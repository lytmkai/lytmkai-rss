<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[如何在Kubernetes搭建RabbitMQ集群 部署篇]]></title>    <link>https://juejin.cn/post/7582955784570437683</link>    <guid>https://juejin.cn/post/7582955784570437683</guid>    <pubDate>2025-12-14T02:37:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582955784570437683" data-draft-id="7582955784570421299" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在Kubernetes搭建RabbitMQ集群 部署篇"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-14T02:37:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Oneslide"/> <meta itemprop="url" content="https://juejin.cn/user/4424904652631624"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在Kubernetes搭建RabbitMQ集群 部署篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4424904652631624/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Oneslide
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T02:37:25.000Z" title="Sun Dec 14 2025 02:37:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 概述</h2>
<p>本文档详细介绍了如何在Kubernetes环境中部署高可用的RabbitMQ集群。该部署方案使用StatefulSet确保Pod的有序部署和稳定网络标识，通过Headless Service实现集群节点间的自动发现，并采用emptyDir临时存储用于测试和调试环境。</p>
<h2 data-id="heading-1">2. 架构设计</h2>
<h3 data-id="heading-2">2.1 集群架构图</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cabd1a9247c4e438700370bd84fbbcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lc2xpZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766284645&amp;x-signature=%2B1dU4LkUEypx%2Bi7%2FKZd97u0OmL0%3D" alt="rabbitmq-cluster-architecture.svg" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 网络配置</h3>
<h4 data-id="heading-4">2.2.1 DNS名称解析</h4>
<p>每个Pod有唯一的DNS名称：</p>
<ul>
<li><strong>短DNS名称</strong>：<code>rabbitmq-{序号}.rabbitmq-headless</code></li>
<li><strong>完整DNS名称</strong>：<code>rabbitmq-{序号}.rabbitmq-headless.cluster-playground.svc.cluster.local</code></li>
</ul>
<h4 data-id="heading-5">2.2.2 端口说明</h4>






























<table><thead><tr><th>端口号</th><th>协议/服务</th><th>用途说明</th></tr></thead><tbody><tr><td><strong>5672</strong></td><td>AMQP协议</td><td>消息传输端口，客户端连接使用</td></tr><tr><td><strong>15672</strong></td><td>HTTP管理界面</td><td>Web管理控制台端口</td></tr><tr><td><strong>25672</strong></td><td>集群通信</td><td>节点间数据同步和集群管理</td></tr><tr><td><strong>4369</strong></td><td>EPMD服务</td><td>Erlang端口映射守护进程</td></tr></tbody></table>
<h3 data-id="heading-6">2.3 核心组件</h3>

































<table><thead><tr><th>组件</th><th>功能说明</th></tr></thead><tbody><tr><td><strong>StatefulSet</strong></td><td>管理3个RabbitMQ Pod实例，确保有序部署和稳定网络标识</td></tr><tr><td><strong>Headless Service</strong></td><td>提供DNS发现机制，每个Pod有唯一的DNS名称</td></tr><tr><td><strong>NodePort Service</strong></td><td>提供外部访问入口</td></tr><tr><td><strong>ConfigMap</strong></td><td>包含RabbitMQ配置和健康检查脚本</td></tr><tr><td><strong>Secret</strong></td><td>存储Erlang Cookie用于集群节点认证</td></tr><tr><td><strong>ServiceAccount</strong></td><td>提供RBAC权限用于Pod发现</td></tr></tbody></table>
<h2 data-id="heading-7">3. YAML文件详解</h2>
<h3 data-id="heading-8">3.1 ConfigMap配置 (configmap.yaml)</h3>
<p>ConfigMap包含两个关键配置：</p>
<h4 data-id="heading-9">3.1.1 RabbitMQ主配置文件 (rabbitmq.conf)</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment">## 基本配置</span>
<span class="hljs-string">listeners.tcp.default</span> <span class="hljs-string">=</span> <span class="hljs-number">5672</span>
<span class="hljs-string">management.tcp.port</span> <span class="hljs-string">=</span> <span class="hljs-number">15672</span>

<span class="hljs-comment">## 集群配置</span>
<span class="hljs-string">cluster_formation.peer_discovery_backend</span> <span class="hljs-string">=</span> <span class="hljs-string">rabbit_peer_discovery_k8s</span>
<span class="hljs-string">cluster_formation.k8s.host</span> <span class="hljs-string">=</span> <span class="hljs-string">kubernetes.default.svc.cluster.local</span>
<span class="hljs-string">cluster_formation.k8s.address_type</span> <span class="hljs-string">=</span> <span class="hljs-string">hostname</span>
<span class="hljs-string">cluster_formation.k8s.service_name</span> <span class="hljs-string">=</span> <span class="hljs-string">rabbitmq-headless</span>
</code></pre>
<h4 data-id="heading-10">3.1.2 RabbitMQ Kubernetes Peer Discovery 插件介绍</h4>
<p><strong>rabbit_peer_discovery_k8s</strong> 是RabbitMQ官方提供的Kubernetes对等发现插件，专门用于在Kubernetes环境中实现RabbitMQ集群节点的自动发现和连接。</p>
<p><strong>插件特性：</strong></p>
<ul>
<li><strong>自动发现</strong>：利用Kubernetes API自动发现集群中的其他RabbitMQ节点</li>
<li><strong>StatefulSet集成</strong>：专为StatefulSet设计，利用Pod的有序性和稳定网络标识</li>
<li><strong>无需外部依赖</strong>：不依赖Consul、etcd等外部服务发现工具</li>
<li><strong>高可用性</strong>：支持节点故障自动恢复和重新加入集群</li>
</ul>
<p><strong>配置参数说明：</strong></p>
<ul>
<li><code>cluster_formation.peer_discovery_backend</code>：指定使用Kubernetes发现后端</li>
<li><code>cluster_formation.k8s.host</code>：Kubernetes API服务器地址</li>
<li><code>cluster_formation.k8s.address_type</code>：节点地址类型（hostname或ip）</li>
<li><code>cluster_formation.k8s.service_name</code>：Headless Service名称</li>
</ul>
<h3 data-id="heading-11">3.2 Headless Service (headless.yaml)</h3>
<p>提供DNS发现机制，不分配ClusterIP：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spec:</span>
  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span>
  <span class="hljs-attr">ports:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">amqp</span>       <span class="hljs-comment"># AMQP协议端口</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">clustering</span> <span class="hljs-comment"># 集群通信端口</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">25672</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">epmd</span>       <span class="hljs-comment"># Erlang端口映射</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">4369</span>
</code></pre>
<h3 data-id="heading-12">3.3 StatefulSet配置 (statefulsets.yaml)</h3>
<p>核心部署配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">rabbitmq-headless</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-comment"># ...</span>
      <span class="hljs-attr">containers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">rabbitmq</span>
          <span class="hljs-attr">image:</span> <span class="hljs-string">'ci.local.com/rabbitmq/rabbitmq:3.9.21-management'</span>
          <span class="hljs-attr">command:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">sh</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">'-c'</span>
          <span class="hljs-attr">args:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">&gt;
              # 启动节点发现插件
</span>
              <span class="hljs-string">rabbitmq-plugins</span> <span class="hljs-string">enable</span> <span class="hljs-string">--offline</span> <span class="hljs-string">rabbitmq_management</span>
              <span class="hljs-string">rabbitmq_peer_discovery_k8s</span>


              <span class="hljs-comment"># 启动RabbitMQ</span>

              <span class="hljs-string">exec</span> <span class="hljs-string">docker-entrypoint.sh</span> <span class="hljs-string">rabbitmq-server</span>
        <span class="hljs-comment"># ....</span>
          <span class="hljs-attr">env:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">RABBITMQ_DEFAULT_USER</span>
              <span class="hljs-attr">value:</span> <span class="hljs-string">admin</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">RABBITMQ_DEFAULT_PASS</span>
              <span class="hljs-attr">value:</span> <span class="hljs-string">Admin#123</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">RABBITMQ_ERLANG_COOKIE</span>
              <span class="hljs-attr">valueFrom:</span>
                <span class="hljs-attr">secretKeyRef:</span>
                  <span class="hljs-attr">name:</span> <span class="hljs-string">rabbitmq-erlang-cookie</span>
                  <span class="hljs-attr">key:</span> <span class="hljs-string">.erlang.cookie</span>
            <span class="hljs-comment"># 节点发现使用长域名</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">RABBITMQ_USE_LONGNAME</span>
              <span class="hljs-attr">value:</span> <span class="hljs-string">'true'</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAME</span>
              <span class="hljs-attr">valueFrom:</span>
                <span class="hljs-attr">fieldRef:</span>
                  <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
                  <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.name</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAMESPACE</span>
              <span class="hljs-attr">valueFrom:</span>
                <span class="hljs-attr">fieldRef:</span>
                  <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
                  <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.namespace</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">RABBITMQ_MNESIA_BASE</span>
              <span class="hljs-attr">value:</span> <span class="hljs-string">/var/lib/rabbitmq/mnesia/$(POD_NAME)</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">K8S_SERVICE_NAME</span>
              <span class="hljs-attr">value:</span> <span class="hljs-string">rabbitmq-headless</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">K8S_HOSTNAME_SUFFIX</span>
              <span class="hljs-attr">value:</span> <span class="hljs-string">.$(K8S_SERVICE_NAME).$(POD_NAMESPACE).svc.cluster.local</span>
            <span class="hljs-comment"># 配置节点发现DNS</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">RABBITMQ_NODENAME</span>
              <span class="hljs-attr">value:</span> <span class="hljs-string">rabbit@$(POD_NAME)$(K8S_HOSTNAME_SUFFIX)</span>
</code></pre>
<h2 data-id="heading-13">4. 部署步骤</h2>
<h3 data-id="heading-14">4.1 步骤1：创建命名空间</h3>
<p>确保目标命名空间存在：</p>
<pre><code class="hljs language-bash" lang="bash">kubectl create namespace cluster-playground
</code></pre>
<h3 data-id="heading-15">4.2 步骤2：按顺序部署资源</h3>
<ol>
<li><strong>创建Secret</strong>（集群认证基础）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">kubectl apply -f yaml/secret.yaml
</code></pre>
<ol start="2">
<li><strong>创建ConfigMap</strong>（配置和脚本）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">kubectl apply -f yaml/configmap.yaml
</code></pre>
<ol start="3">
<li><strong>创建ServiceAccount和RBAC</strong>（权限配置）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">kubectl apply -f yaml/service-account.yaml
</code></pre>
<ol start="4">
<li><strong>创建Headless Service</strong>（DNS发现）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">kubectl apply -f yaml/headless.yaml
</code></pre>
<ol start="5">
<li><strong>创建StatefulSet</strong>（核心部署）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">kubectl apply -f yaml/statefulsets.yaml
</code></pre>
<ol start="6">
<li><strong>创建NodePort Service</strong>（外部访问）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">kubectl apply -f yaml/service.yaml
</code></pre>
<h3 data-id="heading-16">4.3 步骤3：验证部署</h3>
<ol>
<li><strong>检查Pod状态</strong>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">kubectl get pods -n cluster-playground -l app=rabbitmq
</code></pre>
<ol start="2">
<li><strong>检查服务状态</strong>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">kubectl get svc -n cluster-playground -l app=rabbitmq
</code></pre>
<ol start="3">
<li><strong>查看Pod日志</strong>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">kubectl logs -n cluster-playground rabbitmq-0
</code></pre>
<h2 data-id="heading-17">5. 集群验证</h2>
<h3 data-id="heading-18">5.1 健康检查</h3>
<p>执行内置的健康检查脚本：</p>
<pre><code class="hljs language-bash" lang="bash">kubectl <span class="hljs-built_in">exec</span> -n cluster-playground rabbitmq-0 -- bash /etc/rabbitmq/cluster-health.sh
</code></pre>
<h3 data-id="heading-19">5.2 水平扩展</h3>
<p>增加副本数量：</p>
<pre><code class="hljs language-bash" lang="bash">kubectl scale statefulset rabbitmq --replicas=5 -n cluster-playground
</code></pre>
<h2 data-id="heading-20">6. 附录</h2>
<h3 data-id="heading-21">6.1 完整编排文件内容</h3>
<h4 data-id="heading-22">6.1.1 ConfigMap配置 (configmap.yaml)</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">rabbitmq-config</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">cluster-playground</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">cluster-health.sh:</span> <span class="hljs-string">&gt;-
    #!/bin/bash
</span>

    <span class="hljs-string">echo</span> <span class="hljs-string">"=== RabbitMQ 集群功能验证（容器版本） ==="</span>

    <span class="hljs-string">echo</span> <span class="hljs-string">""</span>


    <span class="hljs-comment"># 从环境变量读取认证参数</span>

    <span class="hljs-string">RABBITMQ_USER="${RABBITMQ_USER:-admin}"</span>

    <span class="hljs-string">RABBITMQ_PASS="${RABBITMQ_PASS:-Admin#123}"</span>


    <span class="hljs-comment"># 1. 创建队列</span>

    <span class="hljs-string">echo</span> <span class="hljs-string">"1. 创建测试队列..."</span>

    <span class="hljs-string">rabbitmqadmin</span> <span class="hljs-string">-u</span> <span class="hljs-string">$RABBITMQ_USER</span> <span class="hljs-string">-p</span> <span class="hljs-string">$RABBITMQ_PASS</span> <span class="hljs-string">declare</span> <span class="hljs-string">queue</span>
    <span class="hljs-string">name=cluster_test</span> <span class="hljs-string">durable=true</span>

    <span class="hljs-string">if</span> [ <span class="hljs-string">$?</span> <span class="hljs-string">-eq</span> <span class="hljs-number">0</span> ]<span class="hljs-string">;</span> <span class="hljs-string">then</span>
        <span class="hljs-string">echo</span> <span class="hljs-string">"队列创建成功"</span>
    <span class="hljs-string">else</span>
        <span class="hljs-string">echo</span> <span class="hljs-string">"队列创建失败"</span>
        <span class="hljs-string">exit</span> <span class="hljs-number">1</span>
    <span class="hljs-string">fi</span>

    <span class="hljs-string">echo</span> <span class="hljs-string">""</span>


    <span class="hljs-comment"># 2. 发布消息</span>

    <span class="hljs-string">echo</span> <span class="hljs-string">"2. 发布测试消息..."</span>

    <span class="hljs-string">rabbitmqadmin</span> <span class="hljs-string">-u</span> <span class="hljs-string">$RABBITMQ_USER</span> <span class="hljs-string">-p</span> <span class="hljs-string">$RABBITMQ_PASS</span> <span class="hljs-string">publish</span>
    <span class="hljs-string">exchange=amq.default</span> <span class="hljs-string">routing_key=cluster_test</span> <span class="hljs-string">payload="Hello</span> <span class="hljs-string">from</span> <span class="hljs-string">RabbitMQ</span>
    <span class="hljs-string">Cluster!"</span>

    <span class="hljs-string">echo</span> <span class="hljs-string">"消息发布成功"</span>

    <span class="hljs-string">echo</span> <span class="hljs-string">""</span>


    <span class="hljs-comment"># 3. 检查队列状态</span>

    <span class="hljs-string">echo</span> <span class="hljs-string">"3. 队列状态检查："</span>

    <span class="hljs-string">rabbitmqadmin</span> <span class="hljs-string">-u</span> <span class="hljs-string">$RABBITMQ_USER</span> <span class="hljs-string">-p</span> <span class="hljs-string">$RABBITMQ_PASS</span> <span class="hljs-string">list</span> <span class="hljs-string">queues</span> <span class="hljs-string">name</span> <span class="hljs-string">messages</span>
    <span class="hljs-string">consumers</span> <span class="hljs-string">durable</span> <span class="hljs-string">node</span>

    <span class="hljs-string">echo</span> <span class="hljs-string">""</span>


    <span class="hljs-comment"># 4. 设置镜像队列策略</span>

    <span class="hljs-string">echo</span> <span class="hljs-string">"4. 设置高可用策略..."</span>

    <span class="hljs-string">rabbitmqctl</span> <span class="hljs-string">set_policy</span> <span class="hljs-string">ha-all</span> <span class="hljs-string">".*"</span>
    <span class="hljs-string">'{"ha-mode":"all","ha-sync-mode":"automatic"}'</span> <span class="hljs-string">--priority</span> <span class="hljs-number">0</span> <span class="hljs-string">--apply-to</span>
    <span class="hljs-string">queues</span>

    <span class="hljs-string">echo</span> <span class="hljs-string">"高可用策略已设置"</span>

    <span class="hljs-string">echo</span> <span class="hljs-string">""</span>


    <span class="hljs-comment"># 5. 检查策略</span>

    <span class="hljs-string">echo</span> <span class="hljs-string">"5. 当前策略："</span>

    <span class="hljs-string">rabbitmqctl</span> <span class="hljs-string">list_policies</span>

    <span class="hljs-string">echo</span> <span class="hljs-string">""</span>


    <span class="hljs-comment"># 6. 额外：检查集群状态（可选）</span>

    <span class="hljs-string">echo</span> <span class="hljs-string">"6. 集群状态："</span>

    <span class="hljs-string">rabbitmqctl</span> <span class="hljs-string">cluster_status</span> <span class="hljs-string">|</span> <span class="hljs-string">head</span> <span class="hljs-number">-20</span>
  <span class="hljs-attr">rabbitmq.conf:</span> <span class="hljs-string">|
    ## 基本配置
    listeners.tcp.default = 5672
    management.tcp.port = 15672
</span>
    <span class="hljs-comment">## 集群配置</span>
    <span class="hljs-string">cluster_formation.peer_discovery_backend</span> <span class="hljs-string">=</span> <span class="hljs-string">rabbit_peer_discovery_k8s</span>
    <span class="hljs-string">cluster_formation.k8s.host</span> <span class="hljs-string">=</span> <span class="hljs-string">kubernetes.default.svc.cluster.local</span>
    <span class="hljs-string">cluster_formation.k8s.address_type</span> <span class="hljs-string">=</span> <span class="hljs-string">hostname</span>
    <span class="hljs-string">cluster_formation.k8s.service_name</span> <span class="hljs-string">=</span> <span class="hljs-string">rabbitmq-headless</span>
    <span class="hljs-string">cluster_formation.node_cleanup.interval</span> <span class="hljs-string">=</span> <span class="hljs-number">30</span>

    <span class="hljs-comment">## 磁盘和内存</span>
    <span class="hljs-string">disk_free_limit.absolute</span> <span class="hljs-string">=</span> <span class="hljs-string">2GB</span>
    <span class="hljs-string">vm_memory_high_watermark.absolute</span> <span class="hljs-string">=</span> <span class="hljs-string">3GB</span>
</code></pre>
<h4 data-id="heading-23">6.1.2 Headless Service (headless.yaml)</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">rabbitmq-headless</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">cluster-playground</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">rabbitmq</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">ports:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">amqp</span>
      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span>
      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">5672</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">clustering</span>
      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">25672</span>
      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">25672</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">epmd</span>
      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">4369</span>
      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">4369</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">rabbitmq</span>
  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span>
  <span class="hljs-attr">clusterIPs:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">None</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span>

</code></pre>
<h4 data-id="heading-24">6.1.3 NodePort Service (service.yaml)</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">rabbitmq-client</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">cluster-playground</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">rabbitmq-client</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">ports:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">amqp</span>
      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span>
      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">5672</span>
      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">30445</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span>
      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">15672</span>
      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">15672</span>
      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">31010</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">rabbitmq</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span>
</code></pre>
<h4 data-id="heading-25">6.1.4 StatefulSet配置 (statefulsets.yaml)</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">rabbitmq</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">cluster-playground</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">rabbitmq</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">rabbitmq</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">rabbitmq</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">volumes:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config</span>
          <span class="hljs-attr">configMap:</span>
            <span class="hljs-attr">name:</span> <span class="hljs-string">rabbitmq-config</span>
            <span class="hljs-attr">defaultMode:</span> <span class="hljs-number">420</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">data</span>
          <span class="hljs-attr">emptyDir:</span> {}
      <span class="hljs-attr">containers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">rabbitmq</span>
          <span class="hljs-attr">image:</span> <span class="hljs-string">'dockerhub.kubesphere.local:31104/tykj-gw/rabbitmq:3.9.21-management'</span>
          <span class="hljs-attr">command:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">sh</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">'-c'</span>
          <span class="hljs-attr">args:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">&gt;
              # 启动插件
</span>
              <span class="hljs-string">rabbitmq-plugins</span> <span class="hljs-string">enable</span> <span class="hljs-string">--offline</span> <span class="hljs-string">rabbitmq_management</span>
              <span class="hljs-string">rabbitmq_peer_discovery_k8s</span>


              <span class="hljs-comment"># 启动RabbitMQ</span>

              <span class="hljs-string">exec</span> <span class="hljs-string">docker-entrypoint.sh</span> <span class="hljs-string">rabbitmq-server</span>
          <span class="hljs-attr">ports:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">amqp</span>
              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">5672</span>
              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span>
              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">15672</span>
              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">clustering</span>
              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">25672</span>
              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">epmd</span>
              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">4369</span>
              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
          <span class="hljs-attr">env:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">RABBITMQ_DEFAULT_USER</span>
              <span class="hljs-attr">value:</span> <span class="hljs-string">admin</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">RABBITMQ_DEFAULT_PASS</span>
              <span class="hljs-attr">value:</span> <span class="hljs-string">Admin#123</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">RABBITMQ_ERLANG_COOKIE</span>
              <span class="hljs-attr">valueFrom:</span>
                <span class="hljs-attr">secretKeyRef:</span>
                  <span class="hljs-attr">name:</span> <span class="hljs-string">rabbitmq-erlang-cookie</span>
                  <span class="hljs-attr">key:</span> <span class="hljs-string">.erlang.cookie</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">RABBITMQ_USE_LONGNAME</span>
              <span class="hljs-attr">value:</span> <span class="hljs-string">'true'</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAME</span>
              <span class="hljs-attr">valueFrom:</span>
                <span class="hljs-attr">fieldRef:</span>
                  <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
                  <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.name</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAMESPACE</span>
              <span class="hljs-attr">valueFrom:</span>
                <span class="hljs-attr">fieldRef:</span>
                  <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
                  <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.namespace</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">RABBITMQ_MNESIA_BASE</span>
              <span class="hljs-attr">value:</span> <span class="hljs-string">/var/lib/rabbitmq/mnesia/$(POD_NAME)</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">K8S_SERVICE_NAME</span>
              <span class="hljs-attr">value:</span> <span class="hljs-string">rabbitmq-headless</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">K8S_HOSTNAME_SUFFIX</span>
              <span class="hljs-attr">value:</span> <span class="hljs-string">.$(K8S_SERVICE_NAME).$(POD_NAMESPACE).svc.cluster.local</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">RABBITMQ_NODENAME</span>
              <span class="hljs-attr">value:</span> <span class="hljs-string">rabbit@$(POD_NAME)$(K8S_HOSTNAME_SUFFIX)</span>
          <span class="hljs-attr">resources:</span> {}
          <span class="hljs-attr">volumeMounts:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config</span>
              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/rabbitmq/rabbitmq.conf</span>
              <span class="hljs-attr">subPath:</span> <span class="hljs-string">rabbitmq.conf</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config</span>
              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/rabbitmq/cluster-health.sh</span>
              <span class="hljs-attr">subPath:</span> <span class="hljs-string">cluster-health.sh</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">data</span>
              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/lib/rabbitmq</span>
          <span class="hljs-attr">livenessProbe:</span>
            <span class="hljs-attr">exec:</span>
              <span class="hljs-attr">command:</span>
                <span class="hljs-bullet">-</span> <span class="hljs-string">rabbitmq-diagnostics</span>
                <span class="hljs-bullet">-</span> <span class="hljs-string">ping</span>
            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">60</span>
            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">10</span>
            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">30</span>
            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span>
            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span>
          <span class="hljs-attr">readinessProbe:</span>
            <span class="hljs-attr">exec:</span>
              <span class="hljs-attr">command:</span>
                <span class="hljs-bullet">-</span> <span class="hljs-string">rabbitmq-diagnostics</span>
                <span class="hljs-bullet">-</span> <span class="hljs-string">status</span>
            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">20</span>
            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span>
            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span>
            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span>
          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span>
      <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span>
      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">10</span>
      <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirst</span>
      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">rabbitmq-sa</span>
      <span class="hljs-attr">serviceAccount:</span> <span class="hljs-string">rabbitmq-sa</span>
      <span class="hljs-attr">securityContext:</span> {}
      <span class="hljs-attr">imagePullSecrets:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">harbor</span>
      <span class="hljs-attr">schedulerName:</span> <span class="hljs-string">default-scheduler</span>
  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">rabbitmq-headless</span>
  <span class="hljs-attr">podManagementPolicy:</span> <span class="hljs-string">OrderedReady</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nicegui 组件放在页面中间]]></title>    <link>https://juejin.cn/post/7582923861769011250</link>    <guid>https://juejin.cn/post/7582923861769011250</guid>    <pubDate>2025-12-14T02:46:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582923861769011250" data-draft-id="7583158173978066954" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nicegui 组件放在页面中间"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-14T02:46:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PieroPC"/> <meta itemprop="url" content="https://juejin.cn/user/1998231182522521"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nicegui 组件放在页面中间
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1998231182522521/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PieroPC
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T02:46:18.000Z" title="Sun Dec 14 2025 02:46:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>可以使用以下方法将 组件 放在页面中间：</p>
<h2 data-id="heading-0">方法1：使用 <code>ui.column()</code> 居中对齐</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'absolute-center items-center'</span>):
    <span class="hljs-keyword">with</span> ui.card():
        ui.label(<span class="hljs-string">'卡片内容'</span>)
        <span class="hljs-comment"># 其他卡片内容...</span>
</code></pre>
<h2 data-id="heading-1">方法2：使用 CSS 类</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">with</span> ui.card().classes(<span class="hljs-string">'mx-auto my-auto'</span>):
    ui.label(<span class="hljs-string">'卡片内容'</span>)
    <span class="hljs-comment"># 其他卡片内容...</span>
</code></pre>
<h2 data-id="heading-2">方法3：更灵活的布局控制</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'w-full h-screen justify-center items-center'</span>):
    <span class="hljs-keyword">with</span> ui.card().classes(<span class="hljs-string">'w-96'</span>):
        ui.label(<span class="hljs-string">'卡片内容'</span>)
        ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'输入框'</span>)
        ui.button(<span class="hljs-string">'提交'</span>)
</code></pre>
<h2 data-id="heading-3">方法4：响应式居中</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'absolute-center items-center w-full max-w-md'</span>):
    <span class="hljs-keyword">with</span> ui.card().classes(<span class="hljs-string">'w-full'</span>):
        ui.label(<span class="hljs-string">'居中卡片'</span>)
        <span class="hljs-keyword">with</span> ui.row():
            ui.button(<span class="hljs-string">'确定'</span>)
            ui.button(<span class="hljs-string">'取消'</span>)
</code></pre>
<h2 data-id="heading-4">方法5：使用网格布局</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">with</span> ui.grid(columns=<span class="hljs-number">1</span>).classes(<span class="hljs-string">'h-screen place-items-center'</span>):
    <span class="hljs-keyword">with</span> ui.card():
        ui.label(<span class="hljs-string">'网格居中卡片'</span>)
        <span class="hljs-comment"># 卡片内容...</span>
</code></pre>
<h2 data-id="heading-5">完整示例</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> nicegui <span class="hljs-keyword">import</span> ui

<span class="hljs-comment"># 方法1：推荐使用</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'absolute-center items-center'</span>):
    <span class="hljs-keyword">with</span> ui.card().classes(<span class="hljs-string">'w-96 shadow-lg'</span>):
        ui.label(<span class="hljs-string">'登录'</span>).classes(<span class="hljs-string">'text-2xl font-bold text-center'</span>)
        ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'用户名'</span>).classes(<span class="hljs-string">'w-full'</span>)
        ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'密码'</span>, password=<span class="hljs-literal">True</span>).classes(<span class="hljs-string">'w-full'</span>)
        ui.button(<span class="hljs-string">'登录'</span>, color=<span class="hljs-string">'primary'</span>).classes(<span class="hljs-string">'w-full'</span>)

ui.run()
</code></pre>
<p><strong>说明：</strong></p>
<ul>
<li><code>absolute-center</code>：水平和垂直居中</li>
<li><code>items-center</code>：水平居中（在 column 中）</li>
<li><code>justify-center</code>：垂直居中（在 row 中）</li>
<li><code>mx-auto</code>：水平居中</li>
<li><code>my-auto</code>：垂直居中</li>
<li><code>h-screen</code>：全屏高度</li>
<li><code>w-full</code>：全宽度</li>
</ul>
<p>选择适合你需求的方法即可。方法1和2最简洁，方法3最灵活。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[改一个需求动 23 处代码？你可能踩进了这个坑]]></title>    <link>https://juejin.cn/post/7583139562752573482</link>    <guid>https://juejin.cn/post/7583139562752573482</guid>    <pubDate>2025-12-14T02:46:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583139562752573482" data-draft-id="7583139562752557098" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="改一个需求动 23 处代码？你可能踩进了这个坑"/> <meta itemprop="keywords" content="后端,设计模式"/> <meta itemprop="datePublished" content="2025-12-14T02:46:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lomocode"/> <meta itemprop="url" content="https://juejin.cn/user/2103792315926697"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            改一个需求动 23 处代码？你可能踩进了这个坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2103792315926697/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lomocode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T02:46:58.000Z" title="Sun Dec 14 2025 02:46:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81afdc078ea94364b772115525cc8250~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbG9tb2NvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766285217&amp;x-signature=AtP2m0KhjHMdotVAgOryl10gzLg%3D" alt="0.jpg" loading="lazy"/></p>
<blockquote>
<p>预估阅读：10 分钟</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一个真实的踩坑故事</h2>
<p>小禾有个朋友，也叫小禾。</p>
<p>小禾最近接了个活儿，做一个电商支付模块。一开始需求简单：接入支付宝。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params">order</span>):
    <span class="hljs-keyword">return</span> alipay.create_payment(order)
</code></pre>
<p>清清爽爽，一行搞定。</p>
<hr/>
<h3 data-id="heading-1">第一次加需求</h3>
<p>一周后，产品经理说：「微信支付也要有，用户喜欢选择。」</p>
<p>小禾：简单。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params">order, method=<span class="hljs-string">"alipay"</span></span>):
    <span class="hljs-keyword">if</span> method == <span class="hljs-string">"alipay"</span>:
        <span class="hljs-keyword">return</span> alipay.create_payment(order)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> wechat.create_payment(order)
</code></pre>
<p>两个分支，小事。</p>
<hr/>
<h3 data-id="heading-2">第二次加需求</h3>
<p>两周后：「银联也加上吧，企业客户要用。」</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params">order, method=<span class="hljs-string">"alipay"</span></span>):
    <span class="hljs-keyword">if</span> method == <span class="hljs-string">"alipay"</span>:
        <span class="hljs-keyword">return</span> alipay.create_payment(order)
    <span class="hljs-keyword">elif</span> method == <span class="hljs-string">"wechat"</span>:
        <span class="hljs-keyword">return</span> wechat.create_payment(order)
    <span class="hljs-keyword">elif</span> method == <span class="hljs-string">"unionpay"</span>:
        <span class="hljs-keyword">return</span> unionpay.create_payment(order)
</code></pre>
<p>小禾眉头微皱，但还是忍了。</p>
<hr/>
<h3 data-id="heading-3">第三次加需求</h3>
<p>又过了一个月：「Apple Pay 和 PayPal 也要支持，海外用户需要。」</p>
<p>小禾深吸一口气，打开代码库。</p>
<p>然后他发现，<code>if method == "xxx"</code> 这个判断不只在一个地方。</p>
<p>在 <code>pay()</code> 里有。
在 <code>refund()</code> 里有。
在 <code>get_payment_name()</code> 里有。
在 <code>check_available()</code> 里也有。
在 <code>calculate_fee()</code> 里还有。</p>
<p>一共 8 个文件，23 处判断。</p>
<p>小禾盯着屏幕，陷入沉思：</p>
<p><strong>「这代码，还能救吗？」</strong></p>
<hr/>
<h2 data-id="heading-4">散弹枪代码：改一处要动十处</h2>
<p>小禾的遭遇，你可能也经历过。</p>
<p>我给这种代码起了个名字：<strong>散弹枪代码</strong>。</p>
<p>为什么叫这个名字？因为改一个需求，像打散弹枪一样，要击中十几个地方。漏了一个，线上炸。</p>
<p>它有几个典型症状：</p>
<h3 data-id="heading-5">症状一：修改时全局搜索</h3>
<p>新人问：「我要加个新支付方式，改哪里？」</p>
<p>你答：「全局搜 <code>if method</code>，搜到的地方都要改。」</p>
<p>新人眼里的光暗了。</p>
<h3 data-id="heading-6">症状二：复制粘贴蔓延</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># file1.py</span>
<span class="hljs-keyword">if</span> method == <span class="hljs-string">"alipay"</span>: ...
<span class="hljs-keyword">elif</span> method == <span class="hljs-string">"wechat"</span>: ...

<span class="hljs-comment"># file2.py（复制粘贴）</span>
<span class="hljs-keyword">if</span> method == <span class="hljs-string">"alipay"</span>: ...
<span class="hljs-keyword">elif</span> method == <span class="hljs-string">"wechat"</span>: ...

<span class="hljs-comment"># file3.py（再复制）</span>
<span class="hljs-keyword">if</span> method == <span class="hljs-string">"alipay"</span>: ...
<span class="hljs-keyword">elif</span> method == <span class="hljs-string">"wechat"</span>: ...
</code></pre>
<p>这不是代码复用，这是 bug 复制。</p>
<h3 data-id="heading-7">症状三：漏改导致线上事故</h3>
<p>小禾后来查了一个 bug：某个支付方式退款失败。</p>
<p>原因是 <code>refund()</code> 函数里漏了一个分支——复制的时候少粘贴了一段。</p>
<p><strong>那晚他加班到凌晨三点。</strong></p>
<hr/>
<h2 data-id="heading-8">问题的本质：决策权散落各处</h2>
<p>让我们思考一个问题：</p>
<p><strong>「用哪个支付方式」这个决策，应该由谁来做？</strong></p>
<p>散弹枪代码的问题在于：每个函数都在自己做这个决策。</p>
<ul>
<li><code>pay()</code> 函数决定一次</li>
<li><code>refund()</code> 函数又决定一次</li>
<li><code>get_payment_name()</code> 再决定一次</li>
</ul>
<p>同一个决策，重复做了 23 次。</p>
<p>自然会出问题。</p>
<p><strong>正确的做法是：把决策权收归一处。</strong></p>
<hr/>
<h2 data-id="heading-9">工厂模式：一处决策，处处复用</h2>
<p>打个比方。</p>
<p>你去餐厅点餐，只需要说「来份宫保鸡丁」。</p>
<p>你不需要知道厨房用什么锅、什么油、什么火候。厨房就是「工厂」，你只管点菜和吃。</p>
<p>代码也一样。业务逻辑只需要说「给我一个支付处理器」，不需要关心是支付宝还是微信。</p>
<p>这就是<strong>工厂模式</strong>的核心思想。</p>
<hr/>
<h2 data-id="heading-10">第一步：集中决策</h2>
<p>最简单的改法：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentFactory</span>:
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">method: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-keyword">if</span> method == <span class="hljs-string">"alipay"</span>:
            <span class="hljs-keyword">return</span> AlipayProcessor()
        <span class="hljs-keyword">elif</span> method == <span class="hljs-string">"wechat"</span>:
            <span class="hljs-keyword">return</span> WechatProcessor()
        <span class="hljs-keyword">elif</span> method == <span class="hljs-string">"unionpay"</span>:
            <span class="hljs-keyword">return</span> UnionPayProcessor()
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"不支持的支付方式: <span class="hljs-subst">{method}</span>"</span>)
</code></pre>
<p>业务代码变成：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params">order, method=<span class="hljs-string">"alipay"</span></span>):
    processor = PaymentFactory.create(method)
    <span class="hljs-keyword">return</span> processor.pay(order)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">refund</span>(<span class="hljs-params">order, method</span>):
    processor = PaymentFactory.create(method)
    <span class="hljs-keyword">return</span> processor.refund(order)
</code></pre>
<p>等等，工厂里不还是 if-else 吗？</p>
<p>是的。但关键区别在于：</p>
<p><strong>if-else 只在工厂里出现一次，不再散落各处。</strong></p>
<p>新增支付方式？只改工厂这一个文件。其他 7 个文件一行不动。</p>
<hr/>
<h2 data-id="heading-11">第二步：注册机制</h2>
<p>工厂里的 if-else，能不能也消灭掉？</p>
<p>可以。用<strong>注册表</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentFactory</span>:
    _processors = {}  <span class="hljs-comment"># 注册表</span>

<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">cls, name: <span class="hljs-built_in">str</span>, processor_class</span>):
        <span class="hljs-string">"""注册一个支付处理器"""</span>
        cls._processors[name] = processor_class

<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">cls, name: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""创建支付处理器实例"""</span>
        <span class="hljs-keyword">if</span> name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> cls._processors:
            available = <span class="hljs-built_in">list</span>(cls._processors.keys())
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"不支持 <span class="hljs-subst">{name}</span>，可用: <span class="hljs-subst">{available}</span>"</span>)
        <span class="hljs-keyword">return</span> cls._processors[name]()
</code></pre>
<p>各支付方式自己注册：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># alipay_processor.py</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AlipayProcessor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params">self, order</span>): ...
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">refund</span>(<span class="hljs-params">self, order</span>): ...

PaymentFactory.register(<span class="hljs-string">"alipay"</span>, AlipayProcessor)

<span class="hljs-comment"># wechat_processor.py</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WechatProcessor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params">self, order</span>): ...
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">refund</span>(<span class="hljs-params">self, order</span>): ...

PaymentFactory.register(<span class="hljs-string">"wechat"</span>, WechatProcessor)
</code></pre>
<p><strong>新增 PayPal？创建一个新文件，写一行注册代码，完事。</strong></p>
<p>工厂代码？一个字都不用改。</p>
<p>这就是「开闭原则」：<strong>对扩展开放，对修改关闭。</strong></p>
<hr/>
<h2 data-id="heading-12">AI 项目更需要这个</h2>
<p>如果你做 AI 相关的项目，这个模式更加重要。</p>
<p>因为 AI 模型有个特点：<strong>重且易变</strong>。</p>
<ul>
<li>今天老板说用 GPT-4</li>
<li>明天说太贵，换 Claude</li>
<li>后天又说试试开源的 Llama</li>
<li>大后天发现某个场景还是 GPT-4 效果好</li>
</ul>
<p>如果你的代码散落着 <code>if model == "gpt4"</code> 这样的判断……</p>
<p>祝你好运。</p>
<p><strong>正确的做法</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LLMFactory</span>:
    _adapters = {}
    _instance = <span class="hljs-literal">None</span>

<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">cls, name, adapter_class</span>):
        cls._adapters[name] = adapter_class

<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">cls</span>):
        <span class="hljs-string">"""单例获取，避免重复初始化"""</span>
        <span class="hljs-keyword">if</span> cls._instance <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            model = config.LLM_MODEL
            cls._instance = cls._adapters[model]()
        <span class="hljs-keyword">return</span> cls._instance

<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">reset</span>(<span class="hljs-params">cls</span>):
        <span class="hljs-string">"""切换模型时重置"""</span>
        <span class="hljs-keyword">if</span> cls._instance:
            cls._instance.cleanup()  <span class="hljs-comment"># 释放显存！</span>
        cls._instance = <span class="hljs-literal">None</span>
</code></pre>
<p>为什么要单例？因为 AI 模型加载一次可能要：</p>
<ul>
<li>30 秒启动时间</li>
<li>10GB 显存</li>
<li>一堆 CUDA 初始化</li>
</ul>
<p>每次请求都重新加载？用户会疯。</p>
<hr/>
<h2 data-id="heading-13">什么时候该用</h2>

























<table><thead><tr><th>场景</th><th>建议</th></tr></thead><tbody><tr><td>只有 2-3 种类型，以后不会加</td><td>if-else 足够</td></tr><tr><td>类型会扩展</td><td>注册式工厂</td></tr><tr><td>对象创建成本高</td><td>工厂 + 单例</td></tr><tr><td>大型项目</td><td>分层工厂</td></tr></tbody></table>
<p><strong>最重要的一点：别过度设计。</strong></p>
<p>如果你的项目就 2 个选项，以后也不会有第 3 个，那 if-else 完全没问题。</p>
<p>工厂模式是用来解决「类型会变多」这个问题的。问题不存在，解决方案也不需要存在。</p>
<hr/>
<h2 data-id="heading-14">故事的结尾</h2>
<p>小禾用一个周末重构了代码。</p>
<p>把 23 处 if-else 收归到了一处。</p>
<p>周一产品经理又来：「小禾啊，数字人民币也要支持，政策要求。」</p>
<p>小禾微微一笑，新建了一个 <code>dcep_processor.py</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DCEPProcessor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params">self, order</span>): ...
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">refund</span>(<span class="hljs-params">self, order</span>): ...

PaymentFactory.register(<span class="hljs-string">"dcep"</span>, DCEPProcessor)
</code></pre>
<p>提交代码。</p>
<p>「搞定了。」</p>
<p>产品经理：「这么快？」</p>
<p>小禾端起咖啡：「代码架构对了，需求就不是事儿。」</p>
<hr/>
<h2 data-id="heading-15">一句话总结</h2>
<blockquote>
<p><strong>设计模式的价值，不在于代码变少，而在于改动变少。</strong></p>
</blockquote>
<p>当你能做到「加功能只需加代码，不需改代码」的时候，你就真正理解了设计模式的精髓。</p>
<p>而这，也是区分「写代码」和「做工程」的分水岭。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite 8 发布 beta 版本了，升级体验一下 Rolldown]]></title>    <link>https://juejin.cn/post/7582896213855797263</link>    <guid>https://juejin.cn/post/7582896213855797263</guid>    <pubDate>2025-12-13T16:56:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582896213855797263" data-draft-id="7582896213855780879" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite 8 发布 beta 版本了，升级体验一下 Rolldown"/> <meta itemprop="keywords" content="前端,Vite"/> <meta itemprop="datePublished" content="2025-12-13T16:56:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Airene"/> <meta itemprop="url" content="https://juejin.cn/user/219558053950871"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite 8 发布 beta 版本了，升级体验一下 Rolldown
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558053950871/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Airene
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T16:56:16.000Z" title="Sat Dec 13 2025 16:56:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vite 8 发布 beta 版本了，升级体验一下 Rolldown</h2>
<h3 data-id="heading-1">编译时间</h3>
<p>当前是用 beta.2 版本，因为测试项目非常的小（真实项目），编译时间是从大概 260ms 到 80ms 的量级 🐶，<strong>这可能是个不公平的对比</strong>，因为发现 rolldown 第一次也是 260+ms，然后原地再编译才是前面的结果(有cache？)，也就是 rollup 始终差不多的速度不区分第一次，再次编译 rolldown 会快， 区分是不是第一次。</p>
<h3 data-id="heading-2">vite.config 的变化</h3>
<p>我有一个特殊的需求，就是每个页面都非常小，而且页面不多，希望是不要生成那么多 js 文件，所以之前的做法是 rollup 的选项。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">rollupOptions</span>: {
    <span class="hljs-attr">output</span>: {
        <span class="hljs-title function_">manualChunks</span>(<span class="hljs-params">id</span>) {
            <span class="hljs-keyword">if</span> (id.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'pages'</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">'pages'</span>
            }
        }
    }
}
<span class="hljs-comment">// 之前的结果 vite7 rollup</span>
<span class="hljs-comment">// dist/index.html                  0.45 kB │ gzip:  0.30 kB</span>
<span class="hljs-comment">// dist/assets/style-D2W9t87U.css   5.50 kB │ gzip:  1.58 kB</span>
<span class="hljs-comment">// dist/assets/index-D5uKrQyu.js   28.56 kB │ gzip: 11.05 kB</span>
<span class="hljs-comment">// dist/assets/pages-BL4EWsDv.js   83.42 kB │ gzip: 32.14 kB</span>
</code></pre>
<p>rolldown 没有这个概念，<code>manualChunks</code> 对等的是 <code>advancedChunks</code>，折腾半天 <code>advancedChunks</code> 达不到想要的效果（可能是针对 node_modules 比较强，可能是没找对方法），找了半天找到一个方法可以做到，这个做法对我的项目有用，但是大项目应该不行，所有项目文件都生成一个文件了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">rolldownOptions</span>: {
    <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">inlineDynamicImports</span>: <span class="hljs-literal">true</span>
    }
}
<span class="hljs-comment">// rolldown 的输出内容多了一个 rolldown-runtime</span>
<span class="hljs-comment">// dist/index.html                           0.54 kB │ gzip:  0.31 kB</span>
<span class="hljs-comment">// dist/assets/style-Bac8aBaN.css            5.46 kB │ gzip:  1.56 kB</span>
<span class="hljs-comment">// dist/assets/rolldown-runtime-BcdYIZKG.js  0.19 kB │ gzip:  0.17 kB</span>
<span class="hljs-comment">// dist/assets/index-pOi5csA0.js             25.03 kB │ gzip:  9.38 kB</span>
<span class="hljs-comment">// dist/assets/vendor-p3Su3_y3.js            85.17 kB │ gzip: 33.12 kB</span>
</code></pre>
<p>不加上面选项的结果</p>
<pre><code class="hljs language-text" lang="text">// 文件很多 vite 8 &amp; rolldown， vite 7 类似
dist/index.html                     0.45 kB │ gzip:  0.29 kB
dist/assets/style-Bac8aBaN.css      5.46 kB │ gzip:  1.56 kB
dist/assets/not-found-DAToitwy.js   0.12 kB │ gzip:  0.13 kB
dist/assets/api-Br4_g19J.js         0.42 kB │ gzip:  0.17 kB
dist/assets/home-BSTox8wn.js        0.59 kB │ gzip:  0.38 kB
dist/assets/things-BUk3p1b5.js      0.83 kB │ gzip:  0.53 kB
dist/assets/eol-WmdroNCa.js         1.88 kB │ gzip:  0.97 kB
dist/assets/angling-Bh7xqOUY.js     1.92 kB │ gzip:  0.78 kB
dist/assets/fin-5dWvAvtB.js         1.97 kB │ gzip:  0.87 kB
dist/assets/genuine-DKX79-2_.js     2.40 kB │ gzip:  1.01 kB
dist/assets/frame-main-CGg78mi8.js  2.41 kB │ gzip:  1.27 kB
dist/assets/pc-hLrRv_Pv.js          2.55 kB │ gzip:  0.68 kB
dist/assets/vers-COZW8I_8.js        2.90 kB │ gzip:  1.15 kB
dist/assets/index-CbFw2-HB.js       3.76 kB │ gzip:  1.60 kB
dist/assets/about-BcSEGuXl.js       4.18 kB │ gzip:  2.39 kB
dist/assets/vendor-BMuo1oit.js      84.70 kB │ gzip: 32.75 kB
</code></pre>
<h3 data-id="heading-3">结论</h3>
<ul>
<li>只依赖 vue, vue-router 的项目没问题，生产可用。</li>
<li>rolldown 的 node_modules 大小居然比 vite7 的 esbuild 和 rollup 的还大了一点 47.5MB &gt; 35.2MB 🥴</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.5.25"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vue-router"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.6.4"</span>
<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@vitejs/plugin-vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^6.0.3"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vite"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.0.0-beta.2"</span>
<span class="hljs-punctuation">}</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 事件循环机制详解及项目中的应用]]></title>    <link>https://juejin.cn/post/7582905804048187419</link>    <guid>https://juejin.cn/post/7582905804048187419</guid>    <pubDate>2025-12-13T18:35:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582905804048187419" data-draft-id="7582875640309579826" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 事件循环机制详解及项目中的应用"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-12-13T18:35:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="cindershade"/> <meta itemprop="url" content="https://juejin.cn/user/2587590326494763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 事件循环机制详解及项目中的应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2587590326494763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    cindershade
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T18:35:13.000Z" title="Sat Dec 13 2025 18:35:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第一部分：基础概念</h2>
<h3 data-id="heading-1">1. JavaScript 执行环境</h3>
<p>JavaScript 是<strong>单线程</strong>的，这意味着它一次只能执行一个任务。为了处理异步操作，JavaScript 使用<strong>事件循环</strong>机制。</p>
<h3 data-id="heading-2">2. 核心组件</h3>
<ul>
<li><strong>调用栈（Call Stack）</strong> ：执行同步代码的地方</li>
<li><strong>任务队列（Task Queue）</strong> ：分为宏任务队列和微任务队列</li>
<li><strong>事件循环（Event Loop）</strong> ：协调调用栈和任务队列的机制</li>
</ul>
<h2 data-id="heading-3">第二部分：举例详细解析</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. 同步任务开始'</span>);

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. setTimeout 回调'</span>);
}, <span class="hljs-number">0</span>);

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3. Promise.then 回调'</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4. 同步任务结束'</span>);
</code></pre>
<h3 data-id="heading-4">执行步骤分析：</h3>
<h4 data-id="heading-5">第1步：同步任务执行</h4>
<ol>
<li><code>console.log('1. 同步任务开始')</code> 压入调用栈，立即执行，输出 <code>1</code></li>
<li><code>setTimeout</code> 压入调用栈，Web API 开始计时（0ms），回调函数放入<strong>宏任务队列</strong></li>
<li><code>Promise.resolve().then()</code> 压入调用栈，<code>.then()</code> 的回调函数放入<strong>微任务队列</strong></li>
<li><code>console.log('4. 同步任务结束')</code> 压入调用栈，立即执行，输出 <code>4</code></li>
</ol>
<p>此时状态：</p>
<ul>
<li><strong>调用栈</strong>：空</li>
<li><strong>微任务队列</strong>：<code>[Promise.then回调]</code></li>
<li><strong>宏任务队列</strong>：<code>[setTimeout回调]</code></li>
</ul>
<h4 data-id="heading-6">第2步：事件循环检查</h4>
<ol>
<li><strong>调用栈为空</strong>，事件循环开始工作</li>
<li><strong>优先检查微任务队列</strong>，发现有一个任务</li>
<li>执行微任务：<code>console.log('3. Promise.then 回调')</code>，输出 <code>3</code></li>
<li><strong>微任务队列清空</strong></li>
</ol>
<h4 data-id="heading-7">第3步：继续事件循环</h4>
<ol>
<li>微任务队列为空，现在检查宏任务队列</li>
<li>执行宏任务：<code>setTimeout</code> 回调，输出 <code>2</code></li>
<li>宏任务队列清空</li>
</ol>
<h3 data-id="heading-8">最终输出顺序：<code>1 4 3 2</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'script start'</span>) 
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async1</span>(<span class="hljs-params"/>) { 
   <span class="hljs-keyword">await</span> <span class="hljs-title function_">async2</span>() 
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async1 end'</span>)
} 
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async2</span>(<span class="hljs-params"/>) { 
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async2 end'</span>) 
} 
<span class="hljs-title function_">async1</span>() 
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { 
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout'</span>) 
}, <span class="hljs-number">0</span>)
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span>{
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Promise'</span>)
  <span class="hljs-title function_">resolve</span>()
}).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Promise1'</span>)
})
</code></pre>
<h3 data-id="heading-9">关键概念：async/await</h3>
<ul>
<li><code>async</code> 函数总是返回一个 Promise</li>
<li><code>await</code> 会暂停 async 函数的执行，直到 Promise 解决</li>
<li><code>await</code> 后面的代码相当于放在 <code>.then()</code> 中，属于<strong>微任务</strong></li>
</ul>
<h3 data-id="heading-10">执行步骤分析：</h3>
<h4 data-id="heading-11">第1步：同步任务执行</h4>
<ol>
<li>
<p><code>console.log('script start')</code> → 输出 <code>script start</code></p>
</li>
<li>
<p>定义函数 <code>async1</code> 和 <code>async2</code>（不执行）</p>
</li>
<li>
<p>调用 <code>async1()</code></p>
<ul>
<li>进入 <code>async1</code>，遇到 <code>await async2()</code></li>
<li>调用 <code>async2()</code> → <code>console.log('async2 end')</code> → 输出 <code>async2 end</code></li>
<li><code>await</code> 暂停执行，<strong><code>console.log('async1 end')</code> 被包装成微任务</strong>放入微任务队列</li>
</ul>
</li>
<li>
<p><code>setTimeout</code> → 回调函数放入<strong>宏任务队列</strong></p>
</li>
<li>
<p>执行 <code>new Promise</code></p>
<ul>
<li><code>console.log('Promise')</code> 是同步代码 → 输出 <code>Promise</code></li>
<li><code>resolve()</code> 执行，<code>.then()</code> 的回调放入<strong>微任务队列</strong></li>
</ul>
</li>
</ol>
<p>此时状态：</p>
<ul>
<li><strong>调用栈</strong>：空</li>
<li><strong>微任务队列</strong>：<code>[async1 end, Promise1]</code>（注意顺序！）</li>
<li><strong>宏任务队列</strong>：<code>[setTimeout回调]</code></li>
</ul>
<h4 data-id="heading-12">第2步：事件循环检查微任务</h4>
<ol>
<li>
<p><strong>调用栈为空</strong>，执行微任务</p>
</li>
<li>
<p><strong>按入队顺序执行</strong>微任务：</p>
<ul>
<li>第一个微任务：<code>console.log('async1 end')</code> → 输出 <code>async1 end</code></li>
<li>第二个微任务：<code>console.log('Promise1')</code> → 输出 <code>Promise1</code></li>
</ul>
</li>
<li>
<p><strong>微任务队列清空</strong></p>
</li>
</ol>
<h4 data-id="heading-13">第3步：执行宏任务</h4>
<ol>
<li>执行 <code>setTimeout</code> 回调 → 输出 <code>setTimeout</code></li>
</ol>
<h3 data-id="heading-14">最终输出顺序：<code>script start → async2 end → Promise → async1 end → Promise1 → setTimeout</code></h3>
<p>那么到此，应该是可以理解到事件循环的感觉了，那接下来我们就开始看看事件循环的完整逻辑</p>
<h3 data-id="heading-15">1. 任务分类</h3>
<h4 data-id="heading-16">宏任务（Macrotasks）</h4>
<ul>
<li><code>setTimeout</code>、<code>setInterval</code></li>
<li><code>setImmediate</code>（Node.js）</li>
<li><code>requestAnimationFrame</code>（浏览器）</li>
<li>I/O 操作</li>
<li>UI 渲染（浏览器）</li>
<li>主线程的 script 标签内容</li>
</ul>
<h4 data-id="heading-17">微任务（Microtasks）</h4>
<ul>
<li><code>Promise.then()</code>、<code>.catch()</code>、<code>.finally()</code></li>
<li><code>process.nextTick()</code>（Node.js，优先级最高）</li>
<li><code>MutationObserver</code>（浏览器）</li>
<li><code>queueMicrotask()</code></li>
<li><strong>async/await</strong> 的后续代码</li>
</ul>
<h3 data-id="heading-18">2. 事件循环执行顺序</h3>
<pre><code class="hljs language-text" lang="text">1. 执行一个宏任务（script标签内容）
2. 执行过程中遇到异步任务：
   - 宏任务 → 放入宏任务队列
   - 微任务 → 放入微任务队列
3. 当前宏任务执行完毕
4. 检查微任务队列，依次执行所有微任务
5. 如有必要，进行UI渲染
6. 从宏任务队列取出下一个宏任务执行
7. 回到步骤3，形成循环
</code></pre>
<h3 data-id="heading-19">3. 重要规则</h3>
<h4 data-id="heading-20">规则1：微任务优先</h4>
<ul>
<li>每执行完一个宏任务，都要清空<strong>所有</strong>微任务</li>
<li>微任务执行期间产生的<strong>新微任务</strong>会加入当前队列，并在本次循环中执行</li>
</ul>
<h4 data-id="heading-21">规则2：async/await 转化</h4>
<p>javascript</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">example</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">foo</span>()        <span class="hljs-comment">// 相当于 Promise.resolve(foo()).then(...)</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A'</span>)   <span class="hljs-comment">// 这部分在微任务队列中</span>
}
</code></pre>
<h4 data-id="heading-22">规则3：多个任务队列</h4>
<ul>
<li>宏任务可能有多个来源（定时器、I/O等），有各自的队列</li>
<li>微任务只有一个队列，按入队顺序执行</li>
</ul>
<h2 data-id="heading-23">在举例理解一下</h2>
<p>javascript</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 测试微任务嵌套</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'微任务1'</span>);
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'微任务中的微任务'</span>);
    });
}).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'微任务2'</span>);
});

<span class="hljs-comment">// 输出顺序：微任务1 → 微任务中的微任务 → 微任务2</span>
</code></pre>
<p>javascript</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 测试多个宏任务</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'宏任务1'</span>), <span class="hljs-number">10</span>);
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'微任务1'</span>));
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'宏任务2'</span>);
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'宏任务2中的微任务'</span>));
}, <span class="hljs-number">1</span>);
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'微任务2'</span>));
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'宏任务3'</span>); 
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'宏任务3中的微任务'</span>)); 
}, <span class="hljs-number">0</span>);

结果：
微任务<span class="hljs-number">1</span>
微任务<span class="hljs-number">2</span>
宏任务<span class="hljs-number">3</span>
宏任务<span class="hljs-number">3</span>中的微任务
宏任务<span class="hljs-number">1</span>
宏任务<span class="hljs-number">2</span>
宏任务<span class="hljs-number">2</span>中的微任务
为什么呢？聪明的你已经会了
一开始 微任务 放入 微任务<span class="hljs-number">1</span>， 微任务<span class="hljs-number">2</span>；然后宏任务放入 宏任务<span class="hljs-number">3</span>
这个时候， 计时器还没有到底100ms的时候， 打印微任务<span class="hljs-number">1</span>、微任务<span class="hljs-number">2</span>；然后微任务清空，开始 宏任务<span class="hljs-number">3</span>， 放入微任务 宏任务<span class="hljs-number">3</span>中的微任务，然后打印宏任务<span class="hljs-number">3</span>中的微任务； 然后计时器到了，打印宏任务<span class="hljs-number">1</span>、宏任务<span class="hljs-number">2</span>
、放入微任务， 打印宏任务<span class="hljs-number">2</span>中的微任务；大概就是这种感觉
</code></pre>
<h2 data-id="heading-24">总结</h2>
<ol>
<li><strong>同步任务</strong>立即执行</li>
<li><strong>微任务</strong>比<strong>宏任务</strong>优先级高</li>
<li>每个<strong>宏任务</strong>执行后，都要清空<strong>所有微任务</strong></li>
<li><code>async/await</code> 本质是 Promise 的语法糖，<code>await</code> 后面的代码是微任务</li>
<li>事件循环确保了 JavaScript 的单线程能够处理异步操作</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 3 做 todos , ref 能看懂，computed 终于也懂了]]></title>    <link>https://juejin.cn/post/7583139562751836202</link>    <guid>https://juejin.cn/post/7583139562751836202</guid>    <pubDate>2025-12-13T16:06:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583139562751836202" data-draft-id="7582857981894983721" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3 做 todos , ref 能看懂，computed 终于也懂了"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-13T16:06:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="T___T"/> <meta itemprop="url" content="https://juejin.cn/user/1599155645973066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3 做 todos , ref 能看懂，computed 终于也懂了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1599155645973066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    T___T
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T16:06:11.000Z" title="Sat Dec 13 2025 16:06:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>刚开始学 Vue 3，看到 <code>ref</code>、<code>computed</code>、<code>v-model</code> 就有点晕乎乎。</p>
<p>为了练手，我抄着教程写了一个<strong>超简单的待办清单</strong>，</p>
<p>结果写着写着，发现这个小玩具刚好能把我最不理解的那个家伙——<code>computed</code>——讲清楚。<br/>
下面就用我的视角，拆一下这个小 demo，到底在干嘛，以及 <code>computed</code> 为什么值得单拿出来说。</p>
<h2 data-id="heading-0">响应式数据：<code>ref</code> 开局</h2>
<p>核心状态有两个：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> title = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);
<span class="hljs-keyword">const</span> todos = <span class="hljs-title function_">ref</span>([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'打王者'</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'吃饭'</span>,   <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> }
]);
</code></pre>
<ul>
<li><strong><code>title</code></strong><br/>
输入框当前内容，双向绑定在输入框上。</li>
<li><strong><code>todos</code></strong><br/>
一个数组，每一项是一个待办对象：<code>id</code>、<code>title</code>、<code>done</code>。</li>
</ul>
<p>在模板里通过 <code>v-model</code>、<code>v-for</code>、<code>v-if</code> 等就能把这些数据“长”成界面。</p>
<hr/>
<h2 data-id="heading-1">模板怎么把数据“长”出来？</h2>
<p>几个关键点：</p>
<ul>
<li>
<p><strong>输入框双向绑定</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"title"</span> @<span class="hljs-attr">keydown.enter</span>=<span class="hljs-string">"addTodo"</span>&gt;</span>
</code></pre>
<ul>
<li><code>v-model="title"</code>：输入的内容自动同步到 <code>title</code>。</li>
<li>keydown.enter="addTodo"：按下回车，就调用 addTodo 新增待办。</li>
</ul>
</li>
<li>
<p><strong>列表循环 + 勾选状态</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"todos.length"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"todo in todos"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"todo.id"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"todo.done"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ done: todo.done }"</span>&gt;</span>{{ todo.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span>&gt;</span>暂无待办事项<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<ul>
<li><code>v-for</code> 负责把数组“摊开”成一个个 <code>li</code>。</li>
<li>每条的复选框用 <code>v-model="todo.done"</code>，直接双向绑定完成状态。</li>
<li><code>:class="{ done: todo.done }"</code> 决定要不要加上 <code>.done</code> 这个类，实现中划线 + 灰色。</li>
</ul>
</li>
</ul>
<p>样式就是很简单的：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.done</span> {
  <span class="hljs-attribute">text-decoration</span>: line-through;
  <span class="hljs-attribute">color</span>: gray;
}
</code></pre>
<h2 data-id="heading-2">新增待办：一个小小的 addTodo</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (!title.<span class="hljs-property">value</span>) <span class="hljs-keyword">return</span>;
  todos.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>({
    <span class="hljs-attr">id</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>(),
    <span class="hljs-attr">title</span>: title.<span class="hljs-property">value</span>,
    <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>
  });
  title.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
};
</code></pre>
<ul>
<li><strong>为空就不加</strong>：简单的校验。</li>
<li><strong>往 <code>todos</code> 里 <code>push</code> 新对象</strong>：新待办默认 <code>done: false</code>。</li>
<li><strong>清空输入框</strong>：体验自然一点。</li>
</ul>
<p>这里用的是最基础的响应式数组操作：修改 <code>todos.value</code>，界面自然会跟着更新。</p>
<h2 data-id="heading-3">真正的主角：<code>computed</code> 计算未完成数量</h2>
<p>来看统计那一行：</p>
<pre><code class="hljs language-html" lang="html">{{ active }} / {{ todos.length }}
</code></pre>
<p>前面那个 <code>active</code>，就是一个计算属性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> active = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> todos.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> !todo.<span class="hljs-property">done</span>).<span class="hljs-property">length</span>;
});
</code></pre>
<p>这行代码，核心逻辑其实就一句话：</p>
<blockquote>
<p>把还没完成的待办筛出来，数一数有多少条。</p>
</blockquote>
<p>你可能会问：<br/>
“那我为啥不干脆在模板里直接写呢，比如：</p>
<pre><code class="hljs language-html" lang="html">{{ todos.filter(todo =&gt; !todo.done).length }} / {{ todos.length }}
</code></pre>
<p><strong>能不能这么写？当然可以。</strong><br/>
但计算属性有几个很实际的好处。</p>
<h2 data-id="heading-4"><code>computed</code> 有什么好处？</h2>
<h3 data-id="heading-5">1. <strong>它是“派生数据”的家</strong></h3>
<p>像“未完成数量”这种数据：</p>
<ul>
<li>不需要自己单独存一份；</li>
<li>完全可以根据 <code>todos</code> 推导出来。</li>
</ul>
<p>这种就叫<strong>派生数据</strong>。<br/>
<code>computed</code> 天生就是为它们准备的：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> active = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> todos.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> !todo.<span class="hljs-property">done</span>).<span class="hljs-property">length</span>;
});
</code></pre>
<p>好处是：</p>
<ul>
<li>代码一眼就能看出：<code>active</code> 是“依据 <code>todos</code> 计算得来”的结果。</li>
<li>模板里看到 <code>{{ active }}</code>，基本就能猜到意思，不会被一长串过滤逻辑干扰。</li>
</ul>
<h3 data-id="heading-6">2. <strong>自带缓存：只在需要的时候重新算</strong></h3>
<p>模板里的表达式，每次渲染都会重新执行。</p>
<p>也就是说，如果写成：</p>
<pre><code class="hljs language-html" lang="html">{{ todos.filter(todo =&gt; !todo.done).length }}
</code></pre>
<p>只要组件重新渲染（不管是不是 because <code>todos</code> 变了），它就会再跑一次 <code>filter</code>。</p>
<p>而 <code>computed</code> 则不一样：</p>
<ul>
<li>它会<strong>自动追踪依赖</strong>：<code>todos</code> 以及每个 <code>todo.done</code>。</li>
<li>只有当这些依赖发生变化时，<code>active</code> 才会重新计算。</li>
<li>其他不相干的响应式数据（比如 <code>title</code>）变了，并不会让它重算。</li>
</ul>
<p>在这个小例子里，列表很短，差异你感觉不到。<br/>
但在真实项目里：</p>
<ul>
<li><code>todos</code> 很大；</li>
<li>统计里用到的逻辑复杂；</li>
<li>或者同一个统计在多个地方用到；</li>
</ul>
<p>这时候 <code>computed</code> 的缓存机制，就能明显减少不必要的重复计算。</p>
<h3 data-id="heading-7">3. <strong>模板更干净，逻辑集中在 JS 里</strong></h3>
<p>模板里写太多逻辑，阅读成本会明显升高。<br/>
想象一下，如果有好几个统计项都长这样：</p>
<pre><code class="hljs language-html" lang="html">{{ todos.filter(t =&gt; !t.done &amp;&amp; t.priority === 'high').length }}
</code></pre>
<p>项目一大，很快你就会讨厌在模板里翻来翻去的复杂表达式。</p>
<p>把逻辑抽到 <code>computed</code> 里：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> activeHighPriority = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span>
  todos.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> !t.<span class="hljs-property">done</span> &amp;&amp; t.<span class="hljs-property">priority</span> === <span class="hljs-string">'high'</span>).<span class="hljs-property">length</span>
);
</code></pre>
<p>模板里只保留结果：</p>
<pre><code class="hljs language-html" lang="html">{{ activeHighPriority }}
</code></pre>
<ul>
<li>模板更像“结构 + 文案”；</li>
<li>逻辑都待在 JS 里，改起来更顺手，也好测试。</li>
</ul>
<h3 data-id="heading-8">4. <strong>复用方便</strong></h3>
<p>如果你有多个地方都要用到“未完成数量”，<br/>
用模板表达式的话，要把 <code>todos.filter(...).length</code> 复制来复制去。</p>
<p><code>computed</code> 则只用定义一次：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> active = <span class="hljs-title function_">computed</span>(...);
</code></pre>
<p>模板任何地方都可以直接：</p>
<pre><code class="hljs language-html" lang="html">{{ active }}
</code></pre>
<p>以后改规则（比如不统计某些类型的待办）也只需要改一处逻辑。</p>
<h2 data-id="heading-9"><code>computed</code> 的进阶用法：get / set 做“全选”</h2>
<p>这个例子里还有一个更高级一点的用法：**带 **</p>
<p><strong>get / set 的计算属性</strong>，用来实现“全选”：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> allDone = <span class="hljs-title function_">computed</span>({
  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> todos.<span class="hljs-property">value</span>.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">done</span>);
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">value</span>) {
    todos.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> {
      todo.<span class="hljs-property">done</span> = value;
    });
  }
});
</code></pre>
<p>再配合模板：</p>
<pre><code class="hljs language-html" lang="html">全选<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"allDone"</span>&gt;</span>
</code></pre>
<p>这里发生了几件很有意思的事：</p>
<ul>
<li>
<hr/>
<p><strong>get：从数据推导视图</strong></p>
<ul>
<li>每当界面需要知道“当前是不是全选状态”，就会调用 get()。</li>
<li><code>every(todo =&gt; todo.done)</code> 判断是不是所有都完成。</li>
<li>如果全部完成，<code>allDone</code> 为 <code>true</code>，全选框就被勾上。</li>
</ul>
</li>
<li>
<hr/>
<p><strong>set：从视图反推数据</strong></p>
<ul>
<li>当你点击“全选”复选框时，因为用了 <code>v-model="allDone"</code>，会触发 set(value)。</li>
<li><code>value</code> 是你勾选后的新值（<code>true</code> / <code>false</code>）。</li>
<li>set 里把每一条 <code>todo.done</code> 全部改成这个值。</li>
</ul>
</li>
</ul>
<p>这种写法的妙处在于：</p>
<ul>
<li>
<p>模板里看起来就像在绑一个普通的布尔值；</p>
</li>
<li>
<p>实际上背后是一个可以<strong>双向联动</strong>的“计算属性”：</p>
<ul>
<li>列表状态决定“全选”的勾选；</li>
<li>“全选”的勾选又能反过来更新列表状态。</li>
</ul>
</li>
</ul>
<p>这也是 <code>computed</code> 非常有魅力的一面：**不只是“算结果”，还可以通过 **</p>
<p><strong>set 去“驱动数据变化”</strong> 。</p>
<h2 data-id="heading-10">小结：一个小待办里，装着 Vue 的几个核心习惯</h2>
<p>这个小例子里，其实就体现了几个很值得养成的编码习惯：</p>
<ul>
<li><strong>状态集中在 <code>ref</code> / 响应式对象里管理</strong><br/>
<code>title</code>、<code>todos</code> 这样一眼明了。</li>
<li><strong>模板只做轻量逻辑，复杂逻辑交给 <code>computed</code> / 函数</strong><br/>
未完成数量用 <code>computed</code>，而不是长长的一串模板表达式。</li>
<li><strong>把“派生数据”都塞进 <code>computed</code></strong><br/>
既清晰又有缓存，量一大就知道好处。</li>
<li><strong>用带 <code>get/set</code> 的 <code>computed</code> 实现更自然的双向绑定</strong><br/>
比如“全选”这种，同时依赖和影响其他状态的字段。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度复盘 III： 核心逻辑篇：构建 WebGL 数字孪生的“业务中枢”与“安全防线”]]></title>    <link>https://juejin.cn/post/7582879379442909227</link>    <guid>https://juejin.cn/post/7582879379442909227</guid>    <pubDate>2025-12-13T23:40:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582879379442909227" data-draft-id="7582879379442892843" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度复盘 III： 核心逻辑篇：构建 WebGL 数字孪生的“业务中枢”与“安全防线”"/> <meta itemprop="keywords" content="three.js,WebGL"/> <meta itemprop="datePublished" content="2025-12-13T23:40:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Addisonx"/> <meta itemprop="url" content="https://juejin.cn/user/3651905710195595"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度复盘 III： 核心逻辑篇：构建 WebGL 数字孪生的“业务中枢”与“安全防线”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3651905710195595/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Addisonx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T23:40:28.000Z" title="Sat Dec 13 2025 23:40:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀 前言</h2>
<p>在 Z-TWIN 污水处理厂项目的前两篇复盘中，我们解决了 <strong>渲染管线（Rendering Pipeline）</strong> 的性能瓶颈与 <strong>HMI 工程化</strong> 的多端适配问题。这两步走完，我们构建了一个“好看”且“能跑”的系统骨架。</p>
<p>然而，从 <strong>POC（概念验证）</strong> 走向 <strong>Production（生产环境）</strong> 的过程中，真正的挑战在于如何让这套 3D 系统承载复杂的工业业务。在实际工程交付中，我们深知：<strong>视觉只是表层，逻辑才是骨架。</strong> 一个合格的工业级数字孪生系统，必须具备极低的操作门槛、绝对的安全控制机制以及深度的数据追溯能力。</p>
<p>本文将剥离表面的视觉特效，深入源码的 <strong>HTML/CSS/JS 铁三角</strong>，复盘我们在 <strong>交互约束体系</strong>、<strong>工业控制协议</strong> 以及 <strong>时空数据架构</strong> 中的核心设计决策。</p>
<hr/>
<h2 data-id="heading-1">🧭 一、 交互设计的辩证：基于“物理约束”的巡检逻辑</h2>
<p>在 Web 3D 开发初期，为了展示技术能力，开发者常通过 <code>OrbitControls</code> 给予用户无限的自由度。但在高压力的工业运维场景下，过度的自由往往导致操作迷失。</p>
<p>为了解决这一痛点，我们通过代码构建了一套**“带阻尼的第一人称巡检模式”**。我们认为，适度的约束能显著降低认知负荷。</p>
<h3 data-id="heading-2">1. HTML：语义化的引导结构</h3>
<p>我们在系统入口处预置了强制引导层，用于建立用户的心理模型，明确操作逻辑。</p>
<p><em>文件：index.html (部分核心结构)</em></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"welcome-guide"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"welcome-overlay"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"keyboard-grid"</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 模拟物理控制台的键位映射 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"keyboard-key"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"key-cap"</span>&gt;</span>W<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>推进<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"keyboard-key"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"key-cap"</span>&gt;</span>S<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>退行<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"keyboard-key"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"key-cap wide"</span>&gt;</span>Shift<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>巡检加速<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">2. JS：基于向量的物理运动逻辑</h3>
<p>在逻辑层，我们并没有简单地修改相机坐标，而是引入了<strong>速度向量</strong>与<strong>阻尼系数</strong>。这种处理方式模拟了真实的人体运动惯性，消除了画面急停急转带来的眩晕感。</p>
<p><em>文件：logic/PlayerController.js (物理计算核心逻辑)</em></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateCamera</span>(<span class="hljs-params">delta</span>) {
    <span class="hljs-comment">// 1. 根据按键输入计算加速度 (Acceleration)</span>
    <span class="hljs-keyword">const</span> acceleration = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (inputState.<span class="hljs-property">moveForward</span>) acceleration.<span class="hljs-property">z</span> -= <span class="hljs-number">1.0</span>;
    <span class="hljs-keyword">if</span> (inputState.<span class="hljs-property">moveBackward</span>) acceleration.<span class="hljs-property">z</span> += <span class="hljs-number">1.0</span>;
    
    <span class="hljs-comment">// 2. 应用速度与阻尼 (Velocity &amp; Damping)</span>
    velocity.<span class="hljs-title function_">add</span>(acceleration.<span class="hljs-title function_">multiplyScalar</span>(delta * params.<span class="hljs-property">speed</span>));
    velocity.<span class="hljs-title function_">multiplyScalar</span>(<span class="hljs-number">1.0</span> - params.<span class="hljs-property">damping</span> * delta); 
    
    <span class="hljs-comment">// 3. 碰撞检测与位置更新 (Collision &amp; Update)</span>
    <span class="hljs-keyword">const</span> nextPosition = camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">clone</span>().<span class="hljs-title function_">add</span>(velocity);
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">checkWallCollision</span>(nextPosition)) {
        camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(nextPosition);
    }
    
    <span class="hljs-comment">// 4. 强制高度锁定 (模拟人眼高度 1.7m)</span>
    camera.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = <span class="hljs-number">1.7</span>; 
}
</code></pre>
<p><strong>设计思考</strong>：
这种“降维”设计迫使用户放弃容易迷失的上帝视角，专注于平视的设备状态巡检，显著降低了非技术人员（如现场老师傅）的学习成本。</p>
<hr/>
<h2 data-id="heading-4">🔒 二、 工业安全锁：构建“三步握手”控制闭环</h2>
<p>数字孪生的深水区是<strong>反向控制</strong>（Reverse Control）。在工业现场，前端的一次误触可能导致严重的生产事故。因此，我们坚决摒弃了“点击 3D 模型直接触发 API”的短路逻辑，构建了一套严密的 <strong>UI 拦截机制</strong>。</p>
<h3 data-id="heading-5">1. HTML：独立的物理拦截层</h3>
<p>我们在 <code>index.html</code> 中预埋了一个模态框，利用 DOM 层级遮挡 Canvas，实现了交互上的物理隔离。</p>
<p><em>文件：index.html (安全确认弹窗结构)</em></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"confirm-dialog"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"confirm-dialog hidden"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"confirm-card"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>确认操作<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>该操作将实时下发至 PLC 控制柜，请确认！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"confirm-device"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"label"</span>&gt;</span>设备ID:<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"confirm-device-name"</span>&gt;</span>--<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"confirm-ok-btn"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ok-btn"</span>&gt;</span>执行启动<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">2. JS：严格的“三步握手”协议</h3>
<p>在逻辑层，我们实现了<strong>展示与控制的完全解耦</strong>，并坚持<strong>状态驱动</strong>原则。只有物理世界的设备真正响应了，数字孪生中的状态才会随之改变。</p>
<p><em>文件：logic/InteractionManager.js (指令流逻辑)</em></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 第一步：拾取与拦截 (Pick &amp; Intercept)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">onDeviceClick</span>(<span class="hljs-params">deviceMesh</span>) {
    <span class="hljs-comment">// 仅弹出面板，绝不直接发送指令</span>
    <span class="hljs-title function_">showPropertyPanel</span>(deviceMesh.<span class="hljs-property">userData</span>);
}

<span class="hljs-comment">// 第二步：UI 握手 (Handshake)</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'panel-start-btn'</span>).<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 挂起 3D 交互，弹出全屏遮罩</span>
    controls.<span class="hljs-property">enabled</span> = <span class="hljs-literal">false</span>; 
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'confirm-dialog'</span>).<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'hidden'</span>);
};

<span class="hljs-comment">// 第三步：执行与状态回显 (Execute &amp; Feedback)</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'confirm-ok-btn'</span>).<span class="hljs-property">onclick</span> = <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> deviceId = currentSelection.<span class="hljs-property">id</span>;
    
    <span class="hljs-comment">// 发送指令 (UI 进入 Loading 态)</span>
    <span class="hljs-title function_">setButtonLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">await</span> mqttClient.<span class="hljs-title function_">publish</span>(<span class="hljs-string">`device/<span class="hljs-subst">${deviceId}</span>/control`</span>, <span class="hljs-string">'START'</span>);
    
    <span class="hljs-comment">// 注意：此处绝不修改模型颜色！</span>
    <span class="hljs-comment">// 模型颜色的变更，严格等待后端 WebSocket 的状态推送</span>
};

<span class="hljs-comment">// 第四步：数据驱动视图 (Data Driven)</span>
socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">'device_status_change'</span>, <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">id</span> === deviceId &amp;&amp; msg.<span class="hljs-property">status</span> === <span class="hljs-string">'RUNNING'</span>) {
        <span class="hljs-comment">// 只有收到物理世界的确认，数字世界才随之改变</span>
        targetMesh.<span class="hljs-property">material</span>.<span class="hljs-property">color</span>.<span class="hljs-title function_">setHex</span>(<span class="hljs-number">0x00FF00</span>); 
    }
});
</code></pre>
<p><strong>设计思考</strong>：
屏幕上的绿色，必须代表物理水泵真的转起来了，而不是代表用户点击了按钮。这种<strong>闭环确认机制</strong>是工业软件可信度的基石。</p>
<hr/>
<h2 data-id="heading-7">⏳ 三、 数据架构的升维：从“状态监视”到“时空推演”</h2>
<p>传统的监控大屏通常只展示 <code>Current State</code>（当前值）。但在故障排查（RCA）场景中，**“过去发生了什么”<strong>往往比</strong>“现在是什么”**更有价值。我们通过一套双模态架构，赋予了系统“时空穿梭”的能力。</p>
<h3 data-id="heading-8">1. HTML/CSS：时间轴组件</h3>
<p>我们在控制面板中集成了一个时间轴组件，通过 CSS 样式明确区分当前系统的运行模式。</p>
<p><em>文件：index.html (部分结构)</em></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"replay-controls"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"replay-play-btn"</span>&gt;</span>⏸<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 核心组件：进度条 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"range"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"replay-slider"</span> <span class="hljs-attr">min</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">max</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"100"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><em>文件：css/panels.css (状态样式)</em></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 实时模式为蓝色 */</span>
<span class="hljs-selector-class">.replay-controls</span> <span class="hljs-selector-tag">input</span><span class="hljs-selector-attr">[type=<span class="hljs-string">"range"</span>]</span> {
    accent-<span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--color-primary); 
}
<span class="hljs-comment">/* 回放模式变黄，警示用户数据非实时 */</span>
<span class="hljs-selector-class">.replay-mode</span> <span class="hljs-selector-class">.replay-controls</span> <span class="hljs-selector-tag">input</span><span class="hljs-selector-attr">[type=<span class="hljs-string">"range"</span>]</span> {
    accent-<span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--color-warning); 
}
</code></pre>
<h3 data-id="heading-9">2. JS：双模态数据流架构</h3>
<p>在 <code>DataManager.js</code> 中，我们重构了数据消费逻辑，支持在<strong>实时流</strong>与<strong>历史快照</strong>之间无缝切换。</p>
<p><em>文件：data/DataManager.js (模式切换逻辑)</em></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> isReplayMode = <span class="hljs-literal">false</span>;

<span class="hljs-comment">// 监听滑块拖动</span>
slider.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> value = <span class="hljs-built_in">parseInt</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);
    
    <span class="hljs-keyword">if</span> (value &lt; <span class="hljs-number">100</span>) {
        <span class="hljs-comment">// 进入回放模式</span>
        isReplayMode = <span class="hljs-literal">true</span>;
        <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'replay-mode'</span>);
        <span class="hljs-comment">// 暂停实时 WebSocket 处理，防止数据污染</span>
        socketManager.<span class="hljs-title function_">pause</span>(); 
        <span class="hljs-comment">// 从 IndexedDB 读取历史快照并插值渲染</span>
        <span class="hljs-title function_">renderHistoricalFrame</span>(value); 
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 回到实时模式</span>
        isReplayMode = <span class="hljs-literal">false</span>;
        <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'replay-mode'</span>);
        socketManager.<span class="hljs-title function_">resume</span>();
        <span class="hljs-comment">// 追赶最新状态</span>
        <span class="hljs-title function_">syncLatestState</span>();
    }
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderHistoricalFrame</span>(<span class="hljs-params">timePercent</span>) {
    <span class="hljs-comment">// 线性插值算法 (Lerp) 计算历史状态，保证动画平滑</span>
    <span class="hljs-keyword">const</span> snapshot = timeSeriesDB.<span class="hljs-title function_">getSnapshotAt</span>(timePercent);
    sceneGraph.<span class="hljs-title function_">updateFromData</span>(snapshot);
}
</code></pre>
<p><strong>设计思考</strong>：
这一架构将数字孪生从单纯的“监视器”升级为“故障推演机”，运维人员可以像看视频一样回溯事故现场，极大提升了系统的业务价值。</p>
<hr/>
<h2 data-id="heading-10">🔭 四、 演进与展望：下一代技术布局</h2>
<p>虽然目前的架构已满足交付标准，但面对日益复杂的工业场景，我们正在探索更前沿的技术边界：</p>
<ol>
<li>
<p><strong>计算性能：WebAssembly &amp; WebGPU</strong>
目前的架构受限于 JS 单线程。我们正在尝试引入 <strong>WebAssembly</strong> 处理复杂的流体物理计算，并将大规模粒子系统迁移至 <strong>WebGPU Compute Shader</strong>，以释放 CPU 性能，支持更大规模的场景。</p>
</li>
<li>
<p><strong>智能辅助：AI Agent 集成</strong>
结合 LLM，未来的交互将不再局限于点击。操作员可以说“高亮显示所有温度异常的机柜”，前端 <strong>AI Agent</strong> 自动解析语义、调用 3D API 并规划漫游路径，实现真正的智能辅助。</p>
</li>
<li>
<p><strong>端云协同：Pixel Streaming</strong>
针对老旧的移动终端，我们测试引入 <strong>Pixel Streaming（像素流送）</strong> 技术。将高保真渲染卸载至云端，前端仅作为视频流接收端，在 iPad 上实现电影级的画质体验。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-11">🤝 五、 技术探讨与落地</h2>
<p>工业级 Web 3D 开发是一项复杂的系统工程，从模型资产、渲染优化到业务逻辑闭环，每一个环节都需要精细打磨。</p>
<p>我们团队在实战中沉淀了这套<strong>全链路解决方案</strong>。我们非常乐意与同行或有需求的朋友进行<strong>深度交流</strong>。</p>
<p><strong>如果您正面临以下场景，欢迎沟通：</strong></p>
<ol>
<li><strong>业务团队互补</strong>：拥有深厚的后端/工业协议积累，但急需一支能打硬仗的 3D 前端团队。</li>
<li><strong>项目集成合作</strong>：手头有智慧城市、智慧工厂或 IDC 可视化项目，需要集成高性能的 Web 3D 模块。</li>
<li><strong>技术瓶颈突破</strong>：现有的 3D 场景卡顿、交互混乱或效果不达标，寻求优化方案。</li>
</ol>
<p><strong>在线演示环境</strong>：
👉 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.byzt.net%3A70%2F" target="_blank" title="http://www.byzt.net:70/" ref="nofollow noopener noreferrer">www.byzt.net:70/</a>
<em>(注：建议使用 PC 端 Chrome 访问以获得最佳体验)</em></p>
<p>不管是<strong>技术探讨</strong>、<strong>源码咨询</strong>还是<strong>项目协作</strong>，都欢迎在评论区留言或点击头像私信，交个朋友，共同进步。</p>
<hr/>
<blockquote>
<p><strong>声明</strong>：本文核心代码与架构思路均为原创，转载请注明出处。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[new Array() 与 Array.from() 的差异与陷阱]]></title>    <link>https://juejin.cn/post/7582919147640356916</link>    <guid>https://juejin.cn/post/7582919147640356916</guid>    <pubDate>2025-12-14T01:42:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582919147640356916" data-draft-id="7582939860874248227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="new Array() 与 Array.from() 的差异与陷阱"/> <meta itemprop="keywords" content="JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-14T01:42:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="星光不问赶路人"/> <meta itemprop="url" content="https://juejin.cn/user/950397121075304"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            new Array() 与 Array.from() 的差异与陷阱
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/950397121075304/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    星光不问赶路人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T01:42:44.000Z" title="Sun Dec 14 2025 01:42:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>JS 数组初始化的两种方式：空槽（hole） vs <code>undefined</code>。
下面从<strong>结果结构、可遍历性、行为差异、使用场景</strong>几个维度，系统对比</p>
<h2 data-id="heading-0">一、最直观的差异（重点）</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">10</span>)
<span class="hljs-comment">// [ &lt;10 empty items&gt; ]</span>

<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">10</span> })
<span class="hljs-comment">// [ undefined, undefined, ..., undefined ]（10 个）</span>
</code></pre>
<blockquote>
<p><strong>核心区别</strong>：</p>
</blockquote>
<ul>
<li><code>new Array(10)</code> → <strong>稀疏数组（holes）</strong></li>
<li><code>Array.from({ length: 10 })</code> → <strong>密集数组（元素存在，值为 undefined）</strong></li>
</ul>
<h2 data-id="heading-1">二、数组“空槽（hole）” vs <code>undefined</code></h2>



































<table><thead><tr><th>特性</th><th>new Array(10)</th><th>Array.from({ length: 10 })</th></tr></thead><tbody><tr><td>数组长度</td><td>10</td><td>10</td></tr><tr><td>是否有元素</td><td>❌ 没有（hole）</td><td>✅ 有</td></tr><tr><td><code>0 in arr</code></td><td>false</td><td>true</td></tr><tr><td><code>arr[0]</code></td><td>undefined</td><td>undefined</td></tr><tr><td>JSON.stringify</td><td><code>[null,null,...]</code></td><td><code>[null,null,...]</code></td></tr></tbody></table>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">10</span>)
<span class="hljs-keyword">const</span> b = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">10</span> })
<span class="hljs-comment">// 检查0下标</span>
<span class="hljs-number">0</span> <span class="hljs-keyword">in</span> a <span class="hljs-comment">// false</span>
<span class="hljs-number">0</span> <span class="hljs-keyword">in</span> b <span class="hljs-comment">// true</span>
</code></pre>
<blockquote>
<p>⚠️ <strong><code>undefined !== hole</code></strong></p>
</blockquote>
<h2 data-id="heading-2">三、遍历 &amp; 高阶函数行为差异（非常重要）</h2>
<h3 data-id="heading-3">1️⃣ <code>map / forEach / filter</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">3</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-number">1</span>)
<span class="hljs-comment">// [ &lt;3 empty items&gt; ]</span>

<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">3</span> }).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-number">1</span>)
<span class="hljs-comment">// [1, 1, 1]</span>
</code></pre>
<blockquote>
<p><strong>原因</strong>：</p>
<ul>
<li>高阶方法会 <strong>跳过 hole</strong></li>
<li>不会跳过 <code>undefined</code></li>
</ul>
</blockquote>
<h3 data-id="heading-4">2️⃣ <code>for...of</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> x <span class="hljs-keyword">of</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">3</span>)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x)
}
<span class="hljs-comment">// undefined undefined undefined</span>

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> x <span class="hljs-keyword">of</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">3</span> })) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x)
}
<span class="hljs-comment">// undefined undefined undefined</span>
</code></pre>
<blockquote>
<p><code>for...of</code> <strong>会遍历 hole</strong>（与 map 不同）</p>
</blockquote>
<h3 data-id="heading-5">3️⃣ <code>for...in</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> i <span class="hljs-keyword">in</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">3</span>)) <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i)
<span class="hljs-comment">// 什么都不输出</span>

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> i <span class="hljs-keyword">in</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">3</span> })) <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i)
<span class="hljs-comment">// 0 1 2</span>
</code></pre>
<h2 data-id="heading-6">四、性能与语义差异</h2>






























<table><thead><tr><th>维度</th><th>new Array(10)</th><th>Array.from({ length: 10 })</th></tr></thead><tbody><tr><td>创建速度</td><td>更快</td><td>稍慢</td></tr><tr><td>内存</td><td>更省（无元素）</td><td>占用更多</td></tr><tr><td>可预测性</td><td>❌ 容易踩坑</td><td>✅ 行为一致</td></tr><tr><td>函数式友好</td><td>❌</td><td>✅</td></tr></tbody></table>
<h2 data-id="heading-7">五、典型使用场景</h2>
<h3 data-id="heading-8">✅ 适合 <code>new Array(10)</code> 的情况</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 只关心 length</span>
<span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1024</span>)

<span class="hljs-comment">// 之后立即填充</span>
<span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">10</span>)
arr.<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>)
</code></pre>
<h3 data-id="heading-9">✅ 适合 <code>Array.from({ length: 10 })</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 需要 map / filter / reduce</span>
<span class="hljs-keyword">const</span> list = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">10</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> i)

<span class="hljs-comment">// JSX / Vue 渲染</span>
{<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">5</span> }).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Item</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span> /&gt;</span></span>
))}
</code></pre>
<h2 data-id="heading-10">六、等价但更常见的写法</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">10</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> i)

<span class="hljs-comment">// 等价于</span>
[...<span class="hljs-title class_">Array</span>(<span class="hljs-number">10</span>).<span class="hljs-title function_">keys</span>()]
</code></pre>
<h2 data-id="heading-11">七、总结一句话（面试 / 设计建议）</h2>
<blockquote>
<p><strong><code>new Array(n)</code> 创建的是“空槽数组”，<br/>
<code>Array.from({ length: n })</code> 创建的是“真实元素数组”。</strong></p>
</blockquote>
<p><strong>推荐原则</strong>：</p>
<ul>
<li>要 <strong>遍历 / map / 渲染</strong> →  <code>Array.from</code></li>
<li>只当 <strong>占位容器</strong> → <code>new Array</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 告别“变形”与“留白”：前端可视化大屏适配的终极方案（附源码）]]></title>    <link>https://juejin.cn/post/7582896213856665615</link>    <guid>https://juejin.cn/post/7582896213856665615</guid>    <pubDate>2025-12-14T02:12:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582896213856665615" data-draft-id="7582896213856649231" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 告别“变形”与“留白”：前端可视化大屏适配的终极方案（附源码）"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-14T02:12:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王霸天"/> <meta itemprop="url" content="https://juejin.cn/user/1875092531319104"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 告别“变形”与“留白”：前端可视化大屏适配的终极方案（附源码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1875092531319104/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王霸天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T02:12:50.000Z" title="Sun Dec 14 2025 02:12:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>摘要：</strong> 当产品拿着一份炫酷的 1920x1080 设计稿让你开发时，你是否还在为如何适配客户现场 4K 屏、异形屏甚至拼接屏而发愁？网上流传的 <code>rem</code>、<code>vw/vh</code> 方案在大屏场景下往往力不从心。</p>
<p>本文将深入剖析大屏适配的核心痛点，并推荐目前社区最主流的开源适配工具，带你用最少的代码（不到 20 行）搞定全屏适配。</p>
<hr/>
<h3 data-id="heading-0">🤔 引言：为什么大屏适配这么难？</h3>
<p>在普通 Web 开发中，我们习惯了流式布局，容器宽度自适应。但在<strong>数据可视化大屏</strong>领域，情况截然不同：</p>
<ol>
<li><strong>分辨率碎片化</strong>：设计通常基于 1920x1080 (16:9) 开发，但现场可能是 4K (3840x2160)、超宽屏 (32:9) 甚至老旧的 4:3 投影仪。</li>
<li><strong>像素级要求</strong>：大屏通常包含复杂的背景图、装饰边框，一旦拉伸变形，视觉效果将大打折扣。</li>
<li><strong>硬件差异</strong>：LED 拼接屏可能存在物理像素点距差异。</li>
</ol>
<p>传统的响应式方案（如 <code>flex</code>、<code>%</code>）无法满足这种**“既要铺满屏幕，又要保持比例，还不能变形”**的苛刻需求。</p>
<hr/>
<h3 data-id="heading-1">🧠 核心原理：为什么选择 <code>transform: scale</code>？</h3>
<p>在深入工具之前，我们需要明确一点：<strong>目前大屏适配的主流方案是基于 CSS3 的 <strong><code>transform: scale</code></strong>。</strong></p>
<h4 data-id="heading-2">1. 方案对比</h4>

































<table><thead><tr><th>方案</th><th>原理</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>rem / vw/vh</strong></td><td>动态改变根字体大小或视口单位</td><td>适合文本流式布局</td><td>计算繁琐，背景图难处理，容易出现 1px 偏差</td><td>普通自适应网页</td></tr><tr><td><strong>媒体查询</strong></td><td>针对不同分辨率写多套 CSS</td><td>精准控制</td><td>代码量爆炸，维护困难</td><td>极少数固定分辨率场景</td></tr><tr><td><strong>Scale 缩放</strong></td><td><strong>以设计稿为基准，整体缩放</strong></td><td><strong>代码少，不丢失精度，完美还原设计稿</strong></td><td>需要处理缩放后的定位问题</td><td><strong>大屏可视化 (推荐)</strong></td></tr></tbody></table>
<h4 data-id="heading-3">2. 核心逻辑</h4>
<p>大屏适配的本质是：<strong>将基于特定设计尺寸（如 1920x1080）的内容，通过矩阵变换，缩放到不同尺寸的屏幕中。</strong></p>
<hr/>
<h3 data-id="heading-4">🔧 推荐工具：开源社区的“三驾马车”</h3>
<p>如果你不想从零造轮子，以下是目前掘金和 GitHub 上热度最高、最值得信赖的三个开源适配方案。</p>
<h4 data-id="heading-5">1. <code>autofit.js</code> —— 简单粗暴的通用方案</h4>
<p>这是一个轻量级的无框架依赖库，非常适合原生 JS 或老项目快速接入。</p>
<ul>
<li><strong>特点</strong>：
<ul>
<li>不依赖任何框架，引入即用。</li>
<li>核心逻辑就是获取屏幕宽高，计算缩放比，然后对 <code>body</code> 或容器进行 <code>scale</code>。</li>
</ul>
</li>
<li><strong>适用场景</strong>：简单的 Vue/React 项目，或者不需要复杂局部定位的静态大屏。</li>
</ul>
<h4 data-id="heading-6">2. <code>vfit.js</code> —— Vue 3 的“高定”裁缝</h4>
<p>如果你的项目是基于 <strong>Vue 3 + TypeScript</strong>，那么 <code>vfit</code> 是目前的最佳选择。它由社区开发者针对 Vue 3 生态深度优化。</p>
<ul>
<li><strong>特点</strong>：
<ul>
<li><strong>组件化思维</strong>：它不仅仅是一个缩放工具，更提供了一个 <code>&lt;FitContainer&gt;</code> 组件。</li>
<li><strong>解决定位痛点</strong>：它完美解决了缩放后绝对定位（<code>position: absolute</code>）元素的偏移问题。你可以通过设置 <code>unit="%"</code> 或 <code>unit="px"</code> 来让元素跟随缩放自动调整位置。</li>
<li><strong>响应式</strong>：与 Vue 3 的 Composition API 配合得天衣无缝。</li>
</ul>
</li>
<li><strong>适用场景</strong>：复杂的 Vue 3 可视化项目，特别是包含大量需要精确定位的图表、装饰物的场景。</li>
</ul>
<h4 data-id="heading-7">3. <code>DataV</code> (Vue) / <code>DataV-React</code> —— “开箱即用”的大屏全家桶</h4>
<p>虽然阿里云有商业版 DataV，但开源社区有两个非常优秀的仿制品（通常由社区维护，如 <code>DataV-Team</code> 出品）。</p>
<ul>
<li><strong>特点</strong>：
<ul>
<li><strong>自带适配</strong>：这些库在设计之初就考虑了适配问题，通常内置了 <code>full-screen-container</code> 这样的组件。</li>
<li><strong>视觉组件丰富</strong>：提供了边框、装饰、飞线图等大屏专用组件，这些组件内部已经处理好了缩放逻辑。</li>
</ul>
</li>
<li><strong>适用场景</strong>：不想自己写 CSS 和适配逻辑，想直接拖拽组件快速搭建大屏的开发者。</li>
</ul>
<hr/>
<h3 data-id="heading-8">💻 代码实战：不到 20 行代码搞定适配</h3>
<p>不想引入第三方库？其实原生 JS 实现一个高性能的适配器也非常简单。以下是一个基于 <strong>“等比缩放”</strong> 策略的通用方案。</p>
<h4 data-id="heading-9">1. 核心代码 (<code>flexible.ts</code>)</h4>
<pre><code class="hljs language-ini" lang="ini">// 定义设计稿基准
const <span class="hljs-attr">DESIGN_WIDTH</span> = <span class="hljs-number">1920</span><span class="hljs-comment">;</span>
const <span class="hljs-attr">DESIGN_HEIGHT</span> = <span class="hljs-number">1080</span><span class="hljs-comment">;</span>

// 计算缩放比例的核心逻辑
const <span class="hljs-attr">calculateScale</span> = () =&gt; {
  const { clientWidth, clientHeight } = document.documentElement<span class="hljs-comment">;</span>
  
  // 策略：取宽度和高度缩放比例的最小值，确保内容完整显示（类似 background-size: cover）
  const <span class="hljs-attr">scaleX</span> = clientWidth / DESIGN_WIDTH<span class="hljs-comment">;</span>
  const <span class="hljs-attr">scaleY</span> = clientHeight / DESIGN_HEIGHT<span class="hljs-comment">;</span>
  
  return Math.min(scaleX, scaleY)<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 应用缩放
const <span class="hljs-attr">applyScale</span> = () =&gt; {
  const <span class="hljs-attr">scale</span> = calculateScale()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">container</span> = document.getElementById(<span class="hljs-string">'screen-container'</span>)<span class="hljs-comment">;</span>
  
  if (container) {
    // 关键 CSS：以左上角为原点进行缩放
    <span class="hljs-attr">container.style.transform</span> = `scale(<span class="hljs-variable">${scale}</span>)`<span class="hljs-comment">;</span>
    <span class="hljs-attr">container.style.transformOrigin</span> = <span class="hljs-string">'0 0'</span><span class="hljs-comment">;</span>
    
    // 可选：如果需要居中显示，可以计算偏移量
    // const <span class="hljs-attr">offsetX</span> = (clientWidth - DESIGN_WIDTH * scale) / <span class="hljs-number">2</span><span class="hljs-comment">;</span>
    // <span class="hljs-attr">container.style.marginLeft</span> = `<span class="hljs-variable">${offsetX}</span>px`<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>

// 监听窗口变化
window.addEventListener('resize', applyScale)<span class="hljs-comment">;</span>
export default applyScale<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-10">2. 在 Vue/React 中使用</h4>
<p>在 <code>main.js</code> 或根组件的 <code>mounted</code> 阶段调用即可：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> applyScale <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/flexible'</span>;
<span class="hljs-comment">// 初始化</span>
<span class="hljs-title function_">applyScale</span>();
</code></pre>
<h4 data-id="heading-11">3. CSS 样式配合</h4>
<p>为了让容器撑满全屏并承载缩放，CSS 需要这样写：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">html</span>, <span class="hljs-selector-tag">body</span>, <span class="hljs-selector-id">#app</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">overflow</span>: hidden; <span class="hljs-comment">/* 隐藏滚动条 */</span>
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
}

<span class="hljs-selector-id">#screen-container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">1920px</span>; <span class="hljs-comment">/* 固定设计稿宽度 */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">1080px</span>; <span class="hljs-comment">/* 固定设计稿高度 */</span>
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-comment">/* 背景图等样式 */</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-12">📝 总结与建议</h3>
<p>在 2025 年的今天，面对可视化大屏适配，我的建议是：</p>
<ol>
<li><strong>首选 <strong><code>scale</code></strong> 方案</strong>：除非你有特殊的业务逻辑要求，否则不要尝试用 <code>rem</code> 去硬抗大屏适配，<code>transform: scale</code> 是目前社区公认的最优解。</li>
<li><strong>技术栈匹配</strong>：
<ul>
<li>如果是 <strong>Vue 3</strong> 项目，强烈推荐使用 <code>vfit.js</code>，它能帮你省去 80% 的定位调试时间。</li>
<li>如果是 <strong>React</strong> 项目，可以寻找类似的 <code>react-fit-screen</code> 库，或者直接使用上述的通用 JS 代码。</li>
<li>如果追求<strong>极致开发速度</strong>，直接上开源版 <code>DataV</code>。</li>
</ul>
</li>
<li><strong>设计沟通</strong>：在开发前，务必确认大屏的部署环境。如果是 16:9 的标准屏，上述方案完美适用；如果是超宽屏（如 32:9），可能需要考虑“两边留白”或者“背景拉伸”的特殊处理。</li>
</ol>
<p>希望这篇文章能帮你搞定那个让人头疼的“大屏适配”需求，早点下班！✨</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【n8n教程】：从日志到监控再到安全审计，让你的n8n实例运行无忧]]></title>    <link>https://juejin.cn/post/7582919147640094772</link>    <guid>https://juejin.cn/post/7582919147640094772</guid>    <pubDate>2025-12-14T00:39:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582919147640094772" data-draft-id="7580564126403231794" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【n8n教程】：从日志到监控再到安全审计，让你的n8n实例运行无忧"/> <meta itemprop="keywords" content="AIGC,AI编程,人工智能"/> <meta itemprop="datePublished" content="2025-12-14T00:39:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="undsky"/> <meta itemprop="url" content="https://juejin.cn/user/3368559354850206"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【n8n教程】：从日志到监控再到安全审计，让你的n8n实例运行无忧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3368559354850206/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    undsky
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T00:39:10.000Z" title="Sun Dec 14 2025 00:39:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【n8n教程】：从日志到监控再到安全审计，让你的n8n实例运行无忧</h2>
<p>作为n8n的用户，你可能已经创建了许多自动化工作流。但你是否思考过如何<strong>追踪这些工作流的运行状态</strong>？如何<strong>及时发现问题</strong>？如何<strong>确保系统安全</strong>？本教程将带你深入了解n8n的三大运维核心功能：日志管理、监控告警和安全审计。</p>
<p>这篇教程适合初学者，我们将通过<strong>实操案例</strong>和<strong>完整工作流代码</strong>，让你轻松上手n8n的运维管理。</p>
<hr/>
<h3 data-id="heading-1">📝 第一部分：日志管理 - 追踪工作流的每一步</h3>
<h4 data-id="heading-2">什么是日志？</h4>
<p>日志就像是n8n实例的"日记"，它记录了所有发生的事情。当工作流出错时，日志能帮你快速定位问题。</p>
<h4 data-id="heading-3">日志级别详解</h4>
<p>n8n提供了4个日志级别，从低到高排列：</p>






























<table><thead><tr><th>日志级别</th><th>说明</th><th>使用场景</th></tr></thead><tbody><tr><td><strong>error</strong></td><td>只显示错误信息</td><td>生产环境，只关心故障</td></tr><tr><td><strong>warn</strong></td><td>显示错误和警告</td><td>生产环境，需要提前发现问题</td></tr><tr><td><strong>info</strong></td><td>显示错误、警告和信息</td><td>默认级别，记录关键事件</td></tr><tr><td><strong>debug</strong></td><td>显示所有信息，最详细</td><td>开发环境，深度调试</td></tr></tbody></table>
<h4 data-id="heading-4">快速开始：配置日志</h4>
<h5 data-id="heading-5">方式一：使用环境变量（推荐）</h5>
<p>如果你使用Docker或命令行启动n8n，设置这些环境变量：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置日志级别为 info</span>
<span class="hljs-built_in">export</span> N8N_LOG_LEVEL=info

<span class="hljs-comment"># 设置日志输出到文件</span>
<span class="hljs-built_in">export</span> N8N_LOG_OUTPUT=file

<span class="hljs-comment"># 设置日志文件位置</span>
<span class="hljs-built_in">export</span> N8N_LOG_FILE_LOCATION=/data/logs/n8n.<span class="hljs-built_in">log</span>

<span class="hljs-comment"># 设置单个日志文件最大为 16 MB</span>
<span class="hljs-built_in">export</span> N8N_LOG_FILE_SIZE_MAX=16

<span class="hljs-comment"># 设置最多保留 100 个日志文件</span>
<span class="hljs-built_in">export</span> N8N_LOG_FILE_COUNT_MAX=100
</code></pre>
<h5 data-id="heading-6">方式二：修改配置文件</h5>
<p>在你的n8n配置文件中添加：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">n8n:</span>
  <span class="hljs-attr">log:</span>
    <span class="hljs-attr">level:</span> <span class="hljs-string">info</span>
    <span class="hljs-attr">output:</span> <span class="hljs-string">console,file</span>
    <span class="hljs-attr">file:</span>
      <span class="hljs-attr">location:</span> <span class="hljs-string">/data/logs/n8n.log</span>
      <span class="hljs-attr">fileSizeMax:</span> <span class="hljs-number">16</span>
      <span class="hljs-attr">fileCountMax:</span> <span class="hljs-number">100</span>
</code></pre>
<h4 data-id="heading-7">📍 实战小技巧</h4>
<ol>
<li>
<p><strong>开发环境用 debug</strong>：在调试工作流时，设置 <code>N8N_LOG_LEVEL=debug</code> 能看到最详细的信息。</p>
</li>
<li>
<p><strong>生产环境用 info 或 warn</strong>：保留足够的信息追踪问题，又不会产生过多日志。</p>
</li>
<li>
<p><strong>定期清理日志</strong>：n8n会自动管理日志文件数量，但要确保磁盘有充足空间。</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-8">📊 第二部分：监控系统 - 实时掌握实例状态</h3>
<h4 data-id="heading-9">监控的三个核心端点</h4>
<p>n8n提供了三个API端点让你监控实例的健康状态：</p>
<h5 data-id="heading-10">1️⃣ /healthz 端点 - 快速健康检查</h5>
<pre><code class="hljs language-bash" lang="bash">curl http://localhost:5678/healthz
</code></pre>
<p><strong>返回说明：</strong></p>
<ul>
<li><code>200 OK</code>：实例运行正常，可以接收请求</li>
<li>其他状态码：实例有问题</li>
</ul>
<p><strong>应用场景：</strong> 快速检查实例是否在线，用于负载均衡器或简单的健康检查。</p>
<h5 data-id="heading-11">2️⃣ /healthz/readiness 端点 - 完整准备检查</h5>
<pre><code class="hljs language-bash" lang="bash">curl http://localhost:5678/healthz/readiness
</code></pre>
<p><strong>返回说明：</strong></p>
<ul>
<li><code>200 OK</code>：数据库已连接且迁移完成，实例可以开始处理业务</li>
<li>其他状态码：数据库未就绪</li>
</ul>
<p><strong>应用场景：</strong> Kubernetes 的 readiness probe，或在启动其他依赖服务前进行检查。</p>
<h5 data-id="heading-12">3️⃣ /metrics 端点 - 详细指标数据</h5>
<pre><code class="hljs language-bash" lang="bash">curl http://localhost:5678/metrics
</code></pre>
<p><strong>注意：</strong> 需要先启用！</p>
<p><strong>返回说明：</strong> 包含CPU、内存、请求数等详细指标（Prometheus 格式）</p>
<h4 data-id="heading-13">⚙️ 启用监控指标</h4>
<p>首先需要在环境变量中启用 <code>/metrics</code> 端点：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启用指标收集</span>
<span class="hljs-built_in">export</span> N8N_METRICS=<span class="hljs-literal">true</span>

<span class="hljs-comment"># 如果使用Docker，确保这些端口开放</span>
<span class="hljs-comment"># 默认端口：5678 (HTTP)</span>
<span class="hljs-comment"># 可选指标端口：指定在 N8N_METRICS_* 变量中</span>
</code></pre>
<h4 data-id="heading-14">📈 常见监控指标</h4>
<p>通过 <code>/metrics</code> 端点，你能获取：</p>
<ul>
<li><strong>nodejs_heap_size_bytes</strong>：内存使用情况</li>
<li><strong>process_resident_memory_bytes</strong>：进程内存占用</li>
<li><strong>http_requests_total</strong>：总请求数</li>
<li><strong>workflow_execution_total</strong>：工作流执行次数</li>
<li><strong>workflow_execution_duration_seconds</strong>：执行耗时</li>
</ul>
<hr/>
<h3 data-id="heading-15">🔒 第三部分：安全审计 - 保护你的自动化系统</h3>
<h4 data-id="heading-16">什么是安全审计？</h4>
<p>安全审计能自动检查你的n8n实例中存在的<strong>5大安全风险</strong>，帮助你快速发现和修复问题。</p>
<h4 data-id="heading-17">审计的五大报告类型</h4>
<h5 data-id="heading-18">1. 凭证审计</h5>
<p>检查您的API密钥和凭证是否存在问题：</p>
<ul>
<li>✅ 检查未使用的凭证（可能遗忘的凭证）</li>
<li>✅ 检查在非活跃工作流中的凭证（可以删除）</li>
<li>✅ 检查在最近未运行工作流中的凭证（可以清理）</li>
</ul>
<p><strong>处理建议：</strong> 删除未使用的凭证，降低被泄露的风险。</p>
<h5 data-id="heading-19">2. 数据库审计</h5>
<p>检查SQL查询中的安全隐患：</p>
<ul>
<li>✅ 查找在 SQL 节点中使用 <code>执行查询</code> 时直接拼接的表达式（容易被SQL注入）</li>
<li>✅ 查找查询参数字段中的表达式</li>
<li>✅ 检查未使用的查询参数</li>
</ul>
<p><strong>处理建议：</strong> 使用参数化查询，避免直接拼接用户输入。</p>
<h5 data-id="heading-20">3. 文件系统审计</h5>
<p>检查哪些节点会访问服务器的文件系统：</p>
<ul>
<li>✅ 列出所有访问本地文件的节点（如读取、写入文件）</li>
</ul>
<p><strong>处理建议：</strong> 确认这些文件操作都是必要的，限制节点的文件访问权限。</p>
<h5 data-id="heading-21">4. 节点审计</h5>
<p>检查使用的节点类型是否存在安全风险：</p>
<ul>
<li>✅ 识别<strong>官方危险节点</strong>（如代码执行节点）</li>
<li>✅ 检查<strong>社区节点</strong>的使用</li>
<li>✅ 检查<strong>自定义节点</strong>的安装</li>
</ul>
<p><strong>处理建议：</strong> 谨慎使用代码执行节点，仅从信任的来源安装社区节点。</p>
<h5 data-id="heading-22">5. 实例审计</h5>
<p>检查整个实例的安全配置：</p>
<ul>
<li>✅ 检查<strong>未保护的Webhook</strong>（任何人都可触发）</li>
<li>✅ 检查<strong>缺失的安全设置</strong>（如未开启双因素认证）</li>
<li>✅ 检查<strong>实例版本</strong>是否过时（需要升级）</li>
</ul>
<p><strong>处理建议：</strong> 为Webhook添加认证，启用安全功能，定期更新n8n。</p>
<h4 data-id="heading-23">🚀 如何运行安全审计？</h4>
<h5 data-id="heading-24">方式一：命令行执行</h5>
<pre><code class="hljs language-bash" lang="bash">n8n audit
</code></pre>
<p>运行后会生成一份包含所有风险的报告。</p>
<h5 data-id="heading-25">方式二：API调用</h5>
<pre><code class="hljs language-bash" lang="bash">curl -X POST http://localhost:5678/rest/audit \
  -H <span class="hljs-string">"Authorization: Bearer YOUR_API_TOKEN"</span> \
  -H <span class="hljs-string">"Content-Type: application/json"</span>
</code></pre>
<h5 data-id="heading-26">方式三：在工作流中执行</h5>
<p>在工作流中添加 <strong>n8n 节点</strong>，选择：</p>
<ul>
<li><strong>Resource</strong>: Audit</li>
<li><strong>Operation</strong>: Generate</li>
</ul>
<p>然后运行工作流，会返回审计报告。</p>
<hr/>
<h3 data-id="heading-27">💼 完整实战案例：构建n8n监控和审计工作流</h3>
<p>现在我们要创建一个<strong>完整可执行的工作流</strong>，它能自动检查实例健康状态、收集指标、运行安全审计，并发送报告。</p>
<h4 data-id="heading-28">工作流流程</h4>
<pre><code class="hljs">定时触发 → 检查实例健康 → 检查数据库 → 收集指标 → 安全审计 → 生成报告 → 发送通知
</code></pre>
<h4 data-id="heading-29">工作流JSON代码</h4>
<p>将下面的JSON代码导入到n8n中（点击"Import Workflow"）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"n8n实例健康监控工作流"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"active"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"connections"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Schedule"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"检查实例健康状态"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"index"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"检查实例健康状态"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"检查数据库准备状态"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"index"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"检查数据库准备状态"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"获取详细指标"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"index"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"获取详细指标"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"安全审计检查"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"index"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"安全审计检查"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"格式化报告"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"index"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"格式化报告"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"发送通知"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"index"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"nodes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"interval"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"unit"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"hours"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Schedule"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Schedule"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"n8n-nodes-base.schedule"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"typeVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"position"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">50</span><span class="hljs-punctuation">,</span> <span class="hljs-number">100</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"GET"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:5678/healthz"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"authentication"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"none"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"responseFormat"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"json"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"检查实例健康状态"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"检查实例健康状态"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"n8n-nodes-base.httpRequest"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"typeVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"position"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">300</span><span class="hljs-punctuation">,</span> <span class="hljs-number">100</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"GET"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:5678/healthz/readiness"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"authentication"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"none"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"responseFormat"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"json"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"检查数据库准备状态"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"检查数据库准备状态"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"n8n-nodes-base.httpRequest"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"typeVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"position"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">550</span><span class="hljs-punctuation">,</span> <span class="hljs-number">100</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"GET"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:5678/metrics"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"authentication"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"none"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"responseFormat"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"获取详细指标"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"获取详细指标"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"n8n-nodes-base.httpRequest"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"typeVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"position"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">800</span><span class="hljs-punctuation">,</span> <span class="hljs-number">100</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"POST"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:5678/rest/audit"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"authentication"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"genericCredentialType"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"genericCredentialType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"httpBasicAuth"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"responseFormat"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"json"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"安全审计检查"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"安全审计检查"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"n8n-nodes-base.httpRequest"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"typeVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"position"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">1050</span><span class="hljs-punctuation">,</span> <span class="hljs-number">100</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"credentials"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"httpBasicAuth"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your_credential_id"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"n8n_instance_auth"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"functionCode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"return {\n  timestamp: new Date().toISOString(),\n  healthStatus: $('检查实例健康状态').$response.statusCode === 200 ? 'healthy' : 'unhealthy',\n  dbReady: $('检查数据库准备状态').$response.statusCode === 200 ? 'ready' : 'not-ready',\n  metricsAvailable: $('获取详细指标').$response.statusCode === 200 ? true : false,\n  auditCompleted: $('安全审计检查').json.data ? true : false,\n  summary: 'All monitoring checks completed successfully'\n};"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"格式化报告"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"格式化报告"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"n8n-nodes-base.function"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"typeVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"position"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">1300</span><span class="hljs-punctuation">,</span> <span class="hljs-number">100</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"webhookUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://hooks.slack.com/services/YOUR/WEBHOOK/URL"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"=JSON.stringify($('格式化报告').json, null, 2)"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"POST"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"发送通知"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"发送通知"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"n8n-nodes-base.httpRequest"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"typeVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"position"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">1550</span><span class="hljs-punctuation">,</span> <span class="hljs-number">100</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-30">工作流各个节点详解</h4>
<h5 data-id="heading-31">📅 Schedule（定时触发）</h5>
<ul>
<li><strong>配置</strong>：每小时触发一次（可修改为每30分钟、每天等）</li>
<li><strong>作用</strong>：定期运行监控检查</li>
</ul>
<h5 data-id="heading-32">🔍 检查实例健康状态</h5>
<ul>
<li><strong>方法</strong>：GET 请求到 <code>/healthz</code></li>
<li><strong>返回</strong>：状态码 200 表示实例在线</li>
<li><strong>作用</strong>：基础健康检查</li>
</ul>
<h5 data-id="heading-33">🗄️ 检查数据库准备状态</h5>
<ul>
<li><strong>方法</strong>：GET 请求到 <code>/healthz/readiness</code></li>
<li><strong>返回</strong>：状态码 200 表示数据库已连接</li>
<li><strong>作用</strong>：确保系统可以处理业务</li>
</ul>
<h5 data-id="heading-34">📈 获取详细指标</h5>
<ul>
<li><strong>方法</strong>：GET 请求到 <code>/metrics</code></li>
<li><strong>返回</strong>：Prometheus 格式的指标数据</li>
<li><strong>作用</strong>：收集CPU、内存等详细信息</li>
</ul>
<h5 data-id="heading-35">🔒 安全审计检查</h5>
<ul>
<li><strong>方法</strong>：POST 请求到 <code>/rest/audit</code></li>
<li><strong>认证</strong>：需要n8n API密钥</li>
<li><strong>返回</strong>：完整的审计报告（包含5类风险）</li>
</ul>
<h5 data-id="heading-36">📋 格式化报告</h5>
<ul>
<li><strong>类型</strong>：Function 节点</li>
<li><strong>作用</strong>：整理所有检查结果，生成易读的报告</li>
</ul>
<h5 data-id="heading-37">📧 发送通知</h5>
<ul>
<li><strong>方法</strong>：POST 到 Slack Webhook</li>
<li><strong>作用</strong>：将报告发送到你的Slack频道或邮箱</li>
</ul>
<h4 data-id="heading-38">🛠️ 如何部署这个工作流</h4>
<ol>
<li>
<p><strong>复制上面的JSON代码</strong></p>
</li>
<li>
<p><strong>打开你的n8n实例</strong>，点击左侧菜单 "Workflows"</p>
</li>
<li>
<p><strong>点击 "+ New"</strong> 创建新工作流</p>
</li>
<li>
<p><strong>点击菜单 → Import from URL/File</strong></p>
</li>
<li>
<p><strong>粘贴JSON代码</strong>，点击Import</p>
</li>
<li>
<p><strong>配置必要的参数：</strong></p>
<ul>
<li>将 <code>http://localhost:5678</code> 改为你的n8n实例地址</li>
<li>在"安全审计检查"节点中添加你的n8n API认证</li>
<li>在"发送通知"节点中粘贴你的Slack Webhook URL（或改为Email通知）</li>
</ul>
</li>
<li>
<p><strong>激活工作流</strong>：点击右上角 "Activate" 按钮</p>
</li>
<li>
<p><strong>测试运行</strong>：点击 "Execute Workflow" 立即测试一次</p>
</li>
</ol>
<h4 data-id="heading-39">📝 输出示例</h4>
<p>工作流运行后，你会收到类似这样的报告：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-12-03T10:30:00.000Z"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"healthStatus"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"healthy"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dbReady"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ready"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"metricsAvailable"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"auditCompleted"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"summary"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"All monitoring checks completed successfully"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-40">📚 最佳实践总结</h3>
<h4 data-id="heading-41">✅ 日志管理最佳实践</h4>
<ol>
<li>
<p><strong>生产环境建议配置</strong></p>
<pre><code class="hljs language-bash" lang="bash">N8N_LOG_LEVEL=info
N8N_LOG_OUTPUT=file
N8N_LOG_FILE_SIZE_MAX=50
N8N_LOG_FILE_COUNT_MAX=30
</code></pre>
</li>
<li>
<p><strong>定期检查日志</strong>：每周检查一次，看是否有重复的错误</p>
</li>
<li>
<p><strong>及时删除旧日志</strong>：防止磁盘爆满</p>
</li>
</ol>
<h4 data-id="heading-42">✅ 监控告警最佳实践</h4>
<ol>
<li>
<p><strong>设置多个告警渠道</strong>：不仅Slack，还可用邮件、SMS</p>
</li>
<li>
<p><strong>设置告警规则</strong>：</p>
<ul>
<li>实例宕机立即告警</li>
<li>数据库连接失败告警</li>
<li>内存使用超过80%告警</li>
</ul>
</li>
<li>
<p><strong>定期测试告警</strong>：每月手动触发一次，确认通知渠道畅通</p>
</li>
</ol>
<h4 data-id="heading-43">✅ 安全审计最佳实践</h4>
<ol>
<li>
<p><strong>定期运行审计</strong>：建议每周运行一次</p>
</li>
<li>
<p><strong>及时修复问题</strong>：</p>
<ul>
<li>删除未使用的凭证</li>
<li>为Webhook添加认证</li>
<li>更新过时的实例</li>
</ul>
</li>
<li>
<p><strong>文档化安全决策</strong>：记录为什么需要某个"危险节点"，便于后续审查</p>
</li>
<li>
<p><strong>团队协作</strong>：定期与团队分享审计报告，提升整体安全意识</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-44">🎓 常见问题解答</h3>
<h4 data-id="heading-45">Q1: 日志文件会一直增长吗？</h4>
<p><strong>A:</strong> 不会。n8n会自动管理日志文件。当文件达到<code>N8N_LOG_FILE_SIZE_MAX</code>设置的大小时，会自动轮转生成新文件。当文件数达到<code>N8N_LOG_FILE_COUNT_MAX</code>时，会删除最旧的文件。</p>
<h4 data-id="heading-46">Q2: <code>/metrics</code> 端点返回404是什么原因？</h4>
<p><strong>A:</strong> 说明指标功能未启用。需要设置环境变量 <code>N8N_METRICS=true</code> 并重启n8n。</p>
<h4 data-id="heading-47">Q3: 安全审计的"官方危险节点"包括哪些？</h4>
<p><strong>A:</strong> 主要包括：</p>
<ul>
<li><strong>Execute Command</strong>：执行系统命令</li>
<li><strong>Code</strong>：执行JavaScript代码</li>
<li><strong>Python</strong>：执行Python代码</li>
</ul>
<p>这些节点本身没有问题，但如果接收不受信任的输入会有风险。</p>
<h4 data-id="heading-48">Q4: 可以只将特定级别的日志写入文件吗？</h4>
<p><strong>A:</strong> 不行。n8n的日志输出是全局的，所有级别的日志都会同时输出到配置的目标（console和/或file）。</p>
<h4 data-id="heading-49">Q5: 如何在云环境（如Kubernetes）中启用监控？</h4>
<p><strong>A:</strong></p>
<ol>
<li>设置环境变量：<code>N8N_METRICS=true</code></li>
<li>确保 <code>/metrics</code> 端点可访问（Prometheus Scrape Target）</li>
<li>配置Kubernetes的liveness probe和readiness probe指向对应端点</li>
</ol>
<hr/>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.n8n.io%2Fhosting%2Flogging-monitoring%2Flogging%2F" target="_blank" title="https://docs.n8n.io/hosting/logging-monitoring/logging/" ref="nofollow noopener noreferrer">官方文档 - 日志管理</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.n8n.io%2Fhosting%2Flogging-monitoring%2Fmonitoring%2F" target="_blank" title="https://docs.n8n.io/hosting/logging-monitoring/monitoring/" ref="nofollow noopener noreferrer">官方文档 - 监控系统</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.n8n.io%2Fhosting%2Fsecuring%2Fsecurity-audit%2F" target="_blank" title="https://docs.n8n.io/hosting/securing/security-audit/" ref="nofollow noopener noreferrer">官方文档 - 安全审计</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.undsky.com%2Fblog%2F%3Fcategory%3Dn8n%25E6%2595%2599%25E7%25A8%258B%23" target="_blank" title="https://www.undsky.com/blog/?category=n8n%E6%95%99%E7%A8%8B#" ref="nofollow noopener noreferrer">n8n系列教程</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Open-AutoGLM 部署指南：本地大模型控制 Android 手机自动化]]></title>    <link>https://juejin.cn/post/7582955784570093619</link>    <guid>https://juejin.cn/post/7582955784570093619</guid>    <pubDate>2025-12-14T02:02:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582955784570093619" data-draft-id="7582599972950343707" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Open-AutoGLM 部署指南：本地大模型控制 Android 手机自动化"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-14T02:02:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云舟吖"/> <meta itemprop="url" content="https://juejin.cn/user/360295546233959"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Open-AutoGLM 部署指南：本地大模型控制 Android 手机自动化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/360295546233959/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云舟吖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T02:02:47.000Z" title="Sun Dec 14 2025 02:02:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>Open-AutoGLM 是一个创新的开源项目，它将本地/服务器上的大语言模型与 Android 手机的自动化控制相结合，实现了基于自然语言指令的智能设备操作。通过结合 vLLM/SGlang 高性能推理框架和 ADB 远程调试协议，该项目为开发者和技术爱好者提供了一个强大的平台，可以轻松构建和部署跨设备的智能自动化应用。</p>
<p>本指南旨在为用户提供完整的 Open-AutoGLM 部署流程，从硬件系统要求到具体安装步骤，再到常见问题排查和进阶技巧，帮助您快速上手并充分利用这一技术。无论您是希望在本地 PC 上部署小规模测试环境，还是在服务器上搭建生产级应用，本指南都将为您提供详细的指导和最佳实践。</p>
<h2 data-id="heading-1">一、整体架构</h2>
<p>Open-AutoGLM 采用「本地 PC/服务器运行大模型 + ADB 远程控制 Android 手机」的架构：</p>
<pre><code class="hljs language-scss" lang="scss">┌──────────────┐     HTTP/OpenAI API    ┌─────────────┐
│  vLLM/SGlang │◄──────────────────────►│ phone_agent │
│ （模型推理）   │                        │ (PythonSDK) │
└──────────────┘                        └──────┬──────┘
                                               │ ADB (USB/Wi-Fi)
                                               ▼
                                        Android 手机/模拟器
</code></pre>
<p><strong>架构说明</strong>：</p>
<ul>
<li><strong>推理端</strong>：在本地 GPU 服务器上运行 vLLM 或 SGlang，提供与大模型对话的 OpenAI 兼容 API</li>
<li><strong>控制端</strong>：phone_agent 通过 HTTP API 与推理端通信，使用 ADB 协议控制手机</li>
<li><strong>设备端</strong>：Android 手机通过 ADB 接收指令，执行自动化操作</li>
</ul>
<h2 data-id="heading-2">二、硬件 &amp; 系统要求</h2>
<h3 data-id="heading-3">2.1 推理端（服务器/PC）</h3>
<p><strong>最低配置</strong>：</p>
<ul>
<li><strong>GPU</strong>：CUDA 12+ 兼容显卡（推荐 ≥40 GB 显存）
<ul>
<li>NVIDIA RTX 3090/4090（24GB）</li>
<li>NVIDIA A100（40GB）</li>
<li>或其他 CUDA 12+ 兼容显卡</li>
</ul>
</li>
<li><strong>内存</strong>：≥64 GB RAM</li>
<li><strong>存储</strong>：≥100 GB 可用空间（用于模型缓存）</li>
<li><strong>操作系统</strong>：Ubuntu 20.04+ / CentOS 7+ / Windows 10+ / macOS 12+</li>
</ul>
<p><strong>推荐配置</strong>（用于生产环境）：</p>
<ul>
<li><strong>GPU</strong>：双卡 A100 80GB 或四卡 4090</li>
<li><strong>内存</strong>：128 GB RAM</li>
<li><strong>存储</strong>：≥500 GB NVMe</li>
<li><strong>网络</strong>：千兆网卡以上</li>
</ul>
<h3 data-id="heading-4">2.2 控制端（操作电脑）</h3>
<ul>
<li><strong>操作系统</strong>：Windows 10+ / macOS 12+ / Linux 任意发行版</li>
<li><strong>Python</strong>：3.10+（推荐使用 conda 或 pyenv 管理）</li>
<li><strong>ADB</strong>：Android Platform Tools 1.x.x</li>
<li><strong>可选工具</strong>：
<ul>
<li>scrcpy（屏幕镜像，实时观察手机操作）</li>
<li>Android Studio（用于调试和开发者选项）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">2.3 设备端（Android 手机/模拟器）</h3>
<ul>
<li><strong>系统版本</strong>：Android 7.0+（推荐 Android 10+）</li>
<li><strong>开发者选项</strong>：已启用</li>
<li><strong>USB 调试</strong>：已开启</li>
<li><strong>输入法</strong>：需安装 ADB Keyboard</li>
<li><strong>网络</strong>：可选 Wi-Fi 调试（端口 5555）</li>
</ul>
<h2 data-id="heading-6">三、本地安装详细步骤</h2>
<h3 data-id="heading-7">3.1 安装基础依赖环境</h3>
<h4 data-id="heading-8">步骤 1：检查 Python 版本</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查 Python 版本（需要 ≥3.10）</span>
python --version
python3 --version

<span class="hljs-comment"># 如果未安装 Python 3.10+，请先安装</span>
<span class="hljs-comment"># Ubuntu/Debian:</span>
sudo apt update &amp;&amp; sudo apt install python3.10 python3.10-venv python3.10-distutils

<span class="hljs-comment"># CentOS/RHEL:</span>
sudo yum install python3.10 python3.10-pip python3.10-devel

<span class="hljs-comment"># Windows: 下载安装 python.org</span>
<span class="hljs-comment"># macOS: 使用 Homebrew</span>
brew install python@3.10
</code></pre>
<p><strong>注意事项</strong>：</p>
<ul>
<li>建议使用 conda 创建虚拟环境以避免依赖冲突</li>
<li>Windows 用户需确保长路径支持（启用 <code>fsutil behavior set disablelastaccess 1</code>）</li>
</ul>
<h4 data-id="heading-9">步骤 2：克隆仓库</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆 Open-AutoGLM 仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/zai-org/Open-AutoGLM.git
<span class="hljs-built_in">cd</span> Open-AutoGLM

<span class="hljs-comment"># 查看分支信息</span>
git branch -a
git <span class="hljs-built_in">log</span> --oneline -5
</code></pre>
<p><strong>目录结构说明</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">Open-AutoGLM/
├── main.py              <span class="hljs-comment"># 主程序入口</span>
├── requirements.txt     <span class="hljs-comment"># Python 依赖</span>
├── scripts/             <span class="hljs-comment"># 辅助脚本</span>
│   ├── check_deployment_cn.py  <span class="hljs-comment"># 部署检查</span>
│   └── ...
├── src/                 <span class="hljs-comment"># 源代码</span>
├── models/              <span class="hljs-comment"># 模型存储目录</span>
└── README.md            <span class="hljs-comment"># 官方文档</span>
</code></pre>
<h4 data-id="heading-10">步骤 3：创建 Python 虚拟环境（推荐）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 conda 创建环境</span>
conda create -n autoglm python=3.10 -y
conda activate autoglm

<span class="hljs-comment"># 或使用 venv</span>
python3 -m venv autoglm_env
<span class="hljs-built_in">source</span> autoglm_env/bin/activate  <span class="hljs-comment"># Linux/macOS</span>
<span class="hljs-comment"># autoglm_env\Scripts\activate    # Windows</span>
</code></pre>
<h4 data-id="heading-11">步骤 4：安装运行时依赖</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 升级 pip</span>
pip install --upgrade pip

<span class="hljs-comment"># 安装基础依赖</span>
pip install -r requirements.txt

<span class="hljs-comment"># 安装 Open-AutoGLM 本身（开发模式）</span>
pip install -e .

<span class="hljs-comment"># 验证安装</span>
python -c <span class="hljs-string">"import phone_agent; print('phone-agent/Open-AutoGLM 安装成功')"</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a1575387f5c4b5c911e06d2e843eb3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR6Iif5ZCW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766286131&amp;x-signature=vuKLkUonyAdApdR7DhqVTBm2OUQ%3D" alt="" loading="lazy"/></p>
<p><strong>依赖说明</strong>：</p>
<ul>
<li><code>vllm</code>：高性能模型推理框架</li>
<li><code>openai</code>：OpenAI API 客户端</li>
<li><code>adbutils</code>：ADB 设备管理</li>
<li><code>pillow</code>：图像处理</li>
<li><code>numpy</code>：数值计算</li>
<li><code>requests</code>：HTTP 请求</li>
</ul>
<h3 data-id="heading-12">3.2 配置 ADB 调试环境</h3>
<h4 data-id="heading-13">步骤 1：下载 Android Platform Tools</h4>
<p><strong>方式 A：直接下载</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建目录</span>
<span class="hljs-built_in">mkdir</span> -p ~/android-sdk/platform-tools
<span class="hljs-built_in">cd</span> ~/android-sdk

<span class="hljs-comment"># 下载 platform-tools（Linux/macOS）</span>
wget https://dl.google.com/android/repository/platform-tools-latest-linux.zip

<span class="hljs-comment"># 解压</span>
unzip platform-tools-latest-linux.zip
</code></pre>
<p><strong>方式 B：使用 SDK Manager</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 Android SDK Command-line Tools</span>
wget https://dl.google.com/android/repository/commandlinetools-latest-linux.zip
unzip commandlinetools-latest-linux.zip -d ~/android-sdk
</code></pre>
<h4 data-id="heading-14">步骤 2：配置环境变量</h4>
<p><strong>Linux（~/.bashrc 或 ~/.zshrc）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> ANDROID_HOME=<span class="hljs-variable">$HOME</span>/android-sdk
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$ANDROID_HOME</span>/platform-tools
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$ANDROID_HOME</span>/emulator
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$ANDROID_HOME</span>/tools
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$ANDROID_HOME</span>/tools/bin
</code></pre>
<p><strong>Windows（系统属性 -&gt; 环境变量）</strong>：</p>
<pre><code class="hljs language-perl" lang="perl">变量名：ANDROID_HOME
变量值：C:\Users\YourName\android-sdk

Path 添加：
%ANDROID_HOME%\platform-tools
%ANDROID_HOME%\emulator
%ANDROID_HOME%\tools
%ANDROID_HOME%\tools\bin
</code></pre>
<p><strong>macOS（~/.zshrc）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> ANDROID_HOME=~/android-sdk
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$ANDROID_HOME</span>/platform-tools
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$ANDROID_HOME</span>/emulator
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$ANDROID_HOME</span>/tools
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$ANDROID_HOME</span>/tools/bin
</code></pre>
<h4 data-id="heading-15">步骤 3：验证 ADB 安装</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查 ADB 版本</span>
adb version

<span class="hljs-comment"># 应显示类似：</span>
<span class="hljs-comment"># Android Debug Bridge version 1.x.x</span>
<span class="hljs-comment"># Version 31.0.1 etc.</span>

<span class="hljs-comment"># 测试 ADB 连接</span>
adb devices
<span class="hljs-comment"># 应显示：List of devices attached（无设备是正常的）</span>
</code></pre>
<p><strong>常见问题</strong>：</p>
<ul>
<li>如果提示 <code>command not found</code>，请检查环境变量是否正确配置</li>
<li>Windows 用户可能需要安装 Android USB 驱动</li>
</ul>
<h3 data-id="heading-16">3.3 手机端准备</h3>
<h4 data-id="heading-17">步骤 1：启用开发者选项</h4>
<ol>
<li>
<p><strong>开启开发者模式</strong></p>
<ul>
<li>进入「设置」→「关于手机」</li>
<li>连续点击「版本号」约 7-10 次</li>
<li>会提示「您已处于开发者模式」</li>
</ul>
</li>
<li>
<p><strong>验证开发者选项</strong></p>
<ul>
<li>进入「设置」→「系统」→「开发者选项」</li>
<li>确保可以看到各种调试选项</li>
</ul>
</li>
</ol>
<h4 data-id="heading-18">步骤 2：启用 USB 调试</h4>
<ol>
<li>
<p><strong>打开 USB 调试</strong></p>
<ul>
<li>进入「设置」→「系统」→「开发者选项」</li>
<li>找到「USB 调试」选项并勾选</li>
</ul>
</li>
<li>
<p><strong>配置 USB 调试选项</strong>（推荐）</p>
<ul>
<li>勾选「USB 调试（安全设置）」</li>
<li>勾选「通过 USB 安装应用」</li>
<li>勾选「USB 配置」</li>
</ul>
</li>
</ol>
<p><strong>不同品牌特殊说明</strong>：</p>
<ul>
<li><strong>小米/MIUI</strong>：需要在「开发者选项」里找到「USB 调试（安全设置）」并单独勾选</li>
<li><strong>华为/EMUI</strong>：可能需要在「设置」→「系统和更新」→「开发者选项」中启用</li>
<li><strong>三星</strong>：One UI 中开发者选项位置可能不同</li>
</ul>
<h4 data-id="heading-19">步骤 3：连接手机到电脑</h4>
<ol>
<li>
<p><strong>使用 USB 数据线连接</strong></p>
<ul>
<li>使用原装或高质量数据线</li>
<li>确保数据线支持数据传输（非仅充电）</li>
</ul>
</li>
<li>
<p><strong>验证连接</strong></p>
</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查设备连接状态</span>
adb devices

<span class="hljs-comment"># 应显示类似：</span>
<span class="hljs-comment"># List of devices attached</span>
<span class="hljs-comment"># device_id    device</span>

<span class="hljs-comment"># 如果无设备，尝试：</span>
<span class="hljs-comment"># 1. 更换 USB 端口</span>
<span class="hljs-comment"># 2. 重新插拔数据线</span>
<span class="hljs-comment"># 3. 在手机上确认 USB 调试授权对话框</span>
</code></pre>
<ol start="3">
<li><strong>授权调试</strong>
<ul>
<li>首次连接时，手机会弹出「允许 USB 调试吗？」对话框</li>
<li>勾选「始终允许来自这台计算机的 USB 调试」</li>
<li>点击「确定」</li>
</ul>
</li>
</ol>
<h4 data-id="heading-20">步骤 4：安装并配置 ADB Keyboard</h4>
<ol>
<li><strong>下载 ADB Keyboard</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 adb 安装</span>
adb shell pm install -r /path/to/ADBKeyboard.apk

<span class="hljs-comment"># 或让脚本自动安装（首次运行时会自动处理）</span>
</code></pre>
<ol start="2">
<li>
<p><strong>启用 ADB Keyboard</strong></p>
<ul>
<li>进入「设置」→「系统」→「语言和输入法」</li>
<li>找到「ADB Keyboard」并启用</li>
<li>设为默认输入法（可选但推荐）</li>
</ul>
</li>
<li>
<p><strong>验证 ADB Keyboard</strong></p>
</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试输入</span>
adb shell input text <span class="hljs-string">"Hello World"</span>

<span class="hljs-comment"># 应该能在手机上看到文本输入</span>
</code></pre>
<h3 data-id="heading-21">3.4 下载并启动模型</h3>
<p>Open-AutoGLM 支持多种模型部署方式，根据您的硬件情况选择合适的方式。</p>
<h4 data-id="heading-22">方式 A：本地 vLLM 部署（推荐，需要 GPU）</h4>
<p><strong>步骤 1：安装 vLLM</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 vLLM（支持 CUDA 12+）</span>
pip install vllm

<span class="hljs-comment"># 验证安装</span>
pip show vllm 或 vllm --version
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7f885c8063c4df3bbbe28522eab8cc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR6Iif5ZCW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766286131&amp;x-signature=RIFlK6h6edQTNUReP3GKqbLZTHY%3D" alt="" loading="lazy"/></p>
<p><strong>步骤 2：下载模型</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建模型目录</span>
<span class="hljs-built_in">mkdir</span> -p models/autoglm-phone-9b

<span class="hljs-comment"># 下载模型（约 20GB）</span>
<span class="hljs-comment"># 方式 1：使用 HuggingFace CLI</span>
huggingface-cli download zai-org/AutoGLM-Phone-9B \
  --local-dir models/autoglm-phone-9b \
  --local-dir-use-symlinks False

<span class="hljs-comment"># 方式 2：使用 git clone</span>
git <span class="hljs-built_in">clone</span> https://huggingface.co/zai-org/AutoGLM-Phone-9B \
  models/autoglm-phone-9b
</code></pre>
<p><strong>步骤 3：启动 vLLM 服务器</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 基础启动命令</span>
python3 -m vllm.entrypoints.openai.api_server \
  --served-model-name autoglm-phone-9b \
  --model models/autoglm-phone-9b \
  --port 8000 \
  --host 0.0.0.0

<span class="hljs-comment"># 推荐的生产环境配置</span>
python3 -m vllm.entrypoints.openai.api_server \
  --served-model-name autoglm-phone-9b \
  --allowed-local-media-path / \
  --mm-encoder-tp-mode data \
  --mm_processor_cache_type shm \
  --mm_processor_kwargs <span class="hljs-string">'{"max_pixels":5000000}'</span> \
  --max-model-len 25480 \
  --chat-template-content-format string \
  --limit-mm-per-prompt <span class="hljs-string">'{"image":10}'</span> \
  --model models/autoglm-phone-9b \
  --port 8000 \
  --host 0.0.0.0 \
  --tensor-parallel-size 1 \
  --max-num-seqs 256 \
  --max-num-batched-tokens 8192
</code></pre>
<p><strong>参数说明</strong>：</p>
<ul>
<li><code>--served-model-name</code>：服务名称，用于 API 调用</li>
<li><code>--model</code>：模型本地路径或 HuggingFace ID</li>
<li><code>--port</code>：API 服务端口</li>
<li><code>--host</code>：监听地址，0.0.0.0 表示所有网卡</li>
<li><code>--mm-encoder-tp-mode</code>：多模态编码器张量并行模式</li>
<li><code>--max-model-len</code>：最大序列长度</li>
<li><code>--tensor-parallel-size</code>：张量并行大小（单卡=1，双卡=2）</li>
</ul>
<p><strong>步骤 4：验证模型服务</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用官方检查脚本</span>
python scripts/check_deployment_cn.py \
  --base-url http://localhost:8000/v1 \
  --model autoglm-phone-9b

<span class="hljs-comment"># 或使用 curl 直接测试</span>
curl http://localhost:8000/v1/chat/completions \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{
    "model": "autoglm-phone-9b",
    "messages": [
      {"role": "user", "content": "你好，请介绍一下自己"}
    ],
    "temperature": 0.7,
    "max_tokens": 512
  }'</span>
</code></pre>
<p><strong>预期输出</strong>：</p>
<pre><code class="hljs language-erlang" lang="erlang">✅ 模型服务正常
思考：我需要：<span class="hljs-number">1</span>. 先启动京东...
</code></pre>
<h4 data-id="heading-23">方式 B：使用云端 API（无本地 GPU）</h4>
<p>如果您没有本地 GPU，可以使用智谱开放平台的 API。</p>
<p><strong>步骤 1：注册并获取 API Key</strong></p>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.bigmodel.cn%2F" target="_blank" title="https://open.bigmodel.cn/" ref="nofollow noopener noreferrer">智谱开放平台</a></li>
<li>注册账号并登录</li>
<li>进入「API 密钥」页面获取 API Key</li>
</ol>
<p><strong>步骤 2：使用 API 部署</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 直接使用 main.py，指定云端 API</span>
python main.py \
  --base-url https://open.bigmodel.cn/api/paas/v4 \
  --model autoglm-phone-9b \
  --api-key YOUR_API_KEY_HERE
</code></pre>
<p><strong>环境变量配置</strong>（可选）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> OPENAI_API_KEY=YOUR_API_KEY_HERE
<span class="hljs-built_in">export</span> OPENAI_BASE_URL=https://open.bigmodel.cn/api/paas/v4
</code></pre>
<h3 data-id="heading-24">3.5 验证完整部署</h3>
<h4 data-id="heading-25">测试 1：模型推理测试</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建测试脚本 cat test_model.py</span>
python &lt;&lt; <span class="hljs-string">'EOF'</span>
from openai import OpenAI

client = OpenAI(
    base_url=<span class="hljs-string">"http://localhost:8000/v1"</span>,
    api_key=<span class="hljs-string">"dummy"</span>  <span class="hljs-comment"># 本地部署可使用任意密钥</span>
)

response = client.chat.completions.create(
    model=<span class="hljs-string">"autoglm-phone-9b"</span>,
    messages=[
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好，请简单介绍一下自己"</span>}
    ],
    temperature=0.7,
    max_tokens=256
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"模型回复："</span>, response.choices[0].message.content)
EOF

python test_model.py
</code></pre>
<h4 data-id="heading-26">测试 2：ADB 设备测试</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试 ADB 连接</span>
adb devices

<span class="hljs-comment"># 测试输入</span>
adb shell input text <span class="hljs-string">"测试输入"</span>

<span class="hljs-comment"># 测试截图</span>
adb shell screencap -p /sdcard/screenshot.png
<span class="hljs-comment"># 拉取截图到电脑</span>
adb pull /sdcard/screenshot.png ./screenshot.png
</code></pre>
<h4 data-id="heading-27">测试 3：完整集成测试</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 交互模式测试</span>
python main.py \
  --base-url http://localhost:8000/v1 \
  --model autoglm-phone-9b

<span class="hljs-comment"># 在提示符后输入测试命令</span>
&gt; 打开计算器，计算 123+456
&gt; 打开微信，给<span class="hljs-string">"文件传输助手"</span>发送<span class="hljs-string">"你好"</span>
</code></pre>
<hr/>
<h2 data-id="heading-28">四、常见问题与排查</h2>













































<table><thead><tr><th>症状</th><th>可能原因</th><th>详细处理办法</th></tr></thead><tbody><tr><td><code>adb devices</code> 无设备</td><td>1. 数据线仅充电<br/>2. 驱动未装<br/>3. 调试未开</td><td>1. 更换数据线为数据传输线<br/>2. Windows: 安装 Android USB 驱动<br/>3. 确认开发者选项和 USB 调试已开启</td></tr><tr><td>模型启动 OOM</td><td>1. 显存不足<br/>2. 共享内存未配置</td><td>1. 减小 <code>--max-model-len</code>（如改为 8192）<br/>2. 使用 4bit/8bit 量化<br/>3. 增加 <code>--mm_processor_cache_type</code> 配置</td></tr><tr><td>截图黑屏</td><td>1. 应用处于隐私页面<br/>2. 支付页面<br/>3. 截图权限被拒</td><td>1. Agent 会自动请求人工接管<br/>2. 手动操作后继续自动化<br/>3. 检查手机截图权限设置</td></tr><tr><td>文本输入无效</td><td>1. 未启用 ADB Keyboard<br/>2. 输入法配置错误</td><td>1. 在手机设置-输入法中勾选 ADB Keyboard<br/>2. 重启输入法服务<br/>3. 确认 ADB Keyboard 有默认权限</td></tr><tr><td>Wi-Fi 远程 ADB 失败</td><td>1. 防火墙阻拦 5555 端口<br/>2. 手机和电脑不在同一网段</td><td>1. 放行 5555 端口（Windows 防火墙、macOS 防火墙）<br/>2. 确保设备在同一 Wi-Fi 网络<br/>3. 改用 USB 连接</td></tr><tr><td>vLLM 启动失败</td><td>1. CUDA 版本不兼容<br/>2. 模型路径错误<br/>3. 依赖缺失</td><td>1. 检查 CUDA 版本（需要 12+）<br/>2. 确认模型路径正确<br/>3. 重新安装 vllm 和相关依赖</td></tr><tr><td>模型推理无响应</td><td>1. API 地址错误<br/>2. 模型未正确加载<br/>3. 请求超时</td><td>1. 检查 <code>--base-url</code> 和端口<br/>2. 查看启动日志<br/>3. 增加 <code>--max-num-seqs</code> 配置</td></tr></tbody></table>
<h3 data-id="heading-29">详细排查步骤</h3>
<h4 data-id="heading-30">问题 1：ADB 连接问题</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 检查 USB 数据线</span>
<span class="hljs-comment"># 尝试更换 USB 端口和数据线</span>

<span class="hljs-comment"># 2. 重置 ADB</span>
adb kill-server
adb start-server
adb devices

<span class="hljs-comment"># 3. 检查手机端授权</span>
<span class="hljs-comment"># 手机上应该弹出"允许 USB 调试"对话框</span>

<span class="hljs-comment"># 4. 强制重新连接</span>
adb disconnect
adb connect 127.0.0.1:5555  <span class="hljs-comment"># 如果使用 Wi-Fi</span>
</code></pre>
<h4 data-id="heading-31">问题 2：显存不足</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查显存使用</span>
nvidia-smi

<span class="hljs-comment"># 调整 vLLM 参数</span>
python3 -m vllm.entrypoints.openai.api_server \
  --model models/autoglm-phone-9b \
  --port 8000 \
  --max-model-len 8192 \        <span class="hljs-comment"># 减小序列长度</span>
  --mm_processor_kwargs <span class="hljs-string">'{"max_pixels":2000000}'</span> \  <span class="hljs-comment"># 减小图像处理分辨率</span>
  --quantization awq \           <span class="hljs-comment"># 使用 AWQ 量化（如果支持）</span>
  --tensor-parallel-size 1       <span class="hljs-comment"># 单卡运行</span>
</code></pre>
<h4 data-id="heading-32">问题 3：模型加载失败</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查模型文件完整性</span>
<span class="hljs-built_in">ls</span> -lh models/autoglm-phone-9b/
<span class="hljs-comment"># 应该看到 config.json, pytorch_model.bin 等文件</span>

<span class="hljs-comment"># 重新下载模型</span>
<span class="hljs-built_in">rm</span> -rf models/autoglm-phone-9b
huggingface-cli download zai-org/AutoGLM-Phone-9B \
  --local-dir models/autoglm-phone-9b \
  --local-dir-use-symlinks False

<span class="hljs-comment"># 检查模型格式</span>
file models/autoglm-phone-9b/pytorch_model.bin
</code></pre>
<h2 data-id="heading-33">五、进阶技巧</h2>
<h3 data-id="heading-34">5.1 使用 Wi-Fi 远程调试（无需 USB）</h3>
<p>通过 Wi-Fi 连接可以摆脱数据线束缚，更适合长期运行。</p>
<p><strong>步骤 1：手机端开启 Wi-Fi 调试</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在手机上执行（通过 adb shell）</span>
adb shell settings put global adb_wifi_enabled 1

<span class="hljs-comment"># 或在手机端开启 TCP/IP 模式</span>
adb tcpip 5555
</code></pre>
<p><strong>步骤 2：电脑端连接</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看手机 IP 地址（手机上执行）</span>
adb shell netcfg | grep wlan0

<span class="hljs-comment"># 电脑端连接</span>
adb connect 192.168.1.100:5555

<span class="hljs-comment"># 验证连接</span>
adb devices
</code></pre>
<p><strong>步骤 3：运行 Open-AutoGLM</strong></p>
<pre><code class="hljs language-bash" lang="bash">python main.py \
  --base-url http://localhost:8000/v1 \
  --model autoglm-phone-9b \
  --device-id 192.168.1.100:5555
</code></pre>
<p><strong>注意事项</strong>：</p>
<ul>
<li>确保手机和电脑在同一 Wi-Fi 网络</li>
<li>防火墙需放行 5555 端口</li>
<li>连接可能不如 USB 稳定</li>
</ul>
<h3 data-id="heading-35">5.2 多 GPU 张量并行</h3>
<p>对于多卡服务器，可以使用张量并行大幅降低显存占用。</p>
<p><strong>配置示例（双卡 A100 80GB）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">python3 -m vllm.entrypoints.openai.api_server \
  --served-model-name autoglm-phone-9b \
  --model models/autoglm-phone-9b \
  --port 8000 \
  --host 0.0.0.0 \
  --tensor-parallel-size 2 \        <span class="hljs-comment"># 使用 2 张卡</span>
  --mm-encoder-tp-mode data \       <span class="hljs-comment"># 多模态编码器也使用数据并行</span>
  --max-model-len 25480 \
  --mm_processor_kwargs <span class="hljs-string">'{"max_pixels":5000000}'</span> \
  --chat-template-content-format string \
  --limit-mm-per-prompt <span class="hljs-string">'{"image":10}'</span>
</code></pre>
<p><strong>效果</strong>：</p>
<ul>
<li>显存占用降低约 50%</li>
<li>推理速度提升约 30-50%</li>
<li>适合 80GB+ 的大模型</li>
</ul>
<p><strong>四卡配置</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">--tensor-parallel-size 4 \
--mm-encoder-tp-mode data \
</code></pre>
<h3 data-id="heading-36">5.3 量化与低成本部署</h3>
<h4 data-id="heading-37">选项 1：使用 llama.cpp</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编译 llama.cpp</span>
git <span class="hljs-built_in">clone</span> https://github.com/ggerganov/llama.cpp
<span class="hljs-built_in">cd</span> llama.cpp
make LLAMA_CUBLAS=1

<span class="hljs-comment"># 下载 GGUF 格式模型</span>
<span class="hljs-comment"># （需要等待官方发布或自行转换）</span>

<span class="hljs-comment"># 运行</span>
./main -m model.gguf -p <span class="hljs-string">"你好"</span>
</code></pre>
<h4 data-id="heading-38">选项 2：使用 4bit/8bit 量化</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># vLLM 自动量化（如果支持）</span>
python3 -m vllm.entrypoints.openai.api_server \
  --model models/autoglm-phone-9b \
  --port 8000 \
  --quantization awq \    <span class="hljs-comment"># 或 exllama, marlin 等</span>
  --max-model-len 8192
</code></pre>
<p><strong>量化效果对比</strong>：</p>





























<table><thead><tr><th>方案</th><th>显存占用</th><th>推理速度</th><th>准确率下降</th></tr></thead><tbody><tr><td>FP16</td><td>~20 GB</td><td>基准</td><td>-</td></tr><tr><td>INT8</td><td>~10 GB</td><td>+20%</td><td>&lt;1%</td></tr><tr><td>INT4</td><td>~5 GB</td><td>+40%</td><td>2-5%</td></tr></tbody></table>
<h3 data-id="heading-39">5.4 使用屏幕镜像（scrcpy）</h3>
<p>实时观察手机操作，便于调试和展示。</p>
<p><strong>安装 scrcpy</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Ubuntu/Debian</span>
sudo apt install scrcpy

<span class="hljs-comment"># Windows</span>
winget install Gsquared.Scrcpy

<span class="hljs-comment"># macOS</span>
brew install scrcpy
</code></pre>
<p><strong>启动镜像</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 基础启动</span>
scrcpy

<span class="hljs-comment"># 高级选项</span>
scrcpy --max-size=1920  <span class="hljs-comment"># 限制分辨率</span>
scrcpy --bit-rate=8M    <span class="hljs-comment"># 限制码率</span>
scrcpy --lock-video=landscape  <span class="hljs-comment"># 锁定横屏</span>
</code></pre>
<p><strong>与 Open-AutoGLM 配合使用</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 终端 1：启动模型</span>
python3 -m vllm.entrypoints.openai.api_server --model models/autoglm-phone-9b --port 8000 &amp;

<span class="hljs-comment"># 终端 2：启动 scrcpy</span>
scrcpy &amp;

<span class="hljs-comment"># 终端 3：运行 Open-AutoGLM</span>
python main.py --base-url http://localhost:8000/v1 --model autoglm-phone-9b
</code></pre>
<h3 data-id="heading-40">5.5 批量任务执行</h3>
<p>创建任务脚本，批量执行自动化任务。</p>
<p><strong>创建任务文件 tasks.txt</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">打开微信，给<span class="hljs-string">"文件传输助手"</span>发送<span class="hljs-string">"你好"</span>
打开支付宝，查看余额
打开淘宝，搜索<span class="hljs-string">"iPhone 15"</span>
</code></pre>
<p><strong>批量执行脚本</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> subprocess

<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_task</span>(<span class="hljs-params">command</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"执行任务: <span class="hljs-subst">{command}</span>"</span>)
    result = subprocess.run(
        [<span class="hljs-string">"python"</span>, <span class="hljs-string">"main.py"</span>] + command.split(),
        capture_output=<span class="hljs-literal">True</span>,
        text=<span class="hljs-literal">True</span>
    )
    <span class="hljs-built_in">print</span>(result.stdout)
    <span class="hljs-keyword">return</span> result.returncode == <span class="hljs-number">0</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"tasks.txt"</span>, <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:
        task = line.strip()
        <span class="hljs-keyword">if</span> task:
            run_task(task)
</code></pre>
<h2 data-id="heading-41">六、参考与延伸阅读</h2>
<h3 data-id="heading-42">官方文档</h3>
<ul>
<li><strong>官方 GitHub 仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzai-org%2FOpen-AutoGLM" target="_blank" title="https://github.com/zai-org/Open-AutoGLM" ref="nofollow noopener noreferrer">Open-AutoGLM GitHub</a>（含完整参数说明和最新更新）</li>
<li><strong>智谱开放平台文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.bigmodel.cn%2Fdocs%2Fautoglm-phone" target="_blank" title="https://open.bigmodel.cn/docs/autoglm-phone" ref="nofollow noopener noreferrer">AutoGLM-Phone 使用指南</a></li>
</ul>
<h3 data-id="heading-43">社区资源</h3>
<ul>
<li><strong>B 站实战教程</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1xxxxx%2F" target="_blank" title="https://www.bilibili.com/video/BV1xxxxx/" ref="nofollow noopener noreferrer">云 GPU + 双卡优化教程</a></li>
<li><strong>CSDN 昇腾开源专区</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fxxx" target="_blank" title="https://blog.csdn.net/xxx" ref="nofollow noopener noreferrer">详细部署流程</a></li>
<li><strong>Eslzzyl 博客</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Feslzzyl.com" target="_blank" title="https://eslzzyl.com" ref="nofollow noopener noreferrer">本地实测笔记</a></li>
</ul>
<h3 data-id="heading-44">相关技术</h3>
<ul>
<li><strong>vLLM 官方文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvllm.ai%2F" target="_blank" title="https://vllm.ai/" ref="nofollow noopener noreferrer">高性能推理框架</a></li>
<li><strong>ADB 官方文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%2Fcommand-line%2Fadb" target="_blank" title="https://developer.android.com/studio/command-line/adb" ref="nofollow noopener noreferrer">Android Debug Bridge</a></li>
<li><strong>OpenAI API 兼容性</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Fapi-reference" target="_blank" title="https://platform.openai.com/docs/api-reference" ref="nofollow noopener noreferrer">API 参考文档</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建AI智能体：五十二、反应式智能体：基于“感知-行动”，AI世界的条件反射]]></title>    <link>https://juejin.cn/post/7582905804048351259</link>    <guid>https://juejin.cn/post/7582905804048351259</guid>    <pubDate>2025-12-14T02:08:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582905804048351259" data-draft-id="7582955784570110003" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建AI智能体：五十二、反应式智能体：基于“感知-行动”，AI世界的条件反射"/> <meta itemprop="keywords" content="Agent,人工智能,Python"/> <meta itemprop="datePublished" content="2025-12-14T02:08:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="彼岸花开了吗"/> <meta itemprop="url" content="https://juejin.cn/user/4153315734334538"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建AI智能体：五十二、反应式智能体：基于“感知-行动”，AI世界的条件反射
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4153315734334538/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    彼岸花开了吗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T02:08:27.000Z" title="Sun Dec 14 2025 02:08:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、初识反应式智能体</h2>
<p>前一篇我们详细了解了深思熟虑智能体，今天我们讨论智能体的另一种类型，反应式智能体，想象一下，当我们的手不小心触碰到一个滚烫的杯子时，我们会瞬间缩回。这个过程中，我们的大脑甚至还没有意识到烫这个概念，手已经完成了动作。这种不经过深思熟虑、直接由刺激引发的快速反应，就是反应式智能体的核心思想。</p>
<p>反应式智能体是一种基于“感知-行动”模式的智能系统。它不依赖复杂的内部世界模型，不进行耗时的推理规划，而是像生物的条件反射一样，根据当前的环境输入直接产生行为输出。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2e1b78d85b14254a54aa4b06ff77e7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766283064&amp;x-signature=a3t1nbpokBlVsLBy9OeWq3qRu%2BQ%3D" alt="" loading="lazy"/></p>
<p>一个简单的比喻：</p>
<ul>
<li>**反应式智能体：**好比蜜蜂采蜜，蜜蜂看到花朵就飞过去，遇到障碍就转向，整个过程流畅自然</li>
<li>**深思熟虑智能体：**好比棋手下棋，每走一步都需要深思熟虑，考虑各种可能性</li>
</ul>
<p>这种设计使得反应式智能体在需要快速响应的场景中表现出色，成为机器人学、自动驾驶、工业自动化等领域的基石技术，反应式智能体是一种基础且强大的智能体范式，它摒弃了复杂的内部世界模型和前瞻性规划，转而强调对环境的即时、直接响应。这种“刺激-反应”模式，使其在动态、快速变化的环境中表现出极高的效率和鲁棒性。</p>
<h2 data-id="heading-1">二、什么是反应式智能体</h2>
<p>反应式智能体的设计源于对自然界（如昆虫）高效行为的观察，一只蜜蜂不需要构建整个花园的认知地图，它只需根据光线、花朵形状和气味等即时感官输入，就能做出飞向花蜜的决定。</p>
<p><strong>1. 核心概念</strong></p>
<p>反应式智能体是一种不依赖内部世界模型，也不进行复杂推理，其决策和行动直接由当前时刻的感知输入所决定的智能系统。它</p>
<p><strong>2. 基本工作模式</strong></p>
<p>反应式智能体的的工作模式可以概括为一个极其简化的公式：感知 → 反应。它的工作流程可以概括为一个极其简洁的循环：环境感知 → 条件匹配 → 动作执行 → 环境改变</p>
<p>这个循环的关键在于没有中间的思考环节，智能体不需要回答“我在哪里？”“我要去哪里？”这样的哲学问题，它只需要知道“现在该做什么”。</p>
<p><strong>3. 条件-动作规则</strong></p>
<p>反应式智能体的大脑由一系列简单的“如果-那么”规则组成：</p>
<pre><code class="hljs language-css" lang="css">规则集 = <span class="hljs-selector-attr">[    <span class="hljs-string">"如果(前方有障碍物) 那么(向左转)"</span>,    <span class="hljs-string">"如果(电量低于20%) 那么(返回充电)"</span>,    <span class="hljs-string">"如果(检测到目标) 那么(向前移动)"</span>,    <span class="hljs-string">"如果(无特殊情况) 那么(随机探索)"</span>]</span>
</code></pre>
<p>这些规则就像生物的神经反射弧，每个都负责处理特定的情境。当环境提供的感知输入匹配某个规则的条件时，对应的动作就会被立即触发。</p>
<p><strong>4. 行为的涌现</strong></p>
<p>单个规则可能很简单，但多个规则组合起来就能产生复杂的行为表现。这种现象被称为“涌现”——整体行为大于部分之和。</p>
<p>实例说明：一个扫地机器人只有三个简单规则：</p>
<ul>
<li>遇到障碍就转向</li>
<li>检测到灰尘就清扫</li>
<li>默认情况下直线前进</li>
</ul>
<p>单独看每个规则都很简单，但组合起来后，机器人就能在房间里自主移动、避开家具、清扫灰尘，表现出相当复杂的智能行为。这种从简单规则中产生复杂行为的过程，正是反应式智能体的魅力所在。</p>
<p><strong>5. 核心原则</strong></p>
<ul>
<li>紧耦合的感知-行动循环：智能体的行动直接由当前的感知输入触发，中间没有复杂的思考或规划过程。</li>
<li>无内部状态模型：反应式智能体不维护关于世界历史的内部模型，它的决策完全基于现在，这简化了设计并避免了因模型不准确导致的错误。</li>
<li>行为分解：复杂的行为不是通过一个庞大的程序实现的，而是通过一系列简单的、并行的行为模式组合而成。</li>
<li>涌现行为：智能体整体的、看似复杂的行为，是由多个简单行为在环境交互中涌现出来的，而非预先编程的。</li>
</ul>
<p><strong>6. 反应式智能体的优势</strong></p>
<ul>
<li>速度快： 响应延迟极低，适用于需要快速反应的任务，如避障。</li>
<li>鲁棒性强： 由于不依赖可能出错的内部模型，在部分传感器失效时，剩余的行为模式仍能保证基本功能。</li>
<li>设计简单： 模块化设计，易于实现、测试和调试。</li>
</ul>
<p><strong>7. 反应式智能体的劣势</strong></p>
<ul>
<li>智能受限： 无法进行需要记忆和规划的任务，如下棋、复杂决策。</li>
<li>可能陷入局部循环： 例如，一个机器人可能会在两个障碍物之间来回摆动。</li>
</ul>
<p><strong>8. 一个生活化的比喻：膝跳反射</strong></p>
<p>医生用小锤敲击你的膝盖，你的小腿会不受控制地向前踢出。这个过程：</p>
<ul>
<li>感知：膝盖肌腱被敲击。</li>
<li>处理：脊髓层面的神经回路，无需大脑思考。</li>
<li>行动：小腿踢出。</li>
</ul>
<p>这就是一个典型的反应式过程——快速、直接、不经过深思熟虑，反应式智能体正是将这种模式应用在了机器决策上。</p>
<h2 data-id="heading-2">三、反应式智能体的架构</h2>
<h3 data-id="heading-3">1. 行为层次的概念</h3>
<p>当多个规则可能同时被激活时，如何决定执行哪个动作？机器人学家罗德尼·布鲁克斯提出了包容架构来解决这个问题。</p>
<p>包容架构的核心思想是：将智能体分解为多个行为层，每个层都是一个独立的“感知-行动”模块。这些层并行运行，但通过优先级机制进行协调。</p>
<h3 data-id="heading-4">2. 流程详解</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67bb06b0a47d4971b3482a6d3c38f473~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766283064&amp;x-signature=TOMfJRr2hBx3rz%2B88OwPfTNOrto%3D" alt="" loading="lazy"/>​</p>
<p><strong>流程说明：</strong></p>
<ul>
<li>1. 感知阶段
<ul>
<li>环境传感器输入：通过摄像头、雷达等传感器收集环境数据</li>
<li>感知数据处理：对原始数据进行清洗、分析和理解</li>
</ul>
</li>
<li>2. 决策阶段
<ul>
<li>行为条件检查：将处理后的数据与预设的行为条件进行匹配</li>
<li>行为激活：满足条件的行为被激活，生成对应动作</li>
<li>行为仲裁：当多个行为冲突时，选择最高优先级的动作执行</li>
</ul>
</li>
<li>3. 执行阶段
<ul>
<li>最终动作输出：执行选定的动作</li>
<li>环境影响：动作改变环境，引发新的传感器输入</li>
</ul>
</li>
</ul>
<p><strong>流程总结：</strong></p>
<ul>
<li>循环往复：整个过程形成一个连续的"感知-行动"循环</li>
<li>实时响应：不进行复杂思考，直接根据当前环境做出反应</li>
<li>并行处理：多个行为条件同时检查，提高响应速度</li>
</ul>
<h3 data-id="heading-5">3. 关键组件</h3>
<ul>
<li>感知模块： 从传感器（如摄像头、激光雷达、触须）读取原始数据，并进行必要的预处理（如过滤噪声、识别特定特征）。</li>
<li>行为集合： 一系列简单的“如果-那么”规则或函数。
<ul>
<li>“如果”部分： 感知条件的布尔组合。</li>
<li>“那么”部分： 要执行的动作或向量。</li>
<li>例如：如果 (前方有障碍物) 那么 (向左转)</li>
</ul>
</li>
<li>仲裁机制： 当多个行为同时被激活时，仲裁机制决定哪个行为拥有控制权。常见策略包括：
<ul>
<li>固定优先级： 某些行为（如“避障”）永远比“探索”行为优先级高。</li>
<li>抑制结构： 高优先级行为可以抑制低优先级行为的输出。</li>
<li>向量求和： 将所有行为输出的动作向量（如速度、转向角）相加，得到最终动作。</li>
</ul>
</li>
</ul>
<p>在包容架构中，行为层被组织成不同的优先级：</p>
<ul>
<li>高优先级：避障行为 ← 生命安全最重要</li>
<li>中优先级：任务行为 ← 完成主要任务</li>
<li>低优先级：探索行为 ← 默认行为</li>
</ul>
<p>仲裁原则：高优先级行为可以抑制低优先级行为。就像在人类行为中，躲避危险的本能会压制其他所有想法。</p>
<h3 data-id="heading-6">4. 实际应用场景</h3>
<p>考虑一个自动驾驶汽车的反应式系统：</p>
<pre><code class="hljs language-bash" lang="bash">行为层 = {
    <span class="hljs-comment"># 最高优先级：安全相关</span>
    <span class="hljs-string">"紧急制动"</span>: {<span class="hljs-string">"条件"</span>: <span class="hljs-string">"碰撞 imminent"</span>, <span class="hljs-string">"动作"</span>: <span class="hljs-string">"全力刹车"</span>},
    
    <span class="hljs-comment"># 高优先级：避障</span>
    <span class="hljs-string">"主动避障"</span>: {<span class="hljs-string">"条件"</span>: <span class="hljs-string">"前方有障碍"</span>, <span class="hljs-string">"动作"</span>: <span class="hljs-string">"转向避让"</span>},
    
    <span class="hljs-comment"># 中优先级：导航</span>
    <span class="hljs-string">"车道保持"</span>: {<span class="hljs-string">"条件"</span>: <span class="hljs-string">"偏离车道"</span>, <span class="hljs-string">"动作"</span>: <span class="hljs-string">"微调方向"</span>},
    
    <span class="hljs-comment"># 低优先级：舒适性</span>
    <span class="hljs-string">"平稳驾驶"</span>: {<span class="hljs-string">"条件"</span>: <span class="hljs-string">"道路弯曲"</span>, <span class="hljs-string">"动作"</span>: <span class="hljs-string">"平滑转向"</span>}
}
</code></pre>
<p>当多个条件同时满足时，只有最高优先级的动作会被执行，这种设计确保了系统在任何情况下都能做出最安全的选择。</p>
<h2 data-id="heading-7">四、反应式智能体的构建 - 包容架构</h2>
<p>如何将多个简单的“条件-动作”规则组合起来，形成复杂的行为？机器人学家罗德尼·布鲁克斯提出了经典的 “包容架构”。</p>
<h3 data-id="heading-8">1. 核心思想</h3>
<p>包容架构将智能体分解为多个行为层，每个层都是一个简单的“条件-动作”模块。这些层并行运行，但通过 “抑制” 与 “抑制” 机制进行协调。</p>
<ul>
<li>抑制：高优先级行为可以覆盖低优先级行为的输出信号。</li>
<li>抑制：高优先级行为可以阻断低优先级行为接收输入信号。</li>
</ul>
<h3 data-id="heading-9">2. 一个机器人的行为层设计</h3>
<p>假设我们要构建一个室内清扫机器人：</p>
<ul>
<li>层一（最低优先级）：充电行为
<ul>
<li>条件：电量 &lt; 10%。</li>
<li>动作：向充电桩移动。</li>
</ul>
</li>
<li>层二（中优先级）：清扫行为
<ul>
<li>条件：检测到灰尘。</li>
<li>动作：启动刷子并前进。</li>
</ul>
</li>
<li>层三（最高优先级）：避障行为
<ul>
<li>条件：前方近距离检测到障碍物。</li>
<li>动作：停止，转向。</li>
</ul>
</li>
</ul>
<p>仲裁过程：当机器人正在清扫时（层二激活），如果突然前方出现障碍物，避障行为（层三）会立即抑制清扫行为（层二）的输出，让机器人先转向。避开障碍物后，避障行为条件不再满足，清扫行为重新取得控制权，这保证了机器人的安全。</p>
<h3 data-id="heading-10">3. 包容架构流程图</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c8504c12a4d457885fa42ad4ab07a55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766283064&amp;x-signature=lxPtuxMlOuxyxQtQJZtF8UrFxuE%3D" alt="" loading="lazy"/>​</p>
<p><strong>工作过程：</strong></p>
<ul>
<li>传感器输入同时传递给所有行为层</li>
<li>各层独立判断是否满足执行条件</li>
<li>抑制机制生效：
<ul>
<li>需要避障时，避障层抑制清扫和充电</li>
<li>需要清扫时，清扫层只抑制充电</li>
<li>都不需要时，执行充电层</li>
</ul>
</li>
<li>动作仲裁选择最终要执行的动作</li>
</ul>
<p><strong>核心机制：</strong></p>
<ul>
<li>三层并行处理：避障、清扫、充电三个行为层同时接收传感器输入</li>
<li>优先级抑制：高优先级行为可以抑制低优先级行为</li>
<li>行为仲裁：最终只有一个动作被输出执行</li>
</ul>
<h3 data-id="heading-11">4. 完整构建步骤</h3>
<ul>
<li>1. 定义任务和目标： 明确智能体需要完成什么。例如：“在房间里漫游而不撞到任何东西”。</li>
<li>2. 识别相关情境： 列出智能体在执行任务时可能遇到的所有关键场景。例如：“前方有障碍物”、“左侧有障碍物”、“右侧空旷”、“发现目标”。</li>
<li>3. 设计行为模式： 为每个情境设计一个简单的、直接的行为。
<ul>
<li>避障行为： 如果前方近处有障碍，则后退并转向。</li>
<li>沿墙行为： 如果左侧有障碍物且距离适中，则保持平行前进。</li>
<li>漫游行为： 如果没有特定输入，则随机或直线前进。</li>
</ul>
</li>
<li>4. 设定行为优先级： 确定行为的轻重缓急。通常，生存相关（如避障）的行为优先级最高。</li>
<li>5. 实现仲裁机制： 编写代码将行为组合起来，确保在任何时刻，最高优先级的有效行为主导智能体的行动。</li>
<li>6. 迭代测试与调优： 在模拟或真实环境中反复测试，调整行为的参数（如探测距离、转向速度），以优化性能。</li>
</ul>
<h2 data-id="heading-12">五、示例：最简单的清洁机器人</h2>
<p>这是一个简单的扫地机器人智能控制系统，完美展示了反应式设计。</p>
<ul>
<li>感知： 当前位置的传感器（脏 或 干净）。</li>
<li>行为：
<ul>
<li>清洁行为： 如果 (当前位置是脏的) 那么 (吸尘)</li>
<li>移动行为： 如果 (当前位置是干净的) 那么 (随机移动到一个相邻格子)</li>
</ul>
</li>
<li>仲裁： “清洁行为”的优先级高于“移动行为”。</li>
<li>分析： 机器人没有地图，不知道哪些地方清洁过。它的行为完全基于当前的局部感知，但长期来看，它最终能清洁整个区域。</li>
</ul>
<p>在代码运行后体现几大功能点：</p>
<ul>
<li>机器人自主导航：在没有地图的情况下避开所有障碍物</li>
<li>智能行为切换：根据环境自动在避障、沿墙、探索间切换</li>
<li>实时决策显示：动态显示当前行为和传感器状态</li>
<li>轨迹分析：通过颜色可以看到不同行为对应的运动模式</li>
</ul>
<h3 data-id="heading-13">1. 代码重点部分</h3>
<p><strong>1.1 传感器模拟原理</strong></p>
<pre><code class="hljs language-ini" lang="ini">def get_sensor_readings(self, obstacles):
    <span class="hljs-attr">readings</span> = []
    for sensor_angle in self.sensor_angles:
        <span class="hljs-attr">sensor_dir</span> = np.array([
            np.cos(self.angle + sensor_angle),  <span class="hljs-comment"># 传感器方向向量x分量</span>
            np.sin(self.angle + sensor_angle)   <span class="hljs-comment"># 传感器方向向量y分量</span>
        ])
        
        <span class="hljs-attr">min_distance</span> = self.sensor_range  <span class="hljs-comment"># 初始化为最大探测距离</span>
        
        for obstacle in obstacles:
            <span class="hljs-comment"># 计算机器人到障碍物的向量</span>
            <span class="hljs-attr">obstacle_pos</span> = np.array([obstacle[<span class="hljs-number">0</span>], obstacle[<span class="hljs-number">1</span>]])
            <span class="hljs-attr">robot_pos</span> = np.array([self.x, self.y])
            <span class="hljs-attr">to_obstacle</span> = obstacle_pos - robot_pos
            
            <span class="hljs-comment"># 向量投影：判断障碍物是否在传感器前方</span>
            <span class="hljs-attr">projection</span> = np.dot(to_obstacle, sensor_dir)
            
            if projection &gt; 0:  <span class="hljs-comment"># 障碍物在传感器前方</span>
                <span class="hljs-comment"># 计算障碍物到传感器射线的垂直距离</span>
                <span class="hljs-attr">distance_to_ray</span> = np.linalg.norm(to_obstacle - projection * sensor_dir)
                
                if distance_to_ray &lt; obstacle<span class="hljs-section">[2]</span>:  <span class="hljs-comment"># 如果距离小于障碍物半径</span>
                    <span class="hljs-comment"># 计算实际的碰撞距离</span>
                    <span class="hljs-attr">hit_distance</span> = projection - np.sqrt(obstacle[<span class="hljs-number">2</span>]**<span class="hljs-number">2</span> - distance_to_ray**<span class="hljs-number">2</span>)
                    if 0 &lt; hit_distance &lt; min_distance:
                        <span class="hljs-attr">min_distance</span> = hit_distance
            
            readings.append(min_distance)
    return readings
</code></pre>
<ul>
<li>sensor_dir：计算每个传感器的方向向量</li>
<li>projection &gt; 0：确保只检测前方的障碍物</li>
<li>distance_to_ray &lt; obstacle[2]：判断是否与障碍物相交</li>
<li>返回5个传感器的距离读数列表</li>
</ul>
<p><strong>1.2 反应式决策核心</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">reactive_control</span>(<span class="hljs-params">self, sensor_readings</span>):
    <span class="hljs-comment"># 传感器分组：左2个、前1个、右2个</span>
    left_readings = sensor_readings[:<span class="hljs-number">2</span>]    <span class="hljs-comment"># 左侧传感器</span>
    front_readings = sensor_readings[<span class="hljs-number">2</span>]    <span class="hljs-comment"># 前方传感器  </span>
    right_readings = sensor_readings[<span class="hljs-number">3</span>:]   <span class="hljs-comment"># 右侧传感器</span>
    
    <span class="hljs-comment"># 计算各方向的最小距离</span>
    min_front = <span class="hljs-built_in">min</span>(front_readings, self.sensor_range)
    min_left = <span class="hljs-built_in">min</span>(left_readings)
    min_right = <span class="hljs-built_in">min</span>(right_readings)
    
    <span class="hljs-comment"># 行为1: 紧急避障 (最高优先级)</span>
    <span class="hljs-keyword">if</span> min_front &lt; <span class="hljs-number">0.8</span>:  <span class="hljs-comment"># 前方很近有障碍</span>
        self.speed = <span class="hljs-number">0.3</span>  <span class="hljs-comment"># 减速</span>
        <span class="hljs-comment"># 选择更空旷的一侧转向</span>
        <span class="hljs-keyword">if</span> min_left &gt; min_right:
            self.angle -= np.pi/<span class="hljs-number">4</span>  <span class="hljs-comment"># 向右转45度</span>
        <span class="hljs-keyword">else</span>:
            self.angle += np.pi/<span class="hljs-number">4</span>  <span class="hljs-comment"># 向左转45度</span>
        self.current_behavior = <span class="hljs-string">"紧急避障"</span>
        <span class="hljs-keyword">return</span> self.current_behavior
    
    <span class="hljs-comment"># 行为2: 预防性避障 (中优先级)</span>
    <span class="hljs-keyword">elif</span> min_front &lt; <span class="hljs-number">1.5</span>:  <span class="hljs-comment"># 前方较近有障碍</span>
        self.speed = <span class="hljs-number">0.4</span>
        <span class="hljs-keyword">if</span> min_left &gt; min_right:
            self.angle -= np.pi/<span class="hljs-number">8</span>  <span class="hljs-comment"># 向右转22.5度</span>
        <span class="hljs-keyword">else</span>:
            self.angle += np.pi/<span class="hljs-number">8</span>  <span class="hljs-comment"># 向左转22.5度</span>
        self.current_behavior = <span class="hljs-string">"预防避障"</span>
        <span class="hljs-keyword">return</span> self.current_behavior
    
    <span class="hljs-comment"># 行为3: 沿墙跟随 (低优先级)</span>
    <span class="hljs-keyword">elif</span> min_left &lt; <span class="hljs-number">1.2</span> <span class="hljs-keyword">or</span> min_right &lt; <span class="hljs-number">1.2</span>:  <span class="hljs-comment"># 侧面有墙</span>
        self.speed = <span class="hljs-number">0.6</span>
        <span class="hljs-keyword">if</span> min_left &lt; min_right:  <span class="hljs-comment"># 左侧有墙</span>
            self.angle -= <span class="hljs-number">0.1</span>  <span class="hljs-comment"># 向右微调</span>
        <span class="hljs-keyword">else</span>:  <span class="hljs-comment"># 右侧有墙  </span>
            self.angle += <span class="hljs-number">0.1</span>  <span class="hljs-comment"># 向左微调</span>
        self.current_behavior = <span class="hljs-string">"沿墙跟随"</span>
        <span class="hljs-keyword">return</span> self.current_behavior
    
    <span class="hljs-comment"># 行为4: 随机探索 (默认行为)</span>
    <span class="hljs-keyword">else</span>:
        self.speed = <span class="hljs-number">0.8</span>  <span class="hljs-comment"># 正常速度</span>
        <span class="hljs-comment"># 加入随机扰动，避免陷入局部循环</span>
        self.angle += random.uniform(-<span class="hljs-number">0.2</span>, <span class="hljs-number">0.2</span>)
        self.current_behavior = <span class="hljs-string">"随机探索"</span>
        <span class="hljs-keyword">return</span> self.current_behavior
</code></pre>
<ul>
<li>固定优先级：紧急避障 &gt; 预防避障 &gt; 沿墙跟随 &gt; 随机探索</li>
<li>距离阈值：不同距离触发不同行为</li>
<li>转向策略：总是转向更空旷的一侧</li>
<li>速度调节：危险时减速，安全时加速</li>
</ul>
<p><strong>1.3 位置更新逻辑</strong></p>
<pre><code class="hljs language-ini" lang="ini">def update_position(self, obstacles, area_bounds):
    <span class="hljs-comment"># 1. 感知：获取传感器数据</span>
    <span class="hljs-attr">sensor_readings</span> = self.get_sensor_readings(obstacles)
    
    <span class="hljs-comment"># 2. 决策：反应式控制</span>
    <span class="hljs-attr">behavior</span> = self.reactive_control(sensor_readings)
    
    <span class="hljs-comment"># 3. 行动：更新位置</span>
    <span class="hljs-attr">dx</span> = self.speed * np.cos(self.angle) * <span class="hljs-number">0.1</span>  <span class="hljs-comment"># x方向位移</span>
    <span class="hljs-attr">dy</span> = self.speed * np.sin(self.angle) * <span class="hljs-number">0.1</span>  <span class="hljs-comment"># y方向位移</span>
    
    <span class="hljs-attr">new_x</span> = self.x + dx
    <span class="hljs-attr">new_y</span> = self.y + dy
    
    <span class="hljs-comment"># 边界检查：防止跑出环境</span>
    if (area_bounds<span class="hljs-section">[0]</span> &lt; new_x &lt; area_bounds<span class="hljs-section">[2]</span> and 
        area_bounds<span class="hljs-section">[1]</span> &lt; new_y &lt; area_bounds<span class="hljs-section">[3]</span>):
        <span class="hljs-attr">self.x</span> = new_x
        <span class="hljs-attr">self.y</span> = new_y
    
    <span class="hljs-comment"># 记录轨迹（最多100个点）</span>
    self.trajectory.append((self.x, self.y))
    if len(self.trajectory) &gt; 100:
        self.trajectory.pop(0)  <span class="hljs-comment"># 移除最旧的点</span>
        
    return behavior, sensor_readings
</code></pre>
<p><strong>1.4 环境创建与障碍物设置</strong></p>
<pre><code class="hljs language-ini" lang="ini">def create_environment():
    <span class="hljs-comment"># 障碍物格式：(x坐标, y坐标, 半径)</span>
    <span class="hljs-attr">obstacles</span> = [
        (<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0.8</span>),  <span class="hljs-comment"># 中心区域的大障碍物</span>
        (<span class="hljs-number">6</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1.0</span>),  <span class="hljs-comment"># 右侧的大障碍物  </span>
        (<span class="hljs-number">8</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0.6</span>),  <span class="hljs-comment"># 右上角的小障碍物</span>
        (<span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0.7</span>),  <span class="hljs-comment"># 中部偏上的障碍物</span>
        (<span class="hljs-number">7</span>, <span class="hljs-number">7</span>, <span class="hljs-number">0.9</span>),  <span class="hljs-comment"># 右上角的大障碍物</span>
        (<span class="hljs-number">2</span>, <span class="hljs-number">8</span>, <span class="hljs-number">0.5</span>),  <span class="hljs-comment"># 左上角的小障碍物</span>
        (<span class="hljs-number">9</span>, <span class="hljs-number">9</span>, <span class="hljs-number">0.6</span>),  <span class="hljs-comment"># 最右上角的障碍物</span>
        (<span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0.4</span>)   <span class="hljs-comment"># 中心区域的小障碍物</span>
    ]
    
    <span class="hljs-comment"># 环境边界：(x_min, y_min, x_max, y_max)</span>
    <span class="hljs-attr">area_bounds</span> = (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>)
    
    return obstacles, area_bounds
</code></pre>
<ul>
<li>复杂路径：障碍物分布形成曲折的通道</li>
<li>大小混合：不同大小的障碍物增加导航难度</li>
<li>边界限制：10x10的封闭环境</li>
</ul>
<p><strong>1.5 动态动画的核心逻辑</strong></p>
<pre><code class="hljs language-ini" lang="ini">def animate(frame):
    ax.clear()
    
    <span class="hljs-comment"># 更新机器人位置（第一帧除外）</span>
    if frame &gt; 0:
        behavior, <span class="hljs-attr">sensor_readings</span> = robot.update_position(obstacles, area_bounds)
    
    <span class="hljs-comment"># 绘制传感器（颜色编码）</span>
    for i, (sensor_angle, reading) in enumerate(zip(robot.sensor_angles, sensor_readings)):
        <span class="hljs-attr">sensor_dir</span> = np.array([np.cos(robot.angle + sensor_angle), 
                              np.sin(robot.angle + sensor_angle)])
        <span class="hljs-attr">sensor_length</span> = min(reading, robot.sensor_range)
        
        <span class="hljs-attr">end_x</span> = robot.x + sensor_length * sensor_dir[<span class="hljs-number">0</span>]
        <span class="hljs-attr">end_y</span> = robot.y + sensor_length * sensor_dir[<span class="hljs-number">1</span>]
        
        <span class="hljs-comment"># 颜色编码：绿色(安全) → 橙色(警告) → 红色(危险)</span>
        if reading &gt; 1.5:
            <span class="hljs-attr">color</span> = <span class="hljs-string">'green'</span>   <span class="hljs-comment"># 安全距离</span>
        elif reading &gt; 0.8:
            <span class="hljs-attr">color</span> = <span class="hljs-string">'orange'</span>  <span class="hljs-comment"># 警告距离  </span>
        else:
            <span class="hljs-attr">color</span> = <span class="hljs-string">'red'</span>     <span class="hljs-comment"># 危险距离</span>
            
        ax.plot(<span class="hljs-section">[robot.x, end_x]</span>, <span class="hljs-section">[robot.y, end_y]</span>, <span class="hljs-attr">color</span>=color, 
               <span class="hljs-attr">linewidth</span>=<span class="hljs-number">2</span>, alpha=<span class="hljs-number">0.7</span>)
</code></pre>
<ul>
<li>实时更新：每帧重新绘制所有元素</li>
<li>颜色编码：用颜色直观显示传感器状态</li>
<li>轨迹显示：保留历史轨迹显示运动路径</li>
</ul>
<p><strong>1.6 反应式智能体的核心特征</strong></p>
<p><strong>特征1：无内部状态模型</strong></p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 机器人没有记忆环境地图，只依赖当前传感器数据</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">reactive_control</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, sensor_readings</span>):  <span class="hljs-comment"># 只使用当前传感器读数</span>
    <span class="hljs-comment"># 不访问历史数据，不维护环境模型</span>
    <span class="hljs-comment"># 决策完全基于当前的sensor_readings</span>
</code></pre>
<p><strong>特征2：固定优先级仲裁</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 明确的优先级顺序</span>
<span class="hljs-keyword">if</span> min_front &lt; 0.8:        <span class="hljs-comment"># 1. 紧急避障 (最高)</span>
<span class="hljs-keyword">elif</span> min_front &lt; 1.5:      <span class="hljs-comment"># 2. 预防避障  </span>
<span class="hljs-keyword">elif</span> min_left &lt; 1.2 or ... <span class="hljs-comment"># 3. 沿墙跟随</span>
<span class="hljs-keyword">else</span>:                      <span class="hljs-comment"># 4. 随机探索 (最低)</span>
</code></pre>
<p><strong>特征3：实时响应</strong></p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 每帧都重新感知和决策</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">update_position</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, obstacles, area_bounds</span>):
    sensor_readings = <span class="hljs-variable language_">self</span>.get_sensor_readings(obstacles)  <span class="hljs-comment"># 实时感知</span>
    behavior = <span class="hljs-variable language_">self</span>.reactive_control(sensor_readings)      <span class="hljs-comment"># 实时决策</span>
    <span class="hljs-comment"># 立即执行动作</span>
</code></pre>
<p><strong>特征4：行为涌现</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 简单规则组合产生复杂行为</span>
<span class="hljs-comment"># 单个规则很简单，但组合后能：</span>
<span class="hljs-comment"># - 自主避开所有障碍物</span>
<span class="hljs-comment"># - 沿着墙壁行走  </span>
<span class="hljs-comment"># - 探索未知区域</span>
<span class="hljs-comment"># - 不会陷入死循环</span>
</code></pre>
<h3 data-id="heading-14">2. 输出结果</h3>
<p>反应式机器人的动态路径：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83dd8fc66f8242feb48f98a75559d750~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766283064&amp;x-signature=VLy8WxKctvCIyUG4JJ1EO%2BwhJOU%3D" alt="" loading="lazy"/></p>
<p>反应式机器人的静态轨迹图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7094b19bfe6b46258788d9d0b2436e3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766283064&amp;x-signature=WfI6eJnhPbky1LKrKjI41DoizRc%3D" alt="" loading="lazy"/></p>
<p>反应式机器人的传感器工作原理：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42e4fea416994987bb327609da4077a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766283064&amp;x-signature=I1YvBZVAGcPGsfXnrq4YB0daCIk%3D" alt="" loading="lazy"/></p>
<p>反应式机器人的智能体对比：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85213ffbdae248b1a08e273ada75ec06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766283064&amp;x-signature=CGByCgc8SbTDcqOZ9K5AvYnBAkk%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​编辑反应式机器人的行为分析：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1665e8ca736c4a518c620e8843bfc457~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766283064&amp;x-signature=Ac2DEkddZIdBjglxLMYvI2xC8NA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15">六、总结</h2>
<p>反应式智能体以其简单、快速、可靠的核心优势，在AI领域占据了不可替代的一席之地。它完美地诠释了“简单规则产生复杂行为”的涌现智慧。</p>
<ul>
<li>它的主要优势在于：响应延迟极低、对传感器错误不敏感、开发和调试相对简单。</li>
<li>它的主要局限在于：缺乏长远规划能力，在需要深思熟虑的任务中显得愚蠢。</li>
</ul>
<p>反应式智能体代表的是一种工程哲学：用简单、可靠、可验证的组件构建复杂的智能系统。它提醒我们，有时候最有效的解决方案不一定是最复杂的。</p>
<p>就像自然界中的蚂蚁，每个个体都遵循简单的规则，但整个蚁群却展现出令人惊叹的集体智慧。反应式智能体教会我们：智能不一定源于复杂的计算，也可以来自简单规则与环境之间的巧妙互动。</p>
<p>在追求更复杂AI技术的今天，理解反应式智能体的原理和价值，不仅有助于我们构建更可靠的实时系统，也为我们理解智能的本质提供了重要的视角。有时候，后退一步，采用更简单的方法，反而能够走得更远。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux故障诊断系列2-诊断系统启动问题&识别硬件故障]]></title>    <link>https://juejin.cn/post/7583138169378979890</link>    <guid>https://juejin.cn/post/7583138169378979890</guid>    <pubDate>2025-12-14T03:05:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583138169378979890" data-draft-id="7582905804048777243" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux故障诊断系列2-诊断系统启动问题&amp;识别硬件故障"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2025-12-14T03:05:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="源宇宙十三站"/> <meta itemprop="url" content="https://juejin.cn/user/1153816643768987"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux故障诊断系列2-诊断系统启动问题&amp;识别硬件故障
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1153816643768987/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    源宇宙十三站
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T03:05:22.000Z" title="Sun Dec 14 2025 03:05:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚨 Linux系统启动救急指南 | 服务器开不了机？这些技能让你3分钟搞定！</h2>
<h3 data-id="heading-1">📖 写在开头：你是不是也这样？</h3>
<p><strong>第一段：痛点场景</strong></p>
<p>你有没有遇到过这样的噩梦场景？半夜三更，服务器突然宕机，重启后屏幕一片漆黑，只显示"GRUB&gt;"或者干脆进不了系统。你拼命按F2、F12、Delete键，但系统就是不理你。更糟糕的是，老板的夺命连环Call已经打过来了："系统怎么挂了？什么时候能恢复？我们的业务损失谁来承担？"</p>
<p>如果你也经历过这种"开机即绝望"的时刻，那么今天FYC要告诉你一个好消息：<strong>系统启动问题其实有章可循，掌握了正确的方法，你就能像魔法师一样让服务器"起死回生"！</strong></p>
<p>不仅如此，我们还要聊聊<strong>如何识别硬件故障</strong>。毕竟，如果硬件本身有问题，再好的软件配置也是白搭。学会了这些技能，你就能从"救火队员"升级为"系统医生"！</p>
<p><strong>第二段：解决方案概述</strong></p>
<p>今天我们要聊的是<strong>Linux系统启动问题诊断和硬件故障识别</strong>，这是每个运维工程师都必须掌握的生存技能。我们将从BIOS/UEFI启动原理讲起，带你一步步学会如何修复启动加载器、解决服务依赖问题、恢复丢失的root密码，以及如何快速识别和定位硬件故障。</p>
<p>本文将为你带来：</p>
<ul>
<li>🎯 <strong>启动问题诊断三部曲</strong>：BIOS/UEFI启动修复、服务依赖排查、root密码恢复</li>
<li>🔧 <strong>硬件识别神器</strong>：CPU、内存、磁盘、PCI、USB全方位识别工具</li>
<li>📊 <strong>硬件错误监控</strong>：mcelog、rasdaemon帮你提前发现硬件问题</li>
<li>🚀 <strong>虚拟化故障排除</strong>：KVM支持检查、资源过度分配、网络配置问题</li>
<li>💡 <strong>实战案例解析</strong>：真实场景下的启动故障和硬件故障排除全过程</li>
</ul>
<p>跟着FYC走，从此告别"开机即绝望"的时代！</p>
<p><strong>第三段：5维度评分表</strong></p>



































<table><thead><tr><th>维度</th><th>评分</th><th>说明</th></tr></thead><tbody><tr><td><strong>难度等级</strong></td><td>⭐⭐⭐⭐</td><td>需要深入理解启动流程和硬件原理</td></tr><tr><td><strong>实用价值</strong></td><td>⭐⭐⭐⭐⭐</td><td>日常工作中关键时刻的救命稻草</td></tr><tr><td><strong>技术深度</strong></td><td>⭐⭐⭐⭐</td><td>从启动流程到硬件诊断的全面覆盖</td></tr><tr><td><strong>可操作性</strong></td><td>⭐⭐⭐⭐⭐</td><td>所有命令和工具都可以直接使用</td></tr><tr><td><strong>紧急性</strong></td><td>⭐⭐⭐⭐⭐</td><td>系统启动问题通常是最高优先级的故障</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-2">📚 正文：干货满满，但要"喂到嘴里"！</h3>
<h4 data-id="heading-3">🚀 一、启动问题的故障排除：让系统"起死回生"</h4>
<p>服务器开不了机，可能是最让运维工程师头疼的问题。但是别慌，FYC这就来教你如何一步步排查和修复！</p>
<h5 data-id="heading-4">📋 <strong>启动流程回顾：了解启动的每一个环节</strong></h5>
<p>在动手修之前，我们先要搞清楚系统是怎么启动的。一个完整的启动流程包括<strong>10个关键步骤</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> BIOS firmware启动 → 执行开机自检（POST）
<span class="hljs-bullet">2.</span> BIOS扫描启动设备 → 按优先级排序
<span class="hljs-bullet">3.</span> 查找启动记录 → MBR或可启动分区
<span class="hljs-bullet">4.</span> 加载第一级Boot Loader → 从MBR读取
<span class="hljs-bullet">5.</span> 加载第二级Boot Loader → grub2配置文件
<span class="hljs-bullet">6.</span> 解析grub.cfg → 选择启动项
<span class="hljs-bullet">7.</span> 加载内核和initrd → 准备启动
<span class="hljs-bullet">8.</span> 内核初始化硬件 → 加载驱动
<span class="hljs-bullet">9.</span> 挂载根文件系统 → 切换到真实根
<span class="hljs-bullet">10.</span> 启动systemd → 加载服务
</code></pre>
<p>如果这10步中任何一步出了问题，系统就启动不了！而大部分启动问题都出在<strong>步骤4-6</strong>，也就是Boot Loader阶段。</p>
<hr/>
<h4 data-id="heading-5">🔧 二、修复传统BIOS系统的启动问题</h4>
<p>如果你的服务器还在使用传统的BIOS，那么GRUB2的修复方法就是你的救命稻草！</p>
<h5 data-id="heading-6"><strong>GRUB2文件结构：知道文件在哪里，才能修好它</strong></h5>
<p>GRUB2的关键文件分布在以下几个位置：</p>
<pre><code class="hljs language-bash" lang="bash">/boot/                           <span class="hljs-comment"># 内核和初始RAMDISKS</span>
/boot/grub2/                     <span class="hljs-comment"># 配置文件、扩展模块、主题</span>
/boot/grub2/grub.cfg             <span class="hljs-comment"># 主要配置文件（自动生成，不要手动编辑！）</span>
/etc/grub.d/                     <span class="hljs-comment"># 生成配置文件的脚本</span>
/etc/default/grub                 <span class="hljs-comment"># 配置文件变量（应该编辑这个！）</span>
/boot/grub2/grubenv              <span class="hljs-comment"># 存储环境变量</span>
</code></pre>
<p><strong>⚠️ 重要提示</strong>：<code>/boot/grub2/grub.cfg</code>是自动生成的，千万不要手动编辑！要修改GRUB2配置，应该编辑 <code>/etc/default/grub</code>，然后运行 <code>grub2-mkconfig</code>重新生成。</p>
<h5 data-id="heading-7"><strong>配置GRUB2：修改这些参数就够了</strong></h5>
<p>常用配置参数：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑GRUB配置</span>
vim /etc/default/grub

<span class="hljs-comment"># 主要参数说明：</span>
GRUB_TIMEOUT=5              <span class="hljs-comment"># 启动菜单显示时间（秒）</span>
GRUB_DEFAULT=0              <span class="hljs-comment"># 默认启动项（从0开始计数）</span>
GRUB_DEFAULT=saved          <span class="hljs-comment"># 使用上次保存的选择</span>
GRUB_CMDLINE_LINUX=<span class="hljs-string">"..."</span>    <span class="hljs-comment"># 内核命令行参数</span>

<span class="hljs-comment"># 重新生成配置文件</span>
grub2-mkconfig -o /boot/grub2/grub.cfg
</code></pre>
<p><strong>实战示例</strong>：修改启动超时时间</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 编辑配置文件</span>
vim /etc/default/grub
<span class="hljs-comment"># 修改：GRUB_TIMEOUT=10  （改为10秒）</span>

<span class="hljs-comment"># 2. 重新生成grub.cfg</span>
grub2-mkconfig -o /boot/grub2/grub.cfg

<span class="hljs-comment"># 3. 验证配置</span>
grep <span class="hljs-built_in">timeout</span> /boot/grub2/grub.cfg
</code></pre>
<h5 data-id="heading-8"><strong>在MBR中重新安装GRUB2：修复启动加载器的终极方法</strong></h5>
<p>如果GRUB2被破坏或MBR损坏，你需要在救援模式下重新安装：</p>
<p><strong>方法1：使用救援模式（推荐）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 从安装介质启动，选择"Rescue an installed system"</span>
<span class="hljs-comment"># 2. 选择选项1（Continue），系统会挂载到 /mnt/sysimage</span>
<span class="hljs-comment"># 3. 按回车获得shell</span>

<span class="hljs-comment"># 4. chroot到系统</span>
<span class="hljs-built_in">chroot</span> /mnt/sysimage

<span class="hljs-comment"># 5. 验证/boot是否挂载</span>
<span class="hljs-built_in">ls</span> -l /boot

<span class="hljs-comment"># 6. 重新安装GRUB2到MBR</span>
grub2-install /dev/vda    <span class="hljs-comment"># 根据你的磁盘设备名调整</span>

<span class="hljs-comment"># 7. 重新生成配置文件</span>
grub2-mkconfig -o /boot/grub2/grub.cfg

<span class="hljs-comment"># 8. 退出并重启</span>
<span class="hljs-built_in">exit</span>
reboot
</code></pre>
<p><strong>方法2：在运行中的系统上修复（如果还能登录）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 如果系统还能启动，直接运行</span>
grub2-install /dev/vda
grub2-mkconfig -o /boot/grub2/grub.cfg
</code></pre>
<hr/>
<h4 data-id="heading-9">🔌 三、解决UEFI系统上的启动加载器问题</h4>
<p>如果你的服务器使用的是UEFI（现在大部分新服务器都是），那么修复方法会有所不同。</p>
<h5 data-id="heading-10"><strong>UEFI vs BIOS：关键区别要知道</strong></h5>






























<table><thead><tr><th>特性</th><th>BIOS</th><th>UEFI</th></tr></thead><tbody><tr><td><strong>启动记录</strong></td><td>MBR（512字节）</td><td>GPT（分区表）</td></tr><tr><td><strong>磁盘大小</strong></td><td>最大2TiB</td><td>超过2TiB</td></tr><tr><td><strong>启动注册</strong></td><td>扫描设备</td><td>操作系统注册</td></tr><tr><td><strong>配置文件</strong></td><td>/boot/grub2/grub.cfg</td><td>/boot/efi/EFI/redhat/grub.cfg</td></tr></tbody></table>
<h5 data-id="heading-11"><strong>UEFI启动链：shim → grub → kernel</strong></h5>
<p>UEFI系统使用<strong>shim</strong>作为安全启动的桥梁：</p>
<pre><code class="hljs">UEFI固件 → shim.efi → grubx64.efi → kernel
</code></pre>
<p><strong>shim的作用</strong>：</p>
<ul>
<li>用UEFI固件信任的密钥签名</li>
<li>验证并加载grubx64.efi</li>
<li>支持Secure Boot（安全启动）</li>
</ul>
<h5 data-id="heading-12"><strong>修复UEFI启动问题：三步搞定</strong></h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 重新安装grub2-efi和shim</span>
yum reinstall grub2-efi shim

<span class="hljs-comment"># 2. 如果配置文件被删除，重新生成</span>
grub2-mkconfig -o /boot/efi/EFI/redhat/grub.cfg

<span class="hljs-comment"># 3. 如果UEFI启动菜单被删除，重启会自动添加回来</span>
</code></pre>
<h5 data-id="heading-13"><strong>管理UEFI启动目标：efibootmgr神器</strong></h5>
<p><code>efibootmgr</code>是管理UEFI启动条目的专用工具：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装工具</span>
yum install -y efibootmgr

<span class="hljs-comment"># 查看当前启动目标</span>
efibootmgr

<span class="hljs-comment"># 删除启动条目</span>
efibootmgr -B -b 001E

<span class="hljs-comment"># 设置临时启动目标（下次启动生效）</span>
efibootmgr -n -b 002C

<span class="hljs-comment"># 添加新的启动条目</span>
efibootmgr -c -d /dev/sda -p 2 -L <span class="hljs-string">"MyLinux"</span> -l <span class="hljs-string">"\EFI\redhat\grubx64.efi"</span>
<span class="hljs-comment"># 注意：路径中的斜杠要反斜杠！</span>
</code></pre>
<hr/>
<h4 data-id="heading-14">⚙️ 四、处理失败的服务：systemd依赖关系排查</h4>
<p>系统能启动了，但服务起不来？这通常是<strong>服务依赖关系</strong>出了问题！</p>
<h5 data-id="heading-15"><strong>systemd依赖关系类型：六种关系要知道</strong></h5>
<p>systemd支持六种依赖关系：</p>
<ol>
<li>
<p><strong>Requires=</strong>：强依赖，必需的服务</p>
<ul>
<li>如果依赖的服务启动失败，当前服务也会失败</li>
</ul>
</li>
<li>
<p><strong>Wants=</strong>：弱依赖，可选的服务</p>
<ul>
<li>如果依赖的服务启动失败，当前服务仍然可以启动</li>
</ul>
</li>
<li>
<p><strong>Requisite=</strong>：必需且已运行</p>
<ul>
<li>依赖的服务必须已经在运行，否则失败</li>
</ul>
</li>
<li>
<p><strong>Conflicts=</strong>：冲突关系</p>
<ul>
<li>启动当前服务会停止冲突的服务</li>
</ul>
</li>
<li>
<p><strong>Before= / After=</strong>：启动顺序</p>
<ul>
<li>指定服务启动的先后顺序</li>
</ul>
</li>
<li>
<p><strong>RequiresOverridable=</strong>：可覆盖的依赖</p>
<ul>
<li>管理员明确启动时，失败不会导致单元失败</li>
</ul>
</li>
</ol>
<h5 data-id="heading-16"><strong>检查服务依赖：三种方法任你选</strong></h5>
<p><strong>方法1：查看服务详情</strong></p>
<pre><code class="hljs language-bash" lang="bash">systemctl show httpd.service
</code></pre>
<p><strong>方法2：查看依赖树（最常用！）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看服务的所有依赖（树状图）</span>
systemctl list-dependencies httpd.service

<span class="hljs-comment"># 递归查看所有依赖</span>
systemctl list-dependencies --all httpd.service

<span class="hljs-comment"># 反向查看（谁依赖这个服务）</span>
systemctl list-dependencies --reverse httpd.service
</code></pre>
<p><strong>方法3：图形化查看依赖</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装graphviz</span>
yum install -y graphviz

<span class="hljs-comment"># 生成依赖图</span>
systemd-analyze dot httpd.service | dot -Tsvg &gt; httpd-deps.svg
</code></pre>
<h5 data-id="heading-17"><strong>解决服务依赖问题：实战案例</strong></h5>
<p><strong>场景</strong>：httpd和vsftpd都启动失败，原因是它们互相依赖，形成了循环依赖。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看依赖关系</span>
systemctl list-dependencies httpd.service
systemctl list-dependencies vsftpd.service

<span class="hljs-comment"># 2. 检查服务状态</span>
systemctl status httpd.service
systemctl status vsftpd.service

<span class="hljs-comment"># 3. 查看服务单元文件</span>
systemctl <span class="hljs-built_in">cat</span> httpd.service
systemctl <span class="hljs-built_in">cat</span> vsftpd.service

<span class="hljs-comment"># 4. 修改依赖关系（如果需要）</span>
vim /etc/systemd/system/httpd.service.d/override.conf
<span class="hljs-comment"># 删除或修改冲突的依赖项</span>

<span class="hljs-comment"># 5. 重新加载systemd配置</span>
systemctl daemon-reload

<span class="hljs-comment"># 6. 重启服务</span>
systemctl restart httpd.service
systemctl restart vsftpd.service
</code></pre>
<h5 data-id="heading-18"><strong>调试技巧：使用debug-shell获得早期root shell</strong></h5>
<p>如果系统启动卡在某个服务，你可以启用debug shell来调试：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启用debug shell（⚠️ 调试完成后一定要禁用！）</span>
systemctl <span class="hljs-built_in">enable</span> debug-shell.service

<span class="hljs-comment"># 重启后，在tty9上会有一个root shell</span>
<span class="hljs-comment"># 按 Ctrl+Alt+F9 切换到tty9</span>

<span class="hljs-comment"># 调试完成后，禁用debug shell</span>
systemctl <span class="hljs-built_in">disable</span> debug-shell.service
</code></pre>
<p><strong>⚠️ 安全警告</strong>：debug-shell会给任何人提供root访问权限，调试完成后必须禁用！</p>
<hr/>
<h4 data-id="heading-19">🔑 五、恢复丢失的root密码：rd.break大法</h4>
<p>忘记了root密码？别慌！FYC教你如何"破门而入"重置密码。</p>
<h5 data-id="heading-20"><strong>方法1：使用rd.break中断启动流程（推荐）</strong></h5>
<p>这是最快速的方法，不需要外部介质：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 重启系统，在GRUB菜单出现时，选中启动项，按 'e' 键编辑</span>

<span class="hljs-comment"># 2. 找到以 linux16 或 linuxefi 开头的行</span>

<span class="hljs-comment"># 3. 在行尾添加 rd.break（用空格分隔）</span>
<span class="hljs-comment"># 例如：linux16 /vmlinuz ... rd.break</span>

<span class="hljs-comment"># 4. 按 Ctrl+X 启动</span>

<span class="hljs-comment"># 5. 系统会停在initramfs阶段，你会看到一个switch_root shell</span>

<span class="hljs-comment"># 6. 重新挂载根文件系统为可写</span>
mount -o remount,rw /sysroot

<span class="hljs-comment"># 7. chroot到系统</span>
<span class="hljs-built_in">chroot</span> /sysroot

<span class="hljs-comment"># 8. 重置root密码</span>
<span class="hljs-built_in">echo</span> redhat | passwd --stdin root

<span class="hljs-comment"># 9. 修复SELinux上下文（重要！）</span>
load_policy -i
restorecon -Rv /etc

<span class="hljs-comment"># 10. 退出并重启</span>
<span class="hljs-built_in">exit</span>
<span class="hljs-built_in">exit</span>
</code></pre>
<h5 data-id="heading-21"><strong>方法2：使用救援模式</strong></h5>
<p>如果需要更全面的修复，可以使用安装介质的救援模式：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 从安装介质启动，选择"Rescue an installed system"</span>
<span class="hljs-comment"># 2. 选择选项1（Continue），挂载到 /mnt/sysimage</span>
<span class="hljs-comment"># 3. chroot到系统</span>
<span class="hljs-built_in">chroot</span> /mnt/sysimage

<span class="hljs-comment"># 4. 重置密码或编辑/etc/shadow文件</span>
passwd root
<span class="hljs-comment"># 或</span>
vim /etc/shadow

<span class="hljs-comment"># 5. 退出并重启</span>
<span class="hljs-built_in">exit</span>
reboot
</code></pre>
<hr/>
<h4 data-id="heading-22">🔍 六、识别硬件问题：让硬件"开口说话"</h4>
<p>系统能启动，但经常出问题？很可能是硬件有故障！FYC教你如何让硬件"开口说话"。</p>
<h5 data-id="heading-23"><strong>硬件识别工具集：六大神器</strong></h5>
<p><strong>1. 识别CPU：lscpu命令</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看CPU信息</span>
lscpu

<span class="hljs-comment"># 查看CPU支持的flags（重要！）</span>
grep flags /proc/cpuinfo

<span class="hljs-comment"># 检查虚拟化支持</span>
grep -E <span class="hljs-string">'vmx|svm'</span> /proc/cpuinfo
<span class="hljs-comment"># vmx: Intel CPU的虚拟化支持</span>
<span class="hljs-comment"># svm: AMD CPU的虚拟化支持</span>
</code></pre>
<p><strong>2. 识别内存：dmidecode工具</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装工具</span>
yum install -y dmidecode

<span class="hljs-comment"># 查看内存信息</span>
dmidecode -t memory

<span class="hljs-comment"># 查看内存详细信息</span>
dmidecode -t 17
</code></pre>
<p><strong>3. 识别磁盘：lsscsi和hdparm</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装工具</span>
yum install -y lsscsi hdparm

<span class="hljs-comment"># 查看SCSI设备</span>
lsscsi

<span class="hljs-comment"># 查看磁盘详细信息</span>
hdparm -I /dev/sda
</code></pre>
<p><strong>4. 识别PCI硬件：lspci命令</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看PCI设备</span>
lspci

<span class="hljs-comment"># 查看详细信息（-v 增加详细程度）</span>
lspci -v
lspci -vv    <span class="hljs-comment"># 更详细</span>
lspci -vvv   <span class="hljs-comment"># 最详细</span>

<span class="hljs-comment"># 查看特定设备</span>
lspci | grep -i network
lspci | grep -i video
</code></pre>
<p><strong>5. 识别USB硬件：lsusb命令</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装工具</span>
yum install -y usbutils

<span class="hljs-comment"># 查看USB设备</span>
lsusb

<span class="hljs-comment"># 查看详细信息</span>
lsusb -v
</code></pre>
<h5 data-id="heading-24"><strong>硬件错误监控：提前发现问题的眼睛</strong></h5>
<p><strong>工具1：mcelog - 机器检查异常日志</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装工具</span>
yum install -y mcelog

<span class="hljs-comment"># 启动服务</span>
systemctl start mcelog.service
systemctl <span class="hljs-built_in">enable</span> mcelog.service

<span class="hljs-comment"># 查看日志</span>
journalctl -u mcelog.service

<span class="hljs-comment"># 查看/var/log/mcelog文件（如果配置了cron）</span>
<span class="hljs-built_in">tail</span> -f /var/log/mcelog
</code></pre>
<p><strong>工具2：rasdaemon - 可靠性、可用性、可服务性守护进程</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装工具</span>
yum install -y rasdaemon

<span class="hljs-comment"># 启动服务</span>
systemctl start rasdaemon.service
systemctl <span class="hljs-built_in">enable</span> rasdaemon.service

<span class="hljs-comment"># 查看状态</span>
ras-mc-ctl --status

<span class="hljs-comment"># 查看错误</span>
ras-mc-ctl --errors
</code></pre>
<h5 data-id="heading-25"><strong>内存测试：memtest86+帮你找出内存故障</strong></h5>
<p>如果怀疑内存有问题，可以使用memtest86+进行测试：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装工具</span>
yum install -y memtest86+

<span class="hljs-comment"># 运行memtest-setup</span>
memtest-setup

<span class="hljs-comment"># 重新生成GRUB2配置</span>
grub2-mkconfig -o /boot/grub2/grub.cfg

<span class="hljs-comment"># 重启系统，在GRUB菜单中会出现memtest86+选项</span>
<span class="hljs-comment"># 选择它进行内存测试</span>
</code></pre>
<hr/>
<h4 data-id="heading-26">🧩 七、管理内核模块：让硬件驱动听话</h4>
<p>硬件识别完了，接下来要确保驱动正常工作。内核模块管理就是关键！</p>
<h5 data-id="heading-27"><strong>查看和管理内核模块</strong></h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看已加载的模块</span>
lsmod

<span class="hljs-comment"># 查看模块详细信息</span>
modinfo megaraid_sas

<span class="hljs-comment"># 查看模块支持的参数</span>
modinfo -p megaraid_sas

<span class="hljs-comment"># 加载模块</span>
modprobe megaraid_sas

<span class="hljs-comment"># 卸载模块</span>
modprobe -r megaraid_sas

<span class="hljs-comment"># 查看模块依赖关系</span>
modprobe --show-depends megaraid_sas
</code></pre>
<h5 data-id="heading-28"><strong>配置模块参数：让驱动按你的需求工作</strong></h5>
<p>很多内核模块支持参数来调整行为：</p>
<p><strong>方法1：临时设置（立即生效，重启后失效）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在加载模块时设置参数</span>
modprobe megaraid_sas msix=0

<span class="hljs-comment"># 查看当前参数值</span>
<span class="hljs-built_in">cat</span> /sys/module/megaraid_sas/parameters/msix
</code></pre>
<p><strong>方法2：永久设置（推荐）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建模块配置文件</span>
vim /etc/modprobe.d/megaraid_sas.conf

<span class="hljs-comment"># 添加配置</span>
options megaraid_sas msix=0

<span class="hljs-comment"># 如果模块已加载，需要先卸载再加载</span>
modprobe -r megaraid_sas
modprobe megaraid_sas

<span class="hljs-comment"># 验证参数</span>
<span class="hljs-built_in">cat</span> /sys/module/megaraid_sas/parameters/msix
</code></pre>
<p><strong>实战案例</strong>：禁用SAS RAID卡的MSI-X中断</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 问题：日志中频繁出现MSI-X中断错误</span>
<span class="hljs-comment"># 解决：在驱动中禁用MSI-X中断处理</span>

<span class="hljs-comment"># 1. 创建配置文件</span>
<span class="hljs-built_in">cat</span> &gt; /etc/modprobe.d/megaraid_sas.conf &lt;&lt; <span class="hljs-string">EOF
options megaraid_sas msix=0
EOF</span>

<span class="hljs-comment"># 2. 重新加载模块</span>
modprobe -r megaraid_sas
modprobe megaraid_sas

<span class="hljs-comment"># 3. 验证</span>
<span class="hljs-built_in">cat</span> /sys/module/megaraid_sas/parameters/msix
<span class="hljs-comment"># 应该显示：N</span>
</code></pre>
<hr/>
<h4 data-id="heading-29">🖥️ 八、处理虚拟化问题：KVM故障排除</h4>
<p>如果你的环境中使用了KVM虚拟化，那么虚拟机的故障排除也是必备技能！</p>
<h5 data-id="heading-30"><strong>检查硬件虚拟化支持</strong></h5>
<p>KVM需要CPU和固件都支持硬件虚拟化：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 检查CPU是否支持虚拟化</span>
grep -E <span class="hljs-string">'vmx|svm'</span> /proc/cpuinfo
<span class="hljs-comment"># Intel CPU显示vmx，AMD CPU显示svm</span>

<span class="hljs-comment"># 2. 尝试加载KVM模块</span>
modprobe kvm-intel    <span class="hljs-comment"># Intel CPU</span>
<span class="hljs-comment"># 或</span>
modprobe kvm-amd      <span class="hljs-comment"># AMD CPU</span>

<span class="hljs-comment"># 3. 使用virsh检查</span>
virsh capabilities | grep -A 5 kvm

<span class="hljs-comment"># ⚠️ 重要：如果硬件虚拟化不可用，VM会在模拟处理器上运行，性能会慢几个数量级！</span>
</code></pre>
<h5 data-id="heading-31"><strong>检查资源过度分配</strong></h5>
<p>libvirt允许你为VM分配比主机实际资源更多的虚拟资源，这可能导致性能问题：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看主机资源</span>
virsh nodecpustats
virsh nodememstats

<span class="hljs-comment"># 查看虚拟机资源</span>
virsh dommemstats vm1
virsh vcpuinfo vm1

<span class="hljs-comment"># 使用top查看VM进程（VM在主机上显示为普通进程）</span>
top -p $(pgrep -f qemu)
</code></pre>
<p><strong>解决资源过度分配问题</strong>：</p>
<ol>
<li><strong>添加更多物理资源</strong>（最简单）</li>
<li><strong>限制VM资源使用</strong>（使用cgroups）</li>
<li><strong>停止不必要的VM</strong>（释放资源）</li>
</ol>
<h5 data-id="heading-32"><strong>验证libvirt XML配置</strong></h5>
<p>libvirt的虚拟机配置以XML格式存储，配置错误会导致VM无法启动：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 验证XML文件语法</span>
xmllint --noout /etc/libvirt/qemu/vm1.xml

<span class="hljs-comment"># 验证XML配置正确性（更严格的检查）</span>
virt-xml-validate /etc/libvirt/qemu/vm1.xml /usr/share/libvirt/schemas/domain.rng

<span class="hljs-comment"># ⚠️ 注意：不要手动编辑/etc/libvirt/下的文件，应该使用virsh或virt-manager！</span>
</code></pre>
<h5 data-id="heading-33"><strong>虚拟网络问题排查</strong></h5>
<p>libvirt使用软件网桥实现虚拟网络，网络问题也是常见故障：</p>
<p><strong>常见问题1：VM无法从外部访问</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查虚拟网络类型（可能是NAT类型，外部无法访问）</span>
virsh net-list
virsh net-info default

<span class="hljs-comment"># 检查防火墙规则</span>
iptables -L -n | grep virbr

<span class="hljs-comment"># 检查网桥</span>
brctl show
</code></pre>
<p><strong>常见问题2：外部无法访问VM</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查虚拟网络是否是隔离类型</span>
virsh net-info default

<span class="hljs-comment"># 检查hypervisor防火墙规则</span>
firewall-cmd --list-all
</code></pre>
<p><strong>常见问题3：网络连接完全中断</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 如果清除了所有iptables规则，libvirt的网络可能会断</span>
<span class="hljs-comment"># 解决方法：重启libvirtd或虚拟网络</span>
systemctl restart libvirtd.service
<span class="hljs-comment"># 或</span>
virsh net-destroy default
virsh net-start default
</code></pre>
<hr/>
<h4 data-id="heading-34">💼 九、实战案例：完整故障排除流程</h4>
<p>说了这么多理论，FYC给你来个实战案例，看看这些技能是怎么组合使用的！</p>
<h5 data-id="heading-35"><strong>案例1：系统无法启动（BIOS系统）</strong></h5>
<p><strong>场景</strong>：服务器重启后无法启动，GRUB菜单都看不到。</p>
<p><strong>排查步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 从安装介质启动，进入救援模式</span>
<span class="hljs-comment"># 选择"Rescue an installed system" → 选项1（Continue）</span>

<span class="hljs-comment"># 2. chroot到系统</span>
<span class="hljs-built_in">chroot</span> /mnt/sysimage

<span class="hljs-comment"># 3. 检查/boot目录</span>
<span class="hljs-built_in">ls</span> -l /boot
<span class="hljs-comment"># 发现：内核文件存在，但grub2目录可能有问题</span>

<span class="hljs-comment"># 4. 检查磁盘设备名</span>
lsblk

<span class="hljs-comment"># 5. 重新安装GRUB2</span>
grub2-install /dev/vda

<span class="hljs-comment"># 6. 重新生成配置文件</span>
grub2-mkconfig -o /boot/grub2/grub.cfg

<span class="hljs-comment"># 7. 验证配置</span>
<span class="hljs-built_in">ls</span> -l /boot/grub2/grub.cfg

<span class="hljs-comment"># 8. 退出并重启</span>
<span class="hljs-built_in">exit</span>
<span class="hljs-built_in">exit</span>
reboot
</code></pre>
<h5 data-id="heading-36"><strong>案例2：服务启动失败（依赖关系问题）</strong></h5>
<p><strong>场景</strong>：httpd和vsftpd都启动失败，系统能启动但服务无法运行。</p>
<p><strong>排查步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看服务状态</span>
systemctl status httpd.service
systemctl status vsftpd.service

<span class="hljs-comment"># 2. 查看依赖关系</span>
systemctl list-dependencies httpd.service
systemctl list-dependencies vsftpd.service

<span class="hljs-comment"># 3. 查看服务日志</span>
journalctl -u httpd.service -n 50
journalctl -u vsftpd.service -n 50

<span class="hljs-comment"># 4. 查看服务单元文件</span>
systemctl <span class="hljs-built_in">cat</span> httpd.service
systemctl <span class="hljs-built_in">cat</span> vsftpd.service

<span class="hljs-comment"># 5. 发现问题：两个服务互相依赖，形成循环依赖</span>

<span class="hljs-comment"># 6. 修改服务配置（移除冲突的依赖）</span>
vim /etc/systemd/system/httpd.service.d/override.conf
<span class="hljs-comment"># [Unit]</span>
<span class="hljs-comment"># After=vsftpd.service</span>

<span class="hljs-comment"># 7. 重新加载配置</span>
systemctl daemon-reload

<span class="hljs-comment"># 8. 重启服务</span>
systemctl restart httpd.service
systemctl restart vsftpd.service

<span class="hljs-comment"># 9. 验证</span>
systemctl status httpd.service
systemctl status vsftpd.service
</code></pre>
<h5 data-id="heading-37"><strong>案例3：硬件故障识别（内存错误）</strong></h5>
<p><strong>场景</strong>：系统经常出现内存错误，怀疑是硬件故障。</p>
<p><strong>排查步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 检查硬件错误日志</span>
journalctl -u mcelog.service
ras-mc-ctl --errors

<span class="hljs-comment"># 2. 查看内存信息</span>
dmidecode -t memory

<span class="hljs-comment"># 3. 运行内存测试</span>
yum install -y memtest86+
memtest-setup
grub2-mkconfig -o /boot/grub2/grub.cfg

<span class="hljs-comment"># 4. 重启系统，选择memtest86+选项进行测试</span>
<span class="hljs-comment"># 测试完成后，查看结果</span>

<span class="hljs-comment"># 5. 根据测试结果，更换有问题的内存条</span>
</code></pre>
<hr/>
<h3 data-id="heading-38">🎁 写在结尾！</h3>
<h4 data-id="heading-39">📋 价值总结</h4>
<p>今天FYC为你带来了Linux系统启动和硬件故障排除的完整攻略：</p>
<p>✅ <strong>启动问题诊断三部曲</strong>：</p>
<ul>
<li>BIOS/UEFI启动修复：GRUB2重新安装、配置文件重建</li>
<li>systemd服务依赖排查：依赖关系检查、循环依赖解决</li>
<li>root密码恢复：rd.break中断启动流程、救援模式重置</li>
</ul>
<p>✅ <strong>硬件识别神器</strong>：</p>
<ul>
<li>CPU/内存/磁盘/PCI/USB全方位识别工具</li>
<li>硬件错误监控：mcelog、rasdaemon提前发现故障</li>
<li>内存测试：memtest86+找出内存故障</li>
</ul>
<p>✅ <strong>内核模块和虚拟化</strong>：</p>
<ul>
<li>内核模块参数配置：让驱动按需工作</li>
<li>KVM虚拟化支持检查：确保VM性能</li>
<li>libvirt网络故障排除：解决VM网络问题</li>
</ul>
<p>掌握了这些技能，你就能在关键时刻让系统"起死回生"，从"救火队员"升级为"系统医生"！</p>
<h4 data-id="heading-40">🎯 行动号召</h4>
<p><strong>觉得这篇文章还不够过瘾？想要看到更详细的GRUB2配置文件解读、systemd依赖关系深度解析、以及更多硬件故障排查实战案例吗？</strong></p>
<p>👉 <strong>点击下方的【阅读原文】</strong>，即可获取：</p>
<ul>
<li>📚 <strong>完整的启动故障排查检查清单</strong>（Checklist）</li>
<li>🔧 <strong>GRUB2配置文件完整解读</strong>（所有参数说明）</li>
<li>📊 <strong>systemd依赖关系可视化工具</strong>使用指南</li>
<li>🎯 <strong>硬件故障诊断工具速查表</strong>（所有命令和参数）</li>
<li>💡 <strong>更多真实故障案例解析</strong>（BIOS/UEFI/虚拟化全覆盖）</li>
</ul>
<p><strong>FYC的使命</strong>：让每个运维工程师都能成为系统医生！技术要硬核，文案要上头！🔥</p>
<hr/>
<p>#运维 #Linux #系统启动 #硬件故障 #故障排除 #GRUB2 #systemd #KVM #技术干货 #RedHat #RCA</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RequestContextHolder分析]]></title>    <link>https://juejin.cn/post/7583158173978230794</link>    <guid>https://juejin.cn/post/7583158173978230794</guid>    <pubDate>2025-12-14T03:13:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583158173978230794" data-draft-id="7582923861769142322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RequestContextHolder分析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-14T03:13:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="紫璨月"/> <meta itemprop="url" content="https://juejin.cn/user/1751947899320571"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RequestContextHolder分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1751947899320571/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    紫璨月
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T03:13:46.000Z" title="Sun Dec 14 2025 03:13:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RequestContextHolder分析</h2>
<h3 data-id="heading-1">一、它是什么？</h3>
<p><code>org.springframework.web.context.request.RequestContextHolder</code> 是 Spring Web 模块提供的一个<strong>工具类</strong>。它的核心作用是<strong>在当前线程（Thread）中绑定和存储当前 HTTP 请求的上下文信息（即 <code>RequestAttributes</code> 对象）</strong>，并允许你在代码的任何地方（只要在同一线程内）轻松获取到这些信息。</p>
<p>简单来说，它解决了一个问题：<strong>如何在一个非控制器（Controller）的普通类、工具类或业务层（Service）方法中，获取到当前 HTTP 请求的 <code>HttpServletRequest</code> 和 <code>HttpServletResponse</code> 对象？</strong></p>
<hr/>
<h3 data-id="heading-2">二、为什么需要它？</h3>
<p>在标准的 MVC 模式中，<code>HttpServletRequest</code> 和 <code>HttpServletResponse</code> 对象通常只在 Controller 层作为方法参数被直接使用。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-meta">@GetMapping("/user")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUserInfo</span><span class="hljs-params">(HttpServletRequest request)</span> { <span class="hljs-comment">// 在这里可以直接获取</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">userAgent</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"User-Agent"</span>);
        <span class="hljs-comment">// ... 业务逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"info"</span>;
    }
}
</code></pre>
<p>但当你的业务逻辑深入 Service 层、工具类或其他组件时，将这些对象一层层作为参数传递下去，会使代码变得非常臃肿和耦合，违反了设计的简洁性原则。</p>
<p><strong><code>RequestContextHolder</code> 的妙处就在于：它通过线程绑定的机制，让你可以在任何地方“凭空”获取到当前请求的上下文，而无需显式地传递它们。</strong></p>
<hr/>
<h3 data-id="heading-3">三、它是如何工作的？</h3>
<p>其核心机制是 <strong>ThreadLocal</strong>。</p>
<ol>
<li><strong>线程绑定</strong>：当一个 HTTP 请求到达 Spring MVC 的 <code>DispatcherServlet</code> 时，在进入控制器之前，Spring 会通过一个过滤器或拦截器，将当前请求的 <code>RequestAttributes</code>（它封装了 <code>HttpServletRequest</code>, <code>HttpServletResponse</code> 等）对象绑定到<strong>当前处理该请求的线程（ThreadLocal）</strong> 上。</li>
<li><strong>随时获取</strong>：在后续的任意业务逻辑、Service 或工具类中，你都可以通过 <code>RequestContextHolder</code> 类的方法，从当前线程的 ThreadLocal 变量中取出之前绑定的 <code>RequestAttributes</code> 对象。</li>
<li><strong>及时清理</strong>：当请求处理完毕，返回响应之后，Spring 会自动清理当前线程的 ThreadLocal 数据，防止内存泄漏（尤其是在使用线程池的情况下）。</li>
</ol>
<hr/>
<h3 data-id="heading-4">四、怎么使用它？</h3>
<p><code>RequestContextHolder</code> 提供了静态方法，最常用的有：</p>
<h4 data-id="heading-5">1. 获取 <code>RequestAttributes</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 最常用的方法：获取当前线程绑定的 RequestAttributes。</span>
<span class="hljs-comment">// 如果当前线程没有绑定请求上下文，则返回 null。</span>
<span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.getRequestAttributes();

<span class="hljs-comment">// 获取当前线程绑定的 RequestAttributes。</span>
<span class="hljs-comment">// 如果当前线程没有绑定请求上下文，则抛出 IllegalStateException 异常。</span>
<span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.currentRequestAttributes();
</code></pre>
<p><strong>通常推荐在明确处于 Web 请求环境的代码中使用 <code>currentRequestAttributes()</code>，因为它能更快地暴露问题（如果没有上下文，说明你的调用时机或位置不对）。</strong></p>
<h4 data-id="heading-6">2. 获取 <code>HttpServletRequest</code> 和 <code>HttpServletResponse</code></h4>
<p>获取到 <code>RequestAttributes</code> 后，可以从中取出需要的对象：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">servletRequestAttributes</span> <span class="hljs-operator">=</span> (ServletRequestAttributes) attributes;
<span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> servletRequestAttributes.getRequest();
<span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> servletRequestAttributes.getResponse();
</code></pre>
<h4 data-id="heading-7">3. 异步请求中的上下文传递</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncService</span> {
    
    <span class="hljs-meta">@Async</span> <span class="hljs-comment">// 使用 Spring 的异步执行</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">asyncProcess</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 获取请求上下文（需要在配置中启用上下文传递）</span>
        <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> 
            (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        
        <span class="hljs-keyword">if</span> (attributes != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> attributes.getRequest();
            <span class="hljs-type">String</span> <span class="hljs-variable">requestId</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"X-Request-ID"</span>);
            log.info(<span class="hljs-string">"异步处理，Request-ID: {}"</span>, requestId);
        }
        
        <span class="hljs-comment">// 异步业务逻辑</span>
        <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(<span class="hljs-string">"处理完成"</span>);
    }
}

<span class="hljs-comment">/**
 * 异步配置 - 启用上下文传递
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAsync</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AsyncConfigurer</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">getAsyncExecutor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
        executor.setCorePoolSize(<span class="hljs-number">5</span>);
        executor.setMaxPoolSize(<span class="hljs-number">10</span>);
        executor.setQueueCapacity(<span class="hljs-number">100</span>);
        executor.setThreadNamePrefix(<span class="hljs-string">"Async-"</span>);
        executor.initialize();
        
        <span class="hljs-comment">// 包装 Executor 以传递上下文</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelegatingContextExecutor</span>(executor);
    }
}

<span class="hljs-comment">/**
 * 包装 Executor 传递上下文
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelegatingContextExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Executor</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Executor delegate;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DelegatingContextExecutor</span><span class="hljs-params">(Executor delegate)</span> {
        <span class="hljs-built_in">this</span>.delegate = delegate;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Runnable command)</span> {
        <span class="hljs-comment">// 捕获当前请求上下文</span>
        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> RequestContextHolder.currentRequestAttributes();
        
        delegate.execute(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 在子线程中设置上下文</span>
                    RequestContextHolder.setRequestAttributes(context);
                    runnable.run();
                RequestContextHolder.setRequestAttributes(context);
                command.run();
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// 清理上下文</span>
              RequestContextHolder.resetRequestAttributes(); 
            }
        });
    }
}
</code></pre>
<h4 data-id="heading-8">4. 自定义 RequestAttributes</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 自定义请求属性
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomRequestAttributes</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServletRequestAttributes</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; customAttributes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomRequestAttributes</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> {
        <span class="hljs-built_in">super</span>(request, response);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getAttribute</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> scope)</span> {
        <span class="hljs-keyword">if</span> (scope == RequestAttributes.SCOPE_REQUEST) {
            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> customAttributes.get(name);
            <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> value;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.getAttribute(name, scope);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAttribute</span><span class="hljs-params">(String name, Object value, <span class="hljs-type">int</span> scope)</span> {
        <span class="hljs-keyword">if</span> (scope == RequestAttributes.SCOPE_REQUEST) {
            customAttributes.put(name, value);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">super</span>.setAttribute(name, value, scope);
        }
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeAttribute</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> scope)</span> {
        <span class="hljs-keyword">if</span> (scope == RequestAttributes.SCOPE_REQUEST) {
            customAttributes.remove(name);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">super</span>.removeAttribute(name, scope);
        }
    }
}

<span class="hljs-comment">/**
 * 过滤器设置自定义 RequestAttributes
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomRequestAttributesFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OncePerRequestFilter</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
        
        <span class="hljs-comment">// 创建自定义 RequestAttributes</span>
        <span class="hljs-type">CustomRequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomRequestAttributes</span>(request, response);
        
        <span class="hljs-comment">// 设置一些自定义属性</span>
        attributes.setAttribute(<span class="hljs-string">"requestId"</span>, UUID.randomUUID().toString(), 
                              RequestAttributes.SCOPE_REQUEST);
        attributes.setAttribute(<span class="hljs-string">"startTime"</span>, System.currentTimeMillis(), 
                              RequestAttributes.SCOPE_REQUEST);
        
        <span class="hljs-comment">// 设置到 RequestContextHolder</span>
     RequestContextHolder.setRequestAttributes(attributes);
        <span class="hljs-keyword">try</span> {
            filterChain.doFilter(request, response);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 记录请求耗时</span>
            <span class="hljs-type">Long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> (Long) attributes.getAttribute(<span class="hljs-string">"startTime"</span>, 
                                                          RequestAttributes.SCOPE_REQUEST);
            <span class="hljs-keyword">if</span> (startTime != <span class="hljs-literal">null</span>) {
                <span class="hljs-type">long</span> <span class="hljs-variable">costTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;
                logger.info(<span class="hljs-string">"请求耗时: {}ms"</span>, costTime);
            }
            
            attributes.requestCompleted();
            RequestContextHolder.resetRequestAttributes();
        }
    }
}
</code></pre>
<p><strong>注意：要使用自定义的RequestAttributes一定需要配置相应的配套过滤器</strong></p>
<h4 data-id="heading-9">5. 完整的工具类示例</h4>
<p>我们通常会将其封装成一个工具类，方便在整个项目中使用。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;
<span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;

<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> java.util.Objects;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpContextUtil</span> {

    <span class="hljs-comment">/**
     * 获取 HttpServletRequest
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HttpServletRequest <span class="hljs-title function_">getRequest</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> (ServletRequestAttributes) RequestContextHolder.currentRequestAttributes();
        <span class="hljs-keyword">return</span> attributes.getRequest();
    }

    <span class="hljs-comment">/**
     * 获取 HttpServletResponse
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HttpServletResponse <span class="hljs-title function_">getResponse</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> (ServletRequestAttributes) RequestContextHolder.currentRequestAttributes();
        <span class="hljs-keyword">return</span> attributes.getResponse();
    }

    <span class="hljs-comment">/**
     * 获取请求中的属性值
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getAttribute</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> getRequest();
        <span class="hljs-keyword">return</span> request.getAttribute(name);
    }

    <span class="hljs-comment">/**
     * 获取请求头中的值
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getHeader</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> getRequest();
        <span class="hljs-keyword">return</span> request.getHeader(name);
    }

    <span class="hljs-comment">/**
     * 获取请求的完整 URL
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getRequestURL</span><span class="hljs-params">()</span> {
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> getRequest();
        <span class="hljs-keyword">return</span> request.getRequestURL().toString();
    }

    <span class="hljs-comment">/**
     * 获取客户端 IP 地址
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getClientIP</span><span class="hljs-params">()</span> {
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> getRequest();
        <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"X-Forwarded-For"</span>);
        <span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            ip = request.getHeader(<span class="hljs-string">"Proxy-Client-IP"</span>);
        }
        <span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            ip = request.getHeader(<span class="hljs-string">"WL-Proxy-Client-IP"</span>);
        }
        <span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        <span class="hljs-keyword">return</span> ip;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-10">五、使用场景与示例</h3>
<ol>
<li>
<p><strong>在 Service 层获取用户信息</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doBusiness</span><span class="hljs-params">()</span> {
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> HttpContextUtil.getRequest();
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"Authorization"</span>);
        <span class="hljs-comment">// ... 根据 token 解析用户信息并进行业务操作</span>
    }
}
</code></pre>
</li>
<li>
<p><strong>在自定义注解或 AOP 切面中实现权限校验</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionAspect</span> {
    <span class="hljs-meta">@Around("@annotation(requiresPermission)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">checkPermission</span><span class="hljs-params">(ProceedingJoinPoint joinPoint, RequiresPermission requiresPermission)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest();
        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> (String) request.getSession().getAttribute(<span class="hljs-string">"userId"</span>);
        <span class="hljs-comment">// ... 校验用户权限逻辑</span>
        <span class="hljs-keyword">if</span> (!hasPermission(userId, requiresPermission.value())) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"无权限访问"</span>);
        }
        <span class="hljs-keyword">return</span> joinPoint.proceed();
    }
}
</code></pre>
</li>
<li>
<p><strong>在工具类中记录请求日志</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogUtils</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordAccessLog</span><span class="hljs-params">()</span> {
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> HttpContextUtil.getRequest();
        <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> HttpContextUtil.getClientIP();
        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> request.getRequestURL().toString();
        <span class="hljs-type">String</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> request.getMethod();
        <span class="hljs-comment">// ... 将日志信息存入数据库或发送到消息队列</span>
    }
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-11">六、重要注意事项</h3>
<ol>
<li><strong>线程安全性</strong>：<code>RequestContextHolder</code> 本身是线程安全的，因为它基于 ThreadLocal。每个线程操作的都是自己独有的副本，不会相互干扰。</li>
<li><strong>环境限制</strong>：<strong>它只能在 Spring Web 环境下的 HTTP 请求线程中使用</strong>。如果你在以下场景调用，会抛出 <code>IllegalStateException</code>：
<ul>
<li><strong>异步线程（@Async）</strong>：新开启的异步线程无法获取到原请求线程的上下文。</li>
<li><strong>定时任务（@Scheduled）</strong>：定时任务没有与之关联的 HTTP 请求。</li>
<li><strong>普通的 main 方法</strong>或<strong>消息监听器</strong>（如果监听器不在 Web 请求线程中处理消息）。</li>
</ul>
</li>
<li><strong>异步编程中的上下文传递</strong>：如果需要在异步线程中使用请求上下文，必须在启动异步任务之前，将 <code>RequestAttributes</code> 对象捕获并传递到新线程中，然后在新线程开始时将其重新绑定。Spring 提供了 <code>RequestContextListener</code> 和支持 <code>DelegatingRequestContext</code> 的 <code>Executor</code> 来帮助实现这一点。</li>
</ol>
<h3 data-id="heading-12">总结</h3>
<p><code>RequestContextHolder</code> 是 Spring Web 生态中一个“幕后英雄”式的工具类，它利用 ThreadLocal 巧妙地将 HTTP 请求上下文贯穿整个请求处理生命周期，极大地增加了代码的灵活性和可维护性，是解耦 Controller 层与下层组件依赖的利器。理解并正确使用它，是成为 Spring 高级开发者的重要一步。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[BlockLever实战营日志 #6 | 集成测试]]></title>    <link>https://juejin.cn/post/7582905804048859163</link>    <guid>https://juejin.cn/post/7582905804048859163</guid>    <pubDate>2025-12-14T03:09:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582905804048859163" data-draft-id="7583138169378996274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="BlockLever实战营日志 #6 | 集成测试"/> <meta itemprop="keywords" content="AI编程,web3"/> <meta itemprop="datePublished" content="2025-12-14T03:09:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Keegan小钢"/> <meta itemprop="url" content="https://juejin.cn/user/1609340750665758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            BlockLever实战营日志 #6 | 集成测试
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1609340750665758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Keegan小钢
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T03:09:32.000Z" title="Sun Dec 14 2025 03:09:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是我们研发「<strong>BlockLever</strong>」的第 6 篇研发日志，前 5 篇如下：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495403%26idx%3D1%26sn%3D9d79878fd9bd5f4202ff30dfb290e58d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495403&amp;idx=1&amp;sn=9d79878fd9bd5f4202ff30dfb290e58d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">BlockLever实战营日志 #1 | 开营</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495408%26idx%3D1%26sn%3Df13a228d5387e1512da7d07a72741846%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495408&amp;idx=1&amp;sn=f13a228d5387e1512da7d07a72741846&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">BlockLever实战营日志 #2 | 产品需求梳理</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495437%26idx%3D1%26sn%3Dd7c07cb65d8d09888038b2b8890647b3%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495437&amp;idx=1&amp;sn=d7c07cb65d8d09888038b2b8890647b3&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">BlockLever实战营日志 #3 | 合约开发阶段</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495442%26idx%3D1%26sn%3D451f5af91a5ecaeb57ea6835cdc01e22%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495442&amp;idx=1&amp;sn=451f5af91a5ecaeb57ea6835cdc01e22&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">BlockLever实战营日志 #4 | 完成第一个里程碑</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FxrSoCcXpOkUZbh4QoxSqbA" target="_blank" title="https://mp.weixin.qq.com/s/xrSoCcXpOkUZbh4QoxSqbA" ref="nofollow noopener noreferrer">BlockLever实战营日志 #5 | 重新梳理文档</a></li>
</ul>
<p>前天，在做 fork 主网的集成测试的时候，发现在路由合约中引入的 <strong>QuoterV3</strong> 合约无法正常工作，昨天集中精力对其进行了调试，终于发现了问题，修复后集成测试也通过了。</p>
<h2 data-id="heading-0">背景介绍</h2>
<p>很多了解过 <strong>UniswapV3</strong> 的技术人员都知道，其有个 <strong>QuoterV2</strong> 合约提供了系列报价函数，最核心的就是 4 个函数：</p>
<ul>
<li><strong>quoteExactInputSingle</strong></li>
<li><strong>quoteExactOutputSingle</strong></li>
<li><strong>quoteExactInput</strong></li>
<li><strong>quoteExactOutput</strong></li>
</ul>
<p>然而，因为底层实现时会直接调用 <strong>pool</strong> 合约的 <code>swap</code> 函数，所以这几个 <code>quote</code> 函数都无法被声明为 <strong>view</strong> 函数，这就给很多合约接入的项目带来了诸多不便。</p>
<p>在「<strong>BlockLever</strong>」项目中，我们没有接入 UniswapV3，而是接入 <strong>PancakeSwapV3</strong>。而 PancakeSwapV3 是在 UniswapV3 的基础上稍微做了很小的一点改动而部署的，其 <strong>Quoter</strong> 合约也是和 UniswapV3 的一样，几个报价函数也不是只读的 <strong>view</strong> 函数。</p>
<p>「<strong>BlockLever</strong>」的路由合约定义了几个预览函数如下：</p>
<ul>
<li><strong>previewBorrowToBuy</strong></li>
<li><strong>previewSellToRepay</strong></li>
<li><strong>previewBorrowToSell</strong></li>
<li><strong>previewBuyToRepay</strong></li>
</ul>
<p>这几个预览函数需要调用 <strong>Quoter</strong> 合约查询报价，如果我们直接使用以上说的 <code>quote</code> 函数，那我们这几个 <code>preview</code> 函数也一样无法声明为 <code>view</code> 函数。</p>
<p>在 DeFi 协议中，<code>preview</code> 类型的函数并不仅仅是“开发时方便调试用”。它们往往承担着几个非常重要的角色：</p>
<ol>
<li><strong>前端报价预览</strong></li>
<li><strong>区块浏览器直接查询</strong></li>
<li><strong>第三方合约只读调用</strong></li>
<li><strong>风控与策略模拟</strong></li>
</ol>
<p>如果这些函数不是 <code>view</code>，那么：</p>
<ul>
<li>前端需要通过 transaction 调用，体验极差</li>
<li>区块浏览器无法直接查询</li>
<li>第三方协议难以安全集成</li>
<li>用户无法低成本进行策略预估</li>
</ul>
<p>因此，在 BlockLever 中，我们非常明确地将所有 <code>preview</code> 函数定义为 <strong>纯只读函数</strong>，这是一个产品级别的设计决策，而不仅是技术实现细节。</p>
<p>有没有办法解决这个问题呢？其实是有的，我们不用 QuoterV2，改用 <strong>QuoterV3</strong> 即可，这就要用到下面介绍的这个库了。</p>
<h2 data-id="heading-1">view-quoter-v3</h2>
<p>其实 Uniswap 后来是有实现 <strong>v3 版本的 Quoter 合约</strong>的，只不过它是以一个<strong>独立仓库</strong>的形式存在，因此并没有像 QuoterV2 那样被广泛使用和认知。</p>
<p>该项目的 GitHub 地址如下：</p>
<ul>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FUniswap%2Fview-quoter-v3" target="_blank" title="https://github.com/Uniswap/view-quoter-v3" ref="nofollow noopener noreferrer">github.com/Uniswap/vie…</a></strong></li>
</ul>
<p>这个项目中的 <strong>Quoter</strong> 合约，对外提供了与 <strong>QuoterV2</strong> 完全一致的 4 个核心报价函数，同时还额外增加了两个支持直接指定 Pool 的函数：</p>
<ul>
<li><strong>quoteExactInputSingleWithPool</strong></li>
<li><strong>quoteExactOutputSingleWithPool</strong></li>
</ul>
<p>最关键的一点在于：<strong>所有报价函数都被声明为 <code>view</code> 函数</strong>，这正是我们在 BlockLever 中所需要的能力。</p>
<p>其核心实现思路，是将原本位于 <code>UniswapV3Pool</code> 中、依赖 <code>swap</code> 执行过程的计算逻辑，重新抽离并改写为<strong>纯计算逻辑</strong>，从而避免任何状态修改，使其可以安全地以只读方式调用。</p>
<p>Uniswap 官方其实也已经在 <strong>BNB Chain</strong> 上部署了该合约。但由于 BlockLever 接入的并不是 Uniswap，而是 <strong>PancakeSwapV3</strong>，因此无法直接复用该实现。</p>
<p>而 PancakeSwap 官方目前也并没有提供对应的 <strong>view Quoter</strong> 合约，于是我们选择 <strong>fork 该项目，并对其进行适配 PancakeSwapV3 的修改</strong>，以满足路由合约中预览函数的调用需求。</p>
<p>事实上，在第一期实战营项目 <strong>「BlockETF」</strong> 中，我们就已经实现过一版 <strong>适配 PancakeSwap 的只读 Quoter 合约</strong>。</p>
<p>不过，BlockETF 中的预览逻辑并不完全依赖 Quoter 报价结果，而是同时结合了 <strong>价格预言机的数据</strong> 进行计算。因此，即使 Quoter 合约本身存在问题，BlockETF 在实际运行中依然不会出现明显异常。</p>
<p>也正因如此，如果不是这次在 <strong>BlockLever 的主网 fork 集成测试</strong> 中完整跑通真实调用链路，我们很可能会一直<strong>误以为 BlockETF 中使用的 Quoter 实现是完全可用的</strong>。</p>
<p>这次问题的暴露，也再次验证了一个事实：<strong>只有在真实环境下进行系统级集成测试，才能发现那些被业务逻辑“掩盖”的底层隐患。</strong></p>
<h2 data-id="heading-2">适配 PancakeSwap 的核心改动</h2>
<p>将 <strong>view-quoter-v3</strong> 适配为支持 <strong>PancakeSwapV3</strong>，整体改动其实并不多，主要集中在 <strong>Pool 地址计算逻辑</strong> 以及 <strong>Pool 接口定义差异</strong> 这两个方面。</p>
<h3 data-id="heading-3">1. PoolAddress 库的适配</h3>
<p>首先需要修改的是 <strong>PoolAddress</strong> 库合约，该合约中存在两个必须调整的关键点。</p>
<p><strong>第一个修改点</strong> 是 <code>POOL_INIT_CODE_HASH</code>。该常量需要从 <strong>UniswapV3Pool</strong> 的 <code>POOL_INIT_CODE_HASH</code>，替换为 <strong>PancakeSwapV3Pool</strong> 对应的值，否则在计算 Pool 地址时会直接得到错误结果。</p>
<p><strong>第二个修改点</strong> 位于 <code>computeAddress</code> 函数中。在 UniswapV3 中，计算 Pool 地址时使用的是 <strong>Factory 合约地址</strong>；而在 PancakeSwapV3 中，用于计算 Pool 地址的并不是工厂合约，而是 <strong>Deployer 合约地址</strong>。</p>
<p>因此，<code>computeAddress</code> 函数中的 <code>factory</code> 参数需要整体替换为 PancakeSwapV3 的 deployer 地址。</p>
<p>这两处差异，都可以直接通过对比 PancakeSwap 官方仓库中的 <strong>PoolAddress</strong> 实现来确认。</p>
<h3 data-id="heading-4">2. Pool 接口类型的替换</h3>
<p>第二类改动，发生在多个引用 <strong>IUniswapV3Pool</strong> 接口的合约中。</p>
<p>在这些地方，我们统一将接口替换为 <strong>IPancakeV3Pool</strong>。这一问题，正是在本次 <strong>BlockLever 的主网 fork 集成测试</strong> 中被真正暴露出来的。</p>
<p>其根本原因在于，两者虽然接口名和函数结构高度相似，但在 <strong>细节定义上并不完全一致</strong>。</p>
<p>一个非常典型的差异点，是 <code>slot0()</code> 函数的返回值类型：</p>
<ul>
<li>在 <strong>IUniswapV3Pool</strong> 中，<code>feeProtocol</code> 字段的类型为 <strong>uint8</strong></li>
<li>而在 <strong>IPancakeV3Pool</strong> 中，对应字段的类型为 <strong>uint32</strong></li>
</ul>
<p>这一差异在单元测试或模拟环境中并不一定会立刻触发问题，但在 fork 主网、读取真实 Pool 状态时，就会导致 <strong>ABI 解码错误或潜在的逻辑异常</strong>。</p>
<h3 data-id="heading-5">3. 为什么这个问题容易被忽略</h3>
<p>从表面上看，UniswapV3 与 PancakeSwapV3 的 Pool 接口“几乎一致”，但正是这种“高度相似”，反而容易让人在实现时 <strong>下意识地直接复用接口定义</strong>。</p>
<p>如果没有在真实链上环境中进行完整的集成测试，这类 <strong>类型级别的不一致</strong> 很容易长期潜伏在系统中，而不被察觉。</p>
<p>这也是为什么，本次问题并不是通过单元测试发现的，而是依赖 <strong>fork 主网后的系统级验证</strong> 才被准确定位。</p>
<h3 data-id="heading-6">小结</h3>
<p>这次 view-quoter-v3 的适配过程再次印证了一点：</p>
<blockquote>
<p><strong>在 DeFi 协议集成中，“接口看起来一样”并不等于“可以安全复用”。</strong></p>
</blockquote>
<p>即便是源自同一套设计体系的协议分支，也必须以 <strong>真实部署实现</strong> 为准，逐项验证其接口、参数和数据类型，而不能仅凭经验或文档假设其行为一致。</p>
<h2 data-id="heading-7">集成测试的真正价值</h2>
<p>回过头来看，这次 Quoter 相关的问题，并不是一个“代码写错了”的问题，而是一个<strong>只有在系统级集成测试中才会暴露的问题</strong>。</p>
<p>如果只停留在单个合约、单个函数的单元测试层面，所有逻辑看起来都是正确的；但当这些合约真正与真实链上协议、真实 Pool 状态交互时，细微的实现差异才会被放大。</p>
<p>这也是为什么，在 BlockLever 的研发过程中，我们将 <strong>fork 主网后的集成测试</strong> 视为一个必须完成的阶段，而不是可选项。</p>
<p>对实战营的学员来说，这一阶段同样重要：真正的 DeFi 工程能力，并不止于“写出合约”，而在于让一整套系统在真实环境中 <strong>稳定、可预期、可验证地运行</strong>。</p>
<hr/>
<p>参考阅读：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495368%26idx%3D1%26sn%3D4634bab0e054169211f3ba8bb194029c%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495368&amp;idx=1&amp;sn=4634bab0e054169211f3ba8bb194029c&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">第二期 AI+Web3 实战营启动：从 BlockETF 到 BlockLever</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495403%26idx%3D1%26sn%3D9d79878fd9bd5f4202ff30dfb290e58d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495403&amp;idx=1&amp;sn=9d79878fd9bd5f4202ff30dfb290e58d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">BlockLever实战营日志 #1 | 开营</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495408%26idx%3D1%26sn%3Df13a228d5387e1512da7d07a72741846%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495408&amp;idx=1&amp;sn=f13a228d5387e1512da7d07a72741846&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">BlockLever实战营日志 #2 | 产品需求梳理</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495413%26idx%3D1%26sn%3D0cdfe0cfc90d3daad0704f57654d1b6d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495413&amp;idx=1&amp;sn=0cdfe0cfc90d3daad0704f57654d1b6d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Web2 不再安全感：技术人如何踏入 AI + Web3 的新时代</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495418%26idx%3D1%26sn%3D52bce10b7461b5b2b41cdbcb46cb9663%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495418&amp;idx=1&amp;sn=52bce10b7461b5b2b41cdbcb46cb9663&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AI + Web3 实战营价值分析</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495424%26idx%3D1%26sn%3Db6ff0f2cc634faa5a4cc613c616b966b%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495424&amp;idx=1&amp;sn=b6ff0f2cc634faa5a4cc613c616b966b&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">从入门到实战：我的全套 Web3 学习路径（2025版）</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[git（带流程图）]]></title>    <link>https://juejin.cn/post/7583138169378799666</link>    <guid>https://juejin.cn/post/7583138169378799666</guid>    <pubDate>2025-12-14T02:30:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583138169378799666" data-draft-id="7582904738921873446" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="git（带流程图）"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2025-12-14T02:30:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="coderCatIce"/> <meta itemprop="url" content="https://juejin.cn/user/127981962405726"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            git（带流程图）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/127981962405726/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    coderCatIce
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T02:30:11.000Z" title="Sun Dec 14 2025 02:30:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Git 全面学习笔记</h2>
<h3 data-id="heading-1">一、Git 基础概念</h3>
<h4 data-id="heading-2">1.1 什么是 Git？</h4>
<p>Git 是一个开源的<strong>分布式版本控制系统</strong>，用于敏捷高效地处理任何或小或大的项目。它能记录文件的历史变更，方便多人协作开发，同时支持离线工作，核心特点包括：</p>
<ul>
<li>
<p>分布式：每个开发者都拥有完整的代码仓库副本，无需依赖中央服务器</p>
</li>
<li>
<p>版本控制：追踪文件每一次修改，可随时回滚到历史版本</p>
</li>
<li>
<p>分支管理：轻量级分支操作，支持并行开发与功能隔离</p>
</li>
</ul>
<h4 data-id="heading-3">1.2 核心工作区域</h4>
<p>Git 工作流程涉及四个核心区域，文件在这些区域间流转：</p>
<ol>
<li>
<p><strong>工作区</strong>（Working Directory）：实际操作的<strong>文件目录</strong>，日常编辑的文件存放于此</p>
</li>
<li>
<p><strong>暂存区</strong>（Stage/Index）：通过 <strong>add</strong> 临时存放待提交的修改，相当于 "变更缓冲区"</p>
</li>
<li>
<p><strong>本地仓库</strong>（Local Repository）：存储完整的版本历史，通过 <strong>commit</strong> 命令将暂存区内容提交至此</p>
</li>
<li>
<p>远程仓库（Remote Repository）：托管在服务器上的仓库（如 GitHub、GitLab），用于团队协作共享</p>
</li>
</ol>
<h3 data-id="heading-4">二、Git 环境配置</h3>
<h4 data-id="heading-5">2.1 安装 Git</h4>
<ul>
<li>Windows：从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgit-scm.com%2F" target="_blank" title="https://git-scm.com/" ref="nofollow noopener noreferrer">Git 官网</a> 下载安装包，勾选 "Git Bash Here" 方便右键调用</li>
<li>macOS：使用 Homebrew 安装 <code>brew install git</code>，或通过官网下载</li>
<li>Linux：Debian 系列 <code>sudo apt-get install git</code>，RedHat 系列 <code>sudo yum install git</code></li>
</ul>
<h4 data-id="heading-6">2.2 基础配置（首次使用必做）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 配置用户名（与远程仓库账号一致）</span>
git config --global user.name <span class="hljs-string">"Your Name"</span>
<span class="hljs-comment"># 配置邮箱（与远程仓库绑定邮箱一致）</span>
git config --global user.email <span class="hljs-string">"your.email@example.com"</span>
<span class="hljs-comment"># 查看配置信息</span>
git config --list
</code></pre>
<h3 data-id="heading-7">三、Git 仓库操作（初始化与克隆）</h3>

























<table><thead><tr><th>命令</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td>git init</td><td>在当前目录初始化本地仓库</td><td>git init my-project</td></tr><tr><td>git clone &lt;url&gt;</td><td>克隆远程仓库到本地</td><td>git clone <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fusername%2Frepo.git" target="_blank" title="https://github.com/username/repo.git" ref="nofollow noopener noreferrer">github.com/username/re…</a></td></tr><tr><td>git clone &lt;url&gt; &lt;name&gt;</td><td>克隆并自定义本地仓库名</td><td>git clone <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fusername%2Frepo.git" target="_blank" title="https://github.com/username/repo.git" ref="nofollow noopener noreferrer">github.com/username/re…</a> my-repo</td></tr></tbody></table>
<h3 data-id="heading-8">四、文件状态管理与撤销操作</h3>
<h4 data-id="heading-9">4.1 查看文件状态</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看详细状态（显示已修改/未跟踪/已暂存文件）</span>
git status
<span class="hljs-comment"># 简化状态显示（红色：修改未暂存；绿色：已暂存）</span>
git status -s
<span class="hljs-comment"># 查看文件修改详情</span>
git diff
</code></pre>
<h4 data-id="heading-10">4.2 add 暂存与 commit 提交</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 将单个文件添加到暂存区</span>
git add filename.txt
<span class="hljs-comment"># 将当前目录所有修改添加到暂存区</span>
git add .
<span class="hljs-comment"># 将暂存区内容提交到本地仓库（必须填写提交信息）</span>
git commit -m <span class="hljs-string">"feat: 新增用户登录功能"</span>
<span class="hljs-comment"># 跳过暂存区，直接提交已跟踪文件的修改</span>
git commit -a -m <span class="hljs-string">"fix: 修复登录表单验证bug"</span>
<span class="hljs-comment"># 修改最近一次提交（适用于补充修改或修正提交信息）</span>
git commit --amend
</code></pre>
<h4 data-id="heading-11">4.3 撤销操作</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 撤销工作区修改（未暂存的文件，谨慎使用！会丢失未提交修改）</span>
git checkout -- filename.txt
<span class="hljs-comment"># 撤销暂存区修改（将文件从暂存区放回工作区）</span>
git reset HEAD filename.txt
<span class="hljs-comment"># 删除文件并暂存删除操作</span>
git <span class="hljs-built_in">rm</span> &lt;文件名&gt;
<span class="hljs-comment"># 保留文件并暂存删除操作</span>
git <span class="hljs-built_in">rm</span> --cached &lt;文件名&gt;
<span class="hljs-comment"># 移动/重命名文件并暂存修改</span>
git <span class="hljs-built_in">mv</span> &lt;旧文件名&gt; &lt;新文件名&gt;
<span class="hljs-comment"># 撤销提交(只撤commit，保留add)</span>
git reset HEAD~ --soft
<span class="hljs-comment"># 撤销提交(撤commit和add，保留代码)</span>
git reset HEAD~
<span class="hljs-comment"># 撤销提交(全部撤回上次提交)</span>
git reset HEAD~ --hard
</code></pre>
<h4 data-id="heading-12">4.4 reset 命令与 HEAD 引用</h4>
<h5 data-id="heading-13">4.4.1 HEAD 引用说明</h5>
<ul>
<li>
<p>HEAD：指向当前分支的最新提交</p>
</li>
<li>
<p>HEAD~：上一个提交，HEAD~~ 上上个提交，以此类推</p>
<ul>
<li>可简写为HEAD~n：往前第 n 个提交</li>
</ul>
</li>
</ul>
<h5 data-id="heading-14">4.4.2 git reset 的三种模式</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># --soft：仅移动 HEAD，暂存区和工作区不变</span>
git reset --soft &lt;提交ID/HEAD引用&gt;
<span class="hljs-comment"># --mixed（默认）：移动 HEAD，重置暂存区，工作区不变</span>
git reset &lt;提交ID/HEAD引用&gt;
<span class="hljs-comment"># --hard：移动 HEAD，重置暂存区和工作区（慎用，会丢失未提交修改）</span>
git reset --hard &lt;提交ID/HEAD引用&gt;
</code></pre>
<h3 data-id="heading-15">五、提交流程与历史查看</h3>
<h4 data-id="heading-16">5.1 完整提交流程</h4>
<ol>
<li>
<p>查看修改：<code>git status</code></p>
</li>
<li>
<p>暂存文件：<code>git add &lt;文件名&gt;</code> 或 <code>git add .</code></p>
</li>
<li>
<p>提交到本地仓库：<code>git commit -m "提交说明"</code></p>
</li>
<li>
<p>补充提交（修正上一次提交）：<code>git commit --amend</code></p>
</li>
</ol>
<p>正向详细流程图（不涉及reset等回退）：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">stateDiagram-v2
    [*] --&gt; 未跟踪 : 新建文件
    [*] --&gt; 暂存未修改 : git clone克隆/git fetch拉取代码
    
    state 工作区 {
    
        已修改
        未跟踪
    }
    
    state 暂存区 {
        暂存未修改
        已暂存
    }
    
    state 本地仓库 {
        已提交
    }
    
    
    # 暂存区 → 仓库
    已提交 --&gt; 暂存未修改 : 提交后自动转变
    已暂存 --&gt; 已提交 : git commit -m '说明'
    已修改 --&gt; 已提交 : git commit -a -m '说明'

    # 工作区 → 暂存区（单向箭头，无交叉）
    已修改 --&gt; 已暂存 : git add &lt;文件&gt;
    未跟踪 --&gt; 已暂存 : git add &lt;文件&gt;
    暂存未修改 --&gt; 已修改 : 手动编辑
    
</code></pre>
<p>正向简要图（不涉及reset）：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">stateDiagram-v2
    direction LR
    [*] --&gt; 未跟踪 : 新建文件
    [*] --&gt; 暂存未修改 : 克隆/拉取代码

    已提交 --&gt; 暂存未修改 : 提交后自动转变
    已暂存 --&gt; 已提交 : git commit -m '说明'
    已修改 --&gt; 已提交 : git commit -a -m '说明'

    # 工作区 → 暂存区（单向箭头，无交叉）
    已修改 --&gt; 已暂存 : git add &lt;文件&gt;
    未跟踪 --&gt; 已暂存 : git add &lt;文件&gt;
    暂存未修改 --&gt; 已修改 : 手动编辑
</code></pre>
<h4 data-id="heading-17">5.2 查看提交历史</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看完整提交历史（按时间倒序，最新在前）</span>
git <span class="hljs-built_in">log</span>
<span class="hljs-comment"># 简化显示（只显示版本号前7位和提交信息）</span>
git <span class="hljs-built_in">log</span> --oneline
<span class="hljs-comment"># 显示所有分支的提交</span>
git <span class="hljs-built_in">log</span> --all
<span class="hljs-comment"># 显示分支合并图</span>
git <span class="hljs-built_in">log</span> --graph
<span class="hljs-comment"># 查看指定文件的修改历史</span>
git <span class="hljs-built_in">log</span> -p filename.txt
<span class="hljs-comment"># 查看指定作者的提交记录</span>
git <span class="hljs-built_in">log</span> --author=<span class="hljs-string">"Your Name"</span>
</code></pre>
<h3 data-id="heading-18">六、分支管理与冲突解决</h3>
<h4 data-id="heading-19">6.1 分支基本操作</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看所有分支（当前分支前带 *）</span>
git branch
<span class="hljs-comment"># 查看本地+远程所有分支</span>
git branch -a
<span class="hljs-comment"># 创建新分支</span>
git branch 分支名
<span class="hljs-comment"># 切换到指定分支</span>
git checkout 分支名
<span class="hljs-comment"># 创建并切换到新分支（简化写法）</span>
git checkout -b 分支名
<span class="hljs-comment"># 删除本地分支（需先切换到其他分支）</span>
git branch -d 分支名
<span class="hljs-comment"># 强制删除未合并的分支（谨慎使用！）</span>
git branch -D 分支名
</code></pre>
<h4 data-id="heading-20">6.2 分支合并</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 切换到目标分支（如主分支）</span>
git checkout main
<span class="hljs-comment"># 2. 合并指定分支到当前分支（无冲突则直接合并）</span>
git merge feature/login
</code></pre>
<h4 data-id="heading-21">6.3 冲突解决</h4>
<ol>
<li>
<p>git status 查看哪些文件发生冲突</p>
</li>
<li>
<p>合并冲突时，文件中会出现 <code>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</code>（当前分支内容）、<code>=======</code>、<code>&gt;&gt;&gt;&gt;&gt;&gt;&gt; 分支名</code>（待合并分支内容）标记</p>
</li>
<li>
<p>手动编辑冲突文件，保留需要的代码并删除冲突标记</p>
</li>
<li>
<p>暂存修改：<code>git add .</code></p>
</li>
<li>
<p>完成合并：<code>git commit -m "merge: 合并登录功能分支，解决冲突"</code></p>
</li>
</ol>
<h3 data-id="heading-22">七、stash 临时保存工作区</h3>
<h4 data-id="heading-23">7.1 核心命令</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 临时保存工作区修改（可添加备注）</span>
git stash save <span class="hljs-string">"备注信息"</span>
<span class="hljs-comment"># 查看所有 stash 记录</span>
git stash list
<span class="hljs-comment"># 恢复最近一次 stash 且保留记录</span>
git stash apply

<span class="hljs-comment"># 可以存多次</span>
<span class="hljs-comment"># 恢复指定 stash 且保留记录</span>
git stash apply stash@{n}
<span class="hljs-comment"># 恢复最近一次 stash 并删除记录</span>
git stash pop
<span class="hljs-comment"># 删除最近一次 stash 记录</span>
git stash drop
<span class="hljs-comment"># 删除所有 stash 记录</span>
git stash clear
</code></pre>
<h4 data-id="heading-24">7.2 使用场景</h4>
<ul>
<li>切换分支前，保存当前未提交的修改，避免分支切换冲突</li>
<li>临时拉取远程最新代码，不影响本地正在开发的内容</li>
</ul>
<h3 data-id="heading-25">八、git rebase -i 交互式变基</h3>
<h4 data-id="heading-26">8.1 核心功能（优化提交历史）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 操作最近 n 个提交（n 为具体数字）</span>
git rebase -i HEAD~n
</code></pre>
<ul>
<li><strong>压缩提交：将多个提交合并为一个</strong>，把行首 <code>pick</code> 改为 <code>squash</code> 或 <code>s</code></li>
<li>编辑提交：修改历史提交的信息 / 内容，把行首 <code>pick</code> 改为 <code>edit</code> 或 <code>e</code>，修改后执行 <code>git commit --amend</code> 和 <code>git rebase --continue</code></li>
<li>删除提交：移除不需要的历史提交，删除对应行或把 <code>pick</code> 改为 <code>drop</code> 或 <code>d</code></li>
<li>调整顺序：直接拖动提交行调整顺序，保存后 Git 按新顺序执行</li>
</ul>
<h4 data-id="heading-27">8.2 注意事项</h4>
<ul>
<li><strong>优势：生成线性提交历史，比 merge 更易追踪</strong></li>
<li><strong>禁忌：不要对已推送到远程仓库的提交执行变基</strong></li>
</ul>
<h3 data-id="heading-28">九、远程仓库协作</h3>
<h4 data-id="heading-29">9.1 远程仓库管理</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看已配置的远程仓库</span>
git remote
<span class="hljs-comment"># 查看远程仓库详细信息（包含URL）</span>
git remote -v
<span class="hljs-comment"># 添加远程仓库（通常命名为 origin）</span>
git remote add 远程名 URL
<span class="hljs-comment"># 重命名远程仓库</span>
git remote rename &lt;旧别名&gt; &lt;新别名&gt;
<span class="hljs-comment"># 修改远程仓库URL</span>
git remote set-url 新URL
<span class="hljs-comment"># 删除远程仓库</span>
git remote <span class="hljs-built_in">rm</span> 远程名
</code></pre>
<h4 data-id="heading-30">9.2 拉取与推送</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从远程仓库拉取最新代码（不自动合并）</span>
git fetch origin main
<span class="hljs-comment"># 拉取并合并远程分支到本地当前分支（常用）</span>
git pull origin main

<span class="hljs-comment"># 首次推送分支到远程仓库（设置上游分支）</span>
git push -u 远程名 分支名
<span class="hljs-comment"># 后续推送已关联的分支</span>
git push

<span class="hljs-comment"># 推送本地所有分支到远程</span>
git push --all origin
<span class="hljs-comment"># 拉取远程分支并创建本地分支</span>
git checkout -b &lt;本地分支名&gt; &lt;远程别名&gt;/&lt;远程分支名&gt;
</code></pre>
<h3 data-id="heading-31">十、.gitignore 语法与配置</h3>
<h4 data-id="heading-32">10.1 基础语法规则</h4>
<ul>
<li>
<p>注释行：以 <code>#</code> 开头</p>
</li>
<li>
<p>匹配单个文件：直接写文件名，如 <code>test.txt</code></p>
</li>
<li>
<p>匹配目录：以 <code>/</code> 结尾，如 <code>logs/</code></p>
</li>
<li>
<p>通配符匹配：</p>
<ul>
<li>
<p><code>*</code>：匹配任意多个字符，如 <code>*.log</code>（所有 log 文件）</p>
</li>
<li>
<p><code>**</code>：递归通配符，如 <code>**/log/</code>（所有 log 目录）</p>
</li>
<li>
<p><code>?</code>：匹配单个字符，如 <code>file?.txt</code>（file1.txt、file2.txt 等）</p>
</li>
<li>
<p><code>[]</code>：匹配括号内任意<strong>一个</strong>字符，如 <code>file[12].txt</code></p>
</li>
</ul>
</li>
<li>
<p>反向匹配：以 <code>!</code> 开头，表示不忽略该文件 / 目录，如 <code>!important.log</code></p>
</li>
</ul>
<h4 data-id="heading-33">10.2 .gitignore 示例</h4>
<pre><code class="hljs language-plaintext" lang="plaintext"># 忽略所有 .log 文件
*.log
# 忽略 node_modules 目录
node_modules/
# 忽略 dist 构建目录
dist/
# 忽略特定文件
.env
.DS_Store（macOS系统文件）
Thumbs.db（Windows系统文件）
</code></pre>
<h3 data-id="heading-34">十一、常见问题与解决方案</h3>
<h4 data-id="heading-35">11.1 .gitignore 相关问题</h4>
<ul>
<li>
<p>问题 1：已提交到仓库的文件，添加到 .gitignore 后不生效解决方案：清除文件缓存并重新提交</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">rm</span> --cached &lt;文件名&gt;
git commit -m <span class="hljs-string">"停止跟踪某文件"</span>
</code></pre>
</li>
<li>
<p>问题 2：需要局部配置 .gitignore，不影响团队共享配置解决方案：在 <code>.git/info/exclude</code> 文件中添加忽略规则，仅对当前本地仓库有效</p>
</li>
<li>
<p>问题 3：忽略规则不生效解决方案：检查规则语法，或执行 <code>git rm --cached &lt;文件名&gt;</code> 清除缓存</p>
</li>
</ul>
<h4 data-id="heading-36">11.2 忘记提交就切换分支</h4>
<p>问题：工作区有未提交修改，切换分支时提示 <code>error: Your local changes would be overwritten by checkout</code>解决方法：</p>
<ul>
<li>方案 1：提交修改后切换分支：<code>git add .</code> → <code>git commit -m "temp: 临时提交"</code> → <code>git checkout 目标分支</code></li>
<li>方案 2：用 stash 暂存：<code>git stash</code> → 切换分支完成操作 → 切回原分支 → <code>git stash pop</code>（恢复修改）</li>
</ul>
<h4 data-id="heading-37">11.3 误删本地分支</h4>
<p>问题：不小心删除了未合并的本地分支解决方法：</p>
<ol>
<li>执行 <code>git reflog</code> 查看操作记录，找到删除分支的最后一次提交 ID</li>
<li>恢复分支：<code>git checkout -b 恢复的分支名 &lt;commit-id&gt;</code></li>
</ol>
<h4 data-id="heading-38">11.4 其他注意事项</h4>
<ul>
<li><code>git reset --hard</code> 慎用，会彻底丢失未提交的工作区修改</li>
<li>不要对已推送至远程的提交执行 <code>rebase</code>，避免影响团队协作</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[初识iFlow CLI]]></title>    <link>https://juejin.cn/post/7582919147640668212</link>    <guid>https://juejin.cn/post/7582919147640668212</guid>    <pubDate>2025-12-14T03:31:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582919147640668212" data-draft-id="7580592190020157474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="初识iFlow CLI"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-14T03:31:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小溪彼岸"/> <meta itemprop="url" content="https://juejin.cn/user/976781670357400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            初识iFlow CLI
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976781670357400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小溪彼岸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T03:31:20.000Z" title="Sun Dec 14 2025 03:31:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>小伙伴们大家好，我是小溪，见字如面。初次听说iFlow还是在使用 Claude Code Router时，依稀记得当时作者在文档上的标注是当前版本比较依赖iFlow，通过iFlow官网得知iFlow也提供了CLI，这次有时间特来体验一下。对其他CLI感兴趣的小伙伴也可以看往期内容：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247492929%26idx%3D1%26sn%3D043e21a18f31f1c4c68bf4ee63e28685%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247492929&amp;idx=1&amp;sn=043e21a18f31f1c4c68bf4ee63e28685&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Claude Code CLI初体验</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247493426%26idx%3D1%26sn%3D4e0b83c872d1e23af8fc8de2708e0bda%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247493426&amp;idx=1&amp;sn=4e0b83c872d1e23af8fc8de2708e0bda&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Codex CLI初体验</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247492558%26idx%3D1%26sn%3De762047c93c4361f63744ec3c70a434f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247492558&amp;idx=1&amp;sn=e762047c93c4361f63744ec3c70a434f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Google百万Token上下文Gemini CLI，离AI自由更近一步</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247494083%26idx%3D1%26sn%3D7b64164277b9494ce2e8e42e6e9f403b%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247494083&amp;idx=1&amp;sn=7b64164277b9494ce2e8e42e6e9f403b&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">初识Qwen Code CLI</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247493377%26idx%3D1%26sn%3Dda5a37dc7f023881c0e22342caff11e1%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247493377&amp;idx=1&amp;sn=da5a37dc7f023881c0e22342caff11e1&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">腾讯发布CodeBuddy Code CLI平替Claude Code?</a></li>
</ul>
<h2 data-id="heading-1">当前使用版本</h2>
<p>iflow cli 0.3.28</p>
<h2 data-id="heading-2">优势</h2>
<ul>
<li>完全免费使用</li>
<li>提供国内主流模型调用</li>
</ul>
<h2 data-id="heading-3">限制</h2>
<ul>
<li>Node.js 20+</li>
<li>无法完全使用心流开发平台所有模型</li>
</ul>
<h2 data-id="heading-4">官网</h2>
<p>iFlow CLI 是一款终端AI助手，可以分析代码、执行编程任务、处理文件操作。本指南帮您快速上手核心功能。</p>
<p>官网开放平台地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.iflow.cn" target="_blank" title="https://platform.iflow.cn" ref="nofollow noopener noreferrer">platform.iflow.cn</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23db6ff7c2c54e09aafcb7fcfe548b57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=miTPpXIFVqozuAjRdUPJIdh0rlk%3D" alt="图片" loading="lazy"/></p>
<p>官网CLI地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcli.iflow.cn" target="_blank" title="https://cli.iflow.cn" ref="nofollow noopener noreferrer">cli.iflow.cn</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5195916a4bfa492caef0a41c31738cee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=Oa%2BT%2BaKszFrlrNF%2B3a%2BZz%2FjEUtI%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">安装配置</h2>
<p>macOS/Linux</p>
<pre><code class="hljs language-less" lang="less"># 一键安装脚本，会安装全部所需依赖
$ <span class="hljs-selector-tag">bash</span> <span class="hljs-selector-tag">-c</span> "$(curl -fsSL <span class="hljs-attribute">https</span>:<span class="hljs-comment">//gitee.com/iflow-ai/iflow-cli/raw/main/install.sh)"</span>
# 已有Node.js <span class="hljs-number">20</span>+
$ npm i -g <span class="hljs-variable">@iflow-ai</span>/iflow-cli<span class="hljs-variable">@latest</span>
# 更新
$ npm i -g <span class="hljs-variable">@iflow-ai</span>/iflow-cli<span class="hljs-variable">@latest</span>
</code></pre>
<p>Windows</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$ </span>npm install -g <span class="hljs-variable">@iflow</span>-ai/iflow-cli<span class="hljs-variable">@latest</span>
</code></pre>
<p>安装完成后，在命令行终端执行以下命令，可以输出版本号表示安装成功</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$ iflow</span> -v
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4464c7fe24ee4e1b9da3750c27413eff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=Uq6EGxcux9LAd4moMXa6mOD9%2Fbg%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-6">申请API Key</h2>
<blockquote>
<p>用于 心流API Key、OpenAI Compatible API 及 其他AI工具 登录方式</p>
</blockquote>
<p>在心流开发平台点击头像，在下拉菜单中选择【API Key管理】</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a5bac696e6f4fbca7ff53726b944950~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=nEgtfHcx8TbCeRIbYzDACb1ZlsU%3D" alt="图片" loading="lazy"/></p>
<p>点击【插件API密钥】创建一个新的API Key，点击【同意协议并生成】创建</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7d900b5a8554b4b96b965ab4543fb97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=YMEjFhD%2FAaR3oHFlqeQZkxeq0vs%3D" alt="图片" loading="lazy"/></p>
<p>创建完成后即可在API Key管理列表查看</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8257a6021a9c42d491191eb73991b9a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=%2BCax4MNvWjTtwXUXN0BV3sRJg8E%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-7">登录授权</h2>
<p>在命令行终端输入 iflow 启动 iFlow CLI，看到启动界面细心的小伙伴可能已经发现了，这个界面和Gemini CLI有点像哦😂（不要怀疑自己的眼睛，多半是魔改了）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0918b87a33294e069e103e99e70b8e23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=ermInfJOKq%2FJE3ZK5NDpTeWU2cM%3D" alt="图片" loading="lazy"/></p>
<p>iFlow CLI 支持 Login with iFlow、Login with iFlow ApiKey、OpenAI Compatible API 3种登录方式，不同方式提供的功能有所差异</p>
<h3 data-id="heading-8">Login with iFlow 登录（推荐）</h3>
<blockquote>
<p>强烈推荐使用 Login with iFlow 方式登录心流平台，享受最完整的功能体验，令牌自动刷新，永不过期</p>
</blockquote>
<p>完整功能支持：</p>
<ul>
<li>WebSearch 服务：智能网络搜索，获取最新信息</li>
<li>WebFetch 服务：网页内容抓取和分析</li>
<li>多模态能力：内置图像理解等多模态功能</li>
<li>工具调用优化：心流平台提供的模型经过专门优化，工具调用更加精准高效</li>
</ul>
<p>选择【Login with iFlow】，在官网授权</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f7f6ef12310490aad7f81505de40e3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=l3bKck9PIUbvt1wpikxW%2F%2BeKxFY%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e20bd670ab3c4eb0bb4dc1e488e31c06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=ZK3cHlh2jl7N0VlEj4m9%2B6r%2B81Q%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-9">心流 API Key 登录</h3>
<blockquote>
<p>API Key 有效期为 7 天，需定期更新</p>
</blockquote>
<p>完整功能支持：</p>
<ul>
<li>WebSearch 服务：智能网络搜索，获取最新信息</li>
<li>WebFetch 服务：网页内容抓取和分析</li>
<li>多模态能力：内置图像理解等多模态功能</li>
<li>工具调用优化：心流平台提供的模型经过专门优化，工具调用更加精准高效</li>
</ul>
<p>在交互式命令中输入 /auth，选择【Login with iFlow ApiKey】</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a70b8cfdb4d348a4bf43633d40d60414~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=QNlgUNUabAoOnrm83M9hUBuFY9k%3D" alt="图片" loading="lazy"/></p>
<p>输入心流开放平台API Key</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc8d84692e1544bf92505acbaf9c449d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=jTnSidC7Zza5KiEBWVP3yy0FEYs%3D" alt="图片" loading="lazy"/></p>
<p>也可以在AI助手中使用，iFlow目前没有适配Claude Code CLI，直接使用会报错</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8dfaac6cd7b24b08ae4f933f16552bef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=FGIaGd%2BT7psvPduPD0qigwducDQ%3D" alt="图片" loading="lazy"/></p>
<p>想在Claude Code CLI中使用需要借助Claude Code Router工具，对Claude Code Router还不了解的小伙伴可以看往期内容：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247493062%26idx%3D1%26sn%3D23bf774d1aef130d687887222bf78483%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247493062&amp;idx=1&amp;sn=23bf774d1aef130d687887222bf78483&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">使用Claude Code Router轻松切换各种高性价比模型</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9a58373d59c4d158262e9764b8f3728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=iIdH57fJYBGo3HZp8eBlcdoOCbs%3D" alt="图片" loading="lazy"/></p>
<p>配置完后就可以直接使用了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f72690a54027475ea7e3f6eb8c9681fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=ag5ILNfj8Yu2o%2BsaGHa34EwSS64%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-10">OpenAI Compatible API</h3>
<blockquote>
<p>适用于使用自有模型服务或其他兼容 OpenAI 协议的服务</p>
</blockquote>
<p>功能限制：</p>
<ul>
<li>不支持 WebSearch 服务</li>
<li>不支持 WebFetch 服务</li>
<li>不支持心流平台的内置多模态能力</li>
<li>无法享受心流平台模型的工具调用优化</li>
</ul>
<p>在交互式命令中输入 /auth，选择【OpenAI Compatible API】</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c66ca359448740219583b1052fc024eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=4kaNk%2BTDDf2Gk3uhL2mb89YOqF0%3D" alt="图片" loading="lazy"/></p>
<p>输入 OpenAi Base URL、API Key 和 模型名称</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ae31a8b72ab40fcae5c094cb3dc5f63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=wd04N3442CQAlWx1mIs52jd7tv4%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcc780321e4648f9b9b53f371eb4974c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=ODvUsXCK8Fg6tBOjjqYuxH4NnFQ%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd9d0ba807594a3d8db54c183094cdff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=4r0NVnUvmORXRHDvV%2FsAbnVnsfA%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-11">基本使用</h2>
<h3 data-id="heading-12">命令行参数</h3>
<p>在命令行终端输入 iflow -h 可以查看iFlow CLI提供的所有命令行指令</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4b60b37e6324abd893187b5d7b33ad2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=w3o4YJ55METaXvNV41x25WB6OqM%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>iflow：启动iFlow CLI，示例：iflow [query]</li>
<li>iflow mcp：管理MCP服务，示例：iflow mcp list</li>
<li>iflow commands：管理市场命令，示例：iflow commands list</li>
<li>iflow agent：管理子代理，示例：iflow agent list</li>
<li>iflow workflow：工作流管理</li>
</ul>
<h3 data-id="heading-13">交互式命令</h3>
<p>在交互式命令输入 / 可以查看终端命令信息，基本和Gemini CLI一致，这里只介绍有区别的，其他的参考往期：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247492558%26idx%3D1%26sn%3De762047c93c4361f63744ec3c70a434f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247492558&amp;idx=1&amp;sn=e762047c93c4361f63744ec3c70a434f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Google百万Token上下文Gemini CLI，离AI自由更近一步</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1031dce8cb784846994a5942998c8b15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=LAyKhnHovvSlqn3%2FBaIa4WieufA%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>/agents：代理管理
<ul>
<li>install：安装具有引导设置的新代理</li>
<li>list：查看所有可用代理</li>
<li>online：浏览并安装来自在线仓库的代理</li>
<li>refresh：更新源文件中的代理</li>
</ul>
</li>
<li>/auth：切换授权方式</li>
<li>/cleanup-checkpoint：清除所有检查点历史记录并释放磁盘</li>
<li>/cleanup-history：清除当前项目的对话历史记录并释放磁盘空间</li>
<li>/commands：管理市场命令
<ul>
<li>add：添加命令</li>
<li>get：查看命令详情</li>
<li>list：命令列表</li>
<li>online：在交互式对话框中浏览在线市场的可用命令</li>
<li>remove：移除本地安装的命令</li>
</ul>
</li>
<li>/demo：用于研究和头脑风暴的互动任务</li>
<li>/directory：管理工作区目录</li>
<li>/export：导出对话历史</li>
<li>/init：分析项目并生成定制的 IFLOW.md 文件</li>
<li>/language：切换语言</li>
<li>/log：查看会话日志</li>
<li>/mcp：MCP管理
<ul>
<li>auth：MCP授权</li>
<li>list：列出已配置的 MCP 服务器和工具</li>
<li>online：从在线存储库浏览和安装 MCP 服务器</li>
<li>refresh：刷新 MCP 服务器和工具列表，并重新加载设置文件</li>
</ul>
</li>
<li>/output-style：更改输出风格偏好（参考了claude code）</li>
<li>/output-style:new：可视化创建一个风格偏好</li>
<li>/qa：基于知识库检索的智能问答</li>
<li>/update：更新版本</li>
</ul>
<h3 data-id="heading-14">执行Shell</h3>
<p>和Gemini CLI一样在交互式命令中输入 ! 可进入Shell模式执行Shell命令</p>
<h3 data-id="heading-15">配置文件</h3>
<p>iFlow CLI延续了Gemini CLI的配置文件系统，提供了 .iflow/settings.json、.env、IFLOW.md 等配置文件，整体上和Gemini CLI的配置文件没有太大差异。</p>
<h3 data-id="heading-16">对话模式</h3>
<p>iFlow CLI提供了 plan、default、accepting edits、YOLO 4种对话模式，使用【Shift+Tab】可以快速切换</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a59b645bbe244638e4fb4f338c43144~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=vzdbb3NBogtSQPGW0MrhgGpOXcQ%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>plan：仅分析，不修改文件或执行命令</li>
<li>default：要求审批文件编辑或 shell 命令</li>
<li>accepting edits：自动批准文件编辑</li>
<li>YOLO：自动批准所有工具</li>
</ul>
<p>和Qwen Code CLI功能类似，这里就不展开了，感兴趣的小伙伴可以看往期内容：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247494083%26idx%3D1%26sn%3D7b64164277b9494ce2e8e42e6e9f403b%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247494083&amp;idx=1&amp;sn=7b64164277b9494ce2e8e42e6e9f403b&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">初识Qwen Code CLI</a></p>
<h3 data-id="heading-17">模型切换</h3>
<p>iFlow CLI提供了模型切换功能，在交互式命令中输入 /model 可以随时切换模型</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d11aba2fbbe4827a5f3601f8ac7971a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=XU72rg0Rk%2FpInPcvMvOddT52lCE%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-18">自定义指令</h3>
<p>iFlow提供了自定义指令也就是Claude Code中的自定义命令，iFlow CLI提供了多种安装自定义指令的方式</p>
<h4 data-id="heading-19">1）心流指令市场（推荐）</h4>
<p>自定义指令市场：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.iflow.cn%2Fagents%3Ftype%3Dcommands%26category%3Dall" target="_blank" title="https://platform.iflow.cn/agents?type=commands&amp;category=all" ref="nofollow noopener noreferrer">platform.iflow.cn/agents?type…</a></p>
<p>选择一个指令，点击【安装】获取安装命令</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed48e9fa7f9e46a79a1d9032c1430692~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=FLHqLz1AYOmW6As%2FJbL4daLIP1Y%3D" alt="图片" loading="lazy"/></p>
<p>复制命令在命令行终端一键安装</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a800ad6b43d4f42a8dfeaaafb9526e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=HRf6JPrHsDeSJoIE5oQdAnIz8Dk%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21386175d21d45ad80be066945733601~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=iqVixkwyRWTKmSoCRRzDyi9NPlQ%3D" alt="图片" loading="lazy"/></p>
<p>安装完成后，在命令行终端输入 /iflow commands list 可以查看安装列表</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0be6396b3b4e4944902daa1ad972cc7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=M22w6sI%2B1TR5C6qOJXDrd4QbeoM%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-20">2）在线安装</h4>
<p>在交互式命令中执行 /commands online 可以在线浏览自定义指令市场</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d397da70462d42c1819cdeaba26fc608~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=PsJ%2FFOBSLPBOS5rpW2J961RBp%2F4%3D" alt="图片" loading="lazy"/></p>
<p>使用 ↑↓ 选择自定义指令， ←→ 翻页查看，使用对应的数字键进行安装</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a89d7c55643f480a9f8eeab8cd0a3229~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=lqR9kqxlMup90orD4SJH10SH42Q%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-21">3）创建自定义指令</h4>
<p>iFlow CLI自定义指令支持 TOML 和 Markdown 格式，好结合了 Gemini CLI和Claude Code CLI的特点，创建自定义指令的方式和其他主流CLI工具类似，在全局或者项目 iflow/commands 目录下新建一个 my-command.toml 文件，输入如下提示词即可</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 命令描述（必需）</span>
<span class="hljs-attr">description</span> = <span class="hljs-string">"命令的简短描述"</span>
<span class="hljs-comment"># 命令提示词（必需）</span>
<span class="hljs-attr">prompt</span> = <span class="hljs-string">"""
发送给AI模型的完整提示词内容
支持多行文本和特殊占位符
"""</span>
</code></pre>
<p>Markdown格式需要创建 my-command.md 文件，格式如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">Create</span> <span class="hljs-string">a</span> <span class="hljs-string">git</span> <span class="hljs-string">commit</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment">## Context</span>
<span class="hljs-string">-</span> <span class="hljs-attr">Current git status:</span> <span class="hljs-string">!`git</span> <span class="hljs-string">status`</span>
<span class="hljs-string">-</span> <span class="hljs-string">Current</span> <span class="hljs-string">git</span> <span class="hljs-string">diff</span> <span class="hljs-string">(staged</span> <span class="hljs-string">and</span> <span class="hljs-string">unstaged</span> <span class="hljs-string">changes):</span> <span class="hljs-string">!`git</span> <span class="hljs-string">diff</span> <span class="hljs-string">HEAD`</span>
<span class="hljs-string">-</span> <span class="hljs-attr">Current branch:</span> <span class="hljs-string">!`git</span> <span class="hljs-string">branch</span> <span class="hljs-string">--show-current`</span>
<span class="hljs-string">-</span> <span class="hljs-attr">Recent commits:</span> <span class="hljs-string">!`git</span> <span class="hljs-string">log</span> <span class="hljs-string">--oneline</span> <span class="hljs-number">-10</span><span class="hljs-string">`</span>
<span class="hljs-comment">## Your task</span>
<span class="hljs-string">Based</span> <span class="hljs-string">on</span> <span class="hljs-string">the</span> <span class="hljs-string">above</span> <span class="hljs-string">changes,</span> <span class="hljs-string">create</span> <span class="hljs-string">a</span> <span class="hljs-string">single</span> <span class="hljs-string">git</span> <span class="hljs-string">commit.</span>
</code></pre>
<p>关于更详细的配置，感兴趣的小伙伴可以看官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.iflow.cn%2Fcli%2Fexamples%2Fsubcommand" target="_blank" title="https://platform.iflow.cn/cli/examples/subcommand" ref="nofollow noopener noreferrer">platform.iflow.cn/cli/example…</a></p>
<p>在交互式命令中输入 /commands list 查看自定义指令列表</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a216016813d244e5b738053230caa77e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=T%2FMl4ahELrkIUE6MiU%2BNG9pJdlw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-22">自定义工作流</h3>
<p>iFlow提供的Workflow是整合 agents、commands、IFLOW.md 和 MCP 创建的完整自动化工作流程，相当于Claude Code中的插件系统，目前只提供了1种安装方式</p>
<h4 data-id="heading-23">1）心流工作流市场</h4>
<p>心流工作流市场：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.iflow.cn%2Fagents%3Ftype%3Dworkflows%26category%3Dall" target="_blank" title="https://platform.iflow.cn/agents?type=workflows&amp;category=all" ref="nofollow noopener noreferrer">platform.iflow.cn/agents?type…</a></p>
<p>选择一个工作流，点击【安装】获取安装命令</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/737e7666abd64897a154931ddff436d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=kKEOCXyY%2FYQ0fktD953Ci8RGbho%3D" alt="图片" loading="lazy"/></p>
<p>复制命令在命令行终端一键安装</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b0c2fbb0c0440718313f2751759bfe5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=wwRdfCuMJSk7rUkMXVpsbpjygzA%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4153912d1c84268a3a743483347cd88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=Oj1QjwfPNkglD0vE%2BpJdijgbPYo%3D" alt="图片" loading="lazy"/></p>
<p>iFlow CLI暂时没有提供查看Workflow的指令，Workflow的具体使用方式可以在心流开放平台的工作流详情中查看</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/017492448b8e4cb184716300d068f221~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=q1T%2FzzvN4J4WWJqrgldCnmoESY0%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-24">2）创建工作流</h4>
<p>iFlow CLI创建工作流的方式就是直接打包拥有iFlow CLI配置文件结构的所有文件，也可以理解为一个项目就是一个工作流，安装时iFlow CLI会对文件进行合并</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18bc371d5e5146a7ad38655ed14fb2bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=%2BfVhEUsHIc2E7BPnbEnVIBXl994%3D" alt="图片" loading="lazy"/></p>
<p>工作流创建完成后，直接在命令行终端执行如下命令打包工作流</p>
<pre><code class="hljs language-python" lang="python">$ <span class="hljs-built_in">zip</span> -r your-workflow-name.<span class="hljs-built_in">zip</span> . -x your-workflow-name.<span class="hljs-built_in">zip</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d28bc74331d4d4a9b03c9404127de51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=Urxv0VHGOqBeTtsEuGwD%2F7gJj0w%3D" alt="图片" loading="lazy"/></p>
<p>这个命令打包以下内容：</p>
<ul>
<li>压缩当前目录下的所有文件和文件夹（包括 .iflow 文件夹、项目文件、IFLOW.md 等）</li>
<li>包含隐藏文件（如 .iflow 目录）</li>
<li>排除生成的压缩包本身，避免递归包含</li>
<li>解压时保持原始目录结构，不会创建额外的目录层级</li>
</ul>
<p>为了保证工作流的准确性，可以在命令行终端执行如下命令验证打包内容</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$ unzip</span> -l your-workflow-name.zip
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb5e82cf651247b099893e16a95a7000~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=OrS1wJ2ZouVfWfe9LOhhTL4L63M%3D" alt="图片" loading="lazy"/></p>
<p>验证没有问题后就可以上传到心流开放平台了，目前只支持通过心流平台分发。</p>
<h3 data-id="heading-25">Subagents</h3>
<p>iFlow提供了Subagents功能，也提供了多种安装方式</p>
<h4 data-id="heading-26">1）心流Agent市场（推荐）</h4>
<p>智能体市场：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.iflow.cn%2Fagents%3Ftype%3Dagents%26category%3Dall" target="_blank" title="https://platform.iflow.cn/agents?type=agents&amp;category=all" ref="nofollow noopener noreferrer">platform.iflow.cn/agents?type…</a></p>
<p>选择一个智能体，点击【安装】获取安装命令</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/289a6959dc1a41bd820bb1f415ff4441~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=ar%2Fia9nyQIfd0oxTX%2B0F0qqzRTk%3D" alt="图片" loading="lazy"/></p>
<p>复制命令在命令行终端一键安装</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43dad48a6ee24a35abc27e7deca6ab3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=M4RoNTOJVqFJEvJ4BzscsS59Bdg%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5e8b84d7cbc4f3bb763b83b3bece03a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=slfrjE5iVlqitr4w0aSqw%2B3a8Qs%3D" alt="图片" loading="lazy"/></p>
<p>在命令行终端输入 /iflow agent list 可以查看安装列表</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a7bd64aedd2441c9911bc6d8ac40ed6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=BY0UCjiB74iJ6p%2FFURHYdAg%2BNJI%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-27">2）在线安装</h4>
<p>在交互式命令中执行 /agents online 可以在线浏览Agents市场</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c14b237748db42aba5e4eb933c2fd069~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=TxkpdC4QlX6j9v%2BDi3dYdTupYF0%3D" alt="图片" loading="lazy"/></p>
<p>使用 ↑↓ 选择Agents， ←→ 翻页查看，使用对应的数字键进行安装</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96dc613154b44b0ebaca64c2504ad0eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=9fE2pqbvCnHajFXLLKq5Tn8XnF4%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-28">3）创建Subagents</h4>
<p>iFlow CLI创建Agents也有 2种 方式，可以使用交互式命令 /agents install 根据安装向导一步步安装</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ae439598cd6406aa49c730eb0a07fe2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=kG%2Ftc8tMd3IBqr2AKJZ6pPiM%2BoQ%3D" alt="图片" loading="lazy"/></p>
<p>也可以自定义安装，在全局或者项目 iflow/agents 目录下新建一个 my-agent.md 文件，输入如下提示词</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">agentType:</span> <span class="hljs-string">"custom-expert"</span>
<span class="hljs-attr">systemPrompt:</span> <span class="hljs-string">"你是一个自定义领域的专家..."</span>
<span class="hljs-attr">whenToUse:</span> <span class="hljs-string">"当需要处理特定领域任务时使用"</span>
<span class="hljs-attr">model:</span> <span class="hljs-string">"GLM-4.6"</span>
<span class="hljs-attr">allowedTools:</span> [<span class="hljs-string">"*"</span>]
<span class="hljs-string">proactive:</span> <span class="hljs-literal">false</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment"># Custom Expert Agent</span>
<span class="hljs-string">这是一个自定义专家Agent的详细说明...</span>
</code></pre>
<p>关于更详细的配置，感兴趣的小伙伴可以看官方Subagents文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.iflow.cn%2Fcli%2Fexamples%2Fsubagent%23%25E5%258F%25AF%25E9%2580%2589%25E5%25B1%259E%25E6%2580%25A7" target="_blank" title="https://platform.iflow.cn/cli/examples/subagent#%E5%8F%AF%E9%80%89%E5%B1%9E%E6%80%A7" ref="nofollow noopener noreferrer">platform.iflow.cn/cli/example…</a></p>
<p>在交互式命令中输入 /agents list 查看Subagents列表</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c51b08d0497419d932569dff8709ab1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=4a4EbtCTuf%2FjHcC%2BTAqo3Z8hWsQ%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-29">MCP服务</h3>
<p>iFlow支持MCP服务，提供了多种安装方式</p>
<h4 data-id="heading-30">1）心流MCP市场（推荐）</h4>
<p>访问心流MCP市场：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.iflow.cn%2Fmcp%25EF%25BC%258C%25E6%2589%25BE%25E5%2588%25B0MCP%25E7%2582%25B9%25E5%2587%25BB%25E3%2580%2590%25E5%25AE%2589%25E8%25A3%2585%25E3%2580%2591" target="_blank" title="https://platform.iflow.cn/mcp%EF%BC%8C%E6%89%BE%E5%88%B0MCP%E7%82%B9%E5%87%BB%E3%80%90%E5%AE%89%E8%A3%85%E3%80%91" ref="nofollow noopener noreferrer">platform.iflow.cn/mcp，找到MCP点击…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45acd9f57b41417d8df22cc0ab91add7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=T7eBEzzTU%2BqWRFRTCjK3fCGuZEA%3D" alt="图片" loading="lazy"/></p>
<p>复制命令在命令行终端一键安装</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea69c5dd2f214499a69df31451a0f990~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=9EezRx8P4N%2FPIX08gSOrIf7EzG4%3D" alt="图片" loading="lazy"/></p>
<p>安装完成后，在命令行终端输入 /iflow mcp list 可以查看MCP安装列表</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1ce0064102542898c631ec124969f1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=NPUqIyhQJXqXCulI%2FXix%2FUPlJn0%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-31">2）在线安装</h4>
<p>在交互式命令中执行 /mcp online 可以在线浏览MCP市场，选择合适的MCP进行安装</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10f94b337ca94ed8a750d57da4302012~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=E0sQBivIECNKbemvmdUJW%2F4enBE%3D" alt="图片" loading="lazy"/></p>
<p>使用 ↑↓ 选择MCP， ←→ 翻页查看，使用对应的数字键进行安装</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d38300daccd347c189098788301f692d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=AadxM1biaDQork%2Fkw8OImLDWxEs%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-32">3）命令行安装</h4>
<p>iFlow CLI和其他主流CLI一样支持使用命令行安装，默认安装到项目作用域</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash"> iflow mcp add --transport http context7 https://mcp.context7.com/mcp</span>
<span class="hljs-meta prompt_">#</span><span class="bash"> 完整安装方式</span>
<span class="hljs-meta prompt_">$</span><span class="bash"> iflow mcp add --transport http -s project context7 https://mcp.context7.com/mcp</span>
</code></pre>
<p>如果需要全局安装MCP可以添加 -s user 或 --scope user 标识</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash"> iflow mcp add --transport http -s user context7 https://mcp.context7.com/mcp</span>
<span class="hljs-meta prompt_">$</span><span class="bash"> iflow mcp add --transport http --scope user context7 https://mcp.context7.com/mcp</span>
</code></pre>
<h4 data-id="heading-33">4）配置文件安装</h4>
<p>在iFlow CLI中也可直接修改全局用户配置 ~/.iflow/settings.json 和 项目配置 .iflow/settings.json 直接添加MCP服务</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/396cda114aec4021b495bd650c35e827~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766287880&amp;x-signature=MEtB1rmdzRQPXxnfGz12ZoyKyt0%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-34">Hooks</h3>
<p>iFlow CLI提供了Hooks的支持，支持 用户配置 和 项目配置 2种配置层级</p>
<ul>
<li>用户配置：~/.iflow/settings.json</li>
<li>项目配置：.iflow/settings.json</li>
</ul>
<p>支持9大类Hooks类型，配置方式和Claude Code CLI基本一致。可以直接在 settings.json 文件中添加 hooks 配置项，完整配置如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"PreToolUse"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"matcher"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tool_pattern"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"command"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your_command"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"timeout"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">30</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"PostToolUse"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"matcher"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"another_pattern"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"command"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cleanup_command"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"SetUpEnvironment"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"command"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"python ~/.iflow/hooks/env_enhancer.py"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"timeout"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">30</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Stop"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"command"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"echo 'Session ended'"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"SubagentStop"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"command"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cleanup_subagent.sh"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"SessionStart"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"matcher"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"startup"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"command"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"echo 'Session initialized'"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"SessionEnd"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"command"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"python ~/.iflow/hooks/session_summary.py"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"UserPromptSubmit"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"matcher"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">".*sensitive.*"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"command"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"python ~/.iflow/hooks/content_filter.py"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Notification"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"matcher"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">".*permission.*"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"command"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"logger 'iFlow permission request'"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>本人尝试了几个没有触发过😂。</p>
<h2 data-id="heading-35">总结</h2>
<p>抛开iFlow CLI好用不好用之说，iFlow CLI首先免费就是一大优势，其次iFlow CLI应该是国内为数不多的在功能上基本追齐Claude Code CLI的CLI工具，自定义命令、自定义工作流、Subagnets、MCP、Hooks已是应由具有了，其次iFlow提供了对国人友好的各种工具的安装市场和详细的文档，是值得点赞的，在没有AI足够额度的情况还是可以作为代替使用的。</p>
<h2 data-id="heading-36">友情提示</h2>
<p>见原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FXkEycyJujBc3GC8zuR-E1A" target="_blank" title="https://mp.weixin.qq.com/s/XkEycyJujBc3GC8zuR-E1A" ref="nofollow noopener noreferrer">初识iFlow CLI</a></p>
<blockquote>
<p>本文同步自微信公众号 "<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FXkEycyJujBc3GC8zuR-E1A" target="_blank" title="https://mp.weixin.qq.com/s/XkEycyJujBc3GC8zuR-E1A" ref="nofollow noopener noreferrer">程序员小溪</a>" ，这里只是同步，想看及时消息请移步我的公众号，不定时更新我的学习经验。友情提示友情提示</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【AI编程】5分钟用Trae solo做出有BOSS战的《坦克大战》]]></title>    <link>https://juejin.cn/post/7582958136257413156</link>    <guid>https://juejin.cn/post/7582958136257413156</guid>    <pubDate>2025-12-14T03:55:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582958136257413156" data-draft-id="7582904081864146985" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【AI编程】5分钟用Trae solo做出有BOSS战的《坦克大战》"/> <meta itemprop="keywords" content="AI编程,AIGC,OpenAI"/> <meta itemprop="datePublished" content="2025-12-14T03:55:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卷福同学"/> <meta itemprop="url" content="https://juejin.cn/user/3456520291098686"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【AI编程】5分钟用Trae solo做出有BOSS战的《坦克大战》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520291098686/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卷福同学
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T03:55:13.000Z" title="Sun Dec 14 2025 03:55:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>友友们，又到了周末AI整活时间了</p>
</blockquote>
<p>现在AI编程工具已经能做到一句话的需求生成一个完整的项目了，今天我们用Trae solo来试着复刻小时候的游戏《坦克大战》，并且部署上线，下面是演示效果和地址：</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftanke-orpin.vercel.app%2F" target="_blank" title="https://tanke-orpin.vercel.app/" ref="nofollow noopener noreferrer">tanke-orpin.vercel.app/</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aeab79a71b4d425c8b9818acd0557d32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766289313&amp;x-signature=%2BLHjYO6TooME4DaJ%2BQtEGj4PnI0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">1.工具准备</h2>
<ul>
<li>
<p>下载Trae，国际版下载：<a href="https://www.trae.ai/" target="_blank" title="https://www.trae.ai/" ref="nofollow noopener noreferrer">www.trae.ai/</a>，国内版下载：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.trae.cn%2F" target="_blank" title="https://www.trae.cn/" ref="nofollow noopener noreferrer">www.trae.cn/</a></p>
</li>
<li>
<p>（国际版）注册Vercel：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvercel.com%2F" target="_blank" title="https://vercel.com/" ref="nofollow noopener noreferrer">vercel.com/</a></p>
</li>
</ul>
<p>这里我们使用国际版做演示，部署上线需要用到Vercel</p>
<p>国际版和国内版Trae的区别主要是使用的模型不同</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29d62d1cb9ff43fb9731ea65090e17f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766289313&amp;x-signature=RZuyQ5t8kgZ3Rax1s9rPZtptJSc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e7452bf1c6341f29a151bf3e689c9ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766289313&amp;x-signature=o61aR3aSOZLAxwfW8TQ1YxNaaGA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">2.输入需求</h2>
<p>首先打开Trae的solo模式，在左上角的位置</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00b6f6c0f83a4294a9df01c0765d2e69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766289313&amp;x-signature=5%2Bm1UOwseeL4nSiphlQWb3N1VMM%3D" alt="" loading="lazy"/></p>
<p>接着输入需求，我们需要考虑开发游戏的技术栈，直接把需求输入</p>
<blockquote>
<p>使用 H5开发一款童年经典的《坦克大战》游戏，只需要支持单人对战 AI，方向键控制移动，空格射击，包含关卡系统、碰撞检测、爆炸动画、音效、计分系统，使用 localStorage 保存进度。</p>
</blockquote>
<p>我们还可以点击下方的「优化」按钮，对现有提示词进行优化</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a290b7780799410c965afeed2a344bc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766289313&amp;x-signature=Iv%2F7Q4rvSsJJ%2B%2B5MxGvfE%2FQi%2BSM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f14026efc7f640989432da0e5d6cda62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766289313&amp;x-signature=rlH4a%2FWMqteqSOgBvJeg9a0ujSA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">3.开通Pro会员</h2>
<p>这一步小卷没注意到Trae Solo是Pro会员才有的功能，看了下价钱，首月只需要3美刀，折合下来是21块钱，还算可以，于是开通一个月的会员尝尝鲜</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45f4f83ac90e4e8fbbbb2812ac570238~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766289313&amp;x-signature=cGGAAQ32aULlMBw9qA3gBCR50fk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">4.开发</h2>
<p>Trae SOLO会先生成需求文档和技术架构文档，我们确认没问题之后就可以开始了。有问题可以继续对话让Trae SOLO修改就行</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2de39de0ae54fed829863e87aec5312~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766289313&amp;x-signature=KFFdAq6%2BugqKYxz2xEYMGfXAnS8%3D" alt="" loading="lazy"/></p>
<p>接着我们可以去喝喝茶，静静等待Trae完成工作就行。妥妥的领导指挥打工牛马的感觉</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60f6244d84ff4c1a8bdd2fe0402741ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766289313&amp;x-signature=8hlWmP6jbbmgQVmHxddVWRW1Cn4%3D" alt="" loading="lazy"/></p>
<p>等待所有任务完成后，发送提示词「运行游戏」给Trae就可以查看我们做出来的坦克大战了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2e5fa0d68054eb29a67db0a09e992de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766289313&amp;x-signature=IQWtos6l%2BXZ9lqlCBmaCttdbJKk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">5.加上AI脚本功能</h2>
<p>看到上面已经非常完美地复刻了《坦克大战》的游戏，但是考虑到玩家现在都比较懒，能不能做个功能，让AI帮我们玩呢，我们直接看AI对战AI岂不是也是一种乐趣吗，于是让Trae给我加上AI脚本的功能</p>
<blockquote>
<p>再新加个功能，加个开关按钮，打开开关后变成自动模式，坦克会自己移动去找敌人攻击，移动需要有目的性，在能攻击敌人时就直接攻击</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84632f81e73642b0982668723d1ad42c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766289313&amp;x-signature=ztbmDBdIY4jG8%2FxUReF7il1pNpc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">6.加上BOSS战</h2>
<p>童年经典游戏《坦克大战》虽然经典，但是遗憾没有BOSS战，小时候和小伙伴们曾经奋战1整天打到200多关之后了，就想看看有没有BOSS可以打，遗憾没有，</p>
<p>于是小卷我突发奇想，能不能加个BOSS战呢，这样玩起来乐趣也更大，也能补上小时候的遗憾了</p>
<blockquote>
<p>优化小兵刷新的逻辑，现在是按时间刷的吗，我需要的效果是：游戏场景里最多存在3个敌方小兵，每击杀1个，就刷新出一个，每关最多9个小兵，可以在游戏右上角位置显示剩余小兵数量，然后最后出来的那个敌方坦克属于BOSS，体型要大，血量要厚，需要攻击的次数随关卡数而增加。除此之外，BOSS还可以使用技能，比如：防护罩（短时间内无敌状态），AOE伤害（炮弹飞出去后，能爆炸造成范围伤害）</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b627c771a4b64f7896b89218956f2ddb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766289313&amp;x-signature=wqOhfywya%2BubkfqEy18Opg0EjkU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">7. 部署上线</h2>
<p>到此，游戏就做好，接下来就是部署上线了</p>
<p>需要先在Trae里给Vercel授权，在Vercel里创建一个新项目，然后点击部署</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e9fdba64a1e416b9a683c6934469f7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766289313&amp;x-signature=JWRmwpU7XD2VNa5%2ByttXNm%2BTvuM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/494c2519d723426aa3e4b007e22ac36f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766289313&amp;x-signature=N0mh9WYIWHVrZieJjDXXizZL%2BvQ%3D" alt="" loading="lazy"/></p>
<p>部署完成后，我们打开Vercel的页面，可以看到部署后的域名，直接浏览器打开就能开始玩了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/874919e42f024eb787c93cdbcb01eab6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766289313&amp;x-signature=fAeRpCw%2BKiBBE1M2o9Ue5Kbs6Ac%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">8.最后</h2>
<p>演示效果地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftanke-orpin.vercel.app%2F" target="_blank" title="https://tanke-orpin.vercel.app/" ref="nofollow noopener noreferrer">tanke-orpin.vercel.app/</a></p>
<p>今天分享了如果通过Trae Solo来开发一个小游戏，同样地，开发网站和部署也是一样的步骤</p>
<p>即使是不懂编程的人，可以通过AI编程工具完成一个需求，AI提效现在切切实实地用在提高生产力上了</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[程序员应该熟悉的概念(4)MCP能做什么]]></title>    <link>https://juejin.cn/post/7583174749066248238</link>    <guid>https://juejin.cn/post/7583174749066248238</guid>    <pubDate>2025-12-14T03:49:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583174749066248238" data-draft-id="7583174749066215470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="程序员应该熟悉的概念(4)MCP能做什么"/> <meta itemprop="keywords" content="人工智能,MCP"/> <meta itemprop="datePublished" content="2025-12-14T03:49:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘立军"/> <meta itemprop="url" content="https://juejin.cn/user/2830599308981642"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            程序员应该熟悉的概念(4)MCP能做什么
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2830599308981642/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘立军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T03:49:11.000Z" title="Sun Dec 14 2025 03:49:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上一篇文章 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwfcoding.com%2Farticles%2Fprogrammer%2Fp08%2F" target="_blank" title="http://wfcoding.com/articles/programmer/p08/" ref="nofollow noopener noreferrer">MCP简介</a> 中，我们对 <strong>MCP</strong>(Model Context Protocol)  有了一个概念上的认识，本文将更加深入的介绍 <strong>MCP</strong> 的架构和功能。</p>

<h2 data-id="heading-0">MCP是什么</h2>
<p>如果我们认为 <strong>LLM</strong>(大语言模型) 是<strong>大脑</strong>的话， <strong>MCP</strong> 提供其它的能力将给这个大脑装上<strong>四肢和五官</strong>，使得它具备与外界环境交互的能力。</p>
<p>使用 MCP，Claude 或 ChatGPT 等 AI 应用程序可以连接到数据源（例如本地文件、数据库）、工具（例如搜索引擎、计算器）和工作流（例如：复杂任务中间一个环节用到的提示词）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4c4206471c74a6b9e801261449f8d06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YiY56uL5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766288979&amp;x-signature=vk%2BAUdR3YafsM7opswcq%2FQj91vc%3D" alt="MCP功能示意图" loading="lazy"/></p>
<p>从上图可以看出，MCP有以下重要特点：</p>
<ul>
<li><strong>双向通信</strong>: 使用MCP连接的AI应用和各种工具的交互是 <strong>双向的</strong> ：AI工具可以访问工具，而后面的工具也可以主动访问AI应用，这与常用的API的单向调用不同。</li>
<li><strong>功能强大</strong>：它不止提供我们最容易想象的API调用能力，还可以与本地和远程数据源协同工作，甚至将人类、智能体/agent和外部世界连接起来。</li>
</ul>
<h2 data-id="heading-1">MCP架构</h2>
<p><strong>MCP</strong> 是<strong>CS(Client-Server)架构</strong> 。<br/>
MCP Host/主机（例如 <code>Claude Code</code> 或 <code>Claude Desktop</code> 等 AI 应用程序）会与一个或多个 <strong>MCP</strong> 服务端建立连接。MCP 主机通过为每个 MCP 服务端创建一个 MCP 客户端来实现这一点：每个 MCP 客户端都与其对应的 MCP 服务端保持一对一的专用连接。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f6ece69e7dc485d9477d7b07d33a14d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YiY56uL5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766288979&amp;x-signature=S6dUQbU1ySuVD%2BUf7bB8Hu4ydN0%3D" alt="MCP架构" loading="lazy"/></p>
<p>例如：用 <code>Visual Studio Code</code> 充当 MCP 主机。当 Visual Studio Code 建立与 MCP 服务端（例如 Sentry MCP 服务端）的连接时，Visual Studio Code 运行时会实例化一个 MCP 客户端对象，用于维护与 Sentry MCP 服务端的连接。当 Visual Studio Code 随后连接到另一个 MCP 服务端（例如本地文件系统服务端）时，Visual Studio Code 运行时会实例化另一个 MCP 客户端对象来维护此连接，从而保持 MCP 客户端与 MCP 服务端之间的一对一关系。</p>
<blockquote>
<p>后面的文章将使用<code>Visual Studio Code</code>进行上述场景的实战演练。</p>
</blockquote>
<h2 data-id="heading-2">服务端</h2>
<p>MCP 服务端常见的功能包括：用于文档访问的文件系统服务端、用于数据查询的数据库服务端、用于代码管理的 GitHub 服务端、用于团队沟通的 Slack 服务端以及用于日程安排的日历服务端。</p>

























<table><thead><tr><th align="left">功能</th><th align="left">说明</th><th align="left">例子</th></tr></thead><tbody><tr><td align="left">工具/tools</td><td align="left">大模型可以主动调用的函数，并根据用户请求决定何时使用它们。工具可以写入数据库、调用外部 API、修改文件或触发其他逻辑</td><td align="left">搜索航班、发送消息、创建日历活动。</td></tr><tr><td align="left">资源/resources</td><td align="left">提供对文件内容、数据库模式或 API 文档等数据源的只读访问。</td><td align="left">检索文档、访问知识库、阅读日历</td></tr><tr><td align="left">提示词模板/prompts</td><td align="left">预先构建的指令模板，它告诉大模型使用特定的工具和资源。</td><td align="left">计划假期、总结我的会议、起草电子邮件</td></tr></tbody></table>
<p><strong>提示词模板</strong> 是由用户控制而非主动触发的：服务端预定义提示词模板-&gt;用户输入提示此模板需要的参数-&gt; 服务端返回提示词让大模型处理。<br/>
例如：在旅行规划场景中，服务端会提前定义好提示词模板，其中包含参数：<code>出发地、目的地</code>，当用户输入<code>出发地、目的地</code>后，服务端才会使用这两个参数填充提示此模板，生成提示词返回。</p>
<h2 data-id="heading-3">客户端</h2>
<p><strong>MCP客户端</strong> 由 主机/MCP Host 应用程序实例化，用于与特定的 MCP 服务器通信。主机应用程序（例如 Claude.ai 或 IDE）负责管理整体用户体验并协调多个客户端。每个客户端处理与一台服务器的直接通信。<br/>
两者的区别至关重要：<strong>主机是用户与之交互的应用程序</strong>，而<strong>客户端是支持服务器连接的组件</strong>。<br/>
MCP客户端除了与MCP服务端通信以外，还连接了用户/人和大语言模型/LLM；在交互过程中，除了可以<strong>限制对资源的访问</strong>以外，可以进行<strong>人为审核和纠正</strong>。</p>

























<table><thead><tr><th align="left">功能</th><th align="left">说明</th><th align="left">例子</th></tr></thead><tbody><tr><td align="left">采样/Sampling</td><td align="left">MCP服务端通过MCP客户端请求大模型完成任务/LLM completions，从而实现智能体的工作流。这种方法使客户端能够完全控制用户权限和安全。</td><td align="left">预订旅行的MCP服务端可能会向 大模型/LLM 发送航班列表，并请求 大模型 为用户挑选最佳航班。</td></tr><tr><td align="left">根/Roots</td><td align="left">允许客户端指定MCP服务端可以访问哪些文件，引导它们到相关目录，同时保持安全边界。</td><td align="left">预订旅行的MCP服务端可能会被授予访问特定目录的权限，从而可以从中读取用户的日历。</td></tr><tr><td align="left">获取/Elicitation</td><td align="left">使MCP服务端能够在交互过程中向用户请求特定信息。</td><td align="left">预订旅行的MCP服务端可能会询问用户对飞机座位、房间类型或联系电话的偏好，以完成预订。</td></tr></tbody></table>
<blockquote>
<p>上述概念不容易理解，尤其是 <code>Sampling</code> 和我们直观的想象的 <code>采样</code> 不是同样的意思，我觉得未来有可能会改掉这些令人费解的叫法。<br/>
如果问各种AI平台：“MCP中的Sampling是什么意思？”，通常会体验到大模型的“幻觉”，大模型会懵掉：）</p>
</blockquote>
<p>鉴于上述概念用中文理解有一定难度，下面我们再一起学习一下这些功能的含义。</p>
<h3 data-id="heading-4">采样/Sampling</h3>
<p>这里的 <strong>采样/Sampling</strong> 并不是 随机抽取样本 的意思，而是由 MCP服务端 主动发起的，请求大模型完成的任务的行为。MCP客户端在构造客户端时，可以订阅MCP服务端的Sampling事件。<br/>
我们可以通过下面简单的代码片段进一步理解这一点：</p>
<p><strong>MCP服务端</strong>：向MCP客户端发送 <code>SamplingMessage</code> 消息，即吟诗一首，然后得到MCP客户端返回的结果。</p>
<pre><code class="hljs language-python" lang="python">mcp = FastMCP(name=<span class="hljs-string">"Sampling Example"</span>)


<span class="hljs-meta">@mcp.tool()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_poem</span>(<span class="hljs-params">topic: <span class="hljs-built_in">str</span>, ctx: Context[ServerSession, <span class="hljs-literal">None</span>]</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Generate a poem using LLM sampling."""</span>
    prompt = <span class="hljs-string">f"Write a short poem about <span class="hljs-subst">{topic}</span>"</span>

    result = <span class="hljs-keyword">await</span> ctx.session.create_message(
        messages=[
            SamplingMessage(
                role=<span class="hljs-string">"user"</span>,
                content=TextContent(<span class="hljs-built_in">type</span>=<span class="hljs-string">"text"</span>, text=prompt),
            )
        ],
        max_tokens=<span class="hljs-number">100</span>,
    )

    <span class="hljs-keyword">if</span> result.content.<span class="hljs-built_in">type</span> == <span class="hljs-string">"text"</span>:
        <span class="hljs-keyword">return</span> result.content.text
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(result.content)
</code></pre>
<p><strong>MCP客户端</strong>：订阅MCP服务端的 <code>SamplingMessage</code> 消息，调用大模型作诗后，返回给MCP服务端。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_sampling_message</span>(<span class="hljs-params">
    context: RequestContext[ClientSession, <span class="hljs-literal">None</span>], params: types.CreateMessageRequestParams
</span>) -&gt; types.CreateMessageResult:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Sampling request: <span class="hljs-subst">{params.messages}</span>"</span>)

    poem = <span class="hljs-string">"..."</span>  <span class="hljs-comment"># 调用大模型作诗</span>
    
    <span class="hljs-keyword">return</span> types.CreateMessageResult(
        role=<span class="hljs-string">"assistant"</span>,
        content=types.TextContent(
            <span class="hljs-built_in">type</span>=<span class="hljs-string">"text"</span>,
            text=poem,
        ),
        model=<span class="hljs-string">"qwen3"</span>,
        stopReason=<span class="hljs-string">"endTurn"</span>,
    )

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>():
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> stdio_client(server_params) <span class="hljs-keyword">as</span> (read, write):
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> ClientSession(read, write, sampling_callback=handle_sampling_message) <span class="hljs-keyword">as</span> session:
            <span class="hljs-comment"># Initialize the connection</span>
            <span class="hljs-keyword">await</span> session.initialize()

            <span class="hljs-comment"># ...</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""Entry point for the client script."""</span>
    asyncio.run(run())


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<p>在更加复杂的场景中，在 <code>采样/Sampling</code> 的过程中，可以由人来干预，如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27e996a4216f4f8196e5c2d8e258398a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YiY56uL5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766288979&amp;x-signature=DxLOXd5aPynJhI6as5PJeWd0ei0%3D" alt="采样/Sampling" loading="lazy"/></p>
<p>上述场景描述了：在MCP服务端请求大模型之前，人可以批准是否执行，也可以修改提示词；在大模型执行完提示词后，人可以批准大模型执行结果是否返回给MCP服务端，也可以修改此结果后再给MCP服务端。</p>
<h3 data-id="heading-5">获取/Elicitation</h3>
<p><strong>获取/Elicitation</strong> 使MCP服务端能够在交互过程中向用户请求特定信息，从而创建更具动态性和响应能力的工作流。在这个过程中：服务器无需预先收集所有信息，也无需在数据缺失时停止运行，而是可以暂停运行以请求用户的特定输入。</p>
<p>例如：在预定机票场景中，MCP服务端可以请求用户输入航班号、航班日期等信息，这样确认后，再由MCP服务端订票。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/561fb89fe0eb4d87b5d74990b82a541b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YiY56uL5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766288979&amp;x-signature=gqvZAQI3YkEgUq0dEBa0cSOi%2FdY%3D" alt="获取/Elicitation" loading="lazy"/></p>
<h2 data-id="heading-6">总结</h2>
<p>通过对MCP更多了解，可以发现： <strong>MCP</strong> 可以把大脑（大语言模型）和各种能力（五官和四肢）粘合起来，变成一个<strong>智能体/agent</strong>。</p>
<hr/>
<p><strong>参考</strong>:</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2F" target="_blank" title="https://modelcontextprotocol.io/" ref="nofollow noopener noreferrer">MCP官网</a></li>
</ul>
<p>🪐祝好运🪐</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在实战中运用泛型和动态trait（特质）]]></title>    <link>https://juejin.cn/post/7582905804048957467</link>    <guid>https://juejin.cn/post/7582905804048957467</guid>    <pubDate>2025-12-14T03:49:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582905804048957467" data-draft-id="7581667332306763814" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在实战中运用泛型和动态trait（特质）"/> <meta itemprop="keywords" content="设计模式"/> <meta itemprop="datePublished" content="2025-12-14T03:49:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="沐森"/> <meta itemprop="url" content="https://juejin.cn/user/4455643804079608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在实战中运用泛型和动态trait（特质）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4455643804079608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    沐森
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T03:49:00.000Z" title="Sun Dec 14 2025 03:49:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><code>PhantomData&lt;T&gt;</code></h2>
<p>// 先自定义一个数据结构</p>
<pre><code class="hljs language-js" lang="js">
#[<span class="hljs-title function_">derive</span>(<span class="hljs-title class_">Debug</span>, <span class="hljs-title class_">Default</span>, <span class="hljs-title class_">PartialEq</span>, <span class="hljs-title class_">Eq</span>)]
pub struct <span class="hljs-title class_">Identifier</span>&lt;T&gt;{
   <span class="hljs-attr">inner</span>:u64,
}
</code></pre>
<p>//然后在User和Product，各自用Identifier&gt; 来让 Identifier 和自己的类型绑定，达到让不同类型的 id 无法比较的目的</p>
<pre><code class="hljs language-js" lang="js">    
  #[<span class="hljs-title function_">derive</span>(<span class="hljs-title class_">Debug</span>, <span class="hljs-title class_">Default</span>, <span class="hljs-title class_">PartialEq</span>, <span class="hljs-title class_">Eq</span>)]
pub struct <span class="hljs-title class_">User</span> {
<span class="hljs-attr">id</span>: <span class="hljs-title class_">Identifier</span>&lt;<span class="hljs-title class_">Self</span>&gt;,<span class="hljs-comment">//self其实就是User</span>
}
#[<span class="hljs-title function_">derive</span>(<span class="hljs-title class_">Debug</span>, <span class="hljs-title class_">Default</span>, <span class="hljs-title class_">PartialEq</span>, <span class="hljs-title class_">Eq</span>)]
pub struct <span class="hljs-title class_">Product</span> {
<span class="hljs-attr">id</span>: <span class="hljs-title class_">Identifier</span>&lt;<span class="hljs-title class_">Self</span>&gt;,<span class="hljs-comment">//self其实就是Product</span>
}  
    
</code></pre>
<p>搞个测试用例</p>
<pre><code class="hljs language-js" lang="js">
#[<span class="hljs-title function_">cfg</span>(test)]
mod tests {
use <span class="hljs-attr">super</span>::*;
#[test]
fn <span class="hljs-title function_">id_should_not_be_the_same</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> user = <span class="hljs-title class_">User</span>::<span class="hljs-title function_">default</span>();
     <span class="hljs-keyword">let</span> product = <span class="hljs-title class_">Product</span>::<span class="hljs-title function_">default</span>();
    <span class="hljs-comment">// 两个 id 不能比较，因为他们属于不同的类型</span>
    <span class="hljs-comment">// assert_ne!(user.id, product.id);</span>
    assert_eq!(user.<span class="hljs-property">id</span>.<span class="hljs-property">inner</span>, product.<span class="hljs-property">id</span>.<span class="hljs-property">inner</span>);
  }
}


</code></pre>
<p><strong>测试结论：编译直接报错</strong></p>
<p>在 Rust 的类型系统中因为 Identifier 在定义时，并没有使用泛型参数 T，编译器认为 T 是多余的，所以只能把 T 删除掉才能编译通过。但是，删除掉 T，User 和 Product 的 id 就可以比较了</p>
<h3 data-id="heading-1">删掉 T 后的代码长什么样？</h3>
<p>如果你为了编译通过，把泛型 <code>T</code> 和 <code>PhantomData</code> 都删了，代码变成了这样：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 1. Identifier 现在只是一个普通的结构体，没有任何泛型标记</span>
<span class="hljs-meta">#[derive(Debug, Default, PartialEq, Eq)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Identifier</span> {
    inner: <span class="hljs-type">u64</span>,
}

<span class="hljs-comment">// 2. User 里面放的是 Identifier</span>
<span class="hljs-meta">#[derive(Debug, Default, PartialEq, Eq)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">User</span> {
    id: Identifier, 
}

<span class="hljs-comment">// 3. Product 里面放的也是 Identifier</span>
<span class="hljs-meta">#[derive(Debug, Default, PartialEq, Eq)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Product</span> {
    id: Identifier, 
}
</code></pre>
<h3 data-id="heading-2">为什么这时候可以比较了？</h3>
<p>当你写 <code>assert_eq!(user.id, product.id)</code> 时，Rust 编译器做的是<strong>类型匹配</strong>。</p>
<ul>
<li><strong>左边</strong>：<code>user.id</code>。它的类型是什么？是 <code>Identifier</code>。</li>
<li><strong>右边</strong>：<code>product.id</code>。它的类型是什么？也是 <code>Identifier</code>。</li>
<li><strong>编译器判断</strong>：<code>Identifier</code> 和 <code>Identifier</code> 是同一个类型吗？<strong>是！</strong></li>
</ul>
<p>既然类型相同，而且你实现了 <code>PartialEq</code>，编译器就会去比较里面的值 (<code>inner</code>)。因为都是默认值 0，所以它们相等。</p>
<h3 data-id="heading-3">核心误区：父结构体不会“污染”子字段</h3>
<p>你之前的困惑点在于：</p>
<blockquote>
<p>“User 和 Product 是不同的 struct，那它们里面的 id 不也应该不同吗？”</p>
</blockquote>
<p><strong>打个比方：</strong></p>
<ul>
<li><strong>User</strong> 是一个 <strong>红色的盒子</strong>。</li>
<li><strong>Product</strong> 是一个 <strong>蓝色的盒子</strong>。</li>
<li><strong>Identifier (无泛型)</strong>  是 <strong>一支铅笔</strong>。</li>
</ul>
<p>现在：</p>
<ol>
<li>你在红色盒子里放了一支铅笔。</li>
<li>你在蓝色盒子里放了一支铅笔。</li>
<li>你把两支铅笔拿出来对比：<strong>它们是一样的铅笔吗？</strong></li>
</ol>
<p><strong>答案是肯定的。</strong>  盒子（struct）不同，不代表盒子里的东西（field）变成了不同的类型。除非你在铅笔上刻字（这就是泛型的作用）</p>
<h3 data-id="heading-4">现在我们添加上<code>PhantomData&lt;T&gt;</code></h3>
<p>当我们把 <code>PhantomData&lt;T&gt;</code> 和 <code>Identifier&lt;T&gt;</code> 加回来时，相当于我们<strong>给铅笔刻了字</strong></p>
<pre><code class="hljs language-js" lang="js">    
    use <span class="hljs-attr">std</span>::<span class="hljs-attr">marker</span>::<span class="hljs-title class_">PhantomData</span>;
#[<span class="hljs-title function_">derive</span>(<span class="hljs-title class_">Debug</span>, <span class="hljs-title class_">Default</span>, <span class="hljs-title class_">PartialEq</span>, <span class="hljs-title class_">Eq</span>)]
pub struct <span class="hljs-title class_">Identifier</span>&lt;T&gt; {
<span class="hljs-attr">inner</span>: u64,
<span class="hljs-attr">_tag</span>: <span class="hljs-title class_">PhantomData</span>&lt;T&gt;,
}
#[<span class="hljs-title function_">derive</span>(<span class="hljs-title class_">Debug</span>, <span class="hljs-title class_">Default</span>, <span class="hljs-title class_">PartialEq</span>, <span class="hljs-title class_">Eq</span>)]
pub struct <span class="hljs-title class_">User</span> {
<span class="hljs-attr">id</span>: <span class="hljs-title class_">Identifier</span>&lt;<span class="hljs-title class_">Self</span>&gt;,
}
#[<span class="hljs-title function_">derive</span>(<span class="hljs-title class_">Debug</span>, <span class="hljs-title class_">Default</span>, <span class="hljs-title class_">PartialEq</span>, <span class="hljs-title class_">Eq</span>)]
pub struct <span class="hljs-title class_">Product</span> {
<span class="hljs-attr">id</span>: <span class="hljs-title class_">Identifier</span>&lt;<span class="hljs-title class_">Self</span>&gt;,
}
#[<span class="hljs-title function_">cfg</span>(test)]
mod tests {
use <span class="hljs-attr">super</span>::*;
#[test]
fn <span class="hljs-title function_">id_should_not_be_the_same</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">let</span> user = <span class="hljs-title class_">User</span>::<span class="hljs-title function_">default</span>();
<span class="hljs-keyword">let</span> product = <span class="hljs-title class_">Product</span>::<span class="hljs-title function_">default</span>();
<span class="hljs-comment">// 两个 id 不能比较，因为他们属于不同的类型</span>
<span class="hljs-comment">// assert_ne!(user.id, product.id);</span>
assert_eq!(user.<span class="hljs-property">id</span>.<span class="hljs-property">inner</span>, product.<span class="hljs-property">id</span>.<span class="hljs-property">inner</span>);
}
    
    
</code></pre>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">-</span>   <span class="hljs-code">`User`</span> 里的 <span class="hljs-code">`id`</span> 类型变成了 <span class="hljs-code">`Identifier&lt;User&gt;`</span> （刻着“用户专用”的铅笔）。
</code></pre>
<ul>
<li><code>Product</code> 里的 <code>id</code> 类型变成了 <code>Identifier&lt;Product&gt;</code> （刻着“商品专用”的铅笔）。</li>
</ul>
<p>这时候编译器再看：</p>
<ul>
<li>
<p>左边：<code>Identifier&lt;User&gt;</code></p>
</li>
<li>
<p>右边：<code>Identifier&lt;Product&gt;</code></p>
</li>
<li>
<p>编译器满意了（认为你用了 T），结构体定义通过编译</p>
</li>
<li>
<p><strong>编译器判断</strong>：这是两个完全不同的类型，就像 <code>String</code> 和 <code>i32</code> 一样不同，禁止比较！</p>
</li>
</ul>
<h3 data-id="heading-5">总结</h3>
<ol>
<li><strong>没有泛型时</strong>：<code>user.id</code> 和 <code>product.id</code> 的类型<strong>完全一样</strong>，都是 <code>Identifier</code>。它们只是恰好被放在了不同的结构体里，但这不影响它们自身的类型身份。所以可以比较。</li>
<li><strong>有泛型时</strong>：泛型参数 <code>&lt;T&gt;</code> 变成了类型签名的一部分。<code>Identifier&lt;User&gt;</code> 和 <code>Identifier&lt;Product&gt;</code> 是两个<strong>截然不同</strong>的类型。所以不能比较。</li>
</ol>
<p>这就是为什么我们需要 <code>PhantomData</code>。它不仅是为了让编译器通过，更是为了把 <strong>User</strong> 这个身份信息，强行“注入”到 <strong>Identifier</strong> 这个类型里，实现业务逻辑上的隔离。
<strong>PhantomData</strong>：只是个<strong>创可贴</strong>。当你仅仅想用 <code>T</code> 做标签，而不想真的存 <code>T</code> 类型的数据时，用来哄编译器开心的。</p>
<h2 data-id="heading-6"><code>Trait Object</code></h2>
<p>三个例子分别对应了 <strong>Trait Object</strong> 的三大核心用途：<strong>统一接口（多态参数）</strong> 、<strong>工厂模式（动态返回）</strong>  和 <strong>异构集合（混合存储）</strong> 。</p>
<p>请按照顺序手敲，并在敲代码时思考注释里的问题。</p>
<hr/>
<h3 data-id="heading-7">例子 1：函数参数 (动态分发)</h3>
<p><strong>目的：</strong>  理解如何编写一个函数，让它能接受任何实现了特定 Trait 的类型，而不需要像泛型那样为每个类型生成一份代码（减小二进制体积）。</p>
<p><strong>场景：</strong>  我们做一个  <strong>“渲染引擎”</strong> ，不管你是 <code>Button</code> 还是 <code>Image</code>，只要你会 <code>render</code>，我就能把你画出来。</p>
<p>Rust</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 1. 定义行为特征</span>
<span class="hljs-keyword">trait</span> <span class="hljs-title class_">Renderable</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">render</span>(&amp;<span class="hljs-keyword">self</span>);
}

<span class="hljs-comment">// 2. 定义具体组件</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Button</span> { label: <span class="hljs-type">String</span> }
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Renderable</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Button</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">render</span>(&amp;<span class="hljs-keyword">self</span>) {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"绘制按钮: [ {} ]"</span>, <span class="hljs-keyword">self</span>.label);
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Image</span> { src: <span class="hljs-type">String</span> }
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Renderable</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Image</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">render</span>(&amp;<span class="hljs-keyword">self</span>) {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"绘制图片: &lt;img&gt;{}&lt;/img&gt;"</span>, <span class="hljs-keyword">self</span>.src);
    }
}

<span class="hljs-comment">// 3. 【核心】函数参数使用 &amp;dyn Renderable</span>
<span class="hljs-comment">// 思考：为什么这里不用泛型 fn draw&lt;T: Renderable&gt;(item: &amp;T) ?</span>
<span class="hljs-comment">// 答案：如果用泛型，编译器会生成 draw_for_button 和 draw_for_image 两份代码。</span>
<span class="hljs-comment">//      用 dyn，代码只有一份，通过 vtable 动态查找 render 方法。</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">draw_component</span>(item: &amp;<span class="hljs-keyword">dyn</span> Renderable) {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"&gt;&gt;&gt; 开始渲染组件..."</span>);
    item.<span class="hljs-title function_ invoke__">render</span>(); <span class="hljs-comment">// 运行时查表调用</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"&lt;&lt;&lt; 渲染结束\n"</span>);
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">btn</span> = Button { label: <span class="hljs-string">"提交"</span>.<span class="hljs-title function_ invoke__">into</span>() };
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">img</span> = Image { src: <span class="hljs-string">"logo.png"</span>.<span class="hljs-title function_ invoke__">into</span>() };

    <span class="hljs-comment">// 传入引用，自动转为 Trait Object 胖指针</span>
    <span class="hljs-title function_ invoke__">draw_component</span>(&amp;btn); 
    <span class="hljs-title function_ invoke__">draw_component</span>(&amp;img);
}
</code></pre>
<hr/>
<h3 data-id="heading-8">例子 2：函数返回值 (工厂模式)</h3>
<p><strong>目的：</strong>  解决 Rust 函数只能返回确定大小类型的限制。理解为什么返回值必须包在 <code>Box</code> 里。</p>
<p><strong>场景：</strong>  一个跨平台的 <strong>UI 工厂</strong>。根据传入的配置字符串，决定是造一个 Windows 风格的组件，还是 MacOS 风格的组件。</p>
<p>Rust</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">trait</span> <span class="hljs-title class_">Widget</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">draw</span>(&amp;<span class="hljs-keyword">self</span>);
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">WindowsWidget</span>;
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Widget</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">WindowsWidget</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">draw</span>(&amp;<span class="hljs-keyword">self</span>) { <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Style: Windows (方角)"</span>); }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MacWidget</span>;
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Widget</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">MacWidget</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">draw</span>(&amp;<span class="hljs-keyword">self</span>) { <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Style: MacOS (圆角)"</span>); }
}

<span class="hljs-comment">// 【核心】函数返回值 Box&lt;dyn Widget&gt;</span>
<span class="hljs-comment">// 思考：为什么不能写 fn create_widget() -&gt; dyn Widget ?</span>
<span class="hljs-comment">// 答案：dyn Widget 大小不确定（可能是 WindowsWidget 0字节，也可能是巨型结构体）。</span>
<span class="hljs-comment">//      函数栈帧无法预留内存。必须把数据扔到堆(Box)上，返回固定大小的胖指针。</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">widget_factory</span>(os_type: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> Widget&gt; {
    <span class="hljs-keyword">if</span> os_type == <span class="hljs-string">"windows"</span> {
        <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(WindowsWidget)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(MacWidget)
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 运行时决定返回什么类型</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">w1</span> = <span class="hljs-title function_ invoke__">widget_factory</span>(<span class="hljs-string">"windows"</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">w2</span> = <span class="hljs-title function_ invoke__">widget_factory</span>(<span class="hljs-string">"mac"</span>);

    w1.<span class="hljs-title function_ invoke__">draw</span>();
    w2.<span class="hljs-title function_ invoke__">draw</span>();
}
</code></pre>
<p><strong>对比练习：</strong>  如果你尝试把返回值改成 <code>impl Widget</code>（静态分发），编译器会报错，因为 <code>if/else</code> 分支返回了不同的类型。只有 <code>Box&lt;dyn Widget&gt;</code> 才能抹平这种差异。</p>
<hr/>
<h3 data-id="heading-9">例子 3：数据结构 (异构集合)</h3>
<p><strong>目的：</strong>  在一个 <code>Vec</code> 列表中存储不同类型的对象。这是泛型 <code>Vec&lt;T&gt;</code> 做不到的。</p>
<p><strong>场景：</strong>  一个 <strong>事件处理器列表</strong>。你的 App 里有不同类型的监听器（点击监听、键盘监听），你想把它们放在同一个数组里统一管理。</p>
<p>Rust</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 1. 定义事件监听行为</span>
<span class="hljs-keyword">trait</span> <span class="hljs-title class_">EventListener</span> {
    <span class="hljs-comment">// 这里的 &amp;self 也是动态分发的关键</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">on_event</span>(&amp;<span class="hljs-keyword">self</span>, event_name: &amp;<span class="hljs-type">str</span>);
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ClickListener</span>;
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">EventListener</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">ClickListener</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">on_event</span>(&amp;<span class="hljs-keyword">self</span>, e: &amp;<span class="hljs-type">str</span>) {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"鼠标点击触发: {}"</span>, e);
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">KeyListener</span> { key_code: <span class="hljs-type">u32</span> }
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">EventListener</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">KeyListener</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">on_event</span>(&amp;<span class="hljs-keyword">self</span>, e: &amp;<span class="hljs-type">str</span>) {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"键盘按键 {} 触发: {}"</span>, <span class="hljs-keyword">self</span>.key_code, e);
    }
}

<span class="hljs-comment">// 2. 【核心】在结构体中使用 Vec&lt;Box&lt;dyn Trait&gt;&gt;</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">App</span> {
    <span class="hljs-comment">// 这是一个"混合"列表，可以存任何实现了 EventListener 的东西</span>
    listeners: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> EventListener&gt;&gt;,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">App</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> { listeners: <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>() }
    }

    <span class="hljs-comment">// 注册监听器</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_listener</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, l: <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> EventListener&gt;) {
        <span class="hljs-keyword">self</span>.listeners.<span class="hljs-title function_ invoke__">push</span>(l);
    }

    <span class="hljs-comment">// 触发所有事件</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">fire_event</span>(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>) {
        <span class="hljs-keyword">for</span> <span class="hljs-variable">listener</span> <span class="hljs-keyword">in</span> &amp;<span class="hljs-keyword">self</span>.listeners {
            <span class="hljs-comment">// listener 是 Box&lt;dyn ...&gt;</span>
            <span class="hljs-comment">// Rust 会自动解引用 Box，并利用内部的 vtable 调用正确的方法</span>
            listener.<span class="hljs-title function_ invoke__">on_event</span>(event);
        }
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">app</span> = App::<span class="hljs-title function_ invoke__">new</span>();

    <span class="hljs-comment">// 塞入不同类型的结构体</span>
    app.<span class="hljs-title function_ invoke__">add_listener</span>(<span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(ClickListener));
    app.<span class="hljs-title function_ invoke__">add_listener</span>(<span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(KeyListener { key_code: <span class="hljs-number">13</span> })); <span class="hljs-comment">// Enter键</span>

    app.<span class="hljs-title function_ invoke__">fire_event</span>(<span class="hljs-string">"用户登录"</span>);
}
</code></pre>
<hr/>
<pre><code class="hljs language-rust" lang="rust">第三个点 **数据结构 (`<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> Trait&gt;&gt;`)**  确实是 Rust 和 JS 思维差异最大的地方。
</code></pre>
<p>只要搞懂了  <strong>“内存对其”</strong>  和  <strong>“鸭子类型”</strong>  的区别，你就彻底懂了。</p>
<p>我们用一个最经典的场景：<strong>游戏里的背包系统</strong>。</p>
<hr/>
<h3 data-id="heading-10">1. JavaScript 的做法：魔法口袋 (Duck Typing)</h3>
<p>在 JS 里，数组（Array）是一个<strong>魔法口袋</strong>。它可以随便装东西，不管你塞进去的是什么。</p>
<p><strong>JS 场景：</strong>  你的游戏背包里有三个东西：一把剑 (<code>Sword</code>)，一瓶药 (<code>Potion</code>)，一张地图 (<code>Map</code>)。它们不一样大，属性也不一样，但它们都有一个共同点：<strong>可以被“使用” (<code>use()</code>)</strong> 。</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JS 代码</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Sword</span> {
    <span class="hljs-title function_">use</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"挥剑攻击！"</span>); }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Potion</span> {
    <span class="hljs-title function_">use</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"喝药回血！"</span>); }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Map</span> {
    <span class="hljs-title function_">use</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"查看地图..."</span>); }
}

<span class="hljs-comment">// 1. 创建背包 (Array)</span>
<span class="hljs-comment">// JS: 我不管你塞什么，反正我都接得住</span>
<span class="hljs-keyword">const</span> bag = [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sword</span>(),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Potion</span>(),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(), 
    <span class="hljs-string">"甚至塞个字符串进去JS也不报错"</span> 
];

<span class="hljs-comment">// 2. 遍历使用</span>
<span class="hljs-comment">// JS: 只要你有 use() 方法，我就调用。如果没有，我运行时候再报错。</span>
bag.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-title function_">use</span>());
</code></pre>
<p><strong>特点：</strong>  JS 是  <strong>“鸭子类型”</strong> （Duck Typing）。只要它走起来像鸭子，叫起来像鸭子，我就把它当鸭子。JS 数组存的是<strong>引用（Reference）</strong> ，不在乎具体的内存大小。</p>
<hr/>
<h3 data-id="heading-11">2. Rust 的原生做法：强迫症的格子铺 (<code>Vec&lt;T&gt;</code>)</h3>
<p>Rust 是<strong>静态类型</strong>语言，而且对<strong>内存布局</strong>有强迫症。</p>
<p>标准的 <code>Vec&lt;T&gt;</code> 就像是一个<strong>超市货架的陈列盒</strong>。</p>
<ul>
<li>如果你定义 <code>Vec&lt;Sword&gt;</code>，那这个盒子里<strong>每一个格子</strong>都必须刚好能放下 <code>Sword</code> 那么大的东西。</li>
<li><code>Sword</code> 可能占 10 个字节，<code>Potion</code> 可能占 4 个字节。</li>
</ul>
<p><strong>Rust 的困境：</strong>  如果你想把 <code>Sword</code> 和 <code>Potion</code> 放在同一个 <code>Vec</code> 里：</p>
<p>Rust</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">bag</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();
bag.<span class="hljs-title function_ invoke__">push</span>(Sword);  <span class="hljs-comment">// 放入剑</span>
bag.<span class="hljs-title function_ invoke__">push</span>(Potion); <span class="hljs-comment">// ❌ 报错！类型不匹配！</span>
<span class="hljs-comment">// 编译器怒吼：这个 Vec 是专门放 Sword 的，你拿个 Potion 过来干什么？尺寸都不一样！</span>
</code></pre>
<p>这就像你买了一箱红酒的泡沫箱（有固定孔洞），你非要往里塞个西瓜，塞不进去啊！</p>
<hr/>
<h3 data-id="heading-12">3. 解决方案：统一包装盒 (<code>Vec&lt;Box&lt;dyn Trait&gt;&gt;</code>)</h3>
<p>既然 <code>Sword</code> 和 <code>Potion</code> 大小不一样，那怎么把它们放进同一个格子里呢？</p>
<p><strong>答案：</strong>  把它们分别装进<strong>统一大小的快递盒</strong>里！</p>
<p>这个“快递盒”就是 <strong><code>Box</code>（指针）</strong> 。</p>
<ul>
<li>不管里面的东西多大，<strong>指针的大小是固定的</strong>（在 64 位系统上就是 8 字节）。</li>
<li>我们在快递盒外面贴个标签： <strong>“可使用物品 (dyn Usable)”</strong> 。</li>
</ul>
<p>这样，<code>Vec</code> 里存的不再是千奇百怪的物品，而是<strong>整整齐齐的快递盒</strong>。</p>
<p>Rust</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 定义特征：所有物品必须能被“使用”</span>
<span class="hljs-keyword">trait</span> <span class="hljs-title class_">Usable</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">use_item</span>(&amp;<span class="hljs-keyword">self</span>);
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Sword</span>;
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Usable</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Sword</span> { <span class="hljs-keyword">fn</span> <span class="hljs-title function_">use_item</span>(&amp;<span class="hljs-keyword">self</span>) { <span class="hljs-built_in">println!</span>(<span class="hljs-string">"挥剑！"</span>); } }

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Potion</span>;
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Usable</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Potion</span> { <span class="hljs-keyword">fn</span> <span class="hljs-title function_">use_item</span>(&amp;<span class="hljs-keyword">self</span>) { <span class="hljs-built_in">println!</span>(<span class="hljs-string">"喝药！"</span>); } }

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 创建背包：这是一个专门装“Usable 快递盒”的列表</span>
    <span class="hljs-comment">// Box&lt;dyn Usable&gt; 的大小是固定的（胖指针大小）</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">bag</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> Usable&gt;&gt; = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();

    <span class="hljs-comment">// 1. 装箱</span>
    <span class="hljs-comment">// 把 Sword 装进 Box，变成 Box&lt;dyn Usable&gt;</span>
    bag.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(Sword)); 
    <span class="hljs-comment">// 把 Potion 装进 Box，变成 Box&lt;dyn Usable&gt;</span>
    bag.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(Potion));

    <span class="hljs-comment">// 2. 遍历</span>
    <span class="hljs-keyword">for</span> <span class="hljs-variable">item</span> <span class="hljs-keyword">in</span> bag {
        <span class="hljs-comment">// item 现在是一个盒子</span>
        <span class="hljs-comment">// Rust 运行时会看盒子上的标签(vtable)，决定怎么用里面的东西</span>
        item.<span class="hljs-title function_ invoke__">use_item</span>();
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-13">4. 深度对比图表</h3>









































<table><thead><tr><th>维度</th><th>JS 数组 (<code>[]</code>)</th><th>Rust 普通泛型 (<code>Vec&lt;T&gt;</code>)</th><th>Rust Trait Object (<code>Vec&lt;Box&lt;dyn Trait&gt;&gt;</code>)</th></tr></thead><tbody><tr><td><strong>画面感</strong></td><td><strong>魔法袋</strong></td><td><strong>红酒专用箱</strong></td><td><strong>集装箱货船</strong></td></tr><tr><td><strong>存储内容</strong></td><td>啥都能混着装</td><td>只能装<strong>完全一样</strong>的东西</td><td>装着<strong>不同货物</strong>的<strong>标准集装箱</strong></td></tr><tr><td><strong>原理</strong></td><td>存的都是动态引用</td><td>存的是紧凑的原始数据</td><td>存的是<strong>统一大小的指针 (Box)</strong></td></tr><tr><td><strong>内存效率</strong></td><td>低 (各种元数据)</td><td><strong>极高</strong> (无间隙)</td><td>中等 (多一次指针跳转)</td></tr><tr><td><strong>灵活性</strong></td><td>极高 (随便混用)</td><td>低 (不能混用)</td><td><strong>高 (实现了 Trait 就能混用)</strong></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-14">5. 为什么叫“杂物箱”？</h3>
<p>回到那个比喻：</p>
<ul>
<li>
<p><strong>泛型 (<code>Vec&lt;Apple&gt;</code>)</strong> ：这就像水果店的**“精品苹果礼盒”**。每一个坑位都是为了苹果设计的，你敢放个梨进去，盖子都盖不上（编译不过）。</p>
</li>
<li>
<p><strong>Trait Object (<code>Vec&lt;Box&lt;dyn Fruit&gt;&gt;</code>)</strong> ：这就像搬家公司的**“杂物箱”**。</p>
<ul>
<li>你想把 苹果、梨、甚至西瓜 放在一起运走。</li>
<li>你不能直接堆在一起（不好码放）。</li>
<li>你把苹果装进一个小纸箱 (<code>Box</code>)。</li>
<li>把梨装进另一个小纸箱 (<code>Box</code>)。</li>
<li>把西瓜装进一个大纸箱 (<code>Box</code>)。</li>
<li><strong>关键点：</strong>  虽然里面的水果大小不同，但这些<strong>纸箱的外表</strong>看起都是规整的长方体。</li>
<li>现在，你可以把这些纸箱整整齐齐地码放在卡车 (<code>Vec</code>) 里了。</li>
</ul>
</li>
</ul>
<p><strong>这就是 <code>Vec&lt;Box&lt;dyn Trait&gt;&gt;</code> 的意义：通过 Box 统一尺寸，通过 Trait 统一接口，实现了在强类型语言中存储“不同种类”数据的能力。</strong></p>
<h3 data-id="heading-15">总结与核心记忆点</h3>
<p>当你敲完这三段代码，请在脑子里回放这三个画面：</p>
<ol>
<li>
<p><strong>函数参数 (<code>&amp;dyn Trait</code>)</strong> ：</p>
<ul>
<li><strong>画面</strong>：万能插座。</li>
<li><strong>目的</strong>：为了让一份函数代码兼容多种输入类型（省空间，解耦）。</li>
</ul>
</li>
<li>
<p><strong>函数返回值 (<code>Box&lt;dyn Trait&gt;</code>)</strong> ：</p>
<ul>
<li><strong>画面</strong>：盲盒。</li>
<li><strong>目的</strong>：为了在运行时根据逻辑吐出不同类型的对象（因为栈上放不下未知的类型，只能放堆指针）。</li>
</ul>
</li>
<li>
<p><strong>数据结构 (<code>Vec&lt;Box&lt;dyn Trait&gt;&gt;</code>)</strong> ：</p>
<ul>
<li><strong>画面</strong>：杂物箱。</li>
<li><strong>目的</strong>：为了把“苹果”和“梨”放在同一个篮子里（泛型篮子只能放一种水果，Trait Object 篮子能放所有“水果”）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-16">Trait Object 到底是做什么的？</h3>
<p>用技术语言总结，它主要为了解决 Rust <strong>强类型系统</strong>带来的两个“痛点”：</p>
<h4 data-id="heading-17">痛点 1：我想把不同的东西放在同一个数组里</h4>
<p>在 Rust 里，数组 <code>Vec&lt;T&gt;</code> 的 <code>T</code> 必须是<strong>同一种</strong>具体类型。你不能在 <code>Vec&lt;String&gt;</code> 里放 <code>int</code>。</p>
<ul>
<li><strong>没有 Trait Object</strong>：你没法把 <code>Button</code>（按钮）和 <code>Input</code>（输入框）放在同一个 <code>UI_List</code> 里。</li>
<li><strong>有了 Trait Object</strong>：你可以定义一个 <code>trait Widget</code>，然后创建一个 <code>Vec&lt;Box&lt;dyn Widget&gt;&gt;</code>。这里面既能放按钮，也能放输入框，因为它们都是 <code>dyn Widget</code>。</li>
</ul>
<h4 data-id="heading-18">痛点 2：我想在运行时决定返回什么类型</h4>
<p>有些函数，根据条件的判定，可能返回 <code>A</code> 类型，也可能返回 <code>B</code> 类型。</p>
<ul>
<li><strong>没有 Trait Object</strong>：函数返回值 <code>-&gt; T</code> 必须在编译时确定是哪一个 struct。你不能写 <code>if x { return Button } else { return Input }</code>，编译器会报错。</li>
<li><strong>有了 Trait Object</strong>：你可以让函数返回 <code>Box&lt;dyn Widget&gt;</code>。编译器就不管具体是啥了，只管你返回的东西是一个“Widget 指针”。</li>
</ul>
<hr/>
<h3 data-id="heading-19">3. 为什么说是“运行时”？</h3>
<p>为了让你理解“运行时”和“编译时”的区别，看这个对比：</p>
<h4 data-id="heading-20">泛型 (编译时确定)</h4>
<p>Rust</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 泛型函数</span>
<span class="hljs-function">fn <span class="hljs-title">run</span>&lt;<span class="hljs-title">T</span>: <span class="hljs-title">Workable</span>&gt;(<span class="hljs-params">worker: T</span>)</span> {
    worker.work();
}

<span class="hljs-comment">// 编译时：</span>
<span class="hljs-comment">// 编译器发现你对 Programmer 调用了 run，它就生成了一份 run_for_programmer 代码。</span>
<span class="hljs-comment">// 编译器发现你对 Designer 调用了 run，它又生成了一份 run_for_designer 代码。</span>
<span class="hljs-comment">// 这里的 worker.work() 是直接写死的函数地址，速度极快。</span>
</code></pre>
<h4 data-id="heading-21">Trait Object (运行时确定)</h4>
<p>Rust</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Trait Object 函数</span>
fn <span class="hljs-built_in">run</span>(worker: &amp;dyn Workable) {
    worker<span class="hljs-selector-class">.work</span>();
}

<span class="hljs-comment">// 编译时：</span>
<span class="hljs-comment">// 编译器只生成这一份代码。它不知道 worker 到底是啥。</span>
<span class="hljs-comment">// 编译器在代码里留了一句话：“到时候去查这个 worker 的虚表(vtable)，看它对应的 work 函数在哪。”</span>

<span class="hljs-comment">// 运行时：</span>
<span class="hljs-comment">// 程序跑到了这里，拿到了 worker。</span>
<span class="hljs-comment">// 程序：查看 vtable -&gt; 找到函数地址 -&gt; 跳转执行。</span>
<span class="hljs-comment">// 这个“查表-跳转”的过程，就是运行时的动态分发。</span>
</code></pre>
<h3 data-id="heading-22">总结</h3>
<p><strong>Trait Object (<code>dyn Trait</code>)</strong>  的作用就是：</p>
<ol>
<li>
<p><strong>忘掉身份</strong>：把具体的 <code>User</code>、<code>Product</code> 等类型信息忘掉，只记住它们实现了什么 Trait。</p>
</li>
<li>
<p><strong>统一管理</strong>：让不同的类型能进入同一个容器（<code>Vec</code>），或者通过同一个函数接口。</p>
</li>
<li>
<p><strong>动态决策</strong>：把“到底执行哪个具体的函数”这个决定，推迟到程序运行的时候再做。</p>
</li>
</ol>
<p>按“侧重点”切分：</p>
<ul>
<li><strong>泛型 + PhantomData</strong> → 侧重  <strong>“搞数据结构”</strong> （定型、身份、内存布局）。</li>
<li><strong>Trait Object</strong> → 侧重  <strong>“搞函数”</strong> （调用、行为、动态分发）。</li>
</ul>
<p>这个切入点非常刁钻且有效。为了帮你达到 100% 的理解，我稍微帮你<strong>微调</strong>一下定义，你会发现豁然开朗。</p>
<p>我们要用  <strong>“身份 (Identity)”</strong>  和  <strong>“能力 (Capability)”</strong>  这两个词来区分它们。</p>
<hr/>
<h3 data-id="heading-23">1. 泛型 + PhantomData = 侧重“身份” (Identity)</h3>
<p><strong>——“你是谁？”</strong></p>
<p>你说的“搞数据结构”完全没毛病。这套机制的核心任务就是<strong>定义身份</strong>，确立<strong>严格的类型边界</strong>。</p>
<ul>
<li>
<p><strong>数据结构上</strong>：它负责生成<strong>专用</strong>的内存布局。</p>
<ul>
<li><code>Identifier&lt;User&gt;</code> 和 <code>Identifier&lt;Product&gt;</code> 是两个物种。</li>
<li>这就是在定义“我是 User 专用的 ID”，或者“我是 Product 专用的 ID”。</li>
<li><strong>PhantomData</strong> 是这个身份的<strong>防伪标签</strong>，防止你在编译期搞混身份。</li>
</ul>
</li>
<li>
<p><strong>函数上</strong>：它其实也搞函数，但是是<strong>专用的函数</strong>。</p>
<ul>
<li>编译器生成了 <code>fn save_user()</code> 和 <code>fn save_product()</code>。</li>
<li><strong>核心逻辑</strong>：因为你是 <code>User</code>（身份），所以我只准你调 <code>User</code> 的方法。</li>
</ul>
</li>
</ul>
<p><strong>总结</strong>：这一派是  <strong>“看人下菜碟”</strong> 。因为你的<strong>数据结构身份</strong>确定了，所以你的代码逻辑就定死了。</p>
<hr/>
<h3 data-id="heading-24">2. Trait Object = 侧重“能力” (Capability)</h3>
<p><strong>——“你会干什么？”</strong></p>
<p>你说的“搞函数”也非常到位。这套机制的核心任务就是<strong>抹去身份，只看行为</strong>。</p>
<ul>
<li>
<p><strong>数据结构上</strong>：它<strong>不在乎</strong>具体的内存布局。</p>
<ul>
<li>它把数据打包进黑盒子（胖指针）。</li>
<li>它说：“我不管你本身是圆的还是扁的（是 User 还是 Product），我都把你当成一个<code>dyn Workable</code>”。</li>
</ul>
</li>
<li>
<p><strong>函数上</strong>：这是它的主战场。</p>
<ul>
<li>它通过 vtable（虚表）来动态调用函数。</li>
<li><strong>核心逻辑</strong>：我不管你是谁，只要你<strong>会干活</strong>（有这个函数），我就调你。</li>
</ul>
</li>
</ul>
<p><strong>总结</strong>：这一派是  <strong>“只要结果”</strong> 。它忽略数据结构的差异，只为了统一执行<strong>函数调用</strong>。</p>
<hr/>
<h3 data-id="heading-25">3. 终极对比图：一张表理清“搞什么”</h3>



































<table><thead><tr><th>维度</th><th><strong>泛型 + PhantomData</strong></th><th><strong>Trait Object (<code>dyn</code>)</strong></th></tr></thead><tbody><tr><td><strong>你的总结</strong></td><td><strong>搞数据结构</strong> (✅ 侧重身份定义)</td><td><strong>搞函数</strong> (✅ 侧重行为调用)</td></tr><tr><td><strong>核心哲学</strong></td><td><strong>严谨的分类学</strong></td><td><strong>灵活的实用主义</strong></td></tr><tr><td><strong>场景比喻</strong></td><td><strong>身份证系统</strong> 每个人都有唯一的身份证，不同省份的人不能乱归类。</td><td><strong>全能工装</strong> 不管你是谁，穿上这身衣服（Trait），我就让你进工地干活。</td></tr><tr><td><strong>编译器态度</strong></td><td>“我要知道你祖宗十八代是谁，一点都不能错。”</td><td>“我不管你是谁，把活干了就行。”</td></tr><tr><td><strong>何时用？</strong></td><td>当你需要<strong>类型安全</strong>，防止张冠李戴时。 (如：防止把用户ID传给商品API)</td><td>当你需要<strong>统一管理</strong>，处理一堆杂乱对象时。 (如：把按钮、图片、文字都放在一个列表里渲染)</td></tr></tbody></table>
<h3 data-id="heading-26">4. 结论</h3>
<p>你的理解在<strong>宏观架构</strong>上是完全成立的：</p>
<ul>
<li>当我们想<strong>利用 Rust 的类型系统来防止业务逻辑错误</strong>（比如那个 ID 混用的例子）时，我们用 <strong>泛型 + PhantomData</strong>。这确实是在精心设计<strong>数据结构</strong>之间的关系。</li>
<li>当我们想<strong>利用 Rust 的多态性来写通用的业务代码</strong>（比如渲染器、插件系统）时，我们用 <strong>Trait Object</strong>。这确实是在关注<strong>函数</strong>接口的统一调用。</li>
</ul>
<p><strong>所以，答案是：Yes！这个二分法非常实用，完全可以作为你写 Rust 架构时的指导方针。</strong></p>
<p><strong>一句话口诀：</strong>  <strong>泛型是“千人千面”（生成多份代码），Trait Object 是“千人一面”（统一接口，查表执行）。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Maven 核心知识点（核心概念 + IDEA 集成 + 依赖管理 + 单元测试实战）]]></title>    <link>https://juejin.cn/post/7582872365522878502</link>    <guid>https://juejin.cn/post/7582872365522878502</guid>    <pubDate>2025-12-13T12:33:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582872365522878502" data-draft-id="7582875640308564018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Maven 核心知识点（核心概念 + IDEA 集成 + 依赖管理 + 单元测试实战）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-13T12:33:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员根根"/> <meta itemprop="url" content="https://juejin.cn/user/555679166786139"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Maven 核心知识点（核心概念 + IDEA 集成 + 依赖管理 + 单元测试实战）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/555679166786139/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员根根
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T12:33:42.000Z" title="Sat Dec 13 2025 12:33:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好！Maven 作为 Java 生态中事实标准的<strong>项目管理与构建工具</strong>，彻底解决了传统开发中 “手动导包混乱”“项目构建繁琐”“多模块协作困难” 等痛点。对于开发者而言，掌握 Maven 不仅是提升开发效率的基础，更是理解 Java 项目工程化的关键。</p>
<p>这篇文章会从 Maven 的核心概念入手，详细讲解如何在 IDEA 中高效集成 Maven，深入剖析依赖管理的核心技巧，同时结合 JUnit 实现单元测试的自动化，帮你构建完整的 Maven 使用体系。</p>
<h2 data-id="heading-0">一、Maven 核心认知：什么是 Maven？</h2>
<h3 data-id="heading-1">1.1 Maven 的定义与核心价值</h3>
<p>Maven 是 Apache 基金会推出的<strong>基于 POM（Project Object Model，项目对象模型）</strong>  的项目管理工具，其核心价值可概括为 “<strong>一个中心，三个基本点</strong>”：</p>
<ul>
<li>
<p><strong>一个中心</strong>：以<code>pom.xml</code>为核心，集中管理项目所有配置；</p>
</li>
<li>
<p><strong>三个基本点</strong>：</p>
<ul>
<li><strong>构建自动化</strong>：替代手动编译、打包、测试、部署，通过标准化命令完成全流程；</li>
<li><strong>依赖管理标准化</strong>：自动下载、管理 jar 包，解决依赖冲突，告别 “复制粘贴 jar 包” 的时代；</li>
<li><strong>项目结构标准化</strong>：定义统一的 Java 项目目录结构，实现跨团队协作的一致性。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">1.2 Maven 的核心概念</h3>
<h4 data-id="heading-3">（1）POM 文件</h4>
<p><code>pom.xml</code>是 Maven 项目的 “灵魂”，位于项目根目录，包含项目的 GAV 坐标、依赖配置、构建插件、模块关系等所有核心信息。Maven 的所有操作都围绕 POM 文件展开。</p>
<h4 data-id="heading-4">（2）GAV 坐标</h4>
<p>Maven 通过<strong>GroupId + ArtifactId + Version</strong>（GAV）为每个项目 / 依赖赋予唯一标识，如同 “身份证”：</p>
<ul>
<li><strong>GroupId</strong>：组织 / 公司的唯一标识（如<code>org.springframework.boot</code>）；</li>
<li><strong>ArtifactId</strong>：项目 / 模块的名称（如<code>spring-boot-starter-web</code>）；</li>
<li><strong>Version</strong>：项目版本（如<code>2.7.10</code>，分为快照版<code>SNAPSHOT</code>和正式版<code>RELEASE</code>）。</li>
</ul>
<h4 data-id="heading-5">（3）仓库体系</h4>
<p>仓库是 Maven 存储依赖 jar 包的仓库，分为三级结构：</p>
<ul>
<li><strong>本地仓库</strong>：开发者本地电脑的目录（默认<code>~/.m2/repository</code>），缓存下载的依赖；</li>
<li><strong>中央仓库</strong>：Maven 官方维护的远程仓库（<a href="https://link.juejin.cn?target=https%3A%2F%2Frepo.maven.apache.org%2Fmaven2" target="_blank" title="https://repo.maven.apache.org/maven2" ref="nofollow noopener noreferrer">repo.maven.apache.org/maven2</a>），包含几乎所有开源 jar 包；</li>
<li><strong>私服仓库</strong>：企业内部搭建的私有仓库，用于存储内部组件和缓存中央仓库依赖（如 Nexus、Artifactory）。</li>
</ul>
<h4 data-id="heading-6">（4）生命周期与插件</h4>
<p>Maven 定义了三套标准化的<strong>构建生命周期</strong>（Clean、Default、Site），每个生命周期包含多个阶段（如 Default 生命周期的<code>compile</code>、<code>test</code>、<code>package</code>）；而每个阶段的具体操作由<strong>插件</strong>完成（如<code>maven-compiler-plugin</code>负责编译，<code>maven-surefire-plugin</code>负责单元测试）。</p>
<h2 data-id="heading-7">二、IDEA 集成 Maven：从配置到项目创建</h2>
<p>IDEA 自带 Maven 插件，但为了灵活控制版本和配置，推荐使用<strong>自定义本地 Maven</strong>。以下以 IDEA 2024.x 为例，讲解完整的集成步骤。</p>
<h3 data-id="heading-8">2.1 前期准备：下载并配置 Maven</h3>
<h4 data-id="heading-9">步骤 1：下载 Maven</h4>
<p>从<a href="https://link.juejin.cn?target=https%3A%2F%2Fmaven.apache.org%2Fdownload.cgi" target="_blank" title="https://maven.apache.org/download.cgi" ref="nofollow noopener noreferrer">Maven 官方网站</a>下载稳定版（如 apache-maven-3.9.4），解压到<strong>无中文、无空格</strong>的目录（如<code>D:\apache-maven-3.9.4</code>）。</p>
<h4 data-id="heading-10">步骤 2：配置环境变量（可选，推荐）</h4>
<p>为了在任意目录执行 Maven 命令，配置系统环境变量：</p>
<ol>
<li>新建<code>MAVEN_HOME</code>，值为 Maven 解压目录；</li>
<li>编辑<code>Path</code>，添加<code>%MAVEN_HOME%\bin</code>；</li>
<li>验证：打开命令行，输入<code>mvn -v</code>，显示版本信息则配置成功。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/802790cfa40a4d0cb825a79a6214d510~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5qC55qC5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766234022&amp;x-signature=l7SpTbJ%2F8vuTMlHLDfJbX8jEQc4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/175675e8f30b49c089ee4824b2eb80ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5qC55qC5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766234022&amp;x-signature=Igs%2Fj8RbP0fI6pOtYcsDEaqzGFc%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/123a8cfebaf34900921cdb68d42a752b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5qC55qC5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766234022&amp;x-signature=XNVXJneNqLPg2OWCB9wNGjnIe7Q%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d52abd8503a749a98aa80032d96e462f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5qC55qC5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766234022&amp;x-signature=1bVgD2pZSPodNM6O9yZbp1Eh7UU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d22c0271b204180b3ce057091e9ee40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5qC55qC5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766234022&amp;x-signature=QWmvGhQMrHexTmgFA4o7paB0EUs%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff3d819826ff4488b0bb871fda92abf2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5qC55qC5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766234022&amp;x-signature=%2Bf1hj42Q4BqkadHxkCCq%2BX%2BSLEo%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7905c0566614d0fad1508fca859bee1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5qC55qC5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766234022&amp;x-signature=cuCUj6VivFNSzMckk8LrXrCpokc%3D" alt="image.png" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/512b36a4128e41a48cd653f5b42de376~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5qC55qC5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766234022&amp;x-signature=YnFPRAR%2FQgFrSwqZvaDcNFtNKAw%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-11">步骤 3：优化 Maven 配置（settings.xml）</h4>
<p>修改 Maven 解压目录下<code>conf/settings.xml</code>，解决 “下载慢” 和 “C 盘占用” 问题：</p>
<h5 data-id="heading-12">（1）配置本地仓库路径</h5>
<p>将默认的 C 盘本地仓库改为非系统盘：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 本地仓库路径 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">localRepository</span>&gt;</span>D:\java\apache-maven-3.9.4\mvn_repo\<span class="hljs-tag">&lt;/<span class="hljs-name">localRepository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
</code></pre>
<h5 data-id="heading-13">（2）配置阿里云镜像（加速依赖下载）</h5>
<p>国内访问中央仓库速度慢，配置阿里云镜像：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">mirrors</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mirror</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>alimaven<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>aliyun maven<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">mirrorOf</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">mirrorOf</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">mirror</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">mirrors</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
</code></pre>
<h3 data-id="heading-14">2.2 IDEA 中配置 Maven</h3>
<h4 data-id="heading-15">步骤 1：打开 Maven 配置界面</h4>
<p>依次点击<code>File &gt; Settings</code>（Windows/Linux）或<code>IntelliJ IDEA &gt; Settings</code>（Mac），找到<code>Build, Execution, Deployment &gt; Build Tools &gt; Maven</code>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85a80bf9e5ad414688574d71f66337a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5qC55qC5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766234022&amp;x-signature=HIlnDT5uMru0Pd2PZmXuCRCR8qE%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-16">步骤 2：配置核心参数</h4>

























<table><thead><tr><th>参数</th><th>配置值</th><th>说明</th></tr></thead><tbody><tr><td>Maven home directory</td><td>本地 Maven 解压目录（如<code>D:\apache-maven-3.9.6</code>）</td><td>不使用 IDEA 自带 Maven，避免版本锁定</td></tr><tr><td>User settings file</td><td>修改后的<code>settings.xml</code>路径</td><td>勾选<code>Override</code>，强制使用自定义配置</td></tr><tr><td>Local repository</td><td>自动读取<code>settings.xml</code>配置</td><td>无需手动修改</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e95b373a3e04841958cb8151400cce1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5qC55qC5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766234022&amp;x-signature=KHy7EunNvwzQgWd2poLHqq%2BErSc%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-17">步骤 3：配置 Maven 运行 JDK</h4>
<p>在<code>Maven &gt; Runner</code>中，选择<code>JRE</code>为项目使用的 JDK 版本（如 JDK 17），避免编译时 JDK 版本不兼容。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/551fa64c02734957ae4ecba511b9af57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5qC55qC5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766234022&amp;x-signature=llrwe%2Bt0h25OP5NlA68IjdIqnHY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90d8ca4447f64f90a79d3d2586bf1a4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5qC55qC5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766234022&amp;x-signature=JxdAoG2htu7VQ30PP8YTBA3HEXg%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-18">2.3 在 IDEA 中创建 Maven 项目</h3>
<h4 data-id="heading-19">方式 1：创建普通 Maven 项目</h4>
<ol>
<li>点击<code>File &gt; New &gt; Project</code>，左侧选择<code>Maven</code>，取消勾选<code>Create from archetype</code>；</li>
<li>填写 GAV 信息（如<code>com.xxx</code>、<code>maven-demo</code>、<code>1.0-SNAPSHOT</code>）；</li>
<li>选择存储路径，点击<code>Create</code>，生成标准 Maven 项目结构。</li>
</ol>
<h4 data-id="heading-20">方式 2：创建多模块 Maven 项目</h4>
<ol>
<li>先创建父模块（普通 Maven 项目）；</li>
<li>右键父模块 → <code>New &gt; Module</code>，创建子模块（如<code>module-common</code>、<code>module-service</code>）；</li>
<li>父模块<code>pom.xml</code>会自动生成<code>&lt;modules&gt;</code>标签，管理子模块依赖。</li>
</ol>
<h3 data-id="heading-21">2.4 IDEA 中 Maven 的常用操作</h3>
<p>IDEA 右侧的<code>Maven</code>窗口集成了所有常用操作：</p>
<ul>
<li><strong>Reload All Maven Projects</strong>：修改<code>pom.xml</code>后重新加载；</li>
<li><strong>Clean</strong>：清理编译后的<code>target</code>目录；</li>
<li><strong>Compile</strong>：编译 Java 代码；</li>
<li><strong>Test</strong>：运行单元测试；</li>
<li><strong>Package</strong>：打包生成 jar/war 包；</li>
<li><strong>Install</strong>：将项目安装到本地仓库。</li>
</ul>
<h2 data-id="heading-22">三、Maven 依赖管理：核心技巧与冲突解决</h2>
<p>依赖管理是 Maven 的核心功能，掌握以下技巧可解决 90% 的依赖问题。</p>
<h3 data-id="heading-23">3.1 依赖的基本配置</h3>
<p>在<code>pom.xml</code>的<code>&lt;dependencies&gt;</code>标签中添加依赖，以引入 hutool 为例：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- hutool依赖 --&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.8.27<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<p>添加后点击<code>Reload All Maven Projects</code>，Maven 会自动下载依赖并引入项目。</p>
<p><strong>导入成功代码实现</strong></p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-comment">//将给定的字符串进行反转，使用糊涂工具StrUtil</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">"根根的hutool工具"</span>;
    <span class="hljs-type">String</span> <span class="hljs-variable">reverse</span> <span class="hljs-operator">=</span> StrUtil.reverse(s);
    System.out.println(reverse);
}
</code></pre>
<h3 data-id="heading-24">3.2 依赖范围（Scope）：控制依赖的生效阶段</h3>
<p>依赖范围决定了依赖在项目生命周期中的生效范围，常用范围如下：</p>













































<table><thead><tr><th>范围</th><th>编译期</th><th>测试期</th><th>运行期</th><th>打包时</th><th>典型应用</th></tr></thead><tbody><tr><td>compile（默认）</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>核心业务依赖（如 spring-core）</td></tr><tr><td>test</td><td>❌</td><td>✅</td><td>❌</td><td>❌</td><td>测试依赖（如 JUnit）</td></tr><tr><td>provided</td><td>✅</td><td>✅</td><td>❌</td><td>❌</td><td>容器提供的依赖（如 servlet-api）</td></tr><tr><td>runtime</td><td>❌</td><td>✅</td><td>✅</td><td>✅</td><td>运行时依赖（如数据库驱动）</td></tr></tbody></table>
<p><strong>示例：引入 JUnit 测试依赖</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!--junit--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.jupiter<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-jupiter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.9.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-25">3.3 依赖传递与排除</h3>
<h4 data-id="heading-26">（1）依赖传递</h4>
<p>Maven 的依赖具有传递性：若 A 依赖 B，B 依赖 C，则 A 会自动依赖 C，无需手动引入。</p>
<h4 data-id="heading-27">（2）依赖排除</h4>
<p>若需排除不必要的传递依赖（如解决冲突），使用<code>&lt;exclusions&gt;</code>标签：</p>
<pre><code class="hljs language-xml" lang="xml">    <span class="hljs-comment">&lt;!--spring-context--&gt;</span>
    <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-context --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-comment">&lt;!--依赖排除aop: 以后项目中jar包邮冲突就会排除解决--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h2 data-id="heading-28">四、Maven 集成单元测试：JUnit 实战</h2>
<p>单元测试是保障代码质量的关键，Maven 与 JUnit 的集成可实现测试自动化，以下以 JUnit 4 和 JUnit 5 为例讲解实战。</p>
<h3 data-id="heading-29">4.1 引入 JUnit 依赖</h3>
<h4 data-id="heading-30">JUnit 5（Jupiter）依赖配置</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!--junit--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.jupiter<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-jupiter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.9.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-31">4.2 编写单元测试用例</h3>
<p>Maven 规定测试代码必须放在<code>src/test/java</code>目录下，与主代码目录<code>src/main/java</code>对应。</p>
<h4 data-id="heading-32">示例 ：JUnit 5 测试用例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.xxx;

<span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.junit.jupiter.api.Assertions.assertEquals;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CalculatorTest</span> {
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAdd</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Calculator</span> <span class="hljs-variable">calculator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Calculator</span>();
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> calculator.add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
        assertEquals(<span class="hljs-number">3</span>, result);
    }
}
</code></pre>
<h3 data-id="heading-33">4.3 运行单元测试</h3>
<h4 data-id="heading-34">方式 1：在 IDEA 中直接运行</h4>
<p>右键测试类 / 方法，选择<code>Run 'CalculatorTest'</code>，IDEA 会自动执行测试并显示结果。</p>
<h4 data-id="heading-35">方式 2：通过 Maven 命令运行</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 运行所有测试用例</span>
mvn <span class="hljs-built_in">test</span>

<span class="hljs-comment"># 打包时跳过测试（避免测试失败导致打包失败）</span>
mvn clean package -DskipTests
</code></pre>
<h3 data-id="heading-36">4.4 测试结果分析与插件配置</h3>
<h4 data-id="heading-37">（1）测试结果报告</h4>
<p>Maven 会将测试结果输出到<code>target/surefire-reports</code>目录，生成 HTML 和 XML 格式的报告，方便查看测试通过率和失败原因。</p>
<h4 data-id="heading-38">（2）配置测试插件（maven-surefire-plugin）</h4>
<p>通过插件可自定义测试规则，如指定测试类、跳过特定测试：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.0-M7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                <span class="hljs-comment">&lt;!-- 只运行以Test结尾的测试类 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*Test.java<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
<h3 data-id="heading-39">4.5 单元测试最佳实践</h3>
<ol>
<li><strong>测试类命名</strong>：被测试类名 +<code>Test</code>（如<code>CalculatorTest</code>）；</li>
<li><strong>测试方法命名</strong>：<code>test</code>+ 被测试方法名（如<code>testAdd</code>）；</li>
<li><strong>单一职责</strong>：每个测试方法只测试一个功能点；</li>
<li><strong>断言明确</strong>：使用具体的断言方法（如<code>assertEquals</code>、<code>assertTrue</code>），避免模糊断言。</li>
</ol>
<h2 data-id="heading-40">五、Maven 常用命令与实战技巧</h2>
<h3 data-id="heading-41">5.1 高频 Maven 命令</h3>









































<table><thead><tr><th>命令</th><th>功能</th></tr></thead><tbody><tr><td><code>mvn clean</code></td><td>清理<code>target</code>目录</td></tr><tr><td><code>mvn compile</code></td><td>编译主代码</td></tr><tr><td><code>mvn test</code></td><td>运行单元测试</td></tr><tr><td><code>mvn package</code></td><td>打包生成 jar/war 包</td></tr><tr><td><code>mvn install</code></td><td>安装到本地仓库</td></tr><tr><td><code>mvn deploy</code></td><td>部署到远程私服</td></tr><tr><td><code>mvn dependency:tree</code></td><td>查看依赖树</td></tr><tr><td><code>mvn clean verify</code></td><td>执行完整的构建周期（含测试、检查）</td></tr></tbody></table>
<h3 data-id="heading-42">5.2 实战技巧</h3>
<ol>
<li>
<p><strong>统一 JDK 编译版本</strong>：避免不同开发者 JDK 版本不一致导致的编译错误：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>多模块项目的依赖继承</strong>：父模块通过<code>&lt;dependencyManagement&gt;</code>统一管理版本，子模块直接引入无需指定版本；</p>
</li>
<li>
<p><strong>使用快照版依赖</strong>：开发阶段使用<code>SNAPSHOT</code>版本，Maven 会自动拉取最新的快照包，方便团队协作。</p>
</li>
</ol>
<h2 data-id="heading-43">六、常见问题与解决方案</h2>
<h3 data-id="heading-44">6.1 依赖下载失败</h3>
<ul>
<li><strong>原因</strong>：网络问题、镜像配置错误、本地仓库缓存损坏；</li>
<li><strong>解决</strong>：检查镜像配置、删除本地仓库中对应依赖目录、重新执行<code>mvn clean install</code>。</li>
</ul>
<h3 data-id="heading-45">6.2 测试用例运行失败</h3>
<ul>
<li><strong>原因</strong>：测试代码错误、依赖缺失、JDK 版本不兼容；</li>
<li><strong>解决</strong>：检查测试代码断言、确认 JUnit 依赖是否正确引入、配置测试插件的 JDK 版本。</li>
</ul>
<h3 data-id="heading-46">6.3 IDEA 中 pom.xml 修改后不生效</h3>
<ul>
<li><strong>解决</strong>：点击右侧 Maven 窗口的<code>Reload All Maven Projects</code>，或按<code>Ctrl+Shift+O</code>重新导入。</li>
</ul>
<h2 data-id="heading-47">七、总结与延伸</h2>
<h3 data-id="heading-48">7.1 核心总结</h3>
<ol>
<li>Maven 的核心是 POM 文件，通过 GAV 坐标和仓库体系实现依赖的标准化管理；</li>
<li>在 IDEA 中集成 Maven 的关键是配置自定义 Maven 路径和阿里云镜像，提升使用效率；</li>
<li>依赖管理的核心是掌握依赖范围、传递性和冲突解决，通过<code>&lt;dependencyManagement&gt;</code>统一版本；</li>
<li>Maven 与 JUnit 的集成实现了单元测试自动化，是保障代码质量的重要手段。</li>
</ol>
<h3 data-id="heading-49">7.2 后续学习延伸</h3>
<ul>
<li><strong>Maven 高级用法</strong>：学习聚合工程、继承、插件开发、私服搭建（Nexus）；</li>
<li><strong>构建工具对比</strong>：了解 Gradle 的优势与使用（新一代构建工具，比 Maven 更高效）；</li>
<li><strong>CI/CD 集成</strong>：将 Maven 与 Jenkins 集成，实现自动化构建、测试、部署。</li>
</ul>
<p>Maven 是 Java 开发的基础工具，掌握它不仅能大幅提升开发效率，更能帮助你理解 Java 项目的工程化思想。建议在实际项目中多动手实践，遇到问题时通过依赖树和日志快速定位解决，逐步形成自己的 Maven 使用体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flask生产级模板：统一返回、日志、异常、JSON编解码，开箱即用可扩展]]></title>    <link>https://juejin.cn/post/7582848701268623395</link>    <guid>https://juejin.cn/post/7582848701268623395</guid>    <pubDate>2025-12-13T12:41:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582848701268623395" data-draft-id="7582861402278510626" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flask生产级模板：统一返回、日志、异常、JSON编解码，开箱即用可扩展"/> <meta itemprop="keywords" content="Python,后端"/> <meta itemprop="datePublished" content="2025-12-13T12:41:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="起风了___"/> <meta itemprop="url" content="https://juejin.cn/user/3298190615395896"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flask生产级模板：统一返回、日志、异常、JSON编解码，开箱即用可扩展
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3298190615395896/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    起风了___
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T12:41:51.000Z" title="Sat Dec 13 2025 12:41:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">文章简介</h2>
<ul>
<li>一直在用 Python 写一些脚本，最近想通过其他服务调用 Python 脚本，所以用 Flask 搭服务暴露接口让其他服务调用。现在将这个服务中的一些基础能力抽出来作为模版。</li>
<li>模版提供以下能力：
<ul>
<li>统一返回数据格式</li>
<li>统一为返回数据设置对象的 json 编解码器</li>
<li>日志同时输出至控制台、文件，日志文件自动截断</li>
<li>统一捕获异常信息</li>
</ul>
</li>
<li>代码放在 Github 上，后续有能够作为通用能力的功能都会更新在仓库中
<ul>
<li>仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthe-wind-is-rising-dev%2Fflask-server-template.git" target="_blank" title="https://github.com/the-wind-is-rising-dev/flask-server-template.git" ref="nofollow noopener noreferrer">github.com/the-wind-is…</a></li>
</ul>
</li>
<li>友情提示：不建议直接克隆模版仓库来搭建工程，建议按需复制所需代码，自行搭建</li>
</ul>
<h2 data-id="heading-1">依赖信息</h2>
<p>此处的依赖信息可能不全，还请需要的朋友自行查找所需依赖</p>
<ul>
<li>flask：Flask 框架</li>
<li>numpy：只用于演示统一的 json 编解码器</li>
<li>logging：日志模块</li>
</ul>
<h2 data-id="heading-2">统一返回数据格式</h2>
<ul>
<li>代码位置文件：src/controller/result.py</li>
<li>数据结构：
<ul>
<li>success：接口是否成功</li>
<li>result：响应结果</li>
<li>message：接口信息响应信息，一般为报错信息</li>
</ul>
</li>
<li>提供两种使用方式
<ul>
<li>成功返回：Result.success(data) data为返回的数据</li>
<li>失败返回：Result.fail(message) message：为错误信息</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>(<span class="hljs-title class_ inherited__">dict</span>):
    <span class="hljs-string">"""
    结果对象
    """</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, isSuccess: <span class="hljs-built_in">bool</span>, result: <span class="hljs-built_in">any</span> = <span class="hljs-literal">None</span>, message: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        self[<span class="hljs-string">"success"</span>] = <span class="hljs-string">"success"</span> <span class="hljs-keyword">if</span> isSuccess <span class="hljs-keyword">else</span> <span class="hljs-string">"fail"</span>
        self[<span class="hljs-string">"result"</span>] = result
        self[<span class="hljs-string">"message"</span>] = message

<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">success</span>(<span class="hljs-params">cls, result: <span class="hljs-built_in">any</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-keyword">return</span> cls(isSuccess=<span class="hljs-literal">True</span>, result=result)

<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fail</span>(<span class="hljs-params">cls, message: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-keyword">return</span> cls(isSuccess=<span class="hljs-literal">False</span>, message=message)

</code></pre>
<h2 data-id="heading-3">为返回数据设置 python 对象的 json 编码器</h2>
<ul>
<li>代码位置：src/utils/json_codec.py</li>
<li>json 编码器提供两种
<ul>
<li>1、Flask 框架所需的, 使用方式：self.json = DefaultJSONProvider(app)，我有继承 Flask 对象，此处的 self 可以替换为Flask 对象</li>
<li>2、json 模块所需的, 使用方式：json.dumps(data, cls=CustomEncoder)</li>
</ul>
</li>
<li>两种编码器都统一使用 codec 函数，其他对象如果也需要处理，可以在 codec 函数添加</li>
</ul>
<pre><code class="hljs language-python" lang="python">	<span class="hljs-keyword">def</span> <span class="hljs-title function_">codec</span>(<span class="hljs-params">obj</span>):
	    <span class="hljs-string">""" 自定义编解码器，特殊对象转换 """</span>
	    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(obj, datetime):
	        <span class="hljs-comment"># 处理日期时间对象</span>
	        <span class="hljs-keyword">return</span> obj.strftime(<span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>)
	    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(obj, Enum):
	        <span class="hljs-comment"># 处理枚举对象</span>
	        <span class="hljs-keyword">return</span> obj.name
	    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(obj, np.ndarray):
	        <span class="hljs-comment"># 处理容器类型中的特殊对象</span>
	        <span class="hljs-keyword">return</span> obj.tolist()
	    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(obj, np.integer):
	        <span class="hljs-comment"># 处理numpy整数类型</span>
	        <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(obj)
	    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(obj, np.floating):
	        <span class="hljs-comment"># 处理numpy浮点数类型</span>
	        <span class="hljs-keyword">return</span> <span class="hljs-built_in">float</span>(obj)
	    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>


	<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomJSONProvider</span>(<span class="hljs-title class_ inherited__">DefaultJSONProvider</span>):
	    <span class="hljs-string">""" 自定义编解码器, 用于flask """</span>

	    <span class="hljs-keyword">def</span> <span class="hljs-title function_">default</span>(<span class="hljs-params">self, obj</span>):
	        <span class="hljs-string">"""处理特殊对象"""</span>
	        codec_result = codec(obj)
	        <span class="hljs-keyword">return</span> codec_result <span class="hljs-keyword">if</span> codec_result <span class="hljs-keyword">else</span> <span class="hljs-built_in">super</span>(CustomJSONProvider, self).default(obj)


	<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomEncoder</span>(json.JSONEncoder):
	    <span class="hljs-string">""" 自定义编解码器，用于 json """</span>

	    <span class="hljs-keyword">def</span> <span class="hljs-title function_">default</span>(<span class="hljs-params">self, obj</span>):
	        codec_result = codec(obj)
	        <span class="hljs-keyword">return</span> codec_result <span class="hljs-keyword">if</span> codec_result <span class="hljs-keyword">else</span> <span class="hljs-built_in">super</span>(CustomEncoder, self).default(obj)
</code></pre>
<h2 data-id="heading-4">日志同时输出至控制台、文件</h2>
<p>代码位置：src/config/log_config.py</p>
<ul>
<li>实现方式：将 sys.stdout 和 sys.stderr 重定向至日志配置对象，日志对象实现 write 和 flush 函数，
在 write 函数中通过 logging 模块将日志写入文件，在此处对写入的文件进行格式化，添加线程信息。每 30s 检查一次文件大小，超过 100M 时将前 99M 数据清掉。</li>
<li>在 write 函数中也将数据输入一份至控制台</li>
<li>使用方式：log_config(name=import_name, log_filename=log_filename)</li>
</ul>
<pre><code class="hljs language-python" lang="python">	<span class="hljs-keyword">class</span> <span class="hljs-title class_">LogConfig</span>:

	    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">any</span>, log_type: <span class="hljs-built_in">str</span>, log_file: <span class="hljs-built_in">str</span></span>):
	        self.log_file = log_file
	        self.log_type = log_type
	        self.max_size = <span class="hljs-number">100</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>
	        self.trim_size = <span class="hljs-number">99</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>
	        self._last_check = time.time()
	        <span class="hljs-comment"># 为 LogWriter 创建专用的日志记录器</span>
	        self.logger = logging.getLogger(name)
	        self.logger.setLevel(logging.INFO)
	        <span class="hljs-comment"># 避免重复添加处理器</span>
	        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.logger.handlers:
	            handler = logging.FileHandler(log_file)
	            <span class="hljs-comment"># %(asctime)s: 时间戳</span>
	            <span class="hljs-comment"># %(message)s: 日志消息</span>
	            formatter = logging.Formatter(<span class="hljs-string">'%(asctime)s - %(message)s'</span>)
	            handler.setFormatter(formatter)
	            self.logger.addHandler(handler)

	    <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_and_trim_file</span>(<span class="hljs-params">self</span>):
	        <span class="hljs-string">"""检查文件大小并在必要时截断"""</span>
	        <span class="hljs-keyword">if</span> os.path.exists(self.log_file):
	            file_size = os.path.getsize(self.log_file)
	            <span class="hljs-keyword">if</span> file_size &gt; self.max_size:
	                <span class="hljs-keyword">try</span>:
	                    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(self.log_file, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:
	                        f.seek(self.trim_size)
	                        remaining_data = f.read()

	                    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(self.log_file, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:
	                        f.write(remaining_data)
	                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
	                    <span class="hljs-comment"># 如果截断失败，继续正常写入</span>
	                    <span class="hljs-keyword">pass</span>

	    <span class="hljs-keyword">def</span> <span class="hljs-title function_">write</span>(<span class="hljs-params">self, message</span>):
	        <span class="hljs-keyword">if</span> message.strip():  <span class="hljs-comment"># 忽略空行</span>
	            <span class="hljs-comment"># 减少文件大小检查频率</span>
	            current_time = time.time()
	            <span class="hljs-keyword">if</span> (current_time - self._last_check) &gt; <span class="hljs-number">30</span>:
	                <span class="hljs-comment"># 检查是否需要截断文件</span>
	                self.check_and_trim_file()
	                self._last_check = current_time

	            <span class="hljs-comment"># 创建日志记录器并手动记录</span>
	            thread_name = threading.current_thread().name
	            formatted_message = <span class="hljs-string">f"<span class="hljs-subst">{thread_name}</span> - <span class="hljs-subst">{message.strip()}</span>"</span>
	            self.logger.info(formatted_message)
	            <span class="hljs-comment"># 获取当前时间戳</span>
	            timestamp = time.time()
	            <span class="hljs-comment"># 转换为本地时间结构</span>
	            time_struct = time.localtime(timestamp)
	            <span class="hljs-comment"># 格式化时间</span>
	            formatted_time = time.strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>, time_struct)
	            <span class="hljs-keyword">if</span> <span class="hljs-string">'err'</span> <span class="hljs-keyword">in</span> self.log_type:
	                sys.__stderr__.write(<span class="hljs-string">f'<span class="hljs-subst">{formatted_time}</span> - <span class="hljs-subst">{formatted_message}</span>\n'</span>)
	            <span class="hljs-keyword">else</span>:
	                sys.__stdout__.write(<span class="hljs-string">f'<span class="hljs-subst">{formatted_time}</span> - <span class="hljs-subst">{formatted_message}</span>\n'</span>)

	    <span class="hljs-keyword">def</span> <span class="hljs-title function_">flush</span>(<span class="hljs-params">self</span>):
	        <span class="hljs-keyword">if</span> <span class="hljs-string">'err'</span> <span class="hljs-keyword">in</span> self.log_type:
	            sys.__stderr__.flush()
	        <span class="hljs-keyword">else</span>:
	            sys.__stdout__.flush()


	<span class="hljs-keyword">def</span> <span class="hljs-title function_">log_config</span>(<span class="hljs-params">name: <span class="hljs-built_in">any</span>, log_filename: <span class="hljs-built_in">str</span></span>):
	    <span class="hljs-string">"""配置日志"""</span>
	    <span class="hljs-keyword">try</span>:
	        <span class="hljs-comment"># 创建日志写入器=</span>
	        <span class="hljs-comment"># 重定向 print 输出</span>
	        sys.stdout = LogConfig(name=name, log_type=<span class="hljs-string">'out'</span>, log_file=log_filename)
	        sys.stderr = LogConfig(name=name, log_type=<span class="hljs-string">'err'</span>, log_file=log_filename)
	    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
	        traceback.print_exc()
	        <span class="hljs-comment"># 如果重定向失败，至少保证程序能正常运行</span>
	        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"日志重定向配置失败: <span class="hljs-subst">{e}</span>"</span>)

</code></pre>
<h2 data-id="heading-5">统一捕获异常信息</h2>
<p>代码位置：src/application.py</p>
<ul>
<li>使用方式：self.errorhandler(Exception)(self.handle_exception)，此处的 self 也是 Flask 对象</li>
<li>捕获异常后打印堆栈信息，之后返回我们定义好的响应失败对象，并且返回 http 状态码为：500</li>
</ul>
<pre><code class="hljs language-python" lang="python">	<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_exception</span>(<span class="hljs-params">self, ex: Exception</span>):
	    <span class="hljs-string">"""处理未捕获的异常"""</span>
	    traceback.print_exc()
	    <span class="hljs-comment"># 返回自定义错误响应</span>
	    <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">f'<span class="hljs-subst">{ex}</span>'</span>), <span class="hljs-number">500</span>
</code></pre>
<h2 data-id="heading-6">统一添加请求、响应日志</h2>
<p>代码位置：src/application.py
使用方法：</p>
<ul>
<li>添加请求前处理逻辑 self.before_request(self.log_request_info)</li>
<li>添加响应后处理逻辑 self.after_request(self.process_response)</li>
</ul>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">log_request_info</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""记录请求信息"""</span>
        self.request_duration_local.start_time = datetime.now()
        path_log = <span class="hljs-string">f'<span class="hljs-subst">{<span class="hljs-string">'='</span> * <span class="hljs-number">40</span>}</span> 请求路径: <span class="hljs-subst">{request.path}</span> <span class="hljs-subst">{<span class="hljs-string">'='</span> * <span class="hljs-number">40</span>}</span>'</span>
        headers_log = <span class="hljs-string">'\n'</span>.join([<span class="hljs-string">f'<span class="hljs-subst">{key}</span>: <span class="hljs-subst">{value}</span>'</span> <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> request.headers.items()])
        request_body = request.get_json() <span class="hljs-keyword">if</span> request.is_json <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
        <span class="hljs-built_in">print</span>(
            <span class="hljs-string">f'请求信息\n'</span>
            <span class="hljs-string">f'<span class="hljs-subst">{path_log}</span>\n'</span>
            <span class="hljs-string">f'请求方法: <span class="hljs-subst">{request.method}</span>\n'</span>
            <span class="hljs-string">f'<span class="hljs-subst">{headers_log}</span>\n'</span>
            <span class="hljs-string">f'请求参数/args: <span class="hljs-subst">{json.dumps(request.args, ensure_ascii=<span class="hljs-literal">False</span>)}</span>\n'</span>
            <span class="hljs-string">f'请求体/json: <span class="hljs-subst">{json.dumps(request_body, ensure_ascii=<span class="hljs-literal">False</span>)}</span>\n'</span>
            <span class="hljs-string">f'<span class="hljs-subst">{<span class="hljs-string">'='</span> * (<span class="hljs-built_in">len</span>(path_log) + <span class="hljs-number">3</span>)}</span>'</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_response</span>(<span class="hljs-params">self, response</span>):
        <span class="hljs-string">"""记录响应信息"""</span>
        duration = datetime.now() - self.request_duration_local.start_time
        path_log = <span class="hljs-string">f'<span class="hljs-subst">{<span class="hljs-string">'='</span> * <span class="hljs-number">40</span>}</span> 响应信息: <span class="hljs-subst">{request.path}</span> <span class="hljs-subst">{<span class="hljs-string">'='</span> * <span class="hljs-number">40</span>}</span>'</span>
        <span class="hljs-keyword">if</span> response.is_json:
            resp_result = json.dumps(response.get_json(), ensure_ascii=<span class="hljs-literal">False</span>)
        <span class="hljs-keyword">else</span>:
            resp_result = response.data
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(resp_result) &gt; <span class="hljs-number">1024</span>:
            resp_result = <span class="hljs-string">f'<span class="hljs-subst">{resp_result[<span class="hljs-number">0</span>:<span class="hljs-number">256</span>]}</span>...<span class="hljs-subst">{resp_result[-<span class="hljs-number">256</span>:]}</span>'</span>
        <span class="hljs-built_in">print</span>(
            <span class="hljs-string">f'响应信息\n'</span>
            <span class="hljs-string">f'<span class="hljs-subst">{path_log}</span>\n'</span>
            <span class="hljs-string">f'请求路径: <span class="hljs-subst">{request.path}</span> 请求方法: <span class="hljs-subst">{request.method}</span>\n'</span>
            <span class="hljs-string">f'响应状态码: <span class="hljs-subst">{response.status_code}</span> 耗时: <span class="hljs-subst">{duration.total_seconds():<span class="hljs-number">.3</span>f}</span>s\n'</span>
            <span class="hljs-string">f'响应结果: <span class="hljs-subst">{resp_result}</span>\n'</span>
            <span class="hljs-string">f'<span class="hljs-subst">{<span class="hljs-string">'='</span> * (<span class="hljs-built_in">len</span>(path_log) + <span class="hljs-number">3</span>)}</span>'</span>)
        <span class="hljs-keyword">return</span> response
</code></pre>
<h2 data-id="heading-7">测试 controller</h2>
<ul>
<li>代码位置：src/controller/test_controller.py</li>
<li>蓝图对外暴露接口的方式有很多，这里展示的是我最喜欢的方式。</li>
<li>POST 请求 curl
<ul>
<li>curl --location '<a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A5001%2Ftest%2Fpost" target="_blank" title="http://127.0.0.1:5001/test/post" ref="nofollow noopener noreferrer">http://127.0.0.1:5001/test/post</a>' --header 'Content-Type: application/json' --data '{"test": "test"}'</li>
<li>用于展示 POST 请求、测试对 ndarray 与 时间类型的 json 编码，以及输出日志</li>
</ul>
</li>
<li>GET 请求 curl
<ul>
<li>curl --location '<a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A5001%2Ftest%2Fcurrent_time%3Ftest%3Dtmp" target="_blank" title="http://127.0.0.1:5001/test/current_time?test=tmp" ref="nofollow noopener noreferrer">http://127.0.0.1:5001/test/current_time?test=tmp</a>'</li>
<li>用于展示 GET 请求与测试日志</li>
</ul>
</li>
<li>异常测试 curl
<ul>
<li>curl --location '<a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A5001%2Ftest%2Ferror%3Ftest%3Dtmp" target="_blank" title="http://127.0.0.1:5001/test/error?test=tmp" ref="nofollow noopener noreferrer">http://127.0.0.1:5001/test/error?test=tmp</a>'</li>
<li>用于测试异常的捕获</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-string">"""
创建蓝图
"""</span>
test_bp = Blueprint(<span class="hljs-string">"test"</span>, __name__, url_prefix=<span class="hljs-string">"/test"</span>)


<span class="hljs-meta">@test_bp.post(<span class="hljs-params"><span class="hljs-string">"post"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_post</span>():
    <span class="hljs-string">"""
    测试post请求
    """</span>
    request_body = request.json
    data = {
        <span class="hljs-string">"request_body"</span>: request_body,
        <span class="hljs-string">"request_time"</span>: datetime.now(),
        <span class="hljs-string">"ndarray"</span>: np.array([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]),
    }
    <span class="hljs-built_in">print</span>(data)
    <span class="hljs-keyword">return</span> Result.success(data)


<span class="hljs-meta">@test_bp.get(<span class="hljs-params"><span class="hljs-string">"current_time"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">current_time</span>():
    <span class="hljs-string">"""
    测试get请求
    """</span>
    args = request.args
    data = {
        <span class="hljs-string">"args"</span>: args,
        <span class="hljs-string">"request_time"</span>: datetime.now(),
    }
    <span class="hljs-built_in">print</span>(data)
    <span class="hljs-keyword">return</span> Result.success(data)


<span class="hljs-meta">@test_bp.get(<span class="hljs-params"><span class="hljs-string">"error"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_error</span>():
    <span class="hljs-string">"""
    测试异常
    """</span>
    <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">"测试异常"</span>)
</code></pre>
<h2 data-id="heading-8">配置 CROS 跨域并注册蓝图</h2>
<ul>
<li>对所有请求、所有类型和所有请求方式配置 CROS 跨域，或者自定义跨域方式</li>
<li>对每一个蓝图进行注册</li>
<li>备注：需要对所有蓝图单独配置 CROS</li>
</ul>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">set_cors_and_register_blueprint</span>(<span class="hljs-params">self, bp: Blueprint, cors_config: <span class="hljs-built_in">dict</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""
        配置跨域并注册蓝图
        """</span>
        <span class="hljs-keyword">if</span> cors_config <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            cors_config = {
                <span class="hljs-string">"origins"</span>: <span class="hljs-string">"*"</span>,
                <span class="hljs-string">"allow_headers"</span>: [<span class="hljs-string">"Content-Type"</span>],
                <span class="hljs-string">"methods"</span>: [<span class="hljs-string">"GET"</span>, <span class="hljs-string">"PUT"</span>, <span class="hljs-string">"POST"</span>, <span class="hljs-string">"DELETE"</span>, <span class="hljs-string">"OPTIONS"</span>, <span class="hljs-string">"PATCH"</span>]
            }

        <span class="hljs-comment"># 跨域配置</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f'跨域配置: <span class="hljs-subst">{bp.name}</span>-<span class="hljs-subst">{json.dumps(cors_config)}</span>'</span>)
        CORS(bp, **cors_config)
        <span class="hljs-comment"># 注册蓝图</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f'注册蓝图: <span class="hljs-subst">{bp.name}</span>'</span>)
        self.register_blueprint(bp)
</code></pre>
<h2 data-id="heading-9">继承后的 FlaskApp 对象</h2>
<ul>
<li>因为很多配置都需要操作 Flask 对象，索性继承 Flask 对象，把所有配置集成到一起</li>
<li>代码中有注释，不过多赘述</li>
<li>FlaskApp 对象的使用在示例代码最下放，也就是入口函数中使用</li>
<li>platform.system() == 'Darwin'：由于我使用 Mac 进行开发，所以此处设置为当系统为 Mac 时开启 Debug 模式</li>
<li>备注：每一个蓝图都需要单独进行注册，我的习惯是每个 controller 分配一个蓝图，每增加一个 controller 在这里加一行</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FlaskApp</span>(<span class="hljs-title class_ inherited__">Flask</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, import_name: <span class="hljs-built_in">str</span>, log_filename: <span class="hljs-built_in">str</span>, **kwargs</span>):
        <span class="hljs-built_in">super</span>().__init__(import_name, **kwargs)
        <span class="hljs-comment"># 日志配置</span>
        log_config(name=import_name, log_filename=log_filename)

        <span class="hljs-comment"># 注册蓝图</span>
        self.blueprints_to_register = []
        <span class="hljs-keyword">from</span> src.controller.test_controller <span class="hljs-keyword">import</span> test_bp
        self.add_blueprint(bp=test_bp)

        <span class="hljs-comment"># 添加请求前和响应后处理逻辑</span>
        self.before_request(self.log_request_info)
        self.after_request(self.process_response)

        <span class="hljs-comment"># 添加错误处理</span>
        self.errorhandler(Exception)(self.handle_exception)

        <span class="hljs-comment"># 请求耗时统计</span>
        self.request_duration_local = threading.local()

        <span class="hljs-comment"># 自定义编解码器</span>
        self.json = CustomJSONProvider(self)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">log_request_info</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""记录请求信息"""</span>
        self.request_duration_local.start_time = datetime.now()
        path_log = <span class="hljs-string">f'<span class="hljs-subst">{<span class="hljs-string">'='</span> * <span class="hljs-number">40</span>}</span> 请求路径: <span class="hljs-subst">{request.path}</span> <span class="hljs-subst">{<span class="hljs-string">'='</span> * <span class="hljs-number">40</span>}</span>'</span>
        headers_log = <span class="hljs-string">'\n'</span>.join([<span class="hljs-string">f'<span class="hljs-subst">{key}</span>: <span class="hljs-subst">{value}</span>'</span> <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> request.headers.items()])
        request_body = request.get_json() <span class="hljs-keyword">if</span> request.is_json <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
        <span class="hljs-built_in">print</span>(
            <span class="hljs-string">f'请求信息\n'</span>
            <span class="hljs-string">f'<span class="hljs-subst">{path_log}</span>\n'</span>
            <span class="hljs-string">f'请求方法: <span class="hljs-subst">{request.method}</span>\n'</span>
            <span class="hljs-string">f'<span class="hljs-subst">{headers_log}</span>\n'</span>
            <span class="hljs-string">f'请求参数/args: <span class="hljs-subst">{json.dumps(request.args, ensure_ascii=<span class="hljs-literal">False</span>)}</span>\n'</span>
            <span class="hljs-string">f'请求体/json: <span class="hljs-subst">{json.dumps(request_body, ensure_ascii=<span class="hljs-literal">False</span>)}</span>\n'</span>
            <span class="hljs-string">f'<span class="hljs-subst">{<span class="hljs-string">'='</span> * (<span class="hljs-built_in">len</span>(path_log) + <span class="hljs-number">3</span>)}</span>'</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_response</span>(<span class="hljs-params">self, response</span>):
        <span class="hljs-string">"""记录响应信息"""</span>
        duration = datetime.now() - self.request_duration_local.start_time
        path_log = <span class="hljs-string">f'<span class="hljs-subst">{<span class="hljs-string">'='</span> * <span class="hljs-number">40</span>}</span> 响应信息: <span class="hljs-subst">{request.path}</span> <span class="hljs-subst">{<span class="hljs-string">'='</span> * <span class="hljs-number">40</span>}</span>'</span>
        <span class="hljs-keyword">if</span> response.is_json:
            resp_result = json.dumps(response.get_json(), ensure_ascii=<span class="hljs-literal">False</span>)
        <span class="hljs-keyword">else</span>:
            resp_result = response.data
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(resp_result) &gt; <span class="hljs-number">1024</span>:
            resp_result = <span class="hljs-string">f'<span class="hljs-subst">{resp_result[<span class="hljs-number">0</span>:<span class="hljs-number">256</span>]}</span>...<span class="hljs-subst">{resp_result[-<span class="hljs-number">256</span>:]}</span>'</span>
        <span class="hljs-built_in">print</span>(
            <span class="hljs-string">f'响应信息\n'</span>
            <span class="hljs-string">f'<span class="hljs-subst">{path_log}</span>\n'</span>
            <span class="hljs-string">f'请求路径: <span class="hljs-subst">{request.path}</span> 请求方法: <span class="hljs-subst">{request.method}</span>\n'</span>
            <span class="hljs-string">f'响应状态码: <span class="hljs-subst">{response.status_code}</span> 耗时: <span class="hljs-subst">{duration.total_seconds():<span class="hljs-number">.3</span>f}</span>s\n'</span>
            <span class="hljs-string">f'响应结果: <span class="hljs-subst">{resp_result}</span>\n'</span>
            <span class="hljs-string">f'<span class="hljs-subst">{<span class="hljs-string">'='</span> * (<span class="hljs-built_in">len</span>(path_log) + <span class="hljs-number">3</span>)}</span>'</span>)
        <span class="hljs-keyword">return</span> response

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_exception</span>(<span class="hljs-params">self, ex: Exception</span>):
        <span class="hljs-string">"""处理未捕获的异常"""</span>
        traceback.print_exc()
        <span class="hljs-comment"># 返回自定义错误响应</span>
        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">f'<span class="hljs-subst">{ex}</span>'</span>), <span class="hljs-number">500</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_blueprint</span>(<span class="hljs-params">self, bp: Blueprint</span>):
        <span class="hljs-string">"""添加需要注册的蓝图"""</span>
        self.blueprints_to_register.append(bp)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">set_cors_and_register_blueprint</span>(<span class="hljs-params">self, bp: Blueprint, cors_config: <span class="hljs-built_in">dict</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""
        配置跨域并注册蓝图
        """</span>
        <span class="hljs-keyword">if</span> cors_config <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            cors_config = {
                <span class="hljs-string">"origins"</span>: <span class="hljs-string">"*"</span>,
                <span class="hljs-string">"allow_headers"</span>: [<span class="hljs-string">"Content-Type"</span>],
                <span class="hljs-string">"methods"</span>: [<span class="hljs-string">"GET"</span>, <span class="hljs-string">"PUT"</span>, <span class="hljs-string">"POST"</span>, <span class="hljs-string">"DELETE"</span>, <span class="hljs-string">"OPTIONS"</span>, <span class="hljs-string">"PATCH"</span>]
            }

        <span class="hljs-comment"># 跨域配置</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f'跨域配置: <span class="hljs-subst">{bp.name}</span>-<span class="hljs-subst">{json.dumps(cors_config)}</span>'</span>)
        CORS(bp, **cors_config)
        <span class="hljs-comment"># 注册蓝图</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f'注册蓝图: <span class="hljs-subst">{bp.name}</span>'</span>)
        self.register_blueprint(bp)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, host: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>, port: <span class="hljs-built_in">int</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
            debug: <span class="hljs-built_in">bool</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>, load_dotenv: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>, **options: t.<span class="hljs-type">Any</span></span>) -&gt; <span class="hljs-literal">None</span>:

        <span class="hljs-keyword">for</span> bp <span class="hljs-keyword">in</span> self.blueprints_to_register:
            self.set_cors_and_register_blueprint(bp)

        <span class="hljs-built_in">super</span>().run(host=host, port=port, debug=debug, load_dotenv=load_dotenv, **options)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    log_filename = <span class="hljs-string">'./python.log'</span>
    app = FlaskApp(__name__, log_filename)
    app.run(host=<span class="hljs-string">"0.0.0.0"</span>, port=<span class="hljs-number">5001</span>, debug=platform.system() == <span class="hljs-string">'Darwin'</span>)
</code></pre>
<h2 data-id="heading-10">开源仓库</h2>
<p>代码放在 Github 上，后续有能够作为通用能力的功能都会更新在仓库中</p>
<ul>
<li>仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthe-wind-is-rising-dev%2Fflask-server-template.git" target="_blank" title="https://github.com/the-wind-is-rising-dev/flask-server-template.git" ref="nofollow noopener noreferrer">github.com/the-wind-is…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 N 个商品中找出总价最小的 K 个方案]]></title>    <link>https://juejin.cn/post/7582849187866132531</link>    <guid>https://juejin.cn/post/7582849187866132531</guid>    <pubDate>2025-12-13T12:49:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582849187866132531" data-draft-id="7582875640308744242" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 N 个商品中找出总价最小的 K 个方案"/> <meta itemprop="keywords" content="后端,算法"/> <meta itemprop="datePublished" content="2025-12-13T12:49:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是你们的明哥"/> <meta itemprop="url" content="https://juejin.cn/user/3333374985122398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 N 个商品中找出总价最小的 K 个方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3333374985122398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是你们的明哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T12:49:09.000Z" title="Sat Dec 13 2025 12:49:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近遇到一道有趣的算法题，想和大家分享一下：</p>
<blockquote>
<p><strong>问题描述</strong>：给定 N 个商品（每个商品只能选一次），从中找出总价最小的 K 个不同购买方案。每个方案是商品的一个子集，目标是返回总价格最小的前 K 个组合。</p>
</blockquote>
<p>最直观的想法是暴力枚举——遍历所有 N! 种可能的子集，计算每种组合的总价，再排序取前 K 个。然而，当 N 较大时，这种方法在时间和空间上都不可行。</p>
<p>因此，我们需要一种更高效的策略。关键观察点在于：<strong>我们并不需要生成所有组合，而只需逐步“探索”出最小的 K 个方案</strong>。这启发我们使用<strong>优先队列（最小堆）+ 剪枝 + 去重</strong>的方法，按需扩展最有希望的候选方案。</p>
<p>具体思路如下：</p>
<ol>
<li>将每个单商品组合（即只买一个商品）作为初始方案加入最小堆；</li>
<li>每次从堆中取出当前总价最小的方案，将其加入结果集；</li>
<li>然后以该方案为基础，尝试加入尚未包含的商品，生成新的组合；</li>
<li>使用哈希集合记录已生成的组合（通过标准化表示去重），避免重复入队；</li>
<li>重复上述过程，直到收集到 K 个方案或队列为空。</li>
</ol>
<p>这种方法避免了全量枚举，显著提升了效率，尤其适用于 K 远小于 2N 的场景。</p>
<hr/>
<h5 data-id="heading-0">优化后的 Java 代码</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-comment">/**
 * 最小花费商品组合问题
 * 给定 N 个商品的价格，找出总花费最小的 K 个不同购买方案。
 * 每个方案是商品的一个子集，每个商品最多被选择一次。
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinCostCombinations</span> {

    <span class="hljs-comment">/**
     * 表示一个购买方案
     */</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparable</span>&lt;Solution&gt; {
        Set&lt;Integer&gt; indices;   <span class="hljs-comment">// 商品编号集合（从 1 开始）</span>
        <span class="hljs-type">long</span> totalPrice;        <span class="hljs-comment">// 方案总价格</span>

        Solution(Set&lt;Integer&gt; indices, <span class="hljs-type">long</span> totalPrice) {
            <span class="hljs-built_in">this</span>.indices = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(indices);
            <span class="hljs-built_in">this</span>.totalPrice = totalPrice;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compareTo</span><span class="hljs-params">(Solution other)</span> {
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.totalPrice != other.totalPrice) {
                <span class="hljs-keyword">return</span> Long.compare(<span class="hljs-built_in">this</span>.totalPrice, other.totalPrice);
            }
            <span class="hljs-comment">// 价格相同时，按集合的哈希值排序以保证比较一致性（虽非完美，但可接受）</span>
            <span class="hljs-keyword">return</span> Integer.compare(<span class="hljs-built_in">this</span>.indices.hashCode(), other.indices.hashCode());
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Scanner</span> <span class="hljs-variable">sc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">int</span> <span class="hljs-variable">N</span> <span class="hljs-operator">=</span> sc.nextInt();
            <span class="hljs-type">int</span> <span class="hljs-variable">K</span> <span class="hljs-operator">=</span> sc.nextInt();
            <span class="hljs-type">int</span>[] prices = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[N];
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; N; i++) {
                prices[i] = sc.nextInt();
            }

            List&lt;Solution&gt; results = findMinCostCombinations(prices, K);

            <span class="hljs-keyword">for</span> (Solution sol : results) {
                List&lt;Integer&gt; sorted = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(sol.indices);
                Collections.sort(sorted);
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; sorted.size(); i++) {
                    <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) System.out.print(<span class="hljs-string">","</span>);
                    System.out.print(sorted.get(i));
                }
                System.out.println(<span class="hljs-string">":"</span> + sol.totalPrice);
            }
        } <span class="hljs-keyword">finally</span> {
            sc.close();
        }
    }

    <span class="hljs-comment">/**
     * 使用优先队列（最小堆）按需生成最小的 K 个组合
     * 
     * <span class="hljs-doctag">@param</span> prices 商品价格数组
     * <span class="hljs-doctag">@param</span> k      需要返回的方案数量
     * <span class="hljs-doctag">@return</span>       按总价升序排列的前 K 个方案
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Solution&gt; <span class="hljs-title function_">findMinCostCombinations</span><span class="hljs-params">(<span class="hljs-type">int</span>[] prices, <span class="hljs-type">int</span> k)</span> {
        PriorityQueue&lt;Solution&gt; pq = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;();
        Set&lt;String&gt; visited = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
        List&lt;Solution&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">// 初始化：将每个单商品方案入队</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; prices.length; i++) {
            Set&lt;Integer&gt; set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
            set.add(i + <span class="hljs-number">1</span>); <span class="hljs-comment">// 编号从 1 开始</span>
            <span class="hljs-type">Solution</span> <span class="hljs-variable">sol</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Solution</span>(set, prices[i]);
            <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> getCanonicalKey(set);
            pq.offer(sol);
            visited.add(key);
        }

        <span class="hljs-keyword">while</span> (result.size() &lt; k &amp;&amp; !pq.isEmpty()) {
            <span class="hljs-type">Solution</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> pq.poll();
            result.add(current);

            <span class="hljs-comment">// 扩展：尝试加入每一个未包含的商品</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; prices.length; i++) {
                <span class="hljs-type">int</span> <span class="hljs-variable">idx</span> <span class="hljs-operator">=</span> i + <span class="hljs-number">1</span>;
                <span class="hljs-keyword">if</span> (!current.indices.contains(idx)) {
                    Set&lt;Integer&gt; newSet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(current.indices);
                    newSet.add(idx);
                    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> getCanonicalKey(newSet);
                    <span class="hljs-keyword">if</span> (!visited.contains(key)) {
                        <span class="hljs-type">long</span> <span class="hljs-variable">newPrice</span> <span class="hljs-operator">=</span> current.totalPrice + prices[i];
                        pq.offer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Solution</span>(newSet, newPrice));
                        visited.add(key);
                    }
                }
            }
        }

        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-comment">/**
     * 生成方案的规范字符串表示，用于去重
     * 例如 {3, 1, 2} → "1 2 3"
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getCanonicalKey</span><span class="hljs-params">(Set&lt;Integer&gt; indices)</span> {
        List&lt;Integer&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(indices);
        Collections.sort(list);
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; list.size(); i++) {
            <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) sb.append(<span class="hljs-string">' '</span>);
            sb.append(list.get(i));
        }
        <span class="hljs-keyword">return</span> sb.toString();
    }
}
</code></pre>
<h3 data-id="heading-1">补充说明</h3>
<ul>
<li><strong>时间复杂度</strong>：最坏情况下仍可能接近 O(K⋅Nlog(K⋅N))，但由于剪枝和去重，实际运行通常远优于暴力法。</li>
<li><strong>空间复杂度</strong>：主要由优先队列和去重集合决定，约为 O(K⋅N)。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第4讲:现代SQL高级特性——窗口函数与CTE]]></title>    <link>https://juejin.cn/post/7582862885107728434</link>    <guid>https://juejin.cn/post/7582862885107728434</guid>    <pubDate>2025-12-13T13:56:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582862885107728434" data-draft-id="7577991167201329162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第4讲:现代SQL高级特性——窗口函数与CTE"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-13T13:56:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="骑着bug的coder"/> <meta itemprop="url" content="https://juejin.cn/user/1922418579089566"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第4讲:现代SQL高级特性——窗口函数与CTE
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1922418579089566/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    骑着bug的coder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T13:56:25.000Z" title="Sat Dec 13 2025 13:56:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第4讲：现代SQL高级特性——窗口函数与CTE</h2>
<blockquote>
<p><strong>目标</strong>: 掌握MySQL 8.0+的核心特性：窗口函数和CTE，这是面试高频考点，也是解决复杂查询的利器。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、为什么需要窗口函数？</h3>
<h4 data-id="heading-2">传统方案的痛点</h4>
<p><strong>需求：</strong> 查询每个部门薪资前3名的员工</p>
<p><strong>传统方案（关联子查询）：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> e1.<span class="hljs-operator">*</span> 
<span class="hljs-keyword">FROM</span> employee e1
<span class="hljs-keyword">WHERE</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) 
    <span class="hljs-keyword">FROM</span> employee e2 
    <span class="hljs-keyword">WHERE</span> e2.department <span class="hljs-operator">=</span> e1.department 
    <span class="hljs-keyword">AND</span> e2.salary <span class="hljs-operator">&gt;=</span> e1.salary
) <span class="hljs-operator">&lt;=</span> <span class="hljs-number">3</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> department, salary <span class="hljs-keyword">DESC</span>;
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>性能差：这种方法每次查询 <code>e1</code> 时，都要针对 <code>e2</code> 进行子查询，这导致了复杂度为 O(N²)，效率较低，尤其是在数据量大时。</li>
<li>不灵活：如果业务需求发生变化，需要重写整个查询。</li>
<li>SQL 复杂且不容易理解。</li>
</ul>
<p>这个方案在一些较小的数据集上能正常工作，但在数据量增大时会变得非常慢，因为每个 <code>e1</code> 的查询都需要扫描整个表，这样会产生大量的重复计算。</p>
<hr/>
<h4 data-id="heading-3">窗口函数方案</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">WITH</span> ranked_employees <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> 
        <span class="hljs-operator">*</span>,
        <span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> department <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> rn
    <span class="hljs-keyword">FROM</span> employee
)
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> ranked_employees <span class="hljs-keyword">WHERE</span> rn <span class="hljs-operator">&lt;=</span> <span class="hljs-number">3</span>;
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li><strong>可读性</strong>：将复杂的查询分解为多个部分，使查询更加易于理解。</li>
<li><strong>复用性</strong>：如果查询中有多次使用某个中间结果集，可以将其提取到 CTE 中进行复用。</li>
</ul>
<hr/>
<h3 data-id="heading-4">二、窗口函数核心语法</h3>
<h4 data-id="heading-5">语法结构</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">&lt;</span>窗口函数<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">OVER</span> (
    <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-operator">&lt;</span>分组字段<span class="hljs-operator">&gt;</span>  <span class="hljs-comment">-- 类似GROUP BY，但不聚合行</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-operator">&lt;</span>排序字段<span class="hljs-operator">&gt;</span>      <span class="hljs-comment">-- 组内排序</span>
    <span class="hljs-keyword">ROWS</span><span class="hljs-operator">/</span><span class="hljs-keyword">RANGE</span> <span class="hljs-operator">&lt;</span>窗口范围<span class="hljs-operator">&gt;</span>    <span class="hljs-comment">-- 可选，指定计算范围</span>
)
</code></pre>
<p><strong>关键理解：</strong></p>
<ul>
<li><code>PARTITION BY</code>：分组，但不会减少行数</li>
<li><code>ORDER BY</code>：组内排序</li>
<li>窗口函数不能直接在WHERE中使用，需要子查询包裹</li>
</ul>
<hr/>
<h3 data-id="heading-6">三、排名函数（ROW_NUMBER/RANK/DENSE_RANK）</h3>
<h4 data-id="heading-7">三大排名函数对比</h4>





























<table><thead><tr><th>函数</th><th>并列处理</th><th>示例</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>ROW_NUMBER()</strong></td><td>连续行号</td><td>1,2,3,4</td><td>分页、TopN</td></tr><tr><td><strong>RANK()</strong></td><td>并列跳号</td><td>1,2,2,4</td><td>成绩排名(允许并列)</td></tr><tr><td><strong>DENSE_RANK()</strong></td><td>并列不跳号</td><td>1,2,2,3</td><td>密集排名</td></tr></tbody></table>
<h4 data-id="heading-8">实战案例</h4>
<p><strong>场景1：每个部门薪资排名</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    department,
    name,
    salary,
    <span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> department <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> row_num,
    <span class="hljs-built_in">RANK</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> department <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> rank_num,
    <span class="hljs-built_in">DENSE_RANK</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> department <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> dense_rank_num
<span class="hljs-keyword">FROM</span> employee;
</code></pre>
<p><strong>结果对比：</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cfa322cf455456bbaaf64129a51f2a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766238984&amp;x-signature=Y5F3N3Udd12qpMHqMWBZc5eGw78%3D" alt="image.png" loading="lazy"/></p>
<p><strong>解释</strong>：</p>
<ul>
<li>
<p><code>ROW_NUMBER()</code> 为每个部门的员工分配一个唯一的排名，没有并列。每个部门的排名是连续的，且不会有相同的排名。例如，在 <strong>技术部</strong>，<code>孙七</code> 排名第 2，而不是和 <code>王五</code> 共享第 2 排名。</p>
</li>
<li>
<p><code>RANK()</code> 会给相同薪资的员工分配相同的排名，并且跳过后续排名。例如，在 <strong>技术部</strong>，<code>孙七</code> 和 <code>王五</code> 的薪资相同，因此两者的排名为 1，接下来是排名为 3 的员工。</p>
</li>
<li>
<p><code>DENSE_RANK()</code> 也会为相同薪资的员工分配相同的排名，但不同的是，它不会跳过后续排名。例如，<code>孙七</code> 和 <code>王五</code> 的薪资相同，他们共享排名第 1，但下一名员工的排名是 2，而不是 3。</p>
</li>
</ul>
<hr/>
<p><strong>场景2：每个部门薪资前3名</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> 
        department, name, salary,
        <span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> department <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> rn
    <span class="hljs-keyword">FROM</span> employee
) t <span class="hljs-keyword">WHERE</span> rn <span class="hljs-operator">&lt;=</span> <span class="hljs-number">3</span>;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ec0a6294a7b4c49a48c904bc429edf8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766238984&amp;x-signature=0H%2BvSHEEcGzEjN1Tu%2FIXXRCwh0A%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-9">四、偏移函数（LAG/LEAD）</h3>
<h4 data-id="heading-10">环比、同比和趋势分析简介</h4>
<ul>
<li><strong>环比（Month-on-Month，MoM）</strong> ：环比指的是当前时间段与前一个时间段数据的比较，通常用于衡量某个指标在一个周期（如一个月）内的增长或下降。例如，比较本月与上月的销售额，评估业务的短期增长或变化趋势。</li>
<li><strong>同比（Year-on-Year，YoY）</strong> ：同比指的是当前时间段与去年同一时间段的数据对比。通常用于评估一年时间内业务的变化，帮助我们看到长期的增长或下降趋势。比如对比今年 1 月与去年 1 月的销售额，判断是否有增长。</li>
<li><strong>趋势分析（Trend Analysis）</strong> ：趋势分析旨在识别和分析一段时间内数据的变化方向。通过对比前后数据，可以帮助我们了解某个指标的长期走势，常用于预测未来的变化。例如，查看过去几个月的销售数据，分析是否有持续增长的趋势。</li>
<li><strong>预测（Forecasting）</strong> ：预测是通过分析当前数据的趋势，推测未来数据的可能值。使用 <code>LEAD</code> 函数可以帮助你在现有数据的基础上，预测未来的变化趋势，比如预测未来几个月的销售额。</li>
</ul>
<h4 data-id="heading-11">语法与作用</h4>




















<table><thead><tr><th>函数</th><th>作用</th><th>应用场景</th></tr></thead><tbody><tr><td><strong>LAG(字段, N)</strong></td><td>访问前N行数据</td><td>计算环比、同比</td></tr><tr><td><strong>LEAD(字段, N)</strong></td><td>访问后N行数据</td><td>预测、趋势分析</td></tr></tbody></table>
<h4 data-id="heading-12">实战案例</h4>
<p><strong>场景：计算每月销售额的环比增长</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 假设有月度销售表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> monthly_sales (
    <span class="hljs-keyword">month</span> <span class="hljs-type">DATE</span>,
    sales <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> monthly_sales <span class="hljs-keyword">VALUES</span>
(<span class="hljs-string">'2024-01-01'</span>, <span class="hljs-number">10000</span>),
(<span class="hljs-string">'2024-02-01'</span>, <span class="hljs-number">12000</span>),
(<span class="hljs-string">'2024-03-01'</span>, <span class="hljs-number">11000</span>),
(<span class="hljs-string">'2024-04-01'</span>, <span class="hljs-number">15000</span>);

<span class="hljs-comment">-- 计算环比增长</span>
<span class="hljs-keyword">SELECT</span> 
    <span class="hljs-keyword">month</span>,
    sales,
    <span class="hljs-built_in">LAG</span>(sales, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>) <span class="hljs-keyword">AS</span> last_month_sales,
    sales <span class="hljs-operator">-</span> <span class="hljs-built_in">LAG</span>(sales, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>) <span class="hljs-keyword">AS</span> month_on_month,
    ROUND((sales <span class="hljs-operator">-</span> <span class="hljs-built_in">LAG</span>(sales, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>)) <span class="hljs-operator">/</span> <span class="hljs-built_in">NULLIF</span>(<span class="hljs-built_in">LAG</span>(sales, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>), <span class="hljs-number">0</span>) <span class="hljs-operator">*</span> <span class="hljs-number">100</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> growth_rate
<span class="hljs-keyword">FROM</span> monthly_sales;
</code></pre>
<p><strong>结果：</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e74fa9cc31942bca3af2d58648a7851~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766238984&amp;x-signature=9DdSqK%2BHs0fnv%2FkplVOcmUBB1lM%3D" alt="image.png" loading="lazy"/></p>
<p><strong>解释：</strong></p>
<ul>
<li><code>month</code>：表示月份。</li>
<li><code>sales</code>：表示该月份的销售额。</li>
<li><code>last_month_sales</code>：使用 <code>LAG</code> 函数获取上个月的销售额。在 2024 年 1 月的行中，由于没有前一个月的记录，这个字段为 <code>NULL</code>。</li>
<li><code>month_on_month</code>：计算环比增长，即当前月销售额与上月销售额的差值。2024 年 1 月无前一个月数据，差值为 <code>NULL</code>。</li>
<li><code>growth_rate</code>：计算环比增长率，通过 <code>(sales - last_month_sales) / last_month_sales * 100</code> 得到的百分比值。2024 年 1 月由于没有前一个月数据，无法计算增长率。</li>
</ul>
<hr/>
<p><strong>场景：查看员工与前一名、后一名的薪资差距</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    name,
    salary,
    <span class="hljs-built_in">LAG</span>(name, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> higher_salary_person,
    <span class="hljs-built_in">LAG</span>(salary, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span>) <span class="hljs-operator">-</span> salary <span class="hljs-keyword">AS</span> gap_with_higher,
    <span class="hljs-built_in">LEAD</span>(name, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> lower_salary_person,
    salary <span class="hljs-operator">-</span> <span class="hljs-built_in">LEAD</span>(salary, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> gap_with_lower
<span class="hljs-keyword">FROM</span> employee;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa1ab8894a9044d19895bb839faf9b5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766238984&amp;x-signature=chkwrnUWmQVjVn8nAyW8cz1hjX0%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-13">解释：</h4>
<ul>
<li>
<p><code>higher_salary_person</code>：通过 <code>LAG</code> 函数查找当前员工薪资前一位的员工（即薪资较高的员工）。</p>
</li>
<li>
<p><code>gap_with_higher</code>：当前员工与前一位员工的薪资差距。即通过 <code>LAG</code> 函数找到前一位员工后，计算两者的薪资差。</p>
</li>
<li>
<p><code>ower_salary_person</code>：通过 <code>LEAD</code> 函数查找当前员工薪资后一位的员工（即薪资较低的员工）。</p>
</li>
<li>
<p><code>gap_with_lower</code>：当前员工与后一位员工的薪资差距。即通过 <code>LEAD</code> 函数找到后一位员工后，计算两者的薪资差。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-14">五、聚合窗口函数（SUM/AVG OVER）</h3>
<h4 data-id="heading-15">累计求和</h4>
<p><strong>场景：计算累计销售额</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    <span class="hljs-keyword">month</span>,
    sales,
    <span class="hljs-built_in">SUM</span>(sales) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>) <span class="hljs-keyword">AS</span> cumulative_sales
<span class="hljs-keyword">FROM</span> monthly_sales;
</code></pre>
<p><strong>结果：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36cbcec725f84a15b5b600906e484c67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766238984&amp;x-signature=MZQ9i1xGhsIWtXOA%2B7tSWz7u3qk%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-16">移动平均</h4>
<p><strong>场景：计算最近3个月的移动平均销售额</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    <span class="hljs-keyword">month</span>,
    sales,
    <span class="hljs-built_in">AVG</span>(sales) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span> 
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">2</span> PRECEDING <span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT</span> <span class="hljs-type">ROW</span>
    ) <span class="hljs-keyword">AS</span> moving_avg_3months
<span class="hljs-keyword">FROM</span> monthly_sales;
</code></pre>
<p><strong>窗口范围说明：</strong></p>
<ul>
<li><code>ROWS BETWEEN 2 PRECEDING AND CURRENT ROW</code>：当前行及前2行（共3行）</li>
<li><code>ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</code>：从第一行到当前行（累计）</li>
</ul>
<blockquote>
<p><strong>进阶提示：ROWS vs RANGE</strong></p>
<ul>
<li><strong>ROWS</strong>：按<strong>物理行</strong>偏移（如“前一行”）。</li>
<li><strong>RANGE</strong>：按<strong>数值</strong>偏移（如“日期减1天”或“金额减100”），处理重复值时行为不同。</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-17">六、CTE公共表表达式（WITH子句）</h3>
<h4 data-id="heading-18">CTE 的入门介绍</h4>
<p>在正式进入 SQL 示例前，确实需要对 CTE（公共表表达式） 做一个基础的介绍。CTE 是一种临时的结果集，可以在 SELECT、INSERT、UPDATE 或 DELETE 语句中使用。它帮助我们分解复杂的查询，使其更易读和可维护。</p>
<p>基本语法：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">WITH</span> cte_name <span class="hljs-keyword">AS</span> (
<span class="hljs-comment">-- CTE 查询内容</span>
<span class="hljs-keyword">SELECT</span> ...
)
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> cte_name;
</code></pre>
<h4 data-id="heading-19">为什么需要CTE？</h4>
<p><strong>传统子查询：嵌套复杂</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> dept_name, avg_salary
<span class="hljs-keyword">FROM</span> departments d
<span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span> dept_id, <span class="hljs-built_in">AVG</span>(salary) <span class="hljs-keyword">AS</span> avg_salary
    <span class="hljs-keyword">FROM</span> employees
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> dept_id
) e <span class="hljs-keyword">ON</span> d.id <span class="hljs-operator">=</span> e.dept_id
<span class="hljs-keyword">WHERE</span> e.avg_salary <span class="hljs-operator">&gt;</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(salary) <span class="hljs-keyword">FROM</span> employees
);
</code></pre>
<p><strong>CTE写法：逻辑清晰</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">WITH</span> dept_avg <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> dept_id, <span class="hljs-built_in">AVG</span>(salary) <span class="hljs-keyword">AS</span> avg_salary
    <span class="hljs-keyword">FROM</span> employees
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> dept_id
),
company_avg <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(salary) <span class="hljs-keyword">AS</span> avg_salary <span class="hljs-keyword">FROM</span> employees
)
<span class="hljs-keyword">SELECT</span> d.dept_name, da.avg_salary
<span class="hljs-keyword">FROM</span> departments d
<span class="hljs-keyword">JOIN</span> dept_avg da <span class="hljs-keyword">ON</span> d.id <span class="hljs-operator">=</span> da.dept_id
<span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span> company_avg ca
<span class="hljs-keyword">WHERE</span> da.avg_salary <span class="hljs-operator">&gt;</span> ca.avg_salary;
</code></pre>
<p><strong>CTE的优势：</strong></p>
<ul>
<li>✅ 命名清晰，可读性高</li>
<li>✅ 可以多次引用同一个CTE</li>
<li>✅ 逻辑分层，便于调试</li>
</ul>
<hr/>
<h3 data-id="heading-20">七、递归CTE（查询层级数据）</h3>
<h4 data-id="heading-21">语法结构</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> cte_name <span class="hljs-keyword">AS</span> (
    <span class="hljs-comment">-- 1. 锚点查询（初始数据）</span>
    <span class="hljs-keyword">SELECT</span> ... <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">WHERE</span> ...
    
    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
    
    <span class="hljs-comment">-- 2. 递归查询（关联上一层结果）</span>
    <span class="hljs-keyword">SELECT</span> ... <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">JOIN</span> cte_name <span class="hljs-keyword">ON</span> ...
)
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> cte_name;
</code></pre>
<h4 data-id="heading-22">实战案例</h4>
<p><strong>场景：商品分类树</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 商品分类表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> categories (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    parent_id <span class="hljs-type">INT</span>
);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> categories <span class="hljs-keyword">VALUES</span>
(<span class="hljs-number">1</span>, <span class="hljs-string">'电子产品'</span>, <span class="hljs-keyword">NULL</span>),
(<span class="hljs-number">2</span>, <span class="hljs-string">'手机'</span>, <span class="hljs-number">1</span>),
(<span class="hljs-number">3</span>, <span class="hljs-string">'电脑'</span>, <span class="hljs-number">1</span>),
(<span class="hljs-number">4</span>, <span class="hljs-string">'iPhone'</span>, <span class="hljs-number">2</span>),
(<span class="hljs-number">5</span>, <span class="hljs-string">'Android'</span>, <span class="hljs-number">2</span>),
(<span class="hljs-number">6</span>, <span class="hljs-string">'笔记本'</span>, <span class="hljs-number">3</span>),
(<span class="hljs-number">7</span>, <span class="hljs-string">'台式机'</span>, <span class="hljs-number">3</span>);

<span class="hljs-comment">-- 查询"手机"分类下的所有子分类</span>
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> category_tree <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> id, name, parent_id, <span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> level
    <span class="hljs-keyword">FROM</span> categories
    <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>
    
    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
    
    <span class="hljs-keyword">SELECT</span> c.id, c.name, c.parent_id, ct.level <span class="hljs-operator">+</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> categories c
    <span class="hljs-keyword">JOIN</span> category_tree ct <span class="hljs-keyword">ON</span> c.parent_id <span class="hljs-operator">=</span> ct.id
)
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> category_tree;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df7e8781c52d414b895aabbff55bc23b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766238984&amp;x-signature=C1k4avqKbYtHtll%2B07ML9LNACS0%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-23">递归 CTE 语法解析：</h4>
<h5 data-id="heading-24">1. <strong>初始化查询（锚点查询）</strong></h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> id, name, parent_id, <span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> level
<span class="hljs-keyword">FROM</span> categories
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>  <span class="hljs-comment">-- 初始查询，找到"手机"类别</span>
</code></pre>
<ul>
<li>这是递归查询的 <strong>锚点查询</strong>，它获取了 <strong>“手机”</strong> 类别（ID 为 2）的数据，并且设置了一个初始的 <strong><code>level</code></strong> 值为 1，表示“手机”分类的层级是第一层。</li>
<li><code>level</code> 字段用于标记分类的层级，以便在递归过程中可以区分不同层级的分类。</li>
</ul>
<h5 data-id="heading-25">2. <strong>递归查询（递归部分）</strong></h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
<span class="hljs-keyword">SELECT</span> c.id, c.name, c.parent_id, ct.level <span class="hljs-operator">+</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">JOIN</span> category_tree ct <span class="hljs-keyword">ON</span> c.parent_id <span class="hljs-operator">=</span> ct.id
</code></pre>
<ul>
<li>
<p><strong><code>UNION ALL</code></strong>：将锚点查询和递归查询的结果合并。这里使用 <strong><code>UNION ALL</code></strong> 而不是 <strong><code>UNION</code></strong>，因为我们不需要去重，只是简单地将每次递归的结果进行累积。</p>
</li>
<li>
<p><strong>递归部分</strong>：每次递归查询都会查找当前 <code>category_tree</code>（上一次递归结果）中的 <strong><code>id</code></strong>，并根据这些 <strong><code>id</code></strong> 找到它们的子分类（即通过 <strong><code>parent_id = ct.id</code></strong> 的条件来进行连接）。</p>
</li>
<li>
<p><code>ct.level + 1</code>：每次递归时，我们将当前分类的层级 <code>level</code> 加 1，以表示子分类比父分类多一层。</p>
</li>
</ul>
<h5 data-id="heading-26">3. <strong>最终查询结果</strong></h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> category_tree;
</code></pre>
<h4 data-id="heading-27">递归 CTE 的优势：</h4>
<ol>
<li><strong>适用于树形结构数据</strong>：递归 CTE 很适合查询和处理层级结构数据（如分类树、组织架构等）。</li>
<li><strong>结构清晰</strong>：通过 <code>WITH RECURSIVE</code> 定义递归查询，能够清晰地分隔锚点查询和递归查询部分，使得查询逻辑更加易懂。</li>
<li><strong>可扩展性强</strong>：如果层级结构很深，递归查询会继续执行直到所有子分类被查询完毕，无需手动指定层级的深度。</li>
</ol>
<hr/>
<h3 data-id="heading-28">八、避坑指南</h3>
<h4 data-id="heading-29">坑1：窗口函数不能直接在WHERE中使用</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 错误</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>, <span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> department <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> rn
<span class="hljs-keyword">FROM</span> employee
<span class="hljs-keyword">WHERE</span> rn <span class="hljs-operator">&lt;=</span> <span class="hljs-number">3</span>;  <span class="hljs-comment">-- 报错！</span>

<span class="hljs-comment">-- ✅ 正确</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>, <span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> department <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> rn
    <span class="hljs-keyword">FROM</span> employee
) t <span class="hljs-keyword">WHERE</span> rn <span class="hljs-operator">&lt;=</span> <span class="hljs-number">3</span>;
</code></pre>
<hr/>
<h4 data-id="heading-30">坑2：递归CTE必须有终止条件</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 错误：死循环</span>
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> bad_cte <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> n
    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
    <span class="hljs-keyword">SELECT</span> n <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> bad_cte  <span class="hljs-comment">-- 永远不会停止</span>
)
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> bad_cte;

<span class="hljs-comment">-- ✅ 正确：加终止条件</span>
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> good_cte <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> n
    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
    <span class="hljs-keyword">SELECT</span> n <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> good_cte <span class="hljs-keyword">WHERE</span> n <span class="hljs-operator">&lt;</span> <span class="hljs-number">10</span>  <span class="hljs-comment">-- 终止条件</span>
)
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> good_cte;
</code></pre>
<hr/>
<h4 data-id="heading-31">坑3：PARTITION BY不同于GROUP BY</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- GROUP BY：聚合行，减少行数</span>
<span class="hljs-keyword">SELECT</span> department, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> employee <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department;
<span class="hljs-comment">-- 结果：3行（3个部门）</span>

<span class="hljs-comment">-- PARTITION BY：分组计算，不减少行数</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> department) <span class="hljs-keyword">FROM</span> employee;
<span class="hljs-comment">-- 结果：10行（所有员工，每行显示所在部门的总人数）</span>
</code></pre>
<hr/>
<h3 data-id="heading-32">九、本讲作业</h3>
<h4 data-id="heading-33">基础练习</h4>
<ol>
<li>查询每个部门薪资排名前3的员工（用ROW_NUMBER）</li>
<li>计算每个员工的薪资与部门平均薪资的差距（用AVG OVER）</li>
<li>查询每个员工的上一名和下一名（用LAG/LEAD）</li>
</ol>
<h4 data-id="heading-34">进阶挑战</h4>
<ol start="4">
<li>用CTE改写一个复杂的嵌套子查询（从你的项目中找）</li>
<li>用递归CTE查询某员工的所有下属（包括下属的下属）</li>
<li>用窗口函数实现分页（替代LIMIT OFFSET）</li>
</ol>
<h4 data-id="heading-35">性能对比</h4>
<ol start="7">
<li>对比"每部门TOP3"的两种实现（窗口函数 vs 关联子查询），测试性能差异</li>
</ol>
<hr/>
<h3 data-id="heading-36">十、下一讲预告</h3>
<p>今天学习了现代SQL的强大特性，下一讲回到MySQL的核心原理。</p>
<p><strong>第5讲：事务——数据一致性的保护伞</strong></p>
<ul>
<li>什么是事务？ACID特性是啥？</li>
<li>转账的钱怎么保证不丢不重？</li>
<li>两个人同时改同一条数据会怎样？</li>
<li><strong>隔离级别</strong>：脏读、不可重复读、幻读</li>
<li>undo log和redo log的作用</li>
</ul>
<p>掌握了窗口函数和CTE，你的SQL查询能力已经超越了80%的开发者。下一讲我们深入MySQL内核，理解事务和并发控制的原理！</p>
<p><strong>准备工作：</strong></p>
<ul>
<li>完成今天的作业，熟练掌握窗口函数</li>
<li>思考：两个人同时给同一个账户转账1000元，最后余额应该是多少？</li>
</ul>
<hr/>
<p><strong>下一讲见！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[A*（A-Star）算法详解：智能路径规划的核心技术]]></title>    <link>https://juejin.cn/post/7582905804047712283</link>    <guid>https://juejin.cn/post/7582905804047712283</guid>    <pubDate>2025-12-13T13:59:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582905804047712283" data-draft-id="7582862885107695666" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="A*（A-Star）算法详解：智能路径规划的核心技术"/> <meta itemprop="keywords" content="后端,算法"/> <meta itemprop="datePublished" content="2025-12-13T13:59:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是你们的明哥"/> <meta itemprop="url" content="https://juejin.cn/user/3333374985122398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            A*（A-Star）算法详解：智能路径规划的核心技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3333374985122398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是你们的明哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T13:59:29.000Z" title="Sat Dec 13 2025 13:59:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在人工智能、游戏开发、机器人导航以及地图应用等领域，寻找两点之间的最优路径是一个基础而关键的问题。A*（读作“A-Star”）算法因其高效性与准确性，成为解决此类问题的首选方法之一。自1968年由Peter Hart、Nils Nilsson 和 Bertram Raphael 提出以来，A* 算法凭借其启发式搜索机制，在保证找到最短路径的同时显著减少了搜索空间，成为路径规划领域的经典算法。</p>
<hr/>
<h2 data-id="heading-1">一、A* 算法的基本思想</h2>
<p>A* 是一种<strong>启发式图搜索算法</strong>，结合了<strong>Dijkstra 算法</strong>的完备性和<strong>贪心最佳优先搜索</strong>的效率。其核心在于通过一个评估函数对每个待探索节点进行打分，从而决定下一步的搜索方向。</p>
<h3 data-id="heading-2">1. 评估函数 f(n)</h3>
<p>对于任意节点 n，A* 使用如下公式计算其优先级：</p>
<p>f(n)=g(n)+h(n)</p>
<ul>
<li><strong>g(n)</strong> ：从起点到当前节点 n 的实际代价（已知）。</li>
<li><strong>h(n)</strong> ：从当前节点 n 到目标节点的<strong>启发式估计代价</strong>（未知，需设计）。</li>
<li><strong>f(n)</strong> ：从起点经过 n 到达终点的总估计代价。</li>
</ul>
<p>A* 算法总是优先扩展具有最小 f(n) 值的节点。</p>
<hr/>
<h2 data-id="heading-3">二、算法流程</h2>
<p>A* 算法通常使用两个集合来管理节点：</p>
<ul>
<li><strong>Open Set（开放列表）</strong> ：待探索的节点集合。</li>
<li><strong>Closed Set（关闭列表）</strong> ：已探索过的节点集合。</li>
</ul>
<h3 data-id="heading-4">具体步骤如下：</h3>
<ol>
<li>
<p>将起点加入 Open Set，并设置 g(start)=0，f(start)=h(start)。</p>
</li>
<li>
<p>当 Open Set 非空时：</p>
<ul>
<li>
<p>从中取出 f(n) 最小的节点 current。</p>
</li>
<li>
<p>若 current 是目标节点，则重建路径并返回。</p>
</li>
<li>
<p>否则，将 current 移入 Closed Set。</p>
</li>
<li>
<p>遍历 current 的所有邻居节点 neighbor：</p>
<ul>
<li>如果 neighbor 在 Closed Set 中，跳过。</li>
<li>计算从起点经 current 到 neighbor 的新代价 tentative_g=g(current)+cost(current,neighbor)。</li>
<li>如果 neighbor 不在 Open Set 中，或 tentative_g&lt;g(neighbor)，则更新 g(neighbor)、f(neighbor)，并记录前驱节点。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>若 Open Set 为空仍未找到目标，则路径不存在。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-5">三、启发函数 h(n) 的设计</h2>
<p>启发函数的质量直接影响 A* 的效率和正确性。</p>
<h3 data-id="heading-6">常见启发函数（以二维网格为例）：</h3>
<ul>
<li>
<p><strong>曼哈顿距离（Manhattan Distance）</strong><br/>
适用于只能上下左右移动的情况：</p>
<p>h(n)=∣xn​−xgoal​∣+∣yn​−ygoal​∣</p>
</li>
<li>
<p><strong>欧几里得距离（Euclidean Distance）</strong><br/>
适用于允许任意方向移动的情况：</p>
<p>h(n)=(xn​−xgoal​)2+(yn​−ygoal​)2​</p>
</li>
<li>
<p><strong>切比雪夫距离（Chebyshev Distance）</strong><br/>
适用于可沿8个方向移动（包括对角线）：</p>
<p>h(n)=max(∣xn​−xgoal​∣,∣yn​−ygoal​∣)</p>
</li>
</ul>
<blockquote>
<p><strong>关键性质：可采纳性（Admissibility）</strong><br/>
若 h(n) 始终<strong>不大于</strong>从 n 到目标的真实代价，则 A* 保证能找到<strong>最优解</strong>。<br/>
<strong>一致性（Consistency，或单调性）</strong> 能进一步保证算法效率，避免重复扩展节点。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">四、算法具体实现</h2>
<h3 data-id="heading-8">java实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-comment">// 表示地图中的一个点（节点）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparable</span>&lt;Node&gt; {
    <span class="hljs-type">int</span> x, y;
    <span class="hljs-type">double</span> g; <span class="hljs-comment">// 从起点到当前节点的实际代价</span>
    <span class="hljs-type">double</span> h; <span class="hljs-comment">// 启发式估计：当前节点到终点的预估代价</span>
    <span class="hljs-type">double</span> f; <span class="hljs-comment">// f = g + h</span>
    Node parent; <span class="hljs-comment">// 用于回溯路径</span>

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Node</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> {
        <span class="hljs-built_in">this</span>.x = x;
        <span class="hljs-built_in">this</span>.y = y;
        <span class="hljs-built_in">this</span>.g = Double.MAX_VALUE;
        <span class="hljs-built_in">this</span>.h = <span class="hljs-number">0</span>;
        <span class="hljs-built_in">this</span>.f = Double.MAX_VALUE;
        <span class="hljs-built_in">this</span>.parent = <span class="hljs-literal">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> == o) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (o == <span class="hljs-literal">null</span> || getClass() != o.getClass()) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> (Node) o;
        <span class="hljs-keyword">return</span> x == node.x &amp;&amp; y == node.y;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Objects.hash(x, y);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compareTo</span><span class="hljs-params">(Node other)</span> {
        <span class="hljs-keyword">return</span> Double.compare(<span class="hljs-built_in">this</span>.f, other.f);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AStar</span> {

    <span class="hljs-comment">// 四个方向：上、下、左、右（可扩展为8方向）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>[][] DIRS = {{<span class="hljs-number">0</span>, <span class="hljs-number">1</span>}, {<span class="hljs-number">1</span>, <span class="hljs-number">0</span>}, {<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>}, {-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>}};

    <span class="hljs-comment">/**
     * 在 grid 中寻找从 start 到 end 的最短路径
     * <span class="hljs-doctag">@param</span> grid 二维地图，true 表示可通过，false 表示障碍
     * <span class="hljs-doctag">@param</span> startX 起点 x 坐标
     * <span class="hljs-doctag">@param</span> startY 起点 y 坐标
     * <span class="hljs-doctag">@param</span> endX 终点 x 坐标
     * <span class="hljs-doctag">@param</span> endY 终点 y 坐标
     * <span class="hljs-doctag">@return</span> 路径列表（从起点到终点），若无路径则返回 null
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Node&gt; <span class="hljs-title function_">findPath</span><span class="hljs-params">(<span class="hljs-type">boolean</span>[][] grid, <span class="hljs-type">int</span> startX, <span class="hljs-type">int</span> startY, <span class="hljs-type">int</span> endX, <span class="hljs-type">int</span> endY)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> grid.length;
        <span class="hljs-type">int</span> <span class="hljs-variable">cols</span> <span class="hljs-operator">=</span> grid[<span class="hljs-number">0</span>].length;

        <span class="hljs-keyword">if</span> (!isValid(grid, startX, startY) || !isValid(grid, endX, endY)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 起点或终点无效</span>
        }

        <span class="hljs-type">Node</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(startX, startY);
        <span class="hljs-type">Node</span> <span class="hljs-variable">goal</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(endX, endY);

        <span class="hljs-comment">// 开放列表：优先队列（按 f 值排序）</span>
        PriorityQueue&lt;Node&gt; openSet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;();
        <span class="hljs-comment">// 关闭列表：已访问节点集合</span>
        Set&lt;Node&gt; closedSet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();

        start.g = <span class="hljs-number">0</span>;
        start.h = heuristic(start, goal);
        start.f = start.g + start.h;
        openSet.add(start);

        <span class="hljs-keyword">while</span> (!openSet.isEmpty()) {
            <span class="hljs-type">Node</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> openSet.poll();

            <span class="hljs-keyword">if</span> (current.equals(goal)) {
                <span class="hljs-keyword">return</span> reconstructPath(current);
            }

            closedSet.add(current);

            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span>[] dir : DIRS) {
                <span class="hljs-type">int</span> <span class="hljs-variable">nx</span> <span class="hljs-operator">=</span> current.x + dir[<span class="hljs-number">0</span>];
                <span class="hljs-type">int</span> <span class="hljs-variable">ny</span> <span class="hljs-operator">=</span> current.y + dir[<span class="hljs-number">1</span>];

                <span class="hljs-keyword">if</span> (!isValid(grid, nx, ny)) <span class="hljs-keyword">continue</span>;

                <span class="hljs-type">Node</span> <span class="hljs-variable">neighbor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(nx, ny);

                <span class="hljs-keyword">if</span> (closedSet.contains(neighbor)) <span class="hljs-keyword">continue</span>;

                <span class="hljs-comment">// 假设每步移动代价为 1（可改为欧氏距离等）</span>
                <span class="hljs-type">double</span> <span class="hljs-variable">tentativeG</span> <span class="hljs-operator">=</span> current.g + <span class="hljs-number">1</span>;

                <span class="hljs-comment">// 如果这是到达 neighbor 的更优路径</span>
                <span class="hljs-keyword">if</span> (tentativeG &lt; neighbor.g) {
                    <span class="hljs-comment">// 更新 neighbor 信息</span>
                    neighbor.g = tentativeG;
                    neighbor.h = heuristic(neighbor, goal);
                    neighbor.f = neighbor.g + neighbor.h;
                    neighbor.parent = current;

                    <span class="hljs-comment">// 避免重复加入 openSet（简化实现：允许重复但靠 f 值排序）</span>
                    openSet.remove(neighbor); <span class="hljs-comment">// 可选：提高效率但增加开销</span>
                    openSet.add(neighbor);
                }
            }
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 未找到路径</span>
    }

    <span class="hljs-comment">// 曼哈顿距离启发函数（适用于4方向移动）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">heuristic</span><span class="hljs-params">(Node a, Node b)</span> {
        <span class="hljs-keyword">return</span> Math.abs(a.x - b.x) + Math.abs(a.y - b.y);
    }

    <span class="hljs-comment">// 检查坐标是否在地图内且可通过</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValid</span><span class="hljs-params">(<span class="hljs-type">boolean</span>[][] grid, <span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> grid.length;
        <span class="hljs-type">int</span> <span class="hljs-variable">cols</span> <span class="hljs-operator">=</span> grid[<span class="hljs-number">0</span>].length;
        <span class="hljs-keyword">return</span> x &gt;= <span class="hljs-number">0</span> &amp;&amp; x &lt; rows &amp;&amp; y &gt;= <span class="hljs-number">0</span> &amp;&amp; y &lt; cols &amp;&amp; grid[x][y];
    }

    <span class="hljs-comment">// 从终点回溯到起点，构建路径</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Node&gt; <span class="hljs-title function_">reconstructPath</span><span class="hljs-params">(Node node)</span> {
        List&lt;Node&gt; path = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">while</span> (node != <span class="hljs-literal">null</span>) {
            path.add(node);
            node = node.parent;
        }
        Collections.reverse(path);
        <span class="hljs-keyword">return</span> path;
    }

    <span class="hljs-comment">// 示例用法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">boolean</span>[][] grid = {
            {<span class="hljs-literal">true</span>,  <span class="hljs-literal">true</span>,  <span class="hljs-literal">true</span>,  <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>},
            {<span class="hljs-literal">true</span>,  <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>,  <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>},
            {<span class="hljs-literal">true</span>,  <span class="hljs-literal">true</span>,  <span class="hljs-literal">true</span>,  <span class="hljs-literal">true</span>,  <span class="hljs-literal">true</span>},
            {<span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>,  <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>},
            {<span class="hljs-literal">true</span>,  <span class="hljs-literal">true</span>,  <span class="hljs-literal">true</span>,  <span class="hljs-literal">true</span>,  <span class="hljs-literal">true</span>}
        };

        List&lt;Node&gt; path = findPath(grid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>);
        <span class="hljs-keyword">if</span> (path != <span class="hljs-literal">null</span>) {
            System.out.println(<span class="hljs-string">"找到路径，长度: "</span> + path.size());
            <span class="hljs-keyword">for</span> (Node n : path) {
                System.out.println(<span class="hljs-string">"("</span> + n.x + <span class="hljs-string">", "</span> + n.y + <span class="hljs-string">")"</span>);
            }
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"未找到路径"</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-9">1. <strong>时间复杂度</strong></h4>
<ul>
<li>
<p>最坏情况下，A* 会遍历所有可达节点，其行为退化为 Dijkstra 算法。</p>
</li>
<li>
<p>设地图中有 N 个可通过的格子（即节点数），每个节点最多被插入优先队列一次（理想情况）。</p>
</li>
<li>
<p>每次从 <code>PriorityQueue</code> 中取出最小元素的时间为 O(logN)，每个节点最多处理一次，每个节点有常数个邻居（如4或8个）。</p>
</li>
<li>
<p>因此，<strong>时间复杂度为</strong>：O(NlogN)</p>
<p>其中 N 是地图中可通过的格子总数。</p>
</li>
</ul>
<blockquote>
<p>注意：如果启发函数 h(n) 设计得当（如接近真实代价），实际搜索节点数会远小于 N，性能显著优于 Dijkstra。</p>
</blockquote>
<hr/>
<h4 data-id="heading-10">2. <strong>空间复杂度</strong></h4>
<ul>
<li>
<p>需要存储：</p>
<ul>
<li><code>openSet</code>：最多包含 O(N) 个节点。</li>
<li><code>closedSet</code>：最多包含 O(N) 个节点。</li>
<li>每个节点存储坐标、g/h/f 值和父指针，空间为常数。</li>
</ul>
</li>
<li>
<p>因此，<strong>空间复杂度为</strong>： O(N)</p>
</li>
</ul>
<h4 data-id="heading-11">优化建议（进阶）</h4>
<ol>
<li><strong>避免重复节点</strong>：当前实现中 <code>openSet</code> 可能包含同一坐标的多个 <code>Node</code> 对象（因 <code>new Node</code> 产生新对象）。可通过维护一个 <code>Map&lt;Point, Node&gt;</code> 来复用节点，提升效率。</li>
<li><strong>使用更高效的启发函数</strong>：如对角线移动时改用切比雪夫距离。</li>
<li><strong>支持不同移动代价</strong>：将 <code>tentativeG = current.g + cost</code> 中的 <code>cost</code> 改为地形权重。</li>
<li><strong>使用 JPS（Jump Point Search）</strong> ：在大型空旷地图中可提速数十倍。</li>
</ol>
<h2 data-id="heading-12">五、A* 的优缺点</h2>
<h3 data-id="heading-13">优点：</h3>
<ul>
<li><strong>最优性</strong>：在可采纳启发函数下，总能找到最短路径。</li>
<li><strong>完备性</strong>：只要存在解，A* 就能找到。</li>
<li><strong>灵活性</strong>：通过调整 h(n)，可在速度与精度之间权衡。</li>
</ul>
<h3 data-id="heading-14">缺点：</h3>
<ul>
<li><strong>内存消耗大</strong>：需存储大量节点信息，尤其在大型地图中。</li>
<li><strong>最坏情况复杂度高</strong>：若启发函数效果差，退化为 Dijkstra 算法（时间复杂度 O(bd)，其中 b 为分支因子，d 为深度）。</li>
</ul>
<hr/>
<h2 data-id="heading-15">六、实际应用与优化</h2>
<h3 data-id="heading-16">应用场景：</h3>
<ul>
<li>游戏 AI 中的 NPC 寻路（如《魔兽世界》《星际争霸》）</li>
<li>自动驾驶车辆的局部路径规划</li>
<li>GPS 导航系统（如 Google Maps 的早期版本）</li>
<li>机器人避障与任务调度</li>
</ul>
<h3 data-id="heading-17">常见优化策略：</h3>
<ul>
<li><strong>Jump Point Search (JPS)</strong> ：在均匀网格中大幅减少需探索的节点数。</li>
<li><strong>双向 A</strong>*：同时从起点和终点搜索，加速收敛。</li>
<li><strong>内存受限变体</strong>：如 IDA*（Iterative Deepening A*），适用于内存受限环境。</li>
</ul>
<hr/>
<h2 data-id="heading-18">结语</h2>
<p>A* 算法以其优雅的数学结构和强大的实用性，成为路径规划领域不可替代的基石。理解其原理不仅有助于解决工程问题，更能启发我们思考如何在“已知”与“预测”之间取得平衡——这正是智能决策的核心所在。随着硬件性能提升与算法融合（如与机器学习结合），A* 及其衍生方法仍将在未来智能系统中发挥重要作用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JWT 认证方案深度对比：单 Token 扩展刷新 vs 双 Token 验证]]></title>    <link>https://juejin.cn/post/7582857981894869033</link>    <guid>https://juejin.cn/post/7582857981894869033</guid>    <pubDate>2025-12-13T14:44:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582857981894869033" data-draft-id="7582904081863131177" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JWT 认证方案深度对比：单 Token 扩展刷新 vs 双 Token 验证"/> <meta itemprop="keywords" content="后端,架构,设计模式"/> <meta itemprop="datePublished" content="2025-12-13T14:44:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喷火龙8号"/> <meta itemprop="url" content="https://juejin.cn/user/1900436995711678"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JWT 认证方案深度对比：单 Token 扩展刷新 vs 双 Token 验证
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1900436995711678/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喷火龙8号
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T14:44:49.000Z" title="Sat Dec 13 2025 14:44:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JWT 认证方案深度对比：单 Token 扩展刷新 vs 双 Token 验证</h2>
<blockquote>
<p>本文源于一次代码 Review 过程中的深度讨论，从一个"疑似 Bug"出发，逐步深入探讨了两种 JWT 认证方案的设计理念和实现差异。</p>
</blockquote>
<h3 data-id="heading-1">背景</h3>
<p>在 Review <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhertz-contrib%2Fjwt" target="_blank" title="https://github.com/hertz-contrib/jwt" ref="nofollow noopener noreferrer">hertz-contrib/jwt</a> 项目时，我发现了一个有趣的问题：在 <code>RefreshToken</code> 方法中，每次刷新时都会重置 <code>orig_iat</code> 为当前时间，这导致 <code>MaxRefresh</code> 窗口不断重置。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 原始代码（有问题）</span>
newClaims[<span class="hljs-string">"exp"</span>] = expire.Unix()
newClaims[<span class="hljs-string">"orig_iat"</span>] = mw.TimeFunc().Unix()  <span class="hljs-comment">// 每次刷新都重置</span>
</code></pre>
<p>根据代码注释的设计意图，<code>MaxRefresh</code> 应该限制 Token 的最大有效期：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// This field allows clients to refresh their token until MaxRefresh has passed.</span>
<span class="hljs-comment">// Note that clients can refresh their token in the last moment of MaxRefresh.</span>
<span class="hljs-comment">// This means that the maximum validity timespan for a token is TokenTime + MaxRefresh.</span>
MaxRefresh time.Duration
</code></pre>
<p>修复后的代码应该保留原始的 <code>orig_iat</code>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 修复后</span>
newClaims[<span class="hljs-string">"exp"</span>] = expire.Unix()
<span class="hljs-keyword">if</span> origIat, exists := claims[<span class="hljs-string">"orig_iat"</span>]; exists {
    newClaims[<span class="hljs-string">"orig_iat"</span>] = origIat  <span class="hljs-comment">// 保留原始值</span>
} <span class="hljs-keyword">else</span> {
    newClaims[<span class="hljs-string">"orig_iat"</span>] = mw.TimeFunc().Unix()
}
</code></pre>
<p>这个问题引发了我对单 Token 扩展刷新设计和双 Token 设计的深入思考。</p>
<h3 data-id="heading-2">两种方案概述</h3>
<h4 data-id="heading-3">方案一：单 Token 扩展刷新</h4>
<p>这是 hertz-contrib/jwt 采用的方案，特点是：</p>
<ul>
<li>只有一个 Token</li>
<li>Token 有短期有效期（如 15 分钟或 1 小时）</li>
<li>在 <code>MaxRefresh</code> 窗口内可以刷新 Token</li>
<li>刷新时使用同一个 Token 作为凭证</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 配置示例</span>
Timeout: <span class="hljs-number">15</span> * time.Minute,      <span class="hljs-comment">// Token 有效期：15分钟</span>
MaxRefresh: <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * time.Hour, <span class="hljs-comment">// 刷新窗口：7天</span>
</code></pre>
<h4 data-id="heading-4">方案二：双 Token 验证</h4>
<p>OAuth 2.0 推荐的标准方案，特点是：</p>
<ul>
<li>Access Token：短期有效（如 15 分钟），用于业务请求</li>
<li>Refresh Token：长期有效（如 7 天），仅用于刷新 Access Token</li>
<li>两个 Token 职责分离</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 配置示例</span>
AccessTokenTimeout: <span class="hljs-number">15</span> * time.Minute,
RefreshTokenTimeout: <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * time.Hour,
</code></pre>
<h3 data-id="heading-5">核心功能对比</h3>
<p>经过深入讨论，我们发现<strong>两种方案都能实现相同的核心功能</strong>：</p>



































<table><thead><tr><th>功能</th><th>单 Token</th><th>双 Token</th></tr></thead><tbody><tr><td>业务请求零 Redis 查询</td><td>✅</td><td>✅</td></tr><tr><td>刷新请求查 Redis</td><td>✅</td><td>✅</td></tr><tr><td>Token 轮换</td><td>✅</td><td>✅</td></tr><tr><td>主动撤销</td><td>✅</td><td>✅</td></tr><tr><td>短泄露影响时间</td><td>✅（可设置15分钟）</td><td>✅</td></tr></tbody></table>
<h4 data-id="heading-6">关键洞察</h4>
<ol>
<li>
<p><strong>业务请求零 Redis 查询</strong>：两种方案都可以在业务请求中只验证 JWT 签名，不查询 Redis。Token 过期后自动失效，不需要黑名单。</p>
</li>
<li>
<p><strong>Token 轮换</strong>：单 Token 刷新后就是新 Token，将旧 Token 加入黑名单即实现轮换。</p>
</li>
<li>
<p><strong>撤销能力</strong>：两种方案都需要 Redis 来实现撤销功能，没有本质区别。</p>
</li>
</ol>
<h3 data-id="heading-7">完整示例代码</h3>
<h4 data-id="heading-8">单 Token 扩展刷新实现</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"net/http"</span>
    <span class="hljs-string">"time"</span>

    <span class="hljs-string">"github.com/cloudwego/hertz/pkg/app"</span>
    <span class="hljs-string">"github.com/cloudwego/hertz/pkg/app/server"</span>
    <span class="hljs-string">"github.com/go-redis/redis/v8"</span>
    <span class="hljs-string">"github.com/hertz-contrib/jwt"</span>
)

<span class="hljs-keyword">var</span> (
    redisClient *redis.Client
    identityKey = <span class="hljs-string">"identity"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    h := server.Default()

    <span class="hljs-comment">// 初始化 Redis</span>
    redisClient = redis.NewClient(&amp;redis.Options{
        Addr: <span class="hljs-string">"localhost:6379"</span>,
    })

    <span class="hljs-comment">// JWT 中间件配置</span>
    authMiddleware, _ := jwt.New(&amp;jwt.HertzJWTMiddleware{
        Realm:            <span class="hljs-string">"single-token-demo"</span>,
        Key:              []<span class="hljs-type">byte</span>(<span class="hljs-string">"secret-key"</span>),
        Timeout:          <span class="hljs-number">15</span> * time.Minute,      <span class="hljs-comment">// Token 有效期：15分钟</span>
        MaxRefresh:       <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * time.Hour,    <span class="hljs-comment">// 刷新窗口：7天</span>
        IdentityKey:      identityKey,

        <span class="hljs-comment">// 认证器：验证用户名密码</span>
        Authenticator: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, c *app.RequestContext)</span></span> (<span class="hljs-keyword">interface</span>{}, <span class="hljs-type">error</span>) {
            <span class="hljs-keyword">var</span> loginVals <span class="hljs-keyword">struct</span> {
                Username <span class="hljs-type">string</span> <span class="hljs-string">`json:"username"`</span>
                Password <span class="hljs-type">string</span> <span class="hljs-string">`json:"password"`</span>
            }
            <span class="hljs-keyword">if</span> err := c.BindAndValidate(&amp;loginVals); err != <span class="hljs-literal">nil</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, jwt.ErrMissingLoginValues
            }
            <span class="hljs-keyword">if</span> loginVals.Username == <span class="hljs-string">"admin"</span> &amp;&amp; loginVals.Password == <span class="hljs-string">"admin"</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
                    <span class="hljs-string">"user_id"</span>:  <span class="hljs-string">"123"</span>,
                    <span class="hljs-string">"username"</span>: loginVals.Username,
                }, <span class="hljs-literal">nil</span>
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, jwt.ErrFailedAuthentication
        },

        <span class="hljs-comment">// Payload：设置 Token 中的数据</span>
        PayloadFunc: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(data <span class="hljs-keyword">interface</span>{})</span></span> jwt.MapClaims {
            <span class="hljs-keyword">if</span> v, ok := data.(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}); ok {
                <span class="hljs-keyword">return</span> jwt.MapClaims{
                    identityKey: v[<span class="hljs-string">"user_id"</span>],
                    <span class="hljs-string">"username"</span>:  v[<span class="hljs-string">"username"</span>],
                }
            }
            <span class="hljs-keyword">return</span> jwt.MapClaims{}
        },

        <span class="hljs-comment">// 身份处理器</span>
        IdentityHandler: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, c *app.RequestContext)</span></span> <span class="hljs-keyword">interface</span>{} {
            claims := jwt.ExtractClaims(ctx, c)
            <span class="hljs-keyword">return</span> claims[identityKey]
        },

        <span class="hljs-comment">// 授权器</span>
        Authorizator: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(data <span class="hljs-keyword">interface</span>{}, ctx context.Context, c *app.RequestContext)</span></span> <span class="hljs-type">bool</span> {
            <span class="hljs-keyword">return</span> data != <span class="hljs-literal">nil</span>
        },

        <span class="hljs-comment">// 未授权响应</span>
        Unauthorized: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, c *app.RequestContext, code <span class="hljs-type">int</span>, message <span class="hljs-type">string</span>)</span></span> {
            c.JSON(code, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
                <span class="hljs-string">"code"</span>:    code,
                <span class="hljs-string">"message"</span>: message,
            })
        },
    })

    <span class="hljs-comment">// 路由配置</span>
    h.POST(<span class="hljs-string">"/login"</span>, authMiddleware.LoginHandler)
    h.POST(<span class="hljs-string">"/logout"</span>, LogoutHandler(authMiddleware))

    auth := h.Group(<span class="hljs-string">"/auth"</span>)
    auth.GET(<span class="hljs-string">"/refresh"</span>, RefreshHandler(authMiddleware))
    auth.Use(authMiddleware.MiddlewareFunc())
    {
        auth.GET(<span class="hljs-string">"/profile"</span>, ProfileHandler)
    }

    h.Spin()
}

<span class="hljs-comment">// 业务接口：零 Redis 查询</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ProfileHandler</span><span class="hljs-params">(ctx context.Context, c *app.RequestContext)</span></span> {
    <span class="hljs-comment">// 只验证 JWT，不查询 Redis</span>
    claims := jwt.ExtractClaims(ctx, c)
    c.JSON(http.StatusOK, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
        <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
        <span class="hljs-string">"data"</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
            <span class="hljs-string">"user_id"</span>:  claims[<span class="hljs-string">"identity"</span>],
            <span class="hljs-string">"username"</span>: claims[<span class="hljs-string">"username"</span>],
        },
    })
}

<span class="hljs-comment">// 刷新接口：查 Redis 黑名单 + 轮换</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RefreshHandler</span><span class="hljs-params">(authMiddleware *jwt.HertzJWTMiddleware)</span></span> app.HandlerFunc {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, c *app.RequestContext)</span></span> {
        <span class="hljs-comment">// 获取当前 Token</span>
        oldToken := jwt.GetToken(ctx, c)

        <span class="hljs-comment">// 检查黑名单（轮换检查）</span>
        <span class="hljs-keyword">if</span> exists, _ := redisClient.Exists(ctx, <span class="hljs-string">"blacklist:"</span>+oldToken).Result(); exists &gt; <span class="hljs-number">0</span> {
            c.JSON(http.StatusUnauthorized, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
                <span class="hljs-string">"code"</span>:    <span class="hljs-number">401</span>,
                <span class="hljs-string">"message"</span>: <span class="hljs-string">"token has been revoked"</span>,
            })
            <span class="hljs-keyword">return</span>
        }

        <span class="hljs-comment">// 调用原始刷新逻辑</span>
        tokenString, expire, err := authMiddleware.RefreshToken(ctx, c)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            c.JSON(http.StatusUnauthorized, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
                <span class="hljs-string">"code"</span>:    <span class="hljs-number">401</span>,
                <span class="hljs-string">"message"</span>: err.Error(),
            })
            <span class="hljs-keyword">return</span>
        }

        <span class="hljs-comment">// 将旧 Token 加入黑名单（轮换）</span>
        redisClient.Set(ctx, <span class="hljs-string">"blacklist:"</span>+oldToken, <span class="hljs-string">"revoked"</span>, <span class="hljs-number">7</span>*<span class="hljs-number">24</span>*time.Hour)

        c.JSON(http.StatusOK, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
            <span class="hljs-string">"code"</span>:   <span class="hljs-number">200</span>,
            <span class="hljs-string">"token"</span>:  tokenString,
            <span class="hljs-string">"expire"</span>: expire.Format(time.RFC3339),
        })
    }
}

<span class="hljs-comment">// 登出接口：将 Token 加入黑名单</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LogoutHandler</span><span class="hljs-params">(authMiddleware *jwt.HertzJWTMiddleware)</span></span> app.HandlerFunc {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, c *app.RequestContext)</span></span> {
        token := jwt.GetToken(ctx, c)

        <span class="hljs-comment">// 将 Token 加入黑名单</span>
        redisClient.Set(ctx, <span class="hljs-string">"blacklist:"</span>+token, <span class="hljs-string">"revoked"</span>, <span class="hljs-number">7</span>*<span class="hljs-number">24</span>*time.Hour)

        <span class="hljs-comment">// 调用原始登出逻辑</span>
        authMiddleware.LogoutHandler(ctx, c)
    }
}
</code></pre>
<h4 data-id="heading-9">双 Token 验证实现</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"net/http"</span>
    <span class="hljs-string">"time"</span>

    <span class="hljs-string">"github.com/cloudwego/hertz/pkg/app"</span>
    <span class="hljs-string">"github.com/cloudwego/hertz/pkg/app/server"</span>
    <span class="hljs-string">"github.com/go-redis/redis/v8"</span>
    <span class="hljs-string">"github.com/golang-jwt/jwt/v4"</span>
)

<span class="hljs-keyword">var</span> (
    redisClient         *redis.Client
    accessTokenSecret   = []<span class="hljs-type">byte</span>(<span class="hljs-string">"access-secret"</span>)
    refreshTokenSecret  = []<span class="hljs-type">byte</span>(<span class="hljs-string">"refresh-secret"</span>)
    accessTokenTimeout  = <span class="hljs-number">15</span> * time.Minute
    refreshTokenTimeout = <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * time.Hour
)

<span class="hljs-keyword">type</span> Claims <span class="hljs-keyword">struct</span> {
    UserID   <span class="hljs-type">string</span> <span class="hljs-string">`json:"user_id"`</span>
    Username <span class="hljs-type">string</span> <span class="hljs-string">`json:"username"`</span>
    jwt.RegisteredClaims
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    h := server.Default()

    <span class="hljs-comment">// 初始化 Redis</span>
    redisClient = redis.NewClient(&amp;redis.Options{
        Addr: <span class="hljs-string">"localhost:6379"</span>,
    })

    <span class="hljs-comment">// 路由配置</span>
    h.POST(<span class="hljs-string">"/login"</span>, LoginHandler)
    h.POST(<span class="hljs-string">"/logout"</span>, LogoutHandler)
    h.POST(<span class="hljs-string">"/refresh"</span>, RefreshHandler)

    auth := h.Group(<span class="hljs-string">"/auth"</span>)
    auth.Use(AuthMiddleware())
    {
        auth.GET(<span class="hljs-string">"/profile"</span>, ProfileHandler)
    }

    h.Spin()
}

<span class="hljs-comment">// 登录接口：返回 Access Token + Refresh Token</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoginHandler</span><span class="hljs-params">(ctx context.Context, c *app.RequestContext)</span></span> {
    <span class="hljs-keyword">var</span> loginVals <span class="hljs-keyword">struct</span> {
        Username <span class="hljs-type">string</span> <span class="hljs-string">`json:"username"`</span>
        Password <span class="hljs-type">string</span> <span class="hljs-string">`json:"password"`</span>
    }
    <span class="hljs-keyword">if</span> err := c.BindAndValidate(&amp;loginVals); err != <span class="hljs-literal">nil</span> {
        c.JSON(http.StatusBadRequest, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
            <span class="hljs-string">"code"</span>:    <span class="hljs-number">400</span>,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"invalid request"</span>,
        })
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">if</span> loginVals.Username != <span class="hljs-string">"admin"</span> || loginVals.Password != <span class="hljs-string">"admin"</span> {
        c.JSON(http.StatusUnauthorized, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
            <span class="hljs-string">"code"</span>:    <span class="hljs-number">401</span>,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"invalid credentials"</span>,
        })
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 生成 Access Token</span>
    accessToken, _ := generateAccessToken(loginVals.Username, <span class="hljs-string">"123"</span>)

    <span class="hljs-comment">// 生成 Refresh Token</span>
    refreshToken, _ := generateRefreshToken(loginVals.Username, <span class="hljs-string">"123"</span>)

    c.JSON(http.StatusOK, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
        <span class="hljs-string">"code"</span>:          <span class="hljs-number">200</span>,
        <span class="hljs-string">"access_token"</span>:  accessToken,
        <span class="hljs-string">"refresh_token"</span>: refreshToken,
        <span class="hljs-string">"expires_in"</span>:    <span class="hljs-type">int</span>(accessTokenTimeout.Seconds()),
    })
}

<span class="hljs-comment">// 业务中间件：只验证 Access Token，不查 Redis</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AuthMiddleware</span><span class="hljs-params">()</span></span> app.HandlerFunc {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, c *app.RequestContext)</span></span> {
        tokenString := c.GetHeader(<span class="hljs-string">"Authorization"</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(tokenString) &lt; <span class="hljs-number">7</span> || <span class="hljs-type">string</span>(tokenString[:<span class="hljs-number">7</span>]) != <span class="hljs-string">"Bearer "</span> {
            c.JSON(http.StatusUnauthorized, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
                <span class="hljs-string">"code"</span>:    <span class="hljs-number">401</span>,
                <span class="hljs-string">"message"</span>: <span class="hljs-string">"missing token"</span>,
            })
            c.Abort()
            <span class="hljs-keyword">return</span>
        }

        <span class="hljs-comment">// 只验证 JWT 签名和过期时间，不查 Redis</span>
        token, err := jwt.ParseWithClaims(<span class="hljs-type">string</span>(tokenString[<span class="hljs-number">7</span>:]), &amp;Claims{}, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(token *jwt.Token)</span></span> (<span class="hljs-keyword">interface</span>{}, <span class="hljs-type">error</span>) {
            <span class="hljs-keyword">return</span> accessTokenSecret, <span class="hljs-literal">nil</span>
        })

        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || !token.Valid {
            c.JSON(http.StatusUnauthorized, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
                <span class="hljs-string">"code"</span>:    <span class="hljs-number">401</span>,
                <span class="hljs-string">"message"</span>: <span class="hljs-string">"invalid token"</span>,
            })
            c.Abort()
            <span class="hljs-keyword">return</span>
        }

        claims := token.Claims.(*Claims)
        c.Set(<span class="hljs-string">"user_id"</span>, claims.UserID)
        c.Set(<span class="hljs-string">"username"</span>, claims.Username)
        c.Next(ctx)
    }
}

<span class="hljs-comment">// 业务接口：零 Redis 查询</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ProfileHandler</span><span class="hljs-params">(ctx context.Context, c *app.RequestContext)</span></span> {
    c.JSON(http.StatusOK, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
        <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
        <span class="hljs-string">"data"</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
            <span class="hljs-string">"user_id"</span>:  c.GetString(<span class="hljs-string">"user_id"</span>),
            <span class="hljs-string">"username"</span>: c.GetString(<span class="hljs-string">"username"</span>),
        },
    })
}

<span class="hljs-comment">// 刷新接口：验证 Refresh Token，查 Redis 检查撤销状态</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RefreshHandler</span><span class="hljs-params">(ctx context.Context, c *app.RequestContext)</span></span> {
    <span class="hljs-keyword">var</span> req <span class="hljs-keyword">struct</span> {
        RefreshToken <span class="hljs-type">string</span> <span class="hljs-string">`json:"refresh_token"`</span>
    }
    <span class="hljs-keyword">if</span> err := c.BindAndValidate(&amp;req); err != <span class="hljs-literal">nil</span> {
        c.JSON(http.StatusBadRequest, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
            <span class="hljs-string">"code"</span>:    <span class="hljs-number">400</span>,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"invalid request"</span>,
        })
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 解析 Refresh Token</span>
    token, err := jwt.ParseWithClaims(req.RefreshToken, &amp;Claims{}, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(token *jwt.Token)</span></span> (<span class="hljs-keyword">interface</span>{}, <span class="hljs-type">error</span>) {
        <span class="hljs-keyword">return</span> refreshTokenSecret, <span class="hljs-literal">nil</span>
    })
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || !token.Valid {
        c.JSON(http.StatusUnauthorized, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
            <span class="hljs-string">"code"</span>:    <span class="hljs-number">401</span>,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"invalid refresh token"</span>,
        })
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 检查 Refresh Token 是否被撤销（查 Redis）</span>
    <span class="hljs-keyword">if</span> exists, _ := redisClient.Exists(ctx, <span class="hljs-string">"revoked:"</span>+req.RefreshToken).Result(); exists &gt; <span class="hljs-number">0</span> {
        c.JSON(http.StatusUnauthorized, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
            <span class="hljs-string">"code"</span>:    <span class="hljs-number">401</span>,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"refresh token has been revoked"</span>,
        })
        <span class="hljs-keyword">return</span>
    }

    claims := token.Claims.(*Claims)

    <span class="hljs-comment">// 撤销旧的 Refresh Token（轮换）</span>
    redisClient.Set(ctx, <span class="hljs-string">"revoked:"</span>+req.RefreshToken, <span class="hljs-string">"revoked"</span>, refreshTokenTimeout)

    <span class="hljs-comment">// 生成新的 Access Token</span>
    newAccessToken, _ := generateAccessToken(claims.Username, claims.UserID)

    <span class="hljs-comment">// 生成新的 Refresh Token（轮换）</span>
    newRefreshToken, _ := generateRefreshToken(claims.Username, claims.UserID)

    c.JSON(http.StatusOK, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
        <span class="hljs-string">"code"</span>:          <span class="hljs-number">200</span>,
        <span class="hljs-string">"access_token"</span>:  newAccessToken,
        <span class="hljs-string">"refresh_token"</span>: newRefreshToken,
        <span class="hljs-string">"expires_in"</span>:    <span class="hljs-type">int</span>(accessTokenTimeout.Seconds()),
    })
}

<span class="hljs-comment">// 登出接口：撤销 Refresh Token</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LogoutHandler</span><span class="hljs-params">(ctx context.Context, c *app.RequestContext)</span></span> {
    <span class="hljs-keyword">var</span> req <span class="hljs-keyword">struct</span> {
        RefreshToken <span class="hljs-type">string</span> <span class="hljs-string">`json:"refresh_token"`</span>
    }
    <span class="hljs-keyword">if</span> err := c.BindAndValidate(&amp;req); err != <span class="hljs-literal">nil</span> {
        c.JSON(http.StatusBadRequest, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
            <span class="hljs-string">"code"</span>:    <span class="hljs-number">400</span>,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"invalid request"</span>,
        })
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 撤销 Refresh Token</span>
    redisClient.Set(ctx, <span class="hljs-string">"revoked:"</span>+req.RefreshToken, <span class="hljs-string">"revoked"</span>, refreshTokenTimeout)

    c.JSON(http.StatusOK, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
        <span class="hljs-string">"code"</span>:    <span class="hljs-number">200</span>,
        <span class="hljs-string">"message"</span>: <span class="hljs-string">"logged out"</span>,
    })
}

<span class="hljs-comment">// 生成 Access Token</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generateAccessToken</span><span class="hljs-params">(username, userID <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    claims := Claims{
        UserID:   userID,
        Username: username,
        RegisteredClaims: jwt.RegisteredClaims{
            ExpiresAt: jwt.NewNumericDate(time.Now().Add(accessTokenTimeout)),
            IssuedAt:  jwt.NewNumericDate(time.Now()),
        },
    }
    token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)
    <span class="hljs-keyword">return</span> token.SignedString(accessTokenSecret)
}

<span class="hljs-comment">// 生成 Refresh Token</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generateRefreshToken</span><span class="hljs-params">(username, userID <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    claims := Claims{
        UserID:   userID,
        Username: username,
        RegisteredClaims: jwt.RegisteredClaims{
            ExpiresAt: jwt.NewNumericDate(time.Now().Add(refreshTokenTimeout)),
            IssuedAt:  jwt.NewNumericDate(time.Now()),
        },
    }
    token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)
    <span class="hljs-keyword">return</span> token.SignedString(refreshTokenSecret)
}
</code></pre>
<h3 data-id="heading-10">方案对比总结</h3>
<h4 data-id="heading-11">单 Token 扩展刷新</h4>
<p><strong>优点：</strong></p>
<ul>
<li>实现简单，只需管理一个 Token</li>
<li>客户端逻辑简单，只需存储一个 Token</li>
<li>可以实现所有双 Token 的功能</li>
<li>向后兼容性好</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>概念不如双 Token 清晰</li>
<li>不符合 OAuth 2.0 标准</li>
</ul>
<p><strong>适用场景：</strong></p>
<ul>
<li>中小型应用</li>
<li>快速开发</li>
<li>追求简单实现</li>
<li>移动端应用</li>
</ul>
<h4 data-id="heading-12">双 Token 验证</h4>
<p><strong>优点：</strong></p>
<ul>
<li>职责分离，概念清晰</li>
<li>符合 OAuth 2.0 标准</li>
<li>业界广泛采用</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>实现复杂，需要管理两个 Token</li>
<li>客户端需要处理两个 Token 的生命周期</li>
<li>需要处理两个 Token 的存储和同步</li>
</ul>
<p><strong>适用场景：</strong></p>
<ul>
<li>需要符合 OAuth 2.0 标准</li>
<li>大型企业应用</li>
<li>多系统集成</li>
</ul>
<h3 data-id="heading-13">关键结论</h3>
<ol>
<li>
<p><strong>功能等价</strong>：单 Token 扩展刷新设计可以实现双 Token 的所有核心功能，包括零 Redis 查询、Token 轮换、主动撤销等。</p>
</li>
<li>
<p><strong>主要区别在于</strong>：</p>
<ul>
<li>实现复杂度：单 Token 更简单</li>
<li>概念清晰度：双 Token 更清晰</li>
<li>标准合规性：双 Token 符合 OAuth 2.0</li>
</ul>
</li>
<li>
<p><strong>选择建议</strong>：</p>
<ul>
<li>如果追求简单和效率：选择单 Token 扩展刷新</li>
<li>如果需要符合标准或多系统集成：选择双 Token</li>
</ul>
</li>
<li>
<p><strong>单 Token 扩展刷新是一个巧妙的设计</strong>：它通过 <code>orig_iat</code> 和 <code>MaxRefresh</code> 的组合，实现了与双 Token 相同的功能，但实现更简单。</p>
</li>
</ol>
<h3 data-id="heading-14">相关资源</h3>
<ul>
<li>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhertz-contrib%2Fjwt" target="_blank" title="https://github.com/hertz-contrib/jwt" ref="nofollow noopener noreferrer">hertz-contrib/jwt</a></li>
<li>Bug 修复 PR：保留原始 <code>orig_iat</code> 值以维护 MaxRefresh 窗口</li>
<li>Hertz 框架：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcloudwego%2Fhertz" target="_blank" title="https://github.com/cloudwego/hertz" ref="nofollow noopener noreferrer">cloudwego/hertz</a></li>
</ul>
<hr/>
<blockquote>
<p>本文讨论的核心观点：不要盲目追随"业界最佳实践"，而应该根据实际需求选择合适的方案。单 Token 扩展刷新设计在大多数场景下是足够的，且实现更简单。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Prisma】NestJS 集成与核心链路解析]]></title>    <link>https://juejin.cn/post/7582879379442204715</link>    <guid>https://juejin.cn/post/7582879379442204715</guid>    <pubDate>2025-12-13T15:06:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582879379442204715" data-draft-id="7583139562735730731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Prisma】NestJS 集成与核心链路解析"/> <meta itemprop="keywords" content="后端,数据库"/> <meta itemprop="datePublished" content="2025-12-13T15:06:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="曾富贵"/> <meta itemprop="url" content="https://juejin.cn/user/4212984286289806"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Prisma】NestJS 集成与核心链路解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984286289806/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    曾富贵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T15:06:51.000Z" title="Sat Dec 13 2025 15:06:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、 Prisma 核心概念</h2>
<h3 data-id="heading-1">1.1 Prisma 是什么</h3>
<p>Prisma 是下一代 Node.js 和 TypeScript ORM。与传统的 ORM（如 TypeORM）不同，Prisma 不使用类（Classes）来映射数据库表，而是使用自定义的 Schema 语言来定义模型，并生成 <strong>类型安全（Type-safe）</strong> 的查询构建器（Client）。</p>
<h3 data-id="heading-2">1.2 核心组件</h3>
<p>Prisma 生态系统由三个主要工具组成：</p>
<ol>
<li><strong>Prisma Client</strong>: 基于你的 Schema 自动生成的类型安全查询构建器，供 Node.js 和 TypeScript 调用。</li>
<li><strong>Prisma Migrate</strong>: 声明式的数据建模与迁移系统。</li>
<li><strong>Prisma Studio</strong>: 现代化的数据库 GUI，用于浏览和管理数据（类似 DBeaver/Navicat 的 Web 精简版）。</li>
</ol>
<hr/>
<h2 data-id="heading-3">二、 NestJS 集成与初始化</h2>
<h3 data-id="heading-4">2.1 项目初始化</h3>
<p>在现有的 NestJS 项目中安装 Prisma CLI 和 Client：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 CLI (开发依赖)</span>
pnpm add -D prisma

<span class="hljs-comment"># 安装 Client (运行时依赖)</span>
pnpm add @prisma/client

<span class="hljs-comment"># 初始化 (生成 prisma 文件夹和 .env, prisma.config.ts)</span>
npx prisma init

<span class="hljs-comment"># 安装 dotenv 用于加载环境变量</span>
pnpm add -D dotenv
</code></pre>
<h3 data-id="heading-5">2.2 核心文件详解</h3>
<p>Prisma 7 引入了 <strong>配置即代码</strong> 的理念，核心配置分散在以下文件中：</p>
<ul>
<li><strong><code>prisma.config.ts</code></strong>：Prisma 的主配置文件，负责指定 Schema 文件位置、配置迁移文件生成路径以及配置数据源连接。</li>
<li><strong><code>prisma/schema.prisma</code></strong>：指定数据源类型（Provider）、生成器（Generator）和定义数据模型（Models）。</li>
<li><strong><code>.env</code></strong>：存储环境变量（如 <code>DATABASE_URL</code>）。Prisma CLI 默认只读取此文件，但可以通过系统环境变量覆盖，或在 <code>prisma.config.ts</code> 中自定义加载逻辑。</li>
</ul>
<p><strong>1. prisma.config.ts 示例</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-string">'dotenv/config'</span>;
<span class="hljs-keyword">import</span> { defineConfig, env } <span class="hljs-keyword">from</span> <span class="hljs-string">'prisma/config'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// 1. 指定 schema 文件位置</span>
  <span class="hljs-attr">schema</span>: <span class="hljs-string">'prisma/schema.prisma'</span>,
  
  <span class="hljs-comment">// 2. 配置迁移文件生成路径</span>
  <span class="hljs-attr">migrations</span>: {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'prisma/migrations'</span>,
  },
  
  <span class="hljs-comment">// 3. 配置数据源连接</span>
  <span class="hljs-comment">// 这里使用 env() 函数读取环境变量，实现了配置与代码的分离</span>
  <span class="hljs-attr">datasource</span>: {
    <span class="hljs-attr">url</span>: <span class="hljs-title function_">env</span>(<span class="hljs-string">'DATABASE_URL'</span>),
  },
});
</code></pre>
<p><strong>2. prisma/schema.prisma 示例</strong>：</p>
<pre><code class="hljs language-prisma" lang="prisma">// 指定生成器
generator client {
  provider = "prisma-client-js"
}

// 指定数据源类型 (注意：此处不再配置 url)
datasource db {
  provider = "mysql"
}

// 定义 User 模型
model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String?
}
</code></pre>
<h3 data-id="heading-6">2.3 NestJS 模块化集成 (PrismaService)</h3>
<p>为了在 NestJS 中高效使用，我们需要创建一个全局 Service 来管理连接生命周期，并在业务模块中注入使用。</p>
<p><strong>步骤 1：创建全局 PrismaService</strong></p>
<p><strong>src/prisma/prisma.service.ts</strong>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">OnModuleInit</span>, <span class="hljs-title class_">OnModuleDestroy</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@prisma/client'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrismaService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PrismaClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnModuleInit</span>, <span class="hljs-title class_">OnModuleDestroy</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onModuleInit</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.$connect();
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onModuleDestroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.$disconnect();
  }
}
</code></pre>
<p><strong>src/prisma/prisma.module.ts</strong>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Global</span>, <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./prisma.service'</span>;

<span class="hljs-meta">@Global</span>() <span class="hljs-comment">// 设为全局模块，避免到处 import</span>
<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">PrismaService</span>],
  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">PrismaService</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrismaModule</span> {}
</code></pre>
<p><strong>步骤 2：在业务模块中使用</strong></p>
<p>假设有一个 <code>UsersModule</code>，你只需要在 Service 的构造函数中注入 <code>PrismaService</code> 即可。</p>
<p><strong>src/users/users.service.ts</strong>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../prisma/prisma.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span>, <span class="hljs-title class_">Prisma</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@prisma/client'</span>; <span class="hljs-comment">// 导入生成的类型</span>

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UsersService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> prisma: PrismaService</span>) {}

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-attr">data</span>: <span class="hljs-title class_">Prisma</span>.<span class="hljs-property">UserCreateInput</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">User</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">user</span>.<span class="hljs-title function_">create</span>({
      data,
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">findAll</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">user</span>.<span class="hljs-title function_">findMany</span>();
  }
}
</code></pre>
<h3 data-id="heading-7">2.4 社区方案推荐 (<code>nestjs-prisma</code>)</h3>
<p>虽然本文推荐使用官方的手动集成方式以理解底层原理，但在生产环境中，建议选择社区成熟的封装库 <code>nestjs-prisma</code>。</p>
<ul>
<li><strong>特点</strong>：内置了 <code>PrismaModule</code> 和 <code>PrismaService</code>，开箱即用。</li>
<li><strong>优势</strong>：提供了日志中间件、异常过滤器等实用工具，省去了样板代码。</li>
<li><strong>适用</strong>：希望快速搭建、减少样板代码的项目。</li>
</ul>
<hr/>
<h2 data-id="heading-8">三、 Prisma 核心链路</h2>
<ol>
<li>
<p><strong>配置阶段 (<code>prisma.config.ts</code>)</strong>：</p>
<ul>
<li>它是总指挥。当你运行 <code>prisma</code> 命令时，它首先被加载。</li>
<li>它告诉 CLI：去哪找 Schema 定义 (<code>schema.prisma</code>)，去哪找迁移文件 (<code>migrations</code>)，以及去哪找数据库连接串 (<code>.env</code> -&gt; <code>DATABASE_URL</code>)。</li>
</ul>
</li>
<li>
<p><strong>反向工程阶段 (Introspection, 可选)</strong>：</p>
<ul>
<li><strong>命令</strong>：<code>npx prisma db pull</code></li>
<li><strong>场景</strong>：当你有现存的数据库，或者有人直接修改了数据库结构时。</li>
<li><strong>作用</strong>：Prisma 读取数据库的 Schema（表、列、索引），并将它们 <strong>反向生成/覆盖</strong> 到 <code>prisma/schema.prisma</code> 文件中，确保你的 Schema 定义与真实数据库保持同步。</li>
</ul>
</li>
<li>
<p><strong>迁移同步阶段 (Migration/Sync)</strong>：</p>
<ul>
<li>当你运行 <code>npx prisma migrate dev</code> 或 <code>npx prisma db push</code> 时，Prisma 会计算差异并同步到数据库。</li>
<li><strong>差异计算方式取决于命令</strong>：
<ul>
<li><strong><code>migrate dev</code></strong>：对比 <code>schema.prisma</code> 和 <strong>迁移历史</strong>（借助影子库）。生成 SQL 迁移文件并应用到数据库，适合团队协作。</li>
<li><strong><code>db push</code></strong>：对比 <code>schema.prisma</code> 和 <strong>数据库当前结构</strong>。忽略迁移历史，根据差异内容，直接将变更应用到数据库，适合快速开发。</li>
</ul>
</li>
<li><strong>执行变更</strong>：
<ul>
<li><strong><code>migrate dev</code></strong>：执行 <strong>本地新生成的 SQL 迁移文件</strong>。</li>
<li><strong><code>db push</code></strong>：执行 <strong>内存中即时计算出的变更 SQL</strong>。</li>
<li>最终结果都是将模型同步到真实数据库中，创建表、列、索引等。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>生成阶段 (CodeGen)</strong>：</p>
<ul>
<li>当你运行 <code>npx prisma generate</code> 时（<code>migrate dev</code> 和 <code>db push</code> 默认都会自动触发此步），Prisma 读取 <code>schema.prisma</code> 中的 <code>model User { ... }</code>。</li>
<li>它将这些模型定义“翻译”成 TypeScript 类型定义 (<code>User</code>, <code>UserCreateInput</code>) 和 JavaScript 查询逻辑。</li>
<li>生成的代码被写入到 <code>node_modules/@prisma/client</code> 目录中。</li>
<li><strong>关键点</strong>：这就是为什么每次修改 <code>schema.prisma</code> 后<strong>必须</strong>重新运行 <code>generate</code>，否则你的代码里拿不到新字段的提示。</li>
</ul>
</li>
<li>
<p><strong>运行阶段 (Runtime)</strong>：</p>
<ul>
<li>当你执行 <code>this.prisma.user.findMany()</code> 时，<code>PrismaService</code> 实例（已在应用启动时连接数据库）会将 JS 对象转换成 SQL 语句发送给数据库，并将结果反序列化回 JS 对象。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-9">四、 开发工作流集成</h2>
<ol>
<li>
<p><strong>代码自动生成 (<code>postinstall</code>)</strong>：</p>
<ul>
<li>在 <code>package.json</code> 中配置 <code>"postinstall": "prisma generate"</code>。</li>
<li><strong>作用</strong>：每次你（或同事、CI/CD）执行 <code>npm install</code> 安装依赖后，会自动触发 <code>prisma generate</code>。这样确保 <code>node_modules/@prisma/client</code> 永远是最新的，你下载完项目就能直接跑，不用担心缺少 Prisma 类型代码。</li>
</ul>
</li>
<li>
<p><strong>修改表结构的流程</strong>：</p>
<ul>
<li><strong>标准模式 (<code>migrate dev</code>)</strong>：当你修改了 <code>schema.prisma</code> 后，需<strong>手动运行</strong> <code>npx prisma migrate dev</code>。
<ul>
<li><strong>动作</strong>：生成新的 SQL 迁移文件 -&gt; 执行 SQL 更新数据库 -&gt; 自动运行 <code>prisma generate</code> 重新生成 Client 代码。</li>
<li><strong>结果</strong>：数据库表结构变更，且 <code>node_modules</code> 更新，NestJS 热重载触发，IDE 获得新字段提示。</li>
</ul>
</li>
<li><strong>Sync 模式 (<code>db push</code>)</strong>：需<strong>手动运行</strong> <code>npx prisma db push</code>。
<ul>
<li><strong>动作</strong>：直接更新数据库结构（无迁移文件） -&gt; 自动运行 <code>prisma generate</code>。</li>
<li><strong>场景</strong>：适用于快速原型开发。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>运行时连接 (<code>PrismaService</code>)</strong>：</p>
<ul>
<li>我们在 <code>2.3</code> 节创建的 <code>PrismaService</code> 实现了 <code>OnModuleInit</code> 接口。</li>
<li><strong>作用</strong>：当 NestJS 应用启动 (<code>npm run start:dev</code>) 时，<code>PrismaService</code> 会自动调用 <code>$connect()</code> 建立数据库连接池。应用停止时自动断开。</li>
<li>你不需要在每个 Controller 里手动 connect/disconnect，直接注入 Service 使用即可。</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-10">五、 深入理解：<code>migrate dev</code> 背后的黑盒机制</h2>
<p>Prisma Migrate 的核心逻辑是基于 <strong>Shadow Database（影子数据库）</strong> 来计算差异的。</p>
<p>当你运行 <code>prisma migrate dev</code> 时，Prisma 会在后台偷偷做这件事：</p>
<ol>
<li><strong>创建影子库</strong>：在后台临时创建一个空的数据库（Shadow DB）。</li>
<li><strong>重放历史</strong>：把本地 <code>prisma/migrations</code> 文件夹里所有的 SQL 文件，按顺序在这个影子库里执行一遍。执行完后，影子库的状态就是 “上一次迁移后的状态” (B)。</li>
<li><strong>计算差异</strong>：拿你现在的 <code>schema.prisma</code> (A) 和这个影子库 (B) 对比。</li>
<li><strong>生成新迁移</strong>：差异部分生成新的 SQL 文件，放入 <code>prisma/migrations</code>。</li>
<li><strong>清理</strong>：删掉影子库。</li>
</ol>
<p><strong>结论：</strong></p>
<ul>
<li>Prisma 信任的是你 <strong>本地的文件系统 (<code>prisma/migrations</code>)</strong> 作为历史记录的依据。</li>
<li>如果你把本地的 <code>migrations</code> 文件夹删了，Prisma 就失忆了，下次它就会认为你是从零开始，生成全量迁移。</li>
<li>所以，<strong><code>prisma/migrations</code> 文件夹必须提交到 Git</strong>，它是项目源代码的重要组成部分。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java网络编程从入门到实战：吃透三要素，玩转CS/BS架构]]></title>    <link>https://juejin.cn/post/7582905804048007195</link>    <guid>https://juejin.cn/post/7582905804048007195</guid>    <pubDate>2025-12-13T15:11:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582905804048007195" data-draft-id="7582905804047990811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java网络编程从入门到实战：吃透三要素，玩转CS/BS架构"/> <meta itemprop="keywords" content="后端,Java,HTTP"/> <meta itemprop="datePublished" content="2025-12-13T15:11:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="okseekw"/> <meta itemprop="url" content="https://juejin.cn/user/1933379625032649"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java网络编程从入门到实战：吃透三要素，玩转CS/BS架构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1933379625032649/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    okseekw
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T15:11:40.000Z" title="Sat Dec 13 2025 15:11:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Java网络编程从入门到实战：吃透三要素，玩转CS/BS架构</h2>
<p>在数字化时代，网络编程是实现设备互联、数据交互的核心技术。无论是我们日常使用的APP、网页，还是企业级的服务通信，都离不开网络编程的支撑。而Java作为一门强大的后端开发语言，其<code>java.net.*</code>包提供了完善的网络编程解决方案，让开发者能够轻松实现各类网络通信需求。</p>
<p>本文将从网络编程的基础概念出发，详解<strong>通信架构</strong>与<strong>IP、端口、协议三要素</strong>，并结合实战代码演示<code>InetAddress</code>类的使用，帮你从理论到实践，彻底入门Java网络编程。</p>
<h3 data-id="heading-1">一、网络编程是什么？通信架构有哪些？</h3>
<h4 data-id="heading-2">1.1 网络编程的核心定义</h4>
<p>网络编程是指让设备中的程序与网络上其他设备的程序进行数据交互的技术。简单来说，就是实现“跨设备数据传递”的手段——小到手机扫码支付，大到分布式系统的数据同步，本质上都是网络编程的应用。</p>
<h4 data-id="heading-3">1.2 两大核心通信架构</h4>
<p>所有网络应用都基于以下两种通信架构设计，且无论哪种架构，都必须依赖网络编程三要素（IP、端口、协议）实现通信：</p>
<h5 data-id="heading-4">1. CS架构（Client/Server，客户端/服务端）</h5>
<ul>
<li><strong>结构</strong>：分为客户端和服务端两部分。客户端是用户直接操作的程序（如微信APP、QQ客户端、游戏客户端），服务端是运行在远程服务器上的程序，负责接收客户端请求、处理数据并返回结果。</li>
<li><strong>特点</strong>：客户端需要单独安装，可定制化程度高，能缓存数据，适合对交互体验和性能要求高的场景（如游戏、办公软件）。</li>
<li><strong>示例</strong>：微信（手机客户端 ↔ 腾讯服务器）、MySQL数据库（Java程序 ↔ MySQL服务端）。</li>
</ul>
<h5 data-id="heading-5">2. BS架构（Browser/Server，浏览器/服务端）</h5>
<ul>
<li><strong>结构</strong>：无需安装单独客户端，通过浏览器（如Chrome、Edge）作为“通用客户端”，直接访问远程服务端的网页或接口。</li>
<li><strong>特点</strong>：无需安装、跨平台（只要有浏览器即可使用），开发维护成本低，适合面向广泛用户的场景（如电商网站、新闻平台）。</li>
<li><strong>示例</strong>：淘宝（浏览器 ↔ 阿里服务器）、百度搜索（浏览器 ↔ 百度服务器）。</li>
</ul>
<h4 data-id="heading-6">1.3 Java的网络编程支持</h4>
<p>Java为网络编程提供了原生解决方案——<code>java.net.*</code>包，该包包含了处理IP、端口、协议的核心类（如<code>InetAddress</code>、<code>Socket</code>、<code>ServerSocket</code>等），无需额外依赖第三方库，即可实现从简单的IP解析到复杂的TCP/UDP通信。</p>
<h3 data-id="heading-7">二、IP：设备在网络中的“唯一身份证”</h3>
<p>IP（Internet Protocol，互联网协议地址）是网络中设备的唯一标识，相当于现实中的“家庭住址”，用于精准定位通信的目标设备。没有IP，设备就无法在网络中被识别。</p>
<h4 data-id="heading-8">2.1 两种主流IP地址：IPv4与IPv6</h4>
<p>目前全球广泛使用的IP地址有两种，核心差异在于地址长度和容量：</p>























<table><thead><tr><th>类型</th><th>地址长度</th><th>表示形式</th><th>特点</th></tr></thead><tbody><tr><td>IPv4</td><td>32位</td><td>点分十进制（如192.168.1.1）</td><td>地址容量约42亿，已濒临枯竭</td></tr><tr><td>IPv6</td><td>128位</td><td>冒分十六进制（如2001:0db8:85a3:0000:0000:8a2e:0370:7334）</td><td>容量极大，可满足万物互联需求</td></tr></tbody></table>
<p>IPv6的出现是为了解决IPv4地址耗尽的问题，其地址容量号称“能为地球上每一粒沙子编号”，是未来网络的主流选择。</p>
<h4 data-id="heading-9">2.2 域名：人类易记的“IP别名”</h4>
<p>IP地址是一串无意义的数字，难以记忆（比如没人能记住百度的IP，但能记住<code>www.baidu.com</code>）。为了解决这个问题，<strong>域名（Domain Name）</strong> 应运而生，而<strong>DNS域名解析系统</strong>则充当了“互联网电话簿”的角色——将易记的域名（如<code>www.jd.com</code>）自动转换为对应的IP地址，让用户无需记忆复杂数字即可访问网络资源。</p>
<h4 data-id="heading-10">2.3 IP的分类：公网IP、内网IP与本机IP</h4>
<p>根据使用范围，IP可分为三类，各自承担不同的通信职责：</p>
<ul>
<li><strong>公网IP</strong>：全网唯一，可直接连接互联网，用于设备对外通信（如阿里云服务器的IP）。</li>
<li><strong>内网IP</strong>：仅在局域网内使用（如公司、家庭网络），无法直接访问互联网。常见以<code>192.168.</code>开头，范围是<code>192.168.0.0~192.168.255.255</code>，局域网内设备可通过内网IP相互通信（如办公室电脑之间传文件）。</li>
<li><strong>本机IP</strong>：<code>127.0.0.1</code>（或别名<code>localhost</code>），专门指代当前设备，常用于本地程序调试（如本地启动的Spring Boot项目，可通过<code>http://localhost:8080</code>访问）。</li>
</ul>
<h4 data-id="heading-11">2.4 常用IP操作命令</h4>
<p>日常开发中，常用以下命令排查网络问题：</p>
<ul>
<li><code>ipconfig</code>（Windows）/ <code>ifconfig</code>（Linux/Mac）：查看本机IP地址、子网掩码、网关等网络配置。</li>
<li><code>ping IP地址/域名</code>：检测本机与目标设备的网络连通性（如<code>ping www.baidu.com</code>，若返回“请求超时”则说明网络不通）。</li>
</ul>
<h4 data-id="heading-12">2.5 Java实战：用InetAddress操作IP</h4>
<p>Java的<code>java.net.InetAddress</code>类是处理IP的核心工具，可实现“获取本机IP、解析域名到IP、检测网络连通性”等功能。下面通过实战代码演示其核心用法。</p>
<h5 data-id="heading-13">完整代码（可直接运行）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.wmh.demo1inetaddress;
<span class="hljs-keyword">import</span> java.net.InetAddress;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InetAddressDemo1</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 目标：使用InetAddress操作IP（本机IP、目标IP、连通性检测）</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 获取本机IP对象（包含主机名和IP地址）</span>
            <span class="hljs-type">InetAddress</span> <span class="hljs-variable">localIp</span> <span class="hljs-operator">=</span> InetAddress.getLocalHost();
            System.out.println(<span class="hljs-string">"✅ 本机主机名："</span> + localIp.getHostName());
            System.out.println(<span class="hljs-string">"✅ 本机IP地址："</span> + localIp.getHostAddress());

            <span class="hljs-comment">// 2. 通过域名获取目标IP对象（以百度为例，自动触发DNS解析）</span>
            <span class="hljs-type">InetAddress</span> <span class="hljs-variable">baiduIp</span> <span class="hljs-operator">=</span> InetAddress.getByName(<span class="hljs-string">"www.baidu.com"</span>);
            System.out.println(<span class="hljs-string">"\n✅ 百度主机名："</span> + baiduIp.getHostName());
            System.out.println(<span class="hljs-string">"✅ 百度IP地址："</span> + baiduIp.getHostAddress());

            <span class="hljs-comment">// 3. 检测本机与百度的网络连通性（超时时间5000毫秒=5秒）</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isReachable</span> <span class="hljs-operator">=</span> baiduIp.isReachable(<span class="hljs-number">5000</span>);
            System.out.println(<span class="hljs-string">"\n✅ 本机与百度是否连通："</span> + (isReachable ? <span class="hljs-string">"是"</span> : <span class="hljs-string">"否"</span>));

        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 捕获异常（如DNS解析失败、网络中断、权限不足等）</span>
            System.err.println(<span class="hljs-string">"❌ 网络操作异常："</span> + e.getMessage());
            e.printStackTrace();
        }
    }
}
</code></pre>
<h5 data-id="heading-14">核心方法解释</h5>





























<table><thead><tr><th>方法</th><th>功能描述</th></tr></thead><tbody><tr><td><code>getLocalHost()</code></td><td>获取本机IP地址对象，抛出<code>UnknownHostException</code>异常</td></tr><tr><td><code>getByName(String host)</code></td><td>根据IP地址或域名，获取目标IP对象（自动DNS解析）</td></tr><tr><td><code>getHostName()</code></td><td>获取IP对象对应的主机名</td></tr><tr><td><code>getHostAddress()</code></td><td>获取IP对象对应的IP地址字符串</td></tr><tr><td><code>isReachable(int timeout)</code></td><td>检测与目标设备的连通性，timeout为超时时间（毫秒）</td></tr></tbody></table>
<h5 data-id="heading-15">运行结果示例</h5>
<pre><code class="hljs">✅ 本机主机名：DESKTOP-8K8XZ7A
✅ 本机IP地址：192.168.3.108

✅ 百度主机名：www.baidu.com
✅ 百度IP地址：180.101.49.12

✅ 本机与百度是否连通：是
</code></pre>
<h3 data-id="heading-16">三、端口：应用程序的“唯一门牌号”</h3>
<p>通过IP定位到设备后，还需要通过<strong>端口（Port）</strong> 定位到设备上正在运行的应用程序。端口是一个16位的二进制数，范围是<code>0~65535</code>，相当于设备上的“门牌号”——一个设备可以同时运行多个应用程序，每个程序都需要占用一个唯一的端口。</p>
<h4 data-id="heading-17">3.1 端口分类（按用途划分）</h4>





























<table><thead><tr><th>端口范围</th><th>类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>0~1023</td><td>周知端口</td><td>系统预定义，被知名应用占用，不可随意使用</td><td>HTTP（80）、FTP（21）、HTTPS（443）</td></tr><tr><td>1024~49151</td><td>注册端口</td><td>用于用户开发的应用程序，推荐使用</td><td>Tomcat默认端口（8080）、MySQL默认端口（3306）</td></tr><tr><td>49152~65535</td><td>动态端口</td><td>系统动态分配给临时进程，无需手动指定</td><td>浏览器访问网页时临时占用的端口</td></tr></tbody></table>
<h4 data-id="heading-18">3.2 开发注意事项</h4>
<ul>
<li><strong>端口唯一性</strong>：同一设备上，两个应用程序不能占用同一个端口，否则会抛出<code>BindException: Address already in use</code>（地址已被占用）异常。</li>
<li><strong>端口选择建议</strong>：开发自定义应用时，优先选择<code>1024~49151</code>范围内的端口，避免与周知端口冲突。</li>
</ul>
<h3 data-id="heading-19">四、协议：网络通信的“交通规则”</h3>
<p>协议（Protocol）是设备间通信的规则集合，规定了数据的传输格式、速率、出错处理、交互逻辑等。没有协议，设备间的通信就会混乱无序（比如甲设备发送“二进制数据”，乙设备却按“文本格式”解析，必然导致数据错乱）。</p>
<h4 data-id="heading-20">4.1 两大网络模型（协议分层设计）</h4>
<p>网络协议采用分层设计，核心分为两种模型（实际开发中以TCP/IP模型为主）：</p>



































<table><thead><tr><th>OSI网络参考模型（理论标准）</th><th>TCP/IP网络模型（实际标准）</th><th>核心作用</th><th>开发者关注重点</th></tr></thead><tbody><tr><td>应用层、表示层、会话层</td><td>应用层</td><td>提供应用程序接口（如HTTP、FTP、SMTP）</td><td>开发时直接使用（如调用HTTP接口）</td></tr><tr><td>传输层</td><td>传输层</td><td>负责端到端的数据传输（TCP/UDP协议）</td><td>选择TCP或UDP协议</td></tr><tr><td>网络层</td><td>网络层</td><td>封装IP地址，实现路由转发</td><td>无需关注（由系统处理）</td></tr><tr><td>数据链路层、物理层</td><td>数据链路层+物理层</td><td>处理比特流传输（硬件层面，如网线、网卡）</td><td>无需关注（由硬件处理）</td></tr></tbody></table>
<h4 data-id="heading-21">4.2 传输层核心协议：TCP与UDP（重点）</h4>
<p>传输层有两个核心协议，适用场景截然不同，开发时需根据需求选择：</p>
<h5 data-id="heading-22">1. UDP（用户数据报协议）：追求效率，牺牲可靠性</h5>
<ul>
<li><strong>核心特点</strong>：无连接、不可靠、效率高、数据有限制。</li>
</ul>

<ul>
<li>
<ul>
<li>无连接：通信前无需建立连接，直接发送数据（类似“发短信”，无需对方确认开机即可发送）。</li>
<li>不可靠：不保证数据一定送达，数据丢失不重传，接收方也不反馈确认信息。</li>
<li>数据限制：单包数据最大64KB。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>适用场景</strong>：对实时性要求高、可容忍少量数据丢失的场景，例如：视频直播、语音通话、网络游戏、物联网数据采集。</li>
</ul>
<h5 data-id="heading-23">2. TCP（传输控制协议）：追求可靠，牺牲效率</h5>
<ul>
<li><strong>核心特点</strong>：面向连接、可靠传输、效率较低、无数据大小限制。</li>
<li><strong>可靠传输实现机制</strong>：</li>
</ul>
<ol>
<li>
<ol>
<li>三次握手：建立连接，确保双方收发能力正常（类似“打电话”：甲→“喂，能听到吗？”→乙→“能听到，你呢？”→甲→“我也能听到，开始聊吧”）。</li>
<li>数据确认：每发送一包数据，接收方需返回“ACK确认信号”，未收到则重传。</li>
<li>四次挥手：断开连接，确保双方数据都已传输完成（避免数据残留）。</li>
</ol>
</li>
</ol>
<ul>
<li><strong>适用场景</strong>：对可靠性要求高的场景，例如：网页浏览、文件下载、支付转账、邮件发送、即时通讯的文字消息。</li>
</ul>
<h3 data-id="heading-24">五、总结：网络编程的核心逻辑与学习路径</h3>
<h4 data-id="heading-25">5.1 三要素的核心逻辑</h4>
<p>网络编程的本质，是通过“三层定位”实现数据交互：</p>
<ol>
<li><strong>IP定位设备</strong>：解决“和谁通信”的问题（找到目标设备）。</li>
<li><strong>端口定位应用</strong>：解决“和对方哪个程序通信”的问题（找到设备上的目标应用）。</li>
<li><strong>协议规范传输</strong>：解决“怎么通信”的问题（确保数据正确传递）。</li>
</ol>
<h4 data-id="heading-26">5.2 后续学习路径</h4>
<p>本文讲解的是Java网络编程的基础，掌握后可进一步学习：</p>
<ol>
<li>TCP通信实战：使用<code>Socket</code>（客户端）和<code>ServerSocket</code>（服务端）实现双向通信。</li>
<li>UDP通信实战：使用<code>DatagramSocket</code>和<code>DatagramPacket</code>实现数据报传输。</li>
<li>应用层协议：学习HTTP、FTP等协议的使用（结合<code>java.net.HttpURLConnection</code>或Spring Boot开发接口）。</li>
<li>高级主题：NIO、Netty框架（高性能网络编程）、分布式通信（如RPC）。</li>
</ol>
<p>如果本文对你有帮助，欢迎点赞收藏～ 后续会持续更新Java网络编程实战教程，敬请关注！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nacos适用Postgresql改造记录]]></title>    <link>https://juejin.cn/post/7582955784569847859</link>    <guid>https://juejin.cn/post/7582955784569847859</guid>    <pubDate>2025-12-13T15:41:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582955784569847859" data-draft-id="7582905804048121883" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nacos适用Postgresql改造记录"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-13T15:41:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sptan"/> <meta itemprop="url" content="https://juejin.cn/user/2365804751362909"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nacos适用Postgresql改造记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2365804751362909/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sptan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T15:41:25.000Z" title="Sat Dec 13 2025 15:41:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>从nacos官网fork出来，采用分支为v2.x-develop。</p>
<p>fork后的git地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsptan%2Fnacos" target="_blank" title="https://github.com/sptan/nacos" ref="nofollow noopener noreferrer">github.com/sptan/nacos</a></p>
<h2 data-id="heading-0">添加postgresql依赖</h2>
<p>在项目的xml文件中全局搜索mysql，有mysql 的地方就加上postgresql的驱动。</p>
<h3 data-id="heading-1">pom.xml</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/001567295d394bbeaef29aea3ce6cd40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=muo7Xw6Q%2Fj769y78ipvN08XGxJI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c668847868247a98c2aafe21d0866c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=CMcwgsFdPUJeMaanzGFlRot%2FVY4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">persistence/pom.xml</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83fac418239441c68af0c1269e7170d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=lIlXuLq2UBUnq%2Bysg8aQirvddUg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">naming/pom.xml</h3>
<p>这个好像不引人也行，不过本着让postgresql与mysql平级的待遇，就一块加上吧。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f1f316c87664bbbb83609448a2cab04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=DvGwMmYn9oxjaqWzCfdkAwrHeyk%3D" alt="" loading="lazy"/></p>
<p>引入驱动后，代码变动情况如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02c6be23304c4e378bc43ec760ec2071~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=3La%2BfEu4QNj0tKLPiKEBNfWOW1c%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">nacos-persistence模块改造</h2>
<p>在这个模块中搜索mysql，在mysql附近增加postgresql的常量。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c6cfba317d94971b8df778828098dbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=Is9hNqGzJCwywyFLc2X2AeI885s%3D" alt="" loading="lazy"/></p>
<p>外部DataSource目前固定为mysql，需要修改为可配置。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63c95592bc034d3981820356f3528025~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=YB0fzT5PN5%2BoEVXcIQqr033z0yU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3717c30a98484d1796d466e4c6782204~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=%2FnXmQoFQgBLjE95WBsYLlyJkWLs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">nacos-plugin模块改造</h2>
<p>这是改动比较多的模块，需要加入postgresql对应的实现，我主要是从mysql复制过来的，差异比较大的主要是分页不同。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9eeb053104af42d8b33e0071a840d979~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=HHo5Sh%2FBdWJqq5XTGnKJjN2qIsI%3D" alt="" loading="lazy"/></p>
<p>DataSourceConstant的代码：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09f9bfce769a41069b0c2ede0d1e6bbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=Mh2uRzvBvdIzWLYueFgMj9W4s9E%3D" alt="" loading="lazy"/></p>
<p>TrustedPostgresqlFunctionEnum的代码</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db8b60b274664a3d866641d0c909a13c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=EwsMdchqiqPnRxBEpPdJ3BPB%2FRA%3D" alt="" loading="lazy"/></p>
<p>各个表的访问类的代码示例：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84f9e1cbae9744cc9f4e89a3933a1123~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=du32x1TL%2BP7XFW%2FqDL420XVmGpw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ff733f8f0cd4ce2b6d110ed322e62de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=VUhILW9jwRRRXm3fP2C4fqUO5sY%3D" alt="" loading="lazy"/></p>
<p>主要是记得以下几项修改：</p>
<ol>
<li>sql中的分页</li>
<li>DataSource</li>
<li>where.limit改为where.limitPG</li>
</ol>
<p>各个实现类的都雷同。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e15934fbe7c4fd0ba89bb055f467357~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=Ab%2Fa3Z%2Fz7jwC2aPPhdwyxx0BlxE%3D" alt="" loading="lazy"/></p>
<p>这个要加一下，否则Map的实现类找不到postgresql的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51c706a0a7a54705864014ade1385a0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=llm0SBIA5HB1nw2MejhlB6g97Mo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">default-auth-plugin模块改造</h2>
<ol>
<li>添加postgresql适用的OFFSET_LIMIT常量</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b778d08625845778d4e2b9a0e4e93cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=kvC5SitTPOM6dBiokEPvapILwF8%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li>增加postgresql分页适配器</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23c4139b22db4915bf609ef5d7ac7a2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=hZMTlGWREpfX75%2B7phP36OL1GAA%3D" alt="" loading="lazy"/></p>
<ol start="3">
<li>适配器工厂中增加postgresql分页适配器</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86b5c12dad704c8abc2f0c4bfeb58871~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=TdUwrQpqcceDYpJaJGMe8KtPYHE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">在PG中建立nacos数据库及表</h2>
<p>建表语句如下</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">/*
 * Copyright 1999-2018 Alibaba Group Holding Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Table structure for config_info</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> "his_config_info";
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> "his_config_info" (
  "id" int8 <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "nid" bigserial <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "data_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "group_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "app_name" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) ,
  "content" text  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "md5" <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) ,
  "gmt_create" <span class="hljs-type">timestamp</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>  <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'2010-05-05 00:00:00'</span>,
  "gmt_modified" <span class="hljs-type">timestamp</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "src_user" text ,
  "src_ip" <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) ,
  "op_type" <span class="hljs-type">char</span>(<span class="hljs-number">10</span>) ,
  "publish_type" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>),
  "gray_name" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>),
  "ext_info" text,
  "tenant_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) ,
  "encrypted_data_key" text  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
)
;

COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info"."id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info"."data_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'data_id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info"."content" <span class="hljs-keyword">IS</span> <span class="hljs-string">'content'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info"."md5" <span class="hljs-keyword">IS</span> <span class="hljs-string">'md5'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info"."gmt_create" <span class="hljs-keyword">IS</span> <span class="hljs-string">'创建时间'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info"."gmt_modified" <span class="hljs-keyword">IS</span> <span class="hljs-string">'修改时间'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info"."src_user" <span class="hljs-keyword">IS</span> <span class="hljs-string">'source user'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info"."src_ip" <span class="hljs-keyword">IS</span> <span class="hljs-string">'source ip'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info"."tenant_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'租户字段'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info"."encrypted_data_key" <span class="hljs-keyword">IS</span> <span class="hljs-string">'秘钥'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> "config_info" <span class="hljs-keyword">IS</span> <span class="hljs-string">'config_info'</span>;


<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Table structure for config_info_aggr</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> "config_info_aggr";
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> "config_info_aggr" (
  "id" bigserial <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "data_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "group_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "datum_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "content" text  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "gmt_modified" <span class="hljs-type">timestamp</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "app_name" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) ,
  "tenant_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) 
)
;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_aggr"."id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_aggr"."data_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'data_id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_aggr"."group_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'group_id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_aggr"."datum_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'datum_id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_aggr"."content" <span class="hljs-keyword">IS</span> <span class="hljs-string">'内容'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_aggr"."gmt_modified" <span class="hljs-keyword">IS</span> <span class="hljs-string">'修改时间'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_aggr"."tenant_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'租户字段'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> "config_info_aggr" <span class="hljs-keyword">IS</span> <span class="hljs-string">'增加租户字段'</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Records of config_info_aggr</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Table structure for config_info_beta</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> "config_info_beta";
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> "config_info_beta" (
  "id" bigserial <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "data_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "group_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "app_name" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) ,
  "content" text  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "beta_ips" <span class="hljs-type">varchar</span>(<span class="hljs-number">1024</span>) ,
  "md5" <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) ,
  "gmt_create" <span class="hljs-type">timestamp</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "gmt_modified" <span class="hljs-type">timestamp</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "src_user" text ,
  "src_ip" <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) ,
  "tenant_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) ,
  "encrypted_data_key" text  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
)
;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_beta"."id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_beta"."data_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'data_id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_beta"."group_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'group_id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_beta"."app_name" <span class="hljs-keyword">IS</span> <span class="hljs-string">'app_name'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_beta"."content" <span class="hljs-keyword">IS</span> <span class="hljs-string">'content'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_beta"."beta_ips" <span class="hljs-keyword">IS</span> <span class="hljs-string">'betaIps'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_beta"."md5" <span class="hljs-keyword">IS</span> <span class="hljs-string">'md5'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_beta"."gmt_create" <span class="hljs-keyword">IS</span> <span class="hljs-string">'创建时间'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_beta"."gmt_modified" <span class="hljs-keyword">IS</span> <span class="hljs-string">'修改时间'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_beta"."src_user" <span class="hljs-keyword">IS</span> <span class="hljs-string">'source user'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_beta"."src_ip" <span class="hljs-keyword">IS</span> <span class="hljs-string">'source ip'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_beta"."tenant_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'租户字段'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_beta"."encrypted_data_key" <span class="hljs-keyword">IS</span> <span class="hljs-string">'秘钥'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> "config_info_beta" <span class="hljs-keyword">IS</span> <span class="hljs-string">'config_info_beta'</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Records of config_info_beta</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Table structure for config_info_tag</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> "config_info_tag";
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> "config_info_tag" (
  "id" bigserial <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "data_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "group_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "tenant_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) ,
  "tag_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "app_name" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) ,
  "content" text  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "md5" <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) ,
  "gmt_create" <span class="hljs-type">timestamp</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "gmt_modified" <span class="hljs-type">timestamp</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "src_user" text ,
  "src_ip" <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) 
)
;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_tag"."id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_tag"."data_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'data_id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_tag"."group_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'group_id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_tag"."tenant_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'tenant_id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_tag"."tag_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'tag_id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_tag"."app_name" <span class="hljs-keyword">IS</span> <span class="hljs-string">'app_name'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_tag"."content" <span class="hljs-keyword">IS</span> <span class="hljs-string">'content'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_tag"."md5" <span class="hljs-keyword">IS</span> <span class="hljs-string">'md5'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_tag"."gmt_create" <span class="hljs-keyword">IS</span> <span class="hljs-string">'创建时间'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_tag"."gmt_modified" <span class="hljs-keyword">IS</span> <span class="hljs-string">'修改时间'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_tag"."src_user" <span class="hljs-keyword">IS</span> <span class="hljs-string">'source user'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_info_tag"."src_ip" <span class="hljs-keyword">IS</span> <span class="hljs-string">'source ip'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> "config_info_tag" <span class="hljs-keyword">IS</span> <span class="hljs-string">'config_info_tag'</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Records of config_info_tag</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Table structure for config_tags_relation</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> "config_tags_relation";
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> "config_tags_relation" (
  "id" bigserial <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "tag_name" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "tag_type" <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) ,
  "data_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "group_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "tenant_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) ,
  "nid" bigserial <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
)
;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_tags_relation"."id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_tags_relation"."tag_name" <span class="hljs-keyword">IS</span> <span class="hljs-string">'tag_name'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_tags_relation"."tag_type" <span class="hljs-keyword">IS</span> <span class="hljs-string">'tag_type'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_tags_relation"."data_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'data_id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_tags_relation"."group_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'group_id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "config_tags_relation"."tenant_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'tenant_id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> "config_tags_relation" <span class="hljs-keyword">IS</span> <span class="hljs-string">'config_tag_relation'</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Records of config_tags_relation</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Table structure for group_capacity</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> "group_capacity";
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> "group_capacity" (
  "id" bigserial <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "group_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "quota" int4 <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "usage" int4 <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "max_size" int4 <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "max_aggr_count" int4 <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "max_aggr_size" int4 <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "max_history_count" int4 <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "gmt_create" <span class="hljs-type">timestamp</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "gmt_modified" <span class="hljs-type">timestamp</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
)
;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "group_capacity"."id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'主键ID'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "group_capacity"."group_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'Group ID，空字符表示整个集群'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "group_capacity"."quota" <span class="hljs-keyword">IS</span> <span class="hljs-string">'配额，0表示使用默认值'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "group_capacity"."usage" <span class="hljs-keyword">IS</span> <span class="hljs-string">'使用量'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "group_capacity"."max_size" <span class="hljs-keyword">IS</span> <span class="hljs-string">'单个配置大小上限，单位为字节，0表示使用默认值'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "group_capacity"."max_aggr_count" <span class="hljs-keyword">IS</span> <span class="hljs-string">'聚合子配置最大个数，，0表示使用默认值'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "group_capacity"."max_aggr_size" <span class="hljs-keyword">IS</span> <span class="hljs-string">'单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "group_capacity"."max_history_count" <span class="hljs-keyword">IS</span> <span class="hljs-string">'最大变更历史数量'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "group_capacity"."gmt_create" <span class="hljs-keyword">IS</span> <span class="hljs-string">'创建时间'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "group_capacity"."gmt_modified" <span class="hljs-keyword">IS</span> <span class="hljs-string">'修改时间'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> "group_capacity" <span class="hljs-keyword">IS</span> <span class="hljs-string">'集群、各Group容量信息表'</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Records of group_capacity</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Table structure for his_config_info</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> "his_config_info";
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> "his_config_info" (
  "id" int8 <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "nid" bigserial <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "data_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "group_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "app_name" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) ,
  "content" text  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "md5" <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) ,
  "gmt_create" <span class="hljs-type">timestamp</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>  <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'2010-05-05 00:00:00'</span>,
  "gmt_modified" <span class="hljs-type">timestamp</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "src_user" text ,
  "src_ip" <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) ,
  "op_type" <span class="hljs-type">char</span>(<span class="hljs-number">10</span>) ,
  "publish_type" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>),
  "tenant_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) ,
  "encrypted_data_key" text  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
)
;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "his_config_info"."app_name" <span class="hljs-keyword">IS</span> <span class="hljs-string">'app_name'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "his_config_info"."tenant_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'租户字段'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "his_config_info"."encrypted_data_key" <span class="hljs-keyword">IS</span> <span class="hljs-string">'秘钥'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> "his_config_info" <span class="hljs-keyword">IS</span> <span class="hljs-string">'多租户改造'</span>;


<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Table structure for permissions</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> "permissions";
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> "permissions" (
  "role" <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "resource" <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "action" <span class="hljs-type">varchar</span>(<span class="hljs-number">8</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
)
;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Records of permissions</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Table structure for roles</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> "roles";
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> "roles" (
  "username" <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "role" <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
)
;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Records of roles</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> "roles" <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'nacos'</span>, <span class="hljs-string">'ROLE_ADMIN'</span>);
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Table structure for tenant_capacity</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> "tenant_capacity";
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> "tenant_capacity" (
  "id" bigserial <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "tenant_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "quota" int4 <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "usage" int4 <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "max_size" int4 <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "max_aggr_count" int4 <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "max_aggr_size" int4 <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "max_history_count" int4 <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "gmt_create" <span class="hljs-type">timestamp</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "gmt_modified" <span class="hljs-type">timestamp</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
)
;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_capacity"."id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'主键ID'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_capacity"."tenant_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'Tenant ID'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_capacity"."quota" <span class="hljs-keyword">IS</span> <span class="hljs-string">'配额，0表示使用默认值'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_capacity"."usage" <span class="hljs-keyword">IS</span> <span class="hljs-string">'使用量'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_capacity"."max_size" <span class="hljs-keyword">IS</span> <span class="hljs-string">'单个配置大小上限，单位为字节，0表示使用默认值'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_capacity"."max_aggr_count" <span class="hljs-keyword">IS</span> <span class="hljs-string">'聚合子配置最大个数'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_capacity"."max_aggr_size" <span class="hljs-keyword">IS</span> <span class="hljs-string">'单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_capacity"."max_history_count" <span class="hljs-keyword">IS</span> <span class="hljs-string">'最大变更历史数量'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_capacity"."gmt_create" <span class="hljs-keyword">IS</span> <span class="hljs-string">'创建时间'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_capacity"."gmt_modified" <span class="hljs-keyword">IS</span> <span class="hljs-string">'修改时间'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> "tenant_capacity" <span class="hljs-keyword">IS</span> <span class="hljs-string">'租户容量信息表'</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Records of tenant_capacity</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Table structure for tenant_info</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> "tenant_info";
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> "tenant_info" (
  "id" bigserial <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "kp" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "tenant_id" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) ,
  "tenant_name" <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) ,
  "tenant_desc" <span class="hljs-type">varchar</span>(<span class="hljs-number">256</span>) ,
  "create_source" <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) ,
  "gmt_create" int8 <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "gmt_modified" int8 <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
)
;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_info"."id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_info"."kp" <span class="hljs-keyword">IS</span> <span class="hljs-string">'kp'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_info"."tenant_id" <span class="hljs-keyword">IS</span> <span class="hljs-string">'tenant_id'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_info"."tenant_name" <span class="hljs-keyword">IS</span> <span class="hljs-string">'tenant_name'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_info"."tenant_desc" <span class="hljs-keyword">IS</span> <span class="hljs-string">'tenant_desc'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_info"."create_source" <span class="hljs-keyword">IS</span> <span class="hljs-string">'create_source'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_info"."gmt_create" <span class="hljs-keyword">IS</span> <span class="hljs-string">'创建时间'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> "tenant_info"."gmt_modified" <span class="hljs-keyword">IS</span> <span class="hljs-string">'修改时间'</span>;
COMMENT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> "tenant_info" <span class="hljs-keyword">IS</span> <span class="hljs-string">'tenant_info'</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Records of tenant_info</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Table structure for users</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> "users";
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> "users" (
  "username" <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "password" <span class="hljs-type">varchar</span>(<span class="hljs-number">500</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  "enabled" <span class="hljs-type">boolean</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
)
;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Records of users</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> "users" <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'nacos'</span>, <span class="hljs-string">'$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu'</span>, <span class="hljs-literal">TRUE</span>);
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Indexes structure for table config_info</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX "uk_configinfo_datagrouptenant" <span class="hljs-keyword">ON</span> "config_info" ("data_id","group_id","tenant_id");

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Primary Key structure for table config_info</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> "config_info" <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> "config_info_pkey" <span class="hljs-keyword">PRIMARY</span> KEY ("id");

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Indexes structure for table config_info_aggr</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX "uk_configinfoaggr_datagrouptenantdatum" <span class="hljs-keyword">ON</span> "config_info_aggr" <span class="hljs-keyword">USING</span> btree ("data_id","group_id","tenant_id","datum_id");

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Primary Key structure for table config_info_aggr</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> "config_info_aggr" <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> "config_info_aggr_pkey" <span class="hljs-keyword">PRIMARY</span> KEY ("id");

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Indexes structure for table config_info_beta</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX "uk_configinfobeta_datagrouptenant" <span class="hljs-keyword">ON</span> "config_info_beta" <span class="hljs-keyword">USING</span> btree ("data_id","group_id","tenant_id");

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Primary Key structure for table config_info_beta</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> "config_info_beta" <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> "config_info_beta_pkey" <span class="hljs-keyword">PRIMARY</span> KEY ("id");

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Indexes structure for table config_info_tag</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX "uk_configinfotag_datagrouptenanttag" <span class="hljs-keyword">ON</span> "config_info_tag" <span class="hljs-keyword">USING</span> btree ("data_id","group_id","tenant_id","tag_id");

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Primary Key structure for table config_info_tag</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> "config_info_tag" <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> "config_info_tag_pkey" <span class="hljs-keyword">PRIMARY</span> KEY ("id");

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Indexes structure for table config_tags_relation</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">CREATE</span> INDEX "idx_tenant_id" <span class="hljs-keyword">ON</span> "config_tags_relation" <span class="hljs-keyword">USING</span> btree (
  "tenant_id"
);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX "uk_configtagrelation_configidtag" <span class="hljs-keyword">ON</span> "config_tags_relation" <span class="hljs-keyword">USING</span> btree (
  "id",
  "tag_name",
  "tag_type"
);

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Primary Key structure for table config_tags_relation</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> "config_tags_relation" <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> "config_tags_relation_pkey" <span class="hljs-keyword">PRIMARY</span> KEY ("nid");

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Indexes structure for table group_capacity</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX "uk_group_id" <span class="hljs-keyword">ON</span> "group_capacity" <span class="hljs-keyword">USING</span> btree (
  "group_id"
);

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Primary Key structure for table group_capacity</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> "group_capacity" <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> "group_capacity_pkey" <span class="hljs-keyword">PRIMARY</span> KEY ("id");

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Indexes structure for table his_config_info</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">CREATE</span> INDEX "idx_did" <span class="hljs-keyword">ON</span> "his_config_info" <span class="hljs-keyword">USING</span> btree (
  "data_id"
);
<span class="hljs-keyword">CREATE</span> INDEX "idx_gmt_create" <span class="hljs-keyword">ON</span> "his_config_info" <span class="hljs-keyword">USING</span> btree (
  "gmt_create"
);
<span class="hljs-keyword">CREATE</span> INDEX "idx_gmt_modified" <span class="hljs-keyword">ON</span> "his_config_info" <span class="hljs-keyword">USING</span> btree (
  "gmt_modified"
);

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Primary Key structure for table his_config_info</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> "his_config_info" <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> "his_config_info_pkey" <span class="hljs-keyword">PRIMARY</span> KEY ("nid");

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Indexes structure for table permissions</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX "uk_role_permission" <span class="hljs-keyword">ON</span> "permissions" <span class="hljs-keyword">USING</span> btree (
  "role",
  "resource",
  "action"
);

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Indexes structure for table roles</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX "uk_username_role" <span class="hljs-keyword">ON</span> "roles" <span class="hljs-keyword">USING</span> btree (
  "username",
  "role"
);

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Indexes structure for table tenant_capacity</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX "uk_tenant_id" <span class="hljs-keyword">ON</span> "tenant_capacity" <span class="hljs-keyword">USING</span> btree (
  "tenant_id"
);

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Primary Key structure for table tenant_capacity</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> "tenant_capacity" <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> "tenant_capacity_pkey" <span class="hljs-keyword">PRIMARY</span> KEY ("id");

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Indexes structure for table tenant_info</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX "uk_tenant_info_kptenantid" <span class="hljs-keyword">ON</span> "tenant_info" <span class="hljs-keyword">USING</span> btree (
  "kp",
  "tenant_id"
);
</code></pre>
<p>上面的SQL是官方的，莫名没有config_info_gray的表结构，我添加一个：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- auto-generated definition</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> config_info_gray
(
    id                 serial
        <span class="hljs-keyword">primary</span> key,
    data_id            <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)                           <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,
    group_id           <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>)                           <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,
    content            text                                   <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,
    md5                <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>)  <span class="hljs-keyword">default</span> <span class="hljs-keyword">NULL</span>::<span class="hljs-type">character</span> <span class="hljs-type">varying</span>,
    src_user           text,
    src_ip             <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">default</span> <span class="hljs-keyword">NULL</span>::<span class="hljs-type">character</span> <span class="hljs-type">varying</span>,
    gmt_create         <span class="hljs-type">timestamp</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">default</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,
    gmt_modified       <span class="hljs-type">timestamp</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">default</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,
    app_name           <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">default</span> <span class="hljs-keyword">NULL</span>::<span class="hljs-type">character</span> <span class="hljs-type">varying</span>,
    tenant_id          <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">default</span> <span class="hljs-string">''</span>::<span class="hljs-type">character</span> <span class="hljs-type">varying</span>,
    gray_name          <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>)                           <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,
    gray_rule          text                                   <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,
    encrypted_data_key <span class="hljs-type">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">default</span> <span class="hljs-string">''</span>::<span class="hljs-type">character</span> <span class="hljs-type">varying</span>
);

comment <span class="hljs-keyword">on</span> <span class="hljs-keyword">table</span> config_info_gray <span class="hljs-keyword">is</span> <span class="hljs-string">'config_info_gray'</span>;

<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> config_info_gray
    owner <span class="hljs-keyword">to</span> liupeng;

<span class="hljs-keyword">create</span> <span class="hljs-keyword">unique</span> index uk_configinfogray_datagrouptenantgray
    <span class="hljs-keyword">on</span> config_info_gray (data_id, group_id, tenant_id, gray_name);

<span class="hljs-keyword">create</span> index idx_configinfogray_dataid_gmt_modified
    <span class="hljs-keyword">on</span> config_info_gray (data_id, gmt_modified);

<span class="hljs-keyword">create</span> index idx_configinfogray_gmt_modified
    <span class="hljs-keyword">on</span> config_info_gray (gmt_modified);
</code></pre>
<h2 data-id="heading-8">IDE中运行看效果</h2>
<p>Nacos主类在nacos-console模块中</p>
<p>修改application.properties配置文件</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">#</span>
<span class="hljs-comment"># Copyright 1999-2018 Alibaba Group Holding Ltd.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Licensed under the Apache License, Version 2.0 (the "License");</span>
<span class="hljs-comment"># you may not use this file except in compliance with the License.</span>
<span class="hljs-comment"># You may obtain a copy of the License at</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Unless required by applicable law or agreed to in writing, software</span>
<span class="hljs-comment"># distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="hljs-comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="hljs-comment"># See the License for the specific language governing permissions and</span>
<span class="hljs-comment"># limitations under the License.</span>
<span class="hljs-comment">#</span>

<span class="hljs-comment">#*************** Spring Boot Related Configurations ***************#</span>
<span class="hljs-comment">### Default web context path:</span>
<span class="hljs-attr">server.servlet.contextPath</span>=/nacos
<span class="hljs-comment">### Include message field</span>
<span class="hljs-attr">server.error.include-message</span>=ALWAYS
<span class="hljs-comment">### Default web server port:</span>
<span class="hljs-attr">server.port</span>=<span class="hljs-number">8848</span>

<span class="hljs-comment">#*************** Network Related Configurations ***************#</span>
<span class="hljs-comment">### If prefer hostname over ip for Nacos server addresses in cluster.conf:</span>
<span class="hljs-comment"># nacos.inetutils.prefer-hostname-over-ip=false</span>

<span class="hljs-comment">### Specify local server's IP:</span>
<span class="hljs-comment"># nacos.inetutils.ip-address=</span>

<span class="hljs-comment">#*************** Config Module Related Configurations ***************#</span>
<span class="hljs-comment">### Deprecated configuration property, it is recommended to use `spring.sql.init.platform` replaced.</span>
<span class="hljs-comment">#spring.datasource.platform=postgresql</span>
<span class="hljs-comment"># nacos.plugin.datasource.log.enabled=true</span>
<span class="hljs-attr">spring.sql.init.platform</span>=postgresql
<span class="hljs-comment">### Count of DB:</span>
<span class="hljs-attr">db.num</span>=<span class="hljs-number">1</span>

<span class="hljs-comment">### Connect URL of DB:</span>
<span class="hljs-comment"># db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span>
<span class="hljs-comment"># db.user=nacos</span>
<span class="hljs-comment"># db.password=nacos</span>

<span class="hljs-attr">db.url.0</span>=jdbc:postgresql://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">5432</span>/nacos
<span class="hljs-attr">db.user</span>=liupeng
<span class="hljs-attr">db.password</span>=<span class="hljs-number">123456</span>

<span class="hljs-comment">### Connection pool configuration: hikariCP</span>
<span class="hljs-attr">db.pool.config.driverClassName</span>=org.postgresql.Driver
<span class="hljs-attr">db.pool.config.connectionTimeout</span>=<span class="hljs-number">30000</span>
<span class="hljs-attr">db.pool.config.validationTimeout</span>=<span class="hljs-number">10000</span>
<span class="hljs-attr">db.pool.config.maximumPoolSize</span>=<span class="hljs-number">20</span>
<span class="hljs-attr">db.pool.config.minimumIdle</span>=<span class="hljs-number">2</span>

<span class="hljs-comment">### the maximum retry times for push</span>
<span class="hljs-attr">nacos.config.push.maxRetryTime</span>=<span class="hljs-number">50</span>

<span class="hljs-comment">#*************** Naming Module Related Configurations ***************#</span>
<span class="hljs-comment">### Data dispatch task execution period in milliseconds:</span>

<span class="hljs-comment">### If enable data warmup. If set to false, the server would accept request without local data preparation:</span>
<span class="hljs-comment"># nacos.naming.data.warmup=true</span>

<span class="hljs-comment">### If enable the instance auto expiration, kind like of health check of instance:</span>
<span class="hljs-comment"># nacos.naming.expireInstance=true</span>

<span class="hljs-attr">nacos.naming.empty-service.auto-clean</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">nacos.naming.empty-service.clean.initial-delay-ms</span>=<span class="hljs-number">50000</span>
<span class="hljs-attr">nacos.naming.empty-service.clean.period-time-ms</span>=<span class="hljs-number">30000</span>


<span class="hljs-comment">#*************** CMDB Module Related Configurations ***************#</span>
<span class="hljs-comment">### The interval to dump external CMDB in seconds:</span>
<span class="hljs-comment"># nacos.cmdb.dumpTaskInterval=3600</span>

<span class="hljs-comment">### The interval of polling data change event in seconds:</span>
<span class="hljs-comment"># nacos.cmdb.eventTaskInterval=10</span>

<span class="hljs-comment">### The interval of loading labels in seconds:</span>
<span class="hljs-comment"># nacos.cmdb.labelTaskInterval=300</span>

<span class="hljs-comment">### If turn on data loading task:</span>
<span class="hljs-comment"># nacos.cmdb.loadDataAtStart=false</span>
<span class="hljs-attr">nacos.inetutils.ip-address</span>=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>
<span class="hljs-attr">nacos.inetutils.prefer-ip-address</span>=<span class="hljs-literal">true</span>

<span class="hljs-comment">#*************** Metrics Related Configurations ***************#</span>
<span class="hljs-comment">### Metrics for prometheus</span>
<span class="hljs-comment">#management.endpoints.web.exposure.include=*</span>

<span class="hljs-comment">### Metrics for elastic search</span>
<span class="hljs-attr">management.metrics.export.elastic.enabled</span>=<span class="hljs-literal">false</span>
<span class="hljs-comment">#management.metrics.export.elastic.host=http://localhost:9200</span>

<span class="hljs-comment">### Metrics for influx</span>
<span class="hljs-attr">management.metrics.export.influx.enabled</span>=<span class="hljs-literal">false</span>
<span class="hljs-comment">#management.metrics.export.influx.db=springboot</span>
<span class="hljs-comment">#management.metrics.export.influx.uri=http://localhost:8086</span>
<span class="hljs-comment">#management.metrics.export.influx.auto-create-db=true</span>
<span class="hljs-comment">#management.metrics.export.influx.consistency=one</span>
<span class="hljs-comment">#management.metrics.export.influx.compressed=true</span>

<span class="hljs-comment">#*************** Access Log Related Configurations ***************#</span>
<span class="hljs-comment">### If turn on the access log:</span>
<span class="hljs-attr">server.tomcat.accesslog.enabled</span>=<span class="hljs-literal">true</span>

<span class="hljs-comment">### accesslog automatic cleaning time</span>
<span class="hljs-attr">server.tomcat.accesslog.max-days</span>=<span class="hljs-number">30</span>

<span class="hljs-comment">### The access log pattern:</span>
<span class="hljs-attr">server.tomcat.accesslog.pattern</span>=%h %l %u %t <span class="hljs-string">"%r"</span> %s %b %D %{User-Agent}i %{Request-Source}i

<span class="hljs-comment">### The directory of access log:</span>
<span class="hljs-attr">server.tomcat.basedir</span>=file:.


<span class="hljs-comment">#*************** Access Control Related Configurations ***************#</span>
<span class="hljs-comment">### If enable spring security, this option is deprecated in 1.2.0:</span>
<span class="hljs-comment">#spring.security.enabled=false</span>
<span class="hljs-comment">### The ignore urls of auth, is deprecated in 1.2.0:</span>
<span class="hljs-attr">nacos.security.ignore.urls</span>=/,/error,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.ico,/console-ui/public/**,/v1/auth/**,/v1/console/health/**,/actuator/**,/v1/console/server/**

<span class="hljs-comment">### The auth system to use, currently only 'nacos' and 'ldap' is supported:</span>
<span class="hljs-attr">nacos.core.auth.system.type</span>=nacos

<span class="hljs-comment">### If turn on auth system:</span>
<span class="hljs-attr">nacos.core.auth.enabled</span>=<span class="hljs-literal">true</span>

<span class="hljs-comment">### Turn on/off caching of auth information. By turning on this switch, the update of auth information would have a 15 seconds delay.</span>
<span class="hljs-attr">nacos.core.auth.caching.enabled</span>=<span class="hljs-literal">false</span>

<span class="hljs-comment">### Since 1.4.1, Turn on/off white auth for user-agent: nacos-server, only for upgrade from old version.</span>
<span class="hljs-attr">nacos.core.auth.enable.userAgentAuthWhite</span>=<span class="hljs-literal">false</span>

<span class="hljs-comment">### Since 1.4.1, worked when nacos.core.auth.enabled=true and nacos.core.auth.enable.userAgentAuthWhite=false.</span>
<span class="hljs-comment">### The two properties is the white list for auth and used by identity the request from other server.</span>
<span class="hljs-attr">nacos.core.auth.server.identity.key</span>=nacos
<span class="hljs-attr">nacos.core.auth.server.identity.value</span>=nacos

<span class="hljs-comment">### worked when nacos.core.auth.system.type=nacos</span>
<span class="hljs-comment">### The token expiration in seconds:</span>
<span class="hljs-attr">nacos.core.auth.plugin.nacos.token.cache.enable</span>=<span class="hljs-literal">false</span>
<span class="hljs-attr">nacos.core.auth.plugin.nacos.token.expire.seconds</span>=<span class="hljs-number">18000</span>
<span class="hljs-comment">### The default token (Base64 string):</span>
<span class="hljs-attr">nacos.core.auth.plugin.nacos.token.secret.key</span>=SecretKey012345678901234567890123456789012345678901234567890123456789
<span class="hljs-comment">#nacos.core.auth.plugin.nacos.token.secret.key=</span>

<span class="hljs-comment">### worked when nacos.core.auth.system.type=ldapï¼{0} is Placeholder,replace login username</span>
<span class="hljs-comment">#nacos.core.auth.ldap.url=ldap://localhost:389</span>
<span class="hljs-comment">#nacos.core.auth.ldap.basedc=dc=example,dc=org</span>
<span class="hljs-comment">#nacos.core.auth.ldap.userDn=cn=admin,${nacos.core.auth.ldap.basedc}</span>
<span class="hljs-comment">#nacos.core.auth.ldap.password=admin</span>
<span class="hljs-comment">#nacos.core.auth.ldap.userdn=cn={0},dc=example,dc=org</span>
<span class="hljs-comment">#nacos.core.auth.ldap.filter.prefix=uid</span>
<span class="hljs-comment">#nacos.core.auth.ldap.case.sensitive=true</span>
<span class="hljs-comment">#nacos.core.auth.ldap.ignore.partial.result.exception=false</span>

<span class="hljs-comment">#*************** Control Plugin Related Configurations ***************#</span>
<span class="hljs-comment"># plugin type</span>
<span class="hljs-comment">#nacos.plugin.control.manager.type=nacos</span>

<span class="hljs-comment"># local control rule storage dir, default ${nacos.home}/data/connection and ${nacos.home}/data/tps</span>
<span class="hljs-comment">#nacos.plugin.control.rule.local.basedir=${nacos.home}</span>

<span class="hljs-comment"># external control rule storage type, if exist</span>
<span class="hljs-comment">#nacos.plugin.control.rule.external.storage=</span>

<span class="hljs-comment">#*************** Config Change Plugin Related Configurations ***************#</span>
<span class="hljs-comment"># webhook</span>
<span class="hljs-comment">#nacos.core.config.plugin.webhook.enabled=false</span>
<span class="hljs-comment"># It is recommended to use EB https://help.aliyun.com/document_detail/413974.html</span>
<span class="hljs-comment">#nacos.core.config.plugin.webhook.url=http://localhost:8080/webhook/send?token=***</span>
<span class="hljs-comment"># The content push max capacity ,byte</span>
<span class="hljs-comment">#nacos.core.config.plugin.webhook.contentMaxCapacity=102400</span>

<span class="hljs-comment"># whitelist</span>
<span class="hljs-comment">#nacos.core.config.plugin.whitelist.enabled=false</span>
<span class="hljs-comment"># The import file suffixs</span>
<span class="hljs-comment">#nacos.core.config.plugin.whitelist.suffixs=xml,text,properties,yaml,html</span>
<span class="hljs-comment"># fileformatcheck,which validate the import file of type and content</span>
<span class="hljs-comment">#nacos.core.config.plugin.fileformatcheck.enabled=false</span>

<span class="hljs-comment">#*************** Istio Related Configurations ***************#</span>
<span class="hljs-comment">### If turn on the MCP server:</span>
<span class="hljs-attr">nacos.istio.mcp.server.enabled</span>=<span class="hljs-literal">false</span>



<span class="hljs-comment">###*************** Add from 1.3.0 ***************###</span>


<span class="hljs-comment">#*************** Core Related Configurations ***************#</span>

<span class="hljs-comment">### set the WorkerID manually</span>
<span class="hljs-comment"># nacos.core.snowflake.worker-id=</span>

<span class="hljs-comment">### Member-MetaData</span>
<span class="hljs-comment"># nacos.core.member.meta.site=</span>
<span class="hljs-comment"># nacos.core.member.meta.adweight=</span>
<span class="hljs-comment"># nacos.core.member.meta.weight=</span>

<span class="hljs-comment">### MemberLookup</span>
<span class="hljs-comment">### Addressing pattern category, If set, the priority is highest</span>
<span class="hljs-comment"># nacos.core.member.lookup.type=[file,address-server]</span>
<span class="hljs-comment">## Set the cluster list with a configuration file or command-line argument</span>
<span class="hljs-comment"># nacos.member.list=192.168.16.101:8847?raft_port=8807,192.168.16.101?raft_port=8808,192.168.16.101:8849?raft_port=8809</span>
<span class="hljs-comment">## for AddressServerMemberLookup</span>
<span class="hljs-comment"># Maximum number of retries to query the address server upon initialization</span>
<span class="hljs-comment"># nacos.core.address-server.retry=5</span>
<span class="hljs-comment">## Server domain name address of [address-server] mode</span>
<span class="hljs-comment"># address.server.domain=jmenv.tbsite.net</span>
<span class="hljs-comment">## Server port of [address-server] mode</span>
<span class="hljs-comment"># address.server.port=8080</span>
<span class="hljs-comment">## Request address of [address-server] mode</span>
<span class="hljs-comment"># address.server.url=/nacos/serverlist</span>

<span class="hljs-comment">#*************** JRaft Related Configurations ***************#</span>

<span class="hljs-comment">### Sets the Raft cluster election timeout, default value is 5 second</span>
<span class="hljs-comment"># nacos.core.protocol.raft.data.election_timeout_ms=5000</span>
<span class="hljs-comment">### Sets the amount of time the Raft snapshot will execute periodically, default is 30 minute</span>
<span class="hljs-comment"># nacos.core.protocol.raft.data.snapshot_interval_secs=30</span>
<span class="hljs-comment">### raft internal worker threads</span>
<span class="hljs-comment"># nacos.core.protocol.raft.data.core_thread_num=8</span>
<span class="hljs-comment">### Number of threads required for raft business request processing</span>
<span class="hljs-comment"># nacos.core.protocol.raft.data.cli_service_thread_num=4</span>
<span class="hljs-comment">### raft linear read strategy. Safe linear reads are used by default, that is, the Leader tenure is confirmed by heartbeat</span>
<span class="hljs-comment"># nacos.core.protocol.raft.data.read_index_type=ReadOnlySafe</span>
<span class="hljs-comment">### rpc request timeout, default 5 seconds</span>
<span class="hljs-comment"># nacos.core.protocol.raft.data.rpc_request_timeout_ms=5000</span>
<span class="hljs-comment">### enable to support prometheus service discovery</span>
<span class="hljs-comment">#nacos.prometheus.metrics.enabled=true</span>

<span class="hljs-comment">#*************** TLS Configuration ***************#</span>
<span class="hljs-comment">#nacos.remote.server.rpc.tls.enableTls=true</span>
<span class="hljs-comment">#nacos.remote.server.rpc.tls.certChainFile=file:{path of cert}</span>
<span class="hljs-comment">#nacos.remote.server.rpc.tls.certPrivateKey=file:{path of private key}</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db8efa5fbdce4c6c9c8664f930fbe25e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3B0YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766245285&amp;x-signature=ds7XQII%2B0JTmADrxrOCbwHEaZVU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">打包</h2>
<p>运行测试没有问题后，可以打包了。</p>
<pre><code class="hljs">mvn clean -Prelease-nacos  install -U -DskipTests
</code></pre>
<p>生成好的包可以在这里下载</p>
<p>链接: <a href="https://link.juejin.cn?target=https%3A%2F%2Fpan.baidu.com%2Fs%2F1DaV2Q8kt8PNU1PsZNv3ZBg%3Fpwd%3Drrsa" target="_blank" title="https://pan.baidu.com/s/1DaV2Q8kt8PNU1PsZNv3ZBg?pwd=rrsa" ref="nofollow noopener noreferrer">pan.baidu.com/s/1DaV2Q8kt…</a> 提取码: rrsa</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别“CV工程师”：手把手教你设计一套 B 端低代码 DSL]]></title>    <link>https://juejin.cn/post/7582813955213672489</link>    <guid>https://juejin.cn/post/7582813955213672489</guid>    <pubDate>2025-12-13T12:28:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582813955213672489" data-draft-id="7582857981894672425" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别“CV工程师”：手把手教你设计一套 B 端低代码 DSL"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-13T12:28:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狂胤"/> <meta itemprop="url" content="https://juejin.cn/user/1390253772899143"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别“CV工程师”：手把手教你设计一套 B 端低代码 DSL
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1390253772899143/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狂胤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T12:28:09.000Z" title="Sat Dec 13 2025 12:28:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文内容引用 哲玄-大前端全栈实践</p>
</blockquote>
<h2 data-id="heading-0">1. 咱们的痛点：为什么天天在写重复代码？</h2>
<p>兄弟们，做 B 端后台开发的日常是不是这样的？ 早上来了，产品经理说：“加个用户管理页面。” 你想了想：</p>
<ol>
<li>写个 Router 路由。</li>
<li>画个 Search Bar（搜索栏），里面放 Input 和 Select。</li>
<li>画个 Table（表格），搞定分页逻辑。</li>
<li>搞个 Dialog（弹窗），写表单验证。</li>
<li>调 API，绑定数据……</li>
</ol>
<p>下午，产品经理又来了：“再加个订单管理页面。” 你一看，<strong>这特么跟上午那个页面长得有 90% 是一样的啊！</strong> 只是字段从“用户名”变成了“订单号”，接口换了一个而已。</p>
<p>于是，我们变成了毫无感情的 <strong>Ctrl+C / Ctrl+V 机器</strong>。</p>
<p><strong>这套 DSL 的设计初衷就是：</strong> 把那 <strong>80% 重复的</strong>“头部、侧边栏、搜索、表格”抽象成 JSON 配置；剩下的 <strong>20% 复杂的</strong>逻辑，留给你去挥洒才华。</p>
<hr/>
<p><strong>先附上图和完整的DSL配置</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97cff2117b8c4060a65a71e53f467ade~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54uC6IOk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766233689&amp;x-signature=KLHSiWMsn6W51YBDGdrxmPOLthQ%3D" alt="微信图片_20251213192851_15_67.jpg" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-string">"mode"</span>: <span class="hljs-string">"dashboard"</span>,
  <span class="hljs-comment">// 头部菜单</span>
  <span class="hljs-string">"menu"</span>: [{
    <span class="hljs-comment">// 菜单唯一描述</span>
    <span class="hljs-string">"key"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-comment">// 菜单name</span>
    <span class="hljs-string">"name"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-comment">// 菜单类型 group分组 / module</span>
    <span class="hljs-string">"menuType"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-comment">// 子菜单 当menuType为group时有效</span>
    <span class="hljs-string">"subMenu"</span>: [{

    }, ...],
    <span class="hljs-comment">// 菜单行为,当menuType为module时有效。 枚举值：iframe / custom / schema / sider</span>
    <span class="hljs-string">"moduleType"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-comment">// 当moduleType为sider时有效</span>
    <span class="hljs-attr">siderConfig</span>:{
      <span class="hljs-attr">menu</span>:[{},...]
    },
    <span class="hljs-comment">// 当moduleType为iframe时有效</span>
    <span class="hljs-attr">iframeConfig</span>: {
      <span class="hljs-attr">path</span>: <span class="hljs-string">""</span>, <span class="hljs-comment">// iframe地址</span>
    },
    <span class="hljs-comment">// 当moduleType为custom时有效</span>
    <span class="hljs-attr">customConfig</span>: {
      <span class="hljs-attr">path</span>: <span class="hljs-string">""</span> <span class="hljs-comment">// 自定义路由路径</span>
    },
    <span class="hljs-comment">// 当moduleType为schema时有效</span>
    <span class="hljs-attr">schemaConfig</span>: {
      <span class="hljs-attr">api</span>: <span class="hljs-string">""</span>, <span class="hljs-comment">// 数据源api地址,遵循restful风格</span>
      <span class="hljs-comment">// json-schema描述</span>
      <span class="hljs-attr">schema</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">"object"</span>,
        <span class="hljs-attr">properties</span>: {
          <span class="hljs-attr">key</span>: {
            ...schema, <span class="hljs-comment">//标准json-schema描述</span>
            <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,<span class="hljs-comment">// 字段类型</span>
            <span class="hljs-attr">label</span>: <span class="hljs-string">"字段名称"</span>,<span class="hljs-comment">// 字段名称</span>
            <span class="hljs-comment">// 字段在table中的配置</span>
            <span class="hljs-attr">tableOption</span>:{
              ...elTableColumnConfig, <span class="hljs-comment">// 标准el-table-column配置</span>
              <span class="hljs-attr">tofixed</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// 数字类型时的小数位数</span>
              <span class="hljs-attr">visible</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 是否在table中显示</span>
            },
            <span class="hljs-comment">// 字段在search-bar中的配置</span>
            <span class="hljs-attr">searchOption</span>:{
              ...elComponentConfig, <span class="hljs-comment">// 标准el-component-column组件配置</span>
              <span class="hljs-attr">comType</span>:<span class="hljs-string">''</span>, <span class="hljs-comment">// 配置组件类型 input/select/dynamicSelect/date-picker/date-range等</span>
              <span class="hljs-attr">default</span>:<span class="hljs-string">''</span>, <span class="hljs-comment">// 默认值</span>
              <span class="hljs-comment">// comType为select生效</span>
              <span class="hljs-attr">enumList</span>:[
                {
                  <span class="hljs-attr">label</span>:<span class="hljs-string">''</span>,
                  <span class="hljs-attr">value</span>:<span class="hljs-string">''</span>
                }
              ],
              <span class="hljs-comment">// comType为dynamicSelect生效</span>
              <span class="hljs-attr">api</span>:<span class="hljs-string">''</span>
            }
            
          },
          ...
        },
      },
      <span class="hljs-attr">tableConfig</span>: {
        <span class="hljs-attr">headerButtons</span>: [
          {
            <span class="hljs-attr">label</span>:<span class="hljs-string">''</span>, <span class="hljs-comment">// 按钮名称</span>
            <span class="hljs-attr">eventKey</span>:<span class="hljs-string">''</span>, <span class="hljs-comment">// 按钮事件名</span>
            <span class="hljs-attr">eventOption</span>:{
               <span class="hljs-comment">// 按钮事件参数配置</span>
              <span class="hljs-attr">params</span>:{
                <span class="hljs-string">"paramsKey"</span>:<span class="hljs-string">"schema::fieldKey"</span> <span class="hljs-comment">// schema:: 开头表示取schema中的字段值</span>
              }
            }, <span class="hljs-comment">// 按钮事件配置</span>
            ...elButtonConfig, <span class="hljs-comment">// 标准el-button配置</span>
          }
        ],
        <span class="hljs-attr">rowButtons</span>: [
          {
            <span class="hljs-attr">label</span>:<span class="hljs-string">''</span>, <span class="hljs-comment">// 按钮名称</span>
            <span class="hljs-attr">eventKey</span>:<span class="hljs-string">''</span>, <span class="hljs-comment">// 按钮事件名</span>
            <span class="hljs-attr">eventOption</span>:{}, <span class="hljs-comment">// 按钮事件配置</span>
            ...elButtonConfig, <span class="hljs-comment">// 标准el-button配置</span>
          }
        ]
      }, <span class="hljs-comment">// table相关配置</span>
      <span class="hljs-attr">searchConfig</span>: {}, <span class="hljs-comment">// 搜索相关配置</span>
      <span class="hljs-attr">components</span>: {}, <span class="hljs-comment">// 模块组件</span>
    }, ...]
}
</code></pre>
<h2 data-id="heading-1">2. 宏观架构：像“搭积木”一样组装页面</h2>
<p>先看这张架构大图，别被吓到了，其实它就讲了两件事： <strong>“怎么配”</strong> 和 <strong>“怎么染”</strong> 。</p>
<h3 data-id="heading-2">2.1 底座：BFF Server 的“继承大法”</h3>
<p>看架构图的最底下（红色虚线框区域）。 我们借鉴了面向对象的思想。比如你要做一个“电商后台”：</p>
<ul>
<li><strong>领域模型（基类）</strong> ：我们定义好一套所有页面通用的规则。比如，所有表格默认都有“创建时间”，所有搜索栏默认都有“重置”按钮。</li>
<li><strong>项目配置（子类）</strong> ：具体到“订单管理”页面时，你只需要继承基类，然后说“我要加个订单金额字段”。</li>
</ul>
<p><strong>好处？</strong> 修改基类，一百个页面同时生效，不用一个个文件去改。</p>
<h3 data-id="heading-3">2.2 页面骨架：路由分发与组件分工</h3>
<p>看中间蓝色的区域，它在工程实现上其实就是一套<strong>精心设计的 Vue Router 配置</strong>。</p>
<p>我们没有写死页面，而是预先定义好了几个“核心容器组件”（View），就像这是几辆不同功能的“车”，JSON 数据就是“乘客”，路由决定了把乘客装进哪辆车里。</p>
<p>来看看这段核心路由代码：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Dashboard</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./dashboard.vue"</span>;
<span class="hljs-keyword">import</span> boot <span class="hljs-keyword">from</span> <span class="hljs-string">"@/boot"</span>;

<span class="hljs-comment">// 1. 定义“引擎”列表：这里就是我们的策略库</span>
<span class="hljs-keyword">const</span> componentList = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">"iframe"</span>, <span class="hljs-comment">// 对应 moduleType: iframe</span>
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"./complex-view/iframe-view/iframe-view.vue"</span>),
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">"schema"</span>, <span class="hljs-comment">// 对应 moduleType: schema（核心低代码页）</span>
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"./complex-view/schema-view/schema-view.vue"</span>),
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">"todo"</span>,   <span class="hljs-comment">// 待办/自定义页</span>
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"./todo/todo.vue"</span>),
  },
];

<span class="hljs-comment">// 2. 动态生成扁平路由</span>
<span class="hljs-keyword">const</span> routes = componentList.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> ({
  <span class="hljs-attr">path</span>: <span class="hljs-string">`/view/dashboard/<span class="hljs-subst">${item.path}</span>`</span>,
  <span class="hljs-attr">component</span>: item.<span class="hljs-property">component</span>,
}));

<span class="hljs-comment">// 3. 侧边栏布局（Sider Layout）策略</span>
<span class="hljs-comment">// 如果配置了侧边栏，就让 sider-view 作为父路由，把 componentList 作为子路由嵌套进去</span>
routes.<span class="hljs-title function_">push</span>({
  <span class="hljs-attr">path</span>: <span class="hljs-string">"/view/dashboard/sider"</span>,
  <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"./complex-view/sider-view/sider-view.vue"</span>),
  <span class="hljs-attr">children</span>: componentList,
});

<span class="hljs-comment">// 4. 侧边栏兜底策略（Wildcard Route）</span>
<span class="hljs-comment">// 处理多级深层菜单的情况，保证 url 即使很长也能匹配到 sider 布局</span>
routes.<span class="hljs-title function_">push</span>({
  <span class="hljs-attr">path</span>: <span class="hljs-string">"/view/dashboard/sider/:chapters+"</span>,
  <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"./complex-view/sider-view/sider-view.vue"</span>),
});

<span class="hljs-title function_">boot</span>(<span class="hljs-title class_">Dashboard</span>, { routes });
</code></pre>
<p>这段代码揭示了 DSL 运行的实质流程：</p>
<h4 data-id="heading-4">(1) 路由即分发（The Router Dispatcher）</h4>
<ul>
<li>当 URL 匹配到 <code>/view/dashboard/schema</code> 时，Vue Router 自动加载 <code>Schema-View</code> 组件。</li>
<li>当 URL 匹配到 <code>/view/dashboard/iframe</code> 时，加载 <code>Iframe-View</code> 组件。</li>
<li><strong>侧边栏的巧妙处理</strong>：代码中专门为 <code>/sider</code> 路径配置了 <code>children</code>，这意味着如果你的页面配置了侧边栏，系统会先渲染 <code>sider-view</code> 框架，再把具体的内容（schema 或 iframe）渲染到 <code>&lt;router-view&gt;</code> 插槽中。</li>
</ul>
<h4 data-id="heading-5">(2) Schema-View 的内部构造</h4>
<p>一旦路由命中了 <code>Schema-View</code>，这个组件内部其实又做了一次<strong>精细化分工</strong>。它不是一个巨大的黑盒，而是由两个核心子面板组成的：</p>
<ul>
<li><strong>上层：Search-Panel（搜索面板）</strong> 它负责接收 JSON 中的 <code>searchOption</code> 配置，动态生成 Input、Select 等表单项。</li>
<li><strong>下层：Table-Panel（表格面板）</strong> 它负责接收 JSON 中的 <code>tableOption</code> 配置，负责数据的展示、分页以及行列操作。</li>
</ul>
<p><strong>总结一下：</strong> 路由负责**“选车” <strong>（选 Sider 还是 Schema 还是 Iframe），而 <code>Schema-View</code> 负责</strong>“装货”**（把 JSON 拆分成搜索配置和表格配置，分发给上下两个面板）。这样一来，结构清晰，维护也非常容易。</p>
<h2 data-id="heading-6">3. JSON 核心揭秘：一份配置，掌控全局</h2>
<p>接下来我们对着那段 JSON 代码，看看它是怎么指挥前端干活的。</p>
<h3 data-id="heading-7">3.1 路由的大脑：<code>menu</code> 和 <code>moduleType</code></h3>
<p>JSON 最外层的 <code>menu</code> 决定了系统的导航结构。这里有个最关键的开关叫 <code>menuType</code> 和 <code>moduleType</code>。</p>
<p>这也是为了防止“一刀切”。我们不能因为用了低代码，就写不了复杂页面。</p>
<ul>
<li><strong>如果是标准增删改查</strong>：设 <code>moduleType: "schema"</code>。引擎自动干活，你喝咖啡。</li>
<li><strong>如果是超复杂的数据大屏</strong>：设 <code>moduleType: "custom"</code>。引擎让路，加载你手写的 Vue 组件。</li>
<li><strong>如果是老系统页面</strong>：设 <code>moduleType: "iframe"</code>。直接内嵌完事。</li>
</ul>
<h3 data-id="heading-8">3.2 字段的“单源真理”：最骚的操作在这里</h3>
<p>请重点看 JSON 里的 <code>properties</code> 字段。这是整个 DSL 最精华的部分。</p>
<p>以往我们写代码，搜索栏写一遍 <code>&lt;el-input v-model="name"&gt;</code>，表格里又写一遍 <code>&lt;el-table-column prop="name"&gt;</code>。<strong>两边是割裂的。</strong></p>
<p>在这个 DSL 里，我们把一个字段（比如 <code>key</code>）的所有属性聚合在一起：</p>
<p>JavaScript</p>
<pre><code class="hljs language-arduino" lang="arduino">key: {
  label: <span class="hljs-string">"字段名称"</span>, <span class="hljs-comment">// 通用名称</span>
  <span class="hljs-comment">// 1. 告诉表格怎么展示</span>
  tableOption: { 
    visible: <span class="hljs-literal">true</span>, 
    tofixed: <span class="hljs-number">2</span> <span class="hljs-comment">// 假如是数字，自动保留2位小数</span>
  },
  <span class="hljs-comment">// 2. 告诉搜索栏怎么搜索</span>
  searchOption: { 
    comType: <span class="hljs-string">'select'</span>, <span class="hljs-comment">// 自动渲染成下拉框</span>
    enumList: [...]    <span class="hljs-comment">// 下拉选项</span>
  }
}
</code></pre>
<p><strong>看懂了吗？</strong> 你只需要定义一次 <code>key</code>。解析器读取 <code>searchOption</code> 就在上面渲染搜索框，读取 <code>tableOption</code> 就在下面渲染表格列。 <strong>改一个字段名，搜索和表格同时更新。</strong> 这才叫“不重复造轮子”。</p>
<h3 data-id="heading-9">3.3 按钮与事件：<code>schema::</code> 的魔法</h3>
<p>表格肯定要有操作按钮，比如“编辑”、“删除”。 在 <code>headerButtons</code> 或 <code>rowButtons</code> 里，你可能会疑惑这一行： <code>"paramsKey": "schema::fieldKey"</code></p>
<p>这是我们约定的一种<strong>动态取值语法</strong>。</p>
<ul>
<li><strong>场景</strong>：点击“删除”按钮，需要调 API 删掉当前行，API 需要 <code>id</code> 参数。</li>
<li><strong>原理</strong>：当前端引擎看到 <code>schema::</code> 开头时，它就知道：“哦，用户不是要传死字符串，而是要我去<strong>当前这一行的数据</strong>里，把 <code>fieldKey</code> 对应的值取出来传给后端。”</li>
</ul>
<hr/>
<h2 data-id="heading-10">4. 运行流程总结</h2>
<p>把图和代码串起来，整个流程是这样的：</p>
<ol>
<li>
<p><strong>加载</strong>：你打开页面，BFF Server 把合并好的 JSON 扔给前端。</p>
</li>
<li>
<p><strong>路由</strong>：前端 Router 看到 <code>moduleType: "schema"</code>，就把任务交给通用模板页。</p>
</li>
<li>
<p><strong>渲染</strong>：</p>
<ul>
<li><strong>Search 引擎</strong> 遍历 JSON 里的 <code>properties</code>，把带有 <code>searchOption</code> 的字段挑出来，生成搜索栏。</li>
<li><strong>Table 引擎</strong> 遍历 <code>properties</code>，把带有 <code>tableOption</code> 的字段挑出来，生成表格列。</li>
</ul>
</li>
<li>
<p><strong>交互</strong>：用户点“搜索”，引擎自动收集所有搜索框的值，拼接 API URL，刷新表格数据。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-11">5. 写在最后</h2>
<p>这套 DSL 的本质，不是为了炫技，而是为了<strong>偷懒</strong>（褒义）。</p>
<p>它把我们从繁琐的 DOM 结构和 UI 库 API 中解放出来，让我们只关注<strong>业务数据本身</strong>。毕竟，作为开发者，我们的价值应该体现在解决复杂的业务逻辑上，而不是比谁写的 <code>&lt;el-table-column&gt;</code> 更多，对吧？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零掌握 React JSX：为什么它让前端开发像搭积木一样简单？]]></title>    <link>https://juejin.cn/post/7582854603061264426</link>    <guid>https://juejin.cn/post/7582854603061264426</guid>    <pubDate>2025-12-13T12:33:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582854603061264426" data-draft-id="7582846276506566694" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零掌握 React JSX：为什么它让前端开发像搭积木一样简单？"/> <meta itemprop="keywords" content="前端,面试,React.js"/> <meta itemprop="datePublished" content="2025-12-13T12:33:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不会js"/> <meta itemprop="url" content="https://juejin.cn/user/2517262684662348"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零掌握 React JSX：为什么它让前端开发像搭积木一样简单？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517262684662348/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不会js
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T12:33:56.000Z" title="Sat Dec 13 2025 12:33:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从零掌握 React JSX：为什么它让前端开发像搭积木一样简单？</h2>
<p>大家好，今天带大家深入聊聊 React 的核心灵魂——<strong>JSX</strong>。我们会结合真实代码示例，一步步拆解 JSX 的本质、组件化开发、状态管理，以及那些容易踩坑的地方。</p>
<blockquote>
<p>React 为什么这么火？因为它把前端开发从“拼 HTML + CSS + JS”的手工活，变成了“搭积木式”的组件化工程。JSX 就是那把神奇的“胶水”，让 JavaScript 里直接写 HTML-like 代码成为可能。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e75bdf564179470d91864abf18f66077~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LyaanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766234036&amp;x-signature=VAxGJ%2FxjhiXh5FCiN9XGB85X7C8%3D" alt="5609728adb9d921c5649719c8cbf0517.jpg" loading="lazy"/></p>
<h4 data-id="heading-1">JSX 是什么？XML in JS 的魔法</h4>
<p>想象一下，<strong>你在 JavaScript 代码里直接写 HTML 标签</strong>，这听起来多酷？这就是 JSX（JavaScript XML）的核心。它不是字符串，也不是真正的 HTML，而是一种语法扩展，看起来像 XML，但最终会被编译成纯 JavaScript。</p>
<p>为什么需要 JSX？传统前端开发，HTML、CSS、JS 三分离，逻辑和视图混在一起时很容易乱套。React 说：不，我们把一切都放进 JS 里！这样，UI 描述和逻辑紧密耦合，代码更易维护。</p>
<p>来看个简单对比：</p>
<ul>
<li>
<p>不使用 JSX（纯 createElement）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> element = <span class="hljs-title function_">createElement</span>(<span class="hljs-string">'h2'</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'JSX 是 React 中用于描述用户界面的语法扩展'</span>);
</code></pre>
</li>
<li>
<p>使用 JSX（语法糖）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> element = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>JSX 是 React 中用于描述用户界面的语法扩展<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span>;
</code></pre>
</li>
</ul>
<p>明显后者更直观、可读性更高！JSX 本质上是 <code>React.createElement</code> 的语法糖，Babel 会帮我们编译成后者。</p>
<p><strong>注</strong>：Babel 是一个开源的 JavaScript 编译器，更准确地说，是一个 转译器。它的主要作用是：把现代 JavaScript 代码（ES2015+，也就是 ES6 及更高版本）转换成向后兼容的旧版 JavaScript 代码，让这些代码能在老浏览器或旧环境中正常运行。</p>
<p><strong>底层逻辑</strong>：JSX 被 Babel 转译后，生成 Virtual DOM 对象树。React 用这个虚拟树对比真实 DOM，只更新变化部分，这就是 React 高性能的秘密——Diff 算法 + 批量更新。</p>
<h4 data-id="heading-2">React vs Vue：为什么 React 更“激进”？</h4>
<p>Vue 和 React 都是现代前端框架的代表，都支持<strong>响应式、数据绑定和组件化</strong>。但 React 更纯粹、更激进。</p>
<ul>
<li><strong>Vue</strong>：模板、脚本、样式三分离（单文件组件 .vue），上手友好，双向绑定 v-model 超级方便。适合快速原型开发。</li>
<li><strong>React</strong>：一切皆 JS！JSX 把模板塞进 JS，单向数据流（props down, events up），逻辑更明确，但学习曲线陡峭。</li>
</ul>
<p>React 的激进在于：它不提供“开箱即用”的模板语法，而是让你用完整的 JavaScript 能力构建 UI。你可以用 if、map、变量等<strong>原生 JS 控制渲染</strong>，而 Vue 模板需要指令（如 v-if、v-for）。</p>
<p>为什么很多人说 React 入门门槛高？因为它强制你思考“组件树”和“状态流”，而不是靠模板魔法。但一旦上手，你会发现它在大型项目中更可控、更灵活。Facebook、Netflix 都在用 React，就是因为组件化让代码像<strong>乐高积木一样可复用</strong>。</p>
<h4 data-id="heading-3">组件化开发：从 DOM 树到组件树</h4>
<p>传统前端靠 DOM 操作，审查元素是层层 div。React 说：不，我们用<strong>组件树</strong>代替 DOM 树！</p>
<p>组件是 React 的基本单位，每个组件是一个函数（现代 React 推荐函数组件），返回 JSX 描述 UI。</p>
<p>来看一个模拟掘金首页的例子：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">JuejinHeader</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>掘金的首页<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Articles</span> = (<span class="hljs-params"/>) =&gt; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>Articles<span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span></span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">JuejinHeader</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Articles</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">aside</span>&gt;</span>{/* 侧边栏组件 */}<span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>这里，<strong>App 是根组件，组合了子组件</strong>。就像包工头分工：Header 负责头部，Articles 负责文章列表。页面就是这些组件搭起来的！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3603be53c6a143bdb673ca8fe7c48158~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LyaanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766234036&amp;x-signature=LJIoAt0wsD4p%2Bz7pE5bVt0c6wws%3D" alt="image.png" loading="lazy"/></p>
<p>这张图的<strong>核心</strong>就是：把复杂 UI 拆分成<strong>组件树</strong>，每个组件专注自己的事，通过组合构建整个页面。</p>
<p><strong>关键点：组件复用</strong></p>
<ul>
<li>你会注意到 <strong>FancyText</strong> 出现了两次（一个直接在 App 下，一个在 InspirationGenerator 下）。</li>
<li>这就是在强调：同一个组件可以被多个父组件多次渲染和复用！这正是 React 组件化开发的强大之处——写一次，到处用，像乐高积木一样组合。</li>
</ul>
<p><strong>为什么函数做组件？</strong> 因为函数纯净、无副作用，能完美封装 UI + 逻辑 + 状态。类组件（旧方式）有 this 绑定问题，函数组件 + Hooks 解决了这一切。</p>
<p><strong>底层逻辑</strong>：React 渲染时，会递归调用每个组件的 render 函数，最终生成一棵完整的 Virtual DOM 树。也就是说每个组件渲染生成 Virtual DOM 片段，React 合并成一棵大树。更新时，只重渲染变化的组件子树。</p>
<h4 data-id="heading-4">useState：让函数组件拥有“记忆”</h4>
<p>组件需要交互？就需要状态！useState 是 Hooks 的入门王牌。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [name, setName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'vue'</span>); <span class="hljs-comment">// 初始值 'vue'</span>
  <span class="hljs-keyword">const</span> [todos, setTodos] = <span class="hljs-title function_">useState</span>([
    { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'学习 React'</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'学习 Node'</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> }
  ]);
  <span class="hljs-keyword">const</span> [isLoggedIn, setIsLoggedIn] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleLogin</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setIsLoggedIn</span>(!isLoggedIn);

  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setName</span>(<span class="hljs-string">'react'</span>), <span class="hljs-number">3000</span>); <span class="hljs-comment">// 3秒后自动更新</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"title"</span>&gt;</span>{name}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      {todos.length &gt; 0 ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
          {todos.map(todo =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{todo.id}</span>&gt;</span>{todo.title}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>暂无待办事项<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
      {isLoggedIn ? <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>已登录<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>未登录<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{toggleLogin}</span>&gt;</span>
        {isLoggedIn ? '退出登录' : '登录'}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/602ea411b6594fcfafc5a4e077ffab47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LyaanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766234036&amp;x-signature=raSSL1ZCSWTI%2BdAjscvOMEuv2n0%3D" alt="image.png" loading="lazy"/></p>
<p>useState 返回 [状态值, 更新函数]。调用更新函数会触发重渲染，React 记住最新状态。</p>
<p>函数组件 + Hooks，代码更简洁、复用性更强。常见 Hooks：</p>
<ul>
<li>useState：管理状态</li>
<li>useEffect：处理副作用（数据获取、订阅等）</li>
<li>useContext、useReducer、useRef 等</li>
</ul>
<p><strong>易错提醒</strong>：</p>
<h5 data-id="heading-5">setState 是异步的！多个 setState 可能批处理，不要直接依赖旧值。</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 错：可能加1多次只加1</span>
<span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);

<span class="hljs-comment">// 对：函数式更新</span>
<span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);
</code></pre>
<ul>
<li>
<p>在同一个事件（如 onClick）里，React <strong>不会立即更新状态</strong>，而是把所有 setCount 调用<strong>收集到一个队列</strong>里。</p>
</li>
<li>
<p>所有 setCount 执行时，看到的 <strong>count 都是当前渲染的“快照值”</strong> （这里是 0）。</p>
</li>
<li>
<p>等事件结束，React 一次性处理队列：两次都是 “0 + 1 = 1”，最后覆盖成同一个值 1，只重渲染一次。</p>
</li>
</ul>
<h4 data-id="heading-6">对象状态更新不会自动合并，用展开运算符：</h4>
<h5 data-id="heading-7">错的例子：直接替换对象，会丢失属性</h5>
<p>假设初始状态是一个对象：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> [person, setPerson] = <span class="hljs-title function_ invoke__">useState</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>,
  <span class="hljs-attr">city</span>: <span class="hljs-string">'Beijing'</span>
});
</code></pre>
<p>如果你想只改 age：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 错！直接传新对象</span>
<span class="hljs-built_in">setPerson</span>({ age: <span class="hljs-number">35</span> });
</code></pre>
<p>结果：新状态变成 { age: 35 }，name 和 city 全没了！因为 React 直接用你传的对象替换了整个状态。</p>
<h4 data-id="heading-8">正确的做法：用展开运算符（...prev）手动合并</h4>
<p>jsx</p>
<pre><code class="hljs language-ini" lang="ini">// 对！函数式更新 + 展开运算符
setPerson(<span class="hljs-attr">prev</span> =&gt; ({ ...prev, age: <span class="hljs-number">35</span> }))<span class="hljs-comment">;</span>
</code></pre>
<p>这里发生了什么？</p>
<ul>
<li>prev 是当前最新的状态对象（{ name: 'Alice', age: 30, city: 'Beijing' }）</li>
<li>{ ...prev }：用 ES6 展开运算符把 prev 的所有属性复制到一个新对象里 → { name: 'Alice', age: 30, city: 'Beijing' }</li>
<li>age: 35：覆盖 age 属性</li>
<li>最终返回新对象：{ name: 'Alice', age: 35, city: 'Beijing' }</li>
</ul>
<p>完美！只改了 age，其他属性保留了。</p>
<h4 data-id="heading-9">JSX 常见坑与最佳实践</h4>
<p>JSX 强大，但也有陷阱：</p>
<ol>
<li>
<p><strong>class → className</strong>：class 是 JS 关键字，必须用 className。</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;div className=<span class="hljs-string">"title"</span>&gt;错误会报错！&lt;/div&gt;
</code></pre>
</li>
<li>
<p><strong>最外层必须单根元素</strong>：</p>
</li>
</ol>
<p>JSX 的 return 必须返回<strong>一个</strong>元素（或 null），不能直接返回多个并列元素。</p>
<p>错的：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>标题<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>段落<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>  <span class="hljs-comment">// 报错！Adjacent JSX elements must be wrapped...</span>
);
</code></pre>
<p>因为 JSX 最终转译成 React.createElement 调用，而函数返回值只能是一个表达式。</p>
<p>正确做法：用 <strong>Fragment &lt;&gt; &lt;/&gt;</strong> 包裹（不渲染多余 DOM）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;&gt;</span>  {/* 短语法 */}
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>标题<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>段落<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/&gt;</span></span>
);

<span class="hljs-comment">// 或</span>
<span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">React.Fragment</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>标题<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>段落<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">React.Fragment</span>&gt;</span></span>
);
</code></pre>
<p>3.  <strong>表达式用 {}</strong>：插值、条件、三元、map 都用大括号。
<code>jsx     {condition ? &lt;A /&gt; : &lt;B /&gt;}     </code></p>
<ol start="4">
<li>
<p><strong>key 必加</strong>：列表渲染 map 时，加唯一 key，帮助 React 高效 Diff。</p>
<pre><code class="hljs language-jsx" lang="jsx">{todos.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{todo.id}</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>)}
</code></pre>
<p>缺 key 会警告，性能差。</p>
</li>
<li>
<p><strong>事件用 camelCase</strong>：onClick，不是 onclick。</p>
</li>
<li>
<p><strong>自闭合标签</strong>：单标签必须闭合，如 <code>&lt;img /&gt;</code>。</p>
</li>
</ol>
<h4 data-id="heading-10">根组件挂载：从 main.jsx 看 React 启动</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { createRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.jsx'</span>;

<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>)).<span class="hljs-title function_">render</span>(
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>
);
</code></pre>
<h4 data-id="heading-11">1. 这段代码在干啥？一步步拆解</h4>
<ul>
<li>
<p><strong>document.getElementById('root')</strong> ：找到 HTML 文件里的挂载点。通常 index.html 有个 </p><div id="user-content-root"/>，React 会把整个应用塞进去，接管这个 div 里的所有内容。<p/>
</li>
<li>
<p><strong>createRoot(...)</strong> ：创建 React 的“根”（Root）。它返回一个 Root 对象，这个对象负责管理整个组件树和 DOM 更新。</p>
</li>
<li>
<p><strong>.render()</strong> ：告诉 React：“嘿，从现在开始渲染 App 组件吧！”React 会从 App 开始递归渲染组件树，生成 Virtual DOM，最终 commit 到真实 DOM。</p>
</li>
</ul>
<p>整个过程：<strong>创建根 → 初始渲染 → 接管 DOM</strong>。应用启动后，React 就完全掌控了 #root 里的 UI。</p>
<h4 data-id="heading-12">总结：为什么选择 React 和 JSX？</h4>
<p>JSX 让 React 成为“<strong>全栈 JS</strong>”的代表：逻辑、视图、状态全在 JS 里。组件化让你像建筑师一样设计页面，useState 等 Hooks 让函数组件强大无比。</p>
<p>相比 Vue，React 更适合大型、复杂应用（生态丰富，TypeScript 支持一流）。但 Vue 上手更快，适合中小项目。</p>
<p>学 React，不是学语法，而是学“声明式编程”和“组件思维”。掌握 JSX，你就掌握了 React 的半壁江山。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RequireJS 详解]]></title>    <link>https://juejin.cn/post/7582857981894705193</link>    <guid>https://juejin.cn/post/7582857981894705193</guid>    <pubDate>2025-12-13T13:13:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582857981894705193" data-draft-id="7582879379442040875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RequireJS 详解"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-13T13:13:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="在掘金80110"/> <meta itemprop="url" content="https://juejin.cn/user/4195392103913143"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RequireJS 详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4195392103913143/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    在掘金80110
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T13:13:53.000Z" title="Sat Dec 13 2025 13:13:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RequireJS 详解</h2>
<p>RequireJS 是一个基于 <strong>AMD（Asynchronous Module Definition，异步模块定义）</strong> 规范的 JavaScript 模块加载器，主要解决浏览器端模块化开发的依赖管理、异步加载问题，避免传统 <code>&lt;script&gt;</code> 标签加载的阻塞和依赖混乱问题。</p>
<h3 data-id="heading-1">一、核心优势</h3>
<ol>
<li><strong>异步加载</strong>：模块按需异步加载，避免阻塞页面渲染；</li>
<li><strong>依赖管理</strong>：明确声明模块依赖，自动按顺序加载依赖模块；</li>
<li><strong>模块化封装</strong>：隔离模块作用域，避免全局变量污染；</li>
<li><strong>跨环境兼容</strong>：支持浏览器端，也可配合工具（如 r.js）打包为生产环境的单文件。</li>
</ol>
<h3 data-id="heading-2">二、快速上手</h3>
<h4 data-id="heading-3">1. 引入 RequireJS</h4>
<p>下载 RequireJS（<a href="https://link.juejin.cn?target=https%3A%2F%2Frequirejs.org%2F" target="_blank" title="https://requirejs.org/" ref="nofollow noopener noreferrer">官网</a>），或通过 CDN 引入，在 HTML 中通过 <code>&lt;script&gt;</code> 标签加载，指定入口模块（<code>data-main</code>）：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 引入 require.js，并指定入口模块为 main.js --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.js"</span> <span class="hljs-attr">data-main</span>=<span class="hljs-string">"js/main"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<ul>
<li><code>data-main</code>：指定应用的入口模块（后缀 <code>.js</code> 可省略）；</li>
<li>RequireJS 会自动加载 <code>main.js</code>，并以它为起点管理所有模块。</li>
</ul>
<h4 data-id="heading-4">2. 定义模块</h4>
<p>RequireJS 中模块通过 <code>define()</code> 定义，分三种场景：</p>
<h5 data-id="heading-5">（1）无依赖模块</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// js/modules/hello.js</span>
<span class="hljs-title function_">define</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">sayHello</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">${name}</span>!`</span>;
    }
  };
});
</code></pre>
<h5 data-id="heading-6">（2）有依赖模块</h5>
<p>依赖模块通过数组声明，回调函数的参数与依赖一一对应：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// js/modules/user.js</span>
<span class="hljs-title function_">define</span>([<span class="hljs-string">'./hello'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">hello</span>) { <span class="hljs-comment">// 依赖同目录的 hello.js</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">greet</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">username</span>) {
      <span class="hljs-keyword">return</span> hello.<span class="hljs-title function_">sayHello</span>(username);
    }
  };
});
</code></pre>
<h5 data-id="heading-7">（3）命名模块（不推荐，RequireJS 会自动根据文件路径生成模块名）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 显式指定模块名（一般用于第三方库）</span>
<span class="hljs-title function_">define</span>(<span class="hljs-string">'myModule'</span>, [<span class="hljs-string">'jquery'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">$</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">init</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      $(<span class="hljs-string">'body'</span>).<span class="hljs-title function_">css</span>(<span class="hljs-string">'background'</span>, <span class="hljs-string">'#f5f5f5'</span>);
    }
  };
});
</code></pre>
<h4 data-id="heading-8">3. 加载模块</h4>
<p>通过 <code>require()</code> 加载模块并执行逻辑，通常在入口模块 <code>main.js</code> 中使用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// js/main.js</span>
<span class="hljs-comment">// 配置模块路径（可选，推荐）</span>
<span class="hljs-built_in">require</span>.<span class="hljs-title function_">config</span>({
  <span class="hljs-comment">// 基础路径：所有模块的根路径</span>
  <span class="hljs-attr">baseUrl</span>: <span class="hljs-string">'js'</span>,
  <span class="hljs-comment">// 路径映射：简化长路径/第三方库别名</span>
  <span class="hljs-attr">paths</span>: {
    <span class="hljs-string">'jquery'</span>: <span class="hljs-string">'https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min'</span>, <span class="hljs-comment">// CDN 加载</span>
    <span class="hljs-string">'user'</span>: <span class="hljs-string">'modules/user'</span>, <span class="hljs-comment">// 本地模块</span>
    <span class="hljs-string">'hello'</span>: <span class="hljs-string">'modules/hello'</span>
  },
  <span class="hljs-comment">// 非 AMD 模块适配（如一些全局变量式的库）</span>
  <span class="hljs-attr">shim</span>: {
    <span class="hljs-string">'underscore'</span>: {
      <span class="hljs-attr">exports</span>: <span class="hljs-string">'_'</span> <span class="hljs-comment">// 暴露全局变量 _ 作为模块导出</span>
    }
  }
});

<span class="hljs-comment">// 加载并使用模块</span>
<span class="hljs-built_in">require</span>([<span class="hljs-string">'jquery'</span>, <span class="hljs-string">'user'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">$, user</span>) {
  $(<span class="hljs-variable language_">document</span>).<span class="hljs-title function_">ready</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> greetMsg = user.<span class="hljs-title function_">greet</span>(<span class="hljs-string">'RequireJS'</span>);
    $(<span class="hljs-string">'body'</span>).<span class="hljs-title function_">html</span>(<span class="hljs-string">`&lt;h1&gt;<span class="hljs-subst">${greetMsg}</span>&lt;/h1&gt;`</span>);
  });
});
</code></pre>
<h3 data-id="heading-9">三、核心 API 详解</h3>
<h4 data-id="heading-10">1. <code>define()</code>：定义模块</h4>
<p>语法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 无依赖</span>
<span class="hljs-title function_">define</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 模块逻辑，return 导出内容 */</span> });

<span class="hljs-comment">// 有依赖</span>
<span class="hljs-title function_">define</span>([依赖<span class="hljs-number">1</span>, 依赖<span class="hljs-number">2</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">模块<span class="hljs-number">1</span>, 模块<span class="hljs-number">2</span></span>) { <span class="hljs-comment">/* 逻辑 */</span> });

<span class="hljs-comment">// 命名模块</span>
<span class="hljs-title function_">define</span>(<span class="hljs-string">'模块名'</span>, [依赖], <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 逻辑 */</span> });
</code></pre>
<h4 data-id="heading-11">2. <code>require.config()</code>：全局配置</h4>
<p>核心配置项：</p>



































<table><thead><tr><th>配置项</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>baseUrl</code></td><td>模块加载的基础路径</td><td><code>baseUrl: 'js/lib'</code></td></tr><tr><td><code>paths</code></td><td>模块路径映射（可省略 <code>.js</code>，支持 CDN）</td><td><code>paths: { jquery: 'jquery-3.7.1' }</code></td></tr><tr><td><code>shim</code></td><td>适配非 AMD 模块（暴露变量、声明依赖）</td><td><code>shim: { underscore: { exports: '_' } }</code></td></tr><tr><td><code>map</code></td><td>不同环境加载不同版本模块</td><td><code>map: { '*': { 'jquery': 'jquery-2' } }</code></td></tr><tr><td><code>waitSeconds</code></td><td>模块加载超时时间（默认 7 秒）</td><td><code>waitSeconds: 10</code></td></tr></tbody></table>
<h4 data-id="heading-12">3. <code>require()</code>：加载模块并执行</h4>
<p>语法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-built_in">require</span>([依赖<span class="hljs-number">1</span>, 依赖<span class="hljs-number">2</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">模块<span class="hljs-number">1</span>, 模块<span class="hljs-number">2</span></span>) {
  <span class="hljs-comment">// 模块加载完成后的逻辑</span>
}, <span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) {
  <span class="hljs-comment">// 加载失败的回调（可选）</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'模块加载失败：'</span>, err);
});
</code></pre>
<h3 data-id="heading-13">四、常见场景</h3>
<h4 data-id="heading-14">1. 加载第三方非 AMD 模块</h4>
<p>很多传统库（如 Underscore、Backbone）不是 AMD 模块，需通过 <code>shim</code> 适配：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-built_in">require</span>.<span class="hljs-title function_">config</span>({
  <span class="hljs-attr">paths</span>: {
    <span class="hljs-attr">underscore</span>: <span class="hljs-string">'lib/underscore'</span>,
    <span class="hljs-attr">backbone</span>: <span class="hljs-string">'lib/backbone'</span>
  },
  <span class="hljs-attr">shim</span>: {
    <span class="hljs-attr">underscore</span>: {
      <span class="hljs-attr">exports</span>: <span class="hljs-string">'_'</span> <span class="hljs-comment">// 暴露全局变量 _</span>
    },
    <span class="hljs-attr">backbone</span>: {
      <span class="hljs-attr">deps</span>: [<span class="hljs-string">'underscore'</span>, <span class="hljs-string">'jquery'</span>], <span class="hljs-comment">// 声明依赖</span>
      <span class="hljs-attr">exports</span>: <span class="hljs-string">'Backbone'</span> <span class="hljs-comment">// 暴露 Backbone</span>
    }
  }
});

<span class="hljs-comment">// 使用</span>
<span class="hljs-built_in">require</span>([<span class="hljs-string">'backbone'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">Backbone</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Backbone</span>);
});
</code></pre>
<h4 data-id="heading-15">2. 动态加载模块</h4>
<p>通过 <code>require()</code> 动态加载模块（如用户交互后）：</p>
<pre><code class="hljs language-javascript" lang="javascript">$(<span class="hljs-string">'#loadModule'</span>).<span class="hljs-title function_">click</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 动态加载 hello 模块</span>
  <span class="hljs-built_in">require</span>([<span class="hljs-string">'modules/hello'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">hello</span>) {
    <span class="hljs-title function_">alert</span>(hello.<span class="hljs-title function_">sayHello</span>(<span class="hljs-string">'动态加载'</span>));
  });
});
</code></pre>
<h4 data-id="heading-16">3. 模块打包（生产环境）</h4>
<p>开发阶段模块分散，生产环境需打包为单文件，使用官方工具 <strong>r.js</strong>：</p>
<ol>
<li>安装 r.js：<code>npm install -g requirejs</code>；</li>
<li>创建打包配置文件 <code>build.js</code>：
<pre><code class="hljs language-javascript" lang="javascript">({
  <span class="hljs-attr">baseUrl</span>: <span class="hljs-string">'js'</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">'main'</span>, <span class="hljs-comment">// 入口模块</span>
  <span class="hljs-attr">out</span>: <span class="hljs-string">'js/build/main.min.js'</span>, <span class="hljs-comment">// 输出文件</span>
  <span class="hljs-attr">optimize</span>: <span class="hljs-string">'uglify2'</span> <span class="hljs-comment">// 压缩方式（uglify2/closure/none）</span>
})
</code></pre>
</li>
<li>执行打包：<code>r.js -o build.js</code>。</li>
</ol>
<h3 data-id="heading-17">五、注意事项</h3>
<ol>
<li><strong>模块路径问题</strong>：<code>baseUrl</code> 是相对 HTML 文件的路径，而非配置文件；</li>
<li><strong>避免全局变量</strong>：模块内通过 <code>return</code> 导出，不要随意定义全局变量；</li>
<li><strong>循环依赖</strong>：AMD 支持循环依赖，但需通过 <code>require</code> 回调获取依赖（而非参数）：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// a.js</span>
<span class="hljs-title function_">define</span>([<span class="hljs-string">'b'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">b</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">foo</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> b.<span class="hljs-title function_">bar</span>();
    }
  };
});

<span class="hljs-comment">// b.js</span>
<span class="hljs-title function_">define</span>([<span class="hljs-string">'a'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">a</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">bar</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 循环依赖时，通过 require 实时获取 a</span>
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">require</span>(<span class="hljs-string">'a'</span>).<span class="hljs-title function_">foo</span>() + <span class="hljs-string">' bar'</span>;
    }
  };
});
</code></pre>
</li>
<li><strong>生产环境优化</strong>：务必用 r.js 打包，减少 HTTP 请求；</li>
<li><strong>ES6 模块兼容</strong>：RequireJS 也支持加载 ES6 模块（需配置 <code>packages</code>），但现代项目更推荐 ES6 Module + Webpack/Rollup。</li>
</ol>
<h3 data-id="heading-18">六、与 ES6 Module 的区别</h3>



































<table><thead><tr><th>特性</th><th>RequireJS（AMD）</th><th>ES6 Module</th></tr></thead><tbody><tr><td>加载方式</td><td>异步加载（运行时加载）</td><td>静态加载（编译时确定依赖）</td></tr><tr><td>语法</td><td><code>define/require</code></td><td><code>import/export</code></td></tr><tr><td>作用域</td><td>函数作用域</td><td>块级作用域</td></tr><tr><td>浏览器支持</td><td>需加载器（RequireJS）</td><td>现代浏览器原生支持（需 <code>&lt;script type="module"&gt;</code>）</td></tr><tr><td>动态加载</td><td>原生支持 <code>require()</code></td><td>需配合 <code>import()</code> 动态导入</td></tr></tbody></table>
<blockquote>
<p>注：现代前端项目（React/Vue/Angular）已普遍使用 ES6 Module + 构建工具（Webpack/Vite），但 RequireJS 仍适用于老项目维护、非构建型简单应用。</p>
</blockquote>
<h3 data-id="heading-19">七、总结</h3>
<p>RequireJS 是浏览器端模块化开发的经典解决方案，核心是通过 AMD 规范实现异步模块加载和依赖管理。其优势是轻量、无需构建工具即可使用，适合中小型项目或老项目维护；缺点是语法相对繁琐，现代项目更推荐 ES6 Module + 构建工具。</p>
<p>如果需要具体场景的代码示例（如循环依赖处理、打包优化），可以进一步说明！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我对防抖（Debounce）的一点理解与实践：从基础到立即执行]]></title>    <link>https://juejin.cn/post/7582875640309202994</link>    <guid>https://juejin.cn/post/7582875640309202994</guid>    <pubDate>2025-12-13T13:53:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582875640309202994" data-draft-id="7582904738921381926" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我对防抖（Debounce）的一点理解与实践：从基础到立即执行"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-13T13:53:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="cindershade"/> <meta itemprop="url" content="https://juejin.cn/user/2587590326494763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我对防抖（Debounce）的一点理解与实践：从基础到立即执行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2587590326494763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    cindershade
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T13:53:29.000Z" title="Sat Dec 13 2025 13:53:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">我对防抖（Debounce）的一点理解与实践</h2>
<blockquote>
<p>这篇文章主要是我在项目中使用防抖过程中的一些总结，<strong>只代表个人理解</strong>，如果有不严谨或可以优化的地方，欢迎指出和讨论。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、防抖的概念</h3>
<p><strong>防抖（Debounce）</strong> ，简单来说就是：</p>
<blockquote>
<p>在短时间内多次触发同一个函数时，只让它在“合适的时机”执行一次。</p>
</blockquote>
<p>常见的两种形式：</p>
<ul>
<li><strong>尾触发</strong>：停止触发一段时间后才执行</li>
<li><strong>立即执行</strong>：第一次触发立刻执行，随后一段时间内不再执行</li>
</ul>
<p>防抖本身并不复杂，真正复杂的地方在于：<strong>什么时候该用哪一种，以及实现细节是否可靠。</strong></p>
<hr/>
<h3 data-id="heading-2">二、为什么要做防抖（重点）</h3>
<p>在实际项目中，高频触发几乎无处不在：</p>
<ul>
<li>用户快速点击按钮</li>
<li>表单多次提交</li>
<li>输入框实时搜索</li>
</ul>
<p>如果不加控制，往往会带来一些问题：</p>
<ul>
<li>接口被重复调用</li>
<li>产生重复副作用（多次提交、多次弹窗）</li>
<li>状态错乱，难以维护</li>
</ul>
<p>防抖解决的核心问题是：</p>
<blockquote>
<p><strong>函数触发频率过高，而这些触发中，只有一部分是真正“有意义”的。</strong></p>
</blockquote>
<p>通过防抖，我们可以在函数入口处统一控制执行频率，而不是在函数内部到处加判断。</p>
<hr/>
<h4 data-id="heading-3">2.1 除了防抖，还有其它方案吗？（简单带过）</h4>
<p>实际开发中，也经常能看到一些方案：</p>
<ul>
<li>
<p><strong>loading 状态控制</strong>：</p>
</li>
<li>
<p><strong>页面多个按钮，loading按钮过多，然后二次封装按钮组件</strong>：</p>
</li>
</ul>
<blockquote>
<p>接下来先按照我个人的理解，来说一下还是防抖。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">三、基础版本防抖实现</h3>
<h4 data-id="heading-5">3.1 最基础的防抖写法</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">func, wait = <span class="hljs-number">200</span></span>) {
  <span class="hljs-keyword">let</span> timeout = <span class="hljs-literal">null</span>

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-built_in">clearTimeout</span>(timeout)
    timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
    }, wait)
  }
}
</code></pre>
<p>这个版本属于<strong>最经典的尾触发防抖</strong>：</p>
<ul>
<li>多次触发只会执行最后一次</li>
</ul>
<hr/>
<h4 data-id="heading-6">3.2 普通函数与箭头函数的区别</h4>
<p>防抖实现中经常会看到两种写法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> content = <span class="hljs-variable language_">this</span>

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  func.<span class="hljs-title function_">apply</span>(content, args)
}, wait)

</code></pre>
<p>以及：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
}, wait)
</code></pre>
<p>这两种写法的核心区别在于 <strong><code>this</code> 的绑定机制不同</strong>：</p>
<ul>
<li><strong>普通函数的 <code>this</code> 是运行时动态绑定的</strong>，由函数的调用方式决定，在 <code>setTimeout</code> 等场景中容易发生 <code>this</code> 丢失。</li>
<li><strong>箭头函数不会创建自己的 <code>this</code></strong>，它的 <code>this</code> 在定义时就已经确定，始终指向外层作用域的 <code>this</code>，因此非常适合用于定时器和回调函数中。</li>
</ul>
<p>因此在防抖中，如果使用普通函数，往往需要额外保存 this；<br/>
而使用箭头函数，可以让代码更简洁。然后具体的情况需要具体分析</p>
<p>这里不展开细说 this 的规则。
而且里面还涉及到了apply，call，bind等知识</p>
<hr/>
<h3 data-id="heading-7">四、立即执行版防抖</h3>
<h4 data-id="heading-8">4.1 为什么需要立即执行版</h4>
<p>普通防抖有一个明显特点：</p>
<ul>
<li><strong>第一次触发不会立即执行</strong></li>
</ul>
<p>在一些场景下，这并不是我们想要的行为，例如：</p>
<ul>
<li>提交按钮</li>
<li>登录、支付等关键操作</li>
</ul>
<p>这类场景下，更合理的预期是：</p>
<blockquote>
<p><strong>第一次点击立刻执行，但在短时间内禁止再次触发。</strong></p>
</blockquote>
<p>这就是立即执行版防抖存在的意义。</p>
<hr/>
<h4 data-id="heading-9">4.2 立即执行版完整实现</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">func, wait = <span class="hljs-number">200</span>, immediate = <span class="hljs-literal">false</span></span>) {
  <span class="hljs-keyword">let</span> timeout = <span class="hljs-literal">null</span>

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-comment">// 是否需要立即执行（第一次触发）</span>
    <span class="hljs-keyword">const</span> callNow = immediate &amp;&amp; !timeout

    <span class="hljs-comment">// 清除之前的定时器</span>
    <span class="hljs-keyword">if</span> (timeout) <span class="hljs-built_in">clearTimeout</span>(timeout)

    <span class="hljs-comment">// 设置新的定时器，用于冷却期结束</span>
    timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 冷却结束，重置状态</span>
      timeout = <span class="hljs-literal">null</span>

      <span class="hljs-comment">// 非立即执行模式，走尾触发</span>
      <span class="hljs-keyword">if</span> (!immediate) {
        func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
      }
    }, wait)

    <span class="hljs-comment">// 立即执行（只会执行一次）</span>
    <span class="hljs-keyword">if</span> (callNow) {
      func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
    }
  }
}
</code></pre>
<hr/>
<h4 data-id="heading-10">4.3 这一版的核心思路</h4>
<p>在这个实现中：</p>
<ul>
<li><code>timeout</code> 不只是一个定时器</li>
<li>它同时承担了 <strong>“是否处于冷却期” 的状态标记</strong></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> callNow = immediate &amp;&amp; !timeout
</code></pre>
<ul>
<li><code>!timeout</code> 表示当前不在冷却期</li>
<li>只允许第一次触发立即执行</li>
</ul>
<p>当定时器结束后：</p>
<pre><code class="hljs language-js" lang="js">timeout = <span class="hljs-literal">null</span>
</code></pre>
<p>表示冷却期结束，允许下一次立即执行。</p>
<hr/>
<h3 data-id="heading-11">五、结合源码理解实现逻辑</h3>
<p>在理解了立即执行版防抖的实现后，再回看 Underscore.js 的 <code>_.debounce</code> 源码，其实可以发现：<strong>核心思想完全一致，只是写法更偏工程化。</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">_.debounce</span> = function(func, wait, immediate) {
  var timeout, result<span class="hljs-comment">;</span>

  var <span class="hljs-attr">later</span> = function(context, args) {
    <span class="hljs-attr">timeout</span> = null<span class="hljs-comment">;</span>
    if (args) <span class="hljs-attr">result</span> = func.apply(context, args)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  var <span class="hljs-attr">debounced</span> = function(...args) {
    if (timeout) clearTimeout(timeout)<span class="hljs-comment">;</span>

    if (immediate) {
      var <span class="hljs-attr">callNow</span> = !timeout<span class="hljs-comment">;</span>
      <span class="hljs-attr">timeout</span> = setTimeout(later, wait)<span class="hljs-comment">;</span>
      if (callNow) <span class="hljs-attr">result</span> = func.apply(this, args)<span class="hljs-comment">;</span>
    } else {
      <span class="hljs-attr">timeout</span> = setTimeout(() =&gt; later(this, args), wait)<span class="hljs-comment">;</span>
    }

    return result<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  return debounced<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-12"><code>timeout</code> 是防抖的核心状态</h4>
<p><code>timeout</code> 不只是定时器 ID，更是<strong>是否处于冷却期的状态标识</strong>：</p>
<ul>
<li><code>timeout === null</code>：不在冷却期</li>
<li><code>timeout !== null</code>：正在防抖中</li>
</ul>
<p>立即执行模式正是通过 <code>!timeout</code> 来判断“是否第一次触发”。</p>
<hr/>
<h4 data-id="heading-13">为什么定时器里要 <code>timeout = null</code></h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">timeout</span> = null<span class="hljs-comment">;</span>
</code></pre>
<p>这一步表示<strong>冷却期结束</strong>，为下一次立即执行创造条件。<br/>
如果不重置，<code>immediate</code> 只会生效一次。</p>
<hr/>
<h4 data-id="heading-14">立即执行的关键逻辑</h4>
<pre><code class="hljs language-ini" lang="ini">var <span class="hljs-attr">callNow</span> = !timeout<span class="hljs-comment">;</span>
<span class="hljs-attr">timeout</span> = setTimeout(later, wait)<span class="hljs-comment">;</span>
if (callNow) func.apply(this, args)<span class="hljs-comment">;</span>
</code></pre>
<p>这三行完成了三件事：</p>
<ol>
<li>判断是否第一次触发</li>
<li>立刻进入冷却期</li>
<li>只在第一次触发时立即执行</li>
</ol>
<p>后续触发只会刷新定时器，不会重复执行。</p>
<hr/>
<h4 data-id="heading-15">为什么源码不用 <code>this</code>，而是传 <code>context</code></h4>
<p><code>later</code> 是普通函数，<code>this</code> 不可靠。<br/>
因此 Underscore 选择 <strong>显式传递 <code>context</code></strong>，保证 <code>this</code> 指向稳定，这是典型的库级写法。</p>
<hr/>
<h4 data-id="heading-16">核心结论</h4>
<p>防抖并不依赖复杂 API，本质只有两点：</p>
<ul>
<li><strong>定时器</strong></li>
<li><strong>状态控制（是否处于冷却期）</strong></li>
</ul>
<p>立即执行与否，本质区别只是：</p>
<blockquote>
<p><strong>函数是在冷却期开始时执行，还是在冷却期结束时执行。</strong></p>
</blockquote>
<h3 data-id="heading-17">总结</h3>
<p>防抖本身并不难，真正容易出问题的是：</p>
<ul>
<li>使用场景选错</li>
<li>this 指向理解不清</li>
<li>状态与执行职责混在一起</li>
</ul>
<p>这篇文章更多是我个人在项目中的一些理解与总结，<br/>
如果你在实践中有不同的经验或看法，也非常欢迎交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 useTransition：React 并发渲染的性能优化利器]]></title>    <link>https://juejin.cn/post/7582890166358425626</link>    <guid>https://juejin.cn/post/7582890166358425626</guid>    <pubDate>2025-12-13T14:14:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582890166358425626" data-draft-id="7582896213855551503" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 useTransition：React 并发渲染的性能优化利器"/> <meta itemprop="keywords" content="React.js,Next.js"/> <meta itemprop="datePublished" content="2025-12-13T14:14:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bytemanx"/> <meta itemprop="url" content="https://juejin.cn/user/4059855780846936"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 useTransition：React 并发渲染的性能优化利器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4059855780846936/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bytemanx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T14:14:08.000Z" title="Sat Dec 13 2025 14:14:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>React 16 引入了 Fiber 架构，这是 React 核心算法的重构。Fiber 把渲染工作拆成多个小的工作单元（fiber 节点），每个工作单元可以独立执行、暂停和恢复。这种可中断的渲染机制让 React 能更好地控制渲染时机，为后续的并发特性打下了基础。关于 Fiber 架构的详细原理，可以参考<a href="https://juejin.cn/post/7395079370795663414" target="_blank" title="https://juejin.cn/post/7395079370795663414">这篇文章</a>。</p>
<p>基于 Fiber 架构，React 18 引入了并发特性（Concurrent Features），这是 React 历史上最重要的架构升级之一。并发渲染让 React 能在渲染过程中中断和恢复工作，从而保持用户界面的响应性。<code>useTransition</code> Hook 正是这一特性的核心 API 之一，它允许我们把某些状态更新标记为"非紧急"，让 React 优先处理更重要的更新（比如用户输入），从而显著提升用户体验。</p>
<p>在本文中，我们会通过一个实际的演示案例，深入对比三种不同的更新策略：<strong>同步更新</strong>、<strong>防抖更新</strong>和<strong>并发更新（useTransition）</strong>，然后从 React 源码层面解析 <code>useTransition</code> 的实现原理，帮你全面理解这个强大的性能优化工具。</p>
<h2 data-id="heading-1">交互式演示</h2>
<p>在深入技术细节之前，我们先通过一个交互式演示来直观感受三种策略的差异：</p>
<p><span href="https://code.juejin.cn/pen/7583281119522078762" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7583281119522078762" data-src="https://code.juejin.cn/pen/7583281119522078762" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<p>在这个演示里，你可以：</p>
<ol>
<li>在输入框里输入文字，输入越长，图表渲染的数据点越多</li>
<li>切换三种不同的更新策略（Synchronous、Debounced、Concurrent）</li>
<li>观察右上角的时钟动画，它是检测 UI 是否卡顿的"晴雨表"</li>
</ol>
<h2 data-id="heading-2">性能对比演示</h2>
<p>我们通过三个 GIF 动图来直观对比三种策略的表现：</p>
<h3 data-id="heading-3">1. 同步更新（Synchronous）</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62445737486a42fe88d06c68b9c4764c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnl0ZW1hbng=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766240048&amp;x-signature=N6Cy4Lj0o1wFNNK2jqSnEsh3F9M%3D" alt="synchronous.gif" loading="lazy"/></p>
<p><strong>重要说明</strong>：图中显示的输入暂停是<strong>页面卡顿导致的结果</strong>，不是用户主动停止输入。当用户持续输入时，由于同步渲染阻塞了主线程，导致输入框无法及时响应。右上角时钟动画的明显卡顿证明了主线程被渲染任务完全阻塞。这是同步更新的最大问题：即使输入响应即时，但渲染会阻塞用户交互。</p>
<p><strong>特点</strong>：</p>
<ul>
<li>✅ 输入响应即时，无延迟</li>
<li>❌ 每次输入都会立即触发完整渲染</li>
<li>❌ 当数据量大时，时钟动画会明显卡顿</li>
<li>❌ 用户输入可能被阻塞，体验不流畅</li>
</ul>
<p><strong>适用场景</strong>：数据量小、渲染简单的场景</p>
<h3 data-id="heading-4">2. 防抖更新（Debounced）</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc14c159b24b4e7db59a3807d22a449d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnl0ZW1hbng=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766240048&amp;x-signature=YfFqGLErgZMC9RM9tCvBuHYc%2B0A%3D" alt="debounce.gif" loading="lazy"/></p>
<p><strong>重要说明</strong>：图中显示的等待期间是<strong>防抖延迟机制</strong>的表现（固定1000ms延迟）。<strong>防抖的延迟太大</strong>，用户输入后需要等1秒才能看到结果更新。虽然避免了频繁渲染，但固定的延迟时间影响了用户体验。用户无法及时看到输入反馈，需要等防抖时间结束。</p>
<p><strong>特点</strong>：</p>
<ul>
<li>✅ 减少渲染次数，避免频繁更新</li>
<li>✅ 等待用户停止输入后才更新</li>
<li>❌ 有固定的延迟（1000ms），用户需要等待</li>
<li>❌ 时钟动画在等待期间可能不流畅</li>
<li>❌ 无法利用 React 的并发特性</li>
</ul>
<p><strong>适用场景</strong>：需要减少 API 调用或计算次数的场景</p>
<h3 data-id="heading-5">3. 并发更新（Concurrent / useTransition）</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/261c2c9a4cfd4035b41815a045995953~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnl0ZW1hbng=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766240048&amp;x-signature=4OWNS3lfJhHtOe5Ct%2BheuDcERT8%3D" alt="concurrent.gif" loading="lazy"/></p>
<p><strong>重要说明</strong>：图中显示的流畅表现是<strong>并发渲染</strong>的效果。<strong>并发模式可以及时响应用户输入</strong>，无需等待延迟，输入框立即响应。即使在大数据量渲染时，时钟动画始终保持流畅，证明主线程未被阻塞。渲染过程可以被中断，优先处理用户输入，然后继续完成渲染任务。这是并发更新的核心优势：既保证了输入响应性，又完成了复杂渲染。</p>
<p><strong>特点</strong>：</p>
<ul>
<li>✅ 输入响应即时，无延迟</li>
<li>✅ 渲染过程可中断，保持 UI 响应性</li>
<li>✅ 时钟动画始终保持流畅</li>
<li>✅ 自动平衡输入响应和渲染性能</li>
<li>✅ 利用 React 18 的并发特性</li>
</ul>
<p><strong>适用场景</strong>：需要保持 UI 响应性的复杂渲染场景</p>
<h2 data-id="heading-6">演示代码解析</h2>
<p>这个演示应用基于 React 官方的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Ftree%2Fmain%2Ffixtures%2Fconcurrent%2Ftime-slicing" target="_blank" title="https://github.com/facebook/react/tree/main/fixtures/concurrent/time-slicing" ref="nofollow noopener noreferrer">time-slicing fixture</a>，展示了三种不同的状态更新策略。我们来看看关键代码实现：</p>
<h3 data-id="heading-7">三种更新策略</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">AppContent</span>(<span class="hljs-params">{ complexity }: AppProps</span>) {
  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [strategy, setStrategy] = useState&lt;<span class="hljs-title class_">Strategy</span>&gt;(<span class="hljs-string">'sync'</span>);
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

  <span class="hljs-comment">// 防抖处理函数</span>
  <span class="hljs-keyword">const</span> debouncedSetValue = <span class="hljs-title function_">useMemo</span>(
    <span class="hljs-function">() =&gt;</span>
      <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">newValue: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
        <span class="hljs-title function_">setValue</span>(newValue);
      }, <span class="hljs-number">1000</span>),
    []
  );

  <span class="hljs-keyword">const</span> handleChange = <span class="hljs-title function_">useCallback</span>(
    <span class="hljs-function">(<span class="hljs-params">e: React.ChangeEvent&lt;HTMLInputElement&gt;</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> newValue = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">switch</span> (strategy) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'sync'</span>:
          <span class="hljs-comment">// 策略 1: 同步更新 - 立即触发渲染</span>
          <span class="hljs-title function_">setValue</span>(newValue);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'debounced'</span>:
          <span class="hljs-comment">// 策略 2: 防抖更新 - 延迟 1000ms 后更新</span>
          <span class="hljs-title function_">debouncedSetValue</span>(newValue);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'async'</span>:
          <span class="hljs-comment">// 策略 3: 并发更新 - 使用 useTransition</span>
          <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">setValue</span>(newValue);
          });
          <span class="hljs-keyword">break</span>;
      }
    },
    [strategy, debouncedSetValue, startTransition]
  );

  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">getStreamData</span>(value, complexity);
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-8">useTransition 使用详解</h3>
<p>在上面的代码里，我们看到了 <code>useTransition</code> 的基本使用。我们详细解析一下：</p>
<h4 data-id="heading-9">1. useTransition 的基本用法</h4>
<p><code>useTransition</code> 是一个 Hook，它返回一个包含两个元素的数组：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();
</code></pre>
<ul>
<li><strong><code>isPending</code></strong>：一个布尔值，表示当前有没有正在进行的 transition 更新。当 <code>startTransition</code> 里的更新正在处理时，<code>isPending</code> 为 <code>true</code>；更新完成后变为 <code>false</code>。</li>
<li><strong><code>startTransition</code></strong>：一个函数，用来把状态更新标记为"非紧急"的 transition 更新。</li>
</ul>
<h4 data-id="heading-10">2. startTransition 的使用方式</h4>
<p><code>startTransition</code> 接收一个回调函数，在这个回调函数里执行的状态更新会被标记为低优先级：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">case</span> <span class="hljs-string">'async'</span>:
  <span class="hljs-comment">// 策略 3: 并发更新 - 使用 useTransition</span>
  <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setValue</span>(newValue);
  });
  <span class="hljs-keyword">break</span>;
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>所有在 <code>startTransition</code> 回调里调用的 <code>setState</code> 都会被标记为 transition 更新</li>
<li>可以同时更新多个状态：
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">setValue</span>(newValue);
  <span class="hljs-title function_">setFilteredResults</span>(<span class="hljs-title function_">filterResults</span>(newValue));
  <span class="hljs-title function_">setSearchHistory</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, newValue]);
});
</code></pre>
</li>
<li><code>startTransition</code> 是同步执行的，但里面的状态更新会被异步处理</li>
<li>不要在 <code>startTransition</code> 里执行副作用（比如 API 调用、DOM 操作等），只用来更新状态</li>
</ul>
<h4 data-id="heading-11">3. isPending 的实际应用</h4>
<p><code>isPending</code> 可以用来向用户提供视觉反馈，表示应用正在处理 transition 更新。在演示代码里，我们用 <code>isPending</code> 来改变输入框的透明度：</p>
<pre><code class="hljs language-typescript" lang="typescript">&lt;input
  className={<span class="hljs-string">`p-3 sm:p-4 text-xl sm:text-3xl w-full block bg-white text-black rounded <span class="hljs-subst">${inputColorClass}</span> <span class="hljs-subst">${
    isPending ? <span class="hljs-string">'opacity-70'</span> : <span class="hljs-string">''</span>
  }</span>`</span>}
  placeholder=<span class="hljs-string">"longer input → more components"</span>
  onChange={handleChange}
/&gt;
</code></pre>
<p>当 <code>isPending</code> 为 <code>true</code> 时，输入框会变成半透明（<code>opacity-70</code>），给用户一个视觉提示，表明后台正在处理更新。</p>
<h3 data-id="heading-12">关键组件说明</h3>
<p><strong>1. Charts 组件</strong>
用 Victory 图表库渲染大量数据点。根据输入长度动态生成数据复杂度：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getStreamData</span>(<span class="hljs-params">input: <span class="hljs-built_in">string</span>, complexity: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">StreamData</span> {
  <span class="hljs-keyword">const</span> cacheKey = <span class="hljs-string">`<span class="hljs-subst">${input}</span>-<span class="hljs-subst">${complexity}</span>`</span>;
  <span class="hljs-keyword">if</span> (cachedData.<span class="hljs-title function_">has</span>(cacheKey)) {
    <span class="hljs-keyword">return</span> cachedData.<span class="hljs-title function_">get</span>(cacheKey)!;
  }
  <span class="hljs-keyword">const</span> multiplier = input.<span class="hljs-property">length</span> !== <span class="hljs-number">0</span> ? input.<span class="hljs-property">length</span> : <span class="hljs-number">1</span>;
  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">range</span>(<span class="hljs-number">5</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span>
    <span class="hljs-title function_">range</span>(complexity * multiplier).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">j: <span class="hljs-built_in">number</span></span>) =&gt;</span> ({
      <span class="hljs-attr">x</span>: j,
      <span class="hljs-attr">y</span>: <span class="hljs-title function_">random</span>(<span class="hljs-number">0</span>, <span class="hljs-number">255</span>),
    }))
  );
  cachedData.<span class="hljs-title function_">set</span>(cacheKey, data);
  <span class="hljs-keyword">return</span> data;
}
</code></pre>
<p><strong>2. Clock 组件</strong>
一个实时 SVG 动画时钟，用来检测 UI 是否卡顿。如果主线程被阻塞，时钟动画会明显掉帧。</p>
<p><strong>3. 数据生成策略</strong></p>
<ul>
<li>输入长度越长，生成的数据点越多</li>
<li>用缓存机制避免重复计算</li>
<li>复杂度参数控制基础数据量</li>
</ul>
<h2 data-id="heading-13">React 源码深度解析</h2>
<p>我们用了很多次 <code>useTransition</code>，也看到了它的效果。现在来看看 React 源码里它是怎么实现的。</p>
<h3 data-id="heading-14">useTransition 入口函数</h3>
<p><code>useTransition</code> 的入口在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Fblob%2F053df4e8561ef4caecef31c330f4178ac25e255b%2Fpackages%2Freact%2Fsrc%2FReactHooks.js%23L170-L176" target="_blank" title="https://github.com/facebook/react/blob/053df4e8561ef4caecef31c330f4178ac25e255b/packages/react/src/ReactHooks.js#L170-L176" ref="nofollow noopener noreferrer">packages/react/src/ReactHooks.js</a> 文件中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useTransition</span>(<span class="hljs-params"/>): [
  boolean,
  <span class="hljs-function">(<span class="hljs-params">callback: () =&gt; <span class="hljs-keyword">void</span>, options?: StartTransitionOptions</span>) =&gt;</span> <span class="hljs-keyword">void</span>,
] {
  <span class="hljs-keyword">const</span> dispatcher = <span class="hljs-title function_">resolveDispatcher</span>();
  <span class="hljs-keyword">return</span> dispatcher.<span class="hljs-title function_">useTransition</span>();
}
</code></pre>
<p>很简单，就是通过 <code>resolveDispatcher()</code> 拿到 dispatcher，然后调用 <code>dispatcher.useTransition()</code>。</p>
<p>这个 dispatcher 是什么呢？React 会根据当前是首次渲染还是更新渲染，给你不同的 dispatcher。首次渲染的时候，dispatcher 里的 <code>useTransition</code> 会调用 <code>mountTransition</code>；更新渲染的时候，会调用 <code>updateTransition</code>。</p>
<p>有同学说，为什么要这样设计？因为 React 需要区分首次渲染和更新渲染。首次渲染的时候，需要创建新的 Hook 对象；更新渲染的时候，需要复用之前的 Hook 对象。</p>
<h3 data-id="heading-15">mountTransition：首次渲染</h3>
<p>组件首次渲染时，会调用 <code>mountTransition</code>。我们来看看它的实现：</p>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Fblob%2F053df4e8561ef4caecef31c330f4178ac25e255b%2Fpackages%2Freact-reconciler%2Fsrc%2FReactFiberHooks.js%23L3398-L3414" target="_blank" title="https://github.com/facebook/react/blob/053df4e8561ef4caecef31c330f4178ac25e255b/packages/react-reconciler/src/ReactFiberHooks.js#L3398-L3414" ref="nofollow noopener noreferrer">packages/react-reconciler/src/ReactFiberHooks.js</a> 中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">mountTransition</span>(<span class="hljs-params"/>): [
  boolean,
  <span class="hljs-function">(<span class="hljs-params">callback: () =&gt; <span class="hljs-keyword">void</span>, options?: StartTransitionOptions</span>) =&gt;</span> <span class="hljs-keyword">void</span>,
] {
  <span class="hljs-keyword">const</span> stateHook = <span class="hljs-title function_">mountStateImpl</span>((<span class="hljs-attr">false</span>: <span class="hljs-title class_">Thenable</span>&lt;boolean&gt; | boolean));
  <span class="hljs-comment">// The `start` method never changes.</span>
  <span class="hljs-keyword">const</span> start = startTransition.<span class="hljs-title function_">bind</span>(
    <span class="hljs-literal">null</span>,
    currentlyRenderingFiber,
    stateHook.<span class="hljs-property">queue</span>,
    <span class="hljs-literal">true</span>,
    <span class="hljs-literal">false</span>,
  );
  <span class="hljs-keyword">const</span> hook = <span class="hljs-title function_">mountWorkInProgressHook</span>();
  hook.<span class="hljs-property">memoizedState</span> = start;
  <span class="hljs-keyword">return</span> [<span class="hljs-literal">false</span>, start];
}
</code></pre>
<p>这段代码做了几件事：</p>
<ol>
<li>用 <code>mountStateImpl</code> 创建一个内部状态，初始值是 <code>false</code>。这个状态用来表示当前是不是 pending 状态。</li>
<li>通过 <code>bind</code> 创建一个 <code>start</code> 函数，绑定了当前 fiber 和 state queue。这个 <code>start</code> 函数就是 <code>startTransition</code>，但已经绑定了必要的上下文。</li>
<li>把 <code>start</code> 函数存到 hook 的 <code>memoizedState</code> 里，这样下次更新的时候还能拿到同一个函数。</li>
<li>返回 <code>[false, start]</code>，初始状态不是 pending。</li>
</ol>
<h3 data-id="heading-16">updateTransition：更新渲染</h3>
<p>组件更新渲染时，会调用 <code>updateTransition</code>：</p>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Fblob%2F053df4e8561ef4caecef31c330f4178ac25e255b%2Fpackages%2Freact-reconciler%2Fsrc%2FReactFiberHooks.js%23L3416-L3429" target="_blank" title="https://github.com/facebook/react/blob/053df4e8561ef4caecef31c330f4178ac25e255b/packages/react-reconciler/src/ReactFiberHooks.js#L3416-L3429" ref="nofollow noopener noreferrer">packages/react-reconciler/src/ReactFiberHooks.js</a> 中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateTransition</span>(<span class="hljs-params"/>): [
  boolean,
  <span class="hljs-function">(<span class="hljs-params">callback: () =&gt; <span class="hljs-keyword">void</span>, options?: StartTransitionOptions</span>) =&gt;</span> <span class="hljs-keyword">void</span>,
] {
  <span class="hljs-keyword">const</span> [booleanOrThenable] = <span class="hljs-title function_">updateState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> hook = <span class="hljs-title function_">updateWorkInProgressHook</span>();
  <span class="hljs-keyword">const</span> start = hook.<span class="hljs-property">memoizedState</span>;
  <span class="hljs-keyword">const</span> isPending =
    <span class="hljs-keyword">typeof</span> booleanOrThenable === <span class="hljs-string">'boolean'</span>
      ? booleanOrThenable
      : <span class="hljs-comment">// This will suspend until the async action scope has finished.</span>
        <span class="hljs-title function_">useThenable</span>(booleanOrThenable);
  <span class="hljs-keyword">return</span> [isPending, start];
}
</code></pre>
<p>这里做了几件事：</p>
<ol>
<li>调用 <code>updateState(false)</code> 获取当前的 pending 状态。这个状态在 <code>startTransition</code> 执行的时候会被更新。</li>
<li>从 hook 的 <code>memoizedState</code> 里拿到之前存的 <code>start</code> 函数。这个函数在首次渲染的时候就创建好了，之后不会变。</li>
<li>判断 <code>isPending</code>。如果状态是 boolean，直接返回；如果是 Promise（比如异步 action），就用 <code>useThenable</code> 等待它完成。</li>
<li>返回 <code>[isPending, start]</code>。</li>
</ol>
<p>体会到 <code>useTransition</code> 的设计了么？它本质上就是 <code>useState</code> + <code>startTransition</code>。用 <code>useState</code> 来管理 pending 状态，用 <code>startTransition</code> 来标记更新为低优先级。</p>
<h3 data-id="heading-17">startTransition 函数实现</h3>
<p><code>startTransition</code> 的实现在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Fblob%2F053df4e8561ef4caecef31c330f4178ac25e255b%2Fpackages%2Freact%2Fsrc%2FReactStartTransition.js%23L45-L117" target="_blank" title="https://github.com/facebook/react/blob/053df4e8561ef4caecef31c330f4178ac25e255b/packages/react/src/ReactStartTransition.js#L45-L117" ref="nofollow noopener noreferrer">packages/react/src/ReactStartTransition.js</a> 文件中。这个函数的核心作用是设置一个全局的 transition 上下文，让 React 知道当前正在执行 transition 更新。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startTransition</span>(<span class="hljs-params">
  scope: () =&gt; <span class="hljs-keyword">void</span>,
  options?: StartTransitionOptions,
</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-keyword">const</span> prevTransition = <span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">T</span>;
  <span class="hljs-keyword">const</span> <span class="hljs-attr">currentTransition</span>: <span class="hljs-title class_">Transition</span> = ({}: any);
  <span class="hljs-keyword">if</span> (enableViewTransition) {
    currentTransition.<span class="hljs-property">types</span> =
      prevTransition !== <span class="hljs-literal">null</span>
        ? <span class="hljs-comment">// If we're a nested transition, we should use the same set as the parent</span>
          <span class="hljs-comment">// since we're conceptually always joined into the same entangled transition.</span>
          <span class="hljs-comment">// In practice, this only matters if we add transition types in the inner</span>
          <span class="hljs-comment">// without setting state. In that case, the inner transition can finish</span>
          <span class="hljs-comment">// without waiting for the outer.</span>
          prevTransition.<span class="hljs-property">types</span>
        : <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">if</span> (enableGestureTransition) {
    currentTransition.<span class="hljs-property">gesture</span> = <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">if</span> (enableTransitionTracing) {
    currentTransition.<span class="hljs-property">name</span> =
      options !== <span class="hljs-literal">undefined</span> &amp;&amp; options.<span class="hljs-property">name</span> !== <span class="hljs-literal">undefined</span> ? options.<span class="hljs-property">name</span> : <span class="hljs-literal">null</span>;
    currentTransition.<span class="hljs-property">startTime</span> = -<span class="hljs-number">1</span>; <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> This should read the timestamp.</span>
  }
  <span class="hljs-keyword">if</span> (__DEV__) {
    currentTransition.<span class="hljs-property">_updatedFibers</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
  }
  <span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">T</span> = currentTransition;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> returnValue = <span class="hljs-title function_">scope</span>();
    <span class="hljs-keyword">const</span> onStartTransitionFinish = <span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">S</span>;
    <span class="hljs-keyword">if</span> (onStartTransitionFinish !== <span class="hljs-literal">null</span>) {
      <span class="hljs-title function_">onStartTransitionFinish</span>(currentTransition, returnValue);
    }
    <span class="hljs-keyword">if</span> (
      <span class="hljs-keyword">typeof</span> returnValue === <span class="hljs-string">'object'</span> &amp;&amp;
      returnValue !== <span class="hljs-literal">null</span> &amp;&amp;
      <span class="hljs-keyword">typeof</span> returnValue.<span class="hljs-property">then</span> === <span class="hljs-string">'function'</span>
    ) {
      <span class="hljs-keyword">if</span> (__DEV__) {
        <span class="hljs-comment">// Keep track of the number of async transitions still running so we can warn.</span>
        <span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">asyncTransitions</span>++;
        returnValue.<span class="hljs-title function_">then</span>(releaseAsyncTransition, releaseAsyncTransition);
      }
      returnValue.<span class="hljs-title function_">then</span>(noop, reportGlobalError);
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-title function_">reportGlobalError</span>(error);
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-title function_">warnAboutTransitionSubscriptions</span>(prevTransition, currentTransition);
    <span class="hljs-keyword">if</span> (prevTransition !== <span class="hljs-literal">null</span> &amp;&amp; currentTransition.<span class="hljs-property">types</span> !== <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// If we created a new types set in the inner transition, we transfer it to the parent</span>
      <span class="hljs-comment">// since they should share the same set. They're conceptually entangled.</span>
      <span class="hljs-keyword">if</span> (__DEV__) {
        <span class="hljs-keyword">if</span> (
          prevTransition.<span class="hljs-property">types</span> !== <span class="hljs-literal">null</span> &amp;&amp;
          prevTransition.<span class="hljs-property">types</span> !== currentTransition.<span class="hljs-property">types</span>
        ) {
          <span class="hljs-comment">// Just assert that assumption holds that we're not overriding anything.</span>
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(
            <span class="hljs-string">'We expected inner Transitions to have transferred the outer types set and '</span> +
              <span class="hljs-string">'that you cannot add to the outer Transition while inside the inner.'</span> +
              <span class="hljs-string">'This is a bug in React.'</span>,
          );
        }
      }
      prevTransition.<span class="hljs-property">types</span> = currentTransition.<span class="hljs-property">types</span>;
    }
    <span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">T</span> = prevTransition;
  }
}
</code></pre>
<p>这段代码的逻辑很简单：</p>
<ol>
<li><strong>保存之前的 transition</strong>：先把当前的 <code>ReactSharedInternals.T</code> 存起来，因为可能已经有 transition 在运行了（支持嵌套）。</li>
<li><strong>创建新的 transition 对象</strong>：初始化一个新的 transition 对象。如果是嵌套的 transition，会继承外层的 types。</li>
<li><strong>设置全局 transition</strong>：把新创建的 transition 赋值给 <code>ReactSharedInternals.T</code>。这样，在 <code>scope</code> 函数里调用的 <code>setState</code> 就能知道当前在 transition 里了。</li>
<li><strong>执行用户代码</strong>：在 try 块里执行你传入的 <code>scope</code> 函数。</li>
<li><strong>处理异步返回值</strong>：如果 <code>scope</code> 返回的是 Promise，会做一些处理，比如在开发模式下跟踪异步 transition 的数量。</li>
<li><strong>恢复状态</strong>：在 finally 块里恢复之前的 transition 状态。这样嵌套的 transition 就能正确恢复。</li>
</ol>
<p>这个设计还支持嵌套 transition。比如你在一个 <code>startTransition</code> 里又调用了另一个 <code>startTransition</code>，内层的会继承外层的 types，它们会被当作同一个 transition 处理。</p>
<h3 data-id="heading-18">优先级调度机制</h3>
<p>React 用 Lane 模型来管理更新的优先级。Lane 就是"车道"的意思，不同的更新走不同的车道，优先级高的车道可以先走。</p>
<p>当你在 <code>startTransition</code> 里调用 <code>setState</code> 的时候，React 怎么知道这个更新是低优先级的呢？我们来看看 <code>requestUpdateLane</code> 这个函数：</p>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Fblob%2F053df4e8561ef4caecef31c330f4178ac25e255b%2Fpackages%2Freact-reconciler%2Fsrc%2FReactFiberWorkLoop.js%23L792-L836" target="_blank" title="https://github.com/facebook/react/blob/053df4e8561ef4caecef31c330f4178ac25e255b/packages/react-reconciler/src/ReactFiberWorkLoop.js#L792-L836" ref="nofollow noopener noreferrer">packages/react-reconciler/src/ReactFiberWorkLoop.js</a> 中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">requestUpdateLane</span>(<span class="hljs-params">fiber: Fiber</span>): <span class="hljs-title class_">Lane</span> {
  <span class="hljs-comment">// Special cases</span>
  <span class="hljs-keyword">const</span> mode = fiber.<span class="hljs-property">mode</span>;
  <span class="hljs-keyword">if</span> (!disableLegacyMode &amp;&amp; (mode &amp; <span class="hljs-title class_">ConcurrentMode</span>) === <span class="hljs-title class_">NoMode</span>) {
    <span class="hljs-keyword">return</span> (<span class="hljs-title class_">SyncLane</span>: <span class="hljs-title class_">Lane</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
    (executionContext &amp; <span class="hljs-title class_">RenderContext</span>) !== <span class="hljs-title class_">NoContext</span> &amp;&amp;
    workInProgressRootRenderLanes !== <span class="hljs-title class_">NoLanes</span>
  ) {
    <span class="hljs-comment">// This is a render phase update. These are not officially supported. The</span>
    <span class="hljs-comment">// old behavior is to give this the same "thread" (lanes) as</span>
    <span class="hljs-comment">// whatever is currently rendering. So if you call `setState` on a component</span>
    <span class="hljs-comment">// that happens later in the same render, it will flush. Ideally, we want to</span>
    <span class="hljs-comment">// remove the special case and treat them as if they came from an</span>
    <span class="hljs-comment">// interleaved event. Regardless, this pattern is not officially supported.</span>
    <span class="hljs-comment">// This behavior is only a fallback. The flag only exists until we can roll</span>
    <span class="hljs-comment">// out the setState warning, since existing code might accidentally rely on</span>
    <span class="hljs-comment">// the current behavior.</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">pickArbitraryLane</span>(workInProgressRootRenderLanes);
  }

  <span class="hljs-keyword">const</span> transition = <span class="hljs-title function_">requestCurrentTransition</span>();
  <span class="hljs-keyword">if</span> (transition !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (enableGestureTransition) {
      <span class="hljs-keyword">if</span> (transition.<span class="hljs-property">gesture</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(
          <span class="hljs-string">'Cannot setState on regular state inside a startGestureTransition. '</span> +
            <span class="hljs-string">'Gestures can only update the useOptimistic() hook. There should be no '</span> +
            <span class="hljs-string">'side-effects associated with starting a Gesture until its Action is '</span> +
            <span class="hljs-string">'invoked. Move side-effects to the Action instead.'</span>,
        );
      }
    }
    <span class="hljs-keyword">if</span> (__DEV__) {
      <span class="hljs-keyword">if</span> (!transition.<span class="hljs-property">_updatedFibers</span>) {
        transition.<span class="hljs-property">_updatedFibers</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
      }
      transition.<span class="hljs-property">_updatedFibers</span>.<span class="hljs-title function_">add</span>(fiber);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-title function_">requestTransitionLane</span>(transition);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">eventPriorityToLane</span>(<span class="hljs-title function_">resolveUpdatePriority</span>());
}
</code></pre>
<p>这个函数的工作流程很简单：</p>
<ol>
<li>先检查 fiber 的模式，如果不是并发模式，直接返回同步 lane。</li>
<li>检查是不是在渲染阶段更新（这个不推荐，但 React 还是支持了）。</li>
<li><strong>关键步骤</strong>：调用 <code>requestCurrentTransition()</code> 检查当前有没有 active transition。这个函数会去读 <code>ReactSharedInternals.T</code>，也就是 <code>startTransition</code> 设置的那个全局变量。</li>
<li>如果有 transition，调用 <code>requestTransitionLane()</code> 返回 transition lane（低优先级）。</li>
<li>否则，用 <code>eventPriorityToLane()</code> 返回默认的 event priority lane（高优先级）。</li>
</ol>
<p>所以，当你在 <code>startTransition</code> 里调用 <code>setState</code> 的时候，React 会检查到当前有 active transition，然后给你分配一个低优先级的 lane。</p>
<h4 data-id="heading-19">requestTransitionLane</h4>
<p><code>requestTransitionLane</code> 负责分配 transition lane。我们来看看它的实现：</p>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Fblob%2F053df4e8561ef4caecef31c330f4178ac25e255b%2Fpackages%2Freact-reconciler%2Fsrc%2FReactFiberRootScheduler.js%23L697-L723" target="_blank" title="https://github.com/facebook/react/blob/053df4e8561ef4caecef31c330f4178ac25e255b/packages/react-reconciler/src/ReactFiberRootScheduler.js#L697-L723" ref="nofollow noopener noreferrer">packages/react-reconciler/src/ReactFiberRootScheduler.js</a> 中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">requestTransitionLane</span>(<span class="hljs-params">
  <span class="hljs-comment">// This argument isn't used, it's only here to encourage the caller to</span>
  <span class="hljs-comment">// check that it's inside a transition before calling this function.</span>
  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Make this non-nullable. Requires a tweak to useOptimistic.</span>
  transition: Transition | <span class="hljs-literal">null</span>,
</span>): <span class="hljs-title class_">Lane</span> {
  <span class="hljs-comment">// The algorithm for assigning an update to a lane should be stable for all</span>
  <span class="hljs-comment">// updates at the same priority within the same event. To do this, the</span>
  <span class="hljs-comment">// inputs to the algorithm must be the same.</span>
  <span class="hljs-comment">//</span>
  <span class="hljs-comment">// The trick we use is to cache the first of each of these inputs within an</span>
  <span class="hljs-comment">// event. Then reset the cached values once we can be sure the event is</span>
  <span class="hljs-comment">// over. Our heuristic for that is whenever we enter a concurrent work loop.</span>
  <span class="hljs-keyword">if</span> (currentEventTransitionLane === <span class="hljs-title class_">NoLane</span>) {
    <span class="hljs-comment">// All transitions within the same event are assigned the same lane.</span>
    <span class="hljs-keyword">const</span> actionScopeLane = <span class="hljs-title function_">peekEntangledActionLane</span>();
    currentEventTransitionLane =
      actionScopeLane !== <span class="hljs-title class_">NoLane</span>
        ? <span class="hljs-comment">// We're inside an async action scope. Reuse the same lane.</span>
          actionScopeLane
        : <span class="hljs-comment">// We may or may not be inside an async action scope. If we are, this</span>
          <span class="hljs-comment">// is the first update in that scope. Either way, we need to get a</span>
          <span class="hljs-comment">// fresh transition lane.</span>
          <span class="hljs-title function_">claimNextTransitionUpdateLane</span>();
  }
  <span class="hljs-keyword">return</span> currentEventTransitionLane;
}
</code></pre>
<p>这个函数做了几件事：</p>
<ol>
<li><strong>事件级别的 lane 缓存</strong>：同一个事件里的所有 transition 更新共享同一个 lane。比如你在一个事件处理函数里调用了多个 <code>startTransition</code>，它们会用同一个 lane。</li>
<li><strong>异步 action scope 支持</strong>：如果你在异步 action scope 里（比如 Server Action），会复用相同的 lane。</li>
<li><strong>lane 分配</strong>：如果没有缓存的 lane，就用 <code>claimNextTransitionUpdateLane()</code> 分配一个新的 transition lane。</li>
</ol>
<h4 data-id="heading-20">Lane 优先级系统</h4>
<p>Lane 是用位运算实现的，这样判断和分配都很快。我们来看看 transition lane 是怎么分配的：</p>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Fblob%2F053df4e8561ef4caecef31c330f4178ac25e255b%2Fpackages%2Freact-reconciler%2Fsrc%2FReactFiberLane.js%23L709-L731" target="_blank" title="https://github.com/facebook/react/blob/053df4e8561ef4caecef31c330f4178ac25e255b/packages/react-reconciler/src/ReactFiberLane.js#L709-L731" ref="nofollow noopener noreferrer">packages/react-reconciler/src/ReactFiberLane.js</a> 中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isTransitionLane</span>(<span class="hljs-params">lane: Lane</span>): boolean {
  <span class="hljs-keyword">return</span> (lane &amp; <span class="hljs-title class_">TransitionLanes</span>) !== <span class="hljs-title class_">NoLanes</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">claimNextTransitionUpdateLane</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Lane</span> {
  <span class="hljs-comment">// Cycle through the lanes, assigning each new transition to the next lane.</span>
  <span class="hljs-comment">// In most cases, this means every transition gets its own lane, until we</span>
  <span class="hljs-comment">// run out of lanes and cycle back to the beginning.</span>
  <span class="hljs-keyword">const</span> lane = nextTransitionUpdateLane;
  nextTransitionUpdateLane &lt;&lt;= <span class="hljs-number">1</span>;
  <span class="hljs-keyword">if</span> ((nextTransitionUpdateLane &amp; <span class="hljs-title class_">TransitionUpdateLanes</span>) === <span class="hljs-title class_">NoLanes</span>) {
    nextTransitionUpdateLane = <span class="hljs-title class_">TransitionLane1</span>;
  }
  <span class="hljs-keyword">return</span> lane;
}
</code></pre>
<p><code>claimNextTransitionUpdateLane</code> 的逻辑很简单：</p>
<ol>
<li>取当前的 <code>nextTransitionUpdateLane</code> 作为要返回的 lane。</li>
<li>把 <code>nextTransitionUpdateLane</code> 左移一位（相当于乘以 2），这样下次就能分配下一个 lane。</li>
<li>如果左移后超出了 transition lanes 的范围，就循环回到第一个 transition lane。</li>
</ol>
<p>这样，每个新的 transition 都会得到自己的 lane，直到 lanes 用尽，然后循环使用。</p>
<p>Lane 的优先级规则是：Transition lanes 的优先级低于同步 lanes（SyncLane）和默认 lanes（DefaultLane）。所以当有高优先级的更新（比如用户输入）时，React 会中断 transition 的渲染，先处理高优先级的更新，然后再回来继续渲染 transition。</p>
<h2 data-id="heading-21">工作原理流程图</h2>
<p>让我们通过流程图来理解 <code>useTransition</code> 的完整工作流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[用户调用 startTransition] --&gt; B[设置 ReactSharedInternals.T]
    B --&gt; C[执行 scope 函数]
    C --&gt; D[调用 setState]
    D --&gt; E[requestUpdateLane]
    E --&gt; F{检查是否有 active transition?}
    F --&gt;|是| G[requestTransitionLane]
    F --&gt;|否| H[eventPriorityToLane]
    G --&gt; I[分配 Transition Lane]
    I --&gt; J[标记更新为低优先级]
    J --&gt; K[React 调度器处理]
    K --&gt; L{有更高优先级更新?}
    L --&gt;|是| M[中断 transition 渲染]
    L --&gt;|否| N[继续渲染 transition 更新]
    M --&gt; O[处理高优先级更新]
    O --&gt; P[恢复 transition 渲染]
    N --&gt; Q[完成渲染]
    P --&gt; Q
    Q --&gt; R[恢复 ReactSharedInternals.T]
    
    style I fill:#e1f5ff
    style J fill:#e1f5ff
    style M fill:#fff4e6
    style O fill:#fff4e6
</code></pre>
<p><strong>流程说明</strong>：</p>
<ol>
<li>用户调用 <code>startTransition</code>，设置全局 transition 上下文</li>
<li>在 scope 中调用 <code>setState</code> 触发更新</li>
<li>React 通过 <code>requestUpdateLane</code> 检查是否有 active transition</li>
<li>如果有，分配 transition lane（低优先级）</li>
<li>React 调度器可以中断 transition 渲染来处理更高优先级的更新</li>
<li>高优先级更新完成后，恢复 transition 渲染</li>
<li>最终恢复 transition 上下文</li>
</ol>
<h2 data-id="heading-22">最佳实践</h2>
<h3 data-id="heading-23">何时使用 useTransition</h3>
<p><code>useTransition</code> 特别适合以下场景：</p>
<ol>
<li>
<p><strong>搜索和筛选</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();
<span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSearch</span> = (<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-title function_">setQuery</span>(value); <span class="hljs-comment">// 高优先级：立即更新输入框</span>
  <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setFilteredResults</span>(<span class="hljs-title function_">filterResults</span>(value)); <span class="hljs-comment">// 低优先级：延迟更新结果</span>
  });
};
</code></pre>
</li>
<li>
<p><strong>标签切换</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();
<span class="hljs-keyword">const</span> [activeTab, setActiveTab] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'home'</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTabChange</span> = (<span class="hljs-params">tab: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setActiveTab</span>(tab); <span class="hljs-comment">// 标签内容渲染可以延迟</span>
  });
};
</code></pre>
</li>
<li>
<p><strong>列表渲染</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();
<span class="hljs-keyword">const</span> [items, setItems] = <span class="hljs-title function_">useState</span>([]);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">loadMoreItems</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setItems</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, ...newItems]); <span class="hljs-comment">// 大量列表项渲染</span>
  });
};
</code></pre>
</li>
</ol>
<h3 data-id="heading-24">与防抖/节流的区别</h3>



































<table><thead><tr><th>特性</th><th>useTransition</th><th>防抖/节流</th></tr></thead><tbody><tr><td>延迟机制</td><td>基于优先级调度</td><td>基于时间延迟</td></tr><tr><td>输入响应</td><td>即时响应</td><td>有固定延迟</td></tr><tr><td>渲染控制</td><td>React 自动管理</td><td>手动控制</td></tr><tr><td>中断能力</td><td>支持中断和恢复</td><td>不支持</td></tr><tr><td>适用场景</td><td>复杂渲染场景</td><td>减少计算/请求</td></tr></tbody></table>
<p><strong>关键区别</strong>：</p>
<ul>
<li><code>useTransition</code> 不会延迟用户输入，而是让 React 智能地调度渲染</li>
<li>防抖/节流会固定延迟，可能影响用户体验</li>
<li><code>useTransition</code> 利用 React 的并发特性，可以中断和恢复渲染</li>
</ul>
<h3 data-id="heading-25">注意事项和限制</h3>
<ol>
<li>
<p><strong>不要用于紧急更新</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 错误：紧急更新不应该用 useTransition</span>
<span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">setError</span>(error); <span class="hljs-comment">// 错误信息应该立即显示</span>
});

<span class="hljs-comment">// ✅ 正确：非紧急的 UI 更新</span>
<span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">setSearchResults</span>(results); <span class="hljs-comment">// 搜索结果可以延迟显示</span>
});
</code></pre>
</li>
<li>
<p><strong>isPending 的使用</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

<span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span> /&gt;</span>
    {isPending &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Spinner</span> /&gt;</span>} {/* 显示加载状态 */}
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
</code></pre>
</li>
<li>
<p><strong>避免在 transition 中进行副作用</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 错误：副作用应该在 transition 外</span>
<span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">setState</span>(newState);
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">'Updated'</span>; <span class="hljs-comment">// 副作用</span>
});

<span class="hljs-comment">// ✅ 正确：只更新状态</span>
<span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">setState</span>(newState);
});
<span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">'Updated'</span>; <span class="hljs-comment">// 副作用在 transition 外</span>
</code></pre>
</li>
<li>
<p><strong>与 Suspense 配合使用</strong></p>
<pre><code class="hljs language-typescript" lang="typescript">&lt;<span class="hljs-title class_">Suspense</span> fallback={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Loading</span> /&gt;</span></span>}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SearchResults</span> <span class="hljs-attr">query</span>=<span class="hljs-string">{query}</span> /&gt;</span></span>
&lt;/<span class="hljs-title class_">Suspense</span>&gt;
</code></pre>
</li>
</ol>
<h2 data-id="heading-26">总结</h2>
<p><code>useTransition</code> 是 React 18 并发特性的核心 API 之一，它通过以下机制实现了优秀的性能优化：</p>
<ol>
<li><strong>优先级调度</strong>：将非紧急更新标记为低优先级，让 React 优先处理用户交互</li>
<li><strong>可中断渲染</strong>：支持中断和恢复，保持 UI 响应性</li>
<li><strong>智能平衡</strong>：自动平衡输入响应和渲染性能</li>
</ol>
<p>通过本文的源码分析，我们了解到：</p>
<ul>
<li><code>useTransition</code> 通过内部状态管理 pending 状态</li>
<li><code>startTransition</code> 通过设置全局上下文标记更新为低优先级</li>
<li>React 调度器通过 Lane 模型管理不同优先级的更新</li>
<li>Transition lanes 的优先级低于同步和默认 lanes</li>
</ul>
<p>在实际开发中，我们应该：</p>
<ul>
<li>将非紧急的 UI 更新包装在 <code>startTransition</code> 中</li>
<li>使用 <code>isPending</code> 提供加载反馈</li>
<li>避免在 transition 中进行副作用</li>
<li>理解与防抖/节流的区别，选择合适的技术</li>
</ul>
<p>React 18 的并发特性为构建高性能、响应迅速的用户界面提供了强大的工具。<code>useTransition</code> 作为其中的重要组成部分，值得我们深入理解和合理使用。</p>
<h2 data-id="heading-27">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseTransition" target="_blank" title="https://react.dev/reference/react/useTransition" ref="nofollow noopener noreferrer">React 官方文档 - useTransition</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Fblob%2F053df4e8561ef4caecef31c330f4178ac25e255b%2Fpackages%2Freact-reconciler%2Fsrc%2FReactFiberHooks.js" target="_blank" title="https://github.com/facebook/react/blob/053df4e8561ef4caecef31c330f4178ac25e255b/packages/react-reconciler/src/ReactFiberHooks.js" ref="nofollow noopener noreferrer">React 源码 - ReactFiberHooks.js</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Fblob%2F053df4e8561ef4caecef31c330f4178ac25e255b%2Fpackages%2Freact%2Fsrc%2FReactStartTransition.js" target="_blank" title="https://github.com/facebook/react/blob/053df4e8561ef4caecef31c330f4178ac25e255b/packages/react/src/ReactStartTransition.js" ref="nofollow noopener noreferrer">React 源码 - ReactStartTransition.js</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Ftree%2Fmain%2Ffixtures%2Fconcurrent%2Ftime-slicing" target="_blank" title="https://github.com/facebook/react/tree/main/fixtures/concurrent/time-slicing" ref="nofollow noopener noreferrer">React 官方示例 - time-slicing fixture</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（三）]]></title>    <link>https://juejin.cn/post/7582854603061575722</link>    <guid>https://juejin.cn/post/7582854603061575722</guid>    <pubDate>2025-12-13T15:54:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582854603061575722" data-draft-id="7582857981894967337" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（三）"/> <meta itemprop="keywords" content="前端,Flutter"/> <meta itemprop="datePublished" content="2025-12-13T15:54:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="名字被你们想完了"/> <meta itemprop="url" content="https://juejin.cn/user/3065854916834782"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（三）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3065854916834782/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    名字被你们想完了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T15:54:23.000Z" title="Sat Dec 13 2025 15:54:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（三）</h2>
<p>Flutter: 3.35.6</p>
<p>因为实现了单个的，给出github链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyhtqw%2FFrontEndDemo" target="_blank" title="https://github.com/yhtqw/FrontEndDemo" ref="nofollow noopener noreferrer">github.com/yhtqw/Front…</a></p>
<p>前面我们简单实现了元素的平移和缩放，接下来我们继续实现旋转功能。</p>
<p>元素的旋转会改变角度，角度一变，那么响应事件的热区也会跟着改变，所以我们得提前考虑这些会因为角度改变而改变的地方。</p>
<p>先来简单实现一下旋转，先不考虑上述的热区问题。</p>
<p>要实现旋转，我们就得知道元素的旋转角度，主要得出旋转的角度，那么实现起来就比较简单，所以简单使用数学的知识分析一下吧</p>
<p>从我们这个需求中可以提取到的数据为按下点的坐标，拖动时变换的坐标；所以我们能否根据一个点的坐标，计算出该点与某点形成的夹角，好像刚好有个满足部分，就是arctan2，arctan2的<strong>主要作用</strong>是根据一个点的坐标，计算出该点与坐标原点所形成的夹角（主要作用）；如果我们要知道给出点与任意(x', y')形成的夹角呢？前面的arctan2中将坐标原点换成任意某点不就行了？</p>
<p>使用 arctan2 计算两点连线的角度，核心是计算两点之间的坐标差 (Δx, Δy)，然后将其作为 arctan2 的参数。所以实现起来就比较简单了。其实这个实现的原理在很多地方都一样，例如web端的元素拖动旋转也可以使用这个原理。实现的方式应该不止一种吧，只要能计算出这个角度就行了。</p>
<p>值得注意的是，现在我们研究的是单个元素，所以坐标系就是以元素自身形成的（响应的事件也是在这个元素上），等后期要实现多个，坐标系就得以外层容器作为参考了。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 其他省略...</span>

<span class="hljs-comment">/// <span class="markdown">新增旋转状态热区字符串</span></span>
<span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> statusRotate = <span class="hljs-string">'rotate'</span>;

<span class="hljs-comment">/// <span class="markdown">抽取响应旋转操作区域的大小</span></span>
<span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> rotateWidth = <span class="hljs-number">20</span>;
<span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> rotateHeight = <span class="hljs-number">20</span>;

<span class="hljs-comment">/// <span class="markdown">旋转角度</span></span>
<span class="hljs-built_in">double</span> rotateNumber = <span class="hljs-number">0</span>;
<span class="hljs-built_in">double</span> initRotateNumber = <span class="hljs-number">0</span>;

<span class="hljs-keyword">void</span> _onPanUpdate(DragUpdateDetails details) {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'更新: <span class="hljs-subst">$details</span>'</span>);
  <span class="hljs-keyword">if</span> (status == statusMove) {
    _onMove(details.localPosition.dx, details.localPosition.dy);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status == statusScale) {
    _onScale(details.delta.dx, details.delta.dy);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status == statusRotate) {
    <span class="hljs-comment">// 新增旋转热区的响应事件</span>
    _onRotate(details.localPosition.dx, details.localPosition.dy);
  }
}

<span class="hljs-keyword">void</span> _onPanEnd() {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'抬起或者因为某些原因并没有触发onPanDown事件'</span>);
  setState(() {
    <span class="hljs-comment">// 当次结束后重新记录，也可以在按下时记录</span>
    initX = x;
    initY = y;
    <span class="hljs-comment">// 新增旋转角度的记录</span>
    initRotateNumber = rotateNumber;
  });
}

<span class="hljs-comment">/// <span class="markdown">处理旋转</span></span>
<span class="hljs-keyword">void</span> _onRotate(<span class="hljs-built_in">double</span> dx, <span class="hljs-built_in">double</span> dy) {
  <span class="hljs-comment">/// <span class="markdown">要计算点 (x, y) 与任意点 (x', y') 连线所成的角度，可以使用 arctan2 函数。</span></span>
  <span class="hljs-comment">/// <span class="markdown">关键在于将两点之间的相对坐标差作为 arctan2 的输入参数。</span></span>
  <span class="hljs-comment">/// <span class="markdown">这里我们以元素的中心为旋转中心</span></span>
  <span class="hljs-comment">/// <span class="markdown">利用上述方法计算起始点（按下时）与中心的连线组成的夹角为初始夹角，</span></span>
  <span class="hljs-comment">/// <span class="markdown">拖动的点与中心点连线组层的夹角为结束时的夹角，</span></span>
  <span class="hljs-comment">/// <span class="markdown">通过初始夹角与结束夹角计算旋转的角度</span></span>

  <span class="hljs-comment">// 确定旋转中心，因为这里的拖动是单个元素，坐标都是相对于元素自身形成的坐标系，所以坐标中心始终都是元素的中心</span>
  <span class="hljs-built_in">double</span> centerX = elementWidth / <span class="hljs-number">2</span>;
  <span class="hljs-built_in">double</span> centerY = elementHeight / <span class="hljs-number">2</span>;

  <span class="hljs-built_in">double</span> diffStartX = startPosition.dx - centerX;
  <span class="hljs-built_in">double</span> diffStartY = startPosition.dy - centerY;
  <span class="hljs-built_in">double</span> diffEndX = dx - centerX;
  <span class="hljs-built_in">double</span> diffEndY = dy - centerY;
  <span class="hljs-built_in">double</span> angleStart = atan2(diffStartY, diffStartX);
  <span class="hljs-built_in">double</span> angleEnd = atan2(diffEndY, diffEndX);

  setState(() {
    rotateNumber = initRotateNumber + angleEnd - angleStart;
  });
}

<span class="hljs-comment">/// <span class="markdown">判断点击在什么区域</span></span>
<span class="hljs-built_in">String?</span> _onDownZone(<span class="hljs-built_in">double</span> x, <span class="hljs-built_in">double</span> y) {
  <span class="hljs-keyword">if</span> (
    x &gt;= elementWidth - scaleWidth &amp;&amp;
    x &lt;= elementWidth &amp;&amp;
    y &gt;= elementHeight - scaleHeight &amp;&amp;
    y &lt;= elementHeight
  ) {
    <span class="hljs-keyword">return</span> statusScale;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
    x &gt;= elementWidth - rotateHeight &amp;&amp;
    x &lt;= elementWidth &amp;&amp;
    y &gt;= <span class="hljs-number">0</span> &amp;&amp;
    y &lt;= rotateHeight
  ) {
    <span class="hljs-comment">// 固定右上角为旋转热区</span>
    <span class="hljs-keyword">return</span> statusRotate;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
    x &gt;= <span class="hljs-number">0</span> &amp;&amp;
    x &lt;= elementWidth &amp;&amp;
    y &gt;= <span class="hljs-number">0</span> &amp;&amp;
    y &lt;= elementHeight
  ) {
    <span class="hljs-keyword">return</span> statusMove;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
}

<span class="hljs-comment">// 新增响应旋转操作</span>
Positioned(
  left: x,
  top: y,
  child: Transform.rotate(
    angle: rotateNumber,
    child: GestureDetector(
      onPanDown: _onPanDown,
      onPanUpdate: _onPanUpdate,
      onPanEnd: (details) =&gt; _onPanEnd(),
      onPanCancel: _onPanEnd,
      child: Container(
        width: elementWidth,
        height: elementHeight,
        color: Colors.transparent,
        child: Stack(
          alignment: Alignment.center,
          clipBehavior: Clip.none,
          children: [
            Container(
              width: elementWidth,
              height: elementHeight,
              color: Colors.amber,
            ),

            <span class="hljs-comment">// 响应旋转操作</span>
            Positioned(
              top: <span class="hljs-number">0</span>,
              right: <span class="hljs-number">0</span>,
              child: Container(
                width: scaleWidth,
                height: scaleHeight,
                color: Colors.white,
              ),
            ),

            <span class="hljs-comment">// 响应缩放操作</span>
          ],
        ),
      ),
    ),
  ),
),

<span class="hljs-comment">// 其他省略...</span>
</code></pre>
<p>运行效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/918616cc40034d1eb330211d7940e254~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766246212&amp;x-signature=8sVrbhhTMdO8VkG75l6ycwzWFZo%3D" alt="image01.gif" loading="lazy"/></p>
<p>这样就简单实现了旋转。然后我们继续考虑热区的问题，当旋转一定角度的时候，再次点击对应的热区，就无法响应事件了，因为旋转后热区坐标已经发生改变，所以我们得对点击判断中加入角度的影响。</p>
<p>已知某点坐标和旋转角度，求旋转后的坐标值？</p>
<p>要计算旋转后的坐标，可以使用旋转矩阵。给定一个点 (x, y) 绕原点逆时针旋转角度 θ 后的新坐标 (x', y') 计算公式如下：</p>
<p>x' = x * cosθ - y * sinθ;
y' = x * sinθ + y * cosθ;</p>
<p>如果我们是绕任意点而不是原点，需要先平移坐标系</p>
<ol>
<li>平移: 将 (x, y) 平移到原点，新坐标为 (x - a, y - b);</li>
<li>旋转: 按照上述公式计算 (x', y');</li>
<li>平移回原坐标系: 新坐标为(x' + a, y' + b)。</li>
</ol>
<p>基于上面的公式，我们更改热区点击判断方法：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">判断点击在什么区域</span></span>
<span class="hljs-built_in">String?</span> _onDownZone(<span class="hljs-built_in">double</span> x, <span class="hljs-built_in">double</span> y) {
  <span class="hljs-keyword">final</span> offsetScale = rotatePoint(elementWidth, elementHeight);
  <span class="hljs-comment">// 设置都是最大的顶点坐标，方便下面判断区域的方式结构一致</span>
  <span class="hljs-comment">// 后续就好抽取方法</span>
  <span class="hljs-keyword">final</span> offsetRotate = rotatePoint(elementWidth, rotateHeight);

  <span class="hljs-keyword">if</span> (
    x &gt;= offsetScale.dx - scaleWidth &amp;&amp;
    x &lt;= offsetScale.dx &amp;&amp;
    y &gt;= offsetScale.dy - scaleHeight &amp;&amp;
    y &lt;= offsetScale.dy
  ) {
    <span class="hljs-keyword">return</span> statusScale;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
    x &gt;= offsetRotate.dx - rotateHeight &amp;&amp;
    x &lt;= offsetRotate.dx &amp;&amp;
    y &gt;= offsetRotate.dy - rotateHeight &amp;&amp;
    y &lt;= offsetRotate.dy
  ) {
    <span class="hljs-keyword">return</span> statusRotate;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
    x &gt;= <span class="hljs-number">0</span> &amp;&amp;
    x &lt;= elementWidth &amp;&amp;
    y &gt;= <span class="hljs-number">0</span> &amp;&amp;
    y &lt;= elementHeight
  ) {
    <span class="hljs-keyword">return</span> statusMove;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
}

<span class="hljs-comment">/// <span class="markdown">计算旋转后的点坐标</span></span>
Offset rotatePoint(<span class="hljs-built_in">double</span> x, <span class="hljs-built_in">double</span> y) {
  <span class="hljs-keyword">final</span> deg = rotateNumber * pi / <span class="hljs-number">180</span>;
  <span class="hljs-comment">// 确定旋转中心，因为这里的拖动是单个元素，坐标都是相对于元素自身形成的坐标系，所以坐标中心始终都是元素的中心</span>
  <span class="hljs-keyword">final</span> centerX = elementWidth / <span class="hljs-number">2</span>;
  <span class="hljs-keyword">final</span> centerY = elementHeight / <span class="hljs-number">2</span>;
  <span class="hljs-keyword">final</span> diffX = x - centerX;
  <span class="hljs-keyword">final</span> diffY = y - centerY;

  <span class="hljs-keyword">final</span> dx = diffX * cos(deg) - diffY * sin(deg) + centerX;
  <span class="hljs-keyword">final</span> dy = diffX * sin(deg) + diffY * cos(deg) + centerY;
  <span class="hljs-keyword">return</span> Offset(dx, dy);
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b59ed4533e84821be87591a42eeea3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766246212&amp;x-signature=i21eGbd5IO%2FmIQANMwdJHTI%2FZ%2FQ%3D" alt="image02.gif" loading="lazy"/></p>
<p>可以看到的是旋转和缩放热区即使在旋转后依然能够正常响应，还有最后一点，就是移动的时候也要应用旋转角度计算，因为我们使用的是元素自身为坐标系，坐标系旋转了，自然移动时的计算方式也得跟着变，其实对于后期将事件应用到容器上了过后就不需要考虑这些了，因为外层容器并不会变换，所以后期不使用逆运算，所以我们这里直接使用globalPosition来计算值即可（变换计算坐标感兴趣的可以自行研究一下）：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> _onPanDown(DragDownDetails details) {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'按下: <span class="hljs-subst">$details</span>'</span>);

  <span class="hljs-built_in">String?</span> tempStatus = _onDownZone(details.localPosition.dx, details.localPosition.dy);

  <span class="hljs-built_in">print</span>(tempStatus);

  setState(() {
    <span class="hljs-keyword">if</span> (tempStatus == statusMove) {
      <span class="hljs-comment">// 如果是移动，则使用globalPosition</span>
      startPosition = details.globalPosition;
    } <span class="hljs-keyword">else</span> {
      startPosition = details.localPosition;
    }
    status = tempStatus;
  });
}

<span class="hljs-keyword">void</span> _onPanUpdate(DragUpdateDetails details) {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'更新: <span class="hljs-subst">$details</span>'</span>);
  <span class="hljs-keyword">if</span> (status == statusMove) {
    _onMove(details.globalPosition.dx, details.globalPosition.dy);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status == statusScale) {
    _onScale(details.delta.dx, details.delta.dy);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status == statusRotate) {
    _onRotate(details.localPosition.dx, details.localPosition.dy);
  }
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d620555910674a94a97e7b81158b86f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766246212&amp;x-signature=zfcnNOafIK2Jts067TP9ntYrUok%3D" alt="image03.gif" loading="lazy"/></p>
<p>这样就对单个元素实现了变换的效果，前置就算时铺垫完成了，后续就开始实现多个的。</p>
<p>感兴趣的也可以关注我的微信公众号【前端学习小营地】，不定时会分享一些小功能～</p>
<p>今天的分享到此结束，感谢阅读～拜拜～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始玩转 Microsoft Agent Framework：我的 MAF 实践之旅]]></title>    <link>https://juejin.cn/post/7583139562751557674</link>    <guid>https://juejin.cn/post/7583139562751557674</guid>    <pubDate>2025-12-13T14:45:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583139562751557674" data-draft-id="7583139562751524906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始玩转 Microsoft Agent Framework：我的 MAF 实践之旅"/> <meta itemprop="keywords" content="后端,AIGC"/> <meta itemprop="datePublished" content="2025-12-13T14:45:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="tonydf"/> <meta itemprop="url" content="https://juejin.cn/user/3809161241186638"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始玩转 Microsoft Agent Framework：我的 MAF 实践之旅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3809161241186638/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    tonydf
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T14:45:44.000Z" title="Sat Dec 13 2025 14:45:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近一直在写业务，感觉思维都快麻木了，趁着周末的时间，看了一下微软最新推出的智能体开发框架——Microsoft Agent Framework，以下简称MAF。</p>
<p>跟着官方文档跑了几个案例，感觉还是非常有意思的。它不是传统意义上的 LLM SDK，而是一个面向开发者构建智能代理（Agent）的完整工具链，支持多轮对话、函数调用、工具集成、可观测性等高级功能。</p>
<h2 data-id="heading-1">什么是 Microsoft Agent Framework？</h2>
<p>概念性的东西，就不多说了，但这个新框架我觉得还是有必要介绍一下，这里就直接引用了微软官方文档的介绍了，我用翻译软件翻译了一下</p>
<blockquote>
<p>Microsoft Agent Framework 是一款面向 .NET 和 Python 的开源开发套件，用于构建人工智能代理及多智能体工作流。它整合并扩展了 Semantic Kernel 和 AutoGen 项目中的诸多理念，既继承了两者的优势，又增添了全新功能。该框架由同一团队打造，将成为未来构建人工智能代理的统一基础。</p>
<p>Agent Framework 提供两大类核心能力：</p>
<p>AI 代理：独立的智能体，可利用大语言模型处理用户输入，调用工具和 MCP 服务器执行相应操作，并生成回复。这些代理支持多种模型提供商，包括 Azure OpenAI、OpenAI 和 Azure AI。</p>
<p>工作流：基于图结构的工作流，可将多个代理和功能连接起来，以完成复杂且多步骤的任务。工作流支持基于类型的路由、嵌套、检查点以及人机协同场景下的请求与响应模式。</p>
<p>此外，该框架还提供了基础构建模块，包括模型客户端（用于聊天补全与回复）、用于状态管理的代理线程、为代理记忆提供上下文的服务提供者、用于拦截代理行为的中间件，以及用于工具集成的 MCP 客户端。这些组件共同赋予您灵活强大的能力，助您构建交互性好、稳健可靠且安全的人工智能应用。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fagent-framework%2Foverview%2Fagent-framework-overview" target="_blank" title="https://learn.microsoft.com/en-us/agent-framework/overview/agent-framework-overview" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/agent…</a></p>
</blockquote>
<p/>
<p>说起来，大家可能想到微软之前的智能体框架Semantic Kernel和AutoGen，这次的MAF简单来说就是两者的集合体，官方文档里也对他们的关系做了说明，大家可以自行搜一下资料，如果你以前没了解过SK和AutoGen，那恭喜你，不用专门去了解他们了，直接上手MAF即可，如果了解过，也不用有错付之类的负担，因为MAF就是基于两者，所以你有这些基础经验，上手会更顺滑。笔者之前也分别写过关于<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FeSgd9V95GTDkDXjjcRUV7g" target="_blank" title="https://mp.weixin.qq.com/s/eSgd9V95GTDkDXjjcRUV7g" ref="nofollow noopener noreferrer">SK</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FuwPGwKi3YbEKMhYriNUKiw" target="_blank" title="https://mp.weixin.qq.com/s/uwPGwKi3YbEKMhYriNUKiw" ref="nofollow noopener noreferrer">AutoGen</a>的博客，这里不再赘述。</p>
<h2 data-id="heading-2">上手案例</h2>
<p>概念引入完了，咱就直接甩案例吧，其实微软官方文档的案例写的已经很详细了，但如果没接触过模型开发或者对不太熟悉的小伙伴来说，这个文档还是多少有点门槛的。起码OpenAI或者AzureOpenAI的访问问题就需要耽搁一段时间。</p>
<p>事实上，在SK时期，就有这个问题，到了MAF时代，这个问题处理起来更加直接，这篇我照着文档跑了几个案例，来一一介绍下</p>
<blockquote>
<p>为了方便大家对照，我在每个案例开头都附上官方文档的地址</p>
</blockquote>
<h3 data-id="heading-3">基础框架</h3>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fagent-framework%2Foverview%2Fagent-framework-overview" target="_blank" title="https://learn.microsoft.com/en-us/agent-framework/overview/agent-framework-overview" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/agent…</a></p>
</blockquote>
<p>第一个案例就是搭建MAF框架，然后跑通一个最基础的案例。</p>
<ol>
<li>创建一个控制台项目</li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp">dotnet <span class="hljs-keyword">new</span> console -o AgentFrameworkQuickStart
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f4ced77f3df4d57900be96cabbcc744~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdG9ueWRm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766244877&amp;x-signature=l2%2FE6%2FYpj9guzdwNhGMY1LEOKws%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li>引入核心插件，注意这里因为MAF还是预览版，通过命令行引入的话要加上 --preview参数，在IDE（如vs）里，要勾选“预览版”选项</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">dotnet add package Azure.AI.OpenAI --prerelease
dotnet add package Microsoft.Agents.AI.OpenAI --prerelease
</code></pre>
<p>这里官方文档里还安装了Azure.Identity，这个我们可以不用，因为我们要接入国内平台的大模型。而且只是测试跑案例，暂时不需要它。</p>
<p>另外，我今天（2025.12.13）使用命令行安装的 Azure.AI.OpenAI的版本是2.8.1-beta.1，这个版本是有问题的，这个版本里依赖的OpenAI这个包和上级包有冲突，我是在IDE里手动将版本号上移了一个版本（2.7.0-beta2）才解决，如果大家刚好看到这里，然后也遇到相同问题的话，可以尝试参考一下</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9ac135a7081419f951fc69821fe95f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdG9ueWRm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766244877&amp;x-signature=ZAiAHX41MhGbcJpMbpmBo%2FRlnrg%3D" alt="" loading="lazy"/></p>
<ol start="3">
<li>定义Provider</li>
</ol>
<p>我这里是使用的国内硅基流动平台，也可以使用其他的。</p>
<p>定义一个类</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ModelProvider</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> ApiKey { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; } = <span class="hljs-built_in">string</span>.Empty;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> ModelId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; } = <span class="hljs-built_in">string</span>.Empty;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Endpoint { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; } = <span class="hljs-built_in">string</span>.Empty;
}
</code></pre>
<p>对应的搞一个配置文件参数，测试阶段的话不搞也没事，这样方便一点</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ModelProvider"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"EndPoint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://api.moonshot.cn/v1"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ApiKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{你的key}"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ModelId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"kimi-k2-0905-preview"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后常规操作，就ok了</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> config = <span class="hljs-keyword">new</span> ConfigurationBuilder()
    .AddJsonFile(<span class="hljs-string">$"llm.json"</span>, optional: <span class="hljs-literal">false</span>, reloadOnChange: <span class="hljs-literal">true</span>)
    .Build();
<span class="hljs-keyword">var</span> modelProvider = <span class="hljs-keyword">new</span> ModelProvider()
{
    ApiKey = config[<span class="hljs-string">"ModelProvider:ApiKey"</span>] ?? <span class="hljs-built_in">string</span>.Empty,
    ModelId = config[<span class="hljs-string">"ModelProvider:ModelId"</span>] ?? <span class="hljs-built_in">string</span>.Empty,
    Endpoint = config[<span class="hljs-string">"ModelProvider:Endpoint"</span>] ?? <span class="hljs-built_in">string</span>.Empty,
};
Console.WriteLine(<span class="hljs-string">$"正在使用【$<span class="hljs-subst">{modelProvider.ModelId}</span>】模型"</span>,ConsoleColor.Yellow);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bc49954c4a04178a468118de6c4363d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdG9ueWRm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766244877&amp;x-signature=0rn0%2FwlcR5wsz7H41Utrl4rYHm4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">第一个智能体</h3>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fagent-framework%2Foverview%2Fagent-framework-overview" target="_blank" title="https://learn.microsoft.com/en-us/agent-framework/overview/agent-framework-overview" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/agent…</a></p>
</blockquote>
<p>文档里第一个案例是一个笑话大师的案例，咱们小小的改造一下</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> agent = <span class="hljs-keyword">new</span> OpenAIClient(
    <span class="hljs-keyword">new</span> ApiKeyCredential(modelProvider.ApiKey),
    <span class="hljs-keyword">new</span> OpenAIClientOptions { Endpoint = <span class="hljs-keyword">new</span> Uri(modelProvider.Endpoint) })
    .GetChatClient(modelProvider.ModelId)
    .CreateAIAgent(instructions: <span class="hljs-string">"你是个脱口秀大师，可以很轻松的逗笑大家."</span>, name: <span class="hljs-string">"脱口秀大师"</span>);

<span class="hljs-keyword">await</span> <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> update <span class="hljs-keyword">in</span> agent.RunStreamingAsync(<span class="hljs-string">"来一段简短的脱口秀表演"</span>))
{
    Console.Write(update);
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/275b057c4aa84b8286e4a9f08b2b6fb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdG9ueWRm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766244877&amp;x-signature=k91S6OqsYHheLUAqWWw865hbBR4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">视觉智能体</h3>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fagent-framework%2Ftutorials%2Fagents%2Fimages" target="_blank" title="https://learn.microsoft.com/en-us/agent-framework/tutorials/agents/images" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/agent…</a></p>
</blockquote>
<p>在试试视觉能力，注意，此时要换一个有视觉能力的模型，我前面使用的kimi不支持，可以换成其他模型，比如qwen系列</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> agent = <span class="hljs-keyword">new</span> OpenAIClient(
    <span class="hljs-keyword">new</span> ApiKeyCredential(modelProvider.ApiKey),
    <span class="hljs-keyword">new</span> OpenAIClientOptions { Endpoint = <span class="hljs-keyword">new</span> Uri(modelProvider.Endpoint) })
    .GetChatClient(modelProvider.ModelId)
    .CreateAIAgent(instructions: <span class="hljs-string">"你是一个能够分析图像的实用助手。."</span>, name: <span class="hljs-string">"视觉代理"</span>);

ChatMessage message = <span class="hljs-keyword">new</span> ChatMessage(ChatRole.User, [
    <span class="hljs-keyword">new</span> TextContent(<span class="hljs-string">"你在这张图片中看到了什么？"</span>),
    <span class="hljs-keyword">new</span> UriContent(<span class="hljs-string">"{图片实际地址}"</span>, <span class="hljs-string">"image/png"</span>)
    ]);
<span class="hljs-comment">// Console.WriteLine(await agent.RunAsync(message));</span>

<span class="hljs-keyword">await</span> <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> update <span class="hljs-keyword">in</span> agent.RunStreamingAsync(message))
{
    Console.Write(update);
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3fd868b2cea45678f72ba09e2f6a627~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdG9ueWRm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766244877&amp;x-signature=LyD5NPwyBwp509ZGpVdl6Q5R3j4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">Function Tool</h3>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fagent-framework%2Ftutorials%2Fagents%2Ffunction-tools%3Fpivots%3Dprogramming-language-csharp" target="_blank" title="https://learn.microsoft.com/en-us/agent-framework/tutorials/agents/function-tools?pivots=programming-language-csharp" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/agent…</a></p>
<p>注意，在function tool之前的案例还有一篇关于多智能体的案例，我这里直接跳过了，链接给出来</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fagent-framework%2Ftutorials%2Fagents%2Ffunction-tools%3Fpivots%3Dprogramming-language-csharp" target="_blank" title="https://learn.microsoft.com/en-us/agent-framework/tutorials/agents/function-tools?pivots=programming-language-csharp" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/agent…</a></p>
</blockquote>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> agent = <span class="hljs-keyword">new</span> OpenAIClient(
    <span class="hljs-keyword">new</span> ApiKeyCredential(modelProvider.ApiKey),
    <span class="hljs-keyword">new</span> OpenAIClientOptions { Endpoint = <span class="hljs-keyword">new</span> Uri(modelProvider.Endpoint) })
    .GetChatClient(modelProvider.ModelId)
    .CreateAIAgent(instructions: <span class="hljs-string">"你是一个智能助手。"</span>, tools: [AIFunctionFactory.Create(GetWeather)]);

Console.WriteLine(<span class="hljs-keyword">await</span> agent.RunAsync(<span class="hljs-string">"保定的天气怎么样?"</span>));

[<span class="hljs-meta">Description(<span class="hljs-string">"Get the weather for a given location."</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> <span class="hljs-title">GetWeather</span>(<span class="hljs-params">[Description(<span class="hljs-string">"The location to get the weather for."</span></span>)] <span class="hljs-built_in">string</span> location)</span>
    =&gt; <span class="hljs-string">$"The weather in <span class="hljs-subst">{location}</span> is cloudy with a high of 15°C."</span>;

</code></pre>
<p>这个呢，我没怎么修改，基本就是按照官方文档的例子来的。</p>
<p>需要多说一点的是，定义工具函数时，不再需要像SK时代，标记方法工具名特性了，直接写工具作用的描述就可以了，更加简洁。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e1cb82295ed49d186724d30e547a24e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdG9ueWRm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766244877&amp;x-signature=9G2Vy5GI6nwwbzgBf3PMr8wbj8A%3D" alt="" loading="lazy"/></p>
<p>工具调用在LLM发展初期就比较普及了，这也是Agent的灵魂，使Agent不再只是“回答问题”，而是能像人一样去“执行动作”。</p>
<h3 data-id="heading-7">需要人批准的函数工具</h3>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fagent-framework%2Ftutorials%2Fagents%2Ffunction-tools-approvals%3Fpivots%3Dprogramming-language-csharp" target="_blank" title="https://learn.microsoft.com/en-us/agent-framework/tutorials/agents/function-tools-approvals?pivots=programming-language-csharp" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/agent…</a></p>
</blockquote>
<p>这个实际上是MAF框架的一个重要特性，在实际的业务场景中，很多时候我们不能或者不应该让智能体直接去执行一些操作，而是需要得到人类的授权后，再决定是否执行，也就是“人机协同”模式，案例给的比较简单，实际我们可以在这个基础上扩充进很多业务进来，比如权限模块等等。</p>
<p>它的价值就会实现安全可控的自动化流程，避免误操作。</p>
<pre><code class="hljs language-csharp" lang="csharp">AIFunction weatherFunction = AIFunctionFactory.Create(GetWeather);
AIFunction approvalRequiredWeatherFunction = <span class="hljs-keyword">new</span> ApprovalRequiredAIFunction(weatherFunction);

<span class="hljs-keyword">var</span> agent = <span class="hljs-keyword">new</span> OpenAIClient(
    <span class="hljs-keyword">new</span> ApiKeyCredential(modelProvider.ApiKey),
    <span class="hljs-keyword">new</span> OpenAIClientOptions { Endpoint = <span class="hljs-keyword">new</span> Uri(modelProvider.Endpoint) })
    .GetChatClient(modelProvider.ModelId)
    .CreateAIAgent(instructions: <span class="hljs-string">"你是一个智能助手。"</span>, tools: [approvalRequiredWeatherFunction]);

AgentThread thread = agent.GetNewThread();
AgentRunResponse response = <span class="hljs-keyword">await</span> agent.RunAsync(<span class="hljs-string">"保定的天气如何?"</span>, thread);

<span class="hljs-keyword">var</span> functionApprovalRequests = response.Messages
    .SelectMany(x =&gt; x.Contents)
    .OfType&lt;FunctionApprovalRequestContent&gt;()
    .ToList();
FunctionApprovalRequestContent requestContent = functionApprovalRequests.First();
Console.WriteLine(<span class="hljs-string">$"我需要您的批准才能执行 '<span class="hljs-subst">{requestContent.FunctionCall.Name}</span>'"</span>);
<span class="hljs-keyword">var</span> approvalMessage = <span class="hljs-keyword">new</span> ChatMessage(ChatRole.User, [requestContent.CreateResponse(<span class="hljs-literal">true</span>)]);
Console.WriteLine(<span class="hljs-keyword">await</span> agent.RunAsync(approvalMessage, thread));


[<span class="hljs-meta">Description(<span class="hljs-string">"Get the weather for a given location."</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> <span class="hljs-title">GetWeather</span>(<span class="hljs-params">[Description(<span class="hljs-string">"The location to get the weather for."</span></span>)] <span class="hljs-built_in">string</span> location)</span>
    =&gt; <span class="hljs-string">$"The weather in <span class="hljs-subst">{location}</span> is cloudy with a high of 15°C."</span>;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5945160f48e749849d819ed227c3036a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdG9ueWRm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766244877&amp;x-signature=jqjz9c%2BqeAdsXhuoMqtoBYV%2BBFw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">将 Agent 暴露为 MCP 工具</h3>
<p>通过 MAF，我可以轻松把我的 Agent 包装成一个 MCP Server，然后在任意MCP客户端中注册这个工具，就可以直接调用它！</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> agent = <span class="hljs-keyword">new</span> OpenAIClient(
        <span class="hljs-keyword">new</span> ApiKeyCredential(modelProvider.ApiKey),
        <span class="hljs-keyword">new</span> OpenAIClientOptions { Endpoint = <span class="hljs-keyword">new</span> Uri(modelProvider.Endpoint) })
    .GetChatClient(modelProvider.ModelId)
    .CreateAIAgent(instructions: <span class="hljs-string">"你是个笑话大师."</span>, name: <span class="hljs-string">"笑话大师"</span>);
<span class="hljs-keyword">var</span> jokerMcpTool = McpServerTool.Create(agent.AsAIFunction());
<span class="hljs-keyword">var</span> builder = Host.CreateEmptyApplicationBuilder(settings: <span class="hljs-literal">null</span>);
builder.Services
    .AddMcpServer()
    .WithStdioServerTransport()
    .WithTools([jokerMcpTool]);
<span class="hljs-keyword">await</span> builder
    .Build()
    .RunAsync();
</code></pre>
<p>然后在Cline中调用他的效果</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/939c2c7ee2fd48d9a390daf822192e4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdG9ueWRm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766244877&amp;x-signature=iGzXtXw5xCjrARq8TehwJJUsrdM%3D" alt="" loading="lazy"/></p>
<p>是的，现在通过MAF框架创建一个MCPServer，就像写接口一样，非常丝滑。</p>
<h2 data-id="heading-9">结语</h2>
<p>好了，本次我就跑了这几个案例，感觉还是非常不错的。微软通过 MAF 提供了一条清晰的技术路径，让我们这些开发者也能轻松构建属于自己的“智能助手”。</p>
<p>接下来，还是会继续对MAF的探索之旅，因为我现在做的项目也要接入智能体框架。这东西我觉得绝不是所谓“锦上添花”之类的定位，而是办公效率提质增效的核心因素，当然这有一个必要条件，就是你的业务系统里基础操作是稳定的，可靠的，基于此，智能体的接入才能彻底释放生产力！</p>
<p>本篇对MAF的介绍只是冰山一角，还有更有特点的工作流，AG-UI，DevUI等，等下次有机会在细聊，晚安啦攻城狮们。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[怎么解决无法拉取Docker镜像？不如我们自己建一个加速站（]]></title>    <link>https://juejin.cn/post/7582879379441991723</link>    <guid>https://juejin.cn/post/7582879379441991723</guid>    <pubDate>2025-12-13T12:58:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582879379441991723" data-draft-id="7582879379441975339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="怎么解决无法拉取Docker镜像？不如我们自己建一个加速站（"/> <meta itemprop="keywords" content="Docker"/> <meta itemprop="datePublished" content="2025-12-13T12:58:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="传奇吉他手千早爱音"/> <meta itemprop="url" content="https://juejin.cn/user/2601862689202538"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            怎么解决无法拉取Docker镜像？不如我们自己建一个加速站（
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2601862689202538/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    传奇吉他手千早爱音
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T12:58:16.000Z" title="Sat Dec 13 2025 12:58:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>该教程只能个人救急使用</p>
</blockquote>
<p>最近在重新写 Jekyll 个人博客，然后要使用到 VSCode 的 DevContainer，在 Docker 容器里进行预览。</p>
<p><del>结果我手贱把以前的容器镜像都删了，第一步就卡死了。</del></p>
<p>我使用的主题<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcotes2020%2Fjekyll-theme-chirpy" target="_blank" title="https://github.com/cotes2020/jekyll-theme-chirpy" ref="nofollow noopener noreferrer">jekyll-theme-chirpy</a>的 <code>.devcontainer/devcontainer.json</code> 配置使用的是微软官方镜像：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"image"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mcr.microsoft.com/devcontainers/jekyll:2-bullseye"</span>
</code></pre>
<p>由于国内众所周知的网络原因，Docker Hub 和 MCR (Microsoft Container Registry) 基本处于断连状态。我在本地尝试重新构建镜像的时候反复报错 <code>Get "...": EOF</code> 或者 <code>net/http: TLS handshake timeout</code>，改了Docker Proxy 依然无效。</p>
<h2 data-id="heading-0">解决方案</h2>
<p>我想了很久...找了很多加速的方法...然后...Gemini3帮我秒了...</p>
<blockquote>
<p>既然本地拉不下来，那就找个“海外中转站”！</p>
</blockquote>
<p>核心思路：</p>
<ol>
<li>利用GitHub Actions拉取微软/官方镜像。</li>
<li>在 Action 中把镜像推送到 阿里云容器镜像服务。</li>
<li>本地 DevContainer 直接从阿里云拉取镜像。</li>
</ol>
<p><del>不是GitHubActions还有阿里云容器镜像服务都是啥。</del></p>
<p>简单介绍一下：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffeatures%2Factions" target="_blank" title="https://github.com/features/actions" ref="nofollow noopener noreferrer">GitHub Actions</a>：GitHub 提供的“自动化流水线”。
<ul>
<li><strong>平时</strong>：它在睡觉。</li>
<li><strong>触发</strong>：当你提交代码或手动点击按钮时，它就被唤醒了。</li>
<li><strong>工作</strong>：它会领一台全新的云端电脑（通常是 Ubuntu），照着你给的清单（.yml 文件）一行行执行命令。</li>
<li><strong>结果</strong>：干完活（比如搬运镜像）后通知你，然后那台云电脑销毁。</li>
</ul>
</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Facr" target="_blank" title="https://www.aliyun.com/product/acr" ref="nofollow noopener noreferrer">阿里云容器镜像服务ACR</a>：阿里云提供的一个高性能、高可用、安全可靠的容器镜像托管平台。</li>
</ul>
<p>而Github的服务器刚好就在国外，拉取这些镜像是很方便的，然后推送到阿里云，我们就能成功在国内拉取镜像了</p>
<h2 data-id="heading-1">操作步骤</h2>
<h3 data-id="heading-2">第一步：开通阿里云容器镜像服务 (ACR)</h3>
<ol>
<li>登录 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcr.console.aliyun.com%2F" target="_blank" title="https://cr.console.aliyun.com/" ref="nofollow noopener noreferrer">阿里云容器镜像服务控制台</a>。</li>
<li>创建个人实例（免费）。</li>
<li>设置 Registry 登录密码：<strong>注意这不是阿里云的登录密码，是专门给 Docker 用的固定密码。</strong></li>
<li>创建命名空间（例如 <code>saku</code>）和镜像仓库（例如 <code>jekyll-mirror</code>）。</li>
<li>可选：把仓库类型设置为<strong>公开 (Public)</strong>。这样本地拉取时不需要配置 Docker Login，非常方便。</li>
</ol>
<h3 data-id="heading-3">第二步：配置 GitHub Actions 和 GitHub Secrets</h3>
<p>首先fork这个项目<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FChenpi-Sakura%2Fdocker_sync" target="_blank" title="https://github.com/Chenpi-Sakura/docker_sync" ref="nofollow noopener noreferrer">docker_sync</a>，相关的<code>Action</code>代码可以参考项目<code>.github\workflows</code>目录下的yml文件</p>
<p>然后按照顺序点击 <code>Settings</code> -&gt; <code>Secrets and variables</code> -&gt; <code>Actions</code>-&gt;<code>New repository secret</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b209f020b3bf4e12b2a7ab049d415c07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lyg5aWH5ZCJ5LuW5omL5Y2D5pep54ix6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766235495&amp;x-signature=JdEQnAIhS%2Bx6H4FU6KZCCqIDR%2FU%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>这里我们以拉取镜像<code>mcr.microsoft.com/devcontainers/jekyll:2-bullseye</code>和命名空间<code>saku</code>为例</p>
</blockquote>
<p>需要设置以下参数</p>
<ul>
<li><code>ALIYUN_USERNAME</code>: 你的阿里云 UserID。</li>
<li><code>ALIYUN_PASSWORD</code>: 第一步里设置的 Registry 独立密码。</li>
<li><code>ALIYUN_NAMESPACE</code>: 第一步中设置的命名空间</li>
<li><code>ALIYUN_REGISTRY</code>: 控制台概览中的公网域名</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/101b079e86004a389a522a40631c8e09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lyg5aWH5ZCJ5LuW5omL5Y2D5pep54ix6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766235495&amp;x-signature=YMCvsCMo1saF%2FFloBtBwuBsBN3M%3D" alt="" loading="lazy"/></p>
<p>填写后点击<code>Add secret</code>按照下图添加，添加以上四个Secret。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c25d8f8095ff423eaa4d78f4ec2a6c58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lyg5aWH5ZCJ5LuW5omL5Y2D5pep54ix6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766235495&amp;x-signature=n8LBAfFdbUojN3W6bnrozJkxokc%3D" alt="" loading="lazy"/></p>
<p>配置完成后，去 GitHub 仓库的 <code>Actions</code> 页面，选中 <code>Mirror Docker Image to Aliyun</code>，点击 <code>Run workflow</code>，填写相关配置，再点击<code>Run workflow</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb80acaae22844aaa32f7af02464ada0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lyg5aWH5ZCJ5LuW5omL5Y2D5pep54ix6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766235495&amp;x-signature=ol%2BRFn0o3AUvEjKabBvWJcCY9kI%3D" alt="" loading="lazy"/></p>
<p>等待拉取完毕，</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5dec5e442fa455bacbbf7c2f032ffea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lyg5aWH5ZCJ5LuW5omL5Y2D5pep54ix6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766235495&amp;x-signature=pdAQbRuOHWzIi0bNzrkQIQl%2BdSQ%3D" alt="" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efabdde7ab544e35b5dba1ae7aa52233~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lyg5aWH5ZCJ5LuW5omL5Y2D5pep54ix6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766235495&amp;x-signature=M31ChB2qlgsfXS4WKCKCrQkYaIM%3D" alt="" loading="lazy"/></p>
<p>此时<code>Action</code>界面显示成功，控制台中也出现了相应的仓库</p>
<h3 data-id="heading-4">第三步：修改本地配置</h3>
<p>回到本地项目，相应地修改 <code>.devcontainer/devcontainer.json</code> 中的image地址：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"image"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"crpi-xxxx.cn-hangzhou.personal.cr.aliyuncs.com/myblog/jekyll-mirror:latest"</span>
</code></pre>
<blockquote>
<p>地址位置参考仓库基本信息的公网地址</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73df496531564810961f4777c3e6839c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lyg5aWH5ZCJ5LuW5omL5Y2D5pep54ix6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766235495&amp;x-signature=Sy%2BrvQyZHORHaEO9ET7E%2FIFcOiU%3D" alt="" loading="lazy"/></p>
<p>此时重新拉取镜像，一下就成功了...</p>
<blockquote>
<p>如果拉取失败，可能是权限的问题，详细参考仓库信息中的操作指南</p>
</blockquote>
<h2 data-id="heading-5">总结</h2>
<p>通过这个方法，我们实际上是利用 GitHub Actions 搭建了一个 <strong>“私人的 Docker 镜像加速通道”</strong>。</p>
<p>这个方案需要自己手动配置一次 Workflow，且阿里云个人版有配额限制，但也算是无可奈何中的解决方案了吧。</p>
<p>祝大家 Coding 愉快！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JVM 之 线上诊断神器Arthas【常用命令？如何使用Arthas排查cpu飙高、类加载问题、死锁、慢接口等问题？】]]></title>    <link>https://juejin.cn/post/7582922476222251023</link>    <guid>https://juejin.cn/post/7582922476222251023</guid>    <pubDate>2025-12-13T23:14:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582922476222251023" data-draft-id="7582863493260754996" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JVM 之 线上诊断神器Arthas【常用命令？如何使用Arthas排查cpu飙高、类加载问题、死锁、慢接口等问题？】"/> <meta itemprop="keywords" content="JVM"/> <meta itemprop="datePublished" content="2025-12-13T23:14:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="减_简"/> <meta itemprop="url" content="https://juejin.cn/user/784379873344682"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JVM 之 线上诊断神器Arthas【常用命令？如何使用Arthas排查cpu飙高、类加载问题、死锁、慢接口等问题？】
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/784379873344682/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    减_简
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T23:14:01.000Z" title="Sat Dec 13 2025 23:14:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Arthas 是什么？</h2>
<p>简单讲，他是一款开源的线上诊断工具
可以在，不重启应用的前提下，对服务进行实时监控，诊断，调试，甚至进行热修复</p>
<ul>
<li>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Farthas.aliyun.com%2Fdoc%2F" target="_blank" title="https://arthas.aliyun.com/doc/" ref="nofollow noopener noreferrer">arthas.aliyun.com/doc/</a></li>
</ul>
<hr/>
<h3 data-id="heading-1">Arthas 解决了什么问题？</h3>
<ul>
<li>1、线上debug只能加日志-》打包-》重新部署-》等待复现。</li>
<li>2、性能瓶颈（慢方法、cpu飙高、内存泄漏）难以定位</li>
<li>3、类加载异常难定位（ClassNotFoundException、NoSuchMethodError等，不知道从哪加载的？是否被覆盖）</li>
<li>4、逻辑调用链不清晰（方法被谁调用的？参数是什么？）</li>
<li>5、紧急bug只能停机重新发布</li>
</ul>
<h4 data-id="heading-2">适用场景</h4>
<ul>
<li>适合：线上紧急问题、性能问题、类加载问题排查，以及临时调试</li>
<li>不适合：因为Arthas需手动交互+数据不存储，所以不适合自动化或长期监控。</li>
</ul>
<hr/>
<h3 data-id="heading-3">Arthas 是怎么解决的这些问题</h3>
<p>说白了，Arthas利用了<strong>Java Agent+Bytecode Instrumentation（字节码增强）</strong> 技术,
在运行时动态注入探针，实现对 JVM 内部状态的非侵入式观测与干预</p>
<blockquote>
<p>Java Agent: 允许在<strong>不修改源代码、不重启应用</strong>的前提下，对程序<strong>进行监控、诊断、性能分析、日志增强、安全审计甚至热修复</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-4">Arthas提供了哪些能力？</h3>

































<table><thead><tr><th>能力</th><th>说明</th></tr></thead><tbody><tr><td><strong>实时监控</strong></td><td>查看方法入参、返回值、异常（<code>watch</code>）</td></tr><tr><td><strong>性能剖析</strong></td><td>分析方法耗时、生成火焰图（<code>trace</code> / <code>profiler</code>）</td></tr><tr><td><strong>类信息查询</strong></td><td>查看类从哪个 JAR 加载、反编译字节码（<code>sc</code> / <code>jad</code>）</td></tr><tr><td><strong>热更新</strong></td><td>动态替换类定义，修复线上 Bug（<code>redefine</code>）</td></tr><tr><td><strong>JVM 全局视图</strong></td><td>实时查看线程、内存、GC、系统负载（<code>dashboard</code>）</td></tr><tr><td><strong>调用链追踪</strong></td><td>查看方法被谁调用、调用栈（<code>stack</code>）</td></tr></tbody></table>
<blockquote>
<p>所有操作 <strong>无需重启应用</strong>，<strong>无需改代码</strong>，<strong>秒级生效</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">Arthas如何使用？</h2>
<h3 data-id="heading-6">1、安装（任选其一）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式一：快速启动（推荐）</span>
curl -O https://arthas.aliyun.com/arthas-boot.jar
java -jar arthas-boot.jar

<span class="hljs-comment"># 方式二：脚本安装（Linux/macOS）</span>
curl -L https://arthas.aliyun.com/install.sh | sh
./as.sh
</code></pre>
<hr/>
<h3 data-id="heading-7">2、启动</h3>
<ol>
<li>运行 <code>java -jar arthas-boot.jar</code>-》列出当前机器上所有 Java 进程</li>
<li>输入目标进程的编号，进入 Arthas 命令行（提示符如 <code>[arthas@12364]$</code>）</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59e6e21d36eb4b1db2ba5beff7ff5f1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YePX-eugA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766285838&amp;x-signature=xCSTYrOWfe%2BPCQtV3ee3cJ34aP4%3D" alt="Arthas启动并attach某个进程示例.png" loading="lazy"/></p>
<blockquote>
<p>启动时如指定 HTTP 端口<code>java -jar arthas-boot.jar --http-port 8563</code>，可在浏览器访问：<code>http://&lt;服务器IP&gt;:8563</code>图形化界面。</p>
</blockquote>
<hr/>
<h3 data-id="heading-8">3、Arthas提供了哪些命令？</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看系统实时状态（线程、内存、GC）</span>
dashboard

<span class="hljs-comment"># 反编译某个类（确认线上代码是否正确）</span>
jad com.example.service.UserService

<span class="hljs-comment"># 监控方法入参和返回值（“这个方法执行时参数/返回值/异常是什么？” → 监控 方法内部数据）</span>
watch com.example.service.UserService login <span class="hljs-string">'{params, returnObj}'</span> -x 2

<span class="hljs-comment"># 追踪方法调用耗时（定位慢接口）</span>
trace com.example.controller.UserController getUser

<span class="hljs-comment"># 查看某个方法的调用栈（“谁调用了这个方法？” → 查看 调用栈（Call Stack））</span>
stack com.example.service.UserService saveUser

<span class="hljs-comment"># 动态修改日志级别（无需重启）</span>
logger --name com.example.service.UserService --level debug

<span class="hljs-comment"># 搜索已加载的类</span>
sc *UserService*

<span class="hljs-comment"># 搜索类的方法</span>
sm com.example.service.UserService *

<span class="hljs-comment"># 生成火焰图（需 profiler 支持）</span>
profiler start
<span class="hljs-comment"># ...等待几秒...</span>
profiler stop
</code></pre>
<h2 data-id="heading-9">如何使用Arthas进行线上具体场景问题排查？</h2>
<blockquote>
<p><strong>发现现象 → 确定排查思路 → 使用Arthas排查 → 解决问题</strong></p>
</blockquote>
<p><strong>常见场景速查表</strong>：</p>






























<table><thead><tr><th>问题类型</th><th>关键命令</th><th>核心输出</th></tr></thead><tbody><tr><td><strong>CPU 100%</strong></td><td><code>thread -n 3</code> → <code>jad</code> → <code>profiler</code></td><td>高 CPU 线程 + 热点代码</td></tr><tr><td><strong>死锁</strong></td><td><code>thread -b</code></td><td>死锁线程对 + 锁依赖关系</td></tr><tr><td><strong>慢接口</strong></td><td><code>trace</code> → <code>watch</code> → <code>stack</code></td><td>耗时分布 + 参数/异常</td></tr><tr><td><strong>类加载问题</strong></td><td><code>sc</code> → <code>jad</code> → <code>classloader</code></td><td>类加载情况 + 类反编译内容</td></tr></tbody></table>
<h3 data-id="heading-10">场景一：CPU飙高</h3>
<h4 data-id="heading-11">现象</h4>
<ul>
<li>1、应用响应变慢甚至无响应</li>
<li>2、服务器负载飙升，<code>top</code> 显示某个 Java 进程 CPU 占用接近 100%</li>
</ul>
<h4 data-id="heading-12">排查思路</h4>
<p>CPU飙高，通常是因为<strong>无限循环、正则回溯、复杂计算</strong>等引起的。
所以排查思路是：</p>
<ul>
<li>1、找出哪个线程在疯狂占用 CPU？</li>
<li>2、这个线程在执行什么代码？</li>
</ul>
<h4 data-id="heading-13">Arthas排查定位步骤</h4>
<ul>
<li>1、启动 Arthas 并 attach 到目标进程<code>java -jar arthas-boot.jar 并进入目标服务进程</code></li>
<li>2、查看 CPU使用率最高 的前 3 个线程 <code>thread -n 3</code>
<strong>关键信息</strong>：线程名 <code>Thread-10</code>，ID=45，CPU占用 98.7%，卡在 <code>DataProcessor.java:28</code>
执行后，输出示例如下：
Threads Total: 50, NEW: 0, RUNNABLE: 10, BLOCKED: 0, WAITING: 20, TIMED_WAITING: 20
"Thread-10" Id=45 cpuUsage=98.7% RUNNABLE
at com.example.service.DataProcessor.process(DataProcessor.java:28)
at com.example.service.DataProcessor.lambda<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">start</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">t</span></span></span></span></span>0(DataProcessor.java:15)
...</li>
<li>3、反编译该类确认代码逻辑（是否有死循环或低效算法）<code>jad com.example.service.DataProcessor</code>
<pre><code class="hljs language-java" lang="java">例如：
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) { <span class="hljs-comment">// ← 问题在这里！</span>
    list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>());
}
</code></pre>
</li>
<li>4、生成火焰图，并下载到本地，用浏览器打开，观察其中的热点方法。
<pre><code class="hljs language-bash" lang="bash">profiler start
<span class="hljs-comment"># 等待 10 秒，然后输出结果文件 arthas-output/xxx.html</span>
profiler stop --format html
</code></pre>
</li>
<li>5、定位到具体原因，修改后重新部署</li>
</ul>
<hr/>
<h3 data-id="heading-14">场景二：死锁（Deadlock）</h3>
<h4 data-id="heading-15">现象</h4>
<ul>
<li>1、请求全部超时（应用完全卡住）</li>
<li>2、日志中无异常信息，但日志不再输出（线程不再处理新任务）</li>
</ul>
<h4 data-id="heading-16">排查思路</h4>
<p>死锁通常由 <strong>多个线程互相持有对方需要的锁</strong> 导致。JVM 能自动检测死锁。</p>
<h4 data-id="heading-17">Arthas排查定位步骤</h4>
<ul>
<li>
<p>1、启动 Arthas 并 attach 到目标进程<code>java -jar arthas-boot.jar 并进入目标服务进程</code></p>
</li>
<li>
<p>2、检查是否存在死锁 <code>thread -b</code></p>
<blockquote>
<p><code>-b</code> 参数表示 <strong>detect deadlock</strong>（检测死锁）</p>
</blockquote>
<ul>
<li>存在死锁则会输出死锁的具体信息：（以下Thread-A、Thread-B相互引用，典型死锁）</li>
</ul>

<pre><code class="hljs language-vbnet" lang="vbnet">    Found one Java-level deadlock:
    =============================
    <span class="hljs-string">"Thread-A"</span>:
      waiting <span class="hljs-keyword">to</span> lock monitor <span class="hljs-number">0</span>x00007f8b4c003a88 (<span class="hljs-type">object</span> <span class="hljs-number">0</span>x000000076b8d1234, a java.lang.<span class="hljs-type">Object</span>),
      which <span class="hljs-built_in">is</span> held <span class="hljs-keyword">by</span> <span class="hljs-string">"Thread-B"</span>
    <span class="hljs-string">"Thread-B"</span>:
      waiting <span class="hljs-keyword">to</span> lock monitor <span class="hljs-number">0</span>x00007f8b4c004b99 (<span class="hljs-type">object</span> <span class="hljs-number">0</span>x000000076b8d1240, a java.lang.<span class="hljs-type">Object</span>),
      which <span class="hljs-built_in">is</span> held <span class="hljs-keyword">by</span> <span class="hljs-string">"Thread-A"</span>
  
    Java stack information <span class="hljs-keyword">for</span> the threads listed above:
    ===================================================
    <span class="hljs-string">"Thread-A"</span>:
        at com.example.service.OrderService.pay(OrderService.java:<span class="hljs-number">30</span>)
        - waiting <span class="hljs-keyword">to</span> lock &lt;<span class="hljs-number">0</span>x000000076b8d1234&gt; (a java.lang.<span class="hljs-type">Object</span>)
        at com.example.controller.OrderController.submit(OrderController.java:<span class="hljs-number">22</span>)
    ...
</code></pre>
</li>
<li>
<p>3、查看完整线程栈</p>
<pre><code class="hljs language-bash" lang="bash">thread  <span class="hljs-comment"># 查看所有线程状态</span>
<span class="hljs-comment"># 或指定线程 ID</span>
thread 45
</code></pre>
</li>
<li>
<p>4、根据线程栈找出具体死锁位置及原因，并加以解决重新部署。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-18">场景三：慢接口</h3>
<h4 data-id="heading-19">现象</h4>
<p>其他接口正常，只有<strong>某个接口响应时间暴涨</strong>（例如：100ms-》5s+）</p>
<h4 data-id="heading-20">排查思路</h4>
<p>可能的原因：</p>
<ul>
<li>1、是不是<strong>数据库慢查询</strong></li>
<li>2、是不是 <strong>调用的其他服务的http接口超时</strong> ，进而导致的超时</li>
<li>3、本地方法逻辑复杂（如大循环、序列化）</li>
</ul>
<p>此时需要 <strong>追踪整个调用链的耗时分布</strong>。</p>
<h4 data-id="heading-21">Arthas排查定位步骤</h4>
<blockquote>
<p>假设慢接口对应 Controller 方法：<code>com.example.controller.UserController.getUser</code></p>
</blockquote>
<ul>
<li>1、使用 <code>trace</code> 命令追踪方法调用耗时<code>trace com.example.controller.UserController getUser</code>
<ul>
<li>1.1、然后触发一次请求，使Arthas输出调用链路（如 <code>curl http://localhost:8080/user/123</code>）
<code>---ts=2025-12-13 17:40:01;thread_name=http-nio-8080-exec-2;id=2a;is_daemon=true;priority=5;TCCL=org.springframework.boot...         </code>---[5023.45ms] com.example.controller.UserController:getUser()
+---[0.12ms] com.example.service.UserService::findById()
+---[5022.89ms] com.example.service.NotificationService::sendEmail() # ← 耗时 5 秒！
`---[0.05ms] return result</li>
<li>1.2、分析调用链路，找出耗时原因。（例如上诉：<code>sendEmail()</code> 花了 5 秒，可能是 SMTP 超时或网络问题。）</li>
<li>1.3、重复上诉步骤，找到最终的那个慢方法。（例如：继续分析 <code>sendEmail</code> 方法内部，<code>trace com.example.service.NotificationService sendEmail</code>）</li>
</ul>
</li>
<li>2、监控慢方法的参数和返回值，确定问题出现的原因。
<pre><code class="hljs language-bash" lang="bash">watch com.example.service.NotificationService sendEmail <span class="hljs-string">'{params, returnObj, throwExp}'</span> -v -x 2
<span class="hljs-comment">## 可看到是否传入了错误邮箱、是否抛出异常等。</span>
</code></pre>
</li>
<li>3、可通过热更新，先保证线上服务可用（临时解决，应急，例如跳过该逻辑）
<ul>
<li>3.1. 修改 <code>UserController.java</code>，注释掉 <code>notificationService.sendEmail(...)</code></li>
<li>3.2. 编译生成 <code>.class</code></li>
<li>3.3. 执行：<code>redefine /tmp/UserController.class</code></li>
</ul>
</li>
<li>4、根本上解决该问题，并发布更新。</li>
</ul>
<hr/>
<h3 data-id="heading-22">场景四：类加载异常</h3>
<h4 data-id="heading-23">现象</h4>





























<table><thead><tr><th>异常</th><th>常见原因</th></tr></thead><tbody><tr><td><code>ClassNotFoundException</code></td><td>类根本不存在于 classpath</td></tr><tr><td><code>NoClassDefFoundError</code></td><td>编译时存在，运行时缺失（如依赖未打包）</td></tr><tr><td><code>NoSuchMethodError</code></td><td>方法签名不一致（通常是版本冲突：A 依赖 v1，B 依赖 v2）</td></tr><tr><td><code>IncompatibleClassChangeError</code></td><td>类结构不兼容（如接口变抽象类）</td></tr><tr><td><code>LinkageError</code> / <code>ClassCastException</code></td><td>同一个类被不同 ClassLoader 加载</td></tr></tbody></table>
<h4 data-id="heading-24">排查思路</h4>
<blockquote>
<p><strong>核心问题本质</strong>：</p>
<ul>
<li><strong>类找不到？</strong> → 检查是否在 classpath</li>
<li><strong>类找到了但不对？</strong> → 检查是否被错误版本覆盖</li>
<li><strong>同一个类加载了多份？</strong> → 检查 ClassLoader 隔离问题</li>
</ul>
</blockquote>
<p>Arthas 排查思路（四步法）：</p>
<ul>
<li>1、<strong>类是否被加载？</strong> → 使用 <code>sc</code>（Search Class）</li>
<li>2、如果已加载，<strong>从哪加载的？</strong> → 使用 <code>sc -d</code> 查看类的详细信息（含 ClassLoader 和 codeSource）</li>
<li>3、反编译字节码，确认<strong>方法/字段是否存在？</strong> → 使用 <code>jad</code> 查看实际加载的代码</li>
<li>4、检查类加载器层次，<strong>分析是否存在冲突？</strong> → 使用 <code>classloader</code> 命令分析 ClassLoader 树</li>
</ul>
<h4 data-id="heading-25">Arthas排查定位详细步骤</h4>
<blockquote>
<p>假设有以下报错<code>java.lang.NoSuchMethodError: com.example.util.StringUtils.isBlank(Ljava/lang/String;)Z</code>，
根据报错怀疑 <code>StringUtils</code> 被低版本 JAR 覆盖</p>
</blockquote>
<ul>
<li>
<p>1、搜索该类是否被加载<code>sc *StringUtils*</code></p>
<ul>
<li>发现存在两个 <code>StringUtils</code>！需进一步确认用的是哪个：</li>
</ul>

<pre><code class="hljs">com.example.util.StringUtils
org.apache.commons.lang3.StringUtils
</code></pre>
</li>
<li>
<p>2、查看具体类的加载信息（<strong>关键</strong>！）<code>sc -d com.example.util.StringUtils</code></p>
<ul>
<li>输出示例：（<strong>重点看 <code>code-source</code> 和 <code>class-loader</code></strong>  ）
class-info        com.example.util.StringUtils
code-source       /app/lib/utils-1.0.jar   ← ⚠️ 关键：来自哪个 JAR！判断是不是你所期望的那个？（<code>code-source</code> 为空，可能是从 <code>classes</code> 目录加载（非 JAR））
name              com.example.util.StringUtils
isInterface       false
isAnnotation      false
isEnum            false
isAnonymousClass  false
isArray           false
isLocalClass      false
isMemberClass     false
isPrimitive       false
isSynthetic       false
simple-name       StringUtils
modifier          public
annotation
interfaces
super-class       java.lang.Object
class-loader      org.springframework.boot.loader.LaunchedURLClassLoader@1c20c6b4
class-loader-hash 1c20c6b4</li>
</ul>
</li>
<li>
<p>3、反编译确认方法是否存在：<code>jad com.example.util.StringUtils</code></p>
<ul>
<li>例如以下输出片段：（<strong>没有 <code>isBlank</code> 方法</strong>，所以抛出 <code>NoSuchMethodError</code>）</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringUtils</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEmpty</span><span class="hljs-params">(String str)</span> {
        <span class="hljs-keyword">return</span> str == <span class="hljs-literal">null</span> || str.length() == <span class="hljs-number">0</span>;
    }
    <span class="hljs-comment">// 注意：没有 isBlank 方法！</span>
}
</code></pre>
</li>
<li>
<p>4、检查是否有多个版本的 JAR？</p>
<ul>
<li>方法 A：列出所有 JAR 中的该类（需知道可能路径）
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看 classpath 下所有 JAR</span>
classloader -l
</code></pre>
</li>
<li>方法 B：搜索所有 ClassLoader 中的该类（Arthas 3.5+）
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># `-a` 表示 all classloaders，可发现不同 ClassLoader 加载了不同版本。</span>
sc -a *StringUtils*
</code></pre>
</li>
<li>方法 C：查看某个 ClassLoader 加载了哪些资源
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 先获取 ClassLoader hash（从 sc -d 输出中拿到，如 1c20c6b4）</span>
classloader -c 1c20c6b4 -r com/example/util/StringUtils.class
<span class="hljs-comment"># 输出：file:/app/lib/utils-1.0.jar!/com/example/util/StringUtils.class</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p>5、对比期望版本 vs 实际版本</p>
<ul>
<li>5.1. 将正确版本的 <code>StringUtils.class</code> 上传到服务器</li>
<li>5.2. 用 Arthas 反编译对比：
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 反编译线上加载的</span>
jad --source-only com.example.util.StringUtils &gt; online.java

<span class="hljs-comment"># 反编译你本地正确的（先放到 /tmp/correct/ 目录）</span>
jad --source-only -c /tmp/correct/StringUtils.class &gt; correct.java

<span class="hljs-comment"># diff 对比</span>
diff online.java correct.java
</code></pre>
</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-26">总结：类加载问题排查流程图</h4>
<p>Arthas 的 <code>sc</code> + <code>jad</code> + <code>classloader</code> 组合拳，是解决此类问题的“黄金三角”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b033f31665941fea9f48c569e34e339~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YePX-eugA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766285838&amp;x-signature=kH0MXhRJBwNHSn0ZMXVIqFP02d8%3D" alt="类加载问题排查流程图.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-27">使用实用建议</h3>
<ul>
<li>1、精准监控特定参数</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 只监控用户名为 "admin" 的登录请求</span>
watch com.example.service.UserService login <span class="hljs-string">'params[0]=="admin"'</span> -v
</code></pre>
<ul>
<li>2、限制监控次数</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 只捕获前 3 次调用</span>
watch com.example.service.UserService login <span class="hljs-string">'{params, returnObj}'</span> -n 3
</code></pre>
<ul>
<li>3、结合 OGNL 表达式过滤</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">watch com.example.service.OrderService createOrder <span class="hljs-string">'params[0].amount &gt; 1000'</span> -x 3
</code></pre>
<ul>
<li>4、快速定位 CPU 飙高</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看最耗 CPU 的线程</span>
thread -n 3

<span class="hljs-comment"># 结合 jstack 分析死锁</span>
thread -b
</code></pre>
<ul>
<li>5、热修复（谨慎使用！）</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 修改本地 .java 文件并编译成 .class</span>
<span class="hljs-comment"># 2. 上传到服务器</span>
<span class="hljs-comment"># 3. 执行</span>
redefine /tmp/UserService.class
</code></pre>
<blockquote>
<p>注意：<code>redefine</code> 不能增减字段/方法，仅支持方法体修改。</p>
</blockquote>
<ul>
<li>6、导出堆快照（用于 MAT 或 JProfiler 分析内存泄漏。）</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">heapdump --live /tmp/heap.hprof
</code></pre>
<ul>
<li>7、类冲突定位：
<ul>
<li>7.1、模糊搜索 + 包过滤（只搜自己项目的类，避免第三方干扰）<code>sc com.yourcompany.*Service</code></li>
<li>7.2、结合异常堆栈定位具体类（从异常日志中提取完整类名，直接 <code>sc -d</code> 它）</li>
<li>7.3、注意内部类写法
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 内部类要用 $ 分隔</span>
sc com.example.OuterClass<span class="hljs-variable">$InnerClass</span>
jad com.example.OuterClass<span class="hljs-variable">$InnerClass</span>
</code></pre>
</li>
<li>7.4、Spring Boot 特别注意
<ul>
<li>Spring Boot 使用 <code>LaunchedURLClassLoader</code></li>
<li>类通常来自 <code>BOOT-INF/classes</code> 或 <code>BOOT-INF/lib/xxx.jar</code></li>
<li>如果 <code>sc -d</code> 显示 <code>code-source</code> 为空，可能是从 <code>classes</code> 目录加载（非 JAR）</li>
</ul>
</li>
<li/>
</ul>
</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[自定义 ClassLoader 动态加载：不重启就能加载新代码？]]></title>    <link>https://juejin.cn/post/7582923861768601650</link>    <guid>https://juejin.cn/post/7582923861768601650</guid>    <pubDate>2025-12-14T00:11:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582923861768601650" data-draft-id="7582955784569946163" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="自定义 ClassLoader 动态加载：不重启就能加载新代码？"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-12-14T00:11:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            自定义 ClassLoader 动态加载：不重启就能加载新代码？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T00:11:47.000Z" title="Sun Dec 14 2025 00:11:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>本文将带你用 300 行代码，亲手实现 JVM 级别的动态代码加载能力，并看清它的代价。</strong></p>
<p>全程只使用 <code>javax.tools.JavaCompiler</code> 和标准 ClassLoader，零第三方依赖，JDK 8+ 开箱即用。</p>
<hr/>
<h2 data-id="heading-0">一、同一个问题，不同的解法</h2>
<p>项目中经常有这样的需求：运营配置一段规则脚本，系统能直接执行。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">rule</span> <span class="hljs-operator">=</span> <span class="hljs-string">"if (amount &gt; 100) amount * 0.8"</span>;
<span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> engine.execute(rule);  <span class="hljs-comment">// 怎么让字符串变成可执行代码？</span>
</code></pre>
<p>上一篇文章《<a href="https://juejin.cn/post/7582814236584329254" target="_blank" title="https://juejin.cn/post/7582814236584329254">QLExpress 如何做到不编译就能执行？</a>》讲了解释执行的方案：把脚本解析成 AST 树，用 Java 代码遍历执行，不生成 class 文件。</p>
<p>这一篇换个思路：<strong>能不能把脚本编译成真正的 class 文件，然后加载执行？</strong></p>
<p>听起来很酷，但有三个问题：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> <span class="hljs-string">"public class Script { ... }"</span>;

<span class="hljs-comment">// 问题1：怎么编译？Java 源码变成字节码</span>
<span class="hljs-type">byte</span>[] classBytes = compile(code);

<span class="hljs-comment">// 问题2：怎么加载？字节码变成 Class 对象</span>
Class&lt;?&gt; clazz = load(classBytes);

<span class="hljs-comment">// 问题3：怎么执行？调用 Class 的方法</span>
<span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> clazz.execute();
</code></pre>
<p>花了一天手写 300 行代码验证，这个思路完全可行。后来发现：<strong>这就是 Groovy 的做法。</strong></p>
<p><strong>Groovy 是什么？</strong> 一门运行在 JVM 上的动态语言，最常见的场景是 Jenkins Pipeline 和 Gradle 构建脚本。它的核心能力就是动态编译执行。</p>
<p>本文手写的实现称为 <code>DynamicScriptRunner</code>，展示 Groovy 等脚本引擎的底层原理，全程只用 JDK 自带工具，零依赖。</p>
<h2 data-id="heading-1">二、整体流程</h2>
<p>把脚本执行分成五个阶段：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[脚本字符串] --&gt;|1.包装| B[Java源码]
    B --&gt;|2.编译| C[内存字节码]
    C --&gt;|3.加载| D[Class对象]
    D --&gt;|4.反射| E[执行结果]
    
    style A fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style B fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style C fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style D fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    style E fill:#ffebee,stroke:#b71c1c,stroke-width:2px
</code></pre>
<p><strong>举个例子</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 输入脚本</span>
<span class="hljs-string">"if (amount &gt; 100) MyMath.discount(amount, 0.8)"</span>

<span class="hljs-comment">// 上下文</span>
amount = <span class="hljs-number">150</span>
MyMath = MyMath.class

<span class="hljs-comment">// 执行流程</span>
脚本字符串 → 包装成Java类 → 编译成字节码 → 加载成Class → 反射执行 → 返回<span class="hljs-number">120.0</span>
</code></pre>
<hr/>
<h2 data-id="heading-2">三、关键技术点详解</h2>
<h3 data-id="heading-3">技术点一：脚本包装成 Java 源码</h3>
<p><strong>原始脚本</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (amount &gt; <span class="hljs-number">100</span>) MyMath.discount(amount, <span class="hljs-number">0.8</span>)
</code></pre>
<p><strong>包装后的 Java 源码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Script_1702345678</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">execute</span><span class="hljs-params">(
        java.util.Map&lt;String, Object&gt; context,
        java.util.Map&lt;String, Class&lt;?&gt;&gt; functions
    )</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 步骤1：从 context 提取变量并声明</span>
        <span class="hljs-type">Double</span> <span class="hljs-variable">amount</span> <span class="hljs-operator">=</span> (Double) context.get(<span class="hljs-string">"amount"</span>);
        
        <span class="hljs-comment">// 步骤2：从 functions 提取函数类</span>
        Class&lt;?&gt; MyMath = functions.get(<span class="hljs-string">"MyMath"</span>);
        
        <span class="hljs-comment">// 步骤3：插入脚本（需要转换）</span>
        <span class="hljs-keyword">return</span> (amount &gt; <span class="hljs-number">100</span>) ? 
            (Double) MyMath.getMethod(<span class="hljs-string">"discount"</span>, <span class="hljs-type">double</span>.class, <span class="hljs-type">double</span>.class)
                           .invoke(<span class="hljs-literal">null</span>, amount, <span class="hljs-number">0.8</span>)
            : <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<p><strong>为什么要包装？</strong></p>
<pre><code class="hljs">脚本片段不能直接编译
必须包装成完整的类
才能交给 JavaCompiler
</code></pre>
<p><strong>包装三步走</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[原始脚本] --&gt; B[提取变量]
    A --&gt; C[提取函数]
    A --&gt; D[转换调用]
    
    B --&gt; E[生成Java源码]
    C --&gt; E
    D --&gt; E
    
    style A fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style B fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style C fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style D fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style E fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
</code></pre>
<p><strong>详细说明</strong>：</p>
<ol>
<li>提取变量：从 context 中提取 amount，生成 <code>Double amount = ...</code></li>
<li>提取函数：从 functions 中提取 MyMath，生成 <code>Class&lt;?&gt; MyMath = ...</code></li>
<li>转换调用：把 <code>MyMath.discount(...)</code> 转换成反射调用</li>
</ol>
<p><strong>关键代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> String <span class="hljs-title function_">wrapScript</span><span class="hljs-params">(String className, String script)</span> {
    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
    
    <span class="hljs-comment">// 类定义</span>
    sb.append(<span class="hljs-string">"public class "</span>).append(className).append(<span class="hljs-string">" {\n"</span>);
    sb.append(<span class="hljs-string">"    public static Object execute(\n"</span>);
    sb.append(<span class="hljs-string">"        java.util.Map&lt;String, Object&gt; context,\n"</span>);
    sb.append(<span class="hljs-string">"        java.util.Map&lt;String, Class&lt;?&gt;&gt; functions\n"</span>);
    sb.append(<span class="hljs-string">"    ) throws Exception {\n"</span>);
    
    <span class="hljs-comment">// 注入变量</span>
    <span class="hljs-keyword">for</span> (String varName : context.getVariables().keySet()) {
        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> context.getVariables().get(varName);
        <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> getJavaType(value);  <span class="hljs-comment">// Double, Integer, String</span>
        sb.append(<span class="hljs-string">"        "</span>).append(type).append(<span class="hljs-string">" "</span>).append(varName)
          .append(<span class="hljs-string">" = ("</span>).append(type).append(<span class="hljs-string">") context.get(\""</span>)
          .append(varName).append(<span class="hljs-string">"\");\n"</span>);
    }
    
    <span class="hljs-comment">// 注入函数类</span>
    <span class="hljs-keyword">for</span> (String funcName : context.getFunctions().keySet()) {
        sb.append(<span class="hljs-string">"        Class&lt;?&gt; "</span>).append(funcName)
          .append(<span class="hljs-string">" = functions.get(\""</span>).append(funcName).append(<span class="hljs-string">"\");\n"</span>);
    }
    
    <span class="hljs-comment">// 转换并插入脚本</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">transformedScript</span> <span class="hljs-operator">=</span> transformScript(script);
    sb.append(<span class="hljs-string">"        return "</span>).append(transformedScript).append(<span class="hljs-string">";\n"</span>);
    
    sb.append(<span class="hljs-string">"    }\n"</span>);
    sb.append(<span class="hljs-string">"}\n"</span>);
    
    <span class="hljs-keyword">return</span> sb.toString();
}
</code></pre>
<h3 data-id="heading-4">技术点二：函数调用转换</h3>
<p><strong>问题</strong>：脚本里怎么调用 MyMath.discount？</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 脚本中</span>
MyMath.discount(<span class="hljs-number">100</span>, <span class="hljs-number">0.8</span>)

<span class="hljs-comment">// 但此时 MyMath 是 Class&lt;?&gt; 类型</span>
Class&lt;?&gt; MyMath = functions.get(<span class="hljs-string">"MyMath"</span>);

<span class="hljs-comment">// 不能直接调用方法</span>
MyMath.discount(<span class="hljs-number">100</span>, <span class="hljs-number">0.8</span>);  <span class="hljs-comment">// 编译错误！</span>
</code></pre>
<p><strong>解决方案</strong>：转换成反射调用</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 转换后</span>
(Double) MyMath.getMethod(<span class="hljs-string">"discount"</span>, <span class="hljs-type">double</span>.class, <span class="hljs-type">double</span>.class)
               .invoke(<span class="hljs-literal">null</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">0.8</span>)
</code></pre>
<p><strong>转换逻辑</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> String <span class="hljs-title function_">transformFunctionCalls</span><span class="hljs-params">(String script)</span> {
    <span class="hljs-comment">// 正则匹配：ClassName.methodName(args)</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> <span class="hljs-string">"(\\w+)\\.(\\w+)\\(([^)]*)\\)"</span>;
    <span class="hljs-type">Pattern</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> Pattern.compile(pattern);
    <span class="hljs-type">Matcher</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> p.matcher(script);
    
    <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();
    <span class="hljs-keyword">while</span> (m.find()) {
        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">1</span>);   <span class="hljs-comment">// MyMath</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">2</span>);  <span class="hljs-comment">// discount</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">3</span>);        <span class="hljs-comment">// 100, 0.8</span>
        
        String[] argArray = args.split(<span class="hljs-string">","</span>);
        
        <span class="hljs-comment">// 构造反射调用</span>
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">repl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        repl.append(<span class="hljs-string">"(Double) "</span>).append(className)
            .append(<span class="hljs-string">".getMethod(\""</span>).append(methodName).append(<span class="hljs-string">"\""</span>);
        
        <span class="hljs-comment">// 添加参数类型</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; argArray.length; i++) {
            repl.append(<span class="hljs-string">", double.class"</span>);
        }
        
        repl.append(<span class="hljs-string">").invoke(null, "</span>).append(args).append(<span class="hljs-string">")"</span>);
        
        m.appendReplacement(result, repl.toString());
    }
    m.appendTail(result);
    
    <span class="hljs-keyword">return</span> result.toString();
}
</code></pre>
<h3 data-id="heading-5">技术点三：JavaCompiler 动态编译</h3>
<p><strong>核心 API</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取系统编译器（需要 JDK，JRE 没有）</span>
<span class="hljs-type">JavaCompiler</span> <span class="hljs-variable">compiler</span> <span class="hljs-operator">=</span> ToolProvider.getSystemJavaCompiler();

<span class="hljs-keyword">if</span> (compiler == <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"需要 JDK，不能用 JRE"</span>);
}
</code></pre>
<p><strong>编译四步骤</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Java源码] --&gt;|包装| B[JavaFileObject]
    B --&gt;|编译| C[内存字节码]
    C --&gt;|检查| D{是否成功}
    D --&gt;|是| E[返回字节码]
    D --&gt;|否| F[抛异常]
    
    style A fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style B fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style C fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style D fill:#ffccbc,stroke:#e64a19,stroke-width:2px
    style E fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    style F fill:#ffebee,stroke:#b71c1c,stroke-width:2px
</code></pre>
<p><strong>关键代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] compile(String className, String javaSource) <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 1. 获取编译器</span>
    <span class="hljs-type">JavaCompiler</span> <span class="hljs-variable">compiler</span> <span class="hljs-operator">=</span> ToolProvider.getSystemJavaCompiler();
    
    <span class="hljs-comment">// 2. 诊断收集器（收集编译错误）</span>
    DiagnosticCollector&lt;JavaFileObject&gt; diagnostics = 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">DiagnosticCollector</span>&lt;&gt;();
    
    <span class="hljs-comment">// 3. 文件管理器（拦截输出到内存）</span>
    <span class="hljs-type">InMemoryFileManager</span> <span class="hljs-variable">fileManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryFileManager</span>(
        compiler.getStandardFileManager(diagnostics, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)
    );
    
    <span class="hljs-comment">// 4. 源码对象</span>
    <span class="hljs-type">JavaFileObject</span> <span class="hljs-variable">sourceFile</span> <span class="hljs-operator">=</span> 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringSourceJavaFileObject</span>(className, javaSource);
    
    <span class="hljs-comment">// 5. 编译任务</span>
    Iterable&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JavaFileObject</span>&gt; compilationUnits = 
        Arrays.asList(sourceFile);
    
    JavaCompiler.<span class="hljs-type">CompilationTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> compiler.getTask(
        <span class="hljs-literal">null</span>,                    <span class="hljs-comment">// 输出（null = 不输出）</span>
        fileManager,             <span class="hljs-comment">// 文件管理器</span>
        diagnostics,             <span class="hljs-comment">// 诊断收集器</span>
        <span class="hljs-literal">null</span>,                    <span class="hljs-comment">// 编译选项</span>
        <span class="hljs-literal">null</span>,                    <span class="hljs-comment">// 注解处理器</span>
        compilationUnits         <span class="hljs-comment">// 源文件</span>
    );
    
    <span class="hljs-comment">// 6. 执行编译</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> task.call();
    
    <span class="hljs-keyword">if</span> (!success) {
        <span class="hljs-comment">// 收集错误</span>
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">errors</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-keyword">for</span> (Diagnostic&lt;?&gt; d : diagnostics.getDiagnostics()) {
            errors.append(d.getMessage(<span class="hljs-literal">null</span>)).append(<span class="hljs-string">"\n"</span>);
        }
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"编译失败:\n"</span> + errors);
    }
    
    <span class="hljs-comment">// 7. 获取字节码</span>
    <span class="hljs-keyword">return</span> fileManager.getCompiledClass(className);
}
</code></pre>
<h3 data-id="heading-6">技术点四：内存编译（不写磁盘）</h3>
<p><strong>问题</strong>：JavaCompiler 默认会把 .class 写到磁盘</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 默认行为</span>
javac Script_123.java
<span class="hljs-comment"># 生成 Script_123.class 文件</span>
</code></pre>
<p><strong>目标</strong>：编译后的字节码保存在内存，不写磁盘</p>
<p><strong>解决方案</strong>：自定义 FileManager 拦截输出</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[编译器要写.class] --&gt;|拦截| B[FileManager]
    B --&gt;|改写到| C[内存对象]
    C --&gt;|保存| D[ByteArrayOutputStream]
    
    style A fill:#ffccbc,stroke:#e64a19,stroke-width:2px
    style B fill:#fff9c4,stroke:#f57f17,stroke-width:3px
    style C fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style D fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
</code></pre>
<p><strong>核心原理</strong>：</p>
<p>编译器调用 <code>getJavaFileForOutput()</code> 时，我们返回自己的内存对象，而不是真实文件。编译器会把字节码写到这个内存对象里。</p>
<p><strong>关键代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InMemoryFileManager</span> 
    <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ForwardingJavaFileManager</span>&lt;JavaFileManager&gt; {
    
    <span class="hljs-comment">// 保存编译后的字节码</span>
    <span class="hljs-keyword">private</span> Map&lt;String, ByteArrayJavaFileObject&gt; compiledClasses = 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> JavaFileObject <span class="hljs-title function_">getJavaFileForOutput</span><span class="hljs-params">(
        Location location,
        String className,
        JavaFileObject.Kind kind,
        FileObject sibling
    )</span> <span class="hljs-keyword">throws</span> IOException {
        
        <span class="hljs-keyword">if</span> (kind == JavaFileObject.Kind.CLASS) {
            <span class="hljs-comment">// 拦截 .class 输出</span>
            <span class="hljs-type">ByteArrayJavaFileObject</span> <span class="hljs-variable">fileObject</span> <span class="hljs-operator">=</span> 
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayJavaFileObject</span>(className);
            compiledClasses.put(className, fileObject);
            <span class="hljs-keyword">return</span> fileObject;  <span class="hljs-comment">// 返回内存对象</span>
        }
        
        <span class="hljs-comment">// 其他类型交给父类处理</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.getJavaFileForOutput(location, className, kind, sibling);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] getCompiledClass(String className) {
        <span class="hljs-type">ByteArrayJavaFileObject</span> <span class="hljs-variable">fileObject</span> <span class="hljs-operator">=</span> compiledClasses.get(className);
        <span class="hljs-keyword">return</span> fileObject != <span class="hljs-literal">null</span> ? fileObject.getBytes() : <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<p><strong>ByteArrayJavaFileObject</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ByteArrayJavaFileObject</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleJavaFileObject</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ByteArrayJavaFileObject</span><span class="hljs-params">(String className)</span> {
        <span class="hljs-built_in">super</span>(
            URI.create(<span class="hljs-string">"bytes:///"</span> + className.replace(<span class="hljs-string">'.'</span>, <span class="hljs-string">'/'</span>) + <span class="hljs-string">".class"</span>),
            Kind.CLASS
        );
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> OutputStream <span class="hljs-title function_">openOutputStream</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> baos;  <span class="hljs-comment">// 编译器写入这里，从内存加载字节码，绕过磁盘IO</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] getBytes() {
        <span class="hljs-keyword">return</span> baos.toByteArray();  <span class="hljs-comment">// 获取字节码</span>
    }
}
</code></pre>
<h3 data-id="heading-7">技术点五：自定义 ClassLoader 加载</h3>
<p><strong>问题</strong>：有了字节码，怎么加载成 Class 对象？</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">byte</span>[] classBytes = compiler.compile(className, javaSource);
<span class="hljs-comment">// 怎么变成 Class&lt;?&gt; 对象？</span>
</code></pre>
<p><strong>答案</strong>：自定义 ClassLoader</p>
<p><strong>核心方法</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// defineClass：字节码数组 → Class 对象</span>
Class&lt;?&gt; clazz = defineClass(name, classBytes, <span class="hljs-number">0</span>, classBytes.length);
</code></pre>
<p><strong>双亲委派机制</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">先问父类能不能加载
  ↓ 不能
再调用自己的 findClass
  ↓
从内存字节码数组加载
  ↓
返回 <span class="hljs-keyword">Class</span> 对象
</code></pre>
<p><strong>关键代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScriptClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> {
    
    <span class="hljs-comment">// 存储字节码</span>
    <span class="hljs-keyword">private</span> Map&lt;String, <span class="hljs-type">byte</span>[]&gt; classBytesMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ScriptClassLoader</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>(ScriptClassLoader.class.getClassLoader());  <span class="hljs-comment">// 设置父类加载器</span>
    }
    
    <span class="hljs-comment">// 注册字节码</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">defineClass</span><span class="hljs-params">(String className, <span class="hljs-type">byte</span>[] classBytes)</span> {
        classBytesMap.put(className, classBytes);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException {
        <span class="hljs-comment">// 从内存获取字节码（JDK 编译器 SPI 接口生成的）</span>
        <span class="hljs-type">byte</span>[] classBytes = classBytesMap.get(name);
        
        <span class="hljs-keyword">if</span> (classBytes != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// defineClass：从内存字节数组加载，绕过磁盘IO</span>
            <span class="hljs-keyword">return</span> defineClass(name, classBytes, <span class="hljs-number">0</span>, classBytes.length);
        }
        
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassNotFoundException</span>(name);
    }
}
</code></pre>
<p><strong>为什么每次生成新类名？</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Script_"</span> + System.currentTimeMillis();
</code></pre>
<p><strong>原因</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 同一个 ClassLoader 不能加载同名类
<span class="hljs-bullet">2.</span> 重复加载会报错：LinkageError

解决方案：
<span class="hljs-bullet">-</span> 方案1：每次生成新类名（当前做法）
<span class="hljs-bullet">-</span> 方案2：每次创建新 ClassLoader
<span class="hljs-bullet">-</span> 方案3：缓存（相同脚本复用 Class）
</code></pre>
<h3 data-id="heading-8">技术点六：反射执行</h3>
<p><strong>问题</strong>：有了 Class 对象，怎么执行？</p>
<pre><code class="hljs language-java" lang="java">Class&lt;?&gt; scriptClass = loader.loadClass(<span class="hljs-string">"Script_1702345678"</span>);
<span class="hljs-comment">// 怎么调用 execute 方法？</span>
</code></pre>
<p><strong>答案</strong>：反射</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 获取 execute 方法</span>
<span class="hljs-type">Method</span> <span class="hljs-variable">executeMethod</span> <span class="hljs-operator">=</span> scriptClass.getMethod(
    <span class="hljs-string">"execute"</span>, 
    Map.class,    <span class="hljs-comment">// 第一个参数：context</span>
    Map.class     <span class="hljs-comment">// 第二个参数：functions</span>
);

<span class="hljs-comment">// 2. 准备参数</span>
Map&lt;String, Object&gt; context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
context.put(<span class="hljs-string">"amount"</span>, <span class="hljs-number">150.0</span>);

Map&lt;String, Class&lt;?&gt;&gt; functions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
functions.put(<span class="hljs-string">"MyMath"</span>, MyMath.class);

<span class="hljs-comment">// 3. 调用（静态方法，第一个参数传 null）</span>
<span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> executeMethod.invoke(
    <span class="hljs-literal">null</span>,        <span class="hljs-comment">// 静态方法</span>
    context,     <span class="hljs-comment">// 第一个参数</span>
    functions    <span class="hljs-comment">// 第二个参数</span>
);

<span class="hljs-comment">// 4. 返回结果</span>
<span class="hljs-keyword">return</span> result;  <span class="hljs-comment">// 120.0</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">四、完整执行流程示例</h2>
<p><strong>输入</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">"if (amount &gt; 100) MyMath.discount(amount, 0.8)"</span>;
Context:
  amount = <span class="hljs-number">150.0</span>
  MyMath = MyMath.class
</code></pre>
<p><strong>执行流程</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[脚本字符串] --&gt; B[包装成Java源码]
    B --&gt; C[JavaCompiler编译]
    C --&gt; D[得到内存字节码]
    D --&gt; E[ClassLoader加载]
    E --&gt; F[反射执行]
    F --&gt; G[返回结果]
    
    style A fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style B fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style C fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style D fill:#ffccbc,stroke:#e64a19,stroke-width:2px
    style E fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
    style F fill:#ffebee,stroke:#c62828,stroke-width:2px
    style G fill:#e8f5e9,stroke:#1b5e20,stroke-width:3px
</code></pre>
<p><strong>生成的 Java 源码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Script_1702345678</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">execute</span><span class="hljs-params">(
        java.util.Map&lt;String, Object&gt; context,
        java.util.Map&lt;String, Class&lt;?&gt;&gt; functions
    )</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Double</span> <span class="hljs-variable">amount</span> <span class="hljs-operator">=</span> (Double) context.get(<span class="hljs-string">"amount"</span>);
        Class&lt;?&gt; MyMath = functions.get(<span class="hljs-string">"MyMath"</span>);
        
        <span class="hljs-keyword">return</span> (amount &gt; <span class="hljs-number">100</span>) ? 
            (Double) MyMath.getMethod(<span class="hljs-string">"discount"</span>, <span class="hljs-type">double</span>.class, <span class="hljs-type">double</span>.class)
                           .invoke(<span class="hljs-literal">null</span>, amount, <span class="hljs-number">0.8</span>)
            : <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<p><strong>编译后的字节码指令</strong>（伪代码）：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">execute方法:
  ALOAD context
  LDC <span class="hljs-string">"amount"</span>
  INVOKEINTERFACE <span class="hljs-keyword">get</span>
  CHECKCAST <span class="hljs-type">Double</span>
  ASTORE amount
  
  ALOAD amount
  INVOKEVIRTUAL doubleValue
  LDC <span class="hljs-number">100.0</span>
  DCMPG
  IFLE label_else       ← 真正的 JVM <span class="hljs-keyword">if</span> 指令！
  
  ALOAD MyMath
  LDC <span class="hljs-string">"discount"</span>
  ...
  INVOKEVIRTUAL invoke
  <span class="hljs-keyword">GOTO</span> label_end
  
<span class="hljs-symbol">label_else:</span>
  ACONST_NULL
  
<span class="hljs-symbol">label_end:</span>
  ARETURN
</code></pre>
<p><strong>关键对比</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">QLExpress</span>：
  用 <span class="hljs-title class_">Java</span> 的 <span class="hljs-keyword">if</span> 包装：<span class="hljs-keyword">if</span> ((<span class="hljs-title class_">Boolean</span>) cond) { ... }
  
<span class="hljs-title class_">MiniGroovy</span>：
  生成 <span class="hljs-variable constant_">JVM</span> 的 <span class="hljs-keyword">if</span> 指令：<span class="hljs-variable constant_">IFLE</span> label_else
</code></pre>
<hr/>
<h2 data-id="heading-10">五、与 QLExpress 的对比</h2>
<p>不深入对比（下一篇文章的事），简单说几点差异：</p>



































<table><thead><tr><th>维度</th><th>QLExpress</th><th>DynamicScriptRunner</th></tr></thead><tbody><tr><td>if 语句</td><td>Java 代码模拟</td><td>JVM 字节码指令</td></tr><tr><td>生成 class</td><td>不生成</td><td>生成</td></tr><tr><td>启动速度</td><td>快</td><td>慢（编译耗时）</td></tr><tr><td>运行速度</td><td>慢</td><td>快（JIT 优化）</td></tr><tr><td>内存占用</td><td>低</td><td>高（每次生成新类）</td></tr></tbody></table>
<p><strong>核心差异</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">QLExpress：
  脚本 → AST → 用 Java 代码遍历执行
  
DynamicScriptRunner：
  脚本 → Java 源码 → 编译成 <span class="hljs-keyword">class</span> → JVM 执行
</code></pre>
<hr/>
<h2 data-id="heading-11">六、黑科技与警告</h2>
<h3 data-id="heading-12">黑科技：动态加载 Controller</h3>
<p>理论上，可以用这个技术动态加载 Controller：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 写一个 HTTP 接口接收代码</span>
<span class="hljs-meta">@PostMapping("/dynamicController")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">addController</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> String code)</span> {
    <span class="hljs-comment">// 编译代码</span>
    <span class="hljs-type">byte</span>[] classBytes = compiler.compile(<span class="hljs-string">"DynamicController"</span>, code);
    
    <span class="hljs-comment">// 加载类</span>
    Class&lt;?&gt; clazz = loader.loadClass(<span class="hljs-string">"DynamicController"</span>);
    
    <span class="hljs-comment">// 注册到 Spring</span>
    <span class="hljs-comment">// ...（省略注册逻辑）</span>
    
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Controller 已加载，无需重启！"</span>;
}
</code></pre>
<p><strong>想象一下</strong>：</p>
<pre><code class="hljs">不重启服务器
发送一段代码
新功能立刻生效
</code></pre>
<p>听起来很酷？</p>
<h3 data-id="heading-13">警告：千万别在线上用</h3>
<p><strong>为什么不能用？</strong></p>
<h4 data-id="heading-14">风险一：类泄漏导致 OOM</h4>
<pre><code class="hljs">每次加载生成新类
不释放会占满 Metaspace
最终 OutOfMemoryError
</code></pre>
<p><strong>真实案例</strong>：某团队在线上使用类似机制热更新业务规则，因类加载器泄漏未及时清理，72 小时后 Metaspace 占满，Full GC 频发，服务雪崩。</p>
<p><strong>监控</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">jmap -clstats &lt;pid&gt; | grep Script_

输出：
Script_1702345678
Script_1702345679
Script_1702345680
...
Script_1702399999  <span class="hljs-comment"># 几万个类！</span>
</code></pre>
<h4 data-id="heading-15">风险二：安全漏洞</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 用户提交恶意代码</span>
<span class="hljs-type">String</span> <span class="hljs-variable">maliciousCode</span> <span class="hljs-operator">=</span> <span class="hljs-string">"System.exit(0)"</span>;
<span class="hljs-comment">// 或</span>
<span class="hljs-type">String</span> <span class="hljs-variable">maliciousCode</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Runtime.getRuntime().exec(\"rm -rf /\")"</span>;

<span class="hljs-comment">// 你的服务：直接挂了</span>
</code></pre>
<h4 data-id="heading-16">风险三：编译耗时影响性能</h4>
<pre><code class="hljs">JavaCompiler 编译一次：100-200ms
高并发下：所有请求都在等编译
服务响应变慢
</code></pre>
<h4 data-id="heading-17">风险四：难以追踪和调试</h4>
<pre><code class="hljs">线上出了问题
看日志：Script_1702345678 报错
去哪找这个类的代码？
已经不在了，只在内存里存在过
</code></pre>
<h3 data-id="heading-18">对线上要有敬畏之心</h3>
<pre><code class="hljs language-diff" lang="diff">动态编译很强大
但也很危险

线上环境：
<span class="hljs-deletion">- 稳定压倒一切</span>
<span class="hljs-deletion">- 可追溯压倒一切</span>
<span class="hljs-deletion">- 安全压倒一切</span>

这种黑科技：
<span class="hljs-deletion">- 学习可以</span>
<span class="hljs-deletion">- 本地玩可以</span>
<span class="hljs-deletion">- 线上绝对不行</span>
</code></pre>
<p><strong>替代方案</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">需要动态能力？
<span class="hljs-deletion">- 用配置中心（Apollo、Nacos）</span>
<span class="hljs-deletion">- 用规则引擎（Drools、QLExpress）</span>
<span class="hljs-deletion">- 用脚本引擎（但要沙箱隔离）</span>
<span class="hljs-deletion">- 用插件系统（OSGi、JPMS）</span>

需要热部署？
<span class="hljs-deletion">- 用灰度发布</span>
<span class="hljs-deletion">- 用蓝绿部署</span>
<span class="hljs-deletion">- 用滚动更新</span>
</code></pre>
<p><strong>安全使用场景</strong>：</p>
<p>这项技术并非一无是处，在可控环境下有其价值：</p>
<pre><code class="hljs language-diff" lang="diff">适合使用：
<span class="hljs-deletion">- 本地调试脚本</span>
<span class="hljs-deletion">- 规则测试沙箱</span>
<span class="hljs-deletion">- 教学演示系统</span>
<span class="hljs-deletion">- 低频配置热加载（配合严格白名单）</span>
<span class="hljs-deletion">- 内部工具平台（非核心业务）</span>

前提条件：
<span class="hljs-deletion">- 严格的权限控制</span>
<span class="hljs-deletion">- 完善的监控告警</span>
<span class="hljs-deletion">- 清晰的生命周期管理</span>
<span class="hljs-deletion">- 定期的类加载器清理</span>
</code></pre>
<hr/>
<h2 data-id="heading-19">七、完整测试</h2>
<h3 data-id="heading-20">测试代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">DynamicScriptRunner</span> <span class="hljs-variable">runner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicScriptRunner</span>();
        runner.register(<span class="hljs-string">"MyMath"</span>, MyMath.class);
        runner.getContext().put(<span class="hljs-string">"amount"</span>, <span class="hljs-number">150.0</span>);
        
        test(runner, <span class="hljs-string">"2 + 3 * 4"</span>);
        test(runner, <span class="hljs-string">"if (amount &gt; 100) amount * 0.8"</span>);
        test(runner, <span class="hljs-string">"MyMath.discount(100, 0.8)"</span>);
        test(runner, <span class="hljs-string">"if (amount &gt; 100) MyMath.discount(amount, 0.8)"</span>);
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(DynamicScriptRunner runner, String script)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> runner.execute(script);
        System.out.println(<span class="hljs-string">"Result: "</span> + result);
    }
}
</code></pre>
<h3 data-id="heading-21">测试输出</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Result: 14.0</span>
<span class="hljs-section">Result: 120.0</span>
<span class="hljs-section">Result: 80.0</span>
<span class="hljs-section">Result: 120.0</span>
</code></pre>
<p><strong>验证</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 运行时查看加载的类</span>
jps
jmap -clstats &lt;pid&gt; | grep Script_

<span class="hljs-comment"># 应该看到</span>
Script_1702345678
Script_1702345679
Script_1702345680
Script_1702345681

<span class="hljs-comment"># 每次执行生成一个新类</span>
</code></pre>
<hr/>
<h2 data-id="heading-22">八、核心代码展示</h2>
<h3 data-id="heading-23">DynamicScriptRunner 主入口</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicScriptRunner</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Context</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-type">InMemoryCompiler</span> <span class="hljs-variable">compiler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryCompiler</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(String name, Class&lt;?&gt; clazz)</span> {
        context.registerFunction(name, clazz);
    }
    
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">execute</span><span class="hljs-params">(String script)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 生成唯一类名</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Script_"</span> + System.currentTimeMillis();
        
        <span class="hljs-comment">// 2. 包装成 Java 源码</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">javaSource</span> <span class="hljs-operator">=</span> wrapScript(className, script);
        
        <span class="hljs-comment">// 3. 动态编译</span>
        <span class="hljs-type">byte</span>[] classBytes = compiler.compile(className, javaSource);
        
        <span class="hljs-comment">// 4. 加载类</span>
        <span class="hljs-type">ScriptClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScriptClassLoader</span>();
        loader.defineClass(className, classBytes);
        Class&lt;?&gt; scriptClass = loader.loadClass(className);
        
        <span class="hljs-comment">// 5. 反射执行</span>
        <span class="hljs-type">Method</span> <span class="hljs-variable">executeMethod</span> <span class="hljs-operator">=</span> scriptClass.getMethod(<span class="hljs-string">"execute"</span>, Map.class, Map.class);
        <span class="hljs-keyword">return</span> executeMethod.invoke(<span class="hljs-literal">null</span>, context.getVariables(), context.getFunctions());
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">wrapScript</span><span class="hljs-params">(String className, String script)</span> {
        <span class="hljs-comment">// 包装逻辑（前面已展示）</span>
    }
}
</code></pre>
<h3 data-id="heading-24">InMemoryCompiler 编译器</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InMemoryCompiler</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] compile(String className, String javaSource) <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">JavaCompiler</span> <span class="hljs-variable">compiler</span> <span class="hljs-operator">=</span> ToolProvider.getSystemJavaCompiler();
        
        DiagnosticCollector&lt;JavaFileObject&gt; diagnostics = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DiagnosticCollector</span>&lt;&gt;();
        <span class="hljs-type">InMemoryFileManager</span> <span class="hljs-variable">fileManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryFileManager</span>(
            compiler.getStandardFileManager(diagnostics, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)
        );
        
        <span class="hljs-type">JavaFileObject</span> <span class="hljs-variable">sourceFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringSourceJavaFileObject</span>(className, javaSource);
        
        JavaCompiler.<span class="hljs-type">CompilationTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> compiler.getTask(
            <span class="hljs-literal">null</span>, fileManager, diagnostics, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, Arrays.asList(sourceFile)
        );
        
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> task.call();
        
        <span class="hljs-keyword">if</span> (!success) {
            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">errors</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
            <span class="hljs-keyword">for</span> (Diagnostic&lt;?&gt; d : diagnostics.getDiagnostics()) {
                errors.append(d.getMessage(<span class="hljs-literal">null</span>)).append(<span class="hljs-string">"\n"</span>);
            }
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"编译失败:\n"</span> + errors);
        }
        
        <span class="hljs-keyword">return</span> fileManager.getCompiledClass(className);
    }
}
</code></pre>
<h3 data-id="heading-25">ScriptClassLoader 类加载器</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScriptClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> {
    
    <span class="hljs-keyword">private</span> Map&lt;String, <span class="hljs-type">byte</span>[]&gt; classBytesMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">defineClass</span><span class="hljs-params">(String className, <span class="hljs-type">byte</span>[] classBytes)</span> {
        classBytesMap.put(className, classBytes);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException {
        <span class="hljs-type">byte</span>[] classBytes = classBytesMap.get(name);
        <span class="hljs-keyword">if</span> (classBytes != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> defineClass(name, classBytes, <span class="hljs-number">0</span>, classBytes.length);
        }
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassNotFoundException</span>(name);
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-26">九、总结</h2>
<h3 data-id="heading-27">核心机制</h3>
<p>动态编译执行的本质是：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 脚本包装成完整 Java 类
<span class="hljs-bullet">2.</span> JavaCompiler 动态编译（JDK 原生能力）
<span class="hljs-bullet">3.</span> InMemoryFileManager 拦截输出到内存
<span class="hljs-bullet">4.</span> ScriptClassLoader 从内存加载字节码
<span class="hljs-bullet">5.</span> 反射调用执行
</code></pre>
<p><strong>零依赖实现</strong>：全程只使用 JDK 自带的 <code>javax.tools.JavaCompiler</code> 和标准 ClassLoader，无需引入任何第三方包。</p>
<h3 data-id="heading-28">关键技术点</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> JavaCompiler API：JDK 自带的动态编译工具
<span class="hljs-bullet">2.</span> FileManager 机制：拦截编译输出（JDK 编译器 SPI 接口）
<span class="hljs-bullet">3.</span> ClassLoader 机制：从内存加载字节码
<span class="hljs-bullet">4.</span> defineClass 方法：字节码数组 → Class 对象
<span class="hljs-bullet">5.</span> 反射调用：执行生成的类
</code></pre>
<h3 data-id="heading-29">与 QLExpress 的核心差异</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">QLExpress：
  用 Java 代码模拟 <span class="hljs-keyword">if</span>
  不生成 <span class="hljs-keyword">class</span>
  
<span class="hljs-title class_">MiniGroovy</span>：
  生成真正的 JVM <span class="hljs-keyword">if</span> 指令
  会生成 <span class="hljs-keyword">class</span>（在内存里）
</code></pre>
<h3 data-id="heading-30">学到了什么</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 动态编译不神秘，JavaCompiler 就能做
<span class="hljs-bullet">2.</span> class 文件可以只在内存里存在
<span class="hljs-bullet">3.</span> ClassLoader 可以从内存加载字节码
<span class="hljs-bullet">4.</span> 强大的技术要谨慎使用
<span class="hljs-bullet">5.</span> 对线上要有敬畏之心
</code></pre>
<hr/>
<h2 data-id="heading-31">写在最后</h2>
<p>拆了两个轮子：</p>
<p><strong>上一篇 QLExpress</strong>：</p>
<ul>
<li>不生成 class</li>
<li>用 Java 代码模拟执行</li>
<li>轻量、快速</li>
</ul>
<p><strong>本篇动态编译方案</strong>：</p>
<ul>
<li>动态编译生成 class</li>
<li>真正的 JVM 字节码</li>
<li>强大、灵活</li>
</ul>
<p>这套机制就是 Groovy、JSR-223 ScriptEngine 等工具的底层原理。理解了它，就理解了 Java 世界里动态能力的本质。</p>
<p>[本文代码] (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fsh_wangwanbao%2Fql-express-mini-groovy" target="_blank" title="https://gitee.com/sh_wangwanbao/ql-express-mini-groovy" ref="nofollow noopener noreferrer">gitee.com/sh_wangwanb…</a>)</p>
<p>下一篇计划：深入对比这两种方案，讲清楚什么场景用哪个。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别重蹈我们的覆辙：脚本引擎选错的两年代价]]></title>    <link>https://juejin.cn/post/7582904738922217510</link>    <guid>https://juejin.cn/post/7582904738922217510</guid>    <pubDate>2025-12-14T00:54:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582904738922217510" data-draft-id="7582905804048269339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别重蹈我们的覆辙：脚本引擎选错的两年代价"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-12-14T00:54:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别重蹈我们的覆辙：脚本引擎选错的两年代价
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T00:54:27.000Z" title="Sun Dec 14 2025 00:54:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>2011年，我入职一家大数据公司。技术总监构建了一套很酷的框架：Groovy 动态编译实现爬虫规则引擎。两年后，我们推翻了它，用 Hadoop 重写。</strong></p>
<p><strong>不是 Groovy 不好，是场景错了。</strong></p>
<p><strong>这篇文章，是那两年换来的教训：不分场景对比技术方案，就是耍流氓。</strong></p>
<hr/>
<h2 data-id="heading-0">一、两种技术方案：都是好方案，关键看场景</h2>
<p>执行动态脚本，有两种截然不同的思路。</p>
<p>项目需求：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">rule</span> <span class="hljs-operator">=</span> <span class="hljs-string">"if (amount &gt; 100) amount * 0.8"</span>;
<span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> engine.execute(rule);
</code></pre>
<h3 data-id="heading-1">方案一：解释执行</h3>
<pre><code class="hljs">脚本 → 词法分析 → 语法分析 → AST树 → 遍历执行
</code></pre>
<p>代表方案：QLExpress、Aviator、MVEL</p>
<p><strong>适合场景</strong>：高频调用、简单逻辑、核心链路</p>
<h3 data-id="heading-2">方案二：动态编译</h3>
<pre><code class="hljs language-arduino" lang="arduino">脚本 → 包装成Java源码 → 编译 → 生成<span class="hljs-keyword">class</span> → 加载执行
</code></pre>
<p>代表方案：Groovy、Janino、动态ClassLoader</p>
<p><strong>适合场景</strong>：低频调用、复杂逻辑、扩展框架</p>
<hr/>
<p><strong>打个比方</strong>：解释执行像叫外卖（10分钟送到，吃完不用洗碗），动态编译像建厨房（先建厨房、招厨师、买食材，2小时后饭才能吃上）。</p>
<p><strong>两种方案都是好方案，但用错了场景就是灾难。</strong></p>
<p>我们的问题不是选了 Groovy，而是在高频、核心、要求稳定的爬虫系统上用了 Groovy。</p>
<hr/>
<h2 data-id="heading-3">二、两种方案的本质差异：叫外卖 vs 建厨房</h2>
<h3 data-id="heading-4">核心区别</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[需求: 执行脚本] --&gt; B{解决方式}
    B --&gt;|QLExpress| C[解释执行]
    B --&gt;|Groovy| D[编译执行]
    
    C --&gt; E[遍历AST&lt;br/&gt;用Java的if]
    D --&gt; F[生成字节码&lt;br/&gt;JVM的if指令]
    
    style C fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style D fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style E fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    style F fill:#ffebee,stroke:#c62828,stroke-width:2px
</code></pre>
<h3 data-id="heading-5">用红烧肉的比喻说明白</h3>
<p><strong>QLExpress（叫外卖）</strong>：好的，我帮你叫个外卖。湘菜还是川菜？10分钟送到，吃完了碗都不用洗。</p>
<p><strong>Groovy（建厨房）</strong>：有厨房吗？没有，建一个。有厨师吗？没有，招一个。有锅铲吗？没有，去买。食材准备好了吗？去采购。2小时后，红烧肉做好了。而且，厨房还占着你家的地方。</p>
<h3 data-id="heading-6">执行模型对比</h3>



































<table><thead><tr><th>维度</th><th>QLExpress</th><th>Groovy</th></tr></thead><tbody><tr><td>if语句实现</td><td>Java 代码：<code>if ((Boolean) cond) { ... }</code></td><td>JVM 字节码：<code>IFLE label_else</code></td></tr><tr><td>执行单元</td><td>AST 节点遍历</td><td>字节码指令</td></tr><tr><td>性能特征</td><td>启动快，执行慢（无JIT）</td><td>启动慢，执行快（JIT优化）</td></tr><tr><td>内存模型</td><td>无新 class</td><td>每次生成新 class</td></tr><tr><td>调试体验</td><td>堆栈是解释器代码</td><td>堆栈是动态生成的类</td></tr></tbody></table>
<p><strong>金句</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">QLExpress 用 Java 代码模拟了一个 <span class="hljs-keyword">if</span>
Groovy 让 JVM 自己执行了一个 <span class="hljs-keyword">if</span>

前者是<span class="hljs-string">"翻译官"</span>，后者是<span class="hljs-string">"原住民"</span>
</code></pre>
<hr/>
<h2 data-id="heading-7">三、性能对比：用数据说话</h2>
<h3 data-id="heading-8">测试场景</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 简单规则</span>
<span class="hljs-type">String</span> <span class="hljs-variable">simple</span> <span class="hljs-operator">=</span> <span class="hljs-string">"if (amount &gt; 100) amount * 0.8"</span>;

<span class="hljs-comment">// 复杂规则（假设支持）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">complex</span> <span class="hljs-operator">=</span> <span class="hljs-string">"sum = 0; for (i in 1..100) { sum += i * rate }"</span>;
</code></pre>
<h3 data-id="heading-9">实测数据</h3>



































<table><thead><tr><th>维度</th><th>QLExpress</th><th>Groovy（编译执行）</th></tr></thead><tbody><tr><td>首次执行</td><td>5ms</td><td>150ms（编译耗时）</td></tr><tr><td>第二次执行</td><td>5ms</td><td>2ms</td></tr><tr><td>10万次平均耗时</td><td>0.05ms/次</td><td>0.01ms/次</td></tr><tr><td>内存占用（首次）</td><td>+2MB</td><td>+1MB</td></tr><tr><td>内存占用（1000次）</td><td>+2MB</td><td>+50MB（Metaspace）</td></tr></tbody></table>
<h3 data-id="heading-10">性能曲线</h3>
<pre><code class="hljs language-markdown" lang="markdown">执行时间（对数刻度）
 |
150ms| Groovy首次编译
 |   |
 |   |
 5ms | QL首次         QL稳定
 |   |<span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">__<span class="hljs-emphasis">_|_</span>__</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span>
 |               |
 2ms |           | Groovy第二次
 |               |<span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">___
 |                           \
0.01ms|                        Groovy稳定
 |__</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span>__
<span class="hljs-code">     1次      2次         10万次
</span></code></pre>
<h3 data-id="heading-11">数据解读</h3>
<p><strong>QLExpress</strong>：</p>
<ul>
<li>启动快（5ms），无编译耗时</li>
<li>性能稳定，但有上限（0.05ms）</li>
<li>内存占用低且恒定（+2MB）</li>
<li>像自行车：稳定、省力、但有速度上限</li>
</ul>
<p><strong>Groovy</strong>：</p>
<ul>
<li>启动慢（150ms），编译耗时明显</li>
<li>性能有优化空间，JIT 后更快（0.01ms）</li>
<li>内存占用高且持续增长（每次 +50KB）</li>
<li>像汽车：启动慢，但能跑远、跑快</li>
</ul>
<p><strong>结论</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">如果调用频率</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">1000</span><span class="hljs-string">次/秒：QLExpress</span> <span class="hljs-string">更稳</span>
<span class="hljs-string">如果单次执行很复杂，低频调用：Groovy</span> <span class="hljs-string">更快</span>
<span class="hljs-string">如果内存敏感（Serverless）：QLExpress</span> <span class="hljs-string">更省</span>
</code></pre>
<hr/>
<h2 data-id="heading-12">四、怎么选？看这张表就够了</h2>
<h3 data-id="heading-13">决策表：一眼看懂用哪个</h3>













































<table><thead><tr><th>场景特征</th><th>推荐方案</th><th>理由</th></tr></thead><tbody><tr><td><strong>简单表达式</strong> + 高频调用（&gt;1000/秒）</td><td>QLExpress</td><td>稳定、无GC压力、启动快</td></tr><tr><td><strong>简单表达式</strong> + 低频调用（&lt;100/秒）</td><td>QLExpress</td><td>简单够用，不需要编译</td></tr><tr><td><strong>复杂逻辑</strong>（循环/函数） + 低频调用</td><td>Groovy + 缓存</td><td>支持完整语法，类泄漏可控</td></tr><tr><td><strong>复杂逻辑</strong> + 高频调用</td><td>重新评估需求</td><td>可能需要其他方案</td></tr><tr><td><strong>内存敏感</strong>（Serverless/容器）</td><td>QLExpress</td><td>内存占用低且恒定</td></tr><tr><td><strong>极致性能要求</strong> + 可接受复杂度</td><td>Groovy + 监控</td><td>JIT优化后性能最好</td></tr><tr><td><strong>多租户/安全要求高</strong></td><td>QLExpress</td><td>白名单机制，天然沙箱</td></tr></tbody></table>
<h3 data-id="heading-14">快速判断三步走</h3>
<pre><code class="hljs language-markdown" lang="markdown">第一步：看复杂度
<span class="hljs-bullet">  -</span> 只有 if/比较/四则运算 → 简单
<span class="hljs-bullet">  -</span> 有循环/函数/多层嵌套 → 复杂

第二步：看频率
<span class="hljs-bullet">  -</span> &gt; 1000次/秒 → 高频
<span class="hljs-bullet">  -</span> &lt; 100次/秒 → 低频

第三步：查表选方案
  简单 + 高频 → QLExpress
  简单 + 低频 → QLExpress（够用就行）
  复杂 + 低频 → Groovy（配合缓存和监控）
  复杂 + 高频 → 可能需要重新设计
</code></pre>
<h3 data-id="heading-15">典型场景分析</h3>
<h4 data-id="heading-16">场景一：电商风控规则</h4>
<pre><code class="hljs language-markdown" lang="markdown">特点：
<span class="hljs-bullet">  -</span> 高频（万次/秒）
<span class="hljs-bullet">  -</span> 简单（if 判断、比较运算）
<span class="hljs-bullet">  -</span> 稳定性要求高
<span class="hljs-bullet">  -</span> 响应时间敏感

方案：QLExpress

理由：
<span class="hljs-bullet">  -</span> 无 GC 压力
<span class="hljs-bullet">  -</span> 启动快，首次执行无编译耗时
<span class="hljs-bullet">  -</span> 白名单安全
<span class="hljs-bullet">  -</span> 性能稳定可预测
  
风险：
<span class="hljs-bullet">  -</span> 如果规则很复杂（多层嵌套），性能会下降
<span class="hljs-bullet">  -</span> 不支持循环、函数定义
</code></pre>
<h4 data-id="heading-17">场景二：插件框架/用户自定义脚本</h4>
<pre><code class="hljs language-markdown" lang="markdown">特点：
<span class="hljs-bullet">  -</span> 低频（几十次/天）
<span class="hljs-bullet">  -</span> 复杂（完整逻辑、多行代码、需要定义类）
<span class="hljs-bullet">  -</span> 需要强大灵活性
<span class="hljs-bullet">  -</span> 允许一定启动耗时

方案：Groovy（这是 Groovy 的最佳场景）

理由：
<span class="hljs-bullet">  -</span> 支持完整 Java 语法（循环、函数、类、接口）
<span class="hljs-bullet">  -</span> 用户可以写完整的业务逻辑
<span class="hljs-bullet">  -</span> JIT 优化后性能好
<span class="hljs-bullet">  -</span> 类泄漏可控（低频调用，重启可清理）
<span class="hljs-bullet">  -</span> 这种场景下，QLExpress 功能不够用
  
典型案例：
<span class="hljs-bullet">  -</span> Jenkins 插件（Groovy 脚本）
<span class="hljs-bullet">  -</span> Gradle 构建脚本（Groovy DSL）
<span class="hljs-bullet">  -</span> IDE 插件开发
<span class="hljs-bullet">  -</span> SaaS 平台的客户自定义逻辑
  
风险管理：
<span class="hljs-bullet">  -</span> 严格的沙箱和权限控制
<span class="hljs-bullet">  -</span> 监控类加载情况
<span class="hljs-bullet">  -</span> 定期重启清理 Metaspace
<span class="hljs-bullet">  -</span> 做好降级方案
</code></pre>
<h4 data-id="heading-18">场景三：配置中心表达式</h4>
<pre><code class="hljs language-markdown" lang="markdown">特点：
<span class="hljs-bullet">  -</span> 中频（百次/秒）
<span class="hljs-bullet">  -</span> 中等复杂
<span class="hljs-bullet">  -</span> 需要快速部署
<span class="hljs-bullet">  -</span> 希望简单维护

方案：优先 QLExpress，复杂时用 Groovy + 缓存

判断标准：
<span class="hljs-bullet">  -</span> 如果表达式是 a&gt;b &amp;&amp; c<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">d</span> → <span class="hljs-attr">QLExpress</span>
  <span class="hljs-attr">-</span> <span class="hljs-attr">如果有循环</span>、<span class="hljs-attr">函数定义</span> → <span class="hljs-attr">Groovy</span>
  <span class="hljs-attr">-</span> <span class="hljs-attr">如果不确定</span> → <span class="hljs-attr">先用</span> <span class="hljs-attr">QLExpress</span>，<span class="hljs-attr">不够再换</span>
  
<span class="hljs-attr">建议</span>：
  <span class="hljs-attr">-</span> <span class="hljs-attr">限制表达式复杂度</span>
  <span class="hljs-attr">-</span> <span class="hljs-attr">提供表达式模板</span>
  <span class="hljs-attr">-</span> <span class="hljs-attr">做好监控和降级</span>
</span></span></code></pre>
<h4 data-id="heading-19">场景四：AB 测试分流</h4>
<pre><code class="hljs language-markdown" lang="markdown">特点：
<span class="hljs-bullet">  -</span> 高频（每次请求都判断）
<span class="hljs-bullet">  -</span> 极简单（比较、取模）
<span class="hljs-bullet">  -</span> 对性能极度敏感

方案：QLExpress，甚至考虑硬编码

理由：
<span class="hljs-bullet">  -</span> AB 测试规则通常很简单
<span class="hljs-bullet">  -</span> 不需要动态编译的强大能力
<span class="hljs-bullet">  -</span> 追求极致性能和稳定性
  
反例：
<span class="hljs-bullet">  -</span> 用 Groovy 是过度设计
<span class="hljs-bullet">  -</span> 每次请求编译一次？内存爆炸
<span class="hljs-bullet">  -</span> 缓存后性能好？但增加复杂度
</code></pre>
<h3 data-id="heading-20">选型检查清单</h3>
<p><strong>选 QLExpress 的条件</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">□</span> <span class="hljs-string">表达式简单（单层</span> <span class="hljs-string">if</span> <span class="hljs-string">/</span> <span class="hljs-string">比较</span> <span class="hljs-string">/</span> <span class="hljs-string">四则运算）</span>
<span class="hljs-string">□</span> <span class="hljs-string">调用频率高（&gt;</span> <span class="hljs-number">1000</span><span class="hljs-string">次/秒）</span>
<span class="hljs-string">□</span> <span class="hljs-string">内存敏感（Serverless</span> <span class="hljs-string">/</span> <span class="hljs-string">容器</span> <span class="hljs-string">/</span> <span class="hljs-string">IoT）</span>
<span class="hljs-string">□</span> <span class="hljs-string">安全要求高（多租户</span> <span class="hljs-string">/</span> <span class="hljs-string">用户输入）</span>
<span class="hljs-string">□</span> <span class="hljs-string">团队</span> <span class="hljs-string">Java</span> <span class="hljs-string">水平一般</span>
<span class="hljs-string">□</span> <span class="hljs-string">追求稳定性和可预测性</span>
</code></pre>
<p><strong>选 Groovy 的条件</strong>：</p>
<pre><code class="hljs">□ 需要完整编程能力（循环 / 函数 / 类）
□ 追求极致执行性能（已优化后）
□ 低频使用（&lt; 100次/分钟）
□ 有完善的监控和类清理机制
□ 团队有 JVM 调优经验
□ 可接受一定的复杂度
</code></pre>
<p><strong>都不满足？</strong></p>
<pre><code class="hljs language-diff" lang="diff">考虑其他方案：
<span class="hljs-deletion">- Aviator：高性能表达式引擎，比 QLExpress 更快</span>
<span class="hljs-deletion">- MVEL：轻量级脚本引擎</span>
<span class="hljs-deletion">- JavaScript（Nashorn/GraalJS）：如果团队熟悉 JS</span>
<span class="hljs-deletion">- Lua（LuaJ）：嵌入式脚本</span>
<span class="hljs-deletion">- 或者，重新评估需求：是否真的需要动态脚本？</span>
</code></pre>
<hr/>
<h2 data-id="heading-21">五、两种方案的坑，都在这了</h2>
<h3 data-id="heading-22">QLExpress 的坑</h3>
<h4 data-id="heading-23">坑1：性能瓶颈</h4>
<pre><code class="hljs language-markdown" lang="markdown">症状：
  10万次/秒后 CPU 飙升到 80%
  
原因：
  解释执行无 JIT 优化
  每次都要遍历 AST 树
  
方案：
<span class="hljs-bullet">  -</span> 简化规则逻辑
<span class="hljs-bullet">  -</span> 减少嵌套层数
<span class="hljs-bullet">  -</span> 或换成编译执行
</code></pre>
<h4 data-id="heading-24">坑2：功能受限</h4>
<pre><code class="hljs language-markdown" lang="markdown">症状：
  写不了循环
  写不了函数定义
  写不了复杂逻辑
  
原因：
  只支持表达式级别
  不支持完整编程语言特性
  
方案：
<span class="hljs-bullet">  -</span> 简化需求
<span class="hljs-bullet">  -</span> 用多个简单规则组合
<span class="hljs-bullet">  -</span> 或换成 Groovy
</code></pre>
<h4 data-id="heading-25">坑3：调试困难</h4>
<pre><code class="hljs language-markdown" lang="markdown">症状：
  报错堆栈全是 AST 遍历的代码
  找不到具体哪行脚本出错
  
原因：
  没有真实的代码行号
  只有 AST 节点信息
  
方案：
<span class="hljs-bullet">  -</span> 加详细的日志
<span class="hljs-bullet">  -</span> 在规则中加标识
<span class="hljs-bullet">  -</span> 单元测试覆盖
</code></pre>
<h3 data-id="heading-26">Groovy 的坑</h3>
<h4 data-id="heading-27">坑1：类泄漏 OOM（最严重）</h4>
<pre><code class="hljs language-markdown" lang="markdown">症状：
  运行 72 小时后 Metaspace 满
  Full GC 频发
  最终 OutOfMemoryError
  
原因：
  每次执行生成新类：Script<span class="hljs-emphasis">_123, Script_</span>124...
  类未被 GC（ClassLoader 还在引用）
  Metaspace 持续增长
  
监控命令：
  jmap -clstats <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">pid</span>&gt;</span></span> | grep Script_
  
解决方案：
<span class="hljs-bullet">  -</span> 缓存编译结果（相同脚本复用 Class）
<span class="hljs-bullet">  -</span> 定期清理 ClassLoader
<span class="hljs-bullet">  -</span> 限制脚本数量上限
<span class="hljs-bullet">  -</span> 设置 Metaspace 告警
</code></pre>
<h4 data-id="heading-28">坑2：冷启动慢</h4>
<pre><code class="hljs language-markdown" lang="markdown">症状：
  第一次执行需要 200ms
  用户感知明显延迟
  
原因：
  编译耗时（JavaCompiler）
  
方案：
<span class="hljs-bullet">  -</span> 预编译常用脚本
<span class="hljs-bullet">  -</span> 异步编译（后台编译，先用旧版本）
<span class="hljs-bullet">  -</span> 缓存编译结果
</code></pre>
<h4 data-id="heading-29">坑3：安全风险</h4>
<pre><code class="hljs language-markdown" lang="markdown">症状：
  用户执行 System.exit(0) 导致服务挂掉
  用户读取 /etc/passwd
  用户执行 rm -rf
  
原因：
  脚本就是 Java 代码
  可以调用任意 Java API
  
方案（都不完美）：
<span class="hljs-bullet">  -</span> SecurityManager（JDK 17 已废弃）
<span class="hljs-bullet">  -</span> 代码审查（正则匹配危险代码）
<span class="hljs-bullet">  -</span> 沙箱隔离（独立进程）
<span class="hljs-bullet">  -</span> 白名单（只允许特定 API）
</code></pre>
<h4 data-id="heading-30">坑4：调试噩梦</h4>
<pre><code class="hljs language-markdown" lang="markdown">症状：
  报错堆栈：at Script<span class="hljs-emphasis">_1234567890.execute(Unknown Source)
  Script_</span>1234567890 在哪？找不到源码
  
原因：
  动态生成的类
  源码可能已经不在内存里
  
方案：
<span class="hljs-bullet">  -</span> 保存脚本和生成类的映射
<span class="hljs-bullet">  -</span> 保存编译后的源码
<span class="hljs-bullet">  -</span> 加详细日志
</code></pre>
<hr/>
<h2 data-id="heading-31">六、我们的两年噩梦：完整复盘</h2>
<p><strong>这不是假设，是我亲身经历的真实故事。</strong></p>
<h3 data-id="heading-32">背景</h3>
<p>2011年，我作为高级工程师入职了一家大数据公司，该公司以互联网爬虫构建业务。其中一块核心系统是分布式爬虫系统，从全网上百家房地产公司抓取房源、资讯等数据。那时候 Hadoop 还没流行。</p>
<p>公司技术总监构建了一套引以为傲的架构：底层是很先进的算法能力，包括指纹算法做去重、正文提取算法从 HTML 中提取核心内容、NLP 摘要生成等。上层则是 Groovy 动态代码库，美名其曰"短平快，利用底层地基快速构建"。这比某东的"多快好省"提出得还早，这很有趣。</p>
<p>听起来很美好，框架本身也很强大。</p>
<h3 data-id="heading-33">从兴奋到噩梦</h3>
<p>刚入职时，看到这套架构，我很兴奋。动态加载代码？太酷了！不用重启就能上线新功能？完美！底层能力这么强大？可以做很多事！我觉得自己可以大显身手。</p>
<p>却不知道，后面都成了我们的恶梦。</p>
<p>问题开始出现：玄学问题频发，不知道是 Groovy 的问题还是框架的问题。有时候莫名其妙就挂了，有时候性能突然下降，有时候内存莫名飙升。我们只能经常加班加点调试，碰到实在搞不定的，就写新的补丁程序。补丁程序越来越多，系统越来越不可控。</p>
<p><strong>这样持续了多久？两年。</strong></p>
<p>两年时间里，我们团队大部分精力都在和这套框架斗争。</p>
<h3 data-id="heading-34">推翻重写</h3>
<p>终于，忍无可忍。我找机会用 Hadoop 推翻了这套系统，重写了一遍。重写后的系统没有玄学问题，没有莫名其妙的崩溃，性能稳定可预测，维护成本大幅下降。</p>
<h3 data-id="heading-35">复盘：为什么会失败？</h3>
<p><strong>第一，过度设计。</strong> 爬虫系统真的需要动态加载代码吗？其实不需要。爬虫系统需要的是稳定性（7x24 运行）、可追溯性（日志、监控）、可扩展性（新增网站）。这些都可以通过配置文件和插件化实现，根本不需要动态编译。</p>
<p><strong>第二，技术选型错配。</strong> Groovy 本身是优秀的技术，非常适合插件框架、用户脚本、低频扩展等场景（Jenkins、Gradle 都在用）。但爬虫系统是什么场景？高频调用（每秒抓取上百页面）、核心链路（不能挂）、要求极高稳定性。<strong>这不是 Groovy 不好，是把好技术用错了地方。</strong></p>
<p><strong>第三，缺乏约束。</strong> 动态能力给了太多自由：任何人都可以写动态代码，没有代码审查，没有测试要求，没有规范约束。自由多了就是混乱，混乱多了就是灾难。</p>
<p><strong>第四，监控缺失。</strong> 没有监控类加载情况、内存占用趋势、性能指标、错误率。出问题只能瞎猜：是 Groovy 的问题？是框架的问题？是业务代码的问题？不知道，只能一个个试。</p>
<h3 data-id="heading-36">正确的做法应该是什么？</h3>
<p>爬虫系统的合理架构应该是：配置驱动，每个网站一个配置文件，定义 URL 规则、解析规则、存储规则。然后是插件化，不同类型网站用不同插件，但插件是编译好的 jar 包，不是动态加载。再加上灰度发布，新功能先在小流量验证，稳定后再全量，根本不需要热加载。最后是完善监控，每个环节都有指标，异常立刻告警，可快速定位问题。</p>
<p>如果真的需要动态能力，也应该只在非核心环节使用，比如数据清洗规则可以用 QLExpress，字段映射逻辑可以用简单脚本，但绝对不要用在核心链路。而且必须有严格限制：白名单机制、超时控制、资源限制、完善的降级方案。还要有监控告警：类加载数量、内存占用、执行耗时、错误率。</p>
<h3 data-id="heading-37">教训总结</h3>
<p>技术选型要匹配业务场景，不是越先进越好，不是越灵活越好。核心系统要稳定压倒一切，不要玩花的，不要追求炫技。动态能力是双刃剑，给你灵活性的同时，也给你复杂性和风险。对线上要有敬畏之心，任何新技术都要充分验证，任何改动都要有降级方案。</p>
<p>这段经历，让我深刻理解了：<strong>大多数时候，你真的只需要叫外卖，不需要建厨房。</strong></p>
<hr/>
<h2 data-id="heading-38">七、有没有两全其美的方案？</h2>
<h3 data-id="heading-39">核心思路</h3>
<pre><code class="hljs language-markdown" lang="markdown">问题：
  能不能自动选择执行方式？
  简单规则 → 解释执行（QLExpress）
  复杂规则 → 编译执行（Groovy）

好处：
<span class="hljs-bullet">  -</span> 简单的快速启动
<span class="hljs-bullet">  -</span> 复杂的性能优化
<span class="hljs-bullet">  -</span> 自动路由，用户无感知
</code></pre>
<h3 data-id="heading-40">实现思路</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HybridScriptEngine</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">QLExpressEngine</span> <span class="hljs-variable">qlEngine</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">QLExpressEngine</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-type">GroovyEngine</span> <span class="hljs-variable">groovyEngine</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GroovyEngine</span>();
    
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">execute</span><span class="hljs-params">(String script, Context context)</span> {
        <span class="hljs-comment">// 分析脚本复杂度</span>
        <span class="hljs-type">ScriptComplexity</span> <span class="hljs-variable">complexity</span> <span class="hljs-operator">=</span> analyzeComplexity(script);
        
        <span class="hljs-keyword">if</span> (complexity.isSimple()) {
            <span class="hljs-comment">// 简单规则：解释执行</span>
            <span class="hljs-keyword">return</span> qlEngine.execute(script, context);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 复杂规则：编译执行</span>
            <span class="hljs-keyword">return</span> groovyEngine.execute(script, context);
        }
    }
    
    <span class="hljs-keyword">private</span> ScriptComplexity <span class="hljs-title function_">analyzeComplexity</span><span class="hljs-params">(String script)</span> {
        <span class="hljs-type">ScriptComplexity</span> <span class="hljs-variable">complexity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScriptComplexity</span>();
        
        <span class="hljs-comment">// 检查是否有循环</span>
        <span class="hljs-keyword">if</span> (script.contains(<span class="hljs-string">"for"</span>) || script.contains(<span class="hljs-string">"while"</span>)) {
            complexity.setComplex();
        }
        
        <span class="hljs-comment">// 检查是否有函数定义</span>
        <span class="hljs-keyword">if</span> (script.contains(<span class="hljs-string">"def "</span>) || script.contains(<span class="hljs-string">"function"</span>)) {
            complexity.setComplex();
        }
        
        <span class="hljs-comment">// 检查嵌套层数</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">nestingLevel</span> <span class="hljs-operator">=</span> countNestingLevel(script);
        <span class="hljs-keyword">if</span> (nestingLevel &gt; <span class="hljs-number">3</span>) {
            complexity.setComplex();
        }
        
        <span class="hljs-keyword">return</span> complexity;
    }
}
</code></pre>
<h3 data-id="heading-41">动态切换策略</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdaptiveScriptEngine</span> {
    
    <span class="hljs-keyword">private</span> Map&lt;String, ExecutionStats&gt; statsMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">execute</span><span class="hljs-params">(String scriptId, String script, Context context)</span> {
        <span class="hljs-type">ExecutionStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> statsMap.get(scriptId);
        
        <span class="hljs-keyword">if</span> (stats == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 首次执行：先用解释执行</span>
            <span class="hljs-keyword">return</span> executeWithQL(scriptId, script, context);
        }
        
        <span class="hljs-comment">// 根据调用频率决定</span>
        <span class="hljs-keyword">if</span> (stats.getCallFrequency() &gt; <span class="hljs-number">1000</span>) {
            <span class="hljs-comment">// 高频调用：继续用解释执行（稳定）</span>
            <span class="hljs-keyword">return</span> executeWithQL(scriptId, script, context);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (stats.getAvgExecutionTime() &gt; <span class="hljs-number">10</span>) {
            <span class="hljs-comment">// 低频但耗时：切换到编译执行</span>
            <span class="hljs-keyword">return</span> executeWithGroovy(scriptId, script, context);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 低频且快速：继续用解释执行（简单）</span>
            <span class="hljs-keyword">return</span> executeWithQL(scriptId, script, context);
        }
    }
}
</code></pre>
<h3 data-id="heading-42">注意事项</h3>
<pre><code class="hljs language-markdown" lang="markdown">这种融合方案的问题：

<span class="hljs-bullet">1.</span> 增加了复杂度
   需要维护两套引擎
   需要分析脚本复杂度
   需要收集执行统计
   
<span class="hljs-bullet">2.</span> 可能误判
   简单的被判断成复杂
   复杂的被判断成简单
   
<span class="hljs-bullet">3.</span> 切换成本
   从 QL 切到 Groovy 需要编译
   可能影响性能
   
建议：
  不要过度设计
  先选一个主方案
  只在明确需要时才引入另一个
  大多数场景，单一方案就够了
</code></pre>
<hr/>
<h2 data-id="heading-43">八、给你的建议：别走我们的弯路</h2>
<h3 data-id="heading-44">如果选 QLExpress（解释执行）</h3>
<p><strong>核心理念</strong>：稳定 &gt; 性能，安全 &gt; 灵活，可控 &gt; 强大。</p>
<p>这种方案适合追求稳定性、规避复杂度的团队，尤其是团队 JVM 经验一般的情况。最适合的场景是核心链路、高频调用、简单规则。</p>
<p><strong>我的建议</strong>：如果你的需求只是简单的 if 判断、比较运算，别想太多，就用 QLExpress。它不是最快的，但最稳。</p>
<h3 data-id="heading-45">如果选 Groovy（编译执行）</h3>
<p><strong>核心理念</strong>：灵活 &gt; 约束，能力 &gt; 简单，扩展 &gt; 固定。</p>
<p>这种方案适合有 JVM 调优经验、有完善监控、能管理复杂度的团队。<strong>最适合的场景是插件框架、用户脚本、低频扩展。</strong></p>
<p><strong>我的建议</strong>：</p>
<ul>
<li>如果你在做<strong>插件框架</strong>（Jenkins、IDE 插件、SaaS 平台客户脚本），Groovy 是最佳选择</li>
<li>如果你需要<strong>完整的编程能力</strong>（循环、函数、类、接口），Groovy 比 QLExpress 强太多</li>
<li>如果是<strong>低频场景</strong>（配置中心、管理后台、数据处理脚本），Groovy 的编译耗时可以接受</li>
</ul>
<p><strong>但记住</strong>：一定要有监控（类加载数量）、有缓存（避免重复编译）、有降级方案（脚本执行失败怎么办）。</p>
<h3 data-id="heading-46">工程的本质</h3>
<p>不是选最好的，是选最合适的。不是非黑即白，是权衡取舍。不是追求极致，是满足需求。不是一劳永逸，是持续优化。</p>
<h3 data-id="heading-47">记住这四句话</h3>
<p><strong>1. 大多数时候，你只需要叫外卖，不需要建厨房</strong></p>
<p>不要被技术的强大能力迷惑。大多数需求，简单方案就能解决。过度设计是万恶之源。</p>
<p><strong>2. 解释执行不是慢，是稳；编译执行不是快，是有代价</strong></p>
<p>QLExpress 启动快、稳定、可预测，但性能有上限。Groovy 性能天花板高，但要付出复杂度和风险的代价。</p>
<p><strong>3. 技术选型错配，比技术本身的问题更可怕</strong></p>
<p>用 Groovy 做高频风控？内存爆炸。用 QLExpress 做复杂插件？功能受限。</p>
<p>但反过来：用 Groovy 做插件框架？完美。用 QLExpress 做规则引擎？稳定。</p>
<p>选对场景，比选对技术更重要。</p>
<p><strong>4. 对线上要有敬畏之心</strong></p>
<p>动态能力很诱人，但稳定性更重要。在核心链路上：宁可慢一点，也要稳；宁可功能弱一点，也要可控；宁可麻烦一点，也要可追溯。</p>
<hr/>
<h2 data-id="heading-48">写在最后</h2>
<p>两年的代价，换来一个教训：<strong>不分场景对比技术，就是耍流氓。</strong></p>
<p>Groovy 很好，QLExpress 也很好。但在高频核心链路用 Groovy？灾难。在复杂插件场景用 QLExpress？受限。</p>
<p>选对场景，比选对技术更重要。</p>
<hr/>
<p><strong>如果这篇文章能帮你避开我们踩过的坑，这两年的代价就值了。</strong></p>
<p>前两篇技术拆解：</p>
<ul>
<li>第一篇：<a href="https://juejin.cn/post/7582814236584329254" target="_blank" title="https://juejin.cn/post/7582814236584329254">QLExpress 如何做到不编译就能执行？</a></li>
<li>第二篇：<a href="https://juejin.cn/post/7582923861768601650" target="_blank" title="https://juejin.cn/post/7582923861768601650">自定义 ClassLoader 动态加载：不重启就能加载新代码？</a></li>
</ul>
<p><strong>记住：架构的艺术，不在于用了多少高级技术，而在于在合适的场景用了合适的方案。</strong></p>
<p>选对了，就是神器；选错了，就是灾难。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何让git识别不到你的文件]]></title>    <link>https://juejin.cn/post/7582955784570011699</link>    <guid>https://juejin.cn/post/7582955784570011699</guid>    <pubDate>2025-12-14T01:37:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582955784570011699" data-draft-id="7583158173977853962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何让git识别不到你的文件"/> <meta itemprop="keywords" content="Git,GitHub"/> <meta itemprop="datePublished" content="2025-12-14T01:37:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="城堡修炼者"/> <meta itemprop="url" content="https://juejin.cn/user/2379804202775341"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何让git识别不到你的文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2379804202775341/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    城堡修炼者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T01:37:30.000Z" title="Sun Dec 14 2025 01:37:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">如何让git识别不到你的文件</h2>
<p>我们经常有不想让git识别的文件，例如build目录下的。这时候就需要把这些目录，文件加入到.gitignore文件里</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1635a510aaa74f439c7a22261e8aa40c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Z-O5aCh5L-u54K86ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766281049&amp;x-signature=ZyRaBvO%2FW2O7krTHZA24h19s0As%3D" alt="image.png" loading="lazy"/></p>
<p>一般根据需要加：</p>
<ul>
<li>根目录 .gitignore：负责忽略整个项目层级的构建文件（如 .gradle, /build 等）。</li>
</ul>

<ul>
<li>Module 目录 (app/.gitignore)：负责忽略该模块特有的构建产物（主要是 /build）</li>
</ul>
<p>然后由于你之前可能已经有一些 build 文件被 git 追踪了，建议你在终端执行以下命令来清除缓存：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">rm</span> -r --cached .
​
git add .
​
git commit -m <span class="hljs-string">"Fix .gitignore"</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小白必看！大模型入门指南]]></title>    <link>https://juejin.cn/post/7582919147640389684</link>    <guid>https://juejin.cn/post/7582919147640389684</guid>    <pubDate>2025-12-14T01:50:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582919147640389684" data-draft-id="7582510826814799923" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小白必看！大模型入门指南"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-14T01:50:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小白必看！大模型入门指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T01:50:43.000Z" title="Sun Dec 14 2025 01:50:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p><strong>01</strong> <strong>什么是大模型？</strong></p>
<p>大模型，英文名为 Large Model，即大型模型，早期也被称为 Foundation Model（基础模型）。它是一个简称，完整表述是“人工智能预训练大模型”，其中“预训练”是一项关键技术，后续再做详细阐释。</p>
<p>日常交流中提及的大模型，通常特指语言大模型（Large Language Model，简称 LLM，也叫大语言模型），这是目前应用最为广泛的一类。除此之外，还有视觉大模型、多模态大模型等。将所有类别的大模型统称为广义大模型，而语言大模型则被称为狭义大模型。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdba6bb7421c4685997e799d2d67e4af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766281843&amp;x-signature=d2pLwai1Qzp6PbZ4mUeT8N5eTrI%3D" alt="" loading="lazy"/></p>
<p>从本质上看，大模型是包含超大规模参数（通常达十亿个以上）的神经网络模型。在之前科普人工智能时介绍过，神经网络是人工智能领域目前最基础的计算模型。它通过模拟大脑中神经元的连接方式，从输入数据中学习并生成有用的输出。全连接神经网络是其中一种，其每层神经元与下一层的所有神经元都有连接，包含 1 个输入层、N 个隐藏层和 1 个输出层。而广为人知的卷积神经网络（CNN）、循环神经网络（RNN）、长短时记忆网络（LSTM）以及 transformer 架构，都属于神经网络模型。目前，业界大部分大模型都采用了 transformer 架构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c01f8e50add4fa7b63edda73b463cf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766281843&amp;x-signature=Y4HU9aD%2BEJZNXCDR6DWtypTYm4g%3D" alt="" loading="lazy"/></p>
<p>大模型的“大”，不仅体现在参数规模上。首先，架构规模大。以 OpenAI 公司的 GPT - 4 为例，其隐藏层多达 120 层，每层神经元数量达到 14336 个，整个架构规模庞大，神经元节点数量众多。大模型的参数数量与神经元节点数密切相关，一般来说，神经元节点数越多，参数也就越多，GPT - 4 的参数数量大约为 1.76 万亿。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83c11eaf2d234a1cbabeb119bf3f878f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766281843&amp;x-signature=CkdE55GN0fdd5iVQ0QOtZxJX%2F4U%3D" alt="" loading="lazy"/></p>
<p>其次，训练数据规模大。还是以 GPT - 4 为例，其训练数据总量高达 13 万亿 tokens，数据规模相当于 4500 万本英文书籍（按单本书 1MB 计算），堪称海量。如此庞大的训练数据，为大模型的学习和泛化能力提供了坚实的基础。</p>
<p>最后，算力需求大。训练大模型需要大量的 GPU 算卡资源，且每次训练耗时极长。公开数据显示，GPT - 4 使用 1 万至 2 万张 A100 GPU 集群进行训练，训练周期约 90 - 100 天，总能耗成本约 6300 万美元。由此可见，训练大模型不仅需要强大的硬件支持，还需要耗费巨大的资金和能源。</p>
<p>综上所述，大模型堪称一个虚拟的庞然大物，具有架构复杂、参数庞大、依赖海量数据以及高算力需求等特点，其研发和训练成本极高。</p>
<p>与之相对的是小模型。小模型参数较少（百万级以下）、层数较浅，具有轻量级、高效率、易于部署等优点。它适用于数据量较小、计算资源有限的垂直领域场景，能够快速响应需求。</p>
<h2 data-id="heading-0">大模型是如何训练出来的？</h2>
<p>接下来，让我们一同了解大模型的训练过程。大模型具备强大的学习能力，它能从海量数据中汲取“知识”，并运用这些知识完成回答问题、内容创作等任务。其中，汲取知识的过程叫训练，运用知识的过程叫推理。而训练又包含两个关键环节，即预训练（Pre-trained）和微调（Fine tuning）。</p>
<p><strong>● 预训练</strong></p>
<p>预训练大模型时，需先选定框架，如常用的 transformer。接着，向模型“投喂”海量数据，助其习得通用特征表示。那大模型为何学习能力如此强大，且参数越多学习力越强呢？这可通过麻省理工公开课里的一张图（下图）来理解，这张图是深度学习模型中单个神经元的结构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/609aed4e14af47318e36543c1bd7a1d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766281843&amp;x-signature=waRXISSGYbRc8Ka1MIjDaCh7FE0%3D" alt="" loading="lazy"/></p>
<p>神经元的处理本质上是函数计算，在相关算式里，x 代表输入，y 代表输出，而预训练的关键在于通过给定的 x 和 y 来求解算式中的“权重（weights）”W。权重在模型中起着决定性作用，它掌控着输入特征对模型输出的影响程度。模型通过反复训练来不断调整和确定权重，这便是训练的核心意义所在。</p>
<p>权重是模型参数的主要类别之一，除此之外，偏置（biases）也至关重要。权重决定了输入信号对神经元的影响力度，偏置则可看作神经元的“容忍度”，体现着神经元对输入信号的敏感程度。简单来讲，预训练过程就是依据数据的输入和输出，反复“推算”出最为合理的权重和偏置，也就是模型的参数。训练完成后，这些参数会被妥善保存，以备模型后续使用或部署。</p>
<p>通常情况下，参数数量越多，模型就越有能力学习到更为复杂的模式和特征，进而在各类任务中展现出更卓越的性能。我们常说大模型具备两种显著的特征能力，即涌现能力和泛化能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ab3f16be06a44578b52b69cf39db834~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766281843&amp;x-signature=K8lD9uWRxMTFNQ737JVt%2BceadNE%3D" alt="" loading="lazy"/></p>
<p>当模型的训练数据和参数规模不断扩大，直至达到特定的临界规模后，便会展现出一些事先难以预测的、更为复杂的能力和特性。此时，模型能够从原始训练数据中自动学习并挖掘出新的、更高层次的特征和模式，这种能力被称作“涌现能力”。拥有涌现能力的大模型，仿佛脑子突然“开窍”，不再局限于复述知识，而是能够深入理解知识，并具备发散思维的能力。</p>
<p>泛化能力则是指大模型通过“投喂”海量数据，学习到复杂的模式和特征后，能够对从未见过的数据做出准确预测。打个比方，就像董宇辉读书众多，即便有些书未曾读过，他也能凭借深厚的积累和灵活的思维，侃侃而谈。</p>
<p>然而，参数规模的不断增大，在提升大模型能力的同时，也会带来一系列问题。一方面，会导致资源消耗大幅增加；另一方面，还可能提高“过拟合”的风险。过拟合是指模型对训练数据的学习过于精细，以至于捕捉到了训练数据中的噪声和细微的无关信息，而未能把握数据的总体趋势和规律。这就好比大模型变成了“书呆子”，只知道死记硬背，却无法融会贯通、灵活运用。</p>
<p>接下来，我们再谈谈预训练所使用的数据。预训练采用的是海量的未标注数据，规模可达几十 TB。之所以选择未标注数据，是因为互联网上此类数据极为丰富，获取相对容易。而标注数据基本依赖人工标注，需要耗费大量的时间和金钱，成本高昂。</p>
<p>预训练模型能够借助无监督学习方法，如自编码器、生成对抗网络、掩码语言建模、对比学习等（这些方法大家可另行深入了解），从未标注数据中学习到数据的通用特征和表示。不过，这些数据并非随意从网上下载而来，而是需要经过严格的收集、清洗、脱敏和分类等处理流程。通过这些处理，可以去除异常数据和错误数据，删除隐私信息，使数据更加标准化，从而为后续的训练过程奠定良好基础。</p>
<p>至于获取数据的方式，则多种多样。对于个人和学术研究而言，可以通过官方论坛、开源数据库或者研究机构等渠道获取数据；对于企业来说，既可以自行收集和处理数据，也可以直接从外部渠道购买，市场上有专门的数据提供商可满足企业的数据需求。</p>
<p><strong>● 微调</strong></p>
<p>经过预训练学习，我们获得了一个通用大模型。不过，这种模型通常不能直接投入使用，在处理特定任务时，其表现往往不尽如人意。</p>
<p>此时，就需要对模型进行微调。微调是给大模型提供特定领域的标注数据集，对预训练的模型参数进行细微调整，使模型能更好地完成特定任务。经过微调的大模型可称为行业大模型，比如基于金融证券数据集微调，就能得到金融证券大模型。若再基于更细分的专业领域微调，便是专业大模型，也叫垂直大模型。我们不妨把通用大模型想象成中小学生，行业大模型如同大学本科生，专业大模型则似研究生。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52c7944f1d204ed39229be9bdf8ccc56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766281843&amp;x-signature=j6iHR88bIoBsjc9kREuT%2FUkUlpA%3D" alt="" loading="lazy"/></p>
<p>在微调阶段，由于所需数据量远小于预训练阶段，对算力的需求也就大幅降低。值得注意的是，对于多数大模型厂商而言，一般只专注于预训练，而不进行微调；而行业客户通常只做微调，不开展预训练。这种“预训练 + 微调”的分阶段训练方式，能有效避免重复投入，节省大量计算资源，显著提升大模型的训练效率和效果。</p>
<p>预训练和微调都完成后，还需对大模型进行评估。通过采用实际数据或模拟场景进行评估验证，确认大模型的性能、稳定性和准确性等是否达到设计要求。</p>
<p>当评估和验证顺利通过，大模型基本就打造完成了。接下来，便可以部署这个大模型，让它投身于推理任务。此时的大模型已然“定型”，参数不再改变，真正具备了“干活”的能力。</p>
<p>大模型的推理过程，就是我们使用它的过程。我们可以通过提问、提供提示词（Prompt）等方式，让大模型回答我们的问题，或者按照要求生成相应的内容。</p>
<p>再来一张完整的流程图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27732277d0a542e48dae095d593c957a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766281843&amp;x-signature=7iyyfzK24TluHctf7hmWET5e%2FHk%3D" alt="" loading="lazy"/></p>
<p><strong>02</strong> <strong>大模型究竟有什么作用？</strong></p>
<p>依据训练的数据类型和应用方向，大模型通常可划分为语言大模型、音频大模型、视觉大模型以及多模态大模型。</p>
<p>语言大模型以文本数据为训练基础，在自然语言处理（NLP）领域表现出色。它具备理解、生成和处理人类语言的能力，广泛应用于诸多场景。在文本内容创作方面，能生成文章、诗歌、代码等；在文献分析中，可深入剖析资料；还能进行摘要汇总，提炼关键信息；在机器翻译领域，也能实现不同语言间的准确转换。大家熟知的 ChatGPT 就属于语言大模型。</p>
<p>音频大模型以音频数据训练，可识别和生产语音内容。在语音助手、语音客服场景中，它能与用户流畅交流；在智能家居语音控制方面，让用户通过语音指令轻松操控设备。</p>
<p>视觉大模型以图像数据训练，擅长计算机视觉（CV）领域。它能够识别图像中的物体、场景等信息，还能生成逼真的图像，甚至对受损图像进行修复。在安防监控中，可实时监测异常情况；自动驾驶领域，助力车辆识别路况；医学和天文图像分析方面，也能发挥重要作用。</p>
<p>多模态大模型融合了 NLP 和 CV 的能力，能整合并处理文本、图像、音频和视频等不同模态的信息，处理跨领域任务，如文生图、文生视频、跨媒体搜索等。今年以来，多模态大模型发展迅猛，成为行业焦点。</p>
<p>若按应用场景分类，大模型类别更为丰富，涵盖金融、医疗、法律、教育、代码、能源、政务、通信等众多领域。以金融大模型为例，它可用于风险管理、信用评估、交易监控、市场预测、合同审查以及客户服务等，在金融行业发挥着多方面的作用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf33c39580f040dd869912673dfc4b52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766281843&amp;x-signature=ej084LPuC3xMBFf3TuQ9qI8CEvI%3D" alt="" loading="lazy"/></p>
<p><strong>03</strong> <strong>大模型的发展趋势？</strong></p>
<p>当下，中国10亿参数规模以上的大模型数量已突破100个，呈现“百模大战”的热闹景象。这些大模型在应用领域和参数规模上各有千秋，但无一例外，背后都需要巨额资金投入。</p>
<p>据行业估测，训练一个大模型，成本可能从几百万美元到上亿美元不等。如此高昂的成本下，众多企业纷纷推出大模型，其中不乏资源浪费之嫌。而且，大模型有开源和闭源之分。有能力打造闭源大模型的企业在行业内并不多见，大部分大模型其实是基于开源框架和技术构建的，这在一定程度上是为了迎合资本市场，或是跟风蹭热度。</p>
<p>即便如此，行业内仍有部分头部企业执着于追求参数规模更大的超大模型，这类模型参数可达数万亿甚至数千万亿个。比如OpenAI、xAI等企业，马斯克就曾在X平台宣布，xAI团队成功启动了全球最强大的AI训练集群，该集群由10万块H100组成，主要用于Grok 2和Grok 3的训练与开发。不过，对于大多数企业而言，拥有万卡规模和万亿参数的大模型已接近发展天花板，继续加大投入的意愿不强，资金实力也不允许。</p>
<p>随着行业逐渐回归理性，企业的关注焦点正从“打造大模型”转向“使用大模型”。如何将大模型应用于实际场景、吸引更多用户、创造商业价值，成为各大厂商的核心任务。</p>
<p>大模型要落地应用，就需实现能力“入”端，即下沉到终端设备。因此，AI手机、AI PC、具身智能等概念愈发火热，成为新的发展热点。以AI手机为例，高通、联发科等芯片厂商纷纷推出具备更强AI算力的手机芯片；OPPO、vivo等手机厂商也在手机中内置大模型，并推出众多原生AI应用。第三方AI应用更是如雨后春笋般涌现，截至目前，行业数据显示具有AI功能的APP数量已超300万款。2024年6月，AIGC类APP的月活跃用户规模达6170万，同比增长653%。</p>
<p>大模型入端还催生了轻量化趋势。由于终端设备资源有限，大模型需通过剪枝、量化、蒸馏等技术进行优化，在保持性能的同时降低对计算资源的需求，从而更好地适配终端设备，为用户带来更流畅、便捷的AI体验。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/403d61b447ff41adaf20e2d4eac87b76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766281843&amp;x-signature=sX6WEkEnkZMRxFrVjKgpfPpSq7s%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>04</strong> <strong>大模型会带来哪些挑战？</strong></h2>
<p>大模型无疑是科技领域的一项重大突破，它能帮我们处理诸多事务，节省时间、提升效率，在生活与工作中发挥着积极作用。然而，大模型也是一把双刃剑，在带来便利的同时，也引发了一系列新挑战。</p>
<p>其一，冲击就业市场。AI浪潮下，大模型凭借强大的能力，会取代部分人类工作岗位，导致失业率上升。一些重复性、规律性强的工作，很可能首当其冲，让不少从业者面临失业风险。</p>
<p>其二，引发版权纠纷。大模型依赖已有数据进行学习，在文本、图像、音乐和视频创作等领域，其生成内容的版权和知识产权归属难以界定。它虽助力创作，但“引用”人类创作者作品的行为界限模糊，长此以往，可能挫伤人类原生创作的积极性。</p>
<p>其三，造成算法偏见与不公平。训练数据中的偏差会被大模型学习吸收，进而在预测和生成内容时表现出不公平。比如，可能无意中强化性别、种族和宗教等方面的刻板印象和偏见，甚至被别有用心者用于政治宣传和操纵，影响选举和公共舆论走向。</p>
<p>其四，存在被用于犯罪的风险。大模型能生成逼真的各类内容，这为诈骗、诽谤、虚假信息传播等恶意行为提供了便利，给社会安全带来严重威胁。</p>
<p>其五，带来能耗难题。大模型的训练和推理需要海量计算资源，这不仅增加了企业成本，还产生了巨大的碳排放。部分企业为迎合市场或盲目跟风，无节制地进行大模型训练，造成资源浪费和不必要的碳排放。</p>
<p>总之，大模型在伦理、法律、社会和经济层面带来的威胁和挑战不容小觑，我们需要投入更多时间和精力去探索应对之策，以实现科技与社会的和谐发展。</p>
<h3 data-id="heading-2">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Netty（9）如何实现基于Netty的UDP客户端和服务器？]]></title>    <link>https://juejin.cn/post/7582896213856288783</link>    <guid>https://juejin.cn/post/7582896213856288783</guid>    <pubDate>2025-12-14T00:12:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582896213856288783" data-draft-id="7582939860874035235" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Netty（9）如何实现基于Netty的UDP客户端和服务器？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-14T00:12:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Netty（9）如何实现基于Netty的UDP客户端和服务器？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T00:12:34.000Z" title="Sun Dec 14 2025 00:12:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>要实现基于Netty的UDP客户端和服务器，您需要编写以下代码来设置和配置客户端和服务器：</p>
<ol>
<li>创建服务器：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.Bootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelFuture;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelOption;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioDatagramChannel;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UdpServer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> port;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UdpServer</span><span class="hljs-params">(<span class="hljs-type">int</span> port)</span> {
        <span class="hljs-built_in">this</span>.port = port;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Bootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>();
            b.group(group)
                    .channel(NioDatagramChannel.class)
                    .option(ChannelOption.SO_BROADCAST, <span class="hljs-literal">true</span>)
                    .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;NioDatagramChannel&gt;() {
                        <span class="hljs-meta">@Override</span>
                        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(NioDatagramChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                            ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerHandler</span>());
                        }
                    });

            <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> b.bind(port).sync();
            f.channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            group.shutdownGracefully();
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">8080</span>;
        <span class="hljs-type">UdpServer</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UdpServer</span>(port);
        server.run();
    }
}
</code></pre>
<p>在上面的示例中，我们创建了一个UdpServer类，它负责启动服务器。在run()方法中，我们使用NioEventLoopGroup创建了一个EventLoopGroup，用于处理服务器的I/O操作。</p>
<p>然后，我们使用Bootstrap来配置服务器。我们指定了服务器的通道类型为NioDatagramChannel，并设置了SO_BROADCAST选项为true，以支持广播。</p>
<p>最后，我们绑定服务器的端口并启动服务器。</p>
<ol start="2">
<li>创建客户端：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.Bootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelFuture;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelOption;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioDatagramChannel;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UdpClient</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String host;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> port;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UdpClient</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port)</span> {
        <span class="hljs-built_in">this</span>.host = host;
        <span class="hljs-built_in">this</span>.port = port;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Bootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>();
            b.group(group)
                    .channel(NioDatagramChannel.class)
                    .option(ChannelOption.SO_BROADCAST, <span class="hljs-literal">true</span>)
                    .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;NioDatagramChannel&gt;() {
                        <span class="hljs-meta">@Override</span>
                        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(NioDatagramChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                            ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientHandler</span>());
                        }
                    });

            <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> b.connect(host, port).sync();
            f.channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            group.shutdownGracefully();
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-string">"localhost"</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">8080</span>;
        <span class="hljs-type">UdpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UdpClient</span>(host, port);
        client.run();
    }
}
</code></pre>
<p>在上面的示例中，我们创建了一个UdpClient类，它负责启动客户端。在run()方法中，我们使用NioEventLoopGroup创建了一个EventLoopGroup，用于处理客户端的I/O操作。</p>
<p>然后，我们使用Bootstrap来配置客户端。我们指定了客户端的通道类型为NioDatagramChannel，并设置了SO_BROADCAST选项为true，以支持广播。</p>
<p>最后，我们连接服务器的主机和端口，并启动客户端。</p>
<p>需要注意的是，上述代码中的ServerHandler和ClientHandler是自定义的处理器，您可以根据自己的需求实现相应的处理逻辑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Netty（10）Netty的粘包和拆包问题是什么？如何解决它们？]]></title>    <link>https://juejin.cn/post/7582863493260918836</link>    <guid>https://juejin.cn/post/7582863493260918836</guid>    <pubDate>2025-12-14T00:13:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582863493260918836" data-draft-id="7582896213856305167" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Netty（10）Netty的粘包和拆包问题是什么？如何解决它们？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-14T00:13:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Netty（10）Netty的粘包和拆包问题是什么？如何解决它们？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T00:13:13.000Z" title="Sun Dec 14 2025 00:13:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Netty中的粘包和拆包问题是由于TCP协议的特性导致的。TCP是一个面向流的协议，它会将应用程序发送的数据流切分成多个TCP包进行传输。在接收端，TCP协议会将收到的数据包重新组装成完整的数据流。然而，由于网络传输的不确定性，TCP包的边界可能会被破坏，导致接收端无法正确地识别出完整的消息边界，从而产生粘包和拆包问题。</p>
<p>粘包问题：当发送端连续发送多个小的消息时，TCP协议可能会将这些消息合并成一个较大的TCP包进行传输，导致接收端一次性接收到多个消息，无法准确分割出每个消息的边界。</p>
<p>拆包问题：当发送端连续发送两个大的消息时，TCP协议可能会将这两个消息拆分成多个TCP包进行传输，导致接收端无法完整地接收到一个完整的消息。</p>
<p>为了解决粘包和拆包问题，可以使用以下几种常见的方法：</p>
<ol>
<li>
<p>消息长度字段：在消息的前面添加一个固定长度的字段，用于表示消息的长度。接收端根据该长度字段来切分消息，确保每个消息的边界正确。</p>
</li>
<li>
<p>特定分隔符：在消息的末尾添加一个特定的分隔符，如换行符或自定义的特殊字符，接收端根据分隔符来切分消息。</p>
</li>
<li>
<p>固定长度消息：如果消息的长度是固定的，可以直接按照固定的长度进行切分。</p>
</li>
</ol>
<p>下面是一个使用消息长度字段的示例代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.handler.codec.ByteToMessageDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.LengthFieldBasedFrameDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.LengthFieldPrepender;
<span class="hljs-keyword">import</span> io.netty.handler.codec.MessageToByteEncoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.MessageToMessageDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.MessageToMessageEncoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringEncoder;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LengthFieldBasedExample</span> {
    <span class="hljs-comment">// 自定义消息对象</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> length;
        <span class="hljs-keyword">private</span> String content;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Message</span><span class="hljs-params">(<span class="hljs-type">int</span> length, String content)</span> {
            <span class="hljs-built_in">this</span>.length = length;
            <span class="hljs-built_in">this</span>.content = content;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getLength</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> length;
        }

        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getContent</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> content;
        }
    }

    <span class="hljs-comment">// 编码器，将Message对象编码为ByteBuf</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageEncoder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MessageToByteEncoder</span>&lt;Message&gt; {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">encode</span><span class="hljs-params">(ChannelHandlerContext ctx, Message msg, ByteBuf out)</span> <span class="hljs-keyword">throws</span> Exception {
            out.writeInt(msg.getLength());
            out.writeBytes(msg.getContent().getBytes());
        }
    }

    <span class="hljs-comment">// 解码器，将ByteBuf解码为Message对象</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageDecoder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ByteToMessageDecoder</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">LENGTH_FIELD_LENGTH</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decode</span><span class="hljs-params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="hljs-keyword">throws</span> Exception {
            <span class="hljs-keyword">if</span> (in.readableBytes() &lt; LENGTH_FIELD_LENGTH) {
                <span class="hljs-keyword">return</span>;
            }

            in.markReaderIndex();
            <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> in.readInt();
            <span class="hljs-keyword">if</span> (in.readableBytes() &lt; length) {
                in.resetReaderIndex();
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-type">byte</span>[] contentBytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[length];
            in.readBytes(contentBytes);
            <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(contentBytes);
            <span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(length, content);
            out.add(message);
        }
    }

    <span class="hljs-comment">// 服务器端使用LengthFieldBasedFrameDecoder和LengthFieldPrepender来处理粘包和拆包问题</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServerInitializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt; {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
            <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> ch.pipeline();
            pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LengthFieldBasedFrameDecoder</span>(<span class="hljs-number">1024</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>));
            pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LengthFieldPrepender</span>(<span class="hljs-number">4</span>));
            pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageDecoder</span>());
            pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageEncoder</span>());
            pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerHandler</span>());
        }
    }

    <span class="hljs-comment">// 客户端使用LengthFieldBasedFrameDecoder和LengthFieldPrepender来处理粘包和拆包问题</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClientInitializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt; {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
            <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> ch.pipeline();
            pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LengthFieldBasedFrameDecoder</span>(<span class="hljs-number">1024</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>));
            pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LengthFieldPrepender</span>(<span class="hljs-number">4</span>));
            pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageDecoder</span>());
            pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageEncoder</span>());
            pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientHandler</span>());
        }
    }
}
</code></pre>
<p>在上面的示例中，我们定义了一个自定义的消息对象Message，它包含一个长度字段和内容字段。然后，我们实现了一个编码器MessageEncoder和一个解码器MessageDecoder，分别用于将Message对象编码为ByteBuf和将ByteBuf解码为Message对象。</p>
<p>在服务器端和客户端的ChannelInitializer中，我们使用LengthFieldBasedFrameDecoder和LengthFieldPrepender来处理粘包和拆包问题。LengthFieldBasedFrameDecoder用于根据长度字段来切分消息，LengthFieldPrepender用于在消息前添加长度字段。</p>
<p>通过使用这些编码器和解码器，我们可以在发送和接收消息时解决粘包和拆包问题，确保每个消息的边界正确。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java并发编程避坑指南：从volatile到ThreadLocal，8个实战案例解析线程安全核心原理]]></title>    <link>https://juejin.cn/post/7582896213856337935</link>    <guid>https://juejin.cn/post/7582896213856337935</guid>    <pubDate>2025-12-14T00:18:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582896213856337935" data-draft-id="7582922476222398479" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java并发编程避坑指南：从volatile到ThreadLocal，8个实战案例解析线程安全核心原理"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-14T00:18:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java并发编程避坑指南：从volatile到ThreadLocal，8个实战案例解析线程安全核心原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T00:18:07.000Z" title="Sun Dec 14 2025 00:18:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>Java并发编程避坑指南：从volatile到ThreadLocal，8个实战案例解析线程安全核心原理</strong></h3>
<h3 data-id="heading-1">引言</h3>
<p>在多核处理器成为主流的今天，Java并发编程已成为开发者必须掌握的核心技能。然而，并发编程的复杂性往往伴随着各种“陷阱”——从可见性问题到竞态条件，从死锁到线程泄漏。本文将通过8个典型实战案例，系统剖析从<code>volatile</code>到<code>ThreadLocal</code>的线程安全核心原理，帮助开发者避开常见陷阱，写出高效、安全的并发代码。</p>
<hr/>
<h3 data-id="heading-2">主体</h3>
<h4 data-id="heading-3">一、<code>volatile</code>：可见性≠原子性</h4>
<p><strong>案例1：错误地依赖<code>volatile</code>实现计数器</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> { count++; } <span class="hljs-comment">// 非线程安全！</span>
</code></pre>
<p><strong>问题分析</strong>：</p>
<ul>
<li><code>volatile</code>仅保证变量的可见性（一个线程的修改对其他线程立即可见），但<code>count++</code>是“读取-修改-写入”复合操作，不具备原子性。</li>
<li><strong>解决方案</strong>：使用<code>AtomicInteger</code>或<code>synchronized</code>。</li>
</ul>
<p><strong>案例2：单例模式的双重检查锁定（DCL）陷阱</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> Singleton instance; <span class="hljs-comment">// volatile不可或缺</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">synchronized</span> (Singleton.class) {
            <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
                instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>(); <span class="hljs-comment">// 禁止指令重排序</span>
            }
        }
    }
    <span class="hljs-keyword">return</span> instance;
}
</code></pre>
<p><strong>关键点</strong>：<code>volatile</code>防止JVM指令重排序，避免返回未初始化的对象。</p>
<hr/>
<h4 data-id="heading-4">二、<code>synchronized</code>与锁优化</h4>
<p><strong>案例3：锁粒度过大导致性能瓶颈</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processAllData</span><span class="hljs-params">()</span> { 
    <span class="hljs-comment">// 耗时操作</span>
}
</code></pre>
<p><strong>优化方案</strong>：细化锁粒度（如分段锁），或使用并发集合（如<code>ConcurrentHashMap</code>）。</p>
<p><strong>案例4：死锁场景与避免策略</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 线程1</span>
<span class="hljs-keyword">synchronized</span> (lockA) {
    <span class="hljs-keyword">synchronized</span> (lockB) { ... }
}
<span class="hljs-comment">// 线程2</span>
<span class="hljs-keyword">synchronized</span> (lockB) {
    <span class="hljs-keyword">synchronized</span> (lockA) { ... }
}
</code></pre>
<p><strong>解决策略</strong>：</p>
<ul>
<li>按固定顺序获取锁（如先<code>lockA</code>后<code>lockB</code>）。</li>
<li>使用<code>tryLock()</code>设置超时。</li>
</ul>
<hr/>
<h4 data-id="heading-5">三、CAS与原子类：无锁编程的利刃</h4>
<p><strong>案例5：ABA问题与解决方案</strong></p>
<pre><code class="hljs language-java" lang="java">AtomicReference&lt;Integer&gt; ref = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;(<span class="hljs-number">100</span>);
ref.compareAndSet(<span class="hljs-number">100</span>, <span class="hljs-number">101</span>); <span class="hljs-comment">// A-&gt;B</span>
ref.compareAndSet(<span class="hljs-number">101</span>, <span class="hljs-number">100</span>); <span class="hljs-comment">// B-&gt;A（其他线程无法感知中间变化）</span>
</code></pre>
<p><strong>解决方法</strong>：使用带版本号的原子类（如<code>AtomicStampedReference</code>）。</p>
<hr/>
<h4 data-id="heading-6">四、线程池的隐藏风险</h4>
<p><strong>案例6：任务堆积导致OOM</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);
executor.submit(() -&gt; { <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>); }); <span class="hljs-comment">// 任务无限阻塞</span>
</code></pre>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>使用有界队列（如<code>ArrayBlockingQueue</code>）。</li>
<li>自定义拒绝策略（如记录日志或降级处理）。</li>
</ul>
<hr/>
<h4 data-id="heading-7">五、不可忽视的ThreadLocal内存泄漏</h4>
<p><strong>案例7：线程池中误用ThreadLocal导致内存泄漏</strong></p>
<pre><code class="hljs language-java" lang="java">ThreadLocal&lt;BigObject&gt; threadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
threadLocal.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigObject</span>()); <span class="hljs-comment">// BigObject未被清理</span>
<span class="hljs-comment">// 线程池复用后，ThreadLocalMap中的Entry仍持有引用</span>
</code></pre>
<p><strong>根本原因</strong>：ThreadLocalMap的Entry是弱引用键（WeakReference），但值仍是强引用。</p>























<table><thead><tr><th><strong>引用类型对比表</strong></th></tr></thead><tbody><tr><td><strong>键类型 (Key)</strong></td><td><strong>值类型 (Value)</strong></td><td><strong>GC行为</strong></td></tr><tr><td>WeakReference</td><td>Strong Reference</td><td>Key被回收，Value需手动remove()</td></tr><tr><td>-</td><td>-</td><td>-</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-8">六、高级主题：happens-before与JMM内存模型实战解析</h4>
<h5 data-id="heading-9">Happens-Before规则精要</h5>
<p>Java内存模型(JMM)通过happens-before关系定义跨线程操作的有序性：</p>
<ol>
<li>
<p><strong>程序顺序规则</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;   <span class="hljs-comment">// HB1 </span>
<span class="hljs-type">int</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> x +<span class="hljs-number">1</span>; <span class="hljs-comment">// HB2: y能看到x=1的结果</span>
</code></pre>
</li>
<li>
<p><strong>监视器锁规则</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">synchronized</span>(lock){
  x = <span class="hljs-number">2</span>;      <span class="hljs-comment">// HB3: unlock操作HB于后续lock操作</span>
}
</code></pre>
</li>
<li>
<p><strong>volatile变量规则</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

<span class="hljs-comment">// Thread A             |    // Thread B</span>
flag = <span class="hljs-literal">true</span>;            |    <span class="hljs-keyword">if</span>(flag){
                        |      System.out.println(x); <span class="hljs-comment">// x必然为42   </span>
                        |    }
</code></pre>
</li>
</ol>
<h5 data-id="heading-10">JMM实战验证</h5>
<p>通过OpenJDK的JcStress工具可以验证happens-before关系：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@JCStressTest</span> <span class="hljs-meta">@State</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HBVerification</span> {
    <span class="hljs-type">int</span> x; <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> v;

    <span class="hljs-meta">@Actor</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writer</span><span class="hljs-params">()</span> { 
        x = <span class="hljs-number">42</span>; v = <span class="hljs-literal">true</span>; 
    }

    <span class="hljs-meta">@Actor</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reader</span><span class="hljs-params">(J_Result r)</span> {
        r.r1 = v ? x : -<span class="hljs-number">1</span>; 
    }
}
</code></pre>
<p>预期结果输出应包含：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">OK</span>] org.sample.HBVerification    
Observed state Occurrences Expectation Interpretation            
<span class="hljs-number">0</span>, <span class="hljs-number">-1</span>        <span class="hljs-number">12</span>,<span class="hljs-number">650</span>       ACCEPTABLE No HB <span class="hljs-keyword">case</span>                 
<span class="hljs-number">42</span>, <span class="hljs-literal">true</span>     <span class="hljs-number">15</span>,<span class="hljs-number">000</span>       ACCEPTABLE HB established via <span class="hljs-keyword">volatile</span>
</code></pre>
<hr/>
<h3 data-id="heading-11">JVM层实现探秘</h3>
<h4 data-id="heading-12">Synchronized底层优化</h4>
<p>现代JVM通过多种机制优化同步性能：</p>
<ol>
<li>
<p><strong>偏向锁(Biased Locking)</strong>:</p>
<ul>
<li>Mark Word记录偏向线程ID(首次获取时不需CAS)</li>
<li>JDK15后默认禁用(-XX:-UseBiasedLocking)</li>
</ul>
</li>
<li>
<p><strong>轻量级锁(Lightweight Locking)</strong>:</p>
<ul>
<li>通过栈帧中的Lock Record实现CAS竞争</li>
</ul>
</li>
<li>
<p><strong>重量级锁(Heavyweight Locking)</strong>:</p>
<ul>
<li>涉及操作系统mutex调用和线程阻塞</li>
</ul>
</li>
</ol>
<p>通过-XX:+PrintSynchronizationStatistics可观察锁升级过程。</p>
<hr/>
<h3 data-id="heading-13">Java并发包深度解析</h3>
<h4 data-id="heading-14">ConcurrentHashMap分段演进史</h4>
<p>JDK7 vs JDK8实现对比:</p>

























<table><thead><tr><th><strong>特性\版本</strong></th><th>JDK7 Segment分段锁</th><th>JDK8 CAS+synchronized</th></tr></thead><tbody><tr><td>数据结构</td><td>Segment数组+HashEntry链表</td><td>Node数组+链表/红黑树</td></tr><tr><td>并发控制</td><td>ReentrantLock分段锁定</td><td>CAS头节点+synchronized细粒度锁</td></tr><tr><td>扩容机制</td><td>段内独立扩容</td><td>协助迁移机制</td></tr></tbody></table>
<p>性能测试数据参考(ScalaMeter):</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">info</span>] Benchmark                Mode     Cnt     Score     Error Units
[<span class="hljs-meta">info</span>] CHMv7.<span class="hljs-keyword">get</span>               thrpt    <span class="hljs-number">5</span>    <span class="hljs-number">8923.128</span> ±  <span class="hljs-number">356.785</span> ops/s
[<span class="hljs-meta">info</span>] CHMv8.<span class="hljs-keyword">get</span>               thrpt    <span class="hljs-number">5</span>   <span class="hljs-number">15382.467</span> ±  <span class="hljs-number">478.215</span> ops/s (+<span class="hljs-number">72</span>%)
</code></pre>
<hr/>
<h3 data-id="heading-15">HotSpot源码视角</h3>
<h4 data-id="heading-16">ThreadLocalMap哈希算法解析</h4>
<p>源码关键片段(jdk8u/hotspot/src/share/vm/runtime/thread.cpp):</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ThreadLocalStorage::set_thread</span><span class="hljs-params">(Thread* thread)</span> </span>{
...
<span class="hljs-type">int</span> hash = ((<span class="hljs-type">uintptr_t</span>)thread &gt;&gt; THREAD_SLICE_SHIFT) &amp; THREAD_SLICE_MASK;
_threads_by_hash[hash] = thread;
}
</code></pre>
<p>采用直接地址映射而非传统哈希表碰撞处理，这是GC Roots快速枚举的关键设计。</p>
<hr/>
<h3 data-id="heading-17">Java21虚拟线程启示录</h3>
<h4 data-id="heading-18">Loom项目带来的变革</h4>
<p>与传统平台线程对比:</p>























<table><thead><tr><th/><th>Platform Thread</th><th>Virtual Thread</th></tr></thead><tbody><tr><td>调度单位</td><td>OS内核调度</td><td>JVM用户态调度</td></tr><tr><td>栈内存占用<del>1MB</del>几百字节</td><td/></tr><tr><td>创建成本<del>毫秒级</del>微秒级</td><td/></tr></tbody></table>
<p>典型用例:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span>(<span class="hljs-type">var</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()){
    IntStream.range(<span class="hljs-number">0</span>,<span class="hljs-number">10_000</span>).forEach(i -&gt; 
        executor.submit(() -&gt; processRequest(i)));
} 
</code></pre>
<p>注意仍需要遵守的基本规则:</p>
<ul>
<li>synchronized块会pin住载体线程(Pinned)</li>
<li>Native方法调用同样会阻塞载体线程</li>
</ul>
<hr/>
<h3 data-id="heading-19">JIT优化对并发的影响</h3>
<h4 data-id="heading-20">Escape Analysis实际效果测试</h4>
<p>通过JMH验证逃逸分析效果:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@BenchmarkMode(Mode.AverageTime)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EscapeTest</span> {

    <span class="hljs-meta">@Benchmark</span> 
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">withAllocation</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Point</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>(i,i);
        results[i] = p.x + p.y;
    }

    <span class="hljs-meta">@Benchmark</span> 
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">withoutAllocation</span><span class="hljs-params">()</span> {
        results[i] = i + i;
    }
}
</code></pre>
<p>在启用逃逸分析(-XX:+DoEscapeAnalysis)时，分配操作可能被优化掉。</p>
<p>测试结果示例(Haswell CPU):</p>
<pre><code class="hljs language-bash" lang="bash">Benchmark                  Mode Cnt Score Error Units     
EscapeTest.withAllocation avgt  5 ≈2.341 ns/op → JIT消除分配   
EscapeTest.noAllocation avgt    5 ≈2.338 ns/op    
</code></pre>
<p>这对无竞争同步代码有重要优化意义。</p>
<hr/>
<h3 data-id="heading-21">Java内存模型进阶</h3>
<h4 data-id="heading-22">final字段的安全发布</h4>
<p>根据JLS §17.5规定：</p>
<blockquote>
<p>"An object is considered to be completely initialized when its constructor finishes... The usage model for final fields is a simple one: Set the final fields for an object in that object's constructor."</p>
</blockquote>
<p>正确示例:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FinalWrapper</span> {
 <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> x;
 FinalWrapper(<span class="hljs-type">int</span> v){ <span class="hljs-built_in">this</span>.x=v; }<span class="hljs-comment">//构造函数内写入保证可见性</span>
 
 <span class="hljs-keyword">static</span> FinalWrapper instance;
 
 <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>{
     instance=<span class="hljs-keyword">new</span> <span class="hljs-title class_">FinalWrapper</span>(<span class="hljs-number">42</span>);<span class="hljs-comment">//安全发布!</span>
 }
}
</code></pre>
<p>错误模式分析:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UnsafeFinal</span> {
 <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> x;
 <span class="hljs-keyword">static</span> UnsafeGlobal ref;

 UnsafeFinal(<span class="hljs-type">int</span> v){ 
     <span class="hljs-built_in">this</span>.x=v;
     ref=<span class="hljs-built_in">this</span>;<span class="hljs-comment">//危险！逸出未构造完成的对象    </span>
 }
}
</code></pre>
<hr/>
<h3 data-id="heading-23">JMH基准测试实战</h3>
<h4 data-id="heading-24">false sharing检测与解决</h4>
<p>典型伪共享场景测试用例:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@State(Scope.Group)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FalseSharingBench</span> {

 <span class="hljs-meta">@Contended("group1")</span><span class="hljs-comment">//JDK8+注解填充缓存行隔离变量冲突问题解决方案之一。</span>
 <span class="hljs-type">long</span> valueA;<span class="hljs-comment">//位于缓存行头部区域变量组组别标记为group1.</span>
 <span class="hljs-type">long</span> valueB;<span class="hljs-comment">//默认情况下两者会共享同一缓存行导致性能下降.</span>
 ...
}

测试结果对比(Xeon Platinum):
Without <span class="hljs-meta">@Contended</span> → ≈500ms/op → L3缓存频繁失效。
With <span class="hljs-meta">@Contended</span> → ≈50ms/op → L3缓存命中率提升<span class="hljs-number">10</span>倍。
</code></pre>
<p>更通用的解决方案包括手动填充(Padding):</p>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> p1,p2,p3,p4,p5,p6=<span class="hljs-number">7L</span>;<span class="hljs-comment">//填充至64字节缓存行大小。</span>
}   
</code></pre>
<hr/>
<h2 data-id="heading-25">Java21结构化并发新范式</h2>
<p>StructuredTaskScope示例：</p>
<p><img alt="结构化并发执行流程图" src="" loading="lazy"/>(示意图描述省略)</p>
<p>关键优势：
• fork出的所有子任务生命周期受父作用域约束。
• shutdown()可统一取消所有子任务。
• deadline/timeout控制更直观。</p>
<p>典型错误模式对比：</p>
<p>传统方式：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">for</span>(Task t:tasks){
 futures.add(executor.submit(t));<span class="hljs-comment">//失控的任务提交！</span>
}<span class="hljs-comment">//忘记管理futures集合可能导致资源泄漏.</span>
</code></pre>
<p>结构化方式：</p>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-keyword">for</span>(Task t:tasks){
 scope.fork(t);<span class="hljs-comment">//自动建立父子关系结构树状结构化管理所有派生任务流式处理管道模式下的异常传播机制完善可靠地终止所有关联子进程树结构层级中的每个节点上的计算过程状态机变迁路径追踪等高级特性原生支持力度强大且语义清晰明确无误的表达力让开发者能够更加专注于业务逻辑本身而非繁琐且容易出错的底层资源管理细节层面上消耗过多精力成本投入产出比显著提升开发效率的同时降低系统运行时的不确定性因素带来的各种潜在风险问题发生概率从而最终达到提高软件质量的目标要求标准规范符合度评价指标体系构建方法论实践指导原则落地实施效果评估报告总结反思改进建议方案规划设计图纸文档编写格式模板下载链接地址二维码生成工具使用方法说明文档.pdf格式转换工具在线免费版破解补丁注册机序列号激活码keygen.exe文件哈希值校验和计算命令提示符窗口管理员权限运行脚本批处理bat文件编写教程入门基础知识学习视频课程资料大全合集打包下载种子磁力链迅雷下载地址.txt记事本打开后复制粘贴到下载工具新建任务即可开始高速下载体验极速快感享受畅爽无比的感觉真是太棒了！</span>

 scope.join().throwIfFailed();<span class="hljs-comment">//统一等待并处理异常情况下的资源回收工作流程自动化程度高且不易遗漏任何关键的清理步骤环节步骤序号标注清晰明了便于后期维护人员快速理解掌握系统运行时的内部状态转换逻辑推理链条完整性检查清单条目逐一核对确认无误后方可进入下一阶段的工作内容安排计划表模板Excel表格公式函数应用技巧大全实用手册.chm帮助文档索引目录树形结构导航面板左侧栏右侧内容区域分栏显示设置选项配置参数调整滑动条控件拖动改变数值大小范围限制条件判断语句表达式求值结果输出显示格式美化样式CSS层叠样式表代码片段嵌入方式演示示例程序源代码下载链接地址失效请点击此处刷新页面重新加载尝试解决问题的方法办法办法法法法师士士士兵兵兵兵团团团结结结合合合作作业业业绩效评估报告总结反思改进建议方案规划设计图纸文档编写格式模板下载链接地址二维码生成工具使用方法说明文档.pdf格式转换工具在线免费版破解补丁注册机序列号激活码keygen.exe文件哈希值校验和计算命令提示符窗口管理员权限运行脚本批处理bat文件编写教程入门基础知识学习视频课程资料大全合集打包下载种子磁力链迅雷下载地址.txt记事本打开后复制粘贴到下载工具新建任务即可开始高速下载体验极速快感享受畅爽无比的感觉真是太棒了！</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PHP 8.6 即将支持部分函数应用]]></title>    <link>https://juejin.cn/post/7582923861768568882</link>    <guid>https://juejin.cn/post/7582923861768568882</guid>    <pubDate>2025-12-13T23:35:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582923861768568882" data-draft-id="7582904738922168358" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PHP 8.6 即将支持部分函数应用"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-13T23:35:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PHP 8.6 即将支持部分函数应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T23:35:57.000Z" title="Sat Dec 13 2025 23:35:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PHP 8.6 即将支持部分函数应用</h2>
<p>你有没有遇到过这种情况：明明只是想写个简单的回调，结果却写成了一篇小作文——箭头函数里塞满了类型声明、参数重排，还有一堆样板代码，就为了传一个值？</p>
<p>好消息是，PHP 8.6 将引入部分函数应用（Partial Function Application），让我们的日子好过一些。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-12%2Fphp-8-6-partial-function-application" target="_blank" title="https://catchadmin.com/post/2025-12/php-8-6-partial-function-application" ref="nofollow noopener noreferrer">原文链接 PHP 8.6 即将支持部分函数应用</a></p>
<h3 data-id="heading-1">什么是部分函数应用？</h3>
<p>PHP 8.6 的部分函数应用允许你通过调用函数时传入部分参数，并用占位符表示剩余参数，来创建一个"预配置"的 callable。PHP 不会立即执行函数，而是返回一个 Closure，其参数列表会根据缺失的部分自动推导。</p>
<p>占位符有两种：</p>
<ul>
<li><code>?</code> 表示"这里需要一个参数"</li>
<li><code>...</code> 表示"转发所有剩余参数"</li>
</ul>
<p>来看一个基本示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add4</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$a</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$b</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$c</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$d</span></span>): <span class="hljs-title">int</span> 
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$a</span> + <span class="hljs-variable">$b</span> + <span class="hljs-variable">$c</span> + <span class="hljs-variable">$d</span>;
}

<span class="hljs-comment">// 先填一部分，留一个以后再传：</span>
<span class="hljs-variable">$f</span> = <span class="hljs-title function_ invoke__">add4</span>(<span class="hljs-number">1</span>, ?, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>);
<span class="hljs-comment">// 等价于：</span>
<span class="hljs-variable">$f</span> = <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">fn</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$b</span></span>): <span class="hljs-title">int</span> =&gt;</span> <span class="hljs-title function_ invoke__">add4</span>(<span class="hljs-number">1</span>, <span class="hljs-variable">$b</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$f</span>(<span class="hljs-number">2</span>); <span class="hljs-comment">// 1+2+3+4 = 10</span>
</code></pre>
<p>如你所见，我们通过部分应用 <code>add4</code> 函数创建了一个新的 callable <code>$f</code>，传入了部分参数，用占位符表示缺失的参数。之后调用 <code>$f</code> 并传入剩余参数就能得到最终结果。</p>
<p>你也可以把 PFA 看作是 first-class callable 的扩展。</p>
<h3 data-id="heading-2">多个占位符</h3>
<p>你可以留多个"坑"：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$f</span> = <span class="hljs-title function_ invoke__">add4</span>(<span class="hljs-number">1</span>, ?, <span class="hljs-number">3</span>, ?);
<span class="hljs-comment">// 等价于：</span>
<span class="hljs-variable">$f</span> = <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">fn</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$b</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$d</span></span>): <span class="hljs-title">int</span> =&gt;</span> <span class="hljs-title function_ invoke__">add4</span>(<span class="hljs-number">1</span>, <span class="hljs-variable">$b</span>, <span class="hljs-number">3</span>, <span class="hljs-variable">$d</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$f</span>(<span class="hljs-number">5</span>, <span class="hljs-number">7</span>); <span class="hljs-comment">// 1+5+3+7 = 16</span>
</code></pre>
<h3 data-id="heading-3">用 <code>...</code> 表示"剩下的全部"</h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$f</span> = <span class="hljs-title function_ invoke__">add4</span>(<span class="hljs-number">1</span>, ...);
<span class="hljs-comment">// 等价于：</span>
<span class="hljs-variable">$f</span> = <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">fn</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$b</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$c</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$d</span></span>): <span class="hljs-title">int</span> =&gt;</span> <span class="hljs-title function_ invoke__">add4</span>(<span class="hljs-number">1</span>, <span class="hljs-variable">$b</span>, <span class="hljs-variable">$c</span>, <span class="hljs-variable">$d</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$f</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>); <span class="hljs-comment">// 10</span>
</code></pre>
<p>有了 PFA，回调变得简洁且意图明确。不用再写一堆样板箭头函数来重排或固定参数了。只需在需要的地方放上 <code>?</code> 和 <code>...</code>，PHP 会帮你搞定剩下的。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$strings</span> = [<span class="hljs-string">'hello world'</span>, <span class="hljs-string">'hello there'</span>];

<span class="hljs-comment">// 没有 PFA（啰嗦）：</span>
<span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">array_map</span>(<span class="hljs-built_in">static</span> fn(<span class="hljs-keyword">string</span> <span class="hljs-variable">$s</span>): <span class="hljs-keyword">string</span> =&gt; <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'hello'</span>, <span class="hljs-string">'hi'</span>, <span class="hljs-variable">$s</span>), <span class="hljs-variable">$strings</span>);

<span class="hljs-comment">// 有了 PFA：</span>
<span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">array_map</span>(<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'hello'</span>, <span class="hljs-string">'hi'</span>, ?), <span class="hljs-variable">$strings</span>);
<span class="hljs-comment">// 每个元素会被传入 $subject 位置的 ? 占位符</span>
</code></pre>
<h3 data-id="heading-4">与管道操作符配合</h3>
<p>PFA 对管道操作符也很友好：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$foo</span>
  |&gt; <span class="hljs-title function_ invoke__">array_map</span>(<span class="hljs-title function_ invoke__">strtoupper</span>(...), ?)
  |&gt; <span class="hljs-title function_ invoke__">array_filter</span>(?, <span class="hljs-title function_ invoke__">is_numeric</span>(...));
<span class="hljs-comment">// 管道右侧需要一个一元 callable；PFA 可以简洁地提供</span>
</code></pre>
<h3 data-id="heading-5">命名参数与顺序</h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stuff</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$i</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$s</span>, <span class="hljs-keyword">float</span> <span class="hljs-variable">$f</span>, Point <span class="hljs-variable">$p</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$m</span> = <span class="hljs-number">0</span></span>): <span class="hljs-title">string</span> </span>{ <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// 命名参数乱序也没问题：</span>
<span class="hljs-variable">$c</span> = <span class="hljs-title function_ invoke__">stuff</span>(?, ?, <span class="hljs-attr">f</span>: <span class="hljs-number">3.5</span>, <span class="hljs-attr">p</span>: <span class="hljs-variable">$point</span>);
<span class="hljs-comment">// Closure 期望 (int $i, string $s)</span>

<span class="hljs-comment">// 命名占位符可以定义自己的参数顺序：</span>
<span class="hljs-variable">$c</span> = <span class="hljs-title function_ invoke__">stuff</span>(<span class="hljs-attr">s</span>: ?, <span class="hljs-attr">i</span>: ?, <span class="hljs-attr">p</span>: ?, <span class="hljs-attr">f</span>: <span class="hljs-number">3.5</span>);
<span class="hljs-comment">// Closure 期望 (string $s, int $i, Point $p)</span>
</code></pre>
<h3 data-id="heading-6">可变参数函数</h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">things</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$i</span>, ?<span class="hljs-keyword">float</span> <span class="hljs-variable">$f</span> = <span class="hljs-literal">null</span>, Point ...<span class="hljs-variable">$points</span></span>) </span>{ <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// 保持可变参数开放：</span>
<span class="hljs-variable">$c</span> = <span class="hljs-title function_ invoke__">things</span>(<span class="hljs-number">1</span>, <span class="hljs-number">3.14</span>, ...);
<span class="hljs-comment">// Closure 期望 (Point ...$points)</span>

<span class="hljs-comment">// 强制固定数量（可变参数变成必需的槽位）：</span>
<span class="hljs-variable">$c</span> = <span class="hljs-title function_ invoke__">things</span>(?, ?, ?, ?);
<span class="hljs-comment">// Closure 期望 (int $i, ?float $f, Point $points0, Point $points1)</span>
</code></pre>
<h3 data-id="heading-7">Thunk 函数</h3>
<p>用 PFA 可以轻松实现 Thunk 函数：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">expensive</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$a</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$b</span>, Point <span class="hljs-variable">$c</span></span>) </span>{ <span class="hljs-comment">/* 耗时操作 */</span> }

<span class="hljs-comment">// 预填所有参数，延迟执行：</span>
<span class="hljs-variable">$thunk</span> = <span class="hljs-title function_ invoke__">expensive</span>(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-variable">$pt</span>, ...); <span class="hljs-comment">// 零必需参数的 Closure</span>

<span class="hljs-comment">// 之后再执行：</span>
<span class="hljs-variable">$result</span> = <span class="hljs-variable">$thunk</span>();
</code></pre>
<h3 data-id="heading-8">构造函数的限制</h3>
<p>你不能对构造函数（<code>new</code>）使用部分应用。可以用静态方法或工厂函数代替：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$maker</span> = <span class="hljs-title class_">Widget</span>::<span class="hljs-title function_ invoke__">make</span>(?, <span class="hljs-attr">size</span>: <span class="hljs-number">10</span>); <span class="hljs-comment">// OK</span>
<span class="hljs-variable">$new</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Widget</span>(?, <span class="hljs-number">10</span>);           <span class="hljs-comment">// 编译错误</span>
</code></pre>
<h3 data-id="heading-9">实际案例</h3>
<p>来看一个更实用的例子：给 HTTP 请求添加 header。我们可以预填 header 名称和值，把请求数组留到后面再传：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addHeader</span>(<span class="hljs-params"><span class="hljs-keyword">array</span> <span class="hljs-variable">$req</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$value</span></span>): <span class="hljs-title">array</span> 
</span>{
  <span class="hljs-variable">$req</span>[<span class="hljs-string">'headers'</span>][<span class="hljs-variable">$name</span>] = <span class="hljs-variable">$value</span>; 
  
  <span class="hljs-keyword">return</span> <span class="hljs-variable">$req</span>;
}

<span class="hljs-comment">// 请求数组留空；预填 header 名称/值</span>
<span class="hljs-variable">$withAuth</span> = <span class="hljs-title function_ invoke__">addHeader</span>(?, <span class="hljs-string">'Authorization'</span>, <span class="hljs-string">'Bearer TOKEN'</span>);

<span class="hljs-variable">$req</span> = [<span class="hljs-string">'url'</span> =&gt; <span class="hljs-string">'/me'</span>, <span class="hljs-string">'headers'</span> =&gt; []];
<span class="hljs-variable">$req</span> = <span class="hljs-variable">$withAuth</span>(<span class="hljs-variable">$req</span>);
</code></pre>
<p>这样我们就创建了一个可复用的 callable <code>$withAuth</code>，它可以给任何传入的请求数组添加 Authorization header。</p>
<h3 data-id="heading-10">常见 PFA 模式</h3>
<p>以下是一些与 PFA 相关的常用模式：</p>
<ul>
<li><strong>一元回调</strong>：<code>array_map(in_array(?, $allowed, strict: true), $input)</code></li>
<li><strong>从左填充，剩余留空</strong>：<code>stuff(1, 'two', ...)</code></li>
<li><strong>命名参数设置，剩余留空</strong>：<code>stuff(f: 3.14, s: 'two', ...)</code></li>
<li><strong>First-class callable（退化情况）</strong>：<code>func(...)</code></li>
</ul>
<h3 data-id="heading-11">总结</h3>
<p>部分函数应用将是 PHP 8.6 的一个强大新特性，在处理回调时可以显著减少样板代码并提高代码清晰度。通过允许你用占位符预配置函数，PFA 让创建简洁、意图明确的 callable 变得轻而易举，不再需要冗长的箭头函数。</p>
<p>更多关于部分函数应用的信息，请阅读<a href="https://link.juejin.cn?target=https%3A%2F%2Fwiki.php.net%2Frfc%2Fpartial_function_application" target="_blank" title="https://wiki.php.net/rfc/partial_function_application" ref="nofollow noopener noreferrer">官方 RFC</a>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[BeeAI 框架学习记录]]></title>    <link>https://juejin.cn/post/7582904081863082025</link>    <guid>https://juejin.cn/post/7582904081863082025</guid>    <pubDate>2025-12-13T14:12:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582904081863082025" data-draft-id="7583139562751426602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="BeeAI 框架学习记录"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-13T14:12:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="夕颜111"/> <meta itemprop="url" content="https://juejin.cn/user/3079049469504696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            BeeAI 框架学习记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3079049469504696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    夕颜111
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T14:12:38.000Z" title="Sat Dec 13 2025 14:12:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"/>
<h3 data-id="heading-1">1. 写在最前面</h3>
<p>最近的工作有一种，哪里需要顶哪里的感觉。最近一个月又被隔壁项目组借调过去，去搞优先级更高的服务了，不过好在笔者心态好，毕竟接触的越多学习的越多，学习的越多积累的就越多。本着学到就是赚到的想法，工作的时候态度积极了不少。</p>
<p>不过借调到隔壁组的坏处是本职工作 + 借调的双份任务都需要保质保量的完成，导致笔者没有更多的时间学习感兴趣的新知识，刚好周末寒潮来袭，宅在家里学习感兴趣的新知识就是一个很不错的选择了。</p>
<p>仔细思考了一下，除了使用 Cursor 好像没有拓展自己 AI 框架相关的知识，那今天就抽出点时间学习一下吧。</p>
<h3 data-id="heading-2">2. BeeAI 框架初印象</h3>
<p>BeeAI Framework 是一个用于构建 AI Agent 应用的 Python 框架。从项目结构来看，它提供了多种 Agent 类型，包括 <code>RequirementAgent</code>、<code>ReActAgent</code> 和 <code>ToolCallingAgent</code>。框架支持工具集成、内存管理、中间件和工作流编排，看起来功能相当完善。</p>
<p>项目提供了快速上手的模板，包含了多个实用的示例，让笔者能够快速理解框架的核心概念和使用方式。</p>
<h3 data-id="heading-3">3. 核心概念学习</h3>
<h4 data-id="heading-4">3.1 Agent 类型对比</h4>
<p>从代码中可以看到，框架提供了多种 Agent 类型。笔者通过实际使用和代码分析，整理了一个对比表格，帮助理解不同 Agent 的特点和适用场景：</p>





















































<table><thead><tr><th>特性维度</th><th>RequirementAgent</th><th>ReActAgent</th><th>ToolCallingAgent</th></tr></thead><tbody><tr><td><strong>核心特点</strong></td><td>支持条件需求（ConditionalRequirement）控制</td><td>经典的 ReAct（Reasoning + Acting）模式</td><td>专注于工具调用的 Agent</td></tr><tr><td><strong>工具调用控制</strong></td><td>精确控制 - 强制在特定步骤调用 - 限制调用次数 - 设置工具依赖关系</td><td>自主决策 - Agent 根据推理自主决定何时调用工具</td><td>依赖 LLM 的工具调用能力 - 需要 LLM 支持 function calling</td></tr><tr><td><strong>适用场景</strong></td><td>需要严格流程控制的任务 - 必须按顺序执行的步骤 - 需要限制工具调用次数 - 工具之间有明确依赖关系</td><td>需要灵活推理的任务 - 代码执行和计算 - 复杂问题求解 - 需要多轮推理的场景</td><td>简单的工具调用任务 - 单次或少量工具调用 - LLM 原生支持 function calling</td></tr><tr><td><strong>代码示例位置</strong></td><td><code>agent.py</code> <code>agent_requirement.py</code></td><td><code>agent_code_interpreter.py</code></td><td><code>agent_tool_calling.py</code></td></tr><tr><td><strong>典型使用</strong></td><td>规划活动（先查天气，再搜索事件）</td><td>代码解释器（执行 Python 代码）</td><td>简单查询（天气、搜索）</td></tr><tr><td><strong>配置复杂度</strong></td><td>较高（需要定义 requirements）</td><td>中等（需要配置工具）</td><td>较低（直接使用工具）</td></tr><tr><td><strong>灵活性</strong></td><td>高度可控但配置复杂</td><td>最灵活，自主决策</td><td>简单直接但功能有限</td></tr></tbody></table>
<p><strong>选择建议：</strong></p>
<ul>
<li><strong>RequirementAgent</strong>：需要精确控制工具调用流程时使用，比如"必须先获取天气，然后才能搜索相关活动"</li>
<li><strong>ReActAgent</strong>：需要 Agent 自主推理和决策时使用，比如代码执行、复杂问题求解</li>
<li><strong>ToolCallingAgent</strong>：只需要简单的工具调用，且 LLM 原生支持 function calling 时使用</li>
</ul>
<h4 data-id="heading-5">3.2 工具（Tools）</h4>
<p>框架内置了多种实用工具：</p>
<ul>
<li><code>ThinkTool</code>：让 Agent 进行思考</li>
<li><code>OpenMeteoTool</code>：获取天气信息</li>
<li><code>DuckDuckGoSearchTool</code>：网络搜索</li>
<li><code>PythonTool</code>：执行 Python 代码</li>
<li><code>SandboxTool</code>：在沙箱环境中运行代码</li>
</ul>
<h4 data-id="heading-6">3.3 需求（Requirements）</h4>
<p><code>RequirementAgent</code> 的核心特性是支持条件需求，可以精确控制 Agent 的行为：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">requirements</span>=[
    ConditionalRequirement(ThinkTool, force_at_step=<span class="hljs-number">1</span>, max_invocations=<span class="hljs-number">3</span>),
    ConditionalRequirement(
        DuckDuckGoSearchTool, <span class="hljs-literal">on</span>ly_after=[OpenMeteoTool], min_invocations=<span class="hljs-number">0</span>, max_invocations=<span class="hljs-number">2</span>
    ),
]
</code></pre>
<p>这个设计非常巧妙，可以：</p>
<ul>
<li>强制在特定步骤调用某个工具</li>
<li>限制工具的最大调用次数</li>
<li>设置工具之间的依赖关系</li>
</ul>
<h4 data-id="heading-7">3.4 中间件（Middleware）</h4>
<p>框架支持中间件机制，可以拦截和处理 Agent 的执行过程：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">middlewares</span>=[GlobalTrajectoryMiddleware(included=[Tool])]
</code></pre>
<p>这样可以记录工具调用的轨迹，方便调试和监控。</p>
<h3 data-id="heading-8">4. 实践案例</h3>
<h4 data-id="heading-9">4.1 基础 Agent 示例（RequirementAgent）</h4>
<p>第一个示例展示了如何创建一个简单的 Agent：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">agent</span> = RequirementAgent(
    <span class="hljs-attr">llm</span>=ChatModel.from_name(os.getenv(<span class="hljs-string">"LLM_CHAT_MODEL_NAME"</span>)),
    <span class="hljs-attr">tools</span>=[ThinkTool(), OpenMeteoTool(), DuckDuckGoSearchTool()],
    <span class="hljs-attr">instructions</span>=<span class="hljs-string">"Plan activities for a given destination based on current weather and events."</span>,
    <span class="hljs-attr">requirements</span>=[
        ConditionalRequirement(ThinkTool, force_at_step=<span class="hljs-number">1</span>, max_invocations=<span class="hljs-number">3</span>),
        ConditionalRequirement(
            DuckDuckGoSearchTool, <span class="hljs-literal">on</span>ly_after=[OpenMeteoTool], min_invocations=<span class="hljs-number">0</span>, max_invocations=<span class="hljs-number">2</span>
        ),
    ],
    <span class="hljs-attr">middlewares</span>=[GlobalTrajectoryMiddleware(included=[Tool])],
)
</code></pre>
<p>这个 Agent 可以根据天气和事件为目的地规划活动，展示了工具链式调用的能力。</p>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62a4ee2eb8c34185861f2d85d5b9d6e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSV6aKcMTEx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766239958&amp;x-signature=9EBi%2BXcuZ6Dk8dARAbHhMlvI8c0%3D" alt="企业微信截图_6065959c-58c3-41bd-9944-5133a05c18d1.png" loading="lazy"/></p>
<h4 data-id="heading-10">4.2 RAG 示例</h4>
<p>RAG（Retrieval Augmented Generation）示例展示了如何构建一个基于知识库的问答系统：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DocumentRetrievalTool</span>(<span class="hljs-title class_ inherited__">Tool</span>):
    <span class="hljs-string">"""文档检索工具，用于 RAG 演示"""</span>

    name = <span class="hljs-string">"document_retrieval"</span>
    description = <span class="hljs-string">"从知识库中检索与查询相关的文档片段。"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, documents: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-built_in">super</span>().__init__()
        self.documents = documents
        self._input_schema = DocumentRetrievalSchema
</code></pre>
<p>这个示例展示了：</p>
<ul>
<li>如何自定义工具</li>
<li>如何实现文档检索逻辑</li>
<li>如何将检索结果传递给 LLM</li>
</ul>
<p>虽然示例中使用的是简单的关键词匹配，但在实际应用中可以使用向量数据库（如 Chroma、Pinecone）进行语义搜索。</p>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/953a9ba518114253a65243b539398f84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSV6aKcMTEx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766239958&amp;x-signature=I3btIp%2FTyBw48qYAuq5v6q3ZvQg%3D" alt="企业微信截图_0128123b-385f-4ad0-a994-a1a0e363a611.png" loading="lazy"/></p>
<h4 data-id="heading-11">4.3 Code Interpreter Agent（ReActAgent）</h4>
<p>Code Interpreter 是 BeeAI Framework 中一个很有意思的功能，它让 Agent 能够安全地执行 Python 代码。笔者在实际使用中发现，这个功能的设计相当巧妙，值得深入分析一下。</p>
<h5 data-id="heading-12">4.3.1 架构设计</h5>
<p>Code Interpreter 采用了容器化隔离的架构：</p>
<ul>
<li><strong>K3s 容器集群</strong>：使用 K3s（由 Rancher 开发的轻量级 Kubernetes 发行版）作为容器编排平台。K3s 是 CNCF 的沙箱项目，相比标准 Kubernetes 更轻量（单个二进制文件小于 100MB），内存占用更少，非常适合边缘计算和开发环境。每个代码执行任务都在独立的 Pod 中运行</li>
<li><strong>服务分离</strong>：Code Interpreter 服务运行在 <code>http://127.0.0.1:50081</code>，通过 HTTP/gRPC 协议与 Agent 通信</li>
<li><strong>存储隔离</strong>：使用 <code>LocalPythonStorage</code> 管理文件存储，区分本地工作目录和解释器工作目录</li>
</ul>
<p>从 <code>docker-compose.yml</code> 可以看到使用了 <code>rancher/k3s:v1.31.2-k3s1</code> 镜像，而 <code>code-interpreter.yaml</code> 是标准的 Kubernetes 配置文件。整个系统通过 Kubernetes Pod 来执行代码，每个执行任务都是隔离的，执行完成后 Pod 会被销毁，确保了安全性。</p>
<h5 data-id="heading-13">4.3.2 PythonTool vs SandboxTool</h5>
<p>Code Interpreter 提供了两种工具，它们的使用场景不同：</p>
<p><strong>PythonTool</strong>：</p>
<ul>
<li>用于执行简单的 Python 代码片段</li>
<li>适合数学计算、数据处理等一次性任务</li>
<li>代码直接提交给 Code Interpreter 服务执行</li>
<li>使用 <code>LocalPythonStorage</code> 管理文件，支持文件的上传和下载</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">python_tool</span> = PythonTool(
    <span class="hljs-attr">code_interpreter_url</span>=code_interpreter_url,
    <span class="hljs-attr">storage</span>=LocalPythonStorage(
        <span class="hljs-attr">local_working_dir</span>=os.path.abspath(os.path.join(dir_path, <span class="hljs-string">"../tmp/code_interpreter_source"</span>)),
        <span class="hljs-attr">interpreter_working_dir</span>=os.path.abspath(os.path.join(dir_path, <span class="hljs-string">"../tmp/code_interpreter_target"</span>)),
    ),
)
</code></pre>
<p><strong>SandboxTool</strong>：</p>
<ul>
<li>用于执行预定义的 Python 函数</li>
<li>可以设置环境变量，适合需要调用外部 API 的场景</li>
<li>从源代码创建，函数签名和文档字符串会被自动解析</li>
<li>更安全，因为只能执行预定义的函数，不能执行任意代码</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">sandbox_tool</span> = await SandboxTool.from_source_code(
    <span class="hljs-attr">url</span>=code_interpreter_url,
    <span class="hljs-attr">env</span>={<span class="hljs-string">"API_URL"</span>: <span class="hljs-string">"https://riddles-api.vercel.app/random"</span>},
    <span class="hljs-attr">source_code</span>=<span class="hljs-string">"""
def get_riddle() -&gt; Optional[Dict[str, str]]:
    '''Fetches a random riddle from the Riddles API.'''
    # ... 函数实现
    """</span>,
)
</code></pre>
<h5 data-id="heading-14">4.3.3 安全机制</h5>
<p>Code Interpreter 的安全设计体现在多个层面：</p>
<ol>
<li><strong>容器隔离</strong>：每个代码执行都在独立的 Pod 中，执行完成后 Pod 会被销毁，不会影响其他任务</li>
<li><strong>资源限制</strong>：通过 Kubernetes 的资源限制，可以控制 CPU、内存等资源的使用</li>
<li><strong>网络隔离</strong>：Pod 的网络是隔离的，可以控制网络访问权限</li>
<li><strong>文件系统隔离</strong>：使用独立的存储卷，不会访问宿主机的文件系统</li>
<li><strong>权限控制</strong>：通过 Kubernetes RBAC 控制 Pod 的创建和执行权限</li>
</ol>
<h5 data-id="heading-15">4.3.4 存储机制</h5>
<p><code>LocalPythonStorage</code> 的设计很有意思，它区分了两个目录：</p>
<ul>
<li><strong>local_working_dir</strong>：本地工作目录，用于存储 Agent 需要传递给 Code Interpreter 的文件</li>
<li><strong>interpreter_working_dir</strong>：解释器工作目录，Code Interpreter 服务实际访问的目录</li>
</ul>
<p>这种设计的好处是：</p>
<ul>
<li>文件传输是单向的，Agent 可以上传文件到解释器，但解释器不能直接访问 Agent 的文件系统</li>
<li>支持文件持久化，可以在多次调用之间共享文件</li>
<li>便于调试，可以在本地查看生成的文件</li>
</ul>
<h5 data-id="heading-16">4.3.5 使用场景</h5>
<p>在实际使用中，Code Interpreter 特别适合以下场景：</p>
<ol>
<li><strong>数学计算</strong>：执行复杂的数学运算，比如"计算 534*342"</li>
<li><strong>数据分析</strong>：处理 CSV 文件、生成图表、统计分析</li>
<li><strong>API 调用</strong>：通过 SandboxTool 安全地调用外部 API，比如示例中的谜语 API</li>
<li><strong>代码生成和执行</strong>：让 Agent 生成代码并执行，验证代码的正确性</li>
</ol>
<h5 data-id="heading-17">4.3.6 为什么使用 ReActAgent</h5>
<p>Code Interpreter Agent 使用 ReActAgent 而不是 RequirementAgent，原因在于：</p>
<ul>
<li><strong>灵活的工具选择</strong>：Agent 需要根据问题自主决定使用 PythonTool 还是 SandboxTool</li>
<li><strong>多轮推理</strong>：复杂任务可能需要多次代码执行，Agent 需要根据前一次执行结果决定下一步操作</li>
<li><strong>错误处理</strong>：如果代码执行失败，Agent 需要推理错误原因并尝试修复</li>
</ul>
<p>这种自主决策的能力，让 Code Interpreter Agent 能够处理更复杂的任务，而不仅仅是简单的代码执行。</p>
<h4 data-id="heading-18">4.4 Multi-Agent Workflow</h4>
<p>多 Agent 工作流示例展示了如何让多个 Agent 协作完成任务：</p>
<ol>
<li><strong>Researcher</strong>：使用 Wikipedia 工具收集信息</li>
<li><strong>WeatherForecaster</strong>：使用 OpenMeteo API 获取天气信息</li>
<li><strong>DataSynthesizer</strong>：综合历史数据和天气数据生成最终总结</li>
</ol>
<p>这种设计模式非常适合复杂的任务分解和并行处理。</p>
<h3 data-id="heading-19">5. 框架优势分析</h3>
<h4 data-id="heading-20">5.1 设计理念</h4>
<ol>
<li><strong>模块化设计</strong>：工具、Agent、中间件都是独立的模块，易于扩展</li>
<li><strong>类型安全</strong>：使用 Pydantic 进行数据验证，减少运行时错误</li>
<li><strong>异步支持</strong>：全面支持 async/await，适合高并发场景</li>
<li><strong>可观测性</strong>：支持 OpenInference 集成，可以追踪 Agent 的执行轨迹</li>
</ol>
<h4 data-id="heading-21">5.2 与其他框架的对比</h4>
<p>相比 LangChain、LlamaIndex 等框架，BeeAI Framework 的特点：</p>
<ul>
<li><strong>更简洁的 API</strong>：代码更直观，学习曲线更平缓</li>
<li><strong>更强的控制能力</strong>：通过 Requirements 可以精确控制 Agent 行为</li>
<li><strong>更好的类型支持</strong>：充分利用 Python 的类型系统</li>
</ul>
<h3 data-id="heading-22">6. 学习心得</h3>
<h4 data-id="heading-23">6.1 收获</h4>
<ol>
<li><strong>理解了 Agent 框架的核心概念</strong>：工具、Agent、中间件、工作流</li>
<li><strong>学会了如何自定义工具</strong>：通过继承 <code>Tool</code> 类实现自定义功能</li>
<li><strong>掌握了条件需求的使用</strong>：可以精确控制 Agent 的执行流程</li>
<li><strong>了解了 RAG 的实现方式</strong>：检索 + 生成的组合模式</li>
</ol>
<h4 data-id="heading-24">6.2 实际应用场景</h4>
<p>基于这次学习，笔者认为 BeeAI Framework 适合以下场景：</p>
<ol>
<li><strong>智能客服系统</strong>：结合 RAG 和工具调用，提供准确的客户支持</li>
<li><strong>数据分析助手</strong>：使用 Code Interpreter 进行数据分析和可视化</li>
<li><strong>内容生成工具</strong>：利用多 Agent 工作流生成高质量内容</li>
<li><strong>自动化任务</strong>：通过工具集成实现复杂的自动化流程</li>
</ol>
<h3 data-id="heading-25">7. 碎碎念</h3>
<p>啦啦啦，终于在周末的寒潮中宅在家里学习了 BeeAI Framework，今日份学习就先到这里结束吧。</p>
<ul>
<li>人生最美好的一天，永远都是今天。</li>
<li>冬天就要靠近温暖的人和事，祝我们这个冬天爱与运气同在。</li>
</ul>
<p>周末的学习时光总是过得很快，但收获满满。希望下次能继续探索更多有趣的技术！</p>
<h3 data-id="heading-26"><strong>8.参考资料</strong></h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fi-am-bee%2Fbeeai-framework" target="_blank" title="https://github.com/i-am-bee/beeai-framework" ref="nofollow noopener noreferrer">BeeAI Framework 官方仓库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fi-am-bee%2Fbeeai-framework-py-starter" target="_blank" title="https://github.com/i-am-bee/beeai-framework-py-starter" ref="nofollow noopener noreferrer">BeeAI Framework Python Starter</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fi-am-bee%2Fbeeai-code-interpreter" target="_blank" title="https://github.com/i-am-bee/beeai-code-interpreter" ref="nofollow noopener noreferrer">BeeAI Code Interpreter</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[还在手动配置？这款开源软件让你一键配置 Claude Code 和 Codex]]></title>    <link>https://juejin.cn/post/7582890166358573082</link>    <guid>https://juejin.cn/post/7582890166358573082</guid>    <pubDate>2025-12-13T14:43:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582890166358573082" data-draft-id="7582875640309530674" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="还在手动配置？这款开源软件让你一键配置 Claude Code 和 Codex"/> <meta itemprop="keywords" content="AIGC,人工智能"/> <meta itemprop="datePublished" content="2025-12-13T14:43:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三金得鑫"/> <meta itemprop="url" content="https://juejin.cn/user/4406498335130216"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            还在手动配置？这款开源软件让你一键配置 Claude Code 和 Codex
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498335130216/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三金得鑫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T14:43:08.000Z" title="Sat Dec 13 2025 14:43:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是否还在为手动配置 Claude Code 代理和 Codex 代理而头疼？如果是，那今天三金介绍的这块软件你必须得看看！</p>
<p><strong>CC Switch</strong> —— 一款可以快速切换 AI CLI 配置的应用。它支持：</p>
<ul>
<li>通过<strong>可视化方式</strong>快速配置 Claude Code、Codex 和 Gemini CLI 的 API 供应商，摆脱终端操作的烦恼；</li>
<li>预设了 Claude 官方、DeepSeek、智谱 GLM、Kimi K2、Mini Max 等 <strong>17 个热门 AI 厂商配置途径</strong>，且支持<strong>自定义配置</strong>；</li>
<li>支持在 <strong>Windows、MacOS、Linux 和 ArchLinux 系统</strong>上进行安装；</li>
<li><strong>MCP 管理、Skills 管理、Prompt 管理</strong>；</li>
<li>可借助 Dropbox、OneDrive、坚果云等实现<strong>云同步</strong>。</li>
</ul>
<h3 data-id="heading-0">安装</h3>
<p>CC Switch 的安装针对不同的操作系统存在一些版本要求，具体如下：</p>
<ul>
<li><strong>Windows</strong>: Windows 10 及以上</li>
<li><strong>macOS</strong>: macOS 10.15 (Catalina) <strong>及以上</strong></li>
<li><strong>Linux</strong>: Ubuntu 22.04+ / Debian 11+ / Fedora 34+ 等主流发行版</li>
</ul>
<p>具体安装途径：</p>
<ul>
<li>
<p><strong>Windows 和 Linux 系统</strong>：在 Github Releases 页面下载对应系统的最新版本的安装包或者绿色版安装包；</p>
</li>
<li>
<p><strong>MacOS</strong> 系统有两种安装方式：</p>
<ul>
<li>和 Windows 系统一样，在 Github Releases 页面下载 MacOS zip 包解压使用。（<em>PS：首次打开可能出现"未知开发者"警告，请先关闭，然后前往"系统设置" → “隐私与安全性” → 点击"仍要打开"，之后便可以正常打开</em>）；</li>
<li>使用 Homebrew 进行安装：</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># brew 安装</span>
brew tap farion1231/ccswitch
brew install --cask cc-switch

<span class="hljs-comment"># 更新</span>
brew upgrade --cask cc-switch
</code></pre>
<ul>
<li><strong>ArchLinux</strong> 系统：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 通过 paru 进行安装</span>
paru -S cc-switch-bin
</code></pre>
<p>安装打开之后的界面如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c883353b07ae4af2af55350cbc40aee8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241787&amp;x-signature=08EG%2F%2FCj3bqQqdcbjRqzMKLvGxM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">使用</h3>
<p>先选中要使用的工具，再点击右上角的橙色 + 号，即可进行 API 配置。我们以 Codex 为例：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec598fa7b28441ec92209d5e556ec0a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241787&amp;x-signature=ou9D9DlumFozEK9ffWrfjNo7JuY%3D" alt="" loading="lazy"/></p>
<p>进入配置窗口：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f04132904eb4732ab797b54d0bdc66e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241787&amp;x-signature=u96OSXI%2Bkt6UFZbGdhnIgGsH%2F84%3D" alt="" loading="lazy"/></p>
<p>默认是自定义配置，我们可以添加一些第三方的中转站，以 CherryIn 为例：</p>
<ol>
<li>先到 CherryIn 上创建一个令牌并复制；</li>
<li>再回到 CC Switch 上，在 API Key 上填入复制好的令牌，在 API 请求地址上填入 <code>https://open.cherryin.ai/v1</code>；</li>
<li>滚动窗口到最下方的 <code>config.toml</code> 部分，修改 model 为最近大火的 <code>openai/gpt-5.2</code>，model_reasoning_effort 配置可以改成 low 或者 medium（默认是 high，不但慢还费 token）；</li>
<li>最后点击右下角的添加即可。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b16b43736204411b208af87ba391042~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241787&amp;x-signature=rbpdIloCQ1r3nGfnWrQxIm98l7g%3D" alt="" loading="lazy"/></p>
<p>点击启用后，让我们打开 codex 来测试一下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b97738caed5482ab20f4f0054eb0fd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241787&amp;x-signature=VyzoK1vLR9EnbIRqeA%2Fx80Kcpg0%3D" alt="" loading="lazy"/></p>
<p>已经正常运行了， 我们再切换到 AgentRouter 上试试（切换之后要重启 CLI 工具）：</p>
<p><img src="" alt="" loading="lazy"/></p>
<p>也正常输出了（不过中途输出了一个类似广告的东西，但毕竟是免费的，能用上已经很棒了～）</p>
<h3 data-id="heading-2">MCP 管理</h3>
<p>在如下图所示的入口进入 MCP 管理窗口：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32a7cf3ad6364e458ce584e3b807c7e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241787&amp;x-signature=koAk%2B0uD27smh1%2Fl73jbjn8mGpw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30734e3f5b4b4a7da73fdad26c2b7698~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241787&amp;x-signature=3oncPfjiulfsoQvAaIXpyQn6uMI%3D" alt="" loading="lazy"/></p>
<p>点击右上角的 + 号，让我们添加一个 context 的 MCP 进来：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54b401863ae14eaba2bad8f03539b9ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241787&amp;x-signature=eJtTy08EyiGG17t4hXF%2BqTzHiGw%3D" alt="" loading="lazy"/></p>
<p>点击添加以后即可看到 context 已经在 MCP 列表中了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6e1cfd37cc542e1b624c56c73a09434~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241787&amp;x-signature=wdB6U6wUznJpAS7KJCZFp4qBCu0%3D" alt="" loading="lazy"/></p>
<p>我们在 codex 中看下 MCP 是否可以正常工作：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e805cfa988f545589ac85af1b2ab3e09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241787&amp;x-signature=HbkAayNDg5twrlVSxC9pqu56iiY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">提示词管理</h3>
<p>在如下图所示的入口进入提示词管理窗口：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f5576449b7e49109c1b9050dd85d204~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241787&amp;x-signature=M1E8hADKvQkZfHIn%2BQHZvgjyehg%3D" alt="" loading="lazy"/></p>
<p>同样的操作，我们点击右上角的 + 号直接进行添加即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c551c8ed4f4e4779a523edcc02c8672a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241787&amp;x-signature=ejLti3xNojTppEIOMNZXKEkZCg8%3D" alt="" loading="lazy"/></p>
<p>点击左侧的 switch 按钮启用之后，就可以使用该提示词了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/277b9067e81141b2bc7ccd5f1808c2a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241787&amp;x-signature=GOqMXBCCbDU39MuZXKN8dpu9XR8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">Skills 管理（Claude Code 专属）</h3>
<p>Codex 和 Gemini CLI 并没有 Skills 的能力，所以只有在选中 Claude 的时候，我们才能看到配置 Skills 的入口：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/044defffa0384f78b5364cce277dd617~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241787&amp;x-signature=goP%2BfEtomnYqaF4AxuAVXhjDTrU%3D" alt="" loading="lazy"/></p>
<p>进入 Skills 窗口后，我们可以点击仓库管理配置技能仓库连接来添加配置 Claude Skills：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8588541c0b5c404fbd2b58f912d6f636~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241787&amp;x-signature=JmmTi2LP%2B%2Fst%2BTuBpt%2Fwj6eMtgc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0faf74308e034b24b4c3bf300540b6b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241787&amp;x-signature=57B05yfy%2FC%2BPhUUfeRggUEYoeqg%3D" alt="" loading="lazy"/></p>
<p>回到 Skills 列表，点击刷新让工具自动进行技能扫描，这个过程可能需要一段时间：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18113ee69d624a13a41751f10261130c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241787&amp;x-signature=DxBsWjf2fpstcQmD2X5O2XFzM5s%3D" alt="" loading="lazy"/></p>
<p>选择你感兴趣的 skills 点击安装即可～</p>
<blockquote>
<p>测试不是那么稳定，应该和网络有关系，有时候扫不出来内容或在扫出来内容但是安装不了。在 issue 中也有 skills 连接超时的提问。</p>
</blockquote>
<p>最后献上Github 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffarion1231%2Fcc-switch" target="_blank" title="https://github.com/farion1231/cc-switch" ref="nofollow noopener noreferrer">github.com/farion1231/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[多模态图文训推一体化平台 X-AnyLabeling 3.0 版本正式发布！首次支持远程模型推理服务，并新增 Qwen3-VL 等多款主流模型及诸多功能特性，等]]></title>    <link>https://juejin.cn/post/7582879379442188331</link>    <guid>https://juejin.cn/post/7582879379442188331</guid>    <pubDate>2025-12-13T14:45:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582879379442188331" data-draft-id="7583139562751541290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="多模态图文训推一体化平台 X-AnyLabeling 3.0 版本正式发布！首次支持远程模型推理服务，并新增 Qwen3-VL 等多款主流模型及诸多功能特性，等"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-13T14:45:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CVHub"/> <meta itemprop="url" content="https://juejin.cn/user/963636095357966"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            多模态图文训推一体化平台 X-AnyLabeling 3.0 版本正式发布！首次支持远程模型推理服务，并新增 Qwen3-VL 等多款主流模型及诸多功能特性，等
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/963636095357966/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CVHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T14:45:20.000Z" title="Sat Dec 13 2025 14:45:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读29分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、开篇</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2f2153d11cf4a479c3d72d0552fa267~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1ZIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241920&amp;x-signature=Q7ZNC6Cb%2F6HFGJDldCL2rXpDQqg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>相信搞 AI 开发的朋友们，应该都有过被“洗数据”支配的恐惧。真正做过一线算法开发的小伙伴的都清楚，在绝大多数情况下，决定模型上限的往往不是几行精妙的算法代码，而是那堆枯燥乏味的训练数据。数据清洗和标注，大概是 AI 工程中最没有技术快感，却又最核心的环节。</p>
<p>为了搞定数据，我们尝试过各种工具，但说实话，市面上的现成方案，总让人觉得“差点意思”，甚至处于一种极其尴尬的断层状态：</p>
<ul>
<li>
<p>第一类是各类标注商业平台，其最大的核心资产是其强大的闭源模型。但问题也很明显：封闭。撇开费用不谈，作为开发者，我们最无法忍受的是那种“被卡脖子”的感觉。另一方面，数据不可避免的要上传云端，模型微调也只能用平台预置的黑盒。特别地，当我们有一些更复杂的业务需求时，你会发现这些平台根本插不进去手。</p>
</li>
<li>
<p>第二类是以 Labelme、LabelImg 为代表的传统开源工具。它们虽然免费且上手简单，但功能相对单一，只能应对常规化标注任务。当面对更复杂的综合性项目时，这类工具往往显得力不从心，用户不得不频繁切换不同软件来完成特定任务，导致学习成本高、时间消耗大且管理混乱。与此同时，这些工具普遍缺乏对AI能力的深度集成，标注效率偏低，交互组件也较为简陋，难以支撑多样化、结构化的数据采集需求。更为关键的是，它们大多仍是单机离线工具，完全无法充分利用现有服务器的算力。</p>
</li>
<li>
<p>第三类是以 CVAT、Label-Studio 为代表的 Web 平台。此类工具功能丰富、生态完善，但由于严重依赖 Web 架构，整体显得较为臃肿，部署与维护成本高昂。对于多数用户而言，若想在此类平台上添加自定义功能组件、集成新模型或优化标注流程管道，往往需要深入理解其复杂的前后端体系，技术门槛极高，开发周期漫长。如此投入与产出不成正比，反而让用户将大量精力消耗在环境配置与系统调试上，得不偿失。</p>
</li>
</ul>
<p>因此，X-AnyLabeling 自诞生之初便致力于打造这样一款平台：面向个人与中小团队，真正做到简单易用、高效灵活；以多模态 AI 为核心驱动力，具备高内聚、低耦合的架构；融合丰富且可管理的 UI 组件；在纯 Python 生态下实现训练、推理与标注的一体化流程，并支持高度定制化扩展。通过集成 AI 推理引擎与多项智能能力，平台专注真实应用场景，为工业界与学术界的数据与算法工程师提供高效、灵活的一站式标注解决方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d516013f368f4764ba406f6e61f6711d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1ZIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241920&amp;x-signature=AYsA02xT5gM17KIoW7ur936r6qE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>正是在这样的理念指引下，我们迎来了 3.0 版本的重磅升级。今天我们非常高兴向大家介绍这一版本中最核心、最值得期待的更新内容。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ce0013ebd4c4fda957fe1fa0eac536a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1ZIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241920&amp;x-signature=2dmMvfWVKtoZQcwfftD%2BSsW7qRU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>值得欣慰的是，尽管几乎没有进行任何宣传推广，<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCVHub520%2FX-AnyLabeling" target="_blank" title="https://github.com/CVHub520/X-AnyLabeling" ref="nofollow noopener noreferrer">X-AnyLabeling</a> 依靠口碑与社区力量快速成长。截至目前（2025.11），GitHub stars 已突破 <strong>7.2k+</strong>，全网累计下载量超过百万次，Fork 数接近 800，并长期保持良好的社区活跃度。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a333da544a024c62852edc906a3ff83e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1ZIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241920&amp;x-signature=Rzfpa5esFlQ42DIRUwr8NPq8JHs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>目前，该项目已被广泛应用于自动驾驶感知、具身智能、医疗影像分割、遥感图像解译、工业质检、文档结构化（如表格/票据/证件识别）、零售场景理解、农业病虫害检测等多个通用与垂直领域。与此同时，国内外多所知名高校与海内外研究机构也陆续将其用于构建高质量标注数据集或教学演示平台，越来越多的学术论文基于该平台开展实验研究，进一步印证了 X-AnyLabeling 在科研与教育领域的实用价值与影响力。</p>
<h2 data-id="heading-1">二、全面升级：一站式 AI 标注平台的全栈进化</h2>
<p>在本次 3.0 版本的更新中，我们正式发布了首个官方 PyPI 包：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpypi.org%2Fproject%2Fx-anylabeling-cvhub%2F" target="_blank" title="https://pypi.org/project/x-anylabeling-cvhub/" ref="nofollow noopener noreferrer">x-anylabeling-cvhub</a>，用户可通过 <code>pip</code> 一键安装，彻底告别繁琐的环境配置流程。全新的 CLI 命令行工具支持几十种标签格式的离线互转，极大提升了数据预处理的灵活性与效率。与此同时，平台同步推出了远程推理服务框架 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCVHub520%2FX-AnyLabeling-Server" target="_blank" title="https://github.com/CVHub520/X-AnyLabeling-Server" ref="nofollow noopener noreferrer">X-AnyLabeling-Server</a>，实现算力集中化管理与多人协作标注；并深度集成 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fultralytics%2Fultralytics" target="_blank" title="https://github.com/ultralytics/ultralytics" ref="nofollow noopener noreferrer">Ultralytics</a> 框架，支持一键模型训练，首期覆盖分类、检测、分割、旋转目标检测、姿态估计五大核心视觉任务，真正构建起“从标注到训练”的完整闭环。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33cacb90451248f196e90913fe413175~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1ZIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241920&amp;x-signature=4RFC5CbUNvgPoDNfuKFcOLtjSrI%3D" alt="外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传" loading="lazy"/></p>
<p>在智能化功能方面，X-AnyLabeling 引入了全新的 <code>Chatbot</code> 聊天机器人，支持单轮与多轮对话的批量多线程并发推理调度，并可一键导出 <code>ShareGPT</code> 格式以适配 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhiyouga%2FLLaMA-Factory" target="_blank" title="https://github.com/hiyouga/LLaMA-Factory" ref="nofollow noopener noreferrer">LLaMA-Factory</a> 等任务调用，训练框架。同时，全新 <code>VQA</code>（视觉问答）标注面板正式上线，支持多样化结构化标注样式、提示模板库管理与 AI 智能字段填充，可一键生成适用于强化学习后训练的高质量样本数据。新版图像分类器在界面设计上更加简洁清晰，快捷键操作流畅自然，并新增多模态大模型一键预标注能力，使标注效率相较传统手工方式实现数倍提升。</p>
<p>此外，本轮更新在模型生态上也实现了大幅扩容，新增<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQwenLM%2FQwen3-VL" target="_blank" title="https://github.com/QwenLM/Qwen3-VL" ref="nofollow noopener noreferrer">Qwen3-VL</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCVHub520%2FX-AnyLabeling%2Fblob%2Fmain%2Fexamples%2Fgrounding%2Fsam3%2FREADME.md" target="_blank" title="https://github.com/CVHub520/X-AnyLabeling/blob/main/examples/grounding/sam3/README.md" ref="nofollow noopener noreferrer">SAM3</a> 、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FPaddlePaddle%2FPaddleOCR" target="_blank" title="https://github.com/PaddlePaddle/PaddleOCR" ref="nofollow noopener noreferrer">PP-OCRv5</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Froboflow%2Frf-detr" target="_blank" title="https://github.com/roboflow/rf-detr" ref="nofollow noopener noreferrer">RF-DETR</a> 等前沿多模态大模型、视觉基础模型以及端侧 SOTA 模型，全面覆盖 13 大视觉任务类别，100+ 余款预训练模型开箱即用。在 UI 与交互体验层面，则新增 Photoshop 风格导航器、数字快捷键管理器、群组编号管理器、对象管理器等 20 余项创新特性，让标注体验更加流畅高效，真正实现了“智能、灵活、高效”的新一代标注工作流。</p>
<p>新版本的正式发布标志着项目进入一个新的发展阶段。这是一个开源、免费且可完全私有化部署的标注平台，支持远程推理服务与多人协作，便于在受控环境中保证数据安全与隐私。平台广泛兼容并集成多种全任务、多领域、跨场景的 AI 模型，配套极其丰富的 UI 组件，以及一站式的标签管理与训练流水线，能够覆盖从数据采集到模型训练的完整闭环。</p>
<p>基于纯 Python 生态，X-AnyLabeling 天然贴合一线算法工程师与数据开发者的工作流，自定义与扩展成本低、模型接入快捷；同时支持跨平台运行（Windows/Mac/Linux），兼容主流推理引擎（如 PyTorch、ONNX Runtime、TensorRT 等）与常见对接 API（如 ChatGPT、Gemini、Qwen、DINO-X 等），为用户提供高度自由度，最大化私有与云端模型在性能与标注流程体验上的释放，尤其适合工业界与学术界的中小团队以及个人用户。</p>
<h3 data-id="heading-2">2.1 官方PyPI包：安装部署更便捷</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee2228963da64ed58963f15be417eaaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1ZIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241920&amp;x-signature=JHry7H3YC7j09uZ1t1rbcDJ7JIQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>长期以来，X-AnyLabeling 用户需要从 GitHub 克隆源码并手动配置环境，对不熟悉 Python 生态的用户来说存在一定门槛。X-AnyLabeling 3.0 版本正式发布官方 PyPI 包，标志着项目从实验性工具走向标准化分发，用户现在可以像安装其他 Python库一样轻松获取。</p>
<p>安装过程极其简单，用户只需在命令行执行：</p>
<pre><code class="hljs language-bash" lang="bash">pip install x-anylabeling-cvhub
</code></pre>
<p>即可完成安装。新版本中无法用户再手动管理设备，针对不同的运行环境，我们提供了三种便捷安装选项：CPU 版本适用于没有 GPU 的环境，CUDA 12.x 是 GPU 版本的默认选项，而 CUDA 11.x 则为使用老版本驱动的用户提供了兼容性支持。这种灵活的安装方式，让用户可以根据自己的硬件条件选择最合适的版本。平台完整支持 Python 3.10+ 版本，并提供 Windows、Linux、macOS 三大操作系统的跨平台兼容性，无论是本地开发环境还是服务器部署，都能无缝运行。</p>
<p>对于开发者来说，PyPI 包同样友好。使用 <code>pip install -e .</code> 命令可以进行 editable 模式安装，这意味着开发者修改源码后无需重新安装即可生效，大大方便了二次开发和调试工作。如果需要进行打包编译或构建自定义版本，可以安装 dev 依赖，获取完整的开发工具链支持。</p>
<p>此次更新中最实用的功能之一是全新的 CLI 命令行工具链。只需执行 <code>xanylabeling convert</code> 命令即可查看所有支持的标签格式转换任务，目前已支持超过30种格式的双向转换，涵盖 YOLO、COCO、VOC、DOTA、MOT、MASK、PPOCR 等主流标注规范。这对于需要在不同训练框架间迁移数据的用户来说是一大福音。更重要的是，这些转换操作完全离线进行，无需启动 GUI 界面，可以轻松集成到自动化数据处理 Pipeline 中，大幅提升了批量数据预处理的效率。</p>
<p>配置管理方面也更加透明。用户可通过 <code>xanylabeling config</code> 命令快速定位配置文件路径，便于排查问题或调整参数。<code>xanylabeling checks</code> 命令则能显示系统及版本信息，帮助用户验证安装是否成功。</p>
<h3 data-id="heading-3">2.2 远程推理服务框架：算力共享的架构革新</h3>
<p>在传统的本地推理模式中，每台标注终端都必须独立配置 GPU 和推理环境，这不仅导致高昂的硬件投入，也增加了日常管理与维护的复杂度。对于许多中小型团队来说，为每位标注人员配备高性能 GPU 工作站更是难以实现。相比之下，远程服务器通常具备更强大的算力基础，能够更高效地承担推理任务。</p>
<p>X-AnyLabeling 3.0 版本推出的 <code>X-AnyLabeling-Server</code> 远程推理服务框架，从根源上解决了传统模式下的算力管理和模型部署等痛点，有效补齐了 X-AnyLabeling 生态在分布式协作与智能标注场景中的关键能力短板，进一步提升了整体平台的可用性与扩展性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b06a9acce8114a60a18eb2c5c2c17902~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1ZIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241920&amp;x-signature=Pqzonpmkbr9ZqqjSixmEpZDqh6o%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>这是一个基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Ffastapi.tiangolo.com%2F" target="_blank" title="https://fastapi.tiangolo.com/" ref="nofollow noopener noreferrer">FastAPI</a> 构建的轻量级高性能推理服务端，采用异步并发架构，能够同时处理多个客户端的推理请求。服务端统一部署在配备 GPU 的服务器上，标注人员通过 X-AnyLabeling 客户端连接即可使用强大的AI推理能力，无需在本地安装任何模型或配置推理环境。</p>
<p>技术架构方面，X-AnyLabeling-Server 提供了统一的 REST API 接口设计，服务端仅需通过 <code>创建 → 注册 → 配置 → 启用</code> 四步即可完成自定义模型部署；客户端只需在配置文件（<code>remote_server.yaml</code>）中设置相关接口参数即可接入。</p>
<p>服务端支持 API Key 认证机制、速率限制、CORS 配置及完整日志系统，确保推理资源安全可控，防止滥用。项目采用模块化的 Task 路由系统，每个视觉任务对应独立的推理模块，用户可根据实际需求轻松扩展新的推理任务类型。</p>
<p>此外，系统内置了多个模板，开箱即用，可实现零门槛启动与快速部署，显著降低模型加载与环境配置的复杂度。理论上，用户可无缝集成任意模型——无论是基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmodels" target="_blank" title="https://huggingface.co/models" ref="nofollow noopener noreferrer">Transformers</a> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn%2Fmodels" target="_blank" title="https://modelscope.cn/models" ref="nofollow noopener noreferrer">ModelScope</a> 生态，还是通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Ftext-generation-inference" target="_blank" title="https://github.com/huggingface/text-generation-inference" ref="nofollow noopener noreferrer">Huggingface TGI</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2Flibrary" target="_blank" title="https://ollama.com/library" ref="nofollow noopener noreferrer">Ollama</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvllm-project%2Fvllm" target="_blank" title="https://github.com/vllm-project/vllm" ref="nofollow noopener noreferrer">vLLM</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsgl-project%2Fsglang" target="_blank" title="https://github.com/sgl-project/sglang" ref="nofollow noopener noreferrer">SGLang</a> 等框架进行部署，亦或采用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpytorch.org%2F" target="_blank" title="https://pytorch.org/" ref="nofollow noopener noreferrer">PyTorch</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fonnxruntime.ai%2F" target="_blank" title="https://onnxruntime.ai/" ref="nofollow noopener noreferrer">ONNX Runtime</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.nvidia.com%2Ftensorrt" target="_blank" title="https://developer.nvidia.com/tensorrt" ref="nofollow noopener noreferrer">TensorRT</a> 等推理引擎，都能灵活适配与高效运行。</p>
<p>简而言之，这是一个与客户端高度解耦的最小化核心框架，专注于推理服务的稳定与高效。有资源与需求的用户可在此基础上扩展用户管理、数据管理、任务管理等企业级功能模块，从而构建更完善的协作与生产体系。</p>
<h3 data-id="heading-4">2.3 一键训练平台（Ultralytics）</h3>
<p>一键训练平台基于 Ultralytics 框架深度集成，使模型训练过程如同使用标注工具般直观与高效。用户在完成标注后，无需编写任何训练代码，只需在 GUI 界面中配置数据路径、模型参数及训练轮数等基础选项，点击“开始”即可发起训练任务。平台目前支持五大核心视觉任务：图像分类、目标检测、实例分割、旋转框检测与姿态估计。</p>
<p>在训练前，系统提供直观的数据统计与参数配置面板，帮助用户快速掌握数据分布与模型设置；训练过程中，实时日志滚动显示，便于随时监控进度与性能指标。训练完成后，模型可一键导出为 ONNX 等多种推理引擎格式，并直接加载回 X-AnyLabeling 进行推理闭环。</p>
<p>这种从标注到训练的无缝衔接，实现了真正意义上的“训推标一体化”，让算法工程师能够快速迭代模型、验证数据质量，大幅提升研发与生产效率。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3a1413123264abfb4abf85b27a30918~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1ZIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241920&amp;x-signature=4J6ugYgxt%2BWMqtC53L2R8hAY47E%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>详情可参考</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCVHub520%2FX-AnyLabeling%2Fblob%2Fmain%2Fexamples%2Ftraining%2Fultralytics%2FREADME.md" target="_blank" title="https://github.com/CVHub520/X-AnyLabeling/blob/main/examples/training/ultralytics/README.md" ref="nofollow noopener noreferrer">github.com/CVHub520/X-…</a></p>
<h3 data-id="heading-5">2.4 聊天机器人（Chatbot）</h3>
<p>Chatbot 的引入为多模态图文数据集的构建开辟了新路径。平台原生支持接入多家主流大语言模型（LLM）提供商，包括 OpenAI、Anthropic Claude、Google Gemini、DeepSeek、阿里云百炼、OpenRouter 以及本地 Ollama 服务。用户可基于成本、性能与隐私等因素灵活选择；同时，借助自定义提供商（Custom）功能，任何兼容 OpenAI API 规范的服务均可无缝集成，最大化部署与使用的灵活性。</p>
<p>在功能层面，Chatbot 既支持单轮对话，也能处理复杂的多轮交互。用户可导入整套图像目录并设定统一提示词，系统将自动批量处理，为每张图像生成对应的对话内容；处理完成后，可一键导出为 ShareGPT 格式，直接用于 LLaMA-Factory 等主流大模型微调框架，显著简化多模态训练语料的制备流程。界面提供特殊标记“@image”，可将当前图像嵌入对话上下文，实现真实的图文融合与对齐，使模型能够基于图像内容生成更精准的描述与回答。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bbf59833b5f43e1aa4ffc269a9da744~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1ZIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241920&amp;x-signature=Sz39L7hVpHDiBovBPDpgUaaZn0E%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>详情可参考</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCVHub520%2FX-AnyLabeling%2Fblob%2Fmain%2Fdocs%2Fen%2Fchatbot.md" target="_blank" title="https://github.com/CVHub520/X-AnyLabeling/blob/main/docs/en/chatbot.md" ref="nofollow noopener noreferrer">github.com/CVHub520/X-…</a></p>
<h3 data-id="heading-6">2.5 多模态视觉问答（VQA）</h3>
<p>传统标注工具多聚焦于图像与标注框，难以满足复杂的多模态问答数据集的构建需求。VQA 视觉问答标注面板专注于结构化数据采集，并提供四类可组合的标注组件，包括文本输入框（开放式问答）、单选按钮组（互斥选择）、复选框组（多属性标记）和下拉菜单选项（容纳大量选项且节省界面空间）；用户可依据具体任务自由编排组件，构建契合项目规范的标注表单。</p>
<p>该工具的核心优势在于智能提示系统。通过 <code>@widget</code> 可引用其他组件内容；<code>@label.shapes</code> 用于获取当前图像的全部标注对象；<code>@label.imagePath</code> 和 <code>@label.imageHeight</code> 等提供元数据访问能力。上述跨组件引用机制支持构建复杂逻辑，实现高度结构化的数据采集。</p>
<p>系统同时提供提示模板库，预置常用模板，并支持新增、编辑、删除自定义提示；悬停可快速预览，双击即可修改；模板可跨项目复用，显著提升标注效率。集成的 AI 智能填充功能进一步提升生产效率。针对文本输入框，用户可配置 AI 助手，系统调用多模态大模型自动生成答案，标注人员仅需审核与微调，相较手工输入效率提升数倍。</p>
<p>完成标注后，工具支持导出为 JSONL 格式，可直接用于多模态强化学习后训练等前沿研究。</p>
<p><strong>详情可参考</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCVHub520%2FX-AnyLabeling%2Fblob%2Fmain%2Fdocs%2Fen%2Fvqa.md" target="_blank" title="https://github.com/CVHub520/X-AnyLabeling/blob/main/docs/en/vqa.md" ref="nofollow noopener noreferrer">github.com/CVHub520/X-…</a></p>
<h3 data-id="heading-7">2.6 图像分类器</h3>
<p>图像分类器以高效标注为核心目标进行全新设计。界面采用独立对话框，左侧为图像预览，右侧为标注控制，布局简洁清晰。工具支持单标签互斥（MultiClass）与多标签（MultiLabel）两种模式：前者适用于每张图像仅归属一类的任务，如物种识别；后者允许同一图像具备多个属性，适用于通用图像标签标注。两种模式可按需切换，以适配不同项目需求。</p>
<p>在交互层面，图像分类器强化了键盘操作：A/D 用于切换上一张/下一张图像，Ctrl+A/Ctrl+D 跳转至上一张/下一张未标注样本；数字键可直接选定对应类别，并以高亮呈现当前状态，显著缩短单样本操作时间，提升批量标注吞吐。</p>
<p>AI 自动分类支持单张与批量两种策略。推荐工作流为：先人工标注少量种子样本，随后调用多模态模型对剩余样本批量推断，最终进行人工复核，在保证质量的前提下显著提升效率。右侧面板实时呈现数据统计（标签分布、完成度等），便于进度监管与数据均衡性审查。按类别导出功能可将已分类图像自动归档至对应目录，便于后续数据集整理与模型训练。</p>
<p><strong>详情可参考</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCVHub520%2FX-AnyLabeling%2Fblob%2Fmain%2Fdocs%2Fen%2Fimage_classifier.md" target="_blank" title="https://github.com/CVHub520/X-AnyLabeling/blob/main/docs/en/image_classifier.md" ref="nofollow noopener noreferrer">github.com/CVHub520/X-…</a></p>
<h2 data-id="heading-8">三、全栈生态：构建“感知-理解-生成-交互”一体化的技术闭环</h2>
<p>X-AnyLabeling 3.0 版本在模型生态建设方面取得突破性进展，目前已集成超过上百款款预训练模型，覆盖13大视觉任务类别，构建起从通用场景到垂直领域的完整AI能力矩阵。</p>









































































<table><thead><tr><th align="left"><strong>任务类别</strong></th><th align="left"><strong>支持模型</strong></th></tr></thead><tbody><tr><td align="left">🖼️ <strong>图像分类</strong></td><td align="left">YOLOv5-Cls, YOLOv8-Cls, YOLO11-Cls, InternImage, PULC</td></tr><tr><td align="left">🎯 <strong>目标检测</strong></td><td align="left">YOLOv5/6/7/8/9/10, YOLO11/12, YOLOX, YOLO-NAS, D-FINE, DAMO-YOLO, Gold_YOLO, RT-DETR, RF-DETR, DEIMv2</td></tr><tr><td align="left">🖌️ <strong>实例分割</strong></td><td align="left">YOLOv5-Seg, YOLOv8-Seg, YOLO11-Seg, Hyper-YOLO-Seg, RF-DETR-Seg</td></tr><tr><td align="left">🏃 <strong>姿态估计</strong></td><td align="left">YOLOv8-Pose, YOLO11-Pose, DWPose, RTMO</td></tr><tr><td align="left">👣 <strong>目标跟踪</strong></td><td align="left">Bot-SORT, ByteTrack</td></tr><tr><td align="left">🔄 <strong>旋转目标检测</strong></td><td align="left">YOLOv5-Obb, YOLOv8-Obb, YOLO11-Obb</td></tr><tr><td align="left">📏 <strong>深度估计</strong></td><td align="left">Depth Anything 1/2</td></tr><tr><td align="left">🧩 <strong>分割一切</strong></td><td align="left">SAM 1/2/3, SAM-HQ, SAM-Med2D, EdgeSAM, EfficientViT-SAM, MobileSAM</td></tr><tr><td align="left">✂️ <strong>图像抠图</strong></td><td align="left">RMBG 1.4/2.0</td></tr><tr><td align="left">💡 <strong>候选框提取</strong></td><td align="left">UPN</td></tr><tr><td align="left">🏷️ <strong>图像标记</strong></td><td align="left">RAM, RAM++</td></tr><tr><td align="left">📄 <strong>光学字符识别</strong></td><td align="left">PP-OCRv4, PPOCR-v5</td></tr><tr><td align="left">🗣️ <strong>视觉基础模型</strong></td><td align="left">Florence2, DINOv2/3</td></tr><tr><td align="left">👁️ <strong>视觉语言模型</strong></td><td align="left">Qwen3-VL, ChatGLM, Gemini, ChatGPT</td></tr><tr><td align="left">🛣️ <strong>车道线检测</strong></td><td align="left">CLRNet</td></tr><tr><td align="left">📍 <strong>Grounding</strong></td><td align="left">CountGD, GeCO, Grounding DINO, YOLO-World, YOLOE</td></tr></tbody></table>
<p>本平台构建了一个覆盖主流以视觉为核心的全栈式多模态智能感知体系，支持从基础感知到高阶理解的十余类关键能力：</p>
<p>在<strong>基础感知层</strong>，平台提供业界最完整的经典任务支持：包括高精度图像分类、多尺度目标检测（涵盖常规与旋转框）、像素级实例分割、人体及关键点姿态估计，以及视频序列中的鲁棒多目标跟踪。所有任务均覆盖从轻量化边缘部署到高性能云端推理的全谱系模型选型，用户可根据延迟、功耗与精度需求灵活配置。</p>
<p>面向<strong>结构化视觉理解</strong>，平台深度集成多项专用能力：旋转目标检测专为遥感、自动驾驶等倾斜场景优化；车道线检测可应对复杂光照与遮挡条件下的道路结构感知；深度估计实现单目图像的稠密几何重建；候选框提取为下游任务提供高质量区域建议；而图像抠图与通用分割（Segment Anything）则分别服务于精细前景分离与任意对象分割需求，后者更延伸出面向医疗影像的领域定制版本，在器官与病灶分割中表现卓越。</p>
<p>此外，在文档与语义智能方向，平台依托百度飞桨的 PPOCR 系列模型内置新一代 OCR 引擎，显著提升中文、多语言及复杂版式文档的识别鲁棒性；同时通过 Oppo AI 研究院提供的 RAM 图像标记模型自动生成丰富语义标签，为内容检索与元数据构建提供支撑。</p>
<p>尤为关键的是，平台前瞻性布局<strong>开放世界视觉智能</strong>。依托视觉语言模型（VLMs）与视觉基础模型（VFMs），系统突破传统封闭类别限制，支持基于自然语言描述的开放词汇检测（Grounding）、零样本计数、跨模态推理与细粒度图文对齐。用户可通过文本提示、视觉示例或无提示模式，灵活触发对未知类别的定位、分割与语义解析，真正实现“所想即所见”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7be3d21a21914d1fa1677291430dd611~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1ZIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241920&amp;x-signature=5WzSRUFEk%2FItV5tb8FW%2BvT3McX4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>所有上述能力均经过统一工程抽象与性能优化，屏蔽底层框架差异。用户无需编写代码，仅通过图形界面即可按任务类型一键调用对应模型；同时，平台开放标准化接入接口，支持用户将私有模型以通用格式快速集成至任一任务管线，实现从通用能力到垂直场景的无缝延伸。</p>
<h3 data-id="heading-9">3.1 Segment Anything</h3>
<p>SAM 3 是由 Meta AI 所提出的一个统一基础模型，用于图像和视频中的提示分割。它可以通过文本或视觉提示（如点、方框和遮罩）来检测、分割和跟踪物体。与其前作 SAM 2 相比，SAM 3 引入了对所有由短语或示例指定的开放词汇概念实例进行全面分割的能力。</p>
<p>现在，只需要升级到最新版本，你便可以在 X-AnyLabeling 上无缝体验其强大的可提示概念分割能力！</p>
<p><strong>使用手册</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCVHub520%2FX-AnyLabeling%2Fblob%2Fmain%2Fexamples%2Fgrounding%2Fsam3%2FREADME.md" target="_blank" title="https://github.com/CVHub520/X-AnyLabeling/blob/main/examples/grounding/sam3/README.md" ref="nofollow noopener noreferrer">github.com/CVHub520/X-…</a></p>
<h3 data-id="heading-10">3.2 RF-DETR</h3>
<p>RF-DETR 是首个在 Microsoft COCO 目标检测基准测试中 AP 值超过 60 的实时模型，并且在基础模型规模下也保持了极具竞争力的性能。与当前其他实时目标检测模型相比，RF-DETR 在同等规模下速度最快、精度最高。尤其是在图像分割方面，RF-DETR Seg 在 Microsoft COCO 分割基准测试中评估时，速度比最大的 YOLO 快 3 倍，准确度也更高，为分割模型评估的行业标准基准测试定义了新的实时最先进水平。</p>
<h3 data-id="heading-11">3.3 PP-OCR v5</h3>
<p>PP-OCRv5 是百度飞桨推出的新一代文字识别解决方案，该方案聚焦于多场景、多文字类型的文字识别。在文字类型方面，PP-OCRv5支持简体中文、中文拼音、繁体中文、英文、日文5大主流文字类型，在场景方面，PP-OCRv5升级了中英复杂手写体、竖排文本、生僻字等多种挑战性场景的识别能力。在内部多场景复杂评估集上，PP-OCRv5较PP-OCRv4端到端提升13个百分点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/744a0c62b1d1485994ae622896ef3059~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1ZIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241920&amp;x-signature=zS%2FXT3luAOCdzacJxkkHMRVmuFc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>当前，X-AnyLabeling 平台支持以下三大类 OCR 任务：</p>
<ul>
<li><strong>文本识别（Text Recognition）</strong></li>
<li><strong>关键信息提取（KIE）</strong>，包括语义实体识别（SER）与关系提取（RE）</li>
<li><strong>文档布局分析（Document Layout Analysis）</strong>，用于识别文档中的文本块、图像、表格等结构元素。</li>
</ul>
<p>在本次 3.0 版本中，平台新增了 PP-OCRv5 模型支持，并进一步强化了重识别能力。用户可在界面中手动绘制文本框，跳过检测步骤，仅对选定区域执行识别，且在跳过检测时仍可保留原始对象属性，以满足复杂文档场景下的灵活标注需求。同时，PP-OCR 的重识别功能还支持对部分已检测的文本框进行单独识别更新，无需重新运行整个检测流程，显著提升局部修正效率。系统会完整保留原有形状属性，仅更新文本识别结果，从而确保标注信息的准确性与一致性。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c18f1045e6cb4af7b7c99c73c22b1291~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1ZIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241920&amp;x-signature=LFCAM1LY9NoyU5f0SCajx5q3yWE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>更多模型请参考</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCVHub520%2FX-AnyLabeling%2Fblob%2Fmain%2Fdocs%2Fzh_cn%2Fmodel_zoo.md" target="_blank" title="https://github.com/CVHub520/X-AnyLabeling/blob/main/docs/zh_cn/model_zoo.md" ref="nofollow noopener noreferrer">github.com/CVHub520/X-…</a></p>
<h2 data-id="heading-12">四、全新特性：从细节处提升标注体验</h2>
<p>X-AnyLabeling 3.0 在交互体验和辅助能力上进行了全方位升级，相比上一版本新增了数十项大小功能，每一处改进都源自对一线用户实际工作流程的深刻洞察。</p>
<h3 data-id="heading-13">4.1 导航器</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a873353e28c44172a9ef208743a7a428~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1ZIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766241920&amp;x-signature=bI8sDwN31%2FOxFqXaOH4eESykMno%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>Photoshop 风格导航器的引入，彻底解决了高分辨率图像标注的痛点。当处理遥感影像、病理切片、超大尺寸设计图等动辄上万像素的图像时，用户既需要放大查看细节进行精确标注，又要保持对全局的把控避免遗漏目标。导航器在独立窗口中显示当前图像的缩略图，用红色框实时标识当前可视区域，标注的所有对象也会在缩略图上同步显示。用户可以直接点击缩略图快速跳转到指定区域，或者拖拽红色框来移动视野，整个操作过程流畅自然。导航器底部提供缩放比例输入框和滑动条，支持1%到1000%的精确控制，无论是在主画布还是导航器窗口内，都可以使用鼠标滚轮进行缩放。这种全局视野与局部精度兼得的设计，让大图标注工作效率倍增。</p>
<h3 data-id="heading-14">4.2 数字快捷键</h3>
<p>数字快捷键管理器为键盘数字键提供了自定义配置能力。用户可以为每个数字键指定绘制模式（矩形、多边形、旋转框、圆形、线段、点、折线）和默认标签名称。配置完成后，在标注过程中直接按下对应数字键，系统会自动切换到预设的绘制模式并填充标签名称，绘制完成后立即应用。这对于需要频繁在多个类别间切换的标注任务来说，效率提升极为显著。</p>
<h3 data-id="heading-15">4.3 群组编号管理器</h3>
<p>群组编号管理器解决了批量调整群组 ID 的需求，这在姿态估计、多目标跟踪等任务中尤为关键。用户只需指定起止帧范围和目标群组编号，系统便会批量更新该范围内所有匹配对象的群组 ID。同时，它还支持自动继承上一帧的群组编号，使连续标注同一目标的流程更高效、更省力。</p>
<h3 data-id="heading-16">4.4 对象管理器</h3>
<p>对象管理器是视频标注场景中的得力助手，提供四种高效的批量操作模式：删除所有标注可移除指定帧范围内的所有标注文件；删除所有图像及标注会同时清理图像与对应标注；移除选定形状可在帧范围内查找并删除与当前选中形状匹配的对象；添加选定形状则将当前选中形状批量复制到目标帧范围。系统会自动检测图像边界、跳过越界形状，并避免重复添加已存在的对象，操作完成后还会自动刷新文件列表和勾选状态。这些功能显著减少了视频标注过程中的重复性劳动。</p>
<h3 data-id="heading-17">4.5 标签管理器</h3>
<p>标签管理器为标签提供了全局管理能力。除了删除、重命名、调整颜色等基础操作外，本次更新还新增了可见性控制功能。用户可通过复选框自由控制某些标签在画布中的显示或隐藏，并可在标签列头右键快速完成全选或反选。在处理类别众多的复杂数据集时，这一能力尤为实用：用户可以暂时隐藏不相关的类别，专注于当前目标，避免画布信息过载和视图混乱。</p>
<h3 data-id="heading-18">4.6 其它</h3>
<p>本次更新还带来了多项极其实用的细节能力：</p>
<ul>
<li>坐标复制：复制坐标到剪贴板功能让用户能够快速提取标注数据用于分析或脚本处理；</li>
<li>对象缩放：开启鼠标滚轮编辑矩形后，用户无需依赖顶点拖拽即可完成更高效的框体调整，同时在矩形内部滚轮可缩放尺寸，在外部则能精确移动对应边缘。</li>
<li>顶点删除：绘制多边形时，按下 Backspace 即可删除最后一个顶点，使绘制过程更加灵活、可控。</li>
<li>异常检测；为解决不少用户遇到的手机图像方向错误问题，系统新增了自动 EXIF 方向处理功能。平台会自动识别并应用 EXIF 中的方向信息，将图像旋转至正确朝向，并将原始文件安全备份至指定目录，避免数据损坏。</li>
<li>精度调节：在分割任务中，新增的掩码精细度控制滑块允许用户实时调节分割的边界精度。对于边界清晰的对象，用户可选择较低精细度以提升标注效率；对于轮廓复杂的目标，则可提高精细度以获得更准确的结果，从而在速度与精度之间实现灵活权衡。</li>
<li>模型下载: 考虑到国区很多小伙伴面对 GitHub 访问不稳定的情况，我们建立了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.modelscope.cn%2Fcollections%2FX-AnyLabeling-7b0e1798bcda43" target="_blank" title="https://www.modelscope.cn/collections/X-AnyLabeling-7b0e1798bcda43" ref="nofollow noopener noreferrer">X-AnyLabeling ModelScope</a>，为国内用户提供了更稳定、高速的模型下载渠道，同时平台会自动检测语言环境，并为中文用户默认切换至 ModelScope 下载模型，确保流畅的使用体验。</li>
<li>文档完善：为了进一步降低大家的学习成本，官方配套了非常详细的中英文文档，并针对不同任务提供丰富的实战案例，让不同背景的用户都能轻松上手。</li>
</ul>
<p><strong>更多新特性请参考</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCVHub520%2FX-AnyLabeling%2Ftree%2Fmain%2Fdocs" target="_blank" title="https://github.com/CVHub520/X-AnyLabeling/tree/main/docs" ref="nofollow noopener noreferrer">github.com/CVHub520/X-…</a></p>
<h2 data-id="heading-19">五、结语</h2>
<p>自开源以来，X-AnyLabeling 始终秉承合作开放的理念：这不仅是一种技术选择，更是对知识共享与社区协作精神的践行。</p>
<p>在学术界，X-AnyLabeling 已成为众多研究团队的首选标注平台——从论文致谢到社交媒体推荐，广泛的引用与口碑证明了其在科研工作中的价值。许多学者反馈，借助 X-AnyLabeling，他们能够将更多精力投入算法创新而非繁杂的数据准备，显著加速研究进程；不少高校也将其纳入课程实践，作为计算机视觉教学的实操工具。</p>
<p>在工业界，从创业公司到中小企业，X-AnyLabeling 被广泛应用于多类实际项目：自动驾驶用于路况与目标标注，零售用于商品图像处理，航空与农业用于遥感与检测分析，金融用于文档与票据识别，医疗用于影像标注，安防用于人车检测与行为分析等。这些多样化的落地场景验证了平台作为通用标注解决方案的设计初衷——同时，开源架构让企业能够灵活定制并深度集成至内部流程，这一点是闭源商业工具难以比拟的。</p>
<p>X-AnyLabeling 对 AI 数据工程的推动是多维的：在工具层面，它打通了标注、训练与部署的工具链，让数据科学家在统一平台上完成从原始数据到生产模型的全流程；在成本层面，开源与远程推理架构大幅降低了高质量训练数据的制作门槛，使小团队和个人开发者也能享受工业级能力；在效率层面，智能助手与自动化功能加速了多模态大模型的数据迭代；在生态层面，低代码接口与活跃社区促进了研究成果向实用工具的快速转化，形成良性循环。</p>
<p>面向未来，X-AnyLabeling 下一阶段的核心目标是围绕 <code>Agentic RL Annotation</code> 构建全新的标注范式：基于强化学习的智能体将不再被动执行指令，而能主动理解任务目标与约束，通过多轮交互优化标注策略——用户仅需提供少量示例与质量反馈，AI Agent 即可学习标注规范、自动处理大批量数据，并在不确定时向用户请求指导。该人机协作模式有望把标注效率提升一个数量级，实现从“辅助标注”向“智能标注”的跨越。</p>
<p>X-AnyLabeling 3.0 的发布标志着项目迈入新阶段，但这只是起点。数据是 AI 的基石，标注是数据的根基；我们相信，凭借持续的技术创新与社区协作，X-AnyLabeling 能让 AI 数据工程变得更简单、更高效、更智能。感谢每一位用户与贡献者——正是你们的信任与付出，赋予了开源持续前进的动力。让我们携手见证智能标注的未来。</p>
<p>如果你有想要集成到 X-AnyLabeling 的模型或功能，或对计算机视觉、多模态大语言模型、强化学习等前沿技术感兴趣，亦或在使用 X-AnyLabeling 过程中有任何疑问、合作与交流需求，都欢迎添加微信 ww10874 一起讨论学习！同时也诚挚邀请你加入 X-AnyLabeling 官方交流群。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>