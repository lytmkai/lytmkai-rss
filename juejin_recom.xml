<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[解析Android内存分析的指标]]></title>    <link>https://juejin.cn/post/7585446706326781961</link>    <guid>https://juejin.cn/post/7585446706326781961</guid>    <pubDate>2025-12-20T05:10:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706326781961" data-draft-id="7585463258690273289" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解析Android内存分析的指标"/> <meta itemprop="keywords" content="Android,APP"/> <meta itemprop="datePublished" content="2025-12-20T05:10:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="愤怒的代码"/> <meta itemprop="url" content="https://juejin.cn/user/4125023358426190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解析Android内存分析的指标
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023358426190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    愤怒的代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:10:11.000Z" title="Sat Dec 20 2025 05:10:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Android 系统开发中，为了精准衡量进程的内存消耗，通常会使用 <strong>VSS、RSS、PSS、USS</strong> 这四个指标。由于内存共享机制的存在，单一的“内存占用”数字往往无法真实反映进程对系统的影响，因此这四个指标提供了不同维度的观察视角。</p>
<h2 data-id="heading-0">0x00 核心含义详解</h2>
<p>我们可以通过一个简单的模型来理解：假设进程 A 使用了 <strong>50MB 私有内存</strong>，并与进程 B 共享一个 <strong>20MB 的动态库</strong>。</p>
<h3 data-id="heading-1"><strong>VSS (Virtual Set Size) - 虚拟耗用内存</strong></h3>
<ul>
<li><strong>含义</strong>：进程能访问到的全部虚拟地址空间大小。</li>
<li><strong>包含</strong>：已分配但未实际使用的内存、映射到磁盘的文件、共享库占用的全部空间等。</li>
<li><strong>特点</strong>：数值最大。它不代表真实的物理内存消耗，对于<strong>性能分析意义较小</strong>。</li>
</ul>
<h3 data-id="heading-2"><strong>RSS (Resident Set Size) - 实际使用物理内存</strong></h3>
<ul>
<li><strong>含义</strong>：进程当前实际占用的物理内存（RAM）。</li>
<li><strong>包含</strong>：进程的私有内存 + <strong>共享库的全部大小</strong>。</li>
<li><strong>缺点</strong>：存在“重复计算”。如果有 10 个进程都用了那个 20MB 的共享库，每个进程的 RSS 都会计入这 20MB。将所有进程的 RSS 相加，会远大于系统总内存。</li>
</ul>
<h3 data-id="heading-3"><strong>PSS (Proportional Set Size) - 比例分配内存</strong></h3>
<ul>
<li><strong>含义</strong>：将共享库的大小按共享进程的数量<strong>均摊</strong>。</li>
<li><strong>计算</strong>：私有内存 + (共享库大小 / 共享该库的进程数)。</li>
<li><strong>优点</strong>：<strong>最客观的指标</strong>。如果将系统中所有进程的 PSS 相加，结果几乎等于系统实际消耗的总内存。它是衡量进程系统级负担的最佳标准。</li>
</ul>
<h3 data-id="heading-4"><strong>USS (Unique Set Size) - 进程独占内存（最常用）</strong></h3>
<ul>
<li><strong>含义</strong>：进程完全独占的物理内存。</li>
<li><strong>包含</strong>：只有该进程能访问到的 RAM 区域。</li>
<li><strong>优点</strong>：<strong>分析内存泄露的核心指标</strong>。它表示如果杀死该进程，系统能立刻回收的内存量。</li>
</ul>
<h2 data-id="heading-5">0x01 核心判断标准：为什么 USS 是“金标准”？</h2>
<p>在分析泄漏时，我们通常遵循这个优先级：<strong>USS &gt; PSS &gt; RSS &gt; VSS</strong>。</p>
<ul>
<li><strong>VSS 和 RSS 的局限性</strong>：由于 RSS 包含了共享库内存，当系统其他进程加载或卸载共享库时，你的进程 RSS 可能会波动，这会产生“伪泄漏”的干扰。</li>
<li><strong>PSS 的参考意义</strong>：PSS 能够反映你的进程对系统总内存的真实贡献。如果 PSS 持续上涨，说明你的应用正在拖慢系统。</li>
<li><strong>USS 的决定性作用</strong>：<strong>USS 只包含进程完全独占的内存。</strong> 内存泄漏本质上是进程内部的对象无法被回收，因此<strong>内存泄漏一定会直接反映在 USS 的上涨上</strong>。</li>
</ul>
<h2 data-id="heading-6">0x02 分析内存泄漏分析的流程</h2>
<h3 data-id="heading-7">第一步：建立基准线 (Baseline)</h3>
<p>在应用启动并进入主界面稳定后，记录当前的内存状态。</p>
<pre><code class="hljs language-shell" lang="shell">adb shell dumpsys meminfo &lt;your_package_name&gt;
</code></pre>
<p>重点记录：<code>TOTAL Pss</code> 和 <code>Private Dirty</code>（后者非常接近 USS）。</p>
<h3 data-id="heading-8">第二步：执行重复性操作 (Stress Test)</h3>
<p>内存泄漏通常发生在 Activity 销毁或长生命周期对象（如 Singleton、Thread）中。执行以下操作：</p>
<ol>
<li>进入一个怀疑有泄漏的页面，再退出。</li>
<li>重复上述过程 <strong>10 次以上</strong>。</li>
<li>手动触发几次 GC（在 Android Studio Profiler 中点击小垃圾桶图标，或通过 <code>adb shell cmd activity gc</code>）。</li>
</ol>
<h3 data-id="heading-9">第三步：对比观测</h3>
<p>再次运行 <code>adb shell dumpsys meminfo &lt;your_package_name&gt;</code>，观察数据变化：</p>
<ul>
<li><strong>如果 USS (Private Dirty) 阶梯式上升</strong>：说明存在<strong>私有内存泄漏</strong>（通常是 Java 对象、Bitmap 或 Native 堆内存）。</li>
<li><strong>如果 PSS 上升但 USS 稳定</strong>：这种情况极少见，可能意味着你调用的系统共享资源（如某些系统服务的缓存）在增加，而不是你进程内部的泄漏。</li>
<li><strong>如果 PSS/USS 均不增加，但 VSS 疯狂增长</strong>：说明你在不断地申请虚拟地址空间（例如创建了大量线程，每个线程占用 1MB 虚拟栈空间，但实际还没开始使用物理内存）。</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">Applications Memory Usage (in Kilobytes):
Uptime: 102275 Realtime: 102275

** MEMINFO in pid 3069 [com.android.launcher3] **
                   Pss  Private  Private     Swap      Rss     Heap     Heap     Heap
                 Total    Dirty    Clean    Dirty    Total     Size    Alloc     Free
                ------   ------   ------   ------   ------   ------   ------   ------
  Native Heap    11128    11060        0        0    13796    19812    13511     2600
  Dalvik Heap     2316     2188        0        0     6620    27729     3153    24576
 Dalvik Other     2587     2264        0        0     3528                           
        Stack      736      736        0        0      740                           
       Ashmem        2        0        0        0        8                           
      Gfx dev     1244     1244        0        0     1244                           
    Other dev       36        0       36        0      284                           
     .so mmap     6076      212      128        0    54512                           
    .jar mmap     1922        0        0        0    26648                           
    .apk mmap    14824        0    13900        0    38756                           
    .ttf mmap       54        0        0        0      228                           
    .dex mmap      213        4        0        0      504                           
    .oat mmap       55        0        0        0     2044                           
    .art mmap     7794     7404        4        0    20040                           
   Other mmap     1179        4       32        0     4984                           
   EGL mtrack    40288    40288        0        0    40288                           
    GL mtrack     6104     6104        0        0     6104                           
      Unknown      466      448        0        0     1100                           
        TOTAL    97024    71956    14100        0    97024    47541    16664    27176
 
 App Summary
                       Pss(KB)                        Rss(KB)
                        ------                         ------
           Java Heap:     9596                          26660
         Native Heap:    11060                          13796
                Code:    14256                         123424
               Stack:      736                            740
            Graphics:    47636                          47636
       Private Other:     2772
              System:    10968
             Unknown:                                    9172
 
           TOTAL PSS:    97024            TOTAL RSS:   221428      TOTAL SWAP (KB):        0
 
...

</code></pre>
<h2 data-id="heading-10">0x03 针对不同类型的泄漏分析</h2>
<h3 data-id="heading-11">A. Java 层泄漏 (Activity/Fragment)</h3>
<ul>
<li>
<p><strong>现象</strong>：<code>TOTAL Pss</code> 和 <code>Java Heap</code> 持续增长。</p>
</li>
<li>
<p><strong>分析</strong>：查看 <code>dumpsys meminfo</code> 最后的 <code>Objects</code> 部分。</p>
<ul>
<li><code>Views</code> 和 <code>Activities</code> 的数量。如果你退出了页面，<code>Activities</code> 数量没有减少，那就是典型的 Activity 泄漏。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-12">B. Native 层泄漏 (C++/JNI)</h3>
<ul>
<li><strong>现象</strong>：<code>Native Heap</code> 指标持续增长，且 <code>USS</code> 同步上涨。</li>
<li><strong>分析</strong>：如果你在 JNI 中使用了 <code>malloc</code> 或 <code>new</code> 但没有 <code>free</code>，这部分内存会体现在 <code>Native Heap</code> 中。</li>
</ul>
<h3 data-id="heading-13">C. 共享内存/文件描述符泄漏 (SharedMemory/FD)</h3>
<p>如果 SharedMemory 没有被正确关闭：</p>
<ul>
<li>
<p><strong>现象</strong>：<code>USS</code> 可能不会显著增长（如果你已经 <code>munmap</code> 了），但<strong>文件描述符 (FD)</strong> 会耗尽。</p>
</li>
<li>
<p><strong>检查方式</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">adb shell <span class="hljs-built_in">ls</span> -l /proc/&lt;pid&gt;/fd | <span class="hljs-built_in">wc</span> -l
</code></pre>
<p>例如检查<code>3069</code>号进程(<code>com.android.launcher3</code>)</p>
<pre><code class="hljs language-shell" lang="shell">adb root
adb shell ls -l /proc/3069/fd | wc -l
<span class="hljs-meta prompt_">
# </span><span class="bash">输出</span>
<span class="hljs-meta prompt_"># </span><span class="bash">82</span>
</code></pre>
<p>重复操作后，如果 FD 数量不断增加，说明你的 <code>SharedMemory</code> 或 <code>ParcelFileDescriptor</code> 没有执行 <code>close()</code>。</p>
</li>
</ul>
<h2 data-id="heading-14">0x04 自动化检测工具推荐</h2>
<p>虽然手动分析 <code>dumpsys</code> 很有帮助，但在实际开发中，建议配合以下工具：</p>





















<table><thead><tr><th><strong>工具</strong></th><th><strong>优势</strong></th></tr></thead><tbody><tr><td><strong>LeakCanary</strong></td><td>自动化程度最高，直接在手机端弹窗告知 Java 泄漏引用链。</td></tr><tr><td><strong>Android Studio Profiler</strong></td><td>可视化实时查看 PSS 分布，支持 Capture Heap Dump 分析堆快照。</td></tr><tr><td><strong>Perfetto / Systrace</strong></td><td>适合分析 Native 层和系统级的内存分配行为。</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Node.js Elasticsearch 客户端索引大型 CSV 文件]]></title>    <link>https://juejin.cn/post/7585390679398957062</link>    <guid>https://juejin.cn/post/7585390679398957062</guid>    <pubDate>2025-12-20T04:10:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679398957062" data-draft-id="7585412203978162219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Node.js Elasticsearch 客户端索引大型 CSV 文件"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-20T04:10:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Node.js Elasticsearch 客户端索引大型 CSV 文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:10:45.000Z" title="Sat Dec 20 2025 04:10:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Fu%2Fjoshmock" title="https://discuss.elastic.co/u/joshmock" target="_blank" ref="nofollow noopener noreferrer">joshmock</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a63db05724934ee494f54a3ab790d1a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766808645&amp;x-signature=3Ak4aLkmgmzCh6BMEheIyUvXemY%3D" alt="" loading="lazy"/></p>
<p>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fapi%2Fdoc%2Felasticsearch%2Foperation%2Foperation-bulk" title="https://www.elastic.co/docs/api/doc/elasticsearch/operation/operation-bulk" target="_blank" ref="nofollow noopener noreferrer">bulk API</a> 可以轻松地将大量文档索引到 Elasticsearch：将你的数据记录转换为 JSON 文档，并插入指示它们应该添加到哪个索引的指令，然后将这个大的换行分隔 JSON blob 作为请求体，通过单个 HTTP 请求发送到 Elasticsearch 集群。或者，使用 Node.js 客户端的 bulk 函数。</p>
<p>更多阅读：E<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F124318170" title="https://elasticstack.blog.csdn.net/article/details/124318170" target="_blank" ref="nofollow noopener noreferrer">lasticsearch：使用最新的 Nodejs client 8.x 来创建索引并搜索</a></p>
<p>下面演示如何读取 CSV 文件，将其行转换为 JSON 对象，并进行索引：</p>
<pre><code class="hljs language-php" lang="php">`

<span class="hljs-number">1</span>.  import { Client } <span class="hljs-keyword">from</span> <span class="hljs-string">'@elastic/elasticsearch'</span>
<span class="hljs-number">2</span>.  import { parse } <span class="hljs-keyword">from</span> <span class="hljs-string">"csv-parse/sync"</span>
<span class="hljs-number">3</span>.  import { readFileSync } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>

<span class="hljs-number">5</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">csv</span> = <span class="hljs-title function_ invoke__">parse</span>(<span class="hljs-title function_ invoke__">readFileSync</span>(<span class="hljs-string">'data.csv'</span>, <span class="hljs-string">'utf8'</span>), { <span class="hljs-attr">columns</span>: <span class="hljs-literal">true</span> })
<span class="hljs-number">6</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">operations</span> = csv.<span class="hljs-title function_ invoke__">flatMap</span>(row =&gt; [
<span class="hljs-number">7</span>.    { <span class="hljs-attr">index</span>: { <span class="hljs-attr">_index</span>: <span class="hljs-string">"my_index"</span> } },
<span class="hljs-number">8</span>.    row
<span class="hljs-number">9</span>.  ])

<span class="hljs-number">11</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">client</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Client</span>({ node: <span class="hljs-string">'http://localhost:9200'</span> })
<span class="hljs-number">12</span>.  await client.<span class="hljs-title function_ invoke__">bulk</span>({ operations })

`AI写代码![](https:<span class="hljs-comment">//csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)</span>
</code></pre>
<p>但是，如果你需要发送的数据量超过 Elasticsearch 单次请求能接收的大小，或者你的 CSV 文件太大，无法一次性全部加载到内存中，该怎么办？这时可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Fclients%2Fjavascript%2Fclient-helpers%23bulk-helper" title="https://www.elastic.co/docs/reference/elasticsearch/clients/javascript/client-helpers#bulk-helper" target="_blank" ref="nofollow noopener noreferrer">bulk helper</a>！</p>
<p>虽然 bulk API 本身已经很简单，但对于更复杂的场景，helper 提供了对流式输入的支持，可以将大型数据集拆分为多个请求等。</p>
<p>例如，如果你的 Elasticsearch 服务器只能接收小于 10MB 的 HTTP 请求，你可以通过设置 flushBytes 值来指示 bulk helper 拆分数据。每当请求即将超过设置值时，就会发送一次 bulk 请求：</p>
<pre><code class="hljs language-php" lang="php">`

<span class="hljs-number">1</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">csv</span> = <span class="hljs-title function_ invoke__">parse</span>(<span class="hljs-title function_ invoke__">readFileSync</span>(<span class="hljs-string">'data.csv'</span>, <span class="hljs-string">'utf8'</span>), { <span class="hljs-attr">columns</span>: <span class="hljs-literal">true</span> })
<span class="hljs-number">2</span>.  await client.helpers.<span class="hljs-title function_ invoke__">bulk</span>({
<span class="hljs-number">3</span>.    <span class="hljs-attr">datasource</span>: csv,
<span class="hljs-number">4</span>.    <span class="hljs-title function_ invoke__">onDocument</span>(doc) {
<span class="hljs-number">5</span>.      <span class="hljs-keyword">return</span> { <span class="hljs-attr">index</span>: { <span class="hljs-attr">_index</span>: <span class="hljs-string">"my_index"</span> } }
<span class="hljs-number">6</span>.    },
<span class="hljs-number">7</span>.    // send a bulk request <span class="hljs-keyword">for</span> every <span class="hljs-number">9.5</span>MB
<span class="hljs-number">8</span>.    <span class="hljs-attr">flushBytes</span>: <span class="hljs-number">9500000</span>
<span class="hljs-number">9</span>.  })

`AI写代码
</code></pre>
<p>或者，如果你的 CSV 文件太大无法一次性加载到内存中，helper 可以将<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fapi%2Fstream.html" title="https://nodejs.org/api/stream.html" target="_blank" ref="nofollow noopener noreferrer">流</a>作为数据源，而不是使用数组：</p>
<pre><code class="hljs language-php" lang="php">`

<span class="hljs-number">1</span>.  import { createReadStream } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>
<span class="hljs-number">2</span>.  import { parse } <span class="hljs-keyword">from</span> <span class="hljs-string">'csv-parse'</span>

<span class="hljs-number">4</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">parser</span> = <span class="hljs-title function_ invoke__">parse</span>({ <span class="hljs-attr">columns</span>: <span class="hljs-literal">true</span> })
<span class="hljs-number">5</span>.  await client.helpers.<span class="hljs-title function_ invoke__">bulk</span>({
<span class="hljs-number">6</span>.    <span class="hljs-attr">datasource</span>: <span class="hljs-title function_ invoke__">createReadStream</span>(<span class="hljs-string">'data.csv'</span>).<span class="hljs-title function_ invoke__">pipe</span>(parser),
<span class="hljs-number">7</span>.    <span class="hljs-title function_ invoke__">onDocument</span>(doc) {
<span class="hljs-number">8</span>.      <span class="hljs-keyword">return</span> { <span class="hljs-attr">index</span>: { <span class="hljs-attr">_index</span>: <span class="hljs-string">"my_index"</span> } }
<span class="hljs-number">9</span>.    }
<span class="hljs-number">10</span>.  })

`AI写代码![](https:<span class="hljs-comment">//csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)</span>
</code></pre>
<p>这会将 CSV 文件中的行缓冲到内存中，解析为 JSON 对象，并让 helper 将结果刷新为一个或多个 HTTP 请求发送出去。这个解决方案不仅节省内存，而且阅读起来也和将整个文件加载到内存中的方法一样简单！</p>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Ft%2Fdec-9th-2025-en-use-the-node-js-elasticsearch-client-to-index-large-csv-files%2F382901" title="https://discuss.elastic.co/t/dec-9th-2025-en-use-the-node-js-elasticsearch-client-to-index-large-csv-files/382901" target="_blank" ref="nofollow noopener noreferrer">discuss.elastic.co/t/dec-9th-2…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官问Redis主从延迟导致脏数据读怎么解决？]]></title>    <link>https://juejin.cn/post/7585686247269187593</link>    <guid>https://juejin.cn/post/7585686247269187593</guid>    <pubDate>2025-12-20T05:02:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585686247269187593" data-draft-id="7585382553290342436" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官问Redis主从延迟导致脏数据读怎么解决？"/> <meta itemprop="keywords" content="后端,Redis,面试"/> <meta itemprop="datePublished" content="2025-12-20T05:02:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官问Redis主从延迟导致脏数据读怎么解决？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:02:26.000Z" title="Sat Dec 20 2025 05:02:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>大家好啊，今天给大家带来一个面试常问题：redis主从数据同步延迟，担心从节点读到脏数据，怎么办？Redis 主从复制默认是<strong>异步</strong>的，这意味着在 CAP 理论中，Redis 默认保证的是 <strong>AP（可用性 + 分区容错性）</strong> ，而不是 CP（强一致性）。因此，主从延迟导致的“读脏数据”（Stale Data）在理论上无法完全避免，只能通过业务策略或技术手段来缓解</p>
</blockquote>
<h2 data-id="heading-1">Redis主从架构</h2>
<p>要先弄明白为什么redis主从架构会出现脏数据读，我们才能想出对应的缓解之策。</p>
<p>举一个栗子：redis一主二从架构，主节点负责变更数据，然后同步给从节点。从节点负责读数据。因此从这样的架构来说，出现脏数据读从理论上说是不可避免的，因为主从节点数据同步无法做到零延迟。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/beb441caceb446e68c34d30d982c22cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811746&amp;x-signature=8RnX77VUEIrXkT2iFv%2B%2FZcIR00Q%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">Redis主从数据同步延迟很大的常见原因</h2>
<h3 data-id="heading-3">复制积压堆积</h3>
<p>主节点每秒处理大量写操作（如高频 SET、INCR、LPUSH 等），产生大量复制流，从节点消费速度跟不上主节点生产速度，导致复制积压堆积。</p>
<p><code>lave0</code>/<code>slave1</code> 的 <code>offset</code> 与主节点 <code>master_repl_offset</code> 的差值就是是否复制积压堆积的标准。若差值持续增大，说明复制追不上。</p>
<h3 data-id="heading-4">BigKey</h3>
<p>Redis的BigKey传输是导致主从延迟最常见的原因。
Master 传输一个几十 MB 的 List 或 Hash 给 Slave，网络被占用，解析被阻塞，导致后续命令瞬间堆积延迟。</p>
<h3 data-id="heading-5">网络与硬件</h3>
<ul>
<li>
<p><strong>同局域网:</strong> 确保主从在同一机房/局域网，跨公域网同步延迟极大。</p>
</li>
<li>
<p><strong>机器负载:</strong> 检查 Slave 节点的 AOF 重写（Rewrite）或 RDB 生成是否导致 CPU 飙升，阻塞了主线程的同步回放</p>
</li>
</ul>
<h2 data-id="heading-6">解决方法</h2>
<p>我从<strong>业务容忍度</strong>、<strong>代码逻辑</strong>和<strong>运维配置</strong>三个层面来解决这个问题。</p>
<p>关键是不要试图全局解决“0延迟”，而是根据数据敏感度拆分策略。</p>
<h3 data-id="heading-7">关键业务强制读主 (Read from Master)</h3>
<p>这是最简单且最有效的方案。对于必须准确的数据，不要走读写分离的逻辑，直接路由到 Master 节点。
比如余额，库存扣减，订单状态等等。</p>
<p>在Java中，可以类似这样写：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (isCriticalData) {
    redisTemplate.opsForValue().get(key); <span class="hljs-comment">// 配置为主库连接</span>
} <span class="hljs-keyword">else</span> {
    redisReadReplicaTemplate.opsForValue().get(key); <span class="hljs-comment">// 配置为从库连接</span>
}
</code></pre>
<h3 data-id="heading-8">使用 <code>WAIT</code> 命令 (强一致性折衷,不推荐)</h3>
<p>Redis 支持 <code>WAIT</code> 命令，它可以阻塞当前写操作的客户端，直到写操作被同步到指定数量的从节点。</p>
<ul>
<li><strong>命令:</strong> <code>WAIT numreplicas timeout</code></li>
<li><strong>逻辑:</strong> 只有当至少 <code>numreplicas</code> 个从节点确认接收到写操作后，Master 才会返回成功。</li>
<li><strong>代价:</strong> <strong>严重牺牲写性能</strong>。如果从节点故障或网络抖动，写操作会阻塞直到超时。</li>
<li><strong>适用:</strong> 极其重要且写频率较低的数据</li>
</ul>
<h3 data-id="heading-9">业务层校验 "版本号" 或 "时间戳"</h3>
<p>如果你必须读从库，但又想知道数据是否过期：</p>
<ol>
<li><strong>写入时:</strong> 在 Value 中写入一个时间戳或版本号 <code>v1</code>。</li>
<li><strong>另外存储:</strong> 将该 Key 的最新版本号 <code>v1</code> 存入一个高可用的缓存（如 Zookeeper、Etcd 或 Redis Master 的一个专用 Key）。</li>
<li><strong>读取时:</strong> 读取从库数据，对比其中的版本号与 Master/中心存储的版本号。如果不一致，说明延迟了，触发<strong>回源读主库</strong></li>
</ol>
<h3 data-id="heading-10">杜绝BigKey等</h3>
<p>还有很多策略，比如代码层我们要拆分bigkey，监控主从复制偏移量等等</p>
<h2 data-id="heading-11">总结</h2>
<p>我们要根据业务敏感度来解决这个问题，根据数据敏感度来拆分策略：</p>

























<table><thead><tr><th><strong>场景</strong></th><th><strong>示例</strong></th><th><strong>推荐策略</strong></th></tr></thead><tbody><tr><td><strong>强一致性</strong></td><td>余额、库存扣减、订单状态</td><td><strong>强制读主库 (Master)</strong></td></tr><tr><td><strong>最终一致性</strong></td><td>用户昵称、非实时排行榜、历史记录</td><td><strong>读从库 + 监控/重试</strong></td></tr><tr><td><strong>高敏感度</strong></td><td>秒杀资格、配置开关</td><td><strong>使用 <code>WAIT</code> 命令或分布式锁</strong></td></tr></tbody></table>
<ul>
<li>
<p><strong>最高优先级:</strong> 梳理业务。将<strong>必须强一致</strong>的读请求（如金额），在代码层面指定<strong>直接读 Master</strong>。这是最稳妥的。</p>
</li>
<li>
<p><strong>次优先级:</strong> 检查是否有 <strong>BigKey</strong> 阻塞了同步链路。</p>
</li>
<li>
<p><strong>可选策略:</strong> 如果必须读从库且要求较高一致性，实现一个简单的<strong>监控熔断机制</strong>（通过 Java/Go 定时检查 Offset），自动隔离高延迟的从节点</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零搭一个 Vue 小家：用 Vite + 路由轻松入门现代前端开发]]></title>    <link>https://juejin.cn/post/7585400495683665962</link>    <guid>https://juejin.cn/post/7585400495683665962</guid>    <pubDate>2025-12-20T04:08:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585400495683665962" data-draft-id="7585400495683026986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零搭一个 Vue 小家：用 Vite + 路由轻松入门现代前端开发"/> <meta itemprop="keywords" content="Vue.js,前端框架,面试"/> <meta itemprop="datePublished" content="2025-12-20T04:08:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鱼鱼块"/> <meta itemprop="url" content="https://juejin.cn/user/4302802432307224"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零搭一个 Vue 小家：用 Vite + 路由轻松入门现代前端开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4302802432307224/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鱼鱼块
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:08:42.000Z" title="Sat Dec 20 2025 04:08:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从零开始，轻松走进 Vue 的世界：一个“全家桶”小项目的搭建之旅</h2>
<p>如果你刚刚接触前端开发，听到“Vue”、“Vite”、“路由”这些词时是不是有点懵？别担心！我们可以把写代码想象成<strong>搭积木、装修房子、甚至安排一场家庭旅行</strong>。今天，我们就通过一个名为 <code>all-vue</code> 的小项目，带你一步步理解现代 Vue 应用是怎么“搭起来”的。</p>
<hr/>
<h3 data-id="heading-1">🏠 第一步：选好地基——用 Vite 快速建项目</h3>
<h4 data-id="heading-2"><strong>什么是vite？</strong></h4>
<blockquote>
<p><strong>Vite</strong>（法语，意为“快”）是一个由 Vue.js 作者 <strong>尤雨溪（Evan You）</strong> 主导开发的现代化前端构建工具。它旨在解决传统打包工具（如 Webpack）在开发阶段启动慢、热更新（HMR）延迟高等问题，提供极速的开发体验。</p>
</blockquote>
<p>想象你要盖一栋房子。传统方式可能要先打地基、砌砖、铺电线……繁琐又耗时。而 <strong>Vite</strong> 就像一位超级高效的建筑承包商，你只要说一句：“我要一个 Vue 房子”，它立刻给你搭好框架，连水电都通好了！</p>
<p>在终端里运行：</p>
<pre><code class="hljs language-sql" lang="sql">npm init vite<span class="hljs-variable">@latest</span> <span class="hljs-keyword">all</span><span class="hljs-operator">-</span>vue <span class="hljs-comment">-- --template vue</span>
</code></pre>
<p>几秒钟后，你就得到了一个结构清晰的项目目录。其中最关键的是：</p>
<ul>
<li><code>index.html</code>：这是你房子的“大门”，浏览器一打开就看到它。</li>
<li><code>src/main.js</code>：这是整栋房子的“总开关”，负责启动整个应用。</li>
<li><code>src/App.vue</code>：这是“客厅”，所有房间（页面）都要从这里进出。</li>
</ul>
<p>Vite 的优势在于<strong>快</strong>——修改代码后，浏览器几乎瞬间刷新，就像你换了个沙发，家人马上就能坐上去试舒服不舒服。</p>
<hr/>
<h3 data-id="heading-3">🏗️ 第二步：认识整栋楼——项目结构概览</h3>
<p>运行 <code>npm init vite@latest all-vue -- --template vue</code> 后，你会得到这样一栋“数字公寓”：</p>
<p>项目结构简略预览：</p>
<pre><code class="hljs language-bash" lang="bash">/all-vue
├── public/            <span class="hljs-comment"># 公共资源（如 logo.png）</span>
├── src/
│   ├── assets/        <span class="hljs-comment"># 图片、字体等静态资源</span>
│   ├── components/    <span class="hljs-comment"># 可复用的小部件（按钮、卡片等）</span>
│   ├── views/         <span class="hljs-comment"># 独立页面（首页、关于页等）</span>
|   |     |—— About.vue <span class="hljs-comment"># 关于页面的Vue组件</span>
|   |     |—— Home.vue <span class="hljs-comment"># 主页的vue组件</span>
│   ├── router/        <span class="hljs-comment"># 室内导航系统</span>
|   |     |—— index.js <span class="hljs-comment"># 路由总控</span>
│   ├── App.vue        <span class="hljs-comment"># 中央控制台（客厅）</span>
│   └── main.js        <span class="hljs-comment"># 智能钥匙</span>
├── index.html         <span class="hljs-comment"># 入户大门</span>
├── package.json       <span class="hljs-comment"># 公寓的“住户手册 + 装修清单”</span>
└── vite.config.js     <span class="hljs-comment"># 建筑规范说明书</span>
</code></pre>
<p>其中，<code>package.json</code> 就像这栋楼的<strong>住户手册 + 装修材料清单</strong>。打开它，你会看到：</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"all-vue"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"0.0.0"</span>,
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"dev"</span>: <span class="hljs-string">"vite"</span>,
    <span class="hljs-string">"build"</span>: <span class="hljs-string">"vite build"</span>,
    <span class="hljs-string">"preview"</span>: <span class="hljs-string">"vite preview"</span>
  },
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"vue"</span>: <span class="hljs-string">"^3.4.0"</span>,
    <span class="hljs-string">"vue-router"</span>: <span class="hljs-string">"^4.3.0"</span>
  },
  <span class="hljs-string">"devDependencies"</span>: {
    <span class="hljs-string">"@vitejs/plugin-vue"</span>: <span class="hljs-string">"^5.0.0"</span>,
    <span class="hljs-string">"vite"</span>: <span class="hljs-string">"^5.0.0"</span>
  }
}
</code></pre>
<ul>
<li><strong><code>dependencies</code></strong>：这是“入住必需品”，比如 Vue 框架本身、路由系统——没有它们，房子没法正常运转；</li>
<li><strong><code>devDependencies</code></strong>：这是“装修工具包”，只在开发时用（比如 Vite 构建工具），住户入住后就不需要了；</li>
<li><strong><code>scripts</code></strong>：这是“快捷指令”，比如 <code>npm run dev</code> 就是“启动预览模式”，<code>npm run build</code> 是“打包交付”。</li>
</ul>
<p>有了这份清单，任何开发者都能一键还原你的整套环境——就像照着宜家说明书组装家具一样可靠。</p>
<hr/>
<h3 data-id="heading-4">🚪 第三步：认识“大门”——index.html 的两个秘密</h3>
<p>虽然现代 Vue 应用的逻辑几乎全在 JavaScript 和 <code>.vue</code> 文件里，但一切的起点，其实是这个看似简单的 <code>index.html</code>：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/svg+xml"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/vite.svg"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>all-vue<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>别小看这十几行代码，它藏着两个关键设计：</p>
<h4 data-id="heading-5">🔌 1. <code>&lt;div id="app"&gt;&lt;/div&gt;</code>：Vue 的“插座”</h4>
<p>你可以把它想象成墙上预留的一个<strong>智能插座面板</strong>。它本身空无一物，但一旦通电（Vue 应用启动），就会自动“投影”出整个用户界面。</p>
<p>在 <code>main.js</code> 中，我们这样写：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p>这句话的意思就是：“请把 <code>App.vue</code> 这个‘客厅’的内容，投射到 id 为 <code>app</code> 的那个插座上。”<br/>
没有这个插座，Vue 再厉害也无处施展；有了它，动态内容才能在静态 HTML 中生根发芽。</p>
<h4 data-id="heading-6">⚡ 2. <code>&lt;script type="module" src="/src/main.js"&gt;&lt;/script&gt;</code>：原生 ES 模块的魔法</h4>
<p>注意这里的 <code>type="module"</code>。这是现代浏览器支持的一种<strong>原生模块加载方式</strong>。传统脚本是“一股脑全塞进来”，而模块化脚本则像快递包裹——每个文件独立打包，按需引用，互不干扰。</p>
<p>Vite 正是利用了这一特性，<strong>无需打包即可直接在浏览器中运行模块化的代码</strong>。这意味着：</p>
<ul>
<li>开发时启动飞快（冷启动快）；</li>
<li>修改文件后热更新极快（HMR 精准替换）；</li>
<li>代码结构清晰，符合现代工程规范。</li>
</ul>
<p>所以，<code>index.html</code> 不仅是入口，更是连接<strong>静态 HTML 世界</strong>与<strong>动态 Vue 世界</strong>的桥梁。</p>
<hr/>
<h3 data-id="heading-7">🔑 第四步：打造“钥匙”——main.js 如何启动应用</h3>
<p>有了大门，就得有钥匙。<code>main.js</code> 就是这把精密的电子钥匙，负责激活整套智能家居系统：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./style.css'</span>

<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">use</span>(router).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p>这段代码做了三件事，环环相扣：</p>
<ol>
<li><strong>引入核心模块</strong>：从 Vue 拿到“造房子”的工具（<code>createApp</code>），从本地拿到“客厅设计图”（<code>App.vue</code>）和“导航系统”（<code>router</code>）；</li>
<li><strong>组装系统</strong>：用 <code>.use(router)</code> 把导航插件装进主程序；</li>
<li><strong>插入插座</strong>：<code>.mount('#app')</code> 表示：“请把这套系统通电安装在 <code>index.html</code> 中 id 为 <code>app</code> 的插座上。”</li>
</ol>
<p>没有这把钥匙，再漂亮的客厅也只是一堆图纸；有了它，整个房子才真正“活”起来。</p>
<hr/>
<h3 data-id="heading-8">💡 第五步：点亮客厅——根组件 App.vue</h3>
<p>钥匙转动，门开了，我们走进 <code>App.vue</code> —— 这是所有功能的总控中心：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span> |
      <span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<blockquote>
<p>多人一开始会直接写 <code>&lt;div&gt;Home | About&lt;/div&gt;</code>，但这只是静态文字。要让它们变成可点击的导航，就得用 Vue Router 提供的 <code>&lt;router-link&gt;</code> 组件。</p>
</blockquote>
<p>这里有两个核心元素：</p>
<ul>
<li><strong><code>&lt;router-link&gt;</code></strong> ：智能门把手，点击不刷新页面，只切换内容；</li>
<li><strong><code>&lt;router-view /&gt;</code></strong> ：魔法地板，当前该展示哪个房间，它就实时投影出来。</li>
</ul>
<p>虽然原始文件只写了 <code>HomeAbout</code>，但正确的写法应如上所示——让文字变成可交互的导航。</p>
<hr/>
<h3 data-id="heading-9">🗺️ 第六步：装上导航系统——配置 Vue Router</h3>
<p>路由，就像是你家里的<strong>智能导航系统</strong>。没有它，你只能待在客厅；有了它，你才能自由穿梭于各个房间。</p>
<p>我们在 <code>src/router/index.js</code> 中这样配置：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createRouter, createWebHashHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/Home.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/About.vue'</span>

<span class="hljs-keyword">const</span> routes = [
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Home'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">Home</span> },
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/about'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'About'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">About</span> }
]

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHashHistory</span>(),
  routes
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router
</code></pre>
<p>这段代码的意思是：</p>
<ul>
<li>当用户访问 <code>/</code>（也就是主页），就显示 <code>Home.vue</code> 这个房间；</li>
<li>当用户访问 <code>/about</code>，就带他去 <code>About.vue</code> 那个房间。</li>
</ul>
<p>注意这里用了 <code>createWebHashHistory()</code>，这意味着网址会变成 <code>http://localhost:5173/#/about</code>。那个 <code>#</code> 就像门牌号里的“分隔符”，告诉系统：“后面的部分是内部房间号，不是新地址”。</p>
<hr/>
<h3 data-id="heading-10">🛋️ 第七步：布置房间——编写页面组件</h3>
<p>现在，我们来装修两个房间。</p>
<h4 data-id="heading-11">首页（Home.vue）</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h4 data-id="heading-12">关于页（About.vue）</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>每个 <code>.vue</code> 文件都是一个自包含的“功能单元”：有自己的结构（template）、逻辑（script）和样式（style）。它们彼此隔离，却能通过路由无缝切换。</p>
<hr/>
<h3 data-id="heading-13">🎨 第八步：美化家园——全局样式 style.css</h3>
<p>虽然功能齐备，但房子还是灰扑扑的。这时候，<code>style.css</code> 就派上用场了。你可以在这里写：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Arial'</span>, sans-serif;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f5f5f5</span>;
}

<span class="hljs-selector-tag">nav</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
}
</code></pre>
<p>就像给墙壁刷漆、给地板打蜡，让整个家更温馨舒适。</p>
<hr/>
<h3 data-id="heading-14">▶️ 最后一步：启动你的 Vue 家园！</h3>
<p>现在，所有“装修材料”都已就位——地基打好了（Vite 项目）、大门装上了（<code>index.html</code>）、钥匙配好了（<code>main.js</code>）、客厅布置妥当（<code>App.vue</code>），连房间（<code>Home.vue</code>、<code>About.vue</code>）和导航系统（Vue Router）也都调试完毕。是时候打开电闸，点亮整栋房子了！</p>
<p>请在终端（命令行）中依次执行以下两条命令（确保你已在 <code>all-vue</code> 项目目录下）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 第一步：安装“住户手册”里列出的所有依赖（比如 Vue 和路由）</span>
npm install

<span class="hljs-comment"># 第二步：启动开发服务器——相当于按下“智能家居总开关”</span>
npm run dev
</code></pre>
<p>运行成功后，你会看到类似这样的提示：</p>
<pre><code class="hljs language-arduino" lang="arduino">  VITE v5<span class="hljs-number">.0</span><span class="hljs-number">.0</span>  ready in <span class="hljs-number">320</span> ms

  ➜  Local:   http:<span class="hljs-comment">//localhost:5173/</span>
  ➜  Network: use --host to expose
</code></pre>
<p>这时，只需打开浏览器，访问 <strong><a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A5173%2F" target="_blank" title="http://localhost:5173/" ref="nofollow noopener noreferrer">http://localhost:5173/</a></strong> （端口号可能略有不同），就能看到你的 Vue 小家啦！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/440dcba58617403380171870481fdee4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86bG85Z2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766808522&amp;x-signature=PS6EH4QoNScSUb1Hfyz%2Ff%2FzfYA0%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>点击 <strong>Home</strong>，客厅中央显示 “Home”；</li>
<li>点击 <strong>About</strong>，瞬间切换到 “About” 页面——<strong>全程无需刷新</strong>，就像在家自由走动一样丝滑。</li>
</ul>
<p>🎉 <strong>恭喜你！你不仅看懂了代码，还亲手让它跑起来了！</strong></p>
<p>这不再是一堆抽象的文件，而是一个真正能交互的 Web 应用。你已经完成了从“零”到“一”的飞跃——而这，正是所有伟大项目的起点。</p>
<hr/>
<h3 data-id="heading-15">🧩 总结：Vue 项目的“生活化”逻辑链</h3>
<p>让我们用一次智能家居入住体验来串起全过程：</p>
<ol>
<li><strong>Vite 是开发商</strong>：提供标准化精装修样板间；</li>
<li><strong>index.html 是入户门</strong>：设有智能插座（<code>#app</code>）和模块化接线口（<code>type="module"</code>）；</li>
<li><strong>main.js 是电子钥匙</strong>：插入后激活整套系统；</li>
<li><strong>App.vue 是中央控制台</strong>：集成导航与内容展示区；</li>
<li><strong>Vue Router 是室内导航图</strong>：定义各房间路径；</li>
<li><strong>Home.vue / About.vue 是功能房间</strong>：各自独立，按需进入；</li>
<li><strong>style.css 是全屋软装方案</strong>：统一视觉风格。</li>
</ol>
<h3 data-id="heading-16">✨ 写在最后：你已经站在 Vue 的门口</h3>
<p>这个 <code>all-vue</code> 项目虽小，却包含了现代 Vue 应用的核心骨架：<strong>组件化 + 路由 + 响应式 + 工程化构建</strong>。你不需要一开始就懂所有细节，就像学骑自行车，先扶稳车把，再慢慢蹬脚踏。</p>
<p>当你运行 <code>npm run dev</code>，看到浏览器里出现“Home”和“About”两个链接，并能自由切换时——恭喜你，你已经成功迈出了 Vue 开发的第一步！</p>
<p>接下来，你可以：</p>
<ul>
<li>在 Home 里加一张图片；</li>
<li>在 About 里写一段自我介绍；</li>
<li>用 CSS 让导航栏变彩色；</li>
<li>甚至添加第三个页面……</li>
</ul>
<p>编程不是魔法，而是一步步搭建的过程。而你，已经搭好了第一块积木。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android View框架概览]]></title>    <link>https://juejin.cn/post/7585382553290375204</link>    <guid>https://juejin.cn/post/7585382553290375204</guid>    <pubDate>2025-12-20T04:08:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290375204" data-draft-id="7585400495683616810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android View框架概览"/> <meta itemprop="keywords" content="Android,计算机图形学"/> <meta itemprop="datePublished" content="2025-12-20T04:08:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarShip"/> <meta itemprop="url" content="https://juejin.cn/user/3790771820172391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android View框架概览
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771820172391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarShip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:08:17.000Z" title="Sat Dec 20 2025 04:08:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、整体分层总览</h2>
<p>先看一个“从 App 到 系统服务 到 显示系统”的文字架构图：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[ 应用进程 App Process ]</span>
    ├─ Activity
    │    └─ Window (PhoneWindow)
    │         └─ DecorView (根 ViewGroup)
    │               └─ ViewGroup ... View 树
    ├─ ViewRootImpl   (桥梁：View世界 ↔ Window/Surface世界)
    ├─ WindowManager  (Framework 接口，实现在 app 进程)
    ├─ Handler / Looper (UI线程消息循环)
    ├─ Choreographer  (基于 VSync 调度绘制/动画)
    ├─ <span class="hljs-selector-tag">Canvas</span>         (绘图 API 抽象，底层由 Skia 实现)
    ├─ Skia / HWUI    (<span class="hljs-number">2</span>D 图形引擎，生成 GPU/CPU 绘制命令)
    ├─ OpenGL ES (或 Vulkan) (与 GPU 交互接口)
    └─ Surface / SurfaceView / TextureView (图形缓冲队列的“端口”)

<span class="hljs-selector-attr">[ System Server 进程 ]</span>
    ├─ WindowManagerService (WMS)
    │    └─ 管理 Window 的层级、位置、可见、焦点等
    └─ SurfaceFlinger (图形合成服务，不在此问题核心，略提)

<span class="hljs-selector-attr">[ 显示子系统 / HAL / 驱动 ]</span>
    ├─ Hardware Composer (HWC)
    ├─ Gralloc / GPU 驱动
    └─ 显示驱动 / 屏幕
</code></pre>
<p>记住一件事：Activity 只管“想显示什么 View 树”，真正的窗口、Surface 和显示，都是 Window / WMS / Surface / ViewRootImpl 在干活。</p>
<h2 data-id="heading-1">二、UI 树相关核心概念：Activity → Window → DecorView → ViewGroup / View</h2>
<ol>
<li>
<h3 data-id="heading-2">Activity</h3>
</li>
</ol>
<ul>
<li>
<p>职责：</p>
<ul>
<li>管理一个屏幕界面的生命周期：<code>onCreate</code> / <code>onStart</code> / <code>onResume</code> 等；</li>
<li>通过 <code>setContentView()</code> 指定要显示的布局（View 树）。</li>
</ul>
</li>
<li>
<p>关键点：Activity 本身 不直接持有视图树，而是通过 Window 来间接管理 UI。</p>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-3">Window &amp; WindowManager</h3>
</li>
</ol>
<ul>
<li>
<p>Window（通常是 PhoneWindow）</p>
<ul>
<li>
<p>Activity 调用 <code>getWindow()</code> 得到的就是它；</p>
</li>
<li>
<p>代表的是当前 Activity 的“窗口抽象”，负责管理：</p>
<ul>
<li>标题栏、状态栏占位、导航栏区域（需要时）；</li>
<li>内容视图（<code>setContentView()</code> 塞进去的 View 树）。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>WindowManager</p>
<ul>
<li>是一个 接口，应用通过它 添加/更新/删除 Window；</li>
<li>在应用进程中，<code>WindowManager</code> 的实现是 <code>WindowManagerImpl</code>；</li>
<li>内部最终会通过 Binder 跟系统进程的 WindowManagerService (WMS) 通信。</li>
</ul>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-4">DecorView</h3>
</li>
</ol>
<ul>
<li>
<p>DecorView 是 整个窗口的根 View，是一个 特殊的 ViewGroup：</p>
<ul>
<li>顶层是窗口装饰（状态栏占位、标题栏、ActionBar 等）；</li>
<li>中间是内容区域：<code>android.R.id.content</code> 对应的区域；</li>
<li>Activity 的 <code>setContentView(layout)</code> 实际上是把你的布局添加到 DecorView 的内容区域。</li>
</ul>
</li>
<li>
<p>结构示意：</p>
</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">DecorView (extends FrameLayout)
    ├─ StatusBar 占位（可选）
    ├─ TitleBar / Toolbar（可选）
    └─ contentParent (id=android.R.id.content)
          └─ 你的布局根 ViewGroup (LinearLayout / ConstraintLayout / ...)
                └─ 子 View / ViewGroup ...
</code></pre>
<ol start="4">
<li>
<h3 data-id="heading-5">View &amp; ViewGroup</h3>
</li>
</ol>
<ul>
<li>
<p>View</p>
<ul>
<li>
<p>UI 的最小单元：TextView、Button、ImageView 等都继承自它；</p>
</li>
<li>
<p>负责：</p>
<ul>
<li>测量：<code>onMeasure()</code>；</li>
<li>布局位置（由父布局决定）：<code>onLayout()</code>；</li>
<li>绘制：<code>onDraw(Canvas canvas)</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="5">
<li>
<h3 data-id="heading-6">ViewGroup</h3>
</li>
</ol>
<ul>
<li>
<p>继承自 View，是各种布局容器的基类（LinearLayout、RelativeLayout、ConstraintLayout 等）；</p>
</li>
<li>
<p>负责：</p>
<ul>
<li>管理子 View 的添加/删除；</li>
<li>在 <code>onLayout()</code> 中排列子 View</li>
</ul>
</li>
</ul>
<h2 data-id="heading-7">三、ViewRootImpl：Java View 世界 ↔ Window/Surface 世界的桥梁</h2>
<p>核心：ViewRootImpl 把 View 树绑定到一个 Window/Surface 上，并驱动 measure/layout/draw。</p>
<ol>
<li>
<h3 data-id="heading-8">ViewRootImpl 是谁创建的？</h3>
</li>
</ol>
<ul>
<li>
<p>当 Activity 第一次 <code>setContentView()</code>，并通过 <code>WindowManager.addView(DecorView, params)</code> 时：</p>
<ul>
<li><code>WindowManagerGlobal</code> 会为这个 DecorView 创建一个 ViewRootImpl 实例；</li>
<li>并把 DecorView 作为 ViewRootImpl 的“根 View”。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-9">ViewRootImpl 的职责</h3>
</li>
</ol>
<ul>
<li>
<p>接收来自 WMS 的回调（比如窗口尺寸改变、可见性改变等）；</p>
</li>
<li>
<p>在 UI 线程上驱动 View 树的三大流程：</p>
<ul>
<li>
<p><code>performTraversals()</code>：</p>
<ul>
<li><code>performMeasure()</code> → 根 View 的 <code>onMeasure()</code> 链；</li>
<li><code>performLayout()</code> → 根 View 的 <code>onLayout()</code> 链；</li>
<li><code>performDraw()</code> → 根 View 的 <code>draw()</code> 链。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>管理与 Surface 的绑定（通过 <code>SurfaceHolder</code>/<code>Surface</code>，与底层 BufferQueue 对接）；</p>
</li>
<li>
<p>把 <code>invalidate()</code> / <code>requestLayout()</code> 产生的重绘/重布局请求归一，在合适的 VSync 时机刷新。</p>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-10">ViewRootImpl、Window、WMS 的关系图</h3>
</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[ Activity ]</span>
    └─ <span class="hljs-selector-attr">[ Window (PhoneWindow) ]</span>
            └─ <span class="hljs-selector-attr">[ DecorView (根 ViewGroup) ]</span>

<span class="hljs-selector-attr">[ WindowManagerImpl ]</span>  (app 进程)
    └─ <span class="hljs-built_in">addView</span>(DecorView, params)
         └─ <span class="hljs-selector-attr">[ ViewRootImpl ]</span> ←→ <span class="hljs-selector-attr">[ WMS (系统进程) ]</span>
              └─ 持有 DecorView 作为 mView
              └─ 持有 Surface (mSurface)
              └─ 负责 measure/layout/draw
</code></pre>
<h2 data-id="heading-11">四、WindowManagerService（WMS）：系统级的窗口管理者</h2>
<ul>
<li>
<p>运行在 System Server 进程；</p>
</li>
<li>
<p>管理整个系统所有窗口（应用 Window、系统栏、Dialog 等）的：</p>
<ul>
<li>Z 轴顺序（谁在上谁在下）；</li>
<li>尺寸/位置/可见性；</li>
<li>焦点、输入事件目标窗口等。</li>
</ul>
</li>
<li>
<p><code>WindowManager</code>（应用侧）所有操作最终都会通过 Binder 调用 WMS，例如：</p>
<ul>
<li><code>addView(...)</code> → <code>WMS.addWindow(...)</code>；</li>
<li><code>updateViewLayout(...)</code> → <code>WMS.relayoutWindow(...)</code>；</li>
<li><code>removeView(...)</code> → <code>WMS.removeWindow(...)</code>。</li>
</ul>
</li>
<li>
<p>WMS 决定每个 Window 拥有一个什么样的 Surface（大小、格式等），然后通知对应的 ViewRootImpl 进行渲染。</p>
</li>
</ul>
<h2 data-id="heading-12">五、Surface / Canvas / SurfaceView：图像输出的“终端”</h2>
<ol>
<li>
<h3 data-id="heading-13">Surface：显示的“画布缓冲管道”--数据驱动，以画布数据为中心，承上启下了</h3>
</li>
</ol>
<ul>
<li>
<p>Surface 本质上是一个与底层 BufferQueue 绑定的对象：</p>
<ul>
<li>上层（应用 / RenderThread / SurfaceView 的绘制线程）作为 Producer 往里写图像；</li>
<li>下层（SurfaceFlinger）作为 Consumer 从中取图像做合成。</li>
</ul>
</li>
<li>
<p>每个窗口通常对应一个 Surface：</p>
<ul>
<li>ViewRootImpl 通过 <code>mSurface</code> 把 View 的绘制结果输出到这个 Surface。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-14">Canvas：提供给 View 使用的二维绘图接口</h3>
</li>
</ol>
<ul>
<li>
<p>在 <code>View#onDraw(Canvas canvas)</code> 里使用；</p>
</li>
<li>
<p>Canvas 底层其实是 调用 Skia：</p>
<ul>
<li>软件渲染：Skia 在 CPU 内存里画；</li>
<li>硬件加速：Skia 生成 GPU 绘图指令（最终通过 OpenGL ES/Vulkan 执行）。</li>
</ul>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-15">SurfaceView：一个“特殊的 View”，自己有独立 Surface</h3>
</li>
</ol>
<ul>
<li>
<p>普通 View：</p>
<ul>
<li>最终都绘制到所在窗口的 同一个 Surface；</li>
<li>先由 UI 渲染生成一个层，之后由 SurfaceFlinger 合成。</li>
</ul>
</li>
<li>
<p>SurfaceView：</p>
<ul>
<li>
<p>内部会创建一个 独立的 Surface（通常是直接由系统合成到屏幕，支持视频、游戏等高性能场景）；</p>
</li>
<li>
<p>其子 View 显示区域只是一个“洞”：</p>
<ul>
<li>Window 的主 Surface 挖一个透明区域；</li>
<li>SurfaceView 专用的 Surface 显示在这个洞里。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>特点：</p>
<ul>
<li>支持 单独的绘制线程（后台线程），不占用 UI 线程；</li>
<li>常用于：视频播放、相机预览、需要自定义渲染的游戏。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[ Window 的主 Surface ]</span>      <span class="hljs-selector-attr">[ SurfaceView 专用 Surface ]</span>
    ┌──────────────────┐       ┌──────────────────┐
    │ 其他普通 View 绘制 │       │   视频/游戏内容    │
    │   (UI 线程绘制)   │       │ (渲染线程绘制)     │
    │  <span class="hljs-selector-attr">[挖一个洞区域]</span>   │◀─────▶│ 对应屏幕某块区域   │
    └──────────────────┘       └──────────────────┘
</code></pre>
<h2 data-id="heading-16">六、消息、节奏与动画：Handler / Choreographer / VSync</h2>
<ol>
<li>
<h3 data-id="heading-17">Handler：UI 线程的消息驱动机制</h3>
</li>
</ol>
<ul>
<li>
<p>UI 线程有一个 Looper + MessageQueue：</p>
<ul>
<li>Handler 是发送/处理消息的工具；</li>
</ul>
</li>
<li>
<p>ViewRootImpl 的很多操作都是通过 Handler 投递到 UI 线程执行：</p>
<ul>
<li>比如 <code>requestLayout()</code> / <code>invalidate()</code> 最终会排队一个“重新测量/布局/绘制”的消息。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-18">Choreographer：基于 VSync 的统一调度器</h3>
</li>
</ol>
<ul>
<li>
<p>Choreographer 挂在 UI 线程上，使用 Handler 驱动；</p>
</li>
<li>
<p>每次屏幕发出一帧 VSync 信号 时：</p>
<ul>
<li>
<p>Choreographer 收到回调，在 同一个 frame 内按顺序触发：</p>
<ul>
<li>输入处理（Input）；</li>
<li>动画（Animation）；</li>
<li>View 树绘制（Traversal → ViewRootImpl#doTraversal）。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>作用：保证 UI 绘制和动画跟屏幕刷新同步，减少撕裂与抖动。</p>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-19">三者关系图（UI 线程上）：</h3>
</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[VSync 信号]</span> ──► <span class="hljs-selector-attr">[Choreographer#doFrame()]</span>
                      │
                      ├─ 处理输入事件
                      ├─ 计算动画 (ValueAnimator, ViewPropertyAnimator...)
                      └─ 调用 ViewRootImpl<span class="hljs-selector-class">.scheduleTraversals</span>()
                               │
                               └─ Handler<span class="hljs-selector-class">.post</span>(...) -&gt; <span class="hljs-built_in">doTraversal</span>()
                                       ├─ <span class="hljs-built_in">measure</span>()
                                       ├─ <span class="hljs-built_in">layout</span>()
                                       └─ <span class="hljs-built_in">draw</span>()  (生成绘制命令 / DisplayList)
</code></pre>
<h2 data-id="heading-20">七、Skia / OpenGL ES：View 的绘制到底是怎么画出来的？</h2>
<ol>
<li>
<h3 data-id="heading-21">Skia：2D 图形引擎</h3>
</li>
</ol>
<ul>
<li>
<p>Android 中 <code>Canvas</code> 的真正执行者；</p>
</li>
<li>
<p>提供：</p>
<ul>
<li>画线、画矩形、画圆、画文本；</li>
<li>画 Bitmap、裁剪、变换等；</li>
</ul>
</li>
<li>
<p>在 Android 的 硬件加速 UI 管线（HWUI） 中：</p>
<ul>
<li>Skia 不会直接在 CPU 内存画像素；</li>
<li>而是把绘制操作转换为 GPU 命令，交给 OpenGL ES/Vulkan 执行。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-22">OpenGL ES：与 GPU 对话的 API</h3>
</li>
</ol>
<ul>
<li>
<p>图形硬件标准接口；</p>
</li>
<li>
<p>在 Android 中：</p>
<ul>
<li>
<p>Skia 会调用 OpenGL ES，实现：</p>
<ul>
<li>几何变换（平移/缩放/旋转）；</li>
<li>纹理绘制（View 内容作为纹理贴在矩形上）；</li>
<li>alpha 混合、阴影、圆角等效果。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>GLSurfaceView / 游戏引擎 等也会直接使用 OpenGL ES 绘制自己的内容到 Surface。</p>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-23">View 绘制调用链（硬件加速时，简化版）</h3>
</li>
</ol>
<pre><code class="hljs language-scss" lang="scss">ViewRootImpl<span class="hljs-selector-class">.performDraw</span>()
    └─ DecorView<span class="hljs-selector-class">.draw</span>(canvas)
         └─ 各 View 的 <span class="hljs-built_in">onDraw</span>(canvas)
               └─ 调用 <span class="hljs-selector-tag">Canvas</span> API (drawRect/drawText/drawBitmap...)
                     └─ <span class="hljs-selector-tag">Canvas</span> → Skia
                           └─ Skia 生成 GPU 命令
                               └─ 通过 OpenGL ES / Vulkan 调用 GPU
                                   └─ GPU 在 Surface 对应的 buffer 中生成最终像素
</code></pre>
<h2 data-id="heading-24">八、综合关系大图（简化版）</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-attr">[ Activity ]</span>
    └─ 持有 <span class="hljs-selector-attr">[Window (PhoneWindow)]</span>
            └─ <span class="hljs-selector-attr">[DecorView: 根 ViewGroup]</span>
                    └─ <span class="hljs-selector-tag">ViewGroup</span> / <span class="hljs-selector-tag">View</span> 树
                          └─ <span class="hljs-selector-tag">onDraw</span>(Canvas) → <span class="hljs-selector-tag">Canvas</span> → <span class="hljs-selector-tag">Skia</span> → <span class="hljs-selector-tag">OpenGL</span> <span class="hljs-selector-tag">ES</span>

<span class="hljs-selector-attr">[ WindowManager ]</span>
    └─ <span class="hljs-selector-tag">addView</span>(DecorView, params)
          └─ 创建 <span class="hljs-selector-attr">[ViewRootImpl]</span>
                ├─ 持有 <span class="hljs-selector-tag">DecorView</span>
                ├─ 持有 <span class="hljs-selector-tag">Surface</span>
                ├─ 通过 <span class="hljs-selector-tag">Handler</span> 在 <span class="hljs-selector-tag">UI</span> 线程 <span class="hljs-selector-tag">scheduleTraversals</span>()
                └─ 和 <span class="hljs-selector-attr">[WMS]</span> 通信（窗口大小/位置/<span class="hljs-selector-tag">Surface</span> 等）

<span class="hljs-selector-attr">[ Handler / Looper / Choreographer ]</span>
    ├─ <span class="hljs-selector-tag">Looper</span> 负责 <span class="hljs-selector-tag">UI</span> 线程消息循环
    ├─ <span class="hljs-selector-tag">Handler</span> 投递 <span class="hljs-selector-tag">measure</span>/<span class="hljs-selector-tag">layout</span>/<span class="hljs-selector-tag">draw</span> 等消息
    └─ <span class="hljs-selector-tag">Choreographer</span> 使用 <span class="hljs-selector-tag">VSync</span> 回调统一驱动:
           <span class="hljs-selector-tag">Input</span> → <span class="hljs-selector-tag">Animation</span> → <span class="hljs-selector-tag">Traversal</span> (ViewRootImpl.doTraversal)

<span class="hljs-selector-attr">[ WMS (WindowManagerService) ]</span>
    └─ 管理所有 <span class="hljs-selector-tag">Window</span>
    └─ 为 <span class="hljs-selector-tag">Window</span> 分配 <span class="hljs-selector-tag">Surface</span>
    └─ 告诉 <span class="hljs-selector-tag">app</span> 端 <span class="hljs-selector-tag">ViewRootImpl</span> 窗口变化等信息

<span class="hljs-selector-attr">[ Surface / SurfaceView ]</span>
    ├─ <span class="hljs-selector-tag">Surface</span>: 与 <span class="hljs-selector-tag">BufferQueue</span> 相连，<span class="hljs-selector-tag">ViewRootImpl</span>/<span class="hljs-selector-tag">RenderThread</span> 渲染目标
    └─ <span class="hljs-selector-tag">SurfaceView</span>: 特殊 <span class="hljs-selector-tag">View</span>，自有 <span class="hljs-selector-tag">Surface</span>，可由单独线程/<span class="hljs-selector-tag">GL</span> 渲染

<span class="hljs-selector-attr">[ Skia / OpenGL ES ]</span>
    ├─ <span class="hljs-selector-tag">Skia</span>: <span class="hljs-selector-tag">Canvas</span> 的实现，生成绘制命令
    └─ <span class="hljs-selector-tag">OpenGL</span> <span class="hljs-selector-tag">ES</span>: 交给 <span class="hljs-selector-tag">GPU</span> 执行绘图，硬件加速路径
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 四大组件与 AMS 交互的完整对比]]></title>    <link>https://juejin.cn/post/7585463258690224137</link>    <guid>https://juejin.cn/post/7585463258690224137</guid>    <pubDate>2025-12-20T04:15:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463258690224137" data-draft-id="7585227038992269350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 四大组件与 AMS 交互的完整对比"/> <meta itemprop="keywords" content="面试"/> <meta itemprop="datePublished" content="2025-12-20T04:15:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="懒猫爱上鱼"/> <meta itemprop="url" content="https://juejin.cn/user/325111174151821"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 四大组件与 AMS 交互的完整对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/325111174151821/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    懒猫爱上鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:15:20.000Z" title="Sat Dec 20 2025 04:15:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>Android 系统通过 ActivityManagerService（AMS）统一管理四大组件的生命周期和交互。虽然都是通过 Binder 与 AMS 通信，但四大组件在交互方式、生命周期管理、进程优先级等方面存在显著差异。本文将分析这些差异，帮助开发者更好地理解 Android 系统架构。</p>
<h2 data-id="heading-1">四大组件与 AMS 交互对比表</h2>


















































<table><thead><tr><th>组件</th><th>启动/注册模式</th><th>AMS数据结构</th><th>生命周期管理</th><th>进程交互</th><th>优先级管理</th><th>主要特点</th></tr></thead><tbody><tr><td>Activity</td><td>显式/隐式 Intent</td><td>ActivityStack/Task/ActivityRecord</td><td>栈式管理，AMS 严格控制状态转换</td><td>强绑定，每个状态变化都通知 AMS</td><td>前台/可见进程，由任务栈位置决定</td><td>用户交互界面，AMS 管理窗口、输入焦点</td></tr><tr><td>Service</td><td>startService()/bindService()</td><td>ServiceRecord/ConnectionRecord</td><td>启动/绑定两套生命周期，AMS 协调进程优先级</td><td>启动/停止/绑定/解绑时交互</td><td>动态变化（前台/可见/服务进程）</td><td>后台执行，AMS 管理进程保活和绑定关系</td></tr><tr><td>BroadcastReceiver</td><td>静态注册/动态注册</td><td>BroadcastQueue/ReceiverList/BroadcastRecord</td><td>瞬时执行，无持久状态，AMS 管理分发队列</td><td>发送/接收时交互，执行完即结束</td><td>无独立优先级，依赖宿主进程</td><td>事件驱动，AMS 处理权限和有序分发</td></tr><tr><td>ContentProvider</td><td>自动发布</td><td>ProviderMap/ContentProviderRecord</td><td>持久存在，与应用进程同生命周期</td><td>查询/插入/更新/删除时交互</td><td>依赖宿主进程，但 AMS 管理访问权限</td><td>数据共享，AMS 路由 URI 和权限控制</td></tr></tbody></table>
<h2 data-id="heading-2">详细交互机制分析</h2>
<h3 data-id="heading-3">1. Activity 与 AMS 交互</h3>
<p><strong>核心交互流程</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 启动流程</span>
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">startActivity</span>(intent)  <span class="hljs-comment">// 启动请求</span>
<span class="hljs-variable constant_">AMS</span> → 应用进程: <span class="hljs-title function_">scheduleLaunchActivity</span>()  <span class="hljs-comment">// 调度启动</span>
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">activityPaused</span>()  <span class="hljs-comment">// 状态同步</span>
<span class="hljs-variable constant_">AMS</span> → 其他应用进程: <span class="hljs-title function_">schedulePauseActivity</span>()  <span class="hljs-comment">// 暂停其他Activity</span>
<span class="hljs-variable constant_">AMS</span> → 应用进程: <span class="hljs-title function_">scheduleResumeActivity</span>()  <span class="hljs-comment">// 恢复当前Activity</span>
</code></pre>
<p><strong>AMS 管理要点：</strong></p>
<ul>
<li>维护 ActivityStack 和 Task 的任务栈结构</li>
<li>控制 Back Stack 回退逻辑</li>
<li>管理 Activity 的启动模式（standard、singleTop 等）</li>
<li>处理多窗口模式下的可见性</li>
<li>协调 Activity 转场动画</li>
</ul>
<p><strong>进程优先级：</strong> Activity 所在进程优先级由其在任务栈中的位置决定：</p>
<ul>
<li>前台 Activity → 前台进程（adj=0）</li>
<li>可见但不在前台 → 可见进程（adj=100）</li>
<li>完全不可见 → 缓存进程（adj=900+）</li>
</ul>
<h3 data-id="heading-4">2. Service 与 AMS 交互</h3>
<p><strong>启动服务流程：</strong></p>
<pre><code class="hljs language-js" lang="js">应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">startService</span>(intent)
<span class="hljs-variable constant_">AMS</span> → 应用进程: <span class="hljs-title function_">scheduleCreateService</span>() → <span class="hljs-title function_">scheduleServiceArgs</span>()
<span class="hljs-comment">// 绑定服务流程</span>
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">bindService</span>(intent, conn, flags)
<span class="hljs-variable constant_">AMS</span> → 服务端进程: <span class="hljs-title function_">scheduleBindService</span>()
<span class="hljs-variable constant_">AMS</span> → 客户端进程: 返回 <span class="hljs-title class_">IBinder</span>
</code></pre>
<p><strong>AMS 管理要点：</strong></p>
<ul>
<li>维护 ServiceRecord 记录服务状态</li>
<li>管理 ConnectionRecord 绑定关系</li>
<li>控制服务进程的优先级</li>
<li>处理前台服务通知</li>
<li>协调跨进程服务绑定</li>
</ul>
<p><strong>进程优先级动态变化：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AMS 动态调整服务进程优先级</span>
<span class="hljs-keyword">if</span> (service.isForeground) {
    <span class="hljs-comment">// 前台服务，优先级最高</span>
    process.setAdj(ProcessList.FOREGROUND_APP_ADJ);  <span class="hljs-comment">// 0</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (process.hasVisibleActivities()) {
    <span class="hljs-comment">// 绑定到可见Activity，优先级较高</span>
    process.setAdj(ProcessList.VISIBLE_APP_ADJ);  <span class="hljs-comment">// 100</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (process.hasServices()) {
    <span class="hljs-comment">// 只有服务，无可见组件</span>
    process.setAdj(ProcessList.SERVICE_ADJ);  <span class="hljs-comment">// 500</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 无活跃组件，优先级最低</span>
    process.setAdj(ProcessList.CACHED_APP_MIN_ADJ);  <span class="hljs-comment">// 900+</span>
}
</code></pre>
<h3 data-id="heading-5">3. BroadcastReceiver 与 AMS 交互</h3>
<p><strong>注册和发送流程：</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 注册流程</span>
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">registerReceiver</span>(receiver, filter)
<span class="hljs-comment">// 发送流程</span>
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">sendBroadcast</span>(intent)
<span class="hljs-variable constant_">AMS</span> → 接收进程: <span class="hljs-title function_">scheduleReceiver</span>()  <span class="hljs-comment">// 异步分发</span>
<span class="hljs-comment">// 执行完成后</span>
接收进程 → <span class="hljs-attr">AMS</span>: 无回调，执行完即结束
</code></pre>
<p><strong>AMS 管理要点：</strong></p>
<ul>
<li>维护广播队列（有序/无序）</li>
<li>处理粘性广播缓存</li>
<li>检查发送和接收权限</li>
<li>控制广播超时</li>
<li>管理进程优先级临时提升</li>
</ul>
<p><strong>广播执行特点：</strong></p>
<ul>
<li>瞬时执行，无生命周期状态维护</li>
<li>AMS 不跟踪接收器执行状态</li>
<li>异步分发，可能延迟或丢弃</li>
<li>可并行执行多个无序广播</li>
</ul>
<h3 data-id="heading-6">4. ContentProvider 与 AMS 交互</h3>
<p><strong>发布和查询流程：</strong></p>
<pre><code class="hljs language-js" lang="js">/ 发布流程
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">publishContentProviders</span>(providers)
<span class="hljs-comment">// 查询流程</span>
客户端进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">getContentProvider</span>(name)
<span class="hljs-variable constant_">AMS</span> → 服务端进程: 无直接调用，返回已发布的<span class="hljs-title class_">Provider</span>接口
客户端进程 → 服务端进程: 直接调用<span class="hljs-title class_">IContentProvider</span>.<span class="hljs-title function_">query</span>()
</code></pre>
<p><strong>AMS 管理要点：</strong></p>
<ul>
<li>维护 ProviderMap 路由表</li>
<li>检查跨进程访问权限</li>
<li>管理 Provider 引用计数</li>
<li>处理 Provider 进程死亡</li>
<li>协调 URI 权限授权</li>
</ul>
<p><strong>数据共享模型：</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// AMS 中的Provider路由</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProviderMap</span> {
    <span class="hljs-comment">// authority → ContentProviderRecord</span>
    <span class="hljs-title class_">ArrayMap</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">ContentProviderRecord</span>&gt; mProvidersByName;
    <span class="hljs-comment">// component → ContentProviderRecord  </span>
    <span class="hljs-title class_">ArrayMap</span>&lt;<span class="hljs-title class_">ComponentName</span>, <span class="hljs-title class_">ContentProviderRecord</span>&gt; mProvidersByClass;
}

<span class="hljs-comment">// ContentProviderRecord</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ContentProviderRecord</span> {
    <span class="hljs-title class_">IContentProvider</span> provider;  <span class="hljs-comment">// 真正的Provider接口</span>
    <span class="hljs-title class_">ProcessRecord</span> app;          <span class="hljs-comment">// 所在进程</span>
    int externalProcessNo;      <span class="hljs-comment">// 外部进程引用计数</span>
    <span class="hljs-comment">// 当引用计数为0时，AMS可通知进程清理Provider</span>
}
</code></pre>
<h2 data-id="heading-7">跨进程通信差异</h2>
<h3 data-id="heading-8">1. Binder 通信频率</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Activity: 高频通信</span>
<span class="hljs-comment">// 每个生命周期变化都要通信</span>
<span class="hljs-title function_">onCreate</span>() ↔ <span class="hljs-title function_">onCreate</span>() 通知
<span class="hljs-title function_">onStart</span>()  ↔ <span class="hljs-title function_">onStart</span>() 通知  
<span class="hljs-title function_">onResume</span>() ↔ <span class="hljs-title function_">onResume</span>() 通知
<span class="hljs-title function_">onPause</span>()  ↔ <span class="hljs-title function_">onPause</span>() 通知
<span class="hljs-title function_">onStop</span>()   ↔ <span class="hljs-title function_">onStop</span>() 通知
<span class="hljs-title function_">onDestroy</span>()↔ <span class="hljs-title function_">onDestroy</span>() 通知

<span class="hljs-comment">// Service: 中频通信</span>
<span class="hljs-comment">// 启动/停止/绑定/解绑时通信</span>
<span class="hljs-title function_">onCreate</span>() ↔ 启动时通信
<span class="hljs-title function_">onStartCommand</span>() ↔ 每次启动通信
<span class="hljs-title function_">onBind</span>() ↔ 绑定时通信
<span class="hljs-title function_">onUnbind</span>() ↔ 解绑时通信

<span class="hljs-comment">// Broadcast: 低频通信</span>
<span class="hljs-comment">// 注册/发送时通信</span>
<span class="hljs-title function_">registerReceiver</span>() ↔ 注册时通信
<span class="hljs-title function_">sendBroadcast</span>() ↔ 发送时通信
<span class="hljs-comment">// onReceive() 执行无需回调AMS</span>

<span class="hljs-comment">// ContentProvider: 按需通信</span>
<span class="hljs-comment">// 获取Provider时通信一次</span>
<span class="hljs-title function_">getContentProvider</span>() ↔ 获取时通信
<span class="hljs-comment">// 后续操作直接与Provider进程通信</span>

</code></pre>
<h3 data-id="heading-9">2. 数据传输量</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Activity: 大量数据</span>
<span class="hljs-comment">// 传递整个ActivityRecord，包含Intent、Options等</span>
data.<span class="hljs-title function_">writeParcelable</span>(activityRecord);

<span class="hljs-comment">// Service: 中等数据  </span>
<span class="hljs-comment">// 传递Intent和启动参数</span>
data.<span class="hljs-title function_">writeParcelable</span>(service);
data.<span class="hljs-title function_">writeInt</span>(flags);
data.<span class="hljs-title function_">writeInt</span>(startId);

<span class="hljs-comment">// Broadcast: 小量数据</span>
<span class="hljs-comment">// 主要传递Intent</span>
data.<span class="hljs-title function_">writeParcelable</span>(intent);

<span class="hljs-comment">// ContentProvider: 变长数据</span>
<span class="hljs-comment">// 传递URI和查询参数</span>
data.<span class="hljs-title function_">writeParcelable</span>(uri);
data.<span class="hljs-title function_">writeStringArray</span>(projection);
data.<span class="hljs-title function_">writeString</span>(selection);
data.<span class="hljs-title function_">writeStringArray</span>(selectionArgs);

</code></pre>
<h2 data-id="heading-10">生命周期管理深度</h2>
<h3 data-id="heading-11">1. Activity 生命周期（AMS 完全控制）</h3>
<p>这个生命周期是没有设置configChanges参数。主要简单介绍一下AMS是如何参与到Activity的生命周期中的。设置了configChanges参数的有兴趣的可以单独搜索一下相关文档。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e23535642b09449584b9c9ac713780f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS54yr54ix5LiK6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766808919&amp;x-signature=LVjOadSv9XLB97Ih4n8A4rU%2Fqpc%3D" alt="Activity 生命周期.png" loading="lazy"/></p>
<h3 data-id="heading-12">2. Service 生命周期（AMS 部分控制）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 启动式服务</span>
<span class="hljs-attr">AMS</span>: 启动服务 → 应用: <span class="hljs-title function_">onCreate</span>() → <span class="hljs-title function_">onStartCommand</span>() → 运行
      ↓
<span class="hljs-attr">AMS</span>: 停止服务 → 应用: <span class="hljs-title function_">onDestroy</span>()

<span class="hljs-comment">// 绑定式服务  </span>
<span class="hljs-attr">AMS</span>: 绑定服务 → 应用: <span class="hljs-title function_">onCreate</span>() → <span class="hljs-title function_">onBind</span>() → 服务绑定
      ↓
<span class="hljs-attr">AMS</span>: 所有客户端解绑 → 应用: <span class="hljs-title function_">onUnbind</span>() → <span class="hljs-title function_">onDestroy</span>()
</code></pre>
<h3 data-id="heading-13">3. BroadcastReceiver 生命周期（AMS 不管理）</h3>
<pre><code class="hljs language-js" lang="js">/ <span class="hljs-variable constant_">AMS</span>只管理分发，不管理执行状态
<span class="hljs-attr">AMS</span>: 收到广播 → 查找接收器 → 分发到进程
应用进程: 创建<span class="hljs-title class_">Receiver</span>实例 → <span class="hljs-title function_">onReceive</span>() → 销毁实例
<span class="hljs-comment">// 执行完毕即结束，无状态跟踪</span>
</code></pre>
<h3 data-id="heading-14">4. ContentProvider 生命周期（与应用进程绑定）</h3>
<pre><code class="hljs language-js" lang="js">/ <span class="hljs-title class_">Provider</span>生命周期跟随应用进程
应用进程启动 → <span class="hljs-title function_">onCreate</span>() → 运行
      ↓
应用进程死亡 → <span class="hljs-title function_">onDestroy</span>()

<span class="hljs-comment">// AMS只管理Provider的发布和引用</span>
<span class="hljs-attr">AMS</span>: 发布<span class="hljs-title class_">Provider</span> → 增加引用 → 减少引用 → 通知清理

</code></pre>
<h2 data-id="heading-15">AMS 中的调度策略</h2>
<h3 data-id="heading-16">1. 优先级调度差异</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Activity调度：基于任务栈</span>
<span class="hljs-title class_">ActivityStack</span>.<span class="hljs-title function_">getNextActivityToResume</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 总是恢复栈顶Activity</span>
    <span class="hljs-keyword">return</span> mActivities.<span class="hljs-title function_">get</span>(mActivities.<span class="hljs-title function_">size</span>() - <span class="hljs-number">1</span>);
}

<span class="hljs-comment">// Service调度：基于进程状态</span>
<span class="hljs-title function_">updateServiceProcessLocked</span>(<span class="hljs-params">ServiceRecord sr</span>) {
    <span class="hljs-keyword">if</span> (sr.<span class="hljs-property">isForeground</span>) {
        <span class="hljs-comment">// 前台服务，保持进程存活</span>
        <span class="hljs-title function_">keepProcessAlive</span>(sr.<span class="hljs-property">app</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sr.<span class="hljs-property">bindings</span>.<span class="hljs-title function_">size</span>() &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 有绑定，适当保活</span>
        <span class="hljs-title function_">adjustProcessAdj</span>(sr.<span class="hljs-property">app</span>, <span class="hljs-title class_">ProcessList</span>.<span class="hljs-property">SERVICE_ADJ</span>);
    }
}

<span class="hljs-comment">// Broadcast调度：基于队列</span>
<span class="hljs-title class_">BroadcastQueue</span>.<span class="hljs-title function_">scheduleBroadcastsLocked</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 顺序处理队列中的广播</span>
    <span class="hljs-title function_">processNextBroadcast</span>(<span class="hljs-literal">true</span>);
}

<span class="hljs-comment">// ContentProvider调度：基于需求</span>
<span class="hljs-title function_">getContentProviderImpl</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-comment">// 按需启动Provider进程</span>
    <span class="hljs-keyword">if</span> (provider == <span class="hljs-literal">null</span>) {
        <span class="hljs-title function_">startProcessLocked</span>(cpr.<span class="hljs-property">processName</span>, ...);
    }
}

</code></pre>
<h3 data-id="heading-17">2. 内存管理策略</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 四大组件的内存回收优先级</span>
boolean <span class="hljs-title function_">shouldKillProcess</span>(<span class="hljs-params">ProcessRecord app</span>) {
    <span class="hljs-comment">// 计算进程重要性</span>
    int importance = <span class="hljs-title function_">calculateImportance</span>(app);
    
    <span class="hljs-comment">// 判断标准（简化）：</span>
    <span class="hljs-comment">// 1. 有前台Activity的进程最后杀</span>
    <span class="hljs-comment">// 2. 有可见Activity的进程次之</span>
    <span class="hljs-comment">// 3. 有前台Service的进程再次</span>
    <span class="hljs-comment">// 4. 有普通Service的进程</span>
    <span class="hljs-comment">// 5. 有缓存Provider的进程</span>
    <span class="hljs-comment">// 6. 只有BroadcastReceiver的进程最先杀</span>
    
    <span class="hljs-keyword">return</span> importance &lt; threshold;
}

</code></pre>
<h2 data-id="heading-18">总结</h2>
<p>四大组件与 AMS 的交互体现了 Android 系统的分层设计：</p>
<ol>
<li><strong>Activity​ - 用户界面层：</strong> AMS 严格管理，确保用户体验</li>
<li><strong>Service​ - 后台任务层：</strong> AMS 协调进程优先级，平衡性能</li>
<li><strong>BroadcastReceiver​ - 事件通信层：</strong> AMS 负责路由，解耦组件</li>
<li><strong>ContentProvider​ - 数据共享层：</strong> AMS 控制访问，保证安全</li>
</ol>
<p>关键区别在于：</p>
<ul>
<li><strong>控制粒度：</strong> Activity 最细，Broadcast 最粗</li>
<li><strong>状态管理：</strong> Activity 和 Service 有状态，Broadcast 无状态</li>
<li><strong>进程影响：</strong> Activity 和前台 Service 可提升进程优先级</li>
<li><strong>通信模式：</strong> Activity/Service 双向，Broadcast 单向，Provider 按需</li>
</ul>
<p>AMS 作为系统协调者，针对不同组件的特性采用不同的管理策略，确保系统高效、稳定运行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[macos系统]我用的是苹果电脑, 终端的shell是zsh,而不是bash, 那我在执行.sh文件的时候, 是bash xxx.sh还是zsh xxx.sh]]></title>    <link>https://juejin.cn/post/7585382553290391588</link>    <guid>https://juejin.cn/post/7585382553290391588</guid>    <pubDate>2025-12-20T04:18:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290391588" data-draft-id="7585400495683698730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[macos系统]我用的是苹果电脑, 终端的shell是zsh,而不是bash, 那我在执行.sh文件的时候, 是bash xxx.sh还是zsh xxx.sh"/> <meta itemprop="keywords" content="Shell"/> <meta itemprop="datePublished" content="2025-12-20T04:18:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="import_random"/> <meta itemprop="url" content="https://juejin.cn/user/2013961033882312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [macos系统]我用的是苹果电脑, 终端的shell是zsh,而不是bash, 那我在执行.sh文件的时候, 是bash xxx.sh还是zsh xxx.sh
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2013961033882312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    import_random
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:18:07.000Z" title="Sat Dec 20 2025 04:18:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 macOS 的 zsh 终端中执行 .sh 文件时，<strong>取决于你的需求和脚本的 shebang（第一行声明）</strong>。以下是几种情况和建议：</p>
<h2 data-id="heading-0">1. <strong>如果脚本有 shebang（推荐）</strong></h2>
<p>脚本第一行指定了解释器，例如：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
</code></pre>
<p>或</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/zsh</span>
</code></pre>
<p>可以直接执行：</p>
<pre><code class="hljs language-bash" lang="bash">./xxx.sh
</code></pre>
<p>系统会自动使用 shebang 指定的解释器。</p>
<h2 data-id="heading-1">2. <strong>如果想显式指定解释器</strong></h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 用 bash 执行</span>
bash xxx.sh

<span class="hljs-comment"># 用 zsh 执行</span>
zsh xxx.sh
</code></pre>
<h2 data-id="heading-2">3. <strong>重要区别</strong></h2>
<ul>
<li><strong>bash xxx.sh</strong>：强制使用 bash 解释器</li>
<li><strong>zsh xxx.sh</strong>：强制使用 zsh 解释器</li>
<li><strong>./xxx.sh</strong>：使用 shebang 指定的解释器（需要文件有执行权限）</li>
</ul>
<h2 data-id="heading-3">4. <strong>给脚本添加执行权限</strong></h2>
<p>如果经常执行，建议：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x xxx.sh
./xxx.sh
</code></pre>
<h2 data-id="heading-4">5. <strong>最佳实践</strong></h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 先检查脚本 shebang</span>
<span class="hljs-built_in">head</span> -1 xxx.sh

<span class="hljs-comment"># 如果有 shebang，确保有执行权限</span>
<span class="hljs-built_in">chmod</span> +x xxx.sh
./xxx.sh

<span class="hljs-comment"># 如果没有 shebang或想强制使用特定shell</span>
bash xxx.sh   <span class="hljs-comment"># 用 bash 执行</span>
zsh xxx.sh    <span class="hljs-comment"># 用 zsh 执行</span>
</code></pre>
<h2 data-id="heading-5">6. <strong>判断当前默认shell</strong></h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-variable">$SHELL</span>  <span class="hljs-comment"># 显示默认登录shell</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$0</span>      <span class="hljs-comment"># 显示当前使用的shell</span>
</code></pre>
<p><strong>简单建议</strong>：如果脚本是 bash 写的（多数情况），用 <code>bash xxx.sh</code>；如果是 zsh 写的，用 <code>zsh xxx.sh</code>。最好给脚本加上正确的 shebang。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[工程化工具类：模块化系统全解析与实践]]></title>    <link>https://juejin.cn/post/7585412203978227755</link>    <guid>https://juejin.cn/post/7585412203978227755</guid>    <pubDate>2025-12-20T05:11:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585412203978227755" data-draft-id="7585390679399071750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="工程化工具类：模块化系统全解析与实践"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-20T05:11:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="1024肥宅"/> <meta itemprop="url" content="https://juejin.cn/user/588993964030574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            工程化工具类：模块化系统全解析与实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993964030574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    1024肥宅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:11:39.000Z" title="Sat Dec 20 2025 05:11:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">引言</h4>
<p>在前端开发的演进历程中，模块化一直是工程化实践的核心。从早期的脚本标签堆砌到现代的ES Modules，模块化技术极大地提升了代码的可维护性、复用性和协作效率。本文将深入探讨模块化的各个方面，包括模块加载器实现、规范演化、Polyfill技术，并补充构建工具、性能优化等工程化实践，全面解析模块化在现代前端开发中的应用。</p>
<h4 data-id="heading-1">一、实现简单的模块加载器</h4>
<p>在理解复杂模块系统之前，我们先实现一个简单的模块加载器，了解其核心原理。</p>
<h5 data-id="heading-2">1.1 基础模块加载器实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简单的模块注册表</span>
<span class="hljs-keyword">const</span> moduleRegistry = {};
<span class="hljs-keyword">const</span> moduleCache = {};

<span class="hljs-comment">// 模块定义函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">define</span>(<span class="hljs-params">name, dependencies, factory</span>) {
  <span class="hljs-keyword">if</span> (!moduleRegistry[name]) {
    moduleRegistry[name] = {
      dependencies,
      factory,
      <span class="hljs-attr">resolved</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">exports</span>: <span class="hljs-literal">null</span>
    };
  }
}

<span class="hljs-comment">// 模块加载函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">require</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-comment">// 检查缓存</span>
  <span class="hljs-keyword">if</span> (moduleCache[name]) {
    <span class="hljs-keyword">return</span> moduleCache[name];
  }
  
  <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = moduleRegistry[name];
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Module <span class="hljs-subst">${name}</span> not found`</span>);
  }
  
  <span class="hljs-comment">// 解析依赖</span>
  <span class="hljs-keyword">const</span> resolvedDeps = <span class="hljs-variable language_">module</span>.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (dep === <span class="hljs-string">'exports'</span> || dep === <span class="hljs-string">'module'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 特殊处理</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">require</span>(dep);
  });
  
  <span class="hljs-comment">// 执行工厂函数获取模块导出</span>
  <span class="hljs-keyword">const</span> factoryResult = <span class="hljs-variable language_">module</span>.<span class="hljs-property">factory</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, resolvedDeps);
  
  <span class="hljs-comment">// 缓存模块导出</span>
  moduleCache[name] = factoryResult || {};
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">resolved</span> = <span class="hljs-literal">true</span>;
  
  <span class="hljs-keyword">return</span> moduleCache[name];
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-title function_">define</span>(<span class="hljs-string">'math'</span>, [], <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">add</span>: <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b,
    <span class="hljs-attr">multiply</span>: <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a * b
  };
});

<span class="hljs-title function_">define</span>(<span class="hljs-string">'calculator'</span>, [<span class="hljs-string">'math'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">math</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">calculate</span>: <span class="hljs-function">(<span class="hljs-params">x, y</span>) =&gt;</span> math.<span class="hljs-title function_">multiply</span>(math.<span class="hljs-title function_">add</span>(x, y), <span class="hljs-number">2</span>)
  };
});

<span class="hljs-comment">// 使用模块</span>
<span class="hljs-keyword">const</span> calculator = <span class="hljs-built_in">require</span>(<span class="hljs-string">'calculator'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(calculator.<span class="hljs-title function_">calculate</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)); <span class="hljs-comment">// 10</span>
</code></pre>
<h5 data-id="heading-3">1.2 异步模块加载器</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncModuleLoader</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }
  
  <span class="hljs-comment">// 定义模块</span>
  <span class="hljs-title function_">define</span>(<span class="hljs-params">name, deps, factory</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">set</span>(name, {
      deps,
      factory,
      <span class="hljs-attr">exports</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">resolved</span>: <span class="hljs-literal">false</span>
    });
  }
  
  <span class="hljs-comment">// 异步加载模块</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">require</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(name)?.<span class="hljs-property">resolved</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(name).<span class="hljs-property">exports</span>;
    }
    
    <span class="hljs-comment">// 防止重复加载</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span>.<span class="hljs-title function_">has</span>(name)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span>.<span class="hljs-title function_">get</span>(name);
    }
    
    <span class="hljs-comment">// 创建加载Promise</span>
    <span class="hljs-keyword">const</span> loadPromise = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_loadModule</span>(name);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span>.<span class="hljs-title function_">set</span>(name, loadPromise);
    
    <span class="hljs-keyword">return</span> loadPromise;
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">_loadModule</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(name);
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Module <span class="hljs-subst">${name}</span> not found`</span>);
    }
    
    <span class="hljs-comment">// 加载所有依赖</span>
    <span class="hljs-keyword">const</span> depPromises = <span class="hljs-variable language_">module</span>.<span class="hljs-property">deps</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-built_in">require</span>(dep));
    <span class="hljs-keyword">const</span> deps = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(depPromises);
    
    <span class="hljs-comment">// 执行工厂函数</span>
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">exports</span> = <span class="hljs-variable language_">module</span>.<span class="hljs-property">factory</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, deps);
    
    <span class="hljs-comment">// 更新模块状态</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-built_in">exports</span> || {};
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">resolved</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span>.<span class="hljs-title function_">delete</span>(name);
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncModuleLoader</span>();

loader.<span class="hljs-title function_">define</span>(<span class="hljs-string">'utils'</span>, [], <span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">format</span>: <span class="hljs-function"><span class="hljs-params">str</span> =&gt;</span> str.<span class="hljs-title function_">toUpperCase</span>()
}));

loader.<span class="hljs-title function_">define</span>(<span class="hljs-string">'app'</span>, [<span class="hljs-string">'utils'</span>], <span class="hljs-function">(<span class="hljs-params">utils</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">run</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utils.<span class="hljs-title function_">format</span>(<span class="hljs-string">'hello'</span>))
  };
});

loader.<span class="hljs-built_in">require</span>(<span class="hljs-string">'app'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> app.<span class="hljs-title function_">run</span>()); <span class="hljs-comment">// 输出: HELLO</span>
</code></pre>
<h4 data-id="heading-4">二、AMD规范实现</h4>
<p>AMD（Asynchronous Module Definition）规范是RequireJS推广的异步模块定义标准。</p>
<h5 data-id="heading-5">2.1 简化的AMD实现</h5>
<pre><code class="hljs language-javascript" lang="javascript">(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">global</span></span>) {
  <span class="hljs-comment">// 模块缓存</span>
  <span class="hljs-keyword">const</span> modules = {};
  <span class="hljs-keyword">const</span> inProgress = {};
  
  <span class="hljs-comment">// 定义函数</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">define</span>(<span class="hljs-params">id, dependencies, factory</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">arguments</span>.<span class="hljs-property">length</span> === <span class="hljs-number">2</span>) {
      factory = dependencies;
      dependencies = [];
    }
    
    modules[id] = {
      <span class="hljs-attr">id</span>: id,
      <span class="hljs-attr">dependencies</span>: dependencies,
      <span class="hljs-attr">factory</span>: factory,
      <span class="hljs-attr">exports</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">resolved</span>: <span class="hljs-literal">false</span>
    };
    
    <span class="hljs-comment">// 尝试解析模块</span>
    <span class="hljs-title function_">resolveModule</span>(id);
  }
  
  <span class="hljs-comment">// 依赖解析</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">resolveModule</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = modules[id];
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span> || <span class="hljs-variable language_">module</span>.<span class="hljs-property">resolved</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 检查依赖是否都可用</span>
    <span class="hljs-keyword">const</span> deps = <span class="hljs-variable language_">module</span>.<span class="hljs-property">dependencies</span>;
    <span class="hljs-keyword">const</span> missingDeps = deps.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> 
      !modules[dep] || !modules[dep].<span class="hljs-property">resolved</span>
    );
    
    <span class="hljs-keyword">if</span> (missingDeps.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// 所有依赖已就绪，执行工厂函数</span>
      <span class="hljs-title function_">executeModule</span>(id);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 等待依赖</span>
      missingDeps.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (!inProgress[dep]) {
          inProgress[dep] = [];
        }
        inProgress[dep].<span class="hljs-title function_">push</span>(id);
      });
    }
  }
  
  <span class="hljs-comment">// 执行模块</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">executeModule</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = modules[id];
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">resolved</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 获取依赖的exports</span>
    <span class="hljs-keyword">const</span> depExports = <span class="hljs-variable language_">module</span>.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (dep === <span class="hljs-string">'exports'</span>) <span class="hljs-keyword">return</span> {};
      <span class="hljs-keyword">if</span> (dep === <span class="hljs-string">'require'</span>) <span class="hljs-keyword">return</span> <span class="hljs-title function_">createRequire</span>();
      <span class="hljs-keyword">if</span> (dep === <span class="hljs-string">'module'</span>) <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: <span class="hljs-variable language_">module</span>.<span class="hljs-property">id</span>, <span class="hljs-attr">exports</span>: {} };
      <span class="hljs-keyword">return</span> modules[dep].<span class="hljs-property">exports</span>;
    });
    
    <span class="hljs-comment">// 执行工厂函数</span>
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">exports</span> = <span class="hljs-variable language_">module</span>.<span class="hljs-property">factory</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, depExports);
    
    <span class="hljs-comment">// 设置exports</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-built_in">exports</span> || 
      (depExports[<span class="hljs-variable language_">module</span>.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'exports'</span>)] || {});
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">resolved</span> = <span class="hljs-literal">true</span>;
    
    <span class="hljs-comment">// 通知等待此模块的其他模块</span>
    <span class="hljs-keyword">if</span> (inProgress[id]) {
      inProgress[id].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">dependentId</span> =&gt;</span> <span class="hljs-title function_">resolveModule</span>(dependentId));
      <span class="hljs-keyword">delete</span> inProgress[id];
    }
  }
  
  <span class="hljs-comment">// 创建require函数</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">createRequire</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">ids, callback</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> ids === <span class="hljs-string">'string'</span>) ids = [ids];
      
      <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(ids.<span class="hljs-title function_">map</span>(loadModule))
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">modules</span> =&gt;</span> {
          <span class="hljs-keyword">if</span> (callback) callback.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, modules);
        });
    };
  }
  
  <span class="hljs-comment">// 异步加载模块</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadModule</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (modules[id] &amp;&amp; modules[id].<span class="hljs-property">resolved</span>) {
        <span class="hljs-title function_">resolve</span>(modules[id].<span class="hljs-property">exports</span>);
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// 动态加载脚本</span>
      <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
      script.<span class="hljs-property">src</span> = id + <span class="hljs-string">'.js'</span>;
      script.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 等待模块解析</span>
        <span class="hljs-keyword">const</span> checkInterval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">if</span> (modules[id] &amp;&amp; modules[id].<span class="hljs-property">resolved</span>) {
            <span class="hljs-built_in">clearInterval</span>(checkInterval);
            <span class="hljs-title function_">resolve</span>(modules[id].<span class="hljs-property">exports</span>);
          }
        }, <span class="hljs-number">10</span>);
      };
      script.<span class="hljs-property">onerror</span> = reject;
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script);
    });
  }
  
  <span class="hljs-comment">// 暴露到全局</span>
  <span class="hljs-variable language_">global</span>.<span class="hljs-property">define</span> = define;
  <span class="hljs-variable language_">global</span>.<span class="hljs-property">require</span> = <span class="hljs-title function_">createRequire</span>();
  
})(<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> ? <span class="hljs-variable language_">window</span> : <span class="hljs-variable language_">global</span>);

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-title function_">define</span>(<span class="hljs-string">'math'</span>, [], <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">add</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-keyword">return</span> a + b; }
  };
});

<span class="hljs-title function_">define</span>(<span class="hljs-string">'app'</span>, [<span class="hljs-string">'math'</span>, <span class="hljs-string">'require'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">math, <span class="hljs-built_in">require</span></span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">calculate</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> math.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
    },
    <span class="hljs-attr">loadExtra</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-built_in">require</span>([<span class="hljs-string">'utils'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">utils</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Utils loaded'</span>);
      });
    }
  };
});

<span class="hljs-built_in">require</span>([<span class="hljs-string">'app'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">app</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(app.<span class="hljs-title function_">calculate</span>()); <span class="hljs-comment">// 3</span>
});
</code></pre>
<h4 data-id="heading-6">三、CMD规范实现</h4>
<p>CMD（Common Module Definition）规范由Sea.js推广，强调就近依赖。</p>
<h5 data-id="heading-7">3.1 简化的CMD实现</h5>
<pre><code class="hljs language-javascript" lang="javascript">(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">global</span></span>) {
  <span class="hljs-keyword">const</span> modules = {};
  <span class="hljs-keyword">const</span> factories = {};
  <span class="hljs-keyword">const</span> cache = {};
  
  <span class="hljs-comment">// 模块状态</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STATUS</span> = {
    <span class="hljs-attr">PENDING</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">LOADING</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">LOADED</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">EXECUTING</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">EXECUTED</span>: <span class="hljs-number">4</span>
  };
  
  <span class="hljs-comment">// 定义函数</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">define</span>(<span class="hljs-params">factory</span>) {
    <span class="hljs-comment">// 获取当前脚本</span>
    <span class="hljs-keyword">const</span> scripts = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">'script'</span>);
    <span class="hljs-keyword">const</span> currentScript = scripts[scripts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> id = currentScript.<span class="hljs-property">src</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\.js$/</span>, <span class="hljs-string">''</span>);
    
    factories[id] = factory;
    modules[id] = {
      <span class="hljs-attr">id</span>: id,
      <span class="hljs-attr">factory</span>: factory,
      <span class="hljs-attr">deps</span>: [],
      <span class="hljs-attr">exports</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">status</span>: <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">PENDING</span>,
      <span class="hljs-attr">callbacks</span>: []
    };
    
    <span class="hljs-comment">// 解析依赖</span>
    <span class="hljs-title function_">parseDependencies</span>(id);
  }
  
  <span class="hljs-comment">// 解析依赖</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">parseDependencies</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">const</span> factory = factories[id];
    <span class="hljs-keyword">if</span> (!factory) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> source = factory.<span class="hljs-title function_">toString</span>();
    <span class="hljs-keyword">const</span> requireRegex = <span class="hljs-regexp">/require\s*\(\s*['"]([^'"]+)['"]\s*\)/g</span>;
    <span class="hljs-keyword">const</span> deps = [];
    <span class="hljs-keyword">let</span> match;
    
    <span class="hljs-keyword">while</span> ((match = requireRegex.<span class="hljs-title function_">exec</span>(source)) !== <span class="hljs-literal">null</span>) {
      deps.<span class="hljs-title function_">push</span>(match[<span class="hljs-number">1</span>]);
    }
    
    modules[id].<span class="hljs-property">deps</span> = deps;
  }
  
  <span class="hljs-comment">// 异步加载模块</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">require</span>(<span class="hljs-params">id, callback</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = modules[id];
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span> &amp;&amp; <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> === <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTED</span>) {
      <span class="hljs-comment">// 模块已执行，直接返回</span>
      <span class="hljs-keyword">if</span> (callback) {
        <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>);
      }
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>;
    }
    
    <span class="hljs-comment">// 模块未加载，开始加载</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span> || <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> === <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">PENDING</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">loadModule</span>(id, callback);
    }
    
    <span class="hljs-comment">// 模块加载中，添加回调</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> &lt; <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTED</span>) {
      <span class="hljs-variable language_">module</span>.<span class="hljs-property">callbacks</span>.<span class="hljs-title function_">push</span>(callback);
    }
  }
  
  <span class="hljs-comment">// 加载模块</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadModule</span>(<span class="hljs-params">id, callback</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = modules[id] || (modules[id] = {
      <span class="hljs-attr">id</span>: id,
      <span class="hljs-attr">deps</span>: [],
      <span class="hljs-attr">exports</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">status</span>: <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">LOADING</span>,
      <span class="hljs-attr">callbacks</span>: callback ? [callback] : []
    });
    
    <span class="hljs-comment">// 创建script标签加载</span>
    <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
    script.<span class="hljs-property">src</span> = id + <span class="hljs-string">'.js'</span>;
    script.<span class="hljs-property">async</span> = <span class="hljs-literal">true</span>;
    
    script.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> = <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">LOADED</span>;
      <span class="hljs-title function_">executeModule</span>(id);
    };
    
    script.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to load module: <span class="hljs-subst">${id}</span>`</span>);
    };
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script);
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-comment">// 执行模块</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">executeModule</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = modules[id];
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span> || <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> &gt;= <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTING</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> = <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTING</span>;
    
    <span class="hljs-comment">// 收集依赖</span>
    <span class="hljs-keyword">const</span> deps = <span class="hljs-variable language_">module</span>.<span class="hljs-property">deps</span>;
    <span class="hljs-keyword">const</span> depValues = deps.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">depId</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> depModule = modules[depId];
      <span class="hljs-keyword">if</span> (depModule &amp;&amp; depModule.<span class="hljs-property">status</span> === <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTED</span>) {
        <span class="hljs-keyword">return</span> depModule.<span class="hljs-property">exports</span>;
      }
      <span class="hljs-comment">// 同步加载依赖（简化实现）</span>
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">require</span>(depId);
    });
    
    <span class="hljs-comment">// 执行工厂函数</span>
    <span class="hljs-keyword">const</span> factory = factories[id];
    <span class="hljs-keyword">if</span> (!factory) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Factory not found for module: <span class="hljs-subst">${id}</span>`</span>);
    }
    
    <span class="hljs-comment">// 提供require、exports、module参数</span>
    <span class="hljs-keyword">const</span> localRequire = <span class="hljs-keyword">function</span>(<span class="hljs-params">depId</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">require</span>(depId);
    };
    
    <span class="hljs-keyword">const</span> localExports = {};
    <span class="hljs-keyword">const</span> localModule = { <span class="hljs-attr">exports</span>: localExports };
    
    <span class="hljs-comment">// 执行</span>
    <span class="hljs-keyword">const</span> result = factory.<span class="hljs-title function_">call</span>(<span class="hljs-literal">null</span>, localRequire, localExports, localModule);
    
    <span class="hljs-comment">// 设置exports</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = localModule.<span class="hljs-property">exports</span> || result || localExports;
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> = <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTED</span>;
    
    <span class="hljs-comment">// 执行回调</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">callbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> <span class="hljs-title function_">cb</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>));
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">callbacks</span> = [];
  }
  
  <span class="hljs-comment">// 暴露全局</span>
  <span class="hljs-variable language_">global</span>.<span class="hljs-property">define</span> = define;
  <span class="hljs-variable language_">global</span>.<span class="hljs-property">require</span> = <span class="hljs-built_in">require</span>;
  
})(<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> ? <span class="hljs-variable language_">window</span> : <span class="hljs-variable language_">global</span>);

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-comment">// 文件: math.js</span>
<span class="hljs-title function_">define</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-built_in">require</span>, <span class="hljs-built_in">exports</span>, <span class="hljs-variable language_">module</span></span>) {
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
    <span class="hljs-attr">add</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) {
      <span class="hljs-keyword">return</span> a + b;
    }
  };
});

<span class="hljs-comment">// 文件: app.js</span>
<span class="hljs-title function_">define</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-built_in">require</span>, <span class="hljs-built_in">exports</span>, <span class="hljs-variable language_">module</span></span>) {
  <span class="hljs-keyword">var</span> math = <span class="hljs-built_in">require</span>(<span class="hljs-string">'math'</span>);
  
  <span class="hljs-built_in">exports</span>.<span class="hljs-property">calculate</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> math.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
  };
});

<span class="hljs-comment">// 主文件</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">'app'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">app</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(app.<span class="hljs-title function_">calculate</span>()); <span class="hljs-comment">// 3</span>
});
</code></pre>
<h4 data-id="heading-8">四、ES Module的简单Polyfill</h4>
<p>虽然现代浏览器支持ES Modules，但在某些场景下，我们仍需要Polyfill支持。</p>
<h5 data-id="heading-9">4.1 基础ESM Polyfill实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ES Module Polyfill</span>
(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> moduleMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  <span class="hljs-keyword">const</span> moduleCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  
  <span class="hljs-comment">// 拦截import语句（通过动态import实现）</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">importModule</span> = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">modulePath</span>) {
    <span class="hljs-comment">// 检查缓存</span>
    <span class="hljs-keyword">if</span> (moduleCache.<span class="hljs-title function_">has</span>(modulePath)) {
      <span class="hljs-keyword">return</span> moduleCache.<span class="hljs-title function_">get</span>(modulePath);
    }
    
    <span class="hljs-comment">// 加载模块代码</span>
    <span class="hljs-keyword">const</span> code = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchModule</span>(modulePath);
    
    <span class="hljs-comment">// 解析依赖</span>
    <span class="hljs-keyword">const</span> deps = <span class="hljs-title function_">extractDependencies</span>(code);
    
    <span class="hljs-comment">// 加载依赖</span>
    <span class="hljs-keyword">const</span> depPromises = deps.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> 
      importModule(<span class="hljs-title function_">resolvePath</span>(modulePath, dep))
    );
    <span class="hljs-keyword">const</span> dependencies = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(depPromises);
    
    <span class="hljs-comment">// 执行模块</span>
    <span class="hljs-keyword">const</span> moduleExports = {};
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = {
      <span class="hljs-attr">exports</span>: moduleExports
    };
    
    <span class="hljs-comment">// 创建包装函数</span>
    <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">createWrapper</span>(code, dependencies);
    <span class="hljs-title function_">wrapper</span>(
      moduleExports, <span class="hljs-comment">// exports</span>
      <span class="hljs-variable language_">module</span>,        <span class="hljs-comment">// module</span>
      modulePath     <span class="hljs-comment">// __filename（模拟）</span>
    );
    
    <span class="hljs-comment">// 缓存结果</span>
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">exports</span> = <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> === moduleExports ? 
      moduleExports : <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>;
    moduleCache.<span class="hljs-title function_">set</span>(modulePath, <span class="hljs-built_in">exports</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">exports</span>;
  };
  
  <span class="hljs-comment">// 提取依赖</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">extractDependencies</span>(<span class="hljs-params">code</span>) {
    <span class="hljs-keyword">const</span> importRegex = <span class="hljs-regexp">/import\s+.*?\s+from\s+['"](.*?)['"]/g</span>;
    <span class="hljs-keyword">const</span> dynamicImportRegex = <span class="hljs-regexp">/import\s*\(['"](.*?)['"]\)/g</span>;
    <span class="hljs-keyword">const</span> deps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
    
    <span class="hljs-keyword">let</span> match;
    <span class="hljs-keyword">while</span> ((match = importRegex.<span class="hljs-title function_">exec</span>(code)) !== <span class="hljs-literal">null</span>) {
      deps.<span class="hljs-title function_">add</span>(match[<span class="hljs-number">1</span>]);
    }
    
    <span class="hljs-comment">// 重置正则</span>
    importRegex.<span class="hljs-property">lastIndex</span> = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">while</span> ((match = dynamicImportRegex.<span class="hljs-title function_">exec</span>(code)) !== <span class="hljs-literal">null</span>) {
      deps.<span class="hljs-title function_">add</span>(match[<span class="hljs-number">1</span>]);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(deps);
  }
  
  <span class="hljs-comment">// 创建包装函数</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">createWrapper</span>(<span class="hljs-params">code, dependencies</span>) {
    <span class="hljs-keyword">const</span> wrapperCode = <span class="hljs-string">`
      (function(exports, module, __filename, __dirname) {
        // 注入依赖
        const [
          <span class="hljs-subst">${dependencies.map((_, i) =&gt; <span class="hljs-string">`__dep<span class="hljs-subst">${i}</span>`</span>).join(<span class="hljs-string">', '</span>)}</span>
        ] = arguments[4];
        
        <span class="hljs-subst">${code}</span>
        
        // 返回默认导出
        return module.exports &amp;&amp; module.exports.default ?
          module.exports.default : module.exports;
      })
    `</span>;
    
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">eval</span>(wrapperCode);
  }
  
  <span class="hljs-comment">// 解析路径</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">resolvePath</span>(<span class="hljs-params">basePath, targetPath</span>) {
    <span class="hljs-keyword">if</span> (targetPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'./'</span>) || targetPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'../'</span>)) {
      <span class="hljs-keyword">const</span> baseDir = basePath.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, basePath.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'/'</span>));
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(targetPath, baseDir + <span class="hljs-string">'/'</span>).<span class="hljs-property">pathname</span>;
    }
    <span class="hljs-keyword">return</span> targetPath;
  }
  
  <span class="hljs-comment">// 获取模块代码</span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchModule</span>(<span class="hljs-params">path</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(path);
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Failed to load module: <span class="hljs-subst">${path}</span>`</span>);
    }
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">text</span>();
  }
  
  <span class="hljs-comment">// 拦截script type="module"</span>
  <span class="hljs-title function_">interceptModuleScripts</span>();
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">interceptModuleScripts</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> originalCreateElement = <span class="hljs-variable language_">document</span>.<span class="hljs-property">createElement</span>;
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">createElement</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">tagName</span>) {
      <span class="hljs-keyword">const</span> element = originalCreateElement.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">document</span>, tagName);
      
      <span class="hljs-keyword">if</span> (tagName === <span class="hljs-string">'script'</span>) {
        <span class="hljs-keyword">const</span> originalSetAttribute = element.<span class="hljs-property">setAttribute</span>.<span class="hljs-title function_">bind</span>(element);
        
        element.<span class="hljs-property">setAttribute</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">name, value</span>) {
          <span class="hljs-title function_">originalSetAttribute</span>(name, value);
          
          <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'type'</span> &amp;&amp; value === <span class="hljs-string">'module'</span>) {
            <span class="hljs-comment">// 拦截模块脚本</span>
            <span class="hljs-keyword">const</span> src = element.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'src'</span>);
            <span class="hljs-keyword">if</span> (src) {
              element.<span class="hljs-property">type</span> = <span class="hljs-string">'text/javascript'</span>;
              importModule(src).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-keyword">if</span> (element.<span class="hljs-property">onload</span>) element.<span class="hljs-title function_">onload</span>();
              }).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
                <span class="hljs-keyword">if</span> (element.<span class="hljs-property">onerror</span>) element.<span class="hljs-title function_">onerror</span>(err);
              });
            }
          }
        };
      }
      
      <span class="hljs-keyword">return</span> element;
    };
  }
})();

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-comment">// 模块文件: utils.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">capitalize</span>(<span class="hljs-params">str</span>) {
  <span class="hljs-keyword">return</span> str.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">toUpperCase</span>() + str.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">${capitalize(name)}</span>!`</span>;
}

<span class="hljs-comment">// 主文件</span>
importModule(<span class="hljs-string">'./utils.js'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">utils</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utils.<span class="hljs-title function_">default</span>(<span class="hljs-string">'world'</span>)); <span class="hljs-comment">// Hello, World!</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utils.<span class="hljs-title function_">capitalize</span>(<span class="hljs-string">'test'</span>)); <span class="hljs-comment">// Test</span>
});
</code></pre>
<h5 data-id="heading-10">4.2 支持Tree Shaking的ESM Polyfill</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ESMCompat</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">usedExports</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
  }
  
  <span class="hljs-comment">// 注册模块</span>
  <span class="hljs-title function_">register</span>(<span class="hljs-params">name, code</span>) {
    <span class="hljs-keyword">const</span> ast = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parse</span>(code);
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">exports</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractExports</span>(ast);
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">set</span>(name, {
      code,
      ast,
      <span class="hljs-built_in">exports</span>,
      <span class="hljs-attr">used</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()
    });
  }
  
  <span class="hljs-comment">// 解析代码为AST（简化版）</span>
  <span class="hljs-title function_">parse</span>(<span class="hljs-params">code</span>) {
    <span class="hljs-comment">// 简化实现：实际应使用Babel等解析器</span>
    <span class="hljs-keyword">const</span> exportMatches = code.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/export\s+(const|let|var|function|class|default)\s+(\w+)/g</span>) || [];
    <span class="hljs-keyword">const</span> imports = code.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/import\s+\{([^}]+)\}\s+from\s+['"]([^'"]+)['"]/g</span>) || [];
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">exports</span>: exportMatches.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">match</span> =&gt;</span> ({
        <span class="hljs-attr">type</span>: match.<span class="hljs-title function_">split</span>(<span class="hljs-string">' '</span>)[<span class="hljs-number">1</span>],
        <span class="hljs-attr">name</span>: match.<span class="hljs-title function_">split</span>(<span class="hljs-string">' '</span>)[<span class="hljs-number">2</span>]
      })),
      <span class="hljs-attr">imports</span>: imports.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">match</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> parts = match.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/import\s+\{([^}]+)\}\s+from\s+['"]([^'"]+)['"]/</span>);
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">specifiers</span>: parts[<span class="hljs-number">1</span>].<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.<span class="hljs-title function_">trim</span>()),
          <span class="hljs-attr">source</span>: parts[<span class="hljs-number">2</span>]
        };
      })
    };
  }
  
  <span class="hljs-comment">// 提取导出</span>
  <span class="hljs-title function_">extractExports</span>(<span class="hljs-params">ast</span>) {
    <span class="hljs-keyword">return</span> ast.<span class="hljs-property">exports</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">exp</span> =&gt;</span> exp.<span class="hljs-property">name</span>);
  }
  
  <span class="hljs-comment">// 使用模块（标记使用的导出）</span>
  <span class="hljs-title function_">use</span>(<span class="hljs-params">name, ...<span class="hljs-built_in">exports</span></span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(name);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>) {
      <span class="hljs-built_in">exports</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">exp</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>.<span class="hljs-title function_">includes</span>(exp)) {
          <span class="hljs-variable language_">module</span>.<span class="hljs-property">used</span>.<span class="hljs-title function_">add</span>(exp);
        }
      });
    }
  }
  
  <span class="hljs-comment">// 生成优化后的代码</span>
  <span class="hljs-title function_">generateOptimized</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(name);
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    
    <span class="hljs-keyword">let</span> code = <span class="hljs-variable language_">module</span>.<span class="hljs-property">code</span>;
    
    <span class="hljs-comment">// 移除未使用的导出（简化实现）</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">exp</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span>.<span class="hljs-property">used</span>.<span class="hljs-title function_">has</span>(exp)) {
        <span class="hljs-keyword">const</span> regex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`export\\s+.*?\\b<span class="hljs-subst">${exp}</span>\\b[^;]*;`</span>, <span class="hljs-string">'g'</span>);
        code = code.<span class="hljs-title function_">replace</span>(regex, <span class="hljs-string">''</span>);
      }
    });
    
    <span class="hljs-keyword">return</span> code;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> compat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ESMCompat</span>();

compat.<span class="hljs-title function_">register</span>(<span class="hljs-string">'math'</span>, <span class="hljs-string">`
export const PI = 3.14159;
export function add(a, b) { return a + b; }
export function multiply(a, b) { return a * b; }
export function unusedFunction() { return 'unused'; }
`</span>);

<span class="hljs-comment">// 标记使用的导出</span>
compat.<span class="hljs-title function_">use</span>(<span class="hljs-string">'math'</span>, <span class="hljs-string">'PI'</span>, <span class="hljs-string">'add'</span>);

<span class="hljs-comment">// 生成优化代码</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(compat.<span class="hljs-title function_">generateOptimized</span>(<span class="hljs-string">'math'</span>));
<span class="hljs-comment">// 输出将只包含PI和add的导出</span>
</code></pre>
<h4 data-id="heading-11">五、模块化构建工具集成</h4>
<p>现代开发中，我们使用构建工具处理模块化。以下展示如何集成Webpack-like的简单打包器。</p>
<h5 data-id="heading-12">5.1 简易模块打包器</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> { parse } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/parser'</span>);
<span class="hljs-keyword">const</span> traverse = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/traverse'</span>).<span class="hljs-property">default</span>;
<span class="hljs-keyword">const</span> generate = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/generator'</span>).<span class="hljs-property">default</span>;
<span class="hljs-keyword">const</span> t = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/types'</span>);

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleBundler</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">entry</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">entry</span> = entry;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">moduleId</span> = <span class="hljs-number">0</span>;
  }
  
  <span class="hljs-comment">// 构建</span>
  <span class="hljs-title function_">build</span>(<span class="hljs-params">outputPath</span>) {
    <span class="hljs-keyword">const</span> entryModule = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collectDependencies</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">entry</span>);
    <span class="hljs-keyword">const</span> bundleCode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateBundle</span>(entryModule);
    
    fs.<span class="hljs-title function_">writeFileSync</span>(outputPath, bundleCode);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Bundle generated: <span class="hljs-subst">${outputPath}</span>`</span>);
  }
  
  <span class="hljs-comment">// 收集依赖</span>
  <span class="hljs-title function_">collectDependencies</span>(<span class="hljs-params">filePath</span>) {
    <span class="hljs-keyword">const</span> fileContent = fs.<span class="hljs-title function_">readFileSync</span>(filePath, <span class="hljs-string">'utf-8'</span>);
    <span class="hljs-keyword">const</span> ast = <span class="hljs-title function_">parse</span>(fileContent, {
      <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
      <span class="hljs-attr">plugins</span>: [<span class="hljs-string">'jsx'</span>]
    });
    
    <span class="hljs-keyword">const</span> dependencies = [];
    <span class="hljs-keyword">const</span> dirname = path.<span class="hljs-title function_">dirname</span>(filePath);
    
    <span class="hljs-comment">// 遍历AST收集import语句</span>
    <span class="hljs-title function_">traverse</span>(ast, {
      <span class="hljs-title class_">ImportDeclaration</span>: <span class="hljs-function">(<span class="hljs-params">{ node }</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> importPath = node.<span class="hljs-property">source</span>.<span class="hljs-property">value</span>;
        <span class="hljs-keyword">const</span> absolutePath = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePath</span>(importPath, dirname);
        dependencies.<span class="hljs-title function_">push</span>(absolutePath);
      },
      <span class="hljs-title class_">CallExpression</span>: <span class="hljs-function">(<span class="hljs-params">{ node }</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (node.<span class="hljs-property">callee</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'Import'</span>) {
          <span class="hljs-keyword">const</span> importPath = node.<span class="hljs-property">arguments</span>[<span class="hljs-number">0</span>].<span class="hljs-property">value</span>;
          <span class="hljs-keyword">const</span> absolutePath = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePath</span>(importPath, dirname);
          dependencies.<span class="hljs-title function_">push</span>(absolutePath);
        }
      }
    });
    
    <span class="hljs-keyword">const</span> moduleId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">moduleId</span>++;
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = {
      <span class="hljs-attr">id</span>: moduleId,
      filePath,
      <span class="hljs-attr">code</span>: fileContent,
      dependencies,
      <span class="hljs-attr">mapping</span>: {}
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">set</span>(filePath, <span class="hljs-variable language_">module</span>);
    
    <span class="hljs-comment">// 递归收集依赖</span>
    dependencies.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">has</span>(dep)) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collectDependencies</span>(dep);
      }
    });
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>;
  }
  
  <span class="hljs-comment">// 解析路径</span>
  <span class="hljs-title function_">resolvePath</span>(<span class="hljs-params">importPath, baseDir</span>) {
    <span class="hljs-keyword">if</span> (importPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'.'</span>)) {
      <span class="hljs-keyword">return</span> path.<span class="hljs-title function_">resolve</span>(baseDir, importPath);
    }
    <span class="hljs-comment">// 处理node_modules（简化）</span>
    <span class="hljs-keyword">const</span> nodeModulePath = path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'node_modules'</span>, importPath);
    <span class="hljs-keyword">if</span> (fs.<span class="hljs-title function_">existsSync</span>(nodeModulePath)) {
      <span class="hljs-keyword">return</span> nodeModulePath;
    }
    <span class="hljs-keyword">return</span> importPath;
  }
  
  <span class="hljs-comment">// 生成打包代码</span>
  <span class="hljs-title function_">generateBundle</span>(<span class="hljs-params">entryModule</span>) {
    <span class="hljs-keyword">const</span> modules = [];
    
    <span class="hljs-comment">// 创建模块映射</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> transformedCode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">transformModule</span>(<span class="hljs-variable language_">module</span>);
      modules.<span class="hljs-title function_">push</span>(<span class="hljs-string">`
        <span class="hljs-subst">${<span class="hljs-variable language_">module</span>.id}</span>: {
          factory: function(require, module, exports) {
            <span class="hljs-subst">${transformedCode}</span>
          },
          mapping: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-variable language_">module</span>.mapping)}</span>
        }
      `</span>);
    });
    
    <span class="hljs-comment">// 生成运行时</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">`
      (function(modules) {
        const moduleCache = {};
        
        function require(id) {
          if (moduleCache[id]) {
            return moduleCache[id].exports;
          }
          
          const mod = modules[id];
          const localRequire = function(modulePath) {
            return require(mod.mapping[modulePath]);
          };
          
          const module = { exports: {} };
          mod.factory(localRequire, module, module.exports);
          
          moduleCache[id] = module;
          return module.exports;
        }
        
        // 启动入口模块
        require(0);
      })({
        <span class="hljs-subst">${modules.join(<span class="hljs-string">',\n'</span>)}</span>
      });
    `</span>;
  }
  
  <span class="hljs-comment">// 转换模块代码</span>
  <span class="hljs-title function_">transformModule</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span></span>) {
    <span class="hljs-keyword">const</span> ast = <span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">code</span>, {
      <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>
    });
    
    <span class="hljs-comment">// 构建路径映射</span>
    <span class="hljs-keyword">let</span> importIndex = <span class="hljs-number">0</span>;
    
    <span class="hljs-title function_">traverse</span>(ast, {
      <span class="hljs-title class_">ImportDeclaration</span>: <span class="hljs-function">(<span class="hljs-params">{ node }</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> importPath = node.<span class="hljs-property">source</span>.<span class="hljs-property">value</span>;
        <span class="hljs-keyword">const</span> depModule = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePath</span>(importPath, path.<span class="hljs-title function_">dirname</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">filePath</span>))
        );
        
        <span class="hljs-keyword">if</span> (depModule) {
          <span class="hljs-keyword">const</span> importName = <span class="hljs-string">`__import_<span class="hljs-subst">${importIndex++}</span>`</span>;
          <span class="hljs-variable language_">module</span>.<span class="hljs-property">mapping</span>[importPath] = depModule.<span class="hljs-property">id</span>;
          
          <span class="hljs-comment">// 替换import语句</span>
          <span class="hljs-keyword">const</span> specifiers = node.<span class="hljs-property">specifiers</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">spec</span> =&gt;</span> {
            <span class="hljs-keyword">if</span> (t.<span class="hljs-title function_">isImportDefaultSpecifier</span>(spec)) {
              <span class="hljs-keyword">return</span> t.<span class="hljs-title function_">variableDeclarator</span>(
                spec.<span class="hljs-property">local</span>,
                t.<span class="hljs-title function_">memberExpression</span>(
                  t.<span class="hljs-title function_">identifier</span>(importName),
                  t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'default'</span>)
                )
              );
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">return</span> t.<span class="hljs-title function_">variableDeclarator</span>(
                spec.<span class="hljs-property">local</span>,
                t.<span class="hljs-title function_">memberExpression</span>(
                  t.<span class="hljs-title function_">identifier</span>(importName),
                  spec.<span class="hljs-property">imported</span> || spec.<span class="hljs-property">local</span>
                )
              );
            }
          });
          
          <span class="hljs-keyword">return</span> t.<span class="hljs-title function_">variableDeclaration</span>(<span class="hljs-string">'const'</span>, specifiers);
        }
      }
    });
    
    <span class="hljs-comment">// 移除export语句</span>
    <span class="hljs-title function_">traverse</span>(ast, {
      <span class="hljs-title class_">ExportNamedDeclaration</span>: <span class="hljs-function">(<span class="hljs-params">{ node, remove }</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (node.<span class="hljs-property">declaration</span>) {
          <span class="hljs-keyword">return</span> node.<span class="hljs-property">declaration</span>;
        }
        <span class="hljs-title function_">remove</span>();
      },
      <span class="hljs-title class_">ExportDefaultDeclaration</span>: <span class="hljs-function">(<span class="hljs-params">{ node }</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> t.<span class="hljs-title function_">expressionStatement</span>(
          t.<span class="hljs-title function_">assignmentExpression</span>(
            <span class="hljs-string">'='</span>,
            t.<span class="hljs-title function_">memberExpression</span>(
              t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'module'</span>),
              t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'exports'</span>)
            ),
            t.<span class="hljs-title function_">objectExpression</span>([
              t.<span class="hljs-title function_">objectProperty</span>(
                t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'default'</span>),
                node.<span class="hljs-property">declaration</span>
              )
            ])
          )
        );
      }
    });
    
    <span class="hljs-keyword">const</span> { code } = <span class="hljs-title function_">generate</span>(ast);
    <span class="hljs-keyword">return</span> code;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> bundler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleBundler</span>(<span class="hljs-string">'./src/index.js'</span>);
bundler.<span class="hljs-title function_">build</span>(<span class="hljs-string">'./dist/bundle.js'</span>);
</code></pre>
<h4 data-id="heading-13">六、模块联邦与微前端架构</h4>
<p>模块联邦（Module Federation）是Webpack 5引入的重要特性，支持跨应用共享模块。</p>
<h5 data-id="heading-14">6.1 简易模块联邦实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模块联邦管理器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ModuleFederation</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = config;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">remotes</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposes</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shared</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }
  
  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 初始化共享模块</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">shared</span>) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">shared</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[name, config]</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">shared</span>.<span class="hljs-title function_">set</span>(name, {
          <span class="hljs-attr">module</span>: <span class="hljs-built_in">require</span>(name),
          <span class="hljs-attr">version</span>: config.<span class="hljs-property">version</span>,
          <span class="hljs-attr">singleton</span>: config.<span class="hljs-property">singleton</span> || <span class="hljs-literal">false</span>
        });
      });
    }
    
    <span class="hljs-comment">// 初始化暴露模块</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">exposes</span>) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">exposes</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[name, modulePath]</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposes</span>.<span class="hljs-title function_">set</span>(name, <span class="hljs-built_in">require</span>(modulePath));
      });
    }
  }
  
  <span class="hljs-comment">// 注册远程应用</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">registerRemote</span>(<span class="hljs-params">name, url</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> remoteManifest = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchRemoteManifest</span>(url);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">remotes</span>.<span class="hljs-title function_">set</span>(name, {
        url,
        <span class="hljs-attr">manifest</span>: remoteManifest
      });
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Remote <span class="hljs-subst">${name}</span> registered`</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to register remote <span class="hljs-subst">${name}</span>:`</span>, error);
    }
  }
  
  <span class="hljs-comment">// 获取远程清单</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchRemoteManifest</span>(<span class="hljs-params">url</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${url}</span>/federation-manifest.json`</span>);
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
  }
  
  <span class="hljs-comment">// 获取模块</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getModule</span>(<span class="hljs-params">remoteName, moduleName</span>) {
    <span class="hljs-comment">// 检查共享模块</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shared</span>.<span class="hljs-title function_">has</span>(moduleName)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">shared</span>.<span class="hljs-title function_">get</span>(moduleName).<span class="hljs-property">module</span>;
    }
    
    <span class="hljs-comment">// 检查本地暴露</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">exposes</span>.<span class="hljs-title function_">has</span>(moduleName)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposes</span>.<span class="hljs-title function_">get</span>(moduleName);
    }
    
    <span class="hljs-comment">// 检查远程模块</span>
    <span class="hljs-keyword">const</span> remote = <span class="hljs-variable language_">this</span>.<span class="hljs-property">remotes</span>.<span class="hljs-title function_">get</span>(remoteName);
    <span class="hljs-keyword">if</span> (remote) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadRemoteModule</span>(remote, moduleName);
    }
    
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Module <span class="hljs-subst">${moduleName}</span> not found`</span>);
  }
  
  <span class="hljs-comment">// 加载远程模块</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadRemoteModule</span>(<span class="hljs-params">remote, moduleName</span>) {
    <span class="hljs-keyword">const</span> moduleUrl = <span class="hljs-string">`<span class="hljs-subst">${remote.url}</span>/<span class="hljs-subst">${moduleName}</span>.js`</span>;
    
    <span class="hljs-comment">// 动态加载脚本</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
      script.<span class="hljs-property">src</span> = moduleUrl;
      
      script.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 假设远程模块会暴露到全局</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-variable language_">window</span>[<span class="hljs-string">`<span class="hljs-subst">${remote.name}</span>_<span class="hljs-subst">${moduleName}</span>`</span>];
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>) {
          <span class="hljs-title function_">resolve</span>(<span class="hljs-variable language_">module</span>);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Module <span class="hljs-subst">${moduleName}</span> not found in remote`</span>));
        }
      };
      
      script.<span class="hljs-property">onerror</span> = reject;
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script);
    });
  }
  
  <span class="hljs-comment">// 暴露模块</span>
  <span class="hljs-title function_">expose</span>(<span class="hljs-params">name, <span class="hljs-variable language_">module</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposes</span>.<span class="hljs-title function_">set</span>(name, <span class="hljs-variable language_">module</span>);
    <span class="hljs-comment">// 暴露到全局（供远程访问）</span>
    <span class="hljs-variable language_">window</span>[<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.config.name}</span>_<span class="hljs-subst">${name}</span>`</span>] = <span class="hljs-variable language_">module</span>;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-comment">// App 1 配置</span>
<span class="hljs-keyword">const</span> federation1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleFederation</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'app1'</span>,
  <span class="hljs-attr">exposes</span>: {
    <span class="hljs-string">'./Button'</span>: <span class="hljs-string">'./src/components/Button.js'</span>
  },
  <span class="hljs-attr">shared</span>: {
    <span class="hljs-attr">react</span>: { <span class="hljs-attr">singleton</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">version</span>: <span class="hljs-string">'17.0.0'</span> },
    <span class="hljs-string">'react-dom'</span>: { <span class="hljs-attr">singleton</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">version</span>: <span class="hljs-string">'17.0.0'</span> }
  }
});

<span class="hljs-comment">// App 2 配置</span>
<span class="hljs-keyword">const</span> federation2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleFederation</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'app2'</span>,
  <span class="hljs-attr">remotes</span>: {
    <span class="hljs-attr">app1</span>: <span class="hljs-string">'http://localhost:3001'</span>
  },
  <span class="hljs-attr">shared</span>: {
    <span class="hljs-attr">react</span>: { <span class="hljs-attr">singleton</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">version</span>: <span class="hljs-string">'17.0.0'</span> }
  }
});

<span class="hljs-comment">// App2中使用App1的模块</span>
federation2.<span class="hljs-title function_">getModule</span>(<span class="hljs-string">'app1'</span>, <span class="hljs-string">'Button'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">Button</span> =&gt;</span> {
  <span class="hljs-comment">// 使用远程Button组件</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Remote Button loaded:'</span>, <span class="hljs-title class_">Button</span>);
});
</code></pre>
<h5 data-id="heading-15">七、模块化性能优化</h5>
<h5 data-id="heading-16">7.1 代码分割与懒加载</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CodeSplitter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chunks</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loadedChunks</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
  }
  
  <span class="hljs-comment">// 定义代码分割点</span>
  <span class="hljs-title function_">defineChunk</span>(<span class="hljs-params">name, getChunk</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chunks</span>.<span class="hljs-title function_">set</span>(name, getChunk);
  }
  
  <span class="hljs-comment">// 懒加载代码块</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadChunk</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">loadedChunks</span>.<span class="hljs-title function_">has</span>(name)) {
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-keyword">const</span> getChunk = <span class="hljs-variable language_">this</span>.<span class="hljs-property">chunks</span>.<span class="hljs-title function_">get</span>(name);
    <span class="hljs-keyword">if</span> (!getChunk) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Chunk <span class="hljs-subst">${name}</span> not found`</span>);
    }
    
    <span class="hljs-comment">// 标记为加载中</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loadedChunks</span>.<span class="hljs-title function_">add</span>(name);
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">getChunk</span>();
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Chunk <span class="hljs-subst">${name}</span> loaded`</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loadedChunks</span>.<span class="hljs-title function_">delete</span>(name);
      <span class="hljs-keyword">throw</span> error;
    }
  }
  
  <span class="hljs-comment">// 预加载代码块</span>
  <span class="hljs-title function_">preloadChunk</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">loadedChunks</span>.<span class="hljs-title function_">has</span>(name)) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> link = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'link'</span>);
    link.<span class="hljs-property">rel</span> = <span class="hljs-string">'preload'</span>;
    link.<span class="hljs-property">as</span> = <span class="hljs-string">'script'</span>;
    
    <span class="hljs-keyword">const</span> getChunk = <span class="hljs-variable language_">this</span>.<span class="hljs-property">chunks</span>.<span class="hljs-title function_">get</span>(name);
    <span class="hljs-keyword">if</span> (getChunk &amp;&amp; getChunk.<span class="hljs-property">chunkPath</span>) {
      link.<span class="hljs-property">href</span> = getChunk.<span class="hljs-property">chunkPath</span>;
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(link);
    }
  }
}

<span class="hljs-comment">// Webpack动态导入兼容</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">dynamicImport</span>(<span class="hljs-params">modulePath</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> __webpack_require__ !== <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-comment">// Webpack环境</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: "[request]" */</span> modulePath);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 原生环境</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">import</span>(modulePath);
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> splitter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodeSplitter</span>();

<span class="hljs-comment">// 定义代码块</span>
splitter.<span class="hljs-title function_">defineChunk</span>(<span class="hljs-string">'dashboard'</span>, <span class="hljs-function">() =&gt;</span> 
  <span class="hljs-title function_">dynamicImport</span>(<span class="hljs-string">'./Dashboard.js'</span>)
);

splitter.<span class="hljs-title function_">defineChunk</span>(<span class="hljs-string">'analytics'</span>, <span class="hljs-function">() =&gt;</span> 
  <span class="hljs-title function_">dynamicImport</span>(<span class="hljs-string">'./Analytics.js'</span>)
);

<span class="hljs-comment">// 路由懒加载</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadRoute</span>(<span class="hljs-params">routeName</span>) {
  <span class="hljs-keyword">switch</span> (routeName) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'dashboard'</span>:
      <span class="hljs-keyword">await</span> splitter.<span class="hljs-title function_">loadChunk</span>(<span class="hljs-string">'dashboard'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'analytics'</span>:
      <span class="hljs-keyword">await</span> splitter.<span class="hljs-title function_">loadChunk</span>(<span class="hljs-string">'analytics'</span>);
      <span class="hljs-keyword">break</span>;
  }
}

<span class="hljs-comment">// 预加载</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mouseover'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">target</span>.<span class="hljs-property">href</span> &amp;&amp; e.<span class="hljs-property">target</span>.<span class="hljs-property">href</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'dashboard'</span>)) {
    splitter.<span class="hljs-title function_">preloadChunk</span>(<span class="hljs-string">'dashboard'</span>);
  }
});
</code></pre>
<h5 data-id="heading-17">7.2 模块缓存策略</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModuleCache</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ttl</span> = <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>; <span class="hljs-comment">// 5分钟</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span> = <span class="hljs-number">100</span>; <span class="hljs-comment">// 最大缓存模块数</span>
  }
  
  <span class="hljs-comment">// 获取模块</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">key, fetchModule</span>) {
    <span class="hljs-keyword">const</span> cached = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">get</span>(key);
    
    <span class="hljs-comment">// 检查缓存是否有效</span>
    <span class="hljs-keyword">if</span> (cached &amp;&amp; <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - cached.<span class="hljs-property">timestamp</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">ttl</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Cache hit: <span class="hljs-subst">${key}</span>`</span>);
      <span class="hljs-keyword">return</span> cached.<span class="hljs-property">module</span>;
    }
    
    <span class="hljs-comment">// 缓存失效或不存在，重新获取</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Cache miss: <span class="hljs-subst">${key}</span>`</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchModule</span>();
    
    <span class="hljs-comment">// 更新缓存</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">set</span>(key, <span class="hljs-variable language_">module</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>;
  }
  
  <span class="hljs-comment">// 设置缓存</span>
  <span class="hljs-title function_">set</span>(<span class="hljs-params">key, <span class="hljs-variable language_">module</span></span>) {
    <span class="hljs-comment">// 清理过期缓存</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cleanup</span>();
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">set</span>(key, {
      <span class="hljs-variable language_">module</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    });
  }
  
  <span class="hljs-comment">// 清理缓存</span>
  <span class="hljs-title function_">cleanup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    
    <span class="hljs-comment">// 清理过期</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>) {
      <span class="hljs-keyword">if</span> (now - value.<span class="hljs-property">timestamp</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">ttl</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">delete</span>(key);
      }
    }
    
    <span class="hljs-comment">// 清理超出大小限制的（LRU策略）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">size</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span>) {
      <span class="hljs-keyword">const</span> entries = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">entries</span>());
      entries.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a[<span class="hljs-number">1</span>].<span class="hljs-property">timestamp</span> - b[<span class="hljs-number">1</span>].<span class="hljs-property">timestamp</span>);
      
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; entries.<span class="hljs-property">length</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">delete</span>(entries[i][<span class="hljs-number">0</span>]);
      }
    }
  }
  
  <span class="hljs-comment">// 清空缓存</span>
  <span class="hljs-title function_">clear</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">clear</span>();
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> moduleCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleCache</span>();

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadModuleWithCache</span>(<span class="hljs-params">modulePath</span>) {
  <span class="hljs-keyword">return</span> moduleCache.<span class="hljs-title function_">get</span>(modulePath, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(modulePath);
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">text</span>();
  });
}
</code></pre>
<h4 data-id="heading-18">八、模块化最佳实践与工程化</h4>
<h5 data-id="heading-19">8.1 模块设计原则</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 单一职责原则</span>
<span class="hljs-comment">// 不好的例子</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserManager</span> {
  <span class="hljs-comment">// 混合了用户管理、验证、通知等多个职责</span>
}

<span class="hljs-comment">// 好的例子</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span> {
  <span class="hljs-comment">// 只负责数据访问</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserValidator</span> {
  <span class="hljs-comment">// 只负责验证</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserNotifier</span> {
  <span class="hljs-comment">// 只负责通知</span>
}

<span class="hljs-comment">// 2. 依赖注入</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">userRepository, validator, notifier</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span> = userRepository;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">validator</span> = validator;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">notifier</span> = notifier;
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">user</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">validator</span>.<span class="hljs-title function_">validate</span>(user)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Invalid user'</span>);
    }
    
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">save</span>(user);
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">notifier</span>.<span class="hljs-title function_">sendWelcome</span>(user.<span class="hljs-property">email</span>);
  }
}

<span class="hljs-comment">// 3. 接口抽象</span>
<span class="hljs-comment">// 定义接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">IStorage</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">key, value</span>) {}
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) {}
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">key</span>) {}
}

<span class="hljs-comment">// 具体实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalStorage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">IStorage</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">key, value</span>) {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(key, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value));
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(key));
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(key);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">APIService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">storage</span>) {
    <span class="hljs-keyword">if</span> (!(storage <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">IStorage</span>)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Invalid storage implementation'</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span> = storage;
  }
}
</code></pre>
<h5 data-id="heading-20">8.2 模块版本管理与升级</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModuleVersionManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">versions</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deprecations</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }
  
  <span class="hljs-comment">// 注册模块版本</span>
  <span class="hljs-title function_">register</span>(<span class="hljs-params">moduleName, version, <span class="hljs-variable language_">module</span></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">versions</span>.<span class="hljs-title function_">has</span>(moduleName)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">versions</span>.<span class="hljs-title function_">set</span>(moduleName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>());
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">versions</span>.<span class="hljs-title function_">get</span>(moduleName).<span class="hljs-title function_">set</span>(version, <span class="hljs-variable language_">module</span>);
  }
  
  <span class="hljs-comment">// 获取模块（支持语义化版本）</span>
  <span class="hljs-title function_">get</span>(<span class="hljs-params">moduleName, versionRange = <span class="hljs-string">'latest'</span></span>) {
    <span class="hljs-keyword">const</span> moduleVersions = <span class="hljs-variable language_">this</span>.<span class="hljs-property">versions</span>.<span class="hljs-title function_">get</span>(moduleName);
    <span class="hljs-keyword">if</span> (!moduleVersions) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Module <span class="hljs-subst">${moduleName}</span> not found`</span>);
    }
    
    <span class="hljs-keyword">if</span> (versionRange === <span class="hljs-string">'latest'</span>) {
      <span class="hljs-keyword">const</span> latestVersion = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(moduleVersions.<span class="hljs-title function_">keys</span>())
        .<span class="hljs-title function_">sort</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">compareVersions</span>)
        .<span class="hljs-title function_">pop</span>();
      <span class="hljs-keyword">return</span> moduleVersions.<span class="hljs-title function_">get</span>(latestVersion);
    }
    
    <span class="hljs-comment">// 简化的版本范围解析</span>
    <span class="hljs-keyword">const</span> availableVersions = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(moduleVersions.<span class="hljs-title function_">keys</span>())
      .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">satisfiesVersion</span>(v, versionRange))
      .<span class="hljs-title function_">sort</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">compareVersions</span>);
    
    <span class="hljs-keyword">if</span> (availableVersions.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`No version of <span class="hljs-subst">${moduleName}</span> satisfies <span class="hljs-subst">${versionRange}</span>`</span>);
    }
    
    <span class="hljs-keyword">return</span> moduleVersions.<span class="hljs-title function_">get</span>(availableVersions.<span class="hljs-title function_">pop</span>());
  }
  
  <span class="hljs-comment">// 比较版本</span>
  <span class="hljs-title function_">compareVersions</span>(<span class="hljs-params">v1, v2</span>) {
    <span class="hljs-keyword">const</span> parts1 = v1.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>);
    <span class="hljs-keyword">const</span> parts2 = v2.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
      <span class="hljs-keyword">if</span> (parts1[i] !== parts2[i]) {
        <span class="hljs-keyword">return</span> parts1[i] - parts2[i];
      }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
  }
  
  <span class="hljs-comment">// 检查版本是否满足范围</span>
  <span class="hljs-title function_">satisfiesVersion</span>(<span class="hljs-params">version, range</span>) {
    <span class="hljs-comment">// 简化实现，实际应使用semver库</span>
    <span class="hljs-keyword">if</span> (range === <span class="hljs-string">'*'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    
    <span class="hljs-keyword">const</span> [op, versionRange] = range.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^([&gt;=&lt;~^]*)(\d+\.\d+\.\d+)$/</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> vParts = version.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>);
    <span class="hljs-keyword">const</span> rParts = versionRange.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>);
    
    <span class="hljs-keyword">switch</span> (op) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'^'</span>: <span class="hljs-comment">// 兼容版本</span>
        <span class="hljs-keyword">return</span> vParts[<span class="hljs-number">0</span>] === rParts[<span class="hljs-number">0</span>] &amp;&amp; vParts[<span class="hljs-number">1</span>] &gt;= rParts[<span class="hljs-number">1</span>];
      <span class="hljs-keyword">case</span> <span class="hljs-string">'~'</span>: <span class="hljs-comment">// 近似版本</span>
        <span class="hljs-keyword">return</span> vParts[<span class="hljs-number">0</span>] === rParts[<span class="hljs-number">0</span>] &amp;&amp; 
               vParts[<span class="hljs-number">1</span>] === rParts[<span class="hljs-number">1</span>] &amp;&amp; 
               vParts[<span class="hljs-number">2</span>] &gt;= rParts[<span class="hljs-number">2</span>];
      <span class="hljs-keyword">case</span> <span class="hljs-string">'&gt;='</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compareVersions</span>(version, versionRange) &gt;= <span class="hljs-number">0</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'&gt;'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compareVersions</span>(version, versionRange) &gt; <span class="hljs-number">0</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'&lt;='</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compareVersions</span>(version, versionRange) &lt;= <span class="hljs-number">0</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'&lt;'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compareVersions</span>(version, versionRange) &lt; <span class="hljs-number">0</span>;
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span> version === versionRange;
    }
  }
  
  <span class="hljs-comment">// 弃用通知</span>
  <span class="hljs-title function_">deprecate</span>(<span class="hljs-params">moduleName, version, message</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">deprecations</span>.<span class="hljs-title function_">has</span>(moduleName)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">deprecations</span>.<span class="hljs-title function_">set</span>(moduleName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>());
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deprecations</span>.<span class="hljs-title function_">get</span>(moduleName).<span class="hljs-title function_">set</span>(version, {
      message,
      <span class="hljs-attr">deprecatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
    });
    
    <span class="hljs-comment">// 添加控制台警告</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Module <span class="hljs-subst">${moduleName}</span>@<span class="hljs-subst">${version}</span> is deprecated: <span class="hljs-subst">${message}</span>`</span>);
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> versionManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleVersionManager</span>();

<span class="hljs-comment">// 注册不同版本</span>
versionManager.<span class="hljs-title function_">register</span>(<span class="hljs-string">'utils'</span>, <span class="hljs-string">'1.0.0'</span>, {
  <span class="hljs-attr">oldMethod</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'old'</span>
});

versionManager.<span class="hljs-title function_">register</span>(<span class="hljs-string">'utils'</span>, <span class="hljs-string">'1.1.0'</span>, {
  <span class="hljs-attr">oldMethod</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'old'</span>,
  <span class="hljs-attr">newMethod</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'new'</span>
});

versionManager.<span class="hljs-title function_">register</span>(<span class="hljs-string">'utils'</span>, <span class="hljs-string">'2.0.0'</span>, {
  <span class="hljs-attr">newMethod</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'new'</span>,
  <span class="hljs-attr">betterMethod</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'better'</span>
});

<span class="hljs-comment">// 标记弃用</span>
versionManager.<span class="hljs-title function_">deprecate</span>(<span class="hljs-string">'utils'</span>, <span class="hljs-string">'1.0.0'</span>, <span class="hljs-string">'请升级到1.1.0+版本'</span>);

<span class="hljs-comment">// 获取模块</span>
<span class="hljs-keyword">const</span> utilsV1 = versionManager.<span class="hljs-title function_">get</span>(<span class="hljs-string">'utils'</span>, <span class="hljs-string">'^1.0.0'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utilsV1); <span class="hljs-comment">// 1.1.0版本</span>

<span class="hljs-keyword">const</span> utilsLatest = versionManager.<span class="hljs-title function_">get</span>(<span class="hljs-string">'utils'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utilsLatest); <span class="hljs-comment">// 2.0.0版本</span>
</code></pre>
<h4 data-id="heading-21">总结</h4>
<p>模块化是现代前端工程化的基石，从前端的脚本标签到ES Modules，再到模块联邦等高级模式，模块化技术不断演进。本文从简单模块加载器实现开始，逐步深入AMD、CMD规范，探讨ES Module的Polyfill技术，并补充了构建工具集成、模块联邦、性能优化等工程化实践。</p>
<p><strong>关键要点总结:</strong></p>
<ol>
<li><strong>模块加载器核心原理:</strong> 依赖管理、缓存、异步加载</li>
<li><strong>规范演进:</strong> 从AMD/CMD到ES Modules的统一</li>
<li><strong>工程化实践:</strong> 代码分割、懒加载、版本管理、依赖注入</li>
<li><strong>未来趋势:</strong> 模块联邦、微前端架构、Web Assembly模块化</li>
</ol>
<p>模块化不仅仅是技术选择，更是一种设计哲学。良好的模块化设计能够提升代码的可维护性、可测试性和团队协作效率。在实际项目中，应根据团队规模、项目复杂度和技术栈选择合适的模块化方案，并不断优化模块边界和依赖关系。</p>
<p>随着前端技术的不断发展，模块化将继续演进，但核心原则——关注点分离、接口抽象、依赖管理——将始终保持不变。掌握模块化的核心原理和实践，能够帮助开发者构建更健壮、可维护的前端应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue2中能否实现输入中文自动转化为拼音, 且不带音调]]></title>    <link>https://juejin.cn/post/7585463258690420745</link>    <guid>https://juejin.cn/post/7585463258690420745</guid>    <pubDate>2025-12-20T04:55:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463258690420745" data-draft-id="7585382317444972554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue2中能否实现输入中文自动转化为拼音, 且不带音调"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-20T04:55:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户722786812344"/> <meta itemprop="url" content="https://juejin.cn/user/4100515739233513"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue2中能否实现输入中文自动转化为拼音, 且不带音调
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4100515739233513/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户722786812344
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:55:37.000Z" title="Sat Dec 20 2025 04:55:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>vue2中能否实现输入中文自动转化为拼音, 且不带音调。有以下几种方案</p>
<p>方案一：使用pinyin库（推荐）</p>
<p>1.安装依赖</p>
<pre><code class="hljs">npm install pinyin
</code></pre>
<p>2.在Vue组件中使用</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"chineseInput"</span> 
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入中文"</span>
      @<span class="hljs-attr">input</span>=<span class="hljs-string">"convertToPinyin"</span>
    /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>中文: {{ chineseInput }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>拼音: {{ pinyinOutput }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> pinyin <span class="hljs-keyword">from</span> <span class="hljs-string">'pinyin'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">chineseInput</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">pinyinOutput</span>: <span class="hljs-string">''</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">convertToPinyin</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 使用pinyin库转换，设置style为NORMAL去除音调</span>
      <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">pinyin</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">chineseInput</span>, {
        <span class="hljs-attr">style</span>: pinyin.<span class="hljs-property">STYLE_NORMAL</span>, <span class="hljs-comment">// 不带音调</span>
        <span class="hljs-attr">heteronym</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 不启用多音字模式</span>
      })
      
      <span class="hljs-comment">// 将二维数组转换为一维字符串</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pinyinOutput</span> = result.<span class="hljs-title function_">flat</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>)
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>方案二：自定义指令实现</p>
<p>1.创建自定义指令</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// directives/pinyin.js</span>
<span class="hljs-keyword">import</span> pinyin <span class="hljs-keyword">from</span> <span class="hljs-string">'pinyin'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> pinyinDirective = {
  <span class="hljs-title function_">bind</span>(<span class="hljs-params">el, binding, vnode</span>) {
    <span class="hljs-keyword">const</span> vm = vnode.<span class="hljs-property">context</span>
    <span class="hljs-keyword">const</span> expression = binding.<span class="hljs-property">expression</span>
    
    el.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">pinyin</span>(event.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>, {
        <span class="hljs-attr">style</span>: pinyin.<span class="hljs-property">STYLE_NORMAL</span>
      })
      
      <span class="hljs-keyword">const</span> pinyinText = result.<span class="hljs-title function_">flat</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>)
      
      <span class="hljs-comment">// 更新绑定的数据</span>
      vm[expression] = pinyinText
    })
  }
}

<span class="hljs-comment">// 在main.js中注册全局指令</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { pinyinDirective } <span class="hljs-keyword">from</span> <span class="hljs-string">'./directives/pinyin'</span>

<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">directive</span>(<span class="hljs-string">'pinyin'</span>, pinyinDirective)
</code></pre>
<p>2.在组件中使用指令</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"chineseText"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入中文"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-pinyin</span>=<span class="hljs-string">"pinyinText"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"这里显示拼音"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>拼音结果: {{ pinyinText }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>
export default {
### data(https://www.falvce.com/) {
    return {
      chineseText: '',
      pinyinText: ''
    }
  }
}
<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>方案三：使用计算属性</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"chineseInput"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入中文"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>拼音: {{ pinyinResult }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> pinyin <span class="hljs-keyword">from</span> <span class="hljs-string">'pinyin'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">chineseInput</span>: <span class="hljs-string">''</span>
    }
  },
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">pinyinResult</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">chineseInput</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
      
      <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">pinyin</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">chineseInput</span>, {
        <span class="hljs-attr">style</span>: pinyin.<span class="hljs-property">STYLE_NORMAL</span>
      })
      
      <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">flat</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>)
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>方案四：带防抖的优化版本</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"chineseInput"</span> 
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入中文"</span>
      @<span class="hljs-attr">input</span>=<span class="hljs-string">"debouncedConvertPinyin"</span>
    /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>拼音: {{ pinyinOutput }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> pinyin <span class="hljs-keyword">from</span> <span class="hljs-string">'pinyin'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params">https:<span class="hljs-comment">//www.falvce.com/) {</span>
    <span class="hljs-keyword">return</span> {
      chineseInput: <span class="hljs-string">''</span>,
      pinyinOutput: <span class="hljs-string">''</span>,
      timeout: <span class="hljs-literal">null</span>
    }
  },
  methods: {
    convertToPinyin() {
      <span class="hljs-keyword">const</span> result = pinyin(<span class="hljs-variable language_">this</span>.chineseInput, {
        style: pinyin.STYLE_NORMAL
      })
      <span class="hljs-variable language_">this</span>.pinyinOutput = result.flat().join(<span class="hljs-string">''</span>)
    },
    
    debouncedConvertPinyin() {
      // 防抖处理，避免频繁转换
      <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.timeout)
      <span class="hljs-variable language_">this</span>.timeout = <span class="hljs-built_in">setTimeout</span>(() =&gt; {
        <span class="hljs-variable language_">this</span>.convertToPinyin()
      }, <span class="hljs-number">300</span>)
    }
  },
  
  beforeDestroy() {
    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.timeout)
  }
}
</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>方案五：使用其他拼音库</p>
<p>如果不使用pinyin库，也可以使用考虑其他替代方案</p>
<p>使用tiny-pinyin</p>
<pre><code class="hljs">npm install tiny-pinyin
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { pinyin } <span class="hljs-keyword">from</span> <span class="hljs-string">'tiny-pinyin'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">convertToPinyin</span>(<span class="hljs-params">text</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">pinyin</span>(text, { <span class="hljs-attr">toneType</span>: <span class="hljs-string">'none'</span> }) <span class="hljs-comment">// 不带音调</span>
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>注意事项</p>
<ul>
<li>性能考虑：对于大量文本转换，建议使用防抖或节流</li>
<li>多音字处理：上述示例关闭了多音字模式，如需处理多音字需要额外逻辑</li>
<li>非中文字符：拼音库通常会保留非中文字符不变</li>
<li>空格处理：可根据需求决定是否保留空格</li>
<li>推荐使用方案一或方案三，它们实现简单且易于维护。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零手写一个 printf 函数：变参宏与默认参数提升]]></title>    <link>https://juejin.cn/post/7585446706326765577</link>    <guid>https://juejin.cn/post/7585446706326765577</guid>    <pubDate>2025-12-20T04:58:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706326765577" data-draft-id="7585382317444988938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零手写一个 printf 函数：变参宏与默认参数提升"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2025-12-20T04:58:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xlp666hub"/> <meta itemprop="url" content="https://juejin.cn/user/2965810860569131"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零手写一个 printf 函数：变参宏与默认参数提升
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2965810860569131/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xlp666hub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:58:51.000Z" title="Sat Dec 20 2025 04:58:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在学习 C 语言的过程中，<code>printf</code> 应该是我们打交道最多的函数了。但你是否思考过下面的问题：普通的函数参数个数都是<strong>固定</strong>的，为什么 <code>printf</code> 可以接受无限个参数？编译器又是怎么知道我们传了几个参数的？为什么 <code>%c</code> 明明是打印字符，底层却要按 <code>int</code> 类型来处理？</p>
<p>在这篇文章，我们就从零手写一个 <code>my_printf</code>，彻底弄懂 C 语言 <strong>变参函数</strong> 和 <strong>函数调用栈</strong> 的底层原理。</p>
<h2 data-id="heading-0">1. 核心原理</h2>
<h3 data-id="heading-1">1.1 编译器</h3>
<p>对于我们比较常见的普通函数，他们的<strong>参数类型和数量一般是固定</strong>的，像这样：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">func</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span>;
</code></pre>
<p>这种情况下，编译器在编译时非常清楚，调用这个函数需要传递 2 个 <code>int</code>。</p>
<p>我们再来看看<code>printf</code>函数的声明：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2c8cdbea42742f287599d6207bb0bd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811531&amp;x-signature=dZN5CQgMwCKeSzLt9Ea2ylcqDh4%3D" alt="1. printf声明.png" loading="lazy"/></p>
<h4 data-id="heading-2">1.1.1 restrict 的作用</h4>
<p>在进入咱们的正题之前，我们先需要了解一下图中的<code>restrict</code> 到底是起了什么作用。<code>restrict</code> 是 C99 标准引入的关键字，通俗一点来说，它的作用是告诉编译器：这个 <code>const char *</code> 指针是访问它所指向内存的<strong>唯一</strong>入口，除此之外，别无其他指针，从而使得编译器可以放心大胆地去优化代码。</p>
<p>仅仅这样语言描述一下，可能还是有点不够形象，为了帮助大家理解，我下面举个例子：</p>
<p>编译器在优化代码时，其实是非常保守的，因为它非常害怕<strong>两个不同的指针实际上指向同一块内存（指针别名）</strong> 。请看下面的代码：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> *a, <span class="hljs-type">int</span> *b, <span class="hljs-type">int</span> *val)</span> 
{
    *a += *val;
    *b += *val;
}
</code></pre>
<p>这个<code>add</code>函数接收三个<code>int *</code>类型的参数，分别是<code>a</code>，<code>b</code>，<code>val</code>，然后将<code>val</code>所指向内存的值分别加到<code>a</code>和<code>b</code>所指向内存中的值。</p>
<p>上面其实也提到了，编译器优化代码时是很<strong>保守</strong>的。我们来梳理一下这个过程，编译器在第一步会读取 <code>* val</code> 的值，然后加到 <code>* a</code>中去，第二步，再次读取 <code>* val</code> 的值，然后将读取到的 <code>* val</code>的值加到 <code>* b</code>中去。</p>
<p>可能有人这样想：第一步不是已经读取了 <code>* val</code> 的值了吗？为什么第二步还要再读取一遍呢？直接使用第一步读取到的值不行吗？</p>
<p>而编译器是这样想的：如果在传参数是 <code>a</code> 和 <code>val</code> 指向的是<strong>同一个地址</strong>怎么办？第一步的操作改变了 <code>* a</code> 的值，同时也改变了 <code>* val</code> 的值，如果还使用改变之前的 <code>* val</code> 的值，那计算不是出错了吗？因此，在编译器不能确保两个指针指向的不是同一块内存时，它在使用这块内存中的值之前都会去内存里面重新读取一下，以防计算发生错误。</p>
<p>而如果我们加上<code>restrict</code>，像下面这样：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">add_2</span><span class="hljs-params">(<span class="hljs-type">int</span> *a, <span class="hljs-type">int</span> *b, <span class="hljs-type">int</span> *<span class="hljs-keyword">restrict</span> val)</span> {
    *a += *val;
    *b += *val;
}
</code></pre>
<p>这就相当于告诉编译器，<code>* val</code> 的值绝对不会被 <code>a</code> 或 <code>b</code> 修改，这样编译器在第一次读取了 <code>* val</code> 的值后，第二步时直接就能使用，省得再回内存里面去查。这样也会带来相应的<strong>性能提升</strong>。</p>
<h4 data-id="heading-3">1.1.2 restrict 案例分析</h4>
<p>为了让大家能够更清晰地看到这个现象，我进行了下面的实验：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> *a, <span class="hljs-type">int</span> *b, <span class="hljs-type">int</span> *val)</span> 
{
    *a += *val;
    *b += *val;
}
​
<span class="hljs-type">void</span> <span class="hljs-title function_">add_2</span><span class="hljs-params">(<span class="hljs-type">int</span> *a, <span class="hljs-type">int</span> *b, <span class="hljs-type">int</span> *<span class="hljs-keyword">restrict</span> val)</span> 
{
    *a += *val;
    *b += *val;
}
​
</code></pre>
<p>这段代码<code>add</code>函数的 <code>val</code> 我没加<code>restrict</code>，而<code>add_2</code>函数我加了。然后可以使用下面的命令，将这段代码编译成汇编代码：</p>
<pre><code class="hljs language-bash" lang="bash">gcc -O2 -S demo.c -o demo.s
</code></pre>
<p><strong>-O2</strong>选项是开启编译器优化，<strong>-S</strong>是生成汇编代码。</p>
<p>下面是我截取的部分汇编代码：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8afde7b2d5c84d1ea2c8f1c6e900a3a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811531&amp;x-signature=uPoMSWWbo1QF9NopqA1jZAHPAmM%3D" alt="2. 汇编代码.png" loading="lazy"/></p>
<p>生成的汇编代码中，我们只需要看关键部分，对于<code>add</code>函数，我们需要看第 10-13 行，对于<code>add_2</code>函数，我们需要看 25-27 行。</p>
<p>在我使用的 64 位 Linux 系统中，<strong>函数参数是通过寄存器传递</strong>的，有<strong>固定的顺序</strong>。第一个参数 <code>a</code> 放在寄存器 <code>%rdi</code> 中，第二个参数 <code>b</code> 放在寄存器 <code>%rsi</code> 中，第三个参数 <code>val</code> 存放在寄存器 <code>%rdx</code> 中。而 <code>%eax</code> 是一个通用寄存器，用于临时存放数据。</p>
<p>在了解了一些必备的知识后，我们先来看函数<code>add</code>的关键部分。第10行，<code>movl (%rdx), %eax</code> ，去<code>val</code>指向的内存地址 <code>%rdx</code> ，把里面的数字取出来放到 <code>%eax</code> 中。第11行，<code>addl %eax, (%rdi)</code>，将 <code>%eax</code> 中的数加到<code>a</code>指向的内存地址 <code>%rdi</code> 中去。在看第12行，又去<code>val</code>指向的 <code>%rdx</code> ，把里面的值取出来放到 <code>%eax</code> 中，第13行，<code>addl %eax, (%rsi)</code>，把 <code>%eax</code> 中的数加到 <code>%rsi</code> 中去。在我们看来，第二次再去读 <code>* val</code> 的值是多此一举的，但是编译器害怕旧值被修改，就只能再去读一次，拿到最新的值。</p>
<p>再来看函数 <code>add_2</code> ，这里的<code>val</code>加了<code>restrict</code>关键字，我们看看情况是否有所不同。第25行依然是去<code>val</code>指向的内存，将值取出来放到 <code>%eax</code> 中，第26行将 <code>%eax</code> 中的值加到<code>a</code>所指向的内存地址 <code>%rdi</code> 中去。而到了第27行，它没有再去读一遍 <code>* val</code> 的值，而是直接使用旧的 <code>* val</code> 的值直接加到<code>b</code>指向的内存 <code>%rsi</code> 中去。</p>
<p>到这里相信大家已经很清晰了。<strong>内存是慢速设备，而寄存器速度是极快</strong>的，加上<code>restrict</code>关键词，我们节省了一次去内存读取的开销。</p>
<h4 data-id="heading-4">1.1.3 小结</h4>
<p>在了解了<code>restrict</code>之后，新的问题有浮出水面了。回过头去看<code>printf</code>函数的声明，编译器<strong>只能知道有一个固定参数</strong><code>format</code>，他不知道后面还有没有参数，更不知道后面参数是什么类型的。既然编译器不知道，那么<code>printf</code>是怎样正确的打印出内容的呢？答案藏在下一章的内容里面。</p>
<h3 data-id="heading-5">1.2 函数调用栈</h3>
<p>假如我们在32位系统下调用下面的代码：</p>
<pre><code class="hljs language-c" lang="c">my_printf(<span class="hljs-string">"Num:%d"</span>, <span class="hljs-number">100</span>);
</code></pre>
<p>此时，我们来看一下<strong>函数调用栈</strong>的布局：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc36a4b670a148bab85ab6f565721104~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811531&amp;x-signature=%2FA1s7OoajLA6UlPAknx4wUTBmBc%3D" alt="3. 栈帧.png" loading="lazy"/></p>
<p>注：现代 x64 或 ARM 架构通常优先使用寄存器传参（上面汇编的解释中提到过），但 <code>stdarg.h</code> 的封装让我们在逻辑上还是可以像操作栈一样去处理它们，核心思想是不变的。</p>
<p>首先，我们要知道，<strong>栈是从高地址向低地址生长的</strong>。可以仔细观察一下图中左边函数调用栈的布局，最上面的是之前的栈帧。</p>
<p>其次，我们还要知道，<strong>函数参数的入栈顺序是从右向左</strong>的。在我举的这个例子里面，<strong>最右边的参数100</strong> 先入栈，它紧贴着之前的栈帧，然后它左边的参数（也就是 “<code>Num:%d</code>” 的所在的地址）入栈，紧贴着参数100存放。最后函数的返回地址入栈。</p>
<p>理解了这张图，那一切就都明了了。虽然编译器<strong>只知道第一个固定参数</strong>，而不知道它后面有什么，但根据 C 语言的调用约定，<strong>变参一定紧紧挨着固定参数存放</strong>，并且位于更高的地址。</p>
<p>下面我们来顺一下整个流程，参数<code>format</code>的类型是<code>const char *</code>，也就是说它<strong>本身是一个指针</strong>，真正的字符串内容 “<code>Num:%d</code>” 存放在<strong>只读数据区(.rodata)</strong> ，在32为系统下它的大小是 <strong>4 个字节</strong>，而本身存放 <code>format</code> 的地址我们也是知道的。我们要做的，是拿到<code>format</code>变量本身在栈上的地址，然后加上<code>format</code>的大小，也就是4个字节，这样指针就跳过了<code>format</code>占据的地址，从而能够得到变参（100）的地址。同理，就算后面还有其他变参，我们也能通过<strong>地址偏移</strong>的方法找到他。</p>
<p>如果使用的是<strong>64位系统</strong>，那么<code>format</code>的大小就会改变为 8 个字节，但是原理还是这样的。</p>
<p>这也就是为什么编译器并不知道<code>format</code>后面的参数是什么，而<code>printf</code>却能正确打印出来的原因。</p>
<h3 data-id="heading-6">1.3 变参宏的本质</h3>
<p>理论上，我们确实可以手动通过 <code>(char*)&amp;format + 4</code> 来找到下一个参数。</p>
<p>这里先简要提一下为什么取<code>format</code>的地址后要转为<code>char *</code>类型，这就涉及到C语言中一个基础知识点——<strong>指针运算</strong>。在C语言中，<strong>指针加减的单位不是字节，而是它指向的数据类型的大小</strong>。我把指针转为<code>char *</code>类型，是为了能够让它以字节为单位移动。在转换类型之后，<code>(char*)&amp;format</code>的数据类型为<code>char *</code>，它指向的是<code>char</code>类型，长度为 1 个字节，所以<code>(char*)&amp;format + 4</code>，指针就会精确的移动4个字节，刚好跳过<code>format</code>变量。如果不转的话，<code>&amp;format</code> 的类型是 <code>char**</code>，它指向的是 <code>char*</code> (指针，在32位系统里面大小为 4 )，再给他加上 4 ，那么这个指针就会移动16个字节，已经错过了我们要找的变参。</p>
<p>但直接写<strong>硬编码</strong>的数字（+4）是<strong>非常危险</strong>的。因为在 64 位系统上它应该是 +8，在某些特殊架构上对齐方式可能更复杂。因此，为了解决跨平台问题，C 语言在 <code>&lt;stdarg.h&gt;</code> 中封装了一套<strong>标准宏</strong>。</p>
<p>为了弄懂这些宏执行的操作和我上面描述的是否一致，我查看了现代Linux环境下<code>&lt;stdarg.h&gt;</code>的源码。结果发现GCC的<code>&lt;stdarg.h&gt;</code>的实现如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2673290464e742919f497b9ec02e41e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811531&amp;x-signature=bDG0BsQcUVQI99ZeVbHGPCCTx2c%3D" alt="4. stdarg源码.png" loading="lazy"/></p>
<p>这里要简单补充一下，普通的头文件（如 <code>stdio.h</code>）通常由 C 标准库提供，放在 <code>/usr/include</code>。但 <code>stdarg.h</code> 非常特殊，它涉及参数传递的底层细节（如寄存器使用、栈帧布局），这些是<strong>依赖编译器实现</strong>的。因此，GCC 不会使用系统默认的 stdarg.h，而是会优先使用自己<strong>私有目录</strong>下的版本。</p>
<p>因此我们要使用下面的命令去查看：</p>
<pre><code class="hljs language-bash" lang="bash">vim $(gcc -print-file-name=include/stdarg.h)
</code></pre>
<p>为什么要使用这条命令呢？因为<code>gcc</code>安装目录版本众多，路径随版本变化，而这条命令能获得<code>gcc</code>实际使用的文件并使用<code>vim</code>编辑器打开它。</p>
<p>现在我们来看一下<code>&lt;stdarg.h&gt;</code>的源码，全是 <code>__builtin_</code> 开头的函数。这是因为现代 CPU 架构（如 x86-64）的参数传递非常复杂（<strong>优先使用寄存器，寄存器用完了才压栈</strong>），单纯的指针加减法已经无法搞定了。编译器为了极致的性能优化，选择把这些操作直接<strong>内置</strong>在编译器内部。</p>
<p>为了能够让大家看到实际的C语言实现，我翻出了 <strong>Linux 0.11 内核源码</strong> ，我把源码的内容直接放在下面的代码块中（注：原汁原味，我一点没改）：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _STDARG_H</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _STDARG_H</span>
​
<span class="hljs-keyword">typedef</span> <span class="hljs-type">char</span> *va_list;
​
<span class="hljs-comment">/* Amount of space required in an argument list for an arg of type TYPE.
   TYPE may alternatively be an expression whose type is used.  */</span>
​
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __va_rounded_size(TYPE)  \
  (((sizeof (TYPE) + sizeof (int) - 1) / sizeof (int)) * sizeof (int))</span>
​
<span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __sparc__</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> va_start(AP, LASTARG)                       \
 (AP = ((char *) &amp;(LASTARG) + __va_rounded_size (LASTARG)))</span>
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> va_start(AP, LASTARG)                       \
 (__builtin_saveregs (),                        \
  AP = ((char *) &amp;(LASTARG) + __va_rounded_size (LASTARG)))</span>
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
​
<span class="hljs-type">void</span> <span class="hljs-title function_">va_end</span> <span class="hljs-params">(va_list)</span>;      <span class="hljs-comment">/* Defined in gnulib */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> va_end(AP)</span>
​
<span class="hljs-meta">#<span class="hljs-keyword">define</span> va_arg(AP, TYPE)                        \
 (AP += __va_rounded_size (TYPE),                   \
  *((TYPE *) (AP - __va_rounded_size (TYPE))))</span>
​
<span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* _STDARG_H */</span></span>
</code></pre>
<p>源码第 9，10 行定义了一个宏 <code>__va_rounded_size</code>，这行代码看着复杂，其实只做一件事，就是<strong>向上取整到 int 的倍数</strong>。也就是说如果你传<code>char</code>，算出来是 4，如果你传<code>int</code>，算出来还是 4，如果你传<code>double</code>，算出来就是 8 。这也解释了为什么我们在手动推导时，默认步长是 4 的原因，本质上是<strong>为了保证栈上的内存对齐</strong>。</p>
<p>然后请看源码第 13 行，相信大家已经看到了<code>char *</code>强转，<code>&amp;LASTARG</code> 取出的是固定参数的地址，如果不转成 <code>char *</code>，指针加法会按照该类型的步长移动，转成 <code>char *</code> 后，加法就变成了<strong>字节级</strong>的移动。这也证实了<strong>必须要将指针转为单字节步长</strong>，才能精确跨过固定参数，指向<strong>变参</strong>的第一个元素。</p>
<p>再看源码第 24 行，这里的操作非常有意思，它利用了 C 语言的 <strong>逗号表达式</strong>：(A, B)。规则是：<strong>先执行 A，再执行 B，并且整个表达式的值等于 B 的值。</strong> 在逗号前，游标 AP 直接<strong>向前移动</strong>，跨过了当前这个参数，指向了<strong>下一个参数</strong>的起点。逗号后，用新的参数起始地址减去当前参数的大小，就是当前参数的起始地址，把这个地址强转为<code>TYPE *</code>，再解引用，最后拿到数据。最后<strong>这个宏的值就是拿到的数据</strong>。至于逗号后面为什么要强转为<code>TYPE *</code>然后再解引用，这是因为<strong>解引用后取出数据的长度是根据被解引用的这个东西的数据类型决定</strong>的，如果这个数据类型不是<code>TYPE *</code>，那么解引用取出的数据长度自然就不符合我们的预期。</p>
<h2 data-id="heading-7">2. 默认参数提升</h2>
<p>搞懂了底层的宏定义，我们终于可以开始写代码了。但在动手之前，必须先讲一个大家可能会<strong>踩的坑</strong>。</p>
<p>我们在实现 <code>my_printf</code> 处理 <code>%c</code>字符时，如果没有了解过这个细节，直觉上会这样写：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">char</span> c = va_arg(ap, <span class="hljs-type">char</span>);  <span class="hljs-comment">//错误写法</span>
</code></pre>
<p>这样写会导致指针偏移量出现错误，甚至读到乱码。</p>
<h3 data-id="heading-8">2.1 为什么不能直接取char</h3>
<p>不知道大家对我们 1.3 节中提到的<code>__va_rounded_size</code>这个宏还有印象吗。无论你传入的数据类型多小，栈上的槽位最小也是 <code>sizeof(int)</code>。在 C 语言的<strong>变参函数调用约定</strong>中，有一条<strong>默认参数提升</strong>规则：</p>
<p><strong>char、short</strong> 在入栈前会自动升级为 <strong>int</strong>。</p>
<p><strong>float</strong> 在入栈前会自动升级为 <strong>double</strong>。</p>
<h3 data-id="heading-9">2.2 原理分析</h3>
<p><strong>如果你写 <code>va_arg(ap, char)</code>：</strong> 宏计算出的步长是 <code>sizeof(char)</code> = 1 字节。游标 AP 只往后移了 1 个字节。但实际上，栈里那个字符占了 4 个字节。</p>
<p>结果就是<strong>指针错位</strong>，后面的<strong>所有参数读取全乱套</strong>。</p>
<p>那么怎样写才是正确的呢？既然编译器把 <code>char</code> 变成了 <code>int</code> 塞进栈里，那我们取的时候，也必须按 <code>int</code> 去取，然后再强转回来。想下面这样：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> val = va_arg(ap, <span class="hljs-type">int</span>);   <span class="hljs-comment">// 按照 int 的步长去栈里捞数据</span>
my_putchar((<span class="hljs-type">char</span>)val);   <span class="hljs-comment">// 强转回 char 使用</span>
</code></pre>
<h2 data-id="heading-10">3. 核心代码实现</h2>
<p>理论现在已经了解的差不多了，我们现在来直接使用系统调用<code>write</code>实现一个<code>my_printf</code>。</p>
<h3 data-id="heading-11">3.1 基础函数编写</h3>
<p><code>printf</code> 的核心难点在于<strong>把整数转换成字符串</strong>，例如把整数 123 变成字符数组 <code>{'1', '2', '3', '\0'}</code>。标准库有 <code>itoa</code>，但我们要自己写一个。请看下面代码：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdarg.h&gt;</span></span>
​
<span class="hljs-comment">//往屏幕写一个字符</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">my_putchar</span><span class="hljs-params">(<span class="hljs-type">char</span> c)</span> 
{
    write(<span class="hljs-number">1</span>, &amp;c, <span class="hljs-number">1</span>);
}
​
<span class="hljs-comment">//往屏幕写字符串</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">my_putstr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *str)</span> 
{
    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span>(str[i]) my_putchar(str[i++]);
}
​
<span class="hljs-comment">//将整数 value 转换为字符串并打印</span>
<span class="hljs-comment">//base表示 10 进制或 16 进制</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">my_itoa</span><span class="hljs-params">(<span class="hljs-type">int</span> value, <span class="hljs-type">int</span> base)</span> 
{
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">32</span>];
    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>, is_neg = <span class="hljs-number">0</span>;
​
    <span class="hljs-comment">// 0 是特殊情况，单独处理</span>
    <span class="hljs-keyword">if</span> (value == <span class="hljs-number">0</span>) 
    {
        my_putchar(<span class="hljs-string">'0'</span>);
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">//处理负数 (这里只处理十进制)</span>
    <span class="hljs-keyword">if</span> (value &lt; <span class="hljs-number">0</span> &amp;&amp; base == <span class="hljs-number">10</span>) 
    {
        is_neg = <span class="hljs-number">1</span>;
        value = -value;
    }
​
    <span class="hljs-comment">//循环取模，把 value 的各位数从后往前依次存在 buffer 中</span>
    <span class="hljs-keyword">while</span> (value != <span class="hljs-number">0</span>) 
    {
        <span class="hljs-type">int</span> rem = value % base;
        buffer[i++] = (rem &gt; <span class="hljs-number">9</span>) ? (rem - <span class="hljs-number">10</span>) + <span class="hljs-string">'a'</span> : rem + <span class="hljs-string">'0'</span>;<span class="hljs-comment">//如果是十六进制，要处理 a-f</span>
        value /= base;
    }
​
    <span class="hljs-comment">//如果是负数，给 buffer 最后再补个负号</span>
    <span class="hljs-keyword">if</span> (is_neg) buffer[i++] = <span class="hljs-string">'-'</span>;
​
    <span class="hljs-comment">//逆序打印，把 buffer 的内容从后往前依次打印</span>
    <span class="hljs-keyword">while</span> (i &gt; <span class="hljs-number">0</span>) my_putchar(buffer[--i]);
}
</code></pre>
<p>虽然上面的注释已经很完善了，但我还是想简单解释一下上面代码的实现。我们假设传进去的数字是 123 。</p>
<p>计算机不认识 123 这个整体，它只认识二进制。为了把它变成字符 '1', '2', '3'，我们需要从<strong>个位</strong>开始剥离，请结合<code>while</code>循环中的代码理解下面过程：</p>
<p><strong><code>value % base</code></strong>：拿到最后一位数字，例如 <code>123 % 10 = 3</code> 。</p>
<p>然后将它放在<code>buffer[0]</code>，然后 <code>i</code> 变成 1 。</p>
<p><strong><code>value / base</code></strong>：去掉最后一位，例如 <code>123 / 10 = 12</code> 。</p>
<p>就这样循环 3 次，<code>buffer[] = {3, 2, 1}</code>，这时 <code>i</code> 为 3 。</p>
<p>因为它不是负数，下一步就可以循环打印了。打印的时候，<code>i</code> 先减 1，变成 2 ，这时打印出<code>buffer[2]</code>也就是 1，依次类推，最终打印出 1，2，3 三个字符。</p>
<h3 data-id="heading-12">3.2 主要逻辑</h3>
<p>有了 <code>my_itoa</code> 和标准宏，我们就可以编写主函数逻辑了。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">my_printf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, ...)</span> 
{
    va_list ap;
    va_start(ap, format); <span class="hljs-comment">//初始化，让 ap 指向第一个变参</span>
​
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *p = format;
    <span class="hljs-keyword">while</span> (*p != <span class="hljs-string">'\0'</span>) 
    {
        <span class="hljs-keyword">if</span> (*p == <span class="hljs-string">'%'</span>) 
        {
            p++; <span class="hljs-comment">// 跳过 '%'</span>
            
            <span class="hljs-keyword">switch</span> (*p) 
            {
                <span class="hljs-keyword">case</span> <span class="hljs-string">'d'</span>: <span class="hljs-comment">// 十进制整数</span>
                { 
                    <span class="hljs-type">int</span> val = va_arg(ap, <span class="hljs-type">int</span>); <span class="hljs-comment">// 从栈里取出一个 int</span>
                    my_itoa(val, <span class="hljs-number">10</span>);          
                    <span class="hljs-keyword">break</span>;
                }
                <span class="hljs-keyword">case</span> <span class="hljs-string">'x'</span>: <span class="hljs-comment">// 十六进制整数</span>
                { 
                    <span class="hljs-type">int</span> val = va_arg(ap, <span class="hljs-type">int</span>);
                    my_putstr(<span class="hljs-string">"0x"</span>);           <span class="hljs-comment">// 加个前缀</span>
                    my_itoa(val, <span class="hljs-number">16</span>);
                    <span class="hljs-keyword">break</span>;
                }
                <span class="hljs-keyword">case</span> <span class="hljs-string">'c'</span>: <span class="hljs-comment">// 字符</span>
                { 
                    <span class="hljs-type">int</span> val = va_arg(ap, <span class="hljs-type">int</span>); 
                    my_putchar((<span class="hljs-type">char</span>)val);
                    <span class="hljs-keyword">break</span>;
                }
                <span class="hljs-keyword">case</span> <span class="hljs-string">'s'</span>: <span class="hljs-comment">// 字符串</span>
                { 
                    <span class="hljs-comment">// 字符串本质是 char* 指针，指针不需要提升</span>
                    <span class="hljs-type">char</span> *str = va_arg(ap, <span class="hljs-type">char</span>*);
                    my_putstr(str);
                    <span class="hljs-keyword">break</span>;
                }
                <span class="hljs-keyword">default</span>: <span class="hljs-comment">// 如果不是上面的几种，原样打印</span>
                    my_putchar(<span class="hljs-string">'%'</span>);<span class="hljs-comment">//记得先把跳过的那个 % 打印了</span>
                    my_putchar(*p);
                    <span class="hljs-keyword">break</span>;
            }
        } <span class="hljs-keyword">else</span> 
        {
            <span class="hljs-comment">// 普通字符</span>
            my_putchar(*p);
        }
        p++; <span class="hljs-comment">// 继续扫描下一个字符</span>
    }
​
    va_end(ap); <span class="hljs-comment">//将 ap 置空，防止野指针</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <span class="hljs-comment">//这里简化版返回 0，标准库通常返回打印的字符数</span>
}
</code></pre>
<p>这段代码的主要逻辑是：如果遇到普通字符，那就直接输出。如果遇到 <code>%</code>，暂停输出，查看下一个字符是什么再决定去栈里取什么数据。</p>
<p>理解了主要逻辑，我们再看一下几个关键细节：</p>
<pre><code class="hljs language-c" lang="c">va_start(ap, format);
</code></pre>
<p>执行完这句，指针 <code>ap</code> 就已经跳过了 <code>format</code> 字符串本身，停在了<strong>第一个变参</strong>的内存起始位置，准备随时被调用。</p>
<p>然后是<code>switch-case</code>逻辑，根据 <code>%</code> 后面的字母，决定<strong>用什么类型去取栈里的数据</strong>。如果是<code>%d</code>，调用 <code>va_arg(ap, int)</code>。编译器会生成指令，从当前栈位置复制 4 个字节，解释为 <code>int</code>，然后调用我们写好的 <code>my_itoa</code> 转成字符打印。如果是<code>%x</code>，逻辑和上面相同，但我手动打印了 <code>"0x"</code> 前缀，这样能与十进制有所区别。如果是 <code>%s</code> ，调用<code>va_arg(ap, char*)</code>。注意这里取出的只是一个<strong>指针</strong>，真正的字符串内容存储在常量区或堆区，我们把这个地址交给 <code>my_putstr</code> 去遍历打印。然后就是那个反直觉的 <code>%c</code> ，虽然我们要打印的是 <code>char</code>，但在 <code>va_arg</code> 里必须写 <code>int</code>，正如第二章所述，C 语言的<strong>默认参数提升</strong>规则，<code>char</code> 在入栈时已经被强转为 <code>int</code> 了，因此我们取的时候也要按照<code>int</code>来取。</p>
<p>最后<code>va_end(ap)</code>，调用它来将指针置空。</p>
<h2 data-id="heading-13">4. 测试与验证</h2>
<p>为了验证我们的 <code>my_printf</code> 是否经得起考验，我编写了一个 <code>main</code> 函数，覆盖了整数、十六进制、字符串，和最关键的<strong>字符提升</strong>。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> 
{
    my_putstr(<span class="hljs-string">"=== My Printf Test ===\n"</span>);
​
    my_printf(<span class="hljs-string">"Integer: %d\n"</span>, <span class="hljs-number">12345</span>);
    my_printf(<span class="hljs-string">"Negative: %d\n"</span>, <span class="hljs-number">-6789</span>);
    
    my_printf(<span class="hljs-string">"Hex: %x\n"</span>, <span class="hljs-number">255</span>); 
​
    my_printf(<span class="hljs-string">"String: %s\n"</span>, <span class="hljs-string">"Hello World"</span>);
​
    my_printf(<span class="hljs-string">"Char: %c\n"</span>, <span class="hljs-string">'A'</span>); 
​
    my_printf(<span class="hljs-string">"Mix: %d + %c = %s\n"</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">"Three"</span>);
​
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>运行结果如下，大家可以看到，各种类型都能正常打印。包括涉及到参数提升的<code>char</code>型，也能正常打印。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3713c1563d184b3d889fc1a3da08156a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811531&amp;x-signature=8y2WwYyxXCY6skeTKZ7J9rH41Qs%3D" alt="5. 运行结果.png" loading="lazy"/></p>
<h2 data-id="heading-14">5. 总结</h2>
<p>写到这里，我们的 <code>my_printf</code> 已经跑通了。但说实话，这不到 100 行的代码本身并不重要，毕竟在实际应用中，我们永远会去用标准库那个经过千锤百炼的 <code>printf</code>。</p>
<p>而<strong>这个手写 <code>printf</code> 真正的价值，在于它是我们探索底层原理的一个引导。</strong></p>
<p>通过这几章的分析，我们收获的不是一个粗糙的打印函数，而是对 C 语言运行机制的深刻理解。</p>
<p>我们亲手证明了 <code>&lt;stdarg.h&gt;</code> 里那些看似高深的宏，剥去它光鲜亮丽的外壳后，不过是<strong>朴实无华的指针加减法</strong>。</p>
<p>我们深刻体会到了<strong>默认参数提升</strong>的存在。这不是书本上的死记硬背，而是为了让 CPU 跑得更快、内存对齐更方便而设计的硬件妥协。</p>
<p>我们还知道参数在内存里是挨着放的，拿到一个参数就能顺藤摸瓜拿到其他的参数。</p>
<p>好了，这篇文章到这里就结束了。最后我还想说两句私房话，我真心希望这篇文章能帮助到大家，如果大家觉得看完这篇文章有所收获的话，并且你自己也愿意的话，希望你能留下一个关注，我在这里先说一声感谢，后面我还会再发这种能帮助大家深入理解底层原理的文章。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Tanstack Router 文件命名速查表]]></title>    <link>https://juejin.cn/post/7585382553290457124</link>    <guid>https://juejin.cn/post/7585382553290457124</guid>    <pubDate>2025-12-20T05:24:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290457124" data-draft-id="7585400495683797034" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Tanstack Router 文件命名速查表"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T05:24:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Tanstack Router 文件命名速查表
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:24:22.000Z" title="Sat Dec 20 2025 05:24:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">1. 基础与嵌套 (Basic Structure)</h4>








































<table><thead><tr><th><strong>符号 / 规则</strong></th><th><strong>作用</strong></th><th><strong>文件名示例</strong></th><th><strong>对应 URL / 效果</strong></th><th><strong>核心逻辑</strong></th></tr></thead><tbody><tr><td><strong><code>__root.tsx</code></strong></td><td><strong>根组件</strong></td><td><code>src/routes/__root.tsx</code></td><td><strong>全局</strong></td><td>整个应用的入口外壳 (HTML/Body)。</td></tr><tr><td><strong><code>.</code> (点)</strong></td><td><strong>嵌套层级</strong></td><td><code>blog.post.tsx</code></td><td><code>/blog/post</code></td><td>用点代替文件夹，扁平化写法。</td></tr><tr><td><strong><code>index</code></strong></td><td><strong>默认页</strong></td><td><code>posts.index.tsx</code></td><td><code>/posts</code></td><td>父级路径的“首页” (精确匹配时显示)。</td></tr><tr><td><strong><code>route.tsx</code></strong></td><td><strong>目录布局</strong></td><td><code>settings/route.tsx</code></td><td><code>/settings</code></td><td>等同于 <code>settings.tsx</code>，文件夹模式下的父级布局。</td></tr></tbody></table>
<h4 data-id="heading-1">2. 动态参数 (Dynamic Params)</h4>


























<table><thead><tr><th><strong>符号 / 规则</strong></th><th><strong>作用</strong></th><th><strong>文件名示例</strong></th><th><strong>对应 URL / 效果</strong></th><th><strong>核心逻辑</strong></th></tr></thead><tbody><tr><td><strong><code>$</code></strong></td><td><strong>变量/参数</strong></td><td><code>posts.$id.tsx</code></td><td><code>/posts/123</code><br/><br/>  <br/><br/><code>/posts/abc</code></td><td><code>$</code> 后的单词变为参数名 (如 <code>params.id</code>)。</td></tr><tr><td><strong><code>$</code> (单独)</strong></td><td><strong>通配符 (Splat)</strong></td><td><code>files.$.tsx</code></td><td><code>/files/a/b/c</code></td><td>贪婪匹配后面所有的路径片段。</td></tr></tbody></table>
<h4 data-id="heading-2">3. 布局与组织 (Layouts &amp; Organization)</h4>

































<table><thead><tr><th><strong>符号 / 规则</strong></th><th><strong>作用</strong></th><th><strong>文件名示例</strong></th><th><strong>对应 URL / 效果</strong></th><th><strong>核心逻辑</strong></th></tr></thead><tbody><tr><td><strong><code>_</code> (前缀)</strong></td><td><strong>无路径布局</strong></td><td><code>_auth.login.tsx</code></td><td><code>/login</code></td><td><strong>不</strong>影响 URL，只套用 <code>_auth.tsx</code> 的布局组件。</td></tr><tr><td><strong><code>(xxx)</code></strong></td><td><strong>路由组</strong></td><td><code>(app)/dashboard.tsx</code></td><td><code>/dashboard</code></td><td><strong>完全透明</strong>，仅用于文件夹分类 (如把管理端页面归类)。</td></tr><tr><td><strong><code>-</code> (前缀)</strong></td><td><strong>忽略文件</strong></td><td><code>-components/Nav.tsx</code></td><td>(无)</td><td><strong>不</strong>生成路由，可放组件、工具函数等。</td></tr></tbody></table>
<h4 data-id="heading-3">4. 特殊处理 (Advanced)</h4>


























<table><thead><tr><th><strong>符号 / 规则</strong></th><th><strong>作用</strong></th><th><strong>文件名示例</strong></th><th><strong>对应 URL / 效果</strong></th><th><strong>核心逻辑</strong></th></tr></thead><tbody><tr><td><strong><code>_</code> (后缀)</strong></td><td><strong>非嵌套路由</strong></td><td><code>posts_.$id.edit.tsx</code></td><td><code>/posts/123/edit</code></td><td><strong>逃离</strong>父级 <code>posts.tsx</code> 的布局，独立全屏渲染。</td></tr><tr><td><strong><code>[ ]</code></strong></td><td><strong>转义字符</strong></td><td><code>abc[.]def.tsx</code></td><td><code>/abc.def</code></td><td>强制保留文件名中的点，不被解析为嵌套。</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-4">⚡️ 一眼看懂对比</h3>
<p>为了加深印象，这几个<strong>容易混淆</strong>的用法我单独列出来对比：</p>
<ul>
<li>
<p><strong><code>posts.tsx</code></strong> 🆚 <strong><code>posts/route.tsx</code></strong></p>
<ul>
<li>
<p><strong>效果一样</strong>：都定义 <code>/posts</code> 这个层级的布局（父级）。</p>
</li>
<li>
<p><strong>区别</strong>：前者是扁平文件，后者是目录文件。</p>
</li>
</ul>
</li>
<li>
<p><strong><code>posts/index.tsx</code></strong> 🆚 <strong><code>posts.tsx</code></strong></p>
<ul>
<li>
<p><strong><code>posts.tsx</code></strong>：是<strong>框</strong>（Layout），不管去 <code>/posts</code> 还是 <code>/posts/123</code> 都在。</p>
</li>
<li>
<p><strong><code>posts/index.tsx</code></strong>：是<strong>内容</strong>，只有访问 <code>/posts</code> 时才在框里显示。</p>
</li>
</ul>
</li>
<li>
<p><strong><code>_layout.a.tsx</code></strong> 🆚 <strong><code>layout.a.tsx</code></strong></p>
<ul>
<li>
<p><strong><code>_layout.a.tsx</code></strong> (前缀 <code>_</code>)：URL 是 <code>/a</code> (布局名隐身)。</p>
</li>
<li>
<p><strong><code>layout.a.tsx</code></strong> (无前缀)：URL 是 <code>/layout/a</code> (布局名是路径一部分)。</p>
</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙开发：个人开发者如何使用华为账号登录]]></title>    <link>https://juejin.cn/post/7585382553290440740</link>    <guid>https://juejin.cn/post/7585382553290440740</guid>    <pubDate>2025-12-20T05:23:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290440740" data-draft-id="7585382553290424356" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙开发：个人开发者如何使用华为账号登录"/> <meta itemprop="keywords" content="HarmonyOS,Android,iOS"/> <meta itemprop="datePublished" content="2025-12-20T05:23:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员一鸣"/> <meta itemprop="url" content="https://juejin.cn/user/1398234520239095"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙开发：个人开发者如何使用华为账号登录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1398234520239095/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员一鸣
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:23:49.000Z" title="Sat Dec 20 2025 05:23:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>最近上架的两款应用都增加了华为账号登录，可以说，极大方便了用户登录操作，也降低了自身的业务复杂度，因为不在考虑注册，找回密码等业务，只依赖华为账号即可，所以，开发起来，效率上就提高了很多。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1b7f573948f4e95a875c8d7cbc09737~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766813029&amp;x-signature=xH6TU9LB91NCEmV7J8q8aAkosmo%3D" alt="" width="50%" loading="lazy"/></p>
<p>可能有的同学会有疑问，为什么是华为账号登录，而不是华为账号一键登录，这里需要解释的是，目前华为账号一键登录不支持个人开发者，所以，没办法，只能用官方推荐的华为账号或者静默登录。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ab3ec29674048eba04c5f77826919b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766813029&amp;x-signature=JzBwA92VkTQhNqcgEumYAgUE2QI%3D" alt="" width="50%" loading="lazy"/></p>
<p>需要说明的是，如果你的业务中，存在和用户交互的功能，建议使用，如果只是简单的单机应用，并没有和用户直接操作相关的，建议不使用，因为，没必要。</p>
<h2 data-id="heading-1">开发前提</h2>
<p>华为账号有一个开发前提，无论你是正式还是测试，一定要在 AppGallery Connect后台配置自己的公钥指纹，否则点击是报错的，公钥指纹，就是你所创建的发布证书或者测试证书。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2892dee7867f4a2685af870fba0b6bd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766813029&amp;x-signature=hRYaLw4A2EC7%2Faa72ggnEwdKRmo%3D" alt="" width="50%" loading="lazy"/></p>
<h3 data-id="heading-2">确认是否需要配置Client ID</h3>
<p>如果在项目配置中，看到Client ID和APP ID相同，则无需配置Client ID，否则需要按下一步配置Client ID。</p>
<p>在工程中<strong>entry</strong>模块的module.json5文件中，新增metadata，配置name为client_id，value为上一步获取的Client ID的值，如下所示：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-string">"module"</span>: {
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"&lt;name&gt;"</span>,
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"entry"</span>,
  <span class="hljs-string">"description"</span>: <span class="hljs-string">"&lt;description&gt;"</span>,
  <span class="hljs-string">"mainElement"</span>: <span class="hljs-string">"&lt;mainElement&gt;"</span>,
  <span class="hljs-string">"deviceTypes"</span>: [],
  <span class="hljs-string">"pages"</span>: <span class="hljs-string">"&lt;pages&gt;"</span>,
  <span class="hljs-string">"abilities"</span>: [],
  <span class="hljs-string">"metadata"</span>: [ <span class="hljs-comment">// 配置信息如下</span>
    {
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"client_id"</span>,
      <span class="hljs-string">"value"</span>: <span class="hljs-string">"xxxxx"</span> <span class="hljs-comment">// 将上一步获取到的Client ID赋值给value，请注意不要使用其他方式设置value值</span>
    }
  ]
 }
</code></pre>
<h2 data-id="heading-3">华为账号登录</h2>
<p>华为账号登录，有两种方式，一种是使用官方提供的登录按钮，一种是自己定义的按钮，无论哪种方式，都必须要遵循官方的设计规范；华为账号登录按钮包含文本、标志和文本、标志三种样式，以满足应用对界面风格一致性和灵活性的要求。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c05f95ed742641eba6ae25a5476d7f4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766813029&amp;x-signature=%2FKWihRaEt2%2FfHucReC%2F77pgMwTE%3D" alt="" width="50%" loading="lazy"/></p>
<h3 data-id="heading-4">使用官方按钮</h3>
<p>使用官方的组件比较简单，直接使用即可。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d3b0b1e962a41fd8af4b50b87291404~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766813029&amp;x-signature=UhgoTAdOPwKDiyHUyyc%2ByT%2Fqaz4%3D" alt="" width="50%" loading="lazy"/></p>
<h3 data-id="heading-5">完整案例</h3>
<p>完全是官方的案例，没什么好说的，具体的组件摆放，自己设置即可。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { loginComponentManager, <span class="hljs-title class_">LoginWithHuaweiIDButton</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AccountKit'</span>;
<span class="hljs-keyword">import</span> hilog <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.hilog'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-comment">// 构造LoginWithHuaweiIDButton组件的控制器</span>
  <span class="hljs-attr">controller</span>: loginComponentManager.<span class="hljs-property">LoginWithHuaweiIDButtonController</span> =
    <span class="hljs-keyword">new</span> loginComponentManager.<span class="hljs-title class_">LoginWithHuaweiIDButtonController</span>()
      .<span class="hljs-title function_">onClickLoginWithHuaweiIDButton</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError&lt;<span class="hljs-built_in">void</span>&gt;,
        response: loginComponentManager.HuaweiIDCredential</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (error) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dealAllError</span>(error);
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (response) {
          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in getting response.'</span>);
          <span class="hljs-keyword">const</span> authCode = response.<span class="hljs-property">authorizationCode</span>;
          <span class="hljs-comment">// 开发者处理authCode</span>
        }
      });

  <span class="hljs-comment">// 错误处理</span>
  <span class="hljs-title function_">dealAllError</span>(<span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span>&lt;<span class="hljs-built_in">void</span>&gt;): <span class="hljs-built_in">void</span> {
    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>,
      <span class="hljs-string">`Failed to login, errorCode is <span class="hljs-subst">${error.code}</span>, errorMessage is <span class="hljs-subst">${error.message}</span>`</span>);
    <span class="hljs-comment">// 在应用登录涉及UI交互场景下，建议按照如下错误码指导提示用户</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_LOGIN_OUT</span>) {
      <span class="hljs-comment">// 用户未登录华为账号，请登录华为账号并重试或者尝试使用其他方式登录</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_NETWORK_ERROR</span>) {
      <span class="hljs-comment">// 网络异常，请检查当前网络状态并重试或者尝试使用其他方式登录</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_INTERNAL_ERROR</span>) {
      <span class="hljs-comment">// 登录失败，请尝试使用其他方式登录</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_USER_CANCEL</span>) {
      <span class="hljs-comment">// 用户取消授权</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_SYSTEM_SERVICE</span>) {
      <span class="hljs-comment">// 系统服务异常，请稍后重试或者尝试使用其他方式登录</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_REQUEST_REFUSE</span>) {
      <span class="hljs-comment">// 重复请求，应用无需处理</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_AGREEMENT_STATUS_NOT_ACCEPTED</span>) {
      <span class="hljs-comment">// 用户未同意协议</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 应用登录失败，请尝试使用其他方式登录</span>
    }
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">RelativeContainer</span>() {
      <span class="hljs-title class_">LoginWithHuaweiIDButton</span>({
        <span class="hljs-attr">params</span>: {
          <span class="hljs-comment">// LoginWithHuaweiIDButton支持的样式</span>
          <span class="hljs-attr">style</span>: loginComponentManager.<span class="hljs-property">Style</span>.<span class="hljs-property">BUTTON_RED</span>,
          <span class="hljs-comment">// 账号登录按钮在登录过程中展示加载态</span>
          <span class="hljs-attr">extraStyle</span>: {
            <span class="hljs-attr">buttonStyle</span>: <span class="hljs-keyword">new</span> loginComponentManager.<span class="hljs-title class_">ButtonStyle</span>().<span class="hljs-title function_">loadingStyle</span>({
              <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span>
            })
          },
          <span class="hljs-comment">// LoginWithHuaweiIDButton的边框圆角半径</span>
          <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">24</span>,
          <span class="hljs-comment">// LoginWithHuaweiIDButton支持的登录类型</span>
          <span class="hljs-attr">loginType</span>: loginComponentManager.<span class="hljs-property">LoginType</span>.<span class="hljs-property">ID</span>,
          <span class="hljs-comment">// LoginWithHuaweiIDButton支持按钮的样式跟随系统深浅色模式切换</span>
          <span class="hljs-attr">supportDarkMode</span>: <span class="hljs-literal">true</span>
        },
        <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>
      })
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },
          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }
        })
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span> {
  <span class="hljs-comment">// 账号未登录</span>
  <span class="hljs-variable constant_">ERROR_CODE_LOGIN_OUT</span> = <span class="hljs-number">1001502001</span>,
  <span class="hljs-comment">// 网络错误</span>
  <span class="hljs-variable constant_">ERROR_CODE_NETWORK_ERROR</span> = <span class="hljs-number">1001502005</span>,
  <span class="hljs-comment">// 内部错误</span>
  <span class="hljs-variable constant_">ERROR_CODE_INTERNAL_ERROR</span> = <span class="hljs-number">1001502009</span>,
  <span class="hljs-comment">// 用户取消授权</span>
  <span class="hljs-variable constant_">ERROR_CODE_USER_CANCEL</span> = <span class="hljs-number">1001502012</span>,
  <span class="hljs-comment">// 系统服务异常</span>
  <span class="hljs-variable constant_">ERROR_CODE_SYSTEM_SERVICE</span> = <span class="hljs-number">12300001</span>,
  <span class="hljs-comment">// 重复请求</span>
  <span class="hljs-variable constant_">ERROR_CODE_REQUEST_REFUSE</span> = <span class="hljs-number">1001500002</span>,
  <span class="hljs-comment">// 用户未同意用户协议</span>
  <span class="hljs-variable constant_">ERROR_CODE_AGREEMENT_STATUS_NOT_ACCEPTED</span> = <span class="hljs-number">1005300001</span>
}
</code></pre>
<h3 data-id="heading-6">使用自定义按钮</h3>
<p>自定义按钮，和以上的代码没什么大的区别，唯独是需要自己触发登录请求逻辑，登录成功之后，就可以拿到华为账号的相关信息，接着就可以上传到服务端或者存储到本地，做一些其他的操作，有一点需要注意，有可能avatarUri头像返回为undefined，你可以做判断后，等于一个默认的头像。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"> <span class="hljs-comment">/**
   *AUTHOR:AbnerMing
   *INTRODUCE:登录
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">doLogin</span>(<span class="hljs-params"/>) {
  
    <span class="hljs-comment">// 创建授权请求，并设置参数</span>
    <span class="hljs-keyword">const</span> authRequest = <span class="hljs-keyword">new</span> authentication.<span class="hljs-title class_">HuaweiIDProvider</span>().<span class="hljs-title function_">createAuthorizationWithHuaweiIDRequest</span>();
    <span class="hljs-comment">// 获取头像昵称需要传如下scope</span>
    authRequest.<span class="hljs-property">scopes</span> = [<span class="hljs-string">'profile'</span>];
    <span class="hljs-comment">// 若开发者需要进行服务端开发以获取头像昵称，则需传如下permission获取authorizationCode</span>
    authRequest.<span class="hljs-property">permissions</span> = [<span class="hljs-string">'serviceauthcode'</span>];
    <span class="hljs-comment">// 用户是否需要登录授权，该值为true且用户未登录或未授权时，会拉起用户登录或授权页面</span>
    authRequest.<span class="hljs-property">forceAuthorization</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// 用于防跨站点请求伪造</span>
    authRequest.<span class="hljs-property">state</span> = util.<span class="hljs-title function_">generateRandomUUID</span>();
    <span class="hljs-comment">// 执行授权请求</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 此示例为代码片段，实际需在自定义组件实例中使用，以获取UIContext对象作为函数入参</span>
      <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> authentication.<span class="hljs-title class_">AuthenticationController</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>());
      controller.<span class="hljs-title function_">executeRequest</span>(authRequest).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> authorizationWithHuaweiIDResponse = data <span class="hljs-keyword">as</span> authentication.<span class="hljs-property">AuthorizationWithHuaweiIDResponse</span>;
        <span class="hljs-keyword">const</span> state = authorizationWithHuaweiIDResponse.<span class="hljs-property">state</span>;
        <span class="hljs-keyword">if</span> (state &amp;&amp; authRequest.<span class="hljs-property">state</span> !== state) {
          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to authorize. The state is different, response state: <span class="hljs-subst">${state}</span>`</span>);
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">const</span> authorizationWithHuaweiIDCredential = authorizationWithHuaweiIDResponse?.<span class="hljs-property">data</span>;
        <span class="hljs-keyword">let</span> avatarUri = authorizationWithHuaweiIDCredential?.<span class="hljs-property">avatarUri</span>;
        <span class="hljs-keyword">const</span> nickName = authorizationWithHuaweiIDCredential?.<span class="hljs-property">nickName</span>;
        <span class="hljs-comment">// 开发者处理avatarUri, nickName</span>
        <span class="hljs-keyword">const</span> unionID = authorizationWithHuaweiIDCredential?.<span class="hljs-property">unionID</span>;
        <span class="hljs-comment">// 涉及服务端开发以获取头像昵称场景，开发者处理authorizationCode</span>
        <span class="hljs-comment">//这里进行接口请求，上传到自己服务器，如果需要的情况下</span>

        
        
      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dealAllError</span>(err);
      });
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dealAllError</span>(error);
    }
  }

  <span class="hljs-comment">// 错误处理</span>
  <span class="hljs-title function_">dealAllError</span>(<span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 在应用登录涉及UI交互场景下，建议按照如下错误码指导提示用户</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_LOGIN_OUT</span>) {
      <span class="hljs-comment">// 用户未登录华为账号，请登录华为账号并重试或者尝试使用其他方式登录</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_NETWORK_ERROR</span>) {
      <span class="hljs-comment">// 网络异常，请检查当前网络状态并重试或者尝试使用其他方式登录</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_INTERNAL_ERROR</span>) {
      <span class="hljs-comment">// 登录失败，请尝试使用其他方式登录</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_USER_CANCEL</span>) {
      <span class="hljs-comment">// 用户取消授权</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_SYSTEM_SERVICE</span>) {
      <span class="hljs-comment">// 系统服务异常，请稍后重试或者尝试使用其他方式登录</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_REQUEST_REFUSE</span>) {
      <span class="hljs-comment">// 重复请求，应用无需处理</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 应用登录失败，请尝试使用其他方式登录</span>
    }
  }
</code></pre>
<h2 data-id="heading-7">静默登录</h2>
<p>静默登录一般常用于在应用卸载重装、用户换机等场景，如登录的华为账号与应用重装、换机前一致，应用可通过Account Kit提供的静默登录方式即不需要用户点击登录/注册按钮，即可获取用户的身份标识UnionID/OpenID，完成用户的静默登录。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-title function_">login</span>(<span class="hljs-params"/>){
    <span class="hljs-comment">// 创建登录请求，并设置参数</span>
    <span class="hljs-keyword">const</span> loginRequest = <span class="hljs-keyword">new</span> authentication.<span class="hljs-title class_">HuaweiIDProvider</span>().<span class="hljs-title function_">createLoginWithHuaweiIDRequest</span>();
    <span class="hljs-comment">// false表示静默登录</span>
    loginRequest.<span class="hljs-property">forceLogin</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-comment">// 用于防跨站点请求伪造</span>
    loginRequest.<span class="hljs-property">state</span> = util.<span class="hljs-title function_">generateRandomUUID</span>();
    <span class="hljs-comment">// 执行登录请求</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> authentication.<span class="hljs-title class_">AuthenticationController</span>();
      controller.<span class="hljs-title function_">executeRequest</span>(loginRequest).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response: authentication.LoginWithHuaweiIDResponse</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> loginWithHuaweiIDResponse = response <span class="hljs-keyword">as</span> authentication.<span class="hljs-property">LoginWithHuaweiIDResponse</span>;
        <span class="hljs-keyword">const</span> state = loginWithHuaweiIDResponse.<span class="hljs-property">state</span>;
        <span class="hljs-keyword">if</span> (state &amp;&amp; loginRequest.<span class="hljs-property">state</span> !== state) {
          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to login. The state is different, response state: <span class="hljs-subst">${state}</span>`</span>);
          <span class="hljs-keyword">return</span>;
        }
        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in logging in.'</span>);
        <span class="hljs-keyword">const</span> loginWithHuaweiIDCredential = loginWithHuaweiIDResponse?.<span class="hljs-property">data</span>;
        <span class="hljs-keyword">const</span> code = loginWithHuaweiIDCredential?.<span class="hljs-property">authorizationCode</span>;
        <span class="hljs-comment">//  处理code  都自己的接口，或其他操作</span>
      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {
        <span class="hljs-title function_">dealAllError</span>(error);
      })
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-title function_">dealAllError</span>(error);
    }
  }
</code></pre>
<h2 data-id="heading-8">相关总结</h2>
<p>华为账号登录，满足了个人开发者的用户登录需求，可以说，极大的提高了开发效率和应用的便捷性，不在为账号体系而发愁，但是，有一点需要注意，应用端的账号登录需要和服务端的账号体系打通，否则只是单纯的登录，无法实现用户之间的交互。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis与MySQL双剑合璧：缓存更新策略与数据一致性保障]]></title>    <link>https://juejin.cn/post/7585463195200946226</link>    <guid>https://juejin.cn/post/7585463195200946226</guid>    <pubDate>2025-12-20T05:47:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195200946226" data-draft-id="7490783352842207259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis与MySQL双剑合璧：缓存更新策略与数据一致性保障"/> <meta itemprop="keywords" content="Redis,数据库,性能优化"/> <meta itemprop="datePublished" content="2025-12-20T05:47:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Go高并发架构_王工"/> <meta itemprop="url" content="https://juejin.cn/user/446863555701561"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis与MySQL双剑合璧：缓存更新策略与数据一致性保障
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/446863555701561/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Go高并发架构_王工
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:47:47.000Z" title="Sat Dec 20 2025 05:47:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">一、前言</h4>
<p>在现代高并发系统中，性能和数据一致性常常是一对“欢喜冤家”：追求极致性能可能牺牲一致性，而过于强调一致性又容易拖慢系统响应。Redis和MySQL作为两种截然不同的数据库技术，就像武侠小说中的双剑，一个快如闪电，一个稳如磐石。如何让它们携手作战，既提升性能又保障数据一致性，是许多开发者面临的现实挑战。</p>
<p>想象一下，你正在开发一个电商系统，商品详情页每秒被访问上万次，数据库不堪重负；或者在秒杀活动中，库存数据稍有延迟就可能引发超卖。单靠MySQL，查询慢、压力大；单靠Redis，又难以保证持久化和复杂查询。这时，Redis与MySQL的结合就成了“救命稻草”。Redis负责缓存热点数据，MySQL保障数据持久化和事务支持，两者分工明确，优势互补。</p>
<p>这篇文章面向有1-2年Redis使用经验的开发者。你可能已经熟悉基本的<code>SET</code>、<code>GET</code>操作，也尝试过用Redis优化系统性能，但面对缓存更新策略和一致性问题时，难免有些迷雾重重。我的目标是通过实战经验，带你梳理Redis与MySQL协同工作的核心策略，剖析常见问题，并分享解决方案和注意事项。无论你是想提升系统性能，还是解决“缓存和数据库不同步”的头疼问题，这里都有你需要的答案。</p>
<h5 data-id="heading-1">我的故事与经验</h5>
<p>我从事后端开发已有10年，其中Redis几乎是我每个项目的“老搭档”。从早期的高并发电商平台，到后来的实时数据分析系统，再到最近的分布式日志服务，Redis与MySQL的组合贯穿始终。比如在某电商项目中，我们用Redis缓存商品详情页，QPS从几百提升到上万，数据库负载降低了80%；在实时监控项目中，Redis的低延迟让我们能秒级更新数据，而MySQL则默默守护着数据的完整性。这些经验告诉我，缓存与数据库的协作不仅仅是技术选型，更是业务需求与架构设计的平衡。</p>
<p>然而，这一路并非坦途。缓存失效导致的脏数据、高并发下的热点Key问题、甚至Redis宕机引发的连锁反应，都让我踩过不少坑。正是这些“摔打”，让我深刻认识到缓存更新策略和数据一致性保障的重要性。接下来，我将结合这些实战经验，带你一步步解锁Redis与MySQL双剑合璧的奥秘。</p>
<hr/>
<h4 data-id="heading-2">二、Redis与MySQL双剑合璧的核心优势</h4>
<p>Redis和MySQL的组合，就像一场精心编排的“双人舞”：Redis以迅雷不及掩耳之势处理高频请求，MySQL则稳扎稳打守护数据的完整性。单独使用它们都有局限，但结合起来却能迸发出惊人的能量。这一节，我们将剖析两者的互补性，探讨典型应用场景，并聊聊性能与一致性之间的微妙权衡。</p>
<h5 data-id="heading-3">1. Redis与MySQL的互补性</h5>
<p>MySQL是关系型数据库的“老大哥”，擅长持久化存储和复杂查询。它的强一致性（ACID特性）和丰富的事务支持，让它成为数据可靠性的基石。然而，面对高并发场景，磁盘I/O和锁机制往往让它“喘不过气来”。相比之下，Redis就像一位“轻功高手”，基于内存操作，读写延迟低至亚毫秒级，单机QPS轻松突破十万，非常适合缓存热点数据或临时状态。但Redis也有短板：数据持久化能力有限，复杂查询更是它的“软肋”。</p>
<p>两者的结合，恰好弥补了彼此的不足。在我参与的一个电商项目中，商品详情页的访问量激增时，我们用Redis缓存热点数据，QPS从500提升到2万，MySQL的查询压力骤降80%。而库存更新等关键操作依然交给MySQL，确保数据不会因Redis宕机而丢失。这种“快慢搭配”的模式，既提升了性能，又保障了可靠性。</p>
<p><strong>核心优势一览表：</strong></p>



































<table><thead><tr><th>特性</th><th>MySQL</th><th>Redis</th><th>结合后效果</th></tr></thead><tbody><tr><td>数据存储</td><td>磁盘，持久化</td><td>内存，临时</td><td>热点数据加速，核心数据安全</td></tr><tr><td>访问速度</td><td>毫秒级</td><td>亚毫秒级</td><td>性能提升10倍以上</td></tr><tr><td>查询能力</td><td>复杂SQL支持</td><td>简单Key-Value</td><td>满足多样化需求</td></tr><tr><td>一致性</td><td>强一致性</td><td>弱一致性</td><td>可根据业务灵活调整</td></tr></tbody></table>
<h5 data-id="heading-4">2. 典型应用场景</h5>
<p>在实际项目中，Redis与MySQL的组合无处不在。以下是两个常见的例子：</p>
<ul>
<li>
<p><strong>电商商品详情页</strong><br/>
商品信息（如名称、价格）变化频率低，但访问量极高。我们用Redis缓存这些数据，设置TTL为1小时，极大减少MySQL的查询压力。而库存数据因实时性要求高，更新时直接写MySQL，再同步失效Redis缓存。这种分工让系统既快又稳。</p>
</li>
<li>
<p><strong>用户会话管理</strong><br/>
在一个社交应用中，用户登录状态用Redis存储，TTL设为30分钟，快速响应会话查询。用户的长期数据（如注册信息）则保存在MySQL中，确保即使Redis重启，会话过期后也能从MySQL恢复。这种搭配让会话管理高效又可靠。</p>
</li>
</ul>
<h5 data-id="heading-5">3. 一致性与性能的权衡</h5>
<p>Redis与MySQL协作时，性能和一致性就像天平的两端，很难两全其美。我们常听到“最终一致性”和“强一致性”这两个词，它们该如何选择呢？答案藏在业务需求里。</p>
<p>以秒杀场景为例，库存扣减必须实时准确，任何延迟或不一致都可能导致超卖。这时需要强一致性，通常通过分布式锁或事务确保Redis和MySQL同步更新。而在推荐系统中，用户看到的商品列表可能基于几分钟前的数据，短暂的不一致无伤大雅，最终一致性就够用了——先更新MySQL，再异步刷新Redis即可。</p>
<p><strong>权衡选择示意图：</strong></p>
<pre><code class="hljs language-lua" lang="lua">高一致性需求       中间地带       高性能需求
|<span class="hljs-comment">-------|-------|-------|-------|</span>
强一致性         最终一致性
&lt;<span class="hljs-comment">-- 秒杀、支付 --&gt; &lt;-- 推荐、日志 --&gt;</span>
</code></pre>
<p>在我的经验中，一个实时数据分析项目让我深刻体会到这种权衡。初期我们追求强一致性，所有数据都同步写Redis和MySQL，结果性能瓶颈明显。后来调整为异步写回策略，吞吐量提升了3倍，用户也能接受秒级的延迟。这提醒我们：技术方案没有绝对的好坏，只有适不适合。</p>
<hr/>
<h4 data-id="heading-6">三、缓存更新策略详解</h4>
<p>Redis与MySQL的协作好比一场精密的“接力赛”，缓存更新策略就是接力棒交接的规则。交接顺畅，系统跑得又快又稳；稍有失误，就可能摔个跟头。这一节，我们将深入探讨三种主流缓存更新策略：Cache-Aside、Write-Through和Write-Behind，剖析它们的原理、优缺点，并结合实战经验分享代码和踩坑教训，最后给出选择建议。</p>
<h5 data-id="heading-7">1. 常见的缓存更新策略</h5>
<h6 data-id="heading-8">Cache-Aside（旁路缓存）</h6>
<p><strong>原理</strong>：这是最经典的缓存策略。读取时，先查Redis，若未命中则查MySQL并回写缓存；写入时，先更新MySQL，再主动失效（删除）Redis缓存。这种“懒加载”的方式让缓存按需填充，非常灵活。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>实现简单，开发成本低。</li>
<li>适合读多写少的场景，缓存命中率高时性能提升显著。</li>
</ul>
<p><strong>代码示例（Java伪代码）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取用户信息</span>
String <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user:"</span> + userId;
    <span class="hljs-type">String</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> redis.get(cacheKey); <span class="hljs-comment">// 先查Redis</span>
    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// 未命中</span>
        user = mysql.query(<span class="hljs-string">"SELECT * FROM users WHERE id = ?"</span>, userId); <span class="hljs-comment">// 查MySQL</span>
        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
            redis.setex(cacheKey, <span class="hljs-number">3600</span>, user); <span class="hljs-comment">// 回写Redis，TTL为1小时</span>
        }
    }
    <span class="hljs-keyword">return</span> user;
}

<span class="hljs-comment">// 更新用户信息</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String data)</span> {
    mysql.update(<span class="hljs-string">"UPDATE users SET data = ? WHERE id = ?"</span>, data, userId); <span class="hljs-comment">// 先更新MySQL</span>
    redis.del(<span class="hljs-string">"user:"</span> + userId); <span class="hljs-comment">// 再删除Redis缓存</span>
}
</code></pre>
<p><strong>踩坑经验</strong>：<br/>
在一个电商项目中，我们发现部分用户数据更新后，缓存未及时失效，导致前端显示脏数据。后来分析发现，某些场景下<code>redis.del</code>因网络抖动失败。为此，我们引入TTL自动清理机制，即使删除失败，缓存也会在到期后失效，避免长期不一致。</p>
<h6 data-id="heading-9">Write-Through（直写）</h6>
<p><strong>原理</strong>：写入时同时更新MySQL和Redis，确保两者数据时刻一致。就像“双管齐下”，每次写操作都两边同步。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>一致性强，读操作无需担心脏数据。</li>
<li>适合写频繁且一致性要求高的场景。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>性能开销大，双写增加了延迟。</li>
<li>Redis和MySQL的同步可能因异常中断。</li>
</ul>
<p><strong>实际场景</strong>：<br/>
在金融系统的账户余额更新中，我们采用Write-Through。每次转账操作先写MySQL，再同步更新Redis，确保余额实时准确。虽然性能略有下降，但一致性得到了保障。</p>
<h6 data-id="heading-10">Write-Behind（异步写回）</h6>
<p><strong>原理</strong>：先快速写入Redis，再通过异步任务（如消息队列或定时任务）批量更新MySQL。就像“先记账，后对账”，优先保证写性能。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>高吞吐量，适合高并发写场景。</li>
<li>异步批量操作减少数据库压力。</li>
</ul>
<p><strong>代码示例（Java伪代码）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProductStock</span><span class="hljs-params">(<span class="hljs-type">int</span> productId, <span class="hljs-type">int</span> stock)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"stock:"</span> + productId;
    redis.set(cacheKey, stock); <span class="hljs-comment">// 先写Redis</span>
    messageQueue.send(<span class="hljs-string">"update_stock"</span>, productId, stock); <span class="hljs-comment">// 异步发MQ更新MySQL</span>
}

<span class="hljs-comment">// MQ消费者</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String productId, <span class="hljs-type">int</span> stock)</span> {
    mysql.update(<span class="hljs-string">"UPDATE products SET stock = ? WHERE id = ?"</span>, stock, productId);
}
</code></pre>
<p><strong>踩坑经验</strong>：<br/>
在实时监控系统中，我们用Write-Behind处理指标数据。某次MQ消费失败，导致MySQL未更新，数据丢失了近1小时。吸取教训后，我们引入重试机制和日志补偿：失败的任务重试3次仍不成功则记录日志，运维人员手动修复。</p>
<h5 data-id="heading-11">2. 如何选择合适的策略</h5>
<p>选择缓存策略就像挑选武功招式，没有最强，只有最合适。以下是我的经验总结：</p>
<p><strong>选择依据对比表：</strong></p>

































<table><thead><tr><th>策略</th><th>适用场景</th><th>一致性</th><th>性能</th><th>复杂度</th></tr></thead><tbody><tr><td>Cache-Aside</td><td>读多写少（如商品详情）</td><td>最终一致性</td><td>高</td><td>低</td></tr><tr><td>Write-Through</td><td>写频繁一致性高（如金融）</td><td>强一致性</td><td>中</td><td>中</td></tr><tr><td>Write-Behind</td><td>高并发写（如日志）</td><td>最终一致性</td><td>极高</td><td>高</td></tr></tbody></table>
<p><strong>项目经验</strong>：</p>
<ul>
<li><strong>电商库存管理</strong>：我们用Cache-Aside结合延迟双删（后文详述），应对读多写少的场景，确保库存更新后缓存及时刷新。</li>
<li><strong>实时监控</strong>：Write-Through保证指标数据实时同步，满足强一致性需求。</li>
<li><strong>日志系统</strong>：Write-Behind配合消息队列，轻松应对每秒百万级的写请求。</li>
</ul>
<p>选择时，建议从业务特点出发：</p>
<ol>
<li><strong>读写比例</strong>：读多写少选Cache-Aside，写多读少选Write-Through。</li>
<li><strong>一致性要求</strong>：强一致性选Write-Through，最终一致性可考虑其他两者。</li>
<li><strong>系统复杂度</strong>：资源有限时，优先简单易用的Cache-Aside。</li>
</ol>
<p><strong>策略选择流程图：</strong></p>
<pre><code class="hljs language-rust" lang="rust">开始
  |
读多写少? -<span class="hljs-punctuation">-&gt;</span> 是 -<span class="hljs-punctuation">-&gt;</span> Cache-Aside
  |             否
强一致性? -<span class="hljs-punctuation">-&gt;</span> 是 -<span class="hljs-punctuation">-&gt;</span> Write-Through
  |             否
高并发写? -<span class="hljs-punctuation">-&gt;</span> 是 -<span class="hljs-punctuation">-&gt;</span> Write-Behind
  |
其他场景 -<span class="hljs-punctuation">-&gt;</span> 根据复杂度调整
</code></pre>
<hr/>
<h4 data-id="heading-12">四、数据一致性保障的实战技巧</h4>
<p>缓存更新策略为Redis与MySQL的协作搭好了舞台，但一致性问题就像舞台下的“暗流”，稍不留神就会让表演翻车。无论是缓存未及时刷新，还是并发更新导致的脏数据，这些问题都可能让用户体验大打折扣。这一节，我们将直面一致性问题的根源，分享我在项目中总结的实战技巧，帮助你打造一个既快又准的系统。</p>
<h5 data-id="heading-13">1. 一致性问题的根源</h5>
<p>一致性问题通常源于两点：</p>
<ul>
<li><strong>更新顺序异常</strong>：比如先写MySQL后删Redis，但Redis宕机或网络延迟导致删除失败，缓存保留了旧数据。</li>
<li><strong>并发冲突</strong>：多个线程同时更新同一数据，比如秒杀场景下多人抢购库存，可能出现Redis和MySQL的数据“打架”。</li>
</ul>
<p>在一次电商活动中，我们就遇到过类似问题：库存更新后，Redis缓存未及时删除，导致前端显示的库存比实际多，最终引发超卖。分析后发现，根源在于高并发下操作顺序不可控和异常处理不足。</p>
<h5 data-id="heading-14">2. 解决方案与最佳实践</h5>
<p>针对这些问题，我总结了三种实用方案，下面逐一展开。</p>
<h6 data-id="heading-15">延迟双删策略</h6>
<p><strong>原理</strong>：写MySQL后立即删除Redis缓存，等几秒后再删一次，确保即使有并发读回写了旧数据，也能被清理掉。这就像“双重保险”，牺牲一点延迟换取一致性。</p>
<p><strong>代码示例（Java+Spring）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProduct</span><span class="hljs-params">(<span class="hljs-type">int</span> productId, String data)</span> {
    <span class="hljs-comment">// 更新MySQL</span>
    mysql.update(<span class="hljs-string">"UPDATE products SET data = ? WHERE id = ?"</span>, data, productId);
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
    redis.del(cacheKey); <span class="hljs-comment">// 第一次删除</span>
    <span class="hljs-comment">// 延迟2秒再次删除</span>
    taskScheduler.schedule(() -&gt; redis.del(cacheKey), <span class="hljs-number">2000</span>);
}
</code></pre>
<p><strong>踩坑经验</strong>：<br/>
在某项目中，我们固定延迟2秒，结果发现高峰期QPS过高时，2秒不够覆盖所有并发读，导致部分脏数据残留。后来改为动态调整延迟时间（根据业务QPS，范围1-5秒），问题显著减少。</p>
<p><strong>适用场景</strong>：读多写少，且能容忍短暂不一致。</p>
<h6 data-id="heading-16">分布式锁</h6>
<p><strong>原理</strong>：在高并发更新时，用Redis分布式锁确保同一时刻只有一个线程能操作数据，避免冲突。就像给资源加了把“安全锁”，谁拿到钥匙谁操作。</p>
<p><strong>代码示例（Redis分布式锁）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"lock:product:"</span> + productId;
<span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
<span class="hljs-keyword">if</span> (redis.setnx(lockKey, <span class="hljs-string">"1"</span>)) { <span class="hljs-comment">// 尝试加锁</span>
    redis.expire(lockKey, <span class="hljs-number">10</span>); <span class="hljs-comment">// 设置10秒超时</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 更新MySQL</span>
        mysql.update(<span class="hljs-string">"UPDATE products SET stock = stock - 1 WHERE id = ?"</span>, productId);
        redis.del(cacheKey); <span class="hljs-comment">// 同步删除缓存</span>
    } <span class="hljs-keyword">finally</span> {
        redis.del(lockKey); <span class="hljs-comment">// 释放锁</span>
    }
} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"获取锁失败，重试"</span>);
}
</code></pre>
<p><strong>最佳实践</strong>：</p>
<ul>
<li><strong>超时设置</strong>：锁超时太短可能提前释放，太长可能阻塞其他线程，建议根据业务调整（5-30秒）。</li>
<li><strong>续期机制</strong>：若操作耗时长，可用watchdog线程自动续期，避免死锁。</li>
<li><strong>踩坑经验</strong>：一次秒杀活动中，忘记释放锁，导致后续请求全被阻塞。后来用<code>finally</code>块确保释放，才解决问题。</li>
</ul>
<p><strong>适用场景</strong>：秒杀、库存扣减等高并发强一致性场景。</p>
<h6 data-id="heading-17">消息队列解耦</h6>
<p><strong>原理</strong>：写操作通过消息队列（MQ）解耦，先快速写Redis，再由消费者异步更新MySQL。这就像“快递代发”，前端快速响应，后端慢慢处理。</p>
<p><strong>代码示例（Java伪代码）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">updateLog</span><span class="hljs-params">(String logData)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"log:"</span> + UUID.randomUUID();
    redis.set(cacheKey, logData); <span class="hljs-comment">// 先写Redis</span>
    messageQueue.send(<span class="hljs-string">"update_log"</span>, logData); <span class="hljs-comment">// 发MQ异步更新</span>
}

<span class="hljs-comment">// MQ消费者</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String logData)</span> {
    mysql.insert(<span class="hljs-string">"INSERT INTO logs (data) VALUES (?)"</span>, logData);
}
</code></pre>
<p><strong>踩坑经验</strong>：<br/>
在日志系统中，MQ消费者宕机导致积压，MySQL未及时更新。后来引入死信队列，所有消费失败的消息转入备用队列，由定时任务重试，确保不丢数据。</p>
<p><strong>适用场景</strong>：高并发写，且一致性要求不高（如日志、统计数据）。</p>
<h5 data-id="heading-18">3. 一致性验证</h5>
<p>无论用哪种策略，异常总可能发生。为防万一，我们需要“查漏补缺”：</p>
<ul>
<li><strong>定期比对</strong>：用定时任务对比Redis与MySQL数据，发现不一致时自动修复。</li>
<li><strong>项目经验</strong>：在电商库存管理中，我们每天凌晨跑脚本比对，修复了99%的脏数据问题。修复过程记录日志，便于追溯。</li>
</ul>
<p><strong>验证流程示意图：</strong></p>
<pre><code class="hljs language-rust" lang="rust">定时任务启动
    |
获取Redis数据 -<span class="hljs-punctuation">-&gt;</span> 与MySQL比对 -<span class="hljs-punctuation">-&gt;</span> 不一致?
    |                              是 -<span class="hljs-punctuation">-&gt;</span> 更新Redis或MySQL -<span class="hljs-punctuation">-&gt;</span> 记录日志
    |                              否
结束
</code></pre>
<p><strong>一致性保障方案对比表：</strong></p>

































<table><thead><tr><th>方案</th><th>一致性</th><th>性能影响</th><th>复杂度</th><th>适用场景</th></tr></thead><tbody><tr><td>延迟双删</td><td>较高</td><td>小</td><td>中</td><td>读多写少</td></tr><tr><td>分布式锁</td><td>极高</td><td>中</td><td>高</td><td>高并发强一致性</td></tr><tr><td>消息队列</td><td>最终一致性</td><td>低</td><td>高</td><td>高并发写</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-19">五、性能优化与踩坑经验</h4>
<p>Redis与MySQL的协作就像一辆跑车，缓存策略和一致性保障是引擎，而性能优化则是让它跑得更快更稳的“调校”。但这条赛道上也埋了不少“陷阱”，稍不留神就可能翻车。这一节，我将分享性能优化的核心技巧，以及我在实战中踩过的坑和应对之道，希望帮你少走弯路。</p>
<h5 data-id="heading-20">1. 性能优化的关键点</h5>
<p>要想让系统跑得快，细节决定成败。以下是三个关键点：</p>
<ul>
<li>
<p><strong>Redis键设计</strong><br/>
键名要短小精悍，避免“大Key”拖慢性能。比如存储复杂数据时，别用一个String存JSON，而是用Hash结构分字段存储。在一个用户管理系统中，我们将用户信息从<code>user:123:info</code>的单一String改为<code>HSET user:123 name "Tom" age "25"</code>，内存占用减少30%，查询效率也更高。</p>
</li>
<li>
<p><strong>批量操作</strong><br/>
Redis的单次操作很快，但网络RTT（往返时间）可能是瓶颈。使用Pipeline批量提交命令，能大幅降低延迟。在实时监控项目中，我们将每秒100次<code>SET</code>改为Pipeline批量操作，RTT从50ms降到5ms，性能提升10倍。</p>
</li>
<li>
<p><strong>缓存预热</strong><br/>
系统启动时，别让Redis“裸奔”。提前加载热点数据，能避免冷启动时的数据库压力。在电商活动中，我们在活动前将Top 100商品数据预热到Redis，首波流量直接命中缓存，MySQL毫发无损。</p>
</li>
</ul>
<p><strong>性能优化效果示意图：</strong></p>
<pre><code class="hljs language-lua" lang="lua">优化前：高RTT + 大Key + 冷启动
  |<span class="hljs-comment">----&gt; 数据库压力激增</span>
优化后：Pipeline + Hash + 预热
  |<span class="hljs-comment">----&gt; QPS提升，稳定运行</span>
</code></pre>
<h5 data-id="heading-21">2. 踩坑经验分享</h5>
<p>实战中，性能问题往往伴随着“坑”。以下是我遇到的三大典型问题及解决方案：</p>
<h6 data-id="heading-22">缓存穿透</h6>
<p><strong>问题</strong>：查询不存在的数据（如用户ID为-1），Redis未命中，请求直达MySQL，导致数据库压力暴增。<br/>
<strong>案例</strong>：某次接口被恶意请求刷爆，QPS从1万飙到10万，MySQL差点挂掉。<br/>
<strong>解决</strong>：</p>
<ol>
<li><strong>布隆过滤器</strong>：预先用布隆过滤器判断Key是否存在，不存在直接返回。</li>
<li><strong>缓存空值</strong>：查不到数据时，缓存空对象（如<code>null</code>），TTL设短些（如5分钟）。
<pre><code class="hljs language-java" lang="java">String <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user:"</span> + userId;
    <span class="hljs-type">String</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> redis.get(cacheKey);
    <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> user;
    <span class="hljs-keyword">if</span> (bloomFilter.mightContain(cacheKey)) {
        user = mysql.query(<span class="hljs-string">"SELECT * FROM users WHERE id = ?"</span>, userId);
        redis.setex(cacheKey, user == <span class="hljs-literal">null</span> ? <span class="hljs-number">300</span> : <span class="hljs-number">3600</span>, user); <span class="hljs-comment">// 空值TTL 5分钟</span>
    }
    <span class="hljs-keyword">return</span> user;
}
</code></pre>
</li>
</ol>
<p><strong>经验</strong>：布隆过滤器适合大数据量场景，空值缓存更简单但需控制内存。</p>
<h6 data-id="heading-23">缓存雪崩</h6>
<p><strong>问题</strong>：大量缓存Key同时失效，请求全打到MySQL，导致宕机。<br/>
<strong>案例</strong>：一次活动结束后，所有商品缓存TTL统一到期，MySQL瞬间瘫痪。<br/>
<strong>解决</strong>：</p>
<ol>
<li><strong>TTL随机化</strong>：给每个Key的TTL加随机偏移（如1小时±10分钟）。
<pre><code class="hljs language-java" lang="java">redis.setex(cacheKey, <span class="hljs-number">3600</span> + random.nextInt(<span class="hljs-number">600</span>), data);
</code></pre>
</li>
<li><strong>热点缓存隔离</strong>：将高频Key单独延长TTL或永不过期，手动刷新。<br/>
<strong>经验</strong>：随机化简单有效，热点隔离更适合核心数据。</li>
</ol>
<h6 data-id="heading-24">热点Key问题</h6>
<p><strong>问题</strong>：单个Key（如活动页数据）QPS过高，Redis单节点压力爆棚。<br/>
<strong>案例</strong>：某电商活动页Key每秒10万次请求，Redis集群响应变慢。<br/>
<strong>解决</strong>：</p>
<ol>
<li><strong>分片存储</strong>：将数据拆成多个Key（如<code>activity:1:part1</code>、<code>part2</code>），分散压力。</li>
<li><strong>本地缓存</strong>：前端或应用层用Guava Cache分担流量。我们在Nginx层加了本地缓存，Redis压力降到20%。
<pre><code class="hljs language-java" lang="java">Cache&lt;String, String&gt; localCache = CacheBuilder.newBuilder()
    .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.SECONDS).build();
String <span class="hljs-title function_">getActivityData</span><span class="hljs-params">(String key)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> localCache.getIfPresent(key);
    <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) {
        data = redis.get(key);
        localCache.put(key, data);
    }
    <span class="hljs-keyword">return</span> data;
}
</code></pre>
</li>
</ol>
<p><strong>经验</strong>：分片适合Redis层优化，本地缓存更灵活但需注意内存。</p>
<p><strong>踩坑问题对比表：</strong></p>





























<table><thead><tr><th>问题</th><th>表现</th><th>解决方法</th><th>实施难度</th></tr></thead><tbody><tr><td>缓存穿透</td><td>数据库压力大</td><td>布隆过滤器/空值缓存</td><td>中</td></tr><tr><td>缓存雪崩</td><td>数据库瞬时过载</td><td>TTL随机化/热点隔离</td><td>低</td></tr><tr><td>热点Key</td><td>Redis响应慢</td><td>分片/本地缓存</td><td>高</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-25">六、总结与展望</h4>
<p>Redis与MySQL的协作就像一场精彩的“双人舞”，从缓存策略到一致性保障，再到性能优化，每一步都考验着开发者的智慧和经验。走完这段旅程，我们不仅看到了两者的默契配合，也收获了实战中的宝贵教训。这一节，我将总结核心要点，分享实践建议，并展望未来的技术趋势，希望为你点亮前行的路。</p>
<h5 data-id="heading-26">1. 总结</h5>
<p>Redis与MySQL双剑合璧的核心在于两点：</p>
<ul>
<li><strong>合理选择缓存策略</strong>：Cache-Aside适合读多写少，Write-Through保障强一致性，Write-Behind应对高并发写。策略没有优劣之分，关键是匹配业务需求。</li>
<li><strong>保障数据一致性</strong>：延迟双删、分布式锁和消息队列各有千秋，配合定期验证，能让系统既快又稳。</li>
</ul>
<p>我的核心经验是：一切从业务出发。高并发电商需要性能优先，金融系统强调一致性，日志服务追求吞吐量。技术是为业务服务的，脱离需求的优化都是“空中楼阁”。比如在电商项目中，我们用Cache-Aside加延迟双删，QPS提升10倍的同时保证了库存准确；在实时监控中，Write-Through让数据零延迟，满足了客户需求。这些成功都源于对业务的深刻理解。</p>
<p><strong>实践建议</strong>：</p>
<ol>
<li><strong>从小处着手</strong>：先用Cache-Aside试水，简单易上手，再根据需求调整。</li>
<li><strong>关注异常</strong>：为每种策略设计兜底方案（如重试、日志补偿）。</li>
<li><strong>监控先行</strong>：部署Redis和MySQL的监控，实时掌握命中率、延迟和一致性问题。</li>
<li><strong>迭代优化</strong>：性能和一致性是个动态平衡，定期复盘调整。</li>
</ol>
<h5 data-id="heading-27">2. 展望</h5>
<p>Redis与MySQL的协作仍在进化。Redis 7.0增强了集群功能，支持多线程I/O和更灵活的数据结构，未来可能在一致性场景中扮演更重要角色。MySQL 8.0则优化了JSON支持和高可用性，与Redis的配合将更紧密。比如，Redis的Stream数据结构可以与MySQL的binlog集成，实现更高效的异步同步。</p>
<p>未来趋势可能包括：</p>
<ul>
<li><strong>智能化缓存</strong>：AI驱动的缓存预热和淘汰策略，让Redis更“聪明”。</li>
<li><strong>云原生融合</strong>：Serverless架构下，Redis和MySQL可能以托管服务形式无缝集成。</li>
<li><strong>一致性新解法</strong>：分布式事务（如TiDB+Redis的结合）或将简化强一致性实现。</li>
</ul>
<p>作为开发者，我鼓励你多实践、多分享。Redis与MySQL的组合看似简单，实则蕴藏无限可能。每次踩坑和优化，都是成长的契机。我的10年经验告诉我，技术没有终点，只有不断探索的乐趣。</p>
<p><strong>个人心得</strong>：<br/>
我最喜欢Redis的轻快和MySQL的稳重，它们就像我的左右手，缺一不可。每次解决一个一致性难题或优化一次性能瓶颈，都让我对这对“黄金搭档”更有信心。希望你也能在实践中找到属于自己的节奏。</p>
<hr/>
<p><strong>文章尾声：</strong><br/>
至此，我们从Redis与MySQL的优势讲到缓存策略，再到一致性和性能优化，走了一条完整的实战之路。带着这些经验和建议，去试试吧！有什么心得或问题，欢迎随时交流，毕竟技术的魅力就在于分享与成长。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[精选 8 个 .NET 开发实用的类库，效率提升利器！]]></title>    <link>https://juejin.cn/post/7585390679399104518</link>    <guid>https://juejin.cn/post/7585390679399104518</guid>    <pubDate>2025-12-20T05:47:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679399104518" data-draft-id="7585397173023424531" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="精选 8 个 .NET 开发实用的类库，效率提升利器！"/> <meta itemprop="keywords" content="后端,.NET"/> <meta itemprop="datePublished" content="2025-12-20T05:47:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            精选 8 个 .NET 开发实用的类库，效率提升利器！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:47:11.000Z" title="Sat Dec 20 2025 05:47:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6847a14abcd44fcf8c16b78ede2d4929~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=F3PFPN7HN7vMeliN6HZdl3wpIbw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">Mapster</h2>
<p>Mapster 是一个开源免费（MIT license）、快速、高性能、灵活且易于使用的 .NET 对象映射库，用于在 .NET 用程序中进行对象之间的转换和映射操作，大幅减少手动赋值带来的重复代码、人为错误和维护成本。</p>
<ul>
<li><strong>开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMapsterMapper%2FMapster" target="_blank" title="https://github.com/MapsterMapper/Mapster" ref="nofollow noopener noreferrer">github.com/MapsterMapp…</a></li>
<li><strong>详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FQFEbHE2EWzzZN9VvnUwD4A" target="_blank" title="https://mp.weixin.qq.com/s/QFEbHE2EWzzZN9VvnUwD4A" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/QFEbHE2EW…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f691a8a91f24f8d98f57b66b65bece2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=YGT%2FYfsP2XG1DPXl0kZZMWa0Clg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">FlaUI</h2>
<p>FlaUI 是一个 .NET 开源免费（MIT license）、功能强大 的 UI 自动化库，专为 Windows 桌面应用程序（如 Win32、WinForms、WPF、Store Apps 等应用）的自动化测试而设计。该项目基于 Microsoft 的原生 UI Automation 库构建，并作为这些库的封装器，提供了丰富的功能和灵活的 API，以便开发者能够高效地编写自动化测试脚本。</p>
<ul>
<li><strong>开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFlaUI%2FFlaUI" target="_blank" title="https://github.com/FlaUI/FlaUI" ref="nofollow noopener noreferrer">github.com/FlaUI/FlaUI</a></li>
<li><strong>详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPE4S-fUyeG7U8Z78NYu6Rw" target="_blank" title="https://mp.weixin.qq.com/s/PE4S-fUyeG7U8Z78NYu6Rw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/PE4S-fUye…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bc69f3e40374ecba76d64c1ca3e8624~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=eKXkeP7XDh%2BSTHKmFm009eWFBms%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">QuestPDF</h2>
<p>QuestPDF 是一个用于生成 PDF 文档的现代开源 .NET 库。QuestPDF 由简洁易用的 C# Fluent API 提供全面的布局引擎。轻松生成 PDF 报告、发票、导出等。QuestPDF它提供了一个布局引擎，在设计时考虑了完整的分页支持。与其他库不同，它不依赖于 HTML 到 PDF 的转换，这在许多情况下是不可靠的。相反，它实现了自己的布局引擎，该引擎经过优化，可以满足所有与分页相关的要求。</p>
<ul>
<li><strong>开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQuestPDF%2FQuestPDF" target="_blank" title="https://github.com/QuestPDF/QuestPDF" ref="nofollow noopener noreferrer">github.com/QuestPDF/Qu…</a></li>
<li><strong>详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZLxDsDE-UQnYdLnVw4h3Kg" target="_blank" title="https://mp.weixin.qq.com/s/ZLxDsDE-UQnYdLnVw4h3Kg" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/ZLxDsDE-U…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9206c005cf5c428abf3a9a4614c9059b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=vc1sF08o8fSKZruG7unQMdGefvA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">BouncyCastle</h2>
<p>BouncyCastle是一款C#版开源、免费的Bouncy Castle密码库，开发人员可以通过该项目在他们的 C# 应用程序中使用 Bouncy Castle 提供的各种密码学功能，从而加强数据的安全性和保护隐私信息。</p>
<ul>
<li><strong>开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbcgit%2Fbc-csharp" target="_blank" title="https://github.com/bcgit/bc-csharp" ref="nofollow noopener noreferrer">github.com/bcgit/bc-cs…</a></li>
<li><strong>详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F_VLzuDkyELusgsjFO6Wkog" target="_blank" title="https://mp.weixin.qq.com/s/_VLzuDkyELusgsjFO6Wkog" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/_VLzuDkyE…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f613a1a83cee41498cc77e412b155096~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=k4GGcb5lnRMNzCPX%2BcAcf3e3fW8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">IdGenerator</h2>
<p>IdGenerator是一个全面的分布式主键ID生成器，使用的是优化的雪花算法（SnowFlake）雪花漂移算法，在缩短ID长度的同时，具备极高瞬时并发处理能力（50W/0.1s）。</p>
<ul>
<li><strong>开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyitter%2FIdGenerator" target="_blank" title="https://github.com/yitter/IdGenerator" ref="nofollow noopener noreferrer">github.com/yitter/IdGe…</a></li>
<li><strong>详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FU1qKb4nYkQNtbXmQJkxyPA" target="_blank" title="https://mp.weixin.qq.com/s/U1qKb4nYkQNtbXmQJkxyPA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/U1qKb4nYk…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b3f777cd5e94a9782608e4eaf2e9a3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=%2FssqbCgt%2FMFbU1gjtCGeb7HXQhw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">CsvHelper</h2>
<p>CsvHelper是一个.NET开源、快速、灵活、高度可配置、易于使用的用于读取和写入CSV文件的类库。</p>
<ul>
<li><strong>开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJoshClose%2FCsvHelper" target="_blank" title="https://github.com/JoshClose/CsvHelper" ref="nofollow noopener noreferrer">github.com/JoshClose/C…</a></li>
<li><strong>详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FoE-nnlYuP5SqkJmdxCTdUQ" target="_blank" title="https://mp.weixin.qq.com/s/oE-nnlYuP5SqkJmdxCTdUQ" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/oE-nnlYuP…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3c798374c6c4b62893012c656ea4bfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=R8eHH2dzhu3qhBFCDxzx%2FdxTvo8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">Moq</h2>
<p>Moq是一个.NET开源、流行、使用简单的 .NET 模拟库，充分利用了.NET 的 Linq 表达式树和 lambda 表达式。这使得 Moq 成为最具生产力、类型安全且支持重构的模拟库。它不仅支持模拟接口，还支持模拟类。其 API 非常简单直观，不需要任何关于模拟概念的事先知识或经验。从而简化单元测试中的依赖管理和验证过程，提高代码的可测试性和可维护性。</p>
<ul>
<li><strong>开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdevlooped%2Fmoq" target="_blank" title="https://github.com/devlooped/moq" ref="nofollow noopener noreferrer">github.com/devlooped/m…</a></li>
<li><strong>详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FlJMf3UP1TQHAdE1gi9DWQw" target="_blank" title="https://mp.weixin.qq.com/s/lJMf3UP1TQHAdE1gi9DWQw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/lJMf3UP1T…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16a22ab1fc184b4d80efb16923993e25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=MiI019A329vbNF4Fhb2c1hXIdmw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">xUnit</h2>
<p>xUnit 是一个开源、免费、以社区为中心的 .NET 单元测试框架，是用于 C# 和 F#（其他 .NET 语言可能也能运行，但未提供官方支持）进行单元测试的最新技术。xUnit 能够与 Visual Studio、Visual Studio Code、ReSharper、CodeRush 和 TestDriven.NET 兼容。它是.NET 基金会的一部分，并遵循其行为准则。</p>
<ul>
<li><strong>开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxunit%2Fxunit" target="_blank" title="https://github.com/xunit/xunit" ref="nofollow noopener noreferrer">github.com/xunit/xunit</a></li>
<li><strong>详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F_jZNx2V1mRJCVL4m0nFzxw" target="_blank" title="https://mp.weixin.qq.com/s/_jZNx2V1mRJCVL4m0nFzxw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/_jZNx2V1m…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07dcbd723d034a47b2cdf6361c192a5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=xGVPE1MOZIH00OzTzx1Rnqt5Abs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">更多 .NET 实用类库实操</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fe43W9dqTWnmwI2STQREolw" target="_blank" title="https://mp.weixin.qq.com/s/e43W9dqTWnmwI2STQREolw" ref="nofollow noopener noreferrer">DotNetGuide专栏C#/.NET/.NET Core编程技巧练习集：</a>C#/.NET/.NET Core编程常用语法、算法、技巧、中间件、类库、工作业务实操练习集，配套详细的文章教程和代码示例，助力快速掌握C#/.NET/.NET Core中各种编程常用语法、算法、技巧、中间件、类库、工作业务实操等等。</p>
<ul>
<li>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetExercises" target="_blank" title="https://github.com/YSGStudyHards/DotNetExercises" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
<li>想要学习C#/.NET/.NET Core什么技术欢迎Issues中留言：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetGuide%2Fissues%2F42" target="_blank" title="https://github.com/YSGStudyHards/DotNetGuide/issues/42" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/215e18e2d1a34103ae9045716b2fb27a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766814431&amp;x-signature=NnZQ06SAI3Jp%2BN2eLtVo2dJ3FeE%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[闭包在 Vue 项目中的应用]]></title>    <link>https://juejin.cn/post/7585463195200929842</link>    <guid>https://juejin.cn/post/7585463195200929842</guid>    <pubDate>2025-12-20T05:46:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195200929842" data-draft-id="7585410547338068018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="闭包在 Vue 项目中的应用"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T05:46:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            闭包在 Vue 项目中的应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:46:21.000Z" title="Sat Dec 20 2025 05:46:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>闭包（Closure）作为 JavaScript 的核心特性，在 Vue 项目中有着广泛而精妙的应用。它不仅是 Vue 框架内部实现的重要机制，也是开发者编写高效、可维护代码的关键工具。</p>
<hr/>
<h2 data-id="heading-0">一、Vue 框架内部的闭包应用</h2>
<h3 data-id="heading-1">1. 响应式系统（Reactivity System）</h3>
<p>Vue 3 的响应式系统基于 <code>Proxy</code> 和 <code>effect</code> 实现，而 <strong>依赖收集（Dependency Collection）</strong> 的核心就是闭包。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 简化版 Vue 3 响应式原理</span>
let activeEffect = null;


function <span class="hljs-built_in">effect</span>(fn) {
  activeEffect = fn; <span class="hljs-comment">// 当前正在执行的副作用函数</span>
  <span class="hljs-built_in">fn</span>();              <span class="hljs-comment">// 执行时会触发 getter</span>
  activeEffect = null;
}


function <span class="hljs-built_in">reactive</span>(obj) {
  return new <span class="hljs-built_in">Proxy</span>(obj, {
    get(target, key) {
      if (activeEffect) {
        <span class="hljs-comment">// 闭包：track 函数捕获了 key 和 activeEffect</span>
        <span class="hljs-built_in">track</span>(target, key, activeEffect);
      }
      return target<span class="hljs-selector-attr">[key]</span>;
    },
    <span class="hljs-built_in">set</span>(target, key, value) {
      target<span class="hljs-selector-attr">[key]</span> = value;
      <span class="hljs-built_in">trigger</span>(target, key); <span class="hljs-comment">// 触发所有依赖该 key 的 effect</span>
    }
  });
}


<span class="hljs-comment">// track 函数内部使用闭包保存依赖关系</span>
const depsMap = new <span class="hljs-built_in">WeakMap</span>();
function <span class="hljs-built_in">track</span>(target, key, effectFn) {
  let deps = depsMap<span class="hljs-selector-class">.get</span>(target);
  if (!deps) {
    deps = new <span class="hljs-built_in">Map</span>();
    depsMap<span class="hljs-selector-class">.set</span>(target, deps);
  }
  let effects = deps<span class="hljs-selector-class">.get</span>(key);
  if (!effects) {
    effects = new <span class="hljs-built_in">Set</span>();
    deps<span class="hljs-selector-class">.set</span>(key, effects);
  }
  effects<span class="hljs-selector-class">.add</span>(effectFn); <span class="hljs-comment">// effectFn 是通过闭包传递进来的</span>
}
</code></pre>
<blockquote>
<p>✅ <strong>关键点</strong>：</p>
</blockquote>
<blockquote>
<p><code>effectFn</code>（如组件 render 函数）通过闭包被保存在依赖集合中，当数据变化时，这些闭包函数被重新执行，实现视图更新</p>
</blockquote>
<h3 data-id="heading-2">2. Computed 计算属性</h3>
<p>计算属性的缓存机制依赖闭包保存状态：</p>
<pre><code class="hljs language-ini" lang="ini">function computed(getter) {
  let value<span class="hljs-comment">;</span>
  let <span class="hljs-attr">dirty</span> = <span class="hljs-literal">true</span><span class="hljs-comment">; // 是否需要重新计算</span>
  
  const <span class="hljs-attr">runner</span> = effect(getter, {
    lazy: true,
    scheduler: () =&gt; {
      if (!dirty) {
        <span class="hljs-attr">dirty</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
        // 触发视图更新（通过闭包引用的 watcher）
      }
    }
  })<span class="hljs-comment">;</span>
  
  return {
    // 闭包：get 捕获了 value、dirty、runner
    get value() {
      if (dirty) {
        <span class="hljs-attr">value</span> = runner()<span class="hljs-comment">;</span>
        <span class="hljs-attr">dirty</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
      }
      return value<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p>每个 <code>computed</code> 实例通过闭包维护自己的 <code>value</code> 和 <code>dirty</code> 状态，实现精准缓存。</p>
<h3 data-id="heading-3">3. Watch 监听器</h3>
<p><code>watch</code> 的回调函数本质上是一个闭包，捕获了监听的数据和上下文：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">watch</span>(
  <span class="hljs-function">() =&gt;</span> user.<span class="hljs-property">name</span>, <span class="hljs-comment">// 依赖源（闭包捕获 user）</span>
  <span class="hljs-function">(<span class="hljs-params">newName, oldName</span>) =&gt;</span> {
    <span class="hljs-comment">// 回调函数是闭包，可以访问组件实例、其他变量等</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${oldName}</span> → <span class="hljs-subst">${newName}</span>`</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendAnalytics</span>(newName); <span class="hljs-comment">// 访问组件方法</span>
  }
);
</code></pre>
<hr/>
<p> </p>
<h2 data-id="heading-4">二、业务开发中的闭包应用</h2>
<h3 data-id="heading-5">1. 封装私有状态（模块模式）</h3>
<p>在 Vue 组件或工具函数中，利用闭包创建私有变量：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/request.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">createRequest</span> = (<span class="hljs-params">baseURL</span>) =&gt; {
  <span class="hljs-keyword">let</span> token = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 私有变量，外部无法直接访问</span>
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">setToken</span>(<span class="hljs-params">newToken</span>) {
      token = newToken;
    },
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">url</span>) {
      <span class="hljs-comment">// 闭包捕获 token 和 baseURL</span>
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${baseURL}</span><span class="hljs-subst">${url}</span>`</span>, {
        <span class="hljs-attr">headers</span>: { <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span> }
      });
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
    }
  };
};


<span class="hljs-comment">// 在 Vue 组件中使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">api</span>: <span class="hljs-title function_">createRequest</span>(<span class="hljs-string">'/api'</span>)
    };
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">api</span>.<span class="hljs-title function_">setToken</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>));
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">api</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/user'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> = user;
    });
  }
};
</code></pre>
<blockquote>
<p>✅ <strong>优势</strong>：避免全局变量污染，实现数据封装</p>
</blockquote>
<h3 data-id="heading-6">2. 防抖（Debounce）与节流（Throttle）</h3>
<p>表单验证、搜索建议等场景常用防抖，其核心是闭包：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"searchText"</span> @<span class="hljs-attr">input</span>=<span class="hljs-string">"debouncedSearch"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">searchText</span>: <span class="hljs-string">''</span>
    };
  },
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建防抖函数（闭包保存 timerId）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">debouncedSearch</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">debounce</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">search</span>, <span class="hljs-number">300</span>);
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">debounce</span>(<span class="hljs-params">func, delay</span>) {
      <span class="hljs-keyword">let</span> timeoutId;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
        <span class="hljs-built_in">clearTimeout</span>(timeoutId);
        timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
        }, delay);
      };
    },
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">search</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/search?q=<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.searchText}</span>`</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">results</span> = results;
    }
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>每个组件实例的 <code>debouncedSearch</code> 都有自己的 <code>timeoutId</code>，互不干扰。</p>
<p> </p>
<hr/>
<h3 data-id="heading-7">详细解释：</h3>
<p>在 JavaScript 中，箭头函数 <code>(...args) =&gt; {}</code> 使用了 <strong>剩余参数语法（Rest Parameters）</strong> ，它会把所有传给函数的实际参数收集到一个数组中。</p>
<pre><code class="hljs language-javascript" lang="javascript">javascript
复制
<span class="hljs-keyword">function</span> <span class="hljs-title function_">example</span>(<span class="hljs-params">...args</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args); <span class="hljs-comment">// args 是一个数组，包含所有传入的参数</span>
}

<span class="hljs-title function_">example</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'hello'</span>, <span class="hljs-literal">true</span>); 
<span class="hljs-comment">// 输出: [1, 'hello', true]</span>
</code></pre>
<p> </p>
<h4 data-id="heading-8">🎯 举个实际例子：带参数的防抖函数</h4>
<p>假设我们有一个搜索函数，每次用户输入时都要调用 API 查询结果：</p>
<pre><code class="hljs language-javascript" lang="javascript">javascript
复制
<span class="hljs-keyword">function</span> <span class="hljs-title function_">searchAPI</span>(<span class="hljs-params">query, category</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Searching for "<span class="hljs-subst">${query}</span>" in <span class="hljs-subst">${category}</span>`</span>);
  <span class="hljs-comment">// 模拟发起网络请求</span>
}


<span class="hljs-comment">// 创建防抖版本</span>
<span class="hljs-keyword">const</span> debouncedSearch = <span class="hljs-title function_">debounce</span>(searchAPI, <span class="hljs-number">500</span>);


<span class="hljs-comment">// 模拟用户多次输入</span>
<span class="hljs-title function_">debouncedSearch</span>(<span class="hljs-string">'laptop'</span>, <span class="hljs-string">'electronics'</span>); <span class="hljs-comment">// 参数会被收集到 args 中</span>
<span class="hljs-title function_">debouncedSearch</span>(<span class="hljs-string">'laptop pro'</span>, <span class="hljs-string">'electronics'</span>);
<span class="hljs-title function_">debouncedSearch</span>(<span class="hljs-string">'laptop pro max'</span>, <span class="hljs-string">'electronics'</span>);


<span class="hljs-comment">// 最终只会执行最后一次调用:</span>
<span class="hljs-comment">// Searching for "laptop pro max" in electronics</span>
</code></pre>
<h3 data-id="heading-9">执行过程详解：</h3>
<ol>
<li>第一次调用 <code>debouncedSearch('laptop', 'electronics')</code></li>
<li>
<ol>
<li><code>args = ['laptop', 'electronics']</code></li>
<li>设置定时器 A</li>
</ol>
</li>
<li>第二次调用（500ms 内）</li>
<li>
<ol>
<li>清除定时器 A</li>
<li>设置定时器 B，此时 <code>args = ['laptop pro', 'electronics']</code></li>
</ol>
</li>
<li>第三次调用（仍在 500ms 内）</li>
<li>
<ol>
<li>清除定时器 B</li>
<li>设置定时器 C，此时 <code>args = ['laptop pro max', 'electronics']</code></li>
</ol>
</li>
<li>500ms 后无新调用</li>
<li>
<ol>
<li>执行 <code>func.apply(this, args)</code></li>
<li>等价于 <code>searchAPI.call(this, 'laptop pro max', 'electronics')</code></li>
</ol>
</li>
</ol>
<p> </p>
<h2 data-id="heading-10">🔍 <code>func.apply(this, args)</code> 的作用</h2>
<p>这部分是防抖函数的关键设计，目的是<strong>保持原函数的调用上下文和参数传递</strong>：</p>





















<table><thead><tr><th>方法</th><th>作用</th></tr></thead><tbody><tr><td>this</td><td>保持函数调用时的上下文（谁调用了这个函数）</td></tr><tr><td>args</td><td>保证原始参数完整传递给目标函数</td></tr><tr><td>apply()</td><td>以数组形式展开参数并绑定 this</td></tr></tbody></table>
<hr/>
<p> </p>
<h3 data-id="heading-11">3. 事件处理器中的参数传递</h3>
<p>在循环渲染列表时，闭包解决事件参数问题：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in items"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 方式1：箭头函数（隐式闭包） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"() =&gt; handleDelete(item.id)"</span>&gt;</span>删除<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 方式2：方法返回函数（显式闭包） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"getDeleteHandler(item.id)"</span>&gt;</span>删除<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleDelete</span>(<span class="hljs-params">id</span>) {
      <span class="hljs-comment">// 处理删除逻辑</span>
    },
    <span class="hljs-comment">// 返回一个闭包函数，捕获 id</span>
    <span class="hljs-title function_">getDeleteHandler</span>(<span class="hljs-params">id</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleDelete</span>(id);
      };
    }
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<blockquote>
<p>⚠️ <strong>注意</strong>：避免在模板中直接写 <code>@click="handleDelete(item.id)"</code>，这会在每次渲染时创建新函数，影响性能。</p>
</blockquote>
<h3 data-id="heading-12">4. Composition API 中的闭包</h3>
<p>Vue 3 的组合式 API 天然适合闭包：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// composables/useCounter.js</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;


<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useCounter</span>(<span class="hljs-params">initialValue = <span class="hljs-number">0</span></span>) {
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(initialValue);
  
  <span class="hljs-comment">// 闭包：以下函数共享 count</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; count.<span class="hljs-property">value</span>++;
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">decrement</span> = (<span class="hljs-params"/>) =&gt; count.<span class="hljs-property">value</span>--;
  <span class="hljs-keyword">const</span> doubled = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>);
  
  <span class="hljs-keyword">return</span> {
    count,
    increment,
    decrement,
    doubled
  };
}


<span class="hljs-comment">// 在组件中使用</span>
<span class="hljs-keyword">import</span> { useCounter } <span class="hljs-keyword">from</span> <span class="hljs-string">'./composables/useCounter'</span>;


<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> { count, increment, doubled } = <span class="hljs-title function_">useCounter</span>(<span class="hljs-number">10</span>);
    <span class="hljs-keyword">return</span> { count, increment, doubled };
  }
};
</code></pre>
<p>每个 <code>useCounter</code> 调用都创建独立的作用域，状态完全隔离。</p>
<h3 data-id="heading-13">5. 高阶组件（HOC）与 Renderless 组件</h3>
<p>通过闭包封装通用逻辑：</p>
<pre><code class="hljs language-ini" lang="ini">// composables/useFetch.js
export function useFetch(url) {
  const <span class="hljs-attr">data</span> = ref(null)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">true</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">error</span> = ref(null)<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">fetchData</span> = async () =&gt; {
    try {
      <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
      const <span class="hljs-attr">res</span> = await fetch(url)<span class="hljs-comment">; // 闭包捕获 url</span>
      <span class="hljs-attr">data.value</span> = await res.json()<span class="hljs-comment">;</span>
    } catch (err) {
      <span class="hljs-attr">error.value</span> = err<span class="hljs-comment">;</span>
    } finally {
      <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>
  
  onMounted(fetchData)<span class="hljs-comment">;</span>
  
  return { data, loading, error, refetch: fetchData }<span class="hljs-comment">;</span>
}


// 在任意组件中复用
export default {
  setup() {
    const { data, loading } = useFetch('/api/users')<span class="hljs-comment">;</span>
    return { data, loading }<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-14">6. 缓存计算结果（Memoization）</h3>
<p>对复杂计算进行缓存：</p>
<pre><code class="hljs language-ini" lang="ini">// composables/useExpensiveCalc.js
export function useExpensiveCalc(items) {
  const <span class="hljs-attr">cache</span> = new Map()<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">getResult</span> = (filter) =&gt; {
    const <span class="hljs-attr">key</span> = JSON.stringify(filter)<span class="hljs-comment">;</span>
    if (cache.has(key)) {
      return cache.get(key)<span class="hljs-comment">;</span>
    }
    
    // 模拟复杂计算
    const <span class="hljs-attr">result</span> = items.value
      .filter(<span class="hljs-attr">item</span> =&gt; item.type === filter.type)
      .map(<span class="hljs-attr">item</span> =&gt; ({ ...item, processed: <span class="hljs-literal">true</span> }))<span class="hljs-comment">;</span>
    
    cache.set(key, result)<span class="hljs-comment">;</span>
    return result<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  
  // 提供清除缓存的方法
  const <span class="hljs-attr">clearCache</span> = () =&gt; cache.clear()<span class="hljs-comment">;</span>
  
  return { getResult, clearCache }<span class="hljs-comment">;</span>
}
</code></pre>
<p>闭包保护 <code>cache</code> 对象，避免全局污染。</p>
<hr/>
<p> </p>
<h2 data-id="heading-15">三、闭包相关的常见问题与解决方案</h2>
<h3 data-id="heading-16">1. 循环中的闭包陷阱（Vue 2 + var）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误示例（Vue 2 中使用 var）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">list</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>] };
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i); <span class="hljs-comment">// 全部输出 3</span>
      }, <span class="hljs-number">100</span>);
    }
  }
};
</code></pre>
<p><strong>解决方案</strong>：</p>
<ul>
<li>使用 <code>let</code> 替代 <code>var</code></li>
<li>使用 <code>forEach</code> 或 <code>map</code></li>
<li>使用箭头函数</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确做法</span>
<span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(index); <span class="hljs-comment">// 0, 1, 2</span>
    }, <span class="hljs-number">100</span>);
  });
}
</code></pre>
<h3 data-id="heading-17">2. 内存泄漏风险</h3>
<p>在组件销毁时，及时清理闭包持有的资源：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">timer</span>: <span class="hljs-literal">null</span> };
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 闭包持有 timer 引用</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateData</span>();
    }, <span class="hljs-number">1000</span>);
  },
  <span class="hljs-title function_">beforeUnmount</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 必须清理，否则闭包导致内存泄漏</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span>) {
      <span class="hljs-built_in">clearInterval</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span> = <span class="hljs-literal">null</span>;
    }
  }
};
</code></pre>
<h3 data-id="heading-18">3. 闭包与 this 指向</h3>
<p>在 Vue 2 选项式 API 中，注意 <code>this</code> 绑定：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// 保存 this 引用（闭包）</span>
      
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 普通函数中 this 指向 window</span>
        self.<span class="hljs-title function_">showMessage</span>(); <span class="hljs-comment">// 通过闭包访问组件实例</span>
      }, <span class="hljs-number">100</span>);
      
      <span class="hljs-comment">// 或使用箭头函数（自动继承 this）</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showMessage</span>(); <span class="hljs-comment">// 正确</span>
      }, <span class="hljs-number">100</span>);
    }
  }
};
</code></pre>
<h2 data-id="heading-19">四、最佳实践总结</h2>








































<table><thead><tr><th>场景</th><th>推荐做法</th><th>避免事项</th></tr></thead><tbody><tr><td><strong>状态封装</strong></td><td>使用闭包创建私有变量</td><td>滥用全局变量</td></tr><tr><td><strong>事件处理</strong></td><td>在 methods 中定义，模板中引用</td><td>在模板中直接写内联函数</td></tr><tr><td><strong>防抖节流</strong></td><td>在 created/setup 中创建一次</td><td>每次渲染都创建新函数</td></tr><tr><td><strong>循环索引</strong></td><td>使用 let 或 forEach</td><td>在 for(var) 中使用闭包</td></tr><tr><td><strong>资源清理</strong></td><td>在 beforeUnmount 中清理定时器、监听器</td><td>忽略清理导致内存泄漏</td></tr><tr><td><strong>Composition API</strong></td><td>利用闭包实现逻辑复用</td><td>过度嵌套导致调试困难</td></tr></tbody></table>
<h2 data-id="heading-20">结语</h2>
<p>闭包在 Vue 项目中既是<strong>框架运行的基石</strong>，也是<strong>开发者手中的利器</strong>。理解其原理，能帮助我们：</p>
<ul>
<li>更好地使用 Vue 的响应式系统和 Composition API</li>
<li>编写出高性能、低内存占用的组件</li>
<li>避免常见的作用域陷阱和内存泄漏问题</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 闭包详解：由浅入深掌握作用域与内存管理的艺术]]></title>    <link>https://juejin.cn/post/7585463195200962610</link>    <guid>https://juejin.cn/post/7585463195200962610</guid>    <pubDate>2025-12-20T05:50:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195200962610" data-draft-id="7585410547338100786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 闭包详解：由浅入深掌握作用域与内存管理的艺术"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T05:50:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 闭包详解：由浅入深掌握作用域与内存管理的艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:50:41.000Z" title="Sat Dec 20 2025 05:50:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、什么是闭包？——从直观现象入手</h2>
<h3 data-id="heading-1">1.1 一个经典例子</h3>
<p>先看一段代码：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">outer</span>() {
  let count = <span class="hljs-number">0</span>;
  
  function <span class="hljs-built_in">inner</span>() {
    count++;
    console<span class="hljs-selector-class">.log</span>(count);
  }
  
  return inner;
}


const counter = <span class="hljs-built_in">outer</span>();
<span class="hljs-built_in">counter</span>(); <span class="hljs-comment">// 输出: 1</span>
<span class="hljs-built_in">counter</span>(); <span class="hljs-comment">// 输出: 2</span>
<span class="hljs-built_in">counter</span>(); <span class="hljs-comment">// 输出: 3</span>
</code></pre>
<p>这里发生了什么？</p>
<ul>
<li><code>outer</code> 函数执行完毕后，按理说其内部变量 <code>count</code> 应该被销毁。</li>
<li>但通过 <code>counter()</code> 调用 <code>inner</code> 函数时，<code>count</code> 不仅存在，还能被修改并保留状态。</li>
</ul>
<p>这种 <strong>“函数即使在其词法作用域外被调用，仍能访问并操作其创建时所在作用域中的变量”</strong> 的现象，就是闭包。</p>
<h3 data-id="heading-2">1.2 官方定义</h3>
<p>MDN 对闭包的定义是：</p>
<blockquote>
<p>“闭包是指那些能够访问自由变量的函数。自由变量是指在函数中使用，但既不是函数参数也不是函数局部变量的变量。”</p>
</blockquote>
<p>更通俗地说：<strong>闭包 = 函数 + 其创建时所处的词法环境（Lexical Environment）的引用</strong>。</p>
<p> </p>
<h2 data-id="heading-3">二、理解基础：作用域与词法环境</h2>
<p>要真正理解闭包，必须先掌握 JavaScript 的作用域机制。</p>
<h3 data-id="heading-4">2.1 作用域（Scope）</h3>
<p>作用域决定了变量的可访问范围。JavaScript 采用 <strong>词法作用域（Lexical Scoping）</strong> ，即变量的作用域在<strong>代码编写时就已确定</strong>，而非运行时。</p>
<pre><code class="hljs language-scss" lang="scss">let <span class="hljs-selector-tag">a</span> = <span class="hljs-number">1</span>;


function <span class="hljs-built_in">foo</span>() {
  console<span class="hljs-selector-class">.log</span>(a); <span class="hljs-comment">// 会输出 1，因为 foo 定义在全局作用域内</span>
}


function <span class="hljs-built_in">bar</span>() {
  let <span class="hljs-selector-tag">a</span> = <span class="hljs-number">2</span>;
  <span class="hljs-built_in">foo</span>(); <span class="hljs-comment">// 仍然输出 1！不是 2</span>
}


<span class="hljs-built_in">bar</span>();
</code></pre>
<p>尽管 <code>foo</code> 是在 <code>bar</code> 内部调用的，但它访问的是<strong>定义时</strong>所在的作用域（全局），而非<strong>调用时</strong>的作用域。这就是词法作用域的核心。</p>
<h3 data-id="heading-5">2.2 词法环境（Lexical Environment）</h3>
<p>ES6 规范引入了 <strong>词法环境（Lexical Environment）</strong> 来精确描述作用域。</p>
<p>每个词法环境包含两个部分：</p>
<ul>
<li><strong>环境记录（Environment Record）</strong> ：存储变量和函数的映射（如 <code>{ count: 0 }</code>）</li>
<li><strong>对外部词法环境的引用（Outer Environment Reference）</strong> ：指向父级作用域</li>
</ul>
<p>当函数被创建时，它会<strong>捕获（capture）</strong> 当前的词法环境，并将其保存在内部属性 <code>[[Environment]]</code> 中。</p>
<blockquote>
<p>✅ <strong>关键点</strong>：闭包的本质，就是函数通过 <code>[[Environment]]</code> 引用“记住”了它出生时的环境。</p>
</blockquote>
<p> </p>
<h2 data-id="heading-6">三、闭包的形成机制：内存模型解析</h2>
<p>让我们通过内存模型，可视化闭包的形成过程。</p>
<h3 data-id="heading-7">3.1 执行上下文与作用域链</h3>
<p>当 JavaScript 引擎执行代码时，会为每个函数调用创建一个 <strong>执行上下文（Execution Context）</strong> ，其中包含：</p>
<ul>
<li>变量对象（Variable Object）</li>
<li>作用域链（Scope Chain）</li>
<li>this 绑定</li>
</ul>
<p>作用域链是一个<strong>从当前作用域逐级向上查找</strong>的链表，直到全局作用域。</p>
<h3 data-id="heading-8">3.2 闭包的内存结构</h3>
<p>以之前的 <code>counter</code> 为例：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">outer</span><span class="hljs-params">()</span></span> {
  let count = <span class="hljs-number">0</span>; // 存储在 outer 的词法环境中
  
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">inner</span><span class="hljs-params">()</span></span> { // inner 的 <span class="hljs-string">[[Environment]]</span> 指向 outer 的词法环境
    count++;
    console.<span class="hljs-built_in">log</span>(count);
  }
  
  <span class="hljs-keyword">return</span> inner;
}
</code></pre>
<p>当 <code>outer()</code> 执行时：</p>
<ol>
<li>创建 <code>outer</code> 的执行上下文，初始化 <code>count = 0</code></li>
<li>定义 <code>inner</code> 函数，其内部属性 <code>[[Environment]]</code> 指向 <code>outer</code> 的词法环境</li>
<li>返回 <code>inner</code> 函数引用</li>
</ol>
<p>当 <code>outer()</code> 执行完毕：</p>
<ul>
<li><code>outer</code> 的执行上下文被弹出调用栈</li>
<li><strong>但</strong> <code>inner</code> <strong>仍持有对</strong> <code>outer</code> <strong>词法环境的引用</strong></li>
<li>因此，<code>count</code> 不会被垃圾回收，继续存在于内存中</li>
</ul>
<blockquote>
<p>📌 <strong>重要结论</strong>：</p>
</blockquote>
<blockquote>
<p>闭包导致外部函数的变量<strong>不会被释放</strong>，直到闭包本身不再被引用。</p>
</blockquote>
<h3 data-id="heading-9">3.3 多个闭包共享同一环境</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> ++count,
    <span class="hljs-attr">decrement</span>: <span class="hljs-function">() =&gt;</span> --count,
    <span class="hljs-attr">value</span>: <span class="hljs-function">() =&gt;</span> count
  };
}


<span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">createCounter</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">value</span>()); <span class="hljs-comment">// 0</span>
counter.<span class="hljs-title function_">increment</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">value</span>()); <span class="hljs-comment">// 1</span>
counter.<span class="hljs-title function_">decrement</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">value</span>()); <span class="hljs-comment">// 0</span>
</code></pre>
<p>这里 <code>increment</code>、<code>decrement</code>、<code>value</code> 三个函数都形成了闭包，<strong>共享同一个</strong> <code>count</code> <strong>变量</strong>。它们的 <code>[[Environment]]</code> 都指向 <code>createCounter</code> 的词法环境。</p>
<h2 data-id="heading-10">四、常见误区与陷阱</h2>
<h3 data-id="heading-11">4.1 误区一：“只有返回函数才算闭包”</h3>
<p><strong>错误！</strong> 任何函数只要访问了其外部作用域的变量，就形成了闭包，无论是否被返回。</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">globalVar</span> = <span class="hljs-string">'global'</span><span class="hljs-comment">;</span>


function outer() {
  let <span class="hljs-attr">outerVar</span> = <span class="hljs-string">'outer'</span><span class="hljs-comment">;</span>
  
  function inner() {
    console.log(globalVar, outerVar)<span class="hljs-comment">; // 访问了外部变量 → 闭包</span>
  }
  
  inner()<span class="hljs-comment">; // 即使没有返回，inner 也是闭包</span>
}


outer()<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-12">4.2 误区二：“闭包会导致内存泄漏”</h3>
<p><strong>不完全正确。</strong> 闭包确实会延长变量的生命周期，但这<strong>不是内存泄漏</strong>，而是预期行为。</p>
<p>真正的内存泄漏是指：<strong>无用的数据因错误引用而无法被垃圾回收</strong>。</p>
<p>例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> largeData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">'*'</span>);
  
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'button'</span>).<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Clicked'</span>);
    <span class="hljs-comment">// 即使没用到 largeData，闭包仍会持有它！</span>
  };
}
</code></pre>
<p>这里点击事件处理函数形成了闭包，无意中持有了 <code>largeData</code> 的引用，导致本可释放的大数组一直驻留内存。</p>
<p><strong>解决方案</strong>：显式断开引用</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> largeData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">'*'</span>);
  
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'button'</span>).<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Clicked'</span>);
  };
  
  <span class="hljs-comment">// 不再需要 largeData</span>
  largeData = <span class="hljs-literal">null</span>;
}
</code></pre>
<h3 data-id="heading-13">4.3 经典陷阱：循环中的闭包</h3>
<pre><code class="hljs language-css" lang="css">for (<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span> = <span class="hljs-number">0</span>; <span class="hljs-selector-tag">i</span> &lt; <span class="hljs-number">3</span>; <span class="hljs-selector-tag">i</span>++) {
  setTimeout(() =&gt; {
    console<span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">i</span>); // 输出: <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>
  }, <span class="hljs-number">100</span>);
}
</code></pre>
<p><strong>原因</strong>：<code>var</code> 声明的 <code>i</code> 是函数作用域，所有闭包共享同一个 <code>i</code>。当 <code>setTimeout</code> 执行时，循环早已结束，<code>i = 3</code>。</p>
<p><strong>解决方案</strong>：</p>
<h4 data-id="heading-14">方案一：使用 <code>let</code>（块级作用域）</h4>
<pre><code class="hljs language-css" lang="css">for (let <span class="hljs-selector-tag">i</span> = <span class="hljs-number">0</span>; <span class="hljs-selector-tag">i</span> &lt; <span class="hljs-number">3</span>; <span class="hljs-selector-tag">i</span>++) {
  setTimeout(() =&gt; {
    console<span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">i</span>); // 输出: <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>
  }, <span class="hljs-number">100</span>);
}
</code></pre>
<p><code>let</code> 为每次迭代创建新的绑定，每个闭包捕获的是不同的 <code>i</code>。</p>
<h4 data-id="heading-15">方案二：IIFE（立即调用函数表达式）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
  (<span class="hljs-keyword">function</span>(<span class="hljs-params">j</span>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(j); <span class="hljs-comment">// 输出: 0, 1, 2</span>
    }, <span class="hljs-number">100</span>);
  })(i);
}
</code></pre>
<h4 data-id="heading-16">方案三：<code>bind</code> 传参</h4>
<pre><code class="hljs language-css" lang="css">for (<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span> = <span class="hljs-number">0</span>; <span class="hljs-selector-tag">i</span> &lt; <span class="hljs-number">3</span>; <span class="hljs-selector-tag">i</span>++) {
  setTimeout(console<span class="hljs-selector-class">.log</span><span class="hljs-selector-class">.bind</span>(null, <span class="hljs-selector-tag">i</span>), <span class="hljs-number">100</span>);
}
</code></pre>
<p> </p>
<h2 data-id="heading-17">五、闭包的实际应用场景</h2>
<h3 data-id="heading-18">5.1 模块模式（Module Pattern）</h3>
<p>利用闭包实现<strong>私有变量和公共接口</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">CounterModule</span> = (<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>; <span class="hljs-comment">// 私有变量</span>
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> ++count,
    <span class="hljs-attr">decrement</span>: <span class="hljs-function">() =&gt;</span> --count,
    <span class="hljs-attr">getCount</span>: <span class="hljs-function">() =&gt;</span> count
  };
})();


<span class="hljs-comment">// 外部无法直接访问 count</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">CounterModule</span>.<span class="hljs-title function_">getCount</span>()); <span class="hljs-comment">// 0</span>
<span class="hljs-title class_">CounterModule</span>.<span class="hljs-title function_">increment</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">CounterModule</span>.<span class="hljs-title function_">getCount</span>()); <span class="hljs-comment">// 1</span>
</code></pre>
<p>这是 ES6 模块出现前最流行的封装方式。</p>
<h3 data-id="heading-19">5.2 函数柯里化（Currying）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-params">a</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">b</span>) {
    <span class="hljs-keyword">return</span> a * b;
  };
}


<span class="hljs-keyword">const</span> double = <span class="hljs-title function_">multiply</span>(<span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">double</span>(<span class="hljs-number">5</span>)); <span class="hljs-comment">// 10</span>


<span class="hljs-comment">// 或使用箭头函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">multiply</span> = a =&gt; <span class="hljs-function"><span class="hljs-params">b</span> =&gt;</span> a * b;
</code></pre>
<p>每个返回的函数都闭包了 <code>a</code> 的值。</p>
<h3 data-id="heading-20">5.3 防抖（Debounce）与节流（Throttle）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">func, delay</span>) {
  <span class="hljs-keyword">let</span> timeoutId;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-built_in">clearTimeout</span>(timeoutId);
    timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args), delay);
  };
}


<span class="hljs-keyword">const</span> debouncedSearch = <span class="hljs-title function_">debounce</span>(searchAPI, <span class="hljs-number">300</span>);
input.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, debouncedSearch);
</code></pre>
<p><code>debounce</code> 返回的函数闭包了 <code>timeoutId</code> 和 <code>func</code>，实现了状态保持。</p>
<h3 data-id="heading-21">5.4 事件处理器中的参数传递</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">attachListeners</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> buttons = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.btn'</span>);
  
  buttons.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">button, index</span>) =&gt;</span> {
    button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Button <span class="hljs-subst">${index}</span> clicked`</span>); <span class="hljs-comment">// 闭包捕获 index</span>
    });
  });
}
</code></pre>
<p>若不用闭包，很难在事件回调中获取循环索引。</p>
<h3 data-id="heading-22">5.5 缓存（Memoization）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">memoize</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">const</span> cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> key = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(args);
    <span class="hljs-keyword">if</span> (cache.<span class="hljs-title function_">has</span>(key)) {
      <span class="hljs-keyword">return</span> cache.<span class="hljs-title function_">get</span>(key);
    }
    <span class="hljs-keyword">const</span> result = fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
    cache.<span class="hljs-title function_">set</span>(key, result);
    <span class="hljs-keyword">return</span> result;
  };
}


<span class="hljs-keyword">const</span> fib = <span class="hljs-title function_">memoize</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> n;
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fib</span>(n - <span class="hljs-number">1</span>) + <span class="hljs-title function_">fib</span>(n - <span class="hljs-number">2</span>);
});
</code></pre>
<p>缓存对象 <code>cache</code> 被闭包保护，避免全局污染。</p>
<p> </p>
<h2 data-id="heading-23">六、闭包与 <code>this</code> 的交互</h2>
<p>闭包会捕获变量，但<strong>不会捕获</strong> <code>this</code>。<code>this</code> 的绑定取决于调用方式。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>,
  <span class="hljs-attr">greet</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> sayHello = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// undefined! this 指向全局</span>
    };
    <span class="hljs-title function_">sayHello</span>();
  }
};


obj.<span class="hljs-title function_">greet</span>();
</code></pre>
<p><strong>解决方案</strong>：</p>
<h4 data-id="heading-24">使用箭头函数（继承外层 this）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>,
  <span class="hljs-attr">greet</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">sayHello</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// 'Alice'</span>
    };
    <span class="hljs-title function_">sayHello</span>();
  }
};
</code></pre>
<h4 data-id="heading-25">显式绑定</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>,
  <span class="hljs-attr">greet</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// 闭包捕获 self</span>
    <span class="hljs-keyword">const</span> sayHello = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(self.<span class="hljs-property">name</span>); <span class="hljs-comment">// 'Alice'</span>
    };
    <span class="hljs-title function_">sayHello</span>();
  }
};
</code></pre>
<p> </p>
<h2 data-id="heading-26">七、性能考量与最佳实践</h2>
<h3 data-id="heading-27">7.1 内存占用</h3>
<p>闭包会阻止变量被垃圾回收，因此：</p>
<ul>
<li><strong>避免不必要的闭包</strong>：如果函数不需要访问外部变量，不要嵌套定义</li>
<li><strong>及时释放大对象引用</strong>：如前述 <code>largeData = null</code> 的例子</li>
</ul>
<h3 data-id="heading-28">7.2 调试困难</h3>
<p>闭包中的变量在调试器中可能显示为 <code>[[Scopes]]</code>，不易查看。建议：</p>
<ul>
<li>使用有意义的变量名</li>
<li>避免过深的嵌套</li>
</ul>
<h3 data-id="heading-29">7.3 最佳实践总结</h3>
<ol>
<li><strong>理解作用域链</strong>：清楚知道变量从哪里来</li>
<li><strong>谨慎使用闭包</strong>：只在需要保持状态或封装私有数据时使用</li>
<li><strong>注意循环陷阱</strong>：优先使用 <code>let</code> 而非 <code>var</code></li>
<li><strong>管理内存</strong>：及时解除对大型数据的引用</li>
<li><strong>利用现代语法</strong>：箭头函数简化 <code>this</code> 问题</li>
</ol>
<p> </p>
<h2 data-id="heading-30">八、闭包在现代 JavaScript 中的演进</h2>
<h3 data-id="heading-31">8.1 与块级作用域的协同</h3>
<p>ES6 的 <code>let</code>/<code>const</code> 与闭包结合，解决了经典循环问题，使代码更安全。</p>
<h3 data-id="heading-32">8.2 与模块系统的融合</h3>
<p>ES6 模块（ESM）本质上是<strong>顶级闭包</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// math.js</span>
<span class="hljs-keyword">let</span> privateVar = <span class="hljs-number">0</span>; <span class="hljs-comment">// 模块作用域，外部不可见</span>


<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> ++privateVar; <span class="hljs-comment">// 闭包访问 privateVar</span>
}
</code></pre>
<p>每个模块文件形成独立作用域，天然支持私有状态。</p>
<h3 data-id="heading-33">8.3 在 React Hooks 中的应用</h3>
<p>React 的 <code>useState</code>、<code>useEffect</code> 等 Hook 依赖闭包实现状态管理：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">Counter</span>() {
  const <span class="hljs-selector-attr">[count, setCount]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);
  
  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
      <span class="hljs-built_in">setCount</span>(c =&gt; c + <span class="hljs-number">1</span>); <span class="hljs-comment">// 闭包捕获 setCount</span>
    }, <span class="hljs-number">1000</span>);
    return () =&gt; <span class="hljs-built_in">clearInterval</span>(timer);
  }, <span class="hljs-selector-attr">[]</span>); <span class="hljs-comment">// 依赖项为空，只在挂载时执行</span>
  
  return &lt;<span class="hljs-selector-tag">div</span>&gt;{count}&lt;/<span class="hljs-selector-tag">div</span>&gt;;
}
</code></pre>
<p>若在 <code>setInterval</code> 回调中直接使用 <code>count</code>，会因闭包捕获旧值导致 bug，因此需使用函数式更新。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite 5大优化技巧：让你的构建速度飙升50%，开发者都在偷偷用！]]></title>    <link>https://juejin.cn/post/7585452404112801807</link>    <guid>https://juejin.cn/post/7585452404112801807</guid>    <pubDate>2025-12-20T04:16:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585452404112801807" data-draft-id="7585458459165818914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite 5大优化技巧：让你的构建速度飙升50%，开发者都在偷偷用！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-20T04:16:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite 5大优化技巧：让你的构建速度飙升50%，开发者都在偷偷用！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:16:30.000Z" title="Sat Dec 20 2025 04:16:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vite 5大优化技巧：让你的构建速度飙升50%，开发者都在偷偷用！</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在前端开发领域，构建工具的性能直接影响开发体验和生产力。Vite 作为新一代前端构建工具，凭借其原生 ESM 支持和极速的热更新能力，已经成为许多开发者的首选。然而，即使是性能优异的 Vite，在实际项目中也可能因为配置不当或使用方式欠佳而未能发挥全部潜力。本文将深入剖析 5 个经过实战检验的 Vite 优化技巧，帮助你将构建速度提升高达 50%，这些方法正在被众多高效能团队秘密使用。</p>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. 精准配置依赖预构建（OptimizeDeps）</h3>
<h4 data-id="heading-4">问题背景</h4>
<p>Vite 的核心优势之一是其依赖预构建机制，它将 CommonJS/UMD 模块转换为 ESM 格式并缓存以提高后续加载速度。然而，默认配置可能无法完美适应所有项目。</p>
<h4 data-id="heading-5">优化方案</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">optimizeDeps</span>: {
    <span class="hljs-attr">include</span>: [
      <span class="hljs-string">'vue'</span>,
      <span class="hljs-string">'pinia'</span>,
      <span class="hljs-string">'vue-router'</span>,
      <span class="hljs-comment">// 明确列出高频使用的大型库</span>
      <span class="hljs-string">'lodash-es'</span>,
      <span class="hljs-string">'axios'</span>
    ],
    <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'某些不需要预构建的库'</span>],
    <span class="hljs-attr">force</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'development'</span> ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>
  }
})
</code></pre>
<h4 data-id="heading-6">技术细节</h4>
<ul>
<li><strong>include</strong>：主动声明需要预构建的依赖项可以避免自动探测的开销</li>
<li><strong>force</strong>：生产环境强制重新构建确保一致性</li>
<li><strong>esbuildOptions</strong>：可通过此参数调整 ESBuild 的配置（如 target）</li>
</ul>
<p>实测数据：在包含50+依赖项的中型项目中，此项优化可减少15%-20%的冷启动时间。</p>
<h3 data-id="heading-7">2. Smart CSS Code Splitting</h3>
<h4 data-id="heading-8">CSS处理的瓶颈</h4>
<p>传统打包器会将所有CSS合并成单个文件，导致首屏加载不必要的样式代码。</p>
<h4 data-id="heading-9">Vite高级解决方案</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { splitVendorChunkPlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">css</span>: {
    <span class="hljs-attr">devSourcemap</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">postcss</span>: {
      <span class="hljs-comment">// PostCSS配置...</span>
    },
    <span class="hljs-attr">modules</span>: {
      <span class="hljs-attr">localsConvention</span>: <span class="hljs-string">'camelCaseOnly'</span>
    }
  },
  
})
</code></pre>
<p>结合以下实践：</p>
<ul>
<li><code>@import</code>替换为ESM导入（支持Tree Shaking）</li>
<li>CSS Modules自动作用域处理减少冗余代码</li>
<li>build.cssCodeSplit保持启用（默认true）</li>
</ul>
<p>效果验证：某电商项目应用后CSS体积减少38%，关键路径CSS缩减62%。</p>
<h3 data-id="heading-10">3. Advanced Cache Strategy</h3>
<h4 data-id="heading-11">Vite缓存机制深度利用</h4>
<p>Vite默认缓存位置在node_modules/.vite：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Linux/MacOS用户可将缓存移至内存文件系统</span>
<span class="hljs-built_in">export</span> VITE_CACHE_DIR=/dev/shm/vite_cache

<span class="hljs-comment"># Windows用户可用RAMDisk工具实现类似效果</span>
</code></pre>
<h4 data-id="heading-12">Programmatic Cache Control示例：</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createServer } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>

<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createServer</span>({
  
})

server.<span class="hljs-property">watcher</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'change'</span>, <span class="hljs-keyword">async</span> (file) =&gt; {
  
})
</code></pre>
<p>实际案例：某金融系统通过定制化缓存策略使HMR更新时间从1200ms降至400ms。</p>
<h3 data-id="heading-13">### ###4. Fine-Tuned Build Parallelism</h3>
<h4 data-id="heading-14">ESBuild多核优化秘诀：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  
}) 
</code></pre>
<p>需要配合以下环境变量：</p>
<pre><code class="hljs language-bash" lang="bash">

</code></pre>
<p>基准测试对比：</p>














<table><thead><tr><th>Worker数量</th><th>Build时间(s)</th><th>Memory占用</th></tr></thead><tbody><tr><td>Default(4)</td><td/></tr></tbody></table>
<h2 data-id="heading-15">##总结</h2></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙 SDK 发布实战：JWorker 上架 ohpm 全流程]]></title>    <link>https://juejin.cn/post/7585390679398989830</link>    <guid>https://juejin.cn/post/7585390679398989830</guid>    <pubDate>2025-12-20T04:42:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679398989830" data-draft-id="7585400495682994218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙 SDK 发布实战：JWorker 上架 ohpm 全流程"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS,TypeScript"/> <meta itemprop="datePublished" content="2025-12-20T04:42:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江澎涌"/> <meta itemprop="url" content="https://juejin.cn/user/1820446986338504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙 SDK 发布实战：JWorker 上架 ohpm 全流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1820446986338504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江澎涌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:42:58.000Z" title="Sat Dec 20 2025 04:42:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">零、前言</h2>
<p>分享一次完整的鸿蒙 HAR SDK 发布过程，以前几天发布的 <code>JWorker</code> SDK 为例。</p>
<blockquote>
<p><code>JWorker</code> 是一套简单易用的基于鸿蒙 Worker 的双向 RPC 通讯机制。</p>
<p>库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2Fdetail%2Fjworker" target="_blank" title="https://ohpm.openharmony.cn/#/cn/detail/jworker" ref="nofollow noopener noreferrer">ohpm.openharmony.cn/#/cn/detail…</a></p>
<p>仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FzincPower%2FJWorker" target="_blank" title="https://github.com/zincPower/JWorker" ref="nofollow noopener noreferrer">github.com/zincPower/J…</a></p>
</blockquote>
<p>话不多说，接下来分享每一步的操作细节。</p>
<h2 data-id="heading-1">一、添加 README.md、CHANGELOG.md、LICENSE 文件</h2>
<p><strong>在发布的模块中添加这三个文件，需要与模块的 <code>src</code> 文件夹同层级。</strong> 具体结构如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c33f55082134940919c79053252c504~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=jnPAwj%2FnnxuABZllC2ukPg9PZaw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">1、README.md 文件</h3>
<p>内容描述 SDK 怎么被安装和使用，还有个人或团队的介绍等。<strong>描述内容一定要包含 <code>ohpm install &lt;你发布的 SDK 名称&gt;</code></strong> ，否则上架审核时会被拒绝，并收到以下错误。</p>
<pre><code class="hljs language-css" lang="css">README<span class="hljs-selector-class">.md</span>中未包含安装命令：ohpm install xxx或ohpm <span class="hljs-selector-tag">i</span> xxx；
</code></pre>
<h3 data-id="heading-3">2、CHANGELOG.md 文件</h3>
<p>用于记录 SDK 每个版本的发布时间和修改内容。</p>
<h3 data-id="heading-4">3、LICENSE 开源许可证</h3>
<p>选择合适的开源许可证类型，例如：MIT、Apache-2.0 等。</p>
<blockquote>
<p>MIT：<a href="https://link.juejin.cn?target=https%3A%2F%2Fchoosealicense.com%2Flicenses%2Fmit%2F" target="_blank" title="https://choosealicense.com/licenses/mit/" ref="nofollow noopener noreferrer">choosealicense.com/licenses/mi…</a>
Apache-2.0：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.apache.org%2Flicenses%2FLICENSE-2.0.txt" target="_blank" title="https://www.apache.org/licenses/LICENSE-2.0.txt" ref="nofollow noopener noreferrer">www.apache.org/licenses/LI…</a></p>
</blockquote>
<p>具体内容可以从上面的链接中拷贝然后修改。以 MIT 为例，需要修改 <code>[year]</code> 和 <code>[fullname]</code> 两个值。</p>
<p><strong>值得注意：</strong></p>
<ul>
<li><code>[fullname]</code> 必须和 SDK 的 <code>oh-package.json5</code> 中 <code>name</code> 的值完全一致，否则上架审核时会被拒绝，并收到以下错误。</li>
</ul>

<pre><code class="hljs language-go" lang="go">LICENSE文件中许可证条款内容和oh-<span class="hljs-keyword">package</span>.json5文件中许可证名称不一致；
</code></pre>
<ul>
<li>修改 <code>oh-package.json5</code> 的 <code>license</code> 的类型，默认是 <code>Apache-2.0</code> ，<code>JWorker</code> 使用的是 <code>MIT</code> 所以需要进行修改。否则还是会报上面的错误。</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-comment">// 省略其他</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-5">4、让你的项目评分更高</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ca6986e68454a49a0ef0a09b6ba5be4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=CXz73NcDzjnk834sX9XHWj%2BuE70%3D" alt="" loading="lazy"/></p>
<p>如果想让 SDK 评分得满 50 分，则必须满足以下两点：</p>
<p>1、在 <code>oh-package.json5</code> 配置 <code>author</code>、<code>keywords</code>、<code>homepage</code> 和 <code>repository</code>，具体作用请看下面 json 配置。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-comment">// 项目名称</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"jworker"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 版本</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"一套简单易用的基于鸿蒙 Worker 的双向 RPC 通讯机制"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Index.ets"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 作者</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"江澎涌"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 开源协议类型</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>                                             
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 关键字，能够让你的仓库被搜索到</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>                                             
    <span class="hljs-string">"harmonyos"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"worker"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"rpc"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"communication"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"thread"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"多线程"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"emitter"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"线程通讯"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 主页</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/zincPower"</span><span class="hljs-punctuation">,</span>               
  <span class="hljs-comment">// 代码仓库</span>
  <span class="hljs-attr">"repository"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/zincPower/JWorker"</span><span class="hljs-punctuation">,</span>     
<span class="hljs-punctuation">}</span>
</code></pre>
<p>2、创建 example 目录，可以根据情况增加 README.md 和示例代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dca69f4bc0674b20914649496d1e23ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=j54LFJY6rrGmogZt8MfhZzfTRLw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">二、生成密钥</h2>
<p>通过以下命令生成密钥</p>
<pre><code class="hljs language-css" lang="css">ssh-keygen -m PEM -t RSA -<span class="hljs-selector-tag">b</span> <span class="hljs-number">4096</span> -f /<span class="hljs-selector-attr">[存放路径]</span>/<span class="hljs-selector-attr">[密钥名称]</span>
</code></pre>
<p>例如生成一个名称为 <code>ohos_publish_key</code> 的密钥，可以使用 <code>ssh-keygen -m PEM -t RSA -b 4096 -f ohos_publish_key</code> 进行生成，<strong>期间必须设置密钥密码，否则 OHPM 包管理器会拒绝。</strong> 过程如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/303817fba07c4dc7890675fdedd1677e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=nItvGZ4NcyBzG89PE0zwG5UKcy8%3D" alt="" loading="lazy"/></p>
<p>运行后会生成两个文件，私钥 <code>ohos_publish_key</code> 和 公钥 <code>ohos_publish_key.pub</code> 。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b438752956d84f479d91b287aceb985d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=nhsCG4Rwbt%2B%2BghhzLvG9JWyZUXE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">三、提交公钥</h2>
<p>进入到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2FpersonalCenter%2FsshKeys" target="_blank" title="https://ohpm.openharmony.cn/#/cn/personalCenter/sshKeys" ref="nofollow noopener noreferrer">OpenHarmony 三方库中心仓的 “个人中心-认证管理”</a>，根据下图所示，在 “认证管理-新增” 的弹框中填入刚才生成的公钥 <code>ohos_publish_key.pub</code> 的内容然后保存。</p>
<blockquote>
<p>如果没有 OpenHarmony 三方库中心仓的帐号先进行注册，这里就不再赘述。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37141d9286d04623812ff989365ac284~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=0OzZ95feus2k4emNgYR6RnDK7Xc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">四、本地配置私钥</h2>
<p>将刚生成的私钥 <code>ohos_publish_key</code> 进行配置，配置命令如下</p>
<pre><code class="hljs language-arduino" lang="arduino">ohpm config set key_path [ohos_publish_key 的路径]
</code></pre>
<p><strong>输入后如果遇到 <code>zsh: command not found: ohpm</code> 说明需要配置 ohpm</strong>，通过 <code>open ~/.zshrc</code> 打开配置，添加以下配置即可</p>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">OHPM_PATH</span>=/Users/[你的 mac 用户名]/Library/Huawei/ohpm/bin
export <span class="hljs-attr">PATH</span>=<span class="hljs-variable">${PATH}</span>:<span class="hljs-variable">${OHPM_PATH}</span>
</code></pre>
<p>配置后运行 <code>source ~/.zshrc</code> 或是重新打开 terminal 再次运行配置私钥命令即可。</p>
<h2 data-id="heading-9">五、配置发布码</h2>
<p>进入到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2FpersonalCenter%2Fnotifications" target="_blank" title="https://ohpm.openharmony.cn/#/cn/personalCenter/notifications" ref="nofollow noopener noreferrer">OpenHarmony 三方库中心仓的 “个人中心”</a> 在下图位置复制发布码</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b452e0bfbfdb4cfc905fa2e8d04cd11a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=GG5cw23plJ0owXdGSf8%2BASj5nVw%3D" alt="" loading="lazy"/></p>
<p>然后在 terminal 输入以下命令进行配置</p>
<pre><code class="hljs language-arduino" lang="arduino">ohpm config set publish_id [刚刚获取的发布码]
</code></pre>
<h2 data-id="heading-10">六、编译发布的 har 包</h2>
<p>在鸿蒙的开发 ide 中，先进行 <code>Build - Clean Project</code> 打扫项目，然后 <code>Build - Make Module '你的模块名'</code> 进行 HAR 包编译，如下图所示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c1fe89a7fab4913b199fe2586c81834~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=jV38xm7077CxMIovk0nKVTCKjgI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">七、发布 har 包</h2>
<p>进入到上图所示的 <code>default</code> 目录下，然后运行 <code>ohpm publish jworker.har</code> 进行发布，过程需要输入密钥的密码，输入后就完成了。过程如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea662e905f284c15bc95de0bfb105248~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=Y7f4KwO3wtbHn5aQgdNOL3mVnzI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">八、查看发布情况</h2>
<p>回到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2FpersonalCenter%2Fnotifications" target="_blank" title="https://ohpm.openharmony.cn/#/cn/personalCenter/notifications" ref="nofollow noopener noreferrer">OpenHarmony 三方库中心仓的 “个人中心”</a> 就可以看到对应的消息提示了，后续多留意 SDK 的审核情况。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f66a5a842af43cd84ab25bff6275343~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=hzpOhPh9xmB9dwOW3m4ub4pG7vc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">九、官方文档</h2>
<p>发布共享包：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fide-har-publish" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-har-publish" ref="nofollow noopener noreferrer">developer.huawei.com/consumer/cn…</a></p>
<p>编译HAR模块：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fide-har%23section7892044183814" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-har#section7892044183814" ref="nofollow noopener noreferrer">developer.huawei.com/consumer/cn…</a></p>
<h2 data-id="heading-14">十、作者博客</h2>
<p>掘金：<a href="https://juejin.cn/user/1820446986338504" target="_blank" title="https://juejin.cn/user/1820446986338504">juejin.cn/user/182044…</a></p>
<p>csdn：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_37625173" target="_blank" title="https://blog.csdn.net/weixin_37625173" ref="nofollow noopener noreferrer">blog.csdn.net/weixin_3762…</a></p>
<p>公众号：微信搜索 "江澎涌"</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95f0c6d5e0964c9795f3e8f5897f8311~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811587&amp;x-signature=%2Fe3VOoCeHwS8JOFzL7u72ZRPmxQ%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android AI解放生产力（五）实战：解放写API接口的繁琐工作]]></title>    <link>https://juejin.cn/post/7585289701793677338</link>    <guid>https://juejin.cn/post/7585289701793677338</guid>    <pubDate>2025-12-19T05:58:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585289701793677338" data-draft-id="7585005164726386726" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android AI解放生产力（五）实战：解放写API接口的繁琐工作"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-19T05:58:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TimeFine"/> <meta itemprop="url" content="https://juejin.cn/user/3913917123802615"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android AI解放生产力（五）实战：解放写API接口的繁琐工作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917123802615/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TimeFine
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T05:58:46.000Z" title="Fri Dec 19 2025 05:58:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    35
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>公司当前项目使用的是Apifox作为API调试/文档工具，所以以这个为例。市面上的工具应该都逐步开放了AI能力，需要关注一下，只要能提供原始数据就行，不能的话那也没办法喂给AI。</p>
<p>上一篇已经让AI写UI了，这一篇让AI写接口请求。首先思考一下可能碰到的问题。</p>
<h2 data-id="heading-0">一、可能遇到的问题</h2>
<p>默认网络请求用的retrofit，其它也是一通百通。</p>
<h3 data-id="heading-1">1、问题一：适配请求头</h3>
<p>项目中网络请求的拦截器已经定义了请求头，读取的原始数据如何关联？答案就是在skill中告诉AI，并让它模仿你的代码写。</p>
<h3 data-id="heading-2">2、问题二：适配请求参数中有一些公共部分</h3>
<p>项目中网络请求的拦截器已经定义了一些公共请求参数，读取的原始数据如何关联？例如：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">{
    <span class="hljs-string">"app"</span>: {
        <span class="hljs-string">"locale"</span>: <span class="hljs-string">"{{locale}}"</span>,
        <span class="hljs-string">"tid"</span>: <span class="hljs-string">"{{terminal_id}}"</span>,
        <span class="hljs-string">"platform"</span>: <span class="hljs-string">"{{platform}}"</span>
    },
    <span class="hljs-string">"data"</span>: {
        <span class="hljs-comment">//每个接口只有这里有差异</span>
    }
}
</code></pre>
<p>只有data块中有差异。答案其实同上，skill中告诉AI，并让它模仿你的代码。</p>
<h3 data-id="heading-3">3、问题三：返回数据脱壳</h3>
<p>例如项目中的壳是这样：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiResponse</span>&lt;<span class="hljs-type">T</span>&gt;(
    <span class="hljs-keyword">val</span> code: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">val</span> msg: String,
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T
) : BaseResponse&lt;T&gt;() {...}
</code></pre>
<p>那我们需要的解析的Data Class可能只需要脱壳的部分，如何让AI知道？答案也同上，skill中告诉AI，并让它模仿你的代码。</p>
<h3 data-id="heading-4">4、问题四：viewmodel中网络请求如何写</h3>
<p>道理同上。</p>
<h3 data-id="heading-5">5、问题五：代码放在哪个文件</h3>
<p>这个问题的解答要看情况了，我们先看下面只给代码的示例，最后再探讨一下这个问题。</p>
<h2 data-id="heading-6">二、获取接口原始数据</h2>
<p>这一步依赖MCP的开放能力，后端兄弟接口怎么定义的，字段怎么写的，Android如何封装Data Class都依赖这些原始数据。接下来看通过Apifox如何办到的。</p>
<p>Apifox的MCP现阶段还不能集成到Codex中使用，启动的时候会报错：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">⚠ MCP client <span class="hljs-keyword">for</span> `apifox_api_docs` failed to start: MCP startup failed: handshaking with MCP server failed: connection closed: initialize response
⚠ MCP startup incomplete (failed: apifox_api_docs)
</code></pre>
<p>原因是Apifox的MCP返回不符合Codex定义的规范。</p>
<p>那换其他方式，打开Apifox终端（当前V版本2.7.58 (2.7.58)），选择需要生成代码的接口：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2912582992aa4b93981239341d8f3546~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGltZUZpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766742632&amp;x-signature=59jJlOCs9ni4MWdY7lke9mdIFbg%3D" alt="image.png" loading="lazy"/></p>
<p>如上操作，可以得到复制的一段信息如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">请访问以下链接获取接口“天气信息V3”的接口定义信息：https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/%E5%A4%A9%E6%B0%6%81%AFv3-253061517?t=e0be3ab5-e8bf-4ec2-be81-f1489</span>
</code></pre>
<p>这样我们就拿到了接口的原始数据链接。</p>
<h2 data-id="heading-7">三、如何编辑skills</h2>
<p>这一步跟项目强关联，因为每个项目写法都不一样，文件不一样，所以skill的写法因项目而异。</p>
<p>先自己手动写一份粗糙的，然后给AI帮你改一改。</p>
<p>下面贴一份自己写的粗糙的，剔除敏感信息后的skill：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">---
name: api_to_request
description: 请访问链接获取接口定义信息。
---
## 请访问链接获取接口定义信息，给出如下要求的代码：

### <span class="hljs-number">1</span>、代码一：生成retrofit接口定义
`java/api` 文件夹内是定义的retrofit api 请求的接口，例如其中的一例：

<span class="hljs-comment">/**
 * 获取Camera Event事件
 */</span>
<span class="hljs-meta">@POST(<span class="hljs-string">"/v1/iot/camera/discoverXXX"</span>)</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">discoverXxx</span><span class="hljs-params">(<span class="hljs-meta">@Body</span> request: <span class="hljs-type">Request</span>)</span></span>: ApiResponse&lt;Response?&gt;

请按照链接中的请求类型给出类似上面的接口定义。

### <span class="hljs-number">2</span>、代码二：给出请求的<span class="hljs-meta">@Body</span>
一般的请求数据示例是下面这样的：

{
    <span class="hljs-string">"data"</span>: {
        <span class="hljs-string">"dev_id"</span>: <span class="hljs-string">"xxx"</span>
    },
    <span class="hljs-string">"app"</span>: {
        <span class="hljs-string">"locale"</span>: <span class="hljs-string">"en_AU"</span>,
        <span class="hljs-string">"tid"</span>: <span class="hljs-string">"8AE4EC1E36904B869D03FC9BABE4C087"</span>,
        <span class="hljs-string">"alias"</span>: <span class="hljs-string">"Kevin 的 A52"</span>,
        <span class="hljs-string">"platform"</span>: <span class="hljs-string">"foxx"</span>
    }
}

为了避免每次都给出重复的参数，我在retrofit添加了一个拦截器，请参考`AddPublicParamsInterceptor.kt`文件，这里是添加公共请求参数的地方。所以<span class="hljs-meta">@Body</span>中只需要给出<span class="hljs-keyword">data</span>节点的内容即可，如果<span class="hljs-keyword">data</span>节点内的内容为空，那就不需要给出任何参数，因为`AddPublicParamsInterceptor.kt`中会默认添加`{}`.

### <span class="hljs-number">3</span>、代码三：给出返回的response
返回的数据使用`ApiResponse.kt`剥壳，所以给出的response数据应该是剥壳后的数据，一般是一个<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>类。请参考`java/<span class="hljs-keyword">data</span>`文件夹内其他response的写法给出。

### <span class="hljs-number">4</span>、代码四：viewmodel中实际请求的代码
viewmodel中实际请求的代码请参考下面的代码给出：

    <span class="hljs-comment">/**
     * 获取设备同步授权码
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">syncAppDevice</span><span class="hljs-params">(
        buffer: <span class="hljs-type">MeshBanBindBuffer</span>,
        success: (<span class="hljs-type">Any</span>?) -&gt; <span class="hljs-type">Unit</span>,
        fail: (<span class="hljs-type">ApiHttpExceptionResponse</span>&lt;<span class="hljs-type">Any</span>?&gt;) -&gt; <span class="hljs-type">Unit</span>,
        error: (<span class="hljs-type">AppException</span>) -&gt; <span class="hljs-type">Unit</span>
    )</span></span> {
        <span class="hljs-keyword">val</span> request = SyncAppDeviceRequest(...)
        requestWithHttpException({ apiService.syncAppDevice(request) }, success = {
            success(it)
        }, fail = {
            fail(it)
        }, error = {
            error(it)
        })
    }
</code></pre>
<p>根据项目情况可以写的更丰富，更详细。</p>
<p>这一份是让AI改过后的，如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">---
name: api_to_request
description: 请访问链接获取接口定义信息。访问用户提供的接口文档链接，解析请求/响应结构，并按项目约定生成：Retrofit 接口、<span class="hljs-meta">@Body(data 节点)</span>、剥壳后的 Response <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>、以及优化后的 ViewModel 调用代码（全部用 Markdown 代码块输出）。
---

# 访问链接生成 Retrofit / Request / Response / ViewModel 代码

## 何时使用
当用户提供一个**接口定义链接**（Swagger/Apifox/Postman 文档/自研文档页面等），并要求按项目既定规范生成 Android(Kotlin) 网络层代码时使用。

## 输入
- 必须：接口文档链接（包含请求方式、path、请求体、返回体说明）
- 可选：项目约束/示例（已有 api service、已有 response/request 命名、字段命名风格、是否可空等）

## 输出（必须全部提供，且全部以 Markdown 代码块输出）
<span class="hljs-number">1.</span> **代码一：Retrofit 接口定义**（放入 `java/api` 对应 service）
<span class="hljs-number">2.</span> **代码二：请求 <span class="hljs-meta">@Body</span>（仅 <span class="hljs-keyword">data</span> 节点）**（Request <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> 或 Map 形态）
<span class="hljs-number">3.</span> **代码三：剥壳后的 Response <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>**（放入 `java/<span class="hljs-keyword">data</span>`）
<span class="hljs-number">4.</span> **代码四：ViewModel 中实际请求代码**（基于现有 `requestWithHttpException` 机制优化写法）

---

## 核心约定（严格遵守）
### A. Retrofit 接口风格
- 按接口文档的请求类型使用：`<span class="hljs-meta">@GET</span>/<span class="hljs-meta">@POST</span>/<span class="hljs-meta">@PUT</span>/<span class="hljs-meta">@DELETE</span>/...`
- 路径按文档给出，例如：`<span class="hljs-meta">@POST(<span class="hljs-string">"/v1/iot/camera/discoverEvents"</span>)</span>`
- 返回统一：`ApiResponse&lt;T?&gt;`
- KDoc 注释写清楚「做什么」
- 形参规则：
  - 若接口使用 body：使用 `<span class="hljs-meta">@Body</span> request: XxxRequest` 或 `<span class="hljs-meta">@Body</span> params: Map&lt;String, Any?&gt;`
  - 若 <span class="hljs-keyword">data</span> 节点为空：**不要要求调用方传参**
    - Retrofit 接口直接写成：`<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">xxx</span><span class="hljs-params">()</span></span>: ApiResponse&lt;Resp?&gt;`
    - 或（仅在必须显式 body 的场景）使用默认空对象：`<span class="hljs-meta">@Body</span> request: Map&lt;String, Any?&gt; = emptyMap()`

### B. 请求体只给 <span class="hljs-keyword">data</span> 节点
项目通过拦截器 `AddPublicParamsInterceptor.kt` 统一注入公共字段（例如 `app.locale/tid/alias/platform` 等），因此：
- `<span class="hljs-meta">@Body</span>` 只包含 `<span class="hljs-keyword">data</span>` 的内容
- 若 `<span class="hljs-keyword">data</span>` 为空，则调用方不传任何参数（或传 `{}` 由拦截器兜底）

### C. Response 必须“剥壳后”
网络返回会被 `ApiResponse.kt` 统一剥壳，因此你输出的 Response 类只描述真正业务数据结构：
- 输出为 `<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XxxResponse</span>(...)`
- 字段名遵循服务端返回字段（通常是 snake_case），按项目既有写法决定是否用 `<span class="hljs-meta">@SerializedName</span>`

### D. ViewModel 请求代码要更“干净”
在不破坏现有 `requestWithHttpException` 用法前提下，优化目标：
- 减少重复样板代码
- 参数构造更明确（优先 `buildMap {}` 或 request <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>）
- success/fail/error 的传递更简洁
- 方法命名、注释清晰一致

---

## 严格流程（每次都按此执行）
<span class="hljs-number">1.</span> **打开链接并提取接口定义**
   - 请求方式、path、query/path/header/body 结构
   - `<span class="hljs-keyword">data</span>` 节点字段清单、类型、必填/可选、枚举/限制
   - 返回体结构（剥掉外层 wrapper，仅保留业务 <span class="hljs-keyword">data</span>）
<span class="hljs-number">2.</span> **生成代码一：Retrofit 接口定义**
   - 按项目示例风格输出（参考 `java/api` 里的写法）
<span class="hljs-number">3.</span> **生成代码二：<span class="hljs-meta">@Body</span>（仅 <span class="hljs-keyword">data</span>）**
   - 若字段少且动态：用 `buildMap { put(...) }`
   - 若字段多/有嵌套：建 `XxxRequest` <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>（只含 <span class="hljs-keyword">data</span> 字段本体，不含 app）
<span class="hljs-number">4.</span> **生成代码三：Response <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>**
   - 仅业务字段，按返回体结构拆分嵌套类
   - 可空性：以文档标注为准；没标注时宁可保守为可空
<span class="hljs-number">5.</span> **生成代码四：ViewModel 调用（优化版）**
   - 统一用一个小型私有封装减少重复（示例见下方“推荐写法模板”）
<span class="hljs-number">6.</span> **最终输出格式固定**
   - 依次输出：代码一/二/三/四
   - 如需说明：放在代码块外的简短要点（不发散）

---

## 推荐写法模板（用于生成 ViewModel 优化版）
&gt; 你需要在生成 ViewModel 代码时尽量贴近此风格（不改变现有基础设施前提下）。

- 用一个私有方法把重复的 `requestWithHttpException(...)` 统一收敛：
  - `<span class="hljs-keyword">private</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">call</span><span class="hljs-params">(...)</span></span>`
- 请求参数：
  - Map：`<span class="hljs-keyword">val</span> params = buildMap { put(<span class="hljs-string">"dev_id"</span>, devId) }`
  - Request：`<span class="hljs-keyword">val</span> request = XxxRequest(...)`
- success/fail/error：
  - 直接透传 lambda，不要重复 `success(it)` 这种包一层的写法

---

## 你输出时的固定结构（必须遵守）
### 代码一：Retrofit 接口定义
<span class="hljs-comment">// 放在对应 ApiService 中</span>

### 代码二：<span class="hljs-meta">@Body</span>（仅 <span class="hljs-keyword">data</span>）
<span class="hljs-comment">// XxxRequest data class 或 buildMap 示例（二选一或都给，看接口复杂度）</span>

### 代码三：Response <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span>（剥壳后）
<span class="hljs-comment">// 放在 java/data 下，参考项目现有 response 写法</span>

### 代码四：ViewModel 请求代码（优化版）
<span class="hljs-comment">// 给出可直接粘贴的 ViewModel 方法（包含必要的私有封装）</span>

---

## 质量检查清单（输出前自检）
	•	Retrofit 注解的 HTTP 方法与 path 与文档一致
	•	<span class="hljs-meta">@Body</span> 只包含 <span class="hljs-keyword">data</span> 节点，且 <span class="hljs-keyword">data</span> 为空时不强迫传参
	•	Response 已剥壳：不再包含 ApiResponse 外层结构
	•	ViewModel 代码已减少重复样板，参数构造清晰，回调透传简洁
	•	所有代码均在 Markdown 代码块中输出

如果你接下来把“接口文档链接”贴出来，我就会按这个 skill 的流程输出 **四段代码**（并直接给出优化后的 ViewModel 写法）。


</code></pre>
<p>Apifox复制链接的内容因为匹配skill的<code>description</code>，所以给出链接就可以触发上面的skill。Codex生成的代码如下(剔除了敏感信息)：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">• 使用 api_to_request 技能，因为需要从接口文档生成 Retrofit 请求、请求体、响应体与 ViewModel 调用代码。(api.apifox.cn (https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/</span>
  %E5%A4%A9%E6%F%A1%E6%<span class="hljs-number">81</span>%AFv3-<span class="hljs-number">253061517</span>?t=e0be3ab5-e8bf-4ec2-be81-f148d9))

  代码一：Retrofit 接口定义(api.apifox.cn (https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/%E5%A4%A9%E6%A1%E6%81%AFv3-253061517?t=e0be3ab5-e8bf-4ec2-be81-</span>
  f14569))

  <span class="hljs-comment">/**
   * 天气信息V3
   */</span>
  <span class="hljs-meta">@POST(<span class="hljs-string">"/v1/iot/weather/getCurrentInfo"</span>)</span>
  <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCurrentInfoV3</span><span class="hljs-params">(<span class="hljs-meta">@Body</span> request: <span class="hljs-type">WeatherInfoV3Request</span>)</span></span>: ApiResponse&lt;WeatherInfoV3Response?&gt;

  代码二：<span class="hljs-meta">@Body</span>（仅 <span class="hljs-keyword">data</span> 节点）(api.apifox.cn (https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/%E5%A4%A9%E6%%E6%81%AFv3-253061517?t=e0be3ab5-e8bf-4ec2-be81-</span>
  f8569))

  <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherInfoV3Request</span>(
      <span class="hljs-keyword">var</span> lon: <span class="hljs-built_in">Double</span>,
      <span class="hljs-keyword">var</span> lat: <span class="hljs-built_in">Double</span>,
      <span class="hljs-keyword">var</span> unit: String = <span class="hljs-string">"IMPERIAL"</span> <span class="hljs-comment">// METRIC / IMPERIAL</span>
  )

  代码三：Response（剥壳后的 <span class="hljs-keyword">data</span>）(api.apifox.cn (https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/%E5%A4%A9%E6%F%A1%E6%81%AFv3-253061517?t=e0be3ab5-e8bf-4ec2-</span>
  be81-f18569))

  <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherInfoV3Response</span>(
      <span class="hljs-keyword">var</span> day: <span class="hljs-built_in">Boolean</span>?,
      <span class="hljs-keyword">var</span> weather: WeatherV3?,
      <span class="hljs-keyword">var</span> temperature: <span class="hljs-built_in">Double</span>?,
      <span class="hljs-keyword">var</span> wind: <span class="hljs-built_in">Double</span>?,
      <span class="hljs-keyword">var</span> pressure: <span class="hljs-built_in">Double</span>?,
      <span class="hljs-keyword">var</span> humidity: <span class="hljs-built_in">Double</span>?,
      <span class="hljs-keyword">var</span> aqi: String?
  )

  <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherV3</span>(
      <span class="hljs-keyword">var</span> condition: String?,
      <span class="hljs-keyword">var</span> icon: String?
  )

  代码四：ViewModel 中实际请求代码(api.apifox.cn (https:<span class="hljs-comment">//api.apifox.cn/temp-links/api/%E5%A4%A9%%A1%E6%81%AFv3-253061517?t=e0be3ab5-e8bf-4ec2-</span>
  be81-f1469))

  <span class="hljs-comment">/**
   * 获取天气信息V3
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCurrentInfoV3</span><span class="hljs-params">(
      lon: <span class="hljs-type">Double</span>,
      lat: <span class="hljs-type">Double</span>,
      unit: <span class="hljs-type">String</span> = <span class="hljs-string">"IMPERIAL"</span>,
      success: (<span class="hljs-type">WeatherInfoV3Response</span>?) -&gt; <span class="hljs-type">Unit</span>,
      fail: (<span class="hljs-type">ApiHttpExceptionResponse</span>&lt;<span class="hljs-type">Any</span>?&gt;) -&gt; <span class="hljs-type">Unit</span>,
      error: (<span class="hljs-type">AppException</span>) -&gt; <span class="hljs-type">Unit</span>
  )</span></span> {
      <span class="hljs-keyword">val</span> request = WeatherInfoV3Request(
          lon = lon,
          lat = lat,
          unit = unit
      )
      requestWithHttpException({ homeManagementApiService.getCurrentInfoV3(request) }, success = {
          success(it)
      }, fail = {
          fail(it)
      }, error = {
          error(it)
      })
  }

</code></pre>
<p>生成的代码可用度极高，很大程度上解放了生产力。</p>
<h2 data-id="heading-8">四、AI的放权</h2>
<p>AI生成的代码可用度这么高，那是不是应该放权直接让AI写文件呢？</p>
<p>1、如果是一个新项目，定义好项目架构后就大胆的让AI生成文件自己写代码吧，能”摸鱼"就别动手，人生苦短我用AI。</p>
<p>2、如果是一个成熟度高的项目，建议以小颗粒度的形式让AI生成或修改文件代码，这样影响的范围可控，git提交的时候请仔细审查AI生成的代码。</p>
<p>3、如果是一个成熟度高的项目，修改的需求复杂，牵扯面广，或者公司规定不让AI写代码只让辅助参考，那还是开只读模式自己写吧。</p>
<p>回到最上面的问题五：代码放哪个文件？</p>
<p>答案就简单了。</p>
<ul>
<li>项目架构清晰，让AI干活，可以完全让AI自主决策，后续自己调整。</li>
<li>可以在skill中添加提示加以引导，让AI放哪个文件/目录。</li>
<li>只读模式，自己处理AI生成的代码，前期可以开只读熟悉AI的使用，等熟练后就可以让AI自己写文件了。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 技术栈全解析：从模型编排到 RAG 实战]]></title>    <link>https://juejin.cn/post/7585138968167088164</link>    <guid>https://juejin.cn/post/7585138968167088164</guid>    <pubDate>2025-12-19T07:16:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585138968167088164" data-draft-id="7585214391827890219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 技术栈全解析：从模型编排到 RAG 实战"/> <meta itemprop="keywords" content="前端,LangChain,Python"/> <meta itemprop="datePublished" content="2025-12-19T07:16:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="编程干货铺"/> <meta itemprop="url" content="https://juejin.cn/user/52383084474680"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 技术栈全解析：从模型编排到 RAG 实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/52383084474680/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    编程干货铺
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T07:16:41.000Z" title="Fri Dec 19 2025 07:16:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34d91378c1684fe1862186d879886cd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766733401&amp;x-signature=%2BUR%2BIetRoN43mSOr0nfx8CNobII%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p>随着大语言模型能力的快速演进，真正的技术挑战已经不再是“如何调用模型”，而是：</p>
<ul>
<li>如何组织 Prompt</li>
<li>如何管理上下文</li>
<li>如何接入外部数据</li>
<li>如何构建多步骤推理流程</li>
<li>如何让模型在复杂任务中稳定工作</li>
</ul>
<p>LangChain 正是为解决这些问题而诞生的框架。</p>
<p>它不是一个模型，也不是一个简单的 SDK，而是一个<strong>用于构建 LLM 应用的应用层编排框架</strong>。</p>
<h2 data-id="heading-1">1. LangChain 是什么</h2>
<p>LangChain 是一个用于构建大模型应用（LLM Applications）的开源框架，其核心目标是：</p>
<blockquote>
<p><strong>将模型、提示词、数据源、工具和控制逻辑组织成可复用、可组合、可维护的应用流程。</strong></p>
</blockquote>
<p>在架构层面，LangChain 处于：</p>
<ul>
<li>大模型 API 之上</li>
<li>具体业务逻辑之下</li>
</ul>
<p>它承担的是 <strong>“AI 应用的中间层 / 编排层”</strong> 角色。</p>
<h2 data-id="heading-2">2. LangChain 解决了哪些问题</h2>
<p>在没有 LangChain 的情况下，LLM 应用通常存在以下问题：</p>
<ol>
<li>Prompt 分散在代码中，难以维护</li>
<li>多轮对话上下文不可控</li>
<li>检索、生成、工具调用逻辑耦合严重</li>
<li>难以构建多步骤推理流程</li>
<li>应用无法演进为复杂系统</li>
</ol>
<p>LangChain 的设计目标正是系统性地解决上述问题。</p>
<h2 data-id="heading-3">3. LangChain 的核心抽象模型</h2>
<p>LangChain 的能力建立在一组高度内聚的抽象之上：</p>









































<table><thead><tr><th>抽象</th><th>作用</th></tr></thead><tbody><tr><td>LLM / ChatModel</td><td>大模型统一接口</td></tr><tr><td>PromptTemplate</td><td>结构化提示词</td></tr><tr><td>Chain</td><td>可组合的执行流程</td></tr><tr><td>Memory</td><td>上下文与状态管理</td></tr><tr><td>Retriever</td><td>检索接口</td></tr><tr><td>VectorStore</td><td>向量存储</td></tr><tr><td>Tool</td><td>外部能力封装</td></tr><tr><td>Agent</td><td>推理 + 决策控制器</td></tr></tbody></table>
<p>这些抽象共同构成了 LangChain 的技术骨架。</p>
<h2 data-id="heading-4">4. 安装与基础调用</h2>
<h3 data-id="heading-5">JavaScript</h3>
<pre><code class="hljs language-bash" lang="bash">npm install langchain @langchain/openai
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;

<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4o-mini"</span>
});

<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">"用一句话说明 LangChain 的作用"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">content</span>);
</code></pre>
<h3 data-id="heading-6">Python</h3>
<pre><code class="hljs language-bash" lang="bash">pip install langchain langchain-openai
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

model = ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>)
resp = model.invoke(<span class="hljs-string">"用一句话说明 LangChain 的作用"</span>)
<span class="hljs-built_in">print</span>(resp.content)
</code></pre>
<h2 data-id="heading-7">5. PromptTemplate：结构化提示词</h2>
<p>PromptTemplate 用于将 Prompt 从字符串提升为可配置对象。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PromptTemplate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/prompts"</span>;

<span class="hljs-keyword">const</span> prompt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PromptTemplate</span>({
  <span class="hljs-attr">template</span>: <span class="hljs-string">"请解释 {concept} 的核心作用"</span>,
  <span class="hljs-attr">inputVariables</span>: [<span class="hljs-string">"concept"</span>]
});

<span class="hljs-keyword">const</span> text = <span class="hljs-keyword">await</span> prompt.<span class="hljs-title function_">format</span>({ <span class="hljs-attr">concept</span>: <span class="hljs-string">"LangChain"</span> });
</code></pre>
<p>优势在于：</p>
<ul>
<li>参数明确</li>
<li>可复用</li>
<li>易组合</li>
</ul>
<h2 data-id="heading-8">6. Chain：构建可组合的执行流程</h2>
<p>Chain 是 LangChain 的核心执行单元。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">LLMChain</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/chains"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;

<span class="hljs-keyword">const</span> chain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LLMChain</span>({
  <span class="hljs-attr">llm</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4o-mini"</span> }),
  prompt
});

<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">concept</span>: <span class="hljs-string">"Chain 机制"</span> });
</code></pre>
<p>Chain 使得 <strong>Prompt → 模型 → 输出</strong> 成为一个标准化流程单元。</p>
<h2 data-id="heading-9">7. Memory：上下文与状态管理</h2>
<p>Memory 用于控制模型可感知的历史上下文。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConversationChain</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/chains"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BufferMemory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/memory"</span>;

<span class="hljs-keyword">const</span> chain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConversationChain</span>({
  <span class="hljs-attr">llm</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>(),
  <span class="hljs-attr">memory</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferMemory</span>()
});
</code></pre>
<p>Memory 的存在，使多轮对话和状态管理成为一等能力。</p>
<h2 data-id="heading-10">8. 向量化与检索：RAG 的技术基础</h2>
<p>RAG（Retrieval-Augmented Generation）并不是一个模型，而是一种架构模式。</p>
<p>LangChain 将 RAG 拆解为三个核心组件：</p>
<ol>
<li><strong>Text Splitter</strong>：文本分割</li>
<li><strong>Embedding</strong>：向量化</li>
<li><strong>VectorStore / Retriever</strong>：检索接口</li>
</ol>
<h2 data-id="heading-11">9. LangChain RAG 实战案例</h2>
<p>下面是一个结构完整、可运行的 LangChain RAG 示例（简化版）。</p>
<h3 data-id="heading-12">9.1 文档准备与切分</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RecursiveCharacterTextSplitter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/text_splitter"</span>;

<span class="hljs-keyword">const</span> text = <span class="hljs-string">`
LangChain 是一个用于构建大语言模型应用的框架，
核心目标是将模型、数据、工具组织成可维护的流程。
`</span>;

<span class="hljs-keyword">const</span> splitter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RecursiveCharacterTextSplitter</span>({
  <span class="hljs-attr">chunkSize</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attr">chunkOverlap</span>: <span class="hljs-number">20</span>
});

<span class="hljs-keyword">const</span> docs = <span class="hljs-keyword">await</span> splitter.<span class="hljs-title function_">splitText</span>(text);
</code></pre>
<h3 data-id="heading-13">9.2 向量化并存入向量库</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">OpenAIEmbeddings</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MemoryVectorStore</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/vectorstores/memory"</span>;

<span class="hljs-keyword">const</span> vectorStore = <span class="hljs-keyword">await</span> <span class="hljs-title class_">MemoryVectorStore</span>.<span class="hljs-title function_">fromTexts</span>(
  docs,
  docs.<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> ({})),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAIEmbeddings</span>()
);
</code></pre>
<h3 data-id="heading-14">9.3 基于检索的问答</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> vectorStore.<span class="hljs-title function_">similaritySearch</span>(
  <span class="hljs-string">"LangChain 的核心作用是什么？"</span>,
  <span class="hljs-number">2</span>
);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(results.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">pageContent</span>));
</code></pre>
<h3 data-id="heading-15">9.4 结合模型生成最终回答</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;

<span class="hljs-keyword">const</span> context = results.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">pageContent</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>);

<span class="hljs-keyword">const</span> answer = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>().<span class="hljs-title function_">invoke</span>(
  <span class="hljs-string">`基于以下资料回答问题：\n<span class="hljs-subst">${context}</span>\n\n问题：LangChain 的作用是什么？`</span>
);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(answer.<span class="hljs-property">content</span>);
</code></pre>
<h2 data-id="heading-16">10. Agent 与工具调用（进阶能力）</h2>
<p>LangChain 的 Agent 允许模型在运行时：</p>
<ul>
<li>判断是否需要工具</li>
<li>选择合适的工具</li>
<li>执行并整合结果</li>
</ul>
<p>这是构建复杂 AI 系统的重要基础。</p>
<h2 data-id="heading-17">11. LangChain 的典型应用方向</h2>
<ul>
<li>企业知识库问答（RAG）</li>
<li>智能客服系统</li>
<li>AI 助手与自动化 Agent</li>
<li>多步骤任务执行系统</li>
<li>AI 中台与能力编排层</li>
</ul>
<h2 data-id="heading-18">结语</h2>
<p>LangChain 的价值不在于“帮你写 Prompt”，
而在于 <strong>让大模型应用具备工程结构和系统能力</strong>。</p>
<p>当 LLM 应用从 Demo 走向生产环境，
LangChain 几乎是绕不开的技术栈之一。</p>
<p>如果你正在构建真实的 AI 应用系统，
理解并掌握 LangChain，是非常值得投入的一步。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/821171844b6a4abd9daca23c087ca843~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766733401&amp;x-signature=t%2BlH9D0aw1%2FGLxs%2F7KMsGinvAV8%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d7fe2ec0c944a17a9c76e01962d29b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766733401&amp;x-signature=dGohuWQhcg7B7gfcZo5N0A6%2FWoA%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 性能优化：5个被低估的V8引擎技巧让你的代码提速50%]]></title>    <link>https://juejin.cn/post/7585097023747915791</link>    <guid>https://juejin.cn/post/7585097023747915791</guid>    <pubDate>2025-12-19T04:16:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585097023747915791" data-draft-id="7585130590291656719" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 性能优化：5个被低估的V8引擎技巧让你的代码提速50%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-19T04:16:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 性能优化：5个被低估的V8引擎技巧让你的代码提速50%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T04:16:53.000Z" title="Fri Dec 19 2025 04:16:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    29
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>JavaScript 性能优化：5个被低估的V8引擎技巧让你的代码提速50%</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在现代Web开发中，JavaScript的性能优化是一个永恒的话题。随着V8引擎的不断进化，许多开发者可能并未充分挖掘其潜力。V8作为Chrome和Node.js的核心引擎，通过即时编译（JIT）、隐藏类（Hidden Classes）、内联缓存（Inline Caching）等技术大幅提升了JavaScript的执行效率。然而，许多优化技巧仍被低估或忽视。本文将深入探讨5个鲜为人知的V8引擎技巧，帮助你将代码性能提升高达50%。</p>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. <strong>利用隐藏类（Hidden Classes）避免动态属性分配</strong></h3>
<p>V8通过隐藏类来优化对象属性访问。当对象的结构（即属性的顺序和类型）频繁变化时，V8会创建多个隐藏类，导致性能下降。例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 反例：动态添加属性</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = {};
  user.<span class="hljs-property">name</span> = <span class="hljs-string">"John"</span>;
  user.<span class="hljs-property">age</span> = <span class="hljs-number">30</span>; <span class="hljs-comment">// V8会为每次属性添加创建新的隐藏类</span>
  <span class="hljs-keyword">return</span> user;
}

<span class="hljs-comment">// 正例：一次性初始化所有属性</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUserOptimized</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = { <span class="hljs-attr">name</span>: <span class="hljs-string">"John"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> }; <span class="hljs-comment">// V8只需创建一个隐藏类</span>
  <span class="hljs-keyword">return</span> user;
}
</code></pre>
<p><strong>优化建议</strong>：</p>
<ul>
<li>尽量在对象构造时一次性定义所有属性。</li>
<li>避免在运行时动态删除或重新排序属性。</li>
</ul>
<h3 data-id="heading-4">2. <strong>避免数字类型的频繁切换（Smi vs. Heap Number）</strong></h3>
<p>V8对数字有两种内部表示形式：</p>
<ul>
<li><strong>Smi</strong>（Small Integer）：31位有符号整数，直接存储在对象中，访问速度快。</li>
<li><strong>Heap Number</strong>：双精度浮点数，存储在堆中，访问较慢。</li>
</ul>
<p>频繁切换这两种类型会导致性能损失：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>; <span class="hljs-comment">// Smi</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1e6</span>; i++) {
  count += i; <span class="hljs-comment">// 保持Smi类型</span>
}

<span class="hljs-keyword">let</span> floatCount = <span class="hljs-number">0.1</span>; <span class="hljs-comment">// Heap Number</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1e6</span>; i++) {
  floatCount += i; <span class="hljs-comment">// V8需要反复切换类型</span>
}
</code></pre>
<p><strong>优化建议</strong>：</p>
<ul>
<li>在密集计算中尽量使用整数（Smi）。</li>
<li>避免混合整数和浮点运算。</li>
</ul>
<h3 data-id="heading-5">3. <strong>利用内联缓存（Inline Caching）优化函数调用</strong></h3>
<p>V8通过内联缓存记录函数调用点的类型信息，加速后续调用。如果函数参数类型不稳定，会导致缓存失效（Megamorphic状态）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 反例：多态参数导致内联缓存失效</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">return</span> a + b;
}
<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);       <span class="hljs-comment">// IC记录Number类型</span>
<span class="hljs-title function_">add</span>(<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>);   <span class="hljs-comment">// IC失效，重新学习String类型</span>

<span class="hljs-comment">// 正例：保持参数类型一致</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addNumbers</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">return</span> a + b;
}
<span class="hljs-title function_">addNumbers</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">// IC始终有效</span>
</code></pre>
<p><strong>优化建议</strong>：</p>
<ul>
<li>确保高频调用的函数参数类型稳定。</li>
<li>避免在热代码路径中使用<code>arguments</code>或动态参数。</li>
</ul>
<p>###4. <strong>谨慎使用<code>try-catch</code>和<code>with</code>语句</strong></p>
<p>V8会对包含<code>try-catch</code>或<code>with</code>的函数禁用某些优化（如函数内联）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// try-catch影响性能</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">riskyOperation</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// ...可能抛出异常的操作...</span>
    } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e);
    }
}

<span class="hljs-comment">// Node.js中更高效的错误处理方式：</span>
<span class="hljs-keyword">if</span> (errorProneCondition) {
    process.<span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"..."</span>); });
}
</code></pre>
<p><strong>优化建议</strong>：</p>
<ul>
<li>将<code>try-catch</code>移至外层或非关键路径。</li>
<li>完全避免使用<code>with</code>语句（已废弃）。</li>
</ul>
<p>###5. <strong>预编译正则表达式并利用持久化匹配状态</strong></p>
<p>正则表达式在V8中会被编译为原生代码，但重复编译会拖慢性能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//  反例：每次循环重新编译正则 </span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i =  <span class="hljs-number">0</span> ; i &lt;  <span class="hljs-number">1000</span> ; i++) { 
    <span class="hljs-regexp">/test(\d+)/</span>.<span class="hljs-title function_">exec</span>(<span class="hljs-string">"test123"</span>); 
} 

<span class="hljs-comment">//  正例：预编译正则 </span>
<span class="hljs-keyword">const</span> regex = <span class="hljs-regexp">/test(\d+)/</span>; 
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i =  <span class="hljs-number">0</span> ; i &lt;  <span class="hljs-number">1000</span> ; i++) { 
    regex.<span class="hljs-title function_">exec</span>(<span class="hljs-string">"test123"</span>); 
} 

<span class="hljs-comment">//  进阶技巧：复用RegExp实例的lastIndex </span>
<span class="hljs-keyword">const</span> globalRegex = <span class="hljs-regexp">/test(\d+)/g</span>; 
globalRegex.<span class="hljs-property">lastIndex</span> =  <span class="hljs-number">0</span> ; <span class="hljs-comment">//  显式重置位置 </span>
<span class="hljs-keyword">while</span> ((match = globalRegex.<span class="hljs-title function_">exec</span>(input)) !== <span class="hljs-literal">null</span>) { ... }
</code></pre>
<h2 data-id="heading-6">总结</h2>
<p>通过深入理解V8的工作原理并调整编码习惯 ——从对象构造、数字处理到函数设计——开发者可以显著提升JavaScript的执行效率</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android AI解放生产力（六）实战：解放页面开发前的繁琐工作]]></title>    <link>https://juejin.cn/post/7585121055037358130</link>    <guid>https://juejin.cn/post/7585121055037358130</guid>    <pubDate>2025-12-19T06:59:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585121055037358130" data-draft-id="7585121055036964914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android AI解放生产力（六）实战：解放页面开发前的繁琐工作"/> <meta itemprop="keywords" content="架构,Android"/> <meta itemprop="datePublished" content="2025-12-19T06:59:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TimeFine"/> <meta itemprop="url" content="https://juejin.cn/user/3913917123802615"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android AI解放生产力（六）实战：解放页面开发前的繁琐工作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917123802615/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TimeFine
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T06:59:54.000Z" title="Fri Dec 19 2025 06:59:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    34
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一般开发一个新页面的工作是这样的:</p>
<ul>
<li>新建Activity/Fragment，里面会各种继承和默认实现的函数。</li>
<li>新建ViewModel，也是继承和基础实现。</li>
<li>如果有RecyclerView还要创建Adapter。</li>
</ul>
<p>大部分开发者估计都是拷贝之前的文件然后改改就用了，但是拷贝这些文件是不是很繁琐？以后这些活交给AI来干。首先思考一下可能碰到的问题。</p>
<h2 data-id="heading-0">一、可能碰到的问题</h2>
<h3 data-id="heading-1">1、文件名的定义</h3>
<p>如果要生成Activity，Fragment，ViewModel，Adapter，ViewBinding等，文件名要怎么取？
答案是按项目的命名规范告诉AI即可，例如要创建AboutActivity，告诉AI对应的Fragment应该是AboutFragment，ViewModel应该是AboutViewModel，Adapter应该是AboutAdapter，ViewBding应该是ActivityAboutBinding，如果是XML布局文件来写UI，布局文件应该是activity_about。在skill中描述清楚。</p>
<h3 data-id="heading-2">2、文件放哪儿</h3>
<p>上一篇有讨论这个问题，可以见上篇。</p>
<h2 data-id="heading-3">二、编辑skill</h2>
<p>还是让AI只给出代码。</p>
<p>需要在skill中描述生成哪些文件以及每个文件应该如何参考项目的模版代码生成。下面是一份手动写的简单示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">---
name: new_page_dev
description: 新页面开发生成Activity。
---
## 创建Activity等并给出如下要求的代码：

### <span class="hljs-number">1</span>、代码一：创建对应的Activity
可以参考`MyOrdersActivity`这个Activity。

布局文件的Binding按规则:例如AActivity, 那么viewbinding就是ActivityABinding，我会在后续补充这个布局文件。

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyOrdersActivity</span> : <span class="hljs-type">BaseVBActivity</span>&lt;<span class="hljs-type">ActivityMyOrdersListBinding</span>&gt;() {

    <span class="hljs-comment">//涉及具体项目代码，略，根据自己的项目模版代码编辑</span>

}
请参照上面的模版代码给出。

给出AndroidManifest清单文件注册的代码。

### <span class="hljs-number">2</span>、代码二：给出ViewModel的代码
ViewModel的命名规则如果是AActivity,那么ViewModel就是AViewModel。

AViewModel的创建可参考的代码为：
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AlertDetailsViewModel</span>(savedStateHandle: SavedStateHandle) : BaseViewModel() {

    <span class="hljs-comment">//涉及具体项目代码，略，根据自己的项目模版代码编辑</span>
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {

    }
}

### <span class="hljs-number">3</span>、代码三：给出Adapter的代码

Adapter的命名规则同上。

可参考的Adapter的代码：

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyOrdersListAdapter</span> : <span class="hljs-type">BaseQuickAdapter</span>&lt;<span class="hljs-type">PlanDetails, QuickViewHolder</span>&gt;() {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">QuickViewHolder</span>, position: <span class="hljs-type">Int</span>, item: <span class="hljs-type">PlanDetails</span>?)</span></span> {
        <span class="hljs-keyword">val</span> binding = ItemMyOrdersInfoBinding.bind(holder.itemView)
        item?.apply {
        	<span class="hljs-comment">//TODO</span>
            }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: QuickViewHolder {
        <span class="hljs-keyword">return</span> QuickViewHolder(R.layout.item_my_orders_info, parent)
    }
}

</code></pre>
<p>根据项目的实际情况编辑上面的skill。<strong>给AI让它帮你修改成标准格式的skill</strong>，因为跟项目代码关联，这里没办法贴出我的。</p>
<p>在Codex Cli中输入：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">新页面开发生成AboutActivity
</code></pre>
<p>下面是AI生成的结果：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"> Using skill new_page_dev to generate the Activity/ViewModel/Adapter skeletons.

  <span class="hljs-comment">//...略...</span>

  <span class="hljs-keyword">class</span> <span class="hljs-title class_">AboutActivity</span> : <span class="hljs-type">BaseVBActivity</span>&lt;<span class="hljs-type">ActivityAboutBinding</span>&gt;() {

      <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> viewModel <span class="hljs-keyword">by</span> viewModels&lt;AboutViewModel&gt;()
      <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> mAdapter = AboutAdapter()
      <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> mDataList = mutableListOf&lt;Any&gt;()

      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createViewBinding</span><span class="hljs-params">(inflater: <span class="hljs-type">LayoutInflater</span>)</span></span>: ActivityAboutBinding {
          <span class="hljs-keyword">return</span> ActivityAboutBinding.inflate(inflater)
      }

      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
          multiStateContainer = MultiStatePage.bindMultiState(binding.rlContainer)
          initAdapter()
          requestData(<span class="hljs-literal">true</span>)
      }

      <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initAdapter</span><span class="hljs-params">()</span></span> {
          binding.rcy.layoutManager = LinearLayoutManager(<span class="hljs-keyword">this</span>)
          binding.rcy.adapter = mAdapter
          binding.refreshLayout.setEnableFooterFollowWhenNoMoreData(<span class="hljs-literal">true</span>)
      }

      <span class="hljs-meta">@SuppressLint(<span class="hljs-string">"NotifyDataSetChanged"</span>)</span>
      <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">requestData</span><span class="hljs-params">(isShowLoading: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">false</span>)</span></span> {
          <span class="hljs-keyword">if</span> (isShowLoading) {
              multiStateContainer.showLoading()
          }
          <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> request data and update mDataList / adapter</span>
      }

      <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showError</span><span class="hljs-params">()</span></span> {
          multiStateContainer.showErrorCustom {
              requestData(<span class="hljs-literal">true</span>)
          }
      }

      <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showEmpty</span><span class="hljs-params">()</span></span> {
          multiStateContainer.showEmptyCustom()
      }

      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createObserver</span><span class="hljs-params">()</span></span> {

      }
  }

  <span class="hljs-comment">//...略...</span>

  <span class="hljs-keyword">class</span> <span class="hljs-title class_">AboutViewModel</span>(savedStateHandle: SavedStateHandle) : BaseViewModel() {

      <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {

      }
  }

  <span class="hljs-comment">//...略...</span>

  <span class="hljs-keyword">class</span> <span class="hljs-title class_">AboutAdapter</span> : <span class="hljs-type">BaseQuickAdapter</span>&lt;<span class="hljs-type">Any, QuickViewHolder</span>&gt;() {

      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">QuickViewHolder</span>, position: <span class="hljs-type">Int</span>, item: <span class="hljs-type">Any</span>?)</span></span> {
          <span class="hljs-keyword">val</span> binding = ItemAboutBinding.bind(holder.itemView)
          item?.apply {
              <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> bind item</span>
          }
      }

      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: QuickViewHolder {
          <span class="hljs-keyword">return</span> QuickViewHolder(R.layout.item_about, parent)
      }
  }

  Confirm the target <span class="hljs-keyword">package</span> and whether <span class="hljs-keyword">this</span> page <span class="hljs-keyword">is</span> list-based (RecyclerView). If not, I can simplify the Activity and remove the adapter scaffold.
</code></pre>
<p>代码完全可用，开启写的权限，复制粘贴都省了。</p>
<h2 data-id="heading-4">三、总结</h2>
<p>实战的三篇分别解决了：</p>
<ul>
<li>根据需求创建模板文件；</li>
<li>通过Figma MCP加skill生成UI；</li>
<li>通过Apifox加skill生成接口数据；</li>
</ul>
<p>作为开发者：</p>
<ul>
<li>基本不用写UI了；</li>
<li>不用写接口接入那一套流程了；</li>
<li>不用操作创建一堆文件那一套流程了；</li>
</ul>
<p>重心只需要放在需求和数据对接的代码即可，极大的解放了生成力。</p>
<p>如果终端开多个窗口跑，同时完成上面的工作，效率会进一步提高。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[查看项目中无引用到的文件、函数]]></title>    <link>https://juejin.cn/post/7585180150254665743</link>    <guid>https://juejin.cn/post/7585180150254665743</guid>    <pubDate>2025-12-19T08:09:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585180150254665743" data-draft-id="7585130590292803599" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="查看项目中无引用到的文件、函数"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-19T08:09:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端小黑屋"/> <meta itemprop="url" content="https://juejin.cn/user/4476867078793198"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            查看项目中无引用到的文件、函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4476867078793198/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端小黑屋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T08:09:19.000Z" title="Fri Dec 19 2025 08:09:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">unimported 查看没有引用的文件</h2>
<ol>
<li>全局安装 unimported</li>
</ol>

<pre><code class="hljs">npm install -g unimported
</code></pre>
<p>2.  在 package.json 的 scripts 增加</p>

<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>   
  <span class="hljs-attr">"analyze:deadcode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"unimported &amp;&amp; webpack --profile --json &gt; stats.json"</span> 
<span class="hljs-punctuation">}</span> 
</code></pre>
<p>3.  增加文件 .unimportedrc.json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"entry"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"src/app.{js,ts,jsx,tsx}"</span><span class="hljs-punctuation">,</span>       
      <span class="hljs-string">"src/app.config.{js,ts}"</span><span class="hljs-punctuation">,</span>        
      <span class="hljs-string">"src/pages/**/*.{js,ts,jsx,tsx}"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ignore"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"**/node_modules/**"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"**/dist/**"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"**/*.d.ts"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"**/*.test.{js,ts}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"**/*.spec.{js,ts}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"**/__mocks__/**"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"project.config.json"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"config/**/*.js"</span>                 
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ignoreUnused"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"src/types/**/*.d.ts"</span><span class="hljs-punctuation">,</span>           
      <span class="hljs-string">"src/assets/**/*"</span><span class="hljs-punctuation">,</span>               
      <span class="hljs-string">"src/styles/**/*.{css,scss,less}"</span> 
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>

</code></pre>
<ol start="4">
<li>然后运行</li>
</ol>

<pre><code class="hljs language-arduino" lang="arduino">npm run analyze:deadcode
</code></pre>
<p>运行后输出以下内容，列出未引用的文件</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4de9e4fd21245489615a219e78d9c4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5bCP6buR5bGL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736559&amp;x-signature=0icGhst%2FzCElAcUTPmz9SSRfTTw%3D" alt="image.png" loading="lazy"/></p>
<p>注意
有些小程序页面 A 也会有 /component 的组件，只给页面A用，
但是 <code>"src/pages/**/*.{js,ts,jsx,tsx}"</code> 会涵盖掉，不会把A的无用组件列出来，
这种情况下，小程序最好每个页面的路径都列出来，例如以下，这样可以更加精确的定位到每个页面ABCD里面的component是否真正有被使用</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"entry"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"src/app.{js,ts,jsx,tsx}"</span><span class="hljs-punctuation">,</span>       
      <span class="hljs-string">"src/app.config.{js,ts}"</span><span class="hljs-punctuation">,</span>        
      <span class="hljs-string">"src/pages/index/index.{js,ts,jsx,tsx,config.ts}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"src/pages/home/index.{js,ts,jsx,tsx,config.ts}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"src/pages/category/index.{js,ts,jsx,tsx,config.ts}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"src/pages/cart/index.{js,ts,jsx,tsx,config.ts}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"src/pages/mine/index.{js,ts,jsx,tsx,config.ts}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"src/pages/product/detail/index.{js,ts,jsx,tsx,config.ts}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"src/pages/product/content-hub/index.{js,ts,jsx,tsx,config.ts}"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ignore"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ignoreUnused"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-1">使用Webpack插件 webpack-deadcode-plugin 查看未使用的函数和变量</h2>
<ol>
<li>安装 webpack-deadcode-plugin</li>
</ol>

<pre><code class="hljs language-css" lang="css">npm install webpack-deadcode-plugin <span class="hljs-attr">--save-dev</span>
</code></pre>
<p>2.  在webpack配置中添加：</p>

<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DeadCodePlugin</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">'webpack-deadcode-plugin'</span>);

<span class="hljs-comment">// 增强配置可检测具体方法</span>
chain.<span class="hljs-title function_ invoke__">plugin</span>(<span class="hljs-string">'deadcode'</span>)
  .<span class="hljs-keyword">use</span>(DeadCodePlugin, [{
    detectUnusedExport: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 检测未使用的导出</span>
    detectUnusedClass: <span class="hljs-literal">true</span>,     <span class="hljs-comment">// 检测未使用的类</span>
    detectUnusedFunction: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 检测未使用的函数</span>
    detectUnusedVariable: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 检测未使用的变量</span>
    log: <span class="hljs-string">'all'</span>                   <span class="hljs-comment">// 显示所有未使用项</span>
  }]);
</code></pre>
<p>3.  运行构建后会生成未使用文件的报告<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0e73c1142c64b3fb32bf7acd8729bcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5bCP6buR5bGL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736559&amp;x-signature=KLeh63ILFErgr%2FUThvlPaKgK7M8%3D" alt="image.png" loading="lazy"/></p>
<p>通过这些方式可以 了解到 哪些文件、函数、变量没有使用到</p>
<p>如果要删除</p>
<ol>
<li>一定要确认、确认、确认、多次确认 清楚再删</li>
<li>小规模的删，不要一次性删太多东西</li>
<li>删除之后，对于相关的流程做好自测，也要跟 QA 和 产品说明清楚，可能要做大版本的回测</li>
<li>对于已经上线的项目，不建议再做这样的操作，如果需要做也必须【提前】跟 PM、QA 商量一下是否有足够的时间安排来做代码优化和流程测试，避免出现生产事故</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Gradle - ASM + AsmClassVisitorFactory插桩使用]]></title>    <link>https://juejin.cn/post/7585222924566102056</link>    <guid>https://juejin.cn/post/7585222924566102056</guid>    <pubDate>2025-12-19T08:14:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585222924566102056" data-draft-id="7582155513586417716" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Gradle - ASM + AsmClassVisitorFactory插桩使用"/> <meta itemprop="keywords" content="前端,Android,gradle"/> <meta itemprop="datePublished" content="2025-12-19T08:14:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="明川"/> <meta itemprop="url" content="https://juejin.cn/user/114004941350269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Gradle - ASM + AsmClassVisitorFactory插桩使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/114004941350269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    明川
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T08:14:15.000Z" title="Fri Dec 19 2025 08:14:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>  前边陆续总结学习了 Task 和 Plugin，今天就开始总结插桩的使用，正好能把前边学的知识串起来，温故而知新。</p>
<p>  我们都知道Apk 是从资源编译 -&gt; 源代码 （java/kotlin）-&gt; 编译器（javac/kotlinc） -&gt; JVM字节码 （.class） -&gt; D8/R8 编译器 -&gt; DEX字节码（.dex） -&gt; 最后到我们的APK，字节码操作主要在 JVM这一步，发生在编译后，打包前的class文件环节，比较适合处理一些有规则的代码插入，在编写代码层面无侵入 不容易遗漏。</p>
<h2 data-id="heading-1">插桩</h2>
<p>  <strong>字节码插桩</strong>（Bytecode Instrumentation）是在<strong>编译后、打包前</strong>修改 <code>.class</code> 文件的技术。</p>
<p>先看一个例子：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Hello</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sayHello</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"Hi"</span>);
    }
}
</code></pre>
<p>用 <code>javac</code> 编译后，生成的 <code>Hello.class</code> 是这样的：</p>
<pre><code class="hljs language-r" lang="r">CA FE BA BE <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>D <span class="hljs-number">0</span>A
<span class="hljs-number">00</span> <span class="hljs-number">06</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span><span class="hljs-built_in">F</span> <span class="hljs-number">09</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">11</span> <span class="hljs-number">08</span> <span class="hljs-number">00</span>
<span class="hljs-number">12</span> <span class="hljs-number">0</span>A <span class="hljs-number">00</span> <span class="hljs-number">13</span> <span class="hljs-number">00</span> <span class="hljs-number">14</span> <span class="hljs-number">07</span> <span class="hljs-number">00</span> <span class="hljs-number">15</span> <span class="hljs-number">07</span> <span class="hljs-number">00</span>
<span class="hljs-number">16</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">06</span> <span class="hljs-number">3</span>C <span class="hljs-number">69</span> <span class="hljs-number">6</span>E <span class="hljs-number">69</span> <span class="hljs-number">74</span> <span class="hljs-number">3</span>E ...
（全是二进制数据）种 JVM 指令的二进制编码、计算字节偏移、维护常量池索引……
</code></pre>
<p>  <strong>这就是我们需要 ASM 的原因</strong>：ASM 是一个 Java 库，帮你<strong>读取、修改、生成</strong> <code>.class</code> 文件，让你不用关心底层的二进制细节，借助工具来修改 Class 文件，更加简单方便。</p>

























<table><thead><tr><th>方式</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>手写代码</strong></td><td>直观、可控</td><td>侵入性强、容易遗漏、难以统一</td></tr><tr><td><strong>AOP 注解</strong></td><td>使用简单</td><td>运行时开销、无法处理三方库</td></tr><tr><td><strong>字节码插桩</strong></td><td>无侵入、可处理所有代码</td><td>学习成本高</td></tr></tbody></table>
<h3 data-id="heading-2">ASM重要方法</h3>
<p>  这里插入一下 ASM几个重要的方法和作用，因为下边会有一些实例代码，关于 Transfrom 中如何修改的案例会使用到。</p>

























<table><thead><tr><th>类名</th><th>作用</th></tr></thead><tbody><tr><td><strong>ClassReader</strong></td><td>读取 .class 文件，包括类中的信息方法名和字段</td></tr><tr><td><strong>ClassVisitor</strong></td><td>ClassReader读取，可以在 visit、visitField和visitMethod方法中查看</td></tr><tr><td><strong>MethodVisitor</strong></td><td>访问方法内部</td></tr><tr><td><strong>ClassWriter</strong></td><td>生成新的 .class</td></tr></tbody></table>
<h3 data-id="heading-3">ASM 和 Transform</h3>
<p>  <strong>Transform</strong> 在AGP 4.+版本，我们默认都用的Transform 来实现Class 拦截和输出工作。但是在高版本AGP中， 根据 官方的说法 Transform API 会被移除：<strong>为了提高构建性能，使用 Transform API 很难与其它 Gradle 特性结合使用</strong> ，不过就我自己的使用体验，确实Transform <strong>使用起来代码更多，需要手动处理：遍历文件、读取字节、处理 Jar、写入输出等 ，多个Transform串联执行，执行效率不高</strong> 。</p>
<p>由于项目中之前是使用的 Bytex，这里我写一个 简单的transform 实例代码，仅用于参考</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTransform</span> : <span class="hljs-type">Transform</span>() {

    <span class="hljs-comment">// Task 名称</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getName</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"MyTransform"</span>

    <span class="hljs-comment">// 处理什么类型 class 文件</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInputTypes</span><span class="hljs-params">()</span></span>: Set&lt;QualifiedContent.ContentType&gt; {
        <span class="hljs-keyword">return</span> setOf(QualifiedContent.DefaultContentType.CLASSES)
    }

    <span class="hljs-comment">// 处理代码范围</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getScopes</span><span class="hljs-params">()</span></span>: MutableSet&lt;<span class="hljs-keyword">in</span> QualifiedContent.Scope&gt; {
        <span class="hljs-keyword">return</span> mutableSetOf(
            QualifiedContent.Scope.PROJECT,
            QualifiedContent.Scope.SUB_PROJECTS,
            QualifiedContent.Scope.EXTERNAL_LIBRARIES
        )
    }

    <span class="hljs-comment">// 增量编译</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isIncremental</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">true</span>

    <span class="hljs-comment">// 处理输入，生成输出</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">transform</span><span class="hljs-params">(transformInvocation: <span class="hljs-type">TransformInvocation</span>)</span></span> {
        <span class="hljs-keyword">val</span> inputs = transformInvocation.inputs
        <span class="hljs-keyword">val</span> outputProvider = transformInvocation.outputProvider
        <span class="hljs-keyword">val</span> isIncremental = transformInvocation.isIncremental

        <span class="hljs-keyword">if</span> (!isIncremental) {
            outputProvider.deleteAll()
        }

        <span class="hljs-comment">// 手动遍历所有输入</span>
        inputs.forEach { input -&gt;

            <span class="hljs-comment">// 处理目录输入</span>
            input.directoryInputs.forEach { dirInput -&gt;
                <span class="hljs-keyword">val</span> outputDir = outputProvider.getContentLocation(
                    dirInput.name,
                    dirInput.contentTypes,
                    dirInput.scopes,
                    Format.DIRECTORY
                )

                <span class="hljs-comment">// 需要手动遍历每个 class 文件</span>
                dirInput.file.walkTopDown().forEach { file -&gt;
                    <span class="hljs-keyword">if</span> (file.isFile &amp;&amp; file.name.endsWith(<span class="hljs-string">".class"</span>)) {
                        <span class="hljs-comment">// 需要手动读取字节</span>
                        <span class="hljs-keyword">val</span> classBytes = file.readBytes()

                        <span class="hljs-comment">// 使用 ASM 处理</span>
                        <span class="hljs-keyword">val</span> classReader = ClassReader(classBytes)
                        <span class="hljs-keyword">val</span> classWriter = ClassWriter(ClassWriter.COMPUTE_FRAMES)
                        <span class="hljs-keyword">val</span> classVisitor = MyClassVisitor(classWriter)
                        classReader.accept(classVisitor, ClassReader.EXPAND_FRAMES)

                        <span class="hljs-comment">// 需要手动写入输出</span>
                        <span class="hljs-keyword">val</span> outputFile = File(outputDir, file.relativeTo(dirInput.file).path)
                        outputFile.parentFile.mkdirs()
                        outputFile.writeBytes(classWriter.toByteArray())
                    }
                }
            }

            <span class="hljs-comment">// 处理 Jar 输入（依赖库）</span>
            input.jarInputs.forEach { jarInput -&gt;
                <span class="hljs-comment">// 需要手动解压、处理、重新打包 Jar</span>
                <span class="hljs-keyword">val</span> outputJar = outputProvider.getContentLocation(
                    jarInput.name,
                    jarInput.contentTypes,
                    jarInput.scopes,
                    Format.JAR
                )
                <span class="hljs-comment">// 解压 → 遍历 → 处理 → 重新打包...</span>
                <span class="hljs-comment">// 省略大量代码...</span>
            }
        }
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPlugin</span> : <span class="hljs-type">Plugin</span>&lt;<span class="hljs-type">Project</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(project: <span class="hljs-type">Project</span>)</span></span> {
        <span class="hljs-keyword">val</span> android = project.extensions.getByType(AppExtension::<span class="hljs-keyword">class</span>.java)
        <span class="hljs-comment">// AGP 8.0 中已被删除</span>
        android.registerTransform(MyTransform())
    }
}

</code></pre>
<p>主要功能描述都放在注释里了，这里不多赘述</p>
<h3 data-id="heading-4">AsmClassVisitorFactory示例</h3>
<p>  相比于Transfrom，新的AsmClassVisitorFactory <strong>帮你完成遍历 Class文件，读取字节码 遍历ClassReader/ClassWriter 并处理jar和增量编辑等逻辑</strong>，根据官网所说，代码减少五倍 （不敢苟同哈，但是以前确实要实现5个抽象方法， 相比来说较少写很多代码是真的）。</p>
<p>  我们这里重点讲新的Transfrom的方式，我们这里实现一个 方法耗时打印的插桩。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90917f53974d4774bd4234631f655d87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piO5bed:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736855&amp;x-signature=ihA07V2ENTsrzYIkt5BGY1n3SEk%3D" alt="image.png" loading="lazy"/></p>








































<table><thead><tr><th>文件名</th><th>作用</th><th>关键方法/属性</th></tr></thead><tbody><tr><td>MethodTracePlugin.kt</td><td>插件入口，注册到 Gradle</td><td>apply() - 创建扩展配置、注册 AsmClassVisitorFactory</td></tr><tr><td>MethodTraceExtension.kt</td><td>DSL 扩展配置，供 build.gradle 使用</td><td>enable、enableLog、includePackages、excludePackages、thresholdMs</td></tr><tr><td>MethodTraceParams.kt</td><td>传递给 Factory 的参数接口</td><td>与 Extension 对应的 Property 参数</td></tr><tr><td>MethodTraceClassVisitorFactory.kt</td><td>AGP 的入口工厂类，决定哪些类需要插桩</td><td>isInstrumentable() - 过滤类<br/>createClassVisitor() - 创建 ClassVisitor</td></tr><tr><td>MethodTraceClassVisitor.kt</td><td>类级别访问器，遍历类中的方法</td><td>visitMethod() - 返回自定义的 MethodVisitor</td></tr><tr><td>MethodTraceMethodVisitor.kt</td><td>方法级别访问器，真正插入字节码</td><td>onMethodEnter() - 方法入口插桩<br/>onMethodExit() - 方法出口插桩</td></tr></tbody></table>
<p><strong>超级多代码警告！！</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodTracePlugin</span> : <span class="hljs-type">Plugin</span>&lt;<span class="hljs-type">Project</span>&gt; {

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TAG = <span class="hljs-string">"MethodTracePlugin"</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(project: <span class="hljs-type">Project</span>)</span></span> {
        println(<span class="hljs-string">"<span class="hljs-variable">$TAG</span>: 插件已应用"</span>)
        <span class="hljs-comment">// 创建扩展配置</span>
        <span class="hljs-keyword">val</span> extension = project.extensions.create(
            <span class="hljs-string">"methodTrace"</span>,
            MethodTraceExtension::<span class="hljs-keyword">class</span>.java
        )
        <span class="hljs-comment">// 获取 Android 组件扩展</span>
        <span class="hljs-keyword">val</span> androidComponents = project.extensions.findByType(
            AndroidComponentsExtension::<span class="hljs-keyword">class</span>.java
        ) ?: run {
            println(<span class="hljs-string">"<span class="hljs-variable">$TAG</span>: 未找到 Android 组件，跳过"</span>)
            <span class="hljs-keyword">return</span>
        }
        <span class="hljs-comment">// AGP 的回调执行顺序：onVariants → afterEvaluate</span>
        androidComponents.onVariants { variant -&gt;
            <span class="hljs-comment">// 使用 Provider 延迟获取配置值（配置阶段还没完成）</span>
            <span class="hljs-keyword">val</span> enabled = extension.enable.getOrElse(<span class="hljs-literal">true</span>)
            
            <span class="hljs-keyword">if</span> (!enabled) {
                println(<span class="hljs-string">"<span class="hljs-variable">$TAG</span>: 插件已禁用，跳过变体 <span class="hljs-subst">${variant.name}</span>"</span>)
                <span class="hljs-keyword">return</span><span class="hljs-symbol">@onVariants</span>
            }
            
            println(<span class="hljs-string">"<span class="hljs-variable">$TAG</span>: 配置变体 <span class="hljs-subst">${variant.name}</span>"</span>)

            variant.instrumentation.transformClassesWith(
                MethodTraceClassVisitorFactory::<span class="hljs-keyword">class</span>.java,
                InstrumentationScope.PROJECT  <span class="hljs-comment">// 只处理项目代码</span>
            ) { params -&gt;
                <span class="hljs-comment">// 使用 Provider 链接，这样值会在真正需要时才获取</span>
                params.enableLog.<span class="hljs-keyword">set</span>(extension.enableLog)
                params.includePackages.<span class="hljs-keyword">set</span>(extension.includePackages)
                params.excludePackages.<span class="hljs-keyword">set</span>(extension.excludePackages)
                params.thresholdMs.<span class="hljs-keyword">set</span>(extension.thresholdMs)
            }

            variant.instrumentation.setAsmFramesComputationMode(
                FramesComputationMode.COMPUTE_FRAMES_FOR_INSTRUMENTED_METHODS
            )
        }
    }
}
</code></pre>
<p>  <strong>MethodTracePlugin</strong> 是整个插件的入口，是需要注册在gradle的插件中的，不然是找不到该插件的</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MethodTraceParams</span> : <span class="hljs-type">InstrumentationParameters</span> {
    <span class="hljs-meta">@get:Input</span>
    <span class="hljs-keyword">val</span> enableLog: Property&lt;<span class="hljs-built_in">Boolean</span>&gt;  <span class="hljs-comment">// 插件开关</span>

    <span class="hljs-meta">@get:Input</span>
    <span class="hljs-keyword">val</span> includePackages: ListProperty&lt;String&gt; <span class="hljs-comment">// 要处理的包名列表</span>

    <span class="hljs-meta">@get:Input</span>
    <span class="hljs-keyword">val</span> excludePackages: ListProperty&lt;String&gt;  <span class="hljs-comment">// 要排除的白名单列表</span>

    <span class="hljs-meta">@get:Input</span>
    <span class="hljs-keyword">val</span> thresholdMs: Property&lt;<span class="hljs-built_in">Long</span>&gt;   <span class="hljs-comment">// 方法打印毫秒阈值</span>
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodTraceExtension</span> {

    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> enable: Property&lt;<span class="hljs-built_in">Boolean</span>&gt;

    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> enableLog: Property&lt;<span class="hljs-built_in">Boolean</span>&gt;

    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> includePackages: ListProperty&lt;String&gt;

    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> excludePackages: ListProperty&lt;String&gt;

    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> thresholdMs: Property&lt;<span class="hljs-built_in">Long</span>&gt;

    <span class="hljs-keyword">init</span> {
        enable.convention(<span class="hljs-literal">true</span>)
        enableLog.convention(<span class="hljs-literal">false</span>)
        includePackages.convention(emptyList())
        excludePackages.convention(emptyList())
        thresholdMs.convention(<span class="hljs-number">0L</span>)
    }
}
</code></pre>
<p>  我们可以根据自己想要自定义的部分，<strong>MethodTraceExtension为 gradle 扩展配置</strong>，方便用户在App中使用自定义关键阈值和开关等。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodTraceClassVisitorFactory</span> :
    <span class="hljs-type">AsmClassVisitorFactory</span>&lt;<span class="hljs-type">MethodTraceParams</span>&gt; {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createClassVisitor</span><span class="hljs-params">(
        classContext: <span class="hljs-type">ClassContext</span>,
        nextClassVisitor: <span class="hljs-type">ClassVisitor</span>
    )</span></span>: ClassVisitor {
        <span class="hljs-keyword">return</span> MethodTraceClassVisitor(
            nextClassVisitor,
            classContext.currentClassData.className,
            parameters.<span class="hljs-keyword">get</span>().enableLog.<span class="hljs-keyword">get</span>(),
            parameters.<span class="hljs-keyword">get</span>().thresholdMs.<span class="hljs-keyword">get</span>()
        )
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isInstrumentable</span><span class="hljs-params">(classData: <span class="hljs-type">ClassData</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">val</span> className = classData.className
        <span class="hljs-keyword">val</span> params = parameters.<span class="hljs-keyword">get</span>()

        <span class="hljs-comment">// 排除 MethodTracer 本身，避免死循环！</span>
        <span class="hljs-keyword">if</span> (className.contains(<span class="hljs-string">"MethodTracer"</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        }

        <span class="hljs-comment">// 检查排除列表</span>
        <span class="hljs-keyword">val</span> excludePackages = params.excludePackages.<span class="hljs-keyword">get</span>()
        <span class="hljs-keyword">for</span> (pkg <span class="hljs-keyword">in</span> excludePackages) {
            <span class="hljs-keyword">if</span> (className.startsWith(pkg)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
            }
        }

        <span class="hljs-comment">// 检查包含列表</span>
        <span class="hljs-keyword">val</span> includePackages = params.includePackages.<span class="hljs-keyword">get</span>()
        <span class="hljs-keyword">if</span> (includePackages.isEmpty()) {
            <span class="hljs-comment">// 如果没有配置，默认处理所有非系统类</span>
            <span class="hljs-keyword">return</span> !className.startsWith(<span class="hljs-string">"android."</span>) &amp;&amp;
                    !className.startsWith(<span class="hljs-string">"androidx."</span>) &amp;&amp;
                    !className.startsWith(<span class="hljs-string">"kotlin."</span>) &amp;&amp;
                    !className.startsWith(<span class="hljs-string">"java."</span>) &amp;&amp;
                    !className.startsWith(<span class="hljs-string">"javax."</span>)
        }
        <span class="hljs-keyword">for</span> (pkg <span class="hljs-keyword">in</span> includePackages) {
            <span class="hljs-keyword">if</span> (className.startsWith(pkg)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
}
</code></pre>
<p>  接下来就实现 已经在 MethodTracePlugin 指定的工厂层 <strong>MethodTraceClassVisitorFactory</strong> ，结合 isInstrumentable 方法可以控制是否跳过对应class ，createClassVisitor方法 则是创建 对应的方法处理类。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodTraceClassVisitor</span> (
    nextVisitor: ClassVisitor,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> className: String,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> enableLog: <span class="hljs-built_in">Boolean</span>,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> thresholdMs: <span class="hljs-built_in">Long</span>
) : ClassVisitor(Opcodes.ASM9, nextVisitor) {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">visitMethod</span><span class="hljs-params">(
        access: <span class="hljs-type">Int</span>,
        name: <span class="hljs-type">String</span>,
        descriptor: <span class="hljs-type">String</span>,
        signature: <span class="hljs-type">String</span>?,
        exceptions: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">String</span>&gt;?
    )</span></span>: MethodVisitor? {

        <span class="hljs-keyword">val</span> mv = <span class="hljs-keyword">super</span>.visitMethod(access, name, descriptor, signature, exceptions)
            ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

        <span class="hljs-comment">// 跳过构造方法和静态初始化块</span>
        <span class="hljs-keyword">if</span> (name == <span class="hljs-string">"&lt;init&gt;"</span> || name == <span class="hljs-string">"&lt;clinit&gt;"</span>) {
            <span class="hljs-keyword">return</span> mv
        }

        <span class="hljs-comment">// 跳过抽象方法和 native 方法</span>
        <span class="hljs-keyword">if</span> ((access and Opcodes.ACC_ABSTRACT) != <span class="hljs-number">0</span> ||
            (access and Opcodes.ACC_NATIVE) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> mv
        }

        <span class="hljs-keyword">if</span> (enableLog) {
            println(<span class="hljs-string">"  插桩方法: <span class="hljs-variable">$className</span>#<span class="hljs-variable">$name</span><span class="hljs-variable">$descriptor</span>"</span>)
        }

        <span class="hljs-comment">// 返回自定义的 MethodVisitor，传递阈值参数</span>
        <span class="hljs-keyword">return</span> MethodTraceMethodVisitor(
            mv,
            access,
            className,
            name,
            descriptor,
            thresholdMs  <span class="hljs-comment">// 传递耗时阈值</span>
        )
    }
}
</code></pre>
<p>   <strong>MethodTraceClassVisitor</strong> 主要作用就是 遍历方法，过滤一些特殊的方法，可主要针对核心业务代码进行选择。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodTraceMethodVisitor</span>(
    methodVisitor: MethodVisitor,
    access: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> className: String,      <span class="hljs-comment">// 第3个参数：类名</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> methodName: String,     <span class="hljs-comment">// 第4个参数：方法名  </span>
    descriptor: String,                 <span class="hljs-comment">// 第5个参数：方法描述符</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> thresholdMs: <span class="hljs-built_in">Long</span>       <span class="hljs-comment">// 第6个参数：耗时阈值（毫秒）</span>
) : AdviceAdapter(Opcodes.ASM9, methodVisitor, access, methodName, descriptor) {

    <span class="hljs-comment">// 存储开始时间的局部变量索引</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> startTimeVarIndex = <span class="hljs-number">0</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMethodEnter</span><span class="hljs-params">()</span></span> {
        startTimeVarIndex = newLocal(org.objectweb.asm.Type.LONG_TYPE)

        mv.visitMethodInsn(
            INVOKESTATIC,
            <span class="hljs-string">"java/lang/System"</span>,
            <span class="hljs-string">"nanoTime"</span>,
            <span class="hljs-string">"()J"</span>,
            <span class="hljs-literal">false</span>
        )
        mv.visitVarInsn(LSTORE, startTimeVarIndex)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMethodExit</span><span class="hljs-params">(opcode: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">if</span> (opcode != ATHROW) {
            printMethodCost()
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printMethodCost</span><span class="hljs-params">()</span></span> {
        mv.visitMethodInsn(
            INVOKESTATIC,
            <span class="hljs-string">"java/lang/System"</span>,
            <span class="hljs-string">"nanoTime"</span>,
            <span class="hljs-string">"()J"</span>,
            <span class="hljs-literal">false</span>
        )
        mv.visitVarInsn(LLOAD, startTimeVarIndex)
        mv.visitInsn(LSUB)  <span class="hljs-comment">// 执行减法</span>
        
        <span class="hljs-comment">// 存储耗时结果</span>
        <span class="hljs-keyword">val</span> durationVarIndex = newLocal(org.objectweb.asm.Type.LONG_TYPE)
        mv.visitVarInsn(LSTORE, durationVarIndex)

        <span class="hljs-keyword">if</span> (thresholdMs &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">val</span> skipLabel = org.objectweb.asm.Label()
            
            <span class="hljs-comment">// 加载 durationNs</span>
            mv.visitVarInsn(LLOAD, durationVarIndex)
            <span class="hljs-comment">// 加载阈值（转换为纳秒）</span>
            mv.visitLdcInsn(thresholdMs * <span class="hljs-number">1_000_000L</span>)
            mv.visitInsn(LCMP)
            <span class="hljs-comment">// 如果 durationNs &lt; threshold，跳过 trace 调用</span>
            mv.visitJumpInsn(IFLT, skipLabel)
            
            <span class="hljs-comment">// 调用 trace</span>
            invokeTrace(durationVarIndex)
            
            <span class="hljs-comment">// 跳过标签</span>
            mv.visitLabel(skipLabel)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 没有阈值限制，直接调用</span>
            invokeTrace(durationVarIndex)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">invokeTrace</span><span class="hljs-params">(durationVarIndex: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 调用 MethodTracer.trace(className, methodName, durationNs)</span>
        mv.visitLdcInsn(className.replace(<span class="hljs-string">"/"</span>, <span class="hljs-string">"."</span>))  <span class="hljs-comment">// 第1个参数: className</span>
        mv.visitLdcInsn(methodName)                    <span class="hljs-comment">// 第2个参数: methodName</span>
        mv.visitVarInsn(LLOAD, durationVarIndex)       <span class="hljs-comment">// 第3个参数: durationNs (long)</span>
        
        mv.visitMethodInsn(
            INVOKESTATIC,
            <span class="hljs-string">"com/xmly/gradley/trace/MethodTracer"</span>,  <span class="hljs-comment">// 对应 app 中的类</span>
            <span class="hljs-string">"trace"</span>,
            <span class="hljs-string">"(Ljava/lang/String;Ljava/lang/String;J)V"</span>,  <span class="hljs-comment">// (String, String, long) -&gt; void</span>
            <span class="hljs-literal">false</span>
        )
    }
}
</code></pre>
<p>   这里其实才是 真正的字节码插入的地方，onMethodEnter 方法开始的地方 插入获取当前时间，onMethodExit 方法结束的时候，插入 MethodTracer.trace ，用来打印实际耗时。</p>
<p>最后不要忘记再 gradle-plugin 的 build.gradle.kts中注册插件</p>
<pre><code class="hljs language-ini" lang="ini">create("methodTrace") {
    <span class="hljs-attr">id</span> = <span class="hljs-string">"com.xmly.methodtrace"</span>
    <span class="hljs-attr">implementationClass</span> = <span class="hljs-string">"com.xmly.plugin.trace.MethodTracePlugin"</span>
    <span class="hljs-attr">displayName</span> = <span class="hljs-string">"Method Trace Plugin"</span>
    <span class="hljs-attr">description</span> = <span class="hljs-string">"方法耗时统计插件"</span>
}
</code></pre>
<p>最后就是我们的 发布了， plugin library 都是需要发布的</p>
<pre><code class="hljs language-ruby" lang="ruby">./gradlew <span class="hljs-symbol">:gradle-plugin</span><span class="hljs-symbol">:publish</span>
</code></pre>
<p>对应的，我们在前边自定义了 Gradle扩展函数，所以我们可以自定义一些 plugin 逻辑，我们来到 App build.gradle 中引入插件</p>
<pre><code class="hljs language-ini" lang="ini">plugins {
    alias(libs.plugins.android.application)
    alias(libs.plugins.kotlin.android)
    alias(libs.plugins.kotlin.compose)
    ...
    id 'com.xmly.methodtrace' version '1.0.0'  // 方法耗时插件
}

// 基于 gradle 拓展函数 ，就可以控制开关和 时间戳限制等逻辑
methodTrace {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>
    <span class="hljs-attr">enableLog</span> = <span class="hljs-literal">true</span>
    <span class="hljs-attr">includePackages</span> = [<span class="hljs-string">'com.xmly.gradley'</span>]
    <span class="hljs-attr">excludePackages</span> = [<span class="hljs-string">'com.xmly.gradley.test'</span>]
    <span class="hljs-attr">thresholdMs</span> = <span class="hljs-number">1</span>L  // 只记录超过 <span class="hljs-number">1</span>ms 的方法
}


</code></pre>
<p>最后，我们实现以下 App文件夹下 对应的 log实现类</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> MethodTracer {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TAG = <span class="hljs-string">"MethodTracer"</span>

    <span class="hljs-comment">// 是否启用（运行时开关）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> enabled = <span class="hljs-literal">true</span>

    <span class="hljs-comment">/**
     * 运行时开关，可动态禁用日志输出
     */</span>
    <span class="hljs-meta">@JvmStatic</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setEnabled</span><span class="hljs-params">(enabled: <span class="hljs-type">Boolean</span>)</span></span> {
        <span class="hljs-keyword">this</span>.enabled = enabled
    }

    <span class="hljs-comment">/**
     * 记录方法耗时
     * 
     * 注意：阈值判断已在编译时完成（ASM 插桩生成了 if 判断），
     * 所以这里只负责打印，不再做阈值判断。
     * 
     * <span class="hljs-doctag">@param</span> className 类名
     * <span class="hljs-doctag">@param</span> methodName 方法名
     * <span class="hljs-doctag">@param</span> durationNs 耗时（纳秒）
     */</span>
    <span class="hljs-meta">@JvmStatic</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">trace</span><span class="hljs-params">(className: <span class="hljs-type">String</span>, methodName: <span class="hljs-type">String</span>, durationNs: <span class="hljs-type">Long</span>)</span></span> {
        <span class="hljs-keyword">if</span> (!enabled) <span class="hljs-keyword">return</span>

        <span class="hljs-comment">// 阈值判断已在编译时完成，这里直接打印</span>
        <span class="hljs-keyword">val</span> durationMs = durationNs / <span class="hljs-number">1_000_000.0</span>
        Log.d(TAG, String.format(
            <span class="hljs-string">"%.2fms | %s#%s"</span>,
            durationMs,
            className,
            methodName
        ))
    }
}
</code></pre>
<p>这里重点看trace 即可，主要就是用来打印</p>
<h3 data-id="heading-5">ASM插桩 LayoutInflater 拓展</h3>
<p>  这里简单聊一下对上述方法的拓展，比如说我现在需要对布局绘制进行一些简单的耗时打点，就可以借助上边的办法，针对 <code>View view = layoutInflater.inflate(R.layout.activity_main, container)</code>的代码进行插桩。</p>
<p>目标示例代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">// 方式一：直接替换方法调用
View <span class="hljs-attr">view</span> = LayoutInflaterAgent.wrapInflate(layoutInflater, R.layout.activity_main, container)<span class="hljs-comment">;</span>

// 方式二：前后包裹（记录耗时）
long <span class="hljs-attr">startTime</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
View <span class="hljs-attr">view</span> = layoutInflater.inflate(R.layout.activity_main, container)<span class="hljs-comment">;</span>
long <span class="hljs-attr">cost</span> = System.currentTimeMillis() - startTime<span class="hljs-comment">;</span>
LayoutInflaterAgent.inflateHook(view, R.layout.activity_main, cost)<span class="hljs-comment">;</span>
</code></pre>
<p>我们重点模拟下 方法替换 Visitor 的代码，主要是针对 三个方法，<code>inflate(int resource, ViewGroup root)</code> ， <code>inflate(int resource, ViewGroup root, boolean attachToRoot)</code> 和 <code>ViewStub.inflate()</code>三个方法进行拦截和替换</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InflateMethodVisitor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MethodVisitor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Opcodes</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TO_CLASS</span> <span class="hljs-operator">=</span> <span class="hljs-string">"com/ximalaya/commonaspectj/LayoutInflaterAgent"</span>;
    <span class="hljs-keyword">private</span> String mName, mDesc;
    <span class="hljs-keyword">private</span> <span class="hljs-type">MethodInsnNode</span> <span class="hljs-variable">targetMethodNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodInsnNode</span>(INVOKEVIRTUAL,
            <span class="hljs-string">"android/view/LayoutInflater"</span>,
            <span class="hljs-string">"inflate"</span>,
            INFLATEDESC_1, <span class="hljs-literal">false</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-type">MethodInsnNode</span> <span class="hljs-variable">viewStubMethodNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodInsnNode</span>(INVOKEVIRTUAL,
            <span class="hljs-string">"android/view/ViewStub"</span>, <span class="hljs-string">"inflate"</span>,
            <span class="hljs-string">"()Landroid/view/View;"</span>, <span class="hljs-literal">false</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InflateMethodVisitor</span><span class="hljs-params">(<span class="hljs-type">int</span> api, MethodVisitor methodVisitor, String name, String desc)</span> {
        <span class="hljs-built_in">super</span>(api, methodVisitor);
        <span class="hljs-built_in">this</span>.mName = name;
        <span class="hljs-built_in">this</span>.mDesc = desc;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">visitMethodInsn</span><span class="hljs-params">(<span class="hljs-type">int</span> opcode, String owner, String name, String descriptor, <span class="hljs-type">boolean</span> isInterface)</span> {
        <span class="hljs-keyword">if</span> (owner.equals(targetMethodNode.owner) &amp;&amp; name.equals(targetMethodNode.name)) {
            <span class="hljs-keyword">if</span> (descriptor.equals(INFLATEDESC_1)) {
                mv.visitMethodInsn(INVOKESTATIC, TO_CLASS, <span class="hljs-string">"wrapInflate"</span>, <span class="hljs-string">"(Landroid/view/LayoutInflater;ILandroid/view/ViewGroup;)Landroid/view/View;"</span>, <span class="hljs-literal">false</span>);
                XLog.INSTANCE.d( getLogTag(),<span class="hljs-string">"2_"</span>+className + <span class="hljs-string">"#"</span> + mName + mDesc);

            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (descriptor.equals(INFLATEDESC_2)) {
                mv.visitMethodInsn(INVOKESTATIC, TO_CLASS, <span class="hljs-string">"wrapInflate"</span>, <span class="hljs-string">"(Landroid/view/LayoutInflater;ILandroid/view/ViewGroup;Z)Landroid/view/View;"</span>, <span class="hljs-literal">false</span>);
                XLog.INSTANCE.d(getLogTag(), <span class="hljs-string">"3_"</span> +className + <span class="hljs-string">"#"</span> + mName + mDesc);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-built_in">super</span>.visitMethodInsn(opcode, owner, name, descriptor, isInterface);
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (owner.equals(viewStubMethodNode.owner) &amp;&amp; name.equals(viewStubMethodNode.name) &amp;&amp; descriptor.equals(viewStubMethodNode.desc)) {
            mv.visitMethodInsn(INVOKESTATIC, TO_CLASS, <span class="hljs-string">"wrapInflate"</span>, <span class="hljs-string">"(Landroid/view/ViewStub;)Landroid/view/View;"</span>, <span class="hljs-literal">false</span>);
            XLog.INSTANCE.d(getLogTag(),<span class="hljs-string">"3_"</span>+className + <span class="hljs-string">"#"</span> + mName + mDesc);

            XLog.INSTANCE.i(getLogTag(),<span class="hljs-string">"className: "</span> + className
                    + <span class="hljs-string">", name: "</span> + name + <span class="hljs-string">", descriptor: "</span> + descriptor
                    + <span class="hljs-string">", owner: "</span> + owner + <span class="hljs-string">", mName: "</span> + mName
                    + <span class="hljs-string">", mDesc: "</span> + mDesc);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">super</span>.visitMethodInsn(opcode, owner, name, descriptor, isInterface);
        }

    }
}
</code></pre>
<p>  其实原理和 检测方法耗时是一样的，只是关于方法的替换逻辑不一样，其他的 apm其实大部分原理都差不多。</p>
<h2 data-id="heading-6">最后</h2>
<p>  到这里基本结束了，其实主要是列了一下 新版本的transform的使用方式以及 ASM plugin的开发和使用。关于其他的ASM用来实现什么apm逻辑，就要看自己举一反三了。最近也是终于有空把本地的 Gradle和 ASM插桩知识总结了一下，临近年关，又要对自己来一次 Review，感觉很多知识类的在AI的加持下，可以更快的上手和落地实现了，后续也会把本地的AI使用做一个归纳和总结，<strong>后续也要把输出文章重点放在AI侧方向</strong>。</p>
<h2 data-id="heading-7">参考文章</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fasm.ow2.io%2F" target="_blank" title="https://asm.ow2.io/" ref="nofollow noopener noreferrer">ASM 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Ftools%2Fgradle-api%2Fcurrent%2Fcom%2Fandroid%2Fbuild%2Fapi%2Finstrumentation%2Fpackage-summary" target="_blank" title="https://developer.android.com/reference/tools/gradle-api/current/com/android/build/api/instrumentation/package-summary" ref="nofollow noopener noreferrer">AGP Instrumentation API</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbytedance%2FByteX" target="_blank" title="https://github.com/bytedance/ByteX" ref="nofollow noopener noreferrer">ByteX 开源项目</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchuyouyinghe%2Farticle%2Fdetails%2F144297435" target="_blank" title="https://blog.csdn.net/chuyouyinghe/article/details/144297435" ref="nofollow noopener noreferrer">手把手教你通过 AGP + ASM 实现 Android 应用插桩</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拆包、立边界、可发布：Gemini CLI 的 Monorepo 设计我学到了什么]]></title>    <link>https://juejin.cn/post/7585206549284995113</link>    <guid>https://juejin.cn/post/7585206549284995113</guid>    <pubDate>2025-12-19T03:20:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585206549284995113" data-draft-id="7585096444190818340" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拆包、立边界、可发布：Gemini CLI 的 Monorepo 设计我学到了什么"/> <meta itemprop="keywords" content="Agent,AI编程,AIGC"/> <meta itemprop="datePublished" content="2025-12-19T03:20:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拆包、立边界、可发布：Gemini CLI 的 Monorepo 设计我学到了什么
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T03:20:27.000Z" title="Fri Dec 19 2025 03:20:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从 Gemini CLI 到 Innies CLI：Monorepo 架构改造实践</h2>
<p>做开源项目二次开发的时候，经常会遇到一个问题：上游项目的架构设计得很好，但文档里不会告诉你"为什么这么设计"。只有真正改造的时候，才会慢慢理解那些设计决策背后的意图。</p>
<p>最近在把 Qwen Code（基于 Google Gemini CLI 改造）再改造成我们自己的 用来私有化部署的CLI，过程中对 Monorepo 架构有了更深的理解。这篇文章从项目架构讲起，学习下 Google 在这个 CLI 项目里的好的设计决策。</p>
<hr/>
<h3 data-id="heading-1">项目背景</h3>
<p>先说说这个项目的"血统"：</p>
<pre><code class="hljs language-java" lang="java">Google Gemini <span class="hljs-title function_">CLI</span> <span class="hljs-params">(原版)</span>
       ↓ 改造
Qwen <span class="hljs-title function_">Code</span> <span class="hljs-params">(通义版)</span>
       ↓ 改造
xxx <span class="hljs-title function_">CLI</span> <span class="hljs-params">(我们的版本)</span>
</code></pre>
<p>Google 的 Gemini CLI 是一个 AI 命令行工具，用 TypeScript 写的，架构设计得挺讲究。Qwen Code 把它改造成了适配通义千问的版本，我们又在 Qwen Code 基础上做了进一步定制。</p>
<p>整个项目用的是 <strong>npm workspaces</strong> 管理的 Monorepo 结构，这个选择在后面会发现特别重要。</p>
<hr/>
<h3 data-id="heading-2">Monorepo 结构</h3>
<p>先看项目的目录结构：</p>
<pre><code class="hljs language-ruby" lang="ruby">innies-cli/
├── packages/
│   ├── cli/           <span class="hljs-comment"># <span class="hljs-doctag">@xxx</span>/xxx-cli - 命令行界面</span>
│   ├── core/          <span class="hljs-comment"># <span class="hljs-doctag">@xxx</span>/xxx-core - 核心逻辑</span>
│   ├── test-utils/    <span class="hljs-comment"># <span class="hljs-doctag">@xxx</span>/test-utils - 测试工具</span>
│   └── vscode-ide-companion/  <span class="hljs-comment"># VS Code 扩展</span>
├── scripts/           <span class="hljs-comment"># 构建脚本</span>
├── eslint-rules/      <span class="hljs-comment"># 自定义 ESLint 规则</span>
├── .husky/            <span class="hljs-comment"># Git hooks</span>
├── .github/workflows/ <span class="hljs-comment"># CI/CD</span>
└── package.json       <span class="hljs-comment"># 根配置</span>
</code></pre>
<p>根 <code>package.json</code> 里的 workspaces 配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"workspaces"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"packages/*"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-3">为什么要拆成多个包？</h4>
<p>刚开始看到这个结构的时候，我在想：一个 CLI 工具有必要拆成这么多包吗？后来改造的时候才明白，这个拆分很有道理。</p>
<p><strong>cli 包</strong>：负责终端 UI、命令解析、用户交互。用的是 React + Ink 渲染终端界面。</p>
<p><strong>core 包</strong>：负责核心逻辑，包括 AI 模型调用、工具执行、MCP 协议、沙箱管理。这部分跟 UI 完全无关。</p>
<p>这个拆分的好处在改造的时候体现出来了：</p>
<ol>
<li><strong>换模型不影响 UI</strong>：我们把 Gemini 换成自己的模型，只需要改 core 包，cli 包几乎不用动</li>
<li><strong>复用核心逻辑</strong>：core 包可以被 VS Code 扩展、其他工具直接引用</li>
<li><strong>独立测试</strong>：两个包可以分别跑测试，互不干扰</li>
</ol>
<hr/>
<h3 data-id="heading-4">包之间的依赖关系</h3>
<p>在 <code>packages/cli/package.json</code> 里，可以看到这样的依赖声明：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@innies/innies-core"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:../core"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><code>file:../core</code> 是 npm workspaces 的本地包引用方式。在开发时，npm 会自动把这个软链接到 <code>node_modules/@innies/innies-core</code>，修改 core 包的代码，cli 包能立刻感知到。</p>
<p>发布的时候，这个 <code>file:</code> 协议会被替换成真正的版本号。</p>
<hr/>
<h3 data-id="heading-5">禁止跨包相对导入</h3>
<p>这里就要说到 Google 制定的一条规则了。</p>
<p>在 <code>eslint-rules/</code> 目录下，有一个自定义的 ESLint 规则：<code>no-relative-cross-package-imports.js</code>。这个规则做一件事：<strong>禁止用相对路径跨包导入</strong>。</p>
<h4 data-id="heading-6">错误写法</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 packages/cli/src/someFile.ts 中</span>
<span class="hljs-keyword">import</span> { something } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../core/src/utils.js'</span>;
</code></pre>
<h4 data-id="heading-7">正确写法</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 packages/cli/src/someFile.ts 中</span>
<span class="hljs-keyword">import</span> { something } <span class="hljs-keyword">from</span> <span class="hljs-string">'@innies/innies-core'</span>;
</code></pre>
<h4 data-id="heading-8">为什么要有这条规则？</h4>
<p>改造过程中就明白了。</p>
<p><strong>场景一：改包名</strong></p>
<p>我们把 <code>@qwen-code/qwen-code</code> 改成 <code>@innies/innies-cli</code>，如果代码里到处都是 <code>../../core/src/xxx</code>，那这些路径不用改。但问题是，这些"不用改"的代码，会让你误以为两个包之间没有边界。</p>
<p><strong>场景二：重构目录结构</strong></p>
<p>假设有一天要把 <code>packages/core/src/utils.js</code> 移动到 <code>packages/core/src/shared/utils.js</code>，用包名导入的代码完全不受影响（只要 core 包的导出不变），但用相对路径的代码全部要改。</p>
<p><strong>场景三：发布为独立包</strong></p>
<p>如果未来想把 core 包独立发布到 npm，用包名导入的代码一行不用改。用相对路径的代码？那就只能祈祷了。</p>
<h4 data-id="heading-9">完整规则实现</h4>
<p>下面是 Google 写的完整规则代码，值得仔细看看：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@license</span>
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */</span>

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@fileoverview</span> Disallows relative imports between specified monorepo packages.
 */</span>
<span class="hljs-meta">'use strict'</span>;

<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>;

<span class="hljs-comment">/**
 * Finds the package name by searching for the nearest `package.json` file
 * in the directory hierarchy, starting from the given file's directory
 * and moving upwards until the specified root directory is reached.
 * It reads the `package.json` and extracts the `name` property.
 *
 * <span class="hljs-doctag">@requires</span> module:path Node.js path module
 * <span class="hljs-doctag">@requires</span> module:fs Node.js fs module
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">filePath</span> - The path (absolute or relative) to a file within the potential package structure.
 * The search starts from the directory containing this file.
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">root</span> - The absolute path to the root directory of the project/monorepo.
 * The upward search stops when this directory is reached.
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string | undefined | null</span>} The value of the `name` field from the first `package.json` found.
 * Returns `undefined` if the `name` field doesn't exist in the found `package.json`.
 * Returns `null` if no `package.json` is found before reaching the `root` directory.
 * <span class="hljs-doctag">@throws</span> {<span class="hljs-type">Error</span>} Can throw an error if `fs.readFileSync` fails (e.g., permissions) or if `JSON.parse` fails on invalid JSON content.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">findPackageName</span>(<span class="hljs-params">filePath, root</span>) {
  <span class="hljs-keyword">let</span> currentDir = path.<span class="hljs-title function_">dirname</span>(path.<span class="hljs-title function_">resolve</span>(filePath));
  <span class="hljs-keyword">while</span> (currentDir !== root) {
    <span class="hljs-keyword">const</span> parentDir = path.<span class="hljs-title function_">dirname</span>(currentDir);
    <span class="hljs-keyword">const</span> packageJsonPath = path.<span class="hljs-title function_">join</span>(currentDir, <span class="hljs-string">'package.json'</span>);
    <span class="hljs-keyword">if</span> (fs.<span class="hljs-title function_">existsSync</span>(packageJsonPath)) {
      <span class="hljs-keyword">const</span> pkg = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(fs.<span class="hljs-title function_">readFileSync</span>(packageJsonPath, <span class="hljs-string">'utf-8'</span>));
      <span class="hljs-keyword">return</span> pkg.<span class="hljs-property">name</span>;
    }

    <span class="hljs-comment">// Move up one level</span>
    currentDir = parentDir;
    <span class="hljs-comment">// Safety break if we somehow reached the root directly in the loop condition (less likely with path.resolve)</span>
    <span class="hljs-keyword">if</span> (path.<span class="hljs-title function_">dirname</span>(currentDir) === currentDir) <span class="hljs-keyword">break</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// Not found within the expected structure</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">meta</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'problem'</span>,
    <span class="hljs-attr">docs</span>: {
      <span class="hljs-attr">description</span>: <span class="hljs-string">'Disallow relative imports between packages.'</span>,
      <span class="hljs-attr">category</span>: <span class="hljs-string">'Best Practices'</span>,
      <span class="hljs-attr">recommended</span>: <span class="hljs-string">'error'</span>,
    },
    <span class="hljs-attr">fixable</span>: <span class="hljs-string">'code'</span>,
    <span class="hljs-attr">schema</span>: [
      {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>,
        <span class="hljs-attr">properties</span>: {
          <span class="hljs-attr">root</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
            <span class="hljs-attr">description</span>:
              <span class="hljs-string">'Absolute path to the root of all relevant packages to consider.'</span>,
          },
        },
        <span class="hljs-attr">required</span>: [<span class="hljs-string">'root'</span>],
        <span class="hljs-attr">additionalProperties</span>: <span class="hljs-literal">false</span>,
      },
    ],
    <span class="hljs-attr">messages</span>: {
      <span class="hljs-attr">noRelativePathsForCrossPackageImport</span>:
        <span class="hljs-string">"Relative import '{{importedPath}}' crosses package boundary from '{{importingPackage}}' to '{{importedPackage}}'. Use a direct package import ('{{importedPackage}}') instead."</span>,
      <span class="hljs-attr">relativeImportIsInvalidPackage</span>:
        <span class="hljs-string">"Relative import '{{importedPath}}' does not reference a valid package. All source must be in a package directory."</span>,
    },
  },

  <span class="hljs-title function_">create</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-keyword">const</span> options = context.<span class="hljs-property">options</span>[<span class="hljs-number">0</span>] || {};
    <span class="hljs-keyword">const</span> allPackagesRoot = options.<span class="hljs-property">root</span>;

    <span class="hljs-keyword">const</span> currentFilePath = context.<span class="hljs-property">filename</span>;
    <span class="hljs-keyword">if</span> (
      !currentFilePath ||
      currentFilePath === <span class="hljs-string">'&lt;input&gt;'</span> ||
      currentFilePath === <span class="hljs-string">'&lt;text&gt;'</span>
    ) {
      <span class="hljs-comment">// Skip if filename is not available (e.g., linting raw text)</span>
      <span class="hljs-keyword">return</span> {};
    }

    <span class="hljs-keyword">const</span> currentPackage = <span class="hljs-title function_">findPackageName</span>(currentFilePath, allPackagesRoot);

    <span class="hljs-comment">// If the current file isn't inside a package structure, don't apply the rule</span>
    <span class="hljs-keyword">if</span> (!currentPackage) {
      <span class="hljs-keyword">return</span> {};
    }

    <span class="hljs-keyword">return</span> {
      <span class="hljs-title class_">ImportDeclaration</span>(node) {
        <span class="hljs-keyword">const</span> importingPackage = currentPackage;
        <span class="hljs-keyword">const</span> importedPath = node.<span class="hljs-property">source</span>.<span class="hljs-property">value</span>;

        <span class="hljs-comment">// Only interested in relative paths</span>
        <span class="hljs-keyword">if</span> (
          !importedPath ||
          <span class="hljs-keyword">typeof</span> importedPath !== <span class="hljs-string">'string'</span> ||
          !importedPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'.'</span>)
        ) {
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// Resolve the absolute path of the imported module</span>
        <span class="hljs-keyword">const</span> absoluteImportPath = path.<span class="hljs-title function_">resolve</span>(
          path.<span class="hljs-title function_">dirname</span>(currentFilePath),
          importedPath,
        );

        <span class="hljs-comment">// Find the package information for the imported file</span>
        <span class="hljs-keyword">const</span> importedPackage = <span class="hljs-title function_">findPackageName</span>(
          absoluteImportPath,
          allPackagesRoot,
        );

        <span class="hljs-comment">// If the imported file isn't in a recognized package, report issue</span>
        <span class="hljs-keyword">if</span> (!importedPackage) {
          context.<span class="hljs-title function_">report</span>({
            <span class="hljs-attr">node</span>: node.<span class="hljs-property">source</span>,
            <span class="hljs-attr">messageId</span>: <span class="hljs-string">'relativeImportIsInvalidPackage'</span>,
            <span class="hljs-attr">data</span>: { <span class="hljs-attr">importedPath</span>: importedPath },
          });
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// The core check: Are the source and target packages different?</span>
        <span class="hljs-keyword">if</span> (currentPackage !== importedPackage) {
          <span class="hljs-comment">// We found a relative import crossing package boundaries</span>
          context.<span class="hljs-title function_">report</span>({
            <span class="hljs-attr">node</span>: node.<span class="hljs-property">source</span>, <span class="hljs-comment">// Report the error on the source string literal</span>
            <span class="hljs-attr">messageId</span>: <span class="hljs-string">'noRelativePathsForCrossPackageImport'</span>,
            <span class="hljs-attr">data</span>: {
              importedPath,
              importedPackage,
              importingPackage,
            },
            <span class="hljs-title function_">fix</span>(<span class="hljs-params">fixer</span>) {
              <span class="hljs-keyword">return</span> fixer.<span class="hljs-title function_">replaceText</span>(node.<span class="hljs-property">source</span>, <span class="hljs-string">`'<span class="hljs-subst">${importedPackage}</span>'`</span>);
            },
          });
        }
      },
    };
  },
};

</code></pre>
<p>这个规则的设计有几个亮点：</p>
<ol>
<li>
<p><strong><code>findPackageName</code> 函数</strong>：从当前文件向上查找 <code>package.json</code>，找到就返回包名。这个逻辑很通用，不管包嵌套多深都能正确识别。</p>
</li>
<li>
<p><strong>两种错误消息</strong>：一种是跨包导入，另一种是导入了不在任何包里的文件。后者能帮你发现项目结构问题。</p>
</li>
<li>
<p><strong>自动修复</strong>：<code>fix(fixer)</code> 函数直接把相对路径替换成包名，跑 <code>eslint --fix</code> 就能批量修复。</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-10">其他 Google 制定的规则</h3>
<p>除了跨包导入规则，eslint 配置里还有几条值得一提的规则：</p>
<h4 data-id="heading-11">禁止 require</h4>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'CallExpression[callee.name="require"]'</span>,
  <span class="hljs-attr">message</span>: <span class="hljs-string">'Avoid using require(). Use ES6 imports instead.'</span>,
}
</code></pre>
<p>整个项目用的是 ESM（<code>"type": "module"</code>），不允许混用 CommonJS 的 <code>require</code>。</p>
<h4 data-id="heading-12">禁止抛出字符串</h4>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'ThrowStatement &gt; Literal'</span>,
  <span class="hljs-attr">message</span>: <span class="hljs-string">'Do not throw string literals. Throw new Error("...") instead.'</span>,
}
</code></pre>
<p>这条规则防止 <code>throw "something went wrong"</code> 这种写法，要求必须抛 Error 对象。好处是错误堆栈更清晰。</p>
<h4 data-id="heading-13">禁止访问内部模块</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-string">'import/no-internal-modules'</span>: [
  <span class="hljs-string">'error'</span>,
  {
    <span class="hljs-attr">allow</span>: [<span class="hljs-string">'react-dom/test-utils'</span>, <span class="hljs-string">'memfs/lib/volume.js'</span>, <span class="hljs-string">'yargs/**'</span>]
  }
]
</code></pre>
<p>这条规则禁止直接导入一个包的内部文件（比如 <code>lodash/src/xxx</code>），只能用包的正式导出。白名单里的是一些特殊情况。</p>
<hr/>
<h3 data-id="heading-14">改造过程中的踩坑</h3>
<h4 data-id="heading-15">包名全局替换</h4>
<p>第一步是把包名从 <code>@qwen-code</code> 改成 <code>@xxx</code>。这看起来简单，实际上要改的地方很多：</p>
<ul>
<li>所有 <code>package.json</code></li>
<li>所有 import 语句</li>
<li>Docker 镜像名</li>
<li>CI/CD 配置</li>
<li>文档</li>
</ul>
<p>如果之前用的是相对路径导入，这一步会轻松很多（因为相对路径不涉及包名）。但正因为用了包名导入，后续的维护和理解成本会低很多。这是一个短期痛苦换长期收益的选择。</p>
<h4 data-id="heading-16">版本号同步</h4>
<p>Monorepo 里有个常见问题：多个包的版本号怎么管理？</p>
<p>一种做法是各个包独立版本（比如 lerna 的 independent mode），但这样容易版本混乱。Google 选择了另一种方式：<strong>所有包统一版本号</strong>，用一个脚本 <code>scripts/version.js</code> 来同步。</p>
<p>执行 <code>npm run release:version patch</code> 时，这个脚本会依次做这些事：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 先更新根 package.json 的版本</span>
<span class="hljs-title function_">run</span>(<span class="hljs-string">`npm version <span class="hljs-subst">${versionType}</span> --no-git-tag-version`</span>);

<span class="hljs-comment">// 2. 遍历所有 workspace，逐个更新版本</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> workspaceName <span class="hljs-keyword">of</span> workspacesToVersion) {
  <span class="hljs-title function_">run</span>(<span class="hljs-string">`npm version <span class="hljs-subst">${versionType}</span> --workspace <span class="hljs-subst">${workspaceName}</span> --no-git-tag-version`</span>);
}

<span class="hljs-comment">// 3. 同步更新 Docker 镜像的 tag</span>
rootPackageJson.<span class="hljs-property">config</span>.<span class="hljs-property">sandboxImageUri</span> =
  rootPackageJson.<span class="hljs-property">config</span>.<span class="hljs-property">sandboxImageUri</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/:.*$/</span>, <span class="hljs-string">`:<span class="hljs-subst">${newVersion}</span>`</span>);

<span class="hljs-comment">// 4. 更新 package-lock.json</span>
<span class="hljs-title function_">run</span>(<span class="hljs-string">'npm install --package-lock-only'</span>);
</code></pre>
<p>最终效果是：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 根 package.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.1.5"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"config"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sandboxImageUri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ghcr.io/zhimanai/innies-cli:0.1.5"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// packages/cli/package.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.1.5"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"config"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sandboxImageUri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ghcr.io/zhimanai/innies-cli:0.1.5"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// packages/core/package.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.1.5"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>一条命令，所有 <code>package.json</code> 和 Docker 镜像 tag 全部同步更新，不会出现版本不一致的问题。</p>
<h4 data-id="heading-17">构建顺序</h4>
<p>Monorepo 的另一个问题是构建顺序。cli 包依赖 core 包，所以要先构建 core，再构建 cli。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build:packages"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run build --workspaces"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>npm workspaces 会自动处理依赖顺序，但有时候还是会遇到问题。比如 core 包构建失败了，cli 包的构建也会失败，错误信息可能不太直观。</p>
<hr/>
<h3 data-id="heading-18">Husky + lint-staged</h3>
<p>项目用 Husky 管理 Git hooks，提交前会自动运行 lint-staged：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"*.{js,jsx,ts,tsx}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"prettier --write"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"eslint --fix --max-warnings 0"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"*.{json,md}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"prettier --write"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这个配置保证了提交到仓库的代码格式统一、没有 lint 警告。</p>
<p>一开始觉得 <code>--max-warnings 0</code> 太严格了，后来发现这是对的。warning 堆积起来，总有一天会变成技术债。不如一开始就卡死。</p>
<hr/>
<h3 data-id="heading-19">总结</h3>
<p>从 Gemini CLI 到 Innies CLI 的改造过程，让我对 Monorepo 架构有了更深的理解：</p>
<ol>
<li><strong>包拆分要有明确的边界</strong>：cli 负责 UI，core 负责逻辑，职责清晰</li>
<li><strong>禁止跨包相对导入</strong>：短期麻烦，长期收益。这条 Google 制定的规则真的很有用</li>
<li><strong>版本号统一管理</strong>：避免各个包版本不一致的混乱</li>
<li><strong>Lint 规则从严</strong>：<code>--max-warnings 0</code> 看起来严格，但能防止技术债堆积</li>
</ol>
<p>这些设计决策，在代码里看不出"为什么"，只有真正改造一遍才能体会。</p>
<p>如果你也在做类似的项目改造，希望这些经验能帮到你。</p>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ruoyi-vue2集成flowable6.7.2后端篇]]></title>    <link>https://juejin.cn/post/7585091990347481124</link>    <guid>https://juejin.cn/post/7585091990347481124</guid>    <pubDate>2025-12-19T04:29:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585091990347481124" data-draft-id="7585206549285191721" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ruoyi-vue2集成flowable6.7.2后端篇"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-19T04:29:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码次位面"/> <meta itemprop="url" content="https://juejin.cn/user/1535333867720295"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ruoyi-vue2集成flowable6.7.2后端篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1535333867720295/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码次位面
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T04:29:19.000Z" title="Fri Dec 19 2025 04:29:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>ruoyi在中国市场有着广泛的群众基础， flowable也在很多企业落地。 本文将讲解如何在ruoyi集成flowable，主要是后端。</p>
</blockquote>
<h2 data-id="heading-0">环境说明</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f7eb740380243cc89c0ffc7217f342f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766723359&amp;x-signature=8CVPOphMG09Ec6nR%2F3%2Fnz7DyhZw%3D" alt="image.png" loading="lazy"/></p>
<p>ruoyi: Ruoyi-Vue2-Boot-2.x, <br/>
版本信息: 3.9.0<br/>
jdk: 1.8<br/>
flowable: 6.7.2<br/></p>
<h2 data-id="heading-1">安装步骤</h2>
<ul>
<li>在IDEA工具导入项目， 在项目名称上， 右键点击选择Module, 创建一个新的模块。ruoyi-flowable</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a08a259b940c434abb1db5b9af5f664a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766723359&amp;x-signature=oC6HGEvvPjTjRtxLftocji%2Bvyhk%3D" alt="r2.png" loading="lazy"/></p>
<ul>
<li>maven配置
在ruoyi项目的根目录下找到pom.xml文件， 添加flowable依赖</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">flowable.spring-boot.version</span>&gt;</span>6.7.2<span class="hljs-tag">&lt;/<span class="hljs-name">flowable.spring-boot.version</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 忽略其他--&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>


 <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
       <span class="hljs-comment">&lt;!--忽略其他--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.flowable<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>flowable-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${flowable.spring-boot.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>  
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span> 
</code></pre>
<p>在ruoyi-flowable模块下的根目录pom.xml文件加入以下依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- swagger3--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.springfox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springfox-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--common--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.ruoyi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ruoyi-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.40<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.8.40<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.flowable<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>flowable-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<p>继续在根pom.xml下，加入ruoyi-flowable，与ruoyi-common在同一个位置。这一步就是将新增模块嵌入了系统当中!!!</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.ruoyi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ruoyi-flowable<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${ruoyi.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>在ruoyi-admin模块下加入ruoyi-flowable模块</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 代码生成--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.ruoyi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ruoyi-generator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- flowable--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.ruoyi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ruoyi-flowable<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">配置application.yml</h2>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">flowable:</span>
  <span class="hljs-comment">#关闭定时任务JOB</span>
  <span class="hljs-attr">async-executor-activate:</span> <span class="hljs-literal">false</span>
  <span class="hljs-comment">#将databaseSchemaUpdate设置为true。当flowable发现库与数据库表结构不一致时，会自动将数据库表结构升级至新版本。</span>
  <span class="hljs-attr">database-schema-update:</span> <span class="hljs-literal">true</span>
  <span class="hljs-comment"># 自动部署验证设置:true-开启（默认）、false-关闭</span>
  <span class="hljs-attr">check-process-definitions:</span> <span class="hljs-literal">false</span>
  <span class="hljs-comment">#保存历史数据级别设置为full最高级别，便于历史数据的追溯</span>
  <span class="hljs-attr">history-level:</span> <span class="hljs-string">full</span>
</code></pre>
<ul>
<li>在application-druid.yml在url添加nullCatalogMeansCurrent=true</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://&lt;host&gt;:&lt;port&gt;/&lt;db&gt;?useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;characterEncoding=utf8&amp;nullCatalogMeansCurrent=true</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">&lt;your_user&gt;</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">&lt;your_pass&gt;</span>

</code></pre>
<h2 data-id="heading-3">验证Swagger是否加载</h2>
<p>随便在ruoyi-flowable写一个controller，验证能否加载成功！</p>
<pre><code class="hljs language-bash" lang="bash">http://localhost:8080/swagger-ui/index.html
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c46309c681274af8879cb314029b1bf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766723359&amp;x-signature=pD8DmGgHkvIvozBbB2K1X6MSBqw%3D" alt="r3.png" loading="lazy"/></p>
<h2 data-id="heading-4">若依工作流</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96df552a271e405688e2ae734a1be3a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766723359&amp;x-signature=%2BgdiDGiNGHx%2BktS1fi4XfgELDhI%3D" alt="r4.png" loading="lazy"/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruoyiflow.com" target="_blank" title="https://www.ruoyiflow.com" ref="nofollow noopener noreferrer">若依工作流</a> 提供开箱即用的工作流源码解决方案！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀别再卷 Redux 了！Zustand 才是 React 状态管理的躺平神器]]></title>    <link>https://juejin.cn/post/7585410547337723954</link>    <guid>https://juejin.cn/post/7585410547337723954</guid>    <pubDate>2025-12-20T02:50:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585410547337723954" data-draft-id="7585377128490631220" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀别再卷 Redux 了！Zustand 才是 React 状态管理的躺平神器"/> <meta itemprop="keywords" content="React.js,前端,面试"/> <meta itemprop="datePublished" content="2025-12-20T02:50:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风止何安啊"/> <meta itemprop="url" content="https://juejin.cn/user/2517239724512420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀别再卷 Redux 了！Zustand 才是 React 状态管理的躺平神器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517239724512420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风止何安啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T02:50:20.000Z" title="Sat Dec 20 2025 02:50:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><h2 data-id="heading-0"><code>Zustand</code>  VS  <code>Redux</code></h2>
<p>在文章开始前咱们先唠嗑一下，各位平时用哪个更多点呢？<strong>大数据</strong>不会骗人：</p>
<p>首先<code>GitHub</code>上的 Star 数量比较：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dae79054cda14ddf91cbd6dfca32a293~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=PIoL1fNIHR%2Fa7LPILLJXuGiE4s0%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7323fd248be42978ceb9e219f0b4101~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=l9bzGuLM7S358Pep1XYqMNk04GE%3D" alt="image.png" loading="lazy"/></p>
<p>其次每周的下载数量比较：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/031b589864214d159786932ac330fc23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=9Bp8POAuYFn1gTlZWOmhiwD2L78%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f49f9a7b333e4d979a9d679340254b26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=QRIHy2JMzg2eFv2LAf1xp%2FDnW5M%3D" alt="image.png" loading="lazy"/></p>
<p>显然，想必用<code>Zustand</code>的可能大概也许应该会居多（单纯看数据来讲）。那么明明<code>Redux</code>才是大哥，为啥被<code>Zustand</code>这个小弟后来居上了？</p>
<p>给大家一个表：</p>



































<table><thead><tr><th>对比项</th><th>Redux（老牌流程派）</th><th>Zustand（新晋清爽党）</th></tr></thead><tbody><tr><td>上手门槛</td><td>高：得记 action type、reducer、Provider 等一堆概念</td><td>低：会用 React Hook 就能写，几行代码起手</td></tr><tr><td>代码量</td><td>多：改个 count 得写 action、reducer 一堆模板代码</td><td>少：创建 store + 组件调用，加起来不到 20 行</td></tr><tr><td>组件里怎么用</td><td>得用 <code>useSelector</code> 取数据 + <code>useDispatch</code> 发动作</td><td>直接 <code>useStore( state =&gt; state.xxx )</code> 一步到位</td></tr><tr><td>要不要包 Provider</td><td>必须包：得用 <code>&lt;Provider store={store}&gt;</code> 裹整个 App</td><td>不用包：组件直接调用 store，省一层嵌套</td></tr><tr><td>适合场景</td><td>大型复杂项目（多人协作、状态逻辑多）</td><td>中小型项目 / 快速开发（想少写代码、快速落地）</td></tr></tbody></table>
<p>相信看完表大家已经很明了了，那么如果还想深入了解的可以自行去搜搜，我们唠嗑就到这，开始今天的学习。</p>
<p>具体资料大家去官网看：</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fzustand" target="_blank" title="https://www.npmjs.com/package/zustand" ref="nofollow noopener noreferrer">www.npmjs.com/package/zus…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Freact-redux" target="_blank" title="https://www.npmjs.com/package/react-redux" ref="nofollow noopener noreferrer">www.npmjs.com/package/rea…</a></p>
</blockquote>
<h2 data-id="heading-1">前言</h2>
<p>想象一下：你正在开发一个 <code>React</code> 项目，<strong>Home 组件</strong>要改个数字，<strong>About 组件</strong>得同步显示，<strong>List 组件</strong>还要从接口拉数据 —— 要是每个组件都自己存状态，代码早乱成一锅粥了！今天咱们就用 <code>Zustand</code> 这个<strong>躺平神器</strong>，把这些组件串成丝滑的整体，顺便解锁 React 全局状态的 <strong>“极简玩法”</strong>。</p>
<h3 data-id="heading-2">一、先搭个 “状态仓库”：Zustand 初体验</h3>
<p><code>Zustand</code> 是啥？你可以把它理解成一个 <strong>“共享储物柜”</strong>：组件们不用再互相传 <code>props</code>，直接从这个柜子里拿数据、调方法就行。</p>
<p>首先你需要下载<code>Zustand</code>（在开篇的资料里也可以找到~）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c1d479b2f324448bf69f482aaec11c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=7No%2FHByDB3vEZyN5nYKmCDMeNGs%3D" alt="image.png" loading="lazy"/></p>
<p>先看我们的第一个 “储物格”——<code>count.js</code>（负责管理计数状态）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/store/count.js</span>
<span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">"zustand"</span>;

<span class="hljs-comment">// 用 create 造一个“状态仓库”</span>
<span class="hljs-keyword">const</span> useCountStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
    <span class="hljs-comment">// 存数据：初始计数是0，还有个默认年龄19</span>
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">19</span>,
    <span class="hljs-comment">// 存方法：点一下计数+1（set会自动更新视图）</span>
    <span class="hljs-attr">increase</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> })),
    <span class="hljs-comment">// 传个参数，计数直接减val</span>
    <span class="hljs-attr">decrease</span>: <span class="hljs-function">(<span class="hljs-params">val</span>) =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> - val }))
}))

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useCountStore;
</code></pre>
<p>就这么几行，一个能 <strong>“存数据 + 改数据”</strong> 的全局状态就搞定了 —— 比 Redux 轻量到没朋友！</p>
<h3 data-id="heading-3">二、组件 “抢着用”：状态共享原来这么丝滑</h3>
<p>有了仓库，组件们就能 “按需取货” 了。先看 <strong>Home 组件</strong>（负责操作计数）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// src/components/Home.jsx</span>
<span class="hljs-keyword">import</span> useCountStore <span class="hljs-keyword">from</span> <span class="hljs-string">'../store/count.js'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 从仓库里“拿”count数据</span>
    <span class="hljs-keyword">let</span> count = <span class="hljs-title function_">useCountStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">count</span>);
    <span class="hljs-comment">// 从仓库里“拿”increase、decrease方法</span>
    <span class="hljs-keyword">const</span> increase = <span class="hljs-title function_">useCountStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">increase</span>);
    <span class="hljs-keyword">const</span> decrease = <span class="hljs-title function_">useCountStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">decrease</span>);
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {/* 点按钮直接调仓库里的方法，不用传参！ */}
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{increase}</span>&gt;</span>发送-{count}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> decrease(10)}&gt;减少-{count}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>再看 <strong>About 组件</strong>（负责显示计数）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// src/components/About.jsx</span>
<span class="hljs-keyword">import</span> useCountStore <span class="hljs-keyword">from</span> <span class="hljs-string">"../store/count"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">About</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 同样从仓库拿count，Home改了这里自动更！</span>
    <span class="hljs-keyword">let</span> count = <span class="hljs-title function_">useCountStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">count</span>);
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>title-{count}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>点击前：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74aba9ea775b4eac85fa667e5d6f8535~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=PnGVL84Z1INxXqVr12EWpGwla0E%3D" alt="image.png" loading="lazy"/></p>
<p>点击<strong>10次发送</strong>后：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62917e087a854c55938ef4bd46edbd8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=OgYsGTWma1nbdx%2BysDOeGq3CSg8%3D" alt="image.png" loading="lazy"/></p>
<p>刷新然后点击<strong>10次减少</strong>后：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18deb8bd80f14cd29519606a94dab509~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=t3R2YHZRpQ4DY6WqkwZNIQt4Ijk%3D" alt="image.png" loading="lazy"/></p>
<p>你看你看你看看看，<code>Home</code> 点按钮改了 <strong>count，About</strong> 里的标题直接同步更新 —— 连 props 都不用传，这丝滑感谁用谁知道！</p>
<h3 data-id="heading-4">三、进阶玩法：状态里塞接口请求</h3>
<p>光存数字才哪到哪，<strong>还不够炫</strong>！咱们给仓库加个 “拉接口” 的功能。先写 <code>list.js</code>（负责管理列表数据）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/store/list.js</span>
<span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">"zustand"</span>;

<span class="hljs-comment">// 先写个请求接口的函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchApi</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://mock.mengxuegu.com/mock/66585c4db462b81cb3916d3e/songer/songer'</span>);
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
    <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>; <span class="hljs-comment">// async函数的return会变成Promise的resolve值</span>
}

<span class="hljs-comment">// 造个存列表的仓库</span>
<span class="hljs-keyword">const</span> useListStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
    <span class="hljs-attr">list</span>: [], <span class="hljs-comment">// 初始列表是空数组</span>
    <span class="hljs-comment">// 存个“拉列表”的方法，里面调用接口</span>
    <span class="hljs-attr">fetchList</span>: <span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchApi</span>();
        <span class="hljs-title function_">set</span>({ <span class="hljs-attr">list</span>: res }) <span class="hljs-comment">// 拿到数据后更新list</span>
    }
}))

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useListStore;
</code></pre>
<p>然后让 <strong>List 组件</strong> 用这个仓库：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// src/components/List.jsx</span>
<span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> useListStore <span class="hljs-keyword">from</span> <span class="hljs-string">"../store/list"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">List</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 从仓库拿list数据和fetchList方法</span>
    <span class="hljs-keyword">const</span> list = <span class="hljs-title function_">useListStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">list</span>);
    <span class="hljs-keyword">const</span> fetchList = <span class="hljs-title function_">useListStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">fetchList</span>);

    <span class="hljs-comment">// 组件一加载就调用接口拉数据</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">fetchList</span>()
    }, [])

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {/* 拿到数据直接map渲染 */}
            {list.map((item) =&gt; {
                return <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.name}</span>&gt;</span>{item.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            })}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>接口数据就出现在浏览器上啦：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf758c4ca4544619ba6cd21247f969aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=kVQsvN12pi6rGub750QVknFixf0%3D" alt="image.png" loading="lazy"/></p>
<p>打开页面，<strong>List 组件</strong>会自动<strong>拉接口、存数据、渲染列表</strong> —— 状态管理 + 接口请求，一套流程直接在仓库里包圆了！</p>
<h3 data-id="heading-5">四、最后一步：把组件都塞进 App</h3>
<p>最后在 <code>App.jsx</code> 里把这些组件拼起来：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/Home"</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/About"</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">List</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/List"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Home</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Home</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">About</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">About</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">List</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">List</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b1499e7d82c4051bd978af9f145b954~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766803819&amp;x-signature=z63RmA22UzL7foxHhh9CHbSzEdg%3D" alt="image.png" loading="lazy"/></p>
<p>启动项目，你会看到：About 显示着计数，List 自动渲染接口数据 —— 这就是 <code>Zustand</code> 给 React 带来的 <strong>“状态自由”</strong>！</p>
<h3 data-id="heading-6">总结</h3>
<p><code>Zustand</code> 堪称 React 状态管理的 <strong>“轻骑兵”</strong>：无需写冗余的 reducer、不用嵌套 Provider 包裹组件树，几行代码就能搭建<strong>全局状态仓库</strong>。它剥离了传统状态管理的繁琐仪式感，让我们彻底摆脱模板代码的束缚，聚焦业务本身。</p>
<h2 data-id="heading-7">结语</h2>
<p>相比 <code>Redux</code> 的 “厚重” 和 <code>Context API</code> 在高频更新下的性能短板，<code>Zustand</code> 就像一把恰到好处的 <strong>“瑞士军刀”</strong>，轻巧却锋利，用最简单的方式解决了 React 组件间的状态共享难题，让开发者能把更多精力放在业务逻辑本身，而不是状态管理的 “套路” 里。</p>
<blockquote>
<p><strong>好的工具从来不是炫技的枷锁，而是让开发者回归创造本身的桥梁。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[掌握相关性分析：读懂数据间的“悄悄话”]]></title>    <link>https://juejin.cn/post/7585171571129384996</link>    <guid>https://juejin.cn/post/7585171571129384996</guid>    <pubDate>2025-12-19T08:04:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585171571129384996" data-draft-id="7585171571129303076" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="掌握相关性分析：读懂数据间的“悄悄话”"/> <meta itemprop="keywords" content="Python,数据分析,数据挖掘"/> <meta itemprop="datePublished" content="2025-12-19T08:04:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="databook"/> <meta itemprop="url" content="https://juejin.cn/user/3526889035006702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            掌握相关性分析：读懂数据间的“悄悄话”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889035006702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    databook
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T08:04:20.000Z" title="Fri Dec 19 2025 08:04:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数据分析的江湖里，我们经常会听到老板或业务方抛出这样的问题：</p>
<ul>
<li>“现在的年轻人越晚睡，买护肤品是不是越疯狂？”</li>
<li>“我们APP的各种优惠券，真的能提升用户的留存率吗？”</li>
<li>“天气越热，这只股票是不是跌得越惨？”</li>
</ul>
<p>面对这些问题，很多新人容易犯 <strong>“凭感觉”</strong> 的错误：“我觉得应该有关系吧……”</p>
<p><strong>数据分析不相信“我觉得”，只相信证据。</strong> 而寻找变量之间关系强弱的这个过程，就叫做<strong>相关分析</strong>。</p>
<p>今天，就带大家把相关分析的工具箱翻个底朝天，从基础到进阶，一次性讲透！</p>
<h2 data-id="heading-0">1. 什么是相关分析？</h2>
<p>简单来说，相关分析就是判断<strong>两个或多个事物之间是否存在某种联系，以及这种联系有多紧密</strong>。</p>
<p>但请务必记住数据分析界的第一铁律：<strong>相关 <strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo mathvariant="normal">≠</mo></mrow><annotation encoding="application/x-tex">\neq</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="inner"><span class="mord"><span class="mrel"></span></span></span><span class="fix"/></span></span></span></span><span class="mrel">=</span></span></span></span></span></span></strong> 因果</strong>。</p>
<ul>
<li><strong>相关</strong>：公鸡叫了，天亮了。（它俩有关系，经常一起发生）</li>
<li><strong>因果</strong>：因为公鸡叫了，所以天亮了。（这就错了，天亮是因为地球自转，不是因为鸡叫）</li>
</ul>
<p>我们要做的，就是用数值（相关系数）来量化这种“一起发生”的程度。</p>
<h2 data-id="heading-1">2. 数据相关的“三剑客”</h2>
<p><strong>皮尔森相关系数</strong>，<strong>斯皮尔曼相关系数</strong>和<strong>肯达尔相关系数</strong>，这是最常见的三种相关系数，它们处理的是<strong>数值型</strong>或者<strong>有等级顺序</strong>的数据。</p>
<h3 data-id="heading-2">2.1. 皮尔森相关系数：精确测量的标准</h3>
<p><strong>皮尔森相关</strong>是最常用的相关性分析方法，适用于符合以下条件的数据：</p>
<ul>
<li>连续数据（定距或定比尺度）</li>
<li>数据服从正态分布</li>
<li>变量间呈线性关系</li>
</ul>
<p>这是最“挑剔”也是最常用的指标。它要求数据是<strong>连续数值</strong>（定距/定比），并且最好服从<strong>正态分布</strong>（钟形曲线）。它衡量的是<strong>线性关系</strong>（是不是一条直线）。</p>
<p>比如：<strong>身高和体重</strong>。一般来说，人越高，体重越重，这是一个比较标准的线性关系。</p>
<p>它的取值范围从 <code>-1</code> 到 <code>1</code>。接近 1 表示<strong>正相关</strong>（同涨同跌），接近 -1 表示<strong>负相关</strong>（此消彼长），0 表示<strong>没关系</strong>。</p>
<p>代码示例如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> stats

<span class="hljs-comment"># 模拟数据：运动时间(小时/周)与体重指数(BMI)</span>
np.random.seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># 生成100个样本</span>
n_samples = <span class="hljs-number">100</span>
exercise_time = np.random.normal(<span class="hljs-number">5</span>, <span class="hljs-number">2</span>, n_samples)  <span class="hljs-comment"># 平均每周运动5小时</span>
<span class="hljs-comment"># BMI与运动时间负相关（运动越多，BMI越低）</span>
bmi = <span class="hljs-number">25</span> - <span class="hljs-number">0.5</span> * exercise_time + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">1.5</span>, n_samples)

<span class="hljs-comment"># 创建DataFrame</span>
data = pd.DataFrame({<span class="hljs-string">'运动时间_小时每周'</span>: exercise_time, <span class="hljs-string">'BMI'</span>: bmi})

<span class="hljs-comment"># 计算皮尔森相关系数</span>
pearson_corr, p_value = stats.pearsonr(data[<span class="hljs-string">'运动时间_小时每周'</span>], data[<span class="hljs-string">'BMI'</span>])
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"皮尔森相关系数: <span class="hljs-subst">{pearson_corr:<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"P值: <span class="hljs-subst">{p_value:<span class="hljs-number">.5</span>f}</span>"</span>)

<span class="hljs-comment"># 运行结果：</span>
<span class="hljs-string">'''
皮尔森相关系数: -0.614
P值: 0.00000
'''</span>
</code></pre>
<p>图形展示的效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/807281bfaebc40d7b2a19fa14a27ceed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736259&amp;x-signature=3yShIPrcXp47bU87baG4V6xpya4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.2. 斯皮尔曼相关系数：打破正态分布的限制</h3>
<p>如果数据<strong>不服从正态分布</strong>，或者有<strong>极端值</strong>（比如马云的财富混进了我们的收入数据中），<strong>皮尔森相关系数</strong>就不准了。</p>
<p>这时候用<strong>斯皮尔曼相关系数</strong>。它看重的是排名（Rank），而不是具体数值。</p>
<p>比如语文成绩排名和数学成绩排名，我们不关心具体考了多少分，只关心你的位次。</p>
<p>代码示例如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 模拟数据：社交媒体表现</span>
np.random.seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># 生成非正态分布的数据</span>
followers = np.random.exponential(<span class="hljs-number">5000</span>, <span class="hljs-number">50</span>)  <span class="hljs-comment"># 指数分布</span>
likes = <span class="hljs-number">0.1</span> * followers**<span class="hljs-number">1.2</span> + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">50</span>)  <span class="hljs-comment"># 非线性关系</span>

<span class="hljs-comment"># 创建DataFrame</span>
social_data = pd.DataFrame({<span class="hljs-string">"粉丝数"</span>: followers, <span class="hljs-string">"平均点赞数"</span>: likes})

<span class="hljs-comment"># 计算斯皮尔曼相关系数</span>
spearman_corr, spearman_p = stats.spearmanr(
    social_data[<span class="hljs-string">"粉丝数"</span>], social_data[<span class="hljs-string">"平均点赞数"</span>]
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"斯皮尔曼相关系数: <span class="hljs-subst">{spearman_corr:<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"P值: <span class="hljs-subst">{spearman_p:<span class="hljs-number">.5</span>f}</span>"</span>)

<span class="hljs-comment"># 运行结果：</span>
<span class="hljs-string">'''
斯皮尔曼相关系数: 0.857
P值: 0.00000
'''</span>
</code></pre>
<p>图形化结果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab63f41784814f9c8f0a1e47b02e0253~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736259&amp;x-signature=q3vEuk3JjaRI3TN%2BRvOfTqSzBaM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">2.3. 肯达尔相关系数：小样本和有序数据的首选</h3>
<p><strong>肯达尔相关</strong>也适用于等级数据，与<strong>斯皮尔曼相关</strong>不同，它更关注“和谐对”与“不和谐对”。</p>
<p>通常用于样本量较小，或者数据有很多并列排名的情况。</p>
<p>比如：<strong>两位面试官给5个候选人打分</strong>。我们要看这两位面试官的审美标准是否一致。</p>
<p>代码示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 模拟数据：电影评分与票房</span>
np.random.seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># 生成有序数据（电影评分和票房排名）</span>
movie_data = pd.DataFrame(
    {
        <span class="hljs-string">"电影名称"</span>: [<span class="hljs-string">f"电影<span class="hljs-subst">{i}</span>"</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">21</span>)],
        <span class="hljs-string">"评分等级"</span>: np.random.choice(
            [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>], <span class="hljs-number">20</span>, p=[<span class="hljs-number">0.1</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.1</span>]
        ),  <span class="hljs-comment"># 1-5星</span>
        <span class="hljs-string">"票房排名"</span>: np.arange(<span class="hljs-number">1</span>, <span class="hljs-number">21</span>),  <span class="hljs-comment"># 票房排名</span>
    }
)

<span class="hljs-comment"># 添加一些相关性：评分越高，票房排名越好（数字越小）</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(movie_data)):
    <span class="hljs-keyword">if</span> movie_data.loc[i, <span class="hljs-string">"评分等级"</span>] &gt;= <span class="hljs-number">4</span>:
        movie_data.loc[i, <span class="hljs-string">"票房排名"</span>] = <span class="hljs-built_in">max</span>(
            <span class="hljs-number">1</span>, movie_data.loc[i, <span class="hljs-string">"票房排名"</span>] - np.random.randint(<span class="hljs-number">3</span>, <span class="hljs-number">8</span>)
        )
    <span class="hljs-keyword">elif</span> movie_data.loc[i, <span class="hljs-string">"评分等级"</span>] &lt;= <span class="hljs-number">2</span>:
        movie_data.loc[i, <span class="hljs-string">"票房排名"</span>] = <span class="hljs-built_in">min</span>(
            <span class="hljs-number">20</span>, movie_data.loc[i, <span class="hljs-string">"票房排名"</span>] + np.random.randint(<span class="hljs-number">3</span>, <span class="hljs-number">8</span>)
        )

<span class="hljs-comment"># 计算肯德尔相关系数</span>
kendall_corr, kendall_p = stats.kendalltau(
    movie_data[<span class="hljs-string">"评分等级"</span>], movie_data[<span class="hljs-string">"票房排名"</span>]
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"肯德尔相关系数: <span class="hljs-subst">{kendall_corr:<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"P值: <span class="hljs-subst">{kendall_p:<span class="hljs-number">.5</span>f}</span>"</span>)

<span class="hljs-comment"># 运行结果：</span>
<span class="hljs-string">'''
肯德尔相关系数: -0.503
P值: 0.00460
'''</span>
</code></pre>
<p>图形化结果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c3cdb566e334286ab6d44f6d77eef14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736259&amp;x-signature=9J3ztbsCmfvXPAjLsnaSRRWqegA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">3. 偏相关分析：谁是“第三者”？</h2>
<p>有时候，两个变量看起来关系很好，其实是因为有“第三者”在捣乱。</p>
<p><strong>偏相关分析</strong>允许我们在控制其他变量的情况下，分析两个变量之间的 <strong>"纯"</strong> 相关性。</p>
<p>比如一个生活中的案例：<strong>“冰淇淋销量”</strong> 和 <strong>“溺水事故数量”</strong>。
数据统计发现，冰淇淋卖得越好的日子，溺水的人越多（相关系数很高）。难道吃冰淇淋会导致溺水？
当然不是！背后的控制变量（第三者）是<strong>气温</strong>。气温高 -&gt; 买冰淇淋多 &amp; 游泳的人多 -&gt; 溺水概率大。</p>
<p>想要正确分析，必须<strong>剔除</strong>控制变量（气温）的影响后，再看另外两个变量（冰淇淋和溺水）是否还相关。</p>
<p>下面的示例中，我们先排除收入影响后，分析教育水平与消费水平的关系。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用pingouin库进行偏相关分析（需要安装：pip install pingouin）</span>
<span class="hljs-keyword">import</span> pingouin <span class="hljs-keyword">as</span> pg

<span class="hljs-comment"># 模拟数据：教育水平、收入和消费水平</span>
np.random.seed(<span class="hljs-number">42</span>)
n = <span class="hljs-number">100</span>

<span class="hljs-comment"># 教育水平（1-5，5为最高）</span>
education = np.random.choice([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>], n, p=[<span class="hljs-number">0.1</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.1</span>])

<span class="hljs-comment"># 收入与教育水平正相关</span>
income = <span class="hljs-number">30000</span> + <span class="hljs-number">15000</span> * education + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">5000</span>, n)

<span class="hljs-comment"># 消费水平与收入和教育水平都相关</span>
consumption = <span class="hljs-number">1000</span> + <span class="hljs-number">0.3</span> * income + <span class="hljs-number">200</span> * education + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">500</span>, n)

<span class="hljs-comment"># 创建DataFrame</span>
socioeconomic_data = pd.DataFrame(
    {<span class="hljs-string">"教育水平"</span>: education, <span class="hljs-string">"收入_元每月"</span>: income, <span class="hljs-string">"消费水平"</span>: consumption}
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 简单相关分析 ==="</span>)
simple_corr, simple_p = stats.pearsonr(
    socioeconomic_data[<span class="hljs-string">"教育水平"</span>], socioeconomic_data[<span class="hljs-string">"消费水平"</span>]
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"教育水平与消费水平的简单相关系数: <span class="hljs-subst">{simple_corr:<span class="hljs-number">.3</span>f}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 偏相关分析（控制收入）==="</span>)
<span class="hljs-comment"># 使用pingouin进行偏相关分析</span>
partial_corr = pg.partial_corr(
    data=socioeconomic_data, x=<span class="hljs-string">"教育水平"</span>, y=<span class="hljs-string">"消费水平"</span>, covar=<span class="hljs-string">"收入_元每月"</span>
)
<span class="hljs-built_in">print</span>(partial_corr.<span class="hljs-built_in">round</span>(<span class="hljs-number">3</span>))

<span class="hljs-comment"># 运行结果：</span>
<span class="hljs-string">'''
=== 简单相关分析 ===
教育水平与消费水平的简单相关系数: 0.965

=== 偏相关分析（控制收入）===
        n   r    	CI95%       	p-val
pearson	100	0.129	[-0.07, 0.32]	0.204
'''</span>
</code></pre>
<p>图形化结果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c05c356bc346492c80d9027872de5fd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736259&amp;x-signature=R5Erjg6Ohs%2FdKChCd%2FaLIBH3yQQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">4. 距离相关分析：多变量关系的度量</h2>
<p><strong>距离相关分析</strong>可以衡量两组变量（每个变量组包含多个指标）之间的相关性，是<strong>多变量分析</strong>的有力工具。</p>
<p>比如<strong>压力与工作效率</strong>（耶克斯-多德森定律）的关系。</p>
<p>压力太小，人会懒散（效率低）；压力太大，人会崩溃（效率低）；只有适度的压力，效率最高。</p>
<p>这是一个 <strong>U型（非线性）</strong> 关系。这时候用<code>Pearson</code>去算，结果可能是<code>0</code>（因为它找不到直线），但其实它们关系很紧密。</p>
<p>下面的示例，比较两个城市的综合发展水平（经济、环境、社会等多维度指标）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> scipy.spatial.distance <span class="hljs-keyword">import</span> pdist, squareform

<span class="hljs-comment"># 模拟数据：两个城市的多维指标</span>
np.random.seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># 城市A和城市B的6个发展指标（经济、环境、教育、医疗、文化、创新）</span>
indicators = [<span class="hljs-string">"经济"</span>, <span class="hljs-string">"环境"</span>, <span class="hljs-string">"教育"</span>, <span class="hljs-string">"医疗"</span>, <span class="hljs-string">"文化"</span>, <span class="hljs-string">"创新"</span>]
city_a = np.array([<span class="hljs-number">85</span>, <span class="hljs-number">78</span>, <span class="hljs-number">90</span>, <span class="hljs-number">88</span>, <span class="hljs-number">82</span>, <span class="hljs-number">80</span>]) + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>)
city_b = np.array([<span class="hljs-number">88</span>, <span class="hljs-number">75</span>, <span class="hljs-number">87</span>, <span class="hljs-number">92</span>, <span class="hljs-number">79</span>, <span class="hljs-number">85</span>]) + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>)

<span class="hljs-comment"># 创建多个城市的比较数据</span>
cities_data = pd.DataFrame(
    {
        <span class="hljs-string">"城市A"</span>: city_a,
        <span class="hljs-string">"城市B"</span>: city_b,
        <span class="hljs-string">"城市C"</span>: np.array([<span class="hljs-number">70</span>, <span class="hljs-number">85</span>, <span class="hljs-number">75</span>, <span class="hljs-number">80</span>, <span class="hljs-number">90</span>, <span class="hljs-number">72</span>]) + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>),
        <span class="hljs-string">"城市D"</span>: np.array([<span class="hljs-number">92</span>, <span class="hljs-number">70</span>, <span class="hljs-number">85</span>, <span class="hljs-number">87</span>, <span class="hljs-number">76</span>, <span class="hljs-number">91</span>]) + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>),
        <span class="hljs-string">"城市E"</span>: np.array([<span class="hljs-number">78</span>, <span class="hljs-number">88</span>, <span class="hljs-number">80</span>, <span class="hljs-number">85</span>, <span class="hljs-number">87</span>, <span class="hljs-number">78</span>]) + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>),
    },
    index=indicators,
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"各城市发展指标数据："</span>)
<span class="hljs-built_in">print</span>(cities_data.<span class="hljs-built_in">round</span>(<span class="hljs-number">2</span>))


<span class="hljs-comment"># 计算距离相关性（自定义简化版）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">distance_correlation</span>(<span class="hljs-params">x, y</span>):
    <span class="hljs-string">"""计算距离相关性"""</span>

    <span class="hljs-comment"># 计算距离矩阵</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">dist_matrix</span>(<span class="hljs-params">v</span>):
        v = np.array(v)
        n = <span class="hljs-built_in">len</span>(v)
        a = np.zeros((n, n))
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
                a[i, j] = <span class="hljs-built_in">abs</span>(v[i] - v[j])
        <span class="hljs-keyword">return</span> a

    A = dist_matrix(x)
    B = dist_matrix(y)

    <span class="hljs-comment"># 双中心化</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">double_centering</span>(<span class="hljs-params">D</span>):
        n = <span class="hljs-built_in">len</span>(D)
        row_means = D.mean(axis=<span class="hljs-number">1</span>)
        col_means = D.mean(axis=<span class="hljs-number">0</span>)
        grand_mean = D.mean()

        C = np.zeros((n, n))
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
                C[i, j] = D[i, j] - row_means[i] - col_means[j] + grand_mean
        <span class="hljs-keyword">return</span> C

    A_centered = double_centering(A)
    B_centered = double_centering(B)

    <span class="hljs-comment"># 计算距离协方差和距离方差</span>
    dCov_XY = np.sqrt((A_centered * B_centered).<span class="hljs-built_in">sum</span>() / (<span class="hljs-built_in">len</span>(x) ** <span class="hljs-number">2</span>))
    dVar_X = np.sqrt((A_centered * A_centered).<span class="hljs-built_in">sum</span>() / (<span class="hljs-built_in">len</span>(x) ** <span class="hljs-number">2</span>))
    dVar_Y = np.sqrt((B_centered * B_centered).<span class="hljs-built_in">sum</span>() / (<span class="hljs-built_in">len</span>(x) ** <span class="hljs-number">2</span>))

    <span class="hljs-comment"># 计算距离相关性</span>
    dCor = dCov_XY / np.sqrt(dVar_X * dVar_Y)

    <span class="hljs-keyword">return</span> dCor


<span class="hljs-comment"># 比较城市A和城市B的距离相关性</span>
city_a_scores = cities_data[<span class="hljs-string">"城市A"</span>].values
city_b_scores = cities_data[<span class="hljs-string">"城市B"</span>].values

dcor = distance_correlation(city_a_scores, city_b_scores)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n城市A与城市B的距离相关性: <span class="hljs-subst">{dcor:<span class="hljs-number">.3</span>f}</span>"</span>)

<span class="hljs-comment"># 运行结果：</span>
<span class="hljs-string">'''
各城市发展指标数据：
      城市A  城市B  城市C  城市D   城市E
经济  87.48  95.90  71.21  87.46  75.28
环境  77.31  78.84  75.43  62.94  88.55
教育  93.24  84.65  66.38  92.33  74.25
医疗  95.62  94.71  77.19  85.87  86.88
文化  80.83  76.68  84.94  76.34  84.00
创新  78.83  82.67  73.57  83.88  76.54

城市A与城市B的距离相关性: 0.764
'''</span>
</code></pre>
<p>图形化的结果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f73a889047344872b76840e6f4a35f90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736259&amp;x-signature=eWWDkyeMbQLYNviejHsBsAeWT7k%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">5. 相关性卡方检验：分类变量的关联分析</h2>
<p>如果我们分析的数据不是数字，而是<strong>类别</strong>（定类数据/低测度数据）呢？</p>
<p>当两个变量都是分类变量（定类数据）时，我们可以使用<strong>卡方检验</strong>来分析它们之间是否存在关联。</p>
<p>比如<strong>性别（男/女）</strong> 与 <strong>爱喝的饮料（奶茶/咖啡）</strong> 是否相关？
这里没有大小之分，只有类别。我们可以使用<strong>卡方检验</strong>来判断两个分类变量是否独立。</p>
<p>下面的示例，我们尝试分析性别与购物偏好类别之间的关系。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 模拟数据：性别与购物偏好</span>
np.random.seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># 创建列联表</span>
data = pd.DataFrame(
    {
        <span class="hljs-string">"性别"</span>: np.random.choice([<span class="hljs-string">"男"</span>, <span class="hljs-string">"女"</span>], <span class="hljs-number">200</span>),
        <span class="hljs-string">"购物偏好"</span>: np.random.choice(
            [<span class="hljs-string">"电子产品"</span>, <span class="hljs-string">"服装鞋包"</span>, <span class="hljs-string">"美妆护肤"</span>, <span class="hljs-string">"运动户外"</span>, <span class="hljs-string">"家居生活"</span>], <span class="hljs-number">200</span>
        ),
    }
)

<span class="hljs-comment"># 根据性别调整偏好概率（创建一些关联）</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(data)):
    <span class="hljs-keyword">if</span> data.loc[i, <span class="hljs-string">"性别"</span>] == <span class="hljs-string">"男"</span>:
        <span class="hljs-comment"># 男性更可能偏好电子产品和运动户外</span>
        <span class="hljs-keyword">if</span> np.random.random() &lt; <span class="hljs-number">0.3</span>:
            data.loc[i, <span class="hljs-string">"购物偏好"</span>] = <span class="hljs-string">"电子产品"</span>
        <span class="hljs-keyword">elif</span> np.random.random() &lt; <span class="hljs-number">0.5</span>:
            data.loc[i, <span class="hljs-string">"购物偏好"</span>] = <span class="hljs-string">"运动户外"</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 女性更可能偏好美妆护肤和服装鞋包</span>
        <span class="hljs-keyword">if</span> np.random.random() &lt; <span class="hljs-number">0.3</span>:
            data.loc[i, <span class="hljs-string">"购物偏好"</span>] = <span class="hljs-string">"美妆护肤"</span>
        <span class="hljs-keyword">elif</span> np.random.random() &lt; <span class="hljs-number">0.4</span>:
            data.loc[i, <span class="hljs-string">"购物偏好"</span>] = <span class="hljs-string">"服装鞋包"</span>

<span class="hljs-comment"># 创建列联表</span>
contingency_table = pd.crosstab(data[<span class="hljs-string">"性别"</span>], data[<span class="hljs-string">"购物偏好"</span>])
<span class="hljs-built_in">print</span>(<span class="hljs-string">"性别与购物偏好的列联表："</span>)
<span class="hljs-built_in">print</span>(contingency_table)

<span class="hljs-comment"># 执行卡方检验</span>
chi2, p, dof, expected = stats.chi2_contingency(contingency_table)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n卡方检验结果："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"卡方值: <span class="hljs-subst">{chi2:<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"P值: <span class="hljs-subst">{p:<span class="hljs-number">.5</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"自由度: <span class="hljs-subst">{dof}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n期望频数表："</span>)
<span class="hljs-built_in">print</span>(
    pd.DataFrame(
        expected, index=contingency_table.index, columns=contingency_table.columns
    ).<span class="hljs-built_in">round</span>(<span class="hljs-number">2</span>)
)


<span class="hljs-comment"># 计算Cramer's V（衡量分类变量关联强度）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">cramers_v</span>(<span class="hljs-params">contingency_table</span>):
    <span class="hljs-string">"""计算Cramer's V系数"""</span>
    chi2 = stats.chi2_contingency(contingency_table)[<span class="hljs-number">0</span>]
    n = contingency_table.<span class="hljs-built_in">sum</span>().<span class="hljs-built_in">sum</span>()
    min_dim = <span class="hljs-built_in">min</span>(contingency_table.shape) - <span class="hljs-number">1</span>

    v = np.sqrt(chi2 / (n * min_dim))
    <span class="hljs-keyword">return</span> v


cramers_v_value = cramers_v(contingency_table)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\nCramer's V系数: <span class="hljs-subst">{cramers_v_value:<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"解读：0.1-0.3弱相关，0.3-0.5中等相关，&gt;0.5强相关"</span>)

<span class="hljs-comment"># 运行结果：</span>
<span class="hljs-string">'''
性别与购物偏好的列联表：
购物偏好  家居生活  服装鞋包  电子产品  美妆护肤  运动户外
性别
女        2    33    15    40    10
男       10     2    45    10    33

卡方检验结果：
卡方值: 78.093
P值: 0.00000
自由度: 4

期望频数表：
购物偏好  家居生活  服装鞋包  电子产品  美妆护肤  运动户外
性别
女      6.0  17.5  30.0  25.0  21.5
男      6.0  17.5  30.0  25.0  21.5

Cramer's V系数: 0.625
解读：0.1-0.3弱相关，0.3-0.5中等相关，&gt;0.5强相关
'''</span>
</code></pre>
<p>图形化的结果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0266aa89fc7c433f9b792be686590296~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766736259&amp;x-signature=gtzddsW3L%2B7D3U5jiRPAUjvfqAA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">6. 总结</h2>
<p>数据分析师在面对变量关系时，要根据数据的 <strong>“长相”</strong> 来选工具：</p>








































<table><thead><tr><th>方法</th><th>适用数据类型</th><th>特点</th></tr></thead><tbody><tr><td>皮尔森相关</td><td>连续、正态分布、线性关系</td><td>最常用，对异常值敏感</td></tr><tr><td>斯皮尔曼相关</td><td>连续但不正态，或有序数据</td><td>稳健，适用于单调关系</td></tr><tr><td>肯德尔相关</td><td>有序数据，小样本</td><td>适合等级数据，解释直观</td></tr><tr><td>偏相关</td><td>需控制其他变量影响</td><td>揭示变量间的直接关系</td></tr><tr><td>距离相关</td><td>多变量组间关系</td><td>衡量多维度综合关联</td></tr><tr><td>卡方检验</td><td>分类变量</td><td>检验类别间关联性</td></tr></tbody></table>
<p>我们在分析数据相关性的时候，不要急于得出数据之间是否相关的结论。</p>
<p>先看看下面的注意事项是否有违背！</p>
<ol>
<li><strong>相关性不等于因果性</strong>：即使两个变量高度相关，也不能断定一个导致另一个</li>
<li><strong>警惕第三变量问题</strong>：可能两个变量都受到第三个未测量变量的影响</li>
<li><strong>注意异常值的影响</strong>：异常值可能夸大或掩盖真实的相关性</li>
<li><strong>检查线性假设</strong>：皮尔森相关要求线性关系，非线性关系需要其他方法</li>
<li><strong>样本大小的重要性</strong>：小样本的相关性可能不稳定</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-188 Logstash Output 插件实战：stdout/file/Elasticsearch 输出配置与调优]]></title>    <link>https://juejin.cn/post/7585283741540204590</link>    <guid>https://juejin.cn/post/7585283741540204590</guid>    <pubDate>2025-12-19T01:52:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585283741540204590" data-draft-id="7585289701792497690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-188 Logstash Output 插件实战：stdout/file/Elasticsearch 输出配置与调优"/> <meta itemprop="keywords" content="后端,大数据,Logstash"/> <meta itemprop="datePublished" content="2025-12-19T01:52:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-188 Logstash Output 插件实战：stdout/file/Elasticsearch 输出配置与调优
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T01:52:19.000Z" title="Fri Dec 19 2025 01:52:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：Logstash 过滤后需要稳定输出到控制台、文件、Elasticsearch，并支持多路复用与条件路由</li>
<li>结论：Output 阶段决定吞吐、可靠性与可观测性；参数（批量/重试/缓冲）比“能跑”更关键</li>
<li>产出：3 类输出最小可用配置 + 生产组合范式 + 性能与故障速查卡</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8748c160b3244759c27b19541a9eab0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=bZuXnjEh39FYUmGkDpH2WPln%2BgY%3D" alt="大数据-188 Logstash Output 插件实战：stdout/file/Elasticsearch 输出配置与调优" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>





































<table><thead><tr><th>组件/能力</th><th>已验证说明</th></tr></thead><tbody><tr><td>Logstash版本</td><td>7.3.0</td></tr><tr><td>示例目录结构</td><td><code>/opt/servers/logstash-7.3.0</code></td></tr><tr><td>stdout输出</td><td>使用rubydebug codec进行stdin联调与字段验收（最快闭环方式）</td></tr><tr><td>file输出</td><td>配置为<code>codec =&gt; line</code>格式，动态路径模板<code>%{+YYYY-MM-dd}-%{host}.txt</code></td></tr><tr><td>Elasticsearch输出</td><td>基础写入配置已给出（未标注ES版本，注意7/8版本差异会影响type/参数）</td></tr><tr><td>条件路由</td><td>支持（概念验证）</td></tr><tr><td>多输出并行</td><td>支持（需配合生产环境的队列/重试策略定型）</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0b0208dcbeb455a898c5b99d790cee5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=Ka0vyOKygEXjvWyP0QepKkpLFTI%3D" alt="Elasticsearch" loading="lazy"/></p>
<h2 data-id="heading-2">Output插件</h2>
<p>Logstash Output 插件是 Logstash 管道中的最后一个阶段，负责将处理后的数据输出到各种目标系统或存储设备。每一个输出插件都能将 Logstash 接收到并解析的数据发送到不同的外部服务，如数据库、消息队列、搜索引擎、文件系统等。</p>
<h3 data-id="heading-3">工作原理</h3>
<p>Logstash 的输出插件（Output Plugins）是数据处理流程的关键环节，负责将经过过滤处理的事件数据高效可靠地推送到各类外部系统。作为 Logstash 管道的最终阶段，输出插件支持多种数据目的地和传输协议，能够满足不同场景下的数据存储和分析需求。</p>
<p>常见的输出插件类型包括：</p>
<ol>
<li>
<p><strong>存储系统输出</strong>：</p>
<ul>
<li>Elasticsearch 输出插件（最常用）：将数据索引到 Elasticsearch 集群，支持批量提交和自动重试</li>
<li>文件输出插件：将事件写入本地文件系统，支持文件轮转和压缩</li>
<li>数据库输出插件：支持 MySQL、PostgreSQL 等关系型数据库</li>
</ul>
</li>
<li>
<p><strong>消息队列输出</strong>：</p>
<ul>
<li>Kafka 输出插件：将数据发布到 Kafka 主题</li>
<li>RabbitMQ 输出插件：通过 AMQP 协议发送消息</li>
</ul>
</li>
<li>
<p><strong>云服务输出</strong>：</p>
<ul>
<li>Amazon S3 输出插件：将日志存档到 S3 存储桶</li>
<li>Google Cloud Storage 输出插件</li>
</ul>
</li>
<li>
<p><strong>监控系统输出</strong>：</p>
<ul>
<li>Prometheus 输出插件</li>
<li>Nagios 输出插件</li>
</ul>
</li>
</ol>
<p>输出插件通常提供以下关键特性：</p>
<ul>
<li>批量处理能力（bulk processing）</li>
<li>自动重试机制（retry on failure）</li>
<li>负载均衡支持（multiple endpoints）</li>
<li>数据格式转换（如 JSON、CSV 等）</li>
</ul>
<p>配置示例（输出到 Elasticsearch）：</p>
<pre><code class="hljs language-ruby" lang="ruby">output {
  elasticsearch {
    hosts =&gt; [<span class="hljs-string">"http://localhost:9200"</span>]
    index =&gt; <span class="hljs-string">"applogs-%{+YYYY.MM.dd}"</span>
    document_type =&gt; <span class="hljs-string">"_doc"</span>
    retry_on_failure =&gt; <span class="hljs-number">3</span>
  }
}
</code></pre>
<p>在实际生产环境中，通常会采用多输出插件组合的方式，比如同时输出到 Elasticsearch 进行实时分析和文件系统进行长期归档。输出插件的性能调优（如批量大小、工作线程数等参数）对整体数据处理效率有重要影响。</p>
<h3 data-id="heading-4">主要功能</h3>
<ul>
<li>多种输出目标：支持广泛的输出目标，如 Elasticsearch、Kafka、RabbitMQ、Amazon S3、文件、HTTP、数据库等。</li>
<li>批处理：在某些情况下，输出插件可以批量发送数据，而非逐条处理，从而提高性能。例如，Elasticsearch 插件可以配置批量请求，以优化写入性能。</li>
<li>数据格式化：插件能够根据需要以特定格式（如 JSON、CSV、Plaintext）输出数据。</li>
<li>重试机制：某些输出插件具有自动重试功能，确保在网络故障或系统不稳定时数据不会丢失。</li>
<li>动态路由：可以根据事件的内容动态决定数据输出到哪个目标系统。通过条件语句，可以对不同类型的数据使用不同的输出路径。</li>
<li>插件配置灵活性：每个插件都有丰富的配置选项，可以定制行为，比如指定目标主机、端口、身份验证机制、缓冲设置、批处理参数等。</li>
</ul>
<h3 data-id="heading-5">高级功能</h3>
<ul>
<li>
<p><strong>输出负载均衡</strong>：Logstash 提供了强大的负载均衡功能，可以配置多个输出目标（如多个 Elasticsearch 节点或多个 Kafka 代理）。Logstash 会自动将数据轮询分发到这些目标，避免单点故障并提高数据传输的吞吐量。例如，在生产环境中可以配置 3 个 Elasticsearch 节点作为输出目标，Logstash 会均匀地将日志事件分发到这些节点，既提高了系统的可用性，又实现了读写负载的均衡分配。</p>
</li>
<li>
<p><strong>事件条件判断</strong>：Logstash 支持使用条件语句（如 if/else）对事件进行过滤和路由。可以根据事件字段值动态决定输出目标，实现精细化的日志分发策略。典型应用场景包括：</p>
<ul>
<li>将 ERROR 级别的日志发送到专门的告警系统</li>
<li>将不同业务线的日志路由到不同的 Elasticsearch 索引</li>
<li>示例配置：</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby">    output {
      <span class="hljs-keyword">if</span> [log_level] == <span class="hljs-string">"ERROR"</span> {
        elasticsearch { ... } <span class="hljs-comment"># 错误日志专用管道</span>
      } <span class="hljs-keyword">else</span> {
        kafka { ... } <span class="hljs-comment"># 普通日志管道</span>
      }
    }
</code></pre>
<ul>
<li><strong>插件组合输出</strong>：Logstash 支持在单个管道中并行使用多个输出插件，实现数据的多路复用。常见组合方式包括：
<ul>
<li>存储+转发组合：同时写入 Elasticsearch 和 Kafka</li>
<li>主备方案：主要输出到 Elasticsearch，备用输出到文件系统</li>
<li>监控方案：在业务输出的同时，将统计指标发送到 Prometheus</li>
<li>典型配置示例：</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby">    output {
      elasticsearch { ... } <span class="hljs-comment"># 主要存储</span>
      kafka { 
        topic_id =&gt; <span class="hljs-string">"log_backup"</span> <span class="hljs-comment"># 消息队列备份</span>
      }
      file {
        path =&gt; <span class="hljs-string">"/var/log/logstash/archive.log"</span> <span class="hljs-comment"># 本地归档</span>
      }
    }
</code></pre>
<h3 data-id="heading-6">常见问题</h3>
<ul>
<li>
<p><strong>网络问题</strong>：由于输出插件大多与外部系统交互，网络问题可能导致输出失败。常见的网络问题包括：</p>
<ul>
<li>连接超时（如默认 30 秒未建立连接）</li>
<li>带宽限制导致数据传输缓慢</li>
<li>防火墙或安全组策略阻止访问</li>
<li>DNS 解析失败
应对方案：</li>
<li>重试机制（如指数退避重试，初始间隔 1 秒，最大重试 5 次）</li>
<li>内存/磁盘缓冲（如设置 500MB 内存缓冲区，溢出时写入临时文件）</li>
<li>心跳检测（每 60 秒发送 ping 包检测连接状态）</li>
</ul>
</li>
<li>
<p><strong>性能瓶颈</strong>：某些输出插件（例如 Elasticsearch、Kafka）在高并发场景下需要调整批处理和缓冲参数：</p>
<ul>
<li>Elasticsearch 场景：
<ul>
<li>建议批量大小设置为 500-1000 条/批次</li>
<li>并发 worker 数建议为 CPU 核数的 1.5 倍</li>
<li>启用压缩传输（设置 gzip 压缩级别为 6）</li>
</ul>
</li>
<li>Kafka 场景：
<ul>
<li>调整 linger.ms 参数（建议 50-100ms）</li>
<li>设置 batch.size 为 16384-32768 字节</li>
<li>配置 acks=1 平衡可靠性与性能</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>数据格式问题</strong>：输出的数据格式需要与目标系统兼容，典型场景包括：</p>
<ul>
<li>数据库写入：
<ul>
<li>字段类型映射（如将日志中的字符串 "123" 转换为 INTEGER 类型）</li>
<li>时间格式转换（UTC 时间转本地时区）</li>
<li>处理字段缺失（设置默认值或跳过空字段）</li>
</ul>
</li>
<li>API 对接：
<ul>
<li>遵循 OpenAPI 规范定义数据结构</li>
<li>处理嵌套 JSON（展平或保留层级结构）</li>
<li>添加必要的请求头（如 Content-Type: application/json）</li>
</ul>
</li>
<li>特殊字符处理：
<ul>
<li>转义单引号（' → '）</li>
<li>处理换行符（\n → \n）</li>
<li>编码非 ASCII 字符（使用 UTF-8 编码）</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">标准输出到控制台</h3>
<p>将收集到的数据直接打印到控制台：</p>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0
bin/logstash -e 'input{stdin{}}output{stdout{codec=&gt;rubydebug}}'
</code></pre>
<p>运行之后，对应的结果如下所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40d36ea0cd5f4038be6f9aa8878f0446~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=6XkqaeSbMDa7Ocfe0%2FJ72%2FWbPqo%3D" alt="Logstash Output" loading="lazy"/></p>
<h3 data-id="heading-8">采集的数据保存到文件中</h3>
<h4 data-id="heading-9">需求描述</h4>
<p>Logstash也可以将收集到的数据写入到文件当中去保存，接下来我们看看Logstash如何配置以实现将数据写入到文件当中。</p>
<h4 data-id="heading-10">编写配置</h4>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0/config
vim output_file.conf
</code></pre>
<p>写入的内容如下：</p>
<pre><code class="hljs language-shell" lang="shell">input {stdin{}}
output {
  file {
    path =&gt; "/opt/servers/es/%{+YYYY-MM-dd}-%{host}.txt"
    codec =&gt; line {
      format =&gt; "%{message}"
    }
    flush_interval =&gt; 0
  }
}
</code></pre>
<p>写入的内容截图如下所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6cdb1ad77b1439bb32916ef80c6a4de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=fxuPvsR757pJhJb6Iycq5lIMDl4%3D" alt="Logstash Input output" loading="lazy"/></p>
<h4 data-id="heading-11">检查配置</h4>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0
bin/logstash -f /opt/servers/logstash-7.3.0/config/output_file.conf -t 
</code></pre>
<p>检查结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b5f51d84ae74a49a35d1cf6fba42def~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=LekDXzNwxb%2BuOekwgNGJT5ZsIpU%3D" alt="Logstash 检测配置" loading="lazy"/></p>
<h4 data-id="heading-12">启动配置</h4>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0
bin/logstash -f /opt/servers/logstash-7.3.0/config/output_file.conf
</code></pre>
<p>启动的结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c0d5bcc696e47e2a8a723264f1b5561~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=1G3AjtyQvw%2FJSIxoCu%2BkXe09zNg%3D" alt="Logstash 启动配置" loading="lazy"/></p>
<h4 data-id="heading-13">测试数据</h4>
<p>我们在控制台中输入一些测试的内容，然后查看输出的文件的内容：</p>
<pre><code class="hljs language-shell" lang="shell">hello wzk icu!
</code></pre>
<p>查看的结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2f6c9154f824381949316ba04460ce5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=zCOzVVfY62ws8gby6CEHoyO9wqc%3D" alt="Logstash 测试数据" loading="lazy"/></p>
<h4 data-id="heading-14">查看内容：</h4>
<pre><code class="hljs language-shell" lang="shell">cat /opt/servers/es/2024-08-19-h121.wzk.icu.txt
</code></pre>
<p>结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b48e25d6a2c24ef7bcf65fa36a2a20c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=mBb1k9eMR%2F86%2FGseWRRofa3OBPQ%3D" alt="Logstash 查看内容" loading="lazy"/></p>
<h3 data-id="heading-15">采集数据保存到Elasticsearch</h3>
<h4 data-id="heading-16">需求描述</h4>
<p>不过多描述，主要就是把收集到的数据写入到Elasticsearch中。</p>
<h4 data-id="heading-17">编写配置</h4>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0/config
vim output_es.conf
</code></pre>
<p>写入的内容如下：</p>
<pre><code class="hljs language-shell" lang="shell">input {stdin{}}
output {
  elasticsearch {
    hosts =&gt; ["h121.wzk.icu:9200"]
    index =&gt; "logstash-%{+YYYY.MM.dd}"
  }
}
</code></pre>
<p>对应的截图如下所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8c5341a4c1a4e6783a11b548ce18def~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=2L15rvxruHxjJRmfiG5s4ii%2Bz88%3D" alt="Logstash 配置数据到 ES" loading="lazy"/></p>
<p>注意：这个index是保存到Elasticsearch的索引名称，如何命名是非常重要的，因为我们后续可能有某些需求做查询，所以最好带上时间。</p>
<h4 data-id="heading-18">检查配置</h4>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0
bin/logstash -f /opt/servers/logstash-7.3.0/config/output_es.conf -t
</code></pre>
<p>运行的结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdcf04309f874493b5babd84787078bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=afdoBa0cHdQdhlN4W2j1XT500wo%3D" alt="Logstash 检查配置" loading="lazy"/></p>
<h4 data-id="heading-19">启动配置</h4>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0
bin/logstash -f /opt/servers/logstash-7.3.0/config/output_es.conf
</code></pre>
<p>启动结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a537c873520b4989bb1e1149feac6e20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=zto30a32tikftmYr0XoBtg1oqoY%3D" alt="Logstash 启动配置" loading="lazy"/></p>
<h4 data-id="heading-20">测试数据</h4>
<p>向控制台写入 hello wzk icu !
查看ES集群中的数据如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93fea0d214f14982abcc608ed7536080~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766713939&amp;x-signature=bT6ZaWfD7T%2Biz5Z3IbKmGYX%2FZ%2Bs%3D" alt="Logstash 测试数据" loading="lazy"/></p>
<h2 data-id="heading-21">错误速查</h2>


















































<table><thead><tr><th>症状</th><th>根因定位</th><th>修复</th></tr></thead><tbody><tr><td>启动成功但 stdout 没输出</td><td>stdin 无输入/管道未加载目标 conf/多管道覆盖</td><td>bin/logstash -t；启动日志里确认 pipeline 与 conf 路径指定 -f 到正确 conf；用 stdin{} 直接输入验证</td></tr><tr><td>file 输出无文件/文件为空</td><td>目录不存在/权限不足/字段缺失导致路径渲染异常</td><td>看 Logstash 日志报错；确认目标目录与用户权限预创建目录并授权；路径字段改为稳定值（或给 host 默认值）</td></tr><tr><td>ES 连接超时/拒绝连接</td><td>hosts 不通、端口/防火墙、协议/域名解析问题</td><td>curl -sS <a href="https://link.juejin.cn?target=http%3A%2F%2Fhost%3A9200%25EF%25BC%259BLogstash" target="_blank" title="http://host:9200%EF%BC%9BLogstash" ref="nofollow noopener noreferrer">http://host:9200；Logstash</a> 日志里 connection error hosts 写全协议与端口；放通网络；修正 DNS/安全组</td></tr><tr><td>ES 返回 401/403</td><td>开了安全认证但未配 user/pass 或证书</td><td>ES 响应码与响应体；Logstash 输出插件报 auth 配置 user/password 或 API Key；TLS 配置证书</td></tr><tr><td>写入失败：mapper_parsing_exception</td><td>字段类型漂移（string↔number/date）、动态映射冲突</td><td>ES 返回的 bulk item error；查看 index template/mapping 固定 mapping（模板/组件模板）；在 filter 阶段做类型转换与字段清洗</td></tr><tr><td>写入失败：bulk 413/请求过大</td><td>单批次过大/事件体积过大/网关限制</td><td>ES/代理返回 413；Logstash 重试但持续失败 降低批量大小；启用压缩；拆分大字段或截断</td></tr><tr><td>吞吐低、CPU 高、延迟抖动</td><td>flush 过频、批量太小、并发不匹配、下游慢</td><td>观察 pipeline throughput；看 JVM/GC/队列积压 调大批量与并发；合理 flush；必要时启用持久队列/背压策略</td></tr><tr><td>重试后仍丢数据/重复数据</td><td>无持久化队列、下游短暂故障、幂等策略缺失</td><td>看 Logstash persistent queue 是否开启；ES 是否幂等写入 开启 PQ；用稳定 document_id 做幂等；为失败事件加旁路输出</td></tr></tbody></table>
<h2 data-id="heading-22">其他系列</h2>
<h3 data-id="heading-23">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-24">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-196 消息队列选型：RabbitMQ vs RocketMQ vs Kafka</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-25">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring 错误使用事务导致数据可见性问题分析]]></title>    <link>https://juejin.cn/post/7585112748897091627</link>    <guid>https://juejin.cn/post/7585112748897091627</guid>    <pubDate>2025-12-19T03:53:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585112748897091627" data-draft-id="7585091990347382820" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring 错误使用事务导致数据可见性问题分析"/> <meta itemprop="keywords" content="Spring Boot,数据库"/> <meta itemprop="datePublished" content="2025-12-19T03:53:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jaising666"/> <meta itemprop="url" content="https://juejin.cn/user/2418581311850301"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring 错误使用事务导致数据可见性问题分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2418581311850301/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jaising666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T03:53:26.000Z" title="Fri Dec 19 2025 03:53:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>继续，案例同样来自于企业级代码，这里是一个错误使用事务导致的故障。</p>
<p>因为网络隔离，两个服务依赖于同一个数据库做数据传递，一个服务开启事务写入数据并通知另一个服务，另一个服务收到通知后更新数据。故障现象是两个服务和数据库都没有明显异常，但会偶尔发生数据未被更新。</p>
<p>经过排查确认第一个服务事务未被正确使用，如果第二个服务消费数据快于第一个服务事务提交速度就会发生数据更新丢失的问题，下面对问题做了抽象简要回顾。</p>
<hr/>
<h2 data-id="heading-1">1. 问题发生原因：单个事务控制不当导致调用服务更新丢失</h2>
<h3 data-id="heading-2">1.1 问题场景描述</h3>
<p>在典型的业务场景中，需要先创建数据记录，然后调用外部服务进行后续处理。错误的实现将数据库操作和外部服务调用放在同一个事务中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误的实现方式</span>
<span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBusinessRequest</span><span class="hljs-params">(BusinessRequest request, String operator)</span> {
    <span class="hljs-comment">// 1. 在事务中创建数据库记录</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> createBusinessRecord(request, operator);
    
    <span class="hljs-comment">// 2. 在同一事务中调用外部服务</span>
    callExternalService(taskId, request); <span class="hljs-comment">// 问题发生点</span>
}
</code></pre>
<h3 data-id="heading-3">1.2 问题表现</h3>
<ol>
<li><strong>数据可见性问题</strong>：外部服务查询不到刚创建的业务记录</li>
<li><strong>业务逻辑错误</strong>：外部服务基于空数据执行错误的业务逻辑</li>
<li><strong>数据状态不一致</strong>：本地认为数据已创建，外部服务认为数据不存在</li>
<li><strong>性能问题</strong>：长时间持有数据库锁，影响并发性能</li>
</ol>
<hr/>
<h2 data-id="heading-4">2. 问题根本原因：事务传播机制与隔离机制</h2>
<h3 data-id="heading-5">2.1 事务隔离级别机制</h3>
<h4 data-id="heading-6">READ COMMITTED隔离级别（Spring与MySQL默认配置）</h4>
<p><strong>READ COMMITTED规则：</strong></p>
<ul>
<li>只能读取<strong>已提交</strong>的数据</li>
<li>防止脏读，但允许不可重复读</li>
<li>未提交的事务对其他事务不可见</li>
</ul>
<h4 data-id="heading-7">MVCC多版本并发控制</h4>
<pre><code class="hljs language-ini" lang="ini">数据版本链机制：
时间点1: 事务A开始 (<span class="hljs-attr">TxID</span>=<span class="hljs-number">100</span>)
时间点2: INSERT batch_001 -&gt; <span class="hljs-section">[batch_001@100, 未提交]</span> -&gt; <span class="hljs-section">[空表@0, 已提交]</span>
时间点3: 事务B查询 (<span class="hljs-attr">TxID</span>=<span class="hljs-number">101</span>) -&gt; 只能看到已提交版本 -&gt; 返回空表
时间点4: 事务A提交 -&gt; <span class="hljs-section">[batch_001@100, 已提交]</span> -&gt; 所有事务可见
</code></pre>
<h3 data-id="heading-8">2.2 事务传播机制</h3>
<h4 data-id="heading-9">REQUIRED传播行为（默认）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span> <span class="hljs-comment">// 默认 propagation = Propagation.REQUIRED</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethod</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 外层事务开始</span>
    innerMethod(); <span class="hljs-comment">// 加入外层事务，不会创建新事务</span>
    <span class="hljs-comment">// 外层事务结束时才提交</span>
}

<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">innerMethod</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 数据库操作在外层事务中执行</span>
    <span class="hljs-comment">// 此时数据对外部不可见</span>
}
</code></pre>
<h4 data-id="heading-10">问题时序分析</h4>
<pre><code class="hljs language-sql" lang="sql">时间轴    应用A(事务中)              外部服务B                数据库MVCC
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">1</span>   <span class="hljs-keyword">BEGIN</span> TRANSACTION            <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 创建事务A(TxID<span class="hljs-operator">=</span><span class="hljs-number">100</span>)
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">2</span>   <span class="hljs-keyword">INSERT</span> business_task         <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 写入数据(TxID<span class="hljs-operator">=</span><span class="hljs-number">100</span>,未提交)
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 版本链: [task_001<span class="hljs-variable">@100</span>] <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> [空<span class="hljs-variable">@0</span>]
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">3</span>   HTTP调用外部服务 <span class="hljs-comment">-----------&gt; | 查询业务上下文          |</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">4</span>                                 <span class="hljs-operator">|</span> <span class="hljs-keyword">SELECT</span> task_001 <span class="hljs-comment">-----&gt; | 新事务B(TxID=101)</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> READ_committed规则:
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 只能读取已提交数据
  <span class="hljs-number">5</span>                                 <span class="hljs-operator">|</span> <span class="hljs-operator">&lt;</span><span class="hljs-comment">-- 返回空结果 -------- | task_001@100未提交,不可见</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">6</span>                                 <span class="hljs-operator">|</span> 基于空数据执行业务逻辑   <span class="hljs-operator">|</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">7</span>   外部服务完成 <span class="hljs-operator">&lt;</span><span class="hljs-comment">-------------- | 返回处理结果            |</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">8</span>   <span class="hljs-keyword">COMMIT</span> <span class="hljs-comment">-----------------&gt; |                       | 提交事务A</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">9</span>   业务状态不一致！              <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 数据现在可见，但外部服务
      本地：任务已创建              <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 已基于"无数据"执行完毕
      外部：基于空数据处理          <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
</code></pre>
<h3 data-id="heading-11">2.3 技术验证</h3>
<p>可以通过SQL直接验证隔离机制：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 会话1：模拟应用事务</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> business_task (task_id, status) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'task_001'</span>, <span class="hljs-string">'PENDING'</span>);
<span class="hljs-comment">-- 不提交事务</span>

<span class="hljs-comment">-- 会话2：模拟外部服务查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> business_task <span class="hljs-keyword">WHERE</span> task_id <span class="hljs-operator">=</span> <span class="hljs-string">'task_001'</span>;
<span class="hljs-comment">-- 结果：Empty set (READ COMMITTED隔离机制)</span>

<span class="hljs-comment">-- 会话1：提交事务</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 会话2：再次查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> business_task <span class="hljs-keyword">WHERE</span> task_id <span class="hljs-operator">=</span> <span class="hljs-string">'task_001'</span>;
<span class="hljs-comment">-- 结果：现在能查询到数据了</span>
</code></pre>
<hr/>
<h2 data-id="heading-12">3. 修复方法：使用Self注入完成事务代理</h2>
<h3 data-id="heading-13">3.1 基于代理的事务原理</h3>
<h4 data-id="heading-14">Spring AOP事务代理机制</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Spring为Service类创建的代理对象</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessServiceImpl$$SpringProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BusinessService</span> {
    
    <span class="hljs-keyword">private</span> BusinessServiceImpl target; <span class="hljs-comment">// 真实对象</span>
    <span class="hljs-keyword">private</span> TransactionInterceptor transactionInterceptor; <span class="hljs-comment">// 事务拦截器</span>
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createDistributionRecordsInTransaction</span><span class="hljs-params">(ScriptDeployDTO deployDTO, String operator)</span> {
        <span class="hljs-comment">// 1. 事务拦截器开始事务</span>
        <span class="hljs-type">TransactionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> transactionManager.getTransaction(transactionDefinition);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 调用真实对象的方法</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> target.createDistributionRecordsInTransaction(deployDTO, operator);
            
            <span class="hljs-comment">// 3. 提交事务</span>
            transactionManager.commit(status);
            <span class="hljs-keyword">return</span> result;
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 4. 回滚事务</span>
            transactionManager.rollback(status);
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<h4 data-id="heading-15">内部方法调用的问题</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessServiceImpl</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deployScript</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// ❌ 直接调用内部方法，绕过了代理对象</span>
        createRecords(); <span class="hljs-comment">// 事务注解不生效！</span>
    }
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createRecords</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 事务不会开启，因为没有通过代理调用</span>
    }
}
</code></pre>
<h3 data-id="heading-16">3.2 Self注入解决方案</h3>
<h4 data-id="heading-17">正确的实现方式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BusinessService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> BusinessServiceImpl self; <span class="hljs-comment">// 注入代理对象</span>
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBusinessRequest</span><span class="hljs-params">(BusinessRequest request, String operator)</span> {
        <span class="hljs-comment">// 1. 通过代理对象调用，确保事务生效</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> self.createBusinessRecordInTransaction(request, operator);
        <span class="hljs-comment">// 第一个事务在这里提交，数据立即可见</span>
        
        <span class="hljs-comment">// 2. 事务提交后调用外部服务</span>
        callExternalService(taskId, request);
    }
    
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createBusinessRecordInTransaction</span><span class="hljs-params">(BusinessRequest request, String operator)</span> {
        <span class="hljs-keyword">return</span> createBusinessRecord(request, operator);
    } <span class="hljs-comment">// 事务在此处提交</span>
}
</code></pre>
<h4 data-id="heading-18">Self注入的技术原理</h4>
<ol>
<li>
<p><strong>Spring容器管理</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Spring容器中的Bean定义</span>
<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> BusinessServiceImpl <span class="hljs-title function_">BusinessService</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> Proxy.newProxyInstance(
        classLoader,
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{BusinessService.class},
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionInvocationHandler</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessServiceImpl</span>())
    );
}
</code></pre>
</li>
<li>
<p><strong>代理对象注入</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> BusinessServiceImpl self; 
<span class="hljs-comment">// 注入的是代理对象，包含事务拦截逻辑</span>
</code></pre>
</li>
<li>
<p><strong>事务拦截流程</strong>：</p>
<pre><code class="hljs language-java" lang="java">self.createDistributionRecordsInTransaction() 
-&gt; TransactionInterceptor.invoke()
-&gt; PlatformTransactionManager.getTransaction()
-&gt; 目标方法执行
-&gt; PlatformTransactionManager.commit()
</code></pre>
</li>
</ol>
<h3 data-id="heading-19">3.3 修复后的完整时序</h3>
<pre><code class="hljs language-sql" lang="sql">时间轴    应用A                     外部服务B                数据库MVCC
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">1</span>   调用self.createRecords()     <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">2</span>   <span class="hljs-keyword">BEGIN</span> TRANSACTION            <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 创建事务A(TxID<span class="hljs-operator">=</span><span class="hljs-number">100</span>)
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">3</span>   <span class="hljs-keyword">INSERT</span> distribution_result   <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 写入数据(TxID<span class="hljs-operator">=</span><span class="hljs-number">100</span>)
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">4</span>   <span class="hljs-keyword">COMMIT</span> <span class="hljs-comment">-----------------&gt; |                       | 提交事务A</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 数据对所有事务可见
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">5</span>   HTTP调用外部服务 <span class="hljs-comment">-----------&gt; | 立即回调查询            |</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">6</span>                                 <span class="hljs-operator">|</span> <span class="hljs-keyword">SELECT</span> batch_001 <span class="hljs-comment">----&gt; | 新事务B(TxID=101)</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span> 能读取已提交数据
  <span class="hljs-number">7</span>                                 <span class="hljs-operator">|</span> <span class="hljs-operator">&lt;</span><span class="hljs-comment">-- 返回数据 --------- | 返回batch_001记录</span>
  <span class="hljs-operator">|</span>                                 <span class="hljs-operator">|</span>                       <span class="hljs-operator">|</span>
  <span class="hljs-number">8</span>   外部服务成功 <span class="hljs-operator">&lt;</span><span class="hljs-comment">-------------- |                       |</span>
</code></pre>
<hr/>
<h2 data-id="heading-20">4. 事务常见使用错误与最佳实践</h2>
<h3 data-id="heading-21">4.1 常见错误模式</h3>
<h4 data-id="heading-22">错误1：内部方法调用事务失效</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误示例</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerUser</span><span class="hljs-params">(User user)</span> {
        validateUser(user);
        saveUser(user); <span class="hljs-comment">// 事务不生效</span>
        sendEmail(user);
    }
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(User user)</span> {
        userMapper.insert(user);
    }
}

<span class="hljs-comment">// ✅ 正确示例</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService self;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerUser</span><span class="hljs-params">(User user)</span> {
        validateUser(user);
        self.saveUser(user); <span class="hljs-comment">// 通过代理调用，事务生效</span>
        sendEmail(user);
    }
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(User user)</span> {
        userMapper.insert(user);
    }
}
</code></pre>
<h4 data-id="heading-23">错误2：长事务包含外部调用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误示例</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(Order order)</span> {
    <span class="hljs-comment">// 数据库操作</span>
    orderMapper.insert(order);
    
    <span class="hljs-comment">// 外部服务调用（可能很慢）</span>
    paymentService.processPayment(order); <span class="hljs-comment">// 持有数据库锁</span>
    
    <span class="hljs-comment">// 更多数据库操作</span>
    orderMapper.updateStatus(order.getId(), <span class="hljs-string">"PAID"</span>);
}

<span class="hljs-comment">// ✅ 正确示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(Order order)</span> {
    <span class="hljs-comment">// 第一个事务：创建订单</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> self.createOrderInTransaction(order);
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 外部服务调用（无事务）</span>
        <span class="hljs-type">PaymentResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> paymentService.processPayment(order);
        
        <span class="hljs-comment">// 第二个事务：更新状态</span>
        self.updateOrderStatusInTransaction(orderId, <span class="hljs-string">"PAID"</span>);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-comment">// 第三个事务：处理失败</span>
        self.updateOrderStatusInTransaction(orderId, <span class="hljs-string">"FAILED"</span>);
        <span class="hljs-keyword">throw</span> e;
    }
}
</code></pre>
<h4 data-id="heading-24">错误3：异常处理不当导致事务不回滚</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误示例</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processData</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-keyword">for</span> (Data data : dataList) {
        <span class="hljs-keyword">try</span> {
            processItem(data);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"处理失败"</span>, e);
            <span class="hljs-comment">// 异常被吞掉，事务不会回滚</span>
        }
    }
}

<span class="hljs-comment">// ✅ 正确示例</span>
<span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processData</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-keyword">for</span> (Data data : dataList) {
        <span class="hljs-keyword">try</span> {
            processItem(data);
        } <span class="hljs-keyword">catch</span> (BusinessException e) {
            log.error(<span class="hljs-string">"业务异常: {}"</span>, e.getMessage());
            <span class="hljs-keyword">throw</span> e; <span class="hljs-comment">// 重新抛出，触发回滚</span>
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"系统异常"</span>, e);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemException</span>(<span class="hljs-string">"处理失败"</span>, e);
        }
    }
}
</code></pre>
<h4 data-id="heading-25">错误4：事务传播行为使用不当</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误示例：审计日志应该独立事务</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">businessOperation</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 主业务逻辑</span>
    performBusinessLogic();
    
    <span class="hljs-comment">// 审计日志（如果主业务失败，审计日志也会回滚）</span>
    auditService.recordOperation(); <span class="hljs-comment">// 使用默认REQUIRED传播</span>
}

<span class="hljs-comment">// ✅ 正确示例：使用REQUIRES_NEW</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuditService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordOperation</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 独立事务，即使主业务失败也会提交</span>
        auditMapper.insert(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AuditLog</span>());
    }
}

<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">businessOperation</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">try</span> {
        performBusinessLogic();
        auditService.recordOperation(); <span class="hljs-comment">// 记录成功日志</span>
    } <span class="hljs-keyword">catch</span> (Exception e) {
        auditService.recordOperation(); <span class="hljs-comment">// 记录失败日志</span>
        <span class="hljs-keyword">throw</span> e;
    }
}
</code></pre>
<h3 data-id="heading-26">4.2 最佳实践总结</h3>
<h4 data-id="heading-27">1. 事务边界设计原则</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 推荐模式：短事务 + 状态管理</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">complexBusinessOperation</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 短事务创建初始状态</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> self.createTaskInTransaction(PENDING);
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 2. 无事务的外部操作</span>
        <span class="hljs-type">ExternalResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> externalService.process(taskId);
        
        <span class="hljs-comment">// 3. 短事务更新最终状态</span>
        self.updateTaskStatusInTransaction(taskId, SUCCESS, result);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-comment">// 4. 短事务记录失败状态</span>
        self.updateTaskStatusInTransaction(taskId, FAILED, e.getMessage());
        <span class="hljs-keyword">throw</span> e;
    }
}
</code></pre>
<h4 data-id="heading-28">2. 事务注解配置规范</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 完整的事务配置</span>
<span class="hljs-meta">@Transactional(
    rollbackFor = Exception.class,           // 所有异常都回滚
    timeout = 30,                           // 30秒超时
    isolation = Isolation.READ_COMMITTED,   // 明确指定隔离级别
    propagation = Propagation.REQUIRED      // 明确指定传播行为
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">businessMethod</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 业务逻辑</span>
}
</code></pre>
<h4 data-id="heading-29">3. 异常处理规范</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 分层异常处理</span>
<span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">businessMethod</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">try</span> {
        riskyOperation();
    } <span class="hljs-keyword">catch</span> (BusinessException e) {
        <span class="hljs-comment">// 业务异常：记录并重新抛出</span>
        log.warn(<span class="hljs-string">"业务异常: {}"</span>, e.getMessage());
        <span class="hljs-keyword">throw</span> e;
    } <span class="hljs-keyword">catch</span> (SystemException e) {
        <span class="hljs-comment">// 系统异常：记录并重新抛出</span>
        log.error(<span class="hljs-string">"系统异常"</span>, e);
        <span class="hljs-keyword">throw</span> e;
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-comment">// 未知异常：包装后抛出</span>
        log.error(<span class="hljs-string">"未知异常"</span>, e);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemException</span>(<span class="hljs-string">"操作失败"</span>, e);
    }
}
</code></pre>
<h4 data-id="heading-30">4. 性能优化建议</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 批量操作优化</span>
<span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchProcess</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-comment">// 分批处理，避免长事务</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">batchSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; dataList.size(); i += batchSize) {
        List&lt;Data&gt; batch = dataList.subList(i, Math.min(i + batchSize, dataList.size()));
        processBatch(batch);
    }
}

<span class="hljs-comment">// ✅ 只读事务优化</span>
<span class="hljs-meta">@Transactional(readOnly = true)</span>
<span class="hljs-keyword">public</span> List&lt;Data&gt; <span class="hljs-title function_">queryData</span><span class="hljs-params">(QueryCondition condition)</span> {
    <span class="hljs-comment">// 只读事务，数据库可以进行优化</span>
    <span class="hljs-keyword">return</span> dataMapper.selectByCondition(condition);
}
</code></pre>
<h4 data-id="heading-31">5. 监控和调试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 事务状态监控</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionMonitorService</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkTransactionStatus</span><span class="hljs-params">()</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isActive</span> <span class="hljs-operator">=</span> TransactionSynchronizationManager.isActualTransactionActive();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isReadOnly</span> <span class="hljs-operator">=</span> TransactionSynchronizationManager.isCurrentTransactionReadOnly();
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> TransactionSynchronizationManager.getCurrentTransactionName();
        
        log.info(<span class="hljs-string">"事务状态: active={}, readOnly={}, name={}"</span>, isActive, isReadOnly, name);
    }
}

<span class="hljs-comment">// ✅ 事务日志配置</span>
# logback-spring.xml
&lt;logger name=<span class="hljs-string">"org.springframework.transaction"</span> level=<span class="hljs-string">"DEBUG"</span>/&gt;
&lt;logger name=<span class="hljs-string">"org.springframework.orm.jpa"</span> level=<span class="hljs-string">"DEBUG"</span>/&gt;
</code></pre>
<hr/>
<h2 data-id="heading-32">5. 总结</h2>
<h3 data-id="heading-33">5.1 核心要点</h3>
<ol>
<li><strong>事务隔离是竞态条件的根本原因</strong>：READ COMMITTED隔离级别导致未提交数据不可见</li>
<li><strong>代理机制是事务生效的前提</strong>：内部方法调用必须通过代理对象</li>
<li><strong>事务边界设计至关重要</strong>：数据库操作与外部调用应该分离</li>
<li><strong>状态管理保证最终一致性</strong>：通过状态字段和补偿机制处理异常情况</li>
</ol>
<h3 data-id="heading-34">5.2 实施建议</h3>
<ol>
<li><strong>立即修复</strong>：使用self注入解决内部方法调用问题</li>
<li><strong>重构长事务</strong>：将外部调用从事务中分离出来</li>
<li><strong>完善监控</strong>：添加事务状态监控和性能指标</li>
</ol>
<h3 data-id="heading-35">5.3 预期效果</h3>
<ul>
<li><strong>消除竞态条件</strong>：外部服务能正常查询到已提交数据</li>
<li><strong>提升并发性能</strong>：缩短事务持有锁的时间</li>
<li><strong>增强系统稳定性</strong>：减少因外部服务故障导致的事务回滚</li>
<li><strong>改善可维护性</strong>：清晰的事务边界和错误处理机制</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【深度解析】Seata 分布式事务：核心作用、原理与实战配置指南]]></title>    <link>https://juejin.cn/post/7585406229150826534</link>    <guid>https://juejin.cn/post/7585406229150826534</guid>    <pubDate>2025-12-19T06:37:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585406229150826534" data-draft-id="7585085798810140699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【深度解析】Seata 分布式事务：核心作用、原理与实战配置指南"/> <meta itemprop="keywords" content="Spring Cloud,微服务"/> <meta itemprop="datePublished" content="2025-12-19T06:37:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="元Y亨H"/> <meta itemprop="url" content="https://juejin.cn/user/2839351584888617"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【深度解析】Seata 分布式事务：核心作用、原理与实战配置指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2839351584888617/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    元Y亨H
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T06:37:00.000Z" title="Fri Dec 19 2025 06:37:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0">【深度解析】Seata 分布式事务：核心作用、原理与实战配置指南</h2>
<p>在微服务架构（如 RuoYi-Cloud-Plus）中，我们将一个庞大的单体应用拆分成了多个独立的服务（如订单服务、库存服务、账户服务）。这种拆分虽然提升了开发效率和系统扩展性，但也带来了一个棘手的问题：<strong>数据一致性</strong>。</p>
<p>本文将深入浅出地讲解 Seata 的作用，并以 <code>ruoyi-order</code> 服务为例，提供标准的接入配置指南。</p>
<hr/>
<h3 data-id="heading-1">第一部分：Seata 是什么？有什么用？</h3>
<h4 data-id="heading-2">1. 为什么我们需要 Seata？</h4>
<p>在传统的<strong>单体应用</strong>中，所有的业务表都在同一个数据库里。我们只需要使用 Spring 的 <code>@Transactional</code> 注解，数据库本身就能保证“<strong>要么全成功，要么全失败</strong>”。</p>
<p>但在<strong>微服务架构</strong>中，业务被拆分了：</p>
<ul>
<li><strong>订单服务</strong>（连 订单库）</li>
<li><strong>库存服务</strong>（连 库存库）</li>
</ul>
<p><strong>场景模拟：用户下单</strong></p>
<ol>
<li>用户请求 <strong>订单服务</strong> -&gt; 创建订单（Insert Order 成功）。</li>
<li>订单服务 远程调用 <strong>库存服务</strong> -&gt; 扣减库存（Update Stock 失败，抛出异常）。</li>
</ol>
<p><strong>如果没有 Seata：</strong>
库存服务虽然报错回滚了，但订单服务刚才已经提交了事务。结果就是：<strong>订单创建了，但库存没扣</strong>。商家亏钱，数据错乱。</p>
<h4 data-id="heading-3">2. Seata 的作用：微服务的“大管家”</h4>
<p>Seata (Simple Extensible Autonomous Transaction Architecture) 是阿里巴巴开源的分布式事务解决方案。</p>
<p><strong>它的核心作用是：</strong>
将跨越多个服务、多个数据库的操作，看作一个<strong>全局的大事务</strong>。</p>
<ul>
<li><strong>一荣俱荣：</strong> 所有服务都执行成功，才最终提交。</li>
<li><strong>一损俱损：</strong> 只要有一个服务失败，Seata 会指挥其他所有服务<strong>自动回滚</strong>，就像什么都没发生过一样。</li>
</ul>
<h4 data-id="heading-4">3. <code>undo_log</code> 表是干嘛的？（核心原理）</h4>
<p>在部署 Seata 时，我们必须在每个业务数据库里导入一张 <code>undo_log</code> 表。这是 Seata <strong>AT 模式</strong>（最常用模式）的魔法所在。</p>
<p><strong>“时光倒流”机制：</strong></p>
<ol>
<li><strong>一阶段：</strong> 当你的业务代码执行 <code>UPDATE</code> 时，Seata 会拦截 SQL，先查询更新前的数据（镜像），保存到 <code>undo_log</code> 表中，然后再提交业务数据。</li>
<li><strong>二阶段（如果出错）：</strong> 如果其他服务报错了，Seata 会读取 <code>undo_log</code> 里的记录，生成反向 SQL，把数据<strong>恢复</strong>成原来的样子。</li>
</ol>
<hr/>
<h3 data-id="heading-5">第二部分：实战配置指南</h3>
<p>理解了 Seata 的作用，我们来看看当新增一个微服务（例如 <strong><code>ruoyi-order</code></strong>）时，如何正确配置它。</p>
<h4 data-id="heading-6">1. 现象描述</h4>
<p>启动新服务 <code>ruoyi-order</code> 时，控制台抛出如下异常：</p>
<pre><code class="hljs language-text" lang="text">io.seata.config.exception.ConfigNotFoundException: service.vgroupMapping.ruoyi-order-group configuration item is required
...
</code></pre>
<p><strong>原因：</strong> Seata 客户端生成了事务分组名 <code>ruoyi-order-group</code>，但在 Seata 服务端（注册中心）找不到该分组对应的集群。</p>
<h4 data-id="heading-7">2. Seata 的三层映射机制</h4>
<p>Seata 使用“三层映射”来实现逻辑隔离与高可用：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[微服务应用] --&gt;|配置: tx-service-group| B(事务分组名 Transaction Service Group)
    B --&gt;|Nacos配置: vgroupMapping| C(Seata 集群名 Cluster Name)
    C --&gt;|服务发现| D[Seata Server 集群]
</code></pre>
<h4 data-id="heading-8">3. 标准配置步骤</h4>
<p><strong>不建议</strong>在本地强行修改为 <code>default_tx_group</code>，应遵循 <strong>“自动生成 + Nacos 注册”</strong> 的标准流程。</p>
<h5 data-id="heading-9">步骤一：客户端配置（通常已自动继承）</h5>
<p>在 <code>ruoyi-order</code> 服务中，确保继承了框架的通用配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">ruoyi-order</span>

<span class="hljs-attr">seata:</span>
  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-comment"># 【自动生成】结果为：ruoyi-order-group</span>
  <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">${spring.application.name}-group</span>
</code></pre>
<h5 data-id="heading-10">步骤二：服务端添加映射（Nacos 操作）</h5>
<p>我们需要告诉 Seata：<strong>“<code>ruoyi-order-group</code> 是合法的，请由 <code>default</code> 集群处理。”</strong></p>
<ol>
<li><strong>登录 Nacos 控制台</strong>。</li>
<li>进入 <strong>配置管理 -&gt; 配置列表</strong>。</li>
<li>找到 Seata Server 读取的配置文件（通常名为 <strong><code>seata-server.properties</code></strong>）。</li>
<li><strong>编辑配置</strong>，追加以下内容：</li>
</ol>
<pre><code class="hljs language-properties" lang="properties"># ===================================================
# Seata 事务分组映射表
# 语法：service.vgroupMapping.{事务分组名}={Seata集群名}
# ===================================================

# 系统原有的
service.vgroupMapping.default_tx_group=default
service.vgroupMapping.ruoyi-system-group=default

# ★★★ 新增：为 ruoyi-order 服务添加映射 ★★★
# 左边：ruoyi-order-group (服务名 + "-group")
# 右边：default (Seata Server 的集群名称)
service.vgroupMapping.ruoyi-order-group=default
</code></pre>
<ol start="5">
<li>点击 <strong>发布</strong>。</li>
</ol>
<h5 data-id="heading-11">步骤三：验证</h5>
<p>重启 <code>ruoyi-order</code> 服务。观察日志，报错应消失，且出现 <code>Transaction Manager Client ... init success</code> 字样。</p>
<hr/>
<h3 data-id="heading-12">4. 总结</h3>
<ol>
<li><strong>Seata 的价值：</strong> 它是微服务数据一致性的守护者，保证跨库操作“要么全成，要么全败”。</li>
<li><strong>undo_log 的作用：</strong> 它是“后悔药”，记录了数据修改前的样子，用于出错时自动回滚。</li>
<li><strong>配置原则：</strong> 新增服务时，<strong>不要</strong>改代码里的分组名，而要<strong>去 Nacos 注册</strong>这个分组名。</li>
</ol>
<p>通过本文的配置，您的 <code>ruoyi-order</code> 服务已成功接入分布式事务保护网，可以放心地进行跨服务调用了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[爬楼梯？不，你在攀登算法的珠穆朗玛峰！]]></title>    <link>https://juejin.cn/post/7585466235660861492</link>    <guid>https://juejin.cn/post/7585466235660861492</guid>    <pubDate>2025-12-20T03:19:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585466235660861492" data-draft-id="7585458459165720610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 爬楼梯？不，你在攀登算法的珠穆朗玛峰！"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-20T03:19:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wwwwW"/> <meta itemprop="url" content="https://juejin.cn/user/631558156323657"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             爬楼梯？不，你在攀登算法的珠穆朗玛峰！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/631558156323657/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wwwwW
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T03:19:05.000Z" title="Sat Dec 20 2025 03:19:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">爬楼梯？不，你在攀登算法的珠穆朗玛峰！</h2>
<blockquote>
<p>一道看似“幼儿园难度”的面试题：<br/>
<strong>“每次能爬1阶或2阶，问爬到第n阶有几种方法？”</strong><br/>
却暗藏递归、动态规划、记忆化、空间优化四大内功心法——<br/>
它不是考你会不会算数，而是看你有没有<strong>系统性思维</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">🧗‍♂️ 初见：天真递归 —— “我能行！”（然后爆栈了）</h3>
<p>最直觉的解法？当然是递归！</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">climbStairs</span>(n) {
  if (n === <span class="hljs-number">1</span>) return <span class="hljs-number">1</span>;
  if (n === <span class="hljs-number">2</span>) return <span class="hljs-number">2</span>;
  return <span class="hljs-built_in">climbStairs</span>(n - <span class="hljs-number">1</span>) + <span class="hljs-built_in">climbStairs</span>(n - <span class="hljs-number">2</span>);
}
</code></pre>
<p><strong>逻辑完美</strong>：</p>
<ul>
<li>要到第 <code>n</code> 阶，要么从 <code>n-1</code> 上来，要么从 <code>n-2</code> 跳上来</li>
<li>所以 <code>f(n) = f(n-1) + f(n-2)</code> —— 这不就是斐波那契？</li>
</ul>
<p>但问题来了：<br/>
当你调用 <code>climbStairs(45)</code>，电脑会疯狂重复计算：</p>
<ul>
<li><code>f(43)</code> 被算两次</li>
<li><code>f(42)</code> 被算三次</li>
<li>……<br/>
<strong>时间复杂度 O(2ⁿ)</strong> —— 指数爆炸！</li>
</ul>
<blockquote>
<p>就像你让一个人背完整本字典来查一个词——可行，但荒谬。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">🧠 进阶：记忆化递归 —— “我记住了！”</h3>
<p>既然重复计算是罪魁祸首，那就<strong>把算过的答案存起来</strong>！</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">memo</span> = {}<span class="hljs-comment">;</span>
function climbStairs(n) {
  if (<span class="hljs-attr">n</span> === <span class="hljs-number">1</span>) return <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  if (<span class="hljs-attr">n</span> === <span class="hljs-number">2</span>) return <span class="hljs-number">2</span><span class="hljs-comment">;</span>
  if (memo<span class="hljs-section">[n]</span>) return memo<span class="hljs-section">[n]</span><span class="hljs-comment">; // ← 关键：查缓存！</span>
  memo<span class="hljs-section">[n]</span> = climbStairs(n - 1) + climbStairs(n - 2)<span class="hljs-comment">;</span>
  return memo<span class="hljs-section">[n]</span><span class="hljs-comment">;</span>
}
</code></pre>
<p>✅ <strong>效果</strong>：每个 <code>f(k)</code> 只算一次 → 时间复杂度 <strong>O(n)</strong><br/>
✅ <strong>思想</strong>：<strong>空间换时间</strong>，典型的<strong>自顶向下动态规划（Top-down DP）</strong></p>
<p>但有个小瑕疵：<code>memo</code> 是全局变量，容易被污染。</p>
<hr/>
<h3 data-id="heading-3">🔒 优雅封装：闭包 + 记忆化 —— “我的缓存，外人别碰！”</h3>
<p>用<strong>闭包</strong>把 <code>memo</code> 私有化，打造一个“智能函数”：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">climbStairs</span> = (function() {
  const <span class="hljs-attr">memo</span> = {}<span class="hljs-comment">; // ← 外部无法访问！</span>
  return function climb(n) {
    if (<span class="hljs-attr">n</span> === <span class="hljs-number">1</span>) return <span class="hljs-number">1</span><span class="hljs-comment">;</span>
    if (<span class="hljs-attr">n</span> === <span class="hljs-number">2</span>) return <span class="hljs-number">2</span><span class="hljs-comment">;</span>
    if (memo<span class="hljs-section">[n]</span>) return memo<span class="hljs-section">[n]</span><span class="hljs-comment">;</span>
    memo<span class="hljs-section">[n]</span> = climb(n - 1) + climb(n - 2)<span class="hljs-comment">;</span>
    return memo<span class="hljs-section">[n]</span><span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
})()<span class="hljs-comment">;</span>
</code></pre>
<p>✨ <strong>优势</strong>：</p>
<ul>
<li>多次调用共享缓存（越用越快）</li>
<li>状态私有，安全可靠</li>
<li>接口干净：用户只需 <code>climbStairs(n)</code></li>
</ul>
<blockquote>
<p>这不是函数，这是一个<strong>会学习、有记忆、懂封装的智能体</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">🚀 终极优化：自底向上 + 滚动变量 —— “我不需要递归！”</h3>
<p>其实，我们根本不需要递归，也不需要存所有中间值！</p>
<p>观察规律：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">f</span>(<span class="hljs-number">1</span>) = <span class="hljs-number">1</span>
<span class="hljs-built_in">f</span>(<span class="hljs-number">2</span>) = <span class="hljs-number">2</span>
<span class="hljs-built_in">f</span>(<span class="hljs-number">3</span>) = <span class="hljs-built_in">f</span>(<span class="hljs-number">2</span>) + <span class="hljs-built_in">f</span>(<span class="hljs-number">1</span>) = <span class="hljs-number">3</span>
<span class="hljs-built_in">f</span>(<span class="hljs-number">4</span>) = <span class="hljs-built_in">f</span>(<span class="hljs-number">3</span>) + <span class="hljs-built_in">f</span>(<span class="hljs-number">2</span>) = <span class="hljs-number">5</span>
...
</code></pre>
<p>只需要<strong>两个变量</strong>，就能滚动计算出结果：</p>
<pre><code class="hljs language-ini" lang="ini">function climbStairs(n) {
  if (<span class="hljs-attr">n</span> === <span class="hljs-number">1</span>) return <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  if (<span class="hljs-attr">n</span> === <span class="hljs-number">2</span>) return <span class="hljs-number">2</span><span class="hljs-comment">;</span>
  
  let <span class="hljs-attr">prevPrev</span> = <span class="hljs-number">1</span><span class="hljs-comment">; // f(i-2)</span>
  let <span class="hljs-attr">prev</span> = <span class="hljs-number">2</span><span class="hljs-comment">;     // f(i-1)</span>
  
  for (let <span class="hljs-attr">i</span> = <span class="hljs-number">3</span><span class="hljs-comment">; i &lt;= n; i++) {</span>
    const <span class="hljs-attr">current</span> = prev + prevPrev<span class="hljs-comment">; // f(i)</span>
    <span class="hljs-attr">prevPrev</span> = prev<span class="hljs-comment">;   // 滚动窗口</span>
    <span class="hljs-attr">prev</span> = current<span class="hljs-comment">;</span>
  }
  
  return prev<span class="hljs-comment">;</span>
}
</code></pre>
<p>✅ <strong>时间复杂度</strong>：O(n)<br/>
✅ <strong>空间复杂度</strong>：O(1) —— <strong>极致优化！</strong><br/>
✅ <strong>无递归</strong>：避免调用栈溢出（n 很大时更安全）</p>
<blockquote>
<p>这就是<strong>自底向上的动态规划（Bottom-up DP）</strong> —— 从已知出发，一步步推导未知。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">📊 四种解法对比</h3>








































<table><thead><tr><th>方法</th><th>时间复杂度</th><th>空间复杂度</th><th>是否递归</th><th>适用场景</th></tr></thead><tbody><tr><td>暴力递归</td><td>O(2ⁿ)</td><td>O(n)</td><td>✅</td><td>教学演示</td></tr><tr><td>记忆化递归</td><td>O(n)</td><td>O(n)</td><td>✅</td><td>中等规模，逻辑清晰</td></tr><tr><td>闭包记忆化</td><td>O(n)</td><td>O(n)</td><td>✅</td><td>需要缓存复用</td></tr><tr><td><strong>滚动变量</strong></td><td><strong>O(n)</strong></td><td><strong>O(1)</strong></td><td>❌</td><td><strong>生产环境首选</strong></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-6">💡 面试加分回答</h3>
<p>当面试官问这道题，你可以这样说：</p>
<blockquote>
<p>“我会根据场景选择方案：</p>
<ul>
<li>如果是教学或快速原型，用记忆化递归，逻辑直观；</li>
<li>如果是高性能生产环境，用滚动变量的迭代法，O(1) 空间且无栈溢出风险。<br/>
此外，我还会考虑边界情况（如 n ≤ 0）、类型校验，以及是否需要支持‘每次可爬1~k阶’的扩展。”</li>
</ul>
</blockquote>
<p>——瞬间从“会写代码”升级到“有工程思维”。</p>
<hr/>
<h3 data-id="heading-7">🌟 结语：小题大智慧</h3>
<p>“爬楼梯”从来不是一道数学题，而是一面镜子：</p>
<ul>
<li>它照出你是否理解<strong>递归的本质</strong></li>
<li>它检验你是否掌握<strong>动态规划的思想</strong></li>
<li>它考验你能否在<strong>简洁、性能、可维护性</strong>之间做权衡</li>
</ul>
<p>下次再有人说“这题太简单”，你可以微笑回应：</p>
<blockquote>
<p>“是啊，简单到能写出四种境界。”</p>
</blockquote>
<p>而这，正是优秀工程师和普通 coder 的分水岭。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[都快2026了，还有人不会国际化和暗黑主题适配吗，一篇文章彻底解决]]></title>    <link>https://juejin.cn/post/7585452404112752655</link>    <guid>https://juejin.cn/post/7585452404112752655</guid>    <pubDate>2025-12-20T03:50:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585452404112752655" data-draft-id="7585406030021951523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="都快2026了，还有人不会国际化和暗黑主题适配吗，一篇文章彻底解决"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-20T03:50:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zsnoin能"/> <meta itemprop="url" content="https://juejin.cn/user/2142280667371624"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            都快2026了，还有人不会国际化和暗黑主题适配吗，一篇文章彻底解决
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2142280667371624/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zsnoin能
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T03:50:41.000Z" title="Sat Dec 20 2025 03:50:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">国际化和暗黑主题适配</h2>
<p>前端实现国际化和暗黑主题适配已成为现代产品的核心刚需：国际化能够突破语言、地区和文化壁垒，让产品适配全球不同用户的语言习惯、格式规范（日期/货币/地址）及合规要求，覆盖多语言网站、跨境电商、企业级SaaS等场景，是拓展用户群体、提升全球市场竞争力的基础；而暗黑主题适配不仅能在低光环境下保护用户视力、为OLED设备降低功耗，还能适配不同用户的视觉偏好与特殊人群的无障碍需求，同时契合科技、游戏等行业的产品调性，提升用户体验与使用舒适度；二者结合既满足了产品全球化的适配能力，又兼顾了用户个性化的体验诉求，是提升产品包容性、用户留存率和市场适配性的关键设计与开发策略。</p>
<h3 data-id="heading-1">1、国际化</h3>
<p>国际化（<strong>i18n</strong>）是指让软件、网站或应用能够适配不同语言、地区和文化习惯的设计与开发过程，其核心目标是<strong>无需大规模修改代码</strong>，就能支持多语言、多地区的本地化部署
<strong>使用插件 i18n</strong></p>
<h4 data-id="heading-2">1.1 定义存储当前语言的方法</h4>
<p>src\utils\cookies.ts</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Cookies</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'js-cookie'</span>

<span class="hljs-keyword">const</span> languageKey = <span class="hljs-string">'dd_language'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getLanguage</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">get</span>(languageKey)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">setLanguage</span> = (<span class="hljs-params">language:string</span>) =&gt; <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">set</span>(languageKey, language)
</code></pre>
<h4 data-id="heading-3">1.2 准备翻译文件</h4>
<p>有的组件国际化语言较少，可能自行添加，比如vxe-table版本不是最新的，没有越南和俄罗斯翻译，需手动添加。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b484fb33e0244ed48968a41b6b3d4d12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNub2lu6IO9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766807441&amp;x-signature=wR7fwRzYyE%2BSNmJOaPbq0qe3CRU%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">1.3 翻译文件</h4>
<h5 data-id="heading-5">1.3.1 主文件内容</h5>
<ul>
<li>src\lang\index.ts</li>
<li>注释已经很详细了，就是对翻译文件进行合并，然后根据当前选中的语言进行应用</li>
<li><strong>重点介绍一下远程翻译，很多时候翻译的不是很准确，客户可能需要能自行进行翻译，我们可以在这里定义一个 <code>loadRemoteMessages</code> 方法，用于加载远程翻译，后端返回给你远程自定义的翻译，然后通过扩展运算符进行合并，后面的数据会覆盖前面，从而实现替换，非常简单吧，根本没啥难度。</strong></li>
<li><code>document.title</code> 能直接修改网页标题，可以通过这个设置网页标题多语言。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createI18n } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-i18n'</span>;
<span class="hljs-keyword">import</span> { getLanguage } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/cookies'</span>;
<span class="hljs-comment">// import { fetchRemoteTranslations } from '../api/translation' // 引入远程接口</span>

<span class="hljs-comment">// vxe-table 组件翻译（保留本地，不被远程覆盖）</span>
<span class="hljs-keyword">import</span> vxe_zhCN <span class="hljs-keyword">from</span> <span class="hljs-string">'vxe-table/lib/locale/lang/zh-CN'</span>;
<span class="hljs-keyword">import</span> vxe_enUS <span class="hljs-keyword">from</span> <span class="hljs-string">'vxe-table/lib/locale/lang/en-US'</span>;
<span class="hljs-keyword">import</span> vxe_ruRU <span class="hljs-keyword">from</span> <span class="hljs-string">'@/lang/vxeTabel/ru_RU'</span>;


<span class="hljs-comment">// ant-design 组件翻译（保留本地，不被远程覆盖）</span>
<span class="hljs-keyword">import</span> ant_zhCN <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/zh_CN'</span>;
<span class="hljs-keyword">import</span> ant_enUS <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/en_US'</span>;
<span class="hljs-keyword">import</span> ant_ruRU <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/ru_RU'</span>;


<span class="hljs-comment">// dayjs 本地化（无需修改）</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"dayjs/locale/zh-cn"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dayjs/locale/en"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dayjs/locale/ru"</span>;

<span class="hljs-comment">// 本地业务翻译（可能被远程覆盖）</span>
<span class="hljs-keyword">import</span> enLocale <span class="hljs-keyword">from</span> <span class="hljs-string">'./en'</span>;
<span class="hljs-keyword">import</span> zhLocale <span class="hljs-keyword">from</span> <span class="hljs-string">'./zh'</span>;
<span class="hljs-keyword">import</span> ruLocale <span class="hljs-keyword">from</span> <span class="hljs-string">'./ru'</span>;



<span class="hljs-comment">// 初始化本地消息（组件库翻译 + 本地业务翻译）</span>
<span class="hljs-keyword">const</span> baseMessages = {
    <span class="hljs-attr">en_US</span>: {
        ...ant_enUS,    <span class="hljs-comment">// 组件库翻译（优先级最高，不被覆盖）</span>
        ...vxe_enUS,
        ...enLocale     <span class="hljs-comment">// 本地业务翻译（可能被远程覆盖）</span>
    },
    <span class="hljs-attr">zh_CN</span>: {
        ...ant_zhCN,
        ...vxe_zhCN,
        ...zhLocale
    },
    <span class="hljs-attr">ru_RU</span>: {
        ...ant_ruRU,
        ...vxe_ruRU,
        ...ruLocale
    }
}

<span class="hljs-comment">// 获取当前语言（复用你的现有逻辑）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getLocale</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> cookieLanguage = <span class="hljs-title function_">getLanguage</span>()
    <span class="hljs-keyword">if</span> (cookieLanguage) {
        <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">lang</span> = cookieLanguage
        <span class="hljs-keyword">return</span> cookieLanguage
    }
    <span class="hljs-keyword">const</span> language = navigator.<span class="hljs-property">language</span>.<span class="hljs-title function_">toLowerCase</span>()
    <span class="hljs-keyword">const</span> locales = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(baseMessages)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> locale <span class="hljs-keyword">of</span> locales) {
        <span class="hljs-keyword">if</span> (language.<span class="hljs-title function_">indexOf</span>(locale) &gt; -<span class="hljs-number">1</span>) {
            <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">lang</span> = locale
            <span class="hljs-keyword">return</span> locale
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">'zh_CN'</span> <span class="hljs-comment">// 默认中文</span>
}

<span class="hljs-comment">// 创建基础 i18n 实例（先加载本地翻译）</span>
<span class="hljs-keyword">const</span> i18n = <span class="hljs-title function_">createI18n</span>({
    <span class="hljs-attr">legacy</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">globalInjection</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">locale</span>: <span class="hljs-title function_">getLocale</span>(),
    <span class="hljs-attr">messages</span>: baseMessages, <span class="hljs-comment">// 先使用本地基础翻译</span>
    <span class="hljs-attr">silentTranslationWarn</span>: <span class="hljs-literal">true</span>
})

<span class="hljs-comment">// 核心：加载远程翻译并合并（远程覆盖本地业务翻译，不影响组件库翻译）</span>
<span class="hljs-comment">// 定义语言类型</span>
type <span class="hljs-title class_">Locale</span> = <span class="hljs-string">'en_US'</span> | <span class="hljs-string">'zh_CN'</span> | <span class="hljs-string">'ru_RU'</span>;

<span class="hljs-comment">// 修改 loadRemoteMessages 函数，添加类型约束</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadRemoteMessages</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">locale: Locale = getLocale()</span>) =&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// const remoteTrans = await fetchRemoteTranslations(locale)</span>
        <span class="hljs-keyword">let</span> remoteTrans = {
            <span class="hljs-number">99001</span>: <span class="hljs-string">"测试远程翻译"</span>,
        }
        <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">'波奇壁纸管理系统'</span>
        <span class="hljs-keyword">if</span> (locale == <span class="hljs-string">'en_US'</span>) {
            remoteTrans = {
                <span class="hljs-number">99001</span>: <span class="hljs-string">"test this a remote translation"</span>,
            }
            <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">'bocchi wallpaper management system'</span>
        }
        <span class="hljs-comment">// 2. 合并规则：远程翻译覆盖本地业务翻译，但不影响组件库翻译</span>
        <span class="hljs-keyword">const</span> merged = {
            ...baseMessages[locale], <span class="hljs-comment">// 基础：组件库 + 本地业务</span>
            ...remoteTrans          <span class="hljs-comment">// 远程业务翻译覆盖本地业务</span>
        }
        <span class="hljs-comment">// 3. 更新 i18n 实例的翻译数据</span>
        i18n.<span class="hljs-property">global</span>.<span class="hljs-title function_">setLocaleMessage</span>(locale, merged)
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`已加载 <span class="hljs-subst">${locale}</span> 远程翻译`</span>)
    } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`远程翻译加载失败，使用本地翻译:`</span>, err)
        <span class="hljs-comment">// 失败时仍使用本地翻译</span>
    }
}


<span class="hljs-comment">// 初始化时立即加载远程翻译（确保页面首次渲染使用最新翻译）</span>
<span class="hljs-title function_">loadRemoteMessages</span>()

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> i18n
</code></pre>
<h5 data-id="heading-6">1.3.1 翻译文件示例</h5>
<p>src\lang\en.ts</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-comment">// 系统 10</span>
    <span class="hljs-number">10001</span>: <span class="hljs-string">''</span>,

    <span class="hljs-comment">// 菜单 20</span>
    <span class="hljs-number">20001</span>: <span class="hljs-string">'Home'</span>,
    <span class="hljs-number">20002</span>: <span class="hljs-string">'Wallpaper Management'</span>,
    <span class="hljs-number">20003</span>: <span class="hljs-string">'Wallpaper Information'</span>,
    <span class="hljs-number">20004</span>: <span class="hljs-string">'Image Upload'</span>,
    <span class="hljs-number">20005</span>: <span class="hljs-string">'Video Upload'</span>,
    <span class="hljs-number">20006</span>: <span class="hljs-string">'Data Management'</span>,
    <span class="hljs-number">20007</span>: <span class="hljs-string">'User Management'</span>,
    <span class="hljs-number">20008</span>: <span class="hljs-string">'User Information'</span>,
    <span class="hljs-number">20009</span>: <span class="hljs-string">'Long-term Inactive'</span>,
    <span class="hljs-number">20010</span>: <span class="hljs-string">'Entertainment Management'</span>,
    <span class="hljs-number">20011</span>: <span class="hljs-string">'System Management'</span>,
    <span class="hljs-number">20012</span>: <span class="hljs-string">'Port Information'</span>,
    <span class="hljs-number">20013</span>: <span class="hljs-string">'Software Information'</span>
}
</code></pre>
<p>引用并挂载多语言 src\main.ts</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/App.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'ant-design-vue/dist/reset.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'@/styles/global.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'@/styles/vxeTable.css'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VXETable</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vxe-table'</span>
<span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'vxe-table/lib/style.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'@/router/permisstion'</span>
<span class="hljs-keyword">import</span> globalComponents <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/index'</span>
<span class="hljs-keyword">import</span> globalDirective <span class="hljs-keyword">from</span> <span class="hljs-string">'@/directives/index'</span>
<span class="hljs-keyword">import</span> piniaPluginPersistedstate <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia-plugin-persistedstate'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./auto-update'</span> <span class="hljs-comment">// 自动更新</span>
<span class="hljs-keyword">import</span> i18n <span class="hljs-keyword">from</span> <span class="hljs-string">'./lang'</span>

<span class="hljs-title class_">VXETable</span>.<span class="hljs-title function_">setConfig</span>({
  <span class="hljs-attr">size</span>: <span class="hljs-string">'mini'</span>, <span class="hljs-comment">// 全局尺寸</span>
  <span class="hljs-attr">i18n</span>: <span class="hljs-function">(<span class="hljs-params">key: string, args: any</span>) =&gt;</span> i18n.<span class="hljs-property">global</span>.<span class="hljs-title function_">t</span>(key, args),
  <span class="hljs-title function_">translate</span>(<span class="hljs-params">key, args</span>) {
    <span class="hljs-keyword">return</span> i18n.<span class="hljs-property">global</span>.<span class="hljs-title function_">t</span>(key, args)
  }
})

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
<span class="hljs-comment">// @ts-ignore</span>
app.<span class="hljs-property">config</span>.<span class="hljs-property">globalProperties</span>.<span class="hljs-property">$i18n</span> = i18n;

app.<span class="hljs-title function_">use</span>(i18n) 
app.<span class="hljs-title function_">use</span>(router)
app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VXETable</span>)
store.<span class="hljs-title function_">use</span>(piniaPluginPersistedstate)
app.<span class="hljs-title function_">use</span>(store)
app.<span class="hljs-title function_">use</span>(globalComponents)
app.<span class="hljs-title function_">use</span>(globalDirective)
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h4 data-id="heading-7">1.4 定义多语言切换组件</h4>
<ul>
<li>src\components\layout\Language\index.vue</li>
<li>在合适的地方引入即可实现多语言切换</li>
</ul>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"Language"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a-dropdown</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">overlay</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">a-menu</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"onLanguage"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">a-menu-item</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"itm in languageList"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"itm.value"</span> <span class="hljs-attr">:name</span>=<span class="hljs-string">"itm.label"</span>&gt;</span>
                        {{ itm.label }}
                    <span class="hljs-tag">&lt;/<span class="hljs-name">a-menu-item</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">a-menu</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">a-button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 110px"</span>&gt;</span>
                {{ language }}
                <span class="hljs-tag">&lt;<span class="hljs-name">DownOutlined</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">a-button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">a-dropdown</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { computed, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DownOutlined</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ant-design/icons-vue'</span>;
<span class="hljs-keyword">import</span> { useI18n } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue-i18n"</span>;
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/user'</span>
<span class="hljs-keyword">import</span> { storeToRefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { setLanguage } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/cookies'</span>
<span class="hljs-keyword">import</span> { loadRemoteMessages } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/lang/index'</span>

<span class="hljs-keyword">const</span> { locale } = <span class="hljs-title function_">useI18n</span>();
<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useUserStore</span>()
<span class="hljs-keyword">const</span> { lang } = <span class="hljs-title function_">storeToRefs</span>(store);

<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">'on-click'</span>])

<span class="hljs-comment">//多语音</span>
<span class="hljs-keyword">const</span> language = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">switch</span> (lang.<span class="hljs-property">value</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'zh_CN'</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'简体中文'</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'en_US'</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'English'</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'ru_RU'</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'Russia'</span>;
        <span class="hljs-attr">default</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'简体中文'</span>;
    }
})
<span class="hljs-keyword">const</span> languageList = [
    { <span class="hljs-attr">label</span>: <span class="hljs-string">'简体中文'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'zh_CN'</span> },
    { <span class="hljs-attr">label</span>: <span class="hljs-string">'English'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'en_US'</span> },
    { <span class="hljs-attr">label</span>: <span class="hljs-string">'Russia'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'ru_RU'</span> },
]

<span class="hljs-comment">//切换语言</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">onLanguage</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">v: any</span>) =&gt; {
    <span class="hljs-comment">// language.value = v.item.name;</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadRemoteMessages</span>(v.<span class="hljs-property">key</span>);
    locale.<span class="hljs-property">value</span> = v.<span class="hljs-property">key</span>;
    lang.<span class="hljs-property">value</span> = v.<span class="hljs-property">key</span>;
    <span class="hljs-title function_">setLanguage</span>(v.<span class="hljs-property">key</span>)
    <span class="hljs-title function_">emit</span>(<span class="hljs-string">'on-click'</span>)
}

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setLanguage</span>(lang.<span class="hljs-property">value</span>)
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-8">1.5 主UI库适配</h4>
<ul>
<li>src\App.vue</li>
<li>这里以 <code>ant-design-vue</code> 为例，按照官网方法设置即可，其它 UI库同理。</li>
</ul>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span> <span class="hljs-attr">:locale</span>=<span class="hljs-string">"language"</span> <span class="hljs-attr">:theme</span>=<span class="hljs-string">"themeConfig"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ConfigProvider</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { computed, ref, watch, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'dayjs/locale/zh-cn'</span>
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/user.ts'</span>
<span class="hljs-keyword">import</span> themeStore <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/themeStore'</span>
<span class="hljs-keyword">import</span> { storeToRefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> zhCN <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/zh_CN'</span>
<span class="hljs-keyword">import</span> enUS <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/en_US'</span>
<span class="hljs-keyword">import</span> ruRU <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/ru_RU'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigProvider</span>, theme } <span class="hljs-keyword">from</span> <span class="hljs-string">"ant-design-vue"</span>;

<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()
<span class="hljs-keyword">const</span> { lang } = <span class="hljs-title function_">storeToRefs</span>(userStore)
<span class="hljs-keyword">const</span> { isDark } = <span class="hljs-title function_">storeToRefs</span>(<span class="hljs-title function_">themeStore</span>())

<span class="hljs-keyword">const</span> themeConfig = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">algorithm</span>: isDark.<span class="hljs-property">value</span> ? theme.<span class="hljs-property">darkAlgorithm</span> : theme.<span class="hljs-property">defaultAlgorithm</span>, <span class="hljs-comment">// 核心：切换明暗算法</span>
});

<span class="hljs-title function_">watch</span>(isDark, <span class="hljs-function">(<span class="hljs-params">newVal</span>) =&gt;</span> {
  themeConfig.<span class="hljs-property">value</span>.<span class="hljs-property">algorithm</span> = newVal ? theme.<span class="hljs-property">darkAlgorithm</span> : theme.<span class="hljs-property">defaultAlgorithm</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">'dark'</span>, newVal);
})


<span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: any = {
  <span class="hljs-string">'zh_CN'</span>: zhCN,
  <span class="hljs-string">'en_US'</span>: enUS,
  <span class="hljs-string">'ru_RU'</span>: ruRU
}

<span class="hljs-keyword">const</span> language = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> obj[lang.<span class="hljs-property">value</span>]
})

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">'dark'</span>, isDark.<span class="hljs-property">value</span>);
})

</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

</code></pre>
<h4 data-id="heading-9">1.6 使用</h4>
<p>直接使用 <code>$t('key')</code> 或者 引入后使用 <code>t('key')</code> 都行</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
    &lt;div&gt;
        &lt;hr&gt;
        {{ t('99001') }}
        &lt;hr&gt;
        {{ $t('99001') }}
        &lt;hr&gt;
    &lt;/div&gt;
&lt;/template&gt;

&lt;script lang="ts" setup&gt;
import { useI18n } from "vue-i18n";

const { t } = useI18n();
&lt;/script&gt;

</code></pre>
<h4 data-id="heading-10">1.7 效果预览</h4>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc9071a6c69e43e4b29586f7613065a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNub2lu6IO9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766807441&amp;x-signature=xAOWvWfwBxjfNNIifLR4kezIcMM%3D" alt="image.png" width="100%" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38ebc6e7f0f04dd8849014070556790c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNub2lu6IO9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766807441&amp;x-signature=j0YVf4W3S4ag0cijvxW7YsXBtkw%3D" alt="image.png" width="100%" loading="lazy"/>
<h3 data-id="heading-11">2、暗黑模式</h3>
<p>暗黑模式（Dark Mode）核心价值是适配特定行业调性。刚做的工厂mes系统，现场属于高亮环境，不同时间段还会有太阳光反射等情况，亮色模式下看不清，领导就要求加入暗黑模式，咱就给他加。</p>
<h4 data-id="heading-12">2.1 定义主题仓库</h4>
<ul>
<li>src\store\themeStore.ts</li>
<li>用于记录主题和改变主题</li>
<li>仓库已做持久化存储</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">const</span> themeStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'theme'</span>, {
  <span class="hljs-attr">state</span>: (): {
    <span class="hljs-attr">isDark</span>: boolean,
  } =&gt; {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">isDark</span>: <span class="hljs-literal">false</span>,
    }
  },
  <span class="hljs-attr">persist</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">toggleTheme</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isDark</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isDark</span>
    },
  },
  <span class="hljs-attr">getters</span>: {},
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> themeStore

</code></pre>
<h4 data-id="heading-13">2.2 定义主题参数</h4>
<ul>
<li>src\styles\global.css</li>
</ul>
<h5 data-id="heading-14">2.2.1自定义 css 全局变量</h5>
<ul>
<li>分别定义 暗黑主题 和 亮色主题 的css变量</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 基础变量：覆盖 90% 通用场景，与 Antd 风格对齐 */</span>
<span class="hljs-selector-pseudo">:root</span> {
    <span class="hljs-attr">--bg</span>: white;
    <span class="hljs-comment">/* ========== 背景色 ========== */</span>
    <span class="hljs-attr">--bg-primary</span>: <span class="hljs-number">#ffffff</span>;
    <span class="hljs-attr">--bg-secondary</span>: <span class="hljs-number">#f5f5f5</span>;
    <span class="hljs-attr">--bg-tertiary</span>: <span class="hljs-number">#fafafa</span>;
    <span class="hljs-attr">--bg-overlay</span>: <span class="hljs-number">#ffffff</span>;

    <span class="hljs-comment">/* ========== 文字色 ========== */</span>
    <span class="hljs-attr">--text-primary</span>: black;
    <span class="hljs-attr">--text-secondary</span>: <span class="hljs-number">#4b5563</span>;
    <span class="hljs-attr">--text-tertiary</span>: <span class="hljs-number">#9ca3af</span>;
    <span class="hljs-attr">--text-inverse</span>: <span class="hljs-number">#ffffff</span>;

    <span class="hljs-comment">/* ========== 边框色 ========== */</span>
    <span class="hljs-attr">--border-primary</span>: <span class="hljs-number">#e5e7eb</span>;
    <span class="hljs-attr">--border-secondary</span>: <span class="hljs-number">#d1d5db</span>;
    <span class="hljs-attr">--border-hover</span>: <span class="hljs-number">#9ca3af</span>;

    <span class="hljs-comment">/* ========== 功能色（与 Antd 主色对齐） ========== */</span>
    <span class="hljs-attr">--color-primary</span>: <span class="hljs-number">#1890ff</span>;
    <span class="hljs-attr">--color-success</span>: <span class="hljs-number">#52c41a</span>;
    <span class="hljs-attr">--color-warning</span>: <span class="hljs-number">#faad14</span>;
    <span class="hljs-attr">--color-danger</span>: <span class="hljs-number">#ff4d4f</span>;
    <span class="hljs-attr">--color-info</span>: <span class="hljs-number">#1890ff</span>;

    <span class="hljs-comment">/* ========== 交互状态 ========== */</span>
    <span class="hljs-attr">--hover-bg</span>: <span class="hljs-number">#f9fafb</span>;
    <span class="hljs-attr">--active-bg</span>: <span class="hljs-number">#f3f4f6</span>;
    <span class="hljs-attr">--disabled-bg</span>: <span class="hljs-number">#f9fafb</span>;

    <span class="hljs-comment">/* 偏白色的主色调 */</span>
    <span class="hljs-attr">--color-primary-light</span>: <span class="hljs-number">#e6f7ff</span>;
    <span class="hljs-attr">--color-primary-lighter</span>: <span class="hljs-number">#bae7ff</span>;
    <span class="hljs-attr">--color-primary-lightest</span>: <span class="hljs-number">#69c0ff</span>;
    <span class="hljs-attr">--color-primary-darker</span>: <span class="hljs-number">#40a9ff</span>;
    <span class="hljs-attr">--color-primary-darkest</span>: <span class="hljs-number">#096dd9</span>;

    <span class="hljs-comment">/* 白色透明梯度色 */</span>
    <span class="hljs-attr">--color-gradient-light</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.3</span>);
    <span class="hljs-attr">--color-gradient-lighter</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.4</span>);
    <span class="hljs-attr">--color-gradient-lightest</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.5</span>);

    <span class="hljs-comment">/* 表格相关 */</span>
    <span class="hljs-attr">--table-hover-bg</span>: <span class="hljs-number">#f1f2ffe8</span>;
    <span class="hljs-attr">--table-active-bg</span>: <span class="hljs-number">#cee9ffe2</span>;



    <span class="hljs-comment">/* vxe-table 专属变量 */</span>
    <span class="hljs-attr">--vxe-table-bg</span>: <span class="hljs-built_in">var</span>(--bg-primary);
    <span class="hljs-attr">--vxe-table-header-bg</span>: <span class="hljs-built_in">var</span>(--bg-secondary);
    <span class="hljs-attr">--vxe-table-row-hover-bg</span>: <span class="hljs-number">#f9fafb</span>;
    <span class="hljs-attr">--vxe-table-row-active-bg</span>: <span class="hljs-number">#f3f4f6</span>;
    <span class="hljs-attr">--vxe-table-border-color</span>: <span class="hljs-built_in">var</span>(--border-primary);
    <span class="hljs-attr">--vxe-table-text-color</span>: <span class="hljs-built_in">var</span>(--text-primary);
    <span class="hljs-attr">--vxe-table-header-text-color</span>: <span class="hljs-built_in">var</span>(--text-primary);
    <span class="hljs-attr">--vxe-table-cell-hover-color</span>: <span class="hljs-built_in">var</span>(--color-primary);


}

<span class="hljs-comment">/* 暗黑模式变量：基于 Antd 暗黑风格优化 */</span>
<span class="hljs-selector-class">.dark</span> {
    <span class="hljs-attr">--bg</span>: black;
    <span class="hljs-comment">/* ========== 背景色 ========== */</span>
    <span class="hljs-attr">--bg-primary</span>: <span class="hljs-number">#141414</span>;
    <span class="hljs-attr">--bg-secondary</span>: <span class="hljs-number">#1f1f1f</span>;
    <span class="hljs-attr">--bg-tertiary</span>: <span class="hljs-number">#272727</span>;
    <span class="hljs-attr">--bg-overlay</span>: <span class="hljs-number">#1f1f1f</span>;

    <span class="hljs-comment">/* ========== 文字色 ========== */</span>
    <span class="hljs-attr">--text-primary</span>: white;
    <span class="hljs-attr">--text-secondary</span>: <span class="hljs-number">#9ca3af</span>;
    <span class="hljs-attr">--text-tertiary</span>: <span class="hljs-number">#6b7280</span>;
    <span class="hljs-attr">--text-inverse</span>: <span class="hljs-number">#141414</span>;

    <span class="hljs-comment">/* ========== 边框色 ========== */</span>
    <span class="hljs-attr">--border-primary</span>: <span class="hljs-number">#303030</span>;
    <span class="hljs-attr">--border-secondary</span>: <span class="hljs-number">#3d3d3d</span>;
    <span class="hljs-attr">--border-hover</span>: <span class="hljs-number">#474747</span>;

    <span class="hljs-comment">/* ========== 功能色（暗黑模式优化） ========== */</span>
    <span class="hljs-attr">--color-primary</span>: <span class="hljs-number">#359eff</span>;
    <span class="hljs-attr">--color-success</span>: <span class="hljs-number">#67c23a</span>;
    <span class="hljs-attr">--color-warning</span>: <span class="hljs-number">#feb019</span>;
    <span class="hljs-attr">--color-danger</span>: <span class="hljs-number">#ff7875</span>;
    <span class="hljs-attr">--color-info</span>: <span class="hljs-number">#359eff</span>;

    <span class="hljs-comment">/* ========== 交互状态 ========== */</span>
    <span class="hljs-attr">--hover-bg</span>: <span class="hljs-number">#272727</span>;
    <span class="hljs-attr">--active-bg</span>: <span class="hljs-number">#303030</span>;
    <span class="hljs-attr">--disabled-bg</span>: <span class="hljs-number">#1f1f1f</span>;

    <span class="hljs-comment">/* 暗黑模式 - 偏暗的主色调（匹配原亮色蓝色系，适配深色背景） */</span>
    <span class="hljs-attr">--color-primary-light</span>: <span class="hljs-number">#142f40</span>;
    <span class="hljs-attr">--color-primary-lighter</span>: <span class="hljs-number">#103c58</span>;
    <span class="hljs-attr">--color-primary-lightest</span>: <span class="hljs-number">#2386c8</span>;
    <span class="hljs-attr">--color-primary-darker</span>: <span class="hljs-number">#2994e0</span>;
    <span class="hljs-attr">--color-primary-darkest</span>: <span class="hljs-number">#359eff</span>;

    <span class="hljs-comment">/* 黑色透明梯度色 */</span>
    <span class="hljs-attr">--color-gradient-light</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>);
    <span class="hljs-attr">--color-gradient-lighter</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.6</span>);
    <span class="hljs-attr">--color-gradient-lightest</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.7</span>);

    <span class="hljs-comment">/* 表格相关 */</span>
    <span class="hljs-attr">--table-hover-bg</span>: <span class="hljs-number">#4e4e4e</span>;
    <span class="hljs-attr">--table-active-bg</span>: <span class="hljs-number">#000a3aa4</span>;


    <span class="hljs-comment">/* vxe-table 专属变量（适配暗黑） */</span>
    <span class="hljs-attr">--vxe-table-bg</span>: <span class="hljs-built_in">var</span>(--bg-primary);
    <span class="hljs-attr">--vxe-table-header-bg</span>: <span class="hljs-built_in">var</span>(--bg-secondary);
    <span class="hljs-attr">--vxe-table-row-hover-bg</span>: <span class="hljs-number">#272727</span>;
    <span class="hljs-attr">--vxe-table-row-active-bg</span>: <span class="hljs-number">#303030</span>;
    <span class="hljs-attr">--vxe-table-border-color</span>: <span class="hljs-built_in">var</span>(--border-primary);
    <span class="hljs-attr">--vxe-table-text-color</span>: <span class="hljs-built_in">var</span>(--text-primary);
    <span class="hljs-attr">--vxe-table-header-text-color</span>: <span class="hljs-built_in">var</span>(--text-primary);
    <span class="hljs-attr">--vxe-table-cell-hover-color</span>: <span class="hljs-built_in">var</span>(--color-primary);
}
</code></pre>
<h5 data-id="heading-15">2.2.2 覆盖插件样式</h5>
<ul>
<li>对于一些没有适配暗黑模式或者暗黑模式不清晰的插件，可以对样式进行覆盖</li>
<li>这里以 vxe-table 为例，官网的设置暗黑方法不存在，可能是版本原因吧</li>
<li>其它插件同理覆盖即可</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 覆盖 vxe-table 基础样式 - 全局生效 */</span>
<span class="hljs-selector-class">.vxe-table</span> {
    <span class="hljs-attr">--vxe-font-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-text-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-header-font-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-header-text-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-row-hover-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-row-hover-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-row-current-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-row-active-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-row-hover-font-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-text-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-border-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-border-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-header-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-header-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-body-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-empty-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-input-border-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-border-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-input-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-input-font-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-text-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-border-color</span>: <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-border-color</span>: <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-header--row</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-primary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.row--level-0</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.row--stripe</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-tertiary) <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-pager</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-primary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.vxe-loading</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--color-gradient-light) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.vxe-input--inner</span>,
<span class="hljs-selector-class">.vxe-pager--jump-prev</span>,
<span class="hljs-selector-class">.vxe-select--panel-wrapper</span>,
<span class="hljs-selector-class">.vxe-pager--prev-btn</span>,
<span class="hljs-selector-class">.vxe-pager--num-btn</span>,
<span class="hljs-selector-class">.vxe-pager--next-btn</span>,
<span class="hljs-selector-class">.vxe-pager--jump-next</span>,
<span class="hljs-selector-class">.vxe-pager--goto</span>,
<span class="hljs-selector-class">.vxe-pager</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border-color</span>: <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-secondary) <span class="hljs-meta">!important</span>;
}


<span class="hljs-comment">/* 进入行 */</span>
<span class="hljs-selector-class">.row--hover</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--table-hover-bg) <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/* 选中行 */</span>
<span class="hljs-selector-class">.row--current</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--table-active-bg) <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-table--body-wrapper</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-toolbar</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border-color</span>: <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-secondary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/*滚动条整体部分*/</span>
<span class="hljs-selector-class">.vxe-table</span> ::-webkit-scrollbar {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">8px</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">8px</span> <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/*滚动条的轨道*/</span>
<span class="hljs-selector-class">.vxe-table</span> ::-webkit-scrollbar-track {
    <span class="hljs-attribute">background</span>: transparent <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/*滚动条里面的小方块，能向上向下移动*/</span>
<span class="hljs-selector-class">.vxe-table</span> ::-webkit-scrollbar-thumb {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">box-shadow</span>: inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">6px</span> <span class="hljs-built_in">var</span>(--text-secondary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/*边角，即两个滚动条的交汇处*/</span>
<span class="hljs-selector-class">.vxe-table</span> ::-webkit-scrollbar-corner {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.vxe-pager--btn-wrapper</span> <span class="hljs-selector-class">.is--active</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--color-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">color</span>: white <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/* 覆盖 vxe-table 基础样式 - 全局生效 */</span>
<span class="hljs-selector-class">.vxe-table</span> {
    <span class="hljs-attr">--vxe-font-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-text-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-header-font-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-header-text-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-row-hover-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-row-hover-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-row-current-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-row-active-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-row-hover-font-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-text-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-border-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-border-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-header-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-header-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-body-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-empty-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-input-border-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-border-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-input-bg-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-bg) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-input-font-color</span>: <span class="hljs-built_in">var</span>(--vxe-table-text-color) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-border-color</span>: <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attr">--vxe-table-border-color</span>: <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-header--row</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-primary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.row--level-0</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.row--stripe</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-tertiary) <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-pager</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-primary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.vxe-loading</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--color-gradient-light) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.vxe-input--inner</span>,
<span class="hljs-selector-class">.vxe-pager--jump-prev</span>,
<span class="hljs-selector-class">.vxe-select--panel-wrapper</span>,
<span class="hljs-selector-class">.vxe-pager--prev-btn</span>,
<span class="hljs-selector-class">.vxe-pager--num-btn</span>,
<span class="hljs-selector-class">.vxe-pager--next-btn</span>,
<span class="hljs-selector-class">.vxe-pager--jump-next</span>,
<span class="hljs-selector-class">.vxe-pager--goto</span>,
<span class="hljs-selector-class">.vxe-pager</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border-color</span>: <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-secondary) <span class="hljs-meta">!important</span>;
}


<span class="hljs-comment">/* 进入行 */</span>
<span class="hljs-selector-class">.row--hover</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--table-hover-bg) <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/* 选中行 */</span>
<span class="hljs-selector-class">.row--current</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--table-active-bg) <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-table--body-wrapper</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-toolbar</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border-color</span>: <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-secondary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/*滚动条整体部分*/</span>
<span class="hljs-selector-class">.vxe-table</span> ::-webkit-scrollbar {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">8px</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">8px</span> <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/*滚动条的轨道*/</span>
<span class="hljs-selector-class">.vxe-table</span> ::-webkit-scrollbar-track {
    <span class="hljs-attribute">background</span>: transparent <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/*滚动条里面的小方块，能向上向下移动*/</span>
<span class="hljs-selector-class">.vxe-table</span> ::-webkit-scrollbar-thumb {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">var</span>(--border-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">box-shadow</span>: inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">6px</span> <span class="hljs-built_in">var</span>(--text-secondary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/*边角，即两个滚动条的交汇处*/</span>
<span class="hljs-selector-class">.vxe-table</span> ::-webkit-scrollbar-corner {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-secondary) <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.vxe-pager--btn-wrapper</span> <span class="hljs-selector-class">.is--active</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--color-primary) <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">color</span>: white <span class="hljs-meta">!important</span>;
}


<span class="hljs-selector-class">.vxe-icon-checkbox-unchecked</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-tertiary) <span class="hljs-meta">!important</span>;
}
</code></pre>
<h4 data-id="heading-16">2.3 引入定义好的变量和样式</h4>
<ul>
<li>src\main.ts</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/App.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'ant-design-vue/dist/reset.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'@/styles/global.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'@/styles/vxeTable.css'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VXETable</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vxe-table'</span>
<span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'vxe-table/lib/style.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'@/router/permisstion'</span>
<span class="hljs-keyword">import</span> globalComponents <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/index'</span>
<span class="hljs-keyword">import</span> globalDirective <span class="hljs-keyword">from</span> <span class="hljs-string">'@/directives/index'</span>
<span class="hljs-keyword">import</span> piniaPluginPersistedstate <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia-plugin-persistedstate'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./auto-update'</span> <span class="hljs-comment">// 自动更新</span>
<span class="hljs-keyword">import</span> i18n <span class="hljs-keyword">from</span> <span class="hljs-string">'./lang'</span>

<span class="hljs-title class_">VXETable</span>.<span class="hljs-title function_">setConfig</span>({
  <span class="hljs-attr">size</span>: <span class="hljs-string">'mini'</span>, <span class="hljs-comment">// 全局尺寸</span>
  <span class="hljs-attr">i18n</span>: <span class="hljs-function">(<span class="hljs-params">key: string, args: any</span>) =&gt;</span> i18n.<span class="hljs-property">global</span>.<span class="hljs-title function_">t</span>(key, args),
  <span class="hljs-title function_">translate</span>(<span class="hljs-params">key, args</span>) {
    <span class="hljs-keyword">return</span> i18n.<span class="hljs-property">global</span>.<span class="hljs-title function_">t</span>(key, args)
  }
})

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
<span class="hljs-comment">// @ts-ignore</span>
app.<span class="hljs-property">config</span>.<span class="hljs-property">globalProperties</span>.<span class="hljs-property">$i18n</span> = i18n;

app.<span class="hljs-title function_">use</span>(i18n) 
app.<span class="hljs-title function_">use</span>(router)
app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VXETable</span>)
store.<span class="hljs-title function_">use</span>(piniaPluginPersistedstate)
app.<span class="hljs-title function_">use</span>(store)
app.<span class="hljs-title function_">use</span>(globalComponents)
app.<span class="hljs-title function_">use</span>(globalDirective)
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)

</code></pre>
<h4 data-id="heading-17">2.4 定义主题切换组件</h4>
<ul>
<li>src\components\layout\theme\index.vue</li>
<li>在合适的地方引入即可实现主题切换</li>
</ul>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">a-button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"themeButton"</span>  @<span class="hljs-attr">click</span>=<span class="hljs-string">"toggleDark"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"isDark ? dark : light"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 20px; height: 20px"</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">a-button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> themeStore <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/themeStore'</span>
<span class="hljs-keyword">import</span> { storeToRefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> dark <span class="hljs-keyword">from</span> <span class="hljs-string">'@/assets/images/dark.png'</span>
<span class="hljs-keyword">import</span> light <span class="hljs-keyword">from</span> <span class="hljs-string">'@/assets/images/light.png'</span>

<span class="hljs-keyword">const</span> themes = <span class="hljs-title function_">themeStore</span>()
<span class="hljs-keyword">const</span> { isDark } = <span class="hljs-title function_">storeToRefs</span>(themes)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleDark</span> = (<span class="hljs-params"/>) =&gt; {
    isDark.<span class="hljs-property">value</span> = !isDark.<span class="hljs-property">value</span>;
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.themeButton</span>{
    <span class="hljs-attribute">cursor</span>: pointer;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">32px</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">32px</span>;
    <span class="hljs-attribute">box-sizing</span>: border-box;
    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">var</span>(--border-primary);
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">justify-content</span>: center;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-18">2.5 主UI库适配、应用主题</h4>
<ul>
<li>src\App.vue</li>
<li>这里以 <code>ant-design-vue</code> 为例，按照官网方法设置即可，其它 UI库同理。</li>
<li>原理很简单，就是监听是否是暗黑主题，如果是则为根元素添加 <code>dark</code> 类名，不是则移除。</li>
<li><code>记得初始化时默认设置一次类名</code></li>
</ul>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span> <span class="hljs-attr">:locale</span>=<span class="hljs-string">"language"</span> <span class="hljs-attr">:theme</span>=<span class="hljs-string">"themeConfig"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ConfigProvider</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { computed, ref, watch, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'dayjs/locale/zh-cn'</span>
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/user.ts'</span>
<span class="hljs-keyword">import</span> themeStore <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/themeStore'</span>
<span class="hljs-keyword">import</span> { storeToRefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> zhCN <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/zh_CN'</span>
<span class="hljs-keyword">import</span> enUS <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/en_US'</span>
<span class="hljs-keyword">import</span> ruRU <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue/lib/locale/ru_RU'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigProvider</span>, theme } <span class="hljs-keyword">from</span> <span class="hljs-string">"ant-design-vue"</span>;

<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()
<span class="hljs-keyword">const</span> { lang } = <span class="hljs-title function_">storeToRefs</span>(userStore)
<span class="hljs-keyword">const</span> { isDark } = <span class="hljs-title function_">storeToRefs</span>(<span class="hljs-title function_">themeStore</span>())

<span class="hljs-keyword">const</span> themeConfig = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">algorithm</span>: isDark.<span class="hljs-property">value</span> ? theme.<span class="hljs-property">darkAlgorithm</span> : theme.<span class="hljs-property">defaultAlgorithm</span>, <span class="hljs-comment">// 核心：切换明暗算法</span>
});

<span class="hljs-title function_">watch</span>(isDark, <span class="hljs-function">(<span class="hljs-params">newVal</span>) =&gt;</span> {
  themeConfig.<span class="hljs-property">value</span>.<span class="hljs-property">algorithm</span> = newVal ? theme.<span class="hljs-property">darkAlgorithm</span> : theme.<span class="hljs-property">defaultAlgorithm</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">'dark'</span>, newVal);
})


<span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: any = {
  <span class="hljs-string">'zh_CN'</span>: zhCN,
  <span class="hljs-string">'en_US'</span>: enUS,
  <span class="hljs-string">'ru_RU'</span>: ruRU
}

<span class="hljs-keyword">const</span> language = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> obj[lang.<span class="hljs-property">value</span>]
})

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">'dark'</span>, isDark.<span class="hljs-property">value</span>);
})

</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

</code></pre>
<h4 data-id="heading-19">2.6 使用</h4>
<ul>
<li>使用就非常简单了，通过 <code>var()</code> 使用自定义的css变量即可。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.form</span>{
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--bg-primary);
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-primary);
}
</code></pre>
<h4 data-id="heading-20">2.7 效果预览</h4>
<ul>
<li>效果非常明显，暗黑模式在高亮环境下依然清晰可见。</li>
</ul>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f0b776a3df5481ebd38fc0695a4d32f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNub2lu6IO9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766807441&amp;x-signature=o1bG1GhiR1gn%2BYhvetQLHSFYwSA%3D" alt="image.png" width="100%" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e3796e875574ae69cc078d87e02b1ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNub2lu6IO9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766807441&amp;x-signature=NQgKFNe%2FVzsOxl0Vz0%2BZzlj%2Fcws%3D" alt="image.png" width="100%" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d036b0ce29c9456389640599208a71f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNub2lu6IO9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766807441&amp;x-signature=r6xx5Le%2F38zUw6PAewYy17ON36w%3D" alt="image.png" width="100%" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fa315dbdc564878857a1ba67e5f87ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNub2lu6IO9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766807441&amp;x-signature=0H%2B%2BwZLLbyBrzLkjAJWUt3Q9Dl0%3D" alt="image.png" width="100%" loading="lazy"/>
<h3 data-id="heading-21">3、测试项目地址</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fzsnoin-can%2Flang-and-dark" target="_blank" title="https://gitee.com/zsnoin-can/lang-and-dark" ref="nofollow noopener noreferrer">gitee.com/zsnoin-can/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[kafka]伪集群搭建,各个节点配置文件中listeners参数的配置]]></title>    <link>https://juejin.cn/post/7585382553290227748</link>    <guid>https://juejin.cn/post/7585382553290227748</guid>    <pubDate>2025-12-20T03:34:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290227748" data-draft-id="7585412203978031147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[kafka]伪集群搭建,各个节点配置文件中listeners参数的配置"/> <meta itemprop="keywords" content="Kafka"/> <meta itemprop="datePublished" content="2025-12-20T03:34:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="import_random"/> <meta itemprop="url" content="https://juejin.cn/user/2013961033882312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [kafka]伪集群搭建,各个节点配置文件中listeners参数的配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2013961033882312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    import_random
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T03:34:36.000Z" title="Sat Dec 20 2025 03:34:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>不是的，各个节点的 <code>listeners</code> 配置必须不同</strong>，因为它们是绑定到不同的端口上的。</p>
<h2 data-id="heading-0">一、单机伪集群配置原则</h2>
<p>在一台电脑上部署 Kafka 伪集群时：</p>
<h3 data-id="heading-1">❌ <strong>错误做法</strong>（端口冲突）：</h3>
<pre><code class="hljs language-properties" lang="properties"># 节点1
listeners=PLAINTEXT://localhost:9092,CONTROLLER://localhost:9093

# 节点2
listeners=PLAINTEXT://localhost:9092,CONTROLLER://localhost:9093  # ❌ 端口冲突！
</code></pre>
<h3 data-id="heading-2">✅ <strong>正确做法</strong>（不同端口）：</h3>
<pre><code class="hljs language-properties" lang="properties"># 节点1
listeners=PLAINTEXT://localhost:9092,CONTROLLER://localhost:9093

# 节点2  
listeners=PLAINTEXT://localhost:9095,CONTROLLER://localhost:9096  # ✅ 不同端口

# 节点3
listeners=PLAINTEXT://localhost:9098,CONTROLLER://localhost:9099  # ✅ 不同端口
</code></pre>
<h2 data-id="heading-3">二、完整单机伪集群配置示例（3节点）</h2>
<h3 data-id="heading-4"><strong>端口规划表</strong>：</h3>





























<table><thead><tr><th>节点</th><th>客户端端口</th><th>控制器端口</th><th>日志目录</th></tr></thead><tbody><tr><td>Node1</td><td>9092</td><td>9093</td><td>/tmp/kafka-logs-1</td></tr><tr><td>Node2</td><td>9095</td><td>9096</td><td>/tmp/kafka-logs-2</td></tr><tr><td>Node3</td><td>9098</td><td>9099</td><td>/tmp/kafka-logs-3</td></tr></tbody></table>
<h3 data-id="heading-5"><strong>配置文件：</strong></h3>
<h4 data-id="heading-6"><strong>config/kafka1.properties</strong>：</h4>
<pre><code class="hljs language-properties" lang="properties"># 基本配置
process.roles=broker,controller
node.id=1

# 监听器配置 - 端口 9092/9093
listeners=PLAINTEXT://localhost:9092,CONTROLLER://localhost:9093
advertised.listeners=PLAINTEXT://localhost:9092

# 数据目录
log.dirs=/tmp/kafka-logs-1

# KRaft 配置
controller.listener.names=CONTROLLER
controller.quorum.voters=1@localhost:9093,2@localhost:9096,3@localhost:9099

# 其他配置
num.network.threads=3
num.io.threads=8
socket.send.buffer.bytes=102400
socket.receive.buffer.bytes=102400
socket.request.max.bytes=104857600
num.partitions=1
num.recovery.threads.per.data.dir=1
</code></pre>
<h4 data-id="heading-7"><strong>config/kafka2.properties</strong>：</h4>
<pre><code class="hljs language-properties" lang="properties">process.roles=broker,controller
node.id=2

# 监听器配置 - 端口 9095/9096（与节点1不同！）
listeners=PLAINTEXT://localhost:9095,CONTROLLER://localhost:9096
advertised.listeners=PLAINTEXT://localhost:9095

log.dirs=/tmp/kafka-logs-2

controller.listener.names=CONTROLLER
controller.quorum.voters=1@localhost:9093,2@localhost:9096,3@localhost:9099
</code></pre>
<h4 data-id="heading-8"><strong>config/kafka3.properties</strong>：</h4>
<pre><code class="hljs language-properties" lang="properties">process.roles=broker,controller
node.id=3

# 监听器配置 - 端口 9098/9099（与其他节点不同！）
listeners=PLAINTEXT://localhost:9098,CONTROLLER://localhost:9099
advertised.listeners=PLAINTEXT://localhost:9098

log.dirs=/tmp/kafka-logs-3

controller.listener.names=CONTROLLER
controller.quorum.voters=1@localhost:9093,2@localhost:9096,3@localhost:9099
</code></pre>
<h2 data-id="heading-9">三、必须相同的配置 vs 必须不同的配置</h2>
<h3 data-id="heading-10"><strong>必须相同的配置</strong>（集群一致性）：</h3>
<pre><code class="hljs language-properties" lang="properties"># 所有节点的这些配置必须完全一致
controller.quorum.voters=1@localhost:9093,2@localhost:9096,3@localhost:9099
controller.listener.names=CONTROLLER
inter.broker.listener.name=PLAINTEXT
</code></pre>
<h3 data-id="heading-11"><strong>必须不同的配置</strong>（资源隔离）：</h3>
<pre><code class="hljs language-properties" lang="properties"># 每个节点必须不同
node.id=1                    # 唯一节点ID
listeners=...                # 不同端口
log.dirs=/tmp/kafka-logs-1   # 不同数据目录
</code></pre>
<h2 data-id="heading-12">四、启动脚本示例</h2>
<h3 data-id="heading-13"><strong>start-kafka-cluster.sh</strong>：</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 生成集群ID（首次运行时使用）</span>
CLUSTER_ID=$(./bin/kafka-storage.sh random-uuid)

<span class="hljs-built_in">echo</span> <span class="hljs-string">"集群ID: <span class="hljs-variable">$CLUSTER_ID</span>"</span>

<span class="hljs-comment"># 格式化存储目录（首次运行需要）</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"格式化存储目录..."</span>
./bin/kafka-storage.sh format -t <span class="hljs-variable">$CLUSTER_ID</span> -c config/kafka1.properties
./bin/kafka-storage.sh format -t <span class="hljs-variable">$CLUSTER_ID</span> -c config/kafka2.properties  
./bin/kafka-storage.sh format -t <span class="hljs-variable">$CLUSTER_ID</span> -c config/kafka3.properties

<span class="hljs-comment"># 启动集群（在三个不同的终端中）</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"启动节点1..."</span>
./bin/kafka-server-start.sh config/kafka1.properties &amp;

<span class="hljs-built_in">echo</span> <span class="hljs-string">"等待5秒..."</span>
<span class="hljs-built_in">sleep</span> 5

<span class="hljs-built_in">echo</span> <span class="hljs-string">"启动节点2..."</span>
./bin/kafka-server-start.sh config/kafka2.properties &amp;

<span class="hljs-built_in">echo</span> <span class="hljs-string">"等待5秒..."</span>  
<span class="hljs-built_in">sleep</span> 5

<span class="hljs-built_in">echo</span> <span class="hljs-string">"启动节点3..."</span>
./bin/kafka-storage.sh format -t <span class="hljs-variable">$CLUSTER_ID</span> -c config/kafka3.properties

<span class="hljs-built_in">echo</span> <span class="hljs-string">"集群启动完成！"</span>
</code></pre>
<h2 data-id="heading-14">五、验证集群状态</h2>
<h3 data-id="heading-15"><strong>检查端口占用</strong>：</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看所有Kafka相关端口</span>
netstat -an | grep -E <span class="hljs-string">"9092|9093|9095|9096|9098|9099"</span>

<span class="hljs-comment"># 或使用 lsof</span>
lsof -i :9092,9093,9095,9096,9098,9099
</code></pre>
<h3 data-id="heading-16"><strong>测试集群功能</strong>：</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用任意一个节点的客户端端口</span>
BOOTSTRAP_SERVER=<span class="hljs-string">"localhost:9092"</span>

<span class="hljs-comment"># 创建主题</span>
./bin/kafka-topics.sh --bootstrap-server <span class="hljs-variable">$BOOTSTRAP_SERVER</span> \
  --create --topic test-topic \
  --partitions 3 --replication-factor 3

<span class="hljs-comment"># 查看主题详情</span>
./bin/kafka-topics.sh --bootstrap-server <span class="hljs-variable">$BOOTSTRAP_SERVER</span> \
  --describe --topic test-topic

<span class="hljs-comment"># 查看集群元数据</span>
./bin/kafka-metadata-quorum.sh --bootstrap-server <span class="hljs-variable">$BOOTSTRAP_SERVER</span> \
  describe --status
</code></pre>
<h2 data-id="heading-17">六、使用 Docker Compose 的单机伪集群配置</h2>
<p>如果你更喜欢用 Docker，这里是一个 <code>docker-compose.yml</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">kafka1:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">apache/kafka:4.0.1</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">kafka1</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9092:9092"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9093:9093"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">KAFKA_NODE_ID:</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">KAFKA_PROCESS_ROLES:</span> <span class="hljs-string">"broker,controller"</span>
      <span class="hljs-attr">KAFKA_LISTENERS:</span> <span class="hljs-string">"PLAINTEXT://:9092,CONTROLLER://:9093"</span>
      <span class="hljs-attr">KAFKA_ADVERTISED_LISTENERS:</span> <span class="hljs-string">"PLAINTEXT://localhost:9092"</span>
      <span class="hljs-attr">KAFKA_CONTROLLER_LISTENER_NAMES:</span> <span class="hljs-string">"CONTROLLER"</span>
      <span class="hljs-attr">KAFKA_CONTROLLER_QUORUM_VOTERS:</span> <span class="hljs-string">"1@kafka1:9093,2@kafka2:9093,3@kafka3:9093"</span>
      <span class="hljs-attr">KAFKA_LOG_DIRS:</span> <span class="hljs-string">"/tmp/kafka-logs-1"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./kafka-data-1:/tmp/kafka-logs-1</span>

  <span class="hljs-attr">kafka2:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">apache/kafka:4.0.1</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">kafka2</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9095:9092"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9096:9093"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">KAFKA_NODE_ID:</span> <span class="hljs-number">2</span>
      <span class="hljs-attr">KAFKA_PROCESS_ROLES:</span> <span class="hljs-string">"broker,controller"</span>
      <span class="hljs-attr">KAFKA_LISTENERS:</span> <span class="hljs-string">"PLAINTEXT://:9092,CONTROLLER://:9093"</span>
      <span class="hljs-attr">KAFKA_ADVERTISED_LISTENERS:</span> <span class="hljs-string">"PLAINTEXT://localhost:9095"</span>
      <span class="hljs-attr">KAFKA_CONTROLLER_LISTENER_NAMES:</span> <span class="hljs-string">"CONTROLLER"</span>
      <span class="hljs-attr">KAFKA_CONTROLLER_QUORUM_VOTERS:</span> <span class="hljs-string">"1@kafka1:9093,2@kafka2:9093,3@kafka3:9093"</span>
      <span class="hljs-attr">KAFKA_LOG_DIRS:</span> <span class="hljs-string">"/tmp/kafka-logs-2"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./kafka-data-2:/tmp/kafka-logs-2</span>

  <span class="hljs-attr">kafka3:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">apache/kafka:4.0.1</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">kafka3</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9098:9092"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9099:9093"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">KAFKA_NODE_ID:</span> <span class="hljs-number">3</span>
      <span class="hljs-attr">KAFKA_PROCESS_ROLES:</span> <span class="hljs-string">"broker,controller"</span>
      <span class="hljs-attr">KAFKA_LISTENERS:</span> <span class="hljs-string">"PLAINTEXT://:9092,CONTROLLER://:9093"</span>
      <span class="hljs-attr">KAFKA_ADVERTISED_LISTENERS:</span> <span class="hljs-string">"PLAINTEXT://localhost:9098"</span>
      <span class="hljs-attr">KAFKA_CONTROLLER_LISTENER_NAMES:</span> <span class="hljs-string">"CONTROLLER"</span>
      <span class="hljs-attr">KAFKA_CONTROLLER_QUORUM_VOTERS:</span> <span class="hljs-string">"1@kafka1:9093,2@kafka2:9093,3@kafka3:9093"</span>
      <span class="hljs-attr">KAFKA_LOG_DIRS:</span> <span class="hljs-string">"/tmp/kafka-logs-3"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./kafka-data-3:/tmp/kafka-logs-3</span>
</code></pre>
<h2 data-id="heading-18">七、常见问题解决</h2>
<h3 data-id="heading-19"><strong>问题1：端口已占用</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 解决方案：修改端口</span>
<span class="hljs-comment"># 节点1：9092,9093 → 修改为 19092,19093</span>
<span class="hljs-comment"># 节点2：9095,9096 → 修改为 19095,19096</span>
<span class="hljs-comment"># 节点3：9098,9099 → 修改为 19098,19099</span>
</code></pre>
<h3 data-id="heading-20"><strong>问题2：启动顺序问题</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># KRaft 模式需要至少一个控制器先启动</span>
<span class="hljs-comment"># 解决方案：逐个启动，间隔几秒</span>
./bin/kafka-server-start.sh config/kafka1.properties
<span class="hljs-comment"># 等待10秒</span>
./bin/kafka-server-start.sh config/kafka2.properties
<span class="hljs-comment"># 等待10秒</span>
./bin/kafka-server-start.sh config/kafka3.properties
</code></pre>
<h3 data-id="heading-21"><strong>问题3：数据目录冲突</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 解决方案：使用不同的目录</span>
log.dirs=/tmp/kafka-cluster/node1
log.dirs=/tmp/kafka-cluster/node2
log.dirs=/tmp/kafka-cluster/node3
</code></pre>
<h2 data-id="heading-22">八、简化的配置方法（使用脚本自动生成）</h2>
<h3 data-id="heading-23"><strong>generate-configs.sh</strong>：</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

BASE_PORT=9092
CONTROLLER_BASE_PORT=9093
NODES=3

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">seq</span> 1 <span class="hljs-variable">$NODES</span>); <span class="hljs-keyword">do</span>
  CLIENT_PORT=$((BASE_PORT + (i-<span class="hljs-number">1</span>)*<span class="hljs-number">3</span>))
  CONTROLLER_PORT=$((CONTROLLER_BASE_PORT + (i-<span class="hljs-number">1</span>)*<span class="hljs-number">3</span>))
  
  <span class="hljs-built_in">cat</span> &gt; config/kafka<span class="hljs-variable">$i</span>.properties &lt;&lt; <span class="hljs-string">EOF
# 自动生成的配置 - 节点$i
process.roles=broker,controller
node.id=$i

listeners=PLAINTEXT://localhost:$CLIENT_PORT,CONTROLLER://localhost:$CONTROLLER_PORT
advertised.listeners=PLAINTEXT://localhost:$CLIENT_PORT

log.dirs=/tmp/kafka-logs-$i

controller.listener.names=CONTROLLER
controller.quorum.voters=1@localhost:9093,2@localhost:9096,3@localhost:9099

num.partitions=3
default.replication.factor=3
min.insync.replicas=2
EOF</span>
  
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"生成 config/kafka<span class="hljs-variable">$i</span>.properties: client_port=<span class="hljs-variable">$CLIENT_PORT</span>, controller_port=<span class="hljs-variable">$CONTROLLER_PORT</span>"</span>
<span class="hljs-keyword">done</span>
</code></pre>
<p><strong>总结关键点</strong>：</p>
<ol>
<li>✅ <strong>每个节点必须有唯一的端口组合</strong></li>
<li>✅ <strong><code>controller.quorum.voters</code> 必须完全相同</strong></li>
<li>✅ <strong>数据目录必须不同</strong></li>
<li>✅ <strong>节点ID必须唯一</strong></li>
<li>❌ <strong>不要复用端口</strong>，一台机器上的端口不能重复绑定</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TanStack Router 基于文件的路由]]></title>    <link>https://juejin.cn/post/7585400495683305514</link>    <guid>https://juejin.cn/post/7585400495683305514</guid>    <pubDate>2025-12-20T02:17:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585400495683305514" data-draft-id="7585397173022982163" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TanStack Router 基于文件的路由"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T02:17:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TanStack Router 基于文件的路由
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T02:17:28.000Z" title="Sat Dec 20 2025 02:17:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>TanStack Router 的大部分文档都是基于“基于文件的路由”这一视角编写的，旨在帮助你深入理解如何配置它以及其背后的技术细节。虽然<strong>基于文件的路由是配置 TanStack Router 的首选和推荐方式</strong>，但如果你愿意，也可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Frouter%2Fv1%2Fdocs%2Fframework%2Freact%2Frouting%2Fcode-based-routing" target="_blank" title="https://tanstack.com/router/v1/docs/framework/react/routing/code-based-routing" ref="nofollow noopener noreferrer">基于代码的路由</a>。</p>
<h2 data-id="heading-0">什么是基于文件的路由？</h2>
<p>基于文件的路由是一种利用文件系统来配置路由的方式。你不需要通过代码定义路由结构，而是通过一系列代表应用程序路由层级的文件和目录来定义路由。这带来了许多好处：</p>
<ul>
<li>
<p><strong>简单性 (Simplicity)</strong>：对于新手和经验丰富的开发者来说，基于文件的路由都在视觉上更直观且易于理解。</p>
</li>
<li>
<p><strong>组织性 (Organization)</strong>：路由的组织方式直接镜像了应用程序的 URL 结构。</p>
</li>
<li>
<p><strong>可扩展性 (Scalability)</strong>：随着应用程序的增长，基于文件的路由使得添加新路由和维护现有路由变得容易。</p>
</li>
<li>
<p><strong>代码分割 (Code-Splitting)</strong>：基于文件的路由允许 TanStack Router 自动对路由进行代码分割，以获得更好的性能。</p>
</li>
<li>
<p><strong>类型安全 (Type-Safety)</strong>：基于文件的路由通过自动生成和管理路由的类型链接，极大提升了类型安全的上限，而在基于代码的路由中，这通常是一个繁琐的过程。</p>
</li>
<li>
<p><strong>一致性 (Consistency)</strong>：基于文件的路由强制执行一致的路由结构，使得维护、更新应用程序以及在不同项目间迁移变得更加容易。</p>
</li>
</ul>
<h2 data-id="heading-1"><code>/</code> 还是 <code>.</code> ？</h2>
<p>虽然目录长期以来一直用于表示路由层级，但基于文件的路由引入了一个额外的概念：在文件名中使用 <code>.</code> 字符来表示路由嵌套。这允许你避免为少量深度嵌套的路由创建目录，同时继续为更广泛的路由层级使用目录。让我们看一些例子！</p>
<h2 data-id="heading-2">目录路由 (Directory Routes)</h2>
<p>目录可用于表示路由层级，这对于将多个路由组织成逻辑组以及减少大量深度嵌套路由的文件名长度非常有用。</p>
<p>请看下面的例子：</p>





























































































































<table><thead><tr><th><strong>文件名 (Filename)</strong></th><th><strong>路由路径 (Route Path)</strong></th><th><strong>组件输出 (Component Output)</strong></th></tr></thead><tbody><tr><td>ʦ <code>__root.tsx</code></td><td/><td><code>&lt;Root&gt;</code></td></tr><tr><td>ʦ <code>index.tsx</code></td><td><code>/</code> (精确匹配)</td><td><code>&lt;Root&gt;&lt;RootIndex&gt;</code></td></tr><tr><td>ʦ <code>about.tsx</code></td><td><code>/about</code></td><td><code>&lt;Root&gt;&lt;About&gt;</code></td></tr><tr><td>ʦ <code>posts.tsx</code></td><td><code>/posts</code></td><td><code>&lt;Root&gt;&lt;Posts&gt;</code></td></tr><tr><td>📂 <code>posts</code></td><td/><td/></tr><tr><td>┄ ʦ <code>index.tsx</code></td><td><code>/posts</code> (精确匹配)</td><td><code>&lt;Root&gt;&lt;Posts&gt;&lt;PostsIndex&gt;</code></td></tr><tr><td>┄ ʦ <code>$postId.tsx</code></td><td><code>/posts/$postId</code></td><td><code>&lt;Root&gt;&lt;Posts&gt;&lt;Post&gt;</code></td></tr><tr><td>📂 <code>posts_</code></td><td/><td/></tr><tr><td>┄ 📂 <code>$postId</code></td><td/><td/></tr><tr><td>┄ ┄ ʦ <code>edit.tsx</code></td><td><code>/posts/$postId/edit</code></td><td><code>&lt;Root&gt;&lt;EditPost&gt;</code></td></tr><tr><td>ʦ <code>settings.tsx</code></td><td><code>/settings</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;</code></td></tr><tr><td>📂 <code>settings</code></td><td/><td/></tr><tr><td>┄ ʦ <code>profile.tsx</code></td><td><code>/settings/profile</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;&lt;Profile&gt;</code></td></tr><tr><td>┄ ʦ <code>notifications.tsx</code></td><td><code>/settings/notifications</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;&lt;Notifications&gt;</code></td></tr><tr><td>ʦ <code>_pathlessLayout.tsx</code></td><td/><td><code>&lt;Root&gt;&lt;PathlessLayout&gt;</code></td></tr><tr><td>📂 <code>_pathlessLayout</code></td><td/><td/></tr><tr><td>┄ ʦ <code>route-a.tsx</code></td><td><code>/route-a</code></td><td><code>&lt;Root&gt;&lt;PathlessLayout&gt;&lt;RouteA&gt;</code></td></tr><tr><td>┄ ʦ <code>route-b.tsx</code></td><td><code>/route-b</code></td><td><code>&lt;Root&gt;&lt;PathlessLayout&gt;&lt;RouteB&gt;</code></td></tr><tr><td>📂 <code>files</code></td><td/><td/></tr><tr><td>┄ ʦ <code>$.tsx</code></td><td><code>/files/$</code></td><td><code>&lt;Root&gt;&lt;Files&gt;</code></td></tr><tr><td>📂 <code>account</code></td><td/><td/></tr><tr><td>┄ ʦ <code>route.tsx</code></td><td><code>/account</code></td><td><code>&lt;Root&gt;&lt;Account&gt;</code></td></tr><tr><td>┄ ʦ <code>overview.tsx</code></td><td><code>/account/overview</code></td><td><code>&lt;Root&gt;&lt;Account&gt;&lt;Overview&gt;</code></td></tr></tbody></table>
<h2 data-id="heading-3">扁平路由 (Flat Routes)</h2>
<p>扁平路由赋予你使用 <code>.</code> 来表示路由嵌套层级的能力。</p>
<p>当你有大量独特的深度嵌套路由，并且希望避免为每一个路由都创建目录时，这非常有用：</p>
<p>请看下面的例子：</p>


























































































<table><thead><tr><th><strong>文件名 (Filename)</strong></th><th><strong>路由路径 (Route Path)</strong></th><th><strong>组件输出 (Component Output)</strong></th></tr></thead><tbody><tr><td>ʦ <code>__root.tsx</code></td><td/><td><code>&lt;Root&gt;</code></td></tr><tr><td>ʦ <code>index.tsx</code></td><td><code>/</code> (精确匹配)</td><td><code>&lt;Root&gt;&lt;RootIndex&gt;</code></td></tr><tr><td>ʦ <code>about.tsx</code></td><td><code>/about</code></td><td><code>&lt;Root&gt;&lt;About&gt;</code></td></tr><tr><td>ʦ <code>posts.tsx</code></td><td><code>/posts</code></td><td><code>&lt;Root&gt;&lt;Posts&gt;</code></td></tr><tr><td>ʦ <code>posts.index.tsx</code></td><td><code>/posts</code> (精确匹配)</td><td><code>&lt;Root&gt;&lt;Posts&gt;&lt;PostsIndex&gt;</code></td></tr><tr><td>ʦ <code>posts.$postId.tsx</code></td><td><code>/posts/$postId</code></td><td><code>&lt;Root&gt;&lt;Posts&gt;&lt;Post&gt;</code></td></tr><tr><td>ʦ <code>posts_.$postId.edit.tsx</code></td><td><code>/posts/$postId/edit</code></td><td><code>&lt;Root&gt;&lt;EditPost&gt;</code></td></tr><tr><td>ʦ <code>settings.tsx</code></td><td><code>/settings</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;</code></td></tr><tr><td>ʦ <code>settings.profile.tsx</code></td><td><code>/settings/profile</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;&lt;Profile&gt;</code></td></tr><tr><td>ʦ <code>settings.notifications.tsx</code></td><td><code>/settings/notifications</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;&lt;Notifications&gt;</code></td></tr><tr><td>ʦ <code>_pathlessLayout.tsx</code></td><td/><td><code>&lt;Root&gt;&lt;PathlessLayout&gt;</code></td></tr><tr><td>ʦ <code>_pathlessLayout.route-a.tsx</code></td><td><code>/route-a</code></td><td><code>&lt;Root&gt;&lt;PathlessLayout&gt;&lt;RouteA&gt;</code></td></tr><tr><td>ʦ <code>_pathlessLayout.route-b.tsx</code></td><td><code>/route-b</code></td><td><code>&lt;Root&gt;&lt;PathlessLayout&gt;&lt;RouteB&gt;</code></td></tr><tr><td>ʦ <code>files.$.tsx</code></td><td><code>/files/$</code></td><td><code>&lt;Root&gt;&lt;Files&gt;</code></td></tr><tr><td>ʦ <code>account.tsx</code></td><td><code>/account</code></td><td><code>&lt;Root&gt;&lt;Account&gt;</code></td></tr><tr><td>ʦ <code>account.overview.tsx</code></td><td><code>/account/overview</code></td><td><code>&lt;Root&gt;&lt;Account&gt;&lt;Overview&gt;</code></td></tr></tbody></table>
<h2 data-id="heading-4">混合扁平路由和目录路由</h2>
<p>极有可能 100% 的目录结构或 100% 的扁平路由结构都不完全适合你的项目，这就是为什么 TanStack Router 允许你将扁平路由和目录路由<strong>混合使用</strong>，从而创建一个结合两者优点的路由树。</p>
<p>请看下面的例子：</p>











































































<table><thead><tr><th><strong>文件名 (Filename)</strong></th><th><strong>路由路径 (Route Path)</strong></th><th><strong>组件输出 (Component Output)</strong></th></tr></thead><tbody><tr><td>ʦ <code>__root.tsx</code></td><td/><td><code>&lt;Root&gt;</code></td></tr><tr><td>ʦ <code>index.tsx</code></td><td><code>/</code> (精确匹配)</td><td><code>&lt;Root&gt;&lt;RootIndex&gt;</code></td></tr><tr><td>ʦ <code>about.tsx</code></td><td><code>/about</code></td><td><code>&lt;Root&gt;&lt;About&gt;</code></td></tr><tr><td>ʦ <code>posts.tsx</code></td><td><code>/posts</code></td><td><code>&lt;Root&gt;&lt;Posts&gt;</code></td></tr><tr><td>📂 <code>posts</code></td><td/><td/></tr><tr><td>┄ ʦ <code>index.tsx</code></td><td><code>/posts</code> (精确匹配)</td><td><code>&lt;Root&gt;&lt;Posts&gt;&lt;PostsIndex&gt;</code></td></tr><tr><td>┄ ʦ <code>$postId.tsx</code></td><td><code>/posts/$postId</code></td><td><code>&lt;Root&gt;&lt;Posts&gt;&lt;Post&gt;</code></td></tr><tr><td>┄ ʦ <code>$postId.edit.tsx</code></td><td><code>/posts/$postId/edit</code></td><td><code>&lt;Root&gt;&lt;Posts&gt;&lt;Post&gt;&lt;EditPost&gt;</code></td></tr><tr><td>ʦ <code>settings.tsx</code></td><td><code>/settings</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;</code></td></tr><tr><td>ʦ <code>settings.profile.tsx</code></td><td><code>/settings/profile</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;&lt;Profile&gt;</code></td></tr><tr><td>ʦ <code>settings.notifications.tsx</code></td><td><code>/settings/notifications</code></td><td><code>&lt;Root&gt;&lt;Settings&gt;&lt;Notifications&gt;</code></td></tr><tr><td>ʦ <code>account.tsx</code></td><td><code>/account</code></td><td><code>&lt;Root&gt;&lt;Account&gt;</code></td></tr><tr><td>ʦ <code>account.overview.tsx</code></td><td><code>/account/overview</code></td><td><code>&lt;Root&gt;&lt;Account&gt;&lt;Overview&gt;</code></td></tr></tbody></table>
<p>扁平路由和目录路由可以混合在一起，以便在合理的地方结合两者的优点来创建路由树。</p>
<blockquote>
<p>[!TIP]</p>
<p>如果你发现默认的基于文件的路由结构不符合你的需求，你始终可以使用 虚拟文件路由 (Virtual File Routes) 来控制路由的来源，同时仍然享受基于文件路由带来的出色性能优势。</p>
</blockquote>
<h2 data-id="heading-5">开始使用基于文件的路由</h2>
<p>要开始使用基于文件的路由，你需要配置你项目的打包工具（Bundler）以使用 TanStack Router Plugin 或 TanStack Router CLI。</p>
<p>要启用基于文件的路由，你需要在使用 React 的同时使用受支持的打包工具。请查看下面的配置指南，看看你的打包工具是否在列表中。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Frouter%2Fv1%2Fdocs%2Fframework%2Freact%2Finstallation%2Fwith-vite" target="_blank" title="https://tanstack.com/router/v1/docs/framework/react/installation/with-vite" ref="nofollow noopener noreferrer">Installation with Vite</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Frouter%2Fv1%2Fdocs%2Fframework%2Freact%2Finstallation%2Fwith-rspack" target="_blank" title="https://tanstack.com/router/v1/docs/framework/react/installation/with-rspack" ref="nofollow noopener noreferrer">Installation with Rspack/Rsbuild</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Frouter%2Fv1%2Fdocs%2Fframework%2Freact%2Finstallation%2Fwith-webpack" target="_blank" title="https://tanstack.com/router/v1/docs/framework/react/installation/with-webpack" ref="nofollow noopener noreferrer">Installation with Webpack</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Frouter%2Fv1%2Fdocs%2Fframework%2Freact%2Finstallation%2Fwith-esbuild" target="_blank" title="https://tanstack.com/router/v1/docs/framework/react/installation/with-esbuild" ref="nofollow noopener noreferrer">Installation with Esbuild</a></li>
</ul>
<p>当通过受支持的打包工具使用 TanStack Router 的基于文件的路由时，插件将<strong>通过打包工具的开发和构建过程自动生成你的路由配置</strong>。这是使用 TanStack Router 路由生成功能最简单的方法。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 Windows 上正确安装 OpenAI Codex CLI：一次完整的 pnpm 全局环境修复实录]]></title>    <link>https://juejin.cn/post/7585206349749502004</link>    <guid>https://juejin.cn/post/7585206349749502004</guid>    <pubDate>2025-12-19T11:00:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585206349749502004" data-draft-id="7585394082822832162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 Windows 上正确安装 OpenAI Codex CLI：一次完整的 pnpm 全局环境修复实录"/> <meta itemprop="keywords" content="OpenAI,后端"/> <meta itemprop="datePublished" content="2025-12-19T11:00:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sdguy"/> <meta itemprop="url" content="https://juejin.cn/user/1416608279436087"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 Windows 上正确安装 OpenAI Codex CLI：一次完整的 pnpm 全局环境修复实录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1416608279436087/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sdguy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T11:00:37.000Z" title="Fri Dec 19 2025 11:00:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">在 Windows 上正确安装 OpenAI Codex CLI：一次完整的 pnpm 全局环境修复实录</h2>
<blockquote>
<p>本文记录了一次在 <strong>Windows + pnpm 环境下安装 OpenAI Codex CLI</strong> 的完整踩坑与修复过程。<br/>
如果你遇到过 <code>pnpm global</code> 失败、<code>NO_GLOBAL_BIN_DIR</code>、安装卡死、PATH 混乱等问题，这篇文章可以作为一份<strong>可复用的工程级解决方案</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、问题背景：Codex 安装为什么会这么“折磨”</h3>
<p>我最初的目标非常简单：</p>
<pre><code class="hljs language-css" lang="css">pnpm <span class="hljs-selector-tag">i</span> -g <span class="hljs-keyword">@openai</span>/codex
</code></pre>
<p>结果却遇到了以下问题组合：</p>
<ul>
<li>pnpm 报错：<code>ERR_PNPM_NO_GLOBAL_BIN_DIR</code></li>
<li>npm / pnpm 全局安装长时间“转圈”</li>
<li>Windows 下 PATH / 全局 bin 行为不透明</li>
<li>即使安装成功，也无法确认 <code>codex</code> 是否真正可用</li>
</ul>
<p>这类问题并不是 Codex 独有，而是 <strong>Windows + Node 全局工具链</strong> 的系统性问题。</p>
<hr/>
<h3 data-id="heading-2">二、核心结论先行（给着急的人）</h3>
<p>如果你只关心最终答案：</p>
<blockquote>
<p><strong>在 Windows 上使用 pnpm 全局 CLI 的前提是：必须正确初始化 <code>PNPM_HOME</code>，并确保全局 bin 被实际生成。</strong></p>
</blockquote>
<p>Codex 安装失败，<strong>90% 不是 Codex 的问题，而是 pnpm 全局环境未就绪</strong>。</p>
<hr/>
<h3 data-id="heading-3">三、第一步：正确初始化 pnpm 全局环境（关键）</h3>
<h4 data-id="heading-4">1️⃣ 执行 pnpm 官方初始化命令</h4>
<pre><code class="hljs language-arduino" lang="arduino">pnpm setup
</code></pre>
<p>成功后，pnpm 会：</p>
<ul>
<li>创建 <code>PNPM_HOME</code></li>
<li>修改用户级 PATH</li>
<li>输出提示：<strong>需要重开终端</strong></li>
</ul>
<p>⚠️ <strong>这一步之后必须关闭 PowerShell 窗口并重新打开</strong></p>
<hr/>
<h4 data-id="heading-5">2️⃣ 验证环境变量是否生效</h4>
<p>重新打开 PowerShell 后执行：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-variable">$env</span>:PNPM_HOME
pnpm -v
</code></pre>
<p>期望结果类似：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">C:\Users\xxx\AppData\Local\pnpm</span>
10.x.x
</code></pre>
<hr/>
<h3 data-id="heading-6">四、一个容易误判的点：PNPM_HOME 里只有 <code>store/</code> 正常吗？</h3>
<p>刚完成 <code>pnpm setup</code> 后，我看到的目录是：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">C:\Users\xxx\AppData\Local\pnpm</span>
└── store/
</code></pre>
<p><strong>这是正常的，但还不算“完成”</strong> 。</p>
<p>原因是：</p>
<blockquote>
<p>pnpm 只有在 <strong>第一次发生全局安装行为时</strong>，才会生成全局可执行文件（pnpm / pnpx shim）。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">五、触发 pnpm 全局 bin 初始化（v10 正确方式）</h3>
<p>在 pnpm v10 之后：</p>
<ul>
<li>❌ 不再允许 <code>pnpm add -g pnpm</code></li>
<li>✅ 正确方式是：</li>
</ul>
<pre><code class="hljs language-lua" lang="lua">pnpm <span class="hljs-built_in">self</span>-update
</code></pre>
<p>执行完成后，再查看：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">ls</span> <span class="hljs-variable">$env</span>:PNPM_HOME
</code></pre>
<p>此时应该能看到类似内容：</p>
<pre><code class="hljs language-swift" lang="swift">.tools<span class="hljs-operator">/</span>
store<span class="hljs-operator">/</span>
pnpm
pnpm.<span class="hljs-type">CMD</span>
pnpx
pnpx.<span class="hljs-type">CMD</span>
</code></pre>
<p>这一步是 <strong>pnpm 全局环境真正就绪的标志</strong>。</p>
<hr/>
<h3 data-id="heading-8">六、验证 pnpx 是否可用（重要验收点）</h3>
<p>不要用 <code>pnpx --version</code>（这是不支持的）。</p>
<p>正确的验证方式是：</p>
<pre><code class="hljs">pnpx cowsay hello
</code></pre>
<p>如果你看到一只牛输出 <code>hello</code>，说明：</p>
<ul>
<li>PNPM_HOME ✔</li>
<li>PATH ✔</li>
<li>pnpx / dlx 执行链 ✔</li>
</ul>
<hr/>
<h3 data-id="heading-9">七、正式安装 OpenAI Codex CLI（可观测方式）</h3>
<h4 data-id="heading-10">1️⃣（可选但强烈推荐）设置国内 registry</h4>
<pre><code class="hljs language-arduino" lang="arduino">pnpm config set registry https:<span class="hljs-comment">//registry.npmmirror.com</span>
</code></pre>
<p>避免 100MB+ 包下载卡死。</p>
<hr/>
<h4 data-id="heading-11">2️⃣ 安装 Codex（带 ndjson 日志）</h4>
<pre><code class="hljs language-sql" lang="sql">pnpm <span class="hljs-keyword">add</span> <span class="hljs-operator">-</span>g <span class="hljs-variable">@openai</span><span class="hljs-operator">/</span>codex <span class="hljs-comment">--reporter ndjson</span>
</code></pre>
<p>在日志中你应该能看到：</p>
<ul>
<li><code>@openai/codex@x.y.z</code> resolved</li>
<li>fetched（完整下载）</li>
<li>imported</li>
<li>linked</li>
<li>没有 postinstall 错误</li>
</ul>
<hr/>
<h3 data-id="heading-12">八、Codex 是否真正安装成功？最终验收标准</h3>
<p><strong>不要只看安装日志，看这一步：</strong></p>
<pre><code class="hljs language-bash" lang="bash">codex --<span class="hljs-built_in">help</span>
</code></pre>
<p>如果你能看到完整的 CLI 帮助，例如：</p>
<ul>
<li><code>exec</code></li>
<li><code>review</code></li>
<li><code>mcp / mcp-server</code></li>
<li><code>sandbox</code></li>
<li><code>apply</code></li>
<li><code>--version</code></li>
</ul>
<p>👉 <strong>这意味着 Codex CLI 已 100% 可用</strong></p>
<hr/>
<h3 data-id="heading-13">九、关于 <code>where codex</code> 没有输出的说明</h3>
<p>在 Windows + pnpm 场景下：</p>
<ul>
<li>可执行文件通常是 <code>codex.CMD</code></li>
<li>PowerShell 的 <code>where</code> 有时不会显示 shim</li>
<li><strong>只要 <code>codex</code> 能直接运行，就不是问题</strong></li>
</ul>
<hr/>
<h3 data-id="heading-14">十、登录与使用</h3>
<p>首次使用前执行：</p>
<pre><code class="hljs">codex login
</code></pre>
<p>认证信息会保存在 <code>~/.codex/</code>，不污染环境变量。</p>
<hr/>
<h3 data-id="heading-15">十一、一些经验总结（非常重要）</h3>
<h4 data-id="heading-16">1️⃣ 不要急着怪 Codex</h4>
<ul>
<li>Codex 安装慢 / 失败<br/>
→ <strong>99% 是 Node 全局环境问题</strong></li>
</ul>
<h4 data-id="heading-17">2️⃣ Windows 下推荐顺序</h4>
<pre><code class="hljs language-sql" lang="sql">pnpm setup
→ 重开终端
→ pnpm self<span class="hljs-operator">-</span><span class="hljs-keyword">update</span>
→ pnpx 验证
→ pnpm <span class="hljs-keyword">add</span> <span class="hljs-operator">-</span>g <span class="hljs-variable">@openai</span><span class="hljs-operator">/</span>codex
</code></pre>
<h4 data-id="heading-18">3️⃣ 如果只是“想用”，npx / pnpx 也是合理选择</h4>
<pre><code class="hljs language-bash" lang="bash">pnpx @openai/codex
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TanStack Router 文件命名约定]]></title>    <link>https://juejin.cn/post/7585382553290063908</link>    <guid>https://juejin.cn/post/7585382553290063908</guid>    <pubDate>2025-12-20T02:20:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290063908" data-draft-id="7585382553290047524" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TanStack Router 文件命名约定"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T02:20:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TanStack Router 文件命名约定
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T02:20:25.000Z" title="Sat Dec 20 2025 02:20:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>基于文件的路由要求你遵循一些简单的文件命名约定，以确保正确生成路由。这些约定所启用的概念在 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Frouter%2Fv1%2Fdocs%2Fframework%2Freact%2Frouting%2Froute-trees" target="_blank" title="https://tanstack.com/router/v1/docs/framework/react/routing/route-trees" ref="nofollow noopener noreferrer">路由树与嵌套</a> 指南中有详细介绍。</p>

















































<table><thead><tr><th><strong>特性 (Feature)</strong></th><th><strong>描述 (Description)</strong></th></tr></thead><tbody><tr><td><strong><code>__root.tsx</code></strong></td><td>根路由文件必须命名为 <code>__root.tsx</code>，并且必须放置在配置的 <code>routesDirectory</code> 的根目录下。</td></tr><tr><td><strong><code>.</code> 分隔符</strong></td><td>路由可以使用 <code>.</code> 字符来表示嵌套路由。例如，<code>blog.post</code> 将生成为 <code>blog</code> 的子路由。</td></tr><tr><td><strong><code>$</code> 标记</strong></td><td>带有 <code>$</code> 标记的路由片段是参数化的，并将从 URL 路径名中提取值作为路由 <code>param</code>（参数）。</td></tr><tr><td><strong><code>_</code> 前缀</strong></td><td>带有 <code>_</code> 前缀的路由片段被视为<strong>无路径布局路由</strong>，在将子路由与 URL 路径名匹配时不会使用它。</td></tr><tr><td><strong><code>_</code> 后缀</strong></td><td>带有 <code>_</code> 后缀的路由片段将该路由排除在任何父路由的嵌套之外（即非嵌套路由）。</td></tr><tr><td><strong><code>-</code> 前缀</strong></td><td>带有 <code>-</code> 前缀的文件和文件夹将从路由树中<strong>排除</strong>。它们不会被添加到 <code>routeTree.gen.ts</code> 文件中，可用于在路由文件夹中共存逻辑代码。</td></tr><tr><td><strong><code>(folder)</code> 文件夹名模式</strong></td><td>匹配此模式的文件夹被视为<strong>路由组</strong>，防止该文件夹包含在路由的 URL 路径中。</td></tr><tr><td><strong><code>[x]</code> 转义</strong></td><td>方括号用于转义文件名中具有路由含义的特殊字符。例如，<code>script[.]js.tsx</code> 变为 <code>/script.js</code>，<code>api[.]v1.tsx</code> 变为 <code>/api.v1</code>。</td></tr><tr><td><strong><code>index</code> 标记</strong></td><td>以 <code>index</code> 标记结尾（在任何文件扩展名之前）的路由片段，当 URL 路径名精确匹配父路由时，将匹配父路由。这可以通过 <code>indexToken</code> 配置选项进行配置，参见 [suspicious link removed]。</td></tr><tr><td><strong><code>.route.tsx</code> 文件类型</strong></td><td>当使用目录组织路由时，<code>route</code> 后缀可用于在目录路径处创建路由文件。例如，<code>blog.post.route.tsx</code> 或 <code>blog/post/route.tsx</code> 可用作 <code>/blog/post</code> 路由的路由文件。这可以通过 <code>routeToken</code> 配置选项进行配置，参见 [suspicious link removed]。</td></tr></tbody></table>
<blockquote>
<p><strong>💡 记住：</strong> 项目的文件命名约定可能会受到所配置的 [suspicious link removed] 的影响。</p>
</blockquote>
<blockquote>
<p>[!NOTE]</p>
<p>要转义尾随下划线（例如 /posts[_].tsx），需要使用升级后的 非嵌套路由。</p>
</blockquote>
<h2 data-id="heading-0">动态路径参数 (Dynamic Path Params)</h2>
<p>动态路径参数可用于扁平路由和目录路由，以创建可以匹配 URL 路径动态片段的路由。动态路径参数由文件名中的 <code>$</code> 字符表示：</p>




















<table><thead><tr><th><strong>文件名 (Filename)</strong></th><th><strong>路由路径 (Route Path)</strong></th><th><strong>组件输出 (Component Output)</strong></th></tr></thead><tbody><tr><td>...</td><td>...</td><td>...</td></tr><tr><td>ʦ <code>posts.$postId.tsx</code></td><td><code>/posts/$postId</code></td><td><code>&lt;Root&gt;&lt;Posts&gt;&lt;Post&gt;</code></td></tr></tbody></table>
<p>我们将在 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Frouter%2Fv1%2Fdocs%2Fframework%2Freact%2Fguide%2Fpath-params" target="_blank" title="https://tanstack.com/router/v1/docs/framework/react/guide/path-params" ref="nofollow noopener noreferrer">路径参数</a> 指南中了解更多关于动态路径参数的信息。</p>
<h2 data-id="heading-1">无路径路由 (Pathless Routes)</h2>
<p>无路径路由用逻辑或组件包裹子路由，而不需要 URL 路径。无路径路由由文件名中的 <code>_</code> 字符表示：</p>

























<table><thead><tr><th><strong>文件名 (Filename)</strong></th><th><strong>路由路径 (Route Path)</strong></th><th><strong>组件输出 (Component Output)</strong></th></tr></thead><tbody><tr><td>ʦ <code>_app.tsx</code></td><td/><td/></tr><tr><td>ʦ <code>_app.a.tsx</code></td><td>/a</td><td><code>&lt;Root&gt;&lt;App&gt;&lt;A&gt;</code></td></tr><tr><td>ʦ <code>_app.b.tsx</code></td><td>/b</td><td><code>&lt;Root&gt;&lt;App&gt;&lt;B&gt;</code></td></tr></tbody></table>
<p>要了解更多关于无路径路由的信息，请参阅 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Frouter%2Fv1%2Fdocs%2Fframework%2Freact%2Frouting%2Frouting-concepts%23pathless-layout-routes" target="_blank" title="https://tanstack.com/router/v1/docs/framework/react/routing/routing-concepts#pathless-layout-routes" ref="nofollow noopener noreferrer">路由概念 - 无路径路由</a> 指南。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[升级二进制kubernetes集群（小版本升级）]]></title>    <link>https://juejin.cn/post/7585395972294148105</link>    <guid>https://juejin.cn/post/7585395972294148105</guid>    <pubDate>2025-12-19T11:25:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585395972294148105" data-draft-id="7585406229167587378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="升级二进制kubernetes集群（小版本升级）"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-12-19T11:25:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小陈运维"/> <meta itemprop="url" content="https://juejin.cn/user/3315782802482007"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            升级二进制kubernetes集群（小版本升级）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3315782802482007/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小陈运维
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T11:25:29.000Z" title="Fri Dec 19 2025 11:25:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">升级二进制kubernetes集群（小版本升级）</h2>
<p>此文档基于我的二进制安装仓库
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcby-chen%2FKubernetes" target="_blank" title="https://github.com/cby-chen/Kubernetes" ref="nofollow noopener noreferrer">github.com/cby-chen/Ku…</a></p>
<h3 data-id="heading-1">基础操作</h3>
<h4 data-id="heading-2">查看当前版本信息</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# kubectl  get node
NAME           STATUS   ROLES    AGE    VERSION
k8s-master01   Ready    &lt;none&gt;   110d   v1.34.0
k8s-master02   Ready    &lt;none&gt;   110d   v1.34.0
k8s-master03   Ready    &lt;none&gt;   110d   v1.34.0
k8s-node01     Ready    &lt;none&gt;   110d   v1.34.0
k8s-node02     Ready    &lt;none&gt;   110d   v1.34.0
[root@k8s-master01 ~]# 
</code></pre>
<h4 data-id="heading-3">主机域名以及IP地址</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# cat /etc/hosts | grep k8s
192.168.1.31 k8s-master01
192.168.1.32 k8s-master02
192.168.1.33 k8s-master03
192.168.1.34 k8s-node01
192.168.1.35 k8s-node02
fc00::31 k8s-master01
fc00::32 k8s-master02
fc00::33 k8s-master03
fc00::34 k8s-node01
fc00::35 k8s-node02
[root@k8s-master01 ~]# 
</code></pre>
<h4 data-id="heading-4">下载二进制安装包</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# wget https://dl.k8s.io/v1.34.3/kubernetes-server-linux-amd64.tar.gz
[root@k8s-master01 ~]# wget https://dl.k8s.io/v1.35.0/kubernetes-server-linux-amd64.tar.gz
[root@k8s-master01 ~]#
</code></pre>
<h4 data-id="heading-5">解压二进制安装包</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# tar xf kubernetes-server-linux-amd64.tar.gz
[root@k8s-master01 ~]# 
</code></pre>
<h3 data-id="heading-6">升级Maser</h3>
<h4 data-id="heading-7">升级三台主节点上的客户端</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# scp kubernetes/server/bin/kubectl root@192.168.1.31:/usr/local/bin/
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# scp kubernetes/server/bin/kubectl root@192.168.1.32:/usr/local/bin/
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# scp kubernetes/server/bin/kubectl root@192.168.1.33:/usr/local/bin/
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# kubectl version
Client Version: v1.34.3
Kustomize Version: v5.7.1
Server Version: v1.34.0
[root@k8s-master01 ~]# 
</code></pre>
<h4 data-id="heading-8">升级三台主节点api组件</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl stop kube-apiserver"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# scp kubernetes/server/bin/kube-apiserver root@192.168.1.31:/usr/local/bin/
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl start kube-apiserver"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl status kube-apiserver"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# kube-apiserver --version
Kubernetes v1.34.3
[root@k8s-master01 ~]# 

</code></pre>
<h4 data-id="heading-9">升级三台主节点控制器组件</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl stop kube-controller-manager"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# scp kubernetes/server/bin/kube-controller-manager root@192.168.1.31:/usr/local/bin/
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl start kube-controller-manager"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl status kube-controller-manager"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# kube-controller-manager --version
Kubernetes v1.34.3
[root@k8s-master01 ~]# 
</code></pre>
<h4 data-id="heading-10">升级三台主节点选择器组件</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl stop kube-scheduler"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# scp kubernetes/server/bin/kube-scheduler root@192.168.1.31:/usr/local/bin/
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl start kube-scheduler"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl status kube-scheduler"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# kube-scheduler --version
Kubernetes v1.34.3
[root@k8s-master01 ~]# 
</code></pre>
<h3 data-id="heading-11">升级Worker</h3>
<h4 data-id="heading-12">每一台机器都要升级kubelet</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl stop kubelet"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# scp kubernetes/server/bin/kubelet root@192.168.1.31:/usr/local/bin/
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl start kubelet"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl status kubelet"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "kubelet --version"
Kubernetes v1.34.3
[root@k8s-master01 ~]#
</code></pre>
<h4 data-id="heading-13">每一台机器都要升级kube-proxy</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl stop kube-proxy"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# scp kubernetes/server/bin/kube-proxy root@192.168.1.31:/usr/local/bin/
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl start kube-proxy"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# ssh root@192.168.1.31 "systemctl status kube-proxy"
[root@k8s-master01 ~]#
[root@k8s-master01 ~]# kube-proxy --version
</code></pre>
<h3 data-id="heading-14">验证</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# kubectl  get node
NAME           STATUS   ROLES    AGE    VERSION
k8s-master01   Ready    &lt;none&gt;   110d   v1.34.3
k8s-master02   Ready    &lt;none&gt;   110d   v1.34.3
k8s-master03   Ready    &lt;none&gt;   110d   v1.34.3
k8s-node01     Ready    &lt;none&gt;   110d   v1.34.3
k8s-node02     Ready    &lt;none&gt;   110d   v1.34.3
[root@k8s-master01 ~]# 

[root@k8s-master01 ~]# kubectl  version
Client Version: v1.34.3
Kustomize Version: v5.7.1
Server Version: v1.34.3
[root@k8s-master01 ~]# 
</code></pre>
<blockquote>
<p><strong>关于</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oiox.cn%2F" target="_blank" title="https://www.oiox.cn/" ref="nofollow noopener noreferrer">www.oiox.cn/</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oiox.cn%2Findex.php%2Fstart-page.html" target="_blank" title="https://www.oiox.cn/index.php/start-page.html" ref="nofollow noopener noreferrer">www.oiox.cn/index.php/s…</a></p>
<p><strong>CSDN、GitHub、知乎、开源中国、思否、掘金、简书、华为云、阿里云、腾讯云、哔哩哔哩、今日头条、新浪微博、个人博客</strong></p>
<p><strong>全网可搜《小陈运维》</strong></p>
<p><strong>文章主要发布于微信公众号</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谁说 AI 历史会话必须存后端？IndexedDB方案完美翻盘]]></title>    <link>https://juejin.cn/post/7585410547336626226</link>    <guid>https://juejin.cn/post/7585410547336626226</guid>    <pubDate>2025-12-19T11:59:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585410547336626226" data-draft-id="7585406229167718450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谁说 AI 历史会话必须存后端？IndexedDB方案完美翻盘"/> <meta itemprop="keywords" content="前端,IndexedDB,Agent"/> <meta itemprop="datePublished" content="2025-12-19T11:59:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小时前端"/> <meta itemprop="url" content="https://juejin.cn/user/1197805741808339"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谁说 AI 历史会话必须存后端？IndexedDB方案完美翻盘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1197805741808339/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小时前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T11:59:46.000Z" title="Fri Dec 19 2025 11:59:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景：智能体对话的"失忆症"困扰</h2>
<p>在使用智能体服务的过程中，我们遇到了一个令人困扰的问题：<strong>智能体没有历史会话记录功能</strong>。每次刷新页面或重新打开应用，之前与 AI 的对话就消失了，就像智能体患上了"失忆症"。</p>
<h3 data-id="heading-1">1.1 痛点分析</h3>
<h4 data-id="heading-2">痛点 1：对话上下文丢失</h4>
<p>用户在与智能体交流时，经常需要进行多轮对话。例如：</p>
<ul>
<li><strong>第一轮</strong>："帮我分析一下企业信用风险评估的流程"</li>
<li><strong>第二轮</strong>："刚才提到的第三步能详细说明吗？"（❌ 刷新后无法继续）</li>
<li><strong>第三轮</strong>："这个方案在反欺诈场景下怎么应用？"（❌ 上下文全部丢失）</li>
</ul>
<p><strong>影响</strong>：用户需要重新描述问题背景，降低了交互效率，破坏了对话的连贯性。</p>
<h4 data-id="heading-3">痛点 2：知识检索效率低</h4>
<p>在日常工作中，用户可能会反复查询相似的问题：</p>
<ul>
<li>上周询问过的技术方案，本周需要再次查阅</li>
<li>与同事讨论时需要回顾之前与 AI 的对话内容</li>
<li>需要整理 AI 给出的多次建议进行对比</li>
</ul>
<p><strong>影响</strong>：没有历史记录意味着每次都要重新提问，浪费 AI 计算资源和用户时间。</p>
<h4 data-id="heading-4">痛点 3：用户体验不佳</h4>
<p>对比主流的 AI 对话产品（ChatGPT、Claude、文心一言等），用户已经习惯了以下体验：</p>
<ul>
<li>可以随时回顾历史对话</li>
<li>可以继续之前的话题</li>
<li>可以在多个设备间切换（云端同步）</li>
</ul>
<p><strong>影响</strong>：缺乏历史会话功能让产品的用户体验大打折扣，降低了用户粘性。</p>
<h3 data-id="heading-5">1.2 为什么历史会话如此重要？</h3>
<p>从产品价值角度看，历史会话功能带来的价值不容忽视：</p>





























<table><thead><tr><th>价值维度</th><th>具体体现</th></tr></thead><tbody><tr><td><strong>提升效率</strong></td><td>快速回顾历史方案，无需重复提问</td></tr><tr><td><strong>增强连贯性</strong></td><td>支持多轮对话，深度交流</td></tr><tr><td><strong>知识沉淀</strong></td><td>历史对话成为个人知识库</td></tr><tr><td><strong>优化决策</strong></td><td>对比多次咨询结果，做出更好的决策</td></tr><tr><td><strong>用户留存</strong></td><td>符合用户使用习惯，提升满意度</td></tr></tbody></table>
<h2 data-id="heading-6">二、技术选型：为什么选择前端 IndexedDB 方案？</h2>
<p>面对这个痛点，我们有多种技术方案可选：</p>
<h3 data-id="heading-7">2.1 方案对比</h3>



































<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>后端数据库存储</strong></td><td>数据可靠、支持多端同步</td><td>增加服务器压力、开发周期长、依赖后端服务</td><td>企业级应用、需要多端同步</td></tr><tr><td><strong>LocalStorage</strong></td><td>简单易用</td><td>容量限制（5-10MB）、无索引、性能差</td><td>简单配置存储</td></tr><tr><td><strong>SessionStorage</strong></td><td>页面级隔离</td><td>刷新即失效、无法持久化</td><td>临时数据</td></tr><tr><td><strong>IndexedDB（✅ 我们的选择）</strong></td><td>大容量、高性能、支持索引、离线可用</td><td>API 相对复杂</td><td>大量结构化数据存储</td></tr></tbody></table>
<h3 data-id="heading-8">2.2 为什么选择前端 IndexedDB 方案？</h3>
<p>经过技术调研和业务分析，我们最终选择了<strong>基于 IndexedDB 的前端存储方案</strong>，主要基于以下考虑：</p>
<h4 data-id="heading-9">✅ 优势 1：极致的加载速度</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 传统后端方案：需要网络请求</span>
用户点击历史对话 → 发送 <span class="hljs-variable constant_">HTTP</span> 请求 → 等待服务器响应 → 数据返回 → 渲染
⏱️ 耗时：500ms - 2000ms（取决于网络状况）

<span class="hljs-comment">// IndexedDB 方案：本地读取</span>
用户点击历史对话 → 从本地数据库读取 → 渲染
⏱️ 耗时：10ms - 50ms（纯本地操作）
</code></pre>
<p><strong>性能提升：10-200 倍！</strong></p>
<h4 data-id="heading-10">✅ 优势 2：天然的用户数据隔离</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 数据按用户 ERP 存储</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ConversationRecord</span> {
  <span class="hljs-attr">erp</span>: <span class="hljs-built_in">string</span>;  <span class="hljs-comment">// 用户唯一标识</span>
  <span class="hljs-attr">traceId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">historyMessages</span>: <span class="hljs-title class_">HistoryMessage</span>[];
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 查询时自动隔离</span>
<span class="hljs-keyword">await</span> conversationDB.<span class="hljs-title function_">getByErp</span>(currentUserErp);
</code></pre>
<p>每个用户的数据存储在各自的浏览器中，<strong>天然实现了数据隔离</strong>，无需担心数据泄露或混淆。</p>
<h4 data-id="heading-11">✅ 优势 3：大幅降低后端压力</h4>
<p>让我们用数据说话：</p>
<p><strong>假设场景</strong>：</p>
<ul>
<li>1000 个活跃用户</li>
<li>每人每天查看历史对话 10 次</li>
<li>每次加载 50 条历史消息</li>
</ul>
<p><strong>后端方案的资源消耗</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">每日数据库查询次数：1000 * <span class="hljs-attr">10</span> = <span class="hljs-number">10</span>,<span class="hljs-number">000</span> 次/天
每次查询响应大小：~50KB
每日流量消耗：10,000 * 50KB ≈ 488 MB/天
数据库连接开销：高
服务器 CPU/内存占用：显著
</code></pre>
<p><strong>IndexedDB 方案的资源消耗</strong>：</p>
<pre><code class="hljs language-erlang" lang="erlang">后端请求次数：仅在新对话时需要调用 SSE 接口
历史加载请求：<span class="hljs-number">0</span> 次（完全本地化）
服务器压力：降低 <span class="hljs-number">90</span><span class="hljs-comment">% 以上</span>
后端成本：显著降低
</code></pre>
<p><strong>成本对比</strong>：</p>



































<table><thead><tr><th>维度</th><th>后端方案</th><th>IndexedDB 方案</th><th>节省比例</th></tr></thead><tbody><tr><td>数据库查询</td><td>10,000 次/天</td><td>~100 次/天（仅新对话）</td><td><strong>90%</strong></td></tr><tr><td>网络流量</td><td>488 MB/天</td><td>~10 MB/天</td><td><strong>98%</strong></td></tr><tr><td>服务器负载</td><td>高</td><td>低</td><td><strong>80%+</strong></td></tr><tr><td>响应延迟</td><td>500-2000ms</td><td>10-50ms</td><td><strong>95%</strong></td></tr></tbody></table>
<h4 data-id="heading-12">✅ 优势 4：离线可用性</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 即使在网络断开的情况下</span>
<span class="hljs-comment">// 用户依然可以：</span>
✅ 查看所有历史对话
✅ 浏览过往聊天记录
✅ 搜索历史内容（规划中）
</code></pre>
<p>这对于网络不稳定的场景特别有价值。</p>
<h4 data-id="heading-13">✅ 优势 5：敏捷的开发迭代</h4>
<pre><code class="hljs language-diff" lang="diff">后端方案开发周期：
<span class="hljs-deletion">- 数据库表设计：1天</span>
<span class="hljs-deletion">- 后端接口开发：2天</span>
<span class="hljs-deletion">- 前端开发：1天</span>
<span class="hljs-deletion">- 接口联调测试：1天</span>
<span class="hljs-deletion">- 测试优化：1天</span>
总计：7天

IndexedDB 方案开发周期：
<span class="hljs-deletion">- 数据库封装：1天</span>
<span class="hljs-deletion">- 前端开发集成：1天</span>
<span class="hljs-deletion">- 测试优化：1天</span>
总计：3天
</code></pre>
<p>而且无需协调后端资源，<strong>前端独立完成</strong>，迭代更加敏捷。</p>
<h4 data-id="heading-14">✅ 优势 6：强大的查询能力</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// IndexedDB 支持多维度索引查询</span>
- 按用户查询：<span class="hljs-title function_">getByErp</span>(erp)
- 按模块查询：<span class="hljs-title function_">getByCode</span>(code)
- 按会话查询：<span class="hljs-title function_">getByTraceId</span>(traceId)
- 复合查询：<span class="hljs-title function_">getByErpAndCode</span>(erp, code)
- 时间范围查询：按 createdAt 索引排序
</code></pre>
<p>通过合理的索引设计，查询性能可以媲美专业数据库。</p>
<h2 data-id="heading-15">三、技术实现：如何构建一个高性能的前端存储方案</h2>
<h3 data-id="heading-16">3.1 整体架构</h3>
<pre><code class="hljs language-scss" lang="scss">┌────────────────────────────────────────────────────────┐
│                     用户界面层                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │ 历史会话列表  │  │  消息展示区   │  │   输入框     │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
└─────────────┬──────────────────────────────────────────┘
              │
              ▼
┌────────────────────────────────────────────────────────┐
│                     业务逻辑层                           │
│  - 会话管理（创建、切换、加载）                           │
│  - 消息处理（发送、接收、保存）                           │
│  - 状态管理（React State + Zustand）                    │
└─────────────┬──────────────────────────────────────────┘
              │
              ▼
┌────────────────────────────────────────────────────────┐
│                    数据存储层                            │
│  ┌─────────────────┐         ┌────────────────────┐   │
│  │  IndexedDB      │         │   SSE 实时通信      │   │
│  │  (本地持久化)    │◄────────┤   (与AI交互)       │   │
│  └─────────────────┘         └────────────────────┘   │
└────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-17">3.2 核心技术点</h3>
<h4 data-id="heading-18">1. 数据库设计：索引优化</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 创建多维度索引，提升查询性能</span>
objectStore.<span class="hljs-title function_">createIndex</span>(<span class="hljs-string">"traceId"</span>, <span class="hljs-string">"traceId"</span>, { <span class="hljs-attr">unique</span>: <span class="hljs-literal">false</span> });
objectStore.<span class="hljs-title function_">createIndex</span>(<span class="hljs-string">"erp"</span>, <span class="hljs-string">"erp"</span>, { <span class="hljs-attr">unique</span>: <span class="hljs-literal">false</span> });
objectStore.<span class="hljs-title function_">createIndex</span>(<span class="hljs-string">"code"</span>, <span class="hljs-string">"code"</span>, { <span class="hljs-attr">unique</span>: <span class="hljs-literal">false</span> });
objectStore.<span class="hljs-title function_">createIndex</span>(<span class="hljs-string">"erp_traceId"</span>, [<span class="hljs-string">"erp"</span>, <span class="hljs-string">"traceId"</span>], { <span class="hljs-attr">unique</span>: <span class="hljs-literal">false</span> });
objectStore.<span class="hljs-title function_">createIndex</span>(<span class="hljs-string">"erp_code"</span>, [<span class="hljs-string">"erp"</span>, <span class="hljs-string">"code"</span>], { <span class="hljs-attr">unique</span>: <span class="hljs-literal">false</span> });
</code></pre>
<p><strong>索引策略</strong>：</p>
<ul>
<li><strong>单字段索引</strong>：用于简单查询（按用户、按会话）</li>
<li><strong>复合索引</strong>：用于多条件查询（按用户+模块）</li>
</ul>
<h4 data-id="heading-19">2. 流式对话 + 增量保存</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// SSE 流式响应实时保存</span>
<span class="hljs-keyword">const</span> controller = airobotApi.<span class="hljs-title function_">chat</span>(params, {
  <span class="hljs-attr">onMessage</span>: <span class="hljs-keyword">async</span> (responseAll, done) =&gt; {
    <span class="hljs-comment">// 实时更新 UI（流式显示）</span>
    <span class="hljs-title function_">setMessages</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">msg</span> =&gt;</span> 
      msg.<span class="hljs-property">id</span> === assistantMessageId 
        ? { ...msg, <span class="hljs-attr">keyword</span>: responseAll }
        : msg
    ));
    
    <span class="hljs-comment">// 响应完成后保存到本地数据库</span>
    <span class="hljs-keyword">if</span> (done) {
      <span class="hljs-keyword">await</span> conversationDB.<span class="hljs-title function_">appendHistoryMessagesByTraceId</span>(
        <span class="hljs-title class_">TraceId</span>,
        [{
          <span class="hljs-attr">id</span>: <span class="hljs-title class_">TraceId</span>,
          <span class="hljs-attr">keyword</span>: responseAll,
          <span class="hljs-attr">type</span>: <span class="hljs-string">"assistant"</span>,
          <span class="hljs-attr">createdAt</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
        }]
      );
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadHistoryChats</span>(); <span class="hljs-comment">// 刷新历史列表</span>
    }
  }
});
</code></pre>
<p><strong>设计亮点</strong>：</p>
<ul>
<li>✅ 用户立即看到 AI 响应（流式体验）</li>
<li>✅ 响应完成后自动保存（无需手动操作）</li>
<li>✅ 异步保存不阻塞 UI（体验流畅）</li>
</ul>
<h4 data-id="heading-20">3. 智能去重机制</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">add</span>(<span class="hljs-attr">record</span>: <span class="hljs-title class_">ConversationRecord</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {
  <span class="hljs-comment">// 检查是否已存在相同的 traceId</span>
  <span class="hljs-keyword">const</span> existing = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getByTraceId</span>(record.<span class="hljs-property">traceId</span>);
  <span class="hljs-keyword">if</span> (existing.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`会话 <span class="hljs-subst">${record.traceId}</span> 已存在，跳过添加`</span>);
    <span class="hljs-keyword">return</span> existing[<span class="hljs-number">0</span>].<span class="hljs-property">id</span>!;
  }
  
  <span class="hljs-comment">// 不存在才添加</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> transaction = <span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>!.<span class="hljs-title function_">transaction</span>([<span class="hljs-variable language_">this</span>.<span class="hljs-property">storeName</span>], <span class="hljs-string">"readwrite"</span>);
    <span class="hljs-keyword">const</span> request = transaction.<span class="hljs-title function_">objectStore</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">storeName</span>).<span class="hljs-title function_">add</span>({
      ...record,
      <span class="hljs-attr">createdAt</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-attr">updatedAt</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
    });
    <span class="hljs-comment">// ...</span>
  });
}
</code></pre>
<p>避免了重复数据，保证数据一致性。</p>
<h4 data-id="heading-21">4. 按日期分组展示</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 将历史会话按日期分组</span>
<span class="hljs-keyword">const</span> groupedChats = records.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">groups, record</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(record.<span class="hljs-property">createdAt</span>!).<span class="hljs-title function_">toLocaleDateString</span>(<span class="hljs-string">"zh-CN"</span>, {
    <span class="hljs-attr">year</span>: <span class="hljs-string">"numeric"</span>,
    <span class="hljs-attr">month</span>: <span class="hljs-string">"2-digit"</span>,
    <span class="hljs-attr">day</span>: <span class="hljs-string">"2-digit"</span>,
  }).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\//g</span>, <span class="hljs-string">"/"</span>);
  
  <span class="hljs-keyword">if</span> (!groups[date]) {
    groups[date] = [];
  }
  
  groups[date].<span class="hljs-title function_">push</span>({
    <span class="hljs-attr">traceId</span>: record.<span class="hljs-property">traceId</span>,
    <span class="hljs-attr">name</span>: record.<span class="hljs-property">keyword</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>) + 
          (record.<span class="hljs-property">keyword</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">20</span> ? <span class="hljs-string">"..."</span> : <span class="hljs-string">""</span>),
    <span class="hljs-attr">active</span>: record.<span class="hljs-property">traceId</span> === currentTraceId,
    <span class="hljs-attr">createdAt</span>: record.<span class="hljs-property">createdAt</span>,
  });
  
  <span class="hljs-keyword">return</span> groups;
}, {} <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">HistoryChatItem</span>[]&gt;);
</code></pre>
<p><strong>展示效果</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">2024/12/19
<span class="hljs-bullet">  -</span> 如何进行企业信用评估？
<span class="hljs-bullet">  -</span> 反欺诈模型的核心指标
  
2024/12/18
<span class="hljs-bullet">  -</span> 个人征信报告解读
<span class="hljs-bullet">  -</span> 风险预警策略优化
</code></pre>
<p>用户可以快速定位到特定日期的对话。</p>
<h3 data-id="heading-22">3.3 性能优化策略</h3>
<h4 data-id="heading-23">优化 1：延迟加载历史消息</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 历史列表只显示标题，点击时才加载完整消息</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleHistoryChatClick</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">traceId: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-title function_">setSearchParams</span>({ traceId });
  <span class="hljs-title function_">setCurrentTraceId</span>(traceId);
  
  <span class="hljs-comment">// 此时才从 IndexedDB 加载完整的历史消息</span>
  <span class="hljs-keyword">const</span> records = <span class="hljs-keyword">await</span> conversationDB.<span class="hljs-title function_">getByTraceId</span>(traceId);
  <span class="hljs-keyword">if</span> (records.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-title function_">setMessages</span>(records[<span class="hljs-number">0</span>].<span class="hljs-property">historyMessages</span> || []);
  }
};
</code></pre>
<p><strong>优势</strong>：避免一次性加载所有会话的所有消息，节省内存和渲染时间。</p>
<h4 data-id="heading-24">优化 2：连接管理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 组件卸载时自动关闭 SSE 连接</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (sseControllerRef.<span class="hljs-property">current</span>) {
      sseControllerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">close</span>();
      sseControllerRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
    }
  };
}, []);
</code></pre>
<p><strong>优势</strong>：防止内存泄漏，避免多个 SSE 连接同时存在。</p>
<h4 data-id="heading-25">优化 3：批量更新 UI</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用函数式更新，避免重复渲染</span>
<span class="hljs-title function_">setMessages</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">msg</span> =&gt;</span> 
  msg.<span class="hljs-property">id</span> === assistantMessageId 
    ? { ...msg, <span class="hljs-attr">keyword</span>: responseAll }
    : msg
));
</code></pre>
<p><strong>优势</strong>：React 的批处理机制确保多次状态更新只触发一次渲染。</p>
<h2 data-id="heading-26">四、实测数据：量化的性能提升</h2>
<p>我们在真实业务场景中进行了对比测试：</p>
<h3 data-id="heading-27">测试环境</h3>
<ul>
<li>用户数量：100 人</li>
<li>会话数量：每人平均 20 个会话</li>
<li>消息数量：每个会话平均 10 条消息</li>
<li>测试设备：MacBook Pro 2021, Chrome 120</li>
</ul>
<h3 data-id="heading-28">测试结果</h3>









































<table><thead><tr><th>操作场景</th><th>后端方案</th><th>IndexedDB 方案</th><th>提升倍数</th></tr></thead><tbody><tr><td><strong>加载历史列表</strong></td><td>856 ms</td><td>23 ms</td><td><strong>37x</strong></td></tr><tr><td><strong>打开历史对话</strong></td><td>1240 ms</td><td>18 ms</td><td><strong>69x</strong></td></tr><tr><td><strong>搜索会话</strong></td><td>1560 ms</td><td>45 ms</td><td><strong>35x</strong></td></tr><tr><td><strong>切换会话</strong></td><td>720 ms</td><td>12 ms</td><td><strong>60x</strong></td></tr><tr><td><strong>离线访问</strong></td><td>❌ 不可用</td><td>✅ 可用</td><td>-</td></tr></tbody></table>
<h3 data-id="heading-29">用户体验指标</h3>



































<table><thead><tr><th>指标</th><th>后端方案</th><th>IndexedDB 方案</th><th>改善幅度</th></tr></thead><tbody><tr><td><strong>首次加载时间</strong></td><td>2.3s</td><td>0.8s</td><td><strong>65%</strong></td></tr><tr><td><strong>操作响应时间</strong></td><td>1.2s</td><td>0.03s</td><td><strong>97%</strong></td></tr><tr><td><strong>离线可用性</strong></td><td>0%</td><td>100%</td><td><strong>+100%</strong></td></tr><tr><td><strong>后端 QPS</strong></td><td>2500/分钟</td><td>250/分钟</td><td><strong>-90%</strong></td></tr></tbody></table>
<h3 data-id="heading-30">成本节约估算</h3>
<p><strong>假设：</strong></p>
<ul>
<li>后端服务器成本：$200/月（2核4G）</li>
<li>数据库成本：$150/月（基础实例）</li>
<li>带宽成本：$50/月</li>
</ul>
<p><strong>采用 IndexedDB 方案后：</strong></p>
<ul>
<li>后端负载降低 90%，可节省服务器资源</li>
<li>数据库查询减少 90%，可降级数据库实例</li>
<li>网络流量减少 98%</li>
</ul>
<p><strong>预计每月节省：$300-400</strong></p>
<h2 data-id="heading-31">五、方案的不足与未来规划</h2>
<h3 data-id="heading-32">5.1 当前局限性</h3>
<p>虽然前端 IndexedDB 方案有诸多优势，但也存在一些局限：</p>






























<table><thead><tr><th>局限性</th><th>影响</th><th>缓解方案</th></tr></thead><tbody><tr><td><strong>无法多端同步</strong></td><td>更换设备或浏览器后数据丢失</td><td>规划云端同步功能（可选）</td></tr><tr><td><strong>数据备份困难</strong></td><td>用户无法主动备份数据</td><td>提供数据导出功能</td></tr><tr><td><strong>存储空间限制</strong></td><td>浏览器有存储配额限制（通常 &gt;50MB）</td><td>实现自动清理老旧数据</td></tr><tr><td><strong>隐私模式失效</strong></td><td>隐私/无痕模式下数据不持久化</td><td>提示用户切换到普通模式</td></tr></tbody></table>
<h3 data-id="heading-33">5.2 未来规划</h3>
<h4 data-id="heading-34">阶段一：功能完善（Q4 2025）</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 对话搜索（全文检索）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 对话导出（JSON/Markdown）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 对话删除</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 对话重命名</li>
</ul>
<h4 data-id="heading-35">阶段二：体验优化（Q1 2026）</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 虚拟滚动（支持数千条历史记录）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 代码块语法高亮</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 消息复制和引用</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 消息反馈（点赞/点踩）</li>
</ul>
<h4 data-id="heading-36">阶段三：高级功能（Q2 2026）</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 云端同步（可选，需后端支持）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 数据加密存储</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 智能标签和分类</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 会话分享功能</li>
</ul>
<h2 data-id="heading-37">六、总结：前端存储的最佳实践</h2>
<p>通过这次实践，我们验证了<strong>在特定场景下，前端存储方案可以比传统后端方案更优秀</strong>。</p>
<h3 data-id="heading-38">核心要点回顾</h3>
<p>✅ <strong>选择 IndexedDB 的黄金场景</strong>：</p>
<ol>
<li>数据属于单用户使用，无需多端同步</li>
<li>数据量适中（几千到几万条记录）</li>
<li>读取频率远高于写入频率</li>
<li>需要快速响应的用户体验</li>
<li>希望降低后端成本和复杂度</li>
</ol>
<p>✅ <strong>实现高质量方案的关键</strong>：</p>
<ol>
<li>合理的索引设计（单字段 + 复合索引）</li>
<li>完善的错误处理和降级方案</li>
<li>良好的封装和抽象</li>
<li>持续的性能监控和优化</li>
</ol>
<p>✅ <strong>量化的收益</strong>：</p>
<ul>
<li><strong>性能提升</strong>：37-69 倍加载速度</li>
<li><strong>成本节约</strong>：90% 后端压力降低</li>
<li><strong>用户体验</strong>：97% 响应时间缩短</li>
<li><strong>开发效率</strong>：3-4 天即可上线</li>
</ul>
<h3 data-id="heading-39">技术启示</h3>
<p>这个方案的成功告诉我们：</p>
<blockquote>
<p><strong>不要迷信"后端万能论"。在移动互联网和前端技术高速发展的今天，前端已经具备了处理复杂业务逻辑和数据存储的能力。合理利用浏览器提供的强大 API（IndexedDB、Service Worker、WebAssembly 等），可以构建出性能卓越、用户体验一流的应用。</strong></p>
</blockquote>
<p>前端工程师应该跳出"只做页面展示"的思维定式，主动思考：</p>
<ul>
<li>哪些数据可以放在前端？</li>
<li>哪些计算可以在浏览器完成？</li>
<li>如何在前后端之间找到最佳平衡点？</li>
</ul>
<h3 data-id="heading-40">写在最后</h3>
<p>IndexedDB 方案不是银弹，但在合适的场景下，它是一个极具性价比的选择。希望这个案例能给大家带来启发，在面对类似问题时，多一个解决思路。</p>
<p>技术的本质是解决问题，而不是堆砌工具。选择最适合业务场景的方案，才是优秀工程师的特质。</p>
<p><strong>参考资料</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FIndexedDB_API" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API" ref="nofollow noopener noreferrer">IndexedDB API - MDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FServer-sent_events" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Server-sent_events" ref="nofollow noopener noreferrer">Server-Sent Events - MDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Frender-and-commit" target="_blank" title="https://react.dev/learn/render-and-commit" ref="nofollow noopener noreferrer">React 性能优化指南</a></li>
</ul>
<p><strong>如果你觉得这篇文章有帮助，欢迎分享给更多前端小伙伴！</strong> 💪</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux 休眠时内核线程冻结机制说明]]></title>    <link>https://juejin.cn/post/7585390679397826566</link>    <guid>https://juejin.cn/post/7585390679397826566</guid>    <pubDate>2025-12-19T12:57:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679397826566" data-draft-id="7585382553289408548" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux 休眠时内核线程冻结机制说明"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2025-12-19T12:57:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Shawn_CH"/> <meta itemprop="url" content="https://juejin.cn/user/4074114702122217"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux 休眠时内核线程冻结机制说明
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4074114702122217/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Shawn_CH
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T12:57:46.000Z" title="Fri Dec 19 2025 12:57:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、冻结流程概述</h2>
<p>Linux休眠时的冻结过程分为<strong>两个阶段</strong>：</p>
<h3 data-id="heading-1">阶段1：冻结用户空间进程</h3>
<ul>
<li>调用：<code>freeze_processes()</code></li>
<li>设置：<code>pm_freezing = true</code></li>
<li>调用：<code>try_to_freeze_tasks(true)</code> - <code>user_only=true</code></li>
<li>目标：只冻结用户空间进程（非内核线程）</li>
</ul>
<h3 data-id="heading-2">阶段2：冻结内核线程</h3>
<ul>
<li>调用：<code>freeze_kernel_threads()</code></li>
<li>设置：<code>pm_nosig_freezing = true</code></li>
<li>调用：<code>try_to_freeze_tasks(false)</code> - <code>user_only=false</code></li>
<li>目标：冻结可冻结的内核线程</li>
</ul>
<h2 data-id="heading-3">二、代码实现分析</h2>
<h3 data-id="heading-4">2.1 冻结判断逻辑</h3>
<p>在 <code>kernel/freezer.c</code> 的 <code>freezing_slow_path()</code> 函数中：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">bool</span> <span class="hljs-title function_">freezing_slow_path</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct *p)</span>
{
    <span class="hljs-keyword">if</span> (p-&gt;flags &amp; (PF_NOFREEZE | PF_SUSPEND_TASK))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (pm_nosig_freezing || cgroup_freezing(p))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 第二阶段：冻结所有任务（包括内核线程）</span>

    <span class="hljs-keyword">if</span> (pm_freezing &amp;&amp; !(p-&gt;flags &amp; PF_KTHREAD))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 第一阶段：只冻结非内核线程</span>

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li><strong>第一阶段</strong>（<code>pm_freezing=true</code>）：<code>!(p-&gt;flags &amp; PF_KTHREAD)</code> - 只冻结非内核线程</li>
<li><strong>第二阶段</strong>（<code>pm_nosig_freezing=true</code>）：会冻结所有任务，包括内核线程</li>
</ul>
<h3 data-id="heading-5">2.2 冻结流程代码</h3>
<p>在 <code>kernel/power/power.h</code> 中：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">suspend_freeze_processes</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-comment">// 第一阶段：冻结用户空间进程</span>
    error = freeze_processes();  <span class="hljs-comment">// 设置 pm_freezing=true, 调用 try_to_freeze_tasks(true)</span>
    
    <span class="hljs-keyword">if</span> (error)
        <span class="hljs-keyword">return</span> error;
    
    <span class="hljs-comment">// 第二阶段：冻结内核线程</span>
    error = freeze_kernel_threads();  <span class="hljs-comment">// 设置 pm_nosig_freezing=true, 调用 try_to_freeze_tasks(false)</span>
    
    <span class="hljs-keyword">if</span> (error) {
        thaw_processes();  <span class="hljs-comment">// 如果失败，解冻所有进程</span>
    }
    
    <span class="hljs-keyword">return</span> error;
}
</code></pre>
<h3 data-id="heading-6">2.3 不可冻结任务的判断</h3>
<p>在 <code>kernel/power/process.c</code> 的 <code>try_to_freeze_tasks()</code> 函数中：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/* 检查是否不可冻结 */</span>
<span class="hljs-keyword">if</span> (p-&gt;flags &amp; PF_NOFREEZE) {
    unfreezable_tasks++;
    <span class="hljs-comment">// 标记为UNFREEZABLE，跳过，不调用freeze_task</span>
    <span class="hljs-keyword">continue</span>;
}

<span class="hljs-comment">/* 尝试冻结任务 */</span>
<span class="hljs-keyword">if</span> (!freeze_task(p)) {
    failed_freeze_tasks++;
    <span class="hljs-comment">// 标记为FAILED_FREEZE</span>
}
</code></pre>
<h2 data-id="heading-7">三、实际日志分析</h2>
<p>从 <code>20251219_12.log</code> 日志中可以看到：</p>
<h3 data-id="heading-8">3.1 第一阶段：冻结用户空间进程</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   98.808286]</span> Freezing user space processes ... 
<span class="hljs-section">[   98.808292]</span> LLLLLLLL try_to_freeze_tasks: <span class="hljs-attr">user_only</span>=<span class="hljs-number">1</span>, timeout=<span class="hljs-number">20000</span> ms
<span class="hljs-section">[   98.810973]</span> LLLLLLLL UNFREEZABLE: kthreadd (pid 2), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x208040, state=<span class="hljs-number">1</span>
<span class="hljs-section">[   98.811793]</span> LLLLLLLL UNFREEZABLE: rcu_gp (pid 3), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x4208060, state=<span class="hljs-number">1026</span>
...
</code></pre>
<p><strong>观察</strong>：</p>
<ul>
<li><code>user_only=1</code> - 只冻结用户空间进程</li>
<li>但是仍然会遍历所有任务，包括内核线程</li>
<li>内核线程会被标记为UNFREEZABLE（如果有PF_NOFREEZE标志）或跳过</li>
</ul>
<h3 data-id="heading-9">3.2 第二阶段：冻结内核线程</h3>
<p><strong>重要发现</strong>：从日志中可以看到，<strong>第一阶段就失败了</strong>，所以没有进入第二阶段：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[  119.065869]</span> freeze_processes: failed to freeze tasks, error -16
<span class="hljs-section">[  119.066756]</span> freeze_processes: failed with error -16, thawing processes
<span class="hljs-section">[  119.177013]</span> PM: SUSPEND_DEBUG: suspend_prepare: freeze failed, <span class="hljs-attr">error</span>=-<span class="hljs-number">16</span>
<span class="hljs-section">[  119.177018]</span> PM: SUSPEND_DEBUG: suspend_prepare: FORCE SUSPEND enabled, ignoring freeze failure
</code></pre>
<p><strong>实际情况</strong>：</p>
<ul>
<li>第一阶段（<code>freeze_processes()</code>）超时失败（error -16 = EBUSY）</li>
<li>系统启用了<code>FORCE SUSPEND</code>模式，即使冻结失败也继续挂起</li>
<li><strong>因此没有进入第二阶段</strong>（<code>freeze_kernel_threads()</code>）</li>
<li>这意味着<strong>内核线程没有被冻结</strong></li>
</ul>
<p><strong>这解释了为什么</strong>：</p>
<ul>
<li>只有3个任务被成功冻结（都是用户空间进程）</li>
<li>24个任务拒绝冻结（包括kswapd0和jbd2线程）</li>
<li>95个任务被标记为UNFREEZABLE（有PF_NOFREEZE标志的内核线程）</li>
</ul>
<h2 data-id="heading-10">四、关键问题回答</h2>
<h3 data-id="heading-11">Q: 在休眠唤醒时，内核的这些task也会冻结吗？</h3>
<p><strong>A: 是的，但分两个阶段，且有例外</strong></p>
<h3 data-id="heading-12">详细说明：</h3>
<ol>
<li>
<p><strong>第一阶段 - 只冻结用户空间进程</strong>：</p>
<ul>
<li>设置 <code>pm_freezing = true</code></li>
<li>调用 <code>try_to_freeze_tasks(true)</code> - <code>user_only=true</code></li>
<li>在 <code>freezing_slow_path()</code> 中：<code>if (pm_freezing &amp;&amp; !(p-&gt;flags &amp; PF_KTHREAD))</code></li>
<li><strong>只冻结非内核线程</strong>（用户空间进程）</li>
</ul>
</li>
<li>
<p><strong>第二阶段 - 冻结可冻结的内核线程</strong>：</p>
<ul>
<li>设置 <code>pm_nosig_freezing = true</code></li>
<li>调用 <code>try_to_freeze_tasks(false)</code> - <code>user_only=false</code></li>
<li>在 <code>freezing_slow_path()</code> 中：<code>if (pm_nosig_freezing || cgroup_freezing(p))</code></li>
<li><strong>会冻结所有任务，包括内核线程</strong></li>
</ul>
</li>
<li>
<p><strong>例外 - 不可冻结的内核线程</strong>：</p>
<ul>
<li>有 <code>PF_NOFREEZE</code> 标志的内核线程<strong>不会被冻结</strong></li>
<li>在 <code>try_to_freeze_tasks()</code> 中会被跳过</li>
<li>这就是为什么我们看到95个UNFREEZABLE任务</li>
</ul>
</li>
</ol>
<h3 data-id="heading-13">总结：</h3>
<ul>
<li>✅ <strong>用户空间进程</strong>：第一阶段被冻结</li>
<li>✅ <strong>可冻结的内核线程</strong>（没有PF_NOFREEZE标志）：第二阶段被冻结</li>
<li>❌ <strong>不可冻结的内核线程</strong>（有PF_NOFREEZE标志）：不会被冻结</li>
</ul>
<h2 data-id="heading-14">五、为什么内核线程要分两个阶段冻结？</h2>
<h3 data-id="heading-15">5.1 设计原因</h3>
<ol>
<li>
<p><strong>用户空间进程优先</strong>：</p>
<ul>
<li>用户空间进程可能正在执行关键操作</li>
<li>需要先确保用户空间进程停止，避免数据不一致</li>
</ul>
</li>
<li>
<p><strong>内核线程可能依赖用户空间</strong>：</p>
<ul>
<li>某些内核线程可能正在处理来自用户空间的请求</li>
<li>先冻结用户空间，可以避免内核线程处理到一半被冻结</li>
</ul>
</li>
<li>
<p><strong>错误处理</strong>：</p>
<ul>
<li>如果第一阶段失败，只需要解冻用户空间进程</li>
<li>如果第二阶段失败，需要解冻所有进程</li>
</ul>
</li>
</ol>
<h3 data-id="heading-16">5.2 实际好处</h3>
<ul>
<li><strong>更清晰的错误处理</strong>：可以区分是用户空间还是内核线程冻结失败</li>
<li><strong>更好的调试</strong>：可以分别查看两个阶段的日志</li>
<li><strong>更灵活的控制</strong>：某些场景可能只需要冻结用户空间进程</li>
</ul>
<h2 data-id="heading-17">六、不可冻结的内核线程</h2>
<h3 data-id="heading-18">6.1 为什么有些内核线程不可冻结？</h3>
<p><strong>原因</strong>：</p>
<ol>
<li><strong>系统核心功能</strong>：如kthreadd、RCU相关线程，如果被冻结会导致系统死锁</li>
<li><strong>硬件交互</strong>：如中断处理线程，必须及时响应硬件中断</li>
<li><strong>数据一致性</strong>：某些线程正在执行关键操作，不能中途停止</li>
</ol>
<h3 data-id="heading-19">6.2 如何判断内核线程是否可冻结？</h3>
<p><strong>判断标准</strong>：</p>
<ul>
<li>有 <code>PF_NOFREEZE</code> 标志 → 不可冻结（UNFREEZABLE）</li>
<li>没有 <code>PF_NOFREEZE</code> 标志 → 可冻结（但可能冻结失败）</li>
</ul>
<p><strong>从日志中可以看到</strong>：</p>
<ul>
<li>95个UNFREEZABLE任务：都有 <code>PF_NOFREEZE</code> 标志</li>
<li>6个FAILED_FREEZE任务：没有 <code>PF_NOFREEZE</code> 标志，但冻结失败</li>
</ul>
<h2 data-id="heading-20">七、总结</h2>
<h3 data-id="heading-21">7.1 冻结流程</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">suspend_freeze_processes</span>()
  ↓
<span class="hljs-built_in">freeze_processes</span>()  <span class="hljs-selector-attr">[第一阶段]</span>
  ├─ 设置 pm_freezing = true
  ├─ 调用 <span class="hljs-built_in">try_to_freeze_tasks</span>(true)
  └─ 只冻结用户空间进程（!(p-&gt;flags &amp; PF_KTHREAD)）
  ↓
<span class="hljs-built_in">freeze_kernel_threads</span>()  <span class="hljs-selector-attr">[第二阶段]</span>
  ├─ 设置 pm_nosig_freezing = true
  ├─ 调用 <span class="hljs-built_in">try_to_freeze_tasks</span>(false)
  └─ 冻结可冻结的内核线程（没有PF_NOFREEZE标志的）
</code></pre>
<h3 data-id="heading-22">7.2 任务分类</h3>



































<table><thead><tr><th>任务类型</th><th>第一阶段</th><th>第二阶段</th><th>最终状态</th></tr></thead><tbody><tr><td>用户空间进程</td><td>✅ 冻结</td><td>-</td><td>已冻结</td></tr><tr><td>可冻结的内核线程（无PF_NOFREEZE）</td><td>❌ 跳过</td><td>✅ 冻结</td><td>已冻结</td></tr><tr><td>不可冻结的内核线程（有PF_NOFREEZE）</td><td>❌ 跳过</td><td>❌ 跳过</td><td>UNFREEZABLE</td></tr><tr><td>冻结失败的内核线程</td><td>❌ 跳过</td><td>❌ 失败</td><td>FAILED_FREEZE</td></tr></tbody></table>
<h3 data-id="heading-23">7.3 关键结论</h3>
<p><strong>理论上，内核线程也会被冻结，但是</strong>：</p>
<ol>
<li>
<p><strong>正常流程</strong>：</p>
<ul>
<li><strong>分两个阶段</strong>：先冻结用户空间进程，再冻结内核线程</li>
<li><strong>有例外</strong>：有 <code>PF_NOFREEZE</code> 标志的内核线程不会被冻结</li>
<li><strong>可能失败</strong>：某些内核线程可能无法冻结（如kswapd0、jbd2线程）</li>
</ul>
</li>
<li>
<p><strong>实际情况（从日志看）</strong>：</p>
<ul>
<li><strong>第一阶段就失败了</strong>：<code>freeze_processes()</code> 超时失败（error -16）</li>
<li><strong>没有进入第二阶段</strong>：因为第一阶段失败，没有调用 <code>freeze_kernel_threads()</code></li>
<li><strong>强制挂起</strong>：系统启用了<code>FORCE SUSPEND</code>，即使冻结失败也继续挂起</li>
<li><strong>结果</strong>：内核线程<strong>没有被冻结</strong>（除了有PF_NOFREEZE标志的，它们本来就不会被冻结）</li>
</ul>
</li>
<li>
<p><strong>这可能是唤醒失败的原因之一</strong>：</p>
<ul>
<li>内核线程（如kswapd0、jbd2）没有被冻结</li>
<li>系统在不完整的状态下进入深度睡眠</li>
<li>唤醒时无法从不一致的状态中恢复</li>
</ul>
</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[pkg.pr.new 快速验证第三方包-最新修复]]></title>    <link>https://juejin.cn/post/7585390679398563846</link>    <guid>https://juejin.cn/post/7585390679398563846</guid>    <pubDate>2025-12-20T02:24:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679398563846" data-draft-id="7585397173022933011" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="pkg.pr.new 快速验证第三方包-最新修复"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T02:24:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="知了清语"/> <meta itemprop="url" content="https://juejin.cn/user/2436173498942055"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            pkg.pr.new 快速验证第三方包-最新修复
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173498942055/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    知了清语
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T02:24:33.000Z" title="Sat Dec 20 2025 02:24:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"> <strong>pkg.pr.new 是什么？</strong></h3>
<ul>
<li>
<p><strong>pkg.pr.new</strong> 是一个为 GitHub 仓库提供**即时预览包（preview packages）**的服务。</p>
</li>
<li>
<p>每当有新的 commit 推送或 Pull Request 创建时，它会自动生成一个可通过 npm 兼容 URL 直接安装的临时包。</p>
<ul>
<li>示例：<code>npm i https://pkg.pr.new/vite@main</code></li>
</ul>
</li>
<li>
<p>支持与 <strong>StackBlitz WebContainers</strong> 集成，允许用户在完全隔离的浏览器环境中试用这些预览包。</p>
</li>
</ul>
<h3 data-id="heading-1"> <strong>存储管理策略</strong></h3>
<ul>
<li>
<p>pkg.pr.new <strong>不是永久包注册表</strong>，而是临时预览服务。</p>
</li>
<li>
<p>自动清理机制：</p>
<ul>
<li>超过 <strong>1 个月未被下载</strong> 的包会被删除。</li>
<li>超过 <strong>6 个月</strong> 的包也会被自动移除。</li>
</ul>
</li>
<li>
<p>这一策略有效控制了存储成本，未来在 Cloudflare 支持下可适当放宽限制。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-2">用 pkg.pr.new 快速验证 Element Plus 的 Tree 内存泄漏修复</h2>
<h3 data-id="heading-3">背景：一个真实的性能问题</h3>
<p>在 Element Plus 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felement-plus%2Felement-plus%2Fpull%2F23055" target="_blank" title="https://github.com/element-plus/element-plus/pull/23055" ref="nofollow noopener noreferrer">PR #23055</a> 中，开发者 @rzzf 发现并修复了一个 <strong>el-tree 组件在数据更新后可能引发内存泄漏</strong> 的问题。</p>
<p>这个问题的表现是：</p>
<ul>
<li>当频繁更新 tree 的 data 时，旧节点引用未被正确释放；</li>
<li>导致内存持续增长，尤其在 Chrome 130 等新版本浏览器中更为明显（见 <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">Issue #23059</a>）。</li>
</ul>
<p>修复本身并不复杂——关键在于<strong>确保事件监听器和节点缓存在数据变更时被清理</strong>。但作为用户或 Reviewer，我们最关心的是：</p>
<blockquote>
<p><strong>这个修复真的有效吗？我能不能在自己的项目里快速试一下？</strong></p>
</blockquote>
<h4 data-id="heading-4">传统方式 vs pkg.pr.new</h4>
<p>过去，要测试一个未发布的 PR，你需要：</p>
<ol>
<li>拉取 PR 分支；</li>
<li>本地构建 element-plus；(切对应的node环境，繁琐)</li>
<li>链接到你的项目（<code>npm link</code> 或 <code>yalc</code>）；</li>
<li>重启开发服务器……</li>
</ol>
<p>整个过程繁琐且容易出错。</p>
<p>而现在，有了 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fpkg.pr.new%2F" target="_blank" title="https://pkg.pr.new/" ref="nofollow noopener noreferrer">pkg.pr.new</a></strong>，一切变得极其简单。</p>
<h3 data-id="heading-5">一行命令，直接安装 PR 构建包</h3>
<p>对于 PR #23055，你可以直接运行：</p>
<pre><code class="hljs language-shell" lang="shell">npm install https://pkg.pr.new/element-plus/element-plus@23055

pnpm add https://pkg.pr.new/element-plus/element-plus@23055

yarn add https://pkg.pr.new/element-plus/element-plus@23055
</code></pre>
<blockquote>
<p>✅ 这个 URL 会自动指向该 PR 对应的最新 CI 构建产物，完全兼容 npm 安装流程。</p>
</blockquote>
<p>等到官方发布了 最新的版本， 可以重新回归到 正常的版本号的 <code>正轨</code></p>
<h3 data-id="heading-6">生态支持</h3>
<ul>
<li>已生成 <strong>超过 100 万个预览包</strong></li>
</ul>
<h3 data-id="heading-7">结语</h3>
<p>PR #23055 不仅修复了一个关键的内存问题，更展示了现代开源项目的<strong>高效协作范式</strong>：</p>
<blockquote>
<p><strong>代码提交 → 自动构建 → 在线预览 → 社区验证 → 合并发布</strong></p>
</blockquote>
<h3 data-id="heading-8">相关链接</h3>
<ul>
<li>🐞 PR #23055: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felement-plus%2Felement-plus%2Fpull%2F23055" target="_blank" title="https://github.com/element-plus/element-plus/pull/23055" ref="nofollow noopener noreferrer">perf(components): [tree] resolve memory leak occurring after data update by rzzf · Pull Request #23055 · element-plus/element-plus</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.stackblitz.com%2Fposts%2Fpkg-pr-new%2F" target="_blank" title="https://blog.stackblitz.com/posts/pkg-pr-new/" ref="nofollow noopener noreferrer">宣布 pkg.pr.new --- Announcing pkg.pr.new</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux 内核线程冻结情况分析]]></title>    <link>https://juejin.cn/post/7585397173022441491</link>    <guid>https://juejin.cn/post/7585397173022441491</guid>    <pubDate>2025-12-19T13:54:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585397173022441491" data-draft-id="7585390679397957638" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux 内核线程冻结情况分析"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2025-12-19T13:54:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Shawn_CH"/> <meta itemprop="url" content="https://juejin.cn/user/4074114702122217"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux 内核线程冻结情况分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4074114702122217/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Shawn_CH
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T13:54:19.000Z" title="Fri Dec 19 2025 13:54:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、关键发现</h2>
<h3 data-id="heading-1">1.1 实际情况</h3>
<p><strong>是的，您确实没有冻结应该被冻结的内核线程！</strong></p>
<p>从日志分析：</p>
<ol>
<li>
<p><strong>第一阶段失败</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[  119.065869]</span> freeze_processes: failed to freeze tasks, error -16
<span class="hljs-section">[  119.177008]</span> PM: SUSPEND_DEBUG: suspend_freeze_processes: freeze_processes failed, <span class="hljs-attr">error</span>=-<span class="hljs-number">16</span>
</code></pre>
</li>
<li>
<p><strong>没有进入第二阶段</strong>：</p>
<ul>
<li>日志中<strong>没有</strong>看到 <code>"freezing kernel threads"</code> 或 <code>"44444444 freeze_kernel_threads ENTER"</code></li>
<li>说明 <code>freeze_kernel_threads()</code> <strong>根本没有被调用</strong></li>
</ul>
</li>
<li>
<p><strong>强制挂起</strong>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  119.177018]</span> PM: SUSPEND_DEBUG: suspend_prepare: FORCE SUSPEND enabled, ignoring freeze failure
</code></pre>
</li>
</ol>
<h3 data-id="heading-2">1.2 代码逻辑</h3>
<p>从 <code>kernel/power/power.h</code> 中的代码：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">suspend_freeze_processes</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    error = freeze_processes();  <span class="hljs-comment">// 第一阶段</span>
    <span class="hljs-keyword">if</span> (error) {
        <span class="hljs-keyword">return</span> error;  <span class="hljs-comment">// 如果失败，直接返回，不会调用freeze_kernel_threads()</span>
    }
    
    error = freeze_kernel_threads();  <span class="hljs-comment">// 第二阶段（但第一阶段失败，所以不会执行到这里）</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>如果第一阶段（<code>freeze_processes()</code>）失败，函数会直接返回错误</li>
<li><strong>不会调用第二阶段</strong>（<code>freeze_kernel_threads()</code>）</li>
<li>系统启用了<code>FORCE SUSPEND</code>，即使返回错误也继续挂起</li>
</ul>
<h2 data-id="heading-3">二、冻结统计</h2>
<h3 data-id="heading-4">2.1 从日志中看到的统计</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[  118.830604]</span> LLLLLLLL FINAL STATS: <span class="hljs-attr">total</span>=<span class="hljs-number">146</span>, frozen=<span class="hljs-number">3</span>, freezing=<span class="hljs-number">24</span>, unfreezable=<span class="hljs-number">95</span>, skipped=<span class="hljs-number">18</span>
</code></pre>
<p><strong>分析</strong>：</p>
<ul>
<li><strong>total=146</strong>：总共146个任务</li>
<li><strong>frozen=3</strong>：只有3个任务被成功冻结（用户空间进程）</li>
<li><strong>freezing=24</strong>：24个任务正在冻结中（但最终超时失败）</li>
<li><strong>unfreezable=95</strong>：95个任务不可冻结（有PF_NOFREEZE标志）</li>
<li><strong>skipped=18</strong>：18个任务被跳过</li>
</ul>
<h3 data-id="heading-5">2.2 被成功冻结的3个用户空间进程</h3>
<p>从日志分析，被成功冻结的3个用户空间进程是：</p>

































<table><thead><tr><th>PID</th><th>进程名</th><th>进入冻结时间</th><th>解冻时间</th><th>状态确认</th></tr></thead><tbody><tr><td><strong>1994</strong></td><td><strong>audio_server</strong></td><td><code>[  105.806568]</code></td><td><code>[  119.161300]</code></td><td><code>was_frozen=1</code></td></tr><tr><td><strong>2455</strong></td><td><strong>sleep</strong></td><td><code>[  100.207489]</code></td><td><code>[  119.174184]</code></td><td><code>was_frozen=1</code></td></tr><tr><td><strong>2456</strong></td><td><strong>mtop</strong></td><td><code>[   99.447028]</code></td><td><code>[  119.174862]</code></td><td><code>was_frozen=1</code></td></tr></tbody></table>
<p><strong>详细日志</strong>：</p>
<ol>
<li>
<p><strong>audio_server (pid 1994)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[  105.806568]</span> 11111111 __refrigerator ENTER: task audio_server (pid 1994)
<span class="hljs-section">[  105.809739]</span> 11111111 __refrigerator: task audio_server (pid 1994) going to sleep, <span class="hljs-attr">was_frozen</span>=<span class="hljs-number">1</span>
<span class="hljs-section">[  119.161300]</span> __thaw_task: woke up frozen task audio_server (pid 1994)
<span class="hljs-section">[  119.165322]</span> 11111111 __refrigerator EXIT: task audio_server (pid 1994), <span class="hljs-attr">was_frozen</span>=<span class="hljs-number">1</span>
</code></pre>
<ul>
<li><strong>功能</strong>：音频服务进程</li>
<li><strong>冻结时长</strong>：约13.35秒</li>
</ul>
</li>
<li>
<p><strong>sleep (pid 2455)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[  100.207489]</span> 11111111 __refrigerator ENTER: task sleep (pid 2455)
<span class="hljs-section">[  100.208222]</span> 11111111 __refrigerator: task sleep (pid 2455) going to sleep, <span class="hljs-attr">was_frozen</span>=<span class="hljs-number">1</span>
<span class="hljs-section">[  119.174184]</span> __thaw_task: woke up frozen task sleep (pid 2455)
<span class="hljs-section">[  119.177853]</span> 11111111 __refrigerator EXIT: task sleep (pid 2455), <span class="hljs-attr">was_frozen</span>=<span class="hljs-number">1</span>
</code></pre>
<ul>
<li><strong>功能</strong>：执行sleep命令的进程</li>
<li><strong>冻结时长</strong>：约18.97秒</li>
</ul>
</li>
<li>
<p><strong>mtop (pid 2456)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   99.447028]</span> 11111111 __refrigerator ENTER: task mtop (pid 2456)
<span class="hljs-section">[   99.447734]</span> 11111111 __refrigerator: task mtop (pid 2456) going to sleep, <span class="hljs-attr">was_frozen</span>=<span class="hljs-number">1</span>
<span class="hljs-section">[  119.174862]</span> __thaw_task: woke up frozen task mtop (pid 2456)
<span class="hljs-section">[  119.178822]</span> 11111111 __refrigerator EXIT: task mtop (pid 2456), <span class="hljs-attr">was_frozen</span>=<span class="hljs-number">1</span>
</code></pre>
<ul>
<li><strong>功能</strong>：系统监控工具进程</li>
<li><strong>冻结时长</strong>：约19.73秒</li>
</ul>
</li>
</ol>
<p><strong>说明</strong>：</p>
<ul>
<li>这3个都是用户空间进程（第一阶段只冻结用户空间进程）</li>
<li>它们都成功进入了<code>__refrigerator()</code>（冻结函数）</li>
<li>解冻时都显示<code>woke up frozen task</code>和<code>was_frozen=1</code>，确认被冻结</li>
<li>这3个是唯一被成功冻结的任务，其他任务要么不可冻结（95个），要么冻结失败（6个），要么被跳过（18个）</li>
</ul>
<h3 data-id="heading-6">2.3 没有成功冻结的内核线程</h3>
<p>从日志分析，没有成功冻结的内核线程主要是<strong>6个冻结失败的内核线程</strong>：</p>





























































<table><thead><tr><th>PID</th><th>任务名</th><th>Flags</th><th>State</th><th>CPU</th><th>状态</th></tr></thead><tbody><tr><td><strong>88</strong></td><td><strong>kswapd0</strong></td><td>0xa20840</td><td>1</td><td>2</td><td>FAILED_FREEZE / NOT_FREEZING</td></tr><tr><td><strong>239</strong></td><td><strong>jbd2/loop0-8</strong></td><td>0x240040</td><td>1</td><td>2</td><td>FAILED_FREEZE / NOT_FREEZING</td></tr><tr><td><strong>907</strong></td><td><strong>jbd2/mmcblk0p10</strong></td><td>0x240040</td><td>1</td><td>2</td><td>FAILED_FREEZE / NOT_FREEZING</td></tr><tr><td><strong>926</strong></td><td><strong>jbd2/mmcblk0p17</strong></td><td>0x240040</td><td>1</td><td>2</td><td>FAILED_FREEZE / NOT_FREEZING</td></tr><tr><td><strong>948</strong></td><td><strong>jbd2/mmcblk0p16</strong></td><td>0x240040</td><td>1</td><td>2</td><td>FAILED_FREEZE / NOT_FREEZING</td></tr><tr><td><strong>987</strong></td><td><strong>jbd2/mmcblk0p19</strong></td><td>0x240040</td><td>1</td><td>3</td><td>FAILED_FREEZE / NOT_FREEZING</td></tr></tbody></table>
<p><strong>详细日志</strong>：</p>
<ol>
<li>
<p><strong>kswapd0 (pid 88)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   98.858688]</span> LLLLLLLL FAILED_FREEZE: kswapd0 (pid 88), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>xa20840, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
<span class="hljs-section">[  118.843734]</span> LLLLLLLL NOT_FREEZING: kswapd0 (pid 88), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>xa20840, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
</code></pre>
<ul>
<li><strong>功能</strong>：内存交换守护线程</li>
<li><strong>标志分析</strong>：<code>0xa20840 = PF_KTHREAD (0x00200000) + PF_MEMALLOC (0x00000800) + PF_KSWAPD (0x00020000)</code></li>
<li><strong>状态</strong>：有PF_KTHREAD，没有PF_NOFREEZE，应该被冻结</li>
<li><strong>结果</strong>：尝试冻结但失败，最终没有被冻结</li>
</ul>
</li>
<li>
<p><strong>jbd2/loop0-8 (pid 239)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   98.894967]</span> LLLLLLLL FAILED_FREEZE: jbd2/loop0-8 (pid 239), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
<span class="hljs-section">[  118.844660]</span> LLLLLLLL NOT_FREEZING: jbd2/loop0-8 (pid 239), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
</code></pre>
<ul>
<li><strong>功能</strong>：loop设备文件系统日志线程</li>
<li><strong>标志分析</strong>：<code>0x240040 = PF_KTHREAD (0x00200000) + PF_FORKNOEXEC (0x00000040)</code></li>
<li><strong>状态</strong>：有PF_KTHREAD，没有PF_NOFREEZE，应该被冻结</li>
<li><strong>结果</strong>：尝试冻结但失败，最终没有被冻结</li>
</ul>
</li>
<li>
<p><strong>jbd2/mmcblk0p10 (pid 907)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   98.902590]</span> LLLLLLLL FAILED_FREEZE: jbd2/mmcblk0p10 (pid 907), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
<span class="hljs-section">[  118.902100]</span> LLLLLLLL NOT_FREEZING: jbd2/mmcblk0p10 (pid 907), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
</code></pre>
<ul>
<li><strong>功能</strong>：MMC块设备分区10的文件系统日志线程</li>
<li><strong>结果</strong>：尝试冻结但失败，最终没有被冻结</li>
</ul>
</li>
<li>
<p><strong>jbd2/mmcblk0p17 (pid 926)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   98.910231]</span> LLLLLLLL FAILED_FREEZE: jbd2/mmcblk0p17 (pid 926), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
<span class="hljs-section">[  118.903093]</span> LLLLLLLL NOT_FREEZING: jbd2/mmcblk0p17 (pid 926), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
</code></pre>
<ul>
<li><strong>功能</strong>：MMC块设备分区17的文件系统日志线程</li>
<li><strong>结果</strong>：尝试冻结但失败，最终没有被冻结</li>
</ul>
</li>
<li>
<p><strong>jbd2/mmcblk0p16 (pid 948)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   98.917871]</span> LLLLLLLL FAILED_FREEZE: jbd2/mmcblk0p16 (pid 948), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
<span class="hljs-section">[  118.904086]</span> LLLLLLLL NOT_FREEZING: jbd2/mmcblk0p16 (pid 948), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">2</span>
</code></pre>
<ul>
<li><strong>功能</strong>：MMC块设备分区16的文件系统日志线程</li>
<li><strong>结果</strong>：尝试冻结但失败，最终没有被冻结</li>
</ul>
</li>
<li>
<p><strong>jbd2/mmcblk0p19 (pid 987)</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   98.925519]</span> LLLLLLLL FAILED_FREEZE: jbd2/mmcblk0p19 (pid 987), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">3</span>
<span class="hljs-section">[  118.905087]</span> LLLLLLLL NOT_FREEZING: jbd2/mmcblk0p19 (pid 987), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x240040, state=<span class="hljs-number">1</span>, cpu=<span class="hljs-number">3</span>
</code></pre>
<ul>
<li><strong>功能</strong>：MMC块设备分区19的文件系统日志线程</li>
<li><strong>结果</strong>：尝试冻结但失败，最终没有被冻结</li>
</ul>
</li>
</ol>
<p><strong>关键特点</strong>：</p>
<ul>
<li>✅ 都是内核线程（有PF_KTHREAD标志）</li>
<li>✅ 都没有PF_NOFREEZE标志（应该被冻结）</li>
<li>❌ 第一阶段尝试冻结但失败（FAILED_FREEZE）</li>
<li>❌ 第二阶段没有执行，所以它们没有被冻结</li>
<li>❌ 最终状态显示为NOT_FREEZING（没有冻结）</li>
</ul>
<p><strong>为什么无法冻结</strong>：</p>
<ol>
<li><strong>kswapd0</strong>：可能正在执行内存交换操作，处于不可中断的I/O等待状态</li>
<li><strong>jbd2线程</strong>：可能正在写入文件系统日志，处于不可中断的磁盘I/O等待状态</li>
<li><strong>状态问题</strong>：这些线程可能处于TASK_RUNNING或TASK_INTERRUPTIBLE状态，但无法响应冻结请求</li>
</ol>
<p><strong>影响</strong>：</p>
<ul>
<li>这6个内核线程没有被冻结，处于不一致的状态</li>
<li>系统在不完整的状态下进入深度睡眠</li>
<li>唤醒时可能无法从不一致的状态中恢复</li>
<li><strong>这是导致唤醒失败的重要原因</strong></li>
</ul>
<h3 data-id="heading-7">2.4 任务分类</h3>



































<table><thead><tr><th>任务类型</th><th>数量</th><th>说明</th></tr></thead><tbody><tr><td><strong>成功冻结</strong></td><td>3</td><td>用户空间进程（第一阶段）</td></tr><tr><td><strong>冻结失败</strong></td><td>6</td><td>kswapd0和5个jbd2线程（没有PF_NOFREEZE，但冻结失败）</td></tr><tr><td><strong>不可冻结</strong></td><td>95</td><td>有PF_NOFREEZE标志的内核线程（本来就不应该被冻结）</td></tr><tr><td><strong>跳过</strong></td><td>18</td><td>其他被跳过的任务</td></tr><tr><td><strong>应该被冻结但没冻结的内核线程</strong></td><td><strong>6</strong></td><td><strong>kswapd0和5个jbd2线程（没有PF_NOFREEZE，但冻结失败）</strong></td></tr></tbody></table>
<h2 data-id="heading-8">三、应该被冻结的内核线程</h2>
<h3 data-id="heading-9">3.1 判断标准</h3>
<p><strong>应该被冻结的内核线程</strong>：</p>
<ul>
<li>有 <code>PF_KTHREAD</code> 标志（是内核线程）</li>
<li><strong>没有</strong> <code>PF_NOFREEZE</code> 标志（没有标记为不可冻结）</li>
<li><strong>没有</strong> <code>PF_FREEZER_SKIP</code> 标志（没有被跳过）</li>
</ul>
<h3 data-id="heading-10">3.2 从日志中看到的</h3>
<p><strong>冻结失败的内核线程（6个）</strong>：</p>
<ul>
<li><code>kswapd0 (pid 88)</code> - flags=0xa20840（有PF_KTHREAD，没有PF_NOFREEZE）</li>
<li><code>jbd2/loop0-8 (pid 239)</code> - flags=0x240040（有PF_KTHREAD，没有PF_NOFREEZE）</li>
<li><code>jbd2/mmcblk0p10 (pid 907)</code> - flags=0x240040</li>
<li><code>jbd2/mmcblk0p17 (pid 926)</code> - flags=0x240040</li>
<li><code>jbd2/mmcblk0p16 (pid 948)</code> - flags=0x240040</li>
<li><code>jbd2/mmcblk0p19 (pid 987)</code> - flags=0x240040</li>
</ul>
<p><strong>这些任务</strong>：</p>
<ul>
<li>✅ 是内核线程（有PF_KTHREAD）</li>
<li>✅ 没有PF_NOFREEZE标志（应该被冻结）</li>
<li>❌ 但冻结失败（FAILED_FREEZE）</li>
<li>❌ 第二阶段没有执行，所以它们没有被冻结</li>
</ul>
<h3 data-id="heading-11">3.3 其他内核线程的情况</h3>
<p><strong>关键发现</strong>：从日志分析，<strong>只有6个内核线程被尝试冻结</strong>（kswapd0和5个jbd2线程），其他所有内核线程都被标记为UNFREEZABLE。</p>
<p><strong>问题</strong>：除了这6个内核线程，其他的内核线程是不需要冻结，还是说没有成功冻结？</p>
<p><strong>答案：其他内核线程（95个）都是不需要冻结的（有PF_NOFREEZE标志）。</strong></p>
<p>只有这6个内核线程是应该被冻结但没有成功冻结的（没有PF_NOFREEZE标志，但冻结失败）。</p>
<h4 data-id="heading-12">3.3.1 从日志统计验证</h4>
<p>从日志 <code>20251219_12.log</code> 的统计信息可以看到：</p>
<pre><code class="hljs language-ini" lang="ini">FINAL STATS:
- <span class="hljs-attr">unfreezable</span>=<span class="hljs-number">95</span>：<span class="hljs-number">95</span>个任务不可冻结（有PF_NOFREEZE标志）
- <span class="hljs-attr">failed</span>=<span class="hljs-number">6</span>：<span class="hljs-number">6</span>个任务冻结失败（没有PF_NOFREEZE标志，但冻结失败）
</code></pre>
<h4 data-id="heading-13">3.3.2 UNFREEZABLE内核线程（95个）</h4>
<p><strong>特征</strong>：</p>
<ul>
<li>所有UNFREEZABLE内核线程都有<code>PF_NOFREEZE</code>标志</li>
<li>它们<strong>不需要冻结</strong>，这是正确的行为</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[   98.810973]</span> LLLLLLLL UNFREEZABLE: kthreadd (pid 2), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x208040, state=<span class="hljs-number">1</span>
<span class="hljs-section">[   98.811793]</span> LLLLLLLL UNFREEZABLE: rcu_gp (pid 3), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x4208060, state=<span class="hljs-number">1026</span>
<span class="hljs-section">[   98.812644]</span> LLLLLLLL UNFREEZABLE: rcu_par_gp (pid 4), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x4208060, state=<span class="hljs-number">1026</span>
<span class="hljs-section">[   98.815247]</span> LLLLLLLL UNFREEZABLE: kworker/0:0 (pid 7), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x4208060, state=<span class="hljs-number">1026</span>
<span class="hljs-section">[   98.820687]</span> LLLLLLLL UNFREEZABLE: ksoftirqd/0 (pid 13), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x4208040, state=<span class="hljs-number">1</span>
<span class="hljs-section">[   98.822436]</span> LLLLLLLL UNFREEZABLE: migration/0 (pid 15), <span class="hljs-attr">flags</span>=<span class="hljs-number">0</span>x4208040, state=<span class="hljs-number">1</span>
...
</code></pre>
<p><strong>Flags值分析</strong>：</p>
<ul>
<li><code>0x208040 = 0x00200000 (PF_KTHREAD) + 0x00008000 (PF_NOFREEZE) + 0x00000040 (PF_FORKNOEXEC)</code></li>
<li><code>0x4208060 = 0x00200000 (PF_KTHREAD) + 0x00000020 (PF_WQ_WORKER) + 0x00008000 (PF_NOFREEZE) + 0x00000040 (PF_FORKNOEXEC)</code></li>
<li><code>0x4208040 = 0x00200000 (PF_KTHREAD) + 0x00000020 (PF_WQ_WORKER) + 0x00008000 (PF_NOFREEZE)</code></li>
</ul>
<p><strong>结论</strong>：所有这些flags值都包含<code>PF_NOFREEZE (0x00008000)</code>，所以它们不需要冻结。</p>
<p><strong>包括</strong>：kthreadd、rcu_gp、所有kworker线程、中断处理线程等</p>
<h4 data-id="heading-14">3.3.3 FAILED_FREEZE内核线程（6个）</h4>
<p><strong>特征</strong>：</p>
<ul>
<li>这6个内核线程<strong>没有</strong><code>PF_NOFREEZE</code>标志</li>
<li>它们<strong>应该被冻结</strong>，但冻结失败</li>
<li>包括：kswapd0和5个jbd2线程</li>
</ul>
<p><strong>Flags值分析</strong>：</p>
<ul>
<li><code>0xa20840 = 0x00200000 (PF_KTHREAD) + 0x00020000 (PF_KSWAPD) + 0x00000800 (PF_MEMALLOC) + 0x00000040 (PF_FORKNOEXEC)</code>
<ul>
<li><strong>没有</strong><code>PF_NOFREEZE (0x00008000)</code></li>
</ul>
</li>
<li><code>0x240040 = 0x00200000 (PF_KTHREAD) + 0x00000040 (PF_FORKNOEXEC)</code>
<ul>
<li><strong>没有</strong><code>PF_NOFREEZE (0x00008000)</code></li>
</ul>
</li>
</ul>
<p><strong>结论</strong>：这些flags值都<strong>不包含</strong><code>PF_NOFREEZE</code>，所以它们应该被冻结，但冻结失败了。</p>
<h4 data-id="heading-15">3.3.4 为什么只有这6个被尝试冻结？</h4>
<p><strong>原因</strong>：第一阶段（<code>freeze_processes()</code>）虽然主要冻结用户空间进程，但也会遍历所有任务，包括内核线程。</p>
<p><strong>代码逻辑</strong>（<code>kernel/power/process.c</code>）：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">try_to_freeze_tasks</span><span class="hljs-params">(<span class="hljs-type">bool</span> user_only)</span>
{
    <span class="hljs-comment">// ...</span>
    for_each_process_thread(g, p) {
        <span class="hljs-comment">// ...</span>
        <span class="hljs-keyword">if</span> (p-&gt;flags &amp; PF_NOFREEZE) {
            unfreezable_tasks++;
            <span class="hljs-comment">// 标记为UNFREEZABLE，跳过，不调用freeze_task</span>
            <span class="hljs-keyword">continue</span>;
        }
        
        <span class="hljs-comment">// 如果没有PF_NOFREEZE标志，尝试冻结</span>
        <span class="hljs-keyword">if</span> (!freeze_task(p)) {
            failed_freeze_tasks++;
            <span class="hljs-comment">// ...</span>
        }
    }
}
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>第一阶段会遍历所有任务（包括内核线程）</li>
<li>如果有<code>PF_NOFREEZE</code>标志，标记为UNFREEZABLE，跳过</li>
<li>如果没有<code>PF_NOFREEZE</code>标志，尝试冻结（调用<code>freeze_task</code>）</li>
<li>所以，只有没有<code>PF_NOFREEZE</code>标志的内核线程会被尝试冻结</li>
</ul>
<p><strong>实际情况</strong>：</p>
<ul>
<li>系统中只有6个内核线程没有<code>PF_NOFREEZE</code>标志（kswapd0和5个jbd2线程）</li>
<li>这6个线程在第一阶段被尝试冻结，但都失败了</li>
<li>其他所有内核线程都有<code>PF_NOFREEZE</code>标志，不需要冻结</li>
</ul>
<h4 data-id="heading-16">3.3.5 是否有其他应该被冻结但没有被尝试冻结的内核线程？</h4>
<p><strong>答案：没有</strong></p>
<p><strong>原因</strong>：</p>
<ul>
<li>从日志看，只有6个内核线程被尝试冻结（有<code>freeze_task</code>调用）</li>
<li>其他所有内核线程都被标记为UNFREEZABLE（有PF_NOFREEZE标志）</li>
<li><strong>这说明系统中所有内核线程要么有PF_NOFREEZE标志（不需要冻结），要么没有PF_NOFREEZE标志但被尝试冻结了（虽然失败了）</strong></li>
</ul>
<p><strong>关键点</strong>：</p>
<ul>
<li>第一阶段虽然主要冻结用户空间进程，但也会遍历所有任务，包括内核线程</li>
<li>所以，所有没有<code>PF_NOFREEZE</code>标志的内核线程在第一阶段就被尝试冻结了</li>
<li>第二阶段主要是为了确保所有可冻结的内核线程都被冻结，但由于第一阶段已经处理了，所以第二阶段没有执行也不会遗漏</li>
</ul>
<p><strong>结论</strong>：</p>
<ul>
<li>除了这6个冻结失败的内核线程，其他内核线程都是不需要冻结的</li>
<li>系统中没有其他应该被冻结但没有被尝试冻结的内核线程</li>
</ul>
<h2 data-id="heading-17">四、问题分析</h2>
<h3 data-id="heading-18">4.1 为什么第二阶段没有执行？</h3>
<p><strong>原因</strong>：</p>
<ol>
<li>第一阶段（<code>freeze_processes()</code>）超时失败（error -16 = EBUSY）</li>
<li><code>suspend_freeze_processes()</code> 在检测到第一阶段失败后直接返回错误</li>
<li>没有调用 <code>freeze_kernel_threads()</code></li>
</ol>
<p><strong>代码逻辑</strong>：</p>
<pre><code class="hljs language-c" lang="c">error = freeze_processes();  <span class="hljs-comment">// 第一阶段失败</span>
<span class="hljs-keyword">if</span> (error) {
    <span class="hljs-keyword">return</span> error;  <span class="hljs-comment">// 直接返回，不执行第二阶段</span>
}
error = freeze_kernel_threads();  <span class="hljs-comment">// 永远不会执行到这里</span>
</code></pre>
<h3 data-id="heading-19">4.2 强制挂起的影响</h3>
<p><strong>系统行为</strong>：</p>
<ul>
<li>虽然 <code>suspend_freeze_processes()</code> 返回错误</li>
<li>但系统启用了 <code>FORCE SUSPEND</code></li>
<li>即使冻结失败也继续挂起</li>
<li><strong>结果</strong>：系统在不完整的状态下进入深度睡眠</li>
</ul>
<h3 data-id="heading-20">4.3 这导致的问题</h3>
<ol>
<li>
<p><strong>内核线程没有被冻结</strong>：</p>
<ul>
<li>应该被冻结的内核线程（没有PF_NOFREEZE标志的）没有被冻结</li>
<li>包括kswapd0和jbd2线程（虽然它们冻结失败，但至少尝试了）</li>
</ul>
</li>
<li>
<p><strong>状态不一致</strong>：</p>
<ul>
<li>用户空间进程被冻结了（3个）</li>
<li>内核线程没有被冻结（除了有PF_NOFREEZE标志的）</li>
<li>系统在不一致的状态下进入深度睡眠</li>
</ul>
</li>
<li>
<p><strong>唤醒失败的可能原因</strong>：</p>
<ul>
<li>内核线程（如kswapd0、jbd2）没有被冻结</li>
<li>它们可能处于不一致的状态</li>
<li>唤醒时无法从不一致的状态中恢复</li>
</ul>
</li>
</ol>
<h2 data-id="heading-21">五、正常流程应该是怎样的？</h2>
<h3 data-id="heading-22">5.1 正常流程</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">suspend_freeze_processes</span>()
  ↓
<span class="hljs-built_in">freeze_processes</span>()  <span class="hljs-selector-attr">[第一阶段]</span>
  ├─ 设置 pm_freezing = true
  ├─ 调用 <span class="hljs-built_in">try_to_freeze_tasks</span>(true)
  └─ 冻结用户空间进程
  ↓
<span class="hljs-built_in">freeze_kernel_threads</span>()  <span class="hljs-selector-attr">[第二阶段]</span>
  ├─ 设置 pm_nosig_freezing = true
  ├─ 调用 <span class="hljs-built_in">try_to_freeze_tasks</span>(false)
  └─ 冻结可冻结的内核线程（没有PF_NOFREEZE标志的）
</code></pre>
<h3 data-id="heading-23">5.2 实际流程（从日志看）</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">suspend_freeze_processes</span>()
  ↓
<span class="hljs-built_in">freeze_processes</span>()  <span class="hljs-selector-attr">[第一阶段]</span>
  ├─ 设置 pm_freezing = true
  ├─ 调用 <span class="hljs-built_in">try_to_freeze_tasks</span>(true)
  ├─ 冻结用户空间进程（部分成功，<span class="hljs-number">3</span>个）
  └─ ❌ 超时失败（error -<span class="hljs-number">16</span>）
  ↓
❌ 直接返回错误，不执行第二阶段
  ↓
FORCE SUSPEND启用，继续挂起
  ↓
系统在不完整的状态下进入深度睡眠
</code></pre>
<h2 data-id="heading-24">六、结论</h2>
<h3 data-id="heading-25">6.1 关键结论</h3>
<p><strong>是的，您确实没有冻结应该被冻结的内核线程！</strong></p>
<p><strong>原因</strong>：</p>
<ol>
<li>第一阶段（冻结用户空间进程）失败</li>
<li>因为第一阶段失败，第二阶段（冻结内核线程）<strong>根本没有执行</strong></li>
<li>系统启用了强制挂起，即使冻结失败也继续挂起</li>
<li>结果：应该被冻结的内核线程（没有PF_NOFREEZE标志的）没有被冻结</li>
</ol>
<h3 data-id="heading-26">6.2 影响</h3>
<ol>
<li>
<p><strong>kswapd0和jbd2线程</strong>：</p>
<ul>
<li>没有PF_NOFREEZE标志，应该被冻结</li>
<li>第一阶段尝试冻结它们，但失败了</li>
<li>第二阶段应该再次尝试，但第二阶段没有执行</li>
<li><strong>结果：它们没有被冻结</strong></li>
</ul>
</li>
<li>
<p><strong>其他应该被冻结的内核线程</strong>：</p>
<ul>
<li>没有PF_NOFREEZE标志</li>
<li>第一阶段不会冻结它们（只冻结用户空间进程）</li>
<li>第二阶段应该冻结它们，但第二阶段没有执行</li>
<li><strong>结果：它们也没有被冻结</strong></li>
</ul>
</li>
<li>
<p><strong>系统状态</strong>：</p>
<ul>
<li>只有3个用户空间进程被冻结</li>
<li>应该被冻结的内核线程都没有被冻结</li>
<li>系统在不一致的状态下进入深度睡眠</li>
<li><strong>这很可能是唤醒失败的根本原因</strong></li>
</ul>
</li>
</ol>
<h3 data-id="heading-27">6.3 建议</h3>
<ol>
<li>
<p><strong>禁用强制挂起模式</strong>：</p>
<ul>
<li>如果冻结失败，应该取消挂起，而不是强制继续</li>
<li>这样可以避免系统在不完整的状态下进入深度睡眠</li>
</ul>
</li>
<li>
<p><strong>优化冻结机制</strong>：</p>
<ul>
<li>解决第一阶段冻结失败的问题</li>
<li>确保能够进入第二阶段，冻结内核线程</li>
</ul>
</li>
<li>
<p><strong>增加调试信息</strong>：</p>
<ul>
<li>记录哪些内核线程应该被冻结但没有被冻结</li>
<li>帮助诊断问题</li>
</ul>
</li>
</ol>
<h2 data-id="heading-28">七、内核线程分类总结</h2>
<h3 data-id="heading-29">7.1 完整分类表</h3>








































<table><thead><tr><th>类别</th><th>数量</th><th>特征</th><th>是否需要冻结</th><th>实际行为</th></tr></thead><tbody><tr><td><strong>成功冻结</strong></td><td>3</td><td>用户空间进程</td><td>✅ 需要</td><td>成功冻结</td></tr><tr><td><strong>UNFREEZABLE</strong></td><td>95</td><td>有PF_NOFREEZE标志</td><td>❌ 不需要</td><td>标记为UNFREEZABLE，跳过冻结</td></tr><tr><td><strong>FAILED_FREEZE</strong></td><td>6</td><td>没有PF_NOFREEZE标志</td><td>✅ 需要</td><td>尝试冻结但失败</td></tr><tr><td><strong>跳过</strong></td><td>18</td><td>其他被跳过的任务</td><td>-</td><td>被跳过</td></tr></tbody></table>
<h3 data-id="heading-30">7.2 关键结论</h3>
<ol>
<li>
<p><strong>其他内核线程（95个）都是不需要冻结的</strong>：</p>
<ul>
<li>它们都有<code>PF_NOFREEZE</code>标志</li>
<li>这是正确的行为，这些内核线程不应该被冻结</li>
<li>包括：kthreadd、rcu_gp、所有kworker线程、中断处理线程等</li>
</ul>
</li>
<li>
<p><strong>只有6个内核线程是应该被冻结但没有成功冻结的</strong>：</p>
<ul>
<li>它们没有<code>PF_NOFREEZE</code>标志</li>
<li>应该被冻结，但冻结失败</li>
<li>包括：kswapd0和5个jbd2线程</li>
</ul>
</li>
<li>
<p><strong>系统中没有其他应该被冻结但没有被尝试冻结的内核线程</strong>：</p>
<ul>
<li>从日志看，只有这6个内核线程没有<code>PF_NOFREEZE</code>标志</li>
<li>这6个线程都被尝试冻结了（虽然失败了）</li>
<li>其他所有内核线程都有<code>PF_NOFREEZE</code>标志，不需要冻结</li>
</ul>
</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[python--面向对象（3）]]></title>    <link>https://juejin.cn/post/7585395972294410249</link>    <guid>https://juejin.cn/post/7585395972294410249</guid>    <pubDate>2025-12-19T14:50:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585395972294410249" data-draft-id="7585406229168013362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="python--面向对象（3）"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-19T14:50:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="酷酷的佳"/> <meta itemprop="url" content="https://juejin.cn/user/2939463340923272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            python--面向对象（3）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2939463340923272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    酷酷的佳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T14:50:52.000Z" title="Fri Dec 19 2025 14:50:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、常用魔术方法（特殊方法）</h2>
<p>Python 中以 <code>__</code> 开头和结尾的方法称为 “魔术方法”，用于自定义对象的行为：</p>



































<table><thead><tr><th>方法</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>__init__</code></td><td>初始化实例</td><td><code>def __init__(self, name): ...</code></td></tr><tr><td><code>__str__</code></td><td>打印实例时的字符串</td><td><code>def __str__(self): return f"Person({self.name})"</code></td></tr><tr><td><code>__repr__</code></td><td>交互式解释器显示的字符串</td><td><code>def __repr__(self): return f"Person('{self.name}')"</code></td></tr><tr><td><code>__add__</code></td><td>重载 + 运算符</td><td><code>def __add__(self, other): return self.age + other.age</code></td></tr><tr><td><code>__len__</code></td><td>重载 len () 函数</td><td><code>def __len__(self): return len(self.name)</code></td></tr></tbody></table>
<p>示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        self.name = name
        self.age = age
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"Person(name=<span class="hljs-subst">{self.name}</span>, age=<span class="hljs-subst">{self.age}</span>)"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__add__</span>(<span class="hljs-params">self, other</span>):
        <span class="hljs-keyword">return</span> self.age + other.age

p1 = Person(<span class="hljs-string">"张三"</span>, <span class="hljs-number">18</span>)
p2 = Person(<span class="hljs-string">"李四"</span>, <span class="hljs-number">19</span>)

<span class="hljs-built_in">print</span>(p1)        <span class="hljs-comment"># 输出：Person(name=张三, age=18)（调用 __str__）</span>
<span class="hljs-built_in">print</span>(p1 + p2)   <span class="hljs-comment"># 输出：37（调用 __add__）</span>
</code></pre>
<h2 data-id="heading-1">二、抽象类</h2>
<p>抽象类是包含 “抽象方法” 的类，不能实例化，子类必须实现抽象方法（强制规范子类行为），需借助 <code>abc</code> 模块：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> abc <span class="hljs-keyword">import</span> ABCMeta, abstractmethod

<span class="hljs-comment"># 抽象类：继承 ABCMeta</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Shape</span>(metaclass=ABCMeta):
    <span class="hljs-comment"># 抽象方法：只有定义，无实现</span>
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">area</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">pass</span>

<span class="hljs-comment"># 子类必须实现抽象方法</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span>(<span class="hljs-title class_ inherited__">Shape</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, radius</span>):
        self.radius = radius
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">area</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-number">3.14</span> * self.radius **<span class="hljs-number">2</span>

<span class="hljs-comment"># shape = Shape()  # 报错：无法实例化抽象类</span>
circle = Circle(<span class="hljs-number">5</span>)
<span class="hljs-built_in">print</span>(circle.area())  <span class="hljs-comment"># 输出：78.5</span>
</code></pre>
<h2 data-id="heading-2">三、组合：替代多继承的复用方式</h2>
<p>组合是将 “其他类的实例” 作为当前类的属性，实现代码复用（比多继承更灵活）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 引擎类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Engine</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"引擎启动"</span>)

<span class="hljs-comment"># 汽车类（组合引擎类）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.engine = Engine()  <span class="hljs-comment"># 组合：将 Engine 实例作为属性</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>(<span class="hljs-params">self</span>):
        self.engine.run()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"汽车启动"</span>)

car = Car()
car.start()
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># 引擎启动</span>
<span class="hljs-comment"># 汽车启动</span>
</code></pre>
<h2 data-id="heading-3">四、核心总结</h2>
<ol>
<li>
<p><strong>类与对象</strong>：类是模板，对象是实例，<code>self</code> 指代当前实例；</p>
</li>
<li>
<p><strong>属性</strong>：实例属性（独有）、类属性（共享）；</p>
</li>
<li>
<p><strong>方法</strong>：实例方法（<code>self</code>）、类方法（<code>@classmethod + cls</code>）、静态方法（<code>@staticmethod</code>）；</p>
</li>
<li>
<p><strong>三大特性</strong>：</p>
<ul>
<li>封装：私有属性 / 方法 + <code>@property</code> 隐藏细节；</li>
<li>继承：<code>class 子类(父类)</code>，<code>super()</code> 调用父类方法；</li>
<li>多态：子类重写父类方法，统一接口调用；</li>
</ul>
</li>
<li>
<p><strong>进阶</strong>：魔术方法自定义对象行为，抽象类强制子类规范，组合替代多继承实现复用。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[二进制安装Kubernetes（k8s）v1.35.0]]></title>    <link>https://juejin.cn/post/7585395972294524937</link>    <guid>https://juejin.cn/post/7585395972294524937</guid>    <pubDate>2025-12-19T15:42:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585395972294524937" data-draft-id="7585227038992285734" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="二进制安装Kubernetes（k8s）v1.35.0"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-12-19T15:42:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小陈运维"/> <meta itemprop="url" content="https://juejin.cn/user/3315782802482007"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            二进制安装Kubernetes（k8s）v1.35.0
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3315782802482007/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小陈运维
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T15:42:05.000Z" title="Fri Dec 19 2025 15:42:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">二进制安装Kubernetes（k8s）v1.35.0</h2>
<h2 data-id="heading-1">介绍</h2>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcby-chen%2FKubernetes" target="_blank" title="https://github.com/cby-chen/Kubernetes" ref="nofollow noopener noreferrer">github.com/cby-chen/Ku…</a> 开源不易，帮忙点个star，谢谢了</h3>
<h3 data-id="heading-3">支持IPv4+IPv6双栈。本文是精简文档，删除了注释以及一些基础的内容，社交媒体超出字数限制，完整版见：</h3>
<h3 data-id="heading-4">项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcby-chen%2FKubernetes" target="_blank" title="https://github.com/cby-chen/Kubernetes" ref="nofollow noopener noreferrer">github.com/cby-chen/Ku…</a></h3>
<h2 data-id="heading-5">1.环境</h2>





















































<table><thead><tr><th>主机名称</th><th>IP地址</th><th>说明</th><th>软件</th></tr></thead><tbody><tr><td/><td>192.168.1.60</td><td>外网节点</td><td>下载各种所需安装包</td></tr><tr><td>Master01</td><td>192.168.1.31</td><td>master节点</td><td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br/>kubelet、kube-proxy、nfs-client、haproxy、keepalived、nginx</td></tr><tr><td>Master02</td><td>192.168.1.32</td><td>master节点</td><td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br/>kubelet、kube-proxy、nfs-client、haproxy、keepalived、nginx</td></tr><tr><td>Master03</td><td>192.168.1.33</td><td>master节点</td><td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br/>kubelet、kube-proxy、nfs-client、haproxy、keepalived、nginx</td></tr><tr><td>Node01</td><td>192.168.1.34</td><td>node节点</td><td>kubelet、kube-proxy、nfs-client、nginx</td></tr><tr><td>Node02</td><td>192.168.1.35</td><td>node节点</td><td>kubelet、kube-proxy、nfs-client、nginx</td></tr><tr><td/><td>192.168.1.36</td><td>VIP</td><td/></tr></tbody></table>
<p>详细版本</p>

























































<table><thead><tr><th>软件</th><th>版本</th></tr></thead><tbody><tr><td>cni_plugins_version</td><td>v1.9.0</td></tr><tr><td>cri_containerd_cni_version</td><td>2.2.1</td></tr><tr><td>crictl_version</td><td>v1.35.0</td></tr><tr><td>cri_dockerd_version</td><td>0.3.21</td></tr><tr><td>etcd_version</td><td>v3.6.7</td></tr><tr><td>cfssl_version</td><td>1.6.5</td></tr><tr><td>kubernetes_server_version</td><td>1.35.0</td></tr><tr><td>docker_version</td><td>29.1.3</td></tr><tr><td>runc_version</td><td>1.4.0</td></tr><tr><td>kernel_version</td><td>6.16.4</td></tr><tr><td>helm_version</td><td>4.0.4</td></tr><tr><td>nginx_version</td><td>1.29.4</td></tr></tbody></table>
<p>网段  <br/></p>
<p>IPv4   <br/>
物理主机：192.168.1.0/24  <br/>
service：10.96.0.0/12  <br/>
pod：172.16.0.0/12 <br/></p>
<p>IPv6   <br/>
物理主机：2408:822a:732:5ce1::1001/64  <br/>
物理主机：fc00::31/8  <br/>
service：fd00:1111::/112  <br/>
pod：fc00:2222::/112</p>
<p>安装包已经整理好：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcby-chen%2FKubernetes%2Freleases%2Fdownload%2Fv1.35.0%2Fkubernetes-v1.35.0.tar" target="_blank" title="https://github.com/cby-chen/Kubernetes/releases/download/v1.35.0/kubernetes-v1.35.0.tar" ref="nofollow noopener noreferrer">github.com/cby-chen/Ku…</a></p>
<h3 data-id="heading-6">1.1.k8s基础系统环境配置</h3>
<h4 data-id="heading-7">1.2.配置IP</h4>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-8">1.3.设置主机名</h4>
<pre><code class="hljs language-shell" lang="shell">hostnamectl set-hostname k8s-master01
hostnamectl set-hostname k8s-master02
hostnamectl set-hostname k8s-master03
hostnamectl set-hostname k8s-node01
hostnamectl set-hostname k8s-node02
</code></pre>
<h4 data-id="heading-9">1.4.配置yum源</h4>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-10">1.5.安装一些必备工具</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">对于 Ubuntu</span>
apt update &amp;&amp; apt upgrade -y &amp;&amp; apt install -y wget psmisc vim net-tools nfs-kernel-server telnet lvm2 git tar curl
<span class="hljs-meta prompt_">
# </span><span class="bash">对于 CentOS 7</span>
yum update -y &amp;&amp; yum -y install  wget psmisc vim net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 git tar curl
<span class="hljs-meta prompt_">
# </span><span class="bash">对于 CentOS 8</span>
yum update -y &amp;&amp; yum -y install wget psmisc vim net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 git network-scripts tar curl
<span class="hljs-meta prompt_">
# </span><span class="bash">对于 CentOS 9</span>
yum update -y &amp;&amp; yum -y install wget psmisc vim net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 git tar curl
</code></pre>
<h5 data-id="heading-11">1.5.1 下载离线所需文件(可选)</h5>
<p>在互联网服务器上安装一个一模一样的系统进行下载所需包</p>
<h6 data-id="heading-12">CentOS7</h6>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h6 data-id="heading-13">CentOS8</h6>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h6 data-id="heading-14">CentOS9</h6>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h6 data-id="heading-15">Ubuntu 下载包和依赖</h6>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-16">1.6.选择性下载需要工具</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">!/bin/bash</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">查看版本地址：</span>
<span class="hljs-meta prompt_"># </span><span class="bash">
<span class="hljs-comment"># https://github.com/containernetworking/plugins/releases/</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/containerd/containerd/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/kubernetes-sigs/cri-tools/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/Mirantis/cri-dockerd/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/etcd-io/etcd/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/cloudflare/cfssl/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://download.docker.com/linux/static/stable/x86_64/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/opencontainers/runc/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/helm/helm/tags</span>
<span class="hljs-meta prompt_"># </span><span class="bash">http://nginx.org/download/</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">Version numbers</span>
cni_plugins_version='v1.9.0'
cri_containerd_cni_version='2.2.1'
crictl_version='v1.35.0'
cri_dockerd_version='0.3.21'
etcd_version='v3.6.7'
cfssl_version='1.6.5'
kubernetes_server_version='1.35.0'
docker_version='29.1.3'
runc_version='1.4.0'
kernel_version='5.4.278'
helm_version='4.0.4'
nginx_version='1.29.4'
<span class="hljs-meta prompt_">
# </span><span class="bash">URLs</span> 
base_url='https://github.com'
kernel_url="http://mirrors.tuna.tsinghua.edu.cn/elrepo/kernel/el7/x86_64/RPMS/kernel-lt-${kernel_version}-1.el7.elrepo.x86_64.rpm"
runc_url="${base_url}/opencontainers/runc/releases/download/v${runc_version}/runc.amd64"
docker_url="https://mirrors.ustc.edu.cn/docker-ce/linux/static/stable/x86_64/docker-${docker_version}.tgz"
cni_plugins_url="${base_url}/containernetworking/plugins/releases/download/${cni_plugins_version}/cni-plugins-linux-amd64-${cni_plugins_version}.tgz"
cri_containerd_cni_url="${base_url}/containerd/containerd/releases/download/v${cri_containerd_cni_version}/containerd-${cri_containerd_cni_version}-linux-amd64.tar.gz"
crictl_url="${base_url}/kubernetes-sigs/cri-tools/releases/download/${crictl_version}/crictl-${crictl_version}-linux-amd64.tar.gz"
cri_dockerd_url="${base_url}/Mirantis/cri-dockerd/releases/download/v${cri_dockerd_version}/cri-dockerd-${cri_dockerd_version}.amd64.tgz"
etcd_url="${base_url}/etcd-io/etcd/releases/download/${etcd_version}/etcd-${etcd_version}-linux-amd64.tar.gz"
cfssl_url="${base_url}/cloudflare/cfssl/releases/download/v${cfssl_version}/cfssl_${cfssl_version}_linux_amd64"
cfssljson_url="${base_url}/cloudflare/cfssl/releases/download/v${cfssl_version}/cfssljson_${cfssl_version}_linux_amd64"
helm_url="https://mirrors.huaweicloud.com/helm/v${helm_version}/helm-v${helm_version}-linux-amd64.tar.gz"
kubernetes_server_url="https://cdn.dl.k8s.io/release/v${kubernetes_server_version}/kubernetes-server-linux-amd64.tar.gz"
nginx_url="http://nginx.org/download/nginx-${nginx_version}.tar.gz"
<span class="hljs-meta prompt_">
# </span><span class="bash">Download packages</span>
packages=(
<span class="hljs-meta prompt_">  # </span><span class="bash"><span class="hljs-variable">$kernel_url</span></span>
<span class="hljs-meta prompt_">  $</span><span class="bash">runc_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">docker_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">cni_plugins_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">cri_containerd_cni_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">crictl_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">cri_dockerd_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">etcd_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">cfssl_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">cfssljson_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">helm_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">kubernetes_server_url</span>
<span class="hljs-meta prompt_">  $</span><span class="bash">nginx_url</span>
)

for package_url in "${packages[@]}"; do
  filename=$(basename "$package_url")
  if curl --parallel --parallel-immediate -k -L -C - -o "$filename" "$package_url"; then
    echo "Downloaded $filename"
  else
    echo "Failed to download $filename"
    exit 1
  fi
done
</code></pre>
<h4 data-id="heading-17">1.7.关闭防火墙</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">Ubuntu忽略，CentOS执行</span>
systemctl disable --now firewalld
</code></pre>
<h4 data-id="heading-18">1.8.关闭SELinux</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">Ubuntu忽略，CentOS执行</span>
setenforce 0
sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config
</code></pre>
<h4 data-id="heading-19">1.9.关闭交换分区</h4>
<pre><code class="hljs language-shell" lang="shell">sed -ri 's/.*swap.*/#&amp;/' /etc/fstab
swapoff -a &amp;&amp; sysctl -w vm.swappiness=0

cat /etc/fstab
<span class="hljs-meta prompt_"># </span><span class="bash">/dev/mapper/centos-swap swap                    swap    defaults        0 0</span>
</code></pre>
<h4 data-id="heading-20">1.10.网络配置（俩种方式二选一）</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">Ubuntu忽略，CentOS执行，CentOS9不支持方式一</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">方式一</span>
<span class="hljs-meta prompt_"># </span><span class="bash">systemctl <span class="hljs-built_in">disable</span> --now NetworkManager</span>
<span class="hljs-meta prompt_"># </span><span class="bash">systemctl start network &amp;&amp; systemctl <span class="hljs-built_in">enable</span> network</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">方式二</span>
cat &gt; /etc/NetworkManager/conf.d/calico.conf &lt;&lt; EOF 
[keyfile]
unmanaged-devices=interface-name:cali*;interface-name:tunl*
EOF
systemctl restart NetworkManager
</code></pre>
<h4 data-id="heading-21">1.11.进行时间同步</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">服务端</span>
<span class="hljs-meta prompt_"># </span><span class="bash">apt install chrony -y</span>
yum install chrony -y
cat &gt; /etc/chrony.conf &lt;&lt; EOF 
pool ntp.aliyun.com iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
allow 192.168.1.0/24
local stratum 10
keyfile /etc/chrony.keys
leapsectz right/UTC
logdir /var/log/chrony
EOF

systemctl restart chronyd ; systemctl enable chronyd
<span class="hljs-meta prompt_">
# </span><span class="bash">客户端</span>
<span class="hljs-meta prompt_"># </span><span class="bash">apt install chrony -y</span>
yum install chrony -y
cat &gt; /etc/chrony.conf &lt;&lt; EOF 
pool 192.168.1.31 iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
keyfile /etc/chrony.keys
leapsectz right/UTC
logdir /var/log/chrony
EOF

systemctl restart chronyd ; systemctl enable chronyd
<span class="hljs-meta prompt_">
#</span><span class="bash">使用客户端进行验证</span>
chronyc sources -v
</code></pre>
<h4 data-id="heading-22">1.12.配置ulimit</h4>
<pre><code class="hljs language-shell" lang="shell">ulimit -SHn 65535
cat &gt;&gt; /etc/security/limits.conf &lt;&lt;EOF
* soft nofile 655360
* hard nofile 131072
* soft nproc 655350
* hard nproc 655350
* seft memlock unlimited
* hard memlock unlimitedd
EOF
</code></pre>
<h4 data-id="heading-23">1.13.配置免密登录</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">apt install -y sshpass</span>
yum install -y sshpass
ssh-keygen -f /root/.ssh/id_rsa -P ''
export IP="192.168.1.31 192.168.1.32 192.168.1.33 192.168.1.34 192.168.1.35"
export SSHPASS=123123
for HOST in $IP;do
     sshpass -e ssh-copy-id -o StrictHostKeyChecking=no $HOST
done
</code></pre>
<h4 data-id="heading-24">1.14.添加启用源</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">Ubuntu忽略，CentOS执行</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">为 RHEL-9或 CentOS-9配置源</span>
yum install https://www.elrepo.org/elrepo-release-9.el9.elrepo.noarch.rpm -y 
sed -i "s@mirrorlist@#mirrorlist@g" /etc/yum.repos.d/elrepo.repo 
sed -i "s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g" /etc/yum.repos.d/elrepo.repo 
<span class="hljs-meta prompt_">
# </span><span class="bash">为 RHEL-8或 CentOS-8配置源</span>
yum install https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm -y 
sed -i "s@mirrorlist@#mirrorlist@g" /etc/yum.repos.d/elrepo.repo 
sed -i "s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g" /etc/yum.repos.d/elrepo.repo 
<span class="hljs-meta prompt_">
# </span><span class="bash">为 RHEL-7 SL-7 或 CentOS-7 安装 ELRepo</span> 
yum install https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm -y 
sed -i "s@mirrorlist@#mirrorlist@g" /etc/yum.repos.d/elrepo.repo 
sed -i "s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g" /etc/yum.repos.d/elrepo.repo 
<span class="hljs-meta prompt_">
# </span><span class="bash">查看可用安装包</span>
yum  --disablerepo="*"  --enablerepo="elrepo-kernel"  list  available
</code></pre>
<h4 data-id="heading-25">1.15.升级内核至4.18版本以上</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">Ubuntu忽略，CentOS执行</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">安装最新的内核</span>
<span class="hljs-meta prompt_"># </span><span class="bash">我这里选择的是稳定版kernel-ml   如需更新长期维护版本kernel-lt</span>  
yum -y --enablerepo=elrepo-kernel  install  kernel-ml
<span class="hljs-meta prompt_">
# </span><span class="bash">查看已安装那些内核</span>
rpm -qa | grep kernel
<span class="hljs-meta prompt_">
# </span><span class="bash">查看默认内核</span>
grubby --default-kernel
<span class="hljs-meta prompt_">
# </span><span class="bash">若不是最新的使用命令设置</span>
grubby --set-default $(ls /boot/vmlinuz-* | grep elrepo)
<span class="hljs-meta prompt_">
# </span><span class="bash">重启生效</span>
reboot
<span class="hljs-meta prompt_">
# </span><span class="bash">v8 整合命令为：</span>
yum install https://www.elrepo.org/elrepo-release-9.el9.elrepo.noarch.rpm -y ; sed -i "s@mirrorlist@#mirrorlist@g" /etc/yum.repos.d/elrepo.repo ; sed -i "s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g" /etc/yum.repos.d/elrepo.repo ; yum  --disablerepo="*"  --enablerepo="elrepo-kernel"  list  available -y ; yum  --enablerepo=elrepo-kernel  install kernel-lt -y ; grubby --default-kernel ; reboot 
<span class="hljs-meta prompt_">
# </span><span class="bash">v8 整合命令为：</span>
yum install https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm -y ; sed -i "s@mirrorlist@#mirrorlist@g" /etc/yum.repos.d/elrepo.repo ; sed -i "s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g" /etc/yum.repos.d/elrepo.repo ; yum  --disablerepo="*"  --enablerepo="elrepo-kernel"  list  available -y ; yum  --enablerepo=elrepo-kernel  install kernel-lt -y ; grubby --default-kernel ; reboot 
<span class="hljs-meta prompt_">
# </span><span class="bash">v7 整合命令为：</span>
yum install https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm -y ; sed -i "s@mirrorlist@#mirrorlist@g" /etc/yum.repos.d/elrepo.repo ; sed -i "s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g" /etc/yum.repos.d/elrepo.repo ; yum  --disablerepo="*"  --enablerepo="elrepo-kernel"  list  available -y ; yum  --enablerepo=elrepo-kernel  install  kernel-lt -y ; grubby --set-default $(ls /boot/vmlinuz-* | grep elrepo) ; grubby --default-kernel ; reboot 
<span class="hljs-meta prompt_">
# </span><span class="bash">离线版本</span> 
yum install -y /root/cby/kernel-lt-*-1.el7.elrepo.x86_64.rpm ; grubby --set-default $(ls /boot/vmlinuz-* | grep elrepo) ; grubby --default-kernel ; reboot 
</code></pre>
<h4 data-id="heading-26">1.16.安装ipvsadm</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">对于CentOS7离线安装</span>
<span class="hljs-meta prompt_"># </span><span class="bash">yum install /root/centos7/ipset-*.el7.x86_64.rpm /root/centos7/lm_sensors-libs-*.el7.x86_64.rpm  /root/centos7/ipset-libs-*.el7.x86_64.rpm /root/centos7/sysstat-*.el7_9.x86_64.rpm  /root/centos7/ipvsadm-*.el7.x86_64.rpm  -y</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">对于 Ubuntu</span>
<span class="hljs-meta prompt_"># </span><span class="bash">apt install ipvsadm ipset sysstat conntrack -y</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">对于 CentOS</span>
yum install ipvsadm ipset sysstat conntrack libseccomp -y
cat &gt;&gt; /etc/modules-load.d/ipvs.conf &lt;&lt;EOF 
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip
EOF

systemctl restart systemd-modules-load.service

lsmod | grep -e ip_vs -e nf_conntrack
ip_vs_sh               16384  0
ip_vs_wrr              16384  0
ip_vs_rr               16384  0
ip_vs                 237568  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr
nf_conntrack          217088  3 nf_nat,nft_ct,ip_vs
nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs
nf_defrag_ipv4         16384  1 nf_conntrack
libcrc32c              16384  5 nf_conntrack,nf_nat,nf_tables,xfs,ip_vs

</code></pre>
<h4 data-id="heading-27">1.17.修改内核参数</h4>
<pre><code class="hljs language-shell" lang="shell">cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
fs.may_detach_mounts = 1
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.netfilter.nf_conntrack_max=2310720

net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl =15
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_max_orphans = 327680
net.ipv4.tcp_orphan_retries = 3
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.ip_conntrack_max = 65536
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_timestamps = 0
net.core.somaxconn = 16384

net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
net.ipv6.conf.all.forwarding = 1
EOF

sysctl --system
</code></pre>
<h4 data-id="heading-28">1.18.所有节点配置hosts本地解析</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /etc/hosts &lt;&lt;EOF
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.1.31 k8s-master01
192.168.1.32 k8s-master02
192.168.1.33 k8s-master03
192.168.1.34 k8s-node01
192.168.1.35 k8s-node02
192.168.1.36 lb-vip

fc00::31 k8s-master01
fc00::32 k8s-master02
fc00::33 k8s-master03
fc00::34 k8s-node01
fc00::35 k8s-node02
EOF
</code></pre>
<h2 data-id="heading-29">2.k8s基本组件安装</h2>
<p><strong>注意 ： 2.1 和 2.2 二选其一即可</strong></p>
<h3 data-id="heading-30">2.1.安装Containerd作为Runtime</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/containernetworking/plugins/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget https://github.com/containernetworking/plugins/releases/download/v1.7.1/cni-plugins-linux-amd64-v1.7.1.tgz</span>

cd cby/
<span class="hljs-meta prompt_">
#</span><span class="bash">创建cni插件所需目录</span>
mkdir -p /etc/cni/net.d /opt/cni/bin 
<span class="hljs-meta prompt_">#</span><span class="bash">解压cni二进制包</span>
tar xf cni-plugins-linux-amd64-v*.tgz -C /opt/cni/bin/
<span class="hljs-meta prompt_">
# </span><span class="bash">https://github.com/containerd/containerd/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget https://github.com/containerd/containerd/releases/download/v2.0.5/containerd-2.0.5-linux-amd64.tar.gz</span>
<span class="hljs-meta prompt_">
#</span><span class="bash">解压</span>
tar -xzf containerd-*-linux-amd64.tar.gz -C /usr/local/
<span class="hljs-meta prompt_">
#</span><span class="bash">创建服务启动文件</span>
cat &gt; /etc/systemd/system/containerd.service &lt;&lt;EOF
[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target local-fs.target

[Service]
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/local/bin/containerd
Type=notify
Delegate=yes
KillMode=process
Restart=always
RestartSec=5
LimitNPROC=infinity
LimitCORE=infinity
LimitNOFILE=infinity
TasksMax=infinity
OOMScoreAdjust=-999

[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<h4 data-id="heading-31">2.1.1配置Containerd所需的模块</h4>
<pre><code class="hljs language-shell" lang="shell">cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf
overlay
br_netfilter
EOF
</code></pre>
<h4 data-id="heading-32">2.1.2加载模块</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl restart systemd-modules-load.service
</code></pre>
<h4 data-id="heading-33">2.1.3配置Containerd所需的内核</h4>
<pre><code class="hljs language-shell" lang="shell">cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">加载内核</span>
sysctl --system
</code></pre>
<h4 data-id="heading-34">2.1.4创建Containerd的配置文件</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">创建默认配置文件</span>
mkdir -p /etc/containerd
containerd config default | tee /etc/containerd/config.toml
<span class="hljs-meta prompt_">
# </span><span class="bash">修改Containerd的配置文件</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">sed -i <span class="hljs-string">"s#SystemdCgroup\ \=\ false#SystemdCgroup\ \=\ true#g"</span> /etc/containerd/config.toml</span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">cat</span> /etc/containerd/config.toml | grep SystemdCgroup</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">沙箱pause镜像</span>
sed -i "s#registry.k8s.io#registry.aliyuncs.com/chenby#g" /etc/containerd/config.toml
cat /etc/containerd/config.toml | grep sandbox
<span class="hljs-meta prompt_">
# </span><span class="bash">配置加速器</span>
[root@k8s-master01 ~]# vim /etc/containerd/config.toml
[root@k8s-master01 ~]# cat /etc/containerd/config.toml | grep certs.d -C 5

    [plugins.'io.containerd.cri.v1.images'.pinned_images]
      sandbox = 'registry.aliyuncs.com/chenby/pause:3.10'

    [plugins.'io.containerd.cri.v1.images'.registry]
      config_path = '/etc/containerd/certs.d'

    [plugins.'io.containerd.cri.v1.images'.image_decryption]
      key_model = 'node'

  [plugins.'io.containerd.cri.v1.runtime']
[root@k8s-master01 ~]# 


mkdir /etc/containerd/certs.d/docker.io -pv
cat &gt; /etc/containerd/certs.d/docker.io/hosts.toml &lt;&lt; EOF
server = "https://docker.io"
[host."https://jockerhub.com"]
  capabilities = ["pull", "resolve"]
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">配置 GFW 代理</span>
mkdir -p /etc/systemd/system/containerd.service.d
touch /etc/systemd/system/containerd.service.d/http-proxy.conf
tee /etc/systemd/system/containerd.service.d/http-proxy.conf &lt;&lt; EOF
[Service]
Environment="HTTP_PROXY=http://IP:Port"
Environment="HTTPS_PROXY=http://IP:Port"
Environment="NO_PROXY=localhost,127.0.0.1,containerd"
EOF
</code></pre>
<h4 data-id="heading-35">2.1.5启动并设置为开机启动</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl enable --now containerd.service
systemctl stop containerd.service
systemctl start containerd.service
systemctl restart containerd.service
systemctl status containerd.service
</code></pre>
<h4 data-id="heading-36">2.1.6配置crictl客户端连接的运行时位置</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/kubernetes-sigs/cri-tools/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.35.0/crictl-v1.35.0-linux-amd64.tar.gz</span>
<span class="hljs-meta prompt_">
#</span><span class="bash">解压</span>
tar xf crictl-v*-linux-amd64.tar.gz -C /usr/bin/
<span class="hljs-meta prompt_">#</span><span class="bash">生成配置文件</span>
cat &gt; /etc/crictl.yaml &lt;&lt;EOF
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 10
debug: false
EOF
<span class="hljs-meta prompt_">
#</span><span class="bash">测试</span>
systemctl restart  containerd
crictl info
</code></pre>
<h3 data-id="heading-37">2.2 安装docker作为Runtime</h3>
<h4 data-id="heading-38">2.2.1 解压docker程序</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">二进制包下载地址：https://download.docker.com/linux/static/stable/x86_64/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget https://mirrors.ustc.edu.cn/docker-ce/linux/static/stable/x86_64/docker-27.4.0.tgz</span>
<span class="hljs-meta prompt_">
#</span><span class="bash">解压</span>
tar xf docker-*.tgz 
<span class="hljs-meta prompt_">#</span><span class="bash">拷贝二进制文件</span>
cp docker/* /usr/bin/
</code></pre>
<h4 data-id="heading-39">2.2.2 创建containerd的service文件</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">创建containerd的service文件,并且启动</span>
cat &gt;/etc/systemd/system/containerd.service &lt;&lt;EOF
[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target local-fs.target

[Service]
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/bin/containerd
Type=notify
Delegate=yes
KillMode=process
Restart=always
RestartSec=5
LimitNPROC=infinity
LimitCORE=infinity
LimitNOFILE=1048576
TasksMax=infinity
OOMScoreAdjust=-999

[Install]
WantedBy=multi-user.target
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">设置开机自启</span>
systemctl enable --now containerd.service
</code></pre>
<h4 data-id="heading-40">2.2.3 准备docker的service文件</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">准备docker的service文件</span>
cat &gt; /etc/systemd/system/docker.service &lt;&lt;EOF
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network-online.target firewalld.service containerd.service
Wants=network-online.target
Requires=containerd.service

[Service]
Type=notify
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
ExecReload=/bin/kill -s HUP $MAINPID
TimeoutSec=0
RestartSec=2
Restart=always
StartLimitBurst=3
StartLimitInterval=60s
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
Delegate=yes
KillMode=process
OOMScoreAdjust=-500

[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<h4 data-id="heading-41">2.2.4 准备docker的socket文件</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">准备docker的socket文件</span>
cat &gt; /etc/systemd/system/docker.socket &lt;&lt;EOF
[Unit]
Description=Docker Socket for the API

[Socket]
ListenStream=/var/run/docker.sock
SocketMode=0660
SocketUser=root
SocketGroup=docker

[Install]
WantedBy=sockets.target
EOF
</code></pre>
<h4 data-id="heading-42">2.2.5 配置加速器</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">配置加速器</span>
mkdir /etc/docker/ -pv
cat &gt;/etc/docker/daemon.json &lt;&lt;EOF
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "registry-mirrors": [
    "https://jockerhub.com"
  ],
  "max-concurrent-downloads": 10,
  "log-driver": "json-file",
  "log-level": "warn",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
    },
  "data-root": "/var/lib/docker",
  "proxies": {
    "http-proxy": "http://192.168.1.100:7890",
    "https-proxy": "http://192.168.1.100:7890",
    "no-proxy": "localhost"
  }
}
EOF
</code></pre>
<h4 data-id="heading-43">2.2.6 启动docker</h4>
<pre><code class="hljs language-shell" lang="shell">groupadd docker
systemctl daemon-reload
systemctl enable --now docker.service
systemctl enable --now docker.socket
systemctl stop docker.service
systemctl start docker.service
systemctl restart docker.service
systemctl status docker.service
docker info
</code></pre>
<h4 data-id="heading-44">2.2.7 解压cri-docker</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">由于1.24以及更高版本不支持docker所以安装cri-docker</span>
<span class="hljs-meta prompt_"># </span><span class="bash">下载cri-docker</span> 
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/Mirantis/cri-dockerd/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget  https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.16/cri-dockerd-0.3.16.amd64.tgz</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">解压cri-docker</span>
tar xvf cri-dockerd-*.amd64.tgz 
cp -r cri-dockerd/  /usr/bin/
chmod +x /usr/bin/cri-dockerd/cri-dockerd
</code></pre>
<h4 data-id="heading-45">2.2.8 写入启动cri-docker配置文件</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">写入启动配置文件</span>
cat &gt;  /usr/lib/systemd/system/cri-docker.service &lt;&lt;EOF
[Unit]
Description=CRI Interface for Docker Application Container Engine
Documentation=https://docs.mirantis.com
After=network-online.target firewalld.service docker.service
Wants=network-online.target
Requires=docker.service

[Service]
Type=notify
ExecStart=/usr/bin/cri-dockerd/cri-dockerd --network-plugin=cni --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.7
ExecReload=/bin/kill -s HUP $MAINPID
TimeoutSec=0
RestartSec=5
Restart=always
StartLimitBurst=5
StartLimitInterval=60s
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
Delegate=yes
KillMode=process

[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<h4 data-id="heading-46">2.2.9 写入cri-docker的socket配置文件</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">写入socket配置文件</span>
cat &gt; /usr/lib/systemd/system/cri-docker.socket &lt;&lt;EOF
[Unit]
Description=CRI Docker Socket for the API
PartOf=cri-docker.service

[Socket]
ListenStream=%t/cri-dockerd.sock
SocketMode=0660
SocketUser=root
SocketGroup=docker

[Install]
WantedBy=sockets.target
EOF
</code></pre>
<h4 data-id="heading-47">2.2.10 启动cri-docker</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl enable --now cri-docker.service
systemctl restart cri-docker.service
systemctl status cri-docker.service
</code></pre>
<h3 data-id="heading-48">2.3.k8s与etcd下载及安装（仅在master01操作）</h3>
<h4 data-id="heading-49">2.3.1解压k8s安装包</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">下载安装包</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/etcd-io/etcd/releases/</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG</span>
<span class="hljs-meta prompt_"># </span><span class="bash">
<span class="hljs-comment"># wget https://github.com/etcd-io/etcd/releases/download/v3.5.21/etcd-v3.5.21-linux-amd64.tar.gz</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget https://cdn.dl.k8s.io/release/v1.35.0/kubernetes-server-linux-amd64.tar.gz</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">解压k8s安装文件</span>
cd cby
tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy}
<span class="hljs-meta prompt_">
# </span><span class="bash">解压etcd安装文件</span>
tar -xf etcd*.tar.gz &amp;&amp; mv etcd-*/etcd /usr/local/bin/ &amp;&amp; mv etcd-*/etcdctl /usr/local/bin/
<span class="hljs-meta prompt_">
# </span><span class="bash">查看/usr/local/bin下内容</span>
[root@localhost cby]# ll /usr/local/bin/
总用量 398984
-rwxr-xr-x 1 1000 docker 26087608 12月 18 03:41 etcd
-rwxr-xr-x 1 1000 docker 17207480 12月 18 03:41 etcdctl
-rwxr-xr-x 1 root root   85766328 12月 17 20:56 kube-apiserver
-rwxr-xr-x 1 root root   71815352 12月 17 20:56 kube-controller-manager
-rwxr-xr-x 1 root root   58597560 12月 17 20:56 kubectl
-rwxr-xr-x 1 root root   58110244 12月 17 20:56 kubelet
-rwxr-xr-x 1 root root   43258040 12月 17 20:56 kube-proxy
-rwxr-xr-x 1 root root   47685816 12月 17 20:56 kube-scheduler
[root@localhost cby]# 

</code></pre>
<h4 data-id="heading-50">2.3.2查看版本</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]#  kubelet --version
Kubernetes v1.35.0
[root@k8s-master01 ~]# etcdctl version
etcdctl version: 3.6.7
API version: 3.6
[root@k8s-master01 ~]# 
</code></pre>
<h4 data-id="heading-51">2.3.3将组件发送至其他k8s节点</h4>
<pre><code class="hljs language-shell" lang="shell">Master='k8s-master02 k8s-master03'
Work='k8s-node01 k8s-node02'
<span class="hljs-meta prompt_">
# </span><span class="bash">拷贝master组件</span>
for NODE in $Master; do echo $NODE; scp /usr/local/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy} $NODE:/usr/local/bin/; scp /usr/local/bin/etcd* $NODE:/usr/local/bin/; done
<span class="hljs-meta prompt_">
# </span><span class="bash">拷贝work组件</span>
for NODE in $Work; do echo $NODE; scp /usr/local/bin/kube{let,-proxy} $NODE:/usr/local/bin/ ; done
<span class="hljs-meta prompt_">
# </span><span class="bash">所有节点执行</span>
mkdir -p /opt/cni/bin
</code></pre>
<h3 data-id="heading-52">2.3创建证书相关文件</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">请查看Github仓库 或者进行获取已经打好的包</span>
<span class="hljs-meta prompt_"># </span><span class="bash">可以根据下文3.x进行手动部署操作</span> 
https://github.com/cby-chen/Kubernetes/
https://github.com/cby-chen/Kubernetes/tags
https://github.com/cby-chen/Kubernetes/releases/download/v1.35.0/kubernetes-v1.35.0.tar
</code></pre>
<h2 data-id="heading-53">3.相关证书生成</h2>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">master01节点下载证书生成工具</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget <span class="hljs-string">"https://github.com/cloudflare/cfssl/releases/download/v1.6.5/cfssl_1.6.5_linux_amd64"</span> -O /usr/local/bin/cfssl</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget <span class="hljs-string">"https://github.com/cloudflare/cfssl/releases/download/v1.6.5/cfssljson_1.6.5_linux_amd64"</span> -O /usr/local/bin/cfssljson</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">软件包内有</span>
cp cfssl_*_linux_amd64 /usr/local/bin/cfssl
cp cfssljson_*_linux_amd64 /usr/local/bin/cfssljson
<span class="hljs-meta prompt_">
# </span><span class="bash">添加执行权限</span>
chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson
</code></pre>
<h3 data-id="heading-54">3.1.生成etcd证书</h3>
<p>特别说明除外，以下操作在所有master节点操作</p>
<h4 data-id="heading-55">3.1.1所有master节点创建证书存放目录</h4>
<pre><code class="hljs language-shell" lang="shell">mkdir /etc/etcd/ssl -p
</code></pre>
<h4 data-id="heading-56">3.1.2master01节点生成etcd证书</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">写入生成证书所需的配置文件</span>
cat &gt; ca-config.json &lt;&lt; EOF 
{
  "signing": {
    "default": {
      "expiry": "876000h"
    },
    "profiles": {
      "kubernetes": {
        "usages": [
            "signing",
            "key encipherment",
            "server auth",
            "client auth"
        ],
        "expiry": "876000h"
      }
    }
  }
}
EOF

cat &gt; etcd-ca-csr.json  &lt;&lt; EOF 
{
  "CN": "etcd",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "etcd",
      "OU": "Etcd Security"
    }
  ],
  "ca": {
    "expiry": "876000h"
  }
}
EOF
<span class="hljs-meta prompt_"># </span><span class="bash">生成etcd证书和etcd证书的key（如果你觉得以后可能会扩容，可以在ip那多写几个预留出来）</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若没有IPv6 可删除可保留</span> 

cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca

cat &gt; etcd-csr.json &lt;&lt; EOF 
{
  "CN": "etcd",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "etcd",
      "OU": "Etcd Security"
    }
  ]
}
EOF


cfssl gencert \
   -ca=/etc/etcd/ssl/etcd-ca.pem \
   -ca-key=/etc/etcd/ssl/etcd-ca-key.pem \
   -config=ca-config.json \
   -hostname=127.0.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.1.31,192.168.1.32,192.168.1.33,::1 \
   -profile=kubernetes \
   etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd
</code></pre>
<h4 data-id="heading-57">3.1.3将证书复制到其他节点</h4>
<pre><code class="hljs language-shell" lang="shell">Master='k8s-master02 k8s-master03'
for NODE in $Master; do ssh $NODE "mkdir -p /etc/etcd/ssl"; for FILE in etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem; do scp /etc/etcd/ssl/${FILE} $NODE:/etc/etcd/ssl/${FILE}; done; done
</code></pre>
<h3 data-id="heading-58">3.2.生成k8s相关证书</h3>
<p>特别说明除外，以下操作在所有master节点操作</p>
<h4 data-id="heading-59">3.2.1 所有k8s节点创建证书存放目录</h4>
<pre><code class="hljs language-shell" lang="shell">mkdir -p /etc/kubernetes/pki
</code></pre>
<h4 data-id="heading-60">3.2.2 master01节点生成k8s证书</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">写入生成证书所需的配置文件</span>
cat &gt; ca-csr.json   &lt;&lt; EOF 
{
  "CN": "kubernetes",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "Kubernetes",
      "OU": "Kubernetes-manual"
    }
  ],
  "ca": {
    "expiry": "876000h"
  }
}
EOF


cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca

cat &gt; apiserver-csr.json &lt;&lt; EOF 
{
  "CN": "kube-apiserver",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "Kubernetes",
      "OU": "Kubernetes-manual"
    }
  ]
}
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">生成一个根证书 ，多写了一些IP作为预留IP，为将来添加node做准备</span>
<span class="hljs-meta prompt_"># </span><span class="bash">10.96.0.1是service网段的第一个地址，需要计算，192.168.1.36为高可用vip地址</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若没有IPv6 可删除可保留</span> 

cfssl gencert   \
-ca=/etc/kubernetes/pki/ca.pem   \
-ca-key=/etc/kubernetes/pki/ca-key.pem   \
-config=ca-config.json   \
-hostname=10.96.0.1,192.168.1.36,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,x.oiox.cn,z.oiox.cn,192.168.1.31,192.168.1.32,192.168.1.33,192.168.1.34,192.168.1.35,192.168.1.36,192.168.1.37,192.168.1.38,192.168.1.39,192.168.1.40,::1   \
-profile=kubernetes   apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver
</code></pre>
<h4 data-id="heading-61">3.2.3 生成apiserver聚合证书</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; front-proxy-ca-csr.json  &lt;&lt; EOF 
{
  "CN": "kubernetes",
  "key": {
     "algo": "rsa",
     "size": 2048
  },
  "ca": {
    "expiry": "876000h"
  }
}
EOF

cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca 

cat &gt; front-proxy-client-csr.json  &lt;&lt; EOF 
{
  "CN": "front-proxy-client",
  "key": {
     "algo": "rsa",
     "size": 2048
  }
}
EOF

cfssl gencert  \
-ca=/etc/kubernetes/pki/front-proxy-ca.pem   \
-ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem   \
-config=ca-config.json   \
-profile=kubernetes   front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client
</code></pre>
<h4 data-id="heading-62">3.2.4 生成controller-manage的证书</h4>
<p>在《5.高可用配置》选择使用那种高可用方案
若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.1.36:9443</code>
若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code></p>
<pre><code class="hljs language-shell" lang="shell">cat &gt; manager-csr.json &lt;&lt; EOF 
{
  "CN": "system:kube-controller-manager",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "system:kube-controller-manager",
      "OU": "Kubernetes-manual"
    }
  ]
}
EOF


cfssl gencert \
   -ca=/etc/kubernetes/pki/ca.pem \
   -ca-key=/etc/kubernetes/pki/ca-key.pem \
   -config=ca-config.json \
   -profile=kubernetes \
   manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager
<span class="hljs-meta prompt_">

# </span><span class="bash">设置一个集群项</span>
<span class="hljs-meta prompt_"># </span><span class="bash">在《5.高可用配置》选择使用那种高可用方案</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:9443`</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span>
kubectl config set-cluster kubernetes \
     --certificate-authority=/etc/kubernetes/pki/ca.pem \
     --embed-certs=true \
     --server=https://127.0.0.1:8443 \
     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
<span class="hljs-meta prompt_">
# </span><span class="bash">设置一个环境项，一个上下文</span>
kubectl config set-context system:kube-controller-manager@kubernetes \
    --cluster=kubernetes \
    --user=system:kube-controller-manager \
    --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
<span class="hljs-meta prompt_">
  # </span><span class="bash">设置一个用户项</span>
kubectl config set-credentials system:kube-controller-manager \
   --client-certificate=/etc/kubernetes/pki/controller-manager.pem \
   --client-key=/etc/kubernetes/pki/controller-manager-key.pem \
   --embed-certs=true \
   --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
<span class="hljs-meta prompt_">
# </span><span class="bash">设置默认环境</span>
kubectl config use-context system:kube-controller-manager@kubernetes \
     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig

</code></pre>
<h4 data-id="heading-63">3.2.5 生成kube-scheduler的证书</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; scheduler-csr.json &lt;&lt; EOF 
{
  "CN": "system:kube-scheduler",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "system:kube-scheduler",
      "OU": "Kubernetes-manual"
    }
  ]
}
EOF


cfssl gencert \
   -ca=/etc/kubernetes/pki/ca.pem \
   -ca-key=/etc/kubernetes/pki/ca-key.pem \
   -config=ca-config.json \
   -profile=kubernetes \
   scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler
<span class="hljs-meta prompt_">

# </span><span class="bash">在《5.高可用配置》选择使用那种高可用方案</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:9443`</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span>

kubectl config set-cluster kubernetes \
     --certificate-authority=/etc/kubernetes/pki/ca.pem \
     --embed-certs=true \
     --server=https://127.0.0.1:8443 \
     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig


kubectl config set-credentials system:kube-scheduler \
     --client-certificate=/etc/kubernetes/pki/scheduler.pem \
     --client-key=/etc/kubernetes/pki/scheduler-key.pem \
     --embed-certs=true \
     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig


kubectl config set-context system:kube-scheduler@kubernetes \
     --cluster=kubernetes \
     --user=system:kube-scheduler \
     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig

kubectl config use-context system:kube-scheduler@kubernetes \
     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
</code></pre>
<h4 data-id="heading-64">3.2.6 生成admin的证书配置</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; admin-csr.json &lt;&lt; EOF 
{
  "CN": "admin",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "system:masters",
      "OU": "Kubernetes-manual"
    }
  ]
}
EOF


cfssl gencert \
   -ca=/etc/kubernetes/pki/ca.pem \
   -ca-key=/etc/kubernetes/pki/ca-key.pem \
   -config=ca-config.json \
   -profile=kubernetes \
   admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin
<span class="hljs-meta prompt_">
# </span><span class="bash">在《5.高可用配置》选择使用那种高可用方案</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:9443`</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span>

kubectl config set-cluster kubernetes     \
  --certificate-authority=/etc/kubernetes/pki/ca.pem     \
  --embed-certs=true     \
  --server=https://127.0.0.1:8443     \
  --kubeconfig=/etc/kubernetes/admin.kubeconfig

kubectl config set-credentials kubernetes-admin  \
  --client-certificate=/etc/kubernetes/pki/admin.pem     \
  --client-key=/etc/kubernetes/pki/admin-key.pem     \
  --embed-certs=true     \
  --kubeconfig=/etc/kubernetes/admin.kubeconfig

kubectl config set-context kubernetes-admin@kubernetes    \
  --cluster=kubernetes     \
  --user=kubernetes-admin     \
  --kubeconfig=/etc/kubernetes/admin.kubeconfig

kubectl config use-context kubernetes-admin@kubernetes  --kubeconfig=/etc/kubernetes/admin.kubeconfig
</code></pre>
<h4 data-id="heading-65">3.2.7 创建kube-proxy证书</h4>
<p>在《5.高可用配置》选择使用那种高可用方案
若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.1.36:9443</code>
若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code></p>
<pre><code class="hljs language-shell" lang="shell">cat &gt; kube-proxy-csr.json  &lt;&lt; EOF 
{
  "CN": "system:kube-proxy",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "system:kube-proxy",
      "OU": "Kubernetes-manual"
    }
  ]
}
EOF

cfssl gencert \
   -ca=/etc/kubernetes/pki/ca.pem \
   -ca-key=/etc/kubernetes/pki/ca-key.pem \
   -config=ca-config.json \
   -profile=kubernetes \
   kube-proxy-csr.json | cfssljson -bare /etc/kubernetes/pki/kube-proxy
<span class="hljs-meta prompt_">
# </span><span class="bash">在《5.高可用配置》选择使用那种高可用方案</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:9443`</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span>

kubectl config set-cluster kubernetes     \
  --certificate-authority=/etc/kubernetes/pki/ca.pem     \
  --embed-certs=true     \
  --server=https://127.0.0.1:8443     \
  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig


kubectl config set-credentials kube-proxy  \
  --client-certificate=/etc/kubernetes/pki/kube-proxy.pem     \
  --client-key=/etc/kubernetes/pki/kube-proxy-key.pem     \
  --embed-certs=true     \
  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig

kubectl config set-context kube-proxy@kubernetes    \
  --cluster=kubernetes     \
  --user=kube-proxy     \
  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig

kubectl config use-context kube-proxy@kubernetes  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig
</code></pre>
<h4 data-id="heading-66">3.2.8 创建ServiceAccount Key ——secret</h4>
<pre><code class="hljs language-shell" lang="shell">openssl genrsa -out /etc/kubernetes/pki/sa.key 2048
openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub
</code></pre>
<h4 data-id="heading-67">3.2.9 将证书发送到其他master节点</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">其他节点创建目录</span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">mkdir</span>  /etc/kubernetes/pki/ -p</span>

for NODE in k8s-master02 k8s-master03; do  for FILE in $(ls /etc/kubernetes/pki | grep -v etcd); do  scp /etc/kubernetes/pki/${FILE} $NODE:/etc/kubernetes/pki/${FILE}; done;  for FILE in admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig; do  scp /etc/kubernetes/${FILE} $NODE:/etc/kubernetes/${FILE}; done; done
</code></pre>
<h4 data-id="heading-68">3.2.10 查看证书</h4>
<pre><code class="hljs language-shell" lang="shell">[root@localhost cby]# ll /etc/kubernetes/pki/
总用量 104
-rw-r--r-- 1 root root 1025 12月 19 20:22 admin.csr
-rw------- 1 root root 1675 12月 19 20:22 admin-key.pem
-rw-r--r-- 1 root root 1444 12月 19 20:22 admin.pem
-rw-r--r-- 1 root root 1415 12月 19 20:21 apiserver.csr
-rw------- 1 root root 1679 12月 19 20:21 apiserver-key.pem
-rw-r--r-- 1 root root 1805 12月 19 20:21 apiserver.pem
-rw-r--r-- 1 root root 1070 12月 19 20:21 ca.csr
-rw------- 1 root root 1679 12月 19 20:21 ca-key.pem
-rw-r--r-- 1 root root 1363 12月 19 20:21 ca.pem
-rw-r--r-- 1 root root 1082 12月 19 20:21 controller-manager.csr
-rw------- 1 root root 1675 12月 19 20:21 controller-manager-key.pem
-rw-r--r-- 1 root root 1501 12月 19 20:21 controller-manager.pem
-rw-r--r-- 1 root root  940 12月 19 20:21 front-proxy-ca.csr
-rw------- 1 root root 1679 12月 19 20:21 front-proxy-ca-key.pem
-rw-r--r-- 1 root root 1094 12月 19 20:21 front-proxy-ca.pem
-rw-r--r-- 1 root root  903 12月 19 20:21 front-proxy-client.csr
-rw------- 1 root root 1679 12月 19 20:21 front-proxy-client-key.pem
-rw-r--r-- 1 root root 1188 12月 19 20:21 front-proxy-client.pem
-rw-r--r-- 1 root root 1045 12月 19 20:22 kube-proxy.csr
-rw------- 1 root root 1679 12月 19 20:22 kube-proxy-key.pem
-rw-r--r-- 1 root root 1464 12月 19 20:22 kube-proxy.pem
-rw------- 1 root root 1704 12月 19 20:22 sa.key
-rw-r--r-- 1 root root  451 12月 19 20:22 sa.pub
-rw-r--r-- 1 root root 1058 12月 19 20:22 scheduler.csr
-rw------- 1 root root 1679 12月 19 20:22 scheduler-key.pem
-rw-r--r-- 1 root root 1476 12月 19 20:22 scheduler.pem
[root@localhost cby]# 
<span class="hljs-meta prompt_">


# </span><span class="bash">一共26个就对了</span>
ls /etc/kubernetes/pki/ |wc -l
26
</code></pre>
<h2 data-id="heading-69">4.k8s系统组件配置</h2>
<h3 data-id="heading-70">4.1.etcd配置</h3>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-71">4.1.1master01配置</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF 
name: 'k8s-master01'
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.1.31:2380'
listen-client-urls: 'https://192.168.1.31:2379,http://127.0.0.1:2379'
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.1.31:2380'
advertise-client-urls: 'https://192.168.1.31:2379'
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'k8s-master01=https://192.168.1.31:2380,k8s-master02=https://192.168.1.32:2380,k8s-master03=https://192.168.1.33:2380'
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
EOF
</code></pre>
<h4 data-id="heading-72">4.1.2master02配置</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF 
name: 'k8s-master02'
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.1.32:2380'
listen-client-urls: 'https://192.168.1.32:2379,http://127.0.0.1:2379'
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.1.32:2380'
advertise-client-urls: 'https://192.168.1.32:2379'
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'k8s-master01=https://192.168.1.31:2380,k8s-master02=https://192.168.1.32:2380,k8s-master03=https://192.168.1.33:2380'
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
EOF
</code></pre>
<h4 data-id="heading-73">4.1.3master03配置</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF 
name: 'k8s-master03'
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.1.33:2380'
listen-client-urls: 'https://192.168.1.33:2379,http://127.0.0.1:2379'
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.1.33:2380'
advertise-client-urls: 'https://192.168.1.33:2379'
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'k8s-master01=https://192.168.1.31:2380,k8s-master02=https://192.168.1.32:2380,k8s-master03=https://192.168.1.33:2380'
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
EOF
</code></pre>
<h3 data-id="heading-74">4.2.创建service（所有master节点操作）</h3>
<h4 data-id="heading-75">4.2.1创建etcd.service并启动</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF

[Unit]
Description=Etcd Service
Documentation=https://coreos.com/etcd/docs/latest/
After=network.target

[Service]
Type=notify
ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml
TimeoutSec=0
RestartSec=60
Restart=always
StartLimitBurst=3
StartLimitInterval=60s
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity

[Install]
WantedBy=multi-user.target
Alias=etcd3.service

EOF
</code></pre>
<h4 data-id="heading-76">4.2.2创建etcd证书目录</h4>
<pre><code class="hljs language-shell" lang="shell">mkdir /etc/kubernetes/pki/etcd
ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/

systemctl daemon-reload
systemctl enable --now etcd.service
systemctl restart etcd.service
systemctl status etcd.service
</code></pre>
<h4 data-id="heading-77">4.2.3查看etcd状态</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">如果要用IPv6那么把IPv4地址修改为IPv6即可</span>
export ETCDCTL_API=3
etcdctl --endpoints="192.168.1.33:2379,192.168.1.32:2379,192.168.1.31:2379" --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table
+-------------------+------------------+---------+-----------------+---------+--------+-----------------------+--------+-----------+------------+-----------+------------+--------------------+--------+--------------------------+-------------------+
|     ENDPOINT      |        ID        | VERSION | STORAGE VERSION | DB SIZE | IN USE | PERCENTAGE NOT IN USE | QUOTA  | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS | DOWNGRADE TARGET VERSION | DOWNGRADE ENABLED |
+-------------------+------------------+---------+-----------------+---------+--------+-----------------------+--------+-----------+------------+-----------+------------+--------------------+--------+--------------------------+-------------------+
| 192.168.1.33:2379 |  8065f2e59c8d68c |   3.6.7 |           3.6.0 |   20 kB |  16 kB |                   20% | 2.1 GB |     false |      false |         4 |         14 |                 14 |        |                          |             false |
| 192.168.1.32:2379 | b7b7ad6bf4db3f28 |   3.6.7 |           3.6.0 |   20 kB |  16 kB |                   20% | 2.1 GB |      true |      false |         4 |         14 |                 14 |        |                          |             false |
| 192.168.1.31:2379 | bf047bcfe3b9bf27 |   3.6.7 |           3.6.0 |   20 kB |  16 kB |                   20% | 2.1 GB |     false |      false |         4 |         14 |                 14 |        |                          |             false |
+-------------------+------------------+---------+-----------------+---------+--------+-----------------------+--------+-----------+------------+-----------+------------+--------------------+--------+--------------------------+-------------------+
</code></pre>
<h2 data-id="heading-78">5.高可用配置（在Master服务器上操作）</h2>
<p><em><em>注意</em> 5.1.1 和5.1.2 二选一即可</em>*</p>
<p>选择使用那种高可用方案，同时可以俩种都选用，实现内外兼顾的效果，比如：
5.1 的 NGINX方案实现集群内的高可用
5.2 的 haproxy、keepalived 方案实现集群外访问</p>
<p>在《3.2.生成k8s相关证书》</p>
<p>若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code>
若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.1.36:9443</code></p>
<h3 data-id="heading-79">5.1 NGINX高可用方案</h3>
<h4 data-id="heading-80">5.1.1 进行编译</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">安装编译环境</span>
yum install gcc -y
<span class="hljs-meta prompt_">
# </span><span class="bash">下载解压nginx二进制文件</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget http://nginx.org/download/nginx-1.25.3.tar.gz</span>
tar xvf nginx-*.tar.gz
cd nginx-*
<span class="hljs-meta prompt_">
# </span><span class="bash">进行编译</span>
./configure --with-stream --without-http --without-http_uwsgi_module --without-http_scgi_module --without-http_fastcgi_module
make &amp;&amp; make install 
<span class="hljs-meta prompt_">
# </span><span class="bash">拷贝编译好的nginx</span>
node='k8s-master02 k8s-master03 k8s-node01 k8s-node02'
for NODE in $node; do scp -r /usr/local/nginx/ $NODE:/usr/local/nginx/; done

</code></pre>
<h4 data-id="heading-81">5.1.2 写入启动配置</h4>
<p>在所有主机上执行</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">写入nginx配置文件</span>
cat &gt; /usr/local/nginx/conf/kube-nginx.conf &lt;&lt;EOF
worker_processes 1;
events {
    worker_connections  1024;
}
stream {
    upstream backend {
        least_conn;
        hash $remote_addr consistent;
        server 192.168.1.31:6443        max_fails=3 fail_timeout=30s;
        server 192.168.1.32:6443        max_fails=3 fail_timeout=30s;
        server 192.168.1.33:6443        max_fails=3 fail_timeout=30s;
    }
    server {
        listen 127.0.0.1:8443;
        proxy_connect_timeout 1s;
        proxy_pass backend;
    }
}
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">写入启动配置文件</span>
cat &gt; /etc/systemd/system/kube-nginx.service &lt;&lt;EOF
[Unit]
Description=kube-apiserver nginx proxy
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=forking
ExecStartPre=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx -t
ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx
ExecReload=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx -s reload
PrivateTmp=true
Restart=always
RestartSec=5
StartLimitInterval=0
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">设置开机自启</span>
systemctl daemon-reload
systemctl enable --now kube-nginx.service
systemctl restart kube-nginx.service
systemctl status kube-nginx.service
</code></pre>
<h3 data-id="heading-82">5.2 keepalived和haproxy 高可用方案</h3>
<h4 data-id="heading-83">5.2.1安装keepalived和haproxy服务</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl disable --now firewalld
setenforce 0
sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config
yum -y install keepalived haproxy
</code></pre>
<h4 data-id="heading-84">5.2.2修改haproxy配置文件（配置文件一样）</h4>
<pre><code class="hljs language-shell" lang="shell">cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak
cat &gt;/etc/haproxy/haproxy.cfg&lt;&lt;"EOF"
global
 maxconn 2000
 ulimit-n 16384
 log 127.0.0.1 local0 err
 stats timeout 30s

defaults
 log global
 mode http
 option httplog
 timeout connect 5000
 timeout client 50000
 timeout server 50000
 timeout http-request 15s
 timeout http-keep-alive 15s


frontend monitor-in
 bind *:33305
 mode http
 option httplog
 monitor-uri /monitor

frontend k8s-master
 bind 0.0.0.0:9443
 bind 127.0.0.1:9443
 mode tcp
 option tcplog
 tcp-request inspect-delay 5s
 default_backend k8s-master


backend k8s-master
 mode tcp
 option tcplog
 option tcp-check
 balance roundrobin
 default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
 server  k8s-master01  192.168.1.31:6443 check
 server  k8s-master02  192.168.1.32:6443 check
 server  k8s-master03  192.168.1.33:6443 check
EOF
</code></pre>
<p>参数</p>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-85">5.2.3Master01配置keepalived master节点</h4>
<pre><code class="hljs language-shell" lang="shell">cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak

cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF
! Configuration File for keepalived

global_defs {
    router_id LVS_DEVEL
}
vrrp_script chk_apiserver {
    script "/etc/keepalived/check_apiserver.sh"
    interval 5 
    weight -5
    fall 2
    rise 1
}
vrrp_instance VI_1 {
    state MASTER
    # 注意网卡名
    interface ens160 
    mcast_src_ip 192.168.1.31
    virtual_router_id 51
    priority 100
    nopreempt
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.1.36
    }
    track_script {
      chk_apiserver 
} }

EOF
</code></pre>
<h4 data-id="heading-86">5.2.4Master02配置keepalived backup节点</h4>
<pre><code class="hljs language-shell" lang="shell">cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak

cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF
! Configuration File for keepalived

global_defs {
    router_id LVS_DEVEL
}
vrrp_script chk_apiserver {
    script "/etc/keepalived/check_apiserver.sh"
    interval 5 
    weight -5
    fall 2
    rise 1

}
vrrp_instance VI_1 {
    state BACKUP
    # 注意网卡名
    interface ens160
    mcast_src_ip 192.168.1.32
    virtual_router_id 51
    priority 80
    nopreempt
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.1.36
    }
    track_script {
      chk_apiserver 
} }

EOF
</code></pre>
<h4 data-id="heading-87">5.2.5Master03配置keepalived backup节点</h4>
<pre><code class="hljs language-shell" lang="shell">cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak

cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF
! Configuration File for keepalived

global_defs {
    router_id LVS_DEVEL
}
vrrp_script chk_apiserver {
    script "/etc/keepalived/check_apiserver.sh"
    interval 5 
    weight -5
    fall 2
    rise 1

}
vrrp_instance VI_1 {
    state BACKUP
    # 注意网卡名
    interface ens160
    mcast_src_ip 192.168.1.33
    virtual_router_id 51
    priority 50
    nopreempt
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.1.36
    }
    track_script {
      chk_apiserver 
} }

EOF
</code></pre>
<p>参数</p>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-88">5.2.6健康检查脚本配置（lb主机）</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt;  /etc/keepalived/check_apiserver.sh &lt;&lt; EOF
<span class="hljs-meta prompt_">#</span><span class="bash">!/bin/bash</span>

err=0
for k in \$(seq 1 3)
do
    check_code=\$(pgrep haproxy)
    if [[ \$check_code == "" ]]; then
        err=\$(expr \$err + 1)
        sleep 1
        continue
    else
        err=0
        break
    fi
done

if [[ \$err != "0" ]]; then
    echo "systemctl stop keepalived"
    /usr/bin/systemctl stop keepalived
    exit 1
else
    exit 0
fi
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">给脚本授权</span>

chmod +x /etc/keepalived/check_apiserver.sh
</code></pre>
<h4 data-id="heading-89">5.2.7启动服务</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl enable --now haproxy.service
systemctl enable --now keepalived.service
systemctl status haproxy.service
systemctl status keepalived.service
</code></pre>
<h4 data-id="heading-90">5.2.8测试高可用</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">能ping同</span>
[root@k8s-node02 ~]# ping 192.168.1.36
<span class="hljs-meta prompt_">
# </span><span class="bash">能telnet访问</span>
[root@k8s-node02 ~]# telnet 192.168.1.36 9443
<span class="hljs-meta prompt_">
# </span><span class="bash">关闭主节点，看vip是否漂移到备节点</span>
</code></pre>
<h2 data-id="heading-91">6.k8s组件配置</h2>
<p>所有k8s节点创建以下目录</p>
<pre><code class="hljs language-shell" lang="shell">mkdir -p /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes
</code></pre>
<h3 data-id="heading-92">6.1.创建apiserver（所有master节点）</h3>
<h4 data-id="heading-93">6.1.1master01节点配置</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">若关闭IPv6 删除 --service-cluster-ip-range 的 IPv6 即可</span>
cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver \\
      --v=2  \\
      --allow-privileged=true  \\
      --bind-address=0.0.0.0  \\
      --secure-port=6443  \\
      --advertise-address=192.168.1.31 \\
      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\
      --service-node-port-range=30000-32767  \\
      --etcd-servers=https://192.168.1.31:2379,https://192.168.1.32:2379,https://192.168.1.33:2379 \\
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\
      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\
      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \
      --authorization-mode=Node,RBAC  \\
      --enable-bootstrap-token-auth=true  \\
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\
      --requestheader-allowed-names=aggregator  \\
      --requestheader-group-headers=X-Remote-Group  \\
      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\
      --requestheader-username-headers=X-Remote-User \\
      --enable-aggregator-routing=true
Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target

EOF
</code></pre>
<h4 data-id="heading-94">6.1.2master02节点配置</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">若关闭IPv6 删除 --service-cluster-ip-range 的 IPv6 即可</span>
cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver \\
      --v=2  \\
      --allow-privileged=true  \\
      --bind-address=0.0.0.0  \\
      --secure-port=6443  \\
      --advertise-address=192.168.1.32 \\
      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\
      --service-node-port-range=30000-32767  \\
      --etcd-servers=https://192.168.1.31:2379,https://192.168.1.32:2379,https://192.168.1.33:2379 \\
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\
      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\
      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \\
      --authorization-mode=Node,RBAC  \\
      --enable-bootstrap-token-auth=true  \\
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\
      --requestheader-allowed-names=aggregator  \\
      --requestheader-group-headers=X-Remote-Group  \\
      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\
      --requestheader-username-headers=X-Remote-User \\
      --enable-aggregator-routing=true

Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target

EOF
</code></pre>
<h4 data-id="heading-95">6.1.3master03节点配置</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">若关闭IPv6 删除 --service-cluster-ip-range 的 IPv6 即可</span>
cat &gt; /usr/lib/systemd/system/kube-apiserver.service  &lt;&lt; EOF
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver \\
      --v=2  \\
      --allow-privileged=true  \\
      --bind-address=0.0.0.0  \\
      --secure-port=6443  \\
      --advertise-address=192.168.1.33 \\
      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\
      --service-node-port-range=30000-32767  \\
      --etcd-servers=https://192.168.1.31:2379,https://192.168.1.32:2379,https://192.168.1.33:2379 \\
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\
      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\
      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \\
      --authorization-mode=Node,RBAC  \\
      --enable-bootstrap-token-auth=true  \\
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\
      --requestheader-allowed-names=aggregator  \\
      --requestheader-group-headers=X-Remote-Group  \\
      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\
      --requestheader-username-headers=X-Remote-User \\
      --enable-aggregator-routing=true

Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target

EOF
</code></pre>
<p>参数</p>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-96">6.1.4启动apiserver（所有master节点）</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl enable --now kube-apiserver.service
systemctl restart kube-apiserver.service
systemctl status kube-apiserver.service
</code></pre>
<h3 data-id="heading-97">6.2.配置kube-controller-manager service</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">所有master节点配置，且配置相同</span>
<span class="hljs-meta prompt_"># </span><span class="bash">172.16.0.0/12为pod网段，按需求设置你自己的网段</span>

cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-controller-manager \\
      --v=2 \\
      --bind-address=0.0.0.0 \\
      --root-ca-file=/etc/kubernetes/pki/ca.pem \\
      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \\
      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \\
      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \\
      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \\
      --leader-elect=true \\
      --use-service-account-credentials=true \\
      --node-monitor-grace-period=40s \\
      --node-monitor-period=5s \\
      --controllers=*,bootstrapsigner,tokencleaner \\
      --allocate-node-cidrs=true \\
      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112 \\
      --cluster-cidr=172.16.0.0/12,fc00:2222::/112 \\
      --node-cidr-mask-size-ipv4=24 \\
      --node-cidr-mask-size-ipv6=120 \\
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem

Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target
EOF
<span class="hljs-meta prompt_">


# </span><span class="bash">关闭IPv6</span> 
<span class="hljs-meta prompt_"># </span><span class="bash">删除 --service-cluster-ip-range 中的IPv6地址</span>
<span class="hljs-meta prompt_"># </span><span class="bash">删除 --cluster-cidr 中的IPv6地址</span>
<span class="hljs-meta prompt_"># </span><span class="bash">删除 --node-cidr-mask-size-ipv6=120</span>
cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-controller-manager \\
      --v=2 \\
      --bind-address=0.0.0.0 \\
      --root-ca-file=/etc/kubernetes/pki/ca.pem \\
      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \\
      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \\
      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \\
      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \\
      --leader-elect=true \\
      --use-service-account-credentials=true \\
      --node-monitor-grace-period=40s \\
      --node-monitor-period=5s \\
      --controllers=*,bootstrapsigner,tokencleaner \\
      --allocate-node-cidrs=true \\
      --service-cluster-ip-range=10.96.0.0/12 \\
      --cluster-cidr=172.16.0.0/12 \\
      --node-cidr-mask-size-ipv4=24 \\
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem

Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<p>参数</p>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-98">6.2.1启动kube-controller-manager，并查看状态</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl enable --now kube-controller-manager.service
systemctl restart kube-controller-manager.service
systemctl status kube-controller-manager.service
</code></pre>
<h3 data-id="heading-99">6.3.配置kube-scheduler service</h3>
<h4 data-id="heading-100">6.3.1所有master节点配置，且配置相同</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF

[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-scheduler \\
      --v=2 \\
      --bind-address=0.0.0.0 \\
      --leader-elect=true \\
      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig

Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target

EOF
</code></pre>
<p>参数</p>
<pre><code class="hljs language-shell" lang="shell">详见完整版 https://github.com/cby-chen/Kubernetes
</code></pre>
<h4 data-id="heading-101">6.3.2启动并查看服务状态</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl enable --now kube-scheduler.service
systemctl restart kube-scheduler.service
systemctl status kube-scheduler.service
</code></pre>
<h2 data-id="heading-102">7.TLS Bootstrapping配置</h2>
<h3 data-id="heading-103">7.1在master01上配置</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">在《5.高可用配置》选择使用那种高可用方案</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:9443`</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span>

kubectl config set-cluster kubernetes     \
--certificate-authority=/etc/kubernetes/pki/ca.pem     \
--embed-certs=true     --server=https://127.0.0.1:8443     \
--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig
<span class="hljs-meta prompt_">
# </span><span class="bash">可以使用这个命令进行创建token也可以使用我的</span>
echo "$(head -c 6 /dev/urandom | md5sum | head -c 6)"."$(head -c 16 /dev/urandom | md5sum | head -c 16)"

kubectl config set-credentials tls-bootstrap-token-user     \
--token=c8ad9c.2e4d610cf3e7426e \
--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig

kubectl config set-context tls-bootstrap-token-user@kubernetes     \
--cluster=kubernetes     \
--user=tls-bootstrap-token-user     \
--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig

kubectl config use-context tls-bootstrap-token-user@kubernetes     \
--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig
<span class="hljs-meta prompt_">
# </span><span class="bash">token的位置在bootstrap.secret.yaml，如果修改的话到这个文件修改</span>
mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config
</code></pre>
<h3 data-id="heading-104">7.2查看集群状态，没问题的话继续后续操作</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">1.28 版本只能查看到一个etcd 属于正常现象</span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">export</span> ETCDCTL_API=3</span>
<span class="hljs-meta prompt_"># </span><span class="bash">etcdctl --endpoints=<span class="hljs-string">"192.168.1.33:2379,192.168.1.32:2379,192.168.1.31:2379"</span> --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table</span>

kubectl get cs
Warning: v1 ComponentStatus is deprecated in v1.19+
NAME                 STATUS    MESSAGE   ERROR
scheduler            Healthy   ok        
controller-manager   Healthy   ok        
etcd-0               Healthy   ok 
<span class="hljs-meta prompt_">
# </span><span class="bash">写入bootstrap-token</span>
cat &gt; bootstrap.secret.yaml &lt;&lt; EOF
apiVersion: v1
kind: Secret
metadata:
  name: bootstrap-token-c8ad9c
  namespace: kube-system
type: bootstrap.kubernetes.io/token
stringData:
  description: "The default bootstrap token generated by 'kubelet '."
  token-id: c8ad9c
  token-secret: 2e4d610cf3e7426e
  usage-bootstrap-authentication: "true"
  usage-bootstrap-signing: "true"
  auth-extra-groups:  system:bootstrappers:default-node-token,system:bootstrappers:worker,system:bootstrappers:ingress

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubelet-bootstrap
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:node-bootstrapper
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:bootstrappers:default-node-token
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: node-autoapprove-bootstrap
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:bootstrappers:default-node-token
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: node-autoapprove-certificate-rotation
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:nodes
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-apiserver-to-kubelet
rules:
  - apiGroups:
      - ""
    resources:
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
      - nodes/metrics
    verbs:
      - "*"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: system:kube-apiserver
  namespace: ""
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-apiserver-to-kubelet
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kube-apiserver
EOF
<span class="hljs-meta prompt_"># </span><span class="bash">切记执行，别忘记！！！</span>
kubectl create -f bootstrap.secret.yaml
</code></pre>
<h2 data-id="heading-105">8.node节点配置</h2>
<h3 data-id="heading-106">8.1.在master01上将证书复制到node节点</h3>
<pre><code class="hljs language-shell" lang="shell">cd /etc/kubernetes/

for NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do ssh $NODE mkdir -p /etc/kubernetes/pki; for FILE in pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig kube-proxy.kubeconfig; do scp /etc/kubernetes/$FILE $NODE:/etc/kubernetes/${FILE}; done; done
</code></pre>
<h3 data-id="heading-107">8.2.kubelet配置</h3>
<p><strong>注意 ： 8.2.1 和 8.2.2 需要和 上方 2.1 和 2.2 对应起来</strong></p>
<h4 data-id="heading-108">8.2.1当使用docker作为Runtime</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF

[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes
After=network-online.target firewalld.service cri-docker.service docker.socket containerd.service
Wants=network-online.target
Requires=docker.socket containerd.service

[Service]
ExecStart=/usr/local/bin/kubelet \\
    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\
    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\
    --config=/etc/kubernetes/kubelet-conf.yml \\
    --container-runtime-endpoint=unix:///run/cri-dockerd.sock  \\
    --node-labels=node.kubernetes.io/node= 


[Install]
WantedBy=multi-user.target
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">IPv6示例</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若不使用IPv6那么忽略此项即可</span>
<span class="hljs-meta prompt_"># </span><span class="bash">下方 --node-ip 更换为每个节点的IP即可</span>
**cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes
After=network-online.target firewalld.service cri-docker.service docker.socket containerd.service
Wants=network-online.target
Requires=docker.socket containerd.service

[Service]
ExecStart=/usr/local/bin/kubelet \\
    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\
    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\
    --config=/etc/kubernetes/kubelet-conf.yml \\
    --container-runtime-endpoint=unix:///run/cri-dockerd.sock  \\
    --node-labels=node.kubernetes.io/node=   \\
    --node-ip=192.168.1.31,fc00::31
[Install]
WantedBy=multi-user.target
EOF**
</code></pre>
<h4 data-id="heading-109">8.2.2当使用Containerd作为Runtime</h4>
<pre><code class="hljs language-shell" lang="shell">mkdir -p /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/
<span class="hljs-meta prompt_">
# </span><span class="bash">所有k8s节点配置kubelet service</span>
cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF

[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes
After=network-online.target firewalld.service containerd.service
Wants=network-online.target
Requires=containerd.service

[Service]
ExecStart=/usr/local/bin/kubelet \\
    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\
    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\
    --config=/etc/kubernetes/kubelet-conf.yml \\
    --container-runtime-endpoint=unix:///run/containerd/containerd.sock  \\
    --node-labels=node.kubernetes.io/node=

[Install]
WantedBy=multi-user.target
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">IPv6示例</span>
<span class="hljs-meta prompt_"># </span><span class="bash">若不使用IPv6那么忽略此项即可</span>
<span class="hljs-meta prompt_"># </span><span class="bash">下方 --node-ip 更换为每个节点的IP即可</span>
cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF

[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes
After=network-online.target firewalld.service containerd.service
Wants=network-online.target
Requires=containerd.service

[Service]
ExecStart=/usr/local/bin/kubelet \\
    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\
    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\
    --config=/etc/kubernetes/kubelet-conf.yml \\
    --container-runtime-endpoint=unix:///run/containerd/containerd.sock  \\
    --node-labels=node.kubernetes.io/node=  \\
    --node-ip=192.168.1.31,fc00::31
[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<h4 data-id="heading-110">8.2.3所有k8s节点创建kubelet的配置文件</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /etc/kubernetes/kubelet-conf.yml &lt;&lt;EOF
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
address: 0.0.0.0
port: 10250
readOnlyPort: 10255
authentication:
  anonymous:
    enabled: false
  webhook:
    cacheTTL: 2m0s
    enabled: true
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.pem
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
cgroupDriver: systemd
cgroupsPerQOS: true
clusterDNS:
- 10.96.0.10
clusterDomain: cluster.local
containerLogMaxFiles: 5
containerLogMaxSize: 10Mi
contentType: application/vnd.kubernetes.protobuf
cpuCFSQuota: true
cpuManagerPolicy: none
cpuManagerReconcilePeriod: 10s
enableControllerAttachDetach: true
enableDebuggingHandlers: true
enforceNodeAllocatable:
- pods
eventBurst: 10
eventRecordQPS: 5
evictionHard:
  imagefs.available: 15%
  memory.available: 100Mi
  nodefs.available: 10%
  nodefs.inodesFree: 5%
evictionPressureTransitionPeriod: 5m0s
failSwapOn: true
fileCheckFrequency: 20s
hairpinMode: promiscuous-bridge
healthzBindAddress: 127.0.0.1
healthzPort: 10248
httpCheckFrequency: 20s
imageGCHighThresholdPercent: 85
imageGCLowThresholdPercent: 80
imageMinimumGCAge: 2m0s
iptablesDropBit: 15
iptablesMasqueradeBit: 14
kubeAPIBurst: 10
kubeAPIQPS: 5
makeIPTablesUtilChains: true
maxOpenFiles: 1000000
maxPods: 110
nodeStatusUpdateFrequency: 10s
oomScoreAdj: -999
podPidsLimit: -1
registryBurst: 10
registryPullQPS: 5
resolvConf: /etc/resolv.conf
rotateCertificates: true
runtimeRequestTimeout: 2m0s
serializeImagePulls: true
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 4h0m0s
syncFrequency: 1m0s
volumeStatsAggPeriod: 1m0s
EOF
</code></pre>
<h4 data-id="heading-111">8.2.4启动kubelet</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl enable --now kubelet.service
systemctl restart kubelet.service
systemctl status kubelet.service
</code></pre>
<h4 data-id="heading-112">8.2.5查看集群</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# kubectl  get node
NAME           STATUS     ROLES    AGE   VERSION
k8s-master01   NotReady   &lt;none&gt;   15s   v1.35.0
k8s-master02   NotReady   &lt;none&gt;   14s   v1.35.0
k8s-master03   NotReady   &lt;none&gt;   12s   v1.35.0
k8s-node01     NotReady   &lt;none&gt;   11s   v1.35.0
k8s-node02     NotReady   &lt;none&gt;   9s    v1.35.0
[root@k8s-master01 ~]# 

</code></pre>
<h4 data-id="heading-113">8.2.6查看容器运行时</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# kubectl describe node | grep Runtime
  Container Runtime Version:  containerd://2.2.1
  Container Runtime Version:  containerd://2.2.1
  Container Runtime Version:  containerd://2.2.1
  Container Runtime Version:  containerd://2.2.1
  Container Runtime Version:  containerd://2.2.1
[root@k8s-master01 ~]# kubectl describe node | grep Runtime
  Container Runtime Version:  docker://29.1.3
  Container Runtime Version:  docker://29.1.3
  Container Runtime Version:  docker://29.1.3
  Container Runtime Version:  docker://29.1.3
  Container Runtime Version:  docker://29.1.3
[root@k8s-master01 ~]# 
</code></pre>
<h3 data-id="heading-114">8.3.kube-proxy配置</h3>
<h4 data-id="heading-115">8.3.1将kubeconfig发送至其他节点</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">master-1执行</span>
for NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do scp /etc/kubernetes/kube-proxy.kubeconfig $NODE:/etc/kubernetes/kube-proxy.kubeconfig; done
</code></pre>
<h4 data-id="heading-116">8.3.2所有k8s节点添加kube-proxy的service文件</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt;  /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Kube Proxy
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-proxy \\
  --config=/etc/kubernetes/kube-proxy.yaml \\
  --cluster-cidr=172.16.0.0/12,fc00:2222::/112 \\
  --v=2
Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target

EOF
<span class="hljs-meta prompt_">

# </span><span class="bash">关闭IPv6</span>
<span class="hljs-meta prompt_"># </span><span class="bash">删除 --cluster-cidr 的IPv6地址</span>
cat &gt;  /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Kube Proxy
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-proxy \\
  --config=/etc/kubernetes/kube-proxy.yaml \\
  --cluster-cidr=172.16.0.0/12 \\
  --v=2
Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target

EOF
</code></pre>
<h4 data-id="heading-117">8.3.3所有k8s节点添加kube-proxy的配置</h4>
<pre><code class="hljs language-shell" lang="shell">cat &gt; /etc/kubernetes/kube-proxy.yaml &lt;&lt; EOF
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: 0.0.0.0
clientConnection:
  acceptContentTypes: ""
  burst: 10
  contentType: application/vnd.kubernetes.protobuf
  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig
  qps: 5
clusterCIDR: 172.16.0.0/12,fc00:2222::/112
configSyncPeriod: 15m0s
conntrack:
  max: null
  maxPerCore: 32768
  min: 131072
  tcpCloseWaitTimeout: 1h0m0s
  tcpEstablishedTimeout: 24h0m0s
enableProfiling: false
healthzBindAddress: 0.0.0.0:10256
hostnameOverride: ""
iptables:
  masqueradeAll: false
  masqueradeBit: 14
  minSyncPeriod: 0s
  syncPeriod: 30s
ipvs:
  masqueradeAll: true
  minSyncPeriod: 5s
  scheduler: "rr"
  syncPeriod: 30s
kind: KubeProxyConfiguration
metricsBindAddress: 127.0.0.1:10249
mode: "ipvs"
nodePortAddresses: null
oomScoreAdj: -999
portRange: ""
udpIdleTimeout: 250ms
EOF
</code></pre>
<h4 data-id="heading-118">8.3.4启动kube-proxy</h4>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl enable --now kube-proxy.service
systemctl restart kube-proxy.service
systemctl status kube-proxy.service
</code></pre>
<h2 data-id="heading-119">9.安装网络插件</h2>
<p><strong>注意 9.1 和 9.2 二选其一即可，建议在此处创建好快照后在进行操作，后续出问题可以回滚</strong></p>
<p>** centos7 要升级libseccomp 不然 无法安装网络插件**</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">https://github.com/opencontainers/runc/releases</span>
<span class="hljs-meta prompt_"># </span><span class="bash">升级runc</span>
<span class="hljs-meta prompt_"># </span><span class="bash">wget https://github.com/opencontainers/runc/releases/download/v1.1.12/runc.amd64</span>

install -m 755 runc.amd64 /usr/local/sbin/runc
cp -p /usr/local/sbin/runc  /usr/local/bin/runc
cp -p /usr/local/sbin/runc  /usr/bin/runc
<span class="hljs-meta prompt_">
#</span><span class="bash">查看当前版本</span>
[root@k8s-master-1 ~]# rpm -qa | grep libseccomp
libseccomp-2.5.2-2.el9.x86_64
<span class="hljs-meta prompt_">
#</span><span class="bash">下载高于2.4以上的包</span>
<span class="hljs-meta prompt_"># </span><span class="bash">yum -y install http://rpmfind.net/linux/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.1-1.el8.x86_64.rpm</span>
<span class="hljs-meta prompt_"># </span><span class="bash">清华源</span>
<span class="hljs-meta prompt_"># </span><span class="bash">yum -y install https://mirrors.tuna.tsinghua.edu.cn/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.1-1.el8.x86_64.rpm</span>
</code></pre>
<h3 data-id="heading-120">9.1安装Calico</h3>
<h4 data-id="heading-121">9.1.1更改calico网段</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">
# </span><span class="bash">安装operator</span>
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.31.2/manifests/tigera-operator.yaml
<span class="hljs-meta prompt_">

# </span><span class="bash">下载配置文件</span>
curl https://raw.githubusercontent.com/projectcalico/calico/v3.31.2/manifests/custom-resources.yaml -O

<span class="hljs-meta prompt_">


# </span><span class="bash">修改地址池</span>
vim custom-resources.yaml
apiVersion: operator.tigera.io/v1
kind: Installation
metadata:
  name: default
spec:
  calicoNetwork:
    ipPools:
    - name: default-ipv4-ippool
      blockSize: 26
      cidr: 172.16.0.0/12
      encapsulation: VXLANCrossSubnet
      natOutgoing: Enabled
      nodeSelector: all()

<span class="hljs-meta prompt_">


# </span><span class="bash">修改地址池</span>
vim custom-resources.yaml
apiVersion: operator.tigera.io/v1
kind: Installation
metadata:
  name: default
spec:
  calicoNetwork:
    ipPools:
    - name: ipv4-ippool
      cidr: 172.16.0.0/12
      blockSize: 26
      encapsulation: IPIP
      natOutgoing: Enabled
      nodeSelector: all()
    - name: ipv6-ippool
      cidr: "fd00:100::/64"
      blockSize: 122
      encapsulation: None
      natOutgoing: Enabled
      nodeSelector: all()
    nodeAddressAutodetectionV4:
      interface: "eth.*|en.*"
    nodeAddressAutodetectionV6:
      interface: "eth.*|en.*"
<span class="hljs-meta prompt_">
# </span><span class="bash">执行安装</span>
kubectl create -f custom-resources.yaml
<span class="hljs-meta prompt_">


# </span><span class="bash">安装客户端</span>
curl -L https://github.com/projectcalico/calico/releases/download/v3.30.3/calicoctl-linux-amd64 -o calicoctl
<span class="hljs-meta prompt_">

# </span><span class="bash">给客户端添加执行权限</span>
chmod +x ./calicoctl
<span class="hljs-meta prompt_">

# </span><span class="bash">查看集群节点</span>
./calicoctl get nodes --allow-version-mismatch
<span class="hljs-meta prompt_"># </span><span class="bash">查看集群节点状态</span>
./calicoctl node status --allow-version-mismatch
<span class="hljs-meta prompt_">#</span><span class="bash">查看地址池</span>
./calicoctl get ipPool --allow-version-mismatch
./calicoctl get ipPool --allow-version-mismatch -o yaml


</code></pre>
<h4 data-id="heading-122">9.1.2查看容器状态</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">calico 初始化会很慢 需要耐心等待一下，大约十分钟左右</span>
[root@k8s-master01 kubernetes-v1.35.0]# kubectl get pod -A
NAMESPACE         NAME                                       READY   STATUS    RESTARTS   AGE
calico-system     calico-apiserver-8944cd746-8cf9n           1/1     Running   0          3m17s
calico-system     calico-apiserver-8944cd746-kdvx4           1/1     Running   0          3m17s
calico-system     calico-kube-controllers-757dc6b956-bpx2m   1/1     Running   0          3m16s
calico-system     calico-node-89xvc                          1/1     Running   0          3m16s
calico-system     calico-node-95dgk                          1/1     Running   0          3m16s
calico-system     calico-node-jbm6g                          1/1     Running   0          3m16s
calico-system     calico-node-p5mb2                          1/1     Running   0          3m16s
calico-system     calico-node-t68xn                          1/1     Running   0          3m16s
calico-system     calico-typha-68687d94bd-7pcmq              1/1     Running   0          3m14s
calico-system     calico-typha-68687d94bd-cfclr              1/1     Running   0          3m16s
calico-system     calico-typha-68687d94bd-t62kd              1/1     Running   0          3m14s
calico-system     csi-node-driver-5mwsv                      2/2     Running   0          3m16s
calico-system     csi-node-driver-jtp56                      2/2     Running   0          3m16s
calico-system     csi-node-driver-ncd7q                      2/2     Running   0          3m16s
calico-system     csi-node-driver-nvb6d                      2/2     Running   0          3m16s
calico-system     csi-node-driver-s6dk9                      2/2     Running   0          3m16s
calico-system     goldmane-576ddf78d8-4zkch                  1/1     Running   0          3m17s
calico-system     whisker-58576c6584-nv246                   2/2     Running   0          2m43s
tigera-operator   tigera-operator-5cd7bd49c7-rwb54           1/1     Running   0          3m34s
[root@k8s-master01 kubernetes-v1.35.0]# 


</code></pre>
<h3 data-id="heading-123">9.2 安装cilium</h3>
<h4 data-id="heading-124">9.2.1 安装helm</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">[root@k8s-master01 ~]<span class="hljs-comment"># curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">[root@k8s-master01 ~]<span class="hljs-comment"># chmod 700 get_helm.sh</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">[root@k8s-master01 ~]<span class="hljs-comment"># ./get_helm.sh</span></span>
<span class="hljs-meta prompt_">
# </span><span class="bash">wget https://get.helm.sh/helm-v4.0.4-linux-amd64.tar.gz</span>
tar xvf helm-*-linux-amd64.tar.gz
cp linux-amd64/helm /usr/local/bin/
</code></pre>
<h4 data-id="heading-125">9.2.2 安装cilium</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">添加源</span>
helm repo add cilium https://helm.cilium.io
<span class="hljs-meta prompt_">
# </span><span class="bash">修改为国内源</span>
helm pull cilium/cilium
tar xvf cilium-*.tgz
cd cilium/
<span class="hljs-meta prompt_">
# </span><span class="bash">sed -i <span class="hljs-string">"s#quay.io/#quay.m.daocloud.io/#g"</span> values.yaml</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">默认参数安装</span>
helm install  cilium ./cilium/ -n kube-system

helm install cilium cilium/cilium --version 1.17.4 -n kube-system
<span class="hljs-meta prompt_">
# </span><span class="bash">启用ipv6</span>
<span class="hljs-meta prompt_"># </span><span class="bash">helm install cilium cilium/cilium -n cilium-system --<span class="hljs-built_in">set</span> ipv6.enabled=<span class="hljs-literal">true</span></span> 
<span class="hljs-meta prompt_">

# </span><span class="bash">启用路由信息和监控插件</span>
<span class="hljs-meta prompt_"># </span><span class="bash">helm install cilium ./cilium/ --namespace kube-system --<span class="hljs-built_in">set</span> ipv6.enabled=<span class="hljs-literal">true</span> --<span class="hljs-built_in">set</span> hubble.relay.enabled=<span class="hljs-literal">true</span> --<span class="hljs-built_in">set</span> hubble.ui.enabled=<span class="hljs-literal">true</span> --<span class="hljs-built_in">set</span> prometheus.enabled=<span class="hljs-literal">true</span> --<span class="hljs-built_in">set</span> operator.prometheus.enabled=<span class="hljs-literal">true</span> --<span class="hljs-built_in">set</span> hubble.enabled=<span class="hljs-literal">true</span> --<span class="hljs-built_in">set</span> hubble.metrics.enabled=<span class="hljs-string">"{dns,drop,tcp,flow,port-distribution,icmp,http}"</span></span> 
</code></pre>
<h4 data-id="heading-126">9.2.3 查看</h4>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# kubectl  get pod -A | grep cil
NAMESPACE     NAME                               READY   STATUS    RESTARTS   AGE
kube-system   cilium-2tnfb                       1/1     Running   0          60s
kube-system   cilium-5tgcb                       1/1     Running   0          60s
kube-system   cilium-6shf5                       1/1     Running   0          60s
kube-system   cilium-ccbcx                       1/1     Running   0          60s
kube-system   cilium-cppft                       1/1     Running   0          60s
kube-system   cilium-operator-675f685d59-7q27q   1/1     Running   0          60s
kube-system   cilium-operator-675f685d59-kwmqz   1/1     Running   0          60s
[root@k8s-master01 ~]#
</code></pre>
<h4 data-id="heading-127">9.2.4 下载专属监控面板</h4>
<p>安装时候没有创建 监控可以忽略</p>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 yaml]# wget https://raw.githubusercontent.com/cilium/cilium/1.12.1/examples/kubernetes/addons/prometheus/monitoring-example.yaml

[root@k8s-master01 yaml]# sed -i "s#docker.io/#jockerhub.com/#g" monitoring-example.yaml

[root@k8s-master01 yaml]# kubectl  apply -f monitoring-example.yaml
namespace/cilium-monitoring created
serviceaccount/prometheus-k8s created
configmap/grafana-config created
configmap/grafana-cilium-dashboard created
configmap/grafana-cilium-operator-dashboard created
configmap/grafana-hubble-dashboard created
configmap/prometheus created
clusterrole.rbac.authorization.k8s.io/prometheus created
clusterrolebinding.rbac.authorization.k8s.io/prometheus created
service/grafana created
service/prometheus created
deployment.apps/grafana created
deployment.apps/prometheus created
[root@k8s-master01 yaml]#
</code></pre>
<h4 data-id="heading-128">9.2.5 修改为NodePort</h4>
<p>安装时候没有创建 监控可以忽略</p>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 yaml]# kubectl  edit svc  -n kube-system hubble-ui
service/hubble-ui edited
[root@k8s-master01 yaml]#
[root@k8s-master01 yaml]# kubectl  edit svc  -n cilium-monitoring grafana
service/grafana edited
[root@k8s-master01 yaml]#
[root@k8s-master01 yaml]# kubectl  edit svc  -n cilium-monitoring prometheus
service/prometheus edited
[root@k8s-master01 yaml]#

type: NodePort
</code></pre>
<h4 data-id="heading-129">9.2.6 查看端口</h4>
<p>安装时候没有创建 监控可以忽略</p>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 yaml]# kubectl get svc -A | grep NodePort
cilium-monitoring   grafana          NodePort    10.111.74.3      &lt;none&gt;        3000:32648/TCP   74s
cilium-monitoring   prometheus       NodePort    10.107.240.124   &lt;none&gt;        9090:30495/TCP   74s
kube-system         hubble-ui        NodePort    10.96.185.26     &lt;none&gt;        80:31568/TCP     99s
</code></pre>
<h4 data-id="heading-130">9.2.7 访问</h4>
<p>安装时候没有创建 监控可以忽略</p>
<pre><code class="hljs language-shell" lang="shell">http://192.168.1.31:32648
http://192.168.1.31:30495
http://192.168.1.31:31568
</code></pre>
<h2 data-id="heading-131">10.安装CoreDNS</h2>
<h3 data-id="heading-132">10.1以下步骤只在master01操作</h3>
<h4 data-id="heading-133">10.1.1修改文件</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">下载tgz包</span>
helm repo add coredns https://coredns.github.io/helm
helm pull coredns/coredns
tar xvf coredns-*.tgz
cd coredns/
<span class="hljs-meta prompt_">
# </span><span class="bash">修改IP地址</span>
vim values.yaml
cat values.yaml | grep clusterIP:
clusterIP: "10.96.0.10"
<span class="hljs-meta prompt_">
# </span><span class="bash">示例</span>
---
service:
<span class="hljs-meta prompt_"># </span><span class="bash">clusterIP: <span class="hljs-string">""</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">clusterIPs: []</span>
<span class="hljs-meta prompt_"># </span><span class="bash">loadBalancerIP: <span class="hljs-string">""</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">externalIPs: []</span>
<span class="hljs-meta prompt_"># </span><span class="bash">externalTrafficPolicy: <span class="hljs-string">""</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">ipFamilyPolicy: <span class="hljs-string">""</span></span>
<span class="hljs-meta prompt_">  # </span><span class="bash">The name of the Service</span>
<span class="hljs-meta prompt_">  # </span><span class="bash">If not <span class="hljs-built_in">set</span>, a name is generated using the fullname template</span>
  clusterIP: "10.96.0.10"
  name: ""
  annotations: {}
---
<span class="hljs-meta prompt_">
# </span><span class="bash">修改为国内源</span>
sed -i "s#registry.k8s.io/#k8s.m.daocloud.io/#g" values.yaml
<span class="hljs-meta prompt_">
# </span><span class="bash">默认参数安装</span>
helm install  coredns ./coredns/ -n kube-system
</code></pre>
<h2 data-id="heading-134">11.安装Metrics Server</h2>
<h3 data-id="heading-135">11.1以下步骤只在master01操作</h3>
<h4 data-id="heading-136">11.1.1安装Metrics-server</h4>
<p>在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">下载</span> 
wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml -O metrics-server.yaml 
<span class="hljs-meta prompt_">
# </span><span class="bash">修改配置</span>
vim metrics-server.yaml 

---
<span class="hljs-meta prompt_"># </span><span class="bash">1</span>
    - args:
        - --cert-dir=/tmp
        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
        - --kubelet-use-node-status-port
        - --metric-resolution=15s
        - --kubelet-insecure-tls
        - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem
        - --requestheader-username-headers=X-Remote-User
        - --requestheader-group-headers=X-Remote-Group
        - --requestheader-extra-headers-prefix=X-Remote-Extra-
<span class="hljs-meta prompt_">
# </span><span class="bash">2</span>
        volumeMounts:
        - mountPath: /tmp
          name: tmp-dir
        - name: ca-ssl
          mountPath: /etc/kubernetes/pki
<span class="hljs-meta prompt_">
# </span><span class="bash">3</span>
      volumes:
      - emptyDir: {}
        name: tmp-dir
      - name: ca-ssl
        hostPath:
          path: /etc/kubernetes/pki
---
<span class="hljs-meta prompt_">

# </span><span class="bash">修改为国内源 docker源可选</span>
sed -i "s#registry.k8s.io/#k8s.m.daocloud.io/#g" metrics-server.yaml
<span class="hljs-meta prompt_">
# </span><span class="bash">执行部署</span>
kubectl apply -f metrics-server.yaml 
</code></pre>
<h4 data-id="heading-137">11.1.2稍等片刻查看状态</h4>
<pre><code class="hljs language-shell" lang="shell">kubectl  top node
NAME           CPU(cores)   CPU(%)   MEMORY(bytes)   MEMORY(%)   
k8s-master01   182m         2%       2059Mi          58%         
k8s-master02   104m         1%       1577Mi          44%         
k8s-master03   113m         1%       1516Mi          42%         
k8s-node01     53m          0%       915Mi           25%         
k8s-node02     66m          0%       930Mi           26%         
</code></pre>
<h2 data-id="heading-138">12.集群验证</h2>
<h3 data-id="heading-139">12.1部署pod资源</h3>
<pre><code class="hljs language-shell" lang="shell">cat&lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: busybox
  namespace: default
spec:
  containers:
  - name: busybox
    image: docker.m.daocloud.io/library/busybox:1.28
    command:
      - sleep
      - "3600"
    imagePullPolicy: IfNotPresent
  restartPolicy: Always
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">查看</span>
kubectl  get pod
NAME      READY   STATUS    RESTARTS   AGE
busybox   1/1     Running   0          17s
</code></pre>
<h3 data-id="heading-140">12.2用pod解析默认命名空间中的kubernetes</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">查看name</span>
kubectl get svc
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   17h
<span class="hljs-meta prompt_">
# </span><span class="bash">进行解析</span>
kubectl exec  busybox -n default -- nslookup kubernetes
3Server:    10.96.0.10
Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local

Name:      kubernetes
Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local
</code></pre>
<h3 data-id="heading-141">12.3测试跨命名空间是否可以解析</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">查看有那些name</span>
kubectl  get svc -A
NAMESPACE     NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE
default       kubernetes        ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP         76m
kube-system   calico-typha      ClusterIP   10.105.100.82   &lt;none&gt;        5473/TCP        35m
kube-system   coredns-coredns   ClusterIP   10.96.0.10      &lt;none&gt;        53/UDP,53/TCP   8m14s
kube-system   metrics-server    ClusterIP   10.105.60.31    &lt;none&gt;        443/TCP         109s
<span class="hljs-meta prompt_">
# </span><span class="bash">进行解析</span>
kubectl exec  busybox -n default -- nslookup coredns.kube-system
Server:    10.96.0.10
Address 1: 10.96.0.10 coredns-coredns.kube-system.svc.cluster.local

Name:      coredns-coredns.kube-system
Address 1: 10.96.0.10 coredns-coredns.kube-system.svc.cluster.local
[root@k8s-master01 metrics-server]# 
</code></pre>
<h3 data-id="heading-142">12.4每个节点都必须要能访问Kubernetes的kubernetes svc 443和kube-dns的service 53</h3>
<pre><code class="hljs language-shell" lang="shell">telnet 10.96.0.1 443
Trying 10.96.0.1...
Connected to 10.96.0.1.
Escape character is '^]'.

telnet 10.96.0.10 53
Trying 10.96.0.10...
Connected to 10.96.0.10.
Escape character is '^]'.

curl 10.96.0.10:53
curl: (52) Empty reply from server
</code></pre>
<h3 data-id="heading-143">12.5Pod和Pod之前要能通</h3>
<pre><code class="hljs language-shell" lang="shell">kubectl get po -owide
NAME      READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES
busybox   1/1     Running   0          17m   172.27.14.193   k8s-node02   &lt;none&gt;           &lt;none&gt;

kubectl get po -n kube-system -owide
NAME                                       READY   STATUS    RESTARTS   AGE     IP               NODE           NOMINATED NODE   READINESS GATES
calico-kube-controllers-76754ff848-pw4xg   1/1     Running   0          38m     172.25.244.193   k8s-master01   &lt;none&gt;           &lt;none&gt;
calico-node-97m55                          1/1     Running   0          38m     192.168.1.34     k8s-node01     &lt;none&gt;           &lt;none&gt;
calico-node-hlz7j                          1/1     Running   0          38m     192.168.1.32     k8s-master02   &lt;none&gt;           &lt;none&gt;
calico-node-jtlck                          1/1     Running   0          38m     192.168.1.33     k8s-master03   &lt;none&gt;           &lt;none&gt;
calico-node-lxfkf                          1/1     Running   0          38m     192.168.1.35     k8s-node02     &lt;none&gt;           &lt;none&gt;
calico-node-t667x                          1/1     Running   0          38m     192.168.1.31     k8s-master01   &lt;none&gt;           &lt;none&gt;
calico-typha-59d75c5dd4-gbhfp              1/1     Running   0          38m     192.168.1.35     k8s-node02     &lt;none&gt;           &lt;none&gt;
coredns-coredns-c5c6d4d9b-bd829            1/1     Running   0          10m     172.25.92.65     k8s-master02   &lt;none&gt;           &lt;none&gt;
metrics-server-7c8b55c754-w7q8v            1/1     Running   0          3m56s   172.17.125.3     k8s-node01     &lt;none&gt;           &lt;none&gt;
<span class="hljs-meta prompt_">
# </span><span class="bash">进入busybox ping其他节点上的pod</span>

kubectl exec -ti busybox -- sh
/ # ping 192.168.1.34
PING 192.168.1.34 (192.168.1.34): 56 data bytes
64 bytes from 192.168.1.34: seq=0 ttl=63 time=0.358 ms
64 bytes from 192.168.1.34: seq=1 ttl=63 time=0.668 ms
64 bytes from 192.168.1.34: seq=2 ttl=63 time=0.637 ms
64 bytes from 192.168.1.34: seq=3 ttl=63 time=0.624 ms
64 bytes from 192.168.1.34: seq=4 ttl=63 time=0.907 ms
<span class="hljs-meta prompt_">
# </span><span class="bash">可以连通证明这个pod是可以跨命名空间和跨主机通信的</span>
</code></pre>
<h3 data-id="heading-144">12.6创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）</h3>
<pre><code class="hljs language-shell" lang="shell">cat&lt;&lt;EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx
        ports:
        - containerPort: 80
EOF

kubectl  get pod 
NAME                               READY   STATUS    RESTARTS   AGE
busybox                            1/1     Running   0          6m25s
nginx-deployment-9456bbbf9-4bmvk   1/1     Running   0          8s
nginx-deployment-9456bbbf9-9rcdk   1/1     Running   0          8s
nginx-deployment-9456bbbf9-dqv8s   1/1     Running   0          8s
<span class="hljs-meta prompt_">
# </span><span class="bash">删除nginx</span>
[root@k8s-master01 ~]# kubectl delete deployments nginx-deployment 
</code></pre>
<h2 data-id="heading-145">13.安装dashboard</h2>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">添加源信息</span>
helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
<span class="hljs-meta prompt_">

# </span><span class="bash">修改为国内源</span>
helm pull kubernetes-dashboard/kubernetes-dashboard
tar xvf kubernetes-dashboard-*.tgz
cd kubernetes-dashboard
sed -i "s#docker.io/#jockerhub.com/#g" values.yaml
<span class="hljs-meta prompt_">
# </span><span class="bash">默认参数安装</span>
helm upgrade --install kubernetes-dashboard ./kubernetes-dashboard/  --create-namespace --namespace kube-system
<span class="hljs-meta prompt_">

# </span><span class="bash">我的集群使用默认参数安装 kubernetes-dashboard-kong 出现异常 8444 端口占用</span>
<span class="hljs-meta prompt_"># </span><span class="bash">使用下面的命令进行安装，在安装时关闭kong.tls功能</span>
helm upgrade --install kubernetes-dashboard ./kubernetes-dashboard/ --namespace kube-system --set kong.admin.tls.enabled=false
</code></pre>
<h3 data-id="heading-146">13.1更改dashboard的svc为NodePort，如果已是请忽略</h3>
<pre><code class="hljs language-shell" lang="shell">kubectl edit svc  -n kube-system kubernetes-dashboard-kong-proxy
  type: NodePort
</code></pre>
<h3 data-id="heading-147">13.2查看端口号</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 ~]# kubectl get svc kubernetes-dashboard-kong-proxy -n kube-system
NAME                              TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE
kubernetes-dashboard-kong-proxy   NodePort   10.100.9.217   &lt;none&gt;        443:31330/TCP   42s
[root@k8s-master01 ~]# 
</code></pre>
<h3 data-id="heading-148">13.3创建token</h3>
<pre><code class="hljs language-shell" lang="shell">cat &gt; dashboard-user.yaml &lt;&lt; EOF
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kube-system
EOF

kubectl  apply -f dashboard-user.yaml
<span class="hljs-meta prompt_">
# </span><span class="bash">创建token</span>
kubectl -n kube-system create token admin-user
eyJhbGciOiJSUzI1NiIsImtpZCI6ImtxelI3UzBZOFl5MGtWU1k0c2QyUVRaOXhQeEFNYTNHWlNyRUFucHBIVGMifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzY2MTUzNDIwLCJpYXQiOjE3NjYxNDk4MjAsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwianRpIjoiN2E1NWM3MDEtODc5ZC00YjBmLTg2YTMtNWVmMDBjZjE0NGI0Iiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiZTc5ODAyMzYtNTUyOC00NjRjLWFlOTctMWVmNDJiMWY3ODhhIn19LCJuYmYiOjE3NjYxNDk4MjAsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTphZG1pbi11c2VyIn0.oDH1uZAWnxeq7gun0ej0ihbSJa6YYZwXcDt9O_tHQsWRi9Lr4kcusG0sm6UntEAy7fHLf6UWLTNHtv-V2lvDjUxRM46xQUzDOQ2v5hBI9NnpcRXQRvMvwn0s6wFeGNr2aFZ9i9aeSJZTdqHOlBjrqxsJtYD6fqDGtJYGdbvUA50nvXPN25a9ofgKvEtWjMA50ojGCr3yqF3vrWruEV77suFeYyIye5YXMnJw_I7Cp3zSEwrAuqfyVAlRv8mYQKxZJsNyban2-wcV10V5qzkofSL4DkgBaqqTDh1aOeD2NJrjmLKPQUt8meLohYy5tMGoyZgx0NGzr-9R71KF8tFHoA
</code></pre>
<h3 data-id="heading-149">13.4创建长期token</h3>
<pre><code class="hljs language-shell" lang="shell">cat &gt; dashboard-user-token.yaml &lt;&lt; EOF
apiVersion: v1
kind: Secret
metadata:
  name: admin-user
  namespace: kube-system
  annotations:
    kubernetes.io/service-account.name: "admin-user"   
type: kubernetes.io/service-account-token  
EOF

kubectl  apply -f dashboard-user-token.yaml
<span class="hljs-meta prompt_">
# </span><span class="bash">查看密码</span>
kubectl get secret admin-user -n kube-system -o jsonpath={".data.token"} | base64 -d

eyJhbGciOiJSUzI1NiIsImtpZCI6ImtxelI3UzBZOFl5MGtWU1k0c2QyUVRaOXhQeEFNYTNHWlNyRUFucHBIVGMifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJlNzk4MDIzNi01NTI4LTQ2NGMtYWU5Ny0xZWY0MmIxZjc4OGEiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.etS6ehzcPjtdipt4zm3L2FJpcbYFlJGLGXmrd8dLMGDw2xVU5XQgZM2gMrHa_rrJPnRKcksaG7qNpasM574D7__CpcktduTM_EsUiOc5i7u9lHDMxsPczyiFxlOp7d8jOdNbqwnlEPA5iYWJ6P3Cj3LiDfFKKHQChKgv8mS588Eh-nnYiMsblWltqvPd_DOJ9JxJ4G4T25yWsbEgpH3uZmXUAyVUDNgDFLNIKRPQXLg5d07rlmgHjJInvEsnrrCs8dxp173iNW8LYxnDNy7pwjrXbvniYiRXjltAwc6F68G590hQaogy9AEVUskeTgBvONPJwkZRHbf0beOL30pT0w
</code></pre>
<h3 data-id="heading-150">13.5登录dashboard</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2F192.168.1.31%3A31268%2F" target="_blank" title="https://192.168.1.31:31268/" ref="nofollow noopener noreferrer">https://192.168.1.31:31268/</a></p>
<h2 data-id="heading-151">14.部署metallb</h2>
<h3 data-id="heading-152">14.1 下载部署</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">下载应用包</span>
wget https://raw.githubusercontent.com/metallb/metallb/v0.15.2/config/manifests/metallb-native.yaml
<span class="hljs-meta prompt_">
# </span><span class="bash">修改镜像地址</span>
<span class="hljs-meta prompt_"># </span><span class="bash">自行找代理</span>
sed -i "s#quay.io#quay.chenby.cn#g" metallb-native.yaml 
cat metallb-native.yaml | grep image
        image: quay.chenby.cn/metallb/controller:v0.14.5
        image: quay.chenby.cn/metallb/speaker:v0.14.5
        
<span class="hljs-meta prompt_"># </span><span class="bash">执行部署</span>
kubectl apply -f metallb-native.yaml
<span class="hljs-meta prompt_">
# </span><span class="bash">可以连接国际网络</span>
<span class="hljs-meta prompt_"># </span><span class="bash">kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.15.2/config/manifests/metallb-native.yaml</span>
</code></pre>
<h3 data-id="heading-153">14.2 查看运行情况</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-master01 kubernetes-v1.35.0]# kubectl -n metallb-system get all 
NAME                              READY   STATUS              RESTARTS   AGE
pod/controller-59f49888d7-chwst   1/1     Running             0          54s
pod/speaker-4nkv6                 0/1     Running             0          54s
pod/speaker-dzfzs                 0/1     ErrImagePull        0          53s
pod/speaker-fmwgn                 0/1     ContainerCreating   0          53s
pod/speaker-jch8z                 0/1     Running             0          53s
pod/speaker-pplvk                 0/1     Running             0          53s

NAME                              TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
service/metallb-webhook-service   ClusterIP   10.100.70.55   &lt;none&gt;        443/TCP   54s

NAME                     DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
daemonset.apps/speaker   5         5         0       5            0           kubernetes.io/os=linux   54s

NAME                         READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/controller   1/1     1            1           54s

NAME                                    DESIRED   CURRENT   READY   AGE
replicaset.apps/controller-59f49888d7   1         1         1       54s
[root@k8s-master01 kubernetes-v1.35.0]# 


</code></pre>
<h3 data-id="heading-154">14.3 配置VIP的资源池</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">新版本metallb使用了CR（Custom Resources），这里我们通过IPAddressPool的CR，进行地址池的定义。</span>
<span class="hljs-meta prompt_"># </span><span class="bash">如果实例中不设置IPAddressPool选择器L2Advertisement；那么L2Advertisement默认为该实例所有的IPAddressPool相关联。</span>

cat &gt; metallb-config-ipaddresspool.yaml &lt;&lt; EOF
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: first-pool
  namespace: metallb-system
spec:
  addresses:
  - 192.168.1.71-192.168.1.75
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">进行L2关联地址池的绑定。</span>

cat &gt; metallb-config-L2Advertisement.yaml &lt;&lt; EOF
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: example
  namespace: metallb-system
spec:
  ipAddressPools:
  - first-pool
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">执行部署</span>
kubectl apply -f metallb-config-ipaddresspool.yaml
kubectl apply -f metallb-config-L2Advertisement.yaml
</code></pre>
<h2 data-id="heading-155">15.ingress安装</h2>
<h3 data-id="heading-156">15.1执行部署</h3>
<p>字数限制，详见完整版 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcby-chen%2FKubernetes" target="_blank" title="https://github.com/cby-chen/Kubernetes" ref="nofollow noopener noreferrer">github.com/cby-chen/Ku…</a></p>
<p><strong>关于</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oiox.cn%2F" target="_blank" title="https://www.oiox.cn/" ref="nofollow noopener noreferrer">www.oiox.cn/</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oiox.cn%2Findex.php%2Fstart-page.html" target="_blank" title="https://www.oiox.cn/index.php/start-page.html" ref="nofollow noopener noreferrer">www.oiox.cn/index.php/s…</a></p>
<p><strong>CSDN、GitHub、知乎、开源中国、思否、掘金、简书、华为云、阿里云、腾讯云、哔哩哔哩、今日头条、新浪微博、个人博客</strong></p>
<p><strong>全网可搜《小陈运维》</strong></p>
<p><strong>文章主要发布于微信公众号：《Linux运维交流社区》</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux系统调用实现原理（基于ARM 64, kernel-6.6）]]></title>    <link>https://juejin.cn/post/7585390679397810182</link>    <guid>https://juejin.cn/post/7585390679397810182</guid>    <pubDate>2025-12-19T12:30:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679397810182" data-draft-id="7585382553289359396" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux系统调用实现原理（基于ARM 64, kernel-6.6）"/> <meta itemprop="keywords" content="操作系统"/> <meta itemprop="datePublished" content="2025-12-19T12:30:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="子非愚"/> <meta itemprop="url" content="https://juejin.cn/user/538088404426650"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux系统调用实现原理（基于ARM 64, kernel-6.6）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/538088404426650/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    子非愚
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T12:30:10.000Z" title="Fri Dec 19 2025 12:30:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用户态发起系统调用</h2>
<p>当用户态代码调用系统调用时，将会触发一次异常，从而进入内核态。ARM64提供了汇编指令svc，实现该功能。其中x8寄存器存储了系统调用号，参数一般存在x0寄存器到x5寄存器。</p>
<p>以下案例是绕过libc，直接通过内联方法调用系统调用的案例：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 手动调用 write 系统调用（ARM64）</span>
    <span class="hljs-comment">// 参数：x0=1(STDOUT), x1=字符串地址, x2=长度, x8=64(write 系统调用号)</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg = <span class="hljs-string">"Raw Syscall: Hello ARM64\n"</span>;
    <span class="hljs-type">int</span> len = <span class="hljs-number">21</span>;  <span class="hljs-comment">// 字符串长度</span>
    
    <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span> <span class="hljs-params">(
        <span class="hljs-string">"mov x8, #64\n"</span>    <span class="hljs-comment">// x8 = write 系统调用号（64）</span>
        <span class="hljs-string">"svc #0\n"</span>         <span class="hljs-comment">// 触发系统调用（ARM64 核心指令）</span>
        :                   <span class="hljs-comment">// 输出寄存器（无）</span>
        : <span class="hljs-string">"r"</span>(<span class="hljs-number">1</span>), <span class="hljs-string">"r"</span>(msg), <span class="hljs-string">"r"</span>(len)  <span class="hljs-comment">// 输入寄存器：x0=1, x1=msg, x2=len</span>
        : <span class="hljs-string">"x8"</span>, <span class="hljs-string">"memory"</span>    <span class="hljs-comment">// 告诉编译器：x8 和内存会被修改，避免优化</span>
    )</span></span>;

    <span class="hljs-comment">// 手动调用 exit 系统调用（x8=93, x0=0）</span>
    <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span> <span class="hljs-params">(
        <span class="hljs-string">"mov x8, #93\n"</span>    <span class="hljs-comment">// x8 = exit 系统调用号（93）</span>
        <span class="hljs-string">"svc #0\n"</span>
        :
        : <span class="hljs-string">"r"</span>(<span class="hljs-number">0</span>)           <span class="hljs-comment">// x0=0（退出码）</span>
        : <span class="hljs-string">"x8"</span>
    )</span></span>;

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>编译出中间汇编代码</p>
<pre><code class="hljs language-arduino" lang="arduino">aarch64-linux-gnu-gcc -S -O0 -fverbose-<span class="hljs-keyword">asm</span> -ffreestanding -nostdlib -o test.s test.c
</code></pre>
<p>编译出最后可执行文件</p>
<pre><code class="hljs language-csharp" lang="csharp">aarch64-linux-gnu-gcc -<span class="hljs-keyword">static</span> -ffreestanding -nostdlib -e main -o test.<span class="hljs-keyword">out</span> test.c
</code></pre>
<h2 data-id="heading-1">内核执行系统调用</h2>
<p>kernel会在内核态实现该异常处理。</p>
<h3 data-id="heading-2">el0t_64_sync</h3>
<p>kernel的用户态入口实现一般在 <em>arch/arm64/kernel/entry.S</em></p>
<pre><code class="hljs language-ini" lang="ini">entry_handler	0, t, 64, sync  <span class="hljs-comment">; 启用 EL0 64位 同步异常（如SVC/Abort/Trap）处理入口</span>
entry_handler	0, t, 64, irq   <span class="hljs-comment">; 启用 EL0 64位 普通中断（IRQ）处理入口</span>
entry_handler	0, t, 64, fiq   <span class="hljs-comment">; 启用 EL0 64位 快速中断（FIQ）处理入口</span>
entry_handler	0, t, 64, error <span class="hljs-comment">; 启用 EL0 64位 系统错误（SError）处理入口</span>
</code></pre>
<p>其中entry_handler为汇编中的宏，具体定义如下：</p>
<pre><code class="hljs language-csharp" lang="csharp">; el:req, ht:req, regsize:req, label:req 代表<span class="hljs-number">4</span>个参数
; el\el\ht\()_\regsize\()_\label 拼接出字符串，比如el0t_64_sync
	.macro entry_handler el:req, ht:req, regsize:req, label:<span class="hljs-function">req
<span class="hljs-title">SYM_CODE_START_LOCAL</span>(<span class="hljs-params">el\el\ht\(</span>)_\regsize\()_\label)
	kernel_entry \el, \regsize
	mov	x0, sp
	bl	el\el\ht\()_\regsize\()_\label\()_handler
	.<span class="hljs-keyword">if</span> \el</span> == <span class="hljs-number">0</span>
	b	ret_to_user
	.<span class="hljs-keyword">else</span>
	b	ret_to_kernel
	.<span class="hljs-function">endif
<span class="hljs-title">SYM_CODE_END</span>(<span class="hljs-params">el\el\ht\(</span>)_\regsize\()_\label)
	.endm
</span></code></pre>
<p><strong>&lt;include/linux/linkage.h&gt;</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/* SYM_L_* -- linkage of symbols */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SYM_L_GLOBAL(name)			.globl name</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SYM_L_WEAK(name)			.weak name</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SYM_L_LOCAL(name)			<span class="hljs-comment">/* nothing */</span></span>

<span class="hljs-comment">/* SYM_A_* -- align the symbol? */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SYM_A_ALIGN				ALIGN</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SYM_A_NONE				<span class="hljs-comment">/* nothing */</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> SYM_CODE_START_LOCAL</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SYM_CODE_START_LOCAL(name)			\
	SYM_START(name, SYM_L_LOCAL, SYM_A_ALIGN)</span>
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-comment">// ASM_NL 汇编换行符</span>
<span class="hljs-comment">// 此处生成参数name的段</span>

<span class="hljs-comment">/* SYM_ENTRY -- use only if you have to for non-paired symbols */</span>
<span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> SYM_ENTRY</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SYM_ENTRY(name, linkage, align...)		\
	linkage(name) ASM_NL				\
	align ASM_NL					\
	name:</span>
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-comment">/* SYM_START -- use only if you have to */</span>
<span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> SYM_START</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SYM_START(name, linkage, align...)		\
	SYM_ENTRY(name, linkage, align)</span>
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
</code></pre>
<p>所以会在entry.s中生成el0t_64_sync函数段，该函数非常简单，先执行el0t_64_sync_handler，最后调用ret_to_user返回用户态。</p>
<h3 data-id="heading-3">el0t_64_sync_handler</h3>
<p><strong>&lt;arch/arm64/kernel/entry-common.c&gt;</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">asmlinkage <span class="hljs-type">void</span> noinstr <span class="hljs-title">el0t_64_sync_handler</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pt_regs *regs)</span>
</span>{
	<span class="hljs-comment">// 从esr寄存器读取陷入异常的原因</span>
	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> esr = <span class="hljs-built_in">read_sysreg</span>(esr_el1);

	<span class="hljs-keyword">switch</span> (<span class="hljs-built_in">ESR_ELx_EC</span>(esr)) {
	<span class="hljs-keyword">case</span> ESR_ELx_EC_SVC64: <span class="hljs-comment">// 64 位用户态 SVC 系统调用</span>
		<span class="hljs-built_in">el0_svc</span>(regs);
		<span class="hljs-keyword">break</span>;
	<span class="hljs-keyword">case</span> ESR_ELx_EC_DABT_LOW:
		<span class="hljs-built_in">el0_da</span>(regs, esr);
	...
}
</code></pre>
<p>el0_svc -&gt; do_el0_svc -&gt; el0_svc_common(arch/arm64/kernel/syscall.c文件中) -&gt; invoke_syscall</p>
<h3 data-id="heading-4">invoke_syscall</h3>
<p><strong>&lt;arch/arm64/kernel/syscall.c&gt;</strong></p>
<pre><code class="hljs language-scss" lang="scss">void <span class="hljs-built_in">do_el0_svc</span>(struct pt_regs *regs)
{
	<span class="hljs-comment">// sys_call_table 系统调用表</span>
	<span class="hljs-comment">// regs-&gt;regs[8]中获取到系统调用号</span>
	<span class="hljs-built_in">el0_svc_common</span>(regs, regs-&gt;regs[<span class="hljs-number">8</span>], __NR_syscalls, sys_call_table);
}

static void <span class="hljs-built_in">el0_svc_common</span>(struct pt_regs *regs, int scno, int sc_nr,
			   const syscall_fn_t syscall_table[])
{
	...
	<span class="hljs-built_in">invoke_syscall</span>(regs, scno, sc_nr, syscall_table);
	...
}

static long <span class="hljs-built_in">__invoke_syscall</span>(struct pt_regs *regs, syscall_fn_t syscall_fn)
{
	return <span class="hljs-built_in">syscall_fn</span>(regs);
}

static void <span class="hljs-built_in">invoke_syscall</span>(struct pt_regs *regs, unsigned int scno,
			   unsigned int sc_nr,
			   const syscall_fn_t syscall_table[])
{
	long ret;

	<span class="hljs-built_in">add_random_kstack_offset</span>();

	if (scno &lt; sc_nr) {
		syscall_fn_t syscall_fn;
		<span class="hljs-comment">// 根据方法号找到系统调用实现</span>
		syscall_fn = syscall_table<span class="hljs-selector-attr">[array_index_nospec(scno, sc_nr)]</span>;
		<span class="hljs-comment">// 调用系统调用实现</span>
		ret = <span class="hljs-built_in">__invoke_syscall</span>(regs, syscall_fn);
	} else {
		ret = <span class="hljs-built_in">do_ni_syscall</span>(regs, scno);
	}

	<span class="hljs-built_in">syscall_set_return_value</span>(current, regs, <span class="hljs-number">0</span>, ret);

	<span class="hljs-comment">/*
	 * This value will get limited by KSTACK_OFFSET_MAX(), which is 10
	 * bits. The actual entropy will be further reduced by the compiler
	 * when applying stack alignment constraints: the AAPCS mandates a
	 * 16-byte aligned SP at function boundaries, which will remove the
	 * 4 low bits from any entropy chosen here.
	 *
	 * The resulting 6 bits of entropy is seen in SP[9:4].
	 */</span>
	<span class="hljs-built_in">choose_random_kstack_offset</span>(get_random_u16());
}
</code></pre>
<h2 data-id="heading-5">内核实现系统调用</h2>
<h3 data-id="heading-6">系统调用表</h3>
<pre><code class="hljs language-arduino" lang="arduino">...

<span class="hljs-comment">/*
 * Wrappers to pass the pt_regs argument.
 */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __arm64_sys_personality		__arm64_sys_arm64_personality</span>

<span class="hljs-comment">// 通过宏声明系统调用的实现函数</span>
<span class="hljs-comment">// 拼接的函数名，比如 __arm64_mmap</span>
<span class="hljs-meta">#<span class="hljs-keyword">undef</span> __SYSCALL</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __SYSCALL(nr, sym)	asmlinkage long __arm64_##sym(const struct pt_regs *);</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/unistd.h&gt;</span></span>

<span class="hljs-comment">// 定义嵌套宏</span>
<span class="hljs-meta">#<span class="hljs-keyword">undef</span> __SYSCALL</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __SYSCALL(nr, sym)	[nr] = __arm64_##sym,</span>

<span class="hljs-comment">// 通过宏生成系统调用表</span>
<span class="hljs-type">const</span> <span class="hljs-type">syscall_fn_t</span> sys_call_table[__NR_syscalls] = {
	[<span class="hljs-number">0</span> ... __NR_syscalls - <span class="hljs-number">1</span>] = __arm64_sys_ni_syscall,
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/unistd.h&gt;</span></span>
};
</code></pre>
<p>unistd.h头文件嵌套：
arch/arm64/include/asm/unistd.h -&gt; arch/arm64/include/uapi/asm/unistd.h -&gt; include/uapi/asm-generic/unistd.h<br/>
<strong>&lt;include/uapi/asm-generic/unistd.h&gt;</strong> 中罗列了系统调用列表。</p>
<pre><code class="hljs language-arduino" lang="arduino">...
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_setxattr 5</span>
__SYSCALL(__NR_setxattr, sys_setxattr)
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_lsetxattr 6</span>
__SYSCALL(__NR_lsetxattr, sys_lsetxattr)
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsetxattr 7</span>
__SYSCALL(__NR_fsetxattr, sys_fsetxattr)
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_getxattr 8</span>
__SYSCALL(__NR_getxattr, sys_getxattr)
...
</code></pre>
<h3 data-id="heading-7">定义系统调用</h3>
<p>系统调用表中的函数，是通过<em>SYSCALL_DEFINE</em>宏定义的。
比如mmap的系统调用实现如下：</p>
<p><strong>&lt;arch/arm64/kernel/sys.c&gt;</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/compiler.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/errno.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mm.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/export.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/sched.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/slab.h&gt;</span></span>
<span class="hljs-comment">// 会嵌套调用 #include &lt;asm/syscall_wrapper.h&gt;</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/syscalls.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/cpufeature.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/syscall.h&gt;</span></span>

...

<span class="hljs-built_in">SYSCALL_DEFINE6</span>(mmap, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, len,
		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, prot, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, flags,
		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, fd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, off)
{
	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">offset_in_page</span>(off) != <span class="hljs-number">0</span>)
		<span class="hljs-keyword">return</span> -EINVAL;

	<span class="hljs-keyword">return</span> <span class="hljs-built_in">ksys_mmap_pgoff</span>(addr, len, prot, flags, fd, off &gt;&gt; PAGE_SHIFT);
}
</code></pre>
<p><strong>&lt;include/linux/syscalls.h&gt;</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/signal.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/list.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/bug.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/sem.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/siginfo.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/quota.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/key.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/personality.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;trace/syscall.h&gt;</span></span>

<span class="hljs-comment">// 如果打开该宏，引入syscall_wrapper头文件</span>
<span class="hljs-comment">// arm64上使用该头文件的 SYSCALL_DEFINE 宏定义</span>
 
<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ARCH_HAS_SYSCALL_WRAPPER</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/syscall_wrapper.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">endif</span> /</span>
...
</code></pre>
<p><strong>&lt;arch/arm64/include/asm/syscall_wrapper.h&gt;</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">__SYSCALL_DEFINEx</span>(x, name, ...)						\
	asmlinkage long __arm64_sys#<span class="hljs-selector-id">#name</span>(const struct pt_regs *regs);		\
	<span class="hljs-built_in">ALLOW_ERROR_INJECTION</span>(__arm64_sys##name, ERRNO);			\
	static long __se_sys#<span class="hljs-selector-id">#name</span>(__MAP(x,__SC_LONG,__VA_ARGS__));		\
	static inline long __do_sys#<span class="hljs-selector-id">#name</span>(__MAP(x,__SC_DECL,__VA_ARGS__));	\
	asmlinkage long __arm64_sys#<span class="hljs-selector-id">#name</span>(const struct pt_regs *regs);		\
	asmlinkage long __arm64_sys#<span class="hljs-selector-id">#name</span>(const struct pt_regs *regs)		\
	{									\
		return __se_sys#<span class="hljs-selector-id">#name</span>(SC_ARM64_REGS_TO_ARGS(x,__VA_ARGS__));	\
	}									\
	static long __se_sys#<span class="hljs-selector-id">#name</span>(__MAP(x,__SC_LONG,__VA_ARGS__))		\
	{									\
		long ret = __do_sys#<span class="hljs-selector-id">#name</span>(__MAP(x,__SC_CAST,__VA_ARGS__));	\
		<span class="hljs-built_in">__MAP</span>(x,__SC_TEST,__VA_ARGS__);					\
		<span class="hljs-built_in">__PROTECT</span>(x, ret,__MAP(x,__SC_ARGS,__VA_ARGS__));		\
		return ret;							\
	}									\
	static inline long __do_sys#<span class="hljs-selector-id">#name</span>(__MAP(x,__SC_DECL,__VA_ARGS__))

<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">SYSCALL_DEFINE0</span>(sname)							\
	<span class="hljs-built_in">SYSCALL_METADATA</span>(_##sname, <span class="hljs-number">0</span>);						\
	asmlinkage long __arm64_sys_#<span class="hljs-selector-id">#sname</span>(const struct pt_regs *__unused);	\
	<span class="hljs-built_in">ALLOW_ERROR_INJECTION</span>(__arm64_sys_##sname, ERRNO);			\
	asmlinkage long __arm64_sys_#<span class="hljs-selector-id">#sname</span>(const struct pt_regs *__unused)

<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">SYSCALL_DEFINEx</span>(x, sname, ...)				\
	<span class="hljs-built_in">SYSCALL_METADATA</span>(sname, x, __VA_ARGS__)			\
	<span class="hljs-built_in">__SYSCALL_DEFINEx</span>(x, sname, __VA_ARGS__)
</code></pre>
<p>ARM64上默认开启了<strong>ARCH_HAS_SYSCALL_WRAPPER</strong>宏。</p>
<p><strong>&lt;arch/arm64/Kconfig&gt;</strong></p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-built_in">config</span> ARM64
	def_bool y
	...
	<span class="hljs-built_in">select</span> ARCH_HAS_SYSCALL_WRAPPER
</code></pre>
<p>所以 <strong>SYSCALL_DEFINE6 mmap</strong> 会定义 <strong>__arm64_sys_mmap</strong> 函数，即为系统调用表中mmap系统调用的实现。</p>
<h2 data-id="heading-8">CPU如何找到异常处理函数</h2>
<p>执行svc指令，为什么会调到el0t_64_sync函数呢？
其实是通过查询启动时设置进ARM规定的寄存器内异常向量表，找到异常处理函数后进行跳转的。</p>
<h3 data-id="heading-9">生成异常向量表</h3>
<p>异常向量表也是通过汇编宏实现的：<br/>
<strong>&lt;arch/arm64/kernel/entry.S&gt;</strong><br/>
<strong>1. 定义汇编宏</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.macro</span> <span class="hljs-selector-tag">kernel_ventry</span>, <span class="hljs-selector-tag">el</span>:<span class="hljs-selector-tag">req</span>, <span class="hljs-selector-tag">ht</span>:<span class="hljs-selector-tag">req</span>, <span class="hljs-selector-tag">regsize</span>:<span class="hljs-selector-tag">req</span>, <span class="hljs-selector-tag">label</span>:<span class="hljs-selector-tag">req</span>
	<span class="hljs-selector-class">.align</span> <span class="hljs-number">7</span>
; 第一步，如果是从<span class="hljs-selector-tag">el0</span>进<span class="hljs-selector-tag">el1</span>，备份和清理<span class="hljs-selector-tag">tpidrro_el0</span>
<span class="hljs-selector-class">.Lventry_start</span>\@:
	<span class="hljs-selector-class">.if</span>	\<span class="hljs-selector-tag">el</span> == <span class="hljs-number">0</span>
	<span class="hljs-comment">/*
	 * This must be the first instruction of the EL0 vector entries. It is
	 * skipped by the trampoline vectors, to trigger the cleanup.
	 */</span>
	<span class="hljs-selector-tag">b</span>	<span class="hljs-selector-class">.Lskip_tramp_vectors_cleanup</span>\@
	<span class="hljs-selector-class">.if</span>	\<span class="hljs-selector-tag">regsize</span> == <span class="hljs-number">64</span>
	<span class="hljs-selector-tag">mrs</span>	<span class="hljs-selector-tag">x30</span>, <span class="hljs-selector-tag">tpidrro_el0</span>
	<span class="hljs-selector-tag">msr</span>	<span class="hljs-selector-tag">tpidrro_el0</span>, <span class="hljs-selector-tag">xzr</span>
	<span class="hljs-selector-class">.else</span>
	<span class="hljs-selector-tag">mov</span>	<span class="hljs-selector-tag">x30</span>, <span class="hljs-selector-tag">xzr</span>
	<span class="hljs-selector-class">.endif</span>
<span class="hljs-selector-class">.Lskip_tramp_vectors_cleanup</span>\@:
	<span class="hljs-selector-class">.endif</span>

; 第二步，在<span class="hljs-selector-tag">stack</span>上构建异常栈帧
	<span class="hljs-selector-tag">sub</span>	<span class="hljs-selector-tag">sp</span>, <span class="hljs-selector-tag">sp</span>, <span class="hljs-selector-id">#PT_REGS_SIZE</span>

; 第三步，跳转到异常处理函数段，比如<span class="hljs-selector-tag">el0t_64_sync</span>
	<span class="hljs-selector-tag">b</span>	<span class="hljs-selector-tag">el</span>\<span class="hljs-selector-tag">el</span>\<span class="hljs-selector-tag">ht</span>\()<span class="hljs-selector-tag">_</span>\<span class="hljs-selector-tag">regsize</span>\()<span class="hljs-selector-tag">_</span>\<span class="hljs-selector-tag">label</span>
<span class="hljs-selector-class">.org</span> <span class="hljs-selector-class">.Lventry_start</span>\@ + <span class="hljs-number">128</span>	<span class="hljs-comment">// Did we overflow the ventry slot?</span>
	<span class="hljs-selector-class">.endm</span>
</code></pre>
<p><strong>2. 拼接构建异常向量表</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">/*
 * Exception vectors.
 */</span>
	.pushsection <span class="hljs-string">".entry.text"</span>, <span class="hljs-string">"ax"</span>

	.align	<span class="hljs-number">11</span>
SYM_CODE_START(vectors)
	kernel_ventry	<span class="hljs-number">1</span>, t, <span class="hljs-number">64</span>, sync		<span class="hljs-comment">// Synchronous EL1t</span>
	kernel_ventry	<span class="hljs-number">1</span>, t, <span class="hljs-number">64</span>, irq		<span class="hljs-comment">// IRQ EL1t</span>
	kernel_ventry	<span class="hljs-number">1</span>, t, <span class="hljs-number">64</span>, fiq		<span class="hljs-comment">// FIQ EL1t</span>
	kernel_ventry	<span class="hljs-number">1</span>, t, <span class="hljs-number">64</span>, <span class="hljs-type">error</span>		<span class="hljs-comment">// Error EL1t</span>

	kernel_ventry	<span class="hljs-number">1</span>, h, <span class="hljs-number">64</span>, sync		<span class="hljs-comment">// Synchronous EL1h</span>
	kernel_ventry	<span class="hljs-number">1</span>, h, <span class="hljs-number">64</span>, irq		<span class="hljs-comment">// IRQ EL1h</span>
	kernel_ventry	<span class="hljs-number">1</span>, h, <span class="hljs-number">64</span>, fiq		<span class="hljs-comment">// FIQ EL1h</span>
	kernel_ventry	<span class="hljs-number">1</span>, h, <span class="hljs-number">64</span>, <span class="hljs-type">error</span>		<span class="hljs-comment">// Error EL1h</span>

	kernel_ventry	<span class="hljs-number">0</span>, t, <span class="hljs-number">64</span>, sync		<span class="hljs-comment">// Synchronous 64-bit EL0</span>
	kernel_ventry	<span class="hljs-number">0</span>, t, <span class="hljs-number">64</span>, irq		<span class="hljs-comment">// IRQ 64-bit EL0</span>
	kernel_ventry	<span class="hljs-number">0</span>, t, <span class="hljs-number">64</span>, fiq		<span class="hljs-comment">// FIQ 64-bit EL0</span>
	kernel_ventry	<span class="hljs-number">0</span>, t, <span class="hljs-number">64</span>, <span class="hljs-type">error</span>		<span class="hljs-comment">// Error 64-bit EL0</span>

	kernel_ventry	<span class="hljs-number">0</span>, t, <span class="hljs-number">32</span>, sync		<span class="hljs-comment">// Synchronous 32-bit EL0</span>
	kernel_ventry	<span class="hljs-number">0</span>, t, <span class="hljs-number">32</span>, irq		<span class="hljs-comment">// IRQ 32-bit EL0</span>
	kernel_ventry	<span class="hljs-number">0</span>, t, <span class="hljs-number">32</span>, fiq		<span class="hljs-comment">// FIQ 32-bit EL0</span>
	kernel_ventry	<span class="hljs-number">0</span>, t, <span class="hljs-number">32</span>, <span class="hljs-type">error</span>		<span class="hljs-comment">// Error 32-bit EL0</span>
SYM_CODE_END(vectors)
</code></pre>
<p>异常向量表的布局，需要严格遵守ARM的约定：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c57b2ff0e24e4658a0f1d39d58f4361a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q6Z2e5oSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766752210&amp;x-signature=zMwTi8t7v2GSbGMeeaL%2BkXS8Vb0%3D" alt="image.png" loading="lazy"/>
<em><strong>《Learn the architecture - AArch64 Exception Model》</strong></em></p>
<p>中文解释如下：</p>




























































































































<table><thead><tr><th>相对基址偏移</th><th>异常入口类型</th><th>异常等级/模式</th><th>触发场景（举例）</th><th>对应内核代码中的宏</th></tr></thead><tbody><tr><td>0x000</td><td>Synchronous</td><td>EL0 (AArch64)</td><td>用户态系统调用（svc #0）、未定义指令</td><td><code>tramp_ventry (EL0,64)</code></td></tr><tr><td>0x080</td><td>IRQ</td><td>EL0 (AArch64)</td><td>用户态外设中断（如键盘中断）</td><td><code>tramp_ventry (EL0,64)</code></td></tr><tr><td>0x100</td><td>FIQ</td><td>EL0 (AArch64)</td><td>用户态快速中断（极少使用）</td><td><code>tramp_ventry (EL0,64)</code></td></tr><tr><td>0x180</td><td>Error</td><td>EL0 (AArch64)</td><td>用户态数据访问错误（如非法地址）</td><td><code>tramp_ventry (EL0,64)</code></td></tr><tr><td>0x200</td><td>Synchronous</td><td>EL1t (AArch64)</td><td>内核态同步异常（如空指针访问）</td><td><code>kernel_ventry(1,t,64,sync)</code></td></tr><tr><td>0x280</td><td>IRQ</td><td>EL1t (AArch64)</td><td>内核态外设中断（如网卡中断）</td><td><code>kernel_ventry(1,t,64,irq)</code></td></tr><tr><td>0x300</td><td>FIQ</td><td>EL1t (AArch64)</td><td>内核态快速中断（极少使用）</td><td><code>kernel_ventry(1,t,64,fiq)</code></td></tr><tr><td>0x380</td><td>Error</td><td>EL1t (AArch64)</td><td>内核态数据访问错误（如页表错误）</td><td><code>kernel_ventry(1,t,64,error)</code></td></tr><tr><td>0x400</td><td>Synchronous</td><td>EL1h (AArch64)</td><td>虚拟化模式内核同步异常</td><td><code>kernel_ventry(1,h,64,sync)</code></td></tr><tr><td>0x480</td><td>IRQ</td><td>EL1h (AArch64)</td><td>虚拟化模式内核IRQ中断</td><td><code>kernel_ventry(1,h,64,irq)</code></td></tr><tr><td>0x500</td><td>FIQ</td><td>EL1h (AArch64)</td><td>虚拟化模式内核FIQ中断</td><td><code>kernel_ventry(1,h,64,fiq)</code></td></tr><tr><td>0x580</td><td>Error</td><td>EL1h (AArch64)</td><td>虚拟化模式内核错误异常</td><td><code>kernel_ventry(1,h,64,error)</code></td></tr><tr><td>0x600</td><td>Synchronous</td><td>EL0 (AArch32)</td><td>32位用户态系统调用</td><td><code>tramp_ventry (EL0,32)</code></td></tr><tr><td>0x680</td><td>IRQ</td><td>EL0 (AArch32)</td><td>32位用户态IRQ中断</td><td><code>tramp_ventry (EL0,32)</code></td></tr><tr><td>0x700</td><td>FIQ</td><td>EL0 (AArch32)</td><td>32位用户态FIQ中断</td><td><code>tramp_ventry (EL0,32)</code></td></tr><tr><td>0x780</td><td>Error</td><td>EL0 (AArch32)</td><td>32位用户态错误异常</td><td><code>tramp_ventry (EL0,32)</code></td></tr></tbody></table>
<h4 data-id="heading-10">备份清理tpidrro_el0</h4>
<p>tpidrro_el0：ARM64 架构中EL0（用户态）只读的线程局部存储（TLS）寄存器，核心作用是为用户态线程提供 “线程私有数据的快速访问入口”。</p>
<pre><code class="hljs language-ini" lang="ini">.if	\<span class="hljs-attr">regsize</span> == <span class="hljs-number">64</span>
	<span class="hljs-comment">; 将tpidrro_el0备份到x30寄存器</span>
	mrs	x30, tpidrro_el0
	<span class="hljs-comment">; 用零值寄存器xzr清理tpidrro_el0</span>
	msr	tpidrro_el0, xzr
</code></pre>
<p><strong>为什么要保存tpidrro_el0寄存器</strong></p>
<ol>
<li>防止用户态数据泄露到内核态，引起安全性问题</li>
<li>调试等操作可能污染tpidrro_el0寄存器数据</li>
<li>tpidrro_el0寄存器不会自动保存，此处不保存的话，如果切换任务后，tpidrro_el0会被其他用户态进程干扰污染</li>
<li>tpidrro_el0是用户态只读寄存器，因此依赖内核做备份和清理操作</li>
</ol>
<p><strong>为什么使用x30寄存器</strong></p>
<p>x30寄存器，在arm64中为Link Register (LR)链接寄存器，存储函数调用的返回地址（bl 指令会自动将返回地址写入 x30）；若无函数调用时，可作为普通通用寄存器使用。</p>
<ol>
<li>陷入异常时，并未发生函数调用，因此x30可以复用。而x0-x29等通用寄存器需要保留，后续会用于保存栈帧。</li>
<li>异常切换时，CPU只会自动保存/恢复通用寄存器（x0-x30），所以会用x30作为备份寄存器。</li>
</ol>
<h3 data-id="heading-11">设置异常向量表</h3>
<p><strong>&lt;arch/arm64/kernel/head.S&gt;</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">SYM_FUNC_START_LOCAL</span>(__primary_switched)
	adr_l	x4, init_task
	init_cpu_task x4, x5, x6

	<span class="hljs-comment">// 加载异常向量表（vectors）的虚拟地址到x8</span>
	adr_l	x8, vectors			<span class="hljs-comment">// load VBAR_EL1 with virtual</span>
	<span class="hljs-comment">// 将向量表地址写入VBAR_EL1寄存器</span>
	msr	vbar_el1, x8			<span class="hljs-comment">// vector table address</span>
	<span class="hljs-comment">// 指令同步屏障，确保VBAR_EL1修改立即生效</span>
	isb
	...
</code></pre>
<p>调用顺序：primary_entry -&gt; __primary_switch -&gt; __primary_switched，而 primary_entry 是 ARM64 主 CPU 核上电后执行的第一个汇编入口。<br/>
VBAR_EL1 是 ARM64 架构中EL1（内核态）的向量基地址寄存器（Vector Base Address Register），核心作用是存储异常向量表的虚拟基地址。<br/>
<strong>因此发生系统调用时，cpu通过vbar_el1查询到异常处理函数地址，进而跳转到异常处理函数。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++ constexpr]]></title>    <link>https://juejin.cn/post/7585410547337232434</link>    <guid>https://juejin.cn/post/7585410547337232434</guid>    <pubDate>2025-12-19T18:54:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585410547337232434" data-draft-id="7585410547336986674" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++ constexpr"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-12-19T18:54:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Sichg"/> <meta itemprop="url" content="https://juejin.cn/user/2276407984011465"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++ constexpr
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2276407984011465/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Sichg
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T18:54:40.000Z" title="Fri Dec 19 2025 18:54:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>constexpr</code>是C++的修饰词，用于指定“编译期可以求数值的常量表达式”，可用于修饰变量，函数，类/结构体，构造函数/析构函数，模板五种情况，作用就是支持编译期常量处理。<code>constexpr</code>的实际应用中最常用的是修饰变量和函数。</p>
<ul>
<li><code>constexpr</code>用于修饰变量，可以构建真常量，即编译器常量。</li>
<li><code>constexpr</code>用于修饰函数，可以用于编译期求值；</li>
<li><code>constexpr</code>用于修饰类/结构体。可以用来在编译期构造对象；</li>
<li><code>constexpr</code>用于修饰构造函数/析构函数，可以在编译器就对类对象进行初始化/销毁；</li>
<li><code>constexpr</code>用于修饰模板，在编译期间完成模板实例化进行求数值。</li>
</ul>
<p>增加编译期间求解的效果是提升性能、增强类型安全。</p>
<h4 data-id="heading-0">实例1——<code>constexpr</code>修饰变量：</h4>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> MAXsize = <span class="hljs-number">100</span>; <span class="hljs-comment">// 由constexptr修饰的int型真常量，</span>
<span class="hljs-comment">//在编译期就可以通过直接赋值确定取值为100.</span>
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> OVERsize = MAXsize + <span class="hljs-number">50</span>；
<span class="hljs-comment">//在编译期可以通过计算得到确定取值为150.</span>
<span class="hljs-comment">//由constexpr修饰的MAXsize和OVERsize两个真常量，分别取值100和150.</span>
<span class="hljs-comment">//编译正常。符合处理直觉。</span>
</code></pre>
<p>提问：
constexpr 可以修饰变量，此时该变量是编译期常量（值必须在编译期确定，且生命周期内不可修改，比 const 更严格）如果这个变量的取值在编译期间没有确定会报错吗?还是任意给这个变量取定一个随机值?取定随机值会导致这个变量实际没有可用效果? 以及这里讲的生命周期不可修改是什么意思?一个constexpr修饰的真常量的生命周期不就是整个程序运行的期间都有效吗?编译期常量即真常量是不占用C++堆内存和栈内存的吧！</p>
<pre><code class="hljs language-arduino" lang="arduino">解答：
<span class="hljs-comment">// constexpr 修饰变量，这个变量的数值必须在编译期确定，生命周期内不可修改。</span>
<span class="hljs-comment">// 如果编译期间这个变量的数值没有确定指定，会直接编译报错，无随机值。</span>
<span class="hljs-comment">// constexpr 修饰得到的真常量在生命周期内都只具有只读属性，不可修改。</span>
<span class="hljs-comment">// constexpr 修饰得到的真常量的生命周期取决于变量定义所在的作用域决定。</span>
    <span class="hljs-comment">// 即constexpr只负责跟编译器通力合作在编译期间确定数值。</span>
    <span class="hljs-comment">// 至于这个真常量在何时失效取决于这个变量的自身的作用域，</span>
    <span class="hljs-comment">// 即定义在函数内部的变量，即便加上constexpr修饰，</span>
    <span class="hljs-comment">// 这个真常量的生命周期依然只在函数内的局部作用域效果下。constexpr修饰的真常量被存储在静态只读数据区。</span>
</code></pre>
<p>总结1：</p>
<ul>
<li><code>constexpr</code>修饰变量，得到真常量，存储在静态存储区，不占用运行内存；（因此增强性能）</li>
<li><code>constexpr</code>修饰得到的真常量，如果没有在编译期指定，直接报错。</li>
<li><code>constexpr</code>修饰得到的真常量，生命周期内权限为只读，不可修改。</li>
<li><code>constexpr</code>修饰得到的真常量，生命周期长度取决于变量本身的生命周期。</li>
</ul>
<h4 data-id="heading-1">实例2——<code>constexpr</code>修饰函数：</h4>
<p>表示这个函数，如果入参是编译期常量，在编译期完成计算得到处理结果。如果入参不是编译期间常量，那就退化成普通函数。两种情况都不会报错。UDL和普通函数都支持这种退化兼容。</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-comment">//constexpr修饰UDL(自定义字面值运算符)</span>
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-keyword">operator</span> <span class="hljs-string">""</span> _KM2m(<span class="hljs-type">long</span> <span class="hljs-type">long</span> kilometer) {
    <span class="hljs-keyword">return</span> kilometer*<span class="hljs-number">1000</span>;
}
<span class="hljs-comment">//constexpr修饰普通函数</span>
<span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span></span>{
    <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<h4 data-id="heading-2">实例3——<code>constexpr</code>修饰类/结构体：</h4>
<p>作用是在编译期构造类对象，即<strong>编译期常量对象</strong>。
要求：</p>
<ul>
<li>类的构造函数必须是<code>constexpr</code>构造函数；</li>
<li>编译期内需调用的成员函数也必须有<code>constexpr</code>修饰；</li>
<li>类的成员变量中，对于被<code>constexpr</code>使用/依赖的静态成员变量，必须在类内<code>constexpr</code>修饰。而且最好直接用<code>static constexpr</code></li>
</ul>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-comment">//constexpr修饰结构体(在C++中将结构体视为类的一种)</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Point</span>{

    <span class="hljs-comment">//constexpr 修饰构造函数</span>
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">Point</span><span class="hljs-params">(<span class="hljs-type">int</span> x_, <span class="hljs-type">int</span> y_)</span> ： <span class="hljs-title">x</span><span class="hljs-params">(x_)</span>, <span class="hljs-title">y</span><span class="hljs-params">(y_)</span> </span>{}
        <span class="hljs-comment">// C++中约定俗成用 变量名右加下划线 表示类成员变量的命名。</span>
        <span class="hljs-comment">// x(x_), y(y_) 是 C++ 中的「成员初始化列表（Member Initialization List）</span>
            <span class="hljs-comment">// 效果是将x_,y_的值对应赋值给x，y</span>
            <span class="hljs-comment">// `x(x_)` 和 `x=x_` 在初始化列表中等价</span>
            
    <span class="hljs-comment">//constexpr 修饰构造函数</span>
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> <span class="hljs-title">get_x</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">return</span>}
    }
    
    <span class="hljs-type">int</span> x;
    <span class="hljs-type">int</span> y;
   }
   
   <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span> <span class="hljs-params">()</span> </span>{
       <span class="hljs-comment">//编译器构造Ponit对象</span>
       <span class="hljs-function"><span class="hljs-keyword">constexpr</span> Point <span class="hljs-title">p0</span><span class="hljs-params">(<span class="hljs-number">10</span>,<span class="hljs-number">20</span>)</span></span>;
       <span class="hljs-comment">//编译期调用成员函数，获取数值</span>
       <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> x_val = p0.<span class="hljs-built_in">get_x</span>(); 
       <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
   }
</code></pre>
<ul>
<li>非静态成员变量是指属于单个对象的变量，每个对象独一份，生命周期随对象变化；</li>
<li>静态成员变量属于类本身的，所有对象共享一份，生命周期贯穿程序。
<ul>
<li>静态const成员变量：类内直接初始化，因为贯穿程序的生命周期，且在运行期间数值不可修改，是绑定在整个类上的变量。<code>static const</code> 变量类型 变量名 = 初始化数值；
<ul>
<li><code>static constexpr</code> 变量类型 变量名 = 初始化数值; 效果更好。</li>
</ul>
</li>
<li>-这里的static其实是指类共享。静态变量本质是类共享变量；非静态变量是类不共享变量。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">实例4——<code>constexpr</code>修饰构造函数/析构函数：</h4>
<p>构造函数用<code>constexpr</code>修饰，要么非空要么只涉及基本四则运算和判断的简洁函数体。
析构函数用<code>constexpr</code>修饰，得到的效果是编译期对象销毁时没有运行期开销。
（<code>constexpr</code>修饰的效果要么是用于设定真常量，要么是能在编译期间能处理的事情给处理了。）</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyInt</span>{

    <span class="hljs-keyword">public</span>: 
        <span class="hljs-comment">//构造函数</span>
        <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">MyInt</span> <span class="hljs-params">(<span class="hljs-type">int</span> val_)</span> : val(val_) {</span>}
        <span class="hljs-comment">//析构函数</span>
        <span class="hljs-keyword">constexpr</span> ~<span class="hljs-built_in">MyInt</span>() = <span class="hljs-keyword">default</span>; <span class="hljs-comment">//析构函数直接 = default 就行。</span>
        <span class="hljs-comment">//成员函数</span>
        <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> <span class="hljs-title">get_val</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
            <span class="hljs-keyword">return</span> val;
        }

    <span class="hljs-keyword">private</span>:
        <span class="hljs-type">int</span> val;
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">//在编译期构造 MyInt 对象</span>
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> MyInt <span class="hljs-title">mi</span><span class="hljs-params">(<span class="hljs-number">100</span>)</span></span>;
    <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> val = mi.<span class="hljs-built_in">get_val</span>(); <span class="hljs-comment">// 编译期求值为100</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>关联说明类成员函数的<code>const</code>尾缀修饰：
<code>constexpr int get_val() const {             return val; //这个const成员函数只读取，没有修改val的权限。         }</code></p>
<h5 data-id="heading-4"><code>const</code>成员函数</h5>
<p>作用是限定这个成员函数对成员变量的操作权限仅仅是只读。</p>
<ul>
<li>禁止修改类的非静态成员变量，确保这个函数只进行只读操作，不会改变对象的状态。</li>
<li>禁止调用非<code>const</code>成员函数。</li>
</ul>
<h5 data-id="heading-5"><code>const</code> 是 “承诺不修改成员变量”，仅支持运行期执行；<code>constexpr</code> 是 “支持编译期求值”，</h5>
<h4 data-id="heading-6">实例5——<code>constexpr</code>修饰模板template：</h4>
<p>使模板实例化后具备编译器求值能力。</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">template</span> T&gt;
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> T <span class="hljs-title">max_val</span><span class="hljs-params">(T a, T b)</span></span>{
        <span class="hljs-keyword">return</span> a &gt; b ? a : b;
    }
    
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> max_num = <span class="hljs-built_in">max_val</span>(<span class="hljs-number">5</span>,<span class="hljs-number">10</span>);
    <span class="hljs-comment">//编译期求值: max_val(5,10)实例化得到int型数据，取值为10.</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Docker 容器启动的全方位方法汇总]]></title>    <link>https://juejin.cn/post/7585452404112375823</link>    <guid>https://juejin.cn/post/7585452404112375823</guid>    <pubDate>2025-12-20T01:49:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585452404112375823" data-draft-id="7585145251843309583" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Docker 容器启动的全方位方法汇总"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T01:49:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿杰AJie"/> <meta itemprop="url" content="https://juejin.cn/user/3871838955636704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Docker 容器启动的全方位方法汇总
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3871838955636704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿杰AJie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T01:49:20.000Z" title="Sat Dec 20 2025 01:49:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、最基础的启动</h2>
<pre><code class="hljs language-arduino" lang="arduino">docker run &lt;镜像名&gt;
</code></pre>
<ul>
<li>仅启动容器，不映射端口，不持久化数据</li>
<li>容器退出后数据会丢失</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、后台运行</h2>
<pre><code class="hljs language-arduino" lang="arduino">docker run -d &lt;镜像名&gt;
</code></pre>
<ul>
<li><code>-d</code> → detached 模式，后台运行</li>
<li>常用于服务类镜像（MySQL、Redis、Nginx 等）</li>
</ul>
<hr/>
<h2 data-id="heading-2">三、命名容器</h2>
<pre><code class="hljs language-arduino" lang="arduino">docker run --name mycontainer &lt;镜像名&gt;
</code></pre>
<ul>
<li>方便管理、停止、删除</li>
<li>例如 <code>docker stop mycontainer</code></li>
</ul>
<hr/>
<h2 data-id="heading-3">四、端口映射（外部访问）</h2>
<pre><code class="hljs language-xml" lang="xml">docker run -p <span class="hljs-tag">&lt;<span class="hljs-name">宿主机端口</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">容器端口</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">镜像名</span>&gt;</span>
</code></pre>
<ul>
<li>Web 服务、数据库必须映射端口</li>
<li>多端口映射示例：</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">docker run -p <span class="hljs-number">8080</span>:<span class="hljs-number">80</span> -p <span class="hljs-number">443</span>:<span class="hljs-number">443</span> nginx
</code></pre>
<hr/>
<h2 data-id="heading-4">五、数据持久化（卷和目录挂载）</h2>
<ol>
<li><strong>挂载宿主机目录</strong></li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">docker run -v /宿主机路径:/容器路径 &lt;镜像名&gt;
</code></pre>
<p>示例：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -v /data/mysql:/var/lib/mysql mysql:8.0
</code></pre>
<ol start="2">
<li><strong>Docker 卷</strong></li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">docker volume create myvolume
docker run -v myvolume:/容器路径 &lt;镜像名&gt;
</code></pre>
<ul>
<li>卷管理方便，可通过 <code>docker volume ls</code> 查看</li>
</ul>
<hr/>
<h2 data-id="heading-5">六、环境变量配置</h2>
<pre><code class="hljs language-ini" lang="ini">docker run -e <span class="hljs-attr">KEY</span>=VALUE &lt;镜像名&gt;
</code></pre>
<ul>
<li>
<p>数据库镜像常用：</p>
<ul>
<li><code>MYSQL_ROOT_PASSWORD</code></li>
<li><code>MYSQL_DATABASE</code></li>
<li><code>MYSQL_USER</code></li>
<li><code>MYSQL_PASSWORD</code></li>
</ul>
</li>
<li>
<p>Web 服务镜像常用：</p>
<ul>
<li><code>TZ</code>（时区）</li>
<li><code>APP_ENV</code>、<code>DEBUG</code> 等自定义变量</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-6">七、重启策略</h2>
<pre><code class="hljs language-xml" lang="xml">docker run --restart <span class="hljs-tag">&lt;<span class="hljs-name">策略</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">镜像名</span>&gt;</span>
</code></pre>
<ul>
<li><code>no</code> → 不自动重启（默认）</li>
<li><code>always</code> → 容器停止或 Docker 重启都会自动启动</li>
<li><code>unless-stopped</code> → 除非手动停止，否则自动启动</li>
<li><code>on-failure[:最大重试次数]</code> → 出错自动重启</li>
</ul>
<hr/>
<h2 data-id="heading-7">八、交互模式（进入容器）</h2>
<pre><code class="hljs language-javascript" lang="javascript">docker run -it &lt;镜像名&gt; <span class="hljs-regexp">/bin/</span>bash
</code></pre>
<ul>
<li><code>-it</code> → 交互模式 + 分配伪终端</li>
<li>适用于调试、临时测试</li>
</ul>
<hr/>
<h2 data-id="heading-8">九、组合启动示例（生产环境通用模板）</h2>
<pre><code class="hljs language-xml" lang="xml">docker run -d \
  --name <span class="hljs-tag">&lt;<span class="hljs-name">容器名</span>&gt;</span> \
  -p <span class="hljs-tag">&lt;<span class="hljs-name">宿主端口</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">容器端口</span>&gt;</span> \
  -v <span class="hljs-tag">&lt;<span class="hljs-name">宿主路径</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">容器路径</span>&gt;</span> \
  -e KEY1=VALUE1 -e KEY2=VALUE2 \
  --restart unless-stopped \
  <span class="hljs-tag">&lt;<span class="hljs-name">镜像名</span>&gt;</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">十、常用容器管理命令</h2>









































<table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td><code>docker ps</code></td><td>查看运行中的容器</td></tr><tr><td><code>docker ps -a</code></td><td>查看所有容器</td></tr><tr><td><code>docker stop &lt;容器&gt;</code></td><td>停止容器</td></tr><tr><td><code>docker start &lt;容器&gt;</code></td><td>启动容器</td></tr><tr><td><code>docker restart &lt;容器&gt;</code></td><td>重启容器</td></tr><tr><td><code>docker rm &lt;容器&gt;</code></td><td>删除容器</td></tr><tr><td><code>docker logs &lt;容器&gt;</code></td><td>查看日志</td></tr><tr><td><code>docker exec -it &lt;容器&gt; &lt;命令&gt;</code></td><td>进入容器或执行命令</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">十一、镜像管理</h2>





































<table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td><code>docker pull &lt;镜像&gt;</code></td><td>下载镜像</td></tr><tr><td><code>docker images</code></td><td>查看本地镜像</td></tr><tr><td><code>docker rmi &lt;镜像&gt;</code></td><td>删除镜像</td></tr><tr><td><code>docker save -o &lt;文件&gt;.tar &lt;镜像&gt;</code></td><td>导出镜像</td></tr><tr><td><code>docker load -i &lt;文件&gt;.tar</code></td><td>导入镜像</td></tr><tr><td><code>docker tag &lt;镜像&gt; &lt;新镜像&gt;</code></td><td>镜像打标签</td></tr><tr><td><code>docker push &lt;镜像&gt;</code></td><td>推送到仓库</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-11">十二、系统信息与清理</h2>

























<table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td><code>docker info</code></td><td>查看 Docker 系统信息</td></tr><tr><td><code>docker version</code></td><td>查看版本</td></tr><tr><td><code>docker system df</code></td><td>查看磁盘占用</td></tr><tr><td><code>docker system prune -a</code></td><td>清理无用镜像、容器、网络</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-12">十三、特殊启动选项</h2>

































<table><thead><tr><th>需求</th><th>参数</th></tr></thead><tbody><tr><td>限制内存</td><td><code>--memory=1g</code></td></tr><tr><td>限制 CPU</td><td><code>--cpus=1.5</code></td></tr><tr><td>设置 hostname</td><td><code>--hostname myhost</code></td></tr><tr><td>指定网络</td><td><code>--network mynet</code></td></tr><tr><td>连接多个网络</td><td><code>--network network1 --network network2</code></td></tr><tr><td>临时容器（退出自动删除）</td><td><code>--rm</code></td></tr></tbody></table>
<hr/>
<p>💡 总结：</p>
<ul>
<li><strong>必需参数</strong>：镜像名、端口映射（服务类）、数据卷（持久化）</li>
<li><strong>推荐参数</strong>：环境变量、重启策略、容器命名</li>
<li><strong>可选参数</strong>：CPU/内存限制、网络配置、调试模式</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[观察者模式：从理论到生产实践]]></title>    <link>https://juejin.cn/post/7585397173023014931</link>    <guid>https://juejin.cn/post/7585397173023014931</guid>    <pubDate>2025-12-20T02:27:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585397173023014931" data-draft-id="7585400495683321898" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="观察者模式：从理论到生产实践"/> <meta itemprop="keywords" content="设计模式,Java"/> <meta itemprop="datePublished" content="2025-12-20T02:27:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            观察者模式：从理论到生产实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T02:27:07.000Z" title="Sat Dec 20 2025 02:27:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">观察者模式深度解析：从理论到生产实践</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c416cb9945a411d90037b47ef3563de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766802427&amp;x-signature=3HkmNCsWokdIGT4tARE5%2Fw4DnVs%3D" alt="01_观察者模式UML类图.png" loading="lazy"/></p>
<p>在软件开发中，我们经常需要实现"一个对象状态变化，多个对象自动更新"的场景。比如用户注册成功时，需要发送欢迎邮件、赠送积分、记录日志等多个操作。这种一对多的依赖关系，正是观察者模式的典型应用场景。</p>
<h3 data-id="heading-1">观察者模式是什么？</h3>
<p>观察者模式（Observer Pattern）是一种行为设计模式，它定义了一种一对多的依赖关系，让多个观察者对象同时监听某一个主题对象。当主题对象的状态发生变化时，所有观察者都会收到通知并自动更新。</p>
<p>这里借用建筑监理的比喻：投资方（观察者们）委托建筑师（主题）监督项目进度。每当有建筑进展，建筑师主动通知所有投资方，无需投资方反复询问。</p>
<h3 data-id="heading-2">核心角色与实现</h3>
<p>观察者模式主要包含四个角色：</p>
<ol>
<li><strong>Subject（主题）</strong>：定义了被观察者对象的基本接口</li>
<li><strong>ConcreteSubject（具体主题）</strong>：主题的具体实现，维护观察者列表</li>
<li><strong>Observer（观察者）</strong>：定义了观察者对通知做出反应的方法</li>
<li><strong>ConcreteObserver（具体观察者）</strong>：实现Observer接口，观察主题并执行相应操作</li>
</ol>
<p>下面通过一个实际的电商库存管理示例来展示观察者模式的实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 观察者接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InventoryObserver</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onInventoryChanged</span><span class="hljs-params">(Product product, <span class="hljs-type">int</span> newQuantity)</span>;
}

<span class="hljs-comment">// 具体观察者1：库存预警系统</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InventoryAlert</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InventoryObserver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onInventoryChanged</span><span class="hljs-params">(Product product, <span class="hljs-type">int</span> newQuantity)</span> {
        <span class="hljs-keyword">if</span> (newQuantity &lt; <span class="hljs-number">10</span>) {
            System.out.println(<span class="hljs-string">"⚠️ 库存预警: "</span> + product.getName() + <span class="hljs-string">" 库存不足，当前数量: "</span> + newQuantity);
        }
    }
}

<span class="hljs-comment">// 具体观察者2：订单处理系统</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InventoryObserver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onInventoryChanged</span><span class="hljs-params">(Product product, <span class="hljs-type">int</span> newQuantity)</span> {
        <span class="hljs-keyword">if</span> (newQuantity &lt; <span class="hljs-number">5</span>) {
            System.out.println(<span class="hljs-string">"📦 自动触发补货: "</span> + product.getName() + <span class="hljs-string">" 正在向供应商下单..."</span>);
        }
    }
}

<span class="hljs-comment">// 具体观察者3：价格调整系统</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PriceAdjuster</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InventoryObserver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onInventoryChanged</span><span class="hljs-params">(Product product, <span class="hljs-type">int</span> newQuantity)</span> {
        <span class="hljs-keyword">if</span> (newQuantity &gt; <span class="hljs-number">100</span>) {
            System.out.println(<span class="hljs-string">"💰 库存充足，可以考虑促销降价！"</span>);
        }
    }
}

<span class="hljs-comment">// 主题接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InventorySubject</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addObserver</span><span class="hljs-params">(InventoryObserver observer)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeObserver</span><span class="hljs-params">(InventoryObserver observer)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyObservers</span><span class="hljs-params">(Product product, <span class="hljs-type">int</span> quantity)</span>;
}

<span class="hljs-comment">// 具体主题：库存管理器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InventoryManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InventorySubject</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;InventoryObserver&gt; observers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Integer&gt; inventory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addObserver</span><span class="hljs-params">(InventoryObserver observer)</span> {
        observers.add(observer);
        System.out.println(<span class="hljs-string">"添加观察者: "</span> + observer.getClass().getSimpleName());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeObserver</span><span class="hljs-params">(InventoryObserver observer)</span> {
        observers.remove(observer);
        System.out.println(<span class="hljs-string">"移除观察者: "</span> + observer.getClass().getSimpleName());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyObservers</span><span class="hljs-params">(Product product, <span class="hljs-type">int</span> quantity)</span> {
        <span class="hljs-keyword">for</span> (InventoryObserver observer : observers) {
            observer.onInventoryChanged(product, quantity);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateStock</span><span class="hljs-params">(String productId, <span class="hljs-type">int</span> quantity)</span> {
        inventory.put(productId, quantity);
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(productId, <span class="hljs-string">"Product-"</span> + productId);
        notifyObservers(product, quantity);
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ObserverDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建库存管理器（主题）</span>
        <span class="hljs-type">InventoryManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InventoryManager</span>();

        <span class="hljs-comment">// 创建观察者</span>
        <span class="hljs-type">InventoryAlert</span> <span class="hljs-variable">alert</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InventoryAlert</span>();
        <span class="hljs-type">OrderProcessor</span> <span class="hljs-variable">orderProcessor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderProcessor</span>();
        <span class="hljs-type">PriceAdjuster</span> <span class="hljs-variable">priceAdjuster</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriceAdjuster</span>();

        <span class="hljs-comment">// 注册观察者</span>
        manager.addObserver(alert);
        manager.addObserver(orderProcessor);
        manager.addObserver(priceAdjuster);

        System.out.println(<span class="hljs-string">"\n--- 模拟库存变化 ---"</span>);
        manager.updateStock(<span class="hljs-string">"iphone"</span>, <span class="hljs-number">3</span>);   <span class="hljs-comment">// 库存不足场景</span>

        System.out.println(<span class="hljs-string">"\n--- 模拟供应商补货 ---"</span>);
        manager.updateStock(<span class="hljs-string">"iphone"</span>, <span class="hljs-number">50</span>);  <span class="hljs-comment">// 补货后库存正常</span>

        System.out.println(<span class="hljs-string">"\n--- 模拟库存积压 ---"</span>);
        manager.updateStock(<span class="hljs-string">"iphone"</span>, <span class="hljs-number">150</span>); <span class="hljs-comment">// 库存积压场景</span>
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-diff" lang="diff">添加观察者: InventoryAlert
添加观察者: OrderProcessor
添加观察者: PriceAdjuster

<span class="hljs-comment">--- 模拟库存变化 ---</span>
⚠️ 库存预警: Product-iphone 库存不足，当前数量: 3
📦 自动触发补货: Product-iphone 正在向供应商下单...

<span class="hljs-comment">--- 模拟供应商补货 ---</span>

<span class="hljs-comment">--- 模拟库存积压 ---</span>
💰 库存充足，可以考虑促销降价！
</code></pre>
<h3 data-id="heading-3">Spring框架中的事件机制</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acf401cc8aa2458baca0f5233762cc7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766802427&amp;x-signature=2p1Gxi8gnpVfF7CtQ9VeE8fYSDE%3D" alt="03_Spring事件机制架构.png" loading="lazy"/></p>
<p>观察者模式在Spring框架中被广泛应用，其事件机制就是典型的实现。Spring的事件机制以ApplicationContext为核心，实现了观察者模式的高级封装：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义事件</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRegisterEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ApplicationEvent</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String username;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserRegisterEvent</span><span class="hljs-params">(Object source, String username)</span> {
        <span class="hljs-built_in">super</span>(source);
        <span class="hljs-built_in">this</span>.username = username;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> username;
    }
}

<span class="hljs-comment">// 事件监听器（观察者）</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@EventListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailSendListener</span> {
    <span class="hljs-meta">@EventListener(classes = UserRegisterEvent.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendEmail</span><span class="hljs-params">(UserRegisterEvent event)</span> {
        System.out.println(<span class="hljs-string">"📧 发送欢迎邮件给: "</span> + event.getUsername());
    }
}

<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@EventListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PointsGrantListener</span> {
    <span class="hljs-meta">@EventListener(classes = UserRegisterEvent.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">grantPoints</span><span class="hljs-params">(UserRegisterEvent event)</span> {
        System.out.println(<span class="hljs-string">"🎁 为新用户 "</span> + event.getUsername() + <span class="hljs-string">" 赠送100积分"</span>);
    }
}

<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@EventListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogRecordListener</span> {
    <span class="hljs-meta">@EventListener(classes = UserRegisterEvent.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordLog</span><span class="hljs-params">(UserRegisterEvent event)</span> {
        System.out.println(<span class="hljs-string">"📝 记录用户注册日志: "</span> + event.getUsername());
    }
}

<span class="hljs-comment">// 事件发布者</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ApplicationEventPublisher eventPublisher;

    <span class="hljs-meta">@PostMapping("/register")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;String&gt; <span class="hljs-title function_">register</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String username)</span> {
        <span class="hljs-comment">// 注册用户...</span>
        System.out.println(<span class="hljs-string">"创建用户: "</span> + username);

        <span class="hljs-comment">// 发布事件</span>
        <span class="hljs-type">UserRegisterEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserRegisterEvent</span>(<span class="hljs-built_in">this</span>, username);
        eventPublisher.publishEvent(event);

        <span class="hljs-keyword">return</span> ResponseEntity.ok(<span class="hljs-string">"注册成功"</span>);
    }
}
</code></pre>
<p>Spring的事件机制优势：</p>
<ul>
<li><strong>完全解耦</strong>：发布者和订阅者互不感知</li>
<li><strong>异步支持</strong>：支持@Async异步事件处理</li>
<li><strong>事务绑定</strong>：@TransactionalEventListener支持事务提交后触发</li>
<li><strong>条件过滤</strong>：@EventListener支持SpEL条件表达式</li>
</ul>
<h3 data-id="heading-4">消息队列中的观察者模式</h3>
<p>消息队列系统RabbitMQ本质上也是观察者模式的延伸，但采用了更灵活的发布-订阅模式：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 配置多队列消息监听</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RabbitListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderEventHandler</span> {

    <span class="hljs-comment">// 监听订单创建事件</span>
    <span class="hljs-meta">@RabbitListener(queues = "orderCreated")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderCreated</span><span class="hljs-params">(Order order)</span> {
        log.info(<span class="hljs-string">"订单创建事件: {}"</span>, order.getId());

        <span class="hljs-comment">// 1. 减库存</span>
        inventoryService.reduceStock(order);

        <span class="hljs-comment">// 2. 发送确认邮件</span>
        emailService.sendOrderConfirm(order);

        <span class="hljs-comment">// 3. 记录业务日志</span>
        auditService.log(order);
    }

    <span class="hljs-comment">// 监听订单支付事件</span>
    <span class="hljs-meta">@RabbitListener(queues = "orderPaid")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderPaid</span><span class="hljs-params">(String orderId)</span> {
        log.info(<span class="hljs-string">"订单支付事件: {}"</span>, orderId);

        <span class="hljs-comment">// 1. 更新订单状态</span>
        orderService.payOrder(orderId);

        <span class="hljs-comment">// 2. 通知物流系统发货</span>
        logisticsService.shipOrder(orderId);

        <span class="hljs-comment">// 3. 更新用户累计消费</span>
        userService.addConsumption(orderId);
    }

    <span class="hljs-comment">// 监听订单取消事件</span>
    <span class="hljs-meta">@RabbitListener(queues = "orderCancelled")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderCancelled</span><span class="hljs-params">(Order order)</span> {
        log.info(<span class="hljs-string">"订单取消事件: {}"</span>, order.getId());

        <span class="hljs-comment">// 1. 恢复库存</span>
        inventoryService.restoreStock(order);

        <span class="hljs-comment">// 2. 处理退款</span>
        paymentService.refund(order);

        <span class="hljs-comment">// 3. 发送取消通知</span>
        notificationService.orderCancelled(order);
    }
}
</code></pre>
<h3 data-id="heading-5">观察者模式 vs 发布-订阅模式</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f06e51881ab4859a313ccf7c8fa6a61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766802427&amp;x-signature=vEGnpo%2FAlJHLXNgSnnNijt1NhrE%3D" alt="04_观察者vs发布订阅对比.png" loading="lazy"/></p>
<p>很多人将观察者模式和发布-订阅模式混为一谈，实际上两者有明显区别：</p>



































<table><thead><tr><th>特性</th><th>观察者模式</th><th>发布-订阅模式</th></tr></thead><tbody><tr><td>耦合程度</td><td>相对较强（主题需维护观察者列表）</td><td>完全解耦（通过消息中介）</td></tr><tr><td>通信方式</td><td>同步通信</td><td>支持异步通信</td></tr><tr><td>分层结构</td><td>两层（主题-观察者）</td><td>三层（发布者-临时层-订阅者）</td></tr><tr><td>消息过滤</td><td>不支持</td><td>支持（如topic）</td></tr><tr><td>适用场景</td><td>同一应用中</td><td>分布式系统</td></tr></tbody></table>
<h3 data-id="heading-6">观察者模式工作流程</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc62a58e4fd04a63912cd80ba3238d05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766802427&amp;x-signature=nozx44hd5a0Vzmvaq4qUURCzyGU%3D" alt="02_观察者模式工作流程.png" loading="lazy"/></p>
<p>观察者模式的工作流程主要分为以下几个步骤：</p>
<ol>
<li><strong>注册阶段</strong>：观察者调用subscrib方法将自己注册到主题</li>
<li><strong>状态变更</strong>：主题对象的内部状态发生改变</li>
<li><strong>通知阶段</strong>：主题调用notify方法通知所有注册的观察者</li>
<li><strong>更新阶段</strong>：观察者收到通知后，调用对象的update方法更新自身状态</li>
</ol>
<h3 data-id="heading-7">应用场景分析</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9435ae0c1e23486190288902533a6a83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766802427&amp;x-signature=hvX8MqXCVU8vaDEQXtFtCBK0DJM%3D" alt="05_观察者模式应用场景.png" loading="lazy"/></p>
<p>观察者模式广泛应用于以下场景：</p>
<h4 data-id="heading-8">1. GUI组件事件监听</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// JavaFX 按钮点击监听</span>
<span class="hljs-type">Button</span> <span class="hljs-variable">button</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Button</span>(<span class="hljs-string">"点击我"</span>);
button.setOnAction(event -&gt; {
    System.out.println(<span class="hljs-string">"按钮被点击！"</span>);
});
</code></pre>
<h4 data-id="heading-9">2. 实时数据同步</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 数据库binlog监听（基于Canal）</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseChangeHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CanalClientEx</span> {
    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleChange</span><span class="hljs-params">(CanalEntry.EventType change)</span> {
        <span class="hljs-comment">// 同步到ES</span>
        elasticsearchService.sync(change);
        <span class="hljs-comment">// 同步到缓存</span>
        cacheService.sync(change);
        <span class="hljs-comment">// 通知下游服务</span>
        messageService.publish(change);
    }
}
</code></pre>
<h3 data-id="heading-10">实现要点与注意事项</h3>
<h4 data-id="heading-11">1. 观察者管理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用线程安全的集合管理观察者</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Observer&gt; observers =
    Collections.synchronizedList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());

<span class="hljs-comment">// 添加观察者</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addObserver</span><span class="hljs-params">(Observer observer)</span> {
    <span class="hljs-keyword">if</span> (observer == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"观察者不能为空"</span>);
    }
    <span class="hljs-keyword">synchronized</span>(observers) {
        observers.add(observer);
    }
}

<span class="hljs-comment">// 移除观察者</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeObserver</span><span class="hljs-params">(Observer observer)</span> {
    observers.remove(observer);
}
</code></pre>
<h4 data-id="heading-12">2. 防止观察者循环引用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteSubject</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Observable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">changed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyObservers</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 使用锁避免循环引用</span>
        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
            <span class="hljs-keyword">if</span> (!changed) {
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">// 复制观察者列表避免并发修改</span>
            Observer[] arr = observers.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>[<span class="hljs-number">0</span>]);
            clearChanged();

            <span class="hljs-keyword">for</span> (Observer observer : arr) {
                <span class="hljs-keyword">try</span> {
                    observer.update(<span class="hljs-built_in">this</span>, <span class="hljs-literal">null</span>);
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    log.warn(<span class="hljs-string">"通知观察者失败："</span>, e);
                }
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-13">3. 异步通知避免阻塞</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用线程池异步通知</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncEventPublisher</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publishEventAsync</span><span class="hljs-params">(InventoryEvent event)</span> {
        executor.execute(() -&gt; {
            <span class="hljs-keyword">try</span> {
                notifyObservers(event);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"异步事件通知失败"</span>, e);
            }
        });
    }

    <span class="hljs-comment">// 优雅关闭</span>
    <span class="hljs-meta">@PreDestroy</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> {
        executor.shutdown();
    }
}
</code></pre>
<h3 data-id="heading-14">优缺点分析</h3>
<p>✅ <strong>优点：</strong></p>
<ol>
<li><strong>降低耦合度</strong>：发布者和订阅者相互解耦，易于系统扩展</li>
<li><strong>遵守开闭原则</strong>：新增观察者时无需修改主题代码</li>
<li><strong>实现广播通信</strong>：一个主题状态变化，多个观察者同步更新</li>
<li><strong>消息传递高效</strong>：直接方法调用，性能优于消息队列</li>
</ol>
<p>❌<strong>缺点：</strong></p>
<ol>
<li><strong>观察者数量与性能相关</strong>：当观察者数量较多时，通知过程变慢</li>
<li><strong>循环依赖风险</strong>：观察者和主题之间可能产生循环引用</li>
<li><strong>同步通知阻塞所有观察者</strong>：一个观察者阻塞会影响整个通知链</li>
</ol>
<p>观察者模式作为最经典的设计模式之一，它的思想贯穿于各种事件处理和通知机制中。从简单的对象监听，到复杂的分布式事件系统，观察者模式都能发挥其解耦和扩展性的优势。掌握观察者模式，能够帮助我们构建更加灵活、可维护的软件架构。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 爬虫框架设计：类封装与工程化实践]]></title>    <link>https://juejin.cn/post/7585406030021836835</link>    <guid>https://juejin.cn/post/7585406030021836835</guid>    <pubDate>2025-12-20T01:23:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585406030021836835" data-draft-id="7585377128491221044" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 爬虫框架设计：类封装与工程化实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T01:23:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Felixwb666"/> <meta itemprop="url" content="https://juejin.cn/user/485307600606522"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 爬虫框架设计：类封装与工程化实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/485307600606522/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Felixwb666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T01:23:45.000Z" title="Sat Dec 20 2025 01:23:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 1688 数据采集等爬虫场景中，<strong>类封装</strong>能实现代码的复用与解耦，<strong>工程化</strong>则保障爬虫的稳定性、可维护性和可扩展性。本文将结合 1688 爬虫的实际需求，从<strong>框架设计原则</strong>、<strong>核心类封装</strong>、<strong>工程化配套模块</strong>到<strong>实战落地</strong>，完整讲解爬虫框架的设计与实现。</p>
<h2 data-id="heading-0">一、框架设计原则与整体架构</h2>
<h3 data-id="heading-1">1. 核心设计原则</h3>
<p>爬虫框架需遵循<strong>开闭原则</strong>（对扩展开放、对修改关闭）、<strong>单一职责</strong>（每个模块只做一件事）和<strong>依赖注入</strong>（模块间通过配置解耦），同时需适配 1688 的反爬特性（如动态渲染、IP 封禁）。</p>
<h3 data-id="heading-2">2. 整体架构分层</h3>
<p>将爬虫拆分为<strong>5 个核心层</strong>，层与层之间通过接口交互，降低耦合：</p>



































<table><thead><tr><th>层级</th><th>职责</th><th>核心实现方式</th></tr></thead><tbody><tr><td><strong>配置层</strong></td><td>管理爬虫参数（如代理、UA、爬取关键词）、存储配置等</td><td>YAML/JSON 配置文件 + 配置类</td></tr><tr><td><strong>请求层</strong></td><td>封装 HTTP 请求，处理反爬（代理、UA、延迟）、异常重试</td><td>基础请求类 + 反爬中间件</td></tr><tr><td><strong>解析层</strong></td><td>解析网页 / 接口数据，提取目标字段（如 1688 商品标题、价格）</td><td>解析器基类 + 业务解析子类</td></tr><tr><td><strong>存储层</strong></td><td>处理数据持久化（CSV/MySQL/MongoDB），支持数据去重</td><td>存储基类 + 多存储实现子类</td></tr><tr><td><strong>调度层</strong></td><td>管理爬取任务（分页、多线程 / 异步）、监控任务状态</td><td>调度器类 + 任务队列</td></tr></tbody></table>
<h2 data-id="heading-3">二、核心类封装实现</h2>
<p>基于分层架构，我们通过<strong>类的继承与多态</strong>封装通用逻辑，再针对 1688 场景实现具体业务。</p>
<h3 data-id="heading-4">1. 环境准备</h3>
<p>安装必备依赖：</p>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash">pip install requests beautifulsoup4 pyyaml fake-useragent playwright pymongo mysql-connector-python
playwright install chromium  <span class="hljs-comment"># 处理动态页面</span>
</code></pre>
<h3 data-id="heading-5">2. 配置层封装（Config 类）</h3>
<p>通过 YAML 配置文件管理参数，避免硬编码，便于后续修改。</p>
<p><strong>配置文件（config.yaml）</strong> ：</p>
<p>yaml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 爬虫基础配置</span>
<span class="hljs-attr">spider:</span>
  <span class="hljs-attr">keyword:</span> <span class="hljs-string">"手机壳"</span>  <span class="hljs-comment"># 1688搜索关键词</span>
  <span class="hljs-attr">max_page:</span> <span class="hljs-number">5</span>       <span class="hljs-comment"># 最大爬取页数</span>
  <span class="hljs-attr">delay:</span> <span class="hljs-number">3</span>          <span class="hljs-comment"># 请求延迟（秒）</span>
  <span class="hljs-attr">retry_times:</span> <span class="hljs-number">3</span>    <span class="hljs-comment"># 失败重试次数</span>

<span class="hljs-comment"># 反爬配置</span>
<span class="hljs-attr">anti_crawl:</span>
  <span class="hljs-attr">user_agent_pool:</span> [<span class="hljs-string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36..."</span>, <span class="hljs-string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) ..."</span>]
  <span class="hljs-attr">proxy_pool:</span> [<span class="hljs-string">"http://127.0.0.1:7890"</span>, <span class="hljs-string">"http://username:password@proxy.example.com:8080"</span>]  <span class="hljs-comment"># 代理池</span>

<span class="hljs-comment"># 存储配置</span>
<span class="hljs-attr">storage:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">"csv"</span>  <span class="hljs-comment"># 可选：csv/mongo/mysql</span>
  <span class="hljs-attr">csv_path:</span> <span class="hljs-string">"./1688_products.csv"</span>
  <span class="hljs-attr">mongo:</span>
    <span class="hljs-attr">uri:</span> <span class="hljs-string">"mongodb://localhost:27017/"</span>
    <span class="hljs-attr">db:</span> <span class="hljs-string">"1688_spider"</span>
    <span class="hljs-attr">collection:</span> <span class="hljs-string">"products"</span>
  <span class="hljs-attr">mysql:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">"localhost"</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">3306</span>
    <span class="hljs-attr">user:</span> <span class="hljs-string">"root"</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">"123456"</span>
    <span class="hljs-attr">db:</span> <span class="hljs-string">"1688_spider"</span>
</code></pre>
<p><strong>配置类封装（config.py）</strong> ：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> yaml
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">List</span>, <span class="hljs-type">Any</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span>:
    <span class="hljs-string">"""配置管理类，加载并解析YAML配置文件"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config_path: <span class="hljs-built_in">str</span> = <span class="hljs-string">"./config.yaml"</span></span>):
        self.config_path = config_path
        self.config = self._load_config()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_load_config</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        <span class="hljs-string">"""加载YAML配置"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(self.config_path, <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
                <span class="hljs-keyword">return</span> yaml.safe_load(f)
        <span class="hljs-keyword">except</span> FileNotFoundError:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">f"配置文件<span class="hljs-subst">{self.config_path}</span>不存在"</span>)
        <span class="hljs-keyword">except</span> yaml.YAMLError <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">f"配置文件解析错误：<span class="hljs-subst">{e}</span>"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self, key: <span class="hljs-built_in">str</span>, default: <span class="hljs-type">Any</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-type">Any</span>:
        <span class="hljs-string">"""按层级获取配置，如'spider.keyword'"""</span>
        keys = key.split(<span class="hljs-string">"."</span>)
        value = self.config
        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> keys:
            <span class="hljs-keyword">if</span> k <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> value:
                <span class="hljs-keyword">return</span> default
            value = value[k]
        <span class="hljs-keyword">return</span> value

<span class="hljs-comment"># 测试配置类</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    config = Config()
    <span class="hljs-built_in">print</span>(config.get(<span class="hljs-string">"spider.keyword"</span>))  <span class="hljs-comment"># 输出：手机壳</span>
    <span class="hljs-built_in">print</span>(config.get(<span class="hljs-string">"anti_crawl.proxy_pool"</span>))  <span class="hljs-comment"># 输出代理池列表</span>
</code></pre>
<h3 data-id="heading-6">3. 请求层封装（BaseRequest 类）</h3>
<p>封装 HTTP 请求的通用逻辑（反爬、重试、延迟），支持同步请求和动态页面请求（Playwright）。</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>, <span class="hljs-type">Optional</span>
<span class="hljs-keyword">from</span> fake_useragent <span class="hljs-keyword">import</span> UserAgent
<span class="hljs-keyword">from</span> playwright.sync_api <span class="hljs-keyword">import</span> sync_playwright
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> Config

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseRequest</span>:
    <span class="hljs-string">"""请求基类，封装通用请求逻辑"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: Config</span>):
        self.config = config
        self.ua = UserAgent()
        self.retry_times = self.config.get(<span class="hljs-string">"spider.retry_times"</span>, <span class="hljs-number">3</span>)
        self.delay = self.config.get(<span class="hljs-string">"spider.delay"</span>, <span class="hljs-number">2</span>)
        self.proxy_pool = self.config.get(<span class="hljs-string">"anti_crawl.proxy_pool"</span>, [])
        self.ua_pool = self.config.get(<span class="hljs-string">"anti_crawl.user_agent_pool"</span>, [])

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_random_proxy</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""随机获取代理"""</span>
        <span class="hljs-keyword">return</span> random.choice(self.proxy_pool) <span class="hljs-keyword">if</span> self.proxy_pool <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_random_ua</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""随机获取User-Agent"""</span>
        <span class="hljs-keyword">return</span> random.choice(self.ua_pool) <span class="hljs-keyword">if</span> self.ua_pool <span class="hljs-keyword">else</span> self.ua.random

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_add_delay</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""请求延迟，防反爬"""</span>
        time.sleep(random.uniform(self.delay, self.delay + <span class="hljs-number">2</span>))

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self, url: <span class="hljs-built_in">str</span>, params: <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>] = <span class="hljs-literal">None</span>, headers: <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>] = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""同步GET请求，支持重试和反爬"""</span>
        headers = headers <span class="hljs-keyword">or</span> {}
        headers[<span class="hljs-string">"User-Agent"</span>] = self._get_random_ua()
        proxies = {<span class="hljs-string">"http"</span>: self._get_random_proxy(), <span class="hljs-string">"https"</span>: self._get_random_proxy()} <span class="hljs-keyword">if</span> self._get_random_proxy() <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>

        <span class="hljs-keyword">for</span> retry <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.retry_times):
            <span class="hljs-keyword">try</span>:
                self._add_delay()
                resp = requests.get(url, params=params, headers=headers, proxies=proxies, timeout=<span class="hljs-number">10</span>)
                resp.raise_for_status()  <span class="hljs-comment"># 抛出HTTP错误</span>
                <span class="hljs-keyword">return</span> resp.text
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"请求失败（第<span class="hljs-subst">{retry+<span class="hljs-number">1</span>}</span>次重试）：<span class="hljs-subst">{e}</span>"</span>)
                time.sleep(<span class="hljs-number">2</span> ** retry)  <span class="hljs-comment"># 指数退避重试</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_dynamic</span>(<span class="hljs-params">self, url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
        <span class="hljs-string">"""动态页面请求（Playwright），返回关键数据"""</span>
        result = {<span class="hljs-string">"title"</span>: <span class="hljs-literal">None</span>, <span class="hljs-string">"price"</span>: <span class="hljs-literal">None</span>, <span class="hljs-string">"sales"</span>: <span class="hljs-literal">None</span>}
        <span class="hljs-keyword">with</span> sync_playwright() <span class="hljs-keyword">as</span> p:
            browser = p.chromium.launch(headless=<span class="hljs-literal">True</span>)
            page = browser.new_page(user_agent=self._get_random_ua())
            <span class="hljs-keyword">try</span>:
                page.goto(url, timeout=<span class="hljs-number">30000</span>)
                <span class="hljs-comment"># 提取1688商品详情页关键数据（需根据页面结构调整）</span>
                result[<span class="hljs-string">"title"</span>] = page.locator(<span class="hljs-string">".detail-title"</span>).inner_text() <span class="hljs-keyword">if</span> page.locator(<span class="hljs-string">".detail-title"</span>).count() &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
                result[<span class="hljs-string">"price"</span>] = page.locator(<span class="hljs-string">".price"</span>).inner_text() <span class="hljs-keyword">if</span> page.locator(<span class="hljs-string">".price"</span>).count() &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
                result[<span class="hljs-string">"sales"</span>] = page.locator(<span class="hljs-string">".sales-volume"</span>).inner_text() <span class="hljs-keyword">if</span> page.locator(<span class="hljs-string">".sales-volume"</span>).count() &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
                self._add_delay()
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"动态页面请求失败：<span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">finally</span>:
                browser.close()
        <span class="hljs-keyword">return</span> result

<span class="hljs-comment"># 测试请求类</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    config = Config()
    request = BaseRequest(config)
    html = request.get(<span class="hljs-string">"https://s.1688.com/selloffer/offer_search.htm?keywords=手机壳"</span>)
    <span class="hljs-built_in">print</span>(html[:<span class="hljs-number">500</span>])  <span class="hljs-comment"># 输出页面前500字符</span>
</code></pre>
<h3 data-id="heading-7">4. 解析层封装（BaseParser 类）</h3>
<p>封装数据解析的通用接口，子类实现具体的 1688 页面解析逻辑。</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> Config

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseParser</span>:
    <span class="hljs-string">"""解析器基类，定义解析接口"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: Config</span>):
        self.config = config

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">self, html: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
        <span class="hljs-string">"""解析接口，子类必须实现"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">"子类需实现parse方法"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Ali1688ListParser</span>(<span class="hljs-title class_ inherited__">BaseParser</span>):
    <span class="hljs-string">"""1688商品列表页解析器"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">self, html: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
        <span class="hljs-string">"""解析商品列表页，提取标题、价格、链接"""</span>
        soup = BeautifulSoup(html, <span class="hljs-string">"lxml"</span>)
        products = soup.select(<span class="hljs-string">".sm-offer-item"</span>)
        result = []
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> products:
            <span class="hljs-comment"># 提取字段（需根据1688页面结构实时调整）</span>
            title_elem = item.select_one(<span class="hljs-string">".offer-title a"</span>)
            price_elem = item.select_one(<span class="hljs-string">".price"</span>)
            link_elem = item.select_one(<span class="hljs-string">".offer-title a"</span>)

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (title_elem <span class="hljs-keyword">and</span> price_elem <span class="hljs-keyword">and</span> link_elem):
                <span class="hljs-keyword">continue</span>

            product = {
                <span class="hljs-string">"title"</span>: title_elem.get(<span class="hljs-string">"title"</span>, <span class="hljs-string">""</span>).strip(),
                <span class="hljs-string">"price"</span>: price_elem.text.strip(),
                <span class="hljs-string">"link"</span>: link_elem.get(<span class="hljs-string">"href"</span>, <span class="hljs-string">""</span>).strip(),
                <span class="hljs-string">"source"</span>: <span class="hljs-string">"1688"</span>
            }
            result.append(product)
        <span class="hljs-keyword">return</span> result

<span class="hljs-comment"># 测试解析类</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    config = Config()
    request = BaseRequest(config)
    parser = Ali1688ListParser(config)
    html = request.get(<span class="hljs-string">"https://s.1688.com/selloffer/offer_search.htm?keywords=手机壳"</span>)
    <span class="hljs-keyword">if</span> html:
        products = parser.parse(html)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"解析到<span class="hljs-subst">{<span class="hljs-built_in">len</span>(products)}</span>个商品："</span>)
        <span class="hljs-built_in">print</span>(products[:<span class="hljs-number">2</span>])
</code></pre>
<h3 data-id="heading-8">5. 存储层封装（BaseStorage 类）</h3>
<p>支持多存储方式（CSV/MySQL/MongoDB），通过子类实现具体存储逻辑。</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> csv
<span class="hljs-keyword">import</span> pymongo
<span class="hljs-keyword">import</span> mysql.connector
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> Config

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseStorage</span>:
    <span class="hljs-string">"""存储基类，定义存储接口"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: Config</span>):
        self.config = config

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">self, data: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""存储接口，子类必须实现"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">"子类需实现save方法"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CsvStorage</span>(<span class="hljs-title class_ inherited__">BaseStorage</span>):
    <span class="hljs-string">"""CSV存储类"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: Config</span>):
        <span class="hljs-built_in">super</span>().__init__(config)
        self.csv_path = self.config.get(<span class="hljs-string">"storage.csv_path"</span>, <span class="hljs-string">"./products.csv"</span>)
        <span class="hljs-comment"># 初始化CSV文件并写入表头</span>
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(self.csv_path, <span class="hljs-string">"w"</span>, newline=<span class="hljs-string">""</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
            writer = csv.DictWriter(f, fieldnames=[<span class="hljs-string">"title"</span>, <span class="hljs-string">"price"</span>, <span class="hljs-string">"link"</span>, <span class="hljs-string">"source"</span>])
            writer.writeheader()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">self, data: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""将数据追加写入CSV"""</span>
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(self.csv_path, <span class="hljs-string">"a"</span>, newline=<span class="hljs-string">""</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
            writer = csv.DictWriter(f, fieldnames=[<span class="hljs-string">"title"</span>, <span class="hljs-string">"price"</span>, <span class="hljs-string">"link"</span>, <span class="hljs-string">"source"</span>])
            writer.writerows(data)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功写入<span class="hljs-subst">{<span class="hljs-built_in">len</span>(data)}</span>条数据到CSV：<span class="hljs-subst">{self.csv_path}</span>"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MongoStorage</span>(<span class="hljs-title class_ inherited__">BaseStorage</span>):
    <span class="hljs-string">"""MongoDB存储类"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: Config</span>):
        <span class="hljs-built_in">super</span>().__init__(config)
        self.client = pymongo.MongoClient(self.config.get(<span class="hljs-string">"storage.mongo.uri"</span>))
        self.db = self.client[self.config.get(<span class="hljs-string">"storage.mongo.db"</span>)]
        self.collection = self.db[self.config.get(<span class="hljs-string">"storage.mongo.collection"</span>)]
        <span class="hljs-comment"># 创建唯一索引，避免重复存储</span>
        self.collection.create_index(<span class="hljs-string">"link"</span>, unique=<span class="hljs-literal">True</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">self, data: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""将数据写入MongoDB，自动去重"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data:
            <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">try</span>:
            self.collection.insert_many(data, ordered=<span class="hljs-literal">False</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功写入<span class="hljs-subst">{<span class="hljs-built_in">len</span>(data)}</span>条数据到MongoDB"</span>)
        <span class="hljs-keyword">except</span> pymongo.errors.BulkWriteError <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># 忽略重复数据错误</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"部分数据重复，实际写入<span class="hljs-subst">{<span class="hljs-built_in">len</span>(data) - <span class="hljs-built_in">len</span>(e.details[<span class="hljs-string">'writeErrors'</span>])}</span>条"</span>)

<span class="hljs-comment"># 测试存储类</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    config = Config()
    storage = CsvStorage(config)
    <span class="hljs-comment"># 模拟数据</span>
    test_data = [
        {<span class="hljs-string">"title"</span>: <span class="hljs-string">"苹果15手机壳"</span>, <span class="hljs-string">"price"</span>: <span class="hljs-string">"10.00"</span>, <span class="hljs-string">"link"</span>: <span class="hljs-string">"https://example.com/1"</span>, <span class="hljs-string">"source"</span>: <span class="hljs-string">"1688"</span>},
        {<span class="hljs-string">"title"</span>: <span class="hljs-string">"华为Mate60手机壳"</span>, <span class="hljs-string">"price"</span>: <span class="hljs-string">"8.50"</span>, <span class="hljs-string">"link"</span>: <span class="hljs-string">"https://example.com/2"</span>, <span class="hljs-string">"source"</span>: <span class="hljs-string">"1688"</span>}
    ]
    storage.save(test_data)
</code></pre>
<h3 data-id="heading-9">6. 调度层封装（SpiderScheduler 类）</h3>
<p>管理爬取任务的生命周期（分页、任务分发），整合请求、解析、存储模块。</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> Config
<span class="hljs-keyword">from</span> request <span class="hljs-keyword">import</span> BaseRequest
<span class="hljs-keyword">from</span> parser <span class="hljs-keyword">import</span> Ali1688ListParser
<span class="hljs-keyword">from</span> storage <span class="hljs-keyword">import</span> BaseStorage, CsvStorage, MongoStorage

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SpiderScheduler</span>:
    <span class="hljs-string">"""爬虫调度器，整合各模块并管理爬取任务"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: Config</span>):
        self.config = config
        self.request = BaseRequest(config)
        self.parser = Ali1688ListParser(config)
        self.storage = self._init_storage()
        self.keyword = self.config.get(<span class="hljs-string">"spider.keyword"</span>)
        self.max_page = self.config.get(<span class="hljs-string">"spider.max_page"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_init_storage</span>(<span class="hljs-params">self</span>) -&gt; BaseStorage:
        <span class="hljs-string">"""根据配置初始化存储类"""</span>
        storage_type = self.config.get(<span class="hljs-string">"storage.type"</span>, <span class="hljs-string">"csv"</span>)
        <span class="hljs-keyword">if</span> storage_type == <span class="hljs-string">"csv"</span>:
            <span class="hljs-keyword">return</span> CsvStorage(self.config)
        <span class="hljs-keyword">elif</span> storage_type == <span class="hljs-string">"mongo"</span>:
            <span class="hljs-keyword">return</span> MongoStorage(self.config)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"不支持的存储类型：<span class="hljs-subst">{storage_type}</span>"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_url</span>(<span class="hljs-params">self, page: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""构建1688搜索页URL"""</span>
        <span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"https://s.1688.com/selloffer/offer_search.htm?keywords=<span class="hljs-subst">{quote(self.keyword)}</span>&amp;page=<span class="hljs-subst">{page}</span>"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""启动爬虫任务"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始爬取1688关键词【<span class="hljs-subst">{self.keyword}</span>】，共<span class="hljs-subst">{self.max_page}</span>页"</span>)
        all_data = []
        <span class="hljs-keyword">for</span> page <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, self.max_page + <span class="hljs-number">1</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"正在爬取第<span class="hljs-subst">{page}</span>页..."</span>)
            url = self.build_url(page)
            html = self.request.get(url)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> html:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{page}</span>页爬取失败，跳过"</span>)
                <span class="hljs-keyword">continue</span>
            <span class="hljs-comment"># 解析数据</span>
            page_data = self.parser.parse(html)
            <span class="hljs-keyword">if</span> page_data:
                all_data.extend(page_data)
                <span class="hljs-comment"># 实时存储</span>
                self.storage.save(page_data)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"爬取完成，总计获取<span class="hljs-subst">{<span class="hljs-built_in">len</span>(all_data)}</span>条商品数据"</span>)

<span class="hljs-comment"># 测试调度器</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    config = Config()
    scheduler = SpiderScheduler(config)
    scheduler.run()
</code></pre>
<h2 data-id="heading-10">三、工程化配套模块</h2>
<h3 data-id="heading-11">1. 日志系统（Logging）</h3>
<p>替换 print 语句，使用 Python 标准库<code>logging</code>实现分级日志（INFO/ERROR），便于问题排查。</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">def</span> <span class="hljs-title function_">init_logger</span>() -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""初始化日志系统"""</span>
    <span class="hljs-comment"># 创建日志目录</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(<span class="hljs-string">"logs"</span>):
        os.makedirs(<span class="hljs-string">"logs"</span>)
    <span class="hljs-comment"># 配置日志格式</span>
    log_format = <span class="hljs-string">"%(asctime)s - %(name)s - %(levelname)s - %(message)s"</span>
    <span class="hljs-comment"># 写入文件 + 控制台输出</span>
    logging.basicConfig(
        level=logging.INFO,
        <span class="hljs-built_in">format</span>=log_format,
        handlers=[
            logging.FileHandler(<span class="hljs-string">"logs/1688_spider.log"</span>, encoding=<span class="hljs-string">"utf-8"</span>),
            logging.StreamHandler()
        ]
    )

<span class="hljs-comment"># 在调度器中使用日志</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    init_logger()
    logger = logging.getLogger(__name__)
    logger.info(<span class="hljs-string">"爬虫启动"</span>)
    <span class="hljs-keyword">try</span>:
        config = Config()
        scheduler = SpiderScheduler(config)
        scheduler.run()
        logger.info(<span class="hljs-string">"爬虫结束"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.error(<span class="hljs-string">f"爬虫异常：<span class="hljs-subst">{e}</span>"</span>, exc_info=<span class="hljs-literal">True</span>)
</code></pre>
<h3 data-id="heading-12">2. 异常处理体系</h3>
<p>在核心模块中定义<strong>自定义异常</strong>，便于精准捕获和处理不同类型的错误：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># exceptions.py</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SpiderRequestError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""请求异常"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SpiderParseError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""解析异常"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SpiderStorageError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""存储异常"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-comment"># 在请求层中抛出自定义异常</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self, url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-keyword">for</span> retry <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.retry_times):
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># ... 原有逻辑 ...</span>
            <span class="hljs-keyword">return</span> resp.text
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">if</span> retry == self.retry_times - <span class="hljs-number">1</span>:
                <span class="hljs-keyword">raise</span> SpiderRequestError(<span class="hljs-string">f"请求<span class="hljs-subst">{url}</span>失败：<span class="hljs-subst">{e}</span>"</span>)
            time.sleep(<span class="hljs-number">2</span> ** retry)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<h3 data-id="heading-13">3. 代理池集成</h3>
<p>对于大规模爬取，可对接第三方代理池（如阿布云、快代理）或自建代理池，通过 API 动态获取可用代理：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_proxy_from_pool</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-string">"""从代理池API获取可用代理"""</span>
    proxy_api = <span class="hljs-string">"http://proxy.example.com/get_proxy"</span>
    <span class="hljs-keyword">try</span>:
        resp = requests.get(proxy_api, timeout=<span class="hljs-number">5</span>)
        <span class="hljs-keyword">return</span> resp.json().get(<span class="hljs-string">"proxy"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"获取代理失败：<span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<h2 data-id="heading-14">四、工程化扩展与最佳实践</h2>
<h3 data-id="heading-15">1. 多线程 / 异步爬取</h3>
<p>针对单线程效率低的问题，可使用<code>concurrent.futures.ThreadPoolExecutor</code>实现多线程，或用<code>aiohttp</code>实现异步爬取（注意 1688 的反爬限制，避免并发过高）。</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor

<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_multi_thread</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""多线程爬取"""</span>
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> executor:  <span class="hljs-comment"># 控制并发数</span>
        executor.<span class="hljs-built_in">map</span>(self.crawl_page, <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, self.max_page + <span class="hljs-number">1</span>))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">crawl_page</span>(<span class="hljs-params">self, page: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""单页爬取逻辑，供线程调用"""</span>
    url = self.build_url(page)
    html = self.request.get(url)
    <span class="hljs-keyword">if</span> html:
        page_data = self.parser.parse(html)
        self.storage.save(page_data)
</code></pre>
<h3 data-id="heading-16">2. 爬虫监控与告警</h3>
<p>通过<code>prometheus</code>+<code>grafana</code>监控爬虫的爬取量、失败率，或通过邮件 / 钉钉机器人在爬虫异常时发送告警：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> smtplib
<span class="hljs-keyword">from</span> email.mime.text <span class="hljs-keyword">import</span> MIMEText

<span class="hljs-keyword">def</span> <span class="hljs-title function_">send_alert_email</span>(<span class="hljs-params">message: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""发送告警邮件"""</span>
    msg = MIMEText(message, <span class="hljs-string">"plain"</span>, <span class="hljs-string">"utf-8"</span>)
    msg[<span class="hljs-string">"Subject"</span>] = <span class="hljs-string">"1688爬虫异常告警"</span>
    msg[<span class="hljs-string">"From"</span>] = <span class="hljs-string">"sender@example.com"</span>
    msg[<span class="hljs-string">"To"</span>] = <span class="hljs-string">"receiver@example.com"</span>

    smtp = smtplib.SMTP_SSL(<span class="hljs-string">"smtp.example.com"</span>, <span class="hljs-number">465</span>)
    smtp.login(<span class="hljs-string">"sender@example.com"</span>, <span class="hljs-string">"password"</span>)
    smtp.sendmail(<span class="hljs-string">"sender@example.com"</span>, [<span class="hljs-string">"receiver@example.com"</span>], msg.as_string())
    smtp.quit()
</code></pre>
<h3 data-id="heading-17">3. 合规与维护</h3>
<ol>
<li><strong>遵守 robots 协议</strong>：1688 的<code>robots.txt</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.1688.com%2Frobots.txt" target="_blank" title="https://www.1688.com/robots.txt" ref="nofollow noopener noreferrer">www.1688.com/robots.txt</a>）明确禁止爬取的路径需严格规避。</li>
<li><strong>定期更新解析规则</strong>：1688 页面结构会频繁变更，需定期检查并调整 CSS 选择器 / XPath。</li>
<li><strong>数据去重与清洗</strong>：通过商品链接、ID 等唯一键去重，对价格、销量等字段做格式清洗（如去除非数字字符）。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>