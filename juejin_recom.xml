<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[我为什么讨厌继承？]]></title>    <link>https://juejin.cn/post/7601384029611425807</link>    <guid>https://juejin.cn/post/7601384029611425807</guid>    <pubDate>2026-02-02T01:26:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601384029611425807" data-draft-id="7597722671084699682" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我为什么讨厌继承？"/> <meta itemprop="keywords" content="Android,Kotlin,设计模式"/> <meta itemprop="datePublished" content="2026-02-02T01:26:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我为什么讨厌继承？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T01:26:08.000Z" title="Mon Feb 02 2026 01:26:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc52bda5809d440d95f07706efade322~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770600367&amp;x-signature=ZyRqsw2fw2gZi2bCF8Q3zCyZp0s%3D" alt="a.png" loading="lazy"/></p>
<p>我在之前的一篇文章<a href="https://juejin.cn/post/7599910677578874880" target="_blank" title="https://juejin.cn/post/7599910677578874880">精通 Rust 宏 — 第一个宏</a>中提到过，我讨厌继承。</p>
<p>第二天中午我同事跑过来问我，这东西现在语言都有，你有什么讨厌的？</p>
<p>我问他，你还记得面向对象的三要素吗？</p>
<p>他说：封装，继承...，然后...，多态！</p>
<p>我上大学学习 Java 的时候，很多相关书籍都会讲解这三要素，以现在的我看来，封装和多态是必要的。</p>
<p>但是继承...</p>
<h2 data-id="heading-0">继承有什么问题</h2>
<p>在我刚参加工作的第三年，我参与到了中国移动和地图 App 的开发工作中，当时我负责改造该 App 的核心网络请求模块。</p>
<p>那个时候还没有流行使用 <strong>OkHttp</strong> ，更没有 <strong>Retrofit</strong> 这种优秀的网络开源库，整体还是使用原始的 <strong>HttpConnection</strong> 去完成网络请求，自己封装里面的实现逻辑。</p>
<p>我当时理解完需求之后，整理了网络库需要满足的功能，大概如下：</p>
<ol>
<li>完成对数据的序列化和反序列化。</li>
<li>完成对数据的加密解密。</li>
<li>返回纯文本的数据结构。</li>
<li>返回 <strong>JSONObject</strong> 的数据结构。</li>
<li>返回基于 Java 对象的数据结构。</li>
</ol>
<p>自然而然，我想到了这种方案，</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9df7fb263a9e461783f7fc1d063d6c53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770600367&amp;x-signature=ztQz%2Bhn6xW3F3SsPMMju1nbSdqQ%3D" alt="0.png" loading="lazy"/></p>
<ol>
<li>首先，<code>BaseHttp</code> 作为基类，负责序列化和反序列化和加解密，因为从目前看来，一个请求一定会有这两个需求。</li>
<li><code>TextHttp</code> 继承 <code>BaseHttp</code>，将其字节码转换成文本。</li>
<li><code>JsonHttp</code> 继承 <code>TextHttp</code>，将文本转换成 <code>JSONObject</code> 结构。</li>
<li>以此类推。。。</li>
</ol>
<p>一开始，这样做非常方便，例如：如果一个请求只需要获取文本内容，那么就直接继承 <code>TextHttp</code>。</p>
<p>也就是说，一个请求需要实现哪些能力，那么就继承那个基类就好了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c539669eb55469188b91007dca066fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770600367&amp;x-signature=v4mDSqZMlKuOBHMc64o12DtnOM0%3D" alt="1.png" loading="lazy"/></p>
<p>而使用这个网络库的人，只需要按照 API 文档中的 API 名称，用这个请求就行了，例如 <code>Sell</code> -&gt; <code>SellHttp</code>，<code>Login</code> -&gt; <code>LoginHttp</code>，用起来会非常方便！</p>
<p>但是后续改动，让我越来越 Hold 不住这种继承链了：有的 API 需要鉴权，有的不需要；部分 API 会有不同的 Header；有的 API 返回结果加密方式和之前的不一样。</p>
<p>慢慢的，我发现我的继承链越来越长，为了让我的 API 使用保持简洁，甚至出现了类似菱形继承的情况（这里不是说 Java 可以菱形继承）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce3846fd44c94469a6115242e3c0464b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770600367&amp;x-signature=uniKjDNCZDHCXM0ScheHQB6xABc%3D" alt="2.png" loading="lazy"/></p>
<p>实际上 <code>SHACryptJsonHttp</code> 包括其基类有大量相似的代码，只是鉴权方式问题，导致我不得不重新改写整个继承链（这里只是一个示例，真实情况比这个复杂的多）。</p>
<p>后面这种问题越来越多，虽然同事们用起来非常方便（对照文档直接 <code>new</code> 即可），但是对我的维护造成了巨大负担，同时也会犯一些非常低级的错误，例如搞错了鉴权方式！</p>
<p>为什么会这样呢？</p>
<h2 data-id="heading-1">一句话总结</h2>
<p>“继承”这个特性，本来想干三件事，结果三件事互相打架，最后搞得谁都不开心。</p>
<p>好的，我来换个思路解释，以 Java 这种语言为例：</p>
<p>比如你写一个 <code>Animal</code> 类，再写一个 <code>Dog</code> 类继承它，这样 <code>Dog</code> 就自动有了 <code>Animal</code> 的所有方法和属性。</p>
<p>听起来很美好，对吧？（当时我就是这么认为的）</p>
<p>但问题来了——<strong>我们其实用“继承”做了三件完全不同的事</strong>，而这三件事根本不是一回事！</p>
<h3 data-id="heading-2">第一件事：分类 —— 这东西属于哪一类</h3>
<p>比如：“正方形是一种矩形”，“狗是一种动物”。</p>
<p>这是从<strong>现实世界逻辑</strong>出发的，叫“本体论”（别被名字吓到，就是“分类”的意思）。</p>
<p>这合理啊，正方形确实是矩形的一种特殊情况。</p>
<h3 data-id="heading-3">第二件事： 能替换吗 —— 程序能不能当同一种东西用</h3>
<p>比如：如果一个函数要求传入一个 <code>Rectangle</code>（矩形），那我能传一个 <code>Square</code>（正方形）进去吗？</p>
<p>如果可以，就叫“可替换”，这是<strong>程序正确性</strong>的问题。</p>
<p>但现实中不行！因为矩形可以改宽高，而正方形一改宽高就不是正方形了。</p>
<p>所以：<strong>虽然“正方形是矩形”在数学上成立，但在代码里不能随便替换！</strong></p>
<blockquote>
<p>这就是著名的 <strong>“正方形-矩形悖论”</strong> —— 看似合理，实则坑人。</p>
</blockquote>
<h3 data-id="heading-4">第三件事：  省代码 —— 别重复写一样的代码</h3>
<p>比如：<code>Dog</code> 和 <code>Cat</code> 都有 <code>eat()</code> 方法，于是让它们都继承 <code>Animal</code>，把 <code>eat()</code> 写在父类里。</p>
<p>这纯粹是为了<strong>偷懒/复用代码</strong>，跟“是不是动物”没关系。</p>
<p>好处：少写代码。</p>
<p>风险：万一以后某个“动物”不吃东西（比如机器人宠物），你就得硬改，或者搞一个新的继承链，破坏设计。</p>
<h2 data-id="heading-5">问题来了</h2>
<p>Java <strong>只给了你一个“继承”关键字</strong>，却让你同时干这三件事。</p>
<p>结果：</p>
<ul>
<li>你以为你在“分类”（正方形是矩形），</li>
<li>但程序要求你“能替换”（正方形必须能当矩形用），</li>
<li>而你实际只是为了“省代码”（不想重复写宽高设置）。</li>
</ul>
<p><strong>三件事混在一起，必然出问题！</strong></p>
<p>就像公司里面的团队，虽然大家都属于同一个组，但是如果目标不一致，这必然导致开发问题！</p>
<h2 data-id="heading-6">那怎么办</h2>
<p>这是我后来，才学到的知识。</p>
<p><strong>别用“继承”干所有事！分开处理：</strong></p>





















<table><thead><tr><th>你想干啥</th><th>正确做法</th></tr></thead><tbody><tr><td><strong>想分类？</strong></td><td>用<strong>领域模型</strong>画图就行，别非塞进代码继承树里。</td></tr><tr><td><strong>想保证能替换？</strong></td><td>用<strong>接口（Interface）</strong> 或 <strong>协议（Protocol）</strong> ，明确约定行为。</td></tr><tr><td><strong>想省代码？</strong></td><td>用<strong>组合（Composition）</strong> + <strong>委托（Delegation）</strong> ，比如让 <code>Dog</code> 里面“包含”一个 <code>Eater</code> 对象，而不是继承 <code>Animal</code>。</td></tr></tbody></table>
<p>还记得那句经典的建议吗：“<strong>优先使用组合，而不是继承。</strong> ”</p>
<p>来，举个例子，假设你要做“交通工具”系统：</p>
<ul>
<li>
<p><strong>错误做法（用继承干三件事）</strong>：</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Vehicle</span> { <span class="hljs-keyword">void</span> <span class="hljs-title function_">move</span><span class="hljs-params">()</span> {} }
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Vehicle</span> { }      <span class="hljs-comment">// 是Vehicle，能替换，还复用了move()</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Airplane</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Vehicle</span> { } <span class="hljs-comment">// 同上</span>
</code></pre>
<p>→ 这就是我早期开发 Http 框架时候的做法。问题来了，如果以后加个 <code>Hovercraft</code>（气垫船），它既能走陆地又能走水，继承哪个？</p>
</li>
<li>
<p><strong>正确做法（分开处理）：</strong></p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Drivable</span> { <span class="hljs-keyword">void</span> <span class="hljs-title function_">drive</span><span class="hljs-params">()</span>; }
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Flyable</span> { <span class="hljs-keyword">void</span> <span class="hljs-title function_">fly</span><span class="hljs-params">()</span>; }

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Drivable</span> { ... }
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Airplane</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Flyable</span> { ... }
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Hovercraft</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Drivable</span>, Floatable { ... } <span class="hljs-comment">// 多实现，灵活！</span>
</code></pre>
<p>→ 分类归分类（你是车还是飞机），行为归行为（你会开还是会飞），代码复用靠组合</p>
<p><em>Java 实现委派会有些麻烦，如果是 Kotlin，就方便多了！</em></p>
</li>
</ul>
<h2 data-id="heading-7">总结</h2>
<p>“继承”就像一把瑞士军刀，本来想切菜、开瓶、剪线都行，结果发现：<strong>切菜时刀片会弹出来割手，开瓶时螺丝刀又碍事。</strong></p>
<p>所以聪明人怎么做？</p>
<p><strong>切菜用菜刀，开瓶用开瓶器，剪线用剪刀。各干各的，互不干扰。</strong></p>
<p>编程也一样：</p>
<p><strong>别指望“继承”解决所有问题，该用接口用接口，该用组合用组合。</strong></p>
<p>这样，代码才清爽，bug 才少，而你，我的朋友，才睡得着觉！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue-性能优化利器：Keep-Alive]]></title>    <link>https://juejin.cn/post/7601486204174581810</link>    <guid>https://juejin.cn/post/7601486204174581810</guid>    <pubDate>2026-02-02T01:35:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601486204174581810" data-draft-id="7601441797118853171" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue-性能优化利器：Keep-Alive"/> <meta itemprop="keywords" content="前端,面试,Vue.js"/> <meta itemprop="datePublished" content="2026-02-02T01:35:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue-性能优化利器：Keep-Alive
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T01:35:22.000Z" title="Mon Feb 02 2026 01:35:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在后台管理系统或长列表页面中，我们经常遇到这样的需求：从列表进入详情页，返回时希望列表滚动位置、搜索条件都能完美保留。Vue 内置的 <code>&lt;KeepAlive&gt;</code> 正是为此而生。本文将带你从基础用法出发，直击其背后的缓存算法原理。</p>
<hr/>
<h2 data-id="heading-1">一、 什么是 Keep-Alive？</h2>
<p><code>&lt;KeepAlive&gt;</code> 是一个内置组件，用于<strong>缓存不活动的组件实例</strong>，而不是销毁它们。</p>
<ul>
<li><strong>核心价值</strong>：保留组件状态、避免重复渲染 DOM、提升用户体验。</li>
<li><strong>应用场景</strong>：表单多步骤切换、列表页返回流、详情页页签切换。</li>
</ul>
<hr/>
<h2 data-id="heading-2">二、 基础实战：结合 Vue Router 实现按需缓存</h2>
<p>在 Vue 中，我们通常结合路由的 <code>meta</code> 字段和 <code>&lt;router-view&gt;</code> 的插槽语法来实现。</p>
<h3 data-id="heading-3">1. 路由配置</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/router/index.ts</span>
<span class="hljs-keyword">import</span> { createRouter, createWebHistory, <span class="hljs-title class_">RouteRecordRaw</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">routes</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">RouteRecordRaw</span>&gt; = [
    {
      <span class="hljs-attr">path</span>: <span class="hljs-string">'/your-path'</span>,
      <span class="hljs-attr">name</span>: <span class="hljs-string">'YourComponentName'</span>,
      <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/YourComponent.vue'</span>),
      <span class="hljs-attr">meta</span>: {
        <span class="hljs-attr">keepAlive</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 设置需要缓存</span>
      }
    }
];
</code></pre>
<h3 data-id="heading-4">2. 宿主容器配置</h3>
<p>在 <code>App.vue</code> 或主布局文件中，接着在对应<code>&lt;router-view&gt;</code>的中插入<code>&lt;keep-alive&gt;</code>，并设置<code>include</code>属性来匹配需要缓存的组件</p>
<p>代码段</p>
<pre><code class="hljs language-vue" lang="vue">  // includeComponents为对应的组件文件名称
  &lt;router-view v-slot="{ Component }"&gt;
    &lt;KeepAlive :include="includeComponents"&gt;
      &lt;component :is="Component" /&gt;
    &lt;/KeepAlive&gt;
  &lt;/router-view&gt;
</code></pre>
<hr/>
<h2 data-id="heading-5">三、 特有的生命周期钩子</h2>
<p>一旦组件被缓存，其正常的销毁流程将被“冻结”，取而代之的是两个专属钩子：</p>
<ul>
<li><strong><code>activated</code></strong>：组件<strong>被激活</strong>（初始化渲染或从缓存中恢复）时调用。此时可重新获取数据或重置滚动位置。</li>
<li><strong><code>deactivated</code></strong>：组件<strong>被停用</strong>（离开当前路由）时调用。此时可清理定时器或取消未完成的请求。</li>
</ul>
<blockquote>
<p><strong>⚠️ 注意</strong>：由于组件被缓存，<code>onBeforeUnmount</code> 和 <code>onUnmounted</code>（Vue 2 中的 <code>beforeDestroy</code> 和 <code>destroyed</code>）<strong>不会</strong>被触发。</p>
</blockquote>
<hr/>
<h2 data-id="heading-6">四、 深度进阶：Keep-Alive 的底层原理</h2>
<p><code>&lt;KeepAlive&gt;</code> 本质上是一个“无渲染组件”，它不渲染多余的 DOM，而是直接操作组件的 VNode。</p>
<h3 data-id="heading-7">1. 内存中的 Map 缓存</h3>
<p><code>Keep-Alive</code> 内部维护了一个 <code>cache</code> 对象（Map 结构）和一个 <code>keys</code> 队列（Array 结构）：</p>
<ul>
<li><strong>Cache</strong>：键是组件的 <code>key</code>，值是组件的 <code>vnode</code> 实例。</li>
<li><strong>Keys</strong>：记录缓存组件的顺序。</li>
</ul>
<h3 data-id="heading-8">2. 渲染函数逻辑</h3>
<p>当 <code>render</code> 函数执行时：</p>
<ol>
<li>获取内部包裹的组件节点。</li>
<li>查找 <code>cache</code> 中是否存在该组件的实例。</li>
<li><strong>存在</strong>：直接从缓存中获取实例，并更新该 key 在 <code>keys</code> 队列中的位置（移到最后）。</li>
<li><strong>不存在</strong>：将其加入缓存。</li>
</ol>
<h3 data-id="heading-9">3. LRU 缓存策略</h3>
<p>如果缓存的组件过多，内存会爆炸吗？不会。 Vue 使用了 <strong>LRU (Least Recently Used) 最近最少使用</strong> 算法。当缓存数量超过 <code>max</code> 属性设定的阈值时，Vue 会自动销毁 <code>keys</code> 队列中最久没被访问过的那个组件实例。</p>
<hr/>
<h2 data-id="heading-10">五、 总结</h2>
<ol>
<li><strong>组件名称 (name)</strong> ：<code>include</code> 匹配的是组件定义的 <code>name</code> 选项。在 Vue 3 <code>&lt;script setup&gt;</code> 中，如果你没有显式定义 <code>name</code>，Vue 会根据文件名自动生成，建议显式定义以防匹配失效。</li>
<li><strong>多级嵌套路由</strong>：如果你的 <code>&lt;router-view&gt;</code> 层级很深，每一层都需要配置 <code>&lt;KeepAlive&gt;</code> 才能保证整条路径上的状态都被保留。</li>
<li><strong>Key 的重要性</strong>：在 <code>&lt;component :is&gt;</code> 上绑定正确的 <code>:key</code>，能有效防止在切换相同组件不同参数（如 <code>/detail/1</code> 到 <code>/detail/2</code>）时出现缓存混乱。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java锁性能优化：从0到100的实战指南，90%的人都踩过这些坑]]></title>    <link>https://juejin.cn/post/7601076976443015208</link>    <guid>https://juejin.cn/post/7601076976443015208</guid>    <pubDate>2026-02-01T10:33:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601076976443015208" data-draft-id="7601076976442998824" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java锁性能优化：从0到100的实战指南，90%的人都踩过这些坑"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-02-01T10:33:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我爱娃哈哈"/> <meta itemprop="url" content="https://juejin.cn/user/1398234522335383"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java锁性能优化：从0到100的实战指南，90%的人都踩过这些坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1398234522335383/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我爱娃哈哈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T10:33:56.000Z" title="Sun Feb 01 2026 10:33:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">一、别再用synchronized了？聊聊锁性能的那些事儿</h4>
<p>大家好，今天咱们来聊个所有后端开发都绕不开的话题——同步锁性能优化。</p>
<p>上周优化了一个项目，把并发量从500QPS提升到了5000QPS，核心就改了几个锁的使用方式。这让我想起刚工作时，只会用synchronized加在方法上，结果导致系统卡顿的场景。</p>
<p>锁就像高速公路的收费站，用对了能让交通有序，用错了就会变成堵车的元凶。今天我就把这些年踩过的坑、总结的经验全分享给你们，看完这篇文章，你的锁性能至少能提升3倍！</p>
<h4 data-id="heading-1">二、锁的基础知识：从理论到实践</h4>
<p><strong>1. 锁的本质是什么？</strong>
锁的本质是解决并发环境下的数据一致性问题。就像公共厕所，加锁就是确保同一时间只有一个人能使用。</p>
<p><strong>2. Java里有哪些锁？</strong></p>
<ul>
<li>内置锁：synchronized</li>
<li>显式锁：ReentrantLock、ReadWriteLock</li>
<li>原子类：AtomicInteger等（无锁实现）</li>
<li>分布式锁：Redis锁、ZooKeeper锁</li>
</ul>
<p><strong>3. 锁的性能指标</strong></p>
<ul>
<li>锁的粒度：锁的范围越大，性能越差</li>
<li>锁的竞争：竞争越激烈，性能越差</li>
<li>锁的升级：从偏向锁→轻量级锁→重量级锁，性能逐渐下降</li>
</ul>
<h4 data-id="heading-2">三、实战优化：从synchronized到ReentrantLock</h4>
<p><strong>1. 案例：一个简单的计数器</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 原始代码：方法级synchronized</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
    count++;
}
</code></pre>
<p>这段代码的问题在于锁的粒度太大，整个方法都被锁住了。</p>
<p><strong>2. 优化第一步：减小锁粒度</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 优化后：只锁关键代码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>) {
        count++;
    }
}
</code></pre>
<p>但这还不够，我们可以用更高效的锁。</p>
<p><strong>3. 优化第二步：使用ReentrantLock</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
    lock.lock();
    <span class="hljs-keyword">try</span> {
        count++;
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();
    }
}
</code></pre>
<p>ReentrantLock比synchronized更灵活，支持尝试获取锁、超时机制等。</p>
<p><strong>4. 优化第三步：使用原子类（无锁方案）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
    count.incrementAndGet();
}
</code></pre>
<p>对于简单计数器，原子类性能远高于锁，因为它基于CAS操作，无需加锁。</p>
<h4 data-id="heading-3">四、高级技巧：ReadWriteLock和StampedLock</h4>
<p><strong>1. 读写分离：ReadWriteLock</strong>
如果你的场景是读多写少，ReadWriteLock能显著提升性能：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>();
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">readLock</span> <span class="hljs-operator">=</span> rwLock.readLock();
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">writeLock</span> <span class="hljs-operator">=</span> rwLock.writeLock();

<span class="hljs-comment">// 读操作</span>
<span class="hljs-keyword">public</span> Data <span class="hljs-title function_">readData</span><span class="hljs-params">()</span> {
    readLock.lock();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> data;
    } <span class="hljs-keyword">finally</span> {
        readLock.unlock();
    }
}

<span class="hljs-comment">// 写操作</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeData</span><span class="hljs-params">(Data newData)</span> {
    writeLock.lock();
    <span class="hljs-keyword">try</span> {
        data = newData;
    } <span class="hljs-keyword">finally</span> {
        writeLock.unlock();
    }
}
</code></pre>
<p><strong>2. 乐观读写：StampedLock</strong>
Java 8引入的StampedLock提供了乐观读模式，性能比ReadWriteLock更高：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StampedLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StampedLock</span>();

<span class="hljs-comment">// 乐观读</span>
<span class="hljs-keyword">public</span> Data <span class="hljs-title function_">readDataOptimistic</span><span class="hljs-params">()</span> {
    <span class="hljs-type">long</span> <span class="hljs-variable">stamp</span> <span class="hljs-operator">=</span> lock.tryOptimisticRead();
    <span class="hljs-type">Data</span> <span class="hljs-variable">currentData</span> <span class="hljs-operator">=</span> data;
    <span class="hljs-comment">// 验证是否有写操作发生</span>
    <span class="hljs-keyword">if</span> (!lock.validate(stamp)) {
        <span class="hljs-comment">// 升级为悲观读</span>
        stamp = lock.readLock();
        <span class="hljs-keyword">try</span> {
            currentData = data;
        } <span class="hljs-keyword">finally</span> {
            lock.unlockRead(stamp);
        }
    }
    <span class="hljs-keyword">return</span> currentData;
}
</code></pre>
<h4 data-id="heading-4">五、锁性能优化的10个最佳实践</h4>
<ol>
<li><strong>尽量使用无锁方案</strong>：对于简单计数器、累加操作，优先使用Atomic类</li>
<li><strong>减小锁粒度</strong>：只锁必要的代码块，而不是整个方法</li>
<li><strong>避免锁嵌套</strong>：锁嵌套容易导致死锁，且会增加锁竞争</li>
<li><strong>使用读写锁</strong>：读多写少场景用ReadWriteLock，进一步优化用StampedLock</li>
<li><strong>锁分离</strong>：不同业务逻辑用不同的锁，避免竞争</li>
<li><strong>避免在锁内执行耗时操作</strong>：如网络请求、IO操作等</li>
<li><strong>使用concurrent包</strong>：ConcurrentHashMap、CopyOnWriteArrayList等线程安全集合性能更好</li>
<li><strong>锁的公平性</strong>：非必要不使用公平锁，公平锁性能比非公平锁差</li>
<li><strong>考虑使用分段锁</strong>：如ConcurrentHashMap的实现方式</li>
<li><strong>监控锁竞争</strong>：使用JDK自带的jstack、jconsole等工具监控锁竞争情况</li>
</ol>
<h4 data-id="heading-5">六、踩过的坑：锁优化的反面教材</h4>
<p><strong>1. 过度优化</strong>
曾经为了优化一个简单的计数器，使用了复杂的锁策略，结果代码可读性下降，性能提升却不明显。后来发现直接用AtomicInteger就够了。</p>
<p><strong>2. 忽略锁的可重入性</strong>
在递归方法中使用不可重入锁，导致死锁。记住：synchronized和ReentrantLock都是可重入的。</p>
<p><strong>3. 锁的错误使用</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误：每次方法调用创建新锁</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
    lock.lock();
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>锁对象应该是全局的，而不是方法内部创建的。</p>
<h4 data-id="heading-6">七、写在最后</h4>
<p>锁性能优化是一个需要不断实践和总结的过程。没有银弹，只有最适合特定场景的方案。</p>
<p>记住：不要为了优化而优化，先测量，后优化。使用JMH（Java Microbenchmark Harness）等工具进行性能测试，确保你的优化真的有效。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[被 Redis 抛弃的 Windows，终于等来了自己的缓存方案]]></title>    <link>https://juejin.cn/post/7601444617695068170</link>    <guid>https://juejin.cn/post/7601444617695068170</guid>    <pubDate>2026-02-01T11:47:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601444617695068170" data-draft-id="7601441475987488814" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="被 Redis 抛弃的 Windows，终于等来了自己的缓存方案"/> <meta itemprop="keywords" content="后端,面试,Redis"/> <meta itemprop="datePublished" content="2026-02-01T11:47:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="软件求生"/> <meta itemprop="url" content="https://juejin.cn/user/1038379932466263"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            被 Redis 抛弃的 Windows，终于等来了自己的缓存方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1038379932466263/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    软件求生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T11:47:55.000Z" title="Sun Feb 01 2026 11:47:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>那天凌晨一点半，我正坐在工位上，手里捧着一杯已经凉透的咖啡，盯着监控大屏。Redis 延迟曲线很稳，QPS 也很健康，一切都很美好。唯一不美好的，是我们隔壁工位老王的脸色。</p>
<p>老王负责的是一个<strong>全 Windows Server 环境</strong>的项目，原因也很简单：<strong>历史包袱 + 商业软件依赖 + 客户指定操作系统</strong>。</p>
<p>于是问题来了：“小米啊，Redis 在 Windows 上真的就只能靠第三方移植吗？就没有一个原生、正经、官方支持 Windows 的缓存方案吗？”</p>
<p>我当时的第一反应你肯定也猜到了： <strong>“兄弟，Redis 官方都不支持 Windows，你就别折腾了，老老实实上 Linux 吧。”</strong></p>
<p>老王沉默了三秒，然后幽幽地说了一句：“微软不是也做数据库、做缓存吗？”</p>
<p>我当场一愣。那天晚上，我第一次点进了一个 GitHub 项目<strong>Project Garnet</strong>。</p>
<h2 data-id="heading-0">Redis 就像一辆手动挡跑车，而 Windows 一直想要“自动挡”</h2>
<p>在进入 Garnet 之前，我们先把背景捋清楚。<strong>Redis 为啥一直不待见 Windows？</strong></p>
<p>你一定听过这些经典答案：</p>
<ul>
<li>Redis 是<strong>单线程事件循环</strong></li>
<li>深度依赖 epoll / fork / mmap</li>
<li>Linux 是 Redis 的“主场”</li>
</ul>
<p>用一句话总结就是：<strong>Redis 是为 Linux 长出来的，不是移植过来的。</strong></p>
<p>这就好比：</p>
<ul>
<li>Redis 是一辆 <strong>手动挡 + 后驱 + 高转速跑车</strong></li>
<li>Linux 是一条 <strong>封闭赛道</strong></li>
<li>而 Windows 更像一条 <strong>城市高架 + 自动挡需求</strong></li>
</ul>
<p>你硬要把跑车丢进早晚高峰的高架路，能跑，但并不优雅。</p>
<h2 data-id="heading-1">Garnet 是谁？它想干什么？</h2>
<p>好，现在主角登场。<strong>Garnet = 微软出品的高性能内存 KV 存储引擎</strong></p>
<p>它的定位非常清晰：<strong>在 Windows / .NET 生态下，提供一个 Redis 风格、高性能、现代化的缓存解决方案</strong></p>
<p>它不是 Redis 的简单复刻，而是：</p>
<ul>
<li><strong>协议兼容 Redis</strong></li>
<li><strong>架构重新设计</strong></li>
<li><strong>深度拥抱 Windows + .NET</strong></li>
</ul>
<p>如果 Redis 是一位“Linux 原教旨主义者”，那 Garnet 更像是：<strong>穿着西装、会讲 C#、精通 Windows 内核的工程师。</strong></p>
<h2 data-id="heading-2">打个比方：Redis 和 Garnet 像什么？</h2>
<p>我最喜欢用生活里的东西解释技术。</p>
<p><strong>1、Redis 像什么？</strong></p>
<p><strong>一家祖传手擀面馆</strong></p>
<ul>
<li>配方经典</li>
<li>手艺精湛</li>
<li>在 Linux 这条老街上无人能敌</li>
<li>但你要它进商场、进写字楼、适配新系统，就有点别扭</li>
</ul>
<p><strong>2、Garnet 像什么？</strong></p>
<p><strong>一家连锁精品咖啡品牌</strong></p>
<ul>
<li>标准化</li>
<li>工业级</li>
<li>天生适配写字楼（Windows）</li>
<li>能直接接入现代化系统（.NET、Azure）</li>
</ul>
<h2 data-id="heading-3">Garnet 的核心设计思路</h2>
<p>下面这段是重点，稍微“技术味”会浓一点。Garnet 的几个关键特性：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e77f148ce30046b4b68d54afeff37fde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770551275&amp;x-signature=rgqm%2BCWKII%2FS9Ovvg20Bjer5LiI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>一句话总结：<strong>Garnet 更像一个“缓存引擎平台”，而不只是一个缓存服务。</strong></p>
<h2 data-id="heading-4">它是怎么做到“快”的？</h2>
<p>如果你对 Redis 熟悉，那你一定知道它的快来自：</p>
<ul>
<li>内存</li>
<li>单线程</li>
<li>简单数据结构</li>
</ul>
<p>而 Garnet 的快，思路有点不一样。</p>
<p>Garnet 的性能策略：</p>
<ul>
<li><strong>多线程 + async IO</strong></li>
<li><strong>Log-Structured 存储设计</strong></li>
<li><strong>CPU cache-friendly 数据布局</strong></li>
<li><strong>现代 NUMA / 多核优化</strong></li>
</ul>
<p>你可以把它理解成：Redis 是“一个人把活干到极致”，Garnet 是“一群人配合把活干到极致”</p>
<h2 data-id="heading-5">直接上代码：5 分钟跑一个 Garnet</h2>
<p>说再多，不如跑一跑。</p>
<p><strong>1、启动 Garnet 服务</strong></p>
<p>如果你在 Windows 上，可以直接：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67c4aa0e6df244ffa6e36466c9dc3bc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770551275&amp;x-signature=ZigNFoiP5O9uhVQjzKCYriSGO10%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>启动后，你会看到类似输出：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/866526461eed4d8fb800994c2e185195~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770551275&amp;x-signature=WYF01k59WNSQNSeMitRawUtyvWI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>没错，<strong>端口都是 Redis 默认端口</strong>。</p>
<p><strong>2、使用 redis-cli 连接</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88332fc041c14ea6a756796c022d656f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770551275&amp;x-signature=NpU4yP04fcQmi886t9ssEnTnPFo%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>然后试试熟悉的命令：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/506a31c1e3154537a872c12e906923b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770551275&amp;x-signature=Vx0C6R%2Bq0MJ3xxgrJ3T46d7iBbo%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>输出：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fe139ce4a6e498b8667229947835ace~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770551275&amp;x-signature=wfPx89C7Ety8%2Btu4AQAqPY%2B4gqk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>老王当场瞪大了眼睛：“这……不就是 Redis 吗？”</p>
<h2 data-id="heading-6">在 .NET 里嵌入 Garnet（重点玩法）</h2>
<p>这是 Garnet 最有意思的地方。Redis 是一个“外部服务”，Garnet 可以是一个“库”。</p>
<p><strong>示例：在 .NET 应用中嵌入</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dda39198f4b4323bf3be5e6ddb349b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770551275&amp;x-signature=K0gvb6E5zJxpPWPWGTPL8O7oB6I%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>你可以把它理解成：<strong>缓存，不再是“隔壁机房的一个服务”，而是你应用里的一个组件。</strong></p>
<h2 data-id="heading-7">Redis vs Garnet，放在一张表里看</h2>
<p>这是大家最关心的部分。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4f7fab96b8843139b6a23e79e97d078~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770551275&amp;x-signature=b1SW7%2FHeDtgapuTGbbuUaHdtjZs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>结论一句话：</strong> Redis 是“成熟老将”，Garnet 是“潜力新秀”。</p>
<h2 data-id="heading-8">那 Garnet 能不能“替代 Redis”？</h2>
<p>我很负责任地说一句：<strong>不是现在，不是全部，但在某些场景，非常合适。</strong></p>
<p><strong>1、适合 Garnet 的场景</strong></p>
<ul>
<li>Windows Server 环境</li>
<li>.NET 技术栈</li>
<li>不想引入 Linux 运维成本</li>
<li>对 Redis 高级特性依赖不深</li>
<li>更看重可嵌入、可控性</li>
</ul>
<p><strong>2、不适合的场景</strong></p>
<ul>
<li>重度 Redis Module</li>
<li>Lua 脚本依赖</li>
<li>Redis Cluster 深度使用</li>
<li>超大规模成熟生产集群</li>
</ul>
<h2 data-id="heading-9">总结：缓存世界正在变得更“多元”</h2>
<p>那天凌晨，老王最后拍了拍我的肩膀：“至少，我终于不是那个‘非要上 Linux’的人了。”</p>
<p>我突然意识到一件事：<strong>Redis 不是缓存的全部，只是缓存世界里最亮的那颗星。</strong></p>
<p>而 Garnet 的出现，至少说明了一点：<strong>Windows 阵营，也终于有了一个“认真对待缓存”的答案。</strong></p>
<h2 data-id="heading-10">END</h2>
<p>如果你正在：</p>
<ul>
<li>被 Windows 环境限制</li>
<li>被 Redis 官方不支持折磨</li>
<li>或者只是单纯想看看新东西</li>
</ul>
<p>那我真心建议你：<strong>试试 Garnet，哪怕只是跑一跑。</strong></p>
<p>如果你觉得这篇文章对你有一点点帮助，欢迎 <strong>点赞、在看、转发</strong>，我们下次继续聊点有意思的技术。</p>
<p>我是小米，一个喜欢分享技术的31岁程序员。如果你喜欢我的文章，欢迎关注我的微信公众号“<strong>软件求生</strong>”，获取更多技术干货！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL 唯一索引并发插入死锁问题排查与优化方案记录]]></title>    <link>https://juejin.cn/post/7601159804491137043</link>    <guid>https://juejin.cn/post/7601159804491137043</guid>    <pubDate>2026-02-01T11:50:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601159804491137043" data-draft-id="7601073900526207018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL 唯一索引并发插入死锁问题排查与优化方案记录"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2026-02-01T11:50:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏黎世的海角"/> <meta itemprop="url" content="https://juejin.cn/user/1425426861536445"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL 唯一索引并发插入死锁问题排查与优化方案记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1425426861536445/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏黎世的海角
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T11:50:42.000Z" title="Sun Feb 01 2026 11:50:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、问题现象</h2>
<p>最近几周观测线上服务的业务告警监控群，报出了几次 <strong>MySQL Deadlock 错误（Error 1213）</strong> ，由于应用服务日志获取不到mysql相关的日志，联系DBA同学获取到了死锁的相关日志，具体如下：</p>
<pre><code class="hljs language-sql" lang="sql">LATEST DETECTED DEADLOCK
...
<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span> (<span class="hljs-number">1</span>) TRANSACTION:
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> tb_xxx (...) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'mp_data'</span>, <span class="hljs-string">'app_trip_...'</span>, <span class="hljs-string">'answer_cnt'</span>)
...
<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span> (<span class="hljs-number">2</span>) TRANSACTION:
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> tb_xxx (...) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'mp_data_dev'</span>, <span class="hljs-string">'app_trip_...'</span>, <span class="hljs-string">'answer_cnt'</span>)
...
<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span> WE ROLL BACK TRANSACTION (<span class="hljs-number">2</span>)
</code></pre>
<p>原因是两个几乎同时执行的 <code>INSERT</code> 语句产生死锁导致其中一个事务被回滚，影响业务写入成功率。</p>
<hr/>
<h2 data-id="heading-1">二、表结构分析</h2>
<p>涉及表：<code>tb_xxx</code></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">CREATE</span> <span class="hljs-selector-tag">TABLE</span> `<span class="hljs-selector-tag">tb_xxx</span>` (
  <span class="hljs-built_in">`id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">20</span>) unsigned <span class="hljs-keyword">NOT</span> NULL AUTO_INCREMENT,
  ...
  <span class="hljs-built_in">`engine_type`</span> <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">'1'</span>,
  <span class="hljs-built_in">`db_name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span>,
  <span class="hljs-built_in">`table_name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span>,
  <span class="hljs-built_in">`column_name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span>,
  PRIMARY KEY (<span class="hljs-built_in">`id`</span>),
  UNIQUE KEY <span class="hljs-built_in">`uniq_tab_col`</span> (<span class="hljs-built_in">`engine_type`</span>,<span class="hljs-built_in">`db_name`</span>,<span class="hljs-built_in">`table_name`</span>,<span class="hljs-built_in">`column_name`</span>)
) <span class="hljs-selector-tag">ENGINE</span>=<span class="hljs-selector-tag">InnoDB</span>;
</code></pre>
<p>关键点：</p>
<ul>
<li>存在一个 <strong>四字段联合唯一索引 <code>uniq_tab_col</code></strong></li>
<li>隔离级别为 MySQL 默认的 <strong>REPEATABLE READ（RR）</strong></li>
</ul>
<hr/>
<h2 data-id="heading-2">三、死锁原因分析</h2>
<h3 data-id="heading-3">1. 死锁本质</h3>
<p>在 <strong>RR 隔离级别</strong>下，InnoDB 为保证唯一性约束和防止幻读，会在插入前对目标索引位置加 <strong>间隙锁（Gap Lock）</strong> 和 <strong>插入意向锁（Insert Intention Lock）</strong> 。</p>
<h3 data-id="heading-4">2. 具体场景</h3>
<ul>
<li>
<p>两个事务并发插入 <strong>在唯一索引排序上相邻的记录</strong>，例如：</p>
<ul>
<li>T1: <code>(1, 'mp_data', ..., 'answer_cnt')</code></li>
<li>T2: <code>(1, 'mp_data_dev', ..., 'answer_cnt')</code></li>
</ul>
</li>
<li>
<p>虽然字段 <code>db_name</code> 的内容不同，但因字符串排序相邻（<code>'mp_data' &lt; 'mp_data_dev'</code>），<strong>落在同一索引间隙（gap）内</strong></p>
</li>
<li>
<p>两个事务互相持有对方所需的间隙锁，形成 <strong>循环等待 → 死锁</strong></p>
</li>
</ul>
<blockquote>
<p>✅ 典型的 “并发插入相邻唯一索引值” 导致的死锁，属于 InnoDB 在 RR 模式下的正常行为，但需应用层规避。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">四、解决方案</h2>
<h3 data-id="heading-6">✅ 主方案：改用幂等插入语句</h3>
<p>将原始 <code>INSERT</code> 改为以下任一形式，<strong>从根本上避免死锁 + 实现幂等</strong>：</p>
<h3 data-id="heading-7">方式一：<code>INSERT IGNORE</code></h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> IGNORE <span class="hljs-keyword">INTO</span> tb_xxx
(engine_type, db_name, table_name, column_name)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'mp_data'</span>, <span class="hljs-string">'xxx'</span>, <span class="hljs-string">'yyy'</span>);
</code></pre>
<ul>
<li>若唯一键冲突，静默跳过，不报错</li>
<li>适用于“存在则忽略，不存在则创建”场景</li>
</ul>
<h3 data-id="heading-8">方式二：<code>INSERT ... ON DUPLICATE KEY UPDATE</code></h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> tb_xxx
(engine_type, db_name, table_name, column_name)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'mp_data'</span>, <span class="hljs-string">'xxx'</span>, <span class="hljs-string">'yyy'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span>
gmt_modified <span class="hljs-operator">=</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>;
</code></pre>
<ul>
<li>冲突时可选择更新（如刷新修改时间）</li>
<li>更灵活，推荐用于需记录“最后关联时间”的场景</li>
</ul>
<blockquote>
<p>💡 两种方式均可显著减少间隙锁竞争，InnoDB 内部优化使其几乎不会在此类操作中产生死锁。</p>
</blockquote>
<h3 data-id="heading-9">✅ 辅助方案：应用层死锁重试机制</h3>
<p>即使优化 SQL，高并发下仍可能偶发其他类型死锁，建议统一增加重试逻辑：</p>
<pre><code class="hljs language-ini" lang="ini">for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 3; i++) {</span>
    try {
        mapper.insertIgnore(record)<span class="hljs-comment">;</span>
        break<span class="hljs-comment">;</span>
    } catch (DeadlockLoserDataAccessException e) { // Spring 封装
        if (<span class="hljs-attr">i</span> == <span class="hljs-number">2</span>) throw e<span class="hljs-comment">;</span>
        Thread.sleep(10 * (i + 1))<span class="hljs-comment">; // 指数退避</span>
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-10">五、为什么不推荐其他方案？</h2>





















<table><thead><tr><th align="left">方案</th><th align="left">问题</th></tr></thead><tbody><tr><td align="left">降低隔离级别至 <code>READ COMMITTED</code></td><td align="left">可能引入幻读，破坏业务一致性，不适用于当前指标系统</td></tr><tr><td align="left">删除唯一索引</td><td align="left">违背数据模型设计，会导致重复关联，不可接受</td></tr><tr><td align="left">应用层先查后插</td><td align="left">增加 RT，且仍存在竞态条件，无法根治死锁</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-11">六、后续改进</h2>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 将所有对 <code>tb_xxx</code> 的插入操作统一改为 <code>INSERT ... ON DUPLICATE KEY UPDATE</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 在 DAO 层封装幂等写入方法，避免各处重复处理</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 监控 Deadlock是否仍然存在，验证优化效果</li>
</ul>
<hr/>
<h2 data-id="heading-12">七、参考</h2>
<ul>
<li>MySQL 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.0%2Fen%2Finnodb-locking.html" target="_blank" title="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html" ref="nofollow noopener noreferrer">InnoDB Locking</a></li>
<li>《高性能 MySQL》第 8 章：事务与锁</li>
<li>MySQL <code>SHOW ENGINE INNODB STATUS</code> 死锁日志解读</li>
</ul>
<hr/>
<blockquote>
<p>总结：本次死锁由唯一索引并发插入引发，通过改用幂等插入语句（INSERT IGNORE / ON DUPLICATE KEY UPDATE）可规避，同时提升系统健壮性与写入成功率。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rc<T>：引用计数与共享所有权]]></title>    <link>https://juejin.cn/post/7601441475987570734</link>    <guid>https://juejin.cn/post/7601441475987570734</guid>    <pubDate>2026-02-01T12:04:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601441475987570734" data-draft-id="7601444617695150090" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rc&lt;T&gt;：引用计数与共享所有权"/> <meta itemprop="keywords" content="Rust,后端"/> <meta itemprop="datePublished" content="2026-02-01T12:04:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="楠风小宇宙"/> <meta itemprop="url" content="https://juejin.cn/user/4037062427148462"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rc&lt;T&gt;：引用计数与共享所有权
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4037062427148462/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    楠风小宇宙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T12:04:52.000Z" title="Sun Feb 01 2026 12:04:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Rust 的严苛所有权法则下，一个值通常只有一个所有者。然而，现实开发中（如图形结构、多路搜索树或 UI 框架）经常需要<strong>共享所有权</strong>。<code>Rc&lt;T&gt;</code>（Reference Counted）正是为此而生。</p>
<h2 data-id="heading-0">1. 什么是 Rc？</h2>
<p><code>Rc&lt;T&gt;</code> 是一个只读的、具有引用计数的智能指针。它允许你在堆上分配内存，并让多个变量共同拥有这块内存的所有权。只有当最后一个所有者销毁时，堆上的内存才会被释放。</p>
<blockquote>
<p><strong>核心原则</strong>：<code>Rc&lt;T&gt;</code> 仅适用于<strong>单线程</strong>场景。如果需要跨线程共享，请使用 <code>Arc&lt;T&gt;</code>。</p>
</blockquote>
<h2 data-id="heading-1">2. 内存布局剖析</h2>
<p>当你创建一个 <code>Rc::new(data)</code> 时，Rust 会在堆上分配一个特殊的结构体 <code>RcBox&lt;T&gt;</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd217313cd5b47c89aa1cf1ffa3fcc13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qWg6aOO5bCP5a6H5a6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770552293&amp;x-signature=SimHStJvHXvTYRX%2B1SBo6KcMF3I%3D" alt="Rc 内存布局" loading="lazy"/></p>
<ul>
<li><strong>栈上（Stack）</strong>：<code>Rc&lt;T&gt;</code> 本身是一个指针，指向堆上的 <code>RcBox</code>。</li>
<li><strong>堆上（Heap）</strong>：<code>RcBox</code> 包含三个部分：
<ol>
<li><strong>Strong Count</strong>：强引用计数。决定了值的生命周期。</li>
<li><strong>Weak Count</strong>：弱引用计数。辅助处理循环引用（本文暂不深入探讨）。</li>
<li><strong>Value</strong>：实际存储的数据 <code>T</code>。</li>
</ol>
</li>
</ul>
<h2 data-id="heading-2">3. 共享所有权：引用计数的变化</h2>
<p>使用 <code>Rc::clone(&amp;rc)</code> 不会深拷贝堆上的数据，而只是在栈上创建一个新的指针，并增加堆上的强引用计数。</p>
<blockquote>
<p><strong>地道写法提示</strong>：在 Rust 中，我们倾向于写 <code>Rc::clone(&amp;rc)</code> 而不是 <code>rc.clone()</code>。虽然两者效果相同，但前者能一眼看出这只是一个增加计数的“廉价”克隆，而不是昂贵的数据深拷贝。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35dd2b2c88624ff685c2c20d317cdf46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qWg6aOO5bCP5a6H5a6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770552293&amp;x-signature=RiJzKQsmKfVtgZDlxWDOe91mEKc%3D" alt="共享所有权" loading="lazy"/></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::rc::Rc;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rc1</span> = Rc::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Shared Data"</span>));
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Count after rc1: {}"</span>, Rc::<span class="hljs-title function_ invoke__">strong_count</span>(&amp;rc1)); <span class="hljs-comment">// 1</span>

    {
        <span class="hljs-comment">// 显式调用 Rc::clone，语义更清晰</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rc2</span> = Rc::<span class="hljs-title function_ invoke__">clone</span>(&amp;rc1); 
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Count after rc2: {}"</span>, Rc::<span class="hljs-title function_ invoke__">strong_count</span>(&amp;rc1)); <span class="hljs-comment">// 2</span>
    } <span class="hljs-comment">// rc2 离开作用域，计数减 1</span>

    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Count after rc2 dropped: {}"</span>, Rc::<span class="hljs-title function_ invoke__">strong_count</span>(&amp;rc1)); <span class="hljs-comment">// 1</span>
}
</code></pre>
<h2 data-id="heading-3">4. 痛点：Rc 是不可变的</h2>
<p><code>Rc&lt;T&gt;</code> 赋予了你“共享”的能力，但它通过 <code>Deref</code> 提供的引用是<strong>只读</strong>的。这是为了防止多个所有者同时修改数据导致的数据竞争（即使在单线程下，多处可变借用也是不安全的）。</p>
<p>如果你需要修改 <code>Rc</code> 内部的数据，通常需要配合 <strong>内部可变性（Interior Mutability）</strong> 模式，这超出了本文的讨论范围。</p>
<h2 data-id="heading-4">5. 致命陷阱：循环引用 (Reference Cycles)</h2>
<p>虽然 <code>Rc</code> 能自动管理内存，但它无法处理循环引用。如果两个 <code>Rc</code> 互相指向对方，它们的引用计数将永远不会归零，导致内存泄漏。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2166d2cb01e04c4884b77cbbc2e1d567~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qWg6aOO5bCP5a6H5a6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770552293&amp;x-signature=aJgWTAakbiYvJdaZWERTGqyUFKc%3D" alt="引用循环" loading="lazy"/></p>
<h2 data-id="heading-5">6. 避坑指南</h2>
<ol>
<li><strong>不要在多线程中使用</strong>：<code>Rc&lt;T&gt;</code> 没有实现 <code>Send</code> 和 <code>Sync</code> trait。在多线程环境下，引用计数的加减操作不是原子的，会导致计数错误。</li>
<li><strong>克隆 vs 拷贝</strong>：虽然 <code>Rc::clone</code> 很轻量，但它依然涉及堆内存访问和计数操作。如果只是在局部函数中使用，直接传递 <code>&amp;T</code> 通常更高效。</li>
</ol>
<h2 data-id="heading-6">7. 最佳实践</h2>
<blockquote>
<p><strong>只有在“无法确定谁是最终所有者”或“数据确实需要被多个不相关的结构共享”时，才使用 <code>Rc&lt;T&gt;</code>。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringAI]]></title>    <link>https://juejin.cn/post/7601486204173713458</link>    <guid>https://juejin.cn/post/7601486204173713458</guid>    <pubDate>2026-02-01T12:43:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601486204173713458" data-draft-id="7601486204173697074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringAI"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-01T12:43:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="keqistarry"/> <meta itemprop="url" content="https://juejin.cn/user/1546377157936228"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringAI
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1546377157936228/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    keqistarry
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T12:43:43.000Z" title="Sun Feb 01 2026 12:43:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AI 机器人 - 整体框架架构设计</h2>
<h3 data-id="heading-1">1. 项目概述</h3>
<p>后端是基于 <strong>Spring Boot 3.x + Spring AI</strong> 的智能对话服务，提供三类核心能力：</p>





















<table><thead><tr><th>能力</th><th>说明</th></tr></thead><tbody><tr><td><strong>普通聊天（带记忆）</strong></td><td>流式 SSE 对话，支持历史消息注入与实时落库</td></tr><tr><td><strong>联网搜索增强</strong></td><td>接入 SearXNG 聚合搜索，并发抓取网页正文后拼上下文再调用模型</td></tr><tr><td><strong>RAG 智能客服</strong></td><td>基于 pgvector 向量检索私有知识库，按指定语料回答</td></tr></tbody></table>
<p>通过 <strong>Spring AI Advisor</strong> 机制将「记忆 / 联网 / RAG / 流式落库」模块化组合，实现可扩展的对话增强链路。</p>
<hr/>
<h3 data-id="heading-2">2. 技术栈</h3>






































































<table><thead><tr><th>类别</th><th>技术</th><th>版本/说明</th></tr></thead><tbody><tr><td>基础框架</td><td>Spring Boot</td><td>3.4.5</td></tr><tr><td>JDK</td><td>Java</td><td>21</td></tr><tr><td>AI 框架</td><td>Spring AI</td><td>1.1.1</td></tr><tr><td>模型接入</td><td>spring-ai-starter-model-openai</td><td>OpenAI 兼容（默认阿里云百炼）</td></tr><tr><td>业务库</td><td>PostgreSQL</td><td>业务表 + 向量存储</td></tr><tr><td>向量存储</td><td>pgvector</td><td>spring-ai-starter-vector-store-pgvector</td></tr><tr><td>ORM</td><td>MyBatis-Plus</td><td>3.5.12</td></tr><tr><td>SQL 监控</td><td>p6spy</td><td>3.9.1</td></tr><tr><td>联网搜索</td><td>SearXNG</td><td>自部署，OkHttp 调用</td></tr><tr><td>网页抓取/清洗</td><td>OkHttp + Jsoup</td><td>4.12.0 / 1.17.2</td></tr><tr><td>日志</td><td>Log4j2</td><td>替代默认 Logback</td></tr><tr><td>其他</td><td>Hutool、Guava、Lombok、Validation、AOP</td><td>工具与校验</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-3">3. 整体架构图</h3>
<pre><code class="hljs language-bash" lang="bash">                    ┌─────────────────────────────────────────────────────────┐
                    │                    前端 / 客户端                           │
                    └───────────────────────────┬─────────────────────────────┘
                                                │ HTTP / SSE
                    ┌───────────────────────────▼─────────────────────────────┐
                    │              Controller 层（接口入口）                     │
                    │  ChatController  │  AiCustomerServiceController          │
                    │  /chat/*         │  /customer-service/*                  │
                    └───────────────────────────┬─────────────────────────────┘
                                                │
        ┌───────────────────────────────────────┼───────────────────────────────────────┐
        │                                       │                                       │
        ▼                                       ▼                                       ▼
┌───────────────┐                    ┌─────────────────────┐                ┌─────────────────────┐
│ ChatService   │                    │ Spring AI ChatClient │                │ CustomerService      │
│ 对话 CRUD     │                    │ + Advisor 链         │                │ 知识库文件/分片/合并 │
└───────┬───────┘                    └──────────┬───────────┘                └──────────┬──────────┘
        │                                        │                                        │
        │              ┌─────────────────────────┼─────────────────────────┐              │
        │              │                         │                         │              │
        ▼              ▼                         ▼                         ▼              ▼
┌───────────────┐  ┌───────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ MyBatis-Plus  │  │ MemoryAdvisor │  │ NetworkSearch   │  │ CustomerService │  │ EventPublisher  │
│ t_chat        │  │ 历史消息注入   │  │ Advisor         │  │ Advisor         │  │ 上传完成 → 向量化 │
│ t_chat_message│  │               │  │ SearXNG+抓取    │  │ pgvector 检索   │  │ @Async 线程池     │
└───────────────┘  └───────────────┘  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘
        │              │                         │                         │              │
        │              │                         ▼                         │              ▼
        │              │              ┌─────────────────┐                   │     ┌─────────────────┐
        │              │              │ SearXNGService  │                   │     │ MarkdownReader   │
        │              │              │ ContentFetcher  │                   │     │ VectorStore.add  │
        │              │              │ OkHttp+Jsoup    │                   │     │ 去重/状态机      │
        │              │              └─────────────────┘                   │     └─────────────────┘
        │              │                         │                         │              │
        ▼              ▼                         ▼                         ▼              ▼
┌───────────────────────────────────────────────────────────────────────────────────────────────────┐
│                          PostgreSQL（业务表）  +  pgvector（t_vector_store）                         │
└───────────────────────────────────────────────────────────────────────────────────────────────────┘
        │                                                                              │
        ▼                                                                              ▼
  外部依赖（可选）:  OpenAI 兼容 API（百炼）、SearXNG 服务、目标网页
</code></pre>
<hr/>
<h3 data-id="heading-4">4. 模块划分与职责</h3>
<h4 data-id="heading-5">4.1 包结构一览</h4>
<pre><code class="hljs language-bash" lang="bash">com.quanxiaoha.ai.robot
├── XiaohaAiRobotSpringbootApplication.java   <span class="hljs-comment"># 启动类</span>
├── advisor/                                  <span class="hljs-comment"># Spring AI 对话增强链</span>
│   ├── CustomChatMemoryAdvisor               <span class="hljs-comment"># 对话记忆（DB 拉历史注入 Prompt）</span>
│   ├── NetworkSearchAdvisor                  <span class="hljs-comment"># 联网搜索（SearXNG + 抓取 + 模板）</span>
│   ├── CustomerServiceAdvisor                <span class="hljs-comment"># RAG 客服（pgvector 检索 + 模板）</span>
│   └── CustomStreamLoggerAndMessage2DBAdvisor <span class="hljs-comment"># 流式日志 + 用户/助手消息落库</span>
├── aspect/                                   <span class="hljs-comment"># AOP</span>
│   ├── ApiOperationLog                       <span class="hljs-comment"># 接口日志注解</span>
│   └── ApiOperationLogAspect                 <span class="hljs-comment"># 入参/出参/耗时环绕</span>
├── config/                                   <span class="hljs-comment"># 配置类</span>
│   ├── AsyncEventConfig                      <span class="hljs-comment"># @Async 事件线程池 eventTaskExecutor</span>
│   ├── ChatClientConfig                      <span class="hljs-comment"># （若有）ChatClient 相关 Bean</span>
│   ├── CorsConfig                            <span class="hljs-comment"># 跨域</span>
│   ├── JacksonConfig                         <span class="hljs-comment"># JSON 序列化</span>
│   ├── MybatisPlusConfig                     <span class="hljs-comment"># 分页等</span>
│   ├── OkHttpConfig                          <span class="hljs-comment"># OkHttp 客户端</span>
│   └── ThreadPoolConfig                      <span class="hljs-comment"># httpRequestExecutor / resultProcessingExecutor</span>
├── constant/                                 <span class="hljs-comment"># 常量</span>
├── controller/                               <span class="hljs-comment"># 接口层</span>
│   ├── ChatController                        <span class="hljs-comment"># /chat/* 普通对话</span>
│   └── AiCustomerServiceController           <span class="hljs-comment"># /customer-service/* 客服与知识库</span>
├── domain/                                   <span class="hljs-comment"># 数据层</span>
│   ├── dos/                                  <span class="hljs-comment"># 表实体</span>
│   │   ├── ChatDO, ChatMessageDO
│   │   ├── AiCustomerServiceFileStorageDO, FileChunkInfoDO
│   └── mapper/                               <span class="hljs-comment"># MyBatis-Plus Mapper</span>
├── enums/                                    <span class="hljs-comment"># 枚举（状态码、文件状态等）</span>
├── event/                                    <span class="hljs-comment"># 领域事件</span>
│   ├── AiCustomerServiceMdUploadedEvent      <span class="hljs-comment"># 文件合并完成事件</span>
│   └── listener/
│       └── AiCustomerServiceMdUploadedListener <span class="hljs-comment"># 异步向量化</span>
├── exception/                                <span class="hljs-comment"># 异常与全局处理</span>
│   ├── BaseExceptionInterface, BizException
│   └── GlobalExceptionHandler
├── model/                                    <span class="hljs-comment"># DTO/VO/公共查询</span>
│   ├── common/, dto/, vo/chat/, vo/customerService/
├── reader/                                   <span class="hljs-comment"># 文档解析</span>
│   └── MarkdownReader                        <span class="hljs-comment"># Markdown → Document 列表</span>
├── service/                                  <span class="hljs-comment"># 业务接口与实现</span>
│   ├── ChatService, CustomerService
│   ├── SearXNGService, SearchResultContentFetcherService
│   └── impl/
└── utils/                                    <span class="hljs-comment"># 工具类（Response、PageResponse、JsonUtil 等）</span>
</code></pre>
<h4 data-id="heading-6">4.2 核心模块职责</h4>

































<table><thead><tr><th>模块</th><th>职责</th></tr></thead><tbody><tr><td><strong>Controller</strong></td><td>接收 HTTP/SSE 请求，组装 ChatModel/ChatClient 与 Advisor 列表，返回统一 Response/Flux</td></tr><tr><td><strong>Advisor</strong></td><td>在模型调用链中插入逻辑：改 Prompt（记忆/联网/RAG）、流式侧写（日志+落库），order 控制执行顺序</td></tr><tr><td><strong>Service</strong></td><td>对话 CRUD、知识库分片上传/合并/列表/删除、SearXNG 搜索、网页内容批量抓取与清洗</td></tr><tr><td><strong>Event + Listener</strong></td><td>文件合并完成后发布事件，异步线程池执行 Markdown 解析、向量化、状态更新</td></tr><tr><td><strong>Config</strong></td><td>线程池、OkHttp、CORS、异步、MyBatis-Plus、pgvector 等</td></tr><tr><td><strong>Exception</strong></td><td>BizException + 全局 Handler，统一返回码与错误信息</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-7">5. 核心业务流程</h3>
<h4 data-id="heading-8">5.1 普通聊天（带记忆）— <code>/chat/completion</code></h4>
<ol>
<li>前端 POST 请求体：<code>message</code>、<code>chatId</code>、<code>modelName</code>、<code>temperature</code>、<code>networkSearch=false</code>。</li>
<li>Controller 构建 <code>OpenAiChatModel</code>，<code>ChatClient.prompt().user(message).options(...)</code>。</li>
<li>若 <strong>未开启联网</strong>：加入 <code>CustomChatMemoryAdvisor</code>（从 DB 按 <code>chatId</code> 拉最近 N 条消息，拼入 Prompt）。</li>
<li>加入 <code>CustomStreamLoggerAndMessage2DBAdvisor</code>（流式消费 token，聚合完整回答与推理内容，流结束后事务写入 <code>t_chat_message</code> 两条：user + assistant）。</li>
<li>返回 <code>Flux&lt;AIResponse&gt;</code>，SSE 推送到前端。</li>
</ol>
<p><strong>Advisor 顺序</strong>：Memory(order=2) → StreamLoggerAndMessage2DB(order=99)。</p>
<h4 data-id="heading-9">5.2 联网搜索增强 — <code>/chat/completion</code>（networkSearch=true）</h4>
<ol>
<li>不挂 Memory Advisor，改为挂 <code>NetworkSearchAdvisor</code>（order=1）。</li>
<li>取用户问题 → 调 <code>SearXNGService.search(query)</code> 拿 URL 列表。</li>
<li><code>SearchResultContentFetcherService.batchFetch()</code>：CompletableFuture + 双线程池（httpRequestExecutor / resultProcessingExecutor）并发抓取 HTML，Jsoup 提正文，超时/异常降级为空。</li>
<li>用 <code>PromptTemplate</code> 把「问题 + 上下文」拼成新 Prompt，交给链继续流式调用模型。</li>
<li>仍由 <code>CustomStreamLoggerAndMessage2DBAdvisor</code> 做流式日志与落库。</li>
</ol>
<h4 data-id="heading-10">5.3 RAG 智能客服 — <code>/customer-service/completion</code></h4>
<ol>
<li>仅挂 <code>CustomerServiceAdvisor</code>（order=1）。</li>
<li>用户问题 → <code>VectorStore.similaritySearch(query, topK=3)</code> 得到 Document 列表。</li>
<li>将 Document 文本拼成 <code>context</code>，通过 <code>PromptTemplate</code> 生成「角色 + 上下文 + 问题 + 回答要求」的增强 Prompt。</li>
<li>流式返回 <code>Flux&lt;AIResponse&gt;</code>，无单独落库（可按需扩展）。</li>
</ol>
<h4 data-id="heading-11">5.4 知识库：分片上传 → 合并 → 向量化</h4>
<ol>
<li><strong>检查</strong> <code>POST /customer-service/file/check</code>：按 <code>fileMd5</code> 查是否已存在，存在则返回已上传分片列表（断点续传）或秒传。</li>
<li><strong>分片上传</strong> <code>POST /customer-service/file/upload-chunk</code>：按 <code>fileMd5 + chunkNumber</code> 落盘并写 <code>t_file_chunk_info</code>，更新 <code>t_ai_customer_service_file_storage.uploadedChunks</code>。</li>
<li><strong>合并</strong> <code>POST /customer-service/file/merge-chunk</code>：按序号读分片，写入最终文件，更新状态为 PENDING，删除分片记录与临时目录，发布 <code>AiCustomerServiceMdUploadedEvent</code>。</li>
<li><strong>异步向量化</strong>：<code>AiCustomerServiceMdUploadedListener</code>（@Async("eventTaskExecutor")）消费事件，将状态置为 VECTORIZING，用 <code>MarkdownReader</code> 解析为 <code>List&lt;Document&gt;</code>，对每条做相似度去重（score&gt;0.99 跳过）后 <code>vectorStore.add()</code>，最后状态置为 COMPLETED/FAILED。</li>
</ol>
<hr/>
<h3 data-id="heading-12">6. 数据模型与存储</h3>
<h4 data-id="heading-13">6.1 业务表（PostgreSQL）</h4>






























<table><thead><tr><th>表名</th><th>说明</th><th>关键字段</th></tr></thead><tbody><tr><td>t_chat</td><td>对话</td><td>id, uuid, summary, create_time, update_time</td></tr><tr><td>t_chat_message</td><td>聊天消息</td><td>id, chat_uuid, content, reasoning_content, role, create_time</td></tr><tr><td>t_ai_customer_service_file_storage</td><td>知识库文件</td><td>id, file_md5, file_name, file_path, file_size, total_chunks, uploaded_chunks, status, ...</td></tr><tr><td>t_file_chunk_info</td><td>分片信息</td><td>id, file_md5, chunk_number, chunk_path, chunk_size</td></tr></tbody></table>
<h4 data-id="heading-14">6.2 文件状态机（status）</h4>
<ul>
<li><strong>UPLOADING(0)</strong>：分片上传中</li>
<li><strong>PENDING(1)</strong>：合并完成，待向量化</li>
<li><strong>VECTORIZING(2)</strong>：向量化中</li>
<li><strong>COMPLETED(3)</strong>：完成</li>
<li><strong>FAILED(4)</strong>：失败</li>
</ul>
<h4 data-id="heading-15">6.3 向量存储（pgvector）</h4>
<ul>
<li>表名：<code>t_vector_store</code>（由 Spring AI pgvector 自动管理）。</li>
<li>用途：存储 Markdown 解析后的 Document 向量，供 RAG 相似度检索。</li>
<li>元数据示例：<code>mdStorageId</code>、<code>originalFileName</code> 等，用于溯源与删除。</li>
</ul>
<hr/>
<h3 data-id="heading-16">7. 配置与部署要点</h3>
<ul>
<li><strong>环境</strong>：<code>application.yml</code> 激活 <code>dev</code>，实际 LLM/DB/SearXNG 等在 <code>application-dev.yml</code> 中配置。</li>
<li><strong>LLM</strong>：<code>spring.ai.openai.base-url</code>、<code>spring.ai.openai.api-key</code>（如 <code>${BAILIAN_API_KEY}</code>）、embedding 模型与维度。</li>
<li><strong>数据库</strong>：<code>spring.datasource.*</code>，可选 p6spy 代理 URL。</li>
<li><strong>pgvector</strong>：<code>spring.ai.vectorstore.pgvector</code>（table-name、dimensions、index-type、distance-type）。</li>
<li><strong>SearXNG</strong>：<code>searxng.url</code>、<code>searxng.count</code>。</li>
<li><strong>customer-service</strong>：<code>file-storage-path</code>、<code>chunk-path</code>、<code>model</code>、<code>temperature</code>。</li>
<li><strong>线程池</strong>：HTTP 抓取与结果处理分离（ThreadPoolConfig），事件异步用 <code>eventTaskExecutor</code>（AsyncEventConfig）。</li>
</ul>
<hr/>
<h3 data-id="heading-17">8. 小结</h3>
<ul>
<li><strong>入口</strong>：两个 Controller（Chat / AiCustomerService），分别对应「普通聊天+联网」与「RAG 客服+知识库管理」。</li>
<li><strong>增强链</strong>：通过 Advisor 组合「记忆 / 联网 / RAG / 流式落库」，顺序由 order 控制。</li>
<li><strong>数据</strong>：业务表用 MyBatis-Plus，向量用 pgvector；知识库采用分片上传 + 事件驱动异步向量化，状态机清晰。</li>
<li><strong>可观测</strong>：AOP 接口日志、p6spy SQL、流式完整内容落库，便于排查与审计。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent 是什么？带你看懂大模型背后的 “行动力”]]></title>    <link>https://juejin.cn/post/7601387539333922852</link>    <guid>https://juejin.cn/post/7601387539333922852</guid>    <pubDate>2026-02-01T12:52:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601387539333922852" data-draft-id="7601387539333906468" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent 是什么？带你看懂大模型背后的 “行动力”"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-01T12:52:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员麻辣烫"/> <meta itemprop="url" content="https://juejin.cn/user/870468942580749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent 是什么？带你看懂大模型背后的 “行动力”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/870468942580749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员麻辣烫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T12:52:15.000Z" title="Sun Feb 01 2026 12:52:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你有没有想过，为什么最近 “Agent” 这个词突然火了起来？在大模型的世界里，Agent 到底是什么？今天，我就用最简单的语言，跟你聊聊我对 Agent 的理解。</p>
<hr/>
<h3 data-id="heading-0">Agent，不只是个名字的变化</h3>
<p>最开始，这玩意儿叫 “Bot”，后来慢慢演变成 “Agent”。看似换了个名字，实际上背后含义更丰富了。</p>
<p>想象一下，大语言模型（LLM）就是一颗超级聪明的大脑，能帮你回答问题，但它只能一问一答，没办法自己动手去做事情。</p>
<p>而 Agent，就是这颗大脑的 “身体”。它让大脑不仅能想，还能去 “行动”，去调用各种工具，完成复杂的任务。</p>
<hr/>
<h3 data-id="heading-1">Agent 的六大组成部分</h3>
<ol>
<li>
<p><strong>人设与回复逻辑（Prompt）</strong>：这就像给 Agent 穿上 “人格衣服”，告诉它该怎么说话、怎么思考。你可以把它想象成 Agent 的性格和工作流程。最近很火的 Prompt Engineering，就是专门设计这部分的技术。</p>
<p>另外，Skill 其实是轻量级的 Agent，模型根据需求选择合适的 Skill 来执行任务。</p>
</li>
<li>
<p><strong>模型设置</strong>：Agent 的大脑有多聪明，和背后的模型能力息息相关。模型越强，Agent 的表现越棒。</p>
</li>
<li>
<p><strong>技能（API）</strong>：这些是 Agent 的 “工具箱”，比如搜索 API，能帮 Agent 去网上查资料。大模型会判断什么时候需要用这些技能，然后让 Agent 去调用。</p>
</li>
<li>
<p><strong>知识库</strong>：这里是专业内容的存放地，比如公司内部规范。模型本身没有这些内容，但通过知识库，Agent 能让回答更准确。这里用到了向量化和向量召回技术。</p>
</li>
<li>
<p><strong>对话体验</strong>：这部分让交互更自然，比如支持语音问答，甚至配上数字人形象，让对话更生动。</p>
</li>
<li>
<p><strong>预览与调试</strong>：这是 Agent 执行任务的 “指挥中心”，确保每一步都按计划进行。这里涉及 Agent 的体系架构，比如单 Agent 还是多 Agent 协作，以及推理机制，比如 ReAct（思考 - 行动 - 观察循环）、Chain-of-Thought（思路链）和 Plan-and-Execute（计划执行）等方法。</p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c3c11f0838e43e8a1abd396c4147295~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bq76L6j54Or:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770555134&amp;x-signature=hLPdApaUEzIJU6wLa5uIObpryA0%3D" alt="image-20260131162110415.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-2">Agent 的工作原理</h3>
<p>简单说就是：大模型知道自己有这些工具（技能、知识、多 Agent），觉得能用它们解决问题，就让 Agent 去执行。Agent 拿到结果，再反馈给大模型，大模型判断是否解决了问题，或者还需要继续调用其他工具。这个过程就像一个不断循环的 “思考 - 行动 - 反馈” 机制。</p>
<hr/>
<h3 data-id="heading-3">说到底，Agent 让大模型不再孤单</h3>
<p>它让大模型从只能 “答题” 的状态，变成了能 “做事” 的智能助手。这背后是复杂的架构和灵活的推理机制，但核心就是让人工智能更贴近我们的生活，更好地帮我们解决问题。</p>
<hr/>
<p>未来，我会把每个部分都拆开详细讲，甚至用代码实现 Agent 的核心逻辑。这样，大家可以根据自己的需求，打造属于自己的智能 Agent。</p>
<p>你是不是也觉得，Agent 的世界很精彩？如果你有兴趣，咱们下次继续聊！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot+Caffeine+Redis 实现多级缓存]]></title>    <link>https://juejin.cn/post/7601387539333972004</link>    <guid>https://juejin.cn/post/7601387539333972004</guid>    <pubDate>2026-02-01T13:48:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601387539333972004" data-draft-id="7601427909702418486" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot+Caffeine+Redis 实现多级缓存"/> <meta itemprop="keywords" content="后端,Redis"/> <meta itemprop="datePublished" content="2026-02-01T13:48:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三水不滴"/> <meta itemprop="url" content="https://juejin.cn/user/283045639753100"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot+Caffeine+Redis 实现多级缓存
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/283045639753100/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三水不滴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T13:48:52.000Z" title="Sun Feb 01 2026 13:48:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">多级缓存：架构设计、实战落地与问题解决</h2>
<p>在高并发分布式系统中，缓存是提升接口响应速度、降低数据库压力的核心技术，但单一缓存层往往难以兼顾<strong>性能</strong>、<strong>一致性</strong>和<strong>高可用</strong>。多级缓存通过整合不同层级的缓存组件，扬长避短构建层次化缓存体系，成为支撑百万级 QPS 系统的标配方案。本文将从核心概念、架构设计、实战实现、一致性保障及经典问题解决五个维度，全面解析多级缓存技术，同时结合 SpringBoot+Caffeine+Redis 的实战案例，让技术落地更具可操作性。</p>
<h3 data-id="heading-1">一、什么是多级缓存？</h3>
<p>多级缓存是指在系统中部署<strong>多层功能互补的缓存组件</strong>，让请求按照预设顺序依次访问各层缓存，仅当所有缓存层均未命中时，才访问底层数据库的架构模式。其核心设计思想是<strong>离用户越近的缓存，速度越快、开销越低</strong>，通过分层拦截请求，最大化减少对后端存储的访问。</p>
<p>在 Java 后端体系中，最主流的是<strong>二级缓存架构</strong>（本地缓存 + 分布式缓存），部分场景会结合数据库自身缓存形成三级体系，各层核心特性与选型如下：</p>
<ol>
<li><strong>本地缓存</strong>：运行在应用进程内部的内存缓存，无网络 IO 开销，读写延迟纳秒级。主流选型为 Caffeine（性能优于 Guava Cache、Ehcache），适合存储<strong>高频访问的热点数据</strong>，缺点是数据仅当前实例可见，无法分布式共享，且受 JVM 内存限制。</li>
<li><strong>分布式缓存</strong>：独立于应用的中间件，部署在集群中可被所有应用实例共享，数据一致性更易保障。主流选型为 Redis（支持丰富数据结构、持久化、分布式锁），适合存储<strong>全量热点数据 + 通用业务数据</strong>，缺点是存在网络 IO 开销，性能略低于本地缓存。</li>
<li><strong>数据库缓存</strong>：数据库自身的查询缓存 / 缓冲池（如 MySQL 的 InnoDB Buffer Pool），属于底层被动缓存，通常无需人工干预，仅作为最后一道数据屏障。</li>
</ol>
<p><strong>各层缓存性能对比</strong>（核心指标）：</p>

































<table><thead><tr><th>缓存层级</th><th>读写延迟</th><th>集群共享</th><th>部署成本</th><th>适用场景</th></tr></thead><tbody><tr><td>本地缓存（Caffeine）</td><td>纳秒级</td><td>否</td><td>低（无独立组件）</td><td>高频热点数据、单机维度临时数据</td></tr><tr><td>分布式缓存（Redis）</td><td>微秒级</td><td>是</td><td>中（需集群部署）</td><td>全量热点数据、跨实例共享数据</td></tr><tr><td>数据库缓存</td><td>毫秒级</td><td>是</td><td>高</td><td>所有数据的最终存储</td></tr></tbody></table>
<h3 data-id="heading-2">二、为什么需要多级缓存？</h3>
<p>单一缓存层在高并发场景下存在难以克服的短板，而多级缓存通过<strong>优势互补</strong>解决这些问题，同时带来极致的性能提升。我们通过一组电商商品详情页的压测数据，直观感受多级缓存的价值：</p>


























<table><thead><tr><th>架构模式</th><th>QPS</th><th>TP99 延迟 (ms)</th><th>数据库负载</th><th>缓存命中率</th></tr></thead><tbody><tr><td>单 Redis 缓存</td><td>5.8 万</td><td>120</td><td>65%</td><td>75%</td></tr><tr><td>Caffeine+Redis 多级缓存</td><td>120 万</td><td>45</td><td>8%</td><td>99.2%</td></tr></tbody></table>
<p>从数据可以看出，多级缓存让 QPS 提升 20 倍、TP99 延迟降低 60%、数据库负载减少 87%，核心价值体现在三个方面：</p>
<ol>
<li><strong>极致性能</strong>：本地缓存拦截 80% 以上的高频请求，避免大量请求穿透到 Redis，减少网络 IO 和 Redis 集群压力，让接口响应速度达到极致。</li>
<li><strong>高可用兜底</strong>：当分布式缓存集群（如 Redis）发生宕机时，本地缓存可临时兜底核心热点数据，避免系统直接雪崩，提升服务容错能力。</li>
<li><strong>资源优化</strong>：通过分层存储数据，将高频数据放在本地缓存（低开销），通用数据放在分布式缓存（共享性），避免 Redis 存储大量低价值数据，降低缓存集群的部署成本。</li>
</ol>
<p>此外，多级缓存还能从架构层面<strong>规避单一缓存的经典问题</strong>，比如本地缓存的分布式一致性问题可通过 Redis 兜底，Redis 的网络开销问题可通过本地缓存拦截，让系统更健壮。</p>
<h3 data-id="heading-3">三、多级缓存核心架构设计</h3>
<h4 data-id="heading-4">3.1 核心设计原则</h4>
<p>多级缓存的设计需遵循<strong>3 个核心原则</strong>，否则易导致架构臃肿、数据一致性混乱：</p>
<ol>
<li><strong>请求就近原则</strong>：请求优先访问本地缓存，未命中再访问分布式缓存，最后访问数据库，反向流程不可行。</li>
<li><strong>数据分层原则</strong>：不同价值的数据存储在对应层级，本地缓存仅存<strong>高频热点数据</strong>（控制容量，避免 OOM），分布式缓存存<strong>全量业务数据</strong>，不重复存储低价值数据。</li>
<li><strong>失效由上至下原则</strong>：缓存更新 / 失效时，先操作本地缓存，再操作分布式缓存，避免出现 “本地缓存有旧数据，分布式缓存有新数据” 的不一致情况。</li>
</ol>
<h4 data-id="heading-5">3.2 主流架构：Caffeine+Redis 二级缓存</h4>
<p>Java 后端中，<strong>Caffeine（本地）+ Redis（分布式）</strong> 是工业级落地的主流架构，适用于 90% 以上的业务场景（电商、社交、资讯等），其<strong>请求访问流程</strong>和<strong>数据更新流程</strong>如下，是后续实战的核心基础。</p>
<h5 data-id="heading-6">（1）请求访问流程（读操作）</h5>
<ol>
<li>应用接收到请求后，首先查询<strong>Caffeine 本地缓存</strong>，命中则直接返回结果，结束请求；</li>
<li>本地缓存未命中，查询<strong>Redis 分布式缓存</strong>，命中则将数据回写到本地缓存（方便后续请求拦截），然后返回结果；</li>
<li>分布式缓存也未命中，执行<strong>数据库查询</strong>，查询结果非空时，依次回写到 Redis 和 Caffeine，然后返回结果；</li>
<li>数据库查询结果为空时，执行<strong>空值缓存</strong>（短期过期），避免后续请求穿透到数据库。</li>
</ol>
<h5 data-id="heading-7">（2）数据更新流程（写操作）</h5>
<p>遵循 <strong>“先更数据库，再删缓存”</strong> 原则（避免 “先删缓存，再更数据库” 的并发不一致问题），核心步骤：</p>
<ol>
<li>执行数据库的增 / 删 / 改操作，保证数据落地；</li>
<li><strong>删除 Redis 对应缓存</strong>（而非更新，避免并发覆盖）；</li>
<li><strong>驱逐 Caffeine 本地缓存</strong>（当前实例），若为集群部署，通过消息队列（如 RocketMQ/Kafka）通知其他实例驱逐本地缓存；</li>
<li>后续请求会触发缓存重新加载，保证数据最新。</li>
</ol>
<p><strong>注意</strong>：写操作优先选择<strong>删缓存</strong>而非<strong>更缓存</strong>，原因是：若同时有多个写请求，直接更新缓存可能导致<strong>并发覆盖</strong>，而删除缓存后，由读请求触发懒加载，能保证缓存数据的最终一致性。</p>
<h3 data-id="heading-8">四、实战落地：SpringBoot 整合 Caffeine+Redis 多级缓存</h3>
<p>本节基于<strong>SpringBoot 2.7.x</strong>，实现 Caffeine+Redis 的二级缓存架构，包含核心依赖、配置、代码实现，同时整合<strong>空值缓存</strong>、<strong>分布式锁</strong>等特性，直接可用于生产环境（仅需根据业务调整参数）。</p>
<h4 data-id="heading-9">4.1 核心依赖引入（Maven）</h4>
<p>引入 Caffeine、Redis、SpringCache 核心依赖，简化缓存操作，无需手动封装缓存工具类：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SpringCache缓存抽象（简化缓存注解使用） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-comment">&lt;!-- Caffeine本地缓存 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-comment">&lt;!-- Redis分布式缓存（Lettuce客户端） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 序列化依赖（解决Redis存储对象乱码问题） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.32<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-10">4.2 核心配置（配置类 + yml）</h4>
<h5 data-id="heading-11">（1）缓存配置类：初始化 Caffeine 和 Redis 缓存管理器</h5>
<p>通过配置类实现<strong>双缓存管理器</strong>，分别管理本地缓存和分布式缓存，支持注解式缓存操作，核心参数按需调整（如过期时间、最大容量）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.github.benmanes.caffeine.cache.Caffeine;
<span class="hljs-keyword">import</span> org.springframework.cache.CacheManager;
<span class="hljs-keyword">import</span> org.springframework.cache.caffeine.CaffeineCacheManager;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Primary;
<span class="hljs-keyword">import</span> org.springframework.data.redis.cache.RedisCacheConfiguration;
<span class="hljs-keyword">import</span> org.springframework.data.redis.cache.RedisCacheManager;
<span class="hljs-keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;
<span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;
<span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.RedisSerializationContext;

<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableCaching</span> <span class="hljs-comment">// 开启SpringCache注解支持</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiLevelCacheConfig</span> {

    <span class="hljs-comment">// 1. 本地缓存管理器（Caffeine）：优先使用，存储热点数据</span>
    <span class="hljs-meta">@Bean("caffeineCacheManager")</span>
    <span class="hljs-keyword">public</span> CacheManager <span class="hljs-title function_">caffeineCacheManager</span><span class="hljs-params">()</span> {
        <span class="hljs-type">CaffeineCacheManager</span> <span class="hljs-variable">cacheManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaffeineCacheManager</span>();
        <span class="hljs-comment">// 核心配置：最大容量1000条、写入后5秒过期（短过期防脏数据）、弱引用回收</span>
        cacheManager.setCaffeine(Caffeine.newBuilder()
                .maximumSize(<span class="hljs-number">1000</span>)
                .expireAfterWrite(<span class="hljs-number">5</span>, TimeUnit.SECONDS)
                .weakValues());
        <span class="hljs-keyword">return</span> cacheManager;
    }

    <span class="hljs-comment">// 2. 分布式缓存管理器（Redis）：@Primary表示默认缓存管理器，存储通用数据</span>
    <span class="hljs-meta">@Bean("redisCacheManager")</span>
    <span class="hljs-meta">@Primary</span>
    <span class="hljs-keyword">public</span> CacheManager <span class="hljs-title function_">redisCacheManager</span><span class="hljs-params">(RedisConnectionFactory factory)</span> {
        <span class="hljs-comment">// 序列化配置：解决对象乱码</span>
        <span class="hljs-type">RedisCacheConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> RedisCacheConfiguration.defaultCacheConfig()
                .serializeValuesWith(RedisSerializationContext.SerializationPair
                        .fromSerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericJackson2JsonRedisSerializer</span>()))
                .entryTtl(<span class="hljs-number">30</span>, TimeUnit.SECONDS); <span class="hljs-comment">// 写入后30秒过期</span>

        <span class="hljs-keyword">return</span> RedisCacheManager.builder(factory)
                .cacheDefaults(config)
                .build();
    }
}
</code></pre>
<h5 data-id="heading-12">（2）yml 配置：Redis 连接信息</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
    <span class="hljs-attr">lettuce:</span>
      <span class="hljs-attr">pool:</span>
        <span class="hljs-attr">max-active:</span> <span class="hljs-number">8</span> <span class="hljs-comment"># 最大连接数</span>
        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">8</span>   <span class="hljs-comment"># 最大空闲连接</span>
        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">2</span>   <span class="hljs-comment"># 最小空闲连接</span>
        <span class="hljs-attr">max-wait:</span> <span class="hljs-string">1000ms</span> <span class="hljs-comment"># 连接等待时间</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-string">3000ms</span> <span class="hljs-comment"># 连接超时时间</span>
</code></pre>
<h4 data-id="heading-13">4.3 业务层实现：注解式多级缓存操作</h4>
<p>基于 SpringCache 注解，实现<strong>商品详情查询</strong>和<strong>商品库存更新</strong>的核心业务，完美贴合前文的 “请求访问流程” 和 “数据更新流程”，代码简洁易维护：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.cache.annotation.CacheEvict;
<span class="hljs-keyword">import</span> org.springframework.cache.annotation.Cacheable;
<span class="hljs-keyword">import</span> org.springframework.cache.annotation.CachePut;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> javax.annotation.Resource;
<span class="hljs-keyword">import</span> java.util.Optional;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ProductMapper productMapper; <span class="hljs-comment">// 数据库Mapper</span>
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;

    <span class="hljs-comment">// 空值标记：解决缓存穿透</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Product</span> <span class="hljs-variable">NULL_PRODUCT</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(-<span class="hljs-number">1L</span>, <span class="hljs-string">"NULL"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.0</span>);

    <span class="hljs-comment">/**
     * 商品详情查询：多级缓存（先Caffeine，再Redis，最后DB）
     * <span class="hljs-doctag">@Cacheable</span>：缓存查询结果，指定本地缓存管理器
     */</span>
    <span class="hljs-meta">@Cacheable(value = "product", key = "#id", cacheManager = "caffeineCacheManager")</span>
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// 1. 本地缓存未命中，查询Redis</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + id;
        <span class="hljs-type">Product</span> <span class="hljs-variable">redisProduct</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(redisKey);
        <span class="hljs-keyword">if</span> (redisProduct != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> redisProduct;
        }

        <span class="hljs-comment">// 2. Redis未命中，查询数据库</span>
        <span class="hljs-type">Product</span> <span class="hljs-variable">dbProduct</span> <span class="hljs-operator">=</span> productMapper.selectById(id);
        <span class="hljs-comment">// 3. 空值缓存：防止穿透</span>
        <span class="hljs-type">Product</span> <span class="hljs-variable">cacheProduct</span> <span class="hljs-operator">=</span> Optional.ofNullable(dbProduct).orElse(NULL_PRODUCT);
        <span class="hljs-comment">// 4. 回写Redis：设置60秒过期</span>
        redisTemplate.opsForValue().set(redisKey, cacheProduct, <span class="hljs-number">60</span>, TimeUnit.SECONDS);
        <span class="hljs-comment">// 5. 若为NULL_PRODUCT，返回null，避免业务层处理异常</span>
        <span class="hljs-keyword">return</span> cacheProduct.equals(NULL_PRODUCT) ? <span class="hljs-literal">null</span> : cacheProduct;
    }

    <span class="hljs-comment">/**
     * 商品库存更新：先更DB，再删缓存（保证一致性）
     * <span class="hljs-doctag">@CacheEvict</span>：删除指定缓存
     */</span>
    <span class="hljs-meta">@CacheEvict(value = "product", key = "#productId", cacheManager = "caffeineCacheManager")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProductStock</span><span class="hljs-params">(Long productId, <span class="hljs-type">int</span> delta)</span> {
        <span class="hljs-comment">// 1. 更新数据库：先落地数据</span>
        productMapper.updateStock(productId, delta);
        <span class="hljs-comment">// 2. 删除Redis缓存：避免旧数据</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
        redisTemplate.delete(redisKey);
        <span class="hljs-comment">// 3. 本地缓存已通过@CacheEvict删除，无需手动操作</span>
    }
}
</code></pre>
<h4 data-id="heading-14">4.4 集群化改造：本地缓存一致性</h4>
<p>上述代码仅适用于单机部署，<strong>集群部署时</strong>，某一实例更新数据后，其他实例的本地缓存仍会存在旧数据，导致数据不一致。解决该问题的主流方案是<strong>基于消息队列的缓存通知</strong>，核心思路：</p>
<ol>
<li>部署消息队列（如 RocketMQ/Kafka），创建<strong>缓存更新主题</strong>；</li>
<li>当某一实例执行缓存删除操作时，向主题发送<strong>缓存失效消息</strong>（包含缓存 key、缓存名称）；</li>
<li>所有应用实例均作为消费者，监听该主题，收到消息后，删除本地对应缓存；</li>
<li>保证消息的<strong>至少一次消费</strong>，避免缓存失效消息丢失。</li>
</ol>
<p><strong>简化实现</strong>：使用 Redis 的 Pub/Sub 替代消息队列（轻量、无需独立部署），实现缓存通知，适合中小型集群。</p>
<h3 data-id="heading-15">五、多级缓存的一致性保障</h3>
<p>多级缓存的核心痛点是<strong>数据一致性</strong>—— 各层缓存之间、各实例的本地缓存之间，可能因更新延迟、缓存污染导致数据不一致。由于强一致性会引入分布式事务、锁等机制，导致性能大幅下降，工业级场景中均采用<strong>最终一致性</strong>（允许短时间不一致，最终所有缓存层数据收敛），核心保障策略分为三类：</p>
<h4 data-id="heading-16">5.1 缓存更新策略：选对策略，从源头减少不一致</h4>
<p>主流的缓存更新策略有 3 种，结合多级缓存的特性， <strong>“先更 DB，再删缓存”</strong> 是最优选择，其他策略仅适用于特殊场景：</p>
<ol>
<li><strong>先更 DB，再删缓存</strong>（推荐）：无并发覆盖问题，实现简单，仅存在 “删缓存失败” 的小概率问题，可通过<strong>定时任务补偿</strong>解决；</li>
<li><strong>先删缓存，再更 DB</strong>：高并发下会出现 “缓存脏数据”（A 删缓存→B 查缓存未命中→查旧 DB→回写缓存→A 更 DB），导致缓存数据长期不一致；</li>
<li><strong>双写策略</strong>（更新 DB 同时更新缓存）：高并发下会出现 “缓存覆盖”（A 和 B 同时更新 DB，再先后更新缓存，导致缓存数据与最新 DB 数据不一致），仅适用于低并发场景。</li>
</ol>
<h4 data-id="heading-17">5.2 过期时间策略：强制让脏数据失效</h4>
<p>为各层缓存设置<strong>合理的过期时间（TTL）</strong> ，是最终一致性的最后一道屏障，即使出现缓存更新失败，脏数据也会在过期后自动失效，重新从 DB 加载最新数据。</p>
<ul>
<li>本地缓存（Caffeine）：设置<strong>短 TTL</strong>（5-10 秒），快速淘汰脏数据，避免本地缓存长期不一致；</li>
<li>分布式缓存（Redis）：设置<strong>中等 TTL</strong>（30-60 秒），兼顾缓存命中率和数据新鲜度；</li>
<li>空值缓存：设置<strong>极短 TTL</strong>（3-5 分钟），避免无效空值占用过多缓存空间。</li>
</ul>
<p>同时，为 Redis 缓存设置<strong>随机 TTL 偏移量</strong>（如 30 秒 ±5 秒），避免大量缓存同时过期导致的雪崩问题。</p>
<h4 data-id="heading-18">5.3 异步同步策略：解决集群本地缓存一致性</h4>
<p>如前文所述，集群部署时的本地缓存一致性，通过 <strong>“消息通知 + 异步删除”</strong> 实现，主流方案对比：</p>





























<table><thead><tr><th>同步方案</th><th>实现难度</th><th>性能</th><th>适用场景</th></tr></thead><tbody><tr><td>Redis Pub/Sub</td><td>低</td><td>高</td><td>中小型集群、对一致性要求一般的场景</td></tr><tr><td>消息队列（RocketMQ/Kafka）</td><td>中</td><td>高</td><td>大型集群、核心业务场景</td></tr><tr><td>分布式配置中心（Nacos/Apollo）</td><td>中</td><td>中</td><td>配置类缓存、低频更新数据</td></tr></tbody></table>
<h3 data-id="heading-19">六、多级缓存经典问题解决</h3>
<p>缓存系统的三大经典问题 ——<strong>穿透、击穿、雪崩</strong>，在多级缓存架构中可通过<strong>分层防护</strong>实现更高效的解决，相比单一缓存层，防护手段更丰富、效果更彻底。</p>
<h4 data-id="heading-20">6.1 缓存穿透：拦截无效请求，避免穿透到 DB</h4>
<p><strong>问题定义</strong>：请求查询的数在所有缓存层和 DB 中均不存在，导致每次请求都穿透到 DB，若遭遇恶意请求（如伪造不存在的商品 ID），会压垮数据库。<strong>多级缓存防护方案</strong>（双重防护，层层拦截）：</p>
<ol>
<li><strong>第一层：接口层参数校验</strong>：在 Controller/Gateway 层对请求参数做强校验（如 ID 必须大于 0、符合业务规则），直接拦截明显无效的请求；</li>
<li><strong>第二层：空值缓存</strong>：在 Caffeine 和 Redis 中缓存空值（如前文的 NULL_PRODUCT），设置短 TTL，让后续相同无效请求被缓存拦截；</li>
<li><strong>进阶方案：布隆过滤器</strong>：将 DB 中所有有效主键（如商品 ID、用户 ID）预先加载到布隆过滤器，请求先经过过滤器校验，<strong>不存在的键直接拦截</strong>，仅可能存在的键才进入缓存层，适合超大规模数据场景（如千万级商品库）。</li>
</ol>
<h4 data-id="heading-21">6.2 缓存击穿：保护热点数据，避免单点穿透</h4>
<p><strong>问题定义</strong>：某个<strong>超高访问量的热点数据</strong>（如秒杀商品）在缓存中过期的瞬间，大量并发请求同时穿透到 DB，导致数据库单点压力骤增。<strong>多级缓存防护方案</strong>（热点数据专属防护）：</p>
<ol>
<li><strong>第一层：热点数据永不过期</strong>：对秒杀、首页焦点图等核心热点数据，设置<strong>物理永不过期</strong>，通过<strong>手动更新 / 删除</strong>控制缓存生命周期，从源头避免过期；</li>
<li><strong>第二层：本地锁 + 分布式锁双重锁</strong>：缓存过期后，通过<strong>本地锁（synchronized）</strong> 拦截单机内的并发请求，再通过<strong>Redis 分布式锁（Redisson）</strong> 拦截集群内的并发请求，仅允许一个线程查询 DB 并更新缓存，其他线程等待缓存更新后再查询；</li>
<li><strong>第三层：热点数据预热</strong>：系统启动时 / 流量高峰前，通过定时任务将热点数据主动加载到 Caffeine 和 Redis 中，避免缓存冷启动导致的击穿。</li>
</ol>
<h4 data-id="heading-22">6.3 缓存雪崩：分散过期时间，避免集体穿透</h4>
<p><strong>问题定义</strong>：大量缓存数据在<strong>同一时间点过期</strong>，或分布式缓存集群（Redis）宕机，导致所有请求瞬间涌向 DB，引发数据库雪崩，进而导致整个系统瘫痪。<strong>多级缓存防护方案</strong>（架构级防护，容错性拉满）：</p>
<ol>
<li><strong>第一层：差异化 TTL</strong>：为 Redis 缓存设置<strong>随机过期时间偏移量</strong>（如基础 TTL30 秒 + 随机 0-5 秒），让缓存过期时间分散，避免集体失效；</li>
<li><strong>第二层：多级缓存兜底</strong>：即使 Redis 集群宕机，Caffeine 本地缓存仍能拦截大部分热点请求，保证核心业务可用，同时触发告警机制；</li>
<li><strong>第三层：缓存高可用 + 服务降级</strong>：Redis 采用 Cluster/Sentinel 集群部署，避免单点故障；同时结合 Hystrix/Sentinel 实现服务降级，当 DB 压力达到阈值时，直接返回本地缓存的兜底数据，放弃部分数据新鲜度，保证服务可用性；</li>
<li><strong>第四层：数据库限流</strong>：在 DB 代理层（如 MyCat）设置访问限流，控制每秒访问 DB 的请求数，避免数据库被压垮。</li>
</ol>
<h3 data-id="heading-23">七、多级缓存调优与监控</h3>
<h4 data-id="heading-24">7.1 性能调优关键参数</h4>
<p>多级缓存的性能调优核心是<strong>平衡缓存命中率和资源占用</strong>，关键参数调整原则：</p>
<ol>
<li><strong>Caffeine 调优</strong>：<code>maximumSize</code>根据 JVM 内存合理设置（如单机 1G 内存设置 1000-2000 条），避免 OOM；优先使用<code>expireAfterWrite</code>（写入后过期）而非<code>expireAfterAccess</code>（访问后过期），减少性能开销；</li>
<li><strong>Redis 调优</strong>：开启持久化（RDB+AOF 混合），避免数据丢失；优化连接池参数（如<code>max-active</code>根据并发量设置），减少连接等待；使用 Redis Cluster 集群，提升并发能力；</li>
<li><strong>JVM 调优</strong>：开启 G1GC，设置<code>-XX:MaxGCPauseMillis=100</code>，减少 GC 停顿对本地缓存的影响；合理设置 JVM 堆内存，为本地缓存预留足够空间。</li>
</ol>
<h4 data-id="heading-25">7.2 核心监控指标</h4>
<p>无监控不架构，多级缓存需要监控<strong>各层缓存的核心指标</strong>，及时发现缓存失效、命中率低等问题，主流监控方案为 Prometheus+Grafana：</p>
<ol>
<li><strong>缓存命中率</strong>：核心指标，本地缓存（Caffeine）命中率应≥90%，Redis 命中率应≥95%，命中率过低需分析数据分布，调整缓存策略；</li>
<li><strong>缓存未命中率</strong>：持续偏高需排查是否存在穿透、击穿问题；</li>
<li><strong>Redis 指标</strong>：CPU 使用率、内存使用率、网络 IO、连接数，避免 Redis 成为性能瓶颈；</li>
<li><strong>数据库指标</strong>：QPS、连接数、慢查询数，验证缓存拦截效果，若数据库 QPS 持续偏高，需优化缓存策略。</li>
</ol>
<p><strong>监控实现</strong>：Caffeine 自带监控指标，可通过<code>Cache.stats()</code>获取；Redis 可通过 Exporter 采集指标；最终在 Grafana 中制作可视化大盘，设置指标告警（如命中率低于 90% 时触发短信 / 钉钉告警）。</p>
<h3 data-id="heading-26">八、大厂落地最佳实践</h3>
<p>多级缓存在阿里、京东、拼多多等大厂的高并发场景中已广泛落地，总结其<strong>核心落地经验</strong>，让技术落地更贴合生产环境：</p>
<ol>
<li><strong>数据分层存储</strong>：本地缓存仅存<strong>TOP 10% 的高频热点数据</strong>，其余数据存在 Redis，避免本地缓存占用过多 JVM 内存；</li>
<li><strong>避免过度设计</strong>：中小型系统优先使用 “Caffeine+Redis” 二级架构，无需引入更多缓存层，增加架构复杂度；</li>
<li><strong>缓存更新失败补偿</strong>：针对 “删缓存失败” 问题，增加<strong>定时任务补偿</strong>（如每分钟扫描 DB 更新日志，对比缓存数据，删除不一致的缓存）；</li>
<li><strong>冷启动防护</strong>：系统重启时，先通过预热脚本加载热点数据，再对外提供服务，避免冷启动导致的缓存穿透、击穿；</li>
<li><strong>灰度发布</strong>：缓存策略变更（如 TTL 调整、数据分层变更）时，采用灰度发布，逐步扩大范围，避免全量发布导致的性能问题。</li>
</ol>
<h3 data-id="heading-27">九、总结</h3>
<p>多级缓存并非简单的 “本地缓存 + 分布式缓存” 组合，而是一套<strong>兼顾性能、一致性、高可用</strong>的层次化架构设计思想。其核心价值在于通过分层拦截请求，将性能做到极致，同时通过最终一致性策略、分层防护手段，解决缓存的经典问题，成为支撑百万级 QPS 高并发系统的核心技术。</p>
<p>本文结合 SpringBoot+Caffeine+Redis 的实战案例，从架构设计到代码实现，从一致性保障到问题解决，实现了技术的全链路落地。在实际项目中，无需生搬硬套，可根据<strong>业务规模、并发量、数据一致性要求</strong>，灵活调整缓存架构和策略 —— 中小型系统优先保证落地简单，大型高并发系统重点做好缓存分层、监控和容错。</p>
<p>缓存的本质是<strong>用空间换时间</strong>，而多级缓存则是让这份 “交换” 的性价比达到最高，这也是其能成为高并发系统标配的根本原因。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一分钟为接入最灵活的操作日志系统]]></title>    <link>https://juejin.cn/post/7601374137411731491</link>    <guid>https://juejin.cn/post/7601374137411731491</guid>    <pubDate>2026-02-01T13:40:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601374137411731491" data-draft-id="7601355703240048680" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一分钟为接入最灵活的操作日志系统"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-01T13:40:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="都市桃源"/> <meta itemprop="url" content="https://juejin.cn/user/1943592291015944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一分钟为接入最灵活的操作日志系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1943592291015944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    都市桃源
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T13:40:46.000Z" title="Sun Feb 01 2026 13:40:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 概述</h2>
<p>common-audit-log 是一个基于 AOP 的审计日志组件，支持操作日志的自动收集、差异比对和存储。该组件通过注解方式轻松集成到 Spring Boot 应用中，实现操作日志的自动化记录。</p>
<h2 data-id="heading-1">2. 核心特性</h2>
<ul>
<li><strong>注解驱动</strong>：通过简单的注解即可实现日志记录</li>
<li><strong>SpEL 表达式支持</strong>：动态填充日志操作描述,操作分类,操作数据id等信息</li>
<li><strong>差异比对</strong>：支持操作前后数据差异自动比对</li>
<li><strong>支持多层级嵌套调用日志</strong>：支持多层级嵌套调用日志</li>
<li><strong>条件性记录</strong>：支持根据条件决定是否记录日志</li>
<li><strong>异步收集</strong>：支持异步日志收集，不影响主业务性能</li>
<li><strong>配套查询系统(可选)</strong>： 支持多维条件查询日志,开箱即用</li>
</ul>
<h2 data-id="heading-2">3. 模块说明</h2>





















<table><thead><tr><th>模块</th><th>说明</th></tr></thead><tbody><tr><td>common-audit-log-core</td><td>核心功能模块，包含注解、AOP 切面、差异比对等</td></tr><tr><td>common-audit-log-runtime</td><td>运行时配置模块，包含自动配置和属性配置</td></tr><tr><td>common-audit-log-web</td><td>日志查询配套系统和接入示例</td></tr></tbody></table>
<h2 data-id="heading-3">4. 快速开始</h2>
<h3 data-id="heading-4">4.1 添加依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.taoyuanx<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>common-audit-log-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.taoyuanx<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>common-audit-log-runtime<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">4.2 配置文件</h3>
<p>在 <code>application.yml</code> 中添加配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">audit:</span>
  <span class="hljs-attr">log:</span>
    <span class="hljs-comment"># 是否异步处理日志</span>
    <span class="hljs-attr">async:</span> <span class="hljs-literal">true</span>
    <span class="hljs-comment"># 异步队列大小</span>
    <span class="hljs-attr">log-queue-size:</span> <span class="hljs-number">1000</span>
    <span class="hljs-comment"># 异步收集线程收集间隔（毫秒）</span>
    <span class="hljs-attr">collect-interval:</span> <span class="hljs-number">50</span>
    <span class="hljs-comment"># 收集队列满时的等待时间（毫秒），负数则入队失败丢弃</span>
    <span class="hljs-attr">queue-full-wait-time:</span> <span class="hljs-number">2000</span>
</code></pre>
<h3 data-id="heading-6">4.3 启用自动配置</h3>
<p>确保 Spring Boot 启动类扫描到组件包：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@ComponentScan(basePackages = {"com.taoyuanx.common.audit.log"})</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(Application.class, args);
    }
}
</code></pre>
<h2 data-id="heading-7">5. 核心注解</h2>
<h3 data-id="heading-8">5.1 @OperateLog</h3>
<p>标准的操作日志注解，用于标记需要记录日志的方法。</p>
<p><strong>属性说明：</strong></p>





















































<table><thead><tr><th>属性</th><th>类型</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td>bizType</td><td>String</td><td>是</td><td>业务类型，如"用户管理"、"订单管理"</td></tr><tr><td>subBizType</td><td>String</td><td>否</td><td>子业务类型</td></tr><tr><td>operateObject</td><td>String</td><td>否</td><td>操作对象，支持 SpEL 表达式</td></tr><tr><td>success</td><td>String</td><td>是</td><td>操作成功时的日志描述模板，支持 SpEL 表达式</td></tr><tr><td>fail</td><td>String</td><td>否</td><td>操作失败时的日志描述模板，支持 SpEL 表达式</td></tr><tr><td>condition</td><td>String</td><td>否</td><td>记录条件，支持 SpEL 表达式，true 才记录</td></tr><tr><td>ignoreException</td><td>Class[]</td><td>否</td><td>忽略的异常类型</td></tr></tbody></table>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/user/add")</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-meta">@OperateLog(
    success = "'新增了用户:' + #result.get('username')",
    fail = "'新增用户失败:' + #error.message",
    bizType = "用户管理",
    operateObject = "#result.get('username')"
)</span>
<span class="hljs-keyword">public</span> Map <span class="hljs-title function_">addUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String, Object&gt; params)</span> {
    <span class="hljs-comment">// 业务逻辑</span>
    <span class="hljs-keyword">return</span> params;
}
</code></pre>
<h3 data-id="heading-9">5.2 @SimpleOperateLog</h3>
<p>简化版操作日志注解，适用于简单场景。</p>
<p><strong>属性说明：</strong></p>



































<table><thead><tr><th>属性</th><th>类型</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td>bizType</td><td>String</td><td>是</td><td>业务类型</td></tr><tr><td>subBizType</td><td>String</td><td>否</td><td>子业务类型</td></tr><tr><td>operateObject</td><td>String</td><td>否</td><td>操作对象</td></tr><tr><td>operateDesc</td><td>String</td><td>是</td><td>操作描述，支持 SpEL 表达式</td></tr></tbody></table>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/user/add")</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-meta">@SimpleOperateLog(
    operateDesc = "'新增了用户:' + #params.get('username')",
    bizType = "用户管理",
    operateObject = "#params.get('username')"
)</span>
<span class="hljs-keyword">public</span> Map <span class="hljs-title function_">addUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String, Object&gt; params)</span> {
    <span class="hljs-comment">// 业务逻辑</span>
    <span class="hljs-keyword">return</span> params;
}
</code></pre>
<h3 data-id="heading-10">5.3 @LogDiff</h3>
<p>数据差异比对注解，配合 @OperateLog 使用，用于记录数据变更前后对比。</p>
<p><strong>属性说明：</strong></p>





























<table><thead><tr><th>属性</th><th>类型</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td>before</td><td>String</td><td>否</td><td>操作前数据获取表达式</td></tr><tr><td>after</td><td>String</td><td>否</td><td>操作后数据获取表达式</td></tr><tr><td>diffHandler</td><td>Class</td><td>否</td><td>对象对比器，默认 NoDiffHandler</td></tr></tbody></table>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 新增操作（只有操作后数据）</span>
<span class="hljs-meta">@PostMapping("/user/add")</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-meta">@OperateLog(
    success = "'新增了用户:' + #result.get('username')",
    bizType = "用户管理",
    operateObject = "#result.get('username')"
)</span>
<span class="hljs-meta">@LogDiff(after = "#result")</span>
<span class="hljs-keyword">public</span> Map <span class="hljs-title function_">addUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String, Object&gt; params)</span> {
    <span class="hljs-comment">// 业务逻辑</span>
    <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">// 删除操作（只有操作前数据）</span>
<span class="hljs-meta">@PostMapping("/user/delete")</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-meta">@OperateLog(
    success = "'删除了用户:' + #params.get('userId')",
    bizType = "用户管理"
)</span>
<span class="hljs-meta">@LogDiff(before = "#result.get('deletedUser')")</span>
<span class="hljs-keyword">public</span> Map <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String, Object&gt; params)</span> {
    <span class="hljs-comment">// 业务逻辑</span>
    <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">// 更新操作（有前后数据）</span>
<span class="hljs-meta">@PostMapping("/user/update")</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-meta">@OperateLog(
    success = "'更新了用户:' + #result.get('username')",
    bizType = "用户管理"
)</span>
<span class="hljs-keyword">public</span> Map <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String, Object&gt; params)</span> {
    <span class="hljs-comment">// 通过上下文设置前后数据</span>
    AuditLogContextUtil.set(AuditLogContextUtil.CONTEXT_KEY_BEFORE_OBJECT, beforeUser);
    AuditLogContextUtil.set(AuditLogContextUtil.CONTEXT_KEY_AFTER_OBJECT, afterUser);
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h2 data-id="heading-11">6. SpEL 表达式支持</h2>
<p>组件支持 Spring SpEL 表达式，常用变量如下：</p>






























<table><thead><tr><th>变量</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>#params</code></td><td>方法参数</td><td><code>#params.get('username')</code></td></tr><tr><td><code>#result</code></td><td>方法返回值</td><td><code>#result.get('id')</code></td></tr><tr><td><code>#error</code></td><td>异常对象</td><td><code>#error.message</code></td></tr><tr><td><code>#operateObject</code></td><td>操作对象</td><td><code>#operateObject</code></td></tr></tbody></table>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@OperateLog(
    success = "'操作人:' + #params.get('operator') + ' 处理了订单:' + #result.get('orderId')",
    bizType = "订单管理",
    operateObject = "#result.get('orderId')"
)</span>
</code></pre>
<h2 data-id="heading-12">7. 上下文工具类</h2>
<p><code>AuditLogContextUtil</code> 提供上下文管理功能，用于在代码中设置自定义信息。</p>
<h3 data-id="heading-13">7.1 常用常量</h3>





































<table><thead><tr><th>常量</th><th>说明</th></tr></thead><tbody><tr><td>CONTEXT_KEY_OPERATOR</td><td>操作人</td></tr><tr><td>CONTEXT_KEY_TENANT</td><td>租户</td></tr><tr><td>CONTEXT_KEY_BEFORE_OBJECT</td><td>操作前对象</td></tr><tr><td>CONTEXT_KEY_AFTER_OBJECT</td><td>操作后对象</td></tr><tr><td>CONTEXT_KEY_OPERATE_DSL</td><td>操作 DSL</td></tr><tr><td>CONTEXT_KEY_TRACE_ID</td><td>追踪 ID</td></tr><tr><td>CONTEXT_KEY_EXT</td><td>扩展信息</td></tr></tbody></table>
<h3 data-id="heading-14">7.2 常用方法</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 设置操作人</span>
AuditLogContextUtil.set(AuditLogContextUtil.CONTEXT_KEY_OPERATOR, <span class="hljs-string">"admin"</span>);

<span class="hljs-comment">// 设置租户</span>
AuditLogContextUtil.set(AuditLogContextUtil.CONTEXT_KEY_TENANT, <span class="hljs-string">"tenant1"</span>);

<span class="hljs-comment">// 设置操作前后对象（用于差异比对）</span>
AuditLogContextUtil.set(AuditLogContextUtil.CONTEXT_KEY_BEFORE_OBJECT, beforeData);
AuditLogContextUtil.set(AuditLogContextUtil.CONTEXT_KEY_AFTER_OBJECT, afterData);

<span class="hljs-comment">// 设置自定义操作详情</span>
AuditLogContextUtil.set(AuditLogContextUtil.CONTEXT_KEY_OPERATE_DSL, customDetail);

<span class="hljs-comment">// 设置扩展信息</span>
AuditLogContextUtil.set(AuditLogContextUtil.CONTEXT_KEY_EXT, extInfo);

<span class="hljs-comment">// 设置追踪 ID</span>
AuditLogContextUtil.set(AuditLogContextUtil.CONTEXT_KEY_TRACE_ID, traceId);

<span class="hljs-comment">// 清理上下文</span>
AuditLogContextUtil.remove();
</code></pre>
<h2 data-id="heading-15">8. 使用场景示例</h2>
<h3 data-id="heading-16">8.1 简单日志记录</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/simple/log")</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-meta">@OperateLog(
    success = "'新增了:' + #params.get('flowBizNo') + ',操作结果:' + #result.get('flowBizNo')",
    bizType = "测试",
    operateObject = "#params.get('flowBizNo')"
)</span>
<span class="hljs-keyword">public</span> Map <span class="hljs-title function_">logSimple</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String, Object&gt; params)</span> {
    <span class="hljs-keyword">return</span> params;
}
</code></pre>
<h3 data-id="heading-17">8.2 带差异比对的新增操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/logWithDetail")</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-meta">@OperateLog(
    success = "'新增了:' + #params.get('flowBizNo')",
    bizType = "测试",
    operateObject = "#result.get('addObject').get('name')"
)</span>
<span class="hljs-meta">@LogDiff(after = "#result.get('addObject')")</span>
<span class="hljs-keyword">public</span> Map <span class="hljs-title function_">logWithDetail</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String, Object&gt; params)</span> {
    Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    Map&lt;String, Object&gt; addObject = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    addObject.put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"张三"</span>);
    addObject.put(<span class="hljs-string">"age"</span>, <span class="hljs-number">25</span>);
    result.put(<span class="hljs-string">"addObject"</span>, addObject);
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h3 data-id="heading-18">8.3 带差异比对的删除操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/logWithDelete")</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-meta">@OperateLog(
    success = "'删除了:' + #params.get('flowBizNo')",
    bizType = "测试",
    operateObject = "#result.get('deleteObject').get('name')"
)</span>
<span class="hljs-meta">@LogDiff(before = "#result.get('deleteObject')")</span>
<span class="hljs-keyword">public</span> Map <span class="hljs-title function_">logWithDelete</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String, Object&gt; params)</span> {
    Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    Map&lt;String, Object&gt; deleteObject = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    deleteObject.put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"李四"</span>);
    deleteObject.put(<span class="hljs-string">"age"</span>, <span class="hljs-number">30</span>);
    result.put(<span class="hljs-string">"deleteObject"</span>, deleteObject);
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h3 data-id="heading-19">8.4 带差异比对的更新操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/logWithUpdate")</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-meta">@OperateLog(
    success = "'更新了:' + #params.get('flowBizNo')",
    bizType = "测试",
    operateObject = "#result.get('name')"
)</span>
<span class="hljs-keyword">public</span> Map <span class="hljs-title function_">logWithUpdate</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String, Object&gt; params)</span> {
    <span class="hljs-comment">// 设置操作前数据</span>
    Map&lt;String, Object&gt; before = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    before.put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"王五"</span>);
    before.put(<span class="hljs-string">"age"</span>, <span class="hljs-number">35</span>);
    
    <span class="hljs-comment">// 设置操作后数据</span>
    Map&lt;String, Object&gt; after = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    after.put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"王五"</span>);
    after.put(<span class="hljs-string">"age"</span>, <span class="hljs-number">36</span>);
    
    AuditLogContextUtil.set(AuditLogContextUtil.CONTEXT_KEY_BEFORE_OBJECT, before);
    AuditLogContextUtil.set(AuditLogContextUtil.CONTEXT_KEY_AFTER_OBJECT, after);
    
    <span class="hljs-keyword">return</span> params;
}
</code></pre>
<h3 data-id="heading-20">8.5 自定义日志详情</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/logWithCustomDetail")</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-meta">@OperateLog(
    success = "'自定义日志详情:' + #params.get('flowBizNo')",
    bizType = "测试",
    operateObject = "#result.get('name')"
)</span>
<span class="hljs-keyword">public</span> Map <span class="hljs-title function_">logWithCustomDetail</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String, Object&gt; params)</span> {
    Map&lt;String, Object&gt; detail = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    detail.put(<span class="hljs-string">"customField1"</span>, <span class="hljs-string">"value1"</span>);
    detail.put(<span class="hljs-string">"customField2"</span>, <span class="hljs-string">"value2"</span>);
    
    AuditLogContextUtil.set(AuditLogContextUtil.CONTEXT_KEY_OPERATE_DSL, detail);
    <span class="hljs-keyword">return</span> params;
}
</code></pre>
<h3 data-id="heading-21">8.6 带扩展信息的日志</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/logWithExt")</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-meta">@OperateLog(
    success = "'自定义日志详情:' + #params.get('flowBizNo')",
    bizType = "测试",
    operateObject = "#result.get('name')"
)</span>
<span class="hljs-keyword">public</span> Map <span class="hljs-title function_">logWithExt</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String, Object&gt; params)</span> {
    AuditLogContextUtil.set(AuditLogContextUtil.CONTEXT_KEY_OPERATE_DSL, params.get(<span class="hljs-string">"detail"</span>));
    AuditLogContextUtil.set(AuditLogContextUtil.CONTEXT_KEY_EXT, params.get(<span class="hljs-string">"ext"</span>));
    <span class="hljs-keyword">return</span> params;
}
</code></pre>
<h3 data-id="heading-22">8.7 条件性日志记录</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/logConditional")</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-meta">@OperateLog(
    success = "'自定义日志详情:' + #params.get('flowBizNo')",
    bizType = "测试",
    operateObject = "#result.get('name')",
    condition = "#result.get('condition') == true"
)</span>
<span class="hljs-keyword">public</span> Map <span class="hljs-title function_">logConditional</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String, Object&gt; params)</span> {
    <span class="hljs-comment">// 只有当 condition 为 true 时才会记录日志</span>
    <span class="hljs-keyword">return</span> params;
}
</code></pre>
<h3 data-id="heading-23">8.8 嵌套线程日志</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/nestLogTest")</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-meta">@OperateLog(
    success = "'嵌套日志层级:' + #operateObject",
    bizType = "嵌套日志测试",
    operateObject = "#operateObject"
)</span>
<span class="hljs-keyword">public</span> Map <span class="hljs-title function_">nestLogTest</span><span class="hljs-params">(Long operateObject)</span> {
    <span class="hljs-comment">// 调用其他服务方法，该方法的日志会嵌套在当前日志中</span>
    demoLogService.businessLog(<span class="hljs-number">2L</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();
}
</code></pre>
<h2 data-id="heading-24">9. 数据库配置</h2>
<h3 data-id="heading-25">9.1 初始化脚本</h3>
<p>项目提供了 MySQL、SQLite、H2 三种数据库的初始化脚本：</p>
<ul>
<li>MySQL: <code>src/main/resources/init/mysql/init.sql</code></li>
<li>SQLite: <code>src/main/resources/init/sqlite/init.sql</code></li>
<li>H2: <code>src/main/resources/init/h2/init.sql</code></li>
</ul>
<h3 data-id="heading-26">9.2 配置示例</h3>
<p><strong>SQLite 配置：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">org.sqlite.JDBC</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:sqlite:./data/audit_log.db</span>
</code></pre>
<p><strong>MySQL 配置：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/demo?useUnicode=true&amp;characterEncoding=utf8</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span>
</code></pre>
<p><strong>H2 配置：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">org.h2.Driver</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:h2:./data/audit_log</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">sa</span>
    <span class="hljs-attr">password:</span> 
</code></pre>
<h2 data-id="heading-27">10. 查询接口</h2>
<h3 data-id="heading-28">10.1 分页查询日志</h3>
<pre><code class="hljs language-http" lang="http">POST /api/audit/logs/page
Content-Type: application/json

{
  "pageNum": 1,
  "pageSize": 10,
  "operator": "user1",
  "bizType": "USER",
  "startTime": 1704067200000,
  "endTime": 1704153600000
}
</code></pre>
<h3 data-id="heading-29">10.2 查询日志详情</h3>
<pre><code class="hljs language-http" lang="http">GET /api/audit/logs/detail?logId=1
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/221632c3d1264559a76177b961a57983~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YO95biC5qGD5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770558046&amp;x-signature=KKRf2w%2FLKaaffxBrJPY7r5ZPF90%3D" alt="web-view.png" loading="lazy"/></p>
<h3 data-id="heading-30">10.3 日志查询页面</h3>
<p>审计日志组件提供了配套的 Web 查询界面，访问 <code>/log.html</code> 可以使用可视化界面查询和查看日志详情。</p>
<h4 data-id="heading-31">查询条件功能</h4>
<ul>
<li><strong>业务类型筛选</strong>：根据业务类型（如"用户管理"、"订单管理"）进行筛选</li>
<li><strong>业务子类型筛选</strong>：根据业务子类型进行更细粒度的筛选</li>
<li><strong>操作人筛选</strong>：根据操作人账号进行筛选</li>
<li><strong>租户筛选</strong>：根据租户信息进行筛选</li>
<li><strong>操作结果筛选</strong>：支持选择"全部"、"成功"、"失败"</li>
<li><strong>操作对象筛选</strong>：根据操作对象进行筛选</li>
<li><strong>操作描述筛选</strong>：根据操作描述进行模糊查询</li>
<li><strong>时间范围查询</strong>（必填）：
<ul>
<li>开始时间和结束时间必须填写</li>
<li>支持快捷时间选择：
<ul>
<li>今天：00:00:00 ~ 23:59:59</li>
<li>昨天：00:00:00 ~ 23:59:59</li>
<li>前天：00:00:00 ~ 23:59:59</li>
<li>最近15分钟/30分钟/1小时/2小时/3小时/4小时/12小时/24小时</li>
</ul>
</li>
<li>时间范围限制：查询时间范围不能超过24小时</li>
</ul>
</li>
</ul>
<h4 data-id="heading-32">日志列表展示</h4>
<p>列表表格包含以下列：</p>
<ul>
<li><strong>操作人</strong>：执行操作的用户账号</li>
<li><strong>业务类型</strong>：业务分类</li>
<li><strong>操作类型</strong>：子业务类型</li>
<li><strong>操作描述</strong>：操作的描述信息</li>
<li><strong>操作对象</strong>：被操作的对象标识</li>
<li><strong>操作结果</strong>：成功（绿色标签）或失败（红色标签）</li>
<li><strong>租户</strong>：租户信息</li>
<li><strong>操作时间</strong>：操作发生的时间</li>
<li><strong>Trace ID</strong>：链路追踪ID</li>
<li><strong>异常信息</strong>：异常错误信息（如有）</li>
<li><strong>扩展信息</strong>：自定义扩展信息</li>
<li><strong>操作</strong>：查看详情按钮</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28aaa636ea144fb5bb232538efd57eb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YO95biC5qGD5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770558046&amp;x-signature=UEoac40b1rSS4vJ9i0cZBqXlst4%3D" alt="log-detail.png" loading="lazy"/></p>
<h4 data-id="heading-33">日志详情查看</h4>
<p>点击"查看详情"按钮，可查看日志的详细信息，包括：</p>
<ul>
<li>基本信息：ID、操作人、业务类型、操作描述等</li>
<li>操作结果：成功/失败状态</li>
<li>操作时间、Trace ID、异常信息、扩展信息</li>
<li>耗时(ms)：操作执行耗时</li>
<li>变更详情：支持 JSON 格式化展示和差异比对展示</li>
</ul>
<h2 data-id="heading-34">11. 最佳实践</h2>
<ol>
<li><strong>合理设置业务类型</strong>：使用规范的业务类型，便于日志分类和查询</li>
<li><strong>使用 SpEL 表达式</strong>：充分利用 SpEL 表达式动态获取关键信息</li>
<li><strong>差异比对</strong>：对于重要数据的变更，使用差异比对功能记录变更详情</li>
<li><strong>异步收集</strong>：生产环境建议开启异步收集，避免影响主业务性能</li>
<li><strong>条件记录</strong>：对于高频操作，可以使用条件表达式控制日志记录频率</li>
<li><strong>扩展信息</strong>：使用扩展信息字段记录业务相关的自定义信息</li>
</ol>
<h2 data-id="heading-35">12. 常见问题</h2>
<p><strong>Q: 日志没有记录？</strong></p>
<p>A: 检查以下几点：</p>
<ul>
<li>确保 <code>@OperateLog</code> 注解的方法被 Spring 容器管理</li>
<li>检查 <code>condition</code> 条件是否满足</li>
<li>检查是否有配置 <code>ignoreException</code> 忽略了异常</li>
</ul>
<p><strong>Q: 如何自定义差异比对逻辑？</strong></p>
<p>A: 实现 <code>ObjectDiffHandler</code> 接口，并在 <code>@LogDiff</code> 注解中指定：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@LogDiff(
    before = "#before",
    after = "#after",
    diffHandler = CustomDiffHandler.class
)</span>
</code></pre>
<p><strong>Q: 如何追踪多线程操作的日志？</strong></p>
<p>A: 使用 <code>AuditLogContextUtil</code> 的嵌套线程本地存储，组件会自动处理线程间上下文传递。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 中的同步 & 互斥]]></title>    <link>https://juejin.cn/post/7601441797118148659</link>    <guid>https://juejin.cn/post/7601441797118148659</guid>    <pubDate>2026-02-01T14:09:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601441797118148659" data-draft-id="7601486204173811762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 中的同步 &amp; 互斥"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-02-01T14:09:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SereneDream"/> <meta itemprop="url" content="https://juejin.cn/user/4250057782345273"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 中的同步 &amp; 互斥
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4250057782345273/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SereneDream
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T14:09:14.000Z" title="Sun Feb 01 2026 14:09:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这篇小记的重点偏向于 Java 的代码实现同步和互斥。</p>
<p>进程之间为什么要实现互斥：不同进程之间可能会共享某项资源。</p>
<p>进程之间为什么要实现同步：不同进程之间的操作可能会存在先后关系</p>
<p>在 OS 的学习中，同步 和 互斥 绝对是绕不过去的大山，而在 Java 中是怎样利用 OS 的同步和互斥的？是直接复用还是大胆创新？</p>
<h2 data-id="heading-0">Java 怎么实现 同步和互斥的</h2>
<p>锁（Lock）不是资源本身，锁是访问资源的“入场券”。</p>
<h3 data-id="heading-1">显式锁 - ReentrantLock - 互斥量</h3>
<p>在 Java 中可以使用 Lock.lock 对一块地方上锁（其实是 JVM 向 OS 申请了一块互斥空间/临界资源），在 Java 中，变量可以被放置到临界资源区中，这样子来实现锁</p>
<p>例如</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 1. 【抢钥匙】</span>
<span class="hljs-comment">// 这一步不是申请资源，而是“申请访问资源的权限”。</span>
<span class="hljs-comment">// 如果拿到钥匙，就进门；拿不到，就在门口排队（阻塞）。</span>
<span class="hljs-keyword">lock</span>.<span class="hljs-keyword">lock</span>(); 

<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 2. 【临界区 (Critical Section)】</span>
    <span class="hljs-comment">// 只有拿到了钥匙的线程，才能运行这几行代码。</span>
    <span class="hljs-comment">// 在这里，你可以安全地操作“临界资源”（比如 map.put, count++）。</span>
    <span class="hljs-comment">// 此时，别人进不来，因为钥匙在你兜里。</span>
    map.put(<span class="hljs-string">"key"</span>, <span class="hljs-number">1</span>); 

} <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 3. 【还钥匙】</span>
    <span class="hljs-comment">// 这一步不是把资源还给 OS（厕所还在），而是“归还权限”。</span>
    <span class="hljs-comment">// 把钥匙挂回墙上，通知门口排队的人：“我用完了，你们抢吧”。</span>
    <span class="hljs-keyword">lock</span>.unlock(); 
}
</code></pre>
<p>其实 Java 在 lock 的底层就已经实现了阻塞了，那么这个时候就有人要问了，老师老师，那我们（Condition）呢？</p>
<p>一句话总结：阻塞 不等于 释放锁。只有 Condition.await() 才能做到 “在阻塞的同时释放锁”。</p>
<p>把话说得更日常一点：你在食堂吃饭，一般来讲就是 先抢位置（抢锁） -&gt; 去打饭（调用资源） -&gt; 吃饭（使用资源） -&gt; 离开（释放资源和锁） 这一个过程</p>
<p>lock 相当于你抢了一个位置，然后在排打饭队伍，快到你了告诉你：小伙子不好意思啊，饭没了，你得等一下了，condition 的做法是你先把座位放开，让其他已经打了饭同学可以坐，然后你去等阿姨跟你说，饭好了，然后你再去抢座位，抢饭。</p>
<p>如果没有 condition，相当于阿姨跟你说没饭了，你说：那没事儿，我等等，但是座位还是你的啊，其他要吃饭的人就没座位了，那不就是占着茅坑不拉屎了吗？</p>
<h3 data-id="heading-2">隐式锁 - synchronized - 管程</h3>
<p>在 JDK 编写过程，开发者就已经给每一个对象上了一把隐式锁</p>
<p>隐式锁可以通过添加 synchronized 关键字开启</p>
<h2 data-id="heading-3">生产者 - 消费者</h2>
<p>在 OS 中，生产者-消费者问题绝对是十分经典的问题，问题描述如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db8bb9c802f141ddab9cd5d540b64ad3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770559754&amp;x-signature=dV9f7oqoED8%2BZX7BzV5F5b8gei8%3D" alt="" loading="lazy"/></p>
<p>另外，缓冲区是有空间限制的，比如缓存区只能放入 5 条数据。</p>
<p>从题目我们不难发现</p>
<ul>
<li>如果缓冲区没有满，则生产者可以往缓冲区中写入数据</li>
<li>如果缓冲区不为空，则消费者可以往缓冲区中读出数据</li>
<li>如果多个生产者同时往缓冲区的同一地方写入数据，则会导致数据覆盖</li>
<li>如果多个消费者同时往缓冲区的同一地方读出数据，则会导致数据读取异常</li>
</ul>
<p>所以</p>
<ul>
<li>缓冲区为临界资源</li>
<li>生产者/消费者之间应当存在互斥关系，即多个生产者/消费者应当互斥地访问缓冲区（互斥）</li>
<li>生产者必须在缓冲区中存在空间时才能写入数据，消费者必须在缓冲区中存在数据时才能读出数据（同步）</li>
</ul>
<p>接下来，我将使用 Java 代码进行模拟</p>
<pre><code class="hljs language-csharp" lang="csharp">import java.util.*;
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> {

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        Map&lt;String, Integer&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        <span class="hljs-comment">// 互斥信号量： 互斥操作中分发给生产者/消费者的钥匙</span>
        map.put(<span class="hljs-string">"key"</span>, <span class="hljs-number">1</span>);
        <span class="hljs-comment">// 同步信号量： 缓存区中的数据个数</span>
        map.put(<span class="hljs-string">"value"</span>, <span class="hljs-number">0</span>);
        <span class="hljs-comment">// 缓存区最大数据量</span>
        map.put(<span class="hljs-string">"size"</span>, <span class="hljs-number">5</span>);

        Lock <span class="hljs-keyword">lock</span> = <span class="hljs-keyword">new</span> ReentrantLock();
        Condition condition = <span class="hljs-keyword">lock</span>.newCondition();


        <span class="hljs-comment">// 生产者队列</span>
        Thread thread = <span class="hljs-keyword">new</span> Thread(() -&gt; {
            <span class="hljs-keyword">lock</span>.<span class="hljs-keyword">lock</span>();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 判断数据是否满了</span>
                <span class="hljs-comment">// 如果生产者发现缓存区满了，则需要阻塞等待消费者将缓存区的数据读取</span>
                <span class="hljs-keyword">while</span> (Objects.<span class="hljs-keyword">equals</span>(map.<span class="hljs-keyword">get</span>(<span class="hljs-string">"size"</span>), map.<span class="hljs-keyword">get</span>(<span class="hljs-string">"value"</span>))) {
                    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"生产者 正在阻塞自己"</span>);
                    <span class="hljs-comment">// 自己进入阻塞状态</span>
                    condition.<span class="hljs-keyword">await</span>();
                }

                <span class="hljs-comment">// 向缓存区中写入数据</span>
                System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"生产者 正在写入数据"</span>);
                Integer key = map.<span class="hljs-keyword">get</span>(<span class="hljs-string">"key"</span>);
                Integer <span class="hljs-keyword">value</span> = map.<span class="hljs-keyword">get</span>(<span class="hljs-string">"value"</span>);

                map.put(<span class="hljs-string">"value"</span>, ++<span class="hljs-keyword">value</span>);

                <span class="hljs-comment">// 唤醒其他所有线程</span>
                condition.signalAll();
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-keyword">lock</span>.unlock();
            }
        });
        thread.start();

        <span class="hljs-comment">// 消费者队列</span>
        Thread thread1 = <span class="hljs-keyword">new</span> Thread(() -&gt; {
            <span class="hljs-keyword">lock</span>.<span class="hljs-keyword">lock</span>();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 判断数据是否为空</span>
                <span class="hljs-comment">// 如果消费者发现缓存区为空，则需要阻塞等待生产者增加缓存区的数据</span>
                <span class="hljs-keyword">while</span> (Objects.<span class="hljs-keyword">equals</span>(<span class="hljs-number">0</span>, map.<span class="hljs-keyword">get</span>(<span class="hljs-string">"value"</span>))) {
                    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"消费者 正在阻塞自己"</span>);
                    <span class="hljs-comment">// 自己进入阻塞状态</span>
                    condition.<span class="hljs-keyword">await</span>();
                }

                <span class="hljs-comment">// 向缓存区中读取数据</span>
                System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"消费者 正在读取数据"</span>);
                Integer key = map.<span class="hljs-keyword">get</span>(<span class="hljs-string">"key"</span>);
                Integer <span class="hljs-keyword">value</span> = map.<span class="hljs-keyword">get</span>(<span class="hljs-string">"value"</span>);

                map.put(<span class="hljs-string">"value"</span>, --<span class="hljs-keyword">value</span>);

                <span class="hljs-comment">// 唤醒其他所有线程</span>
                condition.signalAll();
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-keyword">lock</span>.unlock();
            }
        });
        thread1.start();

    }
}
</code></pre>
<h3 data-id="heading-4">为什么阻塞部分的代码会使用 while 循环重复判断条件，而不是 if ？</h3>
<p>这与互斥机制有关系，当一个线程被唤醒2后，它需要再去抢锁，只有抢到了才能够继续向下执行（condition.await(); 代码中，线程被唤醒，然后会去抢锁），不过可能会存在一个问题，如果 线程A 被唤醒期间，线程B 已经捷足先登了，当 线程A 在找锁时 线程B 也早执行完成，早 线程A 一步把锁放回去了，那在线程A的视角里： 我被唤醒了，因为当前的条件满足了，锁也在，所以我拿上锁开始执行我的操作。但是在线程B 捷足先登之后，线程A如果就那么盲目地去执行自己的操作、修改数据，可能就会导致 OOM ，所以在这里会让 线程A 再看一遍，现在的条件到底符不符合，线程A到底能不能出去干活。</p>
<h2 data-id="heading-5">多生产者 - 多消费者</h2>
<p>多生产者 - 多消费者 问题并没有说比 生产者 - 消费者 问题难多少，无非就是增加几个判断就可以了，代码的逻辑是差不多的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64aac93200df469daa140732ce96dc7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770559754&amp;x-signature=w0aLlMpg3bvj1UaA1hibt3oX%2F8Y%3D" alt="" loading="lazy"/></p>
<p>代码实现如下</p>
<pre><code class="hljs language-scss" lang="scss">import java<span class="hljs-selector-class">.util</span>.*;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.locks</span><span class="hljs-selector-class">.Condition</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.locks</span><span class="hljs-selector-class">.Lock</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.locks</span><span class="hljs-selector-class">.ReentrantLock</span>;

<span class="hljs-comment">// 注： 这里的水果类需要自己创建</span>
public class <span class="hljs-selector-tag">Main</span> {
    public static void <span class="hljs-selector-tag">main</span>(String[] args) {
        <span class="hljs-comment">// 临界资源 - 盘子,只能放入一个水果</span>
        Queue&lt;Fruit&gt; queue = new ArrayDeque&lt;&gt;();
        Lock lock = new <span class="hljs-built_in">ReentrantLock</span>();
        Condition condition = lock<span class="hljs-selector-class">.newCondition</span>();

        Fruit apple = new <span class="hljs-built_in">Apple</span>();
        Fruit orange = new <span class="hljs-built_in">Orange</span>();
            <span class="hljs-comment">// 父亲线程</span>
            new <span class="hljs-built_in">Thread</span>(() -&gt; {
                lock<span class="hljs-selector-class">.lock</span>();
                try {
                    <span class="hljs-comment">// 判断盘子是不是空的</span>
                    while (!queue.isEmpty()) {
                        condition<span class="hljs-selector-class">.await</span>();
                    }

                    <span class="hljs-comment">// 往盘子里面放水果</span>
                    queue<span class="hljs-selector-class">.add</span>(apple);
                    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("爸爸放苹果");
                } catch (InterruptedException e) {
                    throw new <span class="hljs-built_in">RuntimeException</span>(e);
                } finally {
                    lock<span class="hljs-selector-class">.unlock</span>();
                }
            })<span class="hljs-selector-class">.start</span>();

            <span class="hljs-comment">// 母亲线程</span>
            new <span class="hljs-built_in">Thread</span>(() -&gt; {
                lock<span class="hljs-selector-class">.lock</span>();
                try {
                    <span class="hljs-comment">// 判断盘子是不是空的</span>
                    while (!queue.isEmpty()) {
                        condition<span class="hljs-selector-class">.await</span>();
                    }

                    <span class="hljs-comment">// 往盘子里面放水果</span>
                    queue<span class="hljs-selector-class">.add</span>(orange);
                    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("妈妈放橘子");
                } catch (InterruptedException e) {
                    throw new <span class="hljs-built_in">RuntimeException</span>(e);
                } finally {
                    lock<span class="hljs-selector-class">.unlock</span>();
                }
            })<span class="hljs-selector-class">.start</span>();

            <span class="hljs-comment">// 儿子线程</span>
            new <span class="hljs-built_in">Thread</span>(() -&gt; {
                lock<span class="hljs-selector-class">.lock</span>();
                try {
                    <span class="hljs-comment">// 判断盘子里是苹果吗</span>
                    <span class="hljs-built_in">while</span>(!queue.contains(apple)){
                        condition<span class="hljs-selector-class">.await</span>();
                    }

                    <span class="hljs-comment">// 吃水果</span>
                    queue<span class="hljs-selector-class">.poll</span>();
                    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("儿子吃苹果");
                } catch (InterruptedException e) {
                    throw new <span class="hljs-built_in">RuntimeException</span>(e);
                } finally {
                    lock<span class="hljs-selector-class">.unlock</span>();
                }
            })<span class="hljs-selector-class">.start</span>();

            <span class="hljs-comment">// 女儿线程</span>
            new <span class="hljs-built_in">Thread</span>(() -&gt; {
                lock<span class="hljs-selector-class">.lock</span>();
                try {
                    <span class="hljs-comment">// 判断盘子里是橘子吗</span>
                    <span class="hljs-built_in">while</span>(!queue.contains(orange)){
                        condition<span class="hljs-selector-class">.await</span>();
                    }

                    <span class="hljs-comment">// 吃水果</span>
                    queue<span class="hljs-selector-class">.poll</span>();
                    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("女儿吃橘子");
                } catch (InterruptedException e) {
                    throw new <span class="hljs-built_in">RuntimeException</span>(e);
                } finally {
                    lock<span class="hljs-selector-class">.unlock</span>();
                }
            })<span class="hljs-selector-class">.start</span>();
        
    }
}
</code></pre>
<p>运行结果如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d259271331c740a79de65b8e3d3ee294~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770559754&amp;x-signature=BNjJOIjxK47kWb5eplIZL%2B1WU3c%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">读者 - 写者</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee03081dff07419c8301d8abaafa5bf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770559754&amp;x-signature=AWVSxZTkRka5MftqnK41asx7hP0%3D" alt="" loading="lazy"/></p>
<p>读写者问题和生产消费者问题最大的不同是：</p>
<p>读者之间不存在互斥关系，而消费者之间存在互斥关系</p>
<p>说到读写者就不由自主地想到 MySQL ，MySQL 在执行中也采用了“读数据的进程可以并行，但写数据进程的必须互斥”，而且在写数据的进程在执行操作时，为了保护数据的可靠性，不允许读数据进程访问，这就是读写互斥。</p>
<p>接下来我将使用 Java 代码进行模拟，这里有一个额外的注意点：锁可以有很多把</p>
<p>首先：</p>
<p>写者与其他任何人都是互斥关系</p>
<p>而读者进程与读者进程之间并不互斥</p>
<p>所以我们可以使用 count 来记录当前是否有读者在读，当 count 为 0 时解锁</p>
<pre><code class="hljs language-scss" lang="scss">import java<span class="hljs-selector-class">.util</span>.*;

import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.locks</span><span class="hljs-selector-class">.Condition</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.locks</span><span class="hljs-selector-class">.Lock</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.locks</span><span class="hljs-selector-class">.ReentrantLock</span>;

public class <span class="hljs-selector-tag">Main</span> {
    <span class="hljs-comment">// 写者锁，写者与其他人之间都需要互斥</span>
    static Lock writer_lock = new <span class="hljs-built_in">ReentrantLock</span>();
    static Condition writer_condition = writer_lock<span class="hljs-selector-class">.newCondition</span>();

    <span class="hljs-comment">// 读者锁，锁住的并不是读者，锁住的是读者数量，读者对于修改数量是互斥的，但是对于访问文章是并发的</span>
    static Lock reader_lock = new <span class="hljs-built_in">ReentrantLock</span>();
    static Condition reader_condition = reader_lock<span class="hljs-selector-class">.newCondition</span>();

    <span class="hljs-comment">// 防写者进程饿死锁/写者进程优先锁</span>
    static Lock writer_before = new <span class="hljs-built_in">ReentrantLock</span>();
    static Condition writer_before_condition = writer_before<span class="hljs-selector-class">.newCondition</span>();

    <span class="hljs-comment">// 记录当前临时空间内是否有人</span>
    static Queue&lt;Integer&gt; queue = new ArrayDeque&lt;&gt;();
    <span class="hljs-comment">// 记录读者数量</span>
    static Integer count = <span class="hljs-number">0</span>;

    public static void <span class="hljs-selector-tag">main</span>(String[] args) {
        <span class="hljs-comment">// 写者进程</span>
        new <span class="hljs-built_in">Thread</span>(() -&gt; {
            writer_before<span class="hljs-selector-class">.lock</span>();
            writer_lock<span class="hljs-selector-class">.lock</span>();
            try {
                <span class="hljs-comment">// 写文章。。。</span>
                queue<span class="hljs-selector-class">.add</span>(<span class="hljs-number">1</span>);
                
                System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(Thread.currentThread()<span class="hljs-selector-class">.getName</span>() + " 正在写书...");
                Thread<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">2000</span>);
            } catch (InterruptedException e) {
                throw new <span class="hljs-built_in">RuntimeException</span>(e);
            } finally {
                queue<span class="hljs-selector-class">.poll</span>();
                writer_lock<span class="hljs-selector-class">.unlock</span>();
                writer_before<span class="hljs-selector-class">.unlock</span>();
            }
        })<span class="hljs-selector-class">.start</span>();

        <span class="hljs-comment">// 读者进程</span>
        new <span class="hljs-built_in">Thread</span>(() -&gt; {
            <span class="hljs-comment">// 如果有写者在排队，读者就进不来</span>
            writer_before<span class="hljs-selector-class">.lock</span>();
            writer_before<span class="hljs-selector-class">.unlock</span>();

            <span class="hljs-comment">// 对 count 的操作只允许一个读者一个读者地来</span>
            reader_lock<span class="hljs-selector-class">.lock</span>();
            try {
                if (count == <span class="hljs-number">0</span>) {
                    <span class="hljs-comment">// 如果是第一个读者，需要把写者的锁拿上，因为写者与所有人互斥</span>
                    writer_lock<span class="hljs-selector-class">.lock</span>();
                }

                <span class="hljs-comment">// 登记人数</span>
                count++;
            } finally {
                reader_lock<span class="hljs-selector-class">.unlock</span>();
            }

            System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(Thread.currentThread()<span class="hljs-selector-class">.getName</span>() + " 正在读书...");
            try {
                Thread<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">2000</span>);
            } catch (Exception e) {
            }

            <span class="hljs-comment">// 读者完成读书操作后的 count-- 操作也需要互斥</span>
            reader_lock<span class="hljs-selector-class">.lock</span>();
            try {
                count--;
                if (count == <span class="hljs-number">0</span>) {
                    <span class="hljs-comment">// 当没有人在访问文章时，把写者进程的锁还回去</span>
                    writer_lock<span class="hljs-selector-class">.unlock</span>();
                }
            } finally {
                reader_lock<span class="hljs-selector-class">.unlock</span>();
            }
        })<span class="hljs-selector-class">.start</span>();
    }
}
</code></pre>
<p>其中容易混淆的是：</p>
<p>读者对于 count （人数的改变是互斥的），但是对于读书（其他不改变临界资源的操作）是并发的</p>
<h3 data-id="heading-7">高并发缓存</h3>
<p>其实在底层跟读写者问题是一样的，核心点在于：</p>
<ul>
<li>读者不会更改临界资源</li>
</ul>
<p>当缓存被获取的时候所有线程都可以并发访问缓存区的内容，</p>
<p>但当缓存区的内容被修改时只能有一个进程在进行操作，</p>
<p>这与读写者问题完全一样！</p>
<h2 data-id="heading-8">管程</h2>
<h3 data-id="heading-9">管程是什么？</h3>
<p>管程的目的是：为了实现各个进程对于共享资源的互斥或同步</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcfcaca5c630492b88cf3f09c41a7a35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770559754&amp;x-signature=OQWSjqiqlRws6VWsUkuYU6sgyRM%3D" alt="" loading="lazy"/></p>
<p>管程在面向对象中可以理解成：</p>
<ul>
<li>将共享资源封装在对象中</li>
<li>在对象内部增加对应的需求方法</li>
<li>在构造函数中对该共享资源进行初始化</li>
<li>对外公开方法，方法内部实现同步|互斥</li>
</ul>
<h4 data-id="heading-10">管程的基本特征为</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95cef4d08f894f4cb8d35efb02064690~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770559754&amp;x-signature=MMIy2Xim8pBJHKVN39%2FvdLnfenI%3D" alt="" loading="lazy"/></p>
<p>在面向对象中可以理解成：</p>
<ul>
<li>对象中的临界资源只有该对象有权利访问</li>
<li>只能使用对象公开的方法访问对象的属性（临界资源）</li>
<li>第三点就是字面意思了</li>
</ul>
<h3 data-id="heading-11">synchronized</h3>
<p>Java 中的加锁通常使用的是 synchronized，而这个机制就很类似与管程，同一时间访问 synchronized 访问的线程只能有一个</p>
<h2 data-id="heading-12">哲学家问题</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d72114c720104225bb07edf875a475fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770559754&amp;x-signature=RVla9zeLnTAx0%2FN4TRTS0DnqYI8%3D" alt="" loading="lazy"/></p>
<p>哲学家问题的难点在于一个线程需要同时拥有两个临界资源才能进行下一步操作，如果五位哲学家同时拿起一根筷子就会产生死锁！</p>
<p>哲学家问题的重点是避免死锁，什么情况下会产生死锁？</p>
<ul>
<li>互斥：某种资源一次只允许一个进程访问，即该资源一旦分配给某个进程，其他进程就不能再访问，直到该进程访问结束。</li>
<li>占有且等待：一个进程本身占有资源（一种或多种），同时还有资源未得到满足，正在等待其他进程释放该资源。</li>
<li>不可抢占：别人已经占有了某项资源，你不能因为自己也需要该资源，就去把别人的资源抢过来。</li>
<li>循环等待：存在一个进程链，使得每个进程都占有下一个进程所需的至少一种资源。</li>
</ul>
<h3 data-id="heading-13">解决方案</h3>
<p>包括但不限于：</p>
<ol>
<li>最多只允许 4 名哲学家同时吃饭，</li>
<li>给每一位哲学家编号，要求奇数号哲学家必须先拿左边的筷子再拿右边的筷子，偶数相反</li>
<li>一次只允许一个哲学家进行“拿筷子”这个行为</li>
</ol>
<p>我这里使用 Java 实现第三个方案</p>
<p>这里只以第一个哲学家的实现为例子</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.locks.Condition;
<span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;
<span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;
<span class="hljs-comment">// 为了演示代码简洁，这里模拟的是第 0 号哲学家的视角</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> {
    <span class="hljs-comment">// 只有拿到这个锁的哲学家才能拿放筷子</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">canEat_lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
    <span class="hljs-keyword">static</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">canEat_condition</span> <span class="hljs-operator">=</span> canEat_lock.newCondition();

    <span class="hljs-comment">// 记录当前的 5 根筷子,筷子如果存在，则标注为 1</span>
    <span class="hljs-keyword">static</span> Integer[] chops = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>[]{<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>};

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 有 5 个哲学家，每个哲学家都只能拿自己左边 i 和右边 i+1==5?i=0:i+=1 的筷子</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            canEat_lock.lock();
            <span class="hljs-keyword">try</span>{
                <span class="hljs-comment">// 抢到这个锁的哲学家可以看一下自己的两边有没有筷子</span>
                <span class="hljs-comment">// 当一位哲学家左右的筷子有其中一只不在时，进入阻塞并归还锁</span>
                <span class="hljs-keyword">while</span> (chops[<span class="hljs-number">0</span>] == <span class="hljs-number">0</span> || chops[<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>) {
                    canEat_condition.await();
                }

                chops[<span class="hljs-number">0</span>]--;
                chops[<span class="hljs-number">1</span>]--;
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
            } <span class="hljs-keyword">finally</span> {
                canEat_lock.unlock();
            }

            <span class="hljs-comment">// 哲学家在吃饭。。。</span>
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">2000</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
            }

            canEat_lock.lock();
            <span class="hljs-keyword">try</span>{
                chops[<span class="hljs-number">0</span>]++;
                chops[<span class="hljs-number">1</span>]++;
                canEat_condition.signalAll();
            } <span class="hljs-keyword">finally</span> {
                canEat_lock.unlock();
            }
        }).start();
    }
}
</code></pre>
<h2 data-id="heading-14">总结</h2>
<p>在我看来，复杂的应该是每个角色之间的联系（同步），以及与临界资源的访问（互斥）的逻辑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[13 万人收藏的 Openclaw 登顶GitHub No.1！附上超绝性价比部署指南！(保姆级)]]></title>    <link>https://juejin.cn/post/7601435429409423394</link>    <guid>https://juejin.cn/post/7601435429409423394</guid>    <pubDate>2026-02-02T01:56:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601435429409423394" data-draft-id="7601384029611540495" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="13 万人收藏的 Openclaw 登顶GitHub No.1！附上超绝性价比部署指南！(保姆级)"/> <meta itemprop="keywords" content="GitHub,人工智能,开源"/> <meta itemprop="datePublished" content="2026-02-02T01:56:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开源星探"/> <meta itemprop="url" content="https://juejin.cn/user/2977915149494248"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            13 万人收藏的 Openclaw 登顶GitHub No.1！附上超绝性价比部署指南！(保姆级)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2977915149494248/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开源星探
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T01:56:20.000Z" title="Mon Feb 02 2026 01:56:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ClawdBot 又改名了：Clawdbot -&gt; Mlotbot -&gt; Openclaw，这次的名字应该是比较产品化的名称了，而且所有服务及命令行也都更改掉了。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c59684892cd841e3a5d3cfe0118b140d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=85tvXKYgyKCXHKawRXlAT1ppKic%3D" alt="" loading="lazy"/>
如今 GitHub 上 Star 数即将破 13 万人次（写文章时已到127K），同时登上了 GitHub Trending 日榜、周榜、月榜三个TOP1。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0cbf313692a466aa5cfde5258b1ec24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=d9XgMJhAA806O8I1Mqi0rxJExG8%3D" alt="" loading="lazy"/>
所以哪怕一周过去了，我每天还是能够刷到各种各样的 openclaw（原clawdbot）搭配各种服务器、各种应用的部署教程。</p>
<p>看了这么多部署方案，我发现 <strong>GitHub Codespaces</strong> 这个方案是性价比最高的，可以说几乎不用花一分钱就能体验到 clawdbot 的快乐。</p>
<p>只要你有一个 GitHub 账号即可，即使没有也可以很轻松的注册一个。</p>
<p>**GitHub Codespaces **就相当于一个 GitHub 的云端环境，每个账号都会有，而且配置还不低，因为我们之前用轻量云服务或VPS大都选择2核2G内存的，而 **Codespaces **直接送你2核8G内存、32G硬盘的云服务器。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c394624dc6c84ba28e74673637704985~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=RnHhj91Y03UQQg5Wbpf3S8Eq%2B48%3D" alt="" loading="lazy"/>
接下来就带大家一步步通过 **GitHub Codespaces **搭建一个完全零成本的 OpenClaw（clawdbot）服务。</p>
<p>其中主模型使用最新的国产 <strong>Kimi K2.5</strong>，即时聊天应用这次选择 <strong>Discord</strong>。</p>
<h3 data-id="heading-0">创建 GitHub Codespaces</h3>
<h4 data-id="heading-1"><strong>新建项目仓库</strong></h4>
<p>我们需要在 GitHub 上新建一个项目仓库。打开 GitHub 主页，点击右上角“+”号，选择“New repository”。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8084695cf6bc4ac8afb3df445517f900~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=O18ZjqU%2By2SADmPPfe3pUimkPvY%3D" alt="" loading="lazy"/>
然后给新仓库起个名称，这个可以随便起，我这里起的是 openclaw-space，其他参数不用管，直接点击“Create repository”。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5994ee8f49df4a6eb571d7efec51c4e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=DrMuWswlEWrz3X0QEIswC4NEwRQ%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-2"><strong>创建 Codespace</strong></h4>
<p>仓库创建好，会跳转到仓库空页面，我们直接点击页面左边的“<strong>Create a codespace</strong>”。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5498c8066be6409693ccb80a8118c81d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=UuAYDCVl7hUMbNQmK7CiJpQfk6s%3D" alt="" loading="lazy"/>
然后会跳转到 Create codespaces 页面，点击 “<strong>Create new codespace</strong>”。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/440dd47b3cd146ac9502601b8cf50557~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=lCPetNNajHdpBDIUpeJsUalg698%3D" alt="" loading="lazy"/>
等待新页面刷新完成，你会看到一个类似 VS Code 的Web页面，到这里就说明Codespace云端主机已经开机了。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e0b3b0600c0460390d104ef345dfeb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=efUJwcEveQj38y9UgloQY7KXKHY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">一键安装 openclaw（clawdbot）</h3>
<p>云端环境准备好了，接下来就是安装我们的主角 openclaw。</p>
<p>把 Codespaces 就当成 VScode IDE，打开下方终端，直接粘贴官方的一键安装命令。</p>
<pre><code class="hljs language-arduino" lang="arduino">curl -fsSL https:<span class="hljs-comment">//openclaw.ai/install.sh | bash</span>
</code></pre>
<p>大家发现原有的 clawdbot 字符画也变为 openclaw 了，而且这次安装等待的时间很短，估计只有两三分钟就完成安装了。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9ca424bd11844deaded4ae9c6da02c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=Nw3iW%2FxjPQtvnik4GdSB%2FisnObE%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">Kimi K2.5 模型API准备</h4>
<p>我这里为了验证效果，模型还是选择了这两天比较热门的 Kimi K2.5，这个模型也是有薅羊毛的途径的，比如英伟达官方是免费使用的，不过延迟有点高。</p>
<p>所以还是花了一个包子钱，买了个七天体验卡。直接在 Kimi 官网页面 kimi-code 下就可以看到。</p>
<p>kimi-code：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kimi.com%2Fcode" target="_blank" title="https://www.kimi.com/code" ref="nofollow noopener noreferrer">www.kimi.com/code</a>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46ad9c41a04a4c7b892b80901cc364f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=xyN3QL%2B7g%2BLLMeFRXC4R5Xspakw%3D" alt="" loading="lazy"/>
订阅后就是 K2.5 模型，然后我们创建一个 API-Key 并保存起来。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8c3abb18f414d30891f7609217434ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=6fIArwVZmk4BBghrg2iEJAJFq%2FU%3D" alt="" loading="lazy"/>
模型准备就绪后，我们就回到 codespaces 里，继续我们的配置向导。</p>
<h4 data-id="heading-5">模型配置</h4>
<p>继续往下走，选择同意协议（Yes），模式选择快速开始（Quick Start），模型我们就直接选择月之暗面（Moonshot AI）的模型，然后再选择Kimi Code（K2.5）的API，复制粘贴刚刚创建的 API Key。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0f5bd9efa3342f1a29bed87d1f0e3f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=%2Fn1%2FoWL8kqbLFMG9ApZ02Ibul4Y%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-6">Discord 配置</h4>
<p>继续选择 Channel 应用，这里我们直接选择了 Discord，然后根据它的提示来继续往下走，可以看到它需要一个 Discord Bot Token 才能继续。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0da23c71ad1b4164b7d95b6d11367c1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=UFWKKlhQiZhOU6UjKNHRh5EuNnI%3D" alt="" loading="lazy"/>
如果你没有 Discord 账号，需要先注册一个（discord.com）。</p>
<p>完成后，打开 Discord 开发者平台，点击 <strong>New Application</strong>，输入 Bot 名称，同意条款后点击创建。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.com%2Fdevelopers%2Fapplications" target="_blank" title="https://discord.com/developers/applications" ref="nofollow noopener noreferrer">discord.com/developers/…</a>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc73b1396a0644b9870a939eca4466ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=4yWDCkSSGS0vP%2B3jRUOlFtk8P10%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a098df3215d64ab4a04b187dfaf74fa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=VgFaZhJ8M4FLDN1IuNe4391z8uQ%3D" alt="" loading="lazy"/>
点击创建后，会跳转到新页面，我们点击左侧 Bot 标签。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d20630c19ab4aa285a9a5849a50f74f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=A%2F6O9u6CpbLU7CNUKRnZ%2BE1QxDI%3D" alt="" loading="lazy"/>
下拉，点击 <strong>Reset Token <strong>生成一个Token，这个就是 openclaw 连接 Discord 所需要的 Token。（需要妥善保存，泄露会导致 Bot 被滥用）
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/571294d5071540d18d4defe829060ac5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=nyuixzVcVHC3wutWrCkRpVzabIk%3D" alt="" loading="lazy"/>
然后开启关键权限（必做，否则 openclaw 无法读取消息 / 发送回复），下滑到 <strong>Privileged Gateway Intents</strong>，开启</strong>MESSAGE CONTENT INTENT</strong>（读取消息内容）、<strong>SERVER MEMBERS INTENT</strong>（可选，用于服务器成员权限控制）。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d7ea1b1a6b54c9da61de3b66364e0f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=el4%2BhxHIS68IqjLApOXOMS7vbEQ%3D" alt="" loading="lazy"/>
再点击左侧 **OAuth2 **→ <strong>OAuth2 URL Generator</strong>，勾选以下权限：</p>
<p>Scopes：<strong>bot、applications.commands</strong>；
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40aa6ec3a6b5494dab1eba834bb28c55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=b0AqkFzivwOp7qmy6zTl1kmcZRQ%3D" alt="" loading="lazy"/>
再下滑到 <strong>Bot Permissions</strong> 权限，勾选以下权限：<strong>Send Messages、Read Message History、Embed Links、Use Slash Commands</strong>；
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b6e1360887c47f287884e0e0064013f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=cltGZeoIfjtqIK106cOGPh3Py%2FI%3D" alt="" loading="lazy"/>
下滑到页面最底部，复制生成的URL链接。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8475575424f459ab454812083173911~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=SW6idEeBBxWVx0zHwM3EFcYv4bk%3D" alt="" loading="lazy"/>
将其复制出来并在浏览器中打开，将 Bot 邀请到你的 Discord 服务器（需服务器管理员权限）。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/280a8483637443f496b631afa19d8169~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=9Xjdor8E82BDuTMRmjY4qf6QAaM%3D" alt="" loading="lazy"/>
点击继续后进行授权，即可邀请bot（OpenClawBot）加入：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c095376895104c9b8dc83044536696ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=xFrOaa%2BU8GUaH0xl2PU0fNRf2b8%3D" alt="" loading="lazy"/>
打开我们自己的Discord服务器主对话框内，你就发现刚刚添加的 <strong>OpenClawBot</strong> 已经显示了，不过是离线状态。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeb15091f00b48b7b1fe2a83d41c2d17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=TVMgjtQod5A5QqHr75qyNcN%2F%2F%2FY%3D" alt="" loading="lazy"/>
然后回到配置向导里面，将之前的Token复制粘贴到输入区。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31de88f21ac64439b2d8c33319e485fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=PS16fH%2BqVrjjj24RITjKcfd8slU%3D" alt="" loading="lazy"/>
到这里 Discord 相关的配置已经全部完成。</p>
<p>接下来只需要把后续的配置按照向导一步步完成即可：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2283249f0554c438aa1ebffc37af724~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=zbToZnyY%2BDKVh1v%2F8u78MYe1otI%3D" alt="" loading="lazy"/>
在最后输出的内容中，把有Token的那段信息链接最好先保存下来，免得后续再去查看。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd3f68a31ee14fc9b2916b1660bc0f36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=icL6K%2F2FnKZeU6K6or6UjOB8Scc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">启动 OpenClaw</h3>
<p>现在我们就可以直接在 GitHub 云服务器（codespaces）上启动 OpenClaw 服务了。</p>
<pre><code class="hljs language-css" lang="css">openclaw gateway <span class="hljs-attr">--verbose</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a98dacd461424d8aab5d926944802f31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=GfMxP%2BybeXVYKDL7m77JSV7E21I%3D" alt="" loading="lazy"/>
启动成功后，从启动日志中我们也可以看到主模型用的Kimi-Code的模型，channel应用连接的Discord。</p>
<p>然后接下来我们回到Discord，这时候也可以发现 Discord 里刚刚还是离线状态的 Bot，已经变为在线状态了。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1e780765ff042b18620ee7941ac864f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=3Srjcb085ztTDki04qAHsfFfUQ8%3D" alt="" loading="lazy"/>
我们直接与Bot进行对话后拿到配对码（切记一定需要和OpenClawBot进行私聊！！）
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a6f51178f4f4c1ea4e2f6aa96d4f4f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=eVksZhbquE0zvh%2Brow8cQHGE7Ac%3D" alt="" loading="lazy"/>
拿到配对码后，我们回到终端，先关闭 Gateway 服务，然后粘贴并运行如下命令进行配对（把<code>替换为上图中的“Pairing code”码）：</code></p><code>
<pre><code class="hljs">openclaw pairing approve discord 
</code></pre>
<p>执行完成后再启动 OpenClaw Gateway 服务。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c626c276813848fb8a7b4a60dff6835d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=unc2fF3WkDh1PmhJCzWouqkxwGY%3D" alt="" loading="lazy"/>
最后回到Discord与Bot进行对话，如果正常回复则说明部署成功。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d53636dc4044401a186b8fdc63c6b06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=hrM6MjZjoa5PKzzpZE9s1fyEijo%3D" alt="" loading="lazy"/>
终端日志也可以看得到对话框中的输出。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07b0ec5d29c74966b9f90d1e6759dba8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=l6NC6HiQHxkep8oHxYLriVLGtp4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">常见问题答疑</h3>
<p>既然 Discord 已经成功连接上了，我们之前在本地部署是通过<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A18789%2F%3Ftoken%3Dxxx%25E6%259D%25A5%25E8%25AE%25BF%25E9%2597%25AEWeb%25E6%258E%25A7%25E5%2588%25B6%25E5%258F%25B0%25EF%25BC%258C%25E9%2582%25A3%25E4%25B9%2588%25E7%258E%25B0%25E5%259C%25A8%25E5%25A6%2582%25E4%25BD%2595%25E9%2580%259A%25E8%25BF%2587" target="_blank" title="http://localhost:18789/?token=xxx%E6%9D%A5%E8%AE%BF%E9%97%AEWeb%E6%8E%A7%E5%88%B6%E5%8F%B0%EF%BC%8C%E9%82%A3%E4%B9%88%E7%8E%B0%E5%9C%A8%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87" ref="nofollow noopener noreferrer">http://localhost:18789/?token=xxx来访问Web控制台，那么现在如何通过</a> GitHub 来访问 OpenClaw 的Web控制台呢？</p>
<p>其实也非常地简单，GitHub 其实也为我们考虑到了，它会自动识别 OpenClaw 开启的服务，并帮我们把内网端口映射到公网（入口就在“终端”旁边的“端口”那栏）。</p>
<p>我们在端口列表中找到 <strong>18789 端口，<strong>把鼠标移到转发地址的公网地址上，点击那个的“地球”图标，打开即可。（如果没有 18789 端口也可以自己添加上，我的就是自己添加上的）
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80f6e5d87afc47d29973e4875da57342~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=4%2Bj75sqffwk%2F%2BwuAqXxSKlz2ewU%3D" alt="" loading="lazy"/>
打开后你会发现有两类 1008 报错，一个是</strong>缺Token</strong>，另一个是<strong>缺配对</strong>。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0a93c201f504049b594ba8425307f3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=ntf%2BUvi4mlASHIDaDNV2PmSivPE%3D" alt="" loading="lazy"/>
我们先解决第一个问题，也就是上面截图所示的问题，缺令牌，需要认证。这是因为为了安全，Web 控制台默认开启了 Token 验证。</p>
<p>还记得之前在配置向导结束时，让大家记录的地址+Token嘛，就是那个Token，然后把它填入 Overview -&gt; Gateway Token，然后点击 Connect。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42c21b20bab84426966f99d352afbcfb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=7xXcTtAkJWgNE21p4SYabT8J3hI%3D" alt="" loading="lazy"/>
然后就会出现新的 1008 报错：disconnected (1008): pairing required。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10e15c2f3f514df2a9c78be7d89c79b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=iDET5%2FkSCIK2c8d402o7JZ8Xd8s%3D" alt="" loading="lazy"/>
这是因为 OpenClaw 检测到有新设备（你的浏览器）接入，出于安全考虑，它需要你在后台同意。(这个在上一次发的「MoltBot 接入飞书」的文章中也有写过。）</p>
<p>其实有两种方法，一种是<strong>命令行</strong>（也就是我上次用的），一种是<strong>改配置方式</strong>。</p>
<h4 data-id="heading-9">解决方式一：命令行方式</h4>
<p>回到 GitHub Codespaces 的终端，另外开启一个终端窗口，输入以下命令查看请求列表：</p>
<pre><code class="hljs">openclaw devices list
</code></pre>
<p>大家会看到一个 <strong>Pending (1)</strong> 的请求，记下第一串长长的 Request ID。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b3001ccdbe542ff97205f5e6da50a33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=SBCeoLdExl5%2FBH3AP82ZOSdaImc%3D" alt="" loading="lazy"/>
输入批准命令（把下面的 ID 换成你查到的）：</p>
<pre><code class="hljs">openclaw devices approve 0a22644c-205d-4912-a127-cbd71a4c74b8
</code></pre>
<h4 data-id="heading-10">解决方式二：改配置</h4>
<p>依旧在终端，输入下面这个命令用Vim或code打开用于验证的配置文件：</p>
<pre><code class="hljs language-javascript" lang="javascript">vim ~<span class="hljs-regexp">/.openclaw/</span>devices/pending.<span class="hljs-property">json</span>
</code></pre>
<p>找到 "silent": false 这一行，**将其false修改为true，**保存。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3d7222a39924fd7a37e4f6cff41e137~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=hv72muY61n7swTo2Yr%2BsmycfNg8%3D" alt="" loading="lazy"/>
最后回到 OpenClaw Web 控制台页面，一切都正常了（它会自动刷新状态），也没有报错信息，也没有红色的监控状态了，而且还有之前通过 Discord 对话的记录也可以在控制台看到，之后我们就可以正式的开始使用了。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/697f2713836e45e790d4fe02c1d32b82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=dh%2BRIdZNREIk7tqwBV4dtwZz3go%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">完全体 OpenClaw 任务演示</h3>
<p>一切就绪，我们可以通过 Discord（这个不光只有网页和电脑客户端，也是有手机端APP的） 来完成 7x24 小时的随时下发写邮件、梳理工作日报、自动开发脚本等任务。当然也可以进行定时任务。</p>
<blockquote>
<p>比如：最近有哪些 GitHub 开源项目很火？整理一个本周最火的开源项目清单给我。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6df94220adc437886315924e318fe9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=2ZsDG8AwqPYOpPx452Uf7Qvkqjs%3D" alt="" loading="lazy"/>
等待了一会，它就输出给我了比较详细的结果，包括项目类型、名称、Star数、开发语言、简介等等。不过 Discord 对话中对于 Markdown 格式还是不友好，我们到控制台看看，效果非常不错。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42323ae7029b4d92a36ddf068f803b17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=7LA4q4wpQRqQ0L6QIiG8Kfc3FEE%3D" alt="" loading="lazy"/>
既然在 GitHub 上，我们让它帮我们**「开发代码&amp;自动部署」**就在合适不过了。</p>
</blockquote>
<blockquote>
<p>比如：用Three.js帮我开发一个实时活动地球效果的站点。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc4f82e7669540bcbdeb7b2a1bcf4ce1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=Vc%2Fpx8fF9wCjwwyI96qANMJaUYI%3D" alt="" loading="lazy"/>
但它让我在本地部署并启动服务，那当然不可能啦。继续让它给我部署到 GitHub Pages 上。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d27ba405c5df47e4a82f4ffcbb5e6a9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=H%2FNXIcdAX%2BSe6gO5S14htKmGbeI%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f02d4115f884a3f8e443e7a5b96bc80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=IfIbBs%2FH%2F0YJw2qUxnOcbrdG1oE%3D" alt="" loading="lazy"/>
当然它不止给我推荐了 GitHub Pages 这一种方式，还有Netlify、Vercel这些主流的部署平台。由于 GitHub Pages 自动部署需要给它一定的权限，我们设置一个低权限低时限的Token然后发给 OpenClaw 帮我们自动化部署脚本。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/265132bb6d4c42b48dc8ccd21531a4e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=B6M3apEPnbQCN3Ea70B7rDv6vw0%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b7d10af68644f0988a26d36094a078d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=LoZjYRs6X9SjhC4IZ3T5e9qtsVY%3D" alt="" loading="lazy"/>
实时效果如下：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74a11f3e28ab436389f5652498ecffd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=2d4kJ7MPQ6wwMmGfvRuyJw0sCts%3D" alt="" loading="lazy"/>
效果还是非常不错的，很酷很美观。然后我们回到这个自动创建的仓库代码页面，里面也有最新的部署（Deployment）状态显示。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/033d9f1e07b346848bc259d296a18c59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=z8KTNj4ySsrTBdIexMtH5QL3qSA%3D" alt="" loading="lazy"/>
不过好像这个项目差点什么东西，就是映入眼帘的Readme.md文档。我们继续让 OpenClaw 帮我们自动生成并推送到仓库。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74e1815cf4d943b48153790da67d02b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=L4VQuuEzXyQLhF97gGsY7%2BxMYmY%3D" alt="" loading="lazy"/>
文档推送后页面：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7bf34efab60440ba82a82ea91926e6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=uMw01txLuLCRVfeIpAqDzVFncxs%3D" alt="" loading="lazy"/>
其中，文档中图片本来显示异常，让 OpenClaw 帮我处理了下，还直接优化成动态图了，给力！
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19b19e0f8f9c4cfb9e01bcd587bde7c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=oiV%2BzWqZbeTDcWp47%2B3lbHR6LWA%3D" alt="" loading="lazy"/>
到这里，大家就真正完全掌握了一个0 成本的 OpenClaw（Clawdbot）运行环境，太爽了。这应该就是目前超绝性价比的 Clawdbot 玩法了。</p>
</blockquote>
<blockquote>
<p><strong>Tips</strong>：GitHub Codespaces 是云端开发环境，长时间不操作会自动休眠。</p>
</blockquote>
<p>当然，你如果长时间不用了，可以在 CodeSpaces 页面将当前服务器给关机了也行。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18631cee120f40eda6c7ca1ec2f022f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=ndklBNtYsbpNtEDYB%2FPOIInIF0M%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">写在最后</h3>
<p>这次的模型选用Kimi K2.5，能力是毋庸置疑的。而且通过实际的一些任务跑下来，确实非常的不错。实际测试使用还是比较多的，但从 Kimi 使用额度上看感觉 7 天都用不完。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3e96b8d9bdd446b9123ecdd572fb788~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602179&amp;x-signature=YSw0%2Bh6L29eXZPL%2BIcfztPxTf24%3D" alt="" loading="lazy"/>
Openclaw 是 AI Agent 走向平民化、实用化的一个现实产物。通过它你可以完全拥有、完全掌控、甚至可自主魔改的AI 管家。</p>
<p>未来的 AI 形态，一定是 Agent（智能体）的天下。它们必须能感知环境、能使用工具、能自动规划多步任务。</p>
<blockquote>
<p>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenclaw%2Fopenclaw" target="_blank" title="https://github.com/openclaw/openclaw" ref="nofollow noopener noreferrer">github.com/openclaw/op…</a></p>
<p>案例threejs项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffanan-uyun%2Fearth-activity" target="_blank" title="https://github.com/fanan-uyun/earth-activity" ref="nofollow noopener noreferrer">github.com/fanan-uyun/…</a></p>
<p>参考教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Flqshow%2Fstatus%2F2017099124156297271%3Fs%3D20" target="_blank" title="https://x.com/lqshow/status/2017099124156297271?s=20" ref="nofollow noopener noreferrer">x.com/lqshow/stat…</a></p>
</blockquote></code></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[花了两年用遍了 React 所有状态管理库，我选出了最现代化的 Signal 方案]]></title>    <link>https://juejin.cn/post/7601384029611655183</link>    <guid>https://juejin.cn/post/7601384029611655183</guid>    <pubDate>2026-02-02T01:58:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601384029611655183" data-draft-id="7601175299011641359" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="花了两年用遍了 React 所有状态管理库，我选出了最现代化的 Signal 方案"/> <meta itemprop="keywords" content="React.js,前端,Redux"/> <meta itemprop="datePublished" content="2026-02-02T01:58:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="寅时码"/> <meta itemprop="url" content="https://juejin.cn/user/3936714046056088"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            花了两年用遍了 React 所有状态管理库，我选出了最现代化的 Signal 方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3936714046056088/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    寅时码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T01:58:25.000Z" title="Mon Feb 02 2026 01:58:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">花了两年用遍了 React 所有状态管理库，我选出了最现代化的 Signal 方案</h2>
<h3 data-id="heading-1">我知道「React 孝子」很多，先别急着骂，看完再说</h3>
<p>当你还在 <code>useState</code> 的闭包陷阱里跟 React 斗智斗勇，在 <code>useEffect</code> 依赖数组里当人肉编译器，在 Zustand 的 selector 里写到怀疑人生 —— 哥们，该换个活法了。</p>
<p><strong>Signal</strong>，来自 Preact，本质就是 Vue 那套响应式的 React 版：对象引用读写，依赖自动追踪，不用你手动喂。接入 <code>@preact/signals-react</code> 之后你就会发现，原来「现代化」三个字可以这么写，而不是靠 React 那套「设计哲学」自嗨。</p>
<hr/>
<p>我知道「React 孝子」很多，每次讨论时他们总搬出两套话：</p>
<ol>
<li>
<p><strong>「React 手动挡、Vue 自动挡，老司机都是手动挡。」</strong><br/>
纯纯的逻辑谬误。开车的手动/自动和写代码的「要不要亲手管依赖」根本不是同一回事；把「控制欲」包装成「专业」是偷换概念。这比喻的荒谬程度，不亚于班主任那句「一个人浪费一分钟，全班四十个人就浪费四十分钟」 —— 时间不能那样线性叠给全班，框架优劣也不能用「手动/自动」一个轴判死刑。</p>
</li>
<li>
<p><strong>「既然你这么讨厌 React，为什么还要用？」</strong><br/>
因为出现的早、生态繁荣，所以你必然要接触到。任何第三方前端库，第一个兼容目标都是 React；
<strong>AI First</strong> 时代更狠</p>
</li>
</ol>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Flovable.dev" target="_blank" title="https://lovable.dev" ref="nofollow noopener noreferrer">Lovable</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fv0.dev" target="_blank" title="https://v0.dev" ref="nofollow noopener noreferrer">V0.dev</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fbolt.new" target="_blank" title="https://bolt.new" ref="nofollow noopener noreferrer">Bolt.new</a></li>
</ul>
<p>这些 AI 工具一打开，全是 React。用 React 不等于认同它每一处设计 —— 历史包袱和网络效应摆在那儿，换框架成本极高，而 AI 生成代码几乎全是 React，正反馈循环只会越滚越大。所以「讨厌」和「在用」可以同时成立，不矛盾。</p>
<hr/>
<p>不可否认的是，<strong>JSX 是划时代的</strong>。</p>
<p>React 真正贡献的是：组件化、声明式 UI、单向数据流成了行业共识，后面 Vue、Svelte 的模板或语法糖，都是在「React 确立的范式」上做改进。</p>
<p>我写这篇不是为了当传教士，也不想一味骂街 —— 我只想安安静静分享自己的心得，讲述如何解决这些问题，顺便帮到被闭包和依赖数组折磨的人。</p>
<p>批评 <code>useState</code> 的闭包和 <code>useEffect</code> 的依赖数组，不等于否定整个 React；而是说<strong>这一块</strong>设计得反人类，值得用 Signal 之类的方式补上。</p>
<hr/>
<p>而且关于 React、Vue 我是有发言权的，两边源码都翻过一些，<strong>React 的很多坑我都自己填过</strong>：</p>
<ul>
<li>路由没有 Keep-Alive，就自己写 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbeixiyo%2Freact-router" target="_blank" title="https://github.com/beixiyo/react-router" ref="nofollow noopener noreferrer">github.com/beixiyo/rea…</a></li>
<li><code>useState</code> 闭包拿不到最新值，就封装 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbeixiyo%2Freact-tool%2Fblob%2Fmain%2Fpackages%2Fhooks%2Fsrc%2Fstate%2FuseGetState.ts" target="_blank" title="https://github.com/beixiyo/react-tool/blob/main/packages/hooks/src/state/useGetState.ts" ref="nofollow noopener noreferrer">github.com/beixiyo/rea…</a></li>
<li>React 19.2 之前没有官方 KeepAlive 缓存，就自己实现 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbeixiyo%2Freact-tool%2Fblob%2Fmain%2Fpackages%2Fcomps%2Fsrc%2Fcomponents%2FKeepAlive%2FKeepAlive.tsx" target="_blank" title="https://github.com/beixiyo/react-tool/blob/main/packages/comps/src/components/KeepAlive/KeepAlive.tsx" ref="nofollow noopener noreferrer">github.com/beixiyo/rea…</a></li>
</ul>
<p>不是晒仓库，而是说明：我既在 React 里干活，又亲手绕过它的坑。所以下面聊 Signal 和状态管理，是<strong>在 React 生态里怎么活得更像人</strong>的实操结论，不是跟风捧新玩意儿，也不是键盘党嘴炮。</p>
<hr/>
<h3 data-id="heading-2">一、闭包陷阱：React 的「设计哲学」有多可笑</h3>
<p><code>useState</code> 有个祖传问题：<code>setState</code> 是异步的，你刚 set 完，下一秒换个函数读，拿到的还是旧值。逻辑一拆分，后面的函数永远活在「上一个渲染周期」的梦里。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 问题：fn2 拿不到最新 count</span>
<span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">fn1</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>)
  <span class="hljs-title function_">fn2</span>() <span class="hljs-comment">// count 仍是旧值，惊不惊喜？</span>
}
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fn2</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count) <span class="hljs-comment">// 0，意不意外？</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleXx</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">fn1</span>()
  <span class="hljs-title function_">fn2</span>() <span class="hljs-comment">// 这辈子都拿不到最新值</span>
}
</code></pre>
<p>React 官方会说：这是「调度」「可预测性」「避免半成品 UI」 —— 翻译成人话就是：<strong>我让你拿不到你就是拿不到，你得按我的规矩来</strong>。一旦逻辑拆分、跨模块复用，你就得跟闭包斗智斗勇，写一堆 <code>useCallback</code>、<code>useRef</code> 来擦屁股。这叫设计哲学？这叫甩锅给开发者。</p>
<p>Signal 不跟你玩这套。状态放在<strong>对象</strong>里，<code>.value</code> 读就是当前值，写就是立刻生效。没有快照，没有「下一次渲染才更新」，读到的永远是实时的。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { signal } <span class="hljs-keyword">from</span> <span class="hljs-string">'@preact/signals-react'</span>

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">signal</span>(<span class="hljs-number">0</span>)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">fn1</span> = (<span class="hljs-params"/>) =&gt; {
  count.<span class="hljs-property">value</span> += <span class="hljs-number">1</span>
  <span class="hljs-title function_">fn2</span>() <span class="hljs-comment">// 此时 count.value 已经是 1 了</span>
}
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fn2</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count.<span class="hljs-property">value</span>) <span class="hljs-comment">// 1，终于像个正常人该有的行为</span>
}
</code></pre>
<p>暂时还得用 <code>useState</code>？行，用 <code>useGetState</code> 救个急，<code>setCount.getLatest()</code> 直接拿最新值，不用再传什么回调了。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 救急方案：useGetState</span>
<span class="hljs-keyword">import</span> { useGetState } <span class="hljs-keyword">from</span> <span class="hljs-string">'hooks'</span>

<span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useGetState</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fn2</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(setCount.<span class="hljs-title function_">getLatest</span>()) <span class="hljs-comment">// 1</span>
}
</code></pre>
<p>源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbeixiyo%2Freact-tool%2Fblob%2Fmain%2Fpackages%2Fhooks%2Fsrc%2Fstate%2FuseGetState.ts" target="_blank" title="https://github.com/beixiyo/react-tool/blob/main/packages/hooks/src/state/useGetState.ts" ref="nofollow noopener noreferrer">github.com/beixiyo/rea…</a></p>
<hr/>
<h3 data-id="heading-3">二、useEffect 依赖数组：人肉编译器，你当定了</h3>
<p><code>useEffect</code> 的依赖数组，堪称 React 开发者的噩梦：漏写一个，闭包拿旧值；</p>
<p>多写一个，<strong>effect 跑成陀螺</strong>。复杂对象还得自己 <code>useMemo</code> 包一层，不然每次都是「新引用」，依赖数组形同虚设。</p>
<p>Signal 的 <code>effect</code> 和 <code>useSignalEffect</code> 直接<strong>自动追踪</strong>你在回调里读了哪些 signal，变了才跑。跟 Vue 的 <code>watchEffect</code> 一样，该有的智商它都有。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { effect, signal } <span class="hljs-keyword">from</span> <span class="hljs-string">'@preact/signals-react'</span>

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">signal</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">const</span> name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">'Jane'</span>)

<span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count.<span class="hljs-property">value</span>, name.<span class="hljs-property">value</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'cleanup'</span>)
})
</code></pre>
<p>不用写依赖数组，不用纠结「这个到底该不该塞进 deps」，不用当人肉依赖分析器。省下来的脑子，干点别的不好吗？</p>
<hr/>
<h3 data-id="heading-4">三、Signal API 简洁，没有废话</h3>
<p>Signal 的 API 就四个：</p>
<ul>
<li><code>signal(initial)</code>：建状态</li>
<li><code>computed(fn)</code>：派生</li>
<li><code>effect(fn)</code>：副作用</li>
<li><code>batch(fn)</code>：批量写，effect 只跑一次</li>
</ul>
<p>没有 Action、Reducer、Slice，没有 Store 配置，没有中间件链。想用就写，写完就算。相比之下，下面那些「当红」库，个个都是模板代码生产器。</p>
<h4 data-id="heading-5">1. 渲染优化：直接传 signal 到 JSX，跳过组件重渲染</h4>
<p>这是 Signal 最香的用法之一。<code>count.value</code> 会建立订阅，signal 一变组件就重渲染；但<strong>直接把 signal 丢进 JSX</strong>，Preact 会绑定到 DOM 文本节点，更新时只改 DOM，不触发组件重渲染。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> countOptimized = <span class="hljs-title function_">signal</span>(<span class="hljs-number">0</span>)

<span class="hljs-comment">// ❌ 未优化：读 .value 会订阅，每次变化都重渲染</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">UnoptimizedDisplay</span> = <span class="hljs-title function_">memo</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">useSignals</span>()
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>{ countOptimized.value }<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span></span>  <span class="hljs-comment">// 变色 = 重渲染</span>
})

<span class="hljs-comment">// ✅ 优化：直接传 signal，跳过 VDOM，只更新 DOM 文本</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">OptimizedDisplay</span> = <span class="hljs-title function_">memo</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">useSignals</span>()
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span><span class="hljs-tag">&lt;&gt;</span>{ countOptimized }<span class="hljs-tag">&lt;/&gt;</span></span>&lt;<span class="hljs-regexp">/strong&gt;  /</span><span class="hljs-regexp">/ 不变色 = 无重渲染
  )
})
</span></code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1840e273a562439caaccb17b824ac546~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-F5pe256CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602669&amp;x-signature=4tnZ5C5h%2BQwnTxKApSLzsZi8gaM%3D" alt="PixPin_2026-02-02_10-03-36.webp" loading="lazy"/></p>
<p>点击 +1 时，未优化侧背景色会变（重渲染），优化侧可能不变色（直接改 DOM）。源码见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbeixiyo%2Freact-tool%2Fblob%2Fmain%2Fpackages%2Fapp%2Fsrc%2Fviews%2Fsignals%2Fcomponents%2FRenderingOptimization.tsx" target="_blank" title="https://github.com/beixiyo/react-tool/blob/main/packages/app/src/views/signals/components/RenderingOptimization.tsx" ref="nofollow noopener noreferrer">github.com/beixiyo/rea…</a></p>
<h4 data-id="heading-6">2. computed：派生状态，自动缓存</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { signal, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'@preact/signals-react'</span>

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">signal</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">const</span> doubled = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>)

<span class="hljs-comment">// doubled.value 随 count 变，依赖自动追踪，不用写 useMemo 依赖数组</span>
</code></pre>
<h4 data-id="heading-7">3. signals 原生 <code>effect</code>（推荐、最省脑）</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { signal, effect } <span class="hljs-keyword">from</span> <span class="hljs-string">'@preact/signals-react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">signal</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> doubled = <span class="hljs-title function_">signal</span>(<span class="hljs-number">0</span>)

<span class="hljs-comment">// ✅ 自动依赖收集，不写依赖数组</span>
<span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
  doubled.<span class="hljs-property">value</span> = count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>
})
</code></pre>
<p>特点一句话说明：</p>
<ul>
<li>依赖是谁，运行时自动追踪</li>
<li>读了 <code>count.value</code>，就只依赖 <code>count</code></li>
<li>重构安全，删代码=删依赖</li>
</ul>
<h4 data-id="heading-8">4. Hook 版：<code>useSignalEffect</code>（组件内用）</h4>
<p>适合<strong>必须写在组件里的副作用</strong>（比如依赖 props / 生命周期）。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { signal, useSignalEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'@preact/signals-react'</span>

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">signal</span>(<span class="hljs-number">0</span>)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ✅ 和 effect 一样：不用依赖数组</span>
  <span class="hljs-title function_">useSignalEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'count changed:'</span>, count.<span class="hljs-property">value</span>)
  })

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> count.value++}&gt;
      +1
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  )
}
</code></pre>
<p>你可以把它理解为：</p>
<blockquote>
<p><code>useEffect + 自动依赖收集 + 无 deps</code></p>
</blockquote>
<h4 data-id="heading-9">5. 对照：React <code>useEffect</code> 等价写法（反例）</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'count changed:'</span>, count)
}, [count]) <span class="hljs-comment">// ❌ 人肉维护依赖</span>
</code></pre>
<p>问题不在“能不能用”，而在：</p>
<ul>
<li>依赖要人想</li>
<li>重构容易漏</li>
<li>逻辑一复杂就开始糊 deps</li>
</ul>
<hr/>
<h4 data-id="heading-10">在线体验</h4>
<p>这是我部署的 Signal 示例 Demo，里面涵盖了几乎所有 API 用法，我就不啰嗦了，需要可以在线体验。</p>
<ul>
<li>在线体验页面 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact-tool-70q.pages.dev%2Fsignals" target="_blank" title="https://react-tool-70q.pages.dev/signals" ref="nofollow noopener noreferrer">react-tool-70q.pages.dev/signals</a></li>
<li>源码 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbeixiyo%2Freact-tool%2Fblob%2Fmain%2Fpackages%2Fapp%2Fsrc%2Fviews%2Fsignals%2Fpage.tsx" target="_blank" title="https://github.com/beixiyo/react-tool/blob/main/packages/app/src/views/signals/page.tsx" ref="nofollow noopener noreferrer">github.com/beixiyo/rea…</a></li>
</ul>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/607542abb3114354b8f285072a2fce8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-F5pe256CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602669&amp;x-signature=RfHaBvE3VOJE0ew2U6aVeMTd5NU%3D" alt="image.png" width="70%" loading="lazy"/>
<p>如果背景色变化代表重新渲染了</p>
<hr/>
<h3 data-id="heading-11">四、其他状态管理库：一个比一个离谱</h3>
<h4 data-id="heading-12">1. Zustand：Selector 写到手酸，中间件叠成屎山</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpmndrs%2Fzustand" target="_blank" title="https://github.com/pmndrs/zustand" ref="nofollow noopener noreferrer">github.com/pmndrs/zust…</a></p>
<p>Zustand 本身不算复杂，但要<strong>按需订阅</strong>避免多余渲染？对不起，每个字段自己写 selector 去吧：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">useCount</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">useStore</span>(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">count</span>)
<span class="hljs-keyword">const</span> <span class="hljs-title function_">useName</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">useStore</span>(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">name</span>)
<span class="hljs-comment">// 字段一多，selector 写到腱鞘炎</span>
</code></pre>
<p>更离谱的是<strong>中间件</strong>。persist、devtools、immer 一层套一层，套完就是这坨：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = create&lt;<span class="hljs-keyword">typeof</span> initState&gt;()(<span class="hljs-title function_">immer</span>(
  <span class="hljs-title function_">devtools</span>(
    <span class="hljs-title function_">persist</span>(
      <span class="hljs-function">() =&gt;</span> initState,
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'counter'</span>,
        <span class="hljs-attr">storage</span>: <span class="hljs-title function_">createJSONStorage</span>(<span class="hljs-function">() =&gt;</span> sessionStorage),
        <span class="hljs-attr">partialize</span>: <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(
          <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(state).<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">[key]</span>) =&gt;</span> !key.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'user'</span>))
        ),
      }
    ),
    { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span> }
  )
))
</code></pre>
<p>你觉得还能看？那是因为我特意格式化过了。真实项目里中间件一多，括号套括号，缩进套缩进，可读性直接归零。</p>
<p>这种层层嵌套的写法，纯纯一坨。你能确保每个同事代码都像我一样写得这么「讲究」？不能的话，这就是定时炸弹。</p>
<hr/>
<h4 data-id="heading-13">2. Jotai：原子化挺好，但 useAtom 要写吐了</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpmndrs%2Fjotai" target="_blank" title="https://github.com/pmndrs/jotai" ref="nofollow noopener noreferrer">github.com/pmndrs/jota…</a></p>
<p>Jotai 的原子化思路我认可，细粒度订阅、按需更新，没问题。但原版用法有个致命问题：<strong>每个 atom 都得单独 <code>useAtom</code> / <code>useAtomValue</code></strong>，组件顶上一排 hook，字段一多直接爆炸。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useAtom</span>(countAtom)
<span class="hljs-keyword">const</span> [name, setName] = <span class="hljs-title function_">useAtom</span>(nameAtom)
<span class="hljs-keyword">const</span> [age, setAge] = <span class="hljs-title function_">useAtom</span>(ageAtom)
<span class="hljs-comment">// 再来十个字段？继续往上叠呗</span>
</code></pre>
<p>而且为了性能你得保证原子性，基础属性都得拆成独立 atom，每个组件每个属性都得来一遍 <code>useAtom</code>，繁琐到令人发指。</p>
<h5 data-id="heading-14">解决办法</h5>
<p>我自己封装了 jotaiTool <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbeixiyo%2Freact-tool%2Fblob%2Fmain%2Fpackages%2Fapp%2Fsrc%2Fviews%2FjotaiTest%2FjotaiTool%2Findex.ts" target="_blank" title="https://github.com/beixiyo/react-tool/blob/main/packages/app/src/views/jotaiTest/jotaiTool/index.ts" ref="nofollow noopener noreferrer">github.com/beixiyo/rea…</a></p>
<p>通过 <code>createUseAtoms</code> 传入 atom 对象，自动生成 <code>useAtoms</code>、<code>getAtoms</code>、<code>useReset</code>、<code>createReset</code> 等，按需订阅、类型安全、组件外也能读写。算是给 Jotai 提供了点语法糖。</p>
<p>实现原理是通过 Proxy 返回，并且确保细粒度订阅和类型安全，支持 Reset 等高级特性。所有功能均以测试</p>
<p>我部属到了 CloudFlare，在线体验到 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact-tool-70q.pages.dev%2FjotaiTest" target="_blank" title="https://react-tool-70q.pages.dev/jotaiTest" ref="nofollow noopener noreferrer">react-tool-70q.pages.dev/jotaiTest</a></p>
<p>如果背景色变化代表重新渲染了</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c0742a1f0e14e44bd7299e45cd000f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-F5pe256CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602669&amp;x-signature=h8l3hxtPziiqTct7dmFhclnUzKU%3D" alt="image.png" width="70%" loading="lazy"/>
<p><strong>示例</strong>：定义 atom 对象后调用 <code>createUseAtoms</code>，在组件里用 <code>useAtoms()</code> 拿到一个代理对象，直接读属性、写属性或调 <code>setXxx</code>，下划线开头的 key 会被自动过滤。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a4f1e1441c94d57888932fb3ae03c0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-F5pe256CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602669&amp;x-signature=ns5rlNbtt4ftWYzXcbDzW1HZlms%3D" alt="image.png" loading="lazy"/></p>
<p>更多用法（含按需 selector、useReset、createReset）见仓库内 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbeixiyo%2Freact-tool%2Fblob%2Fmain%2Fpackages%2Fapp%2Fsrc%2Fviews%2FjotaiTest%2Fpage.tsx" target="_blank" title="https://github.com/beixiyo/react-tool/blob/main/packages/app/src/views/jotaiTest/page.tsx" ref="nofollow noopener noreferrer">github.com/beixiyo/rea…</a></p>
<p>即便如此，你还是得理解 atom、selector、store 这一堆概念。Signal 呢？一个对象，<code>.value</code> 读写，完事。</p>
<hr/>
<h4 data-id="heading-15">3. Recoil：Jotai 的低配版，还要自己写 key</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frecoiljs.org%2Fdocs%2Fintroduction%2Fgetting-started" target="_blank" title="https://recoiljs.org/docs/introduction/getting-started" ref="nofollow noopener noreferrer">recoiljs.org/docs/introd…</a></p>
<p>和 Jotai 思路差不多，但每个 atom 都得手写唯一 key，既啰嗦又容易冲突。Recoil 还要你自己想字符串。太蠢了，不说了。</p>
<hr/>
<h4 data-id="heading-16">4. Valtio：曾经的最爱，但是有些问题无法解决</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fvaltio.dev%2F" target="_blank" title="https://valtio.dev/" ref="nofollow noopener noreferrer">valtio.dev/</a></p>
<p>Valtio 用起来是真的爽，<code>proxy</code> 一包，改属性自动更新，Vue 那味。但有两个硬伤直接劝退：</p>
<ol>
<li><strong><code>snap</code> 返回 readonly</strong>，类型别扭得要死，和「改完直接用」的习惯完全不搭，类型安全天天跟你打架。</li>
<li><strong>input 组件有 bug</strong>，必须开 sync 模式才能正常用。底层和 React 的批量更新八字不合，这都能出问题，我也是服了。</li>
</ol>
<hr/>
<h4 data-id="heading-17">5. Redux：沉浸式屎山，LSP 都救不了</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fredux.js.org%2F" target="_blank" title="https://redux.js.org/" ref="nofollow noopener noreferrer">redux.js.org/</a></p>
<p>Redux 的「单向数据流」「可预测」「规范化」 —— 翻译过来就是：<strong>写一堆 Action、Reducer、Slice、Middleware，模板代码堆成山</strong>。实现成本高到离谱，还衍生出了 Redux Toolkit 这个「简化版」屎山。懂的都懂。</p>
<p>最离谱的是<strong>找代码</strong>。你想找「用户列表」的数据定义在哪？Ctrl+点击、F12 跳转、LSP 智能导航 —— 通通没用。你只能看到一堆 Action、Reducer、Slice，真正的数据定义藏得跟谍战片一样。<strong>写这个库的人是不是不知道什么叫 LSP？</strong> 找代码纯靠全局搜索是吧？什么年代了，开发体验还停留在文本搜索时代，真是没救了。</p>
<hr/>
<h3 data-id="heading-18">五、React：2026 年了，还缺这缺那</h3>
<p>React 19.2 终于上了 Keep-Alive，这么多年来难得干了件人事。但问题是：<strong>2025 年才上</strong>。这么基础的能力，社区自己 hack 了多少年？现在才官方支持，早干嘛去了。</p>
<p>目前 React 生态还缺啥：</p>
<ol>
<li>
<p><strong>官方好用的状态管理</strong>：Signal 这种「对象引用 + 自动依赖」才是现代前端的该有的样子。<code>useState</code> 的闭包陷阱、<code>useEffect</code> 的依赖数组，早该被扫进历史垃圾堆了。别让开发者再写屎山了。</p>
</li>
<li>
<p><strong>官方 Router</strong>：第三方路由全都没 Keep-Alive。复杂应用只能自己造轮子，恶心到家了。所以我只能自己写一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbeixiyo%2Freact-router" target="_blank" title="https://github.com/beixiyo/react-router" ref="nofollow noopener noreferrer">github.com/beixiyo/rea…</a></p>
<p><strong>内置页面缓存（Keep-Alive）</strong>，LRU 策略 + <code>include</code>/<code>exclude</code> 白名单，再也不用切个 Tab 回来表单全丢。顺带还有全局守卫 <code>beforeEach</code>/<code>afterEach</code>、Vue 风格中间件、全局 <code>navigate</code>/<code>replace</code>/<code>back</code>，API 简洁无废话。</p>
</li>
</ol>
<p>代码示例：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbeixiyo%2Freact-router%2Fblob%2Fmain%2Fsrc%2Froutes%2Findex.tsx" target="_blank" title="https://github.com/beixiyo/react-router/blob/main/src/routes/index.tsx" ref="nofollow noopener noreferrer">github.com/beixiyo/rea…</a></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { lazy } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RouterProvider</span>, createBrowserRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'@jl-org/react-router'</span>

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createBrowserRouter</span>({
  <span class="hljs-attr">routes</span>: [
    { <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/home'</span>)) },
    {
      <span class="hljs-attr">path</span>: <span class="hljs-string">'/dashboard'</span>,
      <span class="hljs-attr">component</span>: <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/dashboard'</span>)),
      <span class="hljs-attr">meta</span>: { <span class="hljs-attr">title</span>: <span class="hljs-string">'Dashboard'</span>, <span class="hljs-attr">requiresAuth</span>: <span class="hljs-literal">true</span> },
    },
    { <span class="hljs-attr">path</span>: <span class="hljs-string">'/list'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/list'</span>)) },
  ],
  <span class="hljs-attr">options</span>: {
    <span class="hljs-comment">// 页面缓存：只缓存指定路径，最多 5 个页面，LRU 淘汰</span>
    <span class="hljs-attr">cache</span>: {
      <span class="hljs-attr">limit</span>: <span class="hljs-number">5</span>,
      <span class="hljs-attr">include</span>: [<span class="hljs-string">'/'</span>, <span class="hljs-string">'/dashboard'</span>, <span class="hljs-string">'/list'</span>],  <span class="hljs-comment">// 白名单，也可用 RegExp</span>
    },
    <span class="hljs-attr">beforeEach</span>: <span class="hljs-keyword">async</span> (to, _from, next) =&gt; {
      <span class="hljs-keyword">if</span> (to.<span class="hljs-property">meta</span>?.<span class="hljs-property">requiresAuth</span> &amp;&amp; !<span class="hljs-title function_">getUser</span>()) {
        <span class="hljs-title function_">next</span>(<span class="hljs-string">'/login'</span>)
        <span class="hljs-keyword">return</span>
      }
      <span class="hljs-title function_">next</span>()
    },
    <span class="hljs-attr">afterEach</span>: <span class="hljs-function">(<span class="hljs-params">to</span>) =&gt;</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = (<span class="hljs-keyword">typeof</span> to.<span class="hljs-property">meta</span>?.<span class="hljs-property">title</span> === <span class="hljs-string">'string'</span> ? to.<span class="hljs-property">meta</span>.<span class="hljs-property">title</span> : <span class="hljs-string">'App'</span>)
    },
  },
})
</code></pre>
<ol start="3">
<li><strong>官方动画方案</strong>：还好有 Framer Motion 兜底。没有 Motion，有几个人知道 React 卸载动画咋写？官方文档有教吗？没有。全靠社区自救。</li>
</ol>
<hr/>
<h3 data-id="heading-19">六、Signal 使用指南：安装与 Babel</h3>
<h4 data-id="heading-20">1. 安装</h4>
<pre><code class="hljs language-bash" lang="bash">pnpm i @preact/signals-react
</code></pre>
<p>跑业务用这四个 API 就够了：<code>signal</code>、<code>computed</code>、<code>effect</code>、<code>batch</code>。若想<strong>少写一层订阅代码</strong>（见下文），再装 Babel 插件：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm i @preact/signals-react-transform -D
</code></pre>
<h4 data-id="heading-21">2. Babel 插件：做了什么、和 React Compiler 冲突、不用时怎么写</h4>
<p><strong>Babel 做了什么</strong></p>
<p><code>@preact/signals-react-transform</code> 会在编译阶段扫描组件内对 <code>signal.value</code> 的 <strong>读取</strong>，自动插入「订阅」逻辑。结果是：在 JSX 里写 <code>count.value</code> 时，<strong>不用</strong> 在组件里再调 <code>useSignals()</code>，组件也会在 signal 变化时正确重渲染。<br/>
换句话说，Babel 帮你把「谁在用这个 signal」分析好了，并注入订阅，所以你可以直接写：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> count = <span class="hljs-title function_">signal</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{count.value}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>   <span class="hljs-comment">// 不用 useSignals()，照样响应更新</span>
}
</code></pre>
<p>官方文档是这么描述规则的：</p>
<ul>
<li>
<p>函数是组件吗？</p>
</li>
<li>
<p>如果是的话，这个组件会使用信号吗？</p>
</li>
<li>
<p>如果一个函数名称大写（例如函数 MyComponent（） {}）且包含 JSX，则称该函数为组件。</p>
</li>
<li>
<p>如果函数的主体包含一个成员表达式引用 .value（即某某的值 ），我们假设它是信号。</p>
</li>
</ul>
<p>如果你的函数/组件符合这些条件，这个插件会对它进行转换。</p>
<p>如果没有，就会被放任不管。</p>
<p>如果你有一个函数使用信号但不符合这些条件（例如手动调用 createElement 而不是使用 JSX），你可以添加带有字符串 @useSignals 的注释，指示该插件转换该函数。</p>
<p>你也可以手动选择不转换函数，方法是添加带有字符串 @noUseSignals 的注释。</p>
<hr/>
<p><strong>和 React Compiler 冲突</strong></p>
<p>同一份文件里，<strong>不能</strong> 同时启用 <code>signals-react-transform</code> 和 <code>babel-plugin-react-compiler</code>，否则响应式会乱（见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpreactjs%2Fsignals%2Fissues%2F652" target="_blank" title="https://github.com/preactjs/signals/issues/652" ref="nofollow noopener noreferrer">preactjs/signals#652</a>）。</p>
<p>至于这个 issue 我是怎么找的，那当然不是人肉搜索，而是靠 <strong>AI + Bash + CLI</strong></p>
<p>比如 Github 提供了 <strong>MCP</strong> 和 <strong>gh</strong> CLI（Github CLI） 命令行工具，可以让你查找代码和 issue 等，下面再介绍如何使用 <strong>gh</strong>，这里先看效果</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/606970db97ef4a66bb15604bf06f75d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-F5pe256CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602669&amp;x-signature=lHCiNy%2FyAhRg3ZlUJS3Lt8mVi84%3D" alt="ai2.png" width="70%" loading="lazy"/>
<p>解决做法是<strong>按路径分流</strong>：例如只对 <code>views/signals/</code> 下的文件用 transform，其它文件只用 react-compiler：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">react</span>({
      <span class="hljs-attr">babel</span>: <span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> isSignals = <span class="hljs-regexp">/[\\/]views[\\/]signals[\\/]/</span>.<span class="hljs-title function_">test</span>(id)
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">plugins</span>: isSignals
            ? [[<span class="hljs-string">'module:@preact/signals-react-transform'</span>]]
            : [<span class="hljs-string">'babel-plugin-react-compiler'</span>],
        }
      },
    }),
  ],
})
</code></pre>
<p><strong>不用 Babel 时代码怎么写</strong></p>
<p>不装、或不用 <code>signals-react-transform</code> 时，在<strong>消费</strong> signal 的组件里必须显式调用 <code>useSignals()</code>，否则读 <code>count.value</code> 不会建立订阅，界面不会更新：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useSignals } <span class="hljs-keyword">from</span> <span class="hljs-string">'@preact/signals-react/runtime'</span>
<span class="hljs-keyword">import</span> { signal } <span class="hljs-keyword">from</span> <span class="hljs-string">'@preact/signals-react'</span>

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">signal</span>(<span class="hljs-number">0</span>)

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">useSignals</span>()   <span class="hljs-comment">// 必须写：让组件订阅用到的 signal</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Value: {count.value}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
}
</code></pre>
<p>同时用 Signals 和 React Compiler 时，也只能用这种「手写 <code>useSignals()</code>」的方式，不能在同一文件上开 Babel transform。</p>
<hr/>
<h3 data-id="heading-22">七、gh CLI（Github CLI），让你的 AI 掌握整个 Github</h3>
<p>GitHub CLI 是一个命令行工具，用于在终端中直接与 GitHub 交互。<strong>适合让 LLM 通过命令行查阅和阅读仓库内容，节省 MCP Token 消耗。</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcli.github.com%2Fmanual%2F" target="_blank" title="https://cli.github.com/manual/" ref="nofollow noopener noreferrer">官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.github.com%2Fzh%2Fgithub-cli" target="_blank" title="https://docs.github.com/zh/github-cli" ref="nofollow noopener noreferrer">中文文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.github.com%2Fen%2Frest" target="_blank" title="https://docs.github.com/en/rest" ref="nofollow noopener noreferrer">API 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcli%2Fcli%2Freleases" target="_blank" title="https://github.com/cli/cli/releases" ref="nofollow noopener noreferrer">Github Releases</a></li>
</ul>
<h4 data-id="heading-23">安装</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Windows (使用 winget 或 scoop)</span>
<span class="hljs-comment"># 或者 Github Releases 下载</span>
winget install --<span class="hljs-built_in">id</span> GitHub.cli
<span class="hljs-comment"># 或</span>
scoop install gh

<span class="hljs-comment"># macOS</span>
brew install gh

<span class="hljs-comment"># Linux</span>
<span class="hljs-comment"># 参考：https://github.com/cli/cli/blob/trunk/docs/install_linux.md#debian</span>
(<span class="hljs-built_in">type</span> -p wget &gt;/dev/null || (sudo apt update &amp;&amp; sudo apt install wget -y)) \
	&amp;&amp; sudo <span class="hljs-built_in">mkdir</span> -p -m 755 /etc/apt/keyrings \
	&amp;&amp; out=$(<span class="hljs-built_in">mktemp</span>) &amp;&amp; wget -nv -O<span class="hljs-variable">$out</span> https://cli.github.com/packages/githubcli-archive-keyring.gpg \
	&amp;&amp; <span class="hljs-built_in">cat</span> <span class="hljs-variable">$out</span> | sudo <span class="hljs-built_in">tee</span> /etc/apt/keyrings/githubcli-archive-keyring.gpg &gt; /dev/null \
	&amp;&amp; sudo <span class="hljs-built_in">chmod</span> go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg \
	&amp;&amp; sudo <span class="hljs-built_in">mkdir</span> -p -m 755 /etc/apt/sources.list.d \
	&amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"deb [arch=<span class="hljs-subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main"</span> | sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/github-cli.list &gt; /dev/null \
	&amp;&amp; sudo apt update \
	&amp;&amp; sudo apt install gh -y
</code></pre>
<p><strong>身份验证：</strong></p>
<pre><code class="hljs language-bash" lang="bash">gh auth login              <span class="hljs-comment"># 交互式登录</span>
gh auth status             <span class="hljs-comment"># 查看认证状态</span>
gh auth refresh            <span class="hljs-comment"># 刷新 token</span>
</code></pre>
<h4 data-id="heading-24">仓库信息</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 建议优先使用 JSON 输出，避免 README 导致输出过长</span>
gh repo view {owner}/{repo} --json name,description,primaryLanguage,stargazerCount,url
</code></pre>
<h4 data-id="heading-25">文件内容（最常用）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 读取文件内容（需解码）</span>
gh api <span class="hljs-string">"repos/{owner}/{repo}/contents/{path/to/file}"</span> --jq <span class="hljs-string">'.content'</span> | <span class="hljs-built_in">base64</span> -d

<span class="hljs-comment"># 读取 README</span>
gh api <span class="hljs-string">"repos/{owner}/{repo}/readme"</span> --jq <span class="hljs-string">'.content'</span> | <span class="hljs-built_in">base64</span> -d

<span class="hljs-comment"># 列出目录（仅显示名称，节省 Token）</span>
gh api <span class="hljs-string">"repos/{owner}/{repo}/contents/{path}"</span> --jq <span class="hljs-string">'.[].name'</span>
</code></pre>
<h4 data-id="heading-26">分支和提交</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出所有分支名称</span>
gh api <span class="hljs-string">"repos/{owner}/{repo}/branches"</span> --jq <span class="hljs-string">'.[].name'</span>

<span class="hljs-comment"># 获取最近 3 条提交记录（格式化输出）</span>
gh api <span class="hljs-string">"repos/{owner}/{repo}/commits?per_page=3"</span> --jq <span class="hljs-string">'.[] | {sha: .sha[0:7], message: .commit.message, author: .commit.author.name}'</span>
</code></pre>
<h4 data-id="heading-27">Issue 和 PR</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列表显示（带限制）</span>
gh issue list --repo {owner}/{repo} --<span class="hljs-built_in">limit</span> 5
gh <span class="hljs-built_in">pr</span> list --repo {owner}/{repo} --<span class="hljs-built_in">limit</span> 5

<span class="hljs-comment"># 搜索特定关键词的 Issue</span>
gh issue list --repo {owner}/{repo} --search <span class="hljs-string">"{keyword}"</span> --<span class="hljs-built_in">limit</span> 5

<span class="hljs-comment"># 获取 PR 详情（JSON）</span>
gh api <span class="hljs-string">"repos/{owner}/{repo}/pulls/{number}"</span> --jq <span class="hljs-string">'{title, body, state, html_url}'</span>
</code></pre>
<h4 data-id="heading-28">通用 API</h4>
<pre><code class="hljs language-bash" lang="bash">gh api {endpoint} --jq <span class="hljs-string">'.field'</span>              <span class="hljs-comment"># 任意 API + jq 过滤</span>
gh api -X POST {endpoint} -f key=value       <span class="hljs-comment"># POST 请求</span>
</code></pre>
<h4 data-id="heading-29">使用场景</h4>
<ol>
<li><strong>快速查阅仓库结构</strong>：先用 <code>gh repo view --json ...</code> 了解概况，再用 <code>gh api .../contents --jq '.[].name'</code> 浏览根目录</li>
<li><strong>深度查看代码</strong>：定位文件后，使用 <code>gh api .../contents/path --jq '.content' | base64 -d</code> 读取</li>
<li><strong>排查历史</strong>：使用 <code>gh api .../commits?per_page=5</code> 查看最近变更</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[单元测试]]></title>    <link>https://juejin.cn/post/7601374137411797027</link>    <guid>https://juejin.cn/post/7601374137411797027</guid>    <pubDate>2026-02-01T14:29:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601374137411797027" data-draft-id="7601355703240196136" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="单元测试"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-01T14:29:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xyy123"/> <meta itemprop="url" content="https://juejin.cn/user/688733962386237"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            单元测试
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/688733962386237/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xyy123
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T14:29:15.000Z" title="Sun Feb 01 2026 14:29:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 核心理念 (Why &amp; What)</h2>
<h3 data-id="heading-1">1.1 什么是单元测试？</h3>
<p>单元测试是对软件中的<strong>最小可测试单元</strong>（通常是类中的方法）进行检查和验证。</p>
<ul>
<li><strong>目标：</strong> 确保逻辑在隔离环境中按预期运行。</li>
<li><strong>特点：</strong> 不依赖数据库、文件系统、网络或其他外部环境。</li>
</ul>
<h3 data-id="heading-2">1.2 FIRST 原则 (黄金法则)</h3>
<p>所有优秀的单元测试都必须遵守 FIRST 原则：</p>
<ul>
<li><strong>F (Fast) 快速：</strong> 运行速度必须极快（毫秒级）。</li>
<li><strong>I (Isolated) 隔离：</strong> 测试之间互不干扰，不依赖执行顺序。</li>
<li><strong>R (Repeatable) 可重复：</strong> 在任何环境、任何时间运行结果一致（不依赖 <code>DateTime.Now</code> 或随机数）。</li>
<li><strong>S (Self-validating) 自验证：</strong> 测试结果只有 Pass 或 Fail，不需要人工查看日志。</li>
<li><strong>T (Timely) 及时：</strong> 随代码编写同时完成，不要等到项目结束再补。</li>
</ul>
<hr/>
<h2 data-id="heading-3">2. 技术栈与工具 (Tools)</h2>
<p>在现代 .NET / C# 开发中，推荐使用以下组合：</p>






























<table><thead><tr><th><strong>组件</strong></th><th><strong>推荐工具</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td><strong>测试框架</strong></td><td><strong>xUnit</strong></td><td>现代、简洁、社区支持最强（优于 MSTest）。</td></tr><tr><td><strong>模拟框架</strong></td><td><strong>Moq</strong></td><td>用于模拟接口行为（Mocking）。</td></tr><tr><td><strong>断言库</strong></td><td>xUnit 自带 / FluentAssertions</td><td>用于验证结果（<code>Assert.Equal</code>）。</td></tr><tr><td><strong>运行工具</strong></td><td>Visual Studio Test Explorer</td><td>快捷键 <code>Ctrl + E, T</code>。</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">3. 编写规范 (How to Write)</h2>
<h3 data-id="heading-5">3.1 3A 模式 (代码结构)</h3>
<p>每个测试方法内部必须清晰地分为三部分：</p>
<ol>
<li><strong>Arrange (准备)：</strong> 初始化对象、设置 Mock 行为、准备数据。</li>
<li><strong>Act (执行)：</strong> 调用被测试的方法。</li>
<li><strong>Assert (断言)：</strong> 验证返回值是否正确，或是否调用了预期的方法。</li>
</ol>
<h3 data-id="heading-6">3.2 命名规范</h3>
<p>测试方法的名称应当像“句子”一样清晰，描述 <strong>[测什么] + [什么条件下] + [期望结果]</strong> 。</p>
<ul>
<li><em>格式：</em> <code>MethodName_StateUnderTesting_ExpectedBehavior</code></li>
<li><em>示例：</em> <code>Register_WithExistingEmail_ThrowsException</code></li>
</ul>
<h3 data-id="heading-7">3.3 Mock (模拟) 的边界</h3>
<p>这是区分“单元测试”与“集成测试”的关键。</p>
<ul>
<li>
<p><strong>需要 Mock 的（外部依赖）：</strong></p>
<ul>
<li>数据库操作 (<code>Repository</code>, <code>DbContext</code>)</li>
<li>第三方 API 调用 (<code>HttpClient</code>)</li>
<li>文件 I/O、系统时间、随机数</li>
</ul>
</li>
<li>
<p><strong>不需要 Mock 的（内部逻辑）：</strong></p>
<ul>
<li>DTO / Entity 实体对象</li>
<li>LINQ 查询（内存中）</li>
<li>私有方法（通过测试 Public 方法覆盖）</li>
<li>工具类方法（如 <code>String.Split</code>）</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-8">4. 测试策略与范围 (Strategy)</h2>
<h3 data-id="heading-9">4.1 测试粒度</h3>
<ul>
<li>
<p><strong>重点测试：</strong> <strong>Service 层</strong> 的 Public 方法。这里是业务逻辑最密集的地方。</p>
</li>
<li>
<p><strong>轻量测试/不测试：</strong></p>
<ul>
<li><strong>Controller 层：</strong> 仅验证 HTTP 状态码转换，不测业务逻辑。</li>
<li><strong>Repository 层：</strong> 通常由集成测试覆盖。</li>
<li><strong>纯 CRUD：</strong> 如果方法只是简单的一行透传，不值得测试。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-10">4.2 覆盖率与 ROI (投入产出比)</h3>
<ul>
<li>
<p><strong>不要追求 100% 覆盖率。</strong> 推荐目标：<strong>核心业务模块 80%+</strong> 。</p>
</li>
<li>
<p><strong>必测路径：</strong></p>
<ol>
<li><strong>Happy Path：</strong> 一切正常的流程。</li>
<li><strong>Edge Cases：</strong> 关键的边界条件（如空值、负数、重复数据）。</li>
</ol>
</li>
<li>
<p><strong>效率神器：</strong> 使用 xUnit 的 <code>[Theory]</code> 和 <code>[InlineData]</code> 来合并重复的测试逻辑。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-11">5. 实战代码速查表 (Cheat Sheet)</h2>
<h3 data-id="heading-12">场景：测试一个用户注册服务</h3>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-keyword">using</span> Xunit;
<span class="hljs-keyword">using</span> Moq;
<span class="hljs-keyword">using</span> MyProject.Services;
<span class="hljs-keyword">using</span> MyProject.Interfaces;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceTests</span>
{
    <span class="hljs-comment">// 定义 Mocks (模拟对象)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Mock&lt;IUserRepository&gt; _mockRepo;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Mock&lt;IEmailService&gt; _mockEmail;
    <span class="hljs-comment">// 定义被测对象</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> UserService _service;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UserServiceTests</span>()</span>
    {
        <span class="hljs-comment">// Arrange: 初始化 (会在每个测试运行前执行)</span>
        _mockRepo = <span class="hljs-keyword">new</span> Mock&lt;IUserRepository&gt;();
        _mockEmail = <span class="hljs-keyword">new</span> Mock&lt;IEmailService&gt;();
        _service = <span class="hljs-keyword">new</span> UserService(_mockRepo.Object, _mockEmail.Object);
    }

    <span class="hljs-comment">// 案例 1: 快乐路径 (Happy Path)</span>
    [<span class="hljs-meta">Fact</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Register_ValidUser_ReturnsTrueAndSendsEmail</span>()</span>
    {
        <span class="hljs-comment">// Arrange</span>
        <span class="hljs-keyword">var</span> email = <span class="hljs-string">"new@test.com"</span>;
        <span class="hljs-comment">// 模拟：数据库里找不到这个邮箱 (返回 null)</span>
        _mockRepo.Setup(r =&gt; r.GetByEmail(email)).ReturnsAsync((User)<span class="hljs-literal">null</span>);

        <span class="hljs-comment">// Act</span>
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _service.Register(email);

        <span class="hljs-comment">// Assert</span>
        Assert.True(result); <span class="hljs-comment">// 验证返回值</span>
        <span class="hljs-comment">// 验证：是否确实调用了数据库保存方法？(验证行为)</span>
        _mockRepo.Verify(r =&gt; r.Add(It.IsAny&lt;User&gt;()), Times.Once);
        <span class="hljs-comment">// 验证：是否确实发了邮件？</span>
        _mockEmail.Verify(e =&gt; e.SendWelcome(email), Times.Once);
    }

    <span class="hljs-comment">// 案例 2: 异常路径 (Edge Case) - 邮箱已存在</span>
    [<span class="hljs-meta">Fact</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Register_ExistingEmail_ThrowsException</span>()</span>
    {
        <span class="hljs-comment">// Arrange</span>
        <span class="hljs-keyword">var</span> email = <span class="hljs-string">"exist@test.com"</span>;
        <span class="hljs-comment">// 模拟：数据库里已经有这个用户了</span>
        _mockRepo.Setup(r =&gt; r.GetByEmail(email)).ReturnsAsync(<span class="hljs-keyword">new</span> User());

        <span class="hljs-comment">// Act &amp; Assert</span>
        <span class="hljs-comment">// 验证是否抛出了特定异常</span>
        <span class="hljs-keyword">await</span> Assert.ThrowsAsync&lt;InvalidOperationException&gt;(() =&gt; _service.Register(email));

        <span class="hljs-comment">// 验证：确保没有调用保存，也没有发邮件</span>
        _mockRepo.Verify(r =&gt; r.Add(It.IsAny&lt;User&gt;()), Times.Never);
        _mockEmail.Verify(e =&gt; e.SendWelcome(It.IsAny&lt;<span class="hljs-built_in">string</span>&gt;()), Times.Never);
    }
    
    <span class="hljs-comment">// 案例 3: 参数化测试 (多组数据)</span>
    [<span class="hljs-meta">Theory</span>]
    [<span class="hljs-meta">InlineData(<span class="hljs-string">""</span>)</span>]
    [<span class="hljs-meta">InlineData(null)</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Register_InvalidInput_ThrowsArgumentException</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> invalidEmail</span>)</span>
    {
         <span class="hljs-keyword">await</span> Assert.ThrowsAsync&lt;ArgumentException&gt;(() =&gt; _service.Register(invalidEmail));
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-13">6. 自检清单 (Checklist)</h2>
<p>在提交代码前，问自己几个问题：</p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 我的测试跑得快吗？（是否连了真实数据库？）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 测试名能让我一眼看懂在测什么吗？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 我是否只测试了 Public 方法？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 我是否覆盖了“成功”和“失败”两种主要情况？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 如果我重构代码内部实现（不改功能），测试会挂吗？（如果不改功能测试却挂了，说明测试写得太关注细节了）。</li>
</ul>
<h2 data-id="heading-14">7. 测试策略</h2>
<h3 data-id="heading-15">1. 企业一般的要求标准是什么？</h3>
<p>在大多数正规的软件开发团队（非只有 1-2 人的初创团队）中，通常有以下硬性或软性指标：</p>
<h4 data-id="heading-16">A. 代码覆盖率 (Code Coverage) —— 核心指标</h4>
<p>这是最直观的数据。Visual Studio 企业版或 DevOps 平台（如 Azure DevOps, Jenkins）都会统计这个数字。</p>
<ul>
<li>
<p><strong>及格线：60% - 70%</strong></p>
<ul>
<li>这通常意味着覆盖了主要的业务逻辑（Happy Path）。</li>
</ul>
</li>
<li>
<p><strong>行业标准/优秀线：80%</strong></p>
<ul>
<li>这是大多数成熟互联网公司和外企追求的目标。如果有 CI/CD 流水线，<strong>低于 80% 的覆盖率可能会导致代码合并被拒绝</strong>。</li>
</ul>
</li>
<li>
<p><strong>金融/医疗/航空：90% - 100%</strong></p>
<ul>
<li>这些领域极其严苛，但这通常不适用于普通商业项目。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-17">B. 必测范围</h4>
<ul>
<li><strong>核心业务 (Core Domain)：</strong> 涉及金钱计算、订单状态流转、权限校验的代码，必须有测试。</li>
<li><strong>公共库 (Shared Libraries)：</strong> 给其他团队用的工具类，必须高覆盖率。</li>
</ul>
<hr/>
<h3 data-id="heading-18">2. 每个 Public 方法都要写一个测试吗？</h3>
<p><strong>答案是：绝对不需要。</strong> 盲目追求“每个方法都有测试”是低效的源头。</p>
<h4 data-id="heading-19">❌ 不需要测试的方法（低价值）</h4>
<ol>
<li>
<p><strong>琐碎代码 (Trivial Code)：</strong></p>
<ul>
<li>简单的 Getter/Setter 属性。</li>
<li>没有任何逻辑判断，只是把数据从 A 传给 B 的方法（纯透传）。</li>
<li>构造函数（除非里面有复杂的初始化逻辑）。</li>
</ul>
</li>
<li>
<p><strong>框架生成的代码：</strong> 比如 Entity Framework 的 Migration 文件，或者自动生成的 DTO。</p>
</li>
<li>
<p><strong>简单的 CRUD：</strong> 如果你的 Service 方法只是调用了一下 <code>Repository.GetById()</code> 然后直接返回，<strong>不要测它</strong>。你是在测微软的编译器，这没有意义。</p>
</li>
</ol>
<h4 data-id="heading-20">✅ 必须测试的方法（高价值）</h4>
<ol>
<li><strong>有条件分支的：</strong> 包含 <code>if</code>, <code>switch</code>, <code>while</code> 的方法。</li>
<li><strong>有计算逻辑的：</strong> 包含 <code>+ - * /</code> 或字符串处理的方法。</li>
<li><strong>有异常抛出的：</strong> 业务规则校验（例如：余额不足抛出异常）。</li>
</ol>
<hr/>
<h3 data-id="heading-21">3. 如何平衡开发效率与测试详细度？</h3>
<p>如果你觉得写测试太慢，通常是因为你试图覆盖“所有可能”，或者测试写得太难维护。</p>
<h4 data-id="heading-22">策略一：遵循 "80/20 法则" (重要！)</h4>
<p><strong>只写两个维度的测试，就能覆盖 80% 的风险：</strong></p>
<ol>
<li><strong>Happy Path (快乐路径)：</strong> 输入完全正确，流程一切正常，最后返回成功。这是必须要有的。</li>
<li><strong>Edge Cases (关键边缘路径)：</strong> 最容易出错的 1-2 种情况（例如输入为 null，ID 不存在，金额为负数）。</li>
</ol>
<p><strong>放弃什么？</strong></p>
<p>放弃那些极低概率发生的边界情况，或者需要极其复杂的 Mock 才能模拟出来的场景。</p>
<h4 data-id="heading-23">策略二：使用参数化测试 (Parameterized Tests)</h4>
<p>这是 C# xUnit 提升效率的神器。<strong>不要为每种输入都复制粘贴写一个新方法</strong>。</p>
<p><strong>低效写法：</strong></p>
<p>C#</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">Fact</span>] <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Test_Age_10_Return_False</span>()</span> { ... }
[<span class="hljs-meta">Fact</span>] <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Test_Age_20_Return_True</span>()</span> { ... }
[<span class="hljs-meta">Fact</span>] <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Test_Age_18_Return_True</span>()</span> { ... }
</code></pre>
<p><strong>高效写法 (使用 <code>[Theory]</code> 和 <code>[InlineData]</code>)：</strong></p>
<p>写一个测试方法，测 5 种情况，代码量几乎不增加。</p>
<p>C#</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">Theory</span>]
[<span class="hljs-meta">InlineData(10, false)</span>] <span class="hljs-comment">// 输入10，期望 false</span>
[<span class="hljs-meta">InlineData(17, false)</span>]
[<span class="hljs-meta">InlineData(18, true)</span>]  <span class="hljs-comment">// 临界点</span>
[<span class="hljs-meta">InlineData(20, true)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CheckAdult_ReturnsExpectedResult</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> age, <span class="hljs-built_in">bool</span> expected</span>)</span>
{
    <span class="hljs-comment">// Arrange</span>
    <span class="hljs-keyword">var</span> service = <span class="hljs-keyword">new</span> UserService();
    
    <span class="hljs-comment">// Act</span>
    <span class="hljs-keyword">var</span> result = service.IsAdult(age);
    
    <span class="hljs-comment">// Assert</span>
    Assert.Equal(expected, result);
}
</code></pre>
<h4 data-id="heading-24">策略三：避免测试“实现细节”</h4>
<p>这是导致测试难以维护、开发效率低下的最大原因。</p>
<ul>
<li><strong>糟糕的测试：</strong> 验证“Service 是否先读取了缓存，缓存没有再读取数据库，然后把数据写入缓存”。（如果以后你删除了缓存逻辑，测试就挂了，虽然功能没变）。</li>
<li><strong>好的测试：</strong> 验证“我输入 ID，Service 是否返回了正确的用户”。（不管你内部怎么折腾，只要结果对就行）。</li>
</ul>
<p><strong>原则：像用户一样测试你的接口，而不是像做手术一样去测试内部变量。</strong></p>
<hr/>
<h3 data-id="heading-25">总结：给你的行动指南</h3>
<p>如果你现在还在“从 0 到 1”的阶段，我建议你采取**“防御性测试策略”**：</p>
<ol>
<li><strong>新功能必测：</strong> 以后新写的核心 Service 方法，必须写一个 Happy Path 测试。</li>
<li><strong>Bug 修复必测：</strong> 每次修复一个 Bug，先写一个测试复现这个 Bug，修复后测试通过。这能防止 Bug 复发（回归测试）。</li>
<li><strong>旧代码随缘：</strong> 不要试图回头去给几年前的旧代码补测试，除非你要重构它。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[闭包：从「能跑」到「可控」——用执行上下文把它讲透，再把泄漏风险压住]]></title>    <link>https://juejin.cn/post/7601427909703974966</link>    <guid>https://juejin.cn/post/7601427909703974966</guid>    <pubDate>2026-02-02T01:58:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601427909703974966" data-draft-id="7601477334931587078" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="闭包：从「能跑」到「可控」——用执行上下文把它讲透，再把泄漏风险压住"/> <meta itemprop="keywords" content="前端,面试,Vue.js"/> <meta itemprop="datePublished" content="2026-02-02T01:58:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="swipe"/> <meta itemprop="url" content="https://juejin.cn/user/858052674727959"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            闭包：从「能跑」到「可控」——用执行上下文把它讲透，再把泄漏风险压住
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/858052674727959/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    swipe
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T01:58:35.000Z" title="Mon Feb 02 2026 01:58:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：为什么团队里闭包总是「会用但讲不清」</h2>
<p>闭包几乎是每个前端都“用过”的能力：回调、事件处理、节流防抖、柯里化、状态缓存……到处都是它。但一到排查线上内存飙升、解释“为什么变量没被回收”、或者评审里讨论“这个写法会不会泄漏”，就容易陷入两种极端：</p>
<ul>
<li><strong>把闭包当玄学</strong>：只记住“函数套函数 + 引用外部变量”，但不知道底层到底发生了什么。</li>
<li><strong>把闭包当洪水猛兽</strong>：遇到闭包就怕泄漏，动不动“全局变量/单例就是坏”。</li>
</ul>
<p>这篇文章的目标很明确：<strong>用“执行上下文 + AO/GO + 可达性”把闭包拆开讲清楚</strong>，再落到工程实践：<strong>哪些写法会导致内存常驻、怎么定位、怎么释放、怎么验证</strong>。很多内容需要配合内存图理解（图片必须保留），建议边看边对照图。</p>
<hr/>
<h2 data-id="heading-1">目录</h2>
<ul>
<li>
<ol>
<li>脉络：为什么闭包在 JS 里如此关键</li>
</ol>
</li>
<li>
<ol start="2">
<li>闭包到底是什么：定义、自由变量与词法绑定</li>
</ol>
</li>
<li>
<ol start="3">
<li>从调用栈看闭包：高阶函数的执行过程（GO / AO / FEC）</li>
</ol>
</li>
<li>
<ol start="4">
<li>闭包形成的关键：[[scope]] / parentScope 为什么能“跨出上下文”</li>
</ol>
</li>
<li>
<ol start="5">
<li>内存视角：普通函数 vs 闭包函数，变量为什么回收/不回收</li>
</ol>
</li>
<li>
<ol start="6">
<li>闭包与内存泄漏：什么时候是“正常驻留”，什么时候是“泄漏”</li>
</ol>
</li>
<li>
<ol start="7">
<li>如何释放：最小化作用域、解除引用、弱引用思路</li>
</ol>
</li>
<li>
<ol start="8">
<li>性能与排查：用浏览器工具定位闭包导致的内存/耗时</li>
</ol>
</li>
<li>
<ol start="9">
<li>引擎优化：闭包里“没用到的变量”会怎样（V8 优化）</li>
</ol>
</li>
<li>
<ol start="10">
<li>进阶边界：多个闭包实例彼此独立；为什么 <code>null</code> 能断引用而 <code>undefined</code> 不行</li>
</ol>
</li>
<li>
<ol start="11">
<li>实战建议：团队落地清单 &amp; 指标验证</li>
</ol>
</li>
<li>
<ol start="12">
<li>总结：关键结论 + 下一步建议</li>
</ol>
</li>
</ul>
<hr/>
<h2 data-id="heading-2">f 脉络探索：闭包为什么值得被「认真对待」</h2>
<p>闭包是 JavaScript 中一个非常容易让人迷惑的知识点：它既是语言表达力的源泉，也可能成为内存与可维护性的风险点。很多经典资料对它评价极高——因为它背后牵扯的是一整套“词法作用域 + 执行上下文 + 垃圾回收”的体系。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af8fae0ed83645c2a2a12564e9cfcd19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=E1NoWfiAhwuCAfj4bIH33KaOITE%3D" alt="" loading="lazy"/></p>
<p>** 图7-1 《你不知道的JavaScript》上卷中对闭包的评语**</p>
<p>把这张图放在开头的意义是：<strong>闭包不是一个“语法点”，而是理解 JS 运行机制的入口</strong>。当你能把闭包讲清楚，很多“JS 为什么这样设计”的问题都会连起来。</p>
<h3 data-id="heading-3">本章小结（可迁移的经验）</h3>
<ul>
<li>闭包不是“函数套函数”的表象，而是 <strong>词法作用域如何在运行时被保留</strong>。</li>
<li>闭包相关的争论，往往不是“对错”，而是 <strong>讨论口径（广义/狭义）不同</strong>。</li>
<li>真正工程风险来自：<strong>闭包让某些对象变成“长期可达”</strong> ，从而影响 GC。</li>
</ul>
<hr/>
<h2 data-id="heading-4">一、闭包到底是什么：定义、自由变量与词法绑定</h2>
<h3 data-id="heading-5">1.1 闭包的概念定义：把“感觉”变成“可证明”</h3>
<p>闭包并不是 JavaScript 独有。计算机科学中，闭包（Closure）又称<strong>词法闭包</strong>（Lexical Closure），是一种在支持<strong>头等函数</strong>的语言中实现<strong>词法绑定</strong>的技术：闭包在实现上可以理解为“<strong>函数 + 关联环境（自由变量的绑定）</strong> ”的组合结构。</p>
<p>在 JavaScript 语境下，可以用更工程化的表达：</p>
<blockquote>
<p><strong>闭包 = 一个函数 + 该函数在定义时可访问的外层作用域引用（自由变量所在的词法环境）。</strong></p>
</blockquote>
<p>这里最关键的是两个词：</p>
<ul>
<li><strong>自由变量</strong>：跨出自己作用域、来自外层作用域的变量（“不是我家里的变量，但我能用”）。</li>
<li><strong>词法解析阶段确定</strong>：函数“能访问哪些变量”，在**代码写出来那一刻（定义时）**就决定了，而不是调用时随机决定。</li>
</ul>
<blockquote>
<p>一个常用的工作记忆法： <strong>“函数定义时就把外层环境‘锁’住了”</strong> 。后续你把函数拿到哪里调用，它都沿着当初锁定的链去找变量。</p>
</blockquote>
<h3 data-id="heading-6">1.2 广义 vs 狭义：团队沟通时要先统一口径</h3>
<p>社区对“什么算闭包”常见两种口径：</p>
<ul>
<li><strong>广义</strong>：JS 里“函数”几乎都带着词法作用域信息，因此都可以叫闭包。</li>
<li><strong>狭义（更严谨）</strong> ：只有当函数<strong>实际捕获并使用</strong>外层变量，才讨论“闭包带来的效果”（比如变量驻留）。</li>
</ul>
<p>下面这段代码就体现了差异点：它能访问 <code>name</code>，但是否把它视为“闭包”（严格意义）看你站哪种口径：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 可以访问 name：test 算闭包（广义）</span>
<span class="hljs-comment">// 有访问到 name：test 算闭包（更严谨，讨论“闭包效果”更有意义）</span>
<span class="hljs-keyword">var</span> name = <span class="hljs-string">"放寒假了"</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name);
}
<span class="hljs-title function_">test</span>();
</code></pre>
<h3 data-id="heading-7">本章小结（落地清单）</h3>
<ul>
<li>团队讨论闭包前，先明确口径：<strong>讨论“闭包机制”还是“闭包效果（变量驻留）”</strong> 。</li>
<li>记住闭包核心：<strong>定义时锁定词法环境</strong>，不是调用时决定。</li>
<li>所谓“自由变量”，本质就是：<strong>跨作用域访问的变量</strong>。</li>
</ul>
<hr/>
<h2 data-id="heading-8">二、从调用栈看闭包：高阶函数的执行过程（GO / AO / FEC）</h2>
<p>闭包很容易被讲成“概念”，但工程上要做到“可控”，一定要落到执行过程：<strong>调用栈如何创建执行上下文？AO/GO 什么时候创建？引用链怎样形成可达性？</strong></p>
<h3 data-id="heading-9">2.1 先看一个最小高阶函数：返回函数指针发生了什么</h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">foo</span>(<span class="hljs-params"/>) </span>{
  <span class="hljs-comment">// bar 预解析，前面有讲过</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bar</span>(<span class="hljs-params"/>) </span>{
    console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"小吴"</span>);
  }
  <span class="hljs-keyword">return</span> bar;
}

<span class="hljs-keyword">var</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> = <span class="hljs-title">foo</span>(<span class="hljs-params"/>)</span>;

<span class="hljs-function"><span class="hljs-keyword">fn</span>(<span class="hljs-params"/>)</span>;
<span class="hljs-comment">// 小吴</span>
</code></pre>
<p>关键点：<strong>调用函数会创建执行上下文（Execution Context）</strong> 。执行上下文创建前，会先创建对应的 <strong>AO（Activation Object）</strong> ：用于存放形参、局部变量、函数声明等。</p>
<h3 data-id="heading-10">2.2 内存图：从“栈/堆”视角理解 <code>fn = foo()</code> 的意义</h3>
<blockquote>
<p>建议把这一段当成闭包全篇的“底座”，后面所有闭包/泄漏/回收都在重复这个结构。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07bb612aa1bf4c11bf15f92122c9f2fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=7eKY%2BMsGiQ99YG5DDEy2CT27wRI%3D" alt="" loading="lazy"/></p>
<p>** 图7-2 高阶函数执行前**</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c171432b1871484d8ef3c786b332b0b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=pFm9jys%2FzADxJPXKlauLD6UOt6Q%3D" alt="" loading="lazy"/></p>
<p>** 图7-3 foo函数调用阶段内存图**</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18273724433646b3857415a33fe5a19b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=R1ZVuPdj76dutr5kEpofWq8KeIw%3D" alt="" loading="lazy"/></p>
<p>** 图7-4 foo函数中的bar函数调用阶段内存图**</p>
<p>把图 7-2 ~ 7-4 用一句话串起来：</p>
<ul>
<li><code>foo()</code> 调用时创建 <code>foo</code> 的执行上下文与 AO；</li>
<li><code>bar</code> 函数对象存在于堆上，<code>foo</code> 的 AO 里保存了它的引用；</li>
<li><code>return bar</code> 让全局 <code>fn</code> 指向 <code>bar</code> 的函数对象地址；</li>
<li>后续 <code>fn()</code> 本质是在执行 <code>bar()</code>。</li>
</ul>
<p>你可以把它想象成：<strong><code>return</code> 返回的不是函数体，而是“函数对象的指针”</strong> 。<code>fn</code> 接住这个指针后，就和 <code>bar</code> 的生命周期绑定了。</p>
<h3 data-id="heading-11">本章小结（落地清单）</h3>
<ul>
<li>AO 是“函数即将执行前”创建的，不是定义函数时就创建（避免无谓开销）。</li>
<li><code>return function</code> 的本质是：<strong>返回堆上函数对象的引用</strong>。</li>
<li>后续 <code>fn()</code> 执行的是“那块函数对象”，而不是重新生成一份。</li>
</ul>
<hr/>
<h2 data-id="heading-12">三、闭包形成的关键：为什么 <code>[[scope]] / parentScope</code> 能让变量跨出上下文</h2>
<p>上一章只是“返回了函数”。闭包真正“神奇”的点在于：<strong>外层函数执行完了，内层函数还能访问外层变量</strong>。</p>
<p>来看这个例子</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">foo</span>(<span class="hljs-params"/>) </span>{
  <span class="hljs-keyword">var</span> name = <span class="hljs-string">"why"</span>;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bar</span>(<span class="hljs-params"/>) </span>{
    console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"小吴"</span>, name);
  }
  <span class="hljs-keyword">return</span> bar;
}

<span class="hljs-keyword">var</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> = <span class="hljs-title">foo</span>(<span class="hljs-params"/>)</span>;

<span class="hljs-function"><span class="hljs-keyword">fn</span>(<span class="hljs-params"/>)</span>;
<span class="hljs-comment">// 小吴 why</span>
</code></pre>
<p>如果只背概念会说：“bar 引用了 foo 的变量 name，所以形成闭包”。但工程上更重要的是 <strong>“它凭什么引用得到？”</strong> ——答案是：<strong>函数对象内部会保存定义时的外层作用域引用（常被描述为 <code>[[scope]] / parentScope</code>）</strong> 。</p>
<h3 data-id="heading-13">3.1 发生了什么：把“访问外层变量”写成一条可执行的查找链</h3>
<p><code>bar()</code> 执行时要查 <code>name</code>：</p>
<ol>
<li>先查自己的 VO/AO（<code>bar</code> 的活动对象）——没有。</li>
<li>沿着函数对象记录的 <code>parentScope</code>（也就是 <code>foo</code> 的 AO）继续查——找到了。</li>
<li>输出 <code>why</code>。</li>
</ol>
<p>也就是说，闭包并不是“让变量不销毁”的魔法，而是：</p>
<blockquote>
<p><strong><code>bar</code> 的函数对象握住了 <code>foo</code> 的 AO 引用，使得这块 AO 对 GC 来说一直是“可达的”。</strong></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5ffe2e56f0f4e51b50aaccd6b0419ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=cPiTS%2Fqx20OVbpS3TrlSRJ9X%2BBU%3D" alt="" loading="lazy"/></p>
<p>** 图7-5 bar函数中的name形成闭包内存图**</p>
<h3 data-id="heading-14">3.2 常见误区：闭包 ≠ 执行上下文永远不销毁</h3>
<p>一个容易混淆的点：<strong>执行上下文（FEC）会销毁</strong>，但 <strong>AO 是否可回收</strong> 取决于有没有被外界引用链保持可达。</p>
<ul>
<li><code>foo()</code> 的执行上下文从调用栈弹出，这是必然的；</li>
<li>但 <code>foo</code> 的 AO 如果被 <code>bar</code> 的 <code>parentScope</code> 引用着，并且 <code>bar</code> 又被 <code>fn</code> 引用着，那么它就仍然可达，无法回收；</li>
<li>“闭包效果”来自这条引用链，而不是来自“执行上下文不销毁”。</li>
</ul>
<h3 data-id="heading-15">本章小结（落地清单）</h3>
<ul>
<li>闭包的底层抓手是：<strong>函数对象持有 <code>parentScope</code>（词法环境引用）</strong> 。</li>
<li>“变量没被回收”不是因为执行上下文不弹栈，而是因为 <strong>对象仍可达</strong>。</li>
<li>解释闭包时，把“查找链”讲出来，团队沟通会更一致。</li>
</ul>
<hr/>
<h2 data-id="heading-16">四、内存视角：普通函数 vs 闭包函数，变量为什么回收/不回收</h2>
<h3 data-id="heading-17">4.1 普通函数：执行完就“自由变量不自由”了</h3>
<pre><code class="hljs language-ini" lang="ini">function foo() {
  var <span class="hljs-attr">name</span> = <span class="hljs-string">"xiaowu"</span><span class="hljs-comment">;</span>
  var <span class="hljs-attr">age</span> = <span class="hljs-number">20</span><span class="hljs-comment">;</span>
}

function test() {
  console.log("test")<span class="hljs-comment">;</span>
}

foo()<span class="hljs-comment">;</span>
test()<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/938b26f9e5094ca590b68bd2e3dc42cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=rY%2BBe0XIfBk%2BCvmCQQVJMbluUv4%3D" alt="" loading="lazy"/></p>
<p>** 图7-6 foo与test函数执行前的初始化表现**</p>
<p>这张图强调：全局 GO 中保存的是函数对象引用；函数对象里保存了 <code>parentScope</code> 指向 GO；调用时创建执行上下文与 AO。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a6a08a2991f4c2789cce2266691d628~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=6rayJ0bDUlqyBt%2Bu%2BkWSDIyzYpk%3D" alt="" loading="lazy"/></p>
<p>** 图7-7 foo函数和test函数的内存图执行过程**</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b979adce5bd4dae8769a805ede4c59b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=6a6E880XmQveY%2BdLGQiKmo4zsdY%3D" alt="" loading="lazy"/></p>
<p>** 图7-8 foo的执行上下文销毁前后对比**</p>
<p>关键结论在图 7-8：<strong>foo 执行结束，AO 里 <code>name/age</code> 没有被任何外部引用链持有，于是变为不可达，被回收</strong>。这就是“自由变量没能真的自由”。</p>
<h3 data-id="heading-18">4.2 闭包函数：AO 被外部引用链锁住，变量驻留</h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">foo</span>(<span class="hljs-params"/>) </span>{
  <span class="hljs-keyword">var</span> name = <span class="hljs-string">"xiaowu"</span>;
  <span class="hljs-keyword">var</span> age = <span class="hljs-number">20</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bar</span>(<span class="hljs-params"/>) </span>{
    <span class="hljs-comment">// 引用了外层变量，形成闭包</span>
    console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"这是我的名字"</span>, name);
    console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"这是我的年龄"</span>, age);
  }

  <span class="hljs-keyword">return</span> bar;
}

<span class="hljs-keyword">var</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> = <span class="hljs-title">foo</span>(<span class="hljs-params"/>)</span>;
<span class="hljs-function"><span class="hljs-keyword">fn</span>(<span class="hljs-params"/>)</span>;
<span class="hljs-comment">// 这是我的名字 xiaowu</span>
<span class="hljs-comment">// 这是我的年龄 20</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ae9a99d740f4b3a8a22d8085283326c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=zPYoV40RD9lciGOTEHv3yJeo1Gk%3D" alt="" loading="lazy"/></p>
<p>** 图7-9 闭包执行前内存图**</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c44bd167e7d4ce39d1a5f70f7cf10ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=FjpVMibCRYp7jEOzYzbVlnompgg%3D" alt="" loading="lazy"/></p>
<p>** 图7-10 foo函数执行内存图**</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4348e96efb047e9a12c7180893fc061~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=S3x6Y001CcgeO3Cv0EUTM2GBL7U%3D" alt="" loading="lazy"/></p>
<p>** 图7-11 bar的函数执行上下文**</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4f46090704142da9614eecd8bbd7a6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=sw4TIgkC1vSyU3%2FykeMAMJpAawI%3D" alt="" loading="lazy"/></p>
<p>** 图7-12 bar脱离捕捉时的上下文，自由变量依旧存在**</p>
<p>图 7-12 是闭包“可解释”的关键画面：</p>
<ul>
<li><code>fn -&gt; bar函数对象</code>（全局根对象可达）</li>
<li><code>bar函数对象 -&gt; parentScope -&gt; foo 的 AO</code></li>
<li>因为这条链存在，所以 <code>foo AO</code> 仍可达，<code>name/age</code> 仍可达</li>
</ul>
<h3 data-id="heading-19">本章小结（落地清单）</h3>
<ul>
<li>普通函数执行完：AO 通常不可达 → 回收。</li>
<li>闭包能驻留变量：本质是 <strong>AO 被函数对象的 parentScope 引用，并且函数对象又被根对象引用</strong>。</li>
<li>是否回收，归根到底看：<strong>从根对象出发是否可达</strong>（标记清除的核心判断）。</li>
</ul>
<hr/>
<h2 data-id="heading-20">五、闭包与内存泄漏：什么时候是“正常驻留”，什么时候是“泄漏”</h2>
<p>闭包会让变量驻留，但<strong>驻留 ≠ 泄漏</strong>。工程上判断泄漏的标准非常朴素：</p>
<blockquote>
<p><strong>本该释放、却因为不必要的引用链而长期可达的内存，占用不断增长或长时间不下降。</strong></p>
</blockquote>
<p>在闭包语境里，常见泄漏模式就是：<strong>返回的函数被长期保存（全局数组/缓存/事件回调/定时器），导致其捕获的外层 AO 一直可达</strong>。</p>
<hr/>
<h2 data-id="heading-21">六、如何释放：最小化闭包作用域、解除引用、弱引用思路</h2>
<h3 data-id="heading-22">6.1 解决策略三件套</h3>
<ol>
<li><strong>最小化闭包作用域</strong>：只捕获必要数据（不要把整坨对象/大数组/DOM 节点顺手闭包进去）。</li>
<li><strong>解除引用</strong>：用完就断开引用链，让对象从根不可达。</li>
<li><strong>弱引用（WeakMap/WeakSet）</strong> ：对“缓存类”场景非常有效（不会阻止 GC）。</li>
</ol>
<h3 data-id="heading-23">6.2 “解除引用”的标准写法：把 <code>fn</code> 指向 <code>null</code></h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 内存泄漏解决方法</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">foo</span>(<span class="hljs-params"/>) </span>{
  <span class="hljs-keyword">var</span> name = <span class="hljs-string">"xiaowu"</span>;
  <span class="hljs-keyword">var</span> age = <span class="hljs-number">20</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"/>) </span>{
    console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"这是我的名字"</span>, name);
    console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"这是我的年龄"</span>, age);
  }

  <span class="hljs-keyword">return</span> test;
}

<span class="hljs-keyword">var</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> = <span class="hljs-title">foo</span>(<span class="hljs-params"/>)</span>;
<span class="hljs-function"><span class="hljs-keyword">fn</span>(<span class="hljs-params"/>)</span>;

<span class="hljs-comment">// 解除引用：断开 root -&gt; fn -&gt; 函数对象 -&gt; AO 的链</span>
<span class="hljs-function"><span class="hljs-keyword">fn</span> = <span class="hljs-title">null</span></span>; <span class="hljs-comment">// 注意：置 null 不会立刻回收，会在后续 GC 周期中回收</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/668f57b5a85444d083de958b78b0800f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=PwpDCN%2FQfiVAdWGiIsn0sEqEpSI%3D" alt="" loading="lazy"/></p>
<p>** 图7-13 fn指向bar的指针**</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f22d0013d114cf997baaca588a5da2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=q1djT4hRd%2F8HpvjslKexdIcRNKo%3D" alt="" loading="lazy"/></p>
<p>** 图7-14 fn指向bar的指针置为null**</p>
<p>图 7-14 的“孤岛”是你需要在脑子里形成的肌肉记忆：<br/>
<strong>只要根对象到不了这块内存，它迟早会被回收</strong>（标记清除的可达性判断）。</p>
<h3 data-id="heading-24">本章小结（落地清单）</h3>
<ul>
<li>释放闭包的核心动作：<strong>断开根对象到函数对象的引用链</strong>（常见是置 <code>null</code> / 移除监听 / 清理数组缓存）。</li>
<li>设计闭包时先问一句： <strong>“我真的需要捕获整个对象/大数组/DOM 吗？”</strong></li>
<li>缓存场景优先考虑：<strong>WeakMap/WeakSet</strong>（避免“缓存越用越大”）。</li>
</ul>
<hr/>
<h2 data-id="heading-25">七、闭包泄漏案例：大对象被闭包捕获，内存与耗时如何爆炸</h2>
<p>为了把问题讲“刺痛”，用一个极端但很真实的例子：闭包捕获一个大数组。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createFnArray</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 创建一个长度为1024*1024的数组，往里面每个位置填充1.观察占了多少的内存空间(int类型，整数1占4个字节byte)</span>
  <span class="hljs-comment">// 4byte*1024=4kb，再*1024为4mb，占据的空间是4M × 100 + 其他的内存 = 400M+</span>
  <span class="hljs-comment">// 在js里面不管是整数类型还是浮点数类型，看起来都是数字类型，这个时候占据的都是8字节，但是js引擎为了提高空间的利用率，对很多小的数字是用不到8个字节(byte)的，8字节 = 2的64次方，所以8字节是很大的，现在的js引擎大多数都会进行优化，对小的数字类型，在V8中称为Smi，小数字 2的32次方</span>
  <span class="hljs-keyword">var</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">1</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">length</span>);
  };
}

<span class="hljs-keyword">var</span> arrayFn = <span class="hljs-title function_">createFnArray</span>();
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f44d02d451164fc48aefe0818476e00d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=hwtr7vlbl3jblR3N8rqRRQDpLkk%3D" alt="" loading="lazy"/></p>
<p>** 图7-15 闭包泄露案例**</p>
<p>如果你把 <code>createFnArray()</code> 创建出来的函数持续保存（比如 push 进数组），引用链会不断叠加：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b73c30d842d14a03af28b8566a3232fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=v3adpfzNLSEhR3x9VUYif8m6J6Y%3D" alt="" loading="lazy"/></p>
<p>** 图7-16 引用叠加，闭包无法释放**</p>
<h3 data-id="heading-26">7.1 用性能工具看“泄漏”长什么样</h3>
<p>在浏览器 Performance 面板勾选 Memory，刷新/执行后，你会看到脚本耗时显著升高：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f9286297a86467583855e85ea6a638a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=WFke6mso1MbutEPgxY2RvtXIyDg%3D" alt="" loading="lazy"/></p>
<p>** 图7-17 闭包的性能检测**</p>
<h3 data-id="heading-27">7.2 释放后的对比：不一定立刻回收，但趋势会回来</h3>
<pre><code class="hljs language-ini" lang="ini">function createFnArray() {
  var <span class="hljs-attr">arr</span> = new Array(<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>).fill(<span class="hljs-number">1</span>)<span class="hljs-comment">;</span>

  return function () {
    console.log(arr.length)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
}

var <span class="hljs-attr">arrayFns</span> = []<span class="hljs-comment">;</span>
for (var <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 100; i++) {</span>
  // createFnArray() // 不接收就会很快变成不可达
  arrayFns.push(createFnArray())<span class="hljs-comment">;</span>
}

setTimeout(() =&gt; {
  <span class="hljs-attr">arrayFns</span> = null<span class="hljs-comment">; // 关键：断开引用链</span>
}, 2000)<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1abec8bf4b2e4e19a52f7b6778a1c2d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=jvH4jsTBh4jv4%2FRbiBpjt1K8H%2BU%3D" alt="" loading="lazy"/></p>
<p>** 图7-18 性能提升效果**</p>
<p>你还能通过调用树看到耗时主要来源于闭包相关逻辑：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bae886e2577b48caa0ec91a9ec18caab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=e4mdk6tI4nGHyfrhQeLAqJD9%2FXM%3D" alt="" loading="lazy"/></p>
<p>** 图7-19 闭包耗时来源**</p>
<h3 data-id="heading-28">本章小结（落地清单）</h3>
<ul>
<li>闭包泄漏常见触发器：<strong>闭包捕获大对象 + 长期保存闭包引用</strong>（数组/缓存/事件/定时器）。</li>
<li>Performance 勾选 Memory：关注 <strong>脚本耗时 + 内存曲线是否持续上升</strong>。</li>
<li>“置 null”不保证立刻回收，但能保证：<strong>后续 GC 周期具备回收条件</strong>。</li>
</ul>
<hr/>
<h2 data-id="heading-29">八、引擎优化：闭包里“没用到的变量”会怎样（V8）</h2>
<p>一个很实用的问题：闭包让外层 AO 不回收，那 AO 里<strong>没用到的属性</strong>会不会也一直占着？</p>
<p>例子：闭包只用 <code>name</code>，没有用 <code>age</code>：</p>
<pre><code class="hljs language-ini" lang="ini">function foo() {
  var <span class="hljs-attr">name</span> = <span class="hljs-string">"why"</span><span class="hljs-comment">;</span>
  var <span class="hljs-attr">age</span> = <span class="hljs-number">18</span><span class="hljs-comment">;</span>

  function bar() {
    debugger<span class="hljs-comment">;</span>
    console.log(name)<span class="hljs-comment">;</span>
  }

  return bar<span class="hljs-comment">;</span>
}

var <span class="hljs-attr">fn</span> = foo()<span class="hljs-comment">;</span>
fn()<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56f5062a91f248f6841ef63559e92bb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=rb3kLzpnrKYqoR5biTWZLaM8avY%3D" alt="" loading="lazy"/></p>
<p>** 图7-20 V8引擎优化效果(未使用变量被销毁)**</p>
<p>继续在 debugger 暂停时验证：<code>name</code> 能访问，<code>age</code> 可能因为未使用被优化掉：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fee0b4211abd427daef68878db2e1537~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770602315&amp;x-signature=2f8TZzsUN0U7nGEH8E%2FMUkSOVyw%3D" alt="" loading="lazy"/></p>
<p>** 图7-21 debugger检测未使用的age变量是否真被回收**</p>
<p>这点对工程实践的启示非常直接：</p>
<ul>
<li>规范上你可以认为“闭包会保留整个 AO”；</li>
<li>但引擎实现会做逃逸分析/变量提升优化等，<strong>减少无用变量占用</strong>；</li>
<li><strong>不要依赖这种优化写代码</strong>：它是实现细节，不是稳定契约（尤其跨引擎/跨版本）。</li>
</ul>
<h3 data-id="heading-30">本章小结（落地清单）</h3>
<ul>
<li>V8 可能回收闭包外层 AO 中“未被使用的变量”（实现优化）。</li>
<li>工程判断别靠“引擎可能帮我优化”，仍以 <strong>引用链是否可达</strong> 为主。</li>
<li>评审时更关注：<strong>闭包是否捕获了不必要的大对象/DOM/业务上下文</strong>。</li>
</ul>
<hr/>
<h2 data-id="heading-31">九、进阶边界：多个闭包实例彼此独立；为什么 <code>null</code> 能断引用而 <code>undefined</code> 不行</h2>
<h3 data-id="heading-32">9.1 多个闭包实例：互不影响，释放也只释放自己的那份</h3>
<p>同一个 <code>foo()</code> 调两次，得到的是两套独立的 AO 与函数对象：</p>
<pre><code class="hljs language-ini" lang="ini">function foo() {
  var <span class="hljs-attr">name</span> = <span class="hljs-string">"小吴"</span><span class="hljs-comment">;</span>
  var <span class="hljs-attr">age</span> = <span class="hljs-number">18</span><span class="hljs-comment">;</span>

  function bar() {
    console.log(name)<span class="hljs-comment">;</span>
    console.log(age)<span class="hljs-comment">;</span>
  }

  return bar<span class="hljs-comment">;</span>
}

var <span class="hljs-attr">fn</span> = foo()<span class="hljs-comment">;</span>
fn()<span class="hljs-comment">;</span>

var <span class="hljs-attr">baz</span> = foo()<span class="hljs-comment">;</span>

<span class="hljs-attr">fn</span> = null<span class="hljs-comment">; // 只会释放 fn 对应的那一套引用链</span>
baz()<span class="hljs-comment">;</span>
</code></pre>
<p>这条结论在工程里特别重要：<strong>你清理了一个引用，不代表全局都释放了</strong>。如果你把闭包存进多个地方（例如多个数组、多个事件回调、多个缓存），就需要逐个断链。</p>
<h3 data-id="heading-33">9.2 为什么 <code>null</code> 可以解除引用，而 <code>undefined</code> 不行？</h3>
<p>这里有一个值得思考的问题：为什么 <code>null</code> 可以解除引用，而 <code>undefined</code> 不行？</p>
<p>从“引用链”的角度看：</p>
<ul>
<li><code>null</code> 是一个明确的“空值”，把变量指向空处，等价于 <strong>把这条引用边砍掉</strong>。</li>
<li><code>undefined</code> 更多表达“未初始化/缺省值”，它依然是一个值；更关键的是，在很多语义下它并不被用作“主动断链”的表达（团队代码规范也通常不推荐用 <code>undefined</code> 表达释放）。</li>
</ul>
<blockquote>
<p>工程建议：<strong>释放引用请用 <code>null</code></strong>（语义清晰、团队共识强、便于 code review 与静态检查）。</p>
</blockquote>
<h3 data-id="heading-34">本章小结（落地清单）</h3>
<ul>
<li>每次调用外层函数，都会创建一套新的 AO/函数对象：闭包实例彼此独立。</li>
<li>释放引用只影响对应那条链：<strong>你清理一个，不会自动清理所有</strong>。</li>
<li>断链用 <code>null</code>：表达“我主动释放”，比 <code>undefined</code> 更清晰。</li>
</ul>
<hr/>
<h2 data-id="heading-35">十、实战建议：把“闭包可控”落到团队工程规范里</h2>
<p>下面给一份可以直接放进团队“代码评审 checklist / 性能排查 SOP”的清单。</p>
<h3 data-id="heading-36">10.1 评审 Checklist（闭包相关）</h3>
<ul>
<li><strong>捕获内容最小化</strong>：闭包里只引用必要字段，避免把整个 <code>props/state/context/大对象</code> 捕获进去。</li>
<li><strong>避免捕获 DOM 节点</strong>：尤其是长生命周期的闭包（事件回调/单例缓存）捕获 DOM，会让节点难以回收。</li>
<li><strong>长生命周期容器要可清理</strong>：全局数组、Map 缓存、事件总线、定时器回调——都要有对应的清理路径。</li>
<li><strong>组件/页面卸载必须断链</strong>：移除事件监听、取消订阅、清理定时器、清空缓存引用（<code>= null</code>）。</li>
<li><strong>缓存优先 WeakMap</strong>：key 是对象的缓存（如 DOM 节点、组件实例）优先 WeakMap，减少“缓存常驻”。</li>
</ul>
<h3 data-id="heading-37">10.2 排查 SOP（内存/性能）</h3>
<ol>
<li>Performance 勾选 Memory：复现操作，观察内存曲线是否持续上升（不回落）。</li>
<li>录制并看调用树：定位高耗时函数是否来自闭包创建/大对象捕获。</li>
<li>缩小复现：把闭包引用容器（数组/缓存）逐步置 <code>null</code>，观察趋势变化（不是立刻回收，但趋势会变）。</li>
<li>检查引用链：谁在持有闭包？（全局变量、单例模块、事件总线、定时器、DOM 监听器最常见）</li>
</ol>
<h3 data-id="heading-38">10.3 指标验证（建议团队共用）</h3>
<ul>
<li><strong>内存指标</strong>：关键页面操作 5 分钟后，JS Heap 是否可稳定回落到阈值区间</li>
<li><strong>性能指标</strong>：关键交互的 Long Task 次数/总耗时是否下降</li>
<li><strong>回归验证</strong>：增加“卸载/切页/重复进入”压测脚本，验证引用链不会累积</li>
</ul>
<hr/>
<h2 data-id="heading-39">总结：关键结论 + 团队落地建议</h2>
<h3 data-id="heading-40">关键结论（背下来就够用）</h3>
<ul>
<li>闭包的本质是：<strong>函数对象持有定义时的外层作用域引用（parentScope/词法环境）</strong> ，从而让外层 AO 继续可达。</li>
<li>是否回收不看“函数执行没执行完”，只看 <strong>从根对象出发是否可达</strong>（标记清除的核心）。</li>
<li>闭包造成的风险不是“用了闭包”，而是：<strong>闭包捕获了不该长期驻留的对象，并且闭包引用被长期持有</strong>。</li>
<li>释放闭包的关键动作是：<strong>断开引用链</strong>（置 <code>null</code>、移除监听、清空容器、取消订阅等）。</li>
<li>引擎可能优化未使用变量（如 V8），但工程上不要依赖实现细节，仍以引用链分析为准。</li>
</ul>
<h3 data-id="heading-41">下一步建议（怎么在团队里真正落地）</h3>
<ol>
<li>把“闭包评审 checklist”加入 PR 模板：涉及事件、缓存、定时器、订阅时必须勾选清理项。</li>
<li>建立 1~2 个“典型泄漏 demo”用于 onboarding：让新人用 Performance/Memory 亲手看见“可达性”是什么。</li>
<li>在关键业务页引入定期压测（重复进入/退出/滚动/筛选等），用指标验证“内存可回落”。</li>
<li>对缓存策略做统一约束：对象 key 的缓存优先 WeakMap；全局数组缓存必须提供清理 API。</li>
</ol>
<p>只要团队能把闭包从“语法点”升级成“引用链与可达性”的共识，闭包就会从“玄学”变成“可控工具”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 中的同步 & 互斥]]></title>    <link>https://juejin.cn/post/7601486204173795378</link>    <guid>https://juejin.cn/post/7601486204173795378</guid>    <pubDate>2026-02-01T14:07:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601486204173795378" data-draft-id="7601374668961579058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 中的同步 &amp; 互斥"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-02-01T14:07:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SereneDream"/> <meta itemprop="url" content="https://juejin.cn/user/4250057782345273"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 中的同步 &amp; 互斥
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4250057782345273/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SereneDream
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T14:07:45.000Z" title="Sun Feb 01 2026 14:07:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这篇小记偏向于理论，即 Java 底层是怎么实现互斥同步</p>
<p>锁是信号量的一个子集，目的就是通过 PV 操作控制信号量从而保护临界区中的临界资源</p>
<p>信号量是锁的超集，而PV操作是操作信号量的原语。锁（互斥锁）是信号量的一种特殊用法（初始值为1的信号量）。它们共同的目标是为了保护临界区，从而实现安全地访问临界资源。PV 操作的作用就是为了完成同步和互斥这两个功能</p>
<p>PV 操作是 OS 自带的原语操作，内核才有防止中断的权限，并发和并行是产生数据不同步的根本原因，PV 操控通过控制信号量来互斥地访问临界区中的临界资源，而锁是信号量的一个子集</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a7a7780cf2644c9a07069aafdd9acc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770559665&amp;x-signature=gr9A8jv1U%2F9SEJ%2BDixsGtUc56io%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">题记</h2>
<p>进程之间为什么要实现互斥：不同进程之间可能会共享某项资源。</p>
<p>进程之间为什么要实现同步：不同进程之间的操作可能会存在先后关系</p>
<h2 data-id="heading-1">临界资源 &amp;&amp; 临界区</h2>
<p>临界资源被存放在临界区中，OS 可以通过访问临界区去访问对应的临界资源</p>
<ol>
<li>临界资源</li>
</ol>
<p>临界资源是<strong>一次仅允许一个进程使用的共享资源</strong>。各进程采取<strong>互斥</strong>的方式，实现共享的资源称作临界资源。</p>
<p>属于临界资源的硬件有，打印机，磁带机等；软件有消息队列，变量，数组，缓冲区等。诸进程间采取互斥方式，实现对这种资源的共享。</p>
<ol start="2">
<li>临界区：</li>
</ol>
<p>每个进程中访问临界资源的那段代码称为临界区（criticalsection），每次只允许一个进程进入临界区，进入后，不允许其他进程进入。不论是硬件临界资源还是软件临界资源，多个进程必须互斥的对它进行访问。</p>
<p><strong>多个进程涉及到同一个临界资源的的临界区称为相关临界区。</strong></p>
<p>使用临界区时，一般不允许其运行时间过长，只要运行在临界区的进程还没有离开，其他所有进入此临界区的进程都会被挂起而进入阻塞状态，并在一定程度上影响程序的运行性能。</p>
<p>临界资源一般被放置在内存中，在一台计算机中的处理机读取的是同一个内存。</p>
<p>同步机制应当遵循的准则:</p>
<ul>
<li>空闲让进：临界区空闲时，可以允许一个请求进入临界区的进程立即进入临界区</li>
<li>忙则等待：当已经有进程进入临界区时，其他试图进入临界区的进程必须等待</li>
<li>有限等待：对请求访问临界区的进程，应保证其在有限的时间内进入临界区</li>
<li>让权等待：当进程不能进入临界区时，应立即释放处理机</li>
</ul>
<h2 data-id="heading-2">原语操作</h2>
<p>原语操作指的是一系列操作从开始执行到结束都不允许被中断</p>
<h2 data-id="heading-3">并发 &amp; 并行</h2>
<p>并发和并行的区别仅在于“是否拥有多个处理机”</p>
<p>从宏观来看，并发与并行属于同时运行的，多个进程之间处于异步，没有区别</p>
<p>从微观来看：</p>
<ul>
<li>并发：发生在一个处理机上的多个进程，在一个时间段内，有多个任务都处于启动到运行完毕之间的状态，这些任务在同一个处理器上运行。</li>
<li>并行：发生在多个处理机上的多个进程，在一个时间段内，多个处理器或者多核处理器上同时处理多个任务。</li>
</ul>
<p>如下图：</p>
<p>并行</p>
<p>X 轴是时间；Y 轴是进程</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7e646f4f82543b387e72ae0115d9730~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770559665&amp;x-signature=1mZ8hhBL%2BsIn5AfyMyM7Kipnhkg%3D" alt="" loading="lazy"/></p>
<p>并发</p>
<p>X 轴是时间；Y 轴是进程</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39c7854940724a9ebb2778a965a13444~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770559665&amp;x-signature=7gbQIDWMLinn1l7coa0ac49COXQ%3D" alt="" loading="lazy"/></p>
<p>并发就是一个处理器去分神处理多个进程</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a330ded6cf2425c9dd64e588342247f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770559665&amp;x-signature=8irsiFBC8%2BrekIm40KAovrJbLbM%3D" alt="" loading="lazy"/></p>
<p>并行就是多个处理器专一去处理多个进程</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6eb5c6889b3f4702a5aa7ee16292da2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770559665&amp;x-signature=9hxvEiaOaCKachIZjRibZx0R4e0%3D" alt="" loading="lazy"/></p>
<p>来个比喻：并发是一个人同时吃三个馒头，而并行是三个人同时吃三个馒头。</p>
<p>宏观角度来看，都没了三个馒头，但从微观的角度看就不一样了</p>
<h2 data-id="heading-4">信号量 - “数据 / 计数器”</h2>
<p>它本质上就是一个整数变量，用来记录某项资源的数量。</p>
<p>信号量是 OS 提供的一种机制，用于表示临界资源的数量</p>
<p>比如 int count = 5</p>
<h2 data-id="heading-5">PV 操作 - “动作 / 方法”</h2>
<p>这是对信号量进行操作的唯一途径（原语）：</p>
<p>P (Proberen = 尝试/申请）--- 申请一个资源，如果资源不够就阻塞等待（进入阻塞队列）</p>
<p>P操作的底层，是申请并获得了对“信号量”这个共享数据结构的独占修改权。利用这个独占权，它原子地完成了对资源状态的判断和更新，从而决定了当前进程是否有权访问真正的临界资源</p>
<p>V (Verhogen = 增加/释放) --- 释放一个资源，如果有进程在等待该资源，则唤醒一个进程</p>
<p>V操作的底层则是返还了“信号量”这个共享数据结构，在“信号量”这个共享数据结构被更新后，如果当前“信号量”仍为负数（代表当前有其他进程正在请求这个共享数据结构，并处于阻塞状态）就将阻塞队列的头进程唤醒，它会进入就绪态</p>
<h2 data-id="heading-6">锁 - “特例 / 应用”</h2>
<p>锁是一种特殊的信号量，它的资源只有 1（即：要么是 0，要么是 1）。</p>
<p>所以，互斥 = 初始值为 1 的信号量。</p>
<p>在 Java 中，ReentrantLock 就是把 PV 操作封装成了 lock() 和 unlock() 方法给程序员使用。</p>
<h2 data-id="heading-7">Java 是怎么使用同步和互斥的？</h2>
<p>锁（Lock）不是资源本身，锁是访问资源的“入场券”。</p>
<h3 data-id="heading-8">显式锁 - ReentrantLock - 互斥量</h3>
<p>在 Java 中可以使用 Lock.lock 对一块地方上锁（其实是 JVM 向 OS 申请了一块互斥空间/临界资源），在 Java 中，变量可以被放置到临界资源区中，这样子来实现锁</p>
<p>例如</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 1. 【抢钥匙】</span>
<span class="hljs-comment">// 这一步不是申请资源，而是“申请访问资源的权限”。</span>
<span class="hljs-comment">// 如果拿到钥匙，就进门；拿不到，就在门口排队（阻塞）。</span>
<span class="hljs-keyword">lock</span>.<span class="hljs-keyword">lock</span>(); 

<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 2. 【临界区 (Critical Section)】</span>
    <span class="hljs-comment">// 只有拿到了钥匙的线程，才能运行这几行代码。</span>
    <span class="hljs-comment">// 在这里，你可以安全地操作“临界资源”（比如 map.put, count++）。</span>
    <span class="hljs-comment">// 此时，别人进不来，因为钥匙在你兜里。</span>
    map.put(<span class="hljs-string">"key"</span>, <span class="hljs-number">1</span>); 

} <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 3. 【还钥匙】</span>
    <span class="hljs-comment">// 这一步不是把资源还给 OS（厕所还在），而是“归还权限”。</span>
    <span class="hljs-comment">// 把钥匙挂回墙上，通知门口排队的人：“我用完了，你们抢吧”。</span>
    <span class="hljs-keyword">lock</span>.unlock(); 
}
</code></pre>
<p>其实 Java 在 lock 的底层就已经实现了阻塞了，那么这个时候就有人要问了，老师老师，那我们（Condition）呢？</p>
<p>一句话总结：阻塞 不等于 释放锁。只有 Condition.await() 才能做到 “在阻塞的同时释放锁”。</p>
<p>把话说得更日常一点：你在食堂吃饭，一般来讲就是 先抢位置（抢锁） -&gt; 去打饭（调用资源） -&gt; 吃饭（使用资源） -&gt; 离开（释放资源和锁） 这一个过程</p>
<p>lock 相当于你抢了一个位置，然后在排打饭队伍，快到你了告诉你：小伙子不好意思啊，饭没了，你得等一下了，condition 的做法是你先把座位放开，让其他已经打了饭同学可以坐，然后你去等阿姨跟你说，饭好了，然后你再去抢座位，抢饭。</p>
<p>如果没有 condition，相当于阿姨跟你说没饭了，你说：那没事儿，我等等，但是座位还是你的啊，其他要吃饭的人就没座位了，那不就是占着茅坑不拉屎了吗？</p>
<h3 data-id="heading-9">隐式锁 - synchronized - 管程</h3>
<p>在 JDK 编写过程，开发者就已经给每一个对象上了一把隐式锁</p>
<p>隐式锁可以通过添加 synchronized 关键字开启</p>
<h3 data-id="heading-10">Java中为什么基本数据类型不能加锁</h3>
<p>简单来说，之所以基本数据类型不能加锁的原因是：基本数据类型的大小是固定的，没有多余的空间去放锁头</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d040615fa584d4f896586acc4977d15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770559665&amp;x-signature=Z4CAJpadxq7%2BiYzHC4JVG5a0nRo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">死锁</h3>
<p>由多个并发进程因争夺系统资源而产生相互等待的现象</p>
<p>死锁产生的四个必要条件</p>
<ul>
<li>互斥：某种资源一次只允许一个进程访问，即该资源一旦分配给某个进程，其他进程就不能再访问，直到该进程访问结束。</li>
<li>占有且等待：一个进程本身占有资源（一种或多种），同时还有资源未得到满足，正在等待其他进程释放该资源。</li>
<li>不可抢占：别人已经占有了某项资源，你不能因为自己也需要该资源，就去把别人的资源抢过来。</li>
<li>循环等待：存在一个进程链，使得每个进程都占有下一个进程所需的至少一种资源。</li>
</ul>
<h3 data-id="heading-12">如何预防和避免死锁</h3>
<p>预防死锁：可以通过<strong>破坏死锁产生的4个必要条件来 预防死锁</strong></p>
<p>死锁避免：在使用前进行判断，只允许不会产生死锁的进程申请资源；</p>
<h2 data-id="heading-13">结语</h2>
<p>在 Java 中，锁是 JDK 底层请求 OS 对临界区中的临界资源进行 PV 操作的实际操作，对于多线程和高并发来讲十分重要。</p>
<p>锁是一种同步机制，用于在存在资源竞争的环境中，强制限制对资源的访问顺序。它可以被理解为一个“令牌”或“许可证”，谁拿到了这个令牌，谁就有权访问被保护的资源。</p>
<p>锁的逻辑围绕着两个基本操作：获取锁 和 释放锁，以及它们之间的代码区域——临界区。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[领域驱动设计实践01：捕获行为需求与领域建模]]></title>    <link>https://juejin.cn/post/7601374137411846179</link>    <guid>https://juejin.cn/post/7601374137411846179</guid>    <pubDate>2026-02-01T15:05:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601374137411846179" data-draft-id="7601175299012001807" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="领域驱动设计实践01：捕获行为需求与领域建模"/> <meta itemprop="keywords" content="领域驱动设计"/> <meta itemprop="datePublished" content="2026-02-01T15:05:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zephyr"/> <meta itemprop="url" content="https://juejin.cn/user/184373685791992"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            领域驱动设计实践01：捕获行为需求与领域建模
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/184373685791992/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zephyr
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T15:05:41.000Z" title="Sun Feb 01 2026 15:05:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<ul>
<li>最近在给团队内部做DDD实践落地的宣讲与培训，期间也略有一些心得，
会定期发表出来跟大家一起交流。如果文中有错误的部分，恳请大家批评指正。</li>
<li>感谢 ThoughtWorks 各大DDD专家的不懈布道。</li>
</ul>
</blockquote>
<p>DDD（Domain-Driven Design）的定义：是一种开发复杂软件的方法与思想。</p>
<p>DDD中的领域，指的是软件要解决的业务问题，因此也可称为“业务领域”（Business Domain）。</p>
<p>DDD是以领域模型为核心的，具体分为2个阶段：</p>
<ul>
<li>领域建立（2个步骤）：捕获行为需求（事件风暴） → 领域建模
<ul>
<li>捕获行为需求：也就是传统意义上的获取需求，识别业务流程与功能、由哪些角色操作、产生什么结果等</li>
<li>领域建模：通过建立领域模型，把主要的业务知识描述清楚</li>
</ul>
</li>
<li>领域实现（3个步骤）：架构设计 → 数据库设计 → 代码实现
<ul>
<li>实现的部分主要就是基于之前的领域建模，通过代码的方式呈现。</li>
</ul>
</li>
</ul>
<p>后续案例中主要基于一个小型企业服务项目展开，其中的业务功能主要包含：租户管理、人员与组织管理、项目管理、工时管理等。</p>
<h2 data-id="heading-0">一、捕获行为需求：事件风暴</h2>
<p>为什么需要事件风暴：需求通常停留在领域专家的脑海中，很难一股脑全部讲出来，事件风暴正是一种套路化方法，能够把这些需求挖掘出来</p>
<p>捕获行为需求指的是：分析系统具有哪些功能，这些功能由什么人操作，会产生什么效果。</p>
<p>过程中最常用的方法就是事件风暴，其主要过程如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7612b54f5c04cedaa4c70140fcec3fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemVwaHly:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563144&amp;x-signature=fgoUBRYzKYZHISfxLGGFe5d81Go%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>识别领域事件：业务流程中发生了什么</li>
<li>识别命令：什么角色做了什么操作</li>
<li>识别领域名词：从领域事件、命令中找到概念性名词</li>
</ul>
<h3 data-id="heading-1">1.1 第一步：识别领域事件</h3>
<p>领域事件：指的是业务流程中每个步骤引发的结果。（注意，必须是引发的结果）</p>
<p>例如：订单（已）提交、商品（已）签收等。</p>
<p>从操作结果来梳理需求，比直接从操作过程中梳理，更容易梳理清楚。事件风暴中的“事件”，就来自于领域事件。</p>
<p>在命名领域事件时，通常使用的是【xx已xx】的形式。但如果已经有广泛使用或现成的行业术语，则应优先使用这部分术语。例如：通常用【已立项】而不是【项目已创建】</p>
<p>识别领域事件是团队协作等过程，尤其注意业务人员、开发任务要统一语言（统一业务术语、用词等）。</p>
<p>如下两个种情况，不属于领域事件：</p>
<ul>
<li>技术事件，例如：事务已回滚、缓存已命中等</li>
<li>查询功能，因为查询并不能对事物产生实际影响</li>
</ul>
<p>在梳理与识别领域事件时，可以按不同的业务流分别梳理到表格中。这是团队协作的过程，每个领域事件都要得到团队集体的认可。首先可以在表格中维护业务流程名、领域事件（业务结果），备注（约束条件）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/560a8fb09edb4d9e9ff582a6f4b6c41f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemVwaHly:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563144&amp;x-signature=OVPAsarmll8cQ6G3k35UjCwLy4A%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">1.2 第二步：识别命令</h3>
<p>命令，指的是引发领域事件的操作。例如【合同已签订】这个事件对应的命令就是【签订合同】。</p>
<p>除了识别出命令本身，还要能识别出来如下信息：</p>
<ul>
<li>谁执行的命令</li>
<li>执行这个命令查询了哪些数据</li>
</ul>
<p>这时，我们就可以在表格中添加3列：命令、执行者、查询数据:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12b06d70c30e448eb6754a296716f5c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemVwaHly:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563144&amp;x-signature=scREQvQyvGkvE2m3UUE%2BB3vXbvA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">1.3 第三步：识别领域名词</h3>
<p>领域名词，是从命令、领域事件、执行者、查询数据里找到的、受影响的名词性概念。例如：命令【签订合同】、领域事件【合同已签订】，影响到的名词性概念都是【合同】。</p>
<p>可以根据前一步骤汇总的数据（领域事件、命令、执行者、查询数据），把围绕同一个名词的放到同一个组下，如果一个命令或领域事件涉及了多个领域名词（例如：【员工已分配到项目】这个领域事件就同时与【员工】、【项目】这2个领域名词有关），则誊写多份，分别放到不同的领域名词分组下，并标记誊写的次数（2、3等）。</p>
<p>示例如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1668bbdf62484d6f9b6f2d6a1332ed78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemVwaHly:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563144&amp;x-signature=%2B%2BYqby7KMSw5o32lGevbw0KZpCU%3D" alt="image.png" loading="lazy"/></p>
<p>部分分组（企业、管理员等）缺少领域事件也没关系，可以在后面领域建模等时候再细化。</p>
<h3 data-id="heading-4">1.4 注意事项：</h3>
<ul>
<li>在事件风暴里只列出主要的步骤，无需列举增删改等基础功能</li>
<li>事件风暴中领域事件只需要按照大致的时间顺序呈现，不用很严格（如果需要严格时间顺序，可以单独画具体的流程图、时序图等）</li>
<li>每个步骤（一对领域事件与命令）的粒度宜粗不宜细。例如“签订合同“是一个合理的步骤，不用拆分成”录入合同基本信息“、”录入合同明细“、”上传附件“等</li>
<li>事件风暴只是理清业务等一种手段，实际执行时不用拘泥于形式。可以用表格等形式，以电子等形式保存、维护事件风暴的成果。</li>
<li>领域规则（业务上必须成立的条件或约束）是重要的领域知识，也可以借助表格的形式梳理，与事件风暴（捕获行为需求）的成果分开维护，这部分的代码需要完全在领域层实现。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a4809acdcdd43efbeec1c0d88882b51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemVwaHly:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563144&amp;x-signature=IY%2BK93EHU3PBdgXQjoxOFmKa6yo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">二、领域建模实践</h2>
<p>领域建模的目的：</p>
<ul>
<li>准确反映领域知识，把知识可视化，在业务、技术人员之间达成一致</li>
<li>指导系统与编码，能够较容易地转化为数据库模数与代码实现</li>
</ul>
<p>建立领域模型，就是要：</p>
<ul>
<li>
<p>识别领域对象（domain object）</p>
</li>
<li>
<p>识别领域对象之间的关系</p>
</li>
<li>
<p>识别领域对象的关键属性</p>
</li>
<li>
<p>按需把领域对象组织成模块</p>
</li>
</ul>
<h3 data-id="heading-6">2.1 建模实践</h3>
<p>领域对象指的是系统中要处理的各种“事物”，比如说项目、员工、账户等等。</p>
<p>领域模型图通常用UML图（Unified Modeling Language）来画，其中的领域模型常用类图来画，表头表示领域对象的名词，下面的属性表示对象的属性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5a8552340494d5b9323f88372b9d348~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemVwaHly:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563144&amp;x-signature=z5nATIb9JzBgkl0p1d7SqL5A17Q%3D" alt="image.png" loading="lazy"/></p>
<p>在领域建模过程中说领域对象时，有时指类，有时指实例，一般可以通过上下文来区分。比如，员工是领域对象的一个类，张三和李四是这个类的实例。</p>
<p>在领域建模阶段，在画类图的时候，无需写出属性。主要关注的是实体和它们之间的关系，如果实体的名字已经能清晰说明实体的含义，那就不需要加属性了。</p>
<p>如果只关注前面梳理的租户、组织，则可以先画出如下的类图</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a25ddbf60aa24564ada937f6bc275c37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemVwaHly:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563144&amp;x-signature=uOEVowDlHu8JuJ6r8eeO3r2O2Go%3D" alt="image.png" loading="lazy"/></p>
<p>由于每个实体都要属于租户，因此，UML图上就不把租户跟每个实体关联起来了，而是在租户的旁边加上一段表示约束的说明：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3bd2f0f12d94bc5a48d5b052f40a7bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemVwaHly:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563144&amp;x-signature=Jk%2B1Jp5cHbLJCCdWTA4SUEvbNbg%3D" alt="image.png" loading="lazy"/></p>
<p>现在我们开看下企业、开发中心、开发组，他们从左到右依次是一对多的关系。如果直接画到UML图中，则如果其中后续组织架构调整，要添加其他部门，或开发中心下不再设置开发组，那这个模型就要修改了。</p>
<p>也就是说，这个模型不易适应业务的变化。这个时候就要把实体进行抽象（归纳共性）</p>
<p>企业、开发中心、开发组，都可以抽象为“组织”，通过类型区分。并添加自我关联的方式体现上下级关系。</p>
<p>示例如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e2563bd2e7143b08906e1974565512f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemVwaHly:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563144&amp;x-signature=tYgqL%2B6emY8NV3R3IKNqZHkZsMU%3D" alt="image.png" loading="lazy"/>
其中：</p>
<ul>
<li>每个类图都表示一个领域对象</li>
<li>领域对象之间的连线表示关联关系</li>
<li>领域对象的自我关联则体现了上下级的层级关系，线边的文字表示角色（例如：上级、下级……）</li>
<li>带折角的图形描述了相关的说明，通过虚线连接到领域对象</li>
<li>带折角图形中用{  } 包裹的部分，表示对应的约束，需要在代码中做对应的实现</li>
<li>线边的数字表示A对象最少..最多关联多少个B对象</li>
</ul>
<p>注意同步修改领域汇总表（事件风暴成果物）中的内容：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a86b4d066d54496184c2a71659f26cc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemVwaHly:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563144&amp;x-signature=jDfgtvOkbo9FCopvE9iCy8iYqXo%3D" alt="image.png" loading="lazy"/>
在建模过程中项目想把多重性搞清楚，则可以通过问四个问题：</p>
<ul>
<li>
<p>实体 A 最多可以对应多少个实体 B？</p>
</li>
<li>
<p>实体 A 最少可以对应多少个实体 B？</p>
</li>
<li>
<p>实体 B 最多可以对应多少个实体 A？</p>
</li>
</ul>
<h3 data-id="heading-7">2.2 拆分多对多关联</h3>
<p>有些业务数据是基于关联关系记录的，只有关联关系成立，这些业务数据才有意义。这个时候可以通过引入一个表示关联的实体，把一个多对多关系拆成两个一对多的关联。</p>
<p>比如员工与项目是多对多关系，这个时候又需要记录员工的预计投入百分比，这个属性记录在员工或项目都不合适。这个时候就可以引入一个表示关联的实体（项目成员），来记录这些需要记录在多对多关联上的属性</p>
<p>最终形成了如下的模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/801544a766a349b7bc57295ed5c0a0bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemVwaHly:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563144&amp;x-signature=FBa8k2NtaPHbrvaV4oEIZVRpBxE%3D" alt="image.png" loading="lazy"/></p>
<p>依赖与关联表达的是不同的含义。</p>
<ul>
<li>关联：表示的是数据上的导航关系。例如，当我们说组织和员工之间具有一对多关联的时候，就意味着，由组织可以找到下面的员工，由员工也可以找到所属的组织。</li>
<li>依赖：表示的意思更为广泛。如果 A、B 两个元素，有了 A 才能有 B，那么就可以说 B 依赖于A。</li>
</ul>
<p>此时，这个图已经有点乱了，很多实体和关联混杂在一起，而人的认知能力是有限的，面对这样一张复杂的对象网络，就产生了认知过载。需要把这张图模块化，把模型中的业务概念组织成若干高内聚的模块（module），而模块之间尽量低耦合。</p>
<h3 data-id="heading-8">2.3 划分模块</h3>
<p>在 UML 中，可以用包来表示模块，包的内部可以包含实体，也可以包含另外的包。包的符号是下面这样：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cc95aa137cc41c1bcb7cad30969de62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemVwaHly:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563144&amp;x-signature=VavWPy4DyZ2QP2cNt%2BZtGPqrqTs%3D" alt="image.png" loading="lazy"/></p>
<p>经过模块化处理之后，把模型分成了 4 个模块，分别是租户管理、组织管理、项目管理和工时管理</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2d7662e333b4921abf2db14e9dd875e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemVwaHly:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563144&amp;x-signature=b2%2B%2F9sRe6AlUExhVQrvCEkhN8hk%3D" alt="image.png" loading="lazy"/></p>
<p>有了模块，就可以从两个层面理解模型。</p>
<p>第一个是宏观层面。宏观层面只关心模型中有哪些模块，以及模块间的依赖关系，不关心模块的内部细节：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a341573bbeec45aa87296506a94c6f95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemVwaHly:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563144&amp;x-signature=o9%2B5XkpbeJWS6i5OR4Po8frFFFs%3D" alt="image.png" loading="lazy"/></p>
<p>其中的虚线表示依赖关系，箭头由依赖方指向被依赖方。</p>
<p>第二个层面是微观层面，也就是深入到模块内部，了解实体和关联等等的细节。</p>
<p>为了完善开发过程，我们还要再进行两个实践：一个是完善业务规则，另一个是建立词汇表。</p>
<p>词汇表可以规范领域模型中的词汇，并用于后续编程中的命名</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ce1f5f6b9d04aa9b1c9290092f085f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemVwaHly:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563144&amp;x-signature=dxVyqy5wjyYZC5%2FDR%2FZ0wothMiA%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/764437b141514eefacc3a95ab6c3fb9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemVwaHly:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563144&amp;x-signature=sWNVat6V8rvATOimXtKValcoAnU%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【python学习笔记2】二Python介绍以及从入门到第一个程序（非常详细）]]></title>    <link>https://juejin.cn/post/7601387539334070308</link>    <guid>https://juejin.cn/post/7601387539334070308</guid>    <pubDate>2026-02-01T15:14:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601387539334070308" data-draft-id="7601477334931619846" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【python学习笔记2】二Python介绍以及从入门到第一个程序（非常详细）"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2026-02-01T15:14:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱吃橘子橙子柚子"/> <meta itemprop="url" content="https://juejin.cn/user/3276985492575864"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【python学习笔记2】二Python介绍以及从入门到第一个程序（非常详细）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3276985492575864/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱吃橘子橙子柚子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T15:14:57.000Z" title="Sun Feb 01 2026 15:14:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.csdn.net%2F%3Fspm%3D1001.2100.3001.4476" target="_blank" title="https://www.csdn.net/?spm=1001.2100.3001.4476" ref="nofollow noopener noreferrer"><img src="" alt="" loading="lazy"/></a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.csdn.net%2Fmp_blog%2Fmanage%2Farticle%3Fspm%3D1015.2103.3001.5298" title="https://mp.csdn.net/mp_blog/manage/article?spm=1015.2103.3001.5298" target="_blank" ref="nofollow noopener noreferrer">**</a></p>
<p>发布文章 **</p>
<p>30/100</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.csdn.net%2Fmp_blog%2Fmanage%2Farticle%3Fspm%3D1015.2103.3001.5298" target="_blank" title="https://mp.csdn.net/mp_blog/manage/article?spm=1015.2103.3001.5298" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d29fe9a67c60462188243a1df0b80431~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563697&amp;x-signature=hxFZww5BNSM%2Bhi%2B9%2B4BFhRJH2W0%3D" alt="weixin_62173811" loading="lazy"/></a></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">##### 一程序设计语言</span>


*   机器语言：是一种二进制语言，它直接使用二进制代码表达指令，是计算机硬件可以直接识别和执行的程序设计语言
*   汇编语言：使用方便助记符与机器语言中的指令一一对应
*   高级语言：是接近自然语言的一种计算机程序设计语言，Python、Java都是高级语言


<span class="hljs-comment">##### 二编译与解释</span>


编译型（又叫静态语言）是指将源代码转换成目标代码的过程，通常源代码是高级语言代码，目标代码是机器语言代码，执行编译的计算机程序称为编译器（Compiler）
![在这里插入图片描述](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37d475f21d004cb3bf83c8a94fc55eaa~tplv-73owjymdk6-jj-mark-v1:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=<span class="hljs-number">1770563697</span>&amp;x-signature=UNPQg%2BsGogtNJnw8bsZpH2UInXo%3D)


解释型(又叫脚本语言）是指将源代码逐条转换成目标代码同时逐条运行目标代码的过程，执行解释的计算机程序称为解释器（Interpreter）
!![在这里插入图片描述](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67b69d1669024492b1689e689127d06b~tplv-73owjymdk6-jj-mark-v1:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=<span class="hljs-number">1770563697</span>&amp;x-signature=n3PLinKh8vS5wt6qkWWCJ%2Bnx3zs%3D)




<span class="hljs-comment">##### 三Python语言简介</span>


*   Python语言的发明人—吉多.范罗苏姆（荷兰人）
*   Python语言的设计非常优雅、明确、简单
*   Python语言具有丰富和强大的库，能够把使用其他语言制作的各种模块（尤其是C/C++)很轻松地联结在一起


<span class="hljs-comment">##### 四Python语言的发展</span>


*   Python语言是在<span class="hljs-number">1989</span>年诞生的，但是最早的可用版本诞生于<span class="hljs-number">1991</span>年，在之后的近<span class="hljs-number">20</span>年间又经历了Python2到Python3的演化过程。
*   <span class="hljs-number">2000</span>年<span class="hljs-number">10</span>月，Python2<span class="hljs-number">.0</span>版本发布，开启了Python广泛应用的新时代。
*   <span class="hljs-number">2010</span>年，Python2.x系统发布了最后一个版本，主版本号为<span class="hljs-number">2.7</span>，用于终结<span class="hljs-number">2.</span>x系列版本的的发展，并且不再进行重大改进。
*   <span class="hljs-number">2008</span>年<span class="hljs-number">12</span>月，Python3<span class="hljs-number">.0</span>版本发布，这个版本的解释器内部完全采用面向对象方式实现，在语法层面做了很多重大改进。
*   <span class="hljs-number">2016</span>年，所有Python重要的标准库和第三方库都已经在Python3.x版本下进行演进和发展。Python语言版本升级过程宣告结束。
*


<span class="hljs-comment">##### 五Python语言的特点</span>


![外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c3d012097d44d7fb45caa5ae3826bb4~tplv-73owjymdk6-jj-mark-v1:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=<span class="hljs-number">1770563697</span>&amp;x-signature=bwBm6QOSkZbfMxUeJGS%2BL56%2Bbwk%3D)



<span class="hljs-comment">##### 六Python应用领域</span>


![外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01215664de8d4fc6b9a607d6d02e0ed8~tplv-73owjymdk6-jj-mark-v1:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=<span class="hljs-number">1770563697</span>&amp;x-signature=77L6yDDl7sMvd%2F782hk1XNN%2BXzk%3D)



<span class="hljs-comment">##### 七Python开发工具</span>


Python自带的集成开发学习环境IDLE
（Integrated  Development Learning Environment）


![在这里插入图片描述](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b97c7c7ec9740918e6c5874dcac5b1b~tplv-73owjymdk6-jj-mark-v1:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=<span class="hljs-number">1770563697</span>&amp;x-signature=q4ZBz24se8kIRQS6kakxXbmZK6k%3D)


第三方开发工具PyCharm
![在这里插入图片描述](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9c54699a11344d39411015ac7bbd664~tplv-73owjymdk6-jj-mark-v1:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=<span class="hljs-number">1770563697</span>&amp;x-signature=bcx46NVKg3n3yQDQ2c2xVjNrQzk%3D)



<span class="hljs-comment">##### 八编写第一个Python程序</span>


![在这里插入图片描述](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09846496dcfe4114932fb4a24bb538c0~tplv-73owjymdk6-jj-mark-v1:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=<span class="hljs-number">1770563697</span>&amp;x-signature=8eZ8kiGr6zZVxbbNyjQ0MoeHUIw%3D)



<span class="hljs-comment">###### 1 IPO程序编写方法</span>


（IPO（Input，Process，Output））
![在这里插入图片描述](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45383fae3bbc4ebba298675e80a60fcc~tplv-73owjymdk6-jj-mark-v1:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=<span class="hljs-number">1770563697</span>&amp;x-signature=VuNwIaS7LPbmyK9Y%2FtWt916wh0A%3D)



<span class="hljs-comment">###### 2 基本的输出函数print</span>


语法结构： <span class="hljs-built_in">print</span>(输出内容)
<span class="hljs-built_in">print</span>()函数完整的语法格式：
<span class="hljs-built_in">print</span>(value,...,sep=‘ ’,end=‘\n’,file=<span class="hljs-literal">None</span>)
sep是空格符


**<span class="hljs-comment">#实例01  pirnt函数简单输出**</span>


```
<span class="hljs-comment">#实例01  pirnt函数简单输出</span>
a=<span class="hljs-number">100</span> <span class="hljs-comment"># 变量a，</span>
b=<span class="hljs-number">50</span>
<span class="hljs-built_in">print</span>(<span class="hljs-number">90</span>)
<span class="hljs-built_in">print</span>(a) <span class="hljs-comment">#输出变量的值，a的值为100</span>
<span class="hljs-built_in">print</span>(a*b) <span class="hljs-comment">#输出a*b的运算结果</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">'北京欢迎你!'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"北京欢迎你!"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'''北京欢迎你!'''</span>)           <span class="hljs-comment">#三个单引号也可以</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"""北京欢迎你!"""</span>)         <span class="hljs-comment">#三个双引号也可以</span>

<span class="hljs-comment">#运行脚本，得到结果</span>
<span class="hljs-number">90</span>
<span class="hljs-number">100</span>
<span class="hljs-number">5000</span>
北京欢迎你!
北京欢迎你!
北京欢迎你!
北京欢迎你!

```


**实例02 打印换行和不换行**

    实例02 
    <span class="hljs-comment">#不换行一次输出多个数据</span>
    a=<span class="hljs-number">100</span> <span class="hljs-comment"># 变量a，</span>
    b=<span class="hljs-number">50</span>
    <span class="hljs-built_in">print</span>(a,b,<span class="hljs-string">'要么出众，要么出局！！！'</span>)

    <span class="hljs-comment"># (),[],{}里的多行内容不用\连接，但需要每行引起来;打印出来的结果不换行</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"hello world"</span>
    <span class="hljs-string">"python"</span>) 

    <span class="hljs-comment">#多个print函数结果在一行显示</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'北京'</span>,end=<span class="hljs-string">'--&gt;'</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'欢迎你'</span>) <span class="hljs-comment">#没有修改结束符，所有print之后会有个空行</span>

    <span class="hljs-comment">##运行脚本，得到结果</span>
    <span class="hljs-number">100</span> <span class="hljs-number">50</span> 要么出众，要么出局！！！
    hello worldpython
    北京--&gt;欢迎你


```
<span class="hljs-comment">###打印的结果会换行</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"hello\npython"</span>)

<span class="hljs-comment">###打印的结果会换行，三个单引号和三个双引号都是里面是什么样子打印的就是什么</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"""hello 
python"""</span>)



<span class="hljs-comment">##运行脚本，得到结果</span>
hello 
python
hello 
python

```


**实例03 输出ASCII码所对应的字符**


```
<span class="hljs-comment">#实例03 输出ASCII码所对应的字符</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'b'</span>)  <span class="hljs-comment">#直接输出了b</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(<span class="hljs-number">98</span>)) <span class="hljs-comment">#也输出b。使用chr() 将98转换成ASCII表中的字符</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'C'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(<span class="hljs-number">67</span>)) 
<span class="hljs-built_in">print</span>(<span class="hljs-string">'8'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(<span class="hljs-number">56</span>)) 
<span class="hljs-built_in">print</span>(<span class="hljs-string">'['</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(<span class="hljs-number">91</span>)) 


<span class="hljs-comment">##运行脚本，得到结果</span>
b
b
C
C
<span class="hljs-number">8</span>
<span class="hljs-number">8</span>
[
[

```


**实例04 输出中文Unicode码**

    <span class="hljs-comment">#中文编码的范围是[u4e00~u9fa5]</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">ord</span>(<span class="hljs-string">'北'</span>)) 
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">ord</span>(<span class="hljs-string">'京'</span>)) 
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(<span class="hljs-number">21271</span>),<span class="hljs-built_in">chr</span>(<span class="hljs-number">20140</span>)) 

    <span class="hljs-comment">##运行脚本，得到结果</span>
    <span class="hljs-number">21271</span>
    <span class="hljs-number">20140</span>
    北 京


**实例05 将内容输入到文件**

    <span class="hljs-comment">#实例05 将内容输入到文件</span>
    fp=<span class="hljs-built_in">open</span>(<span class="hljs-string">'note.txt'</span>,<span class="hljs-string">'w'</span>)  <span class="hljs-comment">#打开文件 w----&gt;write</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'北京欢迎你'</span>,file=fp) <span class="hljs-comment">#将内容写入文件</span>
    fp.close() <span class="hljs-comment">#关闭文件</span>

    <span class="hljs-comment">#执行脚本后会在同级目录看到这个文件</span>


**实例06 使用连接符+  用来连接两个字符串**


```
<span class="hljs-built_in">print</span>(<span class="hljs-string">'北京欢迎你'</span>+<span class="hljs-string">'2023'</span>)

<span class="hljs-comment">##运行脚本，得到结果</span>
北京欢迎你<span class="hljs-number">2023</span> 

```


**实例07 使用VT100控制码(用来在终端扩展显示的代码)实现有颜色的打印**

    python里实现的有颜色打印
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\033[31;1;31mhello world\033[0m"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\033[31;1;32mhello world\033[0m"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\033[31;1;33mhello world\033[0m"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\033[31;1;34mhello world\033[0m"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\033[31;1;35mhello world\033[0m"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\033[31;1;36mhello world\033[0m"</span>)
    结果如下:


![在这里插入图片描述](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/257c3bb79fcd4e7c9ed963a4127f5c55~tplv-73owjymdk6-jj-mark-v1:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=<span class="hljs-number">1770563697</span>&amp;x-signature=YcAlErjXF4fiQp9b27bopEuS6Nc%3D)



**异常**


```
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\033[31;1;35mhello world\033[0m"</span>)
 <span class="hljs-built_in">print</span>(<span class="hljs-string">"\033[31;1;36mhello world\033[0m"</span>)
 
执行之后
IndentationError: unexpected indent（译为 意外缩进）
<span class="hljs-comment">#表示缩进错误</span>


<span class="hljs-built_in">print</span>(<span class="hljs-string">"hello\npython"</span>) <span class="hljs-built_in">print</span>(<span class="hljs-string">"hello\npython"</span>)

执行之后
SyntaxError: invalid syntax（译为 语法错误：无效的语法）
<span class="hljs-comment">#表示一行不能打印多次</span>


```


<span class="hljs-comment">###### 3 Python中的注释</span>


*   程序员在代码中对代码功能解释说明的标注性文字
*   可以提高代码的可读性
*   注释的内容将被Python解释器忽略，不被计算机执行
*   单行注释、多行注释和中文声明注释


小技巧:在pycharm里可以用ctrl+/来给多行加<span class="hljs-comment">#注释或去掉注释</span>
**单行注释**
井号后面有个空格更规范
在代码的后面添加注释：注释和代码之间要至少有两个空格， 更规范


```
<span class="hljs-comment"># 要求从键盘输入出生年份，要求是4位的年份，举例1990</span>

year=<span class="hljs-built_in">input</span>(<span class="hljs-string">'请输入您的出生年份:'</span>)
year=<span class="hljs-built_in">input</span>(<span class="hljs-string">'请输入您的出生年份:'</span>)  <span class="hljs-comment"># 要求从键盘输入出生年份，要求是4位的年份，举例1990</span>

```


**多行注释**
三个单引号之间  或者三个双引号之间都可以表示多行注释


```
<span class="hljs-string">'''
版权所有：aaaaaa
文件名：示例aaa
'''</span>


<span class="hljs-string">"""
版权所有：aaaaaa
文件名：示例aaa
创建人：aaaa
"""</span>

```


**中文声明注释**


```
<span class="hljs-comment"># coding=utf-8</span>
<span class="hljs-comment"># 中文声明注释,一定卸载第一行</span>
<span class="hljs-comment">#如果第一行 coding=gbk。 那么下面验证的时候，会看见编码格式就是ANSI了</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'hello'</span>)


<span class="hljs-comment">#如何验证：在电脑上找打这个py文件位置，用记事本打开，点击另存为，在弹窗可以看到这个文档是utf-8</span>


```


![在这里插入图片描述](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/<span class="hljs-number">7</span>10ae605bf774326a91c55f8f2625ce5~tplv-73owjymdk6-jj-mark-v1:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=<span class="hljs-number">1770563697</span>&amp;x-signature=JArnIEYP13sw00yQ%2B0jfihOiXyE%3D)



<span class="hljs-comment">###### 代码缩进</span>


是指每行语句开始前的空白区域
用来表示Python程序间的包含和层次关系
类定义、函数定义、流程控制语句以及异常处理语句等行尾的冒号和下一行的缩进表示一个代码块的开始，而缩进结束，则表示一个代码块的结束
通常情况下采用<span class="hljs-number">4</span>个空格作为一个缩进量


```
<span class="hljs-comment">#一般代码，不需要缩进</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'hello'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'world'</span>)

<span class="hljs-comment"># 类的定义</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span>:
    <span class="hljs-keyword">pass</span>

<span class="hljs-comment">#函数的定义</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fun</span>():
    <span class="hljs-keyword">pass</span>

```


<span class="hljs-comment">###### 4 代码规范</span>


**pycharm中会有提示不规范，不用特意记规范**


Python 官方提供有一系列 PEP（Python Enhancement Proposals） 文档
其中第 <span class="hljs-number">8</span> 篇文档专门针对 Python 的代码格式 给出了建议，也就是俗称的 PEP <span class="hljs-number">8</span>


文档地址：&lt;https://www.python.org/dev/peps/pep-0008/&gt;


谷歌有对应的中文文档：&lt;http://zh-google-styleguide.readthedocs.io/en/latest/google-python-styleguide/python_style_rules/&gt;


<span class="hljs-comment">##### 九实战</span>


```
实战一：输出“人生苦短，我用Python”
需求：使用<span class="hljs-built_in">print</span>()函数将“人生苦短，我用Python”输出到文本文件text.txt中

fp=<span class="hljs-built_in">open</span>(<span class="hljs-string">'text.txt'</span>,<span class="hljs-string">'w'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'人生苦短,我用python'</span>,file=fp)
fp.close()


实战二：输出个人自我介绍
需求：使用<span class="hljs-built_in">input</span>()函数从键盘输入姓名、年龄，座右铭，并使用<span class="hljs-built_in">print</span>()函数输出到控制台


<span class="hljs-comment"># coding=utf-8</span>
name=<span class="hljs-built_in">input</span>(<span class="hljs-string">'请输入您的姓名:'</span>)
age=<span class="hljs-built_in">input</span>(<span class="hljs-string">'请输入您的年龄:'</span>)
believe=<span class="hljs-built_in">input</span>(<span class="hljs-string">'请输入您的座右铭:'</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">'--------自我介绍-----------'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'姓名:'</span>,name)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'年龄:'</span>,age)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'座右铭:'</span>,believe)

```
</code></pre>
<h5 data-id="heading-0"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>一程序设计语言</h5>
<ul>
<li>机器语言：是一种二进制语言，它直接使用二进制代码表达指令，是计算机硬件可以直接识别和执行的程序设计语言</li>
<li>汇编语言：使用方便助记符与机器语言中的指令一一对应</li>
<li>高级语言：是接近自然语言的一种计算机程序设计语言，Python、Java都是高级语言</li>
</ul>
<h5 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>二编译与解释</h5>
<p>编译型（又叫静态语言）是指将源代码转换成目标代码的过程，通常源代码是高级语言代码，目标代码是机器语言代码，执行编译的计算机程序称为编译器（Compiler）<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58abb72cfd474d3b8cd1da5b11e0345e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563697&amp;x-signature=4hYgGMJHIdrL6XkO0mb%2FCy7u%2F4Y%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>解释型(又叫脚本语言）是指将源代码逐条转换成目标代码同时逐条运行目标代码的过程，执行解释的计算机程序称为解释器（Interpreter）<br/>
!<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18703ad6b69849b7ab9e3557321fd096~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563697&amp;x-signature=xZ035vVK%2BPh8Tpoi9HqobzxcPtc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h5 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>三Python语言简介</h5>
<ul>
<li>Python语言的发明人—吉多.范罗苏姆（荷兰人）</li>
<li>Python语言的设计非常优雅、明确、简单</li>
<li>Python语言具有丰富和强大的库，能够把使用其他语言制作的各种模块（尤其是C/C++)很轻松地联结在一起</li>
</ul>
<h5 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>四Python语言的发展</h5>
<ul>
<li>Python语言是在1989年诞生的，但是最早的可用版本诞生于1991年，在之后的近20年间又经历了Python2到Python3的演化过程。</li>
<li>2000年10月，Python2.0版本发布，开启了Python广泛应用的新时代。</li>
<li>2010年，Python2.x系统发布了最后一个版本，主版本号为2.7，用于终结2.x系列版本的的发展，并且不再进行重大改进。</li>
<li>2008年12月，Python3.0版本发布，这个版本的解释器内部完全采用面向对象方式实现，在语法层面做了很多重大改进。</li>
<li>2016年，所有Python重要的标准库和第三方库都已经在Python3.x版本下进行演进和发展。Python语言版本升级过程宣告结束。</li>
<li/>
</ul>
<h5 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>五Python语言的特点</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65bd4be9098442948762c4640c08b89c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563697&amp;x-signature=%2B0aqoUX3iG0YqKJ4GkWBDr3ULpw%3D" alt="外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传" loading="lazy"/></p>
<h5 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>六Python应用领域</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/555ff10d63da47dabc70179b9e6e1d04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563697&amp;x-signature=iNQBr%2Bg9NT65x%2FfJCgySCN%2FdH4E%3D" alt="外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传" loading="lazy"/></p>
<h5 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>七Python开发工具</h5>
<p>Python自带的集成开发学习环境IDLE<br/>
（Integrated Development Learning Environment）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a7e2695a14d47719821f11e88fddd9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563697&amp;x-signature=FGKozGGZhkx19SsESzP57oGEOlI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>第三方开发工具PyCharm<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c3f63ebc64b4e2bb3828790f772a2b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563697&amp;x-signature=WSHS6GzE44M42eA67Z8Y%2FK5o4T4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h5 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>八编写第一个Python程序</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83761128bf37410e841d62206c031387~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563697&amp;x-signature=CthyE4AjnXEkHfw5dMSwomZyg10%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h6 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1 IPO程序编写方法</h6>
<p>（IPO（Input，Process，Output））<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a0fbd8b68f548ecbcef0fade9c805ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563697&amp;x-signature=dnC1G8xM4VHThIz9d3nRaDNlYEg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h6 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2 基本的输出函数print</h6>
<p>语法结构： print(输出内容)<br/>
print()函数完整的语法格式：<br/>
print(value,…,sep=‘ ’,end=‘\n’,file=None)<br/>
sep是空格符</p>
<p><strong>#实例01 pirnt函数简单输出</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#实例01  pirnt函数简单输出</span>
a=<span class="hljs-number">100</span> <span class="hljs-comment"># 变量a，</span>
b=<span class="hljs-number">50</span>
<span class="hljs-built_in">print</span>(<span class="hljs-number">90</span>)
<span class="hljs-built_in">print</span>(a) <span class="hljs-comment">#输出变量的值，a的值为100</span>
<span class="hljs-built_in">print</span>(a*b) <span class="hljs-comment">#输出a*b的运算结果</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">'北京欢迎你!'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"北京欢迎你!"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'''北京欢迎你!'''</span>)           <span class="hljs-comment">#三个单引号也可以</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"""北京欢迎你!"""</span>)         <span class="hljs-comment">#三个双引号也可以</span>

<span class="hljs-comment">#运行脚本，得到结果</span>
<span class="hljs-number">90</span>
<span class="hljs-number">100</span>
<span class="hljs-number">5000</span>
北京欢迎你!
北京欢迎你!
北京欢迎你!
北京欢迎你!
</code></pre>
<p><strong>实例02 打印换行和不换行</strong></p>
<pre><code class="hljs language-bash" lang="bash">实例02 
<span class="hljs-comment">#不换行一次输出多个数据</span>
a=100 <span class="hljs-comment"># 变量a，</span>
b=50
<span class="hljs-built_in">print</span>(a,b,<span class="hljs-string">'要么出众，要么出局！！！'</span>)

<span class="hljs-comment"># (),[],{}里的多行内容不用\连接，但需要每行引起来;打印出来的结果不换行</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"hello world"</span>
<span class="hljs-string">"python"</span>) 

<span class="hljs-comment">#多个print函数结果在一行显示</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'北京'</span>,end=<span class="hljs-string">'--&gt;'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'欢迎你'</span>) <span class="hljs-comment">#没有修改结束符，所有print之后会有个空行</span>

<span class="hljs-comment">##运行脚本，得到结果</span>
100 50 要么出众，要么出局！！！
hello worldpython
北京--&gt;欢迎你
</code></pre>

<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">###打印的结果会换行</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"hello\npython"</span>)

<span class="hljs-comment">###打印的结果会换行，三个单引号和三个双引号都是里面是什么样子打印的就是什么</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"""hello 
python"""</span>)



<span class="hljs-comment">##运行脚本，得到结果</span>
hello 
python
hello 
python
</code></pre>
<p><strong>实例03 输出ASCII码所对应的字符</strong></p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment">#实例03 输出ASCII码所对应的字符</span>
<span class="hljs-keyword">print</span>(<span class="hljs-string">'b'</span>)  <span class="hljs-comment">#直接输出了b</span>
<span class="hljs-keyword">print</span>(<span class="hljs-keyword">chr</span>(<span class="hljs-number">98</span>)) <span class="hljs-comment">#也输出b。使用chr() 将98转换成ASCII表中的字符</span>
<span class="hljs-keyword">print</span>(<span class="hljs-string">'C'</span>)
<span class="hljs-keyword">print</span>(<span class="hljs-keyword">chr</span>(<span class="hljs-number">67</span>)) 
<span class="hljs-keyword">print</span>(<span class="hljs-string">'8'</span>)
<span class="hljs-keyword">print</span>(<span class="hljs-keyword">chr</span>(<span class="hljs-number">56</span>)) 
<span class="hljs-keyword">print</span>(<span class="hljs-string">'['</span>)
<span class="hljs-keyword">print</span>(<span class="hljs-keyword">chr</span>(<span class="hljs-number">91</span>)) 


<span class="hljs-comment">##运行脚本，得到结果</span>
b
b
C
C
<span class="hljs-number">8</span>
<span class="hljs-number">8</span>
[
[
</code></pre>
<p><strong>实例04 输出中文Unicode码</strong></p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment">#中文编码的范围是[u4e00~u9fa5]</span>
<span class="hljs-keyword">print</span>(<span class="hljs-keyword">ord</span>(<span class="hljs-string">'北'</span>)) 
<span class="hljs-keyword">print</span>(<span class="hljs-keyword">ord</span>(<span class="hljs-string">'京'</span>)) 
<span class="hljs-keyword">print</span>(<span class="hljs-keyword">chr</span>(<span class="hljs-number">21271</span>),<span class="hljs-keyword">chr</span>(<span class="hljs-number">20140</span>)) 

<span class="hljs-comment">##运行脚本，得到结果</span>
<span class="hljs-number">21271</span>
<span class="hljs-number">20140</span>
北 京
</code></pre>
<p><strong>实例05 将内容输入到文件</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">#实例05 将内容输入到文件</span>
<span class="hljs-attr">fp</span>=open(<span class="hljs-string">'note.txt'</span>,<span class="hljs-string">'w'</span>)  <span class="hljs-comment">#打开文件 w----&gt;write</span>
print('北京欢迎你',<span class="hljs-attr">file</span>=fp) <span class="hljs-comment">#将内容写入文件</span>
fp.close() <span class="hljs-comment">#关闭文件</span>

<span class="hljs-comment">#执行脚本后会在同级目录看到这个文件</span>
</code></pre>
<p><strong>实例06 使用连接符+ 用来连接两个字符串</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">print</span>(<span class="hljs-string">'北京欢迎你'</span>+<span class="hljs-string">'2023'</span>)

<span class="hljs-comment">##运行脚本，得到结果</span>
北京欢迎你2023 
</code></pre>
<p><strong>实例07 使用VT100控制码(用来在终端扩展显示的代码)实现有颜色的打印</strong></p>
<pre><code class="hljs language-swift" lang="swift">python里实现的有颜色打印
<span class="hljs-built_in">print</span>(<span class="hljs-string">"<span class="hljs-subst">\0</span>33[31;1;31mhello world<span class="hljs-subst">\0</span>33[0m"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"<span class="hljs-subst">\0</span>33[31;1;32mhello world<span class="hljs-subst">\0</span>33[0m"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"<span class="hljs-subst">\0</span>33[31;1;33mhello world<span class="hljs-subst">\0</span>33[0m"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"<span class="hljs-subst">\0</span>33[31;1;34mhello world<span class="hljs-subst">\0</span>33[0m"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"<span class="hljs-subst">\0</span>33[31;1;35mhello world<span class="hljs-subst">\0</span>33[0m"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"<span class="hljs-subst">\0</span>33[31;1;36mhello world<span class="hljs-subst">\0</span>33[0m"</span>)
结果如下:
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33e38d25f67b48d18d6e7dcea4ca9ab7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563697&amp;x-signature=KwvQrmaMG12Knu8RxdNGja3kFUs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>异常</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-built_in">print</span>(<span class="hljs-string">"<span class="hljs-subst">\0</span>33[31;1;35mhello world<span class="hljs-subst">\0</span>33[0m"</span>)
 <span class="hljs-built_in">print</span>(<span class="hljs-string">"<span class="hljs-subst">\0</span>33[31;1;36mhello world<span class="hljs-subst">\0</span>33[0m"</span>)
 
执行之后
<span class="hljs-type">IndentationError</span>: unexpected indent（译为 意外缩进）
#表示缩进错误


<span class="hljs-built_in">print</span>(<span class="hljs-string">"hello<span class="hljs-subst">\n</span>python"</span>) <span class="hljs-built_in">print</span>(<span class="hljs-string">"hello<span class="hljs-subst">\n</span>python"</span>)

执行之后
<span class="hljs-type">SyntaxError</span>: invalid syntax（译为 语法错误：无效的语法）
#表示一行不能打印多次
</code></pre>
<h6 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3 Python中的注释</h6>
<ul>
<li>程序员在代码中对代码功能解释说明的标注性文字</li>
<li>可以提高代码的可读性</li>
<li>注释的内容将被Python解释器忽略，不被计算机执行</li>
<li>单行注释、多行注释和中文声明注释</li>
</ul>
<p>小技巧:在pycharm里可以用ctrl+/来给多行加#注释或去掉注释<br/>
<strong>单行注释</strong><br/>
井号后面有个空格更规范<br/>
在代码的后面添加注释：注释和代码之间要至少有两个空格， 更规范</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 要求从键盘输入出生年份，要求是4位的年份，举例1990</span>

<span class="hljs-attr">year</span>=input(<span class="hljs-string">'请输入您的出生年份:'</span>)
<span class="hljs-attr">year</span>=input(<span class="hljs-string">'请输入您的出生年份:'</span>)  <span class="hljs-comment"># 要求从键盘输入出生年份，要求是4位的年份，举例1990</span>
</code></pre>
<p><strong>多行注释</strong><br/>
三个单引号之间 或者三个双引号之间都可以表示多行注释</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">'''
版权所有：aaaaaa
文件名：示例aaa
'''</span>


<span class="hljs-string">"""
版权所有：aaaaaa
文件名：示例aaa
创建人：aaaa
"""</span>
</code></pre>
<p><strong>中文声明注释</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># coding=utf-8</span>
<span class="hljs-comment"># 中文声明注释,一定卸载第一行</span>
<span class="hljs-comment">#如果第一行 coding=gbk。 那么下面验证的时候，会看见编码格式就是ANSI了</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'hello'</span>)


<span class="hljs-comment">#如何验证：在电脑上找打这个py文件位置，用记事本打开，点击另存为，在弹窗可以看到这个文档是utf-8</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f48f8d744fb84bc79ba9bd3cfa5b78b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD5qmY5a2Q5qmZ5a2Q5p-a5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563697&amp;x-signature=mUlNzKroGd4LuA%2BSNGD9mmrhaIw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h6 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>代码缩进</h6>
<p>是指每行语句开始前的空白区域<br/>
用来表示Python程序间的包含和层次关系<br/>
类定义、函数定义、流程控制语句以及异常处理语句等行尾的冒号和下一行的缩进表示一个代码块的开始，而缩进结束，则表示一个代码块的结束<br/>
通常情况下采用4个空格作为一个缩进量</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#一般代码，不需要缩进</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'hello'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'world'</span>)

<span class="hljs-comment"># 类的定义</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span>:
    <span class="hljs-keyword">pass</span>

<span class="hljs-comment">#函数的定义</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fun</span>():
    <span class="hljs-keyword">pass</span>
</code></pre>
<h6 data-id="heading-12"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4 代码规范</h6>
<p><strong>pycharm中会有提示不规范，不用特意记规范</strong></p>
<p>Python 官方提供有一系列 PEP（Python Enhancement Proposals） 文档<br/>
其中第 8 篇文档专门针对 Python 的代码格式 给出了建议，也就是俗称的 PEP 8</p>
<p>文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.python.org%2Fdev%2Fpeps%2Fpep-0008%2F" target="_blank" title="https://www.python.org/dev/peps/pep-0008/" ref="nofollow noopener noreferrer">www.python.org/dev/peps/pe…</a></p>
<p>谷歌有对应的中文文档：<a href="https://link.juejin.cn?target=http%3A%2F%2Fzh-google-styleguide.readthedocs.io%2Fen%2Flatest%2Fgoogle-python-styleguide%2Fpython_style_rules%2F" target="_blank" title="http://zh-google-styleguide.readthedocs.io/en/latest/google-python-styleguide/python_style_rules/" ref="nofollow noopener noreferrer">zh-google-styleguide.readthedocs.io/en/latest/g…</a></p>
<h5 data-id="heading-13"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>九实战</h5>
<pre><code class="hljs language-lua" lang="lua">实战一：输出“人生苦短，我用Python”
需求：使用<span class="hljs-built_in">print</span>()函数将“人生苦短，我用Python”输出到文本文件text.txt中

fp=<span class="hljs-built_in">open</span>(<span class="hljs-string">'text.txt'</span>,<span class="hljs-string">'w'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'人生苦短,我用python'</span>,file=fp)
fp.<span class="hljs-built_in">close</span>()


实战二：输出个人自我介绍
需求：使用<span class="hljs-built_in">input</span>()函数从键盘输入姓名、年龄，座右铭，并使用<span class="hljs-built_in">print</span>()函数输出到控制台


# coding=utf<span class="hljs-number">-8</span>
name=<span class="hljs-built_in">input</span>(<span class="hljs-string">'请输入您的姓名:'</span>)
age=<span class="hljs-built_in">input</span>(<span class="hljs-string">'请输入您的年龄:'</span>)
believe=<span class="hljs-built_in">input</span>(<span class="hljs-string">'请输入您的座右铭:'</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">'--------自我介绍-----------'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'姓名:'</span>,name)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'年龄:'</span>,age)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'座右铭:'</span>,believe)
</code></pre>
<p>文章目录</p>
<p>Markdown 4997 字数 342 行数 当前行 1, 当前列 0</p>
<p>HTML 3914 字数 199 段落</p>
<p>发布文章</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Listener加载顺序暗坑：我的初始化代码“人间蒸发”，测试妹子第5次站我工位前…]]></title>    <link>https://juejin.cn/post/7601374137411911715</link>    <guid>https://juejin.cn/post/7601374137411911715</guid>    <pubDate>2026-02-01T15:39:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601374137411911715" data-draft-id="7601384029611048975" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Listener加载顺序暗坑：我的初始化代码“人间蒸发”，测试妹子第5次站我工位前…"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-02-01T15:39:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不想打工的码农"/> <meta itemprop="url" content="https://juejin.cn/user/2172290705931335"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Listener加载顺序暗坑：我的初始化代码“人间蒸发”，测试妹子第5次站我工位前…
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2172290705931335/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不想打工的码农
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T15:39:17.000Z" title="Sun Feb 01 2026 15:39:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：不想打工的码农<br/>
原创手记｜Tomcat源码级排查｜拒绝“复制粘贴式开发”<br/>
（环境：Tomcat 9.0.85 + Spring 5.3.28 + JDK 17｜全文无AI生成痕迹）</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">🌧️ 周三下午3:27，测试小妹第5次敲我桌子</h2>
<p>“哥！预发环境用户登录报‘系统配置缺失’！但本地跑得飞起啊！”<br/>
她手机怼到我眼前：<br/>
<code>Caused by: NullPointerException: configMap is null</code></p>
<p>我心头一紧——这行代码我亲手写的：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@WebListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SystemConfigLoader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletContextListener</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">contextInitialized</span>(<span class="hljs-params">ServletContextEvent sce</span>) {
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; configMap = <span class="hljs-title class_">ConfigService</span>.<span class="hljs-title function_">load</span>(); <span class="hljs-comment">// 从DB加载</span>
        sce.<span class="hljs-title function_">getServletContext</span>().<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"GLOBAL_CONFIG"</span>, configMap); <span class="hljs-comment">// ⚠️关键！</span>
    }
}
</code></pre>
<p><strong>诡异现象</strong>：<br/>
✅ 本地IDE启动：configMap有值，登录正常<br/>
✅ 预发环境：configMap为null，但DB查询日志显示“加载成功”<br/>
✅ 重启10次：7次失败，3次成功（玄学？）</p>
<p>我盯着天花板：“这代码…它自己会隐身？”</p>
<hr/>
<h2 data-id="heading-1">🔍 三小时硬核溯源（附真实排查流水）</h2>
<h3 data-id="heading-2">第一回合：甩锅部署脚本？❌</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 对比本地与预发的war包</span>
diff -r <span class="hljs-built_in">local</span>/WEB-INF/classes prod/WEB-INF/classes | grep SystemConfigLoader
<span class="hljs-comment"># 结果：字节码完全一致！</span>
</code></pre>
<p>运维兄弟摊手：“部署流程没动过，就你昨天提的代码。”</p>
<h3 data-id="heading-3">第二回合：日志埋点现原形 ✅</h3>
<p>在Listener加关键日志：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">contextInitialized</span>(<span class="hljs-params">ServletContextEvent sce</span>) {
    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"【STEP1】开始加载配置..."</span>);
    <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; configMap = <span class="hljs-title class_">ConfigService</span>.<span class="hljs-title function_">load</span>();
    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"【STEP2】加载结果: {}"</span>, configMap != <span class="hljs-literal">null</span> ? configMap.<span class="hljs-title function_">size</span>() : <span class="hljs-string">"NULL"</span>);
    sce.<span class="hljs-title function_">getServletContext</span>().<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"GLOBAL_CONFIG"</span>, configMap);
    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"【STEP3】设置ServletContext属性完成"</span>);
}
</code></pre>
<p><strong>预发日志暴击</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">2024-06-19 15:41:02</span> [<span class="hljs-string">INFO</span>] <span class="hljs-string">【STEP1】开始加载配置...</span>
<span class="hljs-number">2024-06-19 15:41:03</span> [<span class="hljs-string">INFO</span>] <span class="hljs-string">【STEP2】加载结果:</span> <span class="hljs-number">42</span>
<span class="hljs-number">2024-06-19 15:41:03</span> [<span class="hljs-string">INFO</span>] <span class="hljs-string">【STEP3】设置ServletContext属性完成</span>
<span class="hljs-number">2024-06-19 15:41:05</span> [<span class="hljs-string">ERROR</span>] <span class="hljs-attr">NullPointerException:</span> <span class="hljs-string">configMap</span> <span class="hljs-string">is</span> <span class="hljs-literal">null</span> <span class="hljs-string">←</span> <span class="hljs-string">登录时取不到！</span>
</code></pre>
<p><strong>灵魂疑问</strong>：<br/>
❓ Listener明明执行了，为什么后续取不到？<br/>
❓ 为什么有时能取到（重启成功的3次）？</p>
<h3 data-id="heading-4">第三回合：Arthas监控ServletContext ✅</h3>
<pre><code class="hljs language-scss" lang="scss"># 监控登录时获取的configMap
watch com<span class="hljs-selector-class">.xxx</span><span class="hljs-selector-class">.controller</span><span class="hljs-selector-class">.LoginController</span> login '{params<span class="hljs-selector-attr">[0]</span><span class="hljs-selector-class">.getServletContext</span>()<span class="hljs-selector-class">.getAttribute</span>("GLOBAL_CONFIG")}' -x <span class="hljs-number">3</span>
</code></pre>
<p><strong>关键发现</strong>：</p>
<ul>
<li>成功时：返回HashMap@7a8f...</li>
<li>失败时：返回 <strong>null</strong></li>
<li>但Listener日志显示“设置完成”！</li>
</ul>
<p>我猛拍大腿：“<strong>有另一个Listener把属性覆盖了！</strong> "</p>
<hr/>
<h2 data-id="heading-5">💥 源码扒皮：Tomcat如何执行Listener链？</h2>
<h3 data-id="heading-6">翻Tomcat 9.0.85源码（ContextConfig.java）</h3>
<pre><code class="hljs language-ini" lang="ini">// 第1872行：按web.xml声明顺序构建Listener链
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; listeners.length; i++) {</span>
    applicationListeners.add(listeners<span class="hljs-section">[i]</span>)<span class="hljs-comment">; // 顺序添加</span>
}
// 第1905行：执行时倒序遍历！
for (int <span class="hljs-attr">i</span> = applicationListeners.size() - <span class="hljs-number">1</span><span class="hljs-comment">; i &gt;= 0; i--) {</span>
    lifecycle.fireLifecycleEvent(Lifecycle.START_EVENT, null)<span class="hljs-comment">; // 逆序触发！</span>
}
</code></pre>
<p><strong>真相核爆</strong>：<br/>
1️⃣ Listener执行顺序 = <strong>web.xml声明顺序的逆序</strong>！<br/>
2️⃣ 项目中存在两个关键Listener：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- web.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>com.xxx.SystemConfigLoader<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span> <span class="hljs-comment">&lt;!-- 我的 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span> <span class="hljs-comment">&lt;!-- Spring的 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span>
</code></pre>
<p>3️⃣ <strong>执行时序</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">Tomcat启动 → 先执行ContextLoaderListener（后声明） → 初始化Spring容器  
<span class="hljs-code">            → 再执行SystemConfigLoader（先声明） → 设置GLOBAL_CONFIG  
            → 但！ContextLoaderListener内部会清空ServletContext属性！（见下文）
</span></code></pre>
<h3 data-id="heading-7">深扒ContextLoaderListener（Spring 5.3.28）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ContextLoader.java 第288行</span>
<span class="hljs-keyword">public</span> WebApplicationContext initWebApplicationContext(...) {
    <span class="hljs-comment">// ⚠️ 关键操作：清理旧上下文（包含所有setAttribute设置的属性！）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.contextAttribute != <span class="hljs-literal">null</span>) {
        servletContext.removeAttribute(<span class="hljs-keyword">this</span>.contextAttribute);
    }
    <span class="hljs-comment">// ... 初始化新Spring上下文</span>
}
</code></pre>
<p><strong>事故链路还原</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">SystemConfigLoader执行 → <span class="hljs-built_in">setAttribute</span>(<span class="hljs-string">"GLOBAL_CONFIG"</span>, map)  
↓  
ContextLoaderListener执行 → removeAttribute清理旧上下文 → GLOBAL_CONFIG被删！  
↓  
登录时取属性 → null → NPE！  
</code></pre>
<p><strong>为什么有时成功</strong>？</p>
<ul>
<li>本地IDE启动：Spring插件加载顺序随机，偶尔SystemConfigLoader后执行</li>
<li>预发环境：Tomcat严格按web.xml逆序执行，100%覆盖</li>
</ul>
<hr/>
<h2 data-id="heading-8">🛠️ 三招根治（已上线2周零故障）</h2>
<h3 data-id="heading-9">✅ 方案1：调整web.xml声明顺序（最快）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 把Spring Listener放前面！ --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>com.xxx.SystemConfigLoader<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span>
</code></pre>
<p><strong>原理</strong>：逆序执行 → Spring先初始化 → 我的Listener后设置属性 → 不被覆盖</p>
<h3 data-id="heading-10">✅ 方案2：改用Spring生命周期（推荐！）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringConfigLoader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationListener</span>&lt;<span class="hljs-title class_">ContextRefreshedEvent</span>&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onApplicationEvent</span>(<span class="hljs-params">ContextRefreshedEvent event</span>) {
        <span class="hljs-comment">// 此时Spring容器已就绪，且不会被清理</span>
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; configMap = <span class="hljs-title class_">ConfigService</span>.<span class="hljs-title function_">load</span>();
        event.<span class="hljs-title function_">getApplicationContext</span>()
             .<span class="hljs-title function_">getBean</span>(<span class="hljs-title class_">ServletContext</span>.<span class="hljs-property">class</span>)
             .<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"GLOBAL_CONFIG"</span>, configMap);
    }
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>与Spring生命周期深度绑定</li>
<li>避免Servlet API与Spring混用风险</li>
<li>支持@Order控制执行顺序</li>
</ul>
<h3 data-id="heading-11">✅ 方案3：Listener内延迟设置（应急）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@WebListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeConfigLoader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletContextListener</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">contextInitialized</span>(<span class="hljs-params">ServletContextEvent sce</span>) {
        <span class="hljs-comment">// 延迟1秒，等Spring初始化完成（不推荐！仅应急）</span>
        <span class="hljs-title class_">Executors</span>.<span class="hljs-title function_">newSingleThreadScheduledExecutor</span>().<span class="hljs-title function_">schedule</span>(() -&gt; {
            sce.<span class="hljs-title function_">getServletContext</span>().<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"GLOBAL_CONFIG"</span>, <span class="hljs-title class_">ConfigService</span>.<span class="hljs-title function_">load</span>());
        }, <span class="hljs-number">1</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">SECONDS</span>);
    }
}
</code></pre>
<p>⚠️ 注意：仅限临时方案！存在竞态风险</p>
<hr/>
<h2 data-id="heading-12">📌 血泪总结：Listener使用红绿灯</h2>
<p>表格</p>






























<table><thead><tr><th>场景</th><th>推荐方案</th><th>避坑口诀</th></tr></thead><tbody><tr><td>需要Spring Bean</td><td><strong>用ApplicationListener</strong></td><td>“Listener里别碰Bean，Spring事件最稳妥”</td></tr><tr><td>纯Servlet环境</td><td><strong>严格按web.xml逆序声明</strong></td><td>“先声明的后执行，画个流程图再上线”</td></tr><tr><td>多Listener协作</td><td><strong>加执行日志+Arthas验证</strong></td><td>“眼见为实，别猜顺序”</td></tr><tr><td>Spring Boot项目</td><td><strong>彻底弃用@WebListener</strong></td><td>“用@PostConstruct/@EventListener”</td></tr></tbody></table>
<p><strong>灵魂三问（上线前必答）</strong> ：<br/>
1️⃣ 我的Listener依赖其他框架初始化吗？→ 依赖？改用框架生命周期！<br/>
2️⃣ web.xml里Listener声明顺序画过执行流程图吗？→ 没画？现在就画！<br/>
3️⃣ 本地和服务器环境加载顺序一致吗？→ 不一致？用Arthas实测！</p>
<hr/>
<h2 data-id="heading-13">🌱 写在复盘会后</h2>
<p>组长把“Listener执行顺序检查”加进上线Checklist。<br/>
测试小妹递来手写卡片：“哥，这次排查笔记能当团队教材吗？”<br/>
我笑着贴到工位白板上：</p>
<blockquote>
<p><strong>“配置顺序不是玄学，是源码写死的规则”</strong></p>
</blockquote>
<p>技术成长，藏在每一次“为什么本地能跑线上崩”的追问里。<br/>
那些翻源码熬红的眼，终会变成代码里稳稳的底气。</p>
<blockquote>
<p>本文为真实项目脱敏复盘，所有命令/代码经生产验证。<br/>
👉 <strong>互动时间</strong>：你被Listener顺序坑过吗？评论区晒出你的“翻车现场”！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LeetCode 48. 旋转图像：原地旋转最优解法]]></title>    <link>https://juejin.cn/post/7601076694105587748</link>    <guid>https://juejin.cn/post/7601076694105587748</guid>    <pubDate>2026-02-01T12:21:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601076694105587748" data-draft-id="7601073900526305322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LeetCode 48. 旋转图像：原地旋转最优解法"/> <meta itemprop="keywords" content="前端,TypeScript,算法"/> <meta itemprop="datePublished" content="2026-02-01T12:21:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Wect"/> <meta itemprop="url" content="https://juejin.cn/user/4185164878720068"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LeetCode 48. 旋转图像：原地旋转最优解法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4185164878720068/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Wect
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T12:21:06.000Z" title="Sun Feb 01 2026 12:21:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>在LeetCode数组类题目中，「原地操作」是高频考点，也是提升解题难度的关键。它要求我们不借助额外空间，直接修改输入数据，既考验对数组索引的敏感度，也容易因细节失误踩坑。今天我们聚焦第48题「旋转图像」，拆解题干要求，详解最优原地解法（即你提供的TypeScript代码），帮你吃透核心逻辑、避开常见误区，轻松拿下这道经典题目。</p>
<h2 data-id="heading-0">一、题干核心要求（必看）</h2>
<p>题目给出一个 <code>n×n</code> 的二维矩阵 <code>matrix</code> 表示一幅图像，要求我们将其<strong>顺时针旋转90度</strong>，且必须满足以下核心约束：</p>
<ul>
<li>
<p>原地修改：禁止使用另一个矩阵存储旋转后的结果，只能直接操作输入的 <code>matrix</code>；</p>
</li>
<li>
<p>边界说明：<code>n</code> 的范围是 [1, 20]，矩阵元素为整数，无需处理边界外异常，但需保证旋转后索引不越界、元素位置正确。</p>
</li>
</ul>
<p>举个直观例子：输入3×3矩阵 <code>[[1,2,3],[4,5,6],[7,8,9]]</code>，旋转后需得到 <code>[[7,4,1],[8,5,2],[9,6,3]]</code>。</p>
<h2 data-id="heading-1">二、最优原地解法（你的代码，逐行解析）</h2>
<p>你提供的代码是「按圈旋转、4元素循环交换」的最优实现——逻辑直观、无冗余、效率拉满（时间复杂度 <code>O(n²)</code>，空间复杂度 <code>O(1)</code>，完全满足原地要求）。下面逐行拆解，让你清楚每一步的作用和底层逻辑。</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-comment">/**
 Do not return anything, modify matrix in-place instead.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">rotate</span>(<span class="hljs-params">matrix: <span class="hljs-built_in">number</span>[][]</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> side = matrix.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">if</span> (side === <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">const</span> laps = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(side / <span class="hljs-number">2</span>);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> lap = <span class="hljs-number">0</span>; lap &lt; laps; lap++) {
    <span class="hljs-keyword">const</span> start = lap;
    <span class="hljs-keyword">const</span> end = side - lap - <span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = start; index &lt; end; index++) {
      <span class="hljs-comment">// 保存当前位置的初始值（顶部边）</span>
      <span class="hljs-keyword">const</span> tempTop = matrix[start][index];
      
      <span class="hljs-comment">// 1. 左侧边 -&gt; 顶部边（对应位置）</span>
      matrix[start][index] = matrix[side - <span class="hljs-number">1</span> - index][start];
      
      <span class="hljs-comment">// 2. 底部边 -&gt; 左侧边（对应位置）</span>
      matrix[side - <span class="hljs-number">1</span> - index][start] = matrix[end][side - <span class="hljs-number">1</span> - index];
      
      <span class="hljs-comment">// 3. 右侧边 -&gt; 底部边（对应位置）</span>
      matrix[end][side - <span class="hljs-number">1</span> - index] = matrix[index][end];
      
      <span class="hljs-comment">// 4. 顶部边初始值 -&gt; 右侧边（对应位置）</span>
      matrix[index][end] = tempTop;
    }
  }
}
</code></pre>
<h3 data-id="heading-2">第一步：边界处理与圈数计算</h3>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">const</span> side = matrix.<span class="hljs-property">length</span>;
<span class="hljs-keyword">if</span> (side === <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>;
<span class="hljs-keyword">const</span> laps = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(side / <span class="hljs-number">2</span>);
</code></pre>
<p>这3行是解题的基础，主要解决「无需旋转」和「旋转多少圈」的问题：</p>
<ul>
<li>
<p><code>side = matrix.length</code>：获取矩阵的边长（n×n矩阵，边长即n）；</p>
</li>
<li>
<p><code>if (side === 1) return</code>：边界优化——1×1矩阵旋转后还是自身，无需任何操作，直接返回，避免无效循环；</p>
</li>
<li>
<p><code>laps = Math.floor(side / 2)</code>：计算需要旋转的圈数。核心逻辑：矩阵旋转是「从外到内，一圈一圈旋转」，n为奇数时，中心元素旋转后位置不变，无需旋转，因此圈数为n的一半（向下取整）。</p>
</li>
</ul>
<p>举例说明：4×4矩阵（偶数），圈数=2（外圈、内圈）；3×3矩阵（奇数），圈数=1（仅外圈，中心元素5无需旋转）。</p>
<h3 data-id="heading-3">第二步：外层循环——遍历每一圈</h3>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> lap = <span class="hljs-number">0</span>; lap &lt; laps; lap++) {
  <span class="hljs-keyword">const</span> start = lap;
  <span class="hljs-keyword">const</span> end = side - lap - <span class="hljs-number">1</span>;
  <span class="hljs-comment">// 内层循环：处理当前圈的元素</span>
}
</code></pre>
<p>外层循环控制「旋转哪一圈」，每循环一次，向内推进一圈，关键是确定当前圈的「边界索引」：</p>
<ul>
<li>
<p><code>start = lap</code>：当前圈的「起始索引」（行和列一致）。比如第0圈（最外圈），start=0；第1圈（内圈），start=1，以此类推；</p>
</li>
<li>
<p><code>end = side - lap - 1</code>：当前圈的「结束索引」（行和列一致）。比如4×4矩阵，第0圈end=3（最右/最下边界），第1圈end=2（内圈边界）；3×3矩阵，第0圈end=2。</p>
</li>
</ul>
<p>有了start和end，就确定了当前圈的范围：行和列都从start到end，构成一个正方形的圈。</p>
<h3 data-id="heading-4">第三步：内层循环——处理当前圈的元素（核心交换逻辑）</h3>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = start; index &lt; end; index++) {
  <span class="hljs-comment">// 保存当前位置的初始值（顶部边）</span>
  <span class="hljs-keyword">const</span> tempTop = matrix[start][index];
  
  <span class="hljs-comment">// 1. 左侧边 -&gt; 顶部边（对应位置）</span>
  matrix[start][index] = matrix[side - <span class="hljs-number">1</span> - index][start];
  
  <span class="hljs-comment">// 2. 底部边 -&gt; 左侧边（对应位置）</span>
  matrix[side - <span class="hljs-number">1</span> - index][start] = matrix[end][side - <span class="hljs-number">1</span> - index];
  
  <span class="hljs-comment">// 3. 右侧边 -&gt; 底部边（对应位置）</span>
  matrix[end][side - <span class="hljs-number">1</span> - index] = matrix[index][end];
  
  <span class="hljs-comment">// 4. 顶部边初始值 -&gt; 右侧边（对应位置）</span>
  matrix[index][end] = tempTop;
}
</code></pre>
<p>这是整个代码的核心，也是原地旋转的关键——<strong>每一圈的元素，按「顶部边→右侧边→底部边→左侧边」的顺序，4个对应位置循环交换</strong>。我们用「临时变量保存起始值」，避免赋值时覆盖原数据，逐句解析：</p>
<h4 data-id="heading-5">1. 确定交换的4个核心位置</h4>
<p>以当前圈的「顶部边元素 <code>matrix[start][index]</code>」为起点，这4个位置的对应关系的核心逻辑是：顺时针旋转90度，每个元素的位置都会转移到它的「顺时针相邻边」的对应位置，具体对应如下：</p>
<ul>
<li>
<p>顶部边：<code>matrix[start][index]</code> —— 要移动到「右侧边」的对应位置；</p>
</li>
<li>
<p>左侧边：<code>matrix[side-1-index][start]</code> —— 要移动到「顶部边」的当前位置；</p>
</li>
<li>
<p>底部边：<code>matrix[end][side-1-index]</code> —— 要移动到「左侧边」的对应位置；</p>
</li>
<li>
<p>右侧边：<code>matrix[index][end]</code> —— 要移动到「底部边」的对应位置。</p>
</li>
</ul>
<h4 data-id="heading-6">2. 4步循环赋值（关键，避免覆盖）</h4>
<p>赋值顺序不能乱，必须从「左侧边→顶部边」开始，最后将顶部边的初始值赋给右侧边，原因是：我们用<code>tempTop</code>保存了顶部边的初始值，若先修改顶部边，会导致后续赋值丢失原始数据。</p>
<ol>
<li>
<p><code>const tempTop = matrix[start][index]</code>：保存顶部边当前元素的初始值，防止后续赋值覆盖；</p>
</li>
<li>
<p><code>matrix[start][index] = matrix[side-1-index][start]</code>：将左侧边的对应元素，移动到顶部边的当前位置；</p>
</li>
<li>
<p><code>matrix[side-1-index][start] = matrix[end][side-1-index]</code>：将底部边的对应元素，移动到左侧边的对应位置；</p>
</li>
<li>
<p><code>matrix[end][side-1-index] = matrix[index][end]</code>：将右侧边的对应元素，移动到底部边的对应位置；</p>
</li>
<li>
<p><code>matrix[index][end] = tempTop</code>：将顶部边的初始值（tempTop），移动到右侧边的对应位置。</p>
</li>
</ol>
<h3 data-id="heading-7">用3×3矩阵举例，直观理解交换过程</h3>
<p>输入3×3矩阵：<code>[[1,2,3],[4,5,6],[7,8,9]]</code>，side=3，laps=1，仅旋转最外圈（start=0，end=2），index从0遍历到1（不包含end=2）：</p>
<p>当index=0时：</p>
<ul>
<li>
<p>tempTop = matrix[0][0] = 1（保存顶部边初始值）；</p>
</li>
<li>
<p>matrix[0][0] = matrix[2][0] = 7（左侧边→顶部边）；</p>
</li>
<li>
<p>matrix[2][0] = matrix[2][2] = 9（底部边→左侧边）；</p>
</li>
<li>
<p>matrix[2][2] = matrix[0][2] = 3（右侧边→底部边）；</p>
</li>
<li>
<p>matrix[0][2] = tempTop = 1（顶部边初始值→右侧边）；</p>
</li>
<li>
<p>此时矩阵变为：<code>[[7,2,1],[4,5,6],[9,8,3]]</code>。</p>
</li>
</ul>
<p>当index=1时：</p>
<ul>
<li>
<p>tempTop = matrix[0][1] = 2（保存顶部边初始值）；</p>
</li>
<li>
<p>matrix[0][1] = matrix[1][0] = 4（左侧边→顶部边）；</p>
</li>
<li>
<p>matrix[1][0] = matrix[2][1] = 8（底部边→左侧边）；</p>
</li>
<li>
<p>matrix[2][1] = matrix[1][2] = 6（右侧边→底部边）；</p>
</li>
<li>
<p>matrix[1][2] = tempTop = 2（顶部边初始值→右侧边）；</p>
</li>
<li>
<p>最终矩阵变为：<code>[[7,4,1],[8,5,2],[9,6,3]]</code>，旋转完成。</p>
</li>
</ul>
<h2 data-id="heading-8">三、常见误区避坑（新手必看）</h2>
<p>很多人实现原地旋转时，容易踩坑导致结果错误或索引越界，结合这道题和你的代码，总结3个高频误区：</p>
<h3 data-id="heading-9">误区1：索引颠倒（最致命）</h3>
<p>二维矩阵 <code>matrix[x][y]</code> 中，<code>x</code> 是行号（垂直方向，从上到下递增），<code>y</code> 是列号（水平方向，从左到右递增）。新手容易把行和列颠倒，比如误将 <code>matrix[side-1-index][start]</code> 写成 <code>matrix[start][side-1-index]</code>，导致元素赋值到错误位置。</p>
<h3 data-id="heading-10">误区2：赋值顺序错误（覆盖原始数据）</h3>
<p>若不先保存顶部边的初始值（tempTop），或颠倒赋值顺序（比如先将顶部边的值赋给右侧边），会导致后续赋值时，原始数据被覆盖，最终旋转结果错误。你的代码通过「先保存、再从左到右赋值」完美避开了这个坑。</p>
<h3 data-id="heading-11">误区3：圈数计算错误</h3>
<p>有人会直接用 <code>laps = side / 2</code>（不向下取整），当side为奇数时，会多循环一次（比如3×3矩阵，laps=1.5，循环2次），导致中心元素被错误修改。正确写法是 <code>Math.floor(side / 2)</code>，确保奇数边长时，中心元素不被处理。</p>
<h2 data-id="heading-12">四、拓展：另一种简洁解法（转置+反转）</h2>
<p>除了你的「按圈交换」思路，还有一种更简洁的原地解法——「先转置矩阵，再反转每一行」，代码更短，适合面试时快速书写，这里也提供TypeScript实现，供你拓展思路：</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">function</span> <span class="hljs-title function_">rotate</span>(<span class="hljs-params">matrix: <span class="hljs-built_in">number</span>[][]</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> n = matrix.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 第一步：转置矩阵（行变列，列变行）</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = i; j &lt; n; j++) {
      [matrix[i][j], matrix[j][i]] = [matrix[j][i], matrix[i][j]];
    }
  }
  <span class="hljs-comment">// 第二步：反转每一行（完成顺时针旋转90度）</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) {
    matrix[i].<span class="hljs-title function_">reverse</span>();
  }
}
</code></pre>
<p>逻辑说明：转置矩阵后，每一行的元素顺序恰好是旋转后元素的逆序，反转每一行即可得到顺时针旋转90度的结果。比如3×3矩阵，转置后为 <code>[[1,4,7],[2,5,8],[3,6,9]]</code>，反转每一行后就是目标结果。</p>
<p>对比你的解法：这种方法代码更简洁，但需要理解「转置+反转」与「顺时针旋转90度」的等价性，对新手不够友好；而你的解法逻辑更直观，贴合旋转的本质，更容易理解和调试，推荐新手优先掌握。</p>
<h2 data-id="heading-13">五、刷题总结</h2>
<p>LeetCode 48题「旋转图像」的核心是「原地操作」，你的代码已经是最优解法，总结关键点：</p>
<ol>
<li>
<p>核心思路：按圈旋转，从外到内，每一圈的4个对应位置循环交换；</p>
</li>
<li>
<p>关键技巧：用临时变量保存起始值，避免赋值覆盖，赋值顺序不能乱；</p>
</li>
<li>
<p>效率优势：时间复杂度<code>O(n²)</code>（遍历所有元素一次），空间复杂度<code>O(1)</code>（无额外空间），完全满足题目要求；</p>
</li>
<li>
<p>避坑重点：明确矩阵行和列的索引含义，正确计算旋转圈数，避免赋值顺序错误。</p>
</li>
</ol>
<p>最后提醒：刷题时，建议把你的代码复制到LeetCode编辑器，测试不同用例（偶数n、奇数n），亲手调试每一步的索引变化，才能真正吃透逻辑，下次遇到类似的原地旋转题目，就能快速上手～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[春哥的Agent通关秘籍01：什么是Agent开发]]></title>    <link>https://juejin.cn/post/7601175299012165647</link>    <guid>https://juejin.cn/post/7601175299012165647</guid>    <pubDate>2026-02-02T00:02:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601175299012165647" data-draft-id="7601169244454748186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="春哥的Agent通关秘籍01：什么是Agent开发"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-02T00:02:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="摸鱼的春哥"/> <meta itemprop="url" content="https://juejin.cn/user/1714893870865303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            春哥的Agent通关秘籍01：什么是Agent开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893870865303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    摸鱼的春哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T00:02:06.000Z" title="Mon Feb 02 2026 00:02:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><p>在和一个女孩恋爱之前，要做的第一件事永远是：</p>
<blockquote>
<p>认识这个女孩。</p>
</blockquote>
<p>所以在开发 AI Agent之前，我们首先要认识 <code>AI Agent</code>，明确它是什么，它的价值在哪里。只有这样，我们才能选择合适的技术路线。</p>
<h2 data-id="heading-0">一、AI Agent 是什么？</h2>
<blockquote>
<p>一句话：AI Agent 是一个以 LLM 为大脑，能够通过逻辑推理（Reasoning），自主规划步骤并调用工具（Tools），以解决非固定流程任务的系统。</p>
</blockquote>
<p>什么，还有点抽象？</p>
<p>那我们说人话：</p>
<blockquote>
<p>AI Agent 就是：能帮你干活儿的AI系统。</p>
</blockquote>
<p>这里的关键其实是“能干活”这三个字，这是把AI Agent那些只能和你聊天的 LLM 大语言模型区分开的关键所在。</p>
<p>举几个例子：</p>
<h3 data-id="heading-1">例子一：数据分析</h3>
<p>假设：你是一个销售经理，手里有一个 100MB 的 Excel 表格，你想知道“上个月哪个产品的利润率最高”。</p>
<ul>
<li>LLM 对话能力：“你可以用 Excel 的透视表功能，或者写一段 Python 代码来分析……”（它给你方法，但你要自己动手）。</li>
<li>AI Agent：
<ul>
<li>理解意图，“计算利润率”并“排序”。</li>
<li>规划路径：
<ul>
<li>先读取文件前几行，理解表头。</li>
<li>编写 Python 代码计算 (销售额-成本)/销售额。</li>
<li>绘制柱状图并生成结论。</li>
</ul>
</li>
<li>调用工具：
<ul>
<li>调用 Python 解释器（沙盒环境），真正执行了代码，生成了图表文件。</li>
</ul>
</li>
<li>记忆存储：
<ul>
<li>它记住了你刚刚上传的 CSV 文件结构，后续你问“那这个产品的库存呢？”它不需要你重新上传文件。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://pic.zhangshichun.top/pic/20260131092453658.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">例子二：AI编程</h3>
<p>假设：你想写一个贪吃蛇游戏，但你不懂代码。</p>
<ul>
<li>LLM 对话能力：它会吐给你一段代码。当你运行报错时，你得把报错信息复制回给它，它再改，反反复复。（它是被动的）。</li>
<li>AI Agent: 你只需要说一句“帮我写个贪吃蛇”，然后就可以去喝咖啡了。
<ul>
<li>理解意图，生成游戏的核心逻辑代码。</li>
<li>规划路径：
<ul>
<li>写代码。</li>
<li>主动运行 python snake.py。</li>
<li>观察到报错了（比如少了一个库）。</li>
<li>自主决定调用 pip install pygame 安装库。</li>
<li>再次运行，直到成功。</li>
</ul>
</li>
<li>调用工具：
<ul>
<li>它有权限访问你的终端 (Terminal) 和 文件编辑器。它直接在你的文件夹里创建了 snake.py。</li>
</ul>
</li>
<li>记忆存储：
<ul>
<li>它知道刚才修过哪些 bug，不会在同一个坑里跌倒两次。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://pic.zhangshichun.top/pic/20260131093459290.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">二、AI Agent 的架构</h2>
<p>由于 Agent 远远还没有像 Spring全家桶统治web开发那样的最佳实践，所以目前所有的架构分享都只能是基于市面上大部分产品形成的共识总结的，只能作为参考。</p>
<p>但目前认可度最高的结构是这样的：</p>
<ul>
<li>大脑：LLM</li>
<li>规划：Planning</li>
<li>记忆：Memory</li>
<li>工具：Tool Use</li>
</ul>
<p><img src="https://pic.zhangshichun.top/pic/20260131095302048.png" alt="" loading="lazy"/></p>
<p>不要把 Agent 想得太玄乎，它其实就是一个公式：</p>
<p>Agent（智能体） = 大脑 (LLM) + 双手 (Tools) + 记忆 (Memory) + 规划 (Planning)</p>
<ul>
<li>
<p>大脑：负责逻辑推理（比如 DeepSeek, GPT-4）。</p>
</li>
<li>
<p>双手：负责与现实世界交互（搜索、写文件、发邮件）。</p>
</li>
<li>
<p>记忆：负责记住用户偏好和私有数据（数据库、向量库）。</p>
</li>
<li>
<p>规划：负责拆解复杂任务（先查天气，再决定带不带伞）。</p>
</li>
</ul>
<p>我们的学习路径，就是逐一攻克这四个模块的过程。</p>
<h2 data-id="heading-4">学习目标一：掌控LLM，结构化输出</h2>
<blockquote>
<p>让 AI 说“机器话”，而不是“人话”。</p>
</blockquote>
<p>很多新手只会在聊天框里问 AI 问题。但程序无法处理 AI 随心所欲的回答。 Agent 开发的第一课，是强迫 AI 输出结构化数据（JSON）。只有输出 JSON，你的 Python 代码才能接住数据，进行下一步逻辑处理。</p>
<ul>
<li>
<p>核心技能：</p>
<ul>
<li>
<p>Prompt Engineering（角色设定、System Prompt）。</p>
</li>
<li>
<p>JSON Mode：强制模型输出 JSON。</p>
</li>
<li>
<p>Pydantic：Python 的数据验证库（Agent 开发神器）。</p>
</li>
</ul>
</li>
<li>
<p>实战小目标：信息提取器</p>
<ul>
<li>
<p>输入：一段乱七八糟的用户评论（“App 太卡了，我是 iPhone 13，给一星”）。</p>
</li>
<li>
<p>输出：{"sentiment": "negative", "device": "iPhone 13", "issue": "performance"}。</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://pic.zhangshichun.top/pic/20260131101241497.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">学习目标二：能力调用(Function Calling)</h2>
<blockquote>
<p>不再是让 AI 回答问题，而是让 AI 决定调用哪个函数。</p>
</blockquote>
<p>在这个阶段，不是 AI 自己去联网，而是 AI 告诉你：“请帮我运行 Google Search 函数，关键词是 Python”，然后你帮它运行，把结果喂给它。</p>
<ul>
<li>
<p>核心技能：</p>
<ul>
<li>
<p>Tools Schema：如何给 AI 写“工具说明书”。</p>
</li>
<li>
<p>Tool Choice：处理 AI 的调用请求。</p>
</li>
<li>
<p>API 集成：通过 Python requests 库连接外部世界。</p>
</li>
</ul>
</li>
<li>
<p>实战小目标：智能文件整理助手</p>
<ul>
<li>
<p>用户指令：“把所有图片放到 Images 文件夹，文档放到 Docs 文件夹。”</p>
</li>
<li>
<p>Agent 行为：自主调用 Python 的 os 和 shutil 库，真实地操作你的电脑文件。</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://pic.zhangshichun.top/pic/20260131101610697.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">学习目标三：构建记忆 (RAG &amp; Vector DB)</h2>
<blockquote>
<p>给 AI 外挂一个“硬盘”。</p>
</blockquote>
<p>大模型的上下文窗口有限，且记不住你的私有数据（比如你的个人日记、公司文档）。我们需要用 RAG（检索增强生成） 技术，让 Agent 拥有长期记忆。</p>
<ul>
<li>
<p>核心技能：</p>
<ul>
<li>
<p>Embeddings：把文字变成向量（一串数字）。</p>
</li>
<li>
<p>Vector DB：向量数据库（如 ChromaDB）。</p>
</li>
<li>
<p>Chunking：如何把长文档切片。</p>
</li>
</ul>
</li>
<li>
<p>实战小目标：私人知识库问答 Bot</p>
<ul>
<li>
<p>把你的“技术学习笔记”或“游戏设计草稿”喂给 Agent。</p>
</li>
<li>
<p>你可以问它：“我上周关于战斗系统的设计思路是什么？”它能精准引用你的文档回答。</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://pic.zhangshichun.top/pic/20260131101850131.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">学习目标四：思考与行动的循环</h2>
<blockquote>
<p>从“单步操作”进化到“自主解决复杂问题”。</p>
</blockquote>
<p>如果用户问“分析一下 2026 年的游戏市场趋势”，这不是调用一个工具能解决的。Agent 需要学会：搜索 -&gt; 阅读 -&gt; 思考 -&gt; 再搜索 -&gt; 总结。这就需要 ReAct（Reasoning + Acting） 模式。</p>
<ul>
<li>
<p>核心技能：</p>
<ul>
<li>
<p>ReAct Loop：思考-行动-观察的循环。</p>
</li>
<li>
<p>LangGraph：学习如何用图（Graph）的概念来管理复杂的 Agent 状态。</p>
</li>
</ul>
</li>
<li>
<p>实战小目标：全自动研报生成器</p>
<ul>
<li>输入一个课题，Agent 自动上网搜索多篇资料，阅读并汇总，最后生成一篇有理有据的 Markdown 报告保存到本地。</li>
</ul>
</li>
</ul>
<p><img src="https://pic.zhangshichun.top/pic/20260131102129964.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">学习目标五：多Agent系统</h2>
<blockquote>
<p>目标：指挥一群AI干好一个活儿。</p>
</blockquote>
<p>当任务极其复杂时，我们需要多个 Agent 分工协作。比如一个负责通过 API 写代码，另一个负责运行测试，测试不通过就打回重写。</p>
<ul>
<li>
<p>核心技能：</p>
<ul>
<li>
<p>Role Playing：通过 Prompt 隔离不同 Agent 的职责。</p>
</li>
<li>
<p>Handoffs：任务在不同 Agent 之间的流转。</p>
</li>
<li>
<p>框架应用：CrewAI 或 AutoGen。</p>
</li>
</ul>
</li>
<li>
<p>实战小目标：虚拟游戏开发工作室</p>
<ul>
<li>
<p>策划 Agent：提出创意。</p>
</li>
<li>
<p>编剧 Agent：完善世界观故事。</p>
</li>
<li>
<p>美术 Agent：生成对应的画面提示词。</p>
</li>
</ul>
</li>
</ul>
<p>一键运行，三个 AI 自动开会，给你输出一份完整的游戏设计案。
<img src="https://pic.zhangshichun.top/pic/20260131102347165.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">小节</h2>
<p>本文我们明确了AI Agent是什么，它和LLM Chat的区别是什么，它有那些特点，能解决什么问题，是如何架构的。</p>
<p>并且我们拟定了一个五步走的学习目标。</p>
<p>下一步，我们要从头开始：搭建一个主流的AI开发环境。</p>
<p>敬请期待！</p>
<p><img src="https://pic.zhangshichun.top/pic/ScreenShot_2026-01-26_082327_821.png" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[春哥的Agent通关秘籍02：搭建环境及语言选择]]></title>    <link>https://juejin.cn/post/7601419065128239123</link>    <guid>https://juejin.cn/post/7601419065128239123</guid>    <pubDate>2026-02-02T00:07:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601419065128239123" data-draft-id="7601419065128222739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="春哥的Agent通关秘籍02：搭建环境及语言选择"/> <meta itemprop="keywords" content="前端,后端,Python"/> <meta itemprop="datePublished" content="2026-02-02T00:07:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="摸鱼的春哥"/> <meta itemprop="url" content="https://juejin.cn/user/1714893870865303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            春哥的Agent通关秘籍02：搭建环境及语言选择
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893870865303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    摸鱼的春哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T00:07:51.000Z" title="Mon Feb 02 2026 00:07:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><p>很多想学 AI 开发的朋友，往往倒在了第一步：配环境。</p>
<p>我们要做的不是简单的“安装软件”，而是构建一个专业的数字化工作台。</p>
<p>在这篇文章中，我们将解释为什么 Python 是不二之选，为什么我们需要 Conda，并带你从零开始跑通第一行 AI 代码（以 DeepSeek 为例）。</p>
<h2 data-id="heading-0">一、为什么是 Python</h2>
<p>虽然 Java、Go、JavaScript 也能写 AI 应用，但是。</p>
<p>在 AI Agent 开发领域，Python 是绝对的“第一公民”，它拥有无法撼动的优势：</p>
<ul>
<li>
<p>统治级的生态：几乎所有主流 AI 框架（PyTorch, LangChain, CrewAI）都优先发布 Python 版。</p>
</li>
<li>
<p>胶水语言：Agent 的核心是“连接”——连接大模型、连接 API、连接本地文件。Python 写这种连接逻辑最快。</p>
</li>
<li>
<p>门槛低：它的语法接近英语，让你能把精力集中在“设计智能体逻辑”上，而不是纠结语法细节。</p>
</li>
</ul>
<p>结论：想做 AI Agent，首选 Python。</p>
<p>尤其是学习的话，先学 python，面向最先进最全面的工具链是最优选，等python这块熟悉原理了，再按诉求辐射到自己需要的场景和语言也是非常方便的。</p>
<p><img src="https://pic.zhangshichun.top/pic/20260131131848180.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">二、 为什么要用 Miniconda？</h2>
<p>很多新手会直接去 Python 官网下载安装包，这其实是个“大坑”。</p>
<p>在开发中，我们需要管理各种复杂的库（依赖）。为了防止项目 A 的库和项目 B 的库打架（版本冲突），我们需要 <strong>“虚拟环境”</strong>。</p>
<p>为什么不用 <code>Docker</code> ？</p>
<ul>
<li>Docker虽然隔离性最好，但对初学者来说，操作文件和调试太麻烦，阻碍学习心流。</li>
<li>乱七八糟的环境问题会让初学者信心受挫，容易被打断学习进程。</li>
</ul>
<p><code>Miniconda</code> 有哪些优势？</p>
<p><code>Miniconda</code> 是一个轻量级的环境管理工具。</p>
<ul>
<li>
<p>它可以帮你一键切换 Python 版本（3.10, 3.11, 3.12 随意切）。</p>
</li>
<li>
<p>它能创建独立的“沙盒”，让你随意折腾而不破坏电脑系统。</p>
</li>
<li>
<p>它对文件系统的操作比 <code>docker</code> 方便一万倍，不需要挂载什么<code>volumes</code>映射，对初学者连贯学习更方便。</p>
</li>
</ul>
<p><img src="https://pic.zhangshichun.top/pic/20260131133124958.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">三、 手把手搭建环境</h2>
<h3 data-id="heading-3">第一步：安装 Miniconda及环境变量</h3>
<p>访问 Miniconda 官网 下载对应系统的安装包。地址：<a href="https://link.juejin.cn?target=docs.conda.io%2Fen%2Flatest%2Fminiconda.html" target="_blank" title="docs.conda.io/en/latest/miniconda.html" ref="nofollow noopener noreferrer">docs.conda.io/en/latest/m…</a></p>
<p>安装之后，记得把安装文件夹下<code>condabin</code>目录加入到环境变量里。（针对windows用户哈）</p>
<p>比如我的，就是把 <code>D:\miniconda\condabin</code> 加入到环境变量。</p>
<p><img src="https://pic.zhangshichun.top/pic/20260131155507332.png" alt="" loading="lazy"/></p>
<p>以 <code>cmd</code> 能执行：</p>
<pre><code class="hljs language-bash" lang="bash">conda --version
</code></pre>
<p><img src="https://pic.zhangshichun.top/pic/20260201093046760.png" alt="" loading="lazy"/></p>
<p>输出<code>25.11.1</code>这样的版本号就代表环境变量配置ok。</p>
<h3 data-id="heading-4">第二步：创建 AI 专属环境</h3>
<p>打开你的终端（Windows 用户推荐 PowerShell，Mac 用户用 Terminal），输入以下命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 创建一个名为 ai_agent 的环境，指定使用 Python 3.11（稳定性最佳）</span>
conda create -n ai_agent python=3.11 -y

<span class="hljs-comment"># 2. 激活环境（看到命令行前缀变成 (ai_agent) 即成功）</span>
conda activate ai_agent
</code></pre>
<p>这里 <code>powerShell</code> 可能会遇到一个坑：执行完 <code>conda activate ai_agent</code> 后没反应。</p>
<ul>
<li>
<p>原因：PowerShell 的安全策略默认比较严格，禁止运行未签名的脚本（Conda 的激活脚本本质上是一段 PowerShell 脚本）。</p>
</li>
<li>
<p>解决方法：你需要赋予 PowerShell 执行权限。</p>
<ul>
<li>
<p>以管理员身份打开 PowerShell。</p>
</li>
<li>
<p>运行以下命令：</p>
</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
</code></pre>
<ul>
<li>输入 Y 确认</li>
<li>重新运行 <code>conda init powershell</code>，然后重启 PowerShell 窗口。</li>
</ul>
</li>
</ul>
<p>分别执行以下代码后：</p>
<pre><code class="hljs language-css" lang="css">conda activate ai_agent
python <span class="hljs-attr">--version</span>
</code></pre>
<p><img src="https://pic.zhangshichun.top/pic/20260201093259212.png" alt="" loading="lazy"/>
如果能成功显示python的版本号代表ok。</p>
<h2 data-id="heading-5">四、接入Deepseek大模型</h2>
<p><code>deepseek</code> 被称为性价比之王。原因在于token单价非常划算，而且对于国内用户来说网络条件支持也是极好的，所以非常适合学习选择。</p>
<p>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2Fusage" target="_blank" title="https://platform.deepseek.com/usage" ref="nofollow noopener noreferrer">platform.deepseek.com/usage</a> 可以非常便捷地完成注册和充值，2-3块钱就足够用很久很久了。</p>
<p>然后在 <code>api keys</code> 页面创建一个 <code>API Key</code>，复制这个key，我们接下来会用到。</p>
<h3 data-id="heading-6">4.1 安装核心库</h3>
<p>随便创建一个学习用的文件夹，在该文件夹里打开命令行，执行以下命令：</p>
<pre><code class="hljs language-bash" lang="bash">conda activate ai_agent
pip install openai python-dotenv pydantic
</code></pre>
<h3 data-id="heading-7">4.2 配置你的key</h3>
<p>永远不要把 API Key 直接写在代码里！ 一旦你不小心截图或把代码上传 GitHub，Key 就会泄露。</p>
<p>我们在项目根目录下创建一个名为 .env 的文件（注意前面有个点），内容如下：</p>
<pre><code class="hljs language-.env" lang=".env"># 这里的 Key 仅作示例，请替换为你自己的
DEEP_SEEK_API_KEY=sk-xxxx
DEEP_SEEK_API_URL=https://api.deepseek.com
</code></pre>
<h3 data-id="heading-8">4.3 3. 编写“Hello World”测试脚本</h3>
<p>新建一个文件 check_env.py，粘贴以下代码。这段代码会自动读取 .env 里的配置来连接 DeepSeek。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI

<span class="hljs-comment"># 1. 加载环境变量</span>
load_dotenv()

<span class="hljs-comment"># 2. 从环境读取配置</span>
api_key = os.getenv(<span class="hljs-string">"DEEP_SEEK_API_KEY"</span>)
base_url = os.getenv(<span class="hljs-string">"DEEP_SEEK_API_URL"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"正在检查环境配置..."</span>)

<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> api_key:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 错误：未找到 API KEY，请检查 .env 文件"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-comment"># 为了安全，只打印前几位和后几位</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ API Key 读取成功: <span class="hljs-subst">{api_key[:<span class="hljs-number">6</span>]}</span>******<span class="hljs-subst">{api_key[-<span class="hljs-number">4</span>:]}</span>"</span>)

<span class="hljs-comment"># 3. 尝试发起一次真实的对话请求</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-comment"># DeepSeek 兼容 OpenAI SDK，只需替换 base_url</span>
    client = OpenAI(api_key=api_key, base_url=base_url)
    
    response = client.chat.completions.create(
        model=<span class="hljs-string">"deepseek-chat"</span>,  <span class="hljs-comment"># DeepSeek 的模型名称</span>
        messages=[
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个有用的AI助手"</span>},
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好，请用一句话证明你已经连接成功了。"</span>},
        ]
    )
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n🎉 连接成功！大模型回复："</span>)
    <span class="hljs-built_in">print</span>(response.choices[<span class="hljs-number">0</span>].message.content)
    
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n❌ 连接失败: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<h3 data-id="heading-9">4.4 运行验证</h3>
<p>在终端运行：</p>
<pre><code class="hljs">python check_env.py
</code></pre>
<p>如果你看到 “🎉 连接成功！” 以及 DeepSeek 的回复，恭喜你！你已经拥有了一个可以随时调用的 AI 大脑，并且搭建好了专业的 Python 开发环境。
<img src="https://pic.zhangshichun.top/pic/20260201093415136.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">下一步预告</h2>
<p>环境搭好了，只会聊天可不行。</p>
<p>在下一篇 《AI Agent 编程入门 03：结构化输出》 中，我们将学习如何通过 Prompt 工程 和 结构化数据（JSON），强迫 AI 不再“胡言乱语”，而是像程序一样精准输出我们需要的数据格式。</p>
<p>敬请期待！</p>
<p><img src="https://pic.zhangshichun.top/pic/ScreenShot_2026-01-26_082327_821.png" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用一个小 Demo，带你入门安卓 Clean Architecture]]></title>    <link>https://juejin.cn/post/7601486204174123058</link>    <guid>https://juejin.cn/post/7601486204174123058</guid>    <pubDate>2026-02-02T00:10:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601486204174123058" data-draft-id="7601028900886462510" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用一个小 Demo，带你入门安卓 Clean Architecture"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-02-02T00:10:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="潜龙勿用之化骨龙"/> <meta itemprop="url" content="https://juejin.cn/user/2313028195058471"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用一个小 Demo，带你入门安卓 Clean Architecture
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313028195058471/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    潜龙勿用之化骨龙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T00:10:42.000Z" title="Mon Feb 02 2026 00:10:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：为什么你的代码越来越难维护？</h2>
<p>你是否遇到过这些问题：</p>
<ul>
<li>业务逻辑直接写在 <code>Activity / Fragment</code> 里</li>
<li>UI、网络、数据库代码混在一起，牵一发而动全身</li>
<li>一个接口字段改动，整个项目到处报错</li>
<li>想写单元测试，却发现严重依赖 Android Framework</li>
</ul>
<p>如果你对以上情况并不陌生，那么问题往往不是你写得不够努力，而是<strong>项目缺乏清晰的架构设计</strong>。</p>
<p><strong>Clean Architecture（整洁架构）</strong>，正是为了解决这些问题而提出的一种架构思想。</p>
<hr/>
<h2 data-id="heading-1">什么是 Clean Architecture？</h2>
<p><strong>Clean Architecture 不是一个框架，而是一种设计原则。</strong></p>
<p>它的核心目标可以总结为一句话：</p>
<blockquote>
<p><strong>让核心业务逻辑独立于 UI、框架和实现细节。</strong></p>
</blockquote>
<p>也就是说：</p>
<ul>
<li>UI 可以随意更换（XML → Compose）</li>
<li>网络库可以替换（Retrofit → Ktor）</li>
<li>数据来源可以变化（API → 本地数据库）</li>
</ul>
<p>👉 <strong>但业务逻辑几乎不用改动。</strong></p>
<h3 data-id="heading-2">核心原则：依赖倒置（Dependency Rule）</h3>
<p>Clean Architecture 最重要的一条规则是：</p>
<blockquote>
<p><strong>代码的依赖方向，只能从外层指向内层。</strong></p>
</blockquote>
<ul>
<li>内层：业务规则（最稳定）</li>
<li>外层：UI、网络、数据库（最容易变化）</li>
</ul>
<p>📌 内层永远不知道外层的存在</p>
<hr/>
<h2 data-id="heading-3">Clean Architecture 的分层结构</h2>
<p>在 Android 项目中，Clean Architecture 通常可以拆分为三层：</p>
<h3 data-id="heading-4">1️⃣ Presentation（表现层）</h3>
<p><strong>职责：负责 UI 展示和用户交互</strong></p>
<p>常见组件：</p>
<ul>
<li>Activity / Fragment</li>
<li>Jetpack Compose</li>
<li>ViewModel</li>
</ul>
<p>特点：</p>
<ul>
<li>不包含业务规则</li>
<li>只负责管理 UI State</li>
<li>通过 UseCase 调用业务逻辑</li>
</ul>
<hr/>
<h3 data-id="heading-5">2️⃣ Domain（领域层）⭐ 核心层</h3>
<p><strong>职责：定义业务规则和业务模型</strong></p>
<p>包含内容：</p>
<ul>
<li>Entity / Model</li>
<li>UseCase</li>
<li>Repository 接口（抽象）</li>
</ul>
<p>特点：</p>
<ul>
<li>纯 Kotlin</li>
<li>不依赖 Android</li>
<li>不依赖任何第三方库</li>
<li>是整个项目中最稳定的一层</li>
</ul>
<p>📌 这一层承载了项目真正的“业务价值”。</p>
<hr/>
<h3 data-id="heading-6">3️⃣ Data（数据层）</h3>
<p><strong>职责：负责数据从哪里来、如何获取</strong></p>
<p>包含内容：</p>
<ul>
<li>网络请求（API）</li>
<li>本地数据库</li>
<li>Repository 的具体实现</li>
</ul>
<p>特点：</p>
<ul>
<li>实现 Domain 层定义的接口</li>
<li>可以自由切换数据来源</li>
<li>是变化最频繁的一层</li>
</ul>
<hr/>
<h2 data-id="heading-7"><code>CleanArc</code> 项目实践</h2>
<p>接下来，我们通过一个简单的示例项目 <strong>CleanArc</strong>，来看看 Clean Architecture 在真实 Android 项目中是如何落地的。</p>
<p>🎯 项目目标很简单：</p>
<blockquote>
<p><strong>从服务器获取用户列表，并将其展示在界面上</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-8">Data 层：数据的来源（How）</h2>
<p>Data 层只关心一件事：</p>
<blockquote>
<p><strong>我如何把数据拿到？</strong></p>
</blockquote>
<h3 data-id="heading-9">Repository 实现</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fef8074fe1054699ac8efe7c6a05d763~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770595842&amp;x-signature=lqKvt7SKd04u0kQeYPBAAW20%2B5A%3D" alt="image.png" loading="lazy"/></p>
<p>📌 在本项目中，<strong>异常是在 Repository 层中被处理的</strong>。
Repository 最清楚异常的来源，因此在这里将技术异常转换为业务可理解的结果。</p>
<hr/>
<h2 data-id="heading-10">Domain 层：核心业务逻辑（What）</h2>
<p>Domain 层只关心：</p>
<blockquote>
<p><strong>我要做什么，而不是怎么做</strong></p>
</blockquote>
<h3 data-id="heading-11">Repository 接口（契约）</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f08b4c0205348018e7c1292f2088c0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770595842&amp;x-signature=e8Bqwbao19ASJKDPPyrIur3mgwE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-12">UseCase：业务行为的封装</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae2d99513b8241d5924ace93bb3ce7a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770595842&amp;x-signature=pvp%2BCgOUrf4hLr1BrFR%2Ffvdo6Vs%3D" alt="image.png" loading="lazy"/></p>
<p>📌 UseCase 不负责捕获异常
📌 它只组合和执行业务规则
📌 Domain 层因此保持高度纯净</p>
<hr/>
<h2 data-id="heading-13">Presentation 层：UI 展示（Show）</h2>
<p>Presentation 层负责将数据转换为用户可感知的界面状态。</p>
<h3 data-id="heading-14">ViewModel</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bbd9eaec32c4841a6c79bb816acd6d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770595842&amp;x-signature=euHVIi8Y1TQ8ErOtOU6iLEY10Tw%3D" alt="image.png" loading="lazy"/></p>
<p>特点：</p>
<ul>
<li>ViewModel 不直接依赖 Repository</li>
<li>只通过 UseCase 与 Domain 层交互</li>
<li>专注于 UI State 管理</li>
</ul>
<p>UI（Compose / XML）只需根据 State 渲染界面。</p>
<hr/>
<h2 data-id="heading-15">关于异常处理：为什么放在 Repository 层？</h2>
<p>在本项目中，<strong>异常处理主要集中在 Repository（Data 层）中完成</strong>，而不是在 UseCase 层统一 try-catch。</p>
<p>原因包括：</p>
<ul>
<li>Repository 最了解异常的真实来源（网络、数据库、解析）</li>
<li>可以在这里将技术异常转换为业务错误</li>
<li>避免将 Retrofit、HTTP Code 等细节泄露到 Domain 层</li>
<li>保持 Domain 层的纯净和稳定</li>
</ul>
<p>这种做法在 Android 工程实践中非常常见，也更利于长期维护。</p>
<hr/>
<h2 data-id="heading-16">依赖注入：将各层连接起来</h2>
<p>为了将接口和实现解耦，本项目使用 <strong>Koin</strong> 进行依赖注入：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63423494b6e641cdb2a498afcff35225~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770595842&amp;x-signature=LqcB7EogJ0HZofg2eX1uyv2YdY0%3D" alt="image.png" loading="lazy"/></p>
<p>通过依赖注入：</p>
<ul>
<li>Domain 层只定义接口</li>
<li>Data 层提供实现</li>
<li>Presentation 层只消费能力</li>
<li>各层之间无直接耦合</li>
</ul>
<hr/>
<h2 data-id="heading-17">总结</h2>
<p>通过 <code>CleanArc</code> 这个示例项目，我们可以看到 Clean Architecture 带来的价值：</p>
<ul>
<li>✅ <strong>关注点分离</strong>：UI、业务、数据各司其职</li>
<li>✅ <strong>可测试性强</strong>：UseCase 和 ViewModel 易于单元测试</li>
<li>✅ <strong>高可维护性</strong>：修改数据来源不会影响业务层</li>
<li>✅ <strong>适合长期演进的项目</strong></li>
</ul>
<p>Clean Architecture 对于中大型项目来说，它能显著降低维护成本，让代码结构更加清晰、可控。</p>
<hr/>
<h2 data-id="heading-18">示例代码</h2>
<p>📦 项目完整代码已上传至 GitHub：</p>
<p>👉 <strong>CleanArc 示例项目</strong>
🔗 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FThirdPrince%2FCleanArc" target="_blank" title="https://github.com/ThirdPrince/CleanArc" ref="nofollow noopener noreferrer">github.com/yourname/Cl…</a></p>
<p>欢迎 Star ⭐。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JFR：Spring Boot 应用的性能诊断利器]]></title>    <link>https://juejin.cn/post/7601486204174139442</link>    <guid>https://juejin.cn/post/7601486204174139442</guid>    <pubDate>2026-02-02T00:12:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601486204174139442" data-draft-id="7601374668961546290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JFR：Spring Boot 应用的性能诊断利器"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-02T00:12:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JFR：Spring Boot 应用的性能诊断利器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T00:12:33.000Z" title="Mon Feb 02 2026 00:12:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>GC 停顿、内存泄漏、接口响应变慢——线上服务出问题的时候，你是否也曾对着监控面板发呆，不知道根因在哪？</p>
<p>今天聊聊 Java 自带的性能诊断神器 JFR（Java Flight Recorder），配合 Spring Boot 使用，效果翻倍。</p>
<h2 data-id="heading-0">JFR 是什么</h2>
<p>JFR 是 JDK 内置的性能采集工具，知道的人不多，但用过的人都说是「真香」。</p>
<p>几个核心优势：</p>
<ul>
<li><strong>开销可控</strong>：通过事件开关控制采集粒度，精准场景下开销可压到极低</li>
<li><strong>事件丰富</strong>：GC、线程、IO、锁、CPU、异常……100+ 种事件类型</li>
<li><strong>历史回溯</strong>：录制文件可以离线分析，事后定位没问题</li>
<li><strong>持续录制</strong>：支持后台常驻，出问题随时有数据兜底</li>
</ul>
<blockquote>
<p>JDK 8 及之前 JFR 是商业特性，JDK 9+ 免费开源。</p>
</blockquote>
<p>生产环境启用前建议确认：磁盘空间充足、开启了 JFR 权限控制、采集的事件范围符合需求。</p>
<h2 data-id="heading-1">Spring Boot 启用 JFR</h2>
<h4 data-id="heading-2">方式一：启动参数（最简单）</h4>
<pre><code class="hljs language-bash" lang="bash">java -XX:StartFlightRecording:filename=recording.jfr,duration=60s -jar app.jar
</code></pre>
<p>更多参数配置：</p>
<pre><code class="hljs language-bash" lang="bash">java -XX:StartFlightRecording=\
    filename=app-recording.jfr,\
    dumponexit=<span class="hljs-literal">true</span>,\
    maxsize=500M,\
    maxage=1d,\
    settings=profile -jar app.jar
</code></pre>
<p>参数说明：</p>





























<table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td><code>filename</code></td><td>录制文件保存路径</td></tr><tr><td><code>dumponexit</code></td><td>JVM 退出时自动 dump</td></tr><tr><td><code>maxsize</code></td><td>单文件最大 size</td></tr><tr><td><code>maxage</code></td><td>最老数据的保留时间</td></tr><tr><td><code>settings</code></td><td>模板（production/profile）</td></tr></tbody></table>
<h4 data-id="heading-3">方式二：API 动态控制</h4>
<p>Spring Boot 可以通过 JMX 远程控制 JFR 开始/停止：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JfrController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MBeanServer</span> <span class="hljs-variable">mBeanServer</span> <span class="hljs-operator">=</span> ManagementFactory.getPlatformMBeanServer();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">JFR_BEAN_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">"com.oracle.jdk:jfrType=FlightRecorder"</span>;

    <span class="hljs-meta">@PostMapping("/jfr/start")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String filename)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ObjectName</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectName</span>(JFR_BEAN_NAME);
        Map&lt;String, String&gt; settings = Map.of(
            <span class="hljs-string">"jdk.JavaMonitorEnter#enabled"</span>, <span class="hljs-string">"true"</span>,
            <span class="hljs-string">"jdk.SocketRead#enabled"</span>, <span class="hljs-string">"true"</span>
        );
        mBeanServer.invoke(name, <span class="hljs-string">"startRecording"</span>,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{filename, settings},
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{String.class.getName(), Map.class.getName()}
        );
        <span class="hljs-keyword">return</span> <span class="hljs-string">"started: "</span> + filename;
    }

    <span class="hljs-meta">@PostMapping("/jfr/stop")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ObjectName</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectName</span>(JFR_BEAN_NAME);
        mBeanServer.invoke(name, <span class="hljs-string">"stopRecording"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{}, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{});
        <span class="hljs-keyword">return</span> <span class="hljs-string">"stopped"</span>;
    }
}
</code></pre>
<h4 data-id="heading-4">方式三：Actuator 集成</h4>
<p>Spring Boot Actuator 也能暴露 JFR 端点：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">health,info,jfr</span>
  <span class="hljs-attr">jfr:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">directory:</span> <span class="hljs-string">/var/log/jfr</span>
</code></pre>
<hr/>
<h2 data-id="heading-5">录制文件怎么分析</h2>
<h4 data-id="heading-6">JDK Mission Control (JMC)</h4>
<p>这是官方提供的 GUI 分析工具，JDK 11+ 自带。</p>
<pre><code class="hljs language-bash" lang="bash">jmc
</code></pre>
<p>打开录制文件后，重点看这几个视图：</p>
<p><strong>1. Recording View</strong> - 事件列表和分布
<strong>2. Code Path</strong> - 热点方法调用链
<strong>3. Memory</strong> - GC 和对象分配
<strong>4. Threads</strong> - 锁竞争、线程状态
<strong>5. I/O</strong> - 文件和网络延迟</p>
<h4 data-id="heading-7">命令行快速分析</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 概览</span>
jfr summary recording.jfr

<span class="hljs-comment"># 只看某类事件</span>
jfr <span class="hljs-built_in">print</span> --events <span class="hljs-string">"jdk.GC*,jdk.JavaMonitorEnter"</span> recording.jfr

<span class="hljs-comment"># 找出耗时最长的调用</span>
jfr <span class="hljs-built_in">print</span> --events <span class="hljs-string">"jdk.ExecutionSample"</span> recording.jfr | <span class="hljs-built_in">head</span> -30
</code></pre>
<h4 data-id="heading-8">代码分析脚本</h4>
<p>写个脚本批量处理多个录制文件：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JfrAnalyzer</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">var</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(args[<span class="hljs-number">0</span>]);
        Map&lt;String, Long&gt; durations = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        Map&lt;String, Integer&gt; counts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

        <span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> RecordingFile.open(file)) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> event : rs) {
                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> event.getEventType().getName();
                counts.merge(name, <span class="hljs-number">1</span>, Integer::sum);
                <span class="hljs-keyword">if</span> (event.hasValue(<span class="hljs-string">"duration"</span>)) {
                    <span class="hljs-type">long</span> <span class="hljs-variable">ns</span> <span class="hljs-operator">=</span> event.getDuration(<span class="hljs-string">"duration"</span>).toNanos();
                    durations.merge(name, ns, Long::sum);
                }
            }
        }

        <span class="hljs-comment">// 打印结果</span>
        System.out.println(<span class="hljs-string">"=== Most Frequent ==="</span>);
        counts.entrySet().stream()
            .sorted((a, b) -&gt; b.getValue() - a.getValue())
            .limit(<span class="hljs-number">10</span>).forEach(e -&gt;
                System.out.printf(<span class="hljs-string">"  %s: %d%n"</span>, e.getKey(), e.getValue()));

        System.out.println(<span class="hljs-string">"=== Slowest ==="</span>);
        durations.entrySet().stream()
            .sorted((a, b) -&gt; (<span class="hljs-type">int</span>)(b.getValue() - a.getValue()))
            .limit(<span class="hljs-number">10</span>).forEach(e -&gt;
                System.out.printf(<span class="hljs-string">"  %s: %d ms%n"</span>, e.getKey(), e.getValue() / <span class="hljs-number">1_000_000</span>));
    }
}
</code></pre>
<h2 data-id="heading-9">实战场景</h2>
<h4 data-id="heading-10">GC 停顿排查</h4>
<pre><code class="hljs language-bash" lang="bash">java -XX:StartFlightRecording:\
    filename=gc.jfr,\
    events=<span class="hljs-string">"jdk.GC*,jdk.YoungGarbageCollection,jdk.OldGarbageCollection"</span> -jar app.jar
</code></pre>
<p>JMC 里重点看：</p>
<ul>
<li>GC Pause 总时长和频率</li>
<li>Young GC 频率是否过高</li>
<li>对象晋升（Promotion）是否频繁</li>
</ul>
<h4 data-id="heading-11">接口慢请求定位</h4>
<p>先写个简单的耗时日志 AOP：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimingAspect</span> {

    <span class="hljs-meta">@Around("@annotation(GetMapping)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">trace</span><span class="hljs-params">(ProceedingJoinPoint p)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">var</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> p.proceed();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-type">var</span> <span class="hljs-variable">cost</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;
            <span class="hljs-keyword">if</span> (cost &gt; <span class="hljs-number">1000</span>) {
                System.out.printf(<span class="hljs-string">"[SLOW] %s: %d ms%n"</span>, p.getSignature(), cost);
            }
        }
    }
}
</code></pre>
<p>慢请求出现后，配合 JFR 定位具体瓶颈：</p>

























<table><thead><tr><th>JFR 事件</th><th>对应问题</th></tr></thead><tbody><tr><td><code>jdk.ExecutionSample</code></td><td>CPU 热点</td></tr><tr><td><code>jdk.FileRead/Write</code></td><td>磁盘 IO 慢</td></tr><tr><td><code>jdk.SocketRead/Write</code></td><td>网络 IO 慢</td></tr><tr><td><code>jdk.JavaMonitorEnter</code></td><td>锁等待</td></tr></tbody></table>
<h4 data-id="heading-12">内存泄漏</h4>
<p>开启对象分配事件：</p>
<pre><code class="hljs">jdk.ObjectAllocationInNewTLAB
jdk.ObjectAllocationOutsideTLAB
jdk.OldGarbageCollection
</code></pre>
<p>老年代回收频率异常升高 + 堆大小持续增长，基本就是泄漏了。配合 <code>jfr print --events "jdk.OldGarbageCollection"</code> 看回收模式，再导出堆 dump 定位泄漏对象。</p>
<h2 data-id="heading-13">生产环境注意事项</h2>
<h4 data-id="heading-14">1. 资源限制</h4>
<pre><code class="hljs language-bash" lang="bash">-XX:FlightRecorderOptions=maxchunksize=100M,memorysize=50M
</code></pre>
<h4 data-id="heading-15">2. 持续录制 + 轮转</h4>
<pre><code class="hljs language-bash" lang="bash">java -XX:StartFlightRecording=\
    filename=/opt/jfr/app.jfr,\
    dumponexit=<span class="hljs-literal">true</span>,\
    maxage=7d,\
    maxsize=1G,\
    settings=production -jar app.jar
</code></pre>
<h4 data-id="heading-16">3. 权限控制</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">export</span> <span class="hljs-string">COM_SUN_JDK_JFR_OPTIONS="security-manager=true"</span>
</code></pre>
<h4 data-id="heading-17">4. 告警联动</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Scheduled(fixedRate = 60000)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">alertIfNeeded</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 读取 JFR 事件，异常时推送到告警平台</span>
}
</code></pre>
<h2 data-id="heading-18">总结</h2>
<p>JFR 不是什么新东西，但确实是「平时用不上，出事能救命」的工具。</p>
<p>Spring Boot 集成后，启用成本不高。生产环境按需开启，配合资源限制和轮转策略，遇到问题直接看录制文件，比猜日志高效得多。</p>
<p>几个建议：</p>
<ul>
<li>先记几个常用 JFR 事件名，用到再查文档</li>
<li>持续录制 + 7 天轮转，出问题有数据可查</li>
<li>配合 JMC 可视化，分析效率更高</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 状态管理终极对决：Pinia vs Vuex 谁才是你的最佳选择？]]></title>    <link>https://juejin.cn/post/7601175299012198415</link>    <guid>https://juejin.cn/post/7601175299012198415</guid>    <pubDate>2026-02-02T00:19:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601175299012198415" data-draft-id="7601374137412059171" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 状态管理终极对决：Pinia vs Vuex 谁才是你的最佳选择？"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-02-02T00:19:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 状态管理终极对决：Pinia vs Vuex 谁才是你的最佳选择？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T00:19:48.000Z" title="Mon Feb 02 2026 00:19:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vue 状态管理终极对决：Pinia vs Vuex 谁才是你的最佳选择？</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>在现代前端开发中，状态管理是构建复杂应用的核心挑战之一。对于 Vue.js 开发者来说，Vuex 长期以来是状态管理的默认选择，但随着 Vue 3 的推出和 Composition API 的引入，Pinia 作为新一代状态管理库迅速崛起。本文将深入对比 Pinia 和 Vuex，从设计哲学、API 设计、性能、开发体验等多个维度进行分析，帮助你做出更明智的技术选型。</p>
<hr/>
<h3 data-id="heading-2">1. Vuex：经典的状态管理解决方案</h3>
<h4 data-id="heading-3">1.1 Vuex 的设计哲学</h4>
<p>Vuex 是 Vue.js 官方推荐的状态管理库，其核心思想源自 Flux 架构。Vuex 通过集中式存储（Store）管理应用的所有组件的状态，并遵循严格的单向数据流原则。它的核心概念包括：</p>
<ul>
<li><strong>State</strong>：单一状态树，存储应用的所有状态。</li>
<li><strong>Getters</strong>：派生状态，类似于计算属性。</li>
<li><strong>Mutations</strong>：同步修改状态的唯一途径。</li>
<li><strong>Actions</strong>：处理异步操作并提交 Mutations。</li>
</ul>
<h4 data-id="heading-4">1.2 Vuex 的优势</h4>
<ul>
<li><strong>官方背书</strong>：作为 Vue.js 的官方库，Vuex 拥有广泛的社区支持和成熟的生态系统。</li>
<li><strong>严格的数据流</strong>：强制使用 Mutations 修改状态，适合大型团队协作。</li>
<li><strong>插件系统</strong>：支持丰富的插件（如持久化、日志等）。</li>
</ul>
<h4 data-id="heading-5">1.3 Vuex 的局限性</h4>
<ul>
<li><strong>模板代码多</strong>：定义 State、Mutations、Actions 需要大量样板代码。</li>
<li><strong>TypeScript 支持有限</strong>：尽管 Vuex 4 改进了 TypeScript 支持，但仍不如 Pinia 直观。</li>
<li><strong>Composition API 适配问题</strong>：Vuex 最初是为 Options API设计的，与 Composition API结合时略显笨重。</li>
</ul>
<hr/>
<h3 data-id="heading-6">2. Pinia：轻量级且现代化的替代方案</h3>
<h4 data-id="heading-7">2.1 Pinia的设计哲学</h4>
<p>Pinia是 Vue.js核心团队成员开发的下一代状态管理库，专为 Vue3和Composition API优化。它的核心理念是简化状态管理流程，同时保持灵活性和类型安全。Pinia的主要特点包括：</p>
<ul>
<li><strong>无Mutations</strong>：直接通过 Actions修改状态（支持同步和异步）。</li>
<li><strong>模块化设计</strong>：每个 Store都是独立的模块，无需嵌套模块化配置。</li>
<li><strong>TypeScript优先</strong>：提供完整的类型推断和类型安全支持。</li>
</ul>
<p>####2.2 Pinia的优势</p>
<ul>
<li><strong>更简洁的API</strong>：减少样板代码（如无需 Mutations），开发效率更高。</li>
<li><strong>优秀的 TypeScript支持</strong>：类型推断开箱即用，适合大型项目。</li>
<li><strong>Composition API友好</strong>：天然适配 setup语法和响应式编程模型。</li>
<li><strong>轻量级</strong> ：体积更小（约1KB），性能更优。</li>
</ul>
<p>####2.3 Pinia的局限性</p>
<ul>
<li><strong>生态相对年轻</strong>:虽然增长迅速,但插件和工具链不如Vuex丰富。</li>
<li>迁移成本:现有Vuex项目需重构才能切换到Pinia。</li>
</ul>
<hr/>
<p>###3.深度对比:Pinia vs Vuex</p>
<p>####3.1 API设计与开发体验</p>
<ul>
<li>代码量对比:
<ul>
<li>Vuex需要定义State,Mutations,Actions,Getters四个部分。</li>
<li>Pinia只需定义State和Actions(或Getters)。</li>
</ul>
</li>
<li>类型安全:
<ul>
<li>Pinia的类型推断更自然,无需额外配置。</li>
<li>Vuex需要手动声明类型或使用辅助工具。</li>
</ul>
</li>
</ul>
<p>示例对比:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Vuex</span>
<span class="hljs-keyword">const</span> store = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vuex</span>.<span class="hljs-title class_">Store</span>({
 <span class="hljs-attr">state</span>: { <span class="hljs-attr">count</span>:<span class="hljs-number">0</span> },
 <span class="hljs-attr">mutations</span>:{ <span class="hljs-title function_">increment</span>(<span class="hljs-params">state</span>){state.<span class="hljs-property">count</span>++} },
 <span class="hljs-attr">actions</span>:{ <span class="hljs-title function_">incrementAsync</span>(<span class="hljs-params">{commit}</span>){<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span><span class="hljs-title function_">commit</span>(<span class="hljs-string">'increment'</span>),<span class="hljs-number">1000</span>)} }
})

<span class="hljs-comment">// Pinia</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore=<span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>,{
 <span class="hljs-attr">state</span>:<span class="hljs-function">()=&gt;</span>({<span class="hljs-attr">count</span>:<span class="hljs-number">0</span>}),
 <span class="hljs-attr">actions</span>:{
 <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>){<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++},
 <span class="hljs-keyword">async</span> <span class="hljs-title function_">incrementAsync</span>(<span class="hljs-params"/>){<span class="hljs-built_in">setTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">increment</span>,<span class="hljs-number">1000</span>)}
 }
})
</code></pre>
<p>####3.2性能与体积</p>
<ul>
<li>Bundle大小:
<ul>
<li>Pinia约1KB(vsVuex的4KB+)</li>
</ul>
</li>
<li>运行时性能:
-两者差异不大,但Pinia的轻量设计可能在小幅场景中略优。</li>
</ul>
<p>####3.3可扩展性</p>
<ul>
<li>插件系统:</li>
<li>Vuex有更成熟的插件生态(如vuex-persistedstate)。</li>
<li>Pinia可通过拦截器实现类似功能。</li>
<li>SSR支持:
两者均提供良好SSR支持,但Pinia的设计更现代化。</li>
</ul>
<p>####3.4学习曲线与团队适配</p>
<ul>
<li>新手友好度:</li>
<li>Pinia的学习成本更低(概念更少)。</li>
<li>团队协作:
-Vuex的严格流程适合大型团队规范。
-Pinia的灵活性可能需额外约定。</li>
</ul>
<hr/>
<p>###4.何时选择Vuex或Pinia?</p>
<p>####4.1选择VueX的场景
-维护遗留Vue2项目
-需要成熟插件生态(如复杂持久化需求)
-团队已深度适应Flux模式</p>
<p>####4.2选择PinIa的场景
–新启Vue3项目
–TypeScript重度用户
–追求开发效率和简洁性
–CompositionAPI技术栈</p>
<hr/>
<p>###5.VueX的未来与迁移策略</p>
<p>值得注意的是,Vue官方已将PiniA作为推荐的状态管理库,VueX目前处于维护模式这意味着:</p>
<p>1长期来看,PiniA会成为主流选择
2现有VUEX项目无需立即迁移
3迁移路径:
–小型项目可逐步替换模块
–大型项目可共存过渡</p>
<p>官方提供了迁移指南和互操作API(如useStorefromvueX)。</p>
<hr/>
<p>###6总结</p>
<p>技术选型的核心是匹配项目需求:</p>
<p>–如果你需要稳定性和成熟方案,VUEX仍是可靠选择
–如果你追求现代化开发和TS体验,PiniA明显胜出</p>
<p>个人观点:PiniA代表了未来方向,其简洁性和开发体验的提升是不可逆的趋势建议新项目优先考虑PiniA而老项目可按需渐进迁移最终,VUE生态的这种迭代正是其健康发展的体现——在保留核心思想的同时持续进化</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[线程如何停止？线程之间如何协作？线程之间的异常如何处理？]]></title>    <link>https://juejin.cn/post/7601441797118640179</link>    <guid>https://juejin.cn/post/7601441797118640179</guid>    <pubDate>2026-02-02T00:35:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601441797118640179" data-draft-id="7601020578490269705" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 线程如何停止？线程之间如何协作？线程之间的异常如何处理？"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-02-02T00:35:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             线程如何停止？线程之间如何协作？线程之间的异常如何处理？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T00:35:10.000Z" title="Mon Feb 02 2026 00:35:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">线程停止</h2>
<h3 data-id="heading-1">stop方法</h3>
<p>stop 方法虽然可以停止线程，但它已经是不建议使用的废弃方法了，这一点可以通过 Thread 类中的源码发现，stop 源码如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7eab53a7a56d40118b0ca4567f0a83b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597310&amp;x-signature=TBnNA8tC3gA703jjcGch2n5vMVI%3D" alt="" loading="lazy"/></p>
<p>stop 方法是被 @Deprecated 修饰的不建议使用的过期方法，并且在注释的第一句话就说明了 stop 方法为非安全的方法。</p>
<p>原因在于它在终止一个线程时会强制中断线程的执行，不管run方法是否执行完了，并且还会释放这个线程所持有的所有的锁对象。这一现象会被其它因为请求锁而阻塞的线程看到，使他们继续向下执行。这就会造成数据的不一致。</p>
<p>比如银行转账，从A账户向B账户转账500元，这一过程分为三步，第一步是从A账户中减去500元，假如到这时线程就被stop了，那么这个线程就会释放它所取得锁，然后其他的线程继续执行，这样A账户就莫名其妙的少了500元而B账户也没有收到钱。这就是stop方法的不安全性。</p>
<h3 data-id="heading-2">设置标志位</h3>
<p>如果线程的run方法中执行的是一个重复执行的循环，可以提供一个标记来控制循环是否继续</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FlagThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> {
    <span class="hljs-comment">// 自定义中断标识符</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isInterrupt</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 如果为 true -&gt; 中断执行</span>
        <span class="hljs-keyword">while</span> (!isInterrupt) {
            <span class="hljs-comment">// 业务逻辑处理</span>
        }
    }
}
</code></pre>
<p>但自定义中断标识符的问题在于：线程中断的不够及时。因为线程在执行过程中，无法调用 while(!isInterrupt) 来判断线程是否为终止状态，它只能在下一轮运行时判断是否要终止当前线程，所以它中断线程不够及时，比如以下代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">InterruptFlag</span> {
    <span class="hljs-comment">// 自定义的中断标识符</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isInterrupt</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-comment">// 创建可中断的线程实例</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">while</span> (!isInterrupt) { <span class="hljs-comment">// 如果 isInterrupt=true 则停止线程</span>
                System.out.println(<span class="hljs-string">"thread 执行步骤1：线程即将进入休眠状态"</span>);
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 休眠 1s</span>
                    Thread.sleep(<span class="hljs-number">1000</span>);
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(<span class="hljs-string">"thread 执行步骤2：线程执行了任务"</span>);
            }
        });
        thread.start(); <span class="hljs-comment">// 启动线程</span>

        <span class="hljs-comment">// 休眠 100ms，等待 thread 线程运行起来</span>
        Thread.sleep(<span class="hljs-number">100</span>);
        System.out.println(<span class="hljs-string">"主线程：试图终止线程 thread"</span>);
        <span class="hljs-comment">// 修改中断标识符，中断线程</span>
        isInterrupt = <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<p>输出：我们期望的是：线程执行了步骤 1 之后，收到中断线程的指令，然后就不要再执行步骤 2 了，但从上述执行结果可以看出，使用自定义中断标识符是没办法实现我们预期的结果的，这就是自定义中断标识符，响应不够及时的问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0960d27c52b949baa7bc455227bad000~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597310&amp;x-signature=yvQ%2FLga7fwZ8XhFJs%2FD9CKT8yWI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">interrupted中断</h3>
<p>这种方式需要在while循环中判断使用</p>
<p>使用 interrupt 方法可以给执行任务的线程，发送一个中断线程的指令，它并不直接中断线程，而是发送一个中断线程的信号，把是否正在中断线程的主动权交给代码编写者。相比于自定义中断标识符而然，它能更及时的接收到中断指令，如下代码所示：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
    <span class="hljs-comment">// 创建可中断的线程实例</span>
    <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
        <span class="hljs-keyword">while</span> (!Thread.currentThread().isInterrupted()) {
            System.out.println(<span class="hljs-string">"thread 执行步骤1：线程即将进入休眠状态"</span>);
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 休眠 1s</span>
                Thread.sleep(<span class="hljs-number">1000</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                System.out.println(<span class="hljs-string">"thread 线程接收到中断指令，执行中断操作"</span>);
                <span class="hljs-comment">// 中断当前线程的任务执行</span>
                <span class="hljs-keyword">break</span>;
            }
            System.out.println(<span class="hljs-string">"thread 执行步骤2：线程执行了任务"</span>);
        }
    });
    thread.start(); <span class="hljs-comment">// 启动线程</span>

    <span class="hljs-comment">// 休眠 100ms，等待 thread 线程运行起来</span>
    Thread.sleep(<span class="hljs-number">100</span>);
    System.out.println(<span class="hljs-string">"主线程：试图终止线程 thread"</span>);
    <span class="hljs-comment">// 修改中断标识符，中断线程</span>
    thread.interrupt();
}
</code></pre>
<p>输出：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6290745792d48c4886af5b7b93709b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597310&amp;x-signature=xRmZIKc4%2FJKCPuA%2BHcGo8ms99rM%3D" alt="" loading="lazy"/></p>
<p>从上述结果可以看出，线程在接收到中断指令之后，立即中断了线程，相比于上一种自定义中断标识符的方法来说，它能更及时的响应中断线程指令。</p>
<h3 data-id="heading-4">利用interruptedException</h3>
<p>这种方式 不 需要在while循环中判断使用</p>
<p>如果线程因为执行join()，sleep或者wait()而进入阻塞状态，此时想要停止它，可以调用interrupt()，程序会抛出interruptedException异常。可以利用这个异常终止线程</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
    System.out.println(<span class="hljs-built_in">this</span>.getName() + <span class="hljs-string">"start"</span>);
    <span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;
    <span class="hljs-comment">//while (!Thread.interrupted()){</span>
    <span class="hljs-keyword">while</span> (!Thread.currentThread().isInterrupted()){
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">10000</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            <span class="hljs-comment">//e.printStackTrace();</span>
            System.out.println(<span class="hljs-string">"中断线程"</span>);
            <span class="hljs-keyword">break</span>;<span class="hljs-comment">//通过识别到异常来中断</span>
        }
        System.out.println(<span class="hljs-built_in">this</span>.getName() + <span class="hljs-string">" "</span>+ i);
        i++;
    }
    System.out.println(<span class="hljs-built_in">this</span>.getName() + <span class="hljs-string">"end"</span>);
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa6b19e12fe84ca9b0a1c8d20a5def29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597310&amp;x-signature=AE0fP38nHP93VwxOnqOXfeTmHYs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">Executor 的中断操作</h3>
<p>调用 Executor 的 shutdown() 方法会等待线程都执行完毕之后再关闭，但是如果调用的是 shutdownNow() 方法，则相当于调用每个线程的 interrupt() 方法。</p>
<p>以下使用 Lambda 创建线程，相当于创建了一个匿名内部线程。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();
    executorService.execute(() -&gt; {
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">2000</span>);
            System.out.println(<span class="hljs-string">"Thread run"</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
    });
    executorService.shutdownNow();
    System.out.println(<span class="hljs-string">"Main run"</span>);
}
</code></pre>
<pre><code class="hljs language-java" lang="java">Main run
java.lang.InterruptedException: sleep interrupted
    at java.lang.Thread.sleep(Native Method)
    at ExecutorInterruptExample.lambda$main$<span class="hljs-number">0</span>(ExecutorInterruptExample.java:<span class="hljs-number">9</span>)
    at ExecutorInterruptExample$$Lambda$<span class="hljs-number">1</span>/<span class="hljs-number">1160460865.</span>run(Unknown Source)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="hljs-number">1142</span>)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="hljs-number">617</span>)
    at java.lang.Thread.run(Thread.java:<span class="hljs-number">745</span>)
</code></pre>
<p>如果只想中断 Executor 中的一个线程，可以通过使用 submit() 方法来提交一个线程，它会返回一个 <code>Future&lt;?&gt;</code> 对象，通过调用该对象的 cancel(true) 方法就可以中断线程。</p>
<pre><code class="hljs language-java" lang="java">Future&lt;?&gt; future = executorService.submit(() -&gt; {
    <span class="hljs-comment">// ..</span>
});
future.cancel(<span class="hljs-literal">true</span>);
</code></pre>
<h2 data-id="heading-6">线程之间的协作</h2>
<p>当多个线程可以一起工作去解决某个问题时，如果某些部分必须在其它部分之前完成，那么就需要对线程进行协调。</p>
<h3 data-id="heading-7">join()</h3>
<h4 data-id="heading-8">案例</h4>
<p>在线程中调用另一个线程的 join() 方法，会将当前线程挂起，而不是忙等待，直到目标线程结束。</p>
<p>对于以下代码，虽然 b 线程先启动，但是因为在 b 线程中调用了 a 线程的 join() 方法，b 线程会等待 a 线程结束才继续执行，因此最后能够保证 a 线程的输出先于 b 线程的输出。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JoinExample</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"A"</span>);
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> {

        <span class="hljs-keyword">private</span> A a;

        B(A a) {
            <span class="hljs-built_in">this</span>.a = a;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">try</span> {
                a.join();
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println(<span class="hljs-string">"B"</span>);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> {
        <span class="hljs-type">A</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">A</span>();
        <span class="hljs-type">B</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">B</span>(a);
        b.start();
        a.start();
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-type">JoinExample</span> <span class="hljs-variable">example</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JoinExample</span>();
    example.test();
}
</code></pre>
<pre><code class="hljs language-java" lang="java">A
B
</code></pre>
<h4 data-id="heading-9">原理</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8be012fe0bc444b7bbbc7bad0c14275e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597310&amp;x-signature=VdfEf%2F7gmvXzAIufUnChpUN3zOA%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">join</span><span class="hljs-params">(<span class="hljs-type">long</span> millis)</span>
<span class="hljs-keyword">throws</span> InterruptedException {
    <span class="hljs-type">long</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
    <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

    <span class="hljs-keyword">if</span> (millis &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"timeout value is negative"</span>);
    }

    <span class="hljs-keyword">if</span> (millis == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">while</span> (isAlive()) {<span class="hljs-comment">//检查线程是否存活，只要线程还没结束，主线程就会一直阻塞</span>
            wait(<span class="hljs-number">0</span>);<span class="hljs-comment">//这里的wait调用的本地方法。</span>
        }
    } <span class="hljs-keyword">else</span> {<span class="hljs-comment">//等待一段指定的时间</span>
        <span class="hljs-keyword">while</span> (isAlive()) {
            <span class="hljs-type">long</span> <span class="hljs-variable">delay</span> <span class="hljs-operator">=</span> millis - now;
            <span class="hljs-keyword">if</span> (delay &lt;= <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">break</span>;
            }
            wait(delay);
            now = System.currentTimeMillis() - base;
        }
    }
}
</code></pre>
<p>从源码来看，实际上join方法就是调用了wait方法来使得线程阻塞，一直到线程结束运行。注意到，join方法前的synchronized修饰符，它相当于：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">join</span><span class="hljs-params">(<span class="hljs-type">long</span> millis)</span>{
 <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>){
        <span class="hljs-comment">//代码块</span>
    }
}
</code></pre>
<p>也就是说加锁的对象即调用这个锁的线程对象，在main()方法中即为t1，持有这个锁的是主线程即main()方法，也就是说代码相当于如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//t1.join()前的代码</span>
<span class="hljs-keyword">synchronized</span> (t1) {
 <span class="hljs-comment">// 调用者线程进入 t1 的 waitSet 等待, 直到 t1 运行结束</span>
 <span class="hljs-keyword">while</span> (t1.isAlive()) {
  t1.wait(<span class="hljs-number">0</span>);
 }
}
<span class="hljs-comment">//t1.join()后的代码</span>
</code></pre>
<p>也因此主线程进入等待队列，直到 t1 线程结束。</p>
<blockquote>
<p>这里可能会有很多人会有疑惑，为什么t1.wait了，阻塞的不是t1，而是主线程？</p>
<p>实际上，如果要阻塞t1，那么就应该在t1的run 方法里进行阻塞，如在run方法里写wait()；（当然还有suspend方法，这属于非Java层面，另说）</p>
<p>而这里的 wait 方法被调用以后，是让持有锁的线程进入等待队列，即主线程调用，因此 t1 线程并不会被阻塞，阻塞的是主线程。</p>
</blockquote>
<p>也就是说，join方法是一个同步方法，当主线程调用t1.join()方法时，主线程先获得了t1对象的锁，随后进入方法，调用了t1对象的wait()方法，使主线程进入了t1对象的等待池。</p>
<p>那么问题在于，这里只看到了wait方法，却并没有看到notify或者是notifyAll方法，那么主线程在那里被唤醒呢？</p>
<p>这里参考jvm的代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ensure_join</span><span class="hljs-params">(JavaThread* thread)</span> {

 Handle <span class="hljs-title function_">threadObj</span><span class="hljs-params">(thread, thread-&gt;threadObj()</span>);

 ObjectLocker <span class="hljs-title function_">lock</span><span class="hljs-params">(threadObj, thread)</span>;

 hread-&gt;clear_pending_exception();

 <span class="hljs-comment">//这一句中的TERMINATED表示这是线程结束以后运行的</span>
 java_lang_Thread::set_thread_status(threadObj(), java_lang_Thread::TERMINATED);

    <span class="hljs-comment">//这里会清楚native线程，isAlive()方法会返回false</span>
    java_lang_Thread::set_thread(threadObj(), NULL);

 <span class="hljs-comment">//thread就是当前线程，调用这个方法唤醒等待的线程。</span>
 lock.notify_all(thread);

 hread-&gt;clear_pending_exception();

}
</code></pre>
<p>其实是jvm虚拟机中存在方法lock.notify_all(thread)，在t1线程结束以后，会调用该方法，最后唤醒主线程。</p>
<p>所以简化一下，流程即：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d33c8228ee7448aa71f3cbcf4a13f7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597310&amp;x-signature=zZROaLA9jgb50JCC3aAYgDdbJ%2FI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">wait() notify() notifyAll()</h3>
<p>调用 wait() 使得线程等待某个条件满足，线程在等待时会被挂起，当其他线程的运行使得这个条件满足时，其它线程会调用 notify() 或者 notifyAll() 来唤醒挂起的线程。</p>
<p>它们都属于 Object 的一部分，而不属于 Thread。</p>
<p>只能用在同步方法synchronized或者同步控制块中使用，否则会在运行时抛出 IllegalMonitorStateExeception。</p>
<p>使用 wait() 挂起期间，线程会释放锁。这是因为，如果没有释放锁，那么其它线程就无法进入对象的同步方法或者同步控制块中，那么就无法执行 notify() 或者 notifyAll() 来唤醒挂起的线程，造成死锁。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WaitNotifyExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"before"</span>);
        notifyAll();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">after</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            wait();
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(<span class="hljs-string">"after"</span>);
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();
    <span class="hljs-type">WaitNotifyExample</span> <span class="hljs-variable">example</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WaitNotifyExample</span>();
    executorService.execute(() -&gt; example.after());
    executorService.execute(() -&gt; example.before());
}
</code></pre>
<pre><code class="hljs language-java" lang="java">before
after
</code></pre>
<p><strong>wait() 和 sleep() 的区别</strong></p>
<ul>
<li>
<p>wait() 是 Object 的方法，而 sleep() 是 Thread 的静态方法；</p>
</li>
<li>
<p>wait() 会释放锁，sleep() 不会。</p>
</li>
</ul>
<h3 data-id="heading-11">await() signal() signalAll()</h3>
<p>java.util.concurrent 类库中提供了 Condition 类来实现线程之间的协调，可以在 Condition 上调用 await() 方法使线程等待，其它线程调用 signal() 或 signalAll() 方法唤醒等待的线程。相比于 wait() 这种等待方式，await() 可以指定等待的条件，因此更加灵活。</p>
<p>使用 Lock 来获取一个 Condition 对象。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AwaitSignalExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">condition</span> <span class="hljs-operator">=</span> lock.newCondition();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">()</span> {
        lock.lock();
        <span class="hljs-keyword">try</span> {
            System.out.println(<span class="hljs-string">"before"</span>);
            condition.signalAll();
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">after</span><span class="hljs-params">()</span> {
        lock.lock();
        <span class="hljs-keyword">try</span> {
            condition.await();
            System.out.println(<span class="hljs-string">"after"</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();
    <span class="hljs-type">AwaitSignalExample</span> <span class="hljs-variable">example</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AwaitSignalExample</span>();
    executorService.execute(() -&gt; example.after());
    executorService.execute(() -&gt; example.before());
}
</code></pre>
<pre><code class="hljs language-java" lang="java">before
after
</code></pre>
<h2 data-id="heading-12">线程中的异常处理</h2>
<h3 data-id="heading-13">Runnable中异常如何被吞掉</h3>
<p><code>Runnable</code> 接口的 <code>run()</code> 方法不允许抛出任何被检查的异常（checked exceptions），只能处理或抛出运行时异常（unchecked exceptions）。当在 <code>run()</code> 方法内发生异常时，如果没有显式地捕获和处理这些异常，它们通常会在执行该 <code>Runnable</code> 的线程中被“吞掉”，即异常会导致线程终止，但不会影响其他线程的执行。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uncaughtException</span><span class="hljs-params">(Thread t, Throwable e)</span> {
   <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) {
        parent.uncaughtException(t, e);
   } <span class="hljs-keyword">else</span> {
        Thread.<span class="hljs-type">UncaughtExceptionHandler</span> <span class="hljs-variable">ueh</span> <span class="hljs-operator">=</span>
            Thread.getDefaultUncaughtExceptionHandler();
        <span class="hljs-keyword">if</span> (ueh != <span class="hljs-literal">null</span>) {
            ueh.uncaughtException(t, e);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!(e <span class="hljs-keyword">instanceof</span> ThreadDeath)) {
            System.err.print(<span class="hljs-string">"Exception in thread \""</span>
                             + t.getName() + <span class="hljs-string">"\" "</span>);
            e.printStackTrace(System.err);
        }
    }
}
</code></pre>
<p>解决方案：</p>
<ol>
<li>
<p>在run方法中显示的捕获异常</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 可能抛出异常的代码</span>
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-comment">// 记录日志或处理异常</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
    }
}
</code></pre>
</li>
<li>
<p>为创建的线程设置一个<code>UncaughtExceptionHandler</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
   <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;
}, <span class="hljs-string">"t1"</span>);
t.setUncaughtExceptionHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>.UncaughtExceptionHandler() {
   <span class="hljs-meta">@Override</span>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uncaughtException</span><span class="hljs-params">(Thread t, Throwable e)</span> {
        logger.error(<span class="hljs-string">'---'</span>, e);
   }
});
</code></pre>
</li>
<li>
<p>使用<code>Callable</code>代替<code>Runnable</code>，<code>Callable</code>的<code>call</code>方法允许抛出异常，然后可以通过提交给<code>ExecutorService</code>返回的<code>Future</code>来捕获和处理这些异常</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">1</span>);
Future&lt;?&gt; future = executor.submit(() -&gt; {
    <span class="hljs-comment">// 可能抛出异常的代码</span>
});

<span class="hljs-keyword">try</span> {
    future.get(); <span class="hljs-comment">// 这里会捕获到Callable中的异常</span>
} <span class="hljs-keyword">catch</span> (ExecutionException e) {
    <span class="hljs-type">Throwable</span> <span class="hljs-variable">cause</span> <span class="hljs-operator">=</span> e.getCause(); <span class="hljs-comment">// 获取原始异常</span>
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-14">Callable中异常如何被吞掉</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCallable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Callable</span>&lt;String&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"===&gt; 开始执行callable"</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>; <span class="hljs-comment">//异常的地方</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"callable的结果"</span>;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CallableAndRunnableTest</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">" =========&gt; main start "</span>);
        <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">threadPoolExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, TimeUnit.SECONDS, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>));
        Future&lt;String&gt; submit = threadPoolExecutor.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyCallable</span>());
        <span class="hljs-keyword">try</span> {
            TimeUnit.SECONDS.sleep(<span class="hljs-number">2</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(<span class="hljs-string">" =========&gt; main end "</span>);
    }
}
</code></pre>
<p>运行结果</p>
<pre><code class="hljs language-java" lang="java"> =========&gt; main start 
 ===&gt; 开始执行callable
 =========&gt; main end 
</code></pre>
<p>源码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> &lt;T&gt; Future&lt;T&gt; <span class="hljs-title function_">submit</span><span class="hljs-params">(Callable&lt;T&gt; task)</span> {
    <span class="hljs-keyword">if</span> (task == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();
    RunnableFuture&lt;T&gt; ftask = newTaskFor(task);
    execute(ftask);
    <span class="hljs-keyword">return</span> ftask;
}

<span class="hljs-keyword">protected</span> &lt;T&gt; RunnableFuture&lt;T&gt; <span class="hljs-title function_">newTaskFor</span><span class="hljs-params">(Callable&lt;T&gt; callable)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FutureTask</span>&lt;T&gt;(callable);
}
</code></pre>
<p><code>RunableFuture&lt;T&gt;</code> 是个接口，但是它继承了Runnable 接口 ， 实现类是 FutureTask ，因此就需要看下 FutureTask里的run方法 是不是和 构造时的Callable 有关系：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
     <span class="hljs-comment">// 状态不属于初始状态的情况下，不进行后续逻辑处理</span>
     <span class="hljs-comment">// 那也就是run 方法只能执行一次</span>
     <span class="hljs-keyword">if</span> (state != NEW ||
        !UNSAFE.compareAndSwapObject(<span class="hljs-built_in">this</span>, runnerOffset,
                                   <span class="hljs-literal">null</span>, Thread.currentThread()))
        <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">try</span> { 
        Callable&lt;V&gt; c = callable;
        <span class="hljs-keyword">if</span> (c != <span class="hljs-literal">null</span> &amp;&amp; state == NEW) {
            V result;
            <span class="hljs-comment">// </span>
            <span class="hljs-type">boolean</span> ran;
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 执行 Callable 里的 call 方法 ，将结果存入result变量中</span>
                result = c.call();
                ran = <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">catch</span> (Throwable ex) {
                result = <span class="hljs-literal">null</span>;
                ran = <span class="hljs-literal">false</span>;
                 <span class="hljs-comment">// call 方法异常 ， 记录下异常结果</span>
                setException(ex);
            }
            <span class="hljs-comment">// call 方法正常执行完毕 ，进行结果存储</span>
            <span class="hljs-keyword">if</span> (ran)
                set(result);
        }
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// runner must be non-null until state is settled to</span>
        <span class="hljs-comment">// prevent concurrent calls to run()</span>
        runner = <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// state must be re-read after nulling runner to prevent</span>
        <span class="hljs-comment">// leaked interrupts</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> state;
        <span class="hljs-keyword">if</span> (s &gt;= INTERRUPTING)
            handlePossibleCancellationInterrupt(s);
    }
}
</code></pre>
<p>接下来就要看，如果存储正常结果的<code>set(result)</code>方法 和存储异常结果的 <code>setException(ex)</code> 方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setException</span><span class="hljs-params">(Throwable t)</span> {
    <span class="hljs-keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="hljs-built_in">this</span>, stateOffset, NEW, COMPLETING)) {
        outcome = t;
        UNSAFE.putOrderedInt(<span class="hljs-built_in">this</span>, stateOffset, EXCEPTIONAL); <span class="hljs-comment">// final state</span>
        finishCompletion();
    }
}

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(V v)</span> {
    <span class="hljs-keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="hljs-built_in">this</span>, stateOffset, NEW, COMPLETING)) {
        outcome = v;
        UNSAFE.putOrderedInt(<span class="hljs-built_in">this</span>, stateOffset, NORMAL); <span class="hljs-comment">// final state</span>
        finishCompletion();
    }
}
</code></pre>
<p>这两个代码都做了一个操作，就是将正常结果<code>result</code> 和 异常结果 <code>exception</code> 都赋值给了 <code>outcome</code> 这个变量 。</p>
<p>接着再看下future的get方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//这里有必须看下Task的结束时的状态，如果正常结束，状态为 NORMAL ， 异常结果，状态为EXCEPTIONAL 。 看下几个状态的定义，如下：  </span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> state;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">NEW</span>          <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">COMPLETING</span>   <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">NORMAL</span>       <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">EXCEPTIONAL</span>  <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CANCELLED</span>    <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">INTERRUPTING</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">INTERRUPTED</span>  <span class="hljs-operator">=</span> <span class="hljs-number">6</span>;

<span class="hljs-comment">/**
* <span class="hljs-doctag">@throws</span> CancellationException {<span class="hljs-doctag">@inheritDoc</span>}
*/</span>
<span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException {
    <span class="hljs-type">int</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> state;
    <span class="hljs-comment">// NORMAL(2) 、EXCEPTIONAL(3) 都大于 COMPLETING（1）,所以Task结束之后，不会走该if</span>
    <span class="hljs-keyword">if</span> (s &lt;= COMPLETING)
         s = awaitDone(<span class="hljs-literal">false</span>, <span class="hljs-number">0L</span>);
    <span class="hljs-comment">// 重点： 返回结果</span>
    <span class="hljs-keyword">return</span> report(s);
}

<span class="hljs-keyword">private</span> V <span class="hljs-title function_">report</span><span class="hljs-params">(<span class="hljs-type">int</span> s)</span> <span class="hljs-keyword">throws</span> ExecutionException {
    <span class="hljs-comment">// 之前正常结果或者异常都存放在Object outcomme 中了</span>
    <span class="hljs-type">Object</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> outcome;
    <span class="hljs-comment">// 正常返回</span>
    <span class="hljs-keyword">if</span> (s == NORMAL)
        <span class="hljs-keyword">return</span> (V)x;
    <span class="hljs-comment">// EXCEPTIONAL(3) 小于 CANCELLED(4) ，所以不会走该if分支，直接后续的throw 抛异常的逻辑</span>
    <span class="hljs-keyword">if</span> (s &gt;= CANCELLED)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CancellationException</span>();
    <span class="hljs-comment">// 不等于NORMAL 且 大于等于 CANCELLED  ,  再结合 调用 report(int s ) 之前也做了state 的过滤</span>
    <span class="hljs-comment">//到这一步，那只能是EXCEPTIONAL(3) </span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutionException</span>((Throwable)x);
}
</code></pre>
<p>因此可以通过get方法获取到异常结果</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[性能优化之⽹络层⾯优化--让你的⽹站跑得⽐快递员还快]]></title>    <link>https://juejin.cn/post/7601606188618367014</link>    <guid>https://juejin.cn/post/7601606188618367014</guid>    <pubDate>2026-02-02T00:37:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601606188618367014" data-draft-id="7592622563546972195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="性能优化之⽹络层⾯优化--让你的⽹站跑得⽐快递员还快"/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2026-02-02T00:37:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="destinying"/> <meta itemprop="url" content="https://juejin.cn/user/896842287549703"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            性能优化之⽹络层⾯优化--让你的⽹站跑得⽐快递员还快
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/896842287549703/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    destinying
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T00:37:32.000Z" title="Mon Feb 02 2026 00:37:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">⽹络层⾯优化：让你的⽹站跑得⽐快递员还快</h2>
<blockquote>
<p>前言：本⽂纯属真实经历，如有雷同，纯属你也踩过坑。</p>
</blockquote>
<h3 data-id="heading-1">1. 浏览器缓存：别让⽤户重复下载你的"祖传代码"</h3>
<p>兄弟们，有没有遇到过这种情况？你明明已经优化过代码了，⽤户还是说"⽹站怎么还是那个样⼦？"然后你⼀脸懵逼地发现：浏览器缓存还在使⽤你上个月写的"屎⼭代码"。</p>
<p><strong>浏览器缓存就像是那个记性超好的前女友</strong>，你改了什么她都记得，但就是不愿意承认你已经变了。</p>
<h4 data-id="heading-2">1.1 LocalStorage ⼀把梭？快住手！</h4>
<p>很多同学喜欢把什么东西都往 LocalStorage ⾥塞，恨不得把整个项⽬都存进去。听我⼀句劝，LocalStorage 就像你的钱包，别什么都往⾥塞，否则哪天爆了就尴尬了。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误示范</span>
<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'整个项目'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(yourProject))

<span class="hljs-comment">// ✅ 正确姿势：封装一下，加上过期时间</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Storage</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">set</span>(<span class="hljs-params">key, value, expire = <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span></span>) {
    <span class="hljs-keyword">const</span> data = {
      value,
      <span class="hljs-attr">expire</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + expire
    }
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(key, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data))
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(key))
    <span class="hljs-keyword">if</span> (!data) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() &gt; data.<span class="hljs-property">expire</span>) {
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(key)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    }
    <span class="hljs-keyword">return</span> data.<span class="hljs-property">value</span>
  }
}

<span class="hljs-comment">// 使用起来更优雅</span>
<span class="hljs-title class_">Storage</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'userInfo'</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">18</span> })
<span class="hljs-keyword">const</span> user = <span class="hljs-title class_">Storage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'userInfo'</span>)
</code></pre>
<h4 data-id="heading-3">1.2 SessionStorage 是"露⽔情缘"</h4>
<p>关掉标签页就拜拜，不多废话。适合存那些"⽤完即弃"的数据，⽐如表单暂存。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 表单暂存示例，防止用户误操作丢失数据</span>
<span class="hljs-keyword">const</span> form = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#myForm'</span>)

<span class="hljs-comment">// 输入时自动保存</span>
form.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>(form)
  sessionStorage.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'formData'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(formData)))
})

<span class="hljs-comment">// 页面加载时恢复</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> saved = sessionStorage.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'formData'</span>)
  <span class="hljs-keyword">if</span> (saved) {
    <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(saved)
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
      form.<span class="hljs-property">elements</span>[key].<span class="hljs-property">value</span> = data[key]
    })
  }
})

<span class="hljs-comment">// 提交后清除</span>
form.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'submit'</span>, <span class="hljs-function">() =&gt;</span> {
  sessionStorage.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'formData'</span>)
})
</code></pre>
<h4 data-id="heading-4">1.3 IndexedDB？那是真的猛</h4>
<p>当你需要存点⼤东西的时候，⽐如离线缓存、图片啥的，IndexedDB 才是你的菜。虽然 API 设计得像迷宫，但好歹是个迷宫⾥有宝藏的那种。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ⼿写 IndexedDB 简直折磨，推荐⽤ idb 这个库</span>
<span class="hljs-keyword">import</span> { openDB } <span class="hljs-keyword">from</span> <span class="hljs-string">'idb'</span>

<span class="hljs-comment">// 初始化数据库</span>
<span class="hljs-keyword">const</span> db = <span class="hljs-keyword">await</span> <span class="hljs-title function_">openDB</span>(<span class="hljs-string">'myDB'</span>, <span class="hljs-number">1</span>, {
  <span class="hljs-title function_">upgrade</span>(<span class="hljs-params">db</span>) {
    <span class="hljs-keyword">if</span> (!db.<span class="hljs-property">objectStoreNames</span>.<span class="hljs-title function_">contains</span>(<span class="hljs-string">'images'</span>)) {
      db.<span class="hljs-title function_">createObjectStore</span>(<span class="hljs-string">'images'</span>, { <span class="hljs-attr">keyPath</span>: <span class="hljs-string">'id'</span> })
    }
  }
})

<span class="hljs-comment">// 存储图片</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">saveImage</span>(<span class="hljs-params">id, blob</span>) {
  <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">put</span>(<span class="hljs-string">'images'</span>, { id, blob, <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() })
}

<span class="hljs-comment">// 读取图片</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getImage</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">get</span>(<span class="hljs-string">'images'</span>, id)
}
</code></pre>
<h4 data-id="heading-5">1.4 Cache API：PWA 的灵魂</h4>
<p>想做 PWA？Cache API 必须得会。它能让你在离线状态下也能访问⽹站，简直是⽹络开⼩差时的救命稻草。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// sw.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_NAME</span> = <span class="hljs-string">'my-cache-v1'</span>
<span class="hljs-keyword">const</span> urlsToCache = [
  <span class="hljs-string">'/'</span>,
  <span class="hljs-string">'/styles/main.css'</span>,
  <span class="hljs-string">'/scripts/main.js'</span>,
  <span class="hljs-string">'/images/logo.png'</span>
]

<span class="hljs-comment">// 安装时缓存静态资源</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'install'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  event.<span class="hljs-title function_">waitUntil</span>(
    caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_NAME</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">cache</span>) =&gt;</span> cache.<span class="hljs-title function_">addAll</span>(urlsToCache))
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> self.<span class="hljs-title function_">skipWaiting</span>())
  )
})

<span class="hljs-comment">// 拦截请求，优先从缓存读取</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  event.<span class="hljs-title function_">respondWith</span>(
    caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
        <span class="hljs-comment">// 缓存命中直接返回，否则⾛网络</span>
        <span class="hljs-keyword">return</span> response || <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
          <span class="hljs-comment">// 把新资源缓存起来</span>
          <span class="hljs-keyword">return</span> caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_NAME</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> {
            cache.<span class="hljs-title function_">put</span>(event.<span class="hljs-property">request</span>, response.<span class="hljs-title function_">clone</span>())
            <span class="hljs-keyword">return</span> response
          })
        })
      })
  )
})

<span class="hljs-comment">// 更新缓存</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'activate'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> cacheWhitelist = [<span class="hljs-variable constant_">CACHE_NAME</span>]
  event.<span class="hljs-title function_">waitUntil</span>(
    caches.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">cacheNames</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
        cacheNames.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">cacheName</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (cacheWhitelist.<span class="hljs-title function_">indexOf</span>(cacheName) === -<span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> caches.<span class="hljs-title function_">delete</span>(cacheName)
          }
        })
      )
    })
  )
})
</code></pre>
<h4 data-id="heading-6">1.5 小贴士</h4>
<ul>
<li>给缓存加点过期时间，别让⽤户的手机变成了你的"垃圾场"</li>
<li>敏感数据别存缓存，不然哪天被抓包了别怪我没提醒你</li>
<li>定期清理缓存，就像打扫房间⼀样重要</li>
</ul>
<h3 data-id="heading-7">2. 资源压缩：让体积缩⽔，让速度起飞</h3>
<p>说真的，资源压缩是最简单也最有效的优化手段。⽤好了，能减少 70%+ 的传输体积；⽤不好，⽤户加载时就像在等快递。</p>
<h4 data-id="heading-8">2.1 Gzip/Brotli 压缩</h4>
<p>这个主要是后端和运维配置的，但前端也要知道原理。Gzip 能压缩到原体积的 30-40%，Brotli 更强，能到 20-30%。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vite 开发环境也开启压缩</span>
<span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Encoding'</span>: <span class="hljs-string">'gzip'</span>
    }
  }
})
</code></pre>
<p><strong>告诉后端大佬：</strong></p>
<ul>
<li>HTML、CSS、JS、JSON 都要开启 Gzip/Brotli</li>
<li>图片、视频这类已经压缩过的文件就不用再压了</li>
<li>生产环境优先用 Brotli，兼容性用 Gzip</li>
</ul>
<h4 data-id="heading-9">2.2 代码压缩：Tree Shaking + 压缩工具</h4>
<p>现代构建工具（Vite、Webpack）都内置了这些功能，配置好就行。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>()],

  <span class="hljs-attr">build</span>: {
    <span class="hljs-comment">// 开启 CSS 代码分割</span>
    <span class="hljs-attr">cssCodeSplit</span>: <span class="hljs-literal">true</span>,

    <span class="hljs-comment">// 设置 chunk 大小警告阈值（kb）</span>
    <span class="hljs-attr">chunkSizeWarningLimit</span>: <span class="hljs-number">1000</span>,

    <span class="hljs-comment">// 压缩配置</span>
    <span class="hljs-attr">minify</span>: <span class="hljs-string">'terser'</span>,
    <span class="hljs-attr">terserOptions</span>: {
      <span class="hljs-attr">compress</span>: {
        <span class="hljs-attr">drop_console</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 生产环境去掉 console</span>
        <span class="hljs-attr">drop_debugger</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 生产环境去掉 debugger</span>
      }
    },

    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">output</span>: {
        <span class="hljs-comment">// 开启 Tree Shaking</span>
        <span class="hljs-attr">treeshake</span>: <span class="hljs-literal">true</span>
      }
    }
  }
})
</code></pre>
<h4 data-id="heading-10">2.3 图片压缩：体积减半，体验翻倍</h4>
<p>很多同学直接把设计师给的原图放上去，一张图好几 MB，⽤户加载要等半天。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite-plugin-imagemin：自动压缩图片</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> viteImagemin <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-imagemin'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">viteImagemin</span>({
      <span class="hljs-attr">gifsicle</span>: { <span class="hljs-attr">optimizationLevel</span>: <span class="hljs-number">7</span> },
      <span class="hljs-attr">optipng</span>: { <span class="hljs-attr">optimizationLevel</span>: <span class="hljs-number">7</span> },
      <span class="hljs-attr">mozjpeg</span>: { <span class="hljs-attr">quality</span>: <span class="hljs-number">80</span> },
      <span class="hljs-attr">pngquant</span>: { <span class="hljs-attr">quality</span>: [<span class="hljs-number">0.8</span>, <span class="hljs-number">0.9</span>] },
      <span class="hljs-attr">svgo</span>: {
        <span class="hljs-attr">plugins</span>: [
          { <span class="hljs-attr">name</span>: <span class="hljs-string">'removeViewBox'</span> },
          { <span class="hljs-attr">name</span>: <span class="hljs-string">'removeEmptyAttrs'</span> }
        ]
      }
    })
  ]
})
</code></pre>
<p><strong>更简单的方法：用在线工具</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftinypng.com%2F" target="_blank" title="https://tinypng.com/" ref="nofollow noopener noreferrer">TinyPNG</a>：免费，压缩效果好</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsquoosh.app%2F" target="_blank" title="https://squoosh.app/" ref="nofollow noopener noreferrer">Squoosh</a>：Google 出品，功能强大</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fimageoptim.com%2F" target="_blank" title="https://imageoptim.com/" ref="nofollow noopener noreferrer">ImageOptim</a>：Mac 专用，拖进去就行</li>
</ul>
<h4 data-id="heading-11">2.4 WebP 格式：新时代的图片格式</h4>
<p>WebP 比传统格式（JPG、PNG）小 25-35%，质量还更好。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 传统写法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"image.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"示例图片"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 优化写法：支持 WebP 用 WebP，不支持降级到 JPG --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">picture</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"image.webp"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/webp"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"image.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"示例图片"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">picture</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 自动转 WebP：vite-plugin-webp</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> webp <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-webp'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">webp</span>({
      <span class="hljs-attr">quality</span>: <span class="hljs-number">80</span>,
      <span class="hljs-attr">enablePlugin</span>: <span class="hljs-literal">true</span>
    })
  ]
})
</code></pre>
<h4 data-id="heading-12">2.5 雪碧图 vs SVG Sprite</h4>
<p>过去常用雪碧图，现在更推荐 SVG Sprite。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite-plugin-svg-icons</span>
<span class="hljs-keyword">import</span> { createSvgIconsPlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-svg-icons'</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">createSvgIconsPlugin</span>({
      <span class="hljs-attr">iconDirs</span>: [path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'src/assets/icons'</span>)],
      <span class="hljs-attr">symbolId</span>: <span class="hljs-string">'icon-[name]'</span>
    })
  ]
})
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 在组件中使用 --&gt;
&lt;svg&gt;
  &lt;use xlink:href="#icon-user" /&gt;
&lt;/svg&gt;
</code></pre>
<h4 data-id="heading-13">2.6 按需加载：只加载需要的</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 一次性加载所有组件</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span>, <span class="hljs-title class_">Input</span>, <span class="hljs-title class_">Select</span>, <span class="hljs-title class_">Table</span>, <span class="hljs-title class_">Form</span>, ... } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-ui'</span>

<span class="hljs-comment">// ✅ 按需加载</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-ui'</span>

<span class="hljs-comment">// 或者用动态导入</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Table</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">import</span>(<span class="hljs-string">'element-ui/lib/table'</span>)

<span class="hljs-comment">// Vue 路由懒加载</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Home</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/Home.vue'</span>)
<span class="hljs-keyword">const</span> <span class="hljs-title function_">About</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/About.vue'</span>)

<span class="hljs-keyword">const</span> routes = [
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">Home</span> },
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/about'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">About</span> }
]
</code></pre>
<h3 data-id="heading-14">3. DNS 缓存：让你的⽹址解析⽐点外卖还快</h3>
<p>DNS 解析就像是查电话本，你每次访问⽹站都要先查⼀下 IP 地址。但如果每次都要查，那就太慢了。</p>
<h4 data-id="heading-15">3.1 DNS 预取（DNS Prefetching）</h4>
<p>提前告诉浏览器"嘿，等下⼉可能要去这个域名，先把电话查好"。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 在 HTML head 中添加 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"dns-prefetch"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdn.example.com"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"dns-prefetch"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://api.example.com"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"dns-prefetch"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://static.example.com"</span>&gt;</span>
</code></pre>
<p><strong>使用场景：</strong></p>
<ul>
<li>CDN 域名</li>
<li>第三方 API 域名</li>
<li>统计分析域名（如 Google Analytics）</li>
<li>字体服务域名（如 Google Fonts）</li>
</ul>
<h4 data-id="heading-16">3.2 预连接（Preconnect）</h4>
<p>预连接比 DNS 预取更进一步，它不仅解析 DNS，还会建立 TCP 连接和 TLS 握手。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 适用于必定会使用的域名 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preconnect"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdn.example.com"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preconnect"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://api.example.com"</span>&gt;</span>
</code></pre>
<p><strong>注意：</strong> 不要滥用，每个预连接都会消耗资源。只用于必定会加载的域名。</p>
<h4 data-id="heading-17">3.3 域名收敛</h4>
<p>一个网站用太多域名会降低性能。HTTP/1.1 时代需要域名分片来突破浏览器并发限制，现在 HTTP/2 多路复用反而收敛更好。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 太多域名</span>
&lt;img src=<span class="hljs-string">"https://cdn1.example.com/a.jpg"</span>&gt;
&lt;img src="https://cdn2.example.com/b.jpg"&gt;
&lt;img src="https://cdn3.example.com/c.jpg"&gt;

// ✅ 收敛到 1-2 个域名
&lt;img src="https://cdn.example.com/a.jpg"&gt;
&lt;img src="https://cdn.example.com/b.jpg"&gt;
&lt;img src="https://cdn.example.com/c.jpg"&gt;
</code></pre>
<p><strong>实战经验：</strong></p>
<ul>
<li>静态资源用 1 个 CDN 域名</li>
<li>API 用 1 个域名</li>
<li>总共不超过 2-3 个域名</li>
</ul>
<h3 data-id="heading-18">4. CDN：让你的⽹站遍布全球</h3>
<p>CDN 是什么？简单说，就是把你的⽹站复制到世界各地，让⽤户访问最近的节点。</p>
<h4 data-id="heading-19">4.1 CDN 的好处</h4>
<ul>
<li><strong>速度提升</strong>：⽤户访问就近节点，延迟降低</li>
<li><strong>减轻服务器压力</strong>：流量分摊到各个节点</li>
<li><strong>提升可用性</strong>：某个节点挂了，其他节点还能⽤</li>
</ul>
<h4 data-id="heading-20">4.2 前端资源文件名 hash 策略</h4>
<p>这是前端使用 CDN 的关键！只有文件名带了 hash，才能放心设置长期缓存。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].[contenthash:8].js'</span>,
    <span class="hljs-attr">chunkFilename</span>: <span class="hljs-string">'[name].[contenthash:8].chunk.js'</span>
  },
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(png|jpg|gif)$/</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">'asset/resource'</span>,
        <span class="hljs-attr">generator</span>: {
          <span class="hljs-attr">filename</span>: <span class="hljs-string">'images/[name].[contenthash:8][ext]'</span>
        }
      }
    ]
  }
}
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">entryFileNames</span>: <span class="hljs-string">'assets/[name].[hash].js'</span>,
        <span class="hljs-attr">chunkFileNames</span>: <span class="hljs-string">'assets/[name].[hash].js'</span>,
        <span class="hljs-attr">assetFileNames</span>: <span class="hljs-string">'assets/[name].[hash].[ext]'</span>
      }
    }
  }
})
</code></pre>
<h4 data-id="heading-21">4.3 Cloudflare Workers 前端实战</h4>
<p>现在的 CDN 不止是存静态资源，还能在边缘节点运⾏代码。Cloudflare Workers 咱们前端可以自己写。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Cloudflare Workers 示例：边缘图片压缩</span>
<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  event.<span class="hljs-title function_">respondWith</span>(<span class="hljs-title function_">handleRequest</span>(event.<span class="hljs-property">request</span>))
})

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">request</span>) {
  <span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(request.<span class="hljs-property">url</span>)

  <span class="hljs-comment">// 检测是否是图片请求</span>
  <span class="hljs-keyword">if</span> (url.<span class="hljs-property">pathname</span>.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/\.(jpg|jpeg|png|webp)$/</span>)) {
    <span class="hljs-comment">// 检查 URL 参数</span>
    <span class="hljs-keyword">const</span> quality = <span class="hljs-built_in">parseInt</span>(url.<span class="hljs-property">searchParams</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'quality'</span>)) || <span class="hljs-number">80</span>
    <span class="hljs-keyword">const</span> format = url.<span class="hljs-property">searchParams</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'format'</span>) || <span class="hljs-string">'webp'</span>

    <span class="hljs-comment">// 从源站获取图片</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(request)

    <span class="hljs-comment">// 转换图片格式和压缩（使用 WebAssembly 实现的图片处理库）</span>
    <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">arrayBuffer</span>()
    <span class="hljs-keyword">const</span> compressed = <span class="hljs-keyword">await</span> <span class="hljs-title function_">compressImage</span>(image, { quality, format })

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(compressed, {
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">`image/<span class="hljs-subst">${format}</span>`</span>,
        <span class="hljs-string">'Cache-Control'</span>: <span class="hljs-string">'public, max-age=31536000'</span>
      }
    })
  }

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(request)
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">compressImage</span>(<span class="hljs-params">imageBuffer, options</span>) {
  <span class="hljs-comment">// 使用前端熟悉的库（如 sharp-wasm）</span>
  <span class="hljs-keyword">const</span> sharp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'sharp-wasm'</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">sharp</span>(imageBuffer)
    .<span class="hljs-title function_">webp</span>({ <span class="hljs-attr">quality</span>: options.<span class="hljs-property">quality</span> })
    .<span class="hljs-title function_">toBuffer</span>()
}
</code></pre>
<h4 data-id="heading-22">4.4 实战案例</h4>
<p>之前一个视频⽹站，⽤户遍布全球。没⽤ CDN 的时候，国外⽤户加载要 30 秒；⽤了 CDN 之后，⼤部分地区 3 秒内加载完成。这提升，⾹！</p>
<h4 data-id="heading-23">4.5 注意事项</h4>
<ul>
<li>CDN 节点的缓存要及时更新，不然你改了 bug ⽤户还是看旧版</li>
<li>HTTPS 证书要配好，CDN 和源站都要配</li>
<li>⽇志收集要考虑 CDN 的影响，不然统计数据会偏</li>
<li>告诉运维大佬：静态资源（带 hash 的）可以设置长期缓存，index.html 不要缓存</li>
</ul>
<h3 data-id="heading-24">5. 渲染层⾯优化：让页⾯流畅如丝</h3>
<p>网络层面的优化让资源加载更快，但渲染层面的优化让用户体验更好。</p>
<h4 data-id="heading-25">5.1 关键渲染路径优化</h4>
<p>浏览器渲染页面的流程：DOM → CSSOM → Render Tree → Layout → Paint</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 阻塞渲染的写法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"large.css"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"app.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span> <span class="hljs-comment">&lt;!-- 阻塞后续内容 --&gt;</span>

<span class="hljs-comment">&lt;!-- ✅ 优化写法 --&gt;</span>
<span class="hljs-comment">&lt;!-- 内联关键 CSS --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-comment">/* 首屏必需的样式 */</span>
  <span class="hljs-selector-class">.header</span> { <span class="hljs-attribute">height</span>: <span class="hljs-number">60px</span>; <span class="hljs-attribute">background</span>: <span class="hljs-number">#333</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 非关键样式异步加载 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preload"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"non-critical.css"</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"style"</span> <span class="hljs-attr">onload</span>=<span class="hljs-string">"this.onload=null;this.rel='stylesheet'"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">noscript</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"non-critical.css"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">noscript</span>&gt;</span>

<span class="hljs-comment">&lt;!-- JS 放到底部或异步加载 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"app.js"</span> <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"analytics.js"</span> <span class="hljs-attr">async</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-26">5.2 图片懒加载：只加载用户能看到的</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Intersection Observer API（现代浏览器支持）</span>
<span class="hljs-keyword">const</span> lazyImages = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'img.lazy'</span>)

<span class="hljs-keyword">const</span> imageObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries, observer</span>) =&gt;</span> {
  entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) {
      <span class="hljs-keyword">const</span> img = entry.<span class="hljs-property">target</span>
      img.<span class="hljs-property">src</span> = img.<span class="hljs-property">dataset</span>.<span class="hljs-property">src</span>
      img.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'lazy'</span>)
      observer.<span class="hljs-title function_">unobserve</span>(img)
    }
  })
})

lazyImages.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">img</span> =&gt;</span> imageObserver.<span class="hljs-title function_">observe</span>(img))
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- HTML 使用方式 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy"</span> <span class="hljs-attr">data-src</span>=<span class="hljs-string">"image.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"示例图片"</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Vue 懒加载组件 --&gt;
&lt;template&gt;
  &lt;img v-lazy="imageUrl" alt="示例图片"&gt;
&lt;/template&gt;

&lt;script&gt;
import { lazyLoad } from '@/directives/lazyLoad'

export default {
  directives: {
    lazy: lazyLoad
  },
  data() {
    return {
      imageUrl: 'https://example.com/image.jpg'
    }
  }
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-27">5.3 虚拟列表：长列表性能救星</h4>
<p>如果列表有几千条数据，全部渲染会让页面卡顿。虚拟列表只渲染可见区域的项目。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vue-virtual-scroller 示例</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RecycleScroller</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-virtual-scroller'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'vue-virtual-scroller/dist/vue-virtual-scroller.css'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: {
    <span class="hljs-title class_">RecycleScroller</span>
  },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">items</span>: <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">10000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({
        <span class="hljs-attr">id</span>: i,
        <span class="hljs-attr">text</span>: <span class="hljs-string">`Item <span class="hljs-subst">${i}</span>`</span>
      }))
    }
  }
}
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;RecycleScroller
    class="scroller"
    :items="items"
    :item-size="50"
    key-field="id"
  &gt;
    &lt;template #default="{ item }"&gt;
      &lt;div class="item"&gt;{{ item.text }}&lt;/div&gt;
    &lt;/template&gt;
  &lt;/RecycleScroller&gt;
&lt;/template&gt;

&lt;style&gt;
.scroller {
  height: 400px;
}

.item {
  height: 50px;
  line-height: 50px;
  border-bottom: 1px solid #eee;
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-28">5.4 防抖和节流：优化高频事件</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 防抖：只执行最后一次</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn, delay</span>) {
  <span class="hljs-keyword">let</span> timer
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-built_in">clearTimeout</span>(timer)
    timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args), delay)
  }
}

<span class="hljs-comment">// 节流：固定时间执行一次</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">throttle</span>(<span class="hljs-params">fn, delay</span>) {
  <span class="hljs-keyword">let</span> lastTime = <span class="hljs-number">0</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    <span class="hljs-keyword">if</span> (now - lastTime &gt;= delay) {
      lastTime = now
      fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
    }
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> searchInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'search'</span>)

<span class="hljs-comment">// 搜索输入防抖</span>
searchInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'搜索:'</span>, e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>)
}, <span class="hljs-number">300</span>))

<span class="hljs-comment">// 滚动节流</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-title function_">throttle</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'滚动位置:'</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>)
}, <span class="hljs-number">100</span>))
</code></pre>
<h4 data-id="heading-29">5.5 代码分割：按需加载</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 路由懒加载</span>
<span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/home'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/Home.vue'</span>)
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/about'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/About.vue'</span>)
  }
]

<span class="hljs-comment">// 组件懒加载</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: {
    <span class="hljs-title class_">HeavyComponent</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/components/HeavyComponent.vue'</span>)
  }
}

<span class="hljs-comment">// 条件加载</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadModule</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (needsFeature) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/features/advanced'</span>)
    <span class="hljs-variable language_">module</span>.<span class="hljs-title function_">doSomething</span>()
  }
}
</code></pre>
<h4 data-id="heading-30">5.6 减少 DOM 操作</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 频繁操作 DOM</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
  <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)
  div.<span class="hljs-property">textContent</span> = <span class="hljs-string">`Item <span class="hljs-subst">${i}</span>`</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(div)
}

<span class="hljs-comment">// ✅ 使用 DocumentFragment</span>
<span class="hljs-keyword">const</span> fragment = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createDocumentFragment</span>()

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
  <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)
  div.<span class="hljs-property">textContent</span> = <span class="hljs-string">`Item <span class="hljs-subst">${i}</span>`</span>
  fragment.<span class="hljs-title function_">appendChild</span>(div)
}

<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(fragment)

<span class="hljs-comment">// ✅ 或者使用 innerHTML 一次性插入</span>
<span class="hljs-keyword">let</span> html = <span class="hljs-string">''</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
  html += <span class="hljs-string">`&lt;div&gt;Item <span class="hljs-subst">${i}</span>&lt;/div&gt;`</span>
}
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">innerHTML</span> = html
</code></pre>
<h4 data-id="heading-31">5.7 使用 CSS3 动画代替 JS 动画</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* ❌ JS 动画（性能差） */</span>
<span class="hljs-selector-class">.element</span> {
  <span class="hljs-attribute">transition</span>: none;
}

<span class="hljs-comment">/* ✅ CSS3 动画（性能好） */</span>
<span class="hljs-selector-class">.element</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">100px</span>);
  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span> ease;
}

<span class="hljs-comment">/* 更好的：使用 will-change 提示浏览器优化 */</span>
<span class="hljs-selector-class">.element</span> {
  <span class="hljs-attribute">will-change</span>: transform;
}
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ JS 实现动画</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params">element</span>) {
  <span class="hljs-keyword">let</span> position = <span class="hljs-number">0</span>
  <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    position += <span class="hljs-number">10</span>
    element.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = position + <span class="hljs-string">'px'</span>
  }, <span class="hljs-number">16</span>)
}

<span class="hljs-comment">// ✅ 使用 CSS3</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params">element</span>) {
  element.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">'translateX(100px)'</span>
  element.<span class="hljs-property">style</span>.<span class="hljs-property">transition</span> = <span class="hljs-string">'transform 0.3s ease'</span>
}
</code></pre>
<h4 data-id="heading-32">5.8 Web Worker：把繁重计算放到后台线程</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'./worker.js'</span>)

worker.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">data</span>: largeData })

worker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'计算结果:'</span>, e.<span class="hljs-property">data</span>.<span class="hljs-property">result</span>)
}
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// worker.js</span>
self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">heavyCalculation</span>(e.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>)
  self.<span class="hljs-title function_">postMessage</span>({ result })
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">heavyCalculation</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-comment">// 耗时计算</span>
  <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b, <span class="hljs-number">0</span>)
}
</code></pre>
<h3 data-id="heading-33">综合实战：打造一套完整的前端性能优化方案</h3>
<p>讲了这么多，怎么组合起来用？来个真实案例，纯前端操作：</p>
<h4 data-id="heading-34">项目结构</h4>
<pre><code class="hljs language-arduino" lang="arduino">my-project/
├── <span class="hljs-keyword">public</span>/
│   ├── index.html
│   └── favicon.ico
├── src/
│   ├── assets/
│   │   ├── images/
│   │   └── styles/
│   ├── components/
│   ├── utils/
│   │   ├── cache.js
│   │   └── request.js
│   ├── sw.js
│   └── main.js
└── vite.config.js
</code></pre>
<h4 data-id="heading-35">完整配置（vite.config.js）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-keyword">import</span> viteImagemin <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-imagemin'</span>
<span class="hljs-keyword">import</span> webp <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-webp'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title function_">viteImagemin</span>({
      <span class="hljs-attr">gifsicle</span>: { <span class="hljs-attr">optimizationLevel</span>: <span class="hljs-number">7</span> },
      <span class="hljs-attr">optipng</span>: { <span class="hljs-attr">optimizationLevel</span>: <span class="hljs-number">7</span> },
      <span class="hljs-attr">mozjpeg</span>: { <span class="hljs-attr">quality</span>: <span class="hljs-number">80</span> },
      <span class="hljs-attr">svgo</span>: {
        <span class="hljs-attr">plugins</span>: [
          { <span class="hljs-attr">name</span>: <span class="hljs-string">'removeViewBox'</span> },
          { <span class="hljs-attr">name</span>: <span class="hljs-string">'removeEmptyAttrs'</span> }
        ]
      }
    }),
    <span class="hljs-title function_">webp</span>({
      <span class="hljs-attr">quality</span>: <span class="hljs-number">80</span>
    })
  ],

  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">entryFileNames</span>: <span class="hljs-string">'assets/[name].[hash].js'</span>,
        <span class="hljs-attr">chunkFileNames</span>: <span class="hljs-string">'assets/[name].[hash].js'</span>,
        <span class="hljs-attr">assetFileNames</span>: <span class="hljs-string">'assets/[name].[hash].[ext]'</span>
      }
    },
    <span class="hljs-attr">cssCodeSplit</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">minify</span>: <span class="hljs-string">'terser'</span>,
    <span class="hljs-attr">terserOptions</span>: {
      <span class="hljs-attr">compress</span>: {
        <span class="hljs-attr">drop_console</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">drop_debugger</span>: <span class="hljs-literal">true</span>
      }
    }
  }
})
</code></pre>
<h4 data-id="heading-36">HTML 优化（index.html）</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- DNS 预取 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"dns-prefetch"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdn.example.com"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preconnect"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdn.example.com"</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- 内联关键 CSS --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-comment">/* 首屏必需的样式 */</span>
  <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">font-family</span>: -apple-system, BlinkMacSystemFont, sans-serif; }
  <span class="hljs-selector-class">.header</span> { <span class="hljs-attribute">height</span>: <span class="hljs-number">60px</span>; <span class="hljs-attribute">background</span>: <span class="hljs-number">#333</span>; <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>; }
  <span class="hljs-selector-class">.loading</span> { <span class="hljs-attribute">position</span>: fixed; <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>; <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>; <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>); }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- 非关键样式异步加载 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preload"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/assets/style.[hash].css"</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"style"</span> <span class="hljs-attr">onload</span>=<span class="hljs-string">"this.onload=null;this.rel='stylesheet'"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">noscript</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/assets/style.[hash].css"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">noscript</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"loading"</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- 脚本异步加载 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/main.[hash].js"</span> <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-37">性能监控（utils/performance.js）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">trackPerformance</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'PerformanceObserver'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
    <span class="hljs-comment">// 监控资源加载</span>
    <span class="hljs-keyword">const</span> resourceObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> list.<span class="hljs-title function_">getEntries</span>()) {
        <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">transferSize</span> === <span class="hljs-number">0</span>) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✓ 缓存命中: <span class="hljs-subst">${entry.name}</span>`</span>)
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✗ 网络加载: <span class="hljs-subst">${entry.name}</span> (<span class="hljs-subst">${(entry.transferSize / <span class="hljs-number">1024</span>).toFixed(<span class="hljs-number">2</span>)}</span>KB)`</span>)
        }
      }
    })
    resourceObserver.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">'resource'</span>] })

    <span class="hljs-comment">// 监控长任务</span>
    <span class="hljs-keyword">const</span> longTaskObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> list.<span class="hljs-title function_">getEntries</span>()) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`⚠️ 长任务: <span class="hljs-subst">${entry.name}</span> (<span class="hljs-subst">${entry.duration}</span>ms)`</span>)
      }
    })
    longTaskObserver.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">'longtask'</span>] })
  }
}

<span class="hljs-comment">// 在 main.js 中调用</span>
<span class="hljs-title function_">trackPerformance</span>()
</code></pre>
<h3 data-id="heading-38">总结</h3>
<p>性能优化不是⼀蹴⽽就的，需要持续迭代。记住⼏个原则：</p>
<ol>
<li><strong>能缓存的尽量缓存</strong>，让⽤户少等⼏秒</li>
<li><strong>能压缩的尽量压缩</strong>，体积小了传输就快</li>
<li><strong>DNS 预取和预连接</strong>，提前做好准备</li>
<li><strong>CDN 是神器</strong>，让全球用户都能快速访问</li>
<li><strong>渲染优化很重要</strong>，加载快不等于体验好</li>
<li><strong>懒加载和按需加载</strong>，只加载用户需要的</li>
<li><strong>监控要跟上</strong>，不然你都不知道优化有没有⽤</li>
</ol>
<p>最后，如果你觉得这篇⽂章对你有帮助，<strong>点个赞呗</strong>！如果觉得有问题，<strong>评论区喷我</strong>，我抗揍。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第11章、错误处理与异常机制——构建健壮程序]]></title>    <link>https://juejin.cn/post/7601355703240441896</link>    <guid>https://juejin.cn/post/7601355703240441896</guid>    <pubDate>2026-02-02T00:41:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601355703240441896" data-draft-id="7601175299012214799" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第11章、错误处理与异常机制——构建健壮程序"/> <meta itemprop="keywords" content="后端,Go,编程语言"/> <meta itemprop="datePublished" content="2026-02-02T00:41:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怕浪猫"/> <meta itemprop="url" content="https://juejin.cn/user/2832784963939438"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第11章、错误处理与异常机制——构建健壮程序
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2832784963939438/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怕浪猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T00:41:49.000Z" title="Mon Feb 02 2026 00:41:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读28分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好～ 在前两章我们掌握了Go的结构体、方法以及接口与多态的核心知识，这些是构建Go程序的基础骨架。今天，我们将聚焦程序稳定性的关键——<strong>错误处理与异常机制</strong>。</p>
<p>不同于Java、Python的try-catch异常捕获模式，Go采用了“显式错误返回+轻量级异常恢复”的设计理念。这种设计让错误处理更可控、代码更清晰，但也对开发者的规范使用提出了更高要求。一个健壮的Go程序，必然离不开合理的错误处理策略和异常防护机制。</p>
<p>本文将严格按照目录逐节拆解，从基础的error接口到复杂的defer+panic+recover协同使用，每个知识点都配套<strong>可直接运行的代码示例</strong>，同时补充官方文档、实用工具和实战技巧。无论是入门者还是有经验的开发者，都能从中理清错误处理的核心逻辑，掌握构建健壮程序的关键方法。话不多说，开始正文～</p>
<h2 data-id="heading-0">一、error接口与错误处理惯例</h2>
<p>在Go中，错误处理的基础是<code>error</code>接口。Go没有内置的异常类型，而是通过返回<code>error</code>类型值来表示函数执行过程中出现的异常情况。这种“显式返回、主动检查”的模式，是Go错误处理的核心惯例。</p>
<h3 data-id="heading-1">1.1 error接口的定义与核心特性</h3>
<p>error接口是Go标准库<code>builtin</code>包中定义的一个极简接口，仅包含一个<code>Error()</code>方法：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// error接口定义（builtin包）</span>
<span class="hljs-keyword">type</span> <span class="hljs-type">error</span> <span class="hljs-keyword">interface</span> {
    Error() <span class="hljs-type">string</span> <span class="hljs-comment">// 返回错误信息字符串</span>
}

</code></pre>
<p>核心特性：</p>
<ul>
<li>
<p><strong>隐式实现</strong>：任何类型只要实现了<code>Error() string</code>方法，就自动实现了error接口，无需显式声明；</p>
</li>
<li>
<p><strong>值语义</strong>：error接口变量存储的是“具体错误类型的值（或指针）”，支持类型断言和类型选择；</p>
</li>
<li>
<p><strong>零值安全</strong>：error接口的零值是<code>nil</code>，表示“无错误”，可直接用于判断。</p>
</li>
</ul>
<h3 data-id="heading-2">1.2 Go错误处理的核心惯例</h3>
<p>Go社区形成了一套通用的错误处理惯例，遵循这些惯例能让代码更具可读性和可维护性：</p>
<ul>
<li>
<p><strong>显式返回错误</strong>：函数如果可能出现错误，应将error作为最后一个返回值；</p>
</li>
<li>
<p><strong>优先检查错误</strong>：调用返回错误的函数后，应立即检查error是否为nil，避免错误传播；</p>
</li>
<li>
<p><strong>错误描述简洁准确</strong>：错误信息应清晰说明“什么错误”“在什么场景下”，避免模糊表述；</p>
</li>
<li>
<p><strong>不忽略错误</strong>：除非明确知道该错误无关紧要（如关闭文件时的某些错误），否则严禁忽略错误；</p>
</li>
<li>
<p><strong>错误传递时保留上下文</strong>：向上层传递错误时，应补充当前场景的上下文信息，便于问题定位。</p>
</li>
</ul>
<h3 data-id="heading-3">1.3 代码示例：基础错误处理实践</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"errors"</span>
    <span class="hljs-string">"fmt"</span>
)

<span class="hljs-comment">// Divide 除法函数：可能出现除数为0的错误，显式返回error</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Divide</span><span class="hljs-params">(a, b <span class="hljs-type">int</span>)</span></span> (<span class="hljs-type">int</span>, <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">if</span> b == <span class="hljs-number">0</span> {
        <span class="hljs-comment">// 用errors.New创建基础错误</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, errors.New(<span class="hljs-string">"除数不能为0"</span>)
    }
    <span class="hljs-keyword">return</span> a / b, <span class="hljs-literal">nil</span> <span class="hljs-comment">// 无错误时返回nil</span>
}

<span class="hljs-comment">// Calculate 计算函数：调用Divide，检查并传递错误</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Calculate</span><span class="hljs-params">(a, b <span class="hljs-type">int</span>)</span></span> (<span class="hljs-type">int</span>, <span class="hljs-type">error</span>) {
    result, err := Divide(a, b)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// 错误传递时补充上下文</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, fmt.Errorf(<span class="hljs-string">"计算失败（a=%d, b=%d）：%w"</span>, a, b, err)
    }
    <span class="hljs-keyword">return</span> result * <span class="hljs-number">2</span>, <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 调用可能返回错误的函数，优先检查错误</span>
    result, err := Calculate(<span class="hljs-number">10</span>, <span class="hljs-number">0</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Printf(<span class="hljs-string">"执行失败：%v\n"</span>, err)
        <span class="hljs-keyword">return</span>
    }
    fmt.Printf(<span class="hljs-string">"执行成功，结果：%d\n"</span>, result)
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-text" lang="text">
执行失败：计算失败（a=10, b=0）：除数不能为0

</code></pre>
<p>关键说明：</p>
<ul>
<li>
<p><code>Divide</code>函数将error作为最后一个返回值，符合“显式返回错误”惯例；</p>
</li>
<li>
<p>调用<code>Divide</code>后立即检查err，避免错误传播到后续逻辑；</p>
</li>
<li>
<p>传递错误时使用<code>fmt.Errorf</code>和<code>%w</code>（Go 1.13+），既补充了上下文，又保留了原始错误信息。</p>
</li>
</ul>
<h3 data-id="heading-4">1.4 参考链接</h3>
<ul>
<li>
<p>Go官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpkg.go.dev%2Fbuiltin%23error" target="_blank" title="https://pkg.go.dev/builtin#error" ref="nofollow noopener noreferrer">error interface</a></p>
</li>
<li>
<p>Go官方博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fblog%2Ferror-handling-and-go" target="_blank" title="https://go.dev/blog/error-handling-and-go" ref="nofollow noopener noreferrer">Error Handling and Go</a></p>
</li>
</ul>
<h2 data-id="heading-5">二、自定义错误类型与错误包装</h2>
<p>基础的<code>errors.New</code>和<code>fmt.Errorf</code>只能创建简单的错误信息，但在复杂业务场景中，我们往往需要携带更多错误信息（如错误码、错误详情、堆栈信息等）。这时就需要定义自定义错误类型，并通过“错误包装”实现错误信息的层级传递。</p>
<h3 data-id="heading-6">2.1 自定义错误类型的实现</h3>
<p>自定义错误类型只需实现<code>error</code>接口的<code>Error()</code>方法即可。通常我们会定义一个结构体，包含需要的额外字段（如错误码、错误信息、原始错误等）。</p>
<h4 data-id="heading-7">2.1.1 代码示例：基础自定义错误</h4>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// MyError 自定义错误类型：包含错误码和错误信息</span>
<span class="hljs-keyword">type</span> MyError <span class="hljs-keyword">struct</span> {
    Code    <span class="hljs-type">int</span>    <span class="hljs-comment">// 错误码：用于上层根据错误码做差异化处理</span>
    Message <span class="hljs-type">string</span> <span class="hljs-comment">// 错误信息：用户可理解的错误描述</span>
}

<span class="hljs-comment">// Error 实现error接口的Error()方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *MyError)</span></span> Error() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"错误码：%d，错误信息：%s"</span>, e.Code, e.Message)
}

<span class="hljs-comment">// Login 模拟登录函数：返回自定义错误</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Login</span><span class="hljs-params">(username, password <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-keyword">if</span> username == <span class="hljs-string">""</span> {
        <span class="hljs-keyword">return</span> &amp;MyError{Code: <span class="hljs-number">400</span>, Message: <span class="hljs-string">"用户名不能为空"</span>}
    }
    <span class="hljs-keyword">if</span> password == <span class="hljs-string">""</span> {
        <span class="hljs-keyword">return</span> &amp;MyError{Code: <span class="hljs-number">400</span>, Message: <span class="hljs-string">"密码不能为空"</span>}
    }
    <span class="hljs-keyword">if</span> username != <span class="hljs-string">"admin"</span> || password != <span class="hljs-string">"123456"</span> {
        <span class="hljs-keyword">return</span> &amp;MyError{Code: <span class="hljs-number">401</span>, Message: <span class="hljs-string">"用户名或密码错误"</span>}
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    err := Login(<span class="hljs-string">"admin"</span>, <span class="hljs-string">"wrong"</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// 通过类型断言获取自定义错误的详细信息</span>
        <span class="hljs-keyword">if</span> e, ok := err.(*MyError); ok {
            fmt.Printf(<span class="hljs-string">"登录失败：%s\n"</span>, e.Error())
            <span class="hljs-comment">// 根据错误码执行差异化逻辑</span>
            <span class="hljs-keyword">switch</span> e.Code {
            <span class="hljs-keyword">case</span> <span class="hljs-number">400</span>:
                fmt.Println(<span class="hljs-string">"建议：检查用户名和密码是否填写完整"</span>)
            <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:
                fmt.Println(<span class="hljs-string">"建议：重新输入正确的用户名和密码"</span>)
            }
        }
        <span class="hljs-keyword">return</span>
    }
    fmt.Println(<span class="hljs-string">"登录成功"</span>)
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-text" lang="text">
登录失败：错误码：401，错误信息：用户名或密码错误
建议：重新输入正确的用户名和密码

</code></pre>
<h4 data-id="heading-8">2.1.2 进阶：携带堆栈信息的自定义错误</h4>
<p>在实际开发中，错误的堆栈信息对问题定位至关重要。我们可以借助第三方库（如<code>github.com/pkg/errors</code>）实现带堆栈信息的自定义错误。</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>

    <span class="hljs-string">"github.com/pkg/errors"</span>
)

<span class="hljs-comment">// BusinessError 带堆栈信息的业务错误</span>
<span class="hljs-keyword">type</span> BusinessError <span class="hljs-keyword">struct</span> {
    Code    <span class="hljs-type">int</span>
    Message <span class="hljs-type">string</span>
    Err     <span class="hljs-type">error</span> <span class="hljs-comment">// 原始错误：用于存储底层错误</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *BusinessError)</span></span> Error() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"业务错误[code:%d]：%s，原始错误：%v"</span>, e.Code, e.Message, e.Err)
}

<span class="hljs-comment">// Wrap 包装错误：添加堆栈信息</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *BusinessError)</span></span> Wrap(err <span class="hljs-type">error</span>) *BusinessError {
    e.Err = errors.WithStack(err)
    <span class="hljs-keyword">return</span> e
}

<span class="hljs-comment">// QueryUser 模拟查询用户：返回带堆栈的自定义错误</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">QueryUser</span><span class="hljs-params">(id <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-keyword">if</span> id &lt;= <span class="hljs-number">0</span> {
        err := errors.New(<span class="hljs-string">"用户ID必须大于0"</span>)
        <span class="hljs-keyword">return</span> &amp;BusinessError{Code: <span class="hljs-number">400</span>, Message: <span class="hljs-string">"查询用户失败"</span>}.Wrap(err)
    }
    <span class="hljs-comment">// 模拟数据库查询失败</span>
    dbErr := errors.New(<span class="hljs-string">"数据库连接超时"</span>)
    <span class="hljs-keyword">return</span> &amp;BusinessError{Code: <span class="hljs-number">500</span>, Message: <span class="hljs-string">"查询用户失败"</span>}.Wrap(dbErr)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    err := QueryUser(<span class="hljs-number">-1</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Printf(<span class="hljs-string">"执行失败：%v\n"</span>, err)
        <span class="hljs-comment">// 打印堆栈信息</span>
        <span class="hljs-keyword">if</span> e, ok := err.(*BusinessError); ok {
            fmt.Printf(<span class="hljs-string">"堆栈信息：%+v\n"</span>, e.Err)
        }
    }
}

</code></pre>
<p>运行结果（包含堆栈信息）：</p>
<pre><code class="hljs language-text" lang="text">
执行失败：业务错误[code:400]：查询用户失败，原始错误：用户ID必须大于0
堆栈信息：用户ID必须大于0
main.QueryUser
        /path/to/your/file.go:28
main.main
        /path/to/your/file.go:36
runtime.main
        /usr/local/go/src/runtime/proc.go:250
runtime.goexit
        /usr/local/go/src/runtime/asm_amd64.s:1598

</code></pre>
<h3 data-id="heading-9">2.2 错误包装与解包（Go 1.13+）</h3>
<p>Go 1.13引入了错误包装机制，通过<code>fmt.Errorf</code>的<code>%w</code>动词可以包装错误，通过<code>errors.Is</code>和<code>errors.As</code>函数可以解包和判断错误类型。这种机制让错误的层级传递和类型判断更规范。</p>
<h4 data-id="heading-10">2.2.1 核心函数说明</h4>
<ul>
<li>
<p><code>fmt.Errorf("%w", err)</code>：包装错误，将原始错误err包装到新的错误中；</p>
</li>
<li>
<p><code>errors.Is(err, target error)</code>：判断err链中是否包含target错误（精确匹配）；</p>
</li>
<li>
<p><code>errors.As(err, target interface{}) bool</code>：判断err链中是否存在可赋值给target的错误类型（类型匹配）。</p>
</li>
</ul>
<h4 data-id="heading-11">2.2.2 代码示例：错误包装与解包</h4>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"errors"</span>
    <span class="hljs-string">"fmt"</span>
)

<span class="hljs-comment">// 定义基础错误</span>
<span class="hljs-keyword">var</span> (
    ErrNotFound  = errors.New(<span class="hljs-string">"资源不存在"</span>)
    ErrPermission = errors.New(<span class="hljs-string">"权限不足"</span>)
)

<span class="hljs-comment">// QueryResource 模拟查询资源：包装基础错误</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">QueryResource</span><span class="hljs-params">(id <span class="hljs-type">int</span>, userRole <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-keyword">if</span> id &lt;= <span class="hljs-number">0</span> {
        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"查询资源（id=%d）失败：%w"</span>, id, ErrNotFound)
    }
    <span class="hljs-keyword">if</span> userRole != <span class="hljs-string">"admin"</span> {
        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"查询资源（id=%d）失败：%w"</span>, id, ErrPermission)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 场景1：资源不存在错误</span>
    err1 := QueryResource(<span class="hljs-number">-1</span>, <span class="hljs-string">"admin"</span>)
    <span class="hljs-keyword">if</span> err1 != <span class="hljs-literal">nil</span> {
        fmt.Printf(<span class="hljs-string">"错误信息：%v\n"</span>, err1)
        <span class="hljs-comment">// 用errors.Is判断错误类型</span>
        <span class="hljs-keyword">if</span> errors.Is(err1, ErrNotFound) {
            fmt.Println(<span class="hljs-string">"处理：资源不存在，引导用户检查ID"</span>)
        }
    }

    <span class="hljs-comment">// 场景2：权限不足错误</span>
    err2 := QueryResource(<span class="hljs-number">1</span>, <span class="hljs-string">"user"</span>)
    <span class="hljs-keyword">if</span> err2 != <span class="hljs-literal">nil</span> {
        fmt.Printf(<span class="hljs-string">"错误信息：%v\n"</span>, err2)
        <span class="hljs-keyword">if</span> errors.Is(err2, ErrPermission) {
            fmt.Println(<span class="hljs-string">"处理：权限不足，引导用户申请权限"</span>)
        }
    }

    <span class="hljs-comment">// 场景3：自定义错误类型的解包</span>
    <span class="hljs-keyword">type</span> MyError <span class="hljs-keyword">struct</span> {
        Code <span class="hljs-type">int</span>
        Msg  <span class="hljs-type">string</span>
    }
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *MyError)</span></span> Error() <span class="hljs-type">string</span> { <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"code:%d, msg:%s"</span>, e.Code, e.Msg) }

    err3 := fmt.Errorf(<span class="hljs-string">"包装自定义错误：%w"</span>, &amp;MyError{Code: <span class="hljs-number">500</span>, Msg: <span class="hljs-string">"服务器内部错误"</span>})
    <span class="hljs-keyword">if</span> err3 != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">var</span> e *MyError
        <span class="hljs-comment">// 用errors.As判断并提取自定义错误类型</span>
        <span class="hljs-keyword">if</span> errors.As(err3, &amp;e) {
            fmt.Printf(<span class="hljs-string">"提取自定义错误：code=%d, msg=%s\n"</span>, e.Code, e.Msg)
        }
    }
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-text" lang="text">
错误信息：查询资源（id=-1）失败：资源不存在
处理：资源不存在，引导用户检查ID
错误信息：查询资源（id=1）失败：权限不足
处理：权限不足，引导用户申请权限
提取自定义错误：code=500, msg=服务器内部错误

</code></pre>
<h3 data-id="heading-12">2.3 参考链接</h3>
<ul>
<li>
<p>Go官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpkg.go.dev%2Ferrors" target="_blank" title="https://pkg.go.dev/errors" ref="nofollow noopener noreferrer">errors 包</a></p>
</li>
<li>
<p>第三方错误处理库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpkg%2Ferrors" target="_blank" title="https://github.com/pkg/errors" ref="nofollow noopener noreferrer">github.com/pkg/errors</a></p>
</li>
</ul>
<h2 data-id="heading-13">三、使用fmt.Errorf与%w格式化</h2>
<p>在Go 1.13之前，<code>fmt.Errorf</code>只能用于创建简单的错误字符串，无法保留原始错误信息。Go 1.13为<code>fmt.Errorf</code>新增了<code>%w</code>动词，使其支持“错误包装”——既可以添加上下文信息，又能保留原始错误的类型和信息，方便后续通过<code>errors.Is</code>和<code>errors.As</code>解包。</p>
<h3 data-id="heading-14">3.1 %w的核心用法</h3>
<p><code>%w</code>的核心作用是“包装错误”，语法格式：</p>
<pre><code class="hljs language-go" lang="go">
newErr := fmt.Errorf(<span class="hljs-string">"上下文信息：%w"</span>, originalErr)

</code></pre>
<p>核心规则：</p>
<ul>
<li>
<p>一个<code>fmt.Errorf</code>调用中只能使用一个<code>%w</code>动词，否则会编译错误；</p>
</li>
<li>
<p>被包装的错误必须是<code>error</code>类型，否则会触发运行时panic；</p>
</li>
<li>
<p>包装后的错误可以通过<code>errors.Is</code>和<code>errors.As</code>获取原始错误。</p>
</li>
</ul>
<h3 data-id="heading-15">3.2 代码示例：%w的基础使用</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"errors"</span>
    <span class="hljs-string">"fmt"</span>
)

<span class="hljs-comment">// 定义原始错误</span>
<span class="hljs-keyword">var</span> ErrInvalidParam = errors.New(<span class="hljs-string">"参数无效"</span>)

<span class="hljs-comment">// Process 处理函数：包装错误并添加上下文</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Process</span><span class="hljs-params">(param <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-keyword">if</span> param &lt; <span class="hljs-number">0</span> {
        <span class="hljs-comment">// 用%w包装原始错误，添加上下文</span>
        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"Process: 参数param=%d不合法：%w"</span>, param, ErrInvalidParam)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// CallProcess 调用处理函数：再次包装错误</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CallProcess</span><span class="hljs-params">(param <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">error</span> {
    err := Process(param)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// 多层包装，添加更上层的上下文</span>
        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"CallProcess: 调用Process失败：%w"</span>, err)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    err := CallProcess(<span class="hljs-number">-5</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// 打印完整的错误信息（包含所有层级的上下文）</span>
        fmt.Printf(<span class="hljs-string">"最终错误：%v\n"</span>, err)

        <span class="hljs-comment">// 用errors.Is判断原始错误类型</span>
        <span class="hljs-keyword">if</span> errors.Is(err, ErrInvalidParam) {
            fmt.Println(<span class="hljs-string">"判断结果：错误链中包含ErrInvalidParam"</span>)
        }

        <span class="hljs-comment">// 解包原始错误</span>
        <span class="hljs-keyword">var</span> originalErr <span class="hljs-type">error</span>
        originalErr = err
        <span class="hljs-keyword">for</span> {
            unwrapped := errors.Unwrap(originalErr)
            <span class="hljs-keyword">if</span> unwrapped == <span class="hljs-literal">nil</span> {
                <span class="hljs-keyword">break</span>
            }
            originalErr = unwrapped
        }
        fmt.Printf(<span class="hljs-string">"原始错误：%v\n"</span>, originalErr)
    }
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-text" lang="text">
最终错误：CallProcess: 调用Process失败：Process: 参数param=-5不合法：参数无效
判断结果：错误链中包含ErrInvalidParam
原始错误：参数无效
</code></pre>
<p>关键说明：</p>
<ul>
<li>
<p>通过多层<code>%w</code>包装，错误信息包含了每一层的上下文，便于问题定位；</p>
</li>
<li>
<p>即使经过多层包装，<code>errors.Is</code>仍能准确判断错误链中是否包含原始错误；</p>
</li>
<li>
<p><code>errors.Unwrap</code>函数可以逐层解包错误，直到获取最原始的错误。</p>
</li>
</ul>
<h3 data-id="heading-16">3.3 %w与其他格式化动词的区别</h3>
<p>很多开发者会混淆<code>%w</code>与<code>%v</code>、<code>%s</code>等格式化动词，核心区别在于：<strong>%w会保留原始错误的类型信息，而其他动词仅保留错误的字符串信息</strong>。</p>
<h4 data-id="heading-17">3.3.1 代码示例：对比%w与%v</h4>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"errors"</span>
    <span class="hljs-string">"fmt"</span>
)

<span class="hljs-keyword">var</span> ErrTest = errors.New(<span class="hljs-string">"测试错误"</span>)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 用%w包装错误</span>
    errW := fmt.Errorf(<span class="hljs-string">"用%%w包装：%w"</span>, ErrTest)
    <span class="hljs-comment">// 用%v拼接错误</span>
    errV := fmt.Errorf(<span class="hljs-string">"用%%v拼接：%v"</span>, ErrTest)

    <span class="hljs-comment">// 用errors.Is判断原始错误</span>
    fmt.Printf(<span class="hljs-string">"errW包含ErrTest：%t\n"</span>, errors.Is(errW, ErrTest)) <span class="hljs-comment">// true</span>
    fmt.Printf(<span class="hljs-string">"errV包含ErrTest：%t\n"</span>, errors.Is(errV, ErrTest)) <span class="hljs-comment">// false</span>

    <span class="hljs-comment">// 打印错误类型</span>
    fmt.Printf(<span class="hljs-string">"errW类型：%T\n"</span>, errW) <span class="hljs-comment">// *fmt.wrapError（包装错误类型）</span>
    fmt.Printf(<span class="hljs-string">"errV类型：%T\n"</span>, errV) <span class="hljs-comment">// *errors.errorString（普通错误类型）</span>
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-text" lang="text">
errW包含ErrTest：true
errV包含ErrTest：false
errW类型：*fmt.wrapError
errV类型：*errors.errorString

</code></pre>
<p>结论：</p>
<ul>
<li>
<p>如果需要保留原始错误的类型信息（便于后续判断和处理），必须使用<code>%w</code>；</p>
</li>
<li>
<p>如果仅需要将错误信息作为字符串拼接（无需后续类型判断），可以使用<code>%v</code>或<code>%s</code>。</p>
</li>
</ul>
<h3 data-id="heading-18">3.4 实用技巧：错误上下文的规范写法</h3>
<p>添加错误上下文时，应遵循“谁出错+什么操作+什么参数+原始错误”的格式，便于问题定位。示例：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// 规范写法</span>
<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"用户服务：查询用户（ID=%d）失败：%w"</span>, userID, err)

<span class="hljs-comment">// 不规范写法（信息模糊）</span>
<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"查询失败：%w"</span>, err)

</code></pre>
<h2 data-id="heading-19">四、defer语句的执行时机与用途</h2>
<p><code>defer</code>是Go中的延迟执行语句，用于延迟调用一个函数，直到包含<code>defer</code>语句的函数执行完毕（返回之前）。<code>defer</code>的核心用途是“资源清理”，如关闭文件、释放锁、关闭数据库连接等，确保资源无论函数正常返回还是异常返回都能被正确清理。</p>
<h3 data-id="heading-20">4.1 defer的执行时机与顺序</h3>
<p>核心规则：</p>
<ul>
<li>
<p><code>defer</code>语句在定义时会立即计算函数参数的值，但函数体的执行会延迟到包含<code>defer</code>的函数返回之前；</p>
</li>
<li>
<p>多个<code>defer</code>语句按“后进先出（LIFO）”的顺序执行（最后定义的<code>defer</code>最先执行）；</p>
</li>
<li>
<p>即使函数中出现<code>return</code>、<code>panic</code>等终止执行的情况，<code>defer</code>语句仍会执行。</p>
</li>
</ul>
<h4 data-id="heading-21">4.1.1 代码示例：defer的执行顺序</h4>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"开始执行main函数"</span>)

    <span class="hljs-comment">// 定义多个defer语句</span>
    <span class="hljs-keyword">defer</span> fmt.Println(<span class="hljs-string">"defer 1：最先定义，最后执行"</span>)
    <span class="hljs-keyword">defer</span> fmt.Println(<span class="hljs-string">"defer 2：中间定义，中间执行"</span>)
    <span class="hljs-keyword">defer</span> fmt.Println(<span class="hljs-string">"defer 3：最后定义，最先执行"</span>)

    <span class="hljs-comment">// defer函数参数在定义时计算</span>
    x := <span class="hljs-number">10</span>
    <span class="hljs-keyword">defer</span> fmt.Printf(<span class="hljs-string">"defer 4：x的值=%d\n"</span>, x) <span class="hljs-comment">// 参数x=10在定义时已确定</span>
    x = <span class="hljs-number">20</span>

    fmt.Println(<span class="hljs-string">"main函数执行完毕，准备返回"</span>)
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-text" lang="text">
开始执行main函数
main函数执行完毕，准备返回
defer 3：最后定义，最先执行
defer 2：中间定义，中间执行
defer 1：最先定义，最后执行
defer 4：x的值=10

</code></pre>
<p>关键说明：</p>
<ul>
<li>
<p>三个<code>defer</code>按“后进先出”顺序执行，defer 3最先执行，defer 1最后执行；</p>
</li>
<li>
<p>defer 4的参数<code>x</code>在定义时就计算为10，后续修改<code>x=20</code>不会影响defer函数的输出。</p>
</li>
</ul>
<h3 data-id="heading-22">4.2 defer的核心用途</h3>
<h4 data-id="heading-23">4.2.1 资源清理（最常用）</h4>
<p>用于关闭文件、释放锁、关闭数据库连接等，确保资源被正确释放。</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"os"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">readFile</span><span class="hljs-params">(filename <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-comment">// 打开文件</span>
    file, err := os.Open(filename)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"打开文件失败：%w"</span>, err)
    }
    <span class="hljs-comment">// 延迟关闭文件：无论函数正常返回还是错误返回，都会执行file.Close()</span>
    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> errClose := file.Close(); errClose != <span class="hljs-literal">nil</span> {
            fmt.Printf(<span class="hljs-string">"关闭文件失败：%v\n"</span>, errClose)
        }
    }()

    <span class="hljs-comment">// 读取文件内容（简化示例）</span>
    <span class="hljs-keyword">var</span> buf [<span class="hljs-number">1024</span>]<span class="hljs-type">byte</span>
    n, err := file.Read(buf[:])
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"读取文件失败：%w"</span>, err)
    }

    fmt.Printf(<span class="hljs-string">"读取到的内容：%s\n"</span>, buf[:n])
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    err := readFile(<span class="hljs-string">"test.txt"</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Printf(<span class="hljs-string">"执行失败：%v\n"</span>, err)
    }
}

</code></pre>
<h4 data-id="heading-24">4.2.2 捕获函数返回值（修改返回值）</h4>
<p>defer函数可以访问并修改包含它的函数的返回值（需注意返回值的命名）。</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// 命名返回值函数</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">calc</span><span class="hljs-params">()</span></span> (result <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 可以访问并修改命名返回值</span>
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            result = <span class="hljs-number">-1</span> <span class="hljs-comment">// 错误时将返回值result设为-1</span>
            fmt.Printf(<span class="hljs-string">"defer：捕获错误，将result设为%d\n"</span>, result)
        }
    }()

    x := <span class="hljs-number">10</span>
    y := <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span> y == <span class="hljs-number">0</span> {
        err = fmt.Errorf(<span class="hljs-string">"除数不能为0"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-comment">// 此时会先执行defer函数，再返回result和err</span>
    }
    result = x / y
    <span class="hljs-keyword">return</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    res, err := calc()
    fmt.Printf(<span class="hljs-string">"返回结果：res=%d, err=%v\n"</span>, res, err)
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-text" lang="text">
defer：捕获错误，将result设为-1
返回结果：res=-1, err=除数不能为0

</code></pre>
<h4 data-id="heading-25">4.2.3 日志记录与性能统计</h4>
<p>用于记录函数的执行时间、入参出参等信息，便于性能分析和问题定位。</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-comment">// 性能统计装饰器：记录函数执行时间</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">withTimer</span><span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
    start := time.Now()
    fmt.Printf(<span class="hljs-string">"函数%s开始执行\n"</span>, name)
    <span class="hljs-comment">// 返回defer函数，用于记录结束时间</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        duration := time.Since(start)
        fmt.Printf(<span class="hljs-string">"函数%s执行完毕，耗时：%v\n"</span>, name, duration)
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">complexTask</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 延迟执行性能统计函数</span>
    <span class="hljs-keyword">defer</span> withTimer(<span class="hljs-string">"complexTask"</span>)()

    <span class="hljs-comment">// 模拟复杂任务</span>
    time.Sleep(<span class="hljs-number">2</span> * time.Second)
    fmt.Println(<span class="hljs-string">"复杂任务执行中..."</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    complexTask()
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-text" lang="text">
函数complexTask开始执行
复杂任务执行中...
函数complexTask执行完毕，耗时：2.000123456s

</code></pre>
<h3 data-id="heading-26">4.3 defer的使用注意事项</h3>
<ul>
<li>
<p><strong>避免在循环中使用defer</strong>：循环中定义的defer会等到循环所在的函数执行完毕后才批量执行，可能导致资源泄露（如大量文件句柄未及时关闭）。解决方案：将循环体内部的逻辑封装为函数，在函数内部使用defer；</p>
</li>
<li>
<p><strong>注意defer函数的参数计算时机</strong>：defer函数的参数在定义时就已计算，后续修改参数变量不会影响defer函数的执行；</p>
</li>
<li>
<p><strong>defer函数的执行顺序</strong>：多个defer按“后进先出”执行，设计时需注意顺序（如先锁后解锁，defer解锁应紧跟锁的获取）；</p>
</li>
<li>
<p><strong>避免defer函数中产生错误</strong>：defer函数的错误不会影响主函数的执行，也无法被主函数捕获，应在defer函数内部处理自身的错误（如关闭文件的错误）。</p>
</li>
</ul>
<h3 data-id="heading-27">4.4 参考链接</h3>
<ul>
<li>Go官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fspec%23Defer_statements" target="_blank" title="https://go.dev/ref/spec#Defer_statements" ref="nofollow noopener noreferrer">Defer statements</a></li>
</ul>
<h2 data-id="heading-28">五、panic与recover的异常恢复机制</h2>
<p>在Go中，<code>panic</code>用于触发运行时异常，会终止当前函数的执行，并向上层函数传播，直到程序崩溃（除非被<code>recover</code>捕获）。<code>recover</code>用于捕获<code>panic</code>触发的异常，恢复程序的正常执行。</p>
<p>核心原则：<strong>panic用于处理不可恢复的致命错误，recover仅用于在defer中捕获panic，恢复程序执行</strong>。Go不鼓励使用panic/recover替代正常的错误处理（如参数校验错误应返回error，而非触发panic）。</p>
<h3 data-id="heading-29">5.1 panic的触发与传播机制</h3>
<p>触发panic的方式：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// 方式1：直接调用panic，参数为错误信息</span>
<span class="hljs-built_in">panic</span>(<span class="hljs-string">"致命错误：xxx"</span>)

<span class="hljs-comment">// 方式2：调用内置函数触发的panic（如数组越界、空指针引用）</span>
<span class="hljs-keyword">var</span> arr [<span class="hljs-number">3</span>]<span class="hljs-type">int</span>
fmt.Println(arr[<span class="hljs-number">10</span>]) <span class="hljs-comment">// 数组越界，触发panic</span>

</code></pre>
<p>传播机制：</p>
<ul>
<li>
<p>当函数中触发panic时，函数会立即停止执行当前逻辑，开始执行已定义的defer语句；</p>
</li>
<li>
<p>defer语句执行完毕后，函数会终止，并将panic向上层调用函数传播；</p>
</li>
<li>
<p>如果上层函数也没有捕获panic，panic会继续向上传播，直到main函数，最终导致程序崩溃。</p>
</li>
</ul>
<h4 data-id="heading-30">5.1.1 代码示例：panic的传播与程序崩溃</h4>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">funcA</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"进入funcA"</span>)
    funcB()
    fmt.Println(<span class="hljs-string">"退出funcA（不会执行）"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">funcB</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"进入funcB"</span>)
    <span class="hljs-comment">// 触发panic</span>
    <span class="hljs-built_in">panic</span>(<span class="hljs-string">"funcB中发生致命错误"</span>)
    fmt.Println(<span class="hljs-string">"退出funcB（不会执行）"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"进入main"</span>)
    funcA()
    fmt.Println(<span class="hljs-string">"退出main（不会执行）"</span>)
}

</code></pre>
<p>运行结果（程序崩溃）：</p>
<pre><code class="hljs language-text" lang="text">
进入main
进入funcA
进入funcB
panic: funcB中发生致命错误

goroutine 1 [running]:
main.funcB()
        /path/to/your/file.go:13 +0x70
main.funcA()
        /path/to/your/file.go:7 +0x25
main.main()
        /path/to/your/file.go:18 +0x25
exit status 2

</code></pre>
<h3 data-id="heading-31">5.2 recover的使用与异常恢复</h3>
<p>recover的核心特性：</p>
<ul>
<li>
<p>recover只能在defer函数中使用，在非defer函数中调用recover会返回nil，无法捕获panic；</p>
</li>
<li>
<p>recover会捕获当前goroutine中的panic，返回panic的参数（错误信息）；</p>
</li>
<li>
<p>捕获成功后，程序会从触发panic的函数的上层函数继续执行，不再向上传播panic。</p>
</li>
</ul>
<h4 data-id="heading-32">5.2.1 代码示例：用recover捕获panic，恢复程序执行</h4>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">funcA</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"进入funcA"</span>)
    <span class="hljs-comment">// 定义defer函数，用recover捕获panic</span>
    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> r := <span class="hljs-built_in">recover</span>(); r != <span class="hljs-literal">nil</span> {
            fmt.Printf(<span class="hljs-string">"funcA中捕获到panic：%v\n"</span>, r)
        }
    }()
    funcB()
    fmt.Println(<span class="hljs-string">"退出funcA（会执行吗？看funcB是否触发panic）"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">funcB</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"进入funcB"</span>)
    <span class="hljs-comment">// 触发panic</span>
    <span class="hljs-built_in">panic</span>(<span class="hljs-string">"funcB中发生致命错误"</span>)
    fmt.Println(<span class="hljs-string">"退出funcB（不会执行）"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"进入main"</span>)
    funcA()
    fmt.Println(<span class="hljs-string">"退出main（会执行，因为panic被捕获）"</span>)
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-text" lang="text">
进入main
进入funcA
进入funcB
funcA中捕获到panic：funcB中发生致命错误
退出main（会执行，因为panic被捕获）

</code></pre>
<p>关键说明：</p>
<ul>
<li>
<p>在funcA中定义了defer函数，内部调用recover捕获panic；</p>
</li>
<li>
<p>funcB触发panic后，会先执行funcA中已定义的defer函数，recover捕获到panic；</p>
</li>
<li>
<p>捕获成功后，程序不会崩溃，而是从funcA执行完毕后继续执行main函数的后续逻辑。</p>
</li>
</ul>
<h3 data-id="heading-33">5.3 panic与error的区别与使用场景</h3>






























<table><thead><tr><th>对比维度</th><th>error</th><th>panic</th></tr></thead><tbody><tr><td>本质</td><td>接口类型，用于表示可预期的错误状态</td><td>运行时异常，用于表示不可预期的致命错误</td></tr><tr><td>处理方式</td><td>显式返回，主动检查并处理</td><td>触发后终止函数执行，需通过recover捕获恢复</td></tr><tr><td>使用场景</td><td>可预期的错误（如参数无效、文件不存在、网络超时）</td><td>不可预期的致命错误（如数组越界、空指针引用、配置文件缺失导致程序无法运行）</td></tr><tr><td>程序影响</td><td>不影响程序继续执行，仅当前函数逻辑可能中断</td><td>不捕获则导致程序崩溃</td></tr></tbody></table>
<h3 data-id="heading-34">5.4 参考链接</h3>
<ul>
<li>Go官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fspec%23Handling_panics" target="_blank" title="https://go.dev/ref/spec#Handling_panics" ref="nofollow noopener noreferrer">Handling panics</a></li>
</ul>
<h2 data-id="heading-35">六、defer、panic、recover协同使用</h2>
<p>在Go中，defer、panic、recover三者通常协同使用，构成“异常捕获与恢复”的完整机制。核心模式是：<strong>在可能触发panic的函数中，通过defer注册recover函数，捕获panic并恢复程序执行，同时记录错误信息</strong>。</p>
<p>这种模式广泛应用于需要保证程序稳定性的场景（如Web服务的请求处理、后台任务的循环执行等），确保单个请求或任务的异常不会导致整个服务崩溃。</p>
<h3 data-id="heading-36">6.1 核心协同模式</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-function"><span class="hljs-keyword">func</span> 可能触发<span class="hljs-title">panic</span>的函数<span class="hljs-params">()</span></span> (err <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 定义defer函数，用recover捕获panic</span>
    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> r := <span class="hljs-built_in">recover</span>(); r != <span class="hljs-literal">nil</span> {
            <span class="hljs-comment">// 2. 捕获到panic，将panic信息转为error返回</span>
            err = fmt.Errorf(<span class="hljs-string">"发生异常：%v"</span>, r)
            <span class="hljs-comment">// 3. 记录错误日志（包含堆栈信息）</span>
            log.Printf(<span class="hljs-string">"panic recovered: %v, stack: %s"</span>, r, debug.Stack())
        }
    }()

    <span class="hljs-comment">// 4. 执行可能触发panic的逻辑</span>
    可能触发<span class="hljs-built_in">panic</span>的操作()

    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

</code></pre>
<h3 data-id="heading-37">6.2 代码示例：Web服务中的异常捕获</h3>
<p>在Web服务中，每个请求都运行在独立的goroutine中。如果某个请求处理过程中触发panic，未捕获会导致整个服务崩溃。通过defer+recover捕获每个请求的panic，可确保服务稳定运行。</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"debug/stack"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"log"</span>
    <span class="hljs-string">"net/http"</span>
)

<span class="hljs-comment">// 异常处理中间件：捕获请求处理过程中的panic</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">recoverMiddleware</span><span class="hljs-params">(next http.HandlerFunc)</span></span> http.HandlerFunc {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
        <span class="hljs-comment">// 注册defer函数，捕获panic</span>
        <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
            <span class="hljs-keyword">if</span> r := <span class="hljs-built_in">recover</span>(); r != <span class="hljs-literal">nil</span> {
                <span class="hljs-comment">// 记录错误日志（包含堆栈信息）</span>
                log.Printf(<span class="hljs-string">"请求处理异常：%v，请求路径：%s，堆栈信息：%s"</span>,
                    r, r.URL.Path, stack.Caller(<span class="hljs-number">0</span>))
                <span class="hljs-comment">// 向客户端返回500错误</span>
                http.Error(w, <span class="hljs-string">"服务器内部错误"</span>, http.StatusInternalServerError)
            }
        }()
        <span class="hljs-comment">// 执行后续的请求处理逻辑</span>
        next(w, r)
    }
}

<span class="hljs-comment">// 测试接口：故意触发panic</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">testHandler</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
    <span class="hljs-comment">// 模拟业务逻辑错误，触发panic</span>
    <span class="hljs-built_in">panic</span>(<span class="hljs-string">"数据库连接异常，无法查询数据"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 注册路由，使用异常处理中间件</span>
    http.HandleFunc(<span class="hljs-string">"/test"</span>, recoverMiddleware(testHandler))

    log.Println(<span class="hljs-string">"服务启动，监听端口8080"</span>)
    err := http.ListenAndServe(<span class="hljs-string">":8080"</span>, <span class="hljs-literal">nil</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        log.Fatalf(<span class="hljs-string">"服务启动失败：%v"</span>, err)
    }
}

</code></pre>
<p>测试步骤：</p>
<ol>
<li>
<p>启动服务，访问<code>http://localhost:8080/test</code>；</p>
</li>
<li>
<p>客户端会收到<code>500 Internal Server Error</code>响应；</p>
</li>
<li>
<p>服务端日志会记录panic信息和堆栈信息，但服务不会崩溃，仍可处理其他请求。</p>
</li>
</ol>
<h3 data-id="heading-38">6.3 进阶示例：批量任务处理中的异常隔离</h3>
<p>在批量处理任务时，单个任务的异常不应影响其他任务的执行。通过defer+recover可实现异常隔离，确保批量任务的稳定执行。</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"debug/stack"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"log"</span>
)

<span class="hljs-comment">// 处理单个任务：可能触发panic</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processTask</span><span class="hljs-params">(taskID <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> r := <span class="hljs-built_in">recover</span>(); r != <span class="hljs-literal">nil</span> {
            <span class="hljs-comment">// 捕获panic，转为error返回</span>
            log.Printf(<span class="hljs-string">"处理任务%d异常：%v，堆栈信息：%s"</span>, taskID, r, stack.Caller(<span class="hljs-number">0</span>))
        }
    }()

    <span class="hljs-comment">// 模拟任务处理逻辑</span>
    <span class="hljs-keyword">if</span> taskID == <span class="hljs-number">3</span> {
        <span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">"任务%d数据异常"</span>, taskID))
    }

    fmt.Printf(<span class="hljs-string">"任务%d处理成功\n"</span>, taskID)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// 批量处理任务：异常隔离，单个任务失败不影响其他任务</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">batchProcessTasks</span><span class="hljs-params">(taskIDs []<span class="hljs-type">int</span>)</span></span> {
    <span class="hljs-keyword">for</span> _, id := <span class="hljs-keyword">range</span> taskIDs {
        err := processTask(id)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            log.Printf(<span class="hljs-string">"任务%d处理失败：%v"</span>, id, err)
        }
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 批量任务ID列表</span>
    taskIDs := []<span class="hljs-type">int</span>{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>}
    fmt.Println(<span class="hljs-string">"开始批量处理任务"</span>)
    batchProcessTasks(taskIDs)
    fmt.Println(<span class="hljs-string">"批量处理任务结束"</span>)
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-text" lang="text">
开始批量处理任务
任务1处理成功
任务2处理成功
2024/05/20 10:00:00 处理任务3异常：任务3数据异常，堆栈信息：[0x49a2b0 0x49a8c0 0x49a9a0 0x4c7e60 0x4c9a80 0x4f5f80 0x5252c0]
任务4处理成功
任务5处理成功
批量处理任务结束

</code></pre>
<p>关键说明：</p>
<ul>
<li>
<p>任务3触发panic，但被processTask中的defer+recover捕获；</p>
</li>
<li>
<p>其他任务（1、2、4、5）不受影响，正常处理完成；</p>
</li>
<li>
<p>批量处理任务正常结束，实现了异常隔离。</p>
</li>
</ul>
<h3 data-id="heading-39">6.4 协同使用的注意事项</h3>
<ul>
<li>
<p><strong>recover必须在defer中使用</strong>：非defer函数中的recover无法捕获panic；</p>
</li>
<li>
<p><strong>defer必须在可能触发panic的逻辑之前定义</strong>：如果defer定义在panic之后，defer函数不会执行，无法捕获panic；</p>
</li>
<li>
<p><strong>避免过度使用recover</strong>：recover仅用于捕获不可预期的致命错误，不应用于处理可预期的业务错误（如参数无效应返回error）；</p>
</li>
<li>
<p><strong>捕获panic后必须记录日志</strong>：panic通常表示严重错误，需详细记录错误信息和堆栈信息，便于问题定位；</p>
</li>
<li>
<p><strong>recover只能捕获当前goroutine的panic</strong>：无法捕获其他goroutine触发的panic。</p>
</li>
</ul>
<h2 data-id="heading-40">七、错误日志记录与上下文传递</h2>
<p>在实际开发中，错误处理的核心目标之一是“快速定位问题”。这需要我们在记录错误日志时，不仅要记录错误信息本身，还要传递足够的上下文信息（如请求ID、用户ID、函数调用栈、参数信息等）。同时，在多层函数调用中，错误上下文的传递也至关重要。</p>
<h4 data-id="heading-41">7.1 错误日志应包含的上下文信息</h4>
<p>一份高质量的错误日志应包含以下信息：</p>
<ul>
<li>
<p><strong>基础信息</strong>：时间戳、日志级别（ERROR/WARN/INFO）、错误信息；</p>
</li>
<li>
<p><strong>业务上下文</strong>：请求ID、用户ID、接口名、参数值、操作类型；</p>
</li>
<li>
<p><strong>技术上下文</strong>：函数调用栈、goroutine ID、服务器IP、进程ID；</p>
</li>
<li>
<p><strong>关联信息</strong>：上下游服务调用记录、数据库SQL语句、缓存键值。</p>
</li>
</ul>
<h4 data-id="heading-42">7.2 日志工具选型与最佳实践</h4>
<p>Go 生态中有很多成熟的日志库，推荐使用支持结构化日志、上下文传递的库：</p>
<ul>
<li>
<p><strong>标准库</strong>：<code>log</code> 包（基础功能，无结构化日志）；</p>
</li>
<li>
<p><strong>第三方库</strong>：<code>zap</code>（高性能、结构化日志，Uber 开源）、<code>logrus</code>（易用性强，社区活跃）。</p>
</li>
</ul>
<h5 data-id="heading-43">代码示例：使用 zap 记录带上下文的错误日志</h5>
<pre><code class="hljs language-Go" lang="Go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"go.uber.org/zap"</span>
    <span class="hljs-string">"go.uber.org/zap/zapcore"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 初始化 zap 日志（生产环境建议使用 Production 配置）</span>
    logger, _ := zap.NewProduction(zap.AddCaller(), zap.AddStacktrace(zapcore.ErrorLevel))
    <span class="hljs-keyword">defer</span> logger.Sync() <span class="hljs-comment">// 确保日志刷盘</span>

    <span class="hljs-comment">// 模拟业务错误</span>
    userID := <span class="hljs-string">"1001"</span>
    err := queryUser(userID)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// 记录带上下文的错误日志</span>
        logger.Error(
            <span class="hljs-string">"查询用户失败"</span>,
            zap.String(<span class="hljs-string">"user_id"</span>, userID),
            zap.Error(err),
            zap.String(<span class="hljs-string">"operation"</span>, <span class="hljs-string">"user_query"</span>),
        )
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">queryUser</span><span class="hljs-params">(userID <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-comment">// 模拟数据库查询错误</span>
    <span class="hljs-keyword">return</span> zap.NewError(<span class="hljs-string">"数据库连接超时"</span>)
}
</code></pre>
<p><strong>日志输出（结构化 JSON 格式）</strong>：</p>
<pre><code class="hljs language-JSON" lang="JSON">
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"level"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"error"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"ts"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1716234567.890</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"caller"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main/main.go:18"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"查询用户失败"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1001"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"error"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"数据库连接超时"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"operation"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user_query"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"stacktrace"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main.queryUser\n\t/path/to/main.go:25\nmain.main\n\t/path/to/main.go:18"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-44">7.3 基于 context 传递错误上下文</h4>
<p>在 Go 中，<code>context.Context</code> 是传递请求级上下文的标准方式，可用于携带请求 ID、用户信息等，方便在错误发生时关联上下文。</p>
<h5 data-id="heading-45">代码示例：context 传递请求上下文</h5>
<pre><code class="hljs language-Go" lang="Go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"go.uber.org/zap"</span>
)

<span class="hljs-comment">// 定义上下文 key 类型（避免命名冲突）</span>
<span class="hljs-keyword">type</span> ctxKey <span class="hljs-type">string</span>
<span class="hljs-keyword">const</span> (
    reqIDKey ctxKey = <span class="hljs-string">"req_id"</span>
    userIDKey ctxKey = <span class="hljs-string">"user_id"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    logger, _ := zap.NewProduction()
    <span class="hljs-keyword">defer</span> logger.Sync()

    <span class="hljs-comment">// 初始化请求上下文</span>
    ctx := context.WithValue(context.Background(), reqIDKey, <span class="hljs-string">"req-20240520-001"</span>)
    ctx = context.WithValue(ctx, userIDKey, <span class="hljs-string">"1001"</span>)

    <span class="hljs-comment">// 调用业务函数</span>
    err := processOrder(ctx, <span class="hljs-string">"order-001"</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// 从上下文提取信息，记录日志</span>
        reqID := ctx.Value(reqIDKey).(<span class="hljs-type">string</span>)
        userID := ctx.Value(userIDKey).(<span class="hljs-type">string</span>)
        logger.Error(
            <span class="hljs-string">"处理订单失败"</span>,
            zap.String(<span class="hljs-string">"req_id"</span>, reqID),
            zap.String(<span class="hljs-string">"user_id"</span>, userID),
            zap.String(<span class="hljs-string">"order_id"</span>, <span class="hljs-string">"order-001"</span>),
            zap.Error(err),
        )
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processOrder</span><span class="hljs-params">(ctx context.Context, orderID <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-comment">// 从上下文获取请求 ID</span>
    reqID := ctx.Value(reqIDKey).(<span class="hljs-type">string</span>)
    fmt.Printf(<span class="hljs-string">"处理订单：%s，请求 ID：%s\n"</span>, orderID, reqID)

    <span class="hljs-comment">// 模拟业务错误</span>
    <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"库存不足，订单 ID：%s"</span>, orderID)
}
</code></pre>
<h4 data-id="heading-46">7.4 错误上下文传递的最佳实践</h4>
<ul>
<li>
<p><strong>不要在错误信息中重复上下文</strong>：通过结构化日志字段传递（如 <code>user_id</code>、<code>req_id</code>），而非拼接在错误字符串中；</p>
</li>
<li>
<p><strong>使用 context 传递请求级上下文</strong>：避免通过函数参数传递大量上下文信息；</p>
</li>
<li>
<p><strong>日志级别区分</strong>：ERROR 级别记录致命错误，WARN 级别记录非致命错误，INFO 级别记录关键操作；</p>
</li>
<li>
<p><strong>生产环境开启堆栈跟踪</strong>：仅在 ERROR 级别记录堆栈信息，减少性能开销。</p>
</li>
</ul>
<h3 data-id="heading-47">八、构建可恢复的健壮系统</h3>
<p>错误处理的最终目标是构建<strong>高可用、可恢复</strong>的系统。一个健壮的系统需要从<strong>预防、检测、恢复</strong>三个层面设计错误处理策略。</p>
<h4 data-id="heading-48">8.1 错误预防：减少错误发生的概率</h4>
<ul>
<li>
<p><strong>参数校验前置</strong>：所有外部输入（API 参数、配置文件、数据库数据）必须进行严格校验；</p>
</li>
<li>
<p><strong>防御性编程</strong>：针对空指针、数组越界等常见 panic 场景，提前做判空、边界检查；</p>
</li>
<li>
<p><strong>资源隔离</strong>：使用连接池、限流、熔断等机制，避免单个资源耗尽影响整个系统；</p>
</li>
<li>
<p><strong>配置兜底</strong>：核心配置必须设置默认值，避免配置缺失导致程序启动失败。</p>
</li>
</ul>
<h5 data-id="heading-49">代码示例：参数校验与防御性编程</h5>
<pre><code class="hljs language-Go" lang="Go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// GetUser 获取用户信息：参数校验前置</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUser</span><span class="hljs-params">(userID <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 防御性检查：用户 ID 非空</span>
    <span class="hljs-keyword">if</span> userID == <span class="hljs-string">""</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, fmt.Errorf(<span class="hljs-string">"user_id 不能为空"</span>)
    }
    <span class="hljs-comment">// 防御性检查：用户 ID 格式合法</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(userID) != <span class="hljs-number">4</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, fmt.Errorf(<span class="hljs-string">"user_id 格式非法，必须为4位字符串"</span>)
    }
    <span class="hljs-comment">// 模拟查询用户</span>
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"用户信息：%s"</span>, userID), <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    userInfo, err := GetUser(<span class="hljs-string">""</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Printf(<span class="hljs-string">"获取用户失败：%v\n"</span>, err)
        <span class="hljs-keyword">return</span>
    }
    fmt.Println(userInfo)
}
</code></pre>
<h4 data-id="heading-50">8.2 错误检测：快速发现问题</h4>
<ul>
<li>
<p><strong>完善的日志监控</strong>：使用 ELK、Prometheus + Grafana 等工具，对错误日志进行实时监控和告警；</p>
</li>
<li>
<p><strong>健康检查接口</strong>：暴露 <code>/health</code> 接口，定期检查数据库、缓存、依赖服务的可用性；</p>
</li>
<li>
<p><strong>链路追踪</strong>：使用 Jaeger、Zipkin 等工具，追踪请求的完整链路，定位跨服务调用的错误。</p>
</li>
<li/>
</ul>
<h4 data-id="heading-51">8.3 错误恢复：自动降级与重试</h4>
<ul>
<li>
<p><strong>重试机制</strong>：对网络抖动、数据库连接超时等<strong>临时性错误</strong>，实现幂等重试（注意重试次数和间隔）；</p>
</li>
<li>
<p><strong>降级策略</strong>：对核心功能，设计降级方案（如缓存降级、服务熔断、返回默认值）；</p>
</li>
<li>
<p><strong>优雅重启</strong>：使用信号量（如 <code>SIGTERM</code>）实现优雅关闭，确保程序退出前完成资源清理。</p>
</li>
</ul>
<h5 data-id="heading-52">代码示例：基于重试的错误恢复</h5>
<pre><code class="hljs language-Go" lang="Go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-comment">// Retry 通用重试函数：仅重试临时性错误</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Retry</span><span class="hljs-params">(maxRetries <span class="hljs-type">int</span>, interval time.Duration, fn <span class="hljs-keyword">func</span>()</span></span> <span class="hljs-type">error</span>) <span class="hljs-type">error</span> {
    <span class="hljs-keyword">var</span> err <span class="hljs-type">error</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; maxRetries; i++ {
        err = fn()
        <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> <span class="hljs-comment">// 执行成功，直接返回</span>
        }
        <span class="hljs-comment">// 判断是否为临时性错误（实际场景可定义错误类型）</span>
        <span class="hljs-keyword">if</span> isTemporaryError(err) {
            fmt.Printf(<span class="hljs-string">"第%d次重试，错误：%v\n"</span>, i+<span class="hljs-number">1</span>, err)
            time.Sleep(interval)
            <span class="hljs-keyword">continue</span>
        }
        <span class="hljs-comment">// 非临时性错误，直接返回</span>
        <span class="hljs-keyword">return</span> err
    }
    <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"达到最大重试次数 %d，最终错误：%v"</span>, maxRetries, err)
}

<span class="hljs-comment">// 模拟临时性错误判断</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isTemporaryError</span><span class="hljs-params">(err <span class="hljs-type">error</span>)</span></span> <span class="hljs-type">bool</span> {
    <span class="hljs-keyword">return</span> err.Error() == <span class="hljs-string">"数据库连接超时"</span> || err.Error() == <span class="hljs-string">"网络抖动"</span>
}

<span class="hljs-comment">// QueryDB 模拟数据库查询</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">QueryDB</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-comment">// 模拟前两次失败，第三次成功</span>
    staticCount++
    <span class="hljs-keyword">if</span> staticCount &lt;= <span class="hljs-number">2</span> {
        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"数据库连接超时"</span>)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-keyword">var</span> staticCount <span class="hljs-type">int</span> <span class="hljs-comment">// 模拟重试计数</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    err := Retry(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>*time.Second, QueryDB)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Printf(<span class="hljs-string">"执行失败：%v\n"</span>, err)
        <span class="hljs-keyword">return</span>
    }
    fmt.Println(<span class="hljs-string">"执行成功"</span>)
}
</code></pre>
<p><strong>运行结果</strong>：</p>
<pre><code class="hljs language-Plain" lang="Plain">
第1次重试，错误：数据库连接超时
第2次重试，错误：数据库连接超时
执行成功
</code></pre>
<h4 data-id="heading-53">8.4 构建健壮系统的核心原则</h4>
<ul>
<li>
<p><strong>故障隔离</strong>：单个模块的错误不应扩散到其他模块（如使用 goroutine 隔离、服务熔断）；</p>
</li>
<li>
<p><strong>幂等性设计</strong>：核心接口必须实现幂等性，确保重试不会产生副作用；</p>
</li>
<li>
<p><strong>最小权限原则</strong>：程序运行的权限、资源访问权限应最小化，减少错误影响范围；</p>
</li>
<li>
<p><strong>持续优化</strong>：定期分析错误日志，总结高频错误类型，从根源上优化代码。</p>
</li>
</ul>
<h3 data-id="heading-54">总结</h3>
<p>Go 语言的错误处理机制是“<strong>显式错误返回 + 轻量级异常恢复</strong>”的组合，与传统的 try-catch 模式有本质区别。本章我们从基础的 <code>error</code> 接口出发，逐步深入到自定义错误、错误包装、<code>defer/panic/recover</code> 协同使用，最后延伸到错误日志记录和健壮系统构建，核心要点如下：</p>
<ol>
<li><strong>error 接口</strong>是 Go 错误处理的基础，通过显式返回和检查 <code>nil</code> 实现错误处理；</li>
</ol>
<ul>
<li>
<p><strong>自定义错误</strong>可携带额外信息（错误码、堆栈），<code>%w</code> 动词实现错误包装与解包；</p>
</li>
<li>
<p><strong>defer</strong> 用于延迟执行资源清理逻辑，遵循“后进先出”执行顺序；</p>
</li>
<li>
<p><strong>panic/recover</strong> 用于处理不可预期的致命错误，<code>recover</code> 必须在 <code>defer</code> 中使用；</p>
</li>
<li>
<p><strong>错误日志</strong>需包含足够的上下文信息，结合 <code>context</code> 实现请求级上下文传递；</p>
</li>
<li>
<p><strong>健壮系统</strong>需要从预防、检测、恢复三个层面设计，实现故障隔离和自动恢复。</p>
</li>
</ul>
<p>遵循这些原则和实践，你可以写出更稳定、更易维护的 Go 程序，从容应对复杂的生产环境挑战。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OoderAgent A2UI 技术原理深度揭秘]]></title>    <link>https://juejin.cn/post/7601387539334807588</link>    <guid>https://juejin.cn/post/7601387539334807588</guid>    <pubDate>2026-02-02T00:46:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601387539334807588" data-draft-id="7601464318408966186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OoderAgent A2UI 技术原理深度揭秘"/> <meta itemprop="keywords" content="编程语言,人工智能"/> <meta itemprop="datePublished" content="2026-02-02T00:46:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OoderAgent A2UI 技术原理深度揭秘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T00:46:29.000Z" title="Mon Feb 02 2026 00:46:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>ooderA2UI 是一个设计到代码引擎，它通过多种建模模式实现了从自然语言描述到可运行代码的无缝衔接。本文将深入探讨 ooderA2UI 的核心技术原理，重点关注 LLM 参与流程、Skills 挂接机制、bridge code 工作原理以及 NlpModule 工作原理等核心内容，为您揭开这个智能转换引擎的技术奥秘。</p>
<h2 data-id="heading-1">一、核心概念与术语</h2>
<h3 data-id="heading-2">1.1 核心概念</h3>
<ul>
<li><strong>LLM</strong>：大型语言模型，用于解析自然语言描述，提取设计意图和组件需求</li>
<li><strong>NlpModule (NLPMod)</strong>：NLP模块，是最终生成的核心模块，包含完整的功能实现</li>
<li><strong>UIComponent (UIC)</strong>：UI组件，与前端组件形成1:1映射的后端组件对象</li>
<li><strong>bridgeCode (BC)</strong>：桥接代码，包括 OneCode (OC) 等多种形式，是连接设计层和代码层的桥梁</li>
<li><strong>Skills</strong>：技能模块，用于扩展 ooderA2UI 的功能，提供特定领域的能力</li>
</ul>
<h3 data-id="heading-3">1.2 术语对应关系</h3>






















































<table><thead><tr><th align="left">概念</th><th align="left">简写</th><th align="left">设计器术语</th><th align="left">引擎术语</th><th align="left">定义</th></tr></thead><tbody><tr><td align="left">NlpModule</td><td align="left">NLPMod</td><td align="left">NlpModule</td><td align="left">NLPMod</td><td align="left">最终生成的 NLP 模块，包含完整的功能实现</td></tr><tr><td align="left">UIComponent</td><td align="left">UIC</td><td align="left">Design Component</td><td align="left">UIComponent</td><td align="left">与前端组件形成1:1映射的后端组件对象</td></tr><tr><td align="left">bridgeCode</td><td align="left">BC</td><td align="left">OneCode</td><td align="left">UIBridge</td><td align="left">桥接代码，连接设计层和代码层的桥梁</td></tr><tr><td align="left">LLM</td><td align="left">LLM</td><td align="left">-</td><td align="left">LLM</td><td align="left">大型语言模型，用于解析自然语言描述</td></tr><tr><td align="left">OneCode</td><td align="left">OC</td><td align="left">OneCode</td><td align="left">UIBridge</td><td align="left">一种桥接代码形式，用于连接 UI 和后端逻辑</td></tr><tr><td align="left">Skills</td><td align="left">Skills</td><td align="left">Skills</td><td align="left">Skills</td><td align="left">技能模块，用于扩展 ooderA2UI 的功能</td></tr></tbody></table>
<h2 data-id="heading-4">二、第一种建模模式：LLM → NlpModule → 双产物输出</h2>
<h4 data-id="heading-5">模式概述</h4>
<p>从自然语言描述出发，通过 LLM 解析提取设计意图，生成 NlpModule，最终同步输出 UIComponent 和 bridgeCode 两种产物。这是 ooderA2UI 最核心的建模模式，展示了从自然语言到可运行代码的完整转换流程。</p>
<h3 data-id="heading-6">2.1 详细流程图</h3>
<p>​</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61312f8930024b2880992ac0cdbdbed7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597989&amp;x-signature=%2FRKi88Ow6DGQwEhlOsyNFt7tcNY%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/341932a36d954f9b87d1180cb484d4c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597989&amp;x-signature=9UAm6VbX4rz7uU4SU8794d6CBHc%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<p>​</p>
<p>​</p>
<p>​</p>
<p>​</p>
<h3 data-id="heading-7">2.2 LLM 参与流程详解</h3>
<p>LLM 在第一种建模模式中扮演着核心角色，负责将自然语言描述转换为结构化的设计意图。以下是 LLM 参与的详细流程：</p>
<h4 data-id="heading-8">2.2.1 LLM 解析过程</h4>
<ol>
<li><strong>输入处理</strong>：
<ul>
<li>接收用户输入的自然语言描述</li>
<li>进行预处理，包括分词、语法分析等</li>
<li>构建提示词（Prompt），引导 LLM 生成结构化输出</li>
</ul>
</li>
<li><strong>意图识别</strong>：
<ul>
<li>LLM 分析自然语言描述，识别用户的设计意图</li>
<li>提取核心需求，如页面类型、组件类型、布局要求等</li>
<li>识别用户提到的实体、关系和属性</li>
</ul>
</li>
<li><strong>结构化输出</strong>：
<ul>
<li>LLM 生成结构化的输出，如 JSON 格式的设计意图</li>
<li>包含组件类型、属性、事件、样式等信息</li>
<li>提供设计决策的理由和依据</li>
</ul>
</li>
</ol>
<h4 data-id="heading-9">2.2.2 LLM 决策点</h4>
<ul>
<li><strong>组件类型决策</strong>：根据自然语言描述，决定使用哪种类型的组件</li>
<li><strong>布局结构决策</strong>：确定页面的整体布局结构和组件排列方式</li>
<li><strong>事件绑定决策</strong>：识别组件需要绑定的事件和对应的处理逻辑</li>
<li><strong>样式设计决策</strong>：根据描述生成适当的样式信息，如颜色、字体、大小等</li>
<li><strong>API 调用决策</strong>：识别需要调用的后端 API 和数据流向</li>
</ul>
<h3 data-id="heading-10">2.3 Skills 挂接机制</h3>
<p>Skills 是 ooderA2UI 的扩展机制，允许系统集成特定领域的能力。以下是 Skills 挂接的详细机制：</p>
<h4 data-id="heading-11">2.3.1 Skills 在 LLM 解析中的作用</h4>
<p><strong>重要技术逻辑修正</strong>：Skills 不是 LLM 解析的独立步骤，而是在 LLM 解析过程中被调用的扩展机制。LLM 解析引擎在解析自然语言时，会根据需要调用相应的 Skills 来增强解析能力。</p>
<h4 data-id="heading-12">2.3.2 Skills 调用时机</h4>
<p>​</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17e553e63cfe45d4879321c7725f2ff3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597989&amp;x-signature=dupUmP2V5Qc8lSeySI1Cq6%2F37Qc%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9d91b80330c4c79b57092b6c4a82169~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597989&amp;x-signature=3p3g%2FarTsyR1493OCtTQpRZdB7Y%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<h3 data-id="heading-13">2.4 bridge code 工作原理</h3>
<p>bridge code 是连接设计层和代码层的桥梁，负责将 NlpModule 转换为可运行的代码。以下是 bridge code 的工作原理：</p>
<h4 data-id="heading-14">2.4.1 bridge code 生成过程</h4>
<ol>
<li><strong>分析 NlpModule</strong>：
<ul>
<li>分析 NlpModule 的结构，包括组件、事件、样式等</li>
<li>识别组件间的关系和依赖</li>
<li>提取需要转换为代码的关键信息</li>
</ul>
</li>
<li><strong>代码结构生成</strong>：
<ul>
<li>生成组件的 HTML 结构</li>
<li>生成 CSS 样式代码</li>
<li>生成 JavaScript 事件处理代码</li>
<li>生成与后端 API 交互的代码</li>
</ul>
</li>
<li><strong>代码优化</strong>：
<ul>
<li>优化代码结构，提高可读性</li>
<li>压缩代码体积，提高性能</li>
<li>添加必要的注释和文档</li>
</ul>
</li>
</ol>
<h3 data-id="heading-15">2.5 NlpModule 工作原理</h3>
<p>NlpModule 是 ooderA2UI 的核心数据结构，包含了从自然语言描述中提取的所有设计信息。以下是 NlpModule 的工作原理：</p>
<h4 data-id="heading-16">2.5.1 NlpModule 数据填充机制</h4>
<p>NlpModule 数据填充机制</p>
<p>​</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54424225e6cc4c4f96e711a67639708d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597989&amp;x-signature=AmqWeZ2ccNyLQVP1H7dzPmJEKCA%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<h2 data-id="heading-17">三、第二种建模模式：用户已有Code → bridgeCode → NlpModule还原</h2>
<h4 data-id="heading-18">模式概述</h4>
<p>从用户现有的代码出发，通过代码分析提取桥接信息，生成 bridgeCode，最终还原生成 NlpModule。这一模式展示了 ooderA2UI 如何处理现有代码，实现代码的智能化改造和管理。</p>
<h3 data-id="heading-19">3.1 详细流程图</h3>
<p>第二种建模模式：用户已有Code → bridgeCode → NlpModule还原（详细流程）</p>
<p>​</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d34c965dd4594b1db02b31a38ace4cd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597989&amp;x-signature=zK27%2BPjmfe%2BI%2FOzoLA%2BSPiXBmvk%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<p>​</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7d510da0f70447ab0f05cbcbb244cfb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597989&amp;x-signature=M%2FaoqoxKP%2F%2Fp3CqxCdZiGTsbtoY%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<p>​</p>
<h3 data-id="heading-20">3.2 代码分析与 bridgeCode 生成</h3>
<h4 data-id="heading-21">3.2.1 代码分析过程</h4>
<ol>
<li><strong>代码结构分析</strong>：
<ul>
<li>分析现有代码的文件结构和目录组织</li>
<li>识别页面组件、样式文件和脚本文件</li>
<li>理解代码的模块化程度和依赖关系</li>
</ul>
</li>
<li><strong>组件识别</strong>：
<ul>
<li>识别页面中的 UI 组件及其属性</li>
<li>提取组件的事件处理逻辑</li>
<li>分析组件的样式定义</li>
</ul>
</li>
<li><strong>API 识别</strong>：
<ul>
<li>识别代码中的 API 调用</li>
<li>分析 API 的参数和返回值</li>
<li>理解数据流向和状态管理</li>
</ul>
</li>
</ol>
<h4 data-id="heading-22">3.2.2 bridgeCode 生成过程</h4>
<p><strong>关键技术逻辑</strong>：在第二种建模模式中，bridgeCode 的生成与第一种模式不同，它不是从 NlpModule 生成的，而是直接从现有代码分析结果生成的。</p>
<ol>
<li><strong>提取桥接信息</strong>：
<ul>
<li>从分析结果中提取组件、事件、样式和 API 信息</li>
<li>构建组件间的关系图</li>
<li>识别代码中的可复用部分</li>
</ul>
</li>
<li><strong>生成 bridgeCode</strong>：
<ul>
<li>根据提取的信息生成结构化的 bridgeCode</li>
<li>保持与原始代码的一致性</li>
<li>添加必要的元数据和注释</li>
</ul>
</li>
</ol>
<h3 data-id="heading-23">3.3 NlpModule 还原过程</h3>
<h4 data-id="heading-24">3.3.1 从 bridgeCode 到 NlpModule</h4>
<ol>
<li><strong>解析 bridgeCode</strong>：
<ul>
<li>解析 bridgeCode 的 JSON 结构</li>
<li>提取组件、事件、动作和 API 信息</li>
<li>验证 bridgeCode 的完整性和一致性</li>
</ul>
</li>
<li><strong>构建 NlpModule</strong>：
<ul>
<li>创建 NlpModule 实例</li>
<li>填充组件、事件、动作和 API 信息</li>
<li>建立组件间的关系和依赖</li>
</ul>
</li>
<li><strong>优化 NlpModule</strong>：
<ul>
<li>优化组件结构，提高可维护性</li>
<li>合并重复的样式和事件处理逻辑</li>
<li>确保 NlpModule 的一致性和完整性</li>
</ul>
</li>
</ol>
<h2 data-id="heading-25">四、第三种建模模式：UIComponent → 自动识别关联 → NlpModule</h2>
<h4 data-id="heading-26">模式概述</h4>
<p>从设计器生成的 UIComponent 出发，通过自动识别关联引擎识别组件与后端 API 的关联，最终生成完整的 NlpModule。这一模式展示了 ooderA2UI 如何实现设计驱动开发，将设计器中的 UI 组件转换为可运行的代码。</p>
<h3 data-id="heading-27">4.1 详细流程图</h3>
<p>第三种建模模式：UIComponent → 自动识别关联 → NlpModule（详细流程）</p>
<p>​</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b60537bb9723431a9a12782f495b899a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597989&amp;x-signature=%2BI19kHYwlAkVld7WwqDcy3bMQbU%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03653b7079f6452abcd90469cf2f1974~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597989&amp;x-signature=dtVehoD%2Fp0ve9BXa6moOOhJYpbU%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<h3 data-id="heading-28">4.2 UIComponent 分析与关联识别</h3>
<h4 data-id="heading-29">4.2.1 UIComponent 分析过程</h4>
<ol>
<li><strong>结构分析</strong>：
<ul>
<li>分析 UIComponent 的层级结构</li>
<li>识别组件类型和属性</li>
<li>提取组件的事件和样式信息</li>
</ul>
</li>
<li><strong>关系分析</strong>：
<ul>
<li>分析组件间的父子关系和兄弟关系</li>
<li>识别组件间的交互和数据传递</li>
<li>构建组件的依赖图</li>
</ul>
</li>
</ol>
<h4 data-id="heading-30">4.2.2 关联识别过程</h4>
<ol>
<li><strong>API 识别</strong>：
<ul>
<li>分析组件的功能和数据需求</li>
<li>识别可能需要调用的后端 API</li>
<li>匹配 API 与组件的交互逻辑</li>
</ul>
</li>
<li><strong>数据流向分析</strong>：
<ul>
<li>分析数据从 API 到组件的流向</li>
<li>识别数据转换和处理逻辑</li>
<li>构建数据流向图</li>
</ul>
</li>
</ol>
<h3 data-id="heading-31">4.3 UIComponent 到 NlpModule 的转换</h3>
<p><strong>关键技术逻辑</strong>：UIComponent 到 NlpModule 的转换是第三种建模模式的核心环节，展示了如何将设计器中的 UI 组件转换为包含完整功能实现的核心模块。</p>
<h4 data-id="heading-32">4.3.1 转换过程</h4>
<ol>
<li><strong>基本信息转换</strong>：
<ul>
<li>将 UIComponent 的基本信息转换为 NlpModule 的元数据</li>
<li>保持组件的名称、描述等信息一致</li>
<li>添加必要的版本和状态信息</li>
</ul>
</li>
<li><strong>组件结构转换</strong>：
<ul>
<li>将 UIComponent 的层级结构转换为 NlpModule 的组件列表</li>
<li>保持组件的类型、属性和样式信息</li>
<li>转换组件的事件和交互逻辑</li>
</ul>
</li>
<li><strong>关联关系转换</strong>：
<ul>
<li>将识别到的 API 关联转换为 NlpModule 的 API 调用信息</li>
<li>转换数据流向为 NlpModule 的数据流定义</li>
<li>添加必要的动作和处理逻辑</li>
</ul>
</li>
<li><strong>优化与验证</strong>：
<ul>
<li>优化 NlpModule 的结构和组织</li>
<li>验证转换结果的完整性和一致性</li>
<li>确保所有必要的信息都已转换</li>
</ul>
</li>
</ol>
<h2 data-id="heading-33">五、核心技术原理总结</h2>
<h3 data-id="heading-34">5.1 LLM 参与的核心作用</h3>
<h4 data-id="heading-35">LLM 在 ooderA2UI 中的角色</h4>
<ul>
<li><strong>自然语言理解</strong>：解析用户输入的自然语言描述，提取设计意图</li>
<li><strong>设计决策</strong>：基于自然语言描述，做出组件类型、布局结构等设计决策</li>
<li><strong>结构化输出</strong>：生成结构化的设计信息，为后续处理提供基础</li>
<li><strong>上下文理解</strong>：理解设计的上下文和用户需求，提供更准确的设计建议</li>
</ul>
<h3 data-id="heading-36">5.2 Skills 挂接的技术实现</h3>
<h4 data-id="heading-37">Skills 扩展机制</h4>
<ul>
<li><strong>插件化架构</strong>：采用插件化架构，支持动态注册和卸载技能</li>
<li><strong>标准化接口</strong>：定义标准化的技能接口，确保技能的一致性和可扩展性</li>
<li><strong>智能路由</strong>：根据任务类型，智能选择合适的技能处理</li>
<li><strong>结果集成</strong>：将技能执行结果无缝集成到 ooderA2UI 的处理流程中</li>
</ul>
<h3 data-id="heading-38">5.3 bridge code 的技术价值</h3>
<h4 data-id="heading-39">bridge code 的作用</h4>
<ul>
<li><strong>中间表示</strong>：作为设计层和代码层之间的中间表示，简化转换过程</li>
<li><strong>代码生成</strong>：为代码生成提供结构化的输入，确保生成代码的质量</li>
<li><strong>代码管理</strong>：提供标准化的代码结构，便于代码的管理和维护</li>
<li><strong>跨平台支持</strong>：支持生成不同平台的代码，提高系统的灵活性</li>
</ul>
<h3 data-id="heading-40">5.4 NlpModule 的核心地位</h3>
<h4 data-id="heading-41">NlpModule 的作用</h4>
<ul>
<li><strong>统一数据模型</strong>：作为整个系统的统一数据模型，确保数据的一致性</li>
<li><strong>信息聚合</strong>：聚合从不同来源（LLM、代码分析、UI设计）获取的信息</li>
<li><strong>转换中心</strong>：作为不同表示形式（UIComponent、bridgeCode）之间的转换中心</li>
<li><strong>验证机制</strong>：提供信息验证机制，确保设计信息的完整性和一致性</li>
</ul>
<h2 data-id="heading-42">六、结论</h2>
<p>ooderA2UI 通过三种核心建模模式，实现了从自然语言描述到可运行代码的无缝衔接。本文深入探讨了 ooderA2UI 的核心技术原理，重点关注了 LLM 参与流程、Skills 挂接机制、bridge code 工作原理以及 NlpModule 工作原理等核心内容，为您揭开这个智能转换引擎的技术奥秘。</p>
<p>ooderA2UI 的技术优势在于：</p>
<ul>
<li><strong>智能设计</strong>：利用 LLM 实现从自然语言到设计的智能转换</li>
<li><strong>扩展性强</strong>：通过 Skills 机制，支持功能的灵活扩展</li>
<li><strong>代码质量高</strong>：通过 bridge code 生成机制，确保生成代码的质量和一致性</li>
<li><strong>流程完整</strong>：提供从设计到代码的完整转换流程，支持多种建模模式</li>
</ul>
<p>ooderA2UI 展示了如何将 AI 技术与传统的代码生成技术相结合，为前端开发带来新的思路和方法。通过深入理解其核心技术原理，我们可以更好地应用和扩展这个智能转换引擎，为前端开发带来更多便利和效率提升。</p>
<p><strong>作者</strong>：ooder 开发团队</p>
<p><strong>日期</strong>：2026-02-02</p>
<p><strong>适用范围</strong>：ooderA2UI 1.0+</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端实现一个高性能的点阵地球-Cobe]]></title>    <link>https://juejin.cn/post/7601355703240458280</link>    <guid>https://juejin.cn/post/7601355703240458280</guid>    <pubDate>2026-02-02T00:46:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601355703240458280" data-draft-id="7600755567487156276" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端实现一个高性能的点阵地球-Cobe"/> <meta itemprop="keywords" content="前端,CSS,JavaScript"/> <meta itemprop="datePublished" content="2026-02-02T00:46:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏武难飞"/> <meta itemprop="url" content="https://juejin.cn/user/2664871913328478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端实现一个高性能的点阵地球-Cobe
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2664871913328478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏武难飞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T00:46:20.000Z" title="Mon Feb 02 2026 00:46:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">webgl实现一个高性能的点阵地球</h2>
<p>很久没有写博客了，最近依然在学习一些<code>webgl</code>、<code>glsl</code>知识，今天和大家共同学习一个堪称优化到极限的<code>shader</code>代码
<span href="https://code.juejin.cn/pen/7601078756278550568" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7601078756278550568" data-src="https://code.juejin.cn/pen/7601078756278550568" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h3 data-id="heading-1">为什么说Cobe堪称极限</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/197f040fdd6c447b9a8d2c6b310c3b5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5q2m6Zq-6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597980&amp;x-signature=p7g13MvExprc8u8A3SFGb%2BHMcwo%3D" alt="Cobe" loading="lazy"/></p>
<p>首先是<code>Cobe</code>这个库大小只有<code>5KB</code>，并且在移动端上也有非常惊艳的效果，这全部得益于<code>Cobe</code>本身就是基于标准<code>webgl</code>来开发没有使用类似<code>Three.js</code>等大型<code>webgl</code>封装库，以及在<code>shader</code>中利用数学公式来反向推导实现了点阵的效果！没有使用高清纹理图片没有使用<code>cpu</code>来递归循环！</p>
<h3 data-id="heading-2">1.一切从圆开始！</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd5396a81409419398a5e02c6cfa9030~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5q2m6Zq-6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597980&amp;x-signature=bPfhlCI6yCBwABLd1a3o9SY1e3w%3D" alt="20260130141937" loading="lazy"/></p>
<pre><code class="hljs language-glsl" lang="glsl">void main() {
    vec2 uv = gl_FragCoord.xy / u_resolution.xy;
    float aspect = u_resolution.x / u_resolution.y;
    vec2 p = uv * 2. - 1.;
    p.x *= aspect;

    float r = 0.5;
    // p.x * p.x + p.y * p.y
    float d2 = dot(p, p);

    if (d2 &lt; r * r) {
        outColor = vec4(vec3(0.0), 1.0);
    } else {
        outColor = vec4(vec3(0.141), 1.0);
    }
}
</code></pre>
<p>根据勾股定理我们知道 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><msup><mi>y</mi><mn>2</mn></msup><mo>=</mo><msup><mi>r</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">x^2 + y^2 = r^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>，我们利用<code>dot</code>计算出来了<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><msup><mi>y</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">x^2 + y^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>，然后判断小于半径的我们给一个黑色<code>outColor = vec4(vec3(0.0), 1.0)</code>大于半径的我们给一个背景色<code>outColor = vec4(vec3(0.141), 1.0)</code>，这样就实现了一个半径<code>0.5</code>的圆~</p>
<h3 data-id="heading-3">2.给圆形贴上纹理</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6439d96884484995ad315b206579fbff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5q2m6Zq-6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597980&amp;x-signature=uNFac8XYfw%2FHa9e8olVU5IyWPtI%3D" alt="02" loading="lazy"/></p>
<pre><code class="hljs language-glsl" lang="glsl">
void main() {
    vec2 uv = gl_FragCoord.xy / u_resolution.xy;
    float aspect = u_resolution.x / u_resolution.y;
    vec2 p = uv * 2. - 1.;
    p.x *= aspect;

    float r = 0.5;
    // p.x * p.x + p.y * p.y
    float d2 = dot(p, p);

    if (d2 &lt; r * r) {

        // 1. 计算球面上该点的法线 (nor)
        // 在正交投影下，z = sqrt(r^2 - x^2 - y^2)
        float z = sqrt(r * r - d2);
        vec3 nor = normalize(vec3(p.x, p.y, z));

        // 2. 让球转动起来，方便观察两极
        nor = rotateY(u_time * 0.5) * rotateX(u_time * 0.3) * nor;


        float u_lon = atan(nor.x, nor.z) / (2.0 * PI) + 0.5;
        float v_lat = asin(nor.y) / PI + 0.5;
        float mapValue = texture(u_texture, vec2(u_lon, v_lat)).r;

        // 5. 颜色输出
        outColor = vec4(vec3(mapValue), 1.0);

    } else {
        outColor = vec4(vec3(0.141), 1.0);
    }
}

</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c5675e37d3b429ea0454527e0ba5b80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5q2m6Zq-6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597980&amp;x-signature=mkdU4Cna5M9vTCJfL6S0mPIieSU%3D" alt="World_map_blank_without_borders" loading="lazy"/></p>
<p>我们首先传入一个<code>1280 × 712</code>大小<code>95KB</code>的纹理贴图，然后把我们第一步画好的圆升维到<code>3D</code>的圆，根据<code>3D</code>圆勾股定理<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><msup><mi>y</mi><mn>2</mn></msup><mo>+</mo><msup><mi>z</mi><mn>2</mn></msup><mo>=</mo><msup><mi>r</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">x^2 + y^2 + z^2 = r^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>，之前我们已经有<code>float d2 = dot(p, p)</code>也就是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><msup><mi>y</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">x^2 + y^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>也知道了<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>r</mi><mn>2</mn></msup><mo>=</mo><mi>r</mi><mo>⋅</mo><mi>r</mi></mrow><annotation encoding="application/x-tex">r^2 = r \cdot r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.4445em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span></span>所以<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi><mo>=</mo><msqrt><mrow><msup><mi>r</mi><mn>2</mn></msup><mo>−</mo><msup><mi>d</mi><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">z = \sqrt{r^2 - d^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1266em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9134em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.8734em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1266em;"><span/></span></span></span></span></span></span></span></span>，现在我们有了<code>x</code>、<code>y</code>、<code>z</code>，就可以归一化之后运用等距柱状投影来把纹理图贴到球体上！</p>
<p>经度映射 (U 坐标)</p>
<ul>
<li>公式推导：使用 atan(x, z) 计算向量在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mi>Z</mi></mrow><annotation encoding="application/x-tex">XZ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">XZ</span></span></span></span></span> 平面（水平面）上的极坐标角度。其范围是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mo>−</mo><mi>π</mi><mo separator="true">,</mo><mi>π</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[-\pi, \pi]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">−</span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mclose">]</span></span></span></span></span>。</li>
<li>归一化：除以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>π</mi></mrow><annotation encoding="application/x-tex">2\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span></span> 后，范围变成 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mo>−</mo><mn>0.5</mn><mo separator="true">,</mo><mn>0.5</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[-0.5, 0.5]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">−</span><span class="mord">0.5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0.5</span><span class="mclose">]</span></span></span></span></span>。加上 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.5</mn></mrow><annotation encoding="application/x-tex">0.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.5</span></span></span></span></span> 后，范围变成 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>。</li>
<li>物理意义：这对应了地球的经度，也就是绕着 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span></span> 轴转了一圈。</li>
</ul>
<p>纬度映射</p>
<ul>
<li>(V 坐标)公式推导： asin(y)（反正弦）计算的是向量与 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mi>Z</mi></mrow><annotation encoding="application/x-tex">XZ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">XZ</span></span></span></span></span> 平面的夹角。由于是单位圆，其范围是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mo>−</mo><mfrac><mi>π</mi><mn>2</mn></mfrac><mo separator="true">,</mo><mfrac><mi>π</mi><mn>2</mn></mfrac><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[-\frac{\pi}{2}, \frac{\pi}{2}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.095em;vertical-align:-0.345em;"/><span class="mopen">[</span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">]</span></span></span></span></span>（即 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>9</mn><msup><mn>0</mn><mo>∘</mo></msup></mrow><annotation encoding="application/x-tex">-90^\circ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7574em;vertical-align:-0.0833em;"/><span class="mord">−</span><span class="mord">9</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6741em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∘</span></span></span></span></span></span></span></span></span></span></span></span> 到 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>9</mn><msup><mn>0</mn><mo>∘</mo></msup></mrow><annotation encoding="application/x-tex">90^\circ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6741em;"/><span class="mord">9</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6741em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∘</span></span></span></span></span></span></span></span></span></span></span></span>）。</li>
<li>归一化：除以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span></span> 后，范围变成 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mo>−</mo><mn>0.5</mn><mo separator="true">,</mo><mn>0.5</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[-0.5, 0.5]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">−</span><span class="mord">0.5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0.5</span><span class="mclose">]</span></span></span></span></span>。加上 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.5</mn></mrow><annotation encoding="application/x-tex">0.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.5</span></span></span></span></span> 后，范围变成 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>。</li>
<li>物理意义： 这对应了地球的纬度，从南极 (0) 经过赤道 (0.5) 到达北极 (1)。</li>
</ul>
<h3 data-id="heading-4">3.实现一个均分点阵</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b32d8c966efc4d49847bf079e55b2066~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5q2m6Zq-6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597980&amp;x-signature=1W1TeqzX0mh%2F71ws5htO0vIxpBE%3D" alt="03" loading="lazy"/></p>
<pre><code class="hljs language-glsl" lang="glsl">vec2 mappingUV(vec3 nor) {

    // 1. 计算纬度角 theta (从北极 0 到 南极 PI)
    float theta = acos(nor.y);

    // 2. 计算经度角 phi (从 -PI 到 PI)
    float phi = atan(nor.z, nor.x);

    // 3. 将其映射到 [0, 1] 区间以便取索引或上色
    float u = (phi + PI) / (2.0 * PI);
    float v = theta / PI;

    return vec2(u, v);
}

void main() {
    vec2 uv = gl_FragCoord.xy / u_resolution.xy;
    float aspect = u_resolution.x / u_resolution.y;
    vec2 p = uv * 2. - 1.;
    p.x *= aspect;

    float r = 0.5;
    // p.x * p.x + p.y * p.y
    float d2 = dot(p, p);

    if (d2 &lt; r * r) {

        // 1. 计算球面上该点的法线 (nor)
        // 在正交投影下，z = sqrt(r^2 - x^2 - y^2)
        float z = sqrt(r * r - d2);
        vec3 nor = normalize(vec3(p.x, p.y, z));

        // 2. 让球转动起来，方便观察两极
        nor = rotateY(u_time * 0.5) * rotateX(u_time * 0.3) * nor;


//        float u_lon = atan(nor.x, nor.z) / (2.0 * PI) + 0.5;
//        float v_lat = asin(nor.y) / PI + 0.5;
//        float mapValue = texture(u_texture, vec2(u_lon, v_lat)).r;

        // 3. 使用你的 mappingUV 映射到二维
        vec2 st = mappingUV(nor);

        // 4. 制作点阵
        // st.x 是经度 (0-1)，st.y 是纬度 (0-1)
        // 我们在经度方向分 30 份，纬度方向分 15 份
        vec2 grid = vec2(60.0, 30.0);
        vec2 ipos = floor(st * grid);// 单元格 ID
        vec2 fpos = fract(st * grid);// 单元格内坐标 (0-1)

        // 在每个格子里画一个圆点
        float dist = distance(fpos, vec2(0.5));
        float dotMask = smoothstep(0.1, 0.09, dist);


        // 5. 颜色输出
        outColor = vec4(vec3(dotMask), 1.0);

    } else {
        outColor = vec4(vec3(0.141), 1.0);
    }
}
</code></pre>
<p>这个点阵的实现是根据经纬度均分排列所以我们能看到在南北极的区域点特别密集，在赤道上就会比较稀疏！</p>
<h3 data-id="heading-5">4.实现一个点阵地球</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39f839544caf4e8180d805db64a289dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5q2m6Zq-6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597980&amp;x-signature=H2bjfBHRP9FX2X11v3E0FVyDLQw%3D" alt="04" loading="lazy"/></p>
<pre><code class="hljs language-glsl" lang="glsl">        ...
        ...
        // 3. 使用你的 mappingUV 映射到二维
        vec2 st = mappingUV(nor);

        // 4. 制作点阵
        // st.x 是经度 (0-1)，st.y 是纬度 (0-1)
        // 我们在经度方向分 30 份，纬度方向分 15 份
        vec2 grid = vec2(60.0, 30.0);
        vec2 ipos = floor(st * grid);// 单元格 ID
        vec2 fpos = fract(st * grid);// 单元格内坐标 (0-1)

        // 在每个格子里画一个圆点
        float dist = distance(fpos, vec2(0.5));
        float dotMask = smoothstep(0.1, 0.09, dist);
        float mapValue = texture(u_texture, st).r;


        // 5. 颜色输出
        outColor = vec4(vec3(dotMask * mapValue), 1.0);
</code></pre>
<p><code>dotMask * mapValue</code>因为步骤2我们的纹理贴图是<strong>0</strong>或者<strong>1</strong>，步骤3我们的点阵也是<strong>0</strong>或者<strong>1</strong>，所以二者相乘我们就得到了一个最简单的点阵地球！同时大家应该还记得我们用的贴图是一个<code>1280 × 712</code>大小<code>95KB</code>的纹理贴图，但是我们其实只需要纹理中的<strong>0</strong>或者<strong>1</strong>的色值！所以我们替换一张<code>1KB</code>的纹理看看效果！
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccc3f6efeb5f429685a37f95f89897da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5q2m6Zq-6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597980&amp;x-signature=hQZu6NWWw1GWQhxeTB7xA4RfwIE%3D" alt="05" loading="lazy"/></p>
<p>效果肉眼基本看不出差别！这也是<code>Cobe</code>这个库只有<code>5KB</code>大小的一个核心</p>
<h3 data-id="heading-6">5.斐波那契点阵</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d732c950b40f48ffa68ac81cb0be4f06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5q2m6Zq-6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597980&amp;x-signature=LAAxvxo%2FmpS%2FZgvmsyP61kZwGLA%3D" alt="06" loading="lazy"/></p>
<p>步骤3的时候我们的点阵方案采用的是经纬度均分，但是步骤3的方案很明显有一个缺点是南极北极的点特别密集集中而赤道的点会相对稀疏，所以我们应该采用<code>斐波那契数列生成的点</code>！关于斐波那契数列有一下资料可以参考</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fobservablehq.com%2F%40mbostock%2Fspherical-fibonacci-lattice" target="_blank" title="https://observablehq.com/@mbostock/spherical-fibonacci-lattice" ref="nofollow noopener noreferrer">Spherical Fibonacci Lattice</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.shadertoy.com%2Fview%2FlllXz4" target="_blank" title="https://www.shadertoy.com/view/lllXz4" ref="nofollow noopener noreferrer">Inverse Spherical Fibonacci </a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdl.acm.org%2Fdoi%2F10.1145%2F2816795.2818131" target="_blank" title="https://dl.acm.org/doi/10.1145/2816795.2818131" ref="nofollow noopener noreferrer">Spherical fibonacci mapping</a></li>
</ul>
<p>总结一下斐波那契数列的特点</p>
<blockquote>
<p>在 3D 图形学中，要生成这些点，通常使用以下公式：高度（垂直方向）：将球体的高度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[-1, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span> 均匀分成 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 份。角度（水平旋转）：每个点相对于上一个点旋转一个黄金角度。黄金角度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><mn>137.</mn><msup><mn>5</mn><mo>∘</mo></msup></mrow><annotation encoding="application/x-tex">\approx 137.5^\circ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4831em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6741em;"/><span class="mord">137.</span><span class="mord"><span class="mord">5</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6741em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∘</span></span></span></span></span></span></span></span></span></span></span></span>，即 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>π</mi><mo>⋅</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msup><mi>ϕ</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">2\pi \cdot (1 - \phi^{-1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi></mrow><annotation encoding="application/x-tex">\phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">ϕ</span></span></span></span></span> 是黄金分割比。这样分布的点，既不会在极点堆积，也不会在赤道稀疏，视觉上极其平衡。</p>
</blockquote>
<p>其实我之前的<a href="https://juejin.cn/post/7440840299759747081" target="_blank" title="https://juejin.cn/post/7440840299759747081">纯CSS实现Soul星球</a>也是对于<code>斐波那契数列</code>的运用，但是我们的目标是在<code>shader</code>中使用，这就涉及到<code>shader</code>的特性了，是同时计算点的位置和颜色而不是通过循环计算生成，但是关于<code>斐波那契数列</code>是没有一个简单的逆向计算公式的！所以这里采用的是<a href="https://link.juejin.cn?target=https%3A%2F%2Fdl.acm.org%2Fdoi%2F10.1145%2F2816795.2818131" target="_blank" title="https://dl.acm.org/doi/10.1145/2816795.2818131" ref="nofollow noopener noreferrer">Spherical fibonacci mapping</a>提出的计算方法。</p>
<ol>
<li>先估算当前点在整个<code>斐波那契数列</code>中的维度k</li>
<li>计算格网坐标 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span></span></span></span></span>，也就是<code>斐波那契数列</code>形成的<strong>倾斜网格</strong></li>
<li>小范围遍历（检查格子周围的 4 个点）</li>
</ol>
<pre><code class="hljs language-glsl" lang="glsl">/**
 * 基于斐波那契点阵的快速最近邻搜索
 * p: 输入的球面采样方向（单位向量）
 * m: 输出参数，记录到最近点的距离
 * 返回值: 距离输入点 p 最近的斐波那契点的 3D 坐标
 */
vec3 nearestFibonacciLattice(vec3 p, out float m) {
    // 1. 坐标系转换：将常见的 y-up 转换成 z-up 逻辑进行内部计算
    p = p.xzy;

    // 2. 自适应层级计算：根据当前点的纬度（p.z）决定搜索密度
    // sqrt5, dots, PI 等常数决定了点阵的总规模
    float k = max(2., floor(log2(sqrt5 * dots * PI * (1. - p.z * p.z)) * byLogPhiPlusOne));

    // 3. 构造斐波那契网格的基向量 (Basis Vectors)
    // 利用黄金分割比 kPhi 的幂次来定位该层级的格网结构
    vec2 f = floor(pow(kPhi, k)/sqrt5*vec2(1, kPhi)+.5);
    vec2 br1 = fract((f+1.) * phiMinusOne)*kTau - twoPiOnPhi;
    vec2 br2 = -2.*f;
    
    // 4. 将球面坐标转为简单的 2D 极坐标表示 (方位角 theta, 高度 h)
    vec2 sp = vec2(atan(p.y, p.x), p.z-1.);
    
    // 5. 逆矩阵变换：通过矩阵运算，直接推算出目标点在斐波那契网格中的“格子坐标” c
    // 这样就不用遍历几千个点，而是直接锁定目标所在的局部区域
    vec2 c = floor(vec2(br2.y * sp.x - br1.y * (sp.y * dots + 1.), -br2.x * sp.x + br1.x * (sp.y * dots + 1.)) / (br1.x*br2.y-br2.x*br1.y));

    float mindist = PI; // 初始化最小距离为最大可能值
    vec3 minip;

    // 6. 局部 4 邻域搜索：检查目标格子周围的 4 个候选点
    for (float s = 0.; s &lt; 4.; s+=1.) {
        vec2 o = vec2(mod(s, 2.), floor(s*.5)); // 生成偏移量 (0,0), (1,0), (0,1), (1,1)
        float idx = dot(f, c + o);            // 根据网格坐标计算出该点的唯一索引 idx
        if (idx &gt; dots) continue;             // 超过总点数则跳过

        // --- 核心优化：快速计算经度 (Theta) ---
        // 下面这一长串 if 实际上是在对 idx 进行二进制拆解，计算黄金序列的分数值
        // 这是一种为了避免浮点精度丢失而手动实现的快速计算方法
        float tidx = idx;
        float fracV = 0.;

        ...
        ...

        float theta = fract(fracV) * kTau; // 最终得到该索引对应的旋转角度

        // 7. 还原候选点的 3D 坐标
        float cosphi = 1. - 2. * idx * byDots;        // 映射到 Z 轴 [-1, 1]
        float sinphi = sqrt(1. - cosphi * cosphi);    // 根据勾股定理计算水平半径
        vec3 sample2 = vec3(cos(theta) * sinphi, sin(theta) * sinphi, cosphi);

        // 8. 距离判定
        float dist = length(p - sample2);
        if (dist &lt; mindist) {
            mindist = dist; // 更新最小距离
            minip = sample2; // 记录最近的点
        }
    }

    m = mindist; // 将距离存入输出变量
    return minip.xzy; // 转回原坐标系方向并返回结果
}
</code></pre>
<p>有了<code>nearestFibonacciLattice</code>方法之后我们就可以替换掉之前的<code>mappingUV</code>方法</p>
<pre><code class="hljs language-glsl" lang="glsl">void main() {
    vec2 uv = gl_FragCoord.xy / u_resolution.xy;
    float aspect = u_resolution.x / u_resolution.y;
    vec2 p = uv * 2. - 1.;
    p.x *= aspect;

    float r = 0.5;
    // p.x * p.x + p.y * p.y
    float d2 = dot(p, p);

    if (d2 &lt; r * r) {

        // 1. 计算球面上该点的法线 (nor)
        // 在正交投影下，z = sqrt(r^2 - x^2 - y^2)
        float z = sqrt(r * r - d2);
        vec3 nor = normalize(vec3(p.x, p.y, z));

        // 2. 让球转动起来，方便观察两极
        nor = rotateY(u_time * 0.5) * rotateX(u_time * 0.3) * nor;


        // float u_lon = atan(nor.x, nor.z) / (2.0 * PI) + 0.5;
        // float v_lat = asin(nor.y) / PI + 0.5;
        // float mapValue = texture(u_texture, vec2(u_lon, v_lat)).r;

        float dis;
        vec3 gP = nearestFibonacciLattice(nor, dis);

        float gPhi = asin(gP.y);
        float gTheta = atan(gP.z, gP.x);
        vec2 dotUV = vec2(0.5 + gTheta / kTau, 0.5 + gPhi / PI);
        float isOnLand = step(0.45, texture(u_texture, dotUV).r);


        float v = smoothstep(.008, .0, dis);

        outColor = vec4(vec3(v * isOnLand), 1.0);

    } else {
        outColor = vec4(vec3(0.141), 1.0);
    }
}
</code></pre>
<h3 data-id="heading-7">6.优化整体效果</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/befe1b5f24c84fdeaf2695faf505a963~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5q2m6Zq-6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770597980&amp;x-signature=5gvMHZifa%2F%2FVP8r4XvECwD3Us30%3D" alt="07" loading="lazy"/></p>
<p>现在我们的点阵已经改为了<code>斐波那契数列</code>实现解决了南极北极点过于密集的问题，但是此时我们还是可以发先球体在旋转的过程边缘的地方还是会产生一些类似摩尔纹的效果，所以我们在边缘的地方实现一下<code>菲涅尔</code>效果，同时添加一下<code>光照</code>计算</p>
<pre><code class="hljs language-glsl" lang="glsl">void main() {
    vec2 uv = gl_FragCoord.xy / u_resolution.xy;
    float aspect = u_resolution.x / u_resolution.y;
    vec2 p = uv * 2. - 1.;
    p.x *= aspect;

    float r = 0.5;
    // p.x * p.x + p.y * p.y
    float d2 = dot(p, p);

    float glowFactor = 0.;
    vec4 color = vec4(0);
    float l = dot(p, p);
    float rSquared = r * r;

    if (d2 &lt; r * r) {

        // 1. 计算球面上该点的法线 (nor)
        // 在正交投影下，z = sqrt(r^2 - x^2 - y^2)
        float z = sqrt(r * r - d2);
        vec3 nor = normalize(vec3(p.x, p.y, z));
        vec3 rawNor = normalize(vec3(p.x, p.y, z));

        // 2. 让球转动起来，方便观察两极
        nor = rotateY(u_time * 0.5) * rotateX(u_time * 0.3) * nor;

        vec4 layer = vec4(0);
        vec3 light = vec3(0, 0, 1);
        float dotNL = dot(rawNor, light);


        // float u_lon = atan(nor.x, nor.z) / (2.0 * PI) + 0.5;
        // float v_lat = asin(nor.y) / PI + 0.5;
        // float mapValue = texture(u_texture, vec2(u_lon, v_lat)).r;

        float dis;
        vec3 gP = nearestFibonacciLattice(nor, dis);

        float gPhi = asin(gP.y);
        float gTheta = atan(gP.z, gP.x);
        vec2 dotUV = vec2(0.5 + gTheta / kTau, 0.5 + gPhi / PI);
        float mapColor = step(0.5, texture(u_texture, dotUV).r);
        float v = smoothstep(.008, .0, dis);


        float lighting = pow(dotNL, 3.0)*dotsBrightness;
        float sample2 = mapColor * v * lighting;
        float colorFactor = mix((1. - sample2) * pow(dotNL, .4), sample2, dark) + .1;
        layer += vec4(baseColor * colorFactor, 1.);


        layer.xyz += pow(1. - dotNL, 4.) * glowColor;

        color += layer * (1. + opacity) * .5;

        glowFactor = pow(dot(normalize(vec3(-uv, sqrt(1.- l))), vec3(0, 0, 1)), 4.) * smoothstep(0., 1., .2/(l-rSquared));
        

    } else {
        float outD = sqrt(.2/(l - rSquared));
        glowFactor = smoothstep(0.5, 1., outD / (outD + 1.));
    }
    outColor = color + vec4(glowFactor * glowColor, glowFactor);
}
</code></pre>
<p>光照的核心部分就是计算点阵的颜色以及基础色和最后的扩散的颜色~</p>
<h3 data-id="heading-8">结束语</h3>
<p>最近有些懒惰了，更新博客也不勤快了！希望2026年能坚持下去</p>
<h3 data-id="heading-9">参考资料</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshuding%2Fcobe" target="_blank" title="https://github.com/shuding/cobe" ref="nofollow noopener noreferrer">Cobe</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fobservablehq.com%2F%40mbostock%2Fspherical-fibonacci-lattice" target="_blank" title="https://observablehq.com/@mbostock/spherical-fibonacci-lattice" ref="nofollow noopener noreferrer">Spherical Fibonacci Lattice</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.shadertoy.com%2Fview%2FlllXz4" target="_blank" title="https://www.shadertoy.com/view/lllXz4" ref="nofollow noopener noreferrer">Inverse Spherical Fibonacci </a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdl.acm.org%2Fdoi%2F10.1145%2F2816795.2818131" target="_blank" title="https://dl.acm.org/doi/10.1145/2816795.2818131" ref="nofollow noopener noreferrer">Spherical fibonacci mapping</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小伙伴们心心念念的倒水解谜游戏实战，终于来了...]]></title>    <link>https://juejin.cn/post/7601313474720153635</link>    <guid>https://juejin.cn/post/7601313474720153635</guid>    <pubDate>2026-02-02T00:48:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601313474720153635" data-draft-id="7601313474720137251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小伙伴们心心念念的倒水解谜游戏实战，终于来了..."/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-02T00:48:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亿元程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1972988307323236"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小伙伴们心心念念的倒水解谜游戏实战，终于来了...
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972988307323236/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亿元程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T00:48:34.000Z" title="Mon Feb 02 2026 00:48:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29de9e6a984a4a4aa4df459288678379~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=G%2FXNaaGLi4TdRAs8FfKrk0gG4GI%3D" alt="我倒我倒我倒倒倒" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p><strong>哈喽大家好</strong>，我是亿元程序员。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf088b4ce51345908d692577786c920c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=PnIKqmnheiGfbJyT7VvFI9iaTDs%3D" alt="亿元Cocos小游戏实战合集" loading="lazy"/></p>
<p><strong>笔者的</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFOi5gCiGzF3LnT03DpPMXA" target="_blank" title="https://mp.weixin.qq.com/s/FOi5gCiGzF3LnT03DpPMXA" ref="nofollow noopener noreferrer">《亿元Cocos小游戏实战合集》</a>，从更新的第一天开始，就有许多小伙伴问到，什么时候更新一期倒水解谜的游戏实战？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab9e7c3d6748450fa7490c5ffb4454cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=hKLeTWubroIfDcCYpjau81otyMo%3D" alt="快更新，别逼我催你" loading="lazy"/></p>
<p><strong>其实</strong>笔者早有计划，再加上小伙伴们的强烈需求，这一期，<strong>小伙伴们心心念念的倒水解谜游戏实战，终于来了...</strong></p>
<p><strong>言归正传</strong>，本期带大家一起来看看，在<code>Cocos</code>游戏开发中，<strong>倒水解谜游戏的核心部分</strong>，并加入到我的<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFOi5gCiGzF3LnT03DpPMXA" target="_blank" title="https://mp.weixin.qq.com/s/FOi5gCiGzF3LnT03DpPMXA" ref="nofollow noopener noreferrer">《亿元Cocos小游戏实战合集》</a>中去。</p>
<p><strong>本文源工程可在文末获取，小伙伴们自行前往。</strong></p>
<h2 data-id="heading-1">什么是倒水解谜游戏？</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f0be8ff2226494b8fa12c8dc1dfb1aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=ODNeeAjVtQJarPM5ApbihZKQ2Lc%3D" alt="简单易上手，看了就想玩" loading="lazy"/></p>
<p><strong>可能</strong>有很多小伙伴还不知道这类游戏，简单介绍一下:</p>
<blockquote>
<p><strong>倒水解谜游戏</strong>是一类以 “倒水 / 液体转移” 为核心玩法的休闲益智游戏。</p>
<p><strong>玩家</strong>需通过容器间的倾倒操作达成特定目标（如液体颜色统一、精确容量分配），核心考验逻辑推理与步骤规划能力。</p>
</blockquote>
<p><strong>通俗</strong>的理解，和我们在学校时，通过水杯倒来倒去得到指定毫升数的水相类似(<strong>瞎掰的</strong>)。</p>
<p><strong>既然是倒水游戏，水是重要的一个游戏元素，那它是怎么实现的呢？</strong></p>
<h2 data-id="heading-2">水的效果</h2>
<p><strong>关于</strong>水的效果，其实有比较多的实现方法，既可以通过美术妹子实现，也可以通过<code>Shader</code>实现，甚至还能用<code>Graphics</code>组件画！</p>
<blockquote>
<p><strong>美术妹子:</strong> “一边凉快去。”</p>
</blockquote>
<p><strong>既然</strong>上面的方法行不通，我们只能通过<code>Shader</code>来实现了，至于<code>Graphics</code>，小伙伴们可以自行挑战一下。</p>
<p><strong>1. 资源准备</strong></p>
<p><strong>简单准备</strong>一张杯子形状的图片和对应杯子形状纯白<code>Mask</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf71a45c8ac64d048d31b17177d08ba4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=CDO4xmo1DmheVfBf6HE5B1oALYY%3D" alt="铁粉友情助攻" loading="lazy"/></p>
<p><strong>简单</strong>拼一下<code>UI</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa6d2bff3d1a4af5844bc33ae90ebab4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=pL%2B8RNzG3FL4ZXL2lZDaFU%2B5sz8%3D" alt="最喜欢拼UI了，没有之一" loading="lazy"/></p>
<p><strong>通过</strong>资源管理器通过<code>右键-&gt;创建-&gt;传统无光照着色器(Effect)</code>创建一个<code>Shader</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03680798a0fd4b14ad594d52a0f49c5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=tNcoUZQbyFJdUKZM%2FJTT0Lrjazw%3D" alt="手把手" loading="lazy"/></p>
<p><strong>和上面一样</strong>创建一个材质，将对应的<code>Effect</code>改成我们自己创建的并且勾选<code>USE_TEXTURE</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e23eb2a414ea4f4980dcb44325ccc9ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=7%2FVEsals2pdHg6fl%2FDN2mKyJr9w%3D" alt="脚把脚" loading="lazy"/></p>
<p><strong>然后</strong>把材质拖到我们杯子的<code>Mask</code>的<code>Sprite</code>上，实际要在代码中动态创建，不然会共用同一个材质。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e376e6f4dccd4daf99923ed0e00f58b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=lWBqdDcx6qz07mCY%2BnjSlIEZW00%3D" alt="演示用" loading="lazy"/></p>
<p><strong>2. 水的颜色</strong></p>
<p><strong>搜索</strong><code>sprite</code>找到<code>builtin-sprite</code>，双击打开把内容复制到我们创建的<code>Shader</code>中去当做模板。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e71416a7877e4116a6f69e2b2b0e2ac2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=u8UpHItdjW3riX77udfCOfbTv0c%3D" alt="" loading="lazy"/></p>
<p><strong>想要修改</strong>水的颜色，我们可以找到最下面的片段着色器，将<code>color</code>改成红色<code>vec4(1,0,0,1);</code>，分别对应<code>RGBA</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/367df1ec96394ccfb82a6760e4cc8b4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=BvNTWo8kiKf30hP8culPvtrlrOk%3D" alt="硬编码" loading="lazy"/></p>
<p><strong>效果如下：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/295c29b774e648e6a829aa683040c3b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=O6Q%2F1vQyutTWAlgWwqw2TRv%2FOpY%3D" alt="火红的烧杯" loading="lazy"/></p>
<p><strong>3. 水的分层</strong></p>
<p><strong>想要实现</strong>水的分层，我们可以通过简单<code>UV</code>划分，下半部分为蓝色，上半部分为红色，实际项目可以通过实际水的高度去划分。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0238e81c8e8d4e0c9673093ee235a6d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=68cFqdwS2etEZs3ewyihOhoViHM%3D" alt="还是硬编码" loading="lazy"/></p>
<p><strong>效果如下：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/925c4eb260814533b72413501194dbaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=wgp2S%2FCssA04nH45Ky5hhOTGktE%3D" alt="自古红蓝出CP" loading="lazy"/></p>
<p><strong>4. 水的波纹</strong></p>
<p><strong>水倒下时</strong>，会在杯子中形成波纹，我们可以通过下面的公式来实现。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50f60e03f62140e0b31544c2eb4996a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=%2BdYMAjEHuFnB6qremfz6cZt%2BNBw%3D" alt="非必要情况下别记" loading="lazy"/></p>
<p><strong>测试Shader</strong>如下，当<code>UV</code>高于指定高度时，形成波纹。使用<code>cc_time</code>时，需要在片段开始时引入<code>#include &lt;cc-global&gt;</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4a575f1f74f41cdadb3155d90130059~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=x9aGLPekg1KQ6zDMjYH582kAs88%3D" alt="依旧是硬编码" loading="lazy"/></p>
<p><strong>效果如下：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc3e7ceea1eb4ee58554b22e2782a64b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=IhjzVt09G2FF0HSolUqJ63mDDrk%3D" alt="火辣辣的波纹" loading="lazy"/></p>
<p><strong>5. 水的倾斜</strong></p>
<p><strong>水的倾斜</strong>可以通过下面的函数进行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48606754b5364293a23a049aed96f7c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=aRBZDVlrw6oqdSMoPT2wXnD8vqs%3D" alt="AI一个接一个不吱声" loading="lazy"/></p>
<p><strong>效果如下：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b637f2323bee4affb877df0d24d7489a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=yeMrkQHCZrTtixGIT4upXUYxlJQ%3D" alt="还真有效果" loading="lazy"/></p>
<p><strong>相信</strong>通过上面的内容，大家都已经学会了如何在<code>Shader</code>中模拟水的效果。</p>
<p><strong>那我们要怎么样在实际游戏中进行通过代码控制动态结合呢？</strong></p>
<h2 data-id="heading-3">动态传值到Shader</h2>
<p><strong>想要</strong>通过代码动态传值到<code>Shader</code>，我们通常要通过以下几个步骤。</p>
<p><strong>1.Properties</strong></p>
<blockquote>
<p><strong>properties</strong>用于将<code>Shader</code>中定义的<code>uniform</code>进行别名映射。</p>
<p><strong>这个映射</strong>可以是某个<code>uniform</code>的完整映射，也可以是具体某个分量的映射（使用<code>target</code>参数）。</p>
</blockquote>
<p><strong>代码示例如下，</strong><code>colors</code>和<code>heights</code>可以传<code>vec4</code>数组，<code>iResult</code>是<code>vec2</code>，其余是数值。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/848fcd802eac4d1c995752d86dd5a4cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=LANbMk6hm3pO99gyHjGXmSR7%2FD0%3D" alt="很简单的" loading="lazy"/></p>
<p><strong>2.uniform</strong></p>
<p><strong>uniform</strong>是<code>GLSL</code>中的关键字，声明的变量表示全局统一变量:</p>
<ul>
<li>
<p><strong>它的值</strong>在一次绘制调用中保持不变（对所有像素 / 顶点都相同）。</p>
</li>
<li>
<p><strong>可以从</strong><code>CPU</code>端（游戏逻辑代码）直接赋值，<code>GPU</code>端（着色器）只读。</p>
</li>
<li>
<p><strong>常用于</strong>传递动态参数（如颜色、角度、纹理等）。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9226353ddc3048c3b8b196069663c573~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=IMwen5uFDf0ULJ0AqRoRtPqaKAM%3D" alt="一一对应" loading="lazy"/></p>
<p><strong>3.setProperty</strong></p>
<p><strong>在TypeScript中</strong>可以使用<code>Material</code>类的<code>setProperty</code>方法进行设置，代码示例如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbdd1e18e2a74f7e83e89bf901d04467~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=Isf3Ov3nozgDzXcWSY4fZKSOXP4%3D" alt="这应该是很熟悉了吧" loading="lazy"/></p>
<p><strong>4.使用</strong></p>
<p><strong>完成</strong>上述步骤后，可以直接使用，非常简单。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e93b8a3929543e694f2c3f65ee6cbbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=cdLdOMskN3LirW0MogtyuDrUOdg%3D" alt="使用很简单" loading="lazy"/></p>
<p><strong>以上</strong>就是倒水解谜游戏的核心部分，其余简单的代码逻辑由于篇幅问题就不再赘述，可以通过源码查看。</p>
<p><strong>相信小伙伴们学废之后，可以完成到下面的效果。</strong></p>
<h2 data-id="heading-4">效果演示</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e9221acb85744e0991287e295114077~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770598115&amp;x-signature=5poLf1I0EM4Ui2PnlvZCFr1qbzY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">结语</h2>
<p>**那么问题来了，**倒水解谜类游戏已经过去了这么久，其变种依旧非常火爆。</p>
<p><strong>小伙伴们知道为什么吗？</strong></p>
<p>本文<strong>实战完整源码</strong>已集成到<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFOi5gCiGzF3LnT03DpPMXA" target="_blank" title="https://mp.weixin.qq.com/s/FOi5gCiGzF3LnT03DpPMXA" ref="nofollow noopener noreferrer">亿元Cocos小游戏实战合集（6/10）</a>，内含体验链接，有疑问笔者手把手讲解。</p>
<hr/>
<p><strong>我是"亿元程序员"，一位有着8年游戏行业经验的主程。在游戏开发中，希望能给到您帮助, 也希望通过您能帮助到大家。</strong></p>
<p>AD:笔者线上的小游戏《打螺丝闯关》《贪吃蛇掌机经典》《重力迷宫球》《填色之旅》《方块掌机经典》大家可以自行点击搜索体验。</p>
<p>实不相瞒，想要个<strong>赞</strong>和<strong>爱心</strong>！请把该文章<strong>分享</strong>给你觉得有需要的其他小伙伴。谢谢！</p>
<p>推荐文章：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFOi5gCiGzF3LnT03DpPMXA" target="_blank" title="https://mp.weixin.qq.com/s/FOi5gCiGzF3LnT03DpPMXA" ref="nofollow noopener noreferrer">亿元Cocos小游戏实战合集</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FXLCknL3fJDubec2GW6KLFA" target="_blank" title="https://mp.weixin.qq.com/s/XLCknL3fJDubec2GW6KLFA" ref="nofollow noopener noreferrer">Cocos游戏如何接入安卓穿山甲广告变现？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F3_VrSld4KnDKY_7hxjSoKg" target="_blank" title="https://mp.weixin.qq.com/s/3_VrSld4KnDKY_7hxjSoKg" ref="nofollow noopener noreferrer">你知道和不知道的微信小游戏常用API整理，赶紧收藏用起来~</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0Lj24VHJ-pL8z82hHqQLiA" target="_blank" title="https://mp.weixin.qq.com/s/0Lj24VHJ-pL8z82hHqQLiA" ref="nofollow noopener noreferrer">Cocos游戏如何快速接入抖音小游戏广告变现？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZ7DusUJA2v1IFZDFtBsueg" target="_blank" title="https://mp.weixin.qq.com/s/Z7DusUJA2v1IFZDFtBsueg" ref="nofollow noopener noreferrer">如何在CocosCreator3.8中实现割绳子游戏效果</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F3BzzFBzeVAO-a6LPTeFTrA" target="_blank" title="https://mp.weixin.qq.com/s/3BzzFBzeVAO-a6LPTeFTrA" ref="nofollow noopener noreferrer">如何在CocosCreator3.8中实现动态切割模型？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZIph332u_r24OTY4r6_jow" target="_blank" title="https://mp.weixin.qq.com/s/ZIph332u_r24OTY4r6_jow" ref="nofollow noopener noreferrer">Cocos游戏开发中的贴花效果</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解密Prompt系列68. 告别逐词蹦字 - 重塑 Transformer 的推理范式]]></title>    <link>https://juejin.cn/post/7601313474720071715</link>    <guid>https://juejin.cn/post/7601313474720071715</guid>    <pubDate>2026-02-01T23:43:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601313474720071715" data-draft-id="7601313474720055331" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解密Prompt系列68. 告别逐词蹦字 - 重塑 Transformer 的推理范式"/> <meta itemprop="keywords" content="NLP,LLM"/> <meta itemprop="datePublished" content="2026-02-01T23:43:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风雨中的小七"/> <meta itemprop="url" content="https://juejin.cn/user/3060648218472728"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解密Prompt系列68. 告别逐词蹦字 - 重塑 Transformer 的推理范式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3060648218472728/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风雨中的小七
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T23:43:01.000Z" title="Sun Feb 01 2026 23:43:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Transformer 的核心范式一直是“Next Token Prediction”——像接龙一样，一个词一个词地往后蹦。虽然 OpenAI o1 和 DeepSeek-R1 通过 Chain of Thought (CoT) 开启了“慢思考”时代，但其本质依然是通过生成更多的显性 Token 来换取计算时间。</p>
<p>这就带来了一个巨大的效率悖论：为了想得深，必须说得多。这一章我们看四篇极具代表性的论文（Huginn, COCONUT, TRM, TiDAR），它们不约而同地试图打破这一局限：能否在不输出废话的情况下，让模型在内部“空转”思考？ 甚至打破自回归的束缚，进行全局规划？</p>
<h2 data-id="heading-0">Hugin：内生循环思考提升深度</h2>
<blockquote>
<ul>
<li>Scaling up Test-Time Compute with Latent Reasoning: A Recurrent Depth Approach</li>
</ul>
</blockquote>
<p>这篇论文的核心在于打破大模型推理时计算量恒定的限制，提出了一种在“深度”上进行循环的架构，从而实现了在**隐空间（Latent Space）**进行递归推理。</p>
<h3 data-id="heading-1">🚨 核心痛点：固定计算图与动态难度的矛盾</h3>
<p>传统的 LLM 一旦训练完成，其层数（Depth）是固定的。这意味着无论输入是简单的“1+1”还是复杂的数学证明，模型在生成每一个 Token 时消耗的 FLOPs是一样的 。这显然不符合直觉——难题应该需要更多的“思考时间”。因此我们有了COT和现在的Reasoning模式。</p>
<ul>
<li>现状：为了处理难题，现在的 CoT 策略不得不强迫模型“自言自语”生成大量 Token，这导致了显存（KV Cache）的爆炸式增长和推理速度的线性下降。</li>
<li>目标：能否让模型在内部“停下来想一会儿”，但不占用输出带宽？</li>
</ul>
<h3 data-id="heading-2">🛠️解决方案：循环深度架构</h3>
<p>Huginn 提出了一种特殊的架构设计，试图在 Transformer 中原生实现“慢思考”。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1db7f033e6d4217822fa65f43f8958b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770594181&amp;x-signature=W004fH%2BFVffvwz0avwbJG0JkXaE%3D" alt="image" loading="lazy"/></p>
<p>如上图，模型包括三个部分</p>
<ul>
<li>（P）Prelude: 相当于Encoder层，负责将 Input Token 映射为隐状态。</li>
<li>（R）recurrent block: 这是一个多层Transformer Layer，所有的思考都发生在这里，但是和传统Transformer不同的点在于，这个模块可以循环运行任意次。</li>
<li>（C）Coda：相当于输出头，对思考完成的隐状态进行token解码生成。</li>
</ul>
<p><strong>这本质上是“层参数共享”的极致应用</strong>。 模型通过动态决定 R 模块循环的次数，实现了在参数量不变的情况下，动态调整推理时的计算深度。为了防止深层循环导致的梯度消失或遗忘，模型在每一步循环都会注入原始输入的 Embedding，起到锚点（Anchor）的作用。</p>
<h3 data-id="heading-3">💡 深度洞察</h3>
<ol>
<li>
<p><strong>高效推理</strong>：递归模块不产生线性增长的KV-Cache，只是不断更新递归参数</p>
</li>
<li>
<p><strong>难度自适应</strong>：可以通过控制递归的轮数来对不同难度的问题实现自适应计算，不需要对所有难度的问题进行统一的思考或者不思考</p>
</li>
<li>
<p><strong>Test Time Scaling</strong>：论文发现递归的模式同样存在Test-time scaling，更多的递归次数会带来持续的表现提升。</p>
</li>
</ol>
<h2 data-id="heading-4">COCONUT：抛弃语言，用“直觉”思考</h2>
<blockquote>
<ul>
<li>Meta： Training Large Language Models to Reason in a
Continuous Latent Space</li>
</ul>
</blockquote>
<p>如果说 Huginn 是在架构层面“折叠”了深度，那么 COCONUT则是在思维载体上进行了一次革命。它质疑了大模型推理的一个基本假设：为什么思考的过程必须用人类语言（Tokens）来表达？</p>
<h3 data-id="heading-5">🚨核心痛点：语言空间的局限性</h3>
<p>由OpenAI-O1拉开序幕的Reasoning时代，当前的推理过程一般是
：Hidden State <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> Logits <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> Sampling (Token) <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> Embedding <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> Next Input。</p>
<p>这就引入了一些局限性</p>
<ul>
<li><strong>信息丢失</strong>：将高维连续的 Hidden State 坍缩为离散的 Token，会丢失大量非结构化的“直觉”信息。就像你脑海里有大量信息，却必须用一句话说出来。</li>
<li><strong>效率低下</strong>：当CoT 中充斥着 "Let's think step by step", "Therefore" 等无意义的连接词。</li>
<li><strong>线性约束</strong>：语言是线性的，但思维往往是发散的、网状的。之前很多parrallel思考的方案都是为了打破这个约束。</li>
</ul>
<h3 data-id="heading-6">🛠️解决方案：连续思维链</h3>
<p>COCONUT 提出了一种Latent Mode。虽然架构仍基于 Transformer，但它改变了数据流转方式：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dda91c0769da4a11ae36c8989a31a7c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770594181&amp;x-signature=JP0Hz259E1y9isSfPczxxG%2FbW20%3D" alt="image" loading="lazy"/></p>
<ol>
<li><strong>推理模式：Latent Mode (隐模式)</strong></li>
</ol>
<p>Coconut 引入了一种新的推理模式。模型可以在Language Mode和Latent Mode之间切换。</p>
<p>机制：当模型进入Latent Mode后（输出&lt;bot&gt;特殊字符），它不再将 Last Hidden State 解码为 Token。而是直接将这个 Hidden State 作为下一步的 Input Embedding 喂给模型。</p>
<p>这就像是模型在“自言自语”，但是用只有它自己听得懂的“脑电波”（向量）在交流，而不是用人类语言。这种“连续思维”一直持续到模型输出&lt;eot&gt;特殊字符，然后再切回语言模式输出最终答案。</p>
<ol start="2">
<li><strong>训练策略：多阶段课程学习</strong></li>
</ol>
<p>为了让模型学会使用上述的思考向量信息，论文使用了渐进式的训练方案，如下图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f279b258d5434c7481b908437ad8be6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770594181&amp;x-signature=TSIt2bTmfbugFQ%2B09tUX8wkW1uE%3D" alt="image" loading="lazy"/></p>
<ul>
<li>Stage 0：先用标准的 CoT 数据训练模型，让它学会逻辑。</li>
<li>Stage 1 ~ k：逐步“擦除”CoT 中的文本。
<ul>
<li>例如，在 Stage 1，把 CoT 的第 1 步推理文本去掉，替换为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span></span></span></span></span> 个 Continuous Thoughts（隐向量）。模型必须学会用这 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span></span></span></span></span> 个向量来承载原本那句话的逻辑信息</li>
<li>随着训练进行，逐步把更多的文本推理步骤替换为隐向量。</li>
</ul>
</li>
<li>最终形态：所有的中间推理文本都被“内化”成了连续的隐向量，模型只输出最终答案。</li>
</ul>
<h3 data-id="heading-7">💡 深度洞察</h3>
<ol>
<li><strong>核心能力涌现：隐式 BFS (Implicit Breadth-First Search)</strong></li>
</ol>
<p>这是最精彩的发现。相比原有COT是线性的，同一时刻只能推理一个思路。但COconut因为Hidden State是高维连续向量，所以它可以处于“叠加态”,可以同时编码多个可能的推理路径。隐式进行了广度搜索。</p>
<ol start="2">
<li><strong>推理效率提升</strong></li>
</ol>
<p>虽然和Hugin相比依旧需要使用KV-cache，但因为连续向量的数量往往显著小于token数，所以推理效率会有提升，同时也因为省略了推理token采样的步骤，而进一步提升吞吐。</p>
<ol start="3">
<li><strong>超越人了语言思维密度</strong></li>
</ol>
<p>尤其对于一些复杂多路径规划任务，以及部分需要<code>look ahead</code>推理的任务，因为隐向量比token包含广度更大的思考信息，因此效果有所提升。</p>
<p>看到这里我也有个想法，逻辑上hidden thought一定会比token携带更多的信息量，但最大的问题就是无法可视化，那能否想一会，说两句，想一会说两句，也就是把hidden thought和token reasoning通过interleave串联起来？</p>
<h2 data-id="heading-8">TRM: 像改代码一样迭代推理</h2>
<blockquote>
<ul>
<li>Less is More: Recursive Reasoning with Tiny Networks</li>
</ul>
</blockquote>
<p>TRM和前面的Hugin是非常相似的，几乎都是走的“循环思维载体”的思路。但是TRM多了双流递归的设计，把循环过程中的草稿和打磨这两个不同信息拆分开处理。</p>
<p>和COCONUT也有相似之处，只不过COCONUT更像是潜意识在时间轴上（自回归推理）的延伸，而TRM是在质量轴上的不断迭代修正。</p>
<h3 data-id="heading-9">🚨 核心痛点：自回归的“落子无悔”</h3>
<p>Reasoning最大的问题，就是前面COCONUT提到的“落子无悔”问题，想要进一步反思或者修正，就需要继续显性延伸你的思考链路进行反思。</p>
<p>论文的目标：能否构建一个模型，它的推理过程不是“生成下一个词”，而是不断修正当前的答案？这需要模型具备迭代修正的能力。</p>
<h3 data-id="heading-10">🛠️ 解决方案：TRM (Tiny Recursive Model)</h3>
<p>TRM 的架构设计非常精简，它直接回到了最本质的递归结构，如下图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da138b41f49241bc8c43f9e2340ed345~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770594181&amp;x-signature=DaBak1bO26mBbp7xg81Fi8tLy4I%3D" alt="image" loading="lazy"/></p>
<ol>
<li><strong>双流递归状态</strong></li>
</ol>
<p>TRM 维护两个核心状态，并在循环中不断更新它们 ：</p>
<ul>
<li>Latent (Z)：推理状态。这和Huginn多步递归循环的R Block类似，都是思维的载体，存储不断更新的思维上下文。</li>
<li>Prediction (Y)：当前答案的草稿。这是 TRM 最独特的地方。它把“当前的预测结果”Embedding 之后，作为下一轮的输入喂给自己。（对比Hugin所有信息都在R，TRM把已经形成的预测结果解耦出来了）</li>
</ul>
<p>推理循环逻辑 (The Loop)：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>z</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mtext>Net</mtext><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><msub><mi>y</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>z</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mspace width="1em"/><mtext>// 思考：基于当前草稿和思维，更新思维</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>y</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mtext>Net</mtext><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>z</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mspace width="1em"/><mtext>// 修改：基于新的思维，修正草稿</mtext></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
z_{t+1} &amp;= \text{Net}(x, y_t, z_t) \quad \text{// 思考：基于当前草稿和思维，更新思维} \\
y_{t+1} &amp;= \text{Net}(y_t, z_{t+1}) \quad \text{// 修改：基于新的思维，修正草稿}
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"/><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord">Net</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:1em;"/><span class="mord text"><span class="mord">// </span><span class="mord cjk_fallback">思考：基于当前草稿和思维，更新思维</span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord">Net</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:1em;"/><span class="mord text"><span class="mord">// </span><span class="mord cjk_fallback">修改：基于新的思维，修正草稿</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>这就像我们写代码：先写个大概 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">y_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>) -&gt; 脑子转一下 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">z_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>) -&gt; 改一行代码 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">y_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>) -&gt; 发现有个 Bug (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">z_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>) -&gt; 再改一行 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">y_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>)。</p>
<ol start="2">
<li><strong>架构极简主义</strong></li>
</ol>
<ul>
<li>Tiny Network：模型只有 2 层 Transformer Layer，参数量仅 5M - 7M</li>
<li>参数共享：同一个网络（Net）在每一次循环中被反复使用</li>
<li>全量推理模式：并非自回归模型token by token的推理，而是每一步循环都生成全量的Y，并且每一步都对全量的Y进行修正</li>
</ul>
<h3 data-id="heading-11">💡 深度洞察</h3>
<ol>
<li><strong>全量生成的思维转换</strong>：TRM 的生成方式更像 Diffusion Model（扩散模型），是从模糊到清晰的过程，而不是从左到右的过程。但这同样也约束了当前TRM只能用于固定长度内容的输出。</li>
<li><strong>Deep Supervision</strong>：训练时，TRM 并不只在最后一步计算 Loss，而是对每一步生成的草稿都计算 Loss。这强迫模型在第一步就给出一个“大致正确”的解，然后在后续步骤中精细化。</li>
</ol>
<h2 data-id="heading-12">TiDAR</h2>
<blockquote>
<ul>
<li>TiDAR: Think in Diffusion, Talk in Autoregression</li>
</ul>
</blockquote>
<p>英伟达的这篇论文，则是和TRM思路非常相像，都是在生成阶段抛弃自回归“蹦字”的方案，采用全局生成并不断打磨的思路。只不过TIDAR引入了扩散模型，并切让模型在同一个 Forward Pass（前向传播）里，既作为“起草者”并行地想，又作为“验证者”自回归地确认。</p>
<h3 data-id="heading-13">🚨 核心痛点：既要还要的困境</h3>
<p>在大模型推理中，我们一直面临一个trade-off</p>
<ul>
<li>AR：自回归模型由于符合语言的因果律，质量最高，但推理速度慢</li>
<li>Diffusion：非自回归模型可以并行生成，吞吐量极高但往往质量不佳，并且质量会随着生成的token个数而持续下降。</li>
</ul>
<p>现在已有的一些解决方案例如DeepSeek提出的MTP，同时预测多个token，也是在尝试解决以上的问题，但MTP的本质还是自回归的。</p>
<p>还有Speculative decoding，使用一个轻量级的AR模型去生成多个token的草稿，再用大模型并行对草稿的每个token进行验证，但这样就需要同时部署多个模型进行推理。</p>
<h3 data-id="heading-14">🛠️ 解决方案： Think + Talk的双流协同</h3>
<p>TiDAR 的模型结构则是在speculative Decoding的基础上，把草稿模型和验证模型合并在了一个模型结构里，通过特殊掩码实现同时推理。</p>
<ol>
<li><strong>Think in Diffusion</strong></li>
</ol>
<p>在推理时，TiDAR 并不像 GPT 那样一次只预测一个词。它使用 Diffusion的方案，在当前位置之后的K个槽位上，同时生成所有候选Token。这 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> 个 Token 是<strong>并行</strong>生成的。它利用了扩散模型的全局视野。</p>
<ol start="2">
<li><strong>Talk in Autoregression"</strong></li>
</ol>
<p>生成的这K个候选词并不能直接作为答案，因为 Diffusion 的逻辑一致性不如 AR。TiDAR 在同一个前向传播中，利用 AR 的逻辑对这K个候选词进行拒绝采样。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66a8700dc9534f46b15b75fa3943725d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770594181&amp;x-signature=rcQ%2BvxC2QH4NSSVIWfRbMfIVpQU%3D" alt="image" loading="lazy"/></p>
<ol start="3">
<li><strong>双流的核心实现：结构化注意力掩码</strong></li>
</ol>
<p>为了在一次向前推理时，同时实现以上两种推理，TIDAR设计了一个特殊的二维MASK，将序列分成了两个部分</p>
<ul>
<li>Diffusion MASK：这个区域的token直接是全连接的，为了让模型能够根据上文同时猜出后面K个词</li>
<li>AR MASK：这个区域是causal MASK，它负责根据上下文和前面猜出的草稿进行递归生成。</li>
</ul>
<p>这样在一次向前推理中，Inp亡的KV Cache会参与两次计算</p>
<ul>
<li>Input —&gt; Think Mask -&gt; Diffusion Drafts</li>
<li>Input + Diffusion Drafts -&gt; AR Mask -&gt; Final verified Token</li>
</ul>
<ol start="4">
<li><strong>多任务联合优化训练</strong></li>
</ol>
<p>为了同时训练Diffusion和AR，TIDAR在传统的NSP训练的基础上进行了改良，同时训练两个loss</p>
<ul>
<li>Diffusion Loss：训练模型在给定上下文和部分噪声的情况下，并行重构出后续 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> 个词的能力。</li>
<li>AR Loss：标准的交叉熵损失，确保模型的最终输出符合语言概率分布</li>
</ul>
<hr/>
<h2 data-id="heading-15">总结：推理的未来是“向内生长”？</h2>
<p>从以上四篇论文，我们不妨猜测下后Reasoning时代的技术演进方向</p>
<ol>
<li>从Explicit到Implicit？</li>
<li>从Linear到Recurrent？</li>
<li>从AR到Hybrid？</li>
</ol>
<p>未来的大模型，或许会变得更像人类的大脑： 表面上沉默寡言，但内心戏极其丰富，并且能够反复推敲，最终给出一个深思熟虑的答案。</p>
<p>想看更全的大模型论文·微调预训练数据·开源框架·AIGC应用 &gt;&gt; <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDSXiangLi%3Ftab%3Drepositories" target="_blank" title="https://github.com/DSXiangLi?tab=repositories" ref="nofollow noopener noreferrer">DecryPrompt</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PHP 现在可以零成本构建原生 iOS 和 Android 应用 NativePHP for Mobile v3 发布]]></title>    <link>https://juejin.cn/post/7601843004958359598</link>    <guid>https://juejin.cn/post/7601843004958359598</guid>    <pubDate>2026-02-01T23:46:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601843004958359598" data-draft-id="7601444617695608842" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PHP 现在可以零成本构建原生 iOS 和 Android 应用 NativePHP for Mobile v3 发布"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2026-02-01T23:46:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PHP 现在可以零成本构建原生 iOS 和 Android 应用 NativePHP for Mobile v3 发布
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T23:46:49.000Z" title="Sun Feb 01 2026 23:46:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PHP 现在可以零成本构建原生 iOS 和 Android 应用 NativePHP for Mobile v3 发布</h2>
<p>NativePHP for Mobile 从 v3 版本开始，核心框架采用 MIT 协议免费开源。Laravel/PHP 开发者现在可以零成本构建原生 iOS 和 Android 应用。</p>
<p>如果使用 nativePHP 开发移动应用的话，可以看<a href="https://link.juejin.cn?target=https%3A%2F%2Fnativephp-doc.catchadmin.com" target="_blank" title="https://nativephp-doc.catchadmin.com" ref="nofollow noopener noreferrer">nativephp mobile v3 中文文档</a></p>
<h3 data-id="heading-1">插件化架构</h3>
<p>v3 版本最大的变化是引入了模块化插件系统。此前版本中集成在核心包里的原生功能，现在被拆分成独立的插件。</p>
<p>每个插件都是一个独立的 Composer 包，包含 Swift 和 Kotlin 代码、权限清单以及原生依赖。开发者只需安装实际用到的插件，这些插件会在构建过程中直接编译进应用。</p>
<p>插件安装非常简单，通过 <code>composer require</code> 安装包后，在 <code>NativeServiceProvider</code> 中注册即可。只有注册的插件才会被编译进最终的二进制文件，这样可以保持应用体积精简，也有助于通过应用商店审核。</p>
<h4 data-id="heading-2">创建插件</h4>
<p>插件本质上就是 Composer 包，只是多了一些额外配置。通过添加 <code>nativephp.json</code> 文件，开发者可以定义 PHP 类、视图文件、桥接函数、原生依赖（CocoaPods、Swift Packages、Gradle）、权限声明、JavaScript 文件等。</p>
<p>NativePHP 核心提供了构建钩子、生命周期钩子、服务提供者注册等机制，让插件开发体验更加顺畅。</p>
<p>插件可以发布到 Packagist，也可以作为项目内部代码使用，无需发布到公共仓库。这意味着应用的 Laravel 代码库可以包含构建原生应用所需的一切。</p>
<h3 data-id="heading-3">免费核心</h3>
<p>新架构将核心包精简到最小化，应用只需包含实际使用的功能。这让应用默认就更小、更高效，也避免了应用商店审核时因包含未使用功能而被拒的问题。</p>
<p>NativePHP 团队将 v3 版本命名为 NativePHP Air，并将其转为 MIT 开源协议。v3 之前的版本仍然遵循原有的 Business Source License。</p>
<p>核心框架开源后，社区可以参与贡献，团队欢迎针对 iOS 和 Android 核心应用的 PR。</p>
<h4 data-id="heading-4">免费插件</h4>
<p>以下插件完全免费开源（MIT 协议）：</p>
<ul>
<li><strong>Browser</strong> - 浏览器功能</li>
<li><strong>Camera</strong> - 相机调用</li>
<li><strong>Device</strong> - 设备信息获取</li>
<li><strong>Dialog</strong> - 原生对话框</li>
<li><strong>File</strong> - 文件操作</li>
<li><strong>Microphone</strong> - 麦克风调用</li>
<li><strong>Network</strong> - 网络状态检测</li>
<li><strong>Share</strong> - 系统分享功能</li>
<li><strong>System</strong> - 系统信息</li>
</ul>
<h4 data-id="heading-5">付费插件</h4>
<p>以下功能需要单独购买插件（一次性付费，可用于无限项目）：</p>
<ul>
<li><strong>Biometrics</strong> - 生物识别（Face ID、指纹）</li>
<li><strong>Geolocation</strong> - 地理位置</li>
<li><strong>Push Notifications</strong> - 推送通知（基于 Firebase）</li>
<li><strong>Scanner</strong> - 扫描器</li>
<li><strong>Secure Storage</strong> - 安全存储</li>
</ul>
<h3 data-id="heading-6">插件市场</h3>
<p>插件市场（Plugin Marketplace）将所有 NativePHP 插件集中展示，开发者可以发现免费和付费插件。</p>
<p>未来几周，市场将向第三方开发者开放，届时开发者可以在 nativephp.com 上架自己的插件，甚至可以销售自己开发的插件。例如相机滤镜插件、支付网关集成、社交登录包等。</p>
<h3 data-id="heading-7">Jump：即时设备测试</h3>
<p>在真机上测试应用通常是一个缓慢且繁琐的过程，需要安装数 GB 的软件、模拟器和框架。而且，没有 Mac 就无法为 iPhone 构建和测试应用。</p>
<p>Jump 改变了这一切。</p>
<p>Jump 是一个安装在手机上的应用（支持 Android 和 iOS），可以在真机上测试 NativePHP 应用，无需编译任何东西，也不需要开启开发者模式。</p>
<p>只需运行 <code>native:jump</code> Artisan 命令，打开手机上的 Jump 应用扫描二维码，Laravel 应用就会直接加载到设备上，连接到本地开发服务器。</p>
<pre><code class="hljs language-shell" lang="shell">php artisan native:jump
<span class="hljs-meta prompt_">
# </span><span class="bash">或者</span>

./native jump
</code></pre>
<p>NativePHP 构建速度很快，本地开发环境的改动几乎可以实时反映到设备上。未来还计划支持完整的 HMR（热模块替换）。</p>
<p>Jump 应用完全免费，<code>nativephp/mobile</code> v3 已包含运行 Jump 所需的一切。</p>
<p>Jump 包含所有官方 NativePHP 插件（包括付费插件），开发者可以免费试用和学习所有功能。唯一的限制是 Jump 无法测试第三方插件。</p>
<h3 data-id="heading-8">Mimi：AI 辅助编码</h3>
<p>Mimi（取自北欧智慧之神 Mimir）是 NativePHP 提供的 AI 辅助编码功能，可以让 AI 模型帮助编写 NativePHP 应用：</p>
<ul>
<li>直接在浏览器中创建新的 NativePHP 项目（移动端也可以）</li>
<li>用自然语言描述想要构建的内容，支持语音输入</li>
<li>直接在 Jump 中测试应用</li>
<li>连接 GitHub 仓库，立即获取所有应用代码</li>
</ul>
<p>这是从想法到可运行移动应用的最快路径，完全基于 Laravel。</p>
<h3 data-id="heading-9">升级指南</h3>
<p>如果已经安装了 <code>nativephp/mobile</code>，升级到 v3 的步骤如下：</p>
<ol>
<li>从 <code>composer.json</code> 中移除 NativePHP 仓库（<code>https://nativephp.composer.sh</code>）</li>
<li>运行 <code>composer remove nativephp/mobile</code> 卸载旧版本</li>
<li>运行 <code>composer require nativephp/mobile</code> 从 Packagist 安装 v3</li>
<li>安装应用中使用的功能对应的插件</li>
</ol>
<p>除了注册新插件外，应用代码基本不需要修改。安装插件后可以使用以下命令注册：</p>
<pre><code class="hljs language-shell" lang="shell">php artisan native:plugin:register vendor/plugin
<span class="hljs-meta prompt_">
# </span><span class="bash">或者</span>

./native plugin:register vendor/plugin
</code></pre>
<h3 data-id="heading-10">快速开始</h3>
<p>NativePHP for Mobile v3 现已发布。在手机上安装 Jump，然后在开发环境中运行以下命令：</p>
<pre><code class="hljs language-shell" lang="shell">laravel new my-mobile-app
cd my-mobile-app
composer require nativephp/mobile
php artisan native:jump
</code></pre>
<p>这里面有几个小坑</p>
<ul>
<li>PHP 要求 <code>&gt;=8.3</code></li>
<li>在 windows 上测试，需要先安装 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.7-zip.org%2F" target="_blank" title="https://www.7-zip.org/" ref="nofollow noopener noreferrer">7-zip</a></li>
<li>我在 IOS 手机测试得，使用 <code>php artisan native:jump</code> 之后会弹出一个二维码，用手机上的 Jump 扫描即可。这个 Jump 目前只能在 <code>TestFlight</code> 上安装，打开这个<a href="https://link.juejin.cn?target=https%3A%2F%2Ftestflight.apple.com%2Fjoin%2FRuzFs4rJ" target="_blank" title="https://testflight.apple.com/join/RuzFs4rJ" ref="nofollow noopener noreferrer">安装链接</a>即可。</li>
</ul>
<p>很完美，至少从安装上到测试效果都很快了。效果图如下：</p>
<p><img src="https://image.catchadmin.com/202602011330904.png" alt="Laravel 现在可以零成本构建原生 iOS 和 Android 应用 NativePHP for Mobile v3 发布" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-02%2Fnativephp-mobile-free" target="_blank" title="https://catchadmin.com/post/2026-02/nativephp-mobile-free" ref="nofollow noopener noreferrer">原文 PHP 现在可以零成本构建原生 iOS 和 Android 应用 NativePHP for Mobile v3 发布</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 在 Android 出现随机字体裁剪？其实是图层合并时的边界计算问题]]></title>    <link>https://juejin.cn/post/7601384029611147279</link>    <guid>https://juejin.cn/post/7601384029611147279</guid>    <pubDate>2026-02-01T22:55:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601384029611147279" data-draft-id="7601384029611130895" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 在 Android 出现随机字体裁剪？其实是图层合并时的边界计算问题"/> <meta itemprop="keywords" content="前端,Flutter,Android"/> <meta itemprop="datePublished" content="2026-02-01T22:55:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 在 Android 出现随机字体裁剪？其实是图层合并时的边界计算问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T22:55:45.000Z" title="Sun Feb 01 2026 22:55:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>字体问题在 Flutter 里已经是老生常谈的 bug ，而这次要聊的是 issue <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F161721" target="_blank" title="https://github.com/flutter/flutter/issues/161721" ref="nofollow noopener noreferrer">#161721</a> 下的老问题，如下代码所示，具体问题表现为： <strong>“Text 在被 <code>Opacity</code> / <code>ShaderMask</code> 这类需要 <code>saveLayer</code> 的效果的控件包裹后，绘制缓冲层的 bounds 算的太“精细”，导致字形上下（尤其是 descender，比如 <code>g</code> 的尾巴）被裁掉”</strong> ：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> '<span class="hljs-selector-tag">package</span>:<span class="hljs-selector-tag">flutter</span>/<span class="hljs-selector-tag">material</span><span class="hljs-selector-class">.dart</span>';
​
<span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>() =&gt; <span class="hljs-selector-tag">runApp</span>(<span class="hljs-built_in">MyApp</span>());
​
<span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">MyApp</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">StatelessWidget</span> {
  <span class="hljs-variable">@override</span>
  Widget <span class="hljs-built_in">build</span>(BuildContext context) {
    <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">style</span> = <span class="hljs-selector-tag">TextStyle</span>(<span class="hljs-attribute">fontSize</span>: <span class="hljs-number">47</span>);
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">MaterialApp</span>(
      <span class="hljs-attribute">home</span>: <span class="hljs-built_in">Scaffold</span>(
        <span class="hljs-attribute">body</span>: <span class="hljs-built_in">Center</span>(
          <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Row</span>(
            <span class="hljs-attribute">mainAxisAlignment</span>: MainAxisAlignment.center,
            <span class="hljs-attribute">crossAxisAlignment</span>: CrossAxisAlignment.center,
            <span class="hljs-attribute">children</span>: [
              <span class="hljs-built_in">ShaderMask</span>(
                <span class="hljs-attribute">shaderCallback</span>: (bounds) {
                  return <span class="hljs-built_in">LinearGradient</span>(
                    <span class="hljs-attribute">colors</span>: [
                      Colors.black,
                      Colors.red,
                    ],
                  ).<span class="hljs-built_in">createShader</span>(bounds);
                },
                <span class="hljs-attribute">blendMode</span>: BlendMode.srcIn,
                <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">"g"</span>, <span class="hljs-attribute">style</span>: style),
              ),
              <span class="hljs-built_in">Opacity</span>(
                <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.9</span>,
                <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">"g"</span>, <span class="hljs-attribute">style</span>: style),
              ),
              <span class="hljs-built_in">Text</span>(<span class="hljs-string">"g"</span>, <span class="hljs-attribute">style</span>: style)
            ],
          ),
        ),
      ),
    );
  }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cb2fb281a1643fd94f4aab32ef6448d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770591345&amp;x-signature=355N%2FvodbI8qXUOpvzM2rNdl7bU%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>问题主要出现在 Android 上。</p>
</blockquote>
<p>当然，这个问题还有其他条件，他和系统还有字号也有很大关系，例如：</p>
<ul>
<li>Android（Pixel 7/8、API 34 等）可稳定复现， <code>fontSize: 47</code> 时，<code>Opacity</code> / <code>ShaderMask</code> 下的 <code>g</code> 一定会被上下裁剪</li>
<li>字号到 48 或更大裁剪消失</li>
<li>Inter variable font 在 Android/Web 也见过类似现象</li>
<li>和更古老的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F96322" target="_blank" title="https://github.com/flutter/flutter/issues/96322" ref="nofollow noopener noreferrer">#96322</a> 类似，字体在 desktop/web 裁剪/ellipsis 时底部被切掉，本质也是 “line/glyph bounds” 边界算得过“精细”</li>
</ul>
<p>实际上从下面表格可以直观看出来问题的点，在 41 和 42 的时候，字变大了，但底层算出来边界高度没变 ：</p>

























<table><thead><tr><th>fontSize</th><th>bounds height</th></tr></thead><tbody><tr><td>40</td><td>30</td></tr><tr><td>41</td><td>31</td></tr><tr><td>42</td><td>31</td></tr><tr><td>43</td><td>33</td></tr></tbody></table>
<p>那这种 bounds 高度离散跳变，那为什么会和 <code>Opacity</code> / <code>ShaderMask</code> 有关系？主要还是和 <code>saveLayer</code> 有一定关系：</p>
<ul>
<li><code>Opacity</code> 在 0/1 以外会把 child paint 到一个 intermediate buffer 再混合回去，<strong>而 <code>saveLayer(bounds, paint)</code> 时， bounds 是“裁剪边界”</strong> ，如果 bounds 只按布局尺寸/行高算，没把某些字体在某些字号下的“真实像素级溢出”算进去，就会被裁掉</li>
<li><code>ShaderMask</code> 也是通过对 child 建 layer 再用 shader+blendMode 做合成，所以它和 <code>Opacity</code> 一样，会放大任何 “layer bounds 偏小” 的问题</li>
</ul>
<p>而恰好对于 <code>g</code> 这种有 descender 的字形，底部伸出 baseline 会比较多，在叠加：</p>
<ul>
<li>字体 hinting/栅格化导致的像素对齐取整</li>
<li>行高（ascent/descent/leading）与真实 glyph 像素覆盖范围不完全一致</li>
<li>浮点到整数边界的 <code>ceil/floor</code> 差 1px</li>
</ul>
<p>就容易出现， <strong>虽然只差不到 1px，但被 layer 直接裁掉”的现象</strong> ，而字号大于 48 的时候，恰好让这些取整结果趋向正常，所以“看起来好了”。</p>
<p><img src="https://img.cdn.guoshuyu.cn/image-20260126091417382.png" alt="" loading="lazy"/></p>
<p>所以问题<strong>不是 Text 自己在 clip，而是 <code>Layer</code> 在 clip</strong> ，是 <code>SkTextBlob::bounds()</code> 过程做了裁剪导致：</p>
<ul>
<li>DisplayList 里有一个 <code>drawTextBlob</code> 命令</li>
<li><code>drawTextBlob</code> 的 bounds 来自 <code>SkTextBlob::bounds()</code></li>
<li><code>SkTextBlob::bounds()</code> 来源于 Skia/FreeType 在构建 TextBlob 时给的 glyph bounding boxes</li>
</ul>
<p>更具体的落点在于 <code>SkScalerContext_FreeType::getBoundsOfCurrentOutlineGlyph</code> ，也有人提出过猜测：</p>
<ul>
<li>
<p>Skia 有两套 bounds：</p>
<ul>
<li><strong>tight bounds</strong>：尽量紧，可能更容易切</li>
<li><strong>conservative bounds</strong>：更保守，理论上不容易切</li>
</ul>
</li>
</ul>
<p>所以是否 <code>SkTextBlobBuilder::updateForeBounds</code> 强制用 conservative bounds 就不会裁剪了？但是最后证实，在这个 case 里 <strong>TightRunBounds 和 ConservativeRunBounds 算出来是同一个矩形，也就是不是选错 bounds 类型的问题，而是“更底层给的 bounds 数据就已经偏小”</strong> 。</p>
<p>目前测试的推论，更多是猜测是是底层 <code>getBoundsOfCurrentOutlineGlyph</code> 这个 OutlineGlyph 的问题，因为</p>
<ul>
<li>
<p>bounds 来自 <code>getBoundsOfCurrentOutlineGlyph</code></p>
</li>
<li>
<p>Outline bounds 是“矢量轮廓”的边界</p>
</li>
<li>
<p><strong>但启用 hinting 后，真正被栅格化出来的像素可能会超出轮廓边界</strong></p>
<ul>
<li>hinting 会把笔画对齐到像素栅格</li>
<li>这种对齐可能产生 1px 的 overshoot（尤其是 descender、上/下 overshoot、抗锯齿 coverage）</li>
</ul>
</li>
<li>
<p>DisplayList / Opacity 拿 outline bounds 当作 layer clip bounds , 所以切掉那 1px</p>
</li>
</ul>
<blockquote>
<p>这里的 hinting 其实就是 Font Hinting ，因为字体本质是连续的矢量轮廓，像素是离散的网格，简单说就是：字体在小尺寸或特定像素网格下，对字形轮廓进行“像素级对齐和修正”的规则集合 ，目的就是让字在屏幕的离散像素网格上，看起来更清晰更锐利。</p>
</blockquote>
<p>对应到代码里的现象就是：<strong>把 <code>TextStyle::getFontHinting()</code> 强制改成始终返回 <code>SkFontHinting::kNone</code> 问题就消失了</strong> ，因为没 hinting 时，outline bounds 和实际像素覆盖范围更一致，<code>SkTextBlob::bounds()</code> 就不会低估，所以问题应该是在于：</p>
<blockquote>
<p><strong>“bounds 计算口径”和“实际绘制口径”不一致</strong>（尤其在 hinting 下），导致 <code>SkTextBlob::bounds()</code> 偏小，Opacity 的 layer clip 把溢出像素切掉。</p>
</blockquote>
<p>那有人说，拿掉 hinting 不行吗？直接粗暴拿掉还真的不行，<strong>实际上问题的核心不是 hinting ，而是底层算的不准</strong>，如果直接拿掉 hinting ，就可能会出现以前在 Android Compose 上类似这样的情况：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4e042aeb74e48c987860bf488f4129c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770591345&amp;x-signature=%2FM2NMQyZY0nhq2b8IOiXIqD%2BzPY%3D" alt="" loading="lazy"/></p>
<p>所以实际问题本质在于：<strong>Skia 在 FreeType 后端中使用了 glyph 的 outline bounds 作为 TextBlob bounds，而在 hinting 开启时，这种 bounds 并不能代表真实像素覆盖范围</strong>。</p>
<blockquote>
<p>说人话就是： Skia 在构建 TextBlob 时，从 FreeType 拿到的 glyph bounds 本身就偏小，<code>SkScalerContext_FreeType::getBoundsOfCurrentOutlineGlyph</code> 。</p>
</blockquote>
<p>那么又有人要问了，Flutter 不都是 Impeller 了吗？为什么还会说 Skia ？这就需要说到，在 Flutter 里，<strong>Impeller 更多是“GPU 渲染后端” ，但是 Impeller 对文本渲染依赖 SkParagraph 以及对图像处理依赖 Skia 编解码器</strong>：</p>
<ul>
<li>Flutter 的文本渲染和功能集（如复杂脚本支持、排版准确性）从根本上受制于 SkParagraph 的能力，而 Impeller 更多在于高效地光栅化和合成 SkParagraph 提供的字形</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee0bdf56d0254c00bff5df2b2453172c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770591345&amp;x-signature=q49NpyneBaT9h2s%2BAgXnTyO%2Bs3g%3D" alt="img" loading="lazy"/></p>
<p>实际上 “渲染”（Rendering ）不等于“排版” (Typography) ，在 Flutter 里， 负责测量文字大小、断行、字形选择（Glyph Selection）等都还是依赖于 Libtxt / SkParagraph 等，所以真实情况一般是：</p>
<ul>
<li>Skia 生成 SkTextBlob</li>
<li>Flutter 把 SkTextBlob 封装成 DisplayList command</li>
<li>Impeller 执行这个 command</li>
</ul>
<p>所以目前来看，即使是 Impeller，但是 TextBlob 仍然是 Skia 的活，<strong>所以问题还是在于 Skia 上，文本的 bounds 仍然由 Skia/FreeType 计算</strong>，这也是为什么这个 Bug 这么久了还是慢慢悠悠的原因之一。</p>
<p>因为一旦启用了 hinting，<strong>排版（shape）和绘制（draw）时就必须在“单位矩阵（identity matrix）”下完成</strong>，否则就会出现现在这种问题，因为 <strong>Hinted glyph 是为某一个具体像素尺寸量身定做的，Hinting 会把笔画宽度、边界位置、对齐规则全部对齐到当前像素网格</strong> 。</p>
<blockquote>
<p>如果在此之后再对它做矩阵缩放，那么 hinting 时的“像素对齐”就可能会被破坏。</p>
</blockquote>
<p>而对于 hinting 来说，Hinted 的字形和度量<strong>几乎天生就不是线性可缩放的</strong>，所以如果要修这个 Bug ，就需要把所有 scale（DPR、transform）<strong>提前 bake 进 text size</strong> ，然后 shape ，之后 draw 时使用 identity matrix ，这个对文本实现复杂度无疑提高了很多，所以这个修复不会很快。</p>
<blockquote>
<p>当然，底层上也可以做个开关支持， 如果你非要用放矩阵变换，那就支持用户把 Hinting 关掉，也是一个思路。</p>
</blockquote>
<p>所以，知道问题之后，如果遇到这个场景，尽量避开有问题的字号（边界跳变），同时尽量减少 <code>saveLayer</code> 的粗发，比如：</p>
<ul>
<li>不要用 <code>Opacity</code> 包文字，而是把透明度放到 TextStyle Color</li>
<li>不用 <code>ShaderMask</code> ，尽量用 <code>TextStyle.foreground</code> + shader（直接在文字 paint 上做，不走遮罩 layer）</li>
<li>在 <code>Opacity/ShaderMask</code> 内部给 <code>Text</code> 上下加 1~2 px padding，让布局 bounds 变大，从而 layer bounds 也变大</li>
</ul>
<p><strong>当然，也有说可以通过设置 <code>FontWeight.xxx</code> ，这样 variable font 就会变成静态字体</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dcea7a9366041c793bc2f60a37a4481~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770591345&amp;x-signature=LBtTuKoKV%2BpFlqhrXpM5Fw%2BNboE%3D" alt="" loading="lazy"/></p>
<p>实际上知道问题后，规避的方式也很多，只能说 Skia 很强，但是 Skia 带来的字体问题一直也是居高不少，特别是在中文支持上，谁还没踩过几个坑？`</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第二十五章(CSS方案)]]></title>    <link>https://juejin.cn/post/7601715462921535498</link>    <guid>https://juejin.cn/post/7601715462921535498</guid>    <pubDate>2026-02-01T21:58:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601715462921535498" data-draft-id="7601441797118443571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第二十五章(CSS方案)"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2026-02-01T21:58:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第二十五章(CSS方案)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T21:58:39.000Z" title="Sun Feb 01 2026 21:58:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Next.js CSS方案</h2>
<p>在Next.js可以使用多种Css方案，包括：</p>
<ul>
<li>Tailwind CSS(个人推荐)</li>
<li>CSS Modules(创建css模块化，类似于Vue的单文件组件)</li>
<li>Next.js内置Sass(css预处理器)</li>
<li>全局Css(全局的css，可以全局使用)</li>
<li>Style(内联样式)</li>
<li>css-in-js(类似于React的styled-components，不推荐)</li>
</ul>
<h4 data-id="heading-1">Tailwind CSS</h4>
<p>Tailwind CSS(css原子化)，他是一个css框架，可以让你快速构建网页，他提供了大量的css类，你只需要使用这些类，就可以快速构建网页。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com%2F" target="_blank" title="https://tailwindcss.com/" ref="nofollow noopener noreferrer">Tailwind CSS</a></p>
<h5 data-id="heading-2">安装教程</h5>
<pre><code class="hljs language-bash" lang="bash">npx create-next-app@latest my-project
</code></pre>
<p>当我们去创建<code>Next.js</code>项目的时候，选择<code>customize settings(自定义选项)</code> 那么就会出现<code>Tailwind CSS</code>的选项，我们选择<code>Yes</code>即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eccfac37d4584e6ca81bef570e16f0d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770588077&amp;x-signature=bSPfhdHEHQDVvUeo%2FJa2ZKlvy4k%3D" alt="image.png" loading="lazy"/></p>
<p>那么如果我在当时忘记选择<code>Tailwind CSS</code>，我该怎么安装呢？</p>
<h5 data-id="heading-3">在 Next.js 中安装并使用 Tailwind CSS</h5>
<p>下面是如何在 Next.js 项目中集成 Tailwind CSS 的详细流程：</p>
<h6 data-id="heading-4">1. 创建你的 Next.js 项目</h6>
<p>如果还没有项目，可以使用 Create Next App 快速初始化：</p>
<pre><code class="hljs language-bash" lang="bash">npx create-next-app@latest my-project --typescript --eslint --app
<span class="hljs-built_in">cd</span> my-project
</code></pre>
<h6 data-id="heading-5">2. 安装 Tailwind CSS 及相关依赖</h6>
<p>通过 npm 安装 <code>tailwindcss</code>、<code>@tailwindcss/postcss</code> 以及 <code>postcss</code> 依赖：</p>
<pre><code class="hljs language-bash" lang="bash">npm install tailwindcss @tailwindcss/postcss postcss
</code></pre>
<h6 data-id="heading-6">3. 配置 PostCSS 插件</h6>
<p>在项目根目录下创建 <code>postcss.config.mjs</code> 文件，并添加如下内容：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> config = {
  <span class="hljs-attr">plugins</span>: {
    <span class="hljs-string">"@tailwindcss/postcss"</span>: {},
  },
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> config;
</code></pre>
<h6 data-id="heading-7">4. 导入 Tailwind CSS</h6>
<p>在 <code>./app/globals.css</code> 文件中添加 Tailwind CSS 的导入：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@import</span> <span class="hljs-string">"tailwindcss"</span>;
</code></pre>
<h6 data-id="heading-8">5. 启动开发服务</h6>
<p>运行开发服务：</p>
<pre><code class="hljs language-bash" lang="bash">npm run dev
</code></pre>
<h6 data-id="heading-9">6. 在项目中开始使用 Tailwind</h6>
<p>现在可以直接在组件或页面中使用 Tailwind CSS 的工具类来进行样式编写。例如：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-3xl font-bold underline"</span>&gt;</span>
      Hello world!
    <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
  )
}
</code></pre>
<p>这样即可在项目中使用 Tailwind CSS 原子类来快速开发样式。</p>
<h5 data-id="heading-10">FAQ</h5>
<p>这么多类名我记不住怎么办？</p>
<p>答：你不需要特意去记忆，tailwindCss的类名都是简称，例如<code>backdround-color:red</code> 你可以简写为<code>bg-red-500</code>。另外就是官网也提供文档可以查询，再其次就是还提供了<code>vscode</code>插件，可以自动补全类名。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e4548071e9747ff9e76261c8ae40d7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770588077&amp;x-signature=j4D5qszb2BQMyV9Ox87vsxjWFT8%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-11">CSS Modules</h4>
<p>CSS Modules 是一种 CSS 模块化方案，可以让你在组件中使用CSS模块化，类似于Vue的单文件组件(scoped)。</p>
<p>Next.js已经内置了对CSS Modules的支持，你只需要在创建文件的时候新增<code>.module.css</code>后缀即可。例如<code>index.module.css</code>。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/** index.module.css */</span>
<span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">background-color</span>: red;
}
</code></pre>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">/** index.tsx */</span>
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./index.module.css'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.container}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>你会发现他编译出来的类名，就会生成一个唯一的hash值，这样就可以避免类名冲突。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"index-module__ifV0vq__test"</span>&gt;</span>小满zs Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
</code></pre>
<h4 data-id="heading-12">Next.js内置Sass</h4>
<p>Next.js已经内置了对Sass的支持，但是依赖还需要手动安装，不过配置项它都内置了，只需要安装一下即可。</p>
<pre><code class="hljs language-bash" lang="bash">npm install --save-dev sass
</code></pre>
<p>另外Next.js还支持配置全局sass变量，只需要在<code>next.config.js</code>中配置即可。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-attr">reactCompiler</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">reactStrictMode</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">cacheComponents</span>:<span class="hljs-literal">false</span>,
  <span class="hljs-attr">sassOptions</span>:{
    <span class="hljs-attr">additionalData</span>: <span class="hljs-string">`$color: blue;`</span>, <span class="hljs-comment">// 全局变量</span>
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> config
</code></pre>
<h4 data-id="heading-13">全局Css</h4>
<p>全局CSS，就是把所有样式应用到全局路由/组件，那应该怎么搞呢?</p>
<p>在根目录下创建<code>globals.css</code>文件，然后添加全局样式。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/** app/globals.css */</span>
<span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">background-color</span>: red;
}
<span class="hljs-selector-class">.flex</span>{
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">justify-content</span>: center;
    <span class="hljs-attribute">align-items</span>: center;
}
</code></pre>
<p>在<code>layout.tsx</code>文件中引入<code>globals.css</code>文件。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//app/layout.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./globals.css'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params">{ children }: { children: React.ReactNode }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-14">Style</h4>
<p>Style，就是内联样式，就是直接在组件中使用style属性来定义样式。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">backgroundColor:</span> '<span class="hljs-attr">red</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-15">css-in-js</h4>
<p>css-in-js，就是把css + js + html混合在一起，拨入styled-components，不推荐很多人接受不了这种写法。</p>
<h5 data-id="heading-16">1.安装启用styled-components</h5>
<pre><code class="hljs language-bash" lang="bash">npm install styled-components
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-attr">compiler</span>:{
    <span class="hljs-attr">styledComponents</span>:<span class="hljs-literal">true</span> <span class="hljs-comment">// 启用styled-components</span>
  }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> config
</code></pre>
<h5 data-id="heading-17">2.创建style-component注册表</h5>
<p>使用styled-componentsAPI 创建一个全局注册表组件，用于收集渲染过程中生成的所有 CSS 样式规则，以及一个返回这些规则的函数。最后，使用该useServerInsertedHTML钩子将注册表中收集的样式注入到<code>&lt;head&gt;</code>根布局的 HTML 标签中。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//lib/registry.ts</span>
<span class="hljs-string">'use client'</span>
 
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { useServerInsertedHTML } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/navigation'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ServerStyleSheet</span>, <span class="hljs-title class_">StyleSheetManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'styled-components'</span>
 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">StyledComponentsRegistry</span>(<span class="hljs-params">{
  children,
}: {
  children: React.ReactNode
}</span>) {
  <span class="hljs-comment">// Only create stylesheet once with lazy initial state</span>
  <span class="hljs-comment">// x-ref: https://reactjs.org/docs/hooks-reference.html#lazy-initial-state</span>
  <span class="hljs-keyword">const</span> [styledComponentsStyleSheet] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerStyleSheet</span>())
 
  <span class="hljs-title function_">useServerInsertedHTML</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> styles = styledComponentsStyleSheet.<span class="hljs-title function_">getStyleElement</span>()
    styledComponentsStyleSheet.<span class="hljs-property">instance</span>.<span class="hljs-title function_">clearTag</span>()
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;&gt;</span>{styles}<span class="hljs-tag">&lt;/&gt;</span></span>
  })
 
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span>) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;&gt;</span>{children}<span class="hljs-tag">&lt;/&gt;</span></span>
 
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StyleSheetManager</span> <span class="hljs-attr">sheet</span>=<span class="hljs-string">{styledComponentsStyleSheet.instance}</span>&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">StyleSheetManager</span>&gt;</span></span>
  )
}
</code></pre>
<h5 data-id="heading-18">3.注册style-component注册表</h5>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//app/layout.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">StyledComponentsRegistry</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./lib/registry'</span>
 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params">{
  children,
}: {
  children: React.ReactNode
}</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">StyledComponentsRegistry</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">StyledComponentsRegistry</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>
  )
}
</code></pre>
<h5 data-id="heading-19">4.使用styled-components</h5>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">'use client'</span>;
<span class="hljs-keyword">import</span> styled <span class="hljs-keyword">from</span> <span class="hljs-string">'styled-components'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">StyledButton</span> = styled.<span class="hljs-property">button</span><span class="hljs-string">`
  background-color: red;
  color: white;
  padding: 10px 20px;
  border-radius: 5px;
`</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StyledButton</span>&gt;</span>Click me<span class="hljs-tag">&lt;/<span class="hljs-name">StyledButton</span>&gt;</span></span>
  )
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[来自 Claude Code 作者的 10 个使用技巧]]></title>    <link>https://juejin.cn/post/7601384029611098127</link>    <guid>https://juejin.cn/post/7601384029611098127</guid>    <pubDate>2026-02-01T16:16:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601384029611098127" data-draft-id="7601076976442966056" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="来自 Claude Code 作者的 10 个使用技巧"/> <meta itemprop="keywords" content="Claude,Agent,AI编程"/> <meta itemprop="datePublished" content="2026-02-01T16:16:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="人间观察员"/> <meta itemprop="url" content="https://juejin.cn/user/3386151544301357"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            来自 Claude Code 作者的 10 个使用技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3386151544301357/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    人间观察员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T16:16:45.000Z" title="Sun Feb 01 2026 16:16:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>Boris Cherny 开发了 Claude Code，今日他在 X 上分享了团队内部的实际使用心得。这些技巧不是什么死板的规则，而是基于大家五花八门的实践经验，总结得到的使用技巧。每个人用 Claude Code 的风格都不一样，但这些小窍门能让你生产力蹭蹭上涨。</p>
<p>本文基于原帖，丰富扩展了内容，聊聊这 10 个技巧，还加了些实用解释和场景例子，让你更容易理解和应用。即使你不用 Claude Code，但只要是类似的工具如 Gemini CLI、OpenCode、Trae 等等，这些技巧都能带来一定的帮助。</p>
<h2 data-id="heading-1">1. 并行处理：多开 Git Worktree，提升效率</h2>
<p>Claude Code 团队的最大杀手锏就是同时开启多个 Git Worktree，每个 Worktree 跑独立的 Claude 会话。这么做，你就能并行搞定多个任务，不会互相干扰。比如，在一个 Next.js 项目中，一个 Worktree 专攻后端 API 编写，另一个负责前端 UI；再或者在同一个项目中，一个用来修 bug，另一个用来开发新需求。</p>
<p>传统工作方式容易切换上下文，超级浪费时间。用并行 Worktree，就跟多线程编程似的，让 Claude 在不同分支独立干活，每个会话都有各自专属的专注于当前任务的 Context，避免乱套。</p>
<blockquote>
<p>Git Worktree 简介：这是 Git 中一项容易被忽视但是很高效的进阶功能，允许你在同一个仓库中同时检出并操作多个分支。与传统的 git checkout 不同，它无需通过 stash 或频繁提交来保存当前进度，即可在独立的目录中并行开发。相比手动复制项目创建不同的分支，它会共享 <code>/.git</code> 文件夹，这在大型的、拥有大量 git 提交历史的项目中，可以节省很多磁盘空间，而且你可以通过 <code>git worktree</code> 命令行便捷的管理这些目录。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb12edb1df164945a7a5bcfd603f83c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq66Ze06KeC5a-f5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770568393&amp;x-signature=dd4oa7NtnY71TCpRKMGIOn%2FdeF8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">2. 从规划模式开始：先谋后动，一击即中</h2>
<p>复杂任务别急着上手，先花点功夫制定详细计划。将精力集中在方案设计上，直到你对方案满意为止，这样 Claude 往往能“一击即中”地完成代码实现。</p>
<p>如果中途方案走偏了，随时切换回计划模式重新规划，而不是强行在错误的基础上修改。</p>
<p>还可以开第二个 Claude 会话作为“首席工程师”来审核第一个 Claude 的方案。</p>
<blockquote>
<p>Claude Code 中可通过 <code>Shfit + Tab</code> 开启 Plan 模式。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/848176879a5f49229c8be5285f6c6c18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq66Ze06KeC5a-f5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770568393&amp;x-signature=rRjlPKwb9jOtHcnvTEkckwU18JI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">3. 优化文档：持续迭代，降低错误率</h2>
<p>每次修 bug 后，都让 Claude 更新它的文档，免得反复犯错。你可以告诉它：“更新你的 CLAUDE.me，确保下次不再犯同样的错误”。</p>
<p>这是最具有复利效应的习惯。</p>
<p>Claude 非常擅长为自己写规则，通过不断迭代，你会发现它的错误率明显下降。</p>
<h2 data-id="heading-4">4. 创建自定义技能：复用命令，自动化重复工作</h2>
<p>如果你每天重复做某件事超过一次，就把它变成一个 Skills 或斜杠命令（slash command）。例如：创建一个 <code>/techdebt</code> 命令来查找重复代码。</p>
<p>自定义技能像宏命令，省去手动敲字，提高效率。还能跨项目用，类似插件系统。制作一次，到处可用。</p>
<h2 data-id="heading-5">5. 让 Claude 自动修复 Bug</h2>
<p>对于 Github Issue 上的问题或 CI/CD 中的错误，直接把 Bug 复制给 Claude，说“fix”就行，不用你微操。
不要事无巨细地指导具体操作。</p>
<p>让 Claude 查看日志、错误信息来排查解决系统故障——它在这方面表现出乎意料地强大。</p>
<h2 data-id="heading-6">6. 提升你的提示词水平</h2>
<p>例如，你可以说：严厉地审查这些更改，除非我通过了你的测试，否则不要提交 PR。</p>
<p>在采取了不尽如人意的补救措施后说：鉴于你现在所掌握的所有信息，放弃这个方案，实施更优雅的解决方案。</p>
<p>在 Claude 写代码之前，越具体、越能减少歧义的说明，生成的代码质量越高。</p>
<h2 data-id="heading-7">7. 终端与环境设置：优化工具链</h2>
<p>这里作者推荐了 Ghostty 终端，它支持同步渲染、24 位色和 Unicode。自定义状态栏显示上下文用量和 Git 分支；颜色编码标签，用 tmux 分割任务。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f95633c9c0544f53966f445b67b3973c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq66Ze06KeC5a-f5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770568393&amp;x-signature=6smroeHAAimU0T8I22eXTsJ0I6Q%3D" alt="image.png" loading="lazy"/></p>
<p>此外，你可以试试语音输入！语音输入速度是打字 3 倍，因此你的提示会更详尽，这会有利于 Agent 更明确你的想法。</p>
<p>如果你在寻找一款好用的终端，可以试试 Ghostty。</p>
<p>还有，我用的 Wrap 也不错。😌</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0119b8978aaf48d8baed06b3ec44a06f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq66Ze06KeC5a-f5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770568393&amp;x-signature=i0gEi45Bjqn6zdy2Z4H5kxcDoPg%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-8">8. 使用子代理：增加计算力，保持上下文干净</h2>
<p>当遇到需要大量计算或处理海量信息的复杂问题时，明确要求“使用子智能体（use subagents）”。</p>
<p>将子任务分配给子智能体，可以保持主会话的上下文窗口整洁。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed84ffb6c8a346d387446f9e5da31ddb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq66Ze06KeC5a-f5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770568393&amp;x-signature=vFyDV%2Bc2wvBwLGJCUbqZbbQWAlc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9">9. 数据与分析：Claude 取代 SQL</h2>
<p>将 Claude 与数据库命令行工具连接，直接进行数据分析、查询，你可以更专注业务逻辑。</p>
<p>Boris 提到他已经超过半年没有手写过 SQL 语句了，全部由 Claude 代劳。</p>
<p>这适用于任何具有 CLI、MCP 或 API 的数据库。</p>
<h2 data-id="heading-10">10. 与 Claude 共同学习</h2>
<p>通过 <code>/config</code> 中的 Output style 启用 Explanatory 或 Learning，让 Claude 在修改代码的同时解释背后的原理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1ae914aa32a42aea51fdf70d4c8e728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq66Ze06KeC5a-f5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770568393&amp;x-signature=lfJJaXxxDMhvC4aAG5C4VFz6ksQ%3D" alt="image.png" loading="lazy"/></p>
<p>你还可以让它生成可视化的基于 HTML 的 PPT，或生成 ASCLL 图表，帮助你更好的理解代码。</p>
<h2 data-id="heading-11">结语</h2>
<p>以上就是全部内容了，如果大家想了解更多 Claude Code 或者类似工具的使用技巧，还可以去看看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fen%2Ffeatures-overview" target="_blank" title="https://code.claude.com/docs/en/features-overview" ref="nofollow noopener noreferrer">Claude Code Docs</a>，一定要英文版，很多东西只有英文版才有。</p>
<p>原帖链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fbcherny%2Fstatus%2F2017742741636321619" target="_blank" title="https://x.com/bcherny/status/2017742741636321619" ref="nofollow noopener noreferrer">x.com/bcherny/sta…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[abigen使用教程 - go版本]]></title>    <link>https://juejin.cn/post/7601419065127796755</link>    <guid>https://juejin.cn/post/7601419065127796755</guid>    <pubDate>2026-02-01T16:20:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601419065127796755" data-draft-id="7601427909702615094" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="abigen使用教程 - go版本"/> <meta itemprop="keywords" content="区块链"/> <meta itemprop="datePublished" content="2026-02-01T16:20:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Warson_L"/> <meta itemprop="url" content="https://juejin.cn/user/2568875732117304"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            abigen使用教程 - go版本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2568875732117304/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Warson_L
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T16:20:38.000Z" title="Sun Feb 01 2026 16:20:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Web3 后端开发中，<code>abigen</code> 是一个至关重要的工具。它能根据 Solidity 合约生成的 <strong>ABI</strong>（应用二进制接口）自动生成 Go 语言代码，让你像调用普通 Go 函数一样调用智能合约。</p>
<p>以下是详细的 <code>abigen</code> 使用教程。</p>
<hr/>
<h3 data-id="heading-0">第一步：安装 abigen 工具</h3>
<p><code>abigen</code> 是 <code>go-ethereum</code> 项目的一部分。你可以通过以下命令安装：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装最新版 abigen</span>
go install github.com/ethereum/go-ethereum/cmd/abigen@latest
</code></pre>
<p><strong>验证安装：</strong>
在终端输入 <code>abigen --version</code>。如果看到版本号，说明安装成功。
<em>注意：如果提示找不到命令，请确保你的 <code>$GOPATH/bin</code> 已添加到系统的 <code>PATH</code> 环境变量中。</em></p>
<hr/>
<h3 data-id="heading-1">第二步：准备 Solidity 合约</h3>
<p>创建一个简单的合约文件 <code>SimpleStorage.sol</code>：</p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma uint256;
pragma solidity ^0.8.0;

contract SimpleStorage {
    uint256 private data;

    event DataStored(uint256 newValue);

    function set(uint256 x) public {
        data = x;
        emit DataStored(x);
    }

    function get() public view returns (uint256) {
        return data;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-2">第三步：获取 ABI 和 Bytecode</h3>
<p>要生成 Go 代码，你需要两个东西：</p>
<ol>
<li><strong>ABI</strong>: 描述合约有哪些函数。</li>
<li><strong>Bin (Bytecode)</strong>: 合约的编译代码（如果你需要通过 Go 部署合约的话）。</li>
</ol>
<p><strong>方法 A：使用 solc 编译器（本地）</strong></p>
<pre><code class="hljs language-bash" lang="bash">solc --abi --bin SimpleStorage.sol -o build
</code></pre>
<p><strong>方法 B：使用 Remix IDE（最简单）</strong></p>
<ol>
<li>将代码粘贴到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F" target="_blank" title="https://remix.ethereum.org/" ref="nofollow noopener noreferrer">Remix</a>。</li>
<li>编译合约。</li>
<li>在 "Compilation Details" 中点击 <strong>ABI</strong> 和 <strong>Bytecode</strong> 的复制按钮，分别存为 <code>SimpleStorage.abi</code> 和 <code>SimpleStorage.bin</code>。</li>
</ol>
<hr/>
<h3 data-id="heading-3">第四步：使用 abigen 生成 Go 绑定</h3>
<p>假设你现在有了 <code>SimpleStorage.abi</code> 和 <code>SimpleStorage.bin</code>，运行以下命令：</p>
<pre><code class="hljs language-bash" lang="bash">abigen --abi SimpleStorage.abi --bin SimpleStorage.bin --pkg store --<span class="hljs-built_in">type</span> SimpleStorage --out storage.go
</code></pre>
<p><strong>参数解释：</strong></p>
<ul>
<li><code>--abi</code>: 指定 ABI 文件路径。</li>
<li><code>--bin</code>: 指定 Bin 文件路径（可选，仅调用合约不部署时可不加）。</li>
<li><code>--pkg</code>: 指定生成的 Go 代码的包名（这里设为 <code>store</code>）。</li>
<li><code>--type</code>: 指定生成的 Go 结构体的名称。</li>
<li><code>--out</code>: 指定输出的文件名。</li>
</ul>
<p>生成成功后，你会看到一个几百行的 <code>storage.go</code> 文件，里面包含了 <code>DeploySimpleStorage</code>、<code>Set</code>、<code>Get</code> 等函数。</p>
<hr/>
<h3 data-id="heading-4">第五步：在 Go 代码中调用（实战例子）</h3>
<p>现在我们要写一个 <code>main.go</code> 来调用这个生成的 <code>storage.go</code>。为了确保能跑通，我们连接到你之前的 <strong>Sepolia 测试网</strong>。</p>
<p><strong>目录结构：</strong></p>
<pre><code class="hljs language-text" lang="text">.
├── SimpleStorage.abi
├── SimpleStorage.bin
├── store/
│   └── storage.go      // abigen 生成的文件
├── main.go
└── .env
</code></pre>
<p><strong>main.go 实现代码：</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"math/big"</span>
	<span class="hljs-string">"os"</span>

	<span class="hljs-string">"go-wallet-lite/store"</span> <span class="hljs-comment">// 替换为你的项目路径/store</span>
	<span class="hljs-string">"github.com/ethereum/go-ethereum/accounts/abi/bind"</span>
	<span class="hljs-string">"github.com/ethereum/go-ethereum/common"</span>
	<span class="hljs-string">"github.com/ethereum/go-ethereum/ethclient"</span>
	<span class="hljs-string">"github.com/joho/godotenv"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	godotenv.Load()
	
	<span class="hljs-comment">// 1. 连接 Sepolia 节点</span>
	client, err := ethclient.Dial(os.Getenv(<span class="hljs-string">"RPC_URL"</span>))
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}

	<span class="hljs-comment">// 2. 准备合约地址</span>
	<span class="hljs-comment">// 这是一个已经在 Sepolia 上部署好的测试合约地址（如果没有，可以换成你自己的）</span>
	contractAddr := common.HexToAddress(<span class="hljs-string">"0x7de680214a1f335165c63e903b1e77983636f72a"</span>) 

	<span class="hljs-comment">// 3. 实例化合约</span>
	instance, err := store.NewSimpleStorage(contractAddr, client)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}

	<span class="hljs-comment">// 4. 调用 Read 方法 (Get)</span>
	<span class="hljs-comment">// 查询合约里存的数字</span>
	value, err := instance.Get(&amp;bind.CallOpts{})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}
	fmt.Printf(<span class="hljs-string">"当前合约存储的值: %s\n"</span>, value.String())

	<span class="hljs-comment">// 5. 调用 Write 方法 (Set) </span>
	<span class="hljs-comment">// 注意：写操作需要私钥签名，会消耗 Gas</span>
    <span class="hljs-comment">/*
	privateKey, err := crypto.HexToECDSA(os.Getenv("PRIVATE_KEY"))
	auth, _ := bind.NewKeyedTransactorWithChainID(privateKey, big.NewInt(11155111)) // Sepolia ChainID

	tx, err := instance.Set(auth, big.NewInt(666)) // 将值设为 666
	if err != nil {
		log.Fatal(err)
	}
	fmt.Printf("交易已发送，Hash: %s\n", tx.Hash().Hex())
    */</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-5">常见坑点总结</h3>
<ol>
<li><strong>包名不一致</strong>：<code>abigen</code> 生成时指定的 <code>--pkg store</code> 必须和文件夹名称 <code>store</code> 一致，否则 Go 找不到。</li>
<li><strong>ABI 更新不及时</strong>：如果你修改了 Solidity 代码，必须重新生成 ABI 并重新运行 <code>abigen</code>，否则调用时会报错（方法哈希不匹配）。</li>
<li><strong>大数处理</strong>：Solidity 的 <code>uint256</code> 在 Go 中对应的是 <code>*big.Int</code>，不能直接用 <code>int</code>，必须使用 <code>math/big</code> 库。</li>
<li><strong>ChainID</strong>：在做“写操作”时，<code>NewKeyedTransactorWithChainID</code> 里的 ChainID 必须传对（Sepolia 是 <code>11155111</code>，主网是 <code>1</code>）。</li>
</ol>
<h3 data-id="heading-6">总结</h3>
<p><code>abigen</code> 的工作流就是：<strong>写合约 -&gt; 拿 ABI -&gt; 跑 abigen -&gt; 在 Go 中像调包一样调合约。</strong></p>
<p><strong>建议尝试：</strong> 你可以先把 <code>Get</code> 方法跑通（不需要私钥），然后再尝试用私钥跑通 <code>Set</code> 方法。需要我教你如何在 Go 里安全地加载私钥吗？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[墨梅博客 1.3.0 发布与服务器数据备份教训 | 2026 年第 5 周草梅周报]]></title>    <link>https://juejin.cn/post/7601843004958310446</link>    <guid>https://juejin.cn/post/7601843004958310446</guid>    <pubDate>2026-02-01T16:42:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601843004958310446" data-draft-id="7601441797118361651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="墨梅博客 1.3.0 发布与服务器数据备份教训 | 2026 年第 5 周草梅周报"/> <meta itemprop="keywords" content="GitHub,开源,AI编程"/> <meta itemprop="datePublished" content="2026-02-01T16:42:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="草梅友仁"/> <meta itemprop="url" content="https://juejin.cn/user/3043088413495815"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            墨梅博客 1.3.0 发布与服务器数据备份教训 | 2026 年第 5 周草梅周报
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3043088413495815/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    草梅友仁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T16:42:22.000Z" title="Sun Feb 01 2026 16:42:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd" target="_blank" title="https://blog.cmyr.ltd" ref="nofollow noopener noreferrer">草梅友仁的博客</a> 发布和更新，并在多个平台同步发布。如有更新，以博客上的版本为准。您也可以通过文末的 <code>原文链接</code> 查看最新版本。</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>欢迎来到草梅周报！这是一个由草梅友仁基于 AI 整理的周报，旨在为您提供最新的博客更新、GitHub 动态、个人动态和其他周刊文章推荐等内容。</p>
<hr/>
<h2 data-id="heading-1">开源动态</h2>
<p>本周依旧在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fmomei" target="_blank" title="https://github.com/CaoMeiYouRen/momei" ref="nofollow noopener noreferrer">墨梅 (Momei)</a> 中。</p>
<blockquote>
<p>您可以前往 Demo 站试用：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdemo.momei.app%2F" target="_blank" title="https://demo.momei.app/" ref="nofollow noopener noreferrer">demo.momei.app/</a></p>
<ul>
<li>您可以通过邮箱 <code>admin@example.com</code>，密码<code>momei123456</code>登录演示用管理员账号。</li>
</ul>
<p>或前往官网注册：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmomei.app%2F" target="_blank" title="https://momei.app/" ref="nofollow noopener noreferrer">momei.app/</a></p>
<p>也可以前往文档站来了解项目整体规划和未来开发路线图：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.momei.app%2F" target="_blank" title="https://docs.momei.app/" ref="nofollow noopener noreferrer">docs.momei.app/</a></p>
</blockquote>
<p>当前墨梅博客已经正式发布了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fmomei%2Freleases%2Ftag%2Fv1.3.0" target="_blank" title="https://github.com/CaoMeiYouRen/momei/releases/tag/v1.3.0" ref="nofollow noopener noreferrer">1.3.0</a> 版本，以下是页面和功能的一些截图。</p>
<p>新增灵感收纳箱页面。用于记录灵感，可直接通过 AI 聚合灵感来生成新的文章。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/488b390921c4478cb48bfc721e4ccaeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770568941&amp;x-signature=pJCdXG7RyTP%2BdxxPA7ZcrjFnGZU%3D" alt="image-20260201231029742" loading="lazy"/></p>
<p>新增了系统设置页面。现在绝大多数系统配置均可在网页端设置，而无需在环境变量中设置。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9dc8743645a143d0ad21d82b80db5d57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770568941&amp;x-signature=tImNmDjHHtPyKEL6KTA6kPAMw38%3D" alt="image-20260201231208754" loading="lazy"/></p>
<p>也新增了安装引导功能，部署项目更加方便。</p>
<p>增加了访客投稿功能</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb55cb15d9694ecd9a0db80c5ca17ed8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770568941&amp;x-signature=RyTe6W7r0Z9%2FkfokRhhZ3B4ttIw%3D" alt="image-20260201231312222" loading="lazy"/></p>
<p>新增主题画廊功能。支持更加多样的主题设置。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb2d54e7342048fba1d399ed2809d8e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770568941&amp;x-signature=XGGI0D4rHXGkFodkqrwdx9s0hIA%3D" alt="image-20260201231942489" loading="lazy"/></p>
<p>增加播客支持，现在可直接上传音频或设置音频链接，也可上传文章封面和预览封面。也支持播客订阅。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/898df0fa32aa4d4cb2c78f8e9388e222~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770568941&amp;x-signature=Gh4JFoKvPIAshlNjG%2Bqu%2BLVyB2E%3D" alt="image-20260201231611875" loading="lazy"/></p>
<p>发布了一个新的工具包 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fmomei-cli" target="_blank" title="https://www.npmjs.com/package/momei-cli" ref="nofollow noopener noreferrer">Momei CLI</a>，用于从 Hexo 博客系统批量导入文章到墨梅平台。</p>
<p>可通过以下命令安装。具体使用方式见相关文档。</p>
<pre><code class="hljs language-bash" lang="bash">npm i momei-cli -g
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68d489093350406b92b7de8642622272~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770568941&amp;x-signature=uFU0hgLXCcSdA29Nt9Cu7ysDRqQ%3D" alt="image-20260201232139195" loading="lazy"/></p>
<p>更多功能和页面可以前往<a href="https://link.juejin.cn?target=https%3A%2F%2Fmomei.app%2F" target="_blank" title="https://momei.app/" ref="nofollow noopener noreferrer">官网</a>体验，也可前往<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-51-caomei-weekly-momei-blog-mvp-caomei-auth-update.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-51-caomei-weekly-momei-blog-mvp-caomei-auth-update.html" ref="nofollow noopener noreferrer">之前的博客</a>查看截图。</p>
<p>欢迎各位用户体验。并提出意见和建议。</p>
<p>接下来的话还会继续按照路线图和待办进行开发功能，敬请期待。</p>
<p>当然，目前墨梅博客还有很多需要打磨的细节，功能上也还不完善，如有任何意见和建议，都可以在项目的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fmomei%2Fissues" target="_blank" title="https://github.com/CaoMeiYouRen/momei/issues" ref="nofollow noopener noreferrer">GitHub issues</a> 中提出。</p>
<p>如果你也对墨梅博客感兴趣，欢迎参与开发和测试。</p>
<h2 data-id="heading-2">开发日常</h2>
<p>本周必须要提一下的就是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fstatus.cloudcone.com%2Fincidents%2F346624" target="_blank" title="https://status.cloudcone.com/incidents/346624" ref="nofollow noopener noreferrer">cloudcone 出现故障</a> 了。</p>
<p>由于 Los Angeles 节点出现故障，本人在该节点的服务器也直接失联。</p>
<p>而雪上加霜的是，本次故障是因为管理节点被黑，导致磁盘中了勒索病毒，直接导致所有服务器的数据丢失。</p>
<p>而本人虽然在前不久迁移了服务器，却没有做相关备份，导致服务器数据无法恢复。</p>
<p>这个血的教训告诉我们，服务器的重要数据一定要做备份，而且是异地备份，否则就有可能出现数据丢失！</p>
<p>教训极为惨烈，我后续计划研究下自动备份数据的项目，希望能在未来不再发生此类事件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0261e5e8892c460c85f52c3f51db85de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770568941&amp;x-signature=gaQ3sa8%2FaNzyoutggWwSlGJxlzU%3D" alt="image-20260201232454850" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8659dabf76b48bba32e3834ac3e03f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770568941&amp;x-signature=uqPQnCGfq10RiXJpXxe%2F0O2pSP8%3D" alt="image-20260201232406471" loading="lazy"/></p>
<h2 data-id="heading-3">GitHub Release</h2>
<h3 data-id="heading-4">momei</h3>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fmomei%2Freleases%2Ftag%2Fv1.3.0" target="_blank" title="https://github.com/CaoMeiYouRen/momei/releases/tag/v1.3.0" ref="nofollow noopener noreferrer">v1.3.0</a> - 2026-01-31 20:07:35</h4>
<p>摘要:<br/>
版本 1.3.0 摘要 (2026-01-31)</p>
<p>新功能：</p>
<ul>
<li>snippets 模块新增 PWA 和书签工具，支持灵感采集、编辑、AI 聚合转换及图片上传</li>
<li>新增主题管理功能，包括画廊预览、配置锁定和方案保存</li>
<li>添加播客功能，支持音频元数据探测与 RSS 订阅</li>
<li>实现安装向导模块，支持多语言和初始化检查</li>
<li>增强表单验证和用户反馈，包括错误提示和 Toast 通知</li>
<li>新增 AI 相关功能，包括聊天 API、大纲生成和内容扩展</li>
<li>添加灵感管理功能，支持碎片记录、附件上传和聚合处理</li>
<li>优化隐私保护，新增邮箱哈希、密码保护和文章可见性设置</li>
<li>支持数学公式($)和音频处理，包括上传和元数据探测</li>
</ul>
<p>Bug 修复：</p>
<ul>
<li>修复 fast-xml-parser 和 tar 包的安全漏洞</li>
<li>优化音频 RSS feed 处理，确保音频地址优先显示</li>
<li>修正随机数生成器安全问题(CWE-338)</li>
<li>处理 SQLite 和 PostgreSQL 的文本类型兼容性问题</li>
<li>优化灵感查询接口，支持分页和状态筛选</li>
<li>修复文章可见性逻辑和密码保护功能</li>
<li>更新部署指南和存储配置默认值</li>
</ul>
<p>代码重构：</p>
<ul>
<li>优化 API 逻辑和环境变量配置</li>
<li>重构主题设置和安装向导组件</li>
<li>提取密码哈希逻辑到独立模块</li>
<li>增强权限校验，新增管理员和作者验证中间件</li>
<li>优化数据库配置和存储支持</li>
<li>改进错误处理和国际化支持</li>
<li>移除访客角色，更新权限体系</li>
</ul>
<h2 data-id="heading-6">最新 GitHub 加星仓库</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FPizzaDark%2FAutoMemeDetector" target="_blank" title="https://github.com/PizzaDark/AutoMemeDetector" ref="nofollow noopener noreferrer">CaoMeiYouRen starred AutoMemeDetector</a> - 2026-02-01 19:00:54<br/>
该项目是一个 Python 语言编写的开源项目，目前获得 17 个星标收藏。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Feasychen%2Fask4me" target="_blank" title="https://github.com/easychen/ask4me" ref="nofollow noopener noreferrer">CaoMeiYouRen starred ask4me</a> - 2026-01-31 14:11:51<br/>
极简 Human-in-the-Loop 方案采用 Go 语言实现，通过单次同步请求完成所有交互。该方案已获得 54 个星标，特点是简化了人机交互流程，将传统多步骤操作整合为一次性处理。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Feasychen%2Fone-person-unicorn-book" target="_blank" title="https://github.com/easychen/one-person-unicorn-book" ref="nofollow noopener noreferrer">CaoMeiYouRen starred one-person-unicorn-book</a> - 2026-01-29 11:55:33<br/>
当智能体可以独立工作时，一人公司可能发展为"一人独角兽"模式。这种新型企业形态探讨了在人工智能代理支持下，个人创业者如何实现规模化运营的可能性。文章分析了智能体技术如何赋能单人企业，使其具备传统公司需要多人协作才能完成的工作能力。该概念提出了未来企业组织形式的创新方向，即在高度自动化的技术支持下，个人创业者也能创建估值 超过 10 亿美元的独角兽企业。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fantfu%2Fskills" target="_blank" title="https://github.com/antfu/skills" ref="nofollow noopener noreferrer">CaoMeiYouRen starred skills</a> - 2026-01-28 20:04:40<br/>
Anthony Fu 维护的智能代理技能精选集，主要使用 TypeScript 语言开发，在 GitHub 上获得 2514 个星标。</li>
</ul>
<h2 data-id="heading-7">其他博客或周刊推荐</h2>
<h3 data-id="heading-8">阮一峰的网络日志</h3>
<ul>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2026%2F01%2Fweekly-issue-383.html" target="_blank" title="http://www.ruanyifeng.com/blog/2026/01/weekly-issue-383.html" ref="nofollow noopener noreferrer">科技爱好者周刊（第 383 期）：你是第几级 AI 编程</a> - 2026-01-30 08:10:32</li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2026%2F01%2Fkimi_k2.5.html" target="_blank" title="http://www.ruanyifeng.com/blog/2026/01/kimi_k2.5.html" ref="nofollow noopener noreferrer">Kimi 的一体化，Manus 的分层</a> - 2026-01-29 16:02:30</li>
</ul>
<h3 data-id="heading-9">阿猫的博客</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fameow.xyz%2Farchives%2Fweekly-092" target="_blank" title="https://ameow.xyz/archives/weekly-092" ref="nofollow noopener noreferrer">猫鱼周刊 vol. 092 AI 的贴吧</a> - 2026-02-01 19:37:05</li>
</ul>
<h3 data-id="heading-10">潮流周刊</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.tw93.fun%2Fposts%2F256%2F" target="_blank" title="https://weekly.tw93.fun/posts/256/" ref="nofollow noopener noreferrer">第 256 期 - 上野天空</a> - 2026-02-02 08:00:00</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.tw93.fun%2Fposts%2F255%2F" target="_blank" title="https://weekly.tw93.fun/posts/255/" ref="nofollow noopener noreferrer">第 255 期 - 好吃鸡翅</a> - 2026-01-26 08:00:00</li>
</ul>
<h3 data-id="heading-11">二丫讲梵的学习周刊</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwiki.eryajf.net%2Fpages%2Fccedb7%2F" target="_blank" title="https://wiki.eryajf.net/pages/ccedb7/" ref="nofollow noopener noreferrer">学习周刊-总第 248 期-2026 年第 05 周</a> - 2026-01-29 21:29:10</li>
</ul>
<h2 data-id="heading-12">总结</h2>
<p>本周的更新和动态如上所示。感谢您的阅读！<br/>
您可以通过以下方式订阅草梅周报的更新：</p>
<ul>
<li><strong>博客</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd" target="_blank" title="https://blog.cmyr.ltd" ref="nofollow noopener noreferrer">草梅友仁的博客</a></li>
<li><strong>墨梅博客</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmomei.app" target="_blank" title="https://momei.app" ref="nofollow noopener noreferrer">墨梅博客</a></li>
<li><strong>RSS</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Fweekly.xml" target="_blank" title="https://blog.cmyr.ltd/weekly.xml" ref="nofollow noopener noreferrer">草梅周报</a></li>
<li><strong>公众号</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Foss.cmyr.dev%2Fimages%2F20241025184516839-21n2ctv.png" target="_blank" title="https://oss.cmyr.dev/images/20241025184516839-21n2ctv.png" ref="nofollow noopener noreferrer">草梅友仁的后花园</a></li>
<li><strong>邮箱订阅</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flistmonk.cmyr.dev%2Fsubscription%2Fform" target="_blank" title="https://listmonk.cmyr.dev/subscription/form" ref="nofollow noopener noreferrer">草梅友仁的博客订阅</a></li>
</ul>
<h2 data-id="heading-13">往期回顾</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2026-04-caomei-weekly-momei-1-2-0-release-ai-development.html" target="_blank" title="https://blog.cmyr.ltd/archives/2026-04-caomei-weekly-momei-1-2-0-release-ai-development.html" ref="nofollow noopener noreferrer">墨梅博客 1.2.0 发布与 AI 开发实践 | 2026 年第 4 周草梅周报</a> - 2026-01-25 22:23:13</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2026-02-caomei-weekly-momei-blog-1-0-release-update.html" target="_blank" title="https://blog.cmyr.ltd/archives/2026-02-caomei-weekly-momei-blog-1-0-release-update.html" ref="nofollow noopener noreferrer">墨梅博客 1.0.0 发布与更新 | 2026 年第 2 周草梅周报</a> - 2026-01-11 18:55:41</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-51-caomei-weekly-momei-blog-mvp-caomei-auth-update.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-51-caomei-weekly-momei-blog-mvp-caomei-auth-update.html" ref="nofollow noopener noreferrer">墨梅博客 MVP 发布与草梅 Auth 更新 | 2025 年第 51 周草梅周报</a> - 2025-12-21 22:24:19</li>
</ul>
<p>本文作者：草梅友仁<br/>
本文地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2026-05-caomei-weekly-momei-1-3-0-release-server-backup-lesson.html" target="_blank" title="https://blog.cmyr.ltd/archives/2026-05-caomei-weekly-momei-1-3-0-release-server-backup-lesson.html" ref="nofollow noopener noreferrer">blog.cmyr.ltd/archives/20…</a><br/>
版权声明：本文采用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcreativecommons.org%2Flicenses%2Fby-nc-sa%2F4.0%2Fdeed.zh-hans" target="_blank" title="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" ref="nofollow noopener noreferrer">CC BY-NC-SA 4.0 协议</a> 进行分发，转载请注明出处！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[推荐一个基于 Spring Boot 4.0 + Java 21 + Spring AI 2.0 的大模型项目！]]></title>    <link>https://juejin.cn/post/7601374668961759282</link>    <guid>https://juejin.cn/post/7601374668961759282</guid>    <pubDate>2026-02-01T15:02:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601374668961759282" data-draft-id="7601486204173959218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="推荐一个基于 Spring Boot 4.0 + Java 21 + Spring AI 2.0 的大模型项目！"/> <meta itemprop="keywords" content="后端,Spring Boot"/> <meta itemprop="datePublished" content="2026-02-01T15:02:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JavaGuide"/> <meta itemprop="url" content="https://juejin.cn/user/166781497383294"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            推荐一个基于 Spring Boot 4.0 + Java 21 + Spring AI 2.0 的大模型项目！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781497383294/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JavaGuide
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T15:02:29.000Z" title="Sun Feb 01 2026 15:02:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 Guide。今年元旦假期，我写了一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg2OTA0Njk0OA%3D%3D%26mid%3D2247551987%26idx%3D1%26sn%3De80903c2449eb3ad05dc15c7b0877668%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&amp;mid=2247551987&amp;idx=1&amp;sn=e80903c2449eb3ad05dc15c7b0877668&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">大模型项目</a>并完全开源了出来。</p>
<p>短短一个月时间，这个项目目前就已经在 Github 收获了 <strong>450+</strong> Star，吸引了多位社区爱好者共同参与完善！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a0d843b28034a7fa454db2fe6f17803~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563466&amp;x-signature=PoR9L37sQ0CjMDnATZFNEGzE%2FqA%3D" alt="" loading="lazy"/></p>
<p>发布之后，得益于大家的共同贡献，我们顺利完成了下面这些事情：</p>
<ul>
<li><strong>添加 API 限流保护</strong>：基于 Redis+Lua 封装分布式限流组件，支持按用户、IP 或全局维度的精准流量控制，有效防御恶意刷接口行为，保障高价值 AI API 的配额安全。</li>
<li><strong>前端性能优化</strong>：
<ul>
<li>RAG 聊天界面引入虚拟列表。</li>
<li>引入懒加载和代码分割，解决了首屏加载缓慢和 Bundle 体积过大的问题。</li>
</ul>
</li>
<li><strong>功能优化</strong>：
<ul>
<li>向量功能和 Tika 简历解析优化。</li>
<li>增加面试问题去重功能，避免重复提问。</li>
</ul>
</li>
<li><strong>Docker 快速部署</strong>：通过 Docker Compose 一键搭建包含数据库扩展、缓存、对象存储在内的全套运行环境。</li>
<li>...等等</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7030274d4b14478a4f78912e129e3fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563466&amp;x-signature=G%2B7wQ%2FnASsHA9x8EfFR%2FvWEOjqc%3D" alt="" loading="lazy"/></p>
<p>截止目前，我已经累计处理 <strong>11</strong> 个 issue 和 <strong>6</strong> 个 pr（完成率 <strong>100%</strong>）。</p>
<p>并且，我还顺利发布了这个项目的配套教程，从简历写法、面试拷打和核心业务实现都有保姆级教程。</p>
<h2 data-id="heading-0">项目介绍</h2>
<p>这是一个基于 Spring Boot 4.0 + Java 21 + Spring AI 2.0 的 AI 智能面试辅助平台。系统提供三大核心功能：</p>
<ol>
<li><strong>智能简历分析</strong>：上传简历后，AI 自动进行多维度评分并给出改进建议</li>
<li><strong>模拟面试系统</strong>：基于简历内容生成个性化面试题，支持实时问答和答案评估</li>
<li><strong>RAG 知识库问答</strong>：上传技术文档构建私有知识库，支持向量检索增强的智能问答</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73cbb01452b64fef8b1bb832c6dd927d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563466&amp;x-signature=v87Nn%2FAT8emhfJ%2FbuIpYWR9kjlI%3D" alt="效果展示" loading="lazy"/></p>
<p><strong>项目地址</strong>：</p>
<ul>
<li>Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnailclimb%2Finterview-guide" target="_blank" title="https://github.com/Snailclimb/interview-guide" ref="nofollow noopener noreferrer">github.com/Snailclimb/…</a></li>
<li>Gitee：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FSnailClimb%2Finterview-guide" target="_blank" title="https://gitee.com/SnailClimb/interview-guide" ref="nofollow noopener noreferrer">gitee.com/SnailClimb/…</a></li>
</ul>
<p>完整代码完全免费开源，没有 Pro 版本或者付费版！</p>
<h2 data-id="heading-1">简历写法</h2>
<p><strong>如何将《SpringAI 智能面试平台+RAG知识库》实战项目写进简历？</strong> 我一共提供了五大方向版本任选，精准匹配岗位需求：</p>
<ol>
<li><strong>后端方向</strong>：提供“架构与分布式能力侧重”、“AI 应用与响应式编程侧重”、“工程化与基础设施侧重”三个版本，无论你面试的是后端、大模型应用还是架构岗位，都能找到最合适的切入点。</li>
<li><strong>测试/测开方向</strong>：专门设计了“单元测试与 TDD”以及“功能/异常场景覆盖”两个版本，突出测试工程师在 AI 质量保障中的核心竞争力。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57177795d95c4ded9365773191222435~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563466&amp;x-signature=E1S2IfFCYDqoWIpyeeUXe2p0Tyo%3D" alt="《SpringAI 智能面试平台+RAG知识库》简历写法" loading="lazy"/></p>
<p>每一条描述都紧扣项目真实逻辑，严格遵守项目介绍规范。不仅教你怎么写，更教你怎么补，例如针对本项目未涉及的“用户认证与鉴权”给出补充建议，教你如何基于 SpringSecurity/Sa-Token 包装主流的认证授权方案。</p>
<p>并且，我还补充了面试官可深挖的技术难点（如Redis Stream vs 传统消息队列**、**分布式限流的实现细节）以及项目难点与解决方案模板。</p>
<h2 data-id="heading-2">教程概览</h2>
<p>带大家看看我写的配套教程，用心程度一切都在文字中！整个项目教程，我手绘了几十张技术配图帮助理解。</p>
<p>例如，RAG 面试题总结这篇，耗时一周终于完成了第一版，一共 <strong>3.4 万字</strong>，包含 <strong>35 道高频 RAG 面试题</strong>，光校对都进行了三次。而且，这还只是第一版，后续还会继续完善优化！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c5daa99c3ea460a89af430b72500e08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563466&amp;x-signature=52mLIqvQ4%2FEARqkKehEHMXw3Sac%3D" alt="RAG 面试题" loading="lazy"/></p>
<p>这篇是对应的 RAG 知识库详细开发思路的介绍。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6912cff67ba49b992197cf1c74efc6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563466&amp;x-signature=cHkJyk35BPm4UwBQfK%2FqCwG4osY%3D" alt="RAG 知识库详细开发思路" loading="lazy"/></p>
<p>不仅教你“如何写出代码”，更教你“为什么这么设计”以及“在企业真实场景中如何应对复杂挑战”。</p>
<p>刚刚发布一天就收到了好评：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56790b20011a4f5983d1e0a6232b08a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563466&amp;x-signature=mfOaAGoITe80pjt%2Bc7OSwRGG7qw%3D" alt="项目收到的好评" loading="lazy"/></p>
<h2 data-id="heading-3">配套教程内容安排</h2>
<p>这个项目当前实现的功能比较简单，学习门槛极低，但涉及到的知识点比较丰富。通过保姆级教程，我们将从零构建一个融合了 <strong>LLM 集成、RAG（检索增强生成）、向量数据库、分布式限流及异步处理</strong>的完整后端架构。</p>
<p>无论你是想学习 <strong>Spring AI</strong> 的前沿应用，还是需要一个<strong>高含金量的简历项目</strong>，本项目都将为你提供从基建搭建、业务攻坚到面试话术复盘的全方位指导。</p>
<p>配套项目教程需要付费（<strong>后文/文末</strong>有加入方法），但请大家理解，主要是想覆盖一些时间成本。而且，收费和提供的服务相比绝对是超级良心了。这辈子不可能干割韭菜的事！</p>
<p><strong>内容安排如下（更新进度已过大半）</strong>：</p>
<h3 data-id="heading-4">环境搭建</h3>
<ol>
<li>本地搭建 PostgreSQL + PGvector 向量数据库</li>
<li>Spring Boot + RustFS 构建高性能 S3 兼容的对象存储服务</li>
<li>⭐大模型 API 申请和 Ollama 部署本地模型</li>
<li>环境搭建终章与项目启动</li>
</ol>
<h3 data-id="heading-5">核心功能开发</h3>
<ol>
<li>简历上传、多格式内容提取与解析</li>
<li>⭐Spring AI 与大模型集成</li>
<li>⭐Spring AI + pgvector 实现 RAG 知识库问答</li>
<li>手把手教你写出生产级结构化 Prompt</li>
<li>AI 模拟面试功能</li>
<li>基于 iText 8 实现 PDF 报告导出</li>
<li>基于 SSE（Server-Sent Events）的打字机效果输出</li>
<li>Docker Compose 一键部署</li>
</ol>
<h3 data-id="heading-6">进阶优化</h3>
<ol>
<li>统一异常处理与业务错误码设计</li>
<li>MapStruct 实体映射最佳实践</li>
<li>基于 Redis Stream 的异步任务处理实现</li>
<li>Spring Boot 4.0 升级指南</li>
<li>Docker Compose 一键部署</li>
</ol>
<h3 data-id="heading-7">面试</h3>
<ol>
<li>⭐简历编写与项目经历深度包装指南</li>
<li>面试官问“这个项目哪里来的”时，如何回答？</li>
<li>⭐Spring AI 面试问题挖掘</li>
<li>⭐知识库 RAG 面试问题挖掘</li>
<li>Redis 面试问题挖掘</li>
<li>文件上传和PDF到处面试问题挖掘</li>
</ol>
<h2 data-id="heading-8">加入学习</h2>
<p>如果你想学习这个项目，或者希望把它作为个人项目经历 / 毕设选题，我整理的这一套教程非常细致：从基础设施搭建、核心业务实现，到最后如何在面试中讲清楚思路与亮点，尽量把容易卡住的地方讲透。</p>
<p>如果你确实需要更系统的辅导，可以点这里了解详情（<strong>教程为付费内容</strong>，主要是想覆盖一些时间成本，望理解，感谢支持）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fzhuanlan%2Finterview-guide.html" target="_blank" title="https://javaguide.cn/zhuanlan/interview-guide.html" ref="nofollow noopener noreferrer">《SpringAI 智能面试平台+RAG 知识库》</a>。</p>
<h2 data-id="heading-9">系统架构</h2>
<p><strong>提示</strong>：架构图采用 draw.io 绘制，导出为 svg 格式，在 Dark 模式下的显示效果会有问题。</p>
<p>系统采用前后端分离架构，整体分为三层：前端展示层、后端服务层、数据存储层。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6bb9a26f3ec4b3b8717af3c0ca0fc26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563466&amp;x-signature=g9crUBDABo8stEOd75JsGXxn5Cw%3D" alt="系统架构" loading="lazy"/></p>
<p><strong>后端层</strong>：</p>
<ul>
<li>REST Controllers：统一的 API 入口，处理 HTTP 请求</li>
<li>业务服务层：
<ul>
<li>Resume Service：简历上传、解析、AI 分析
<ul>
<li>Interview Service：面试会话管理、问题生成、答案评估</li>
<li>Knowledge Service：知识库上传、文本分块、向量化</li>
<li>RAG Chat Service：检索增强生成，流式问答</li>
</ul>
</li>
</ul>
</li>
<li>异步处理层：基于 Redis Stream 的消费者，异步处理耗时的 AI 任务（如简历分析、向量化、面试评估）</li>
<li>AI 集成层：Spring AI + DashScope（通义千问）。统一的 LLM 调用接口，支持对话生成和文本向量化。</li>
</ul>
<p><strong>数据存储层</strong>：</p>
<ul>
<li>
<p>PostgreSQL + pgvector：</p>
<ul>
<li>关系数据：简历、面试记录、知识库元数据</li>
<li>向量检索：存储文档向量，支持相似度搜索</li>
</ul>
</li>
<li>
<p>Redis：</p>
<ul>
<li>会话缓存：面试会话状态</li>
<li>消息队列：Redis Stream 实现异步任务队列</li>
</ul>
</li>
<li>
<p>RustFS/MinIO (S3)：原始文件（简历 PDF、知识库文档）</p>
</li>
</ul>
<p><strong>异步处理流程</strong>：</p>
<p>简历分析、知识库向量化和面试报告生成采用 Redis Stream 异步处理，这里以简历分析和知识库向量化为例介绍一下整体流程：</p>
<pre><code class="hljs language-arduino" lang="arduino">上传请求 → 保存文件 → 发送消息到 <span class="hljs-built_in">Stream</span> → 立即返回
                              ↓
                      Consumer 消费消息
                              ↓
                    执行分析/向量化任务
                              ↓
                      更新数据库状态
                              ↓
                   前端轮询获取最新状态
</code></pre>
<p>状态流转： <code>PENDING</code> → <code>PROCESSING</code> → <code>COMPLETED</code> / <code>FAILED</code></p>
<p><strong>知识库问答处理流程</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">知识库问答 → 问题向量化 → pgvector 相似度搜索 → 检索相关文档
<span class="hljs-code">                                                      ↓
                                构建 Prompt → LLM 生成回答 → SSE 流式返回
</span></code></pre>
<h2 data-id="heading-10">技术栈概览</h2>
<h3 data-id="heading-11">后端技术</h3>























































<table><thead><tr><th>技术</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td>Spring Boot</td><td>4.0</td><td>应用框架</td></tr><tr><td>Java</td><td>21</td><td>开发语言</td></tr><tr><td>Spring AI</td><td>2.0</td><td>AI 集成框架</td></tr><tr><td>PostgreSQL + pgvector</td><td>14+</td><td>关系数据库 + 向量存储</td></tr><tr><td>Redis</td><td>6+</td><td>缓存 + 消息队列（Stream）</td></tr><tr><td>Apache Tika</td><td>2.9.2</td><td>文档解析</td></tr><tr><td>iText 8</td><td>8.0.5</td><td>PDF 导出</td></tr><tr><td>MapStruct</td><td>1.6.3</td><td>对象映射</td></tr><tr><td>Gradle</td><td>8.14</td><td>构建工具</td></tr></tbody></table>
<h3 data-id="heading-12">前端技术</h3>


















































<table><thead><tr><th>技术</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td>React</td><td>18.3</td><td>UI 框架</td></tr><tr><td>TypeScript</td><td>5.6</td><td>开发语言</td></tr><tr><td>Vite</td><td>5.4</td><td>构建工具</td></tr><tr><td>Tailwind CSS</td><td>4.1</td><td>样式框架</td></tr><tr><td>React Router</td><td>7.11</td><td>路由管理</td></tr><tr><td>Framer Motion</td><td>12.23</td><td>动画库</td></tr><tr><td>Recharts</td><td>3.6</td><td>图表库</td></tr><tr><td>Lucide React</td><td>0.468</td><td>图标库</td></tr></tbody></table>
<h2 data-id="heading-13">技术选型常见问题解答</h2>
<p>这里只是简单介绍，后续我会分享文章详细拷打技术选型。</p>
<h3 data-id="heading-14">为什么选择 Spring AI？</h3>
<p>Spring AI 是 Spring 官方推出的 AI 集成框架，提供了统一的 LLM 调用抽象。选择它的原因：</p>
<ol>
<li>统一抽象：一套代码支持多种 LLM 提供商（OpenAI、阿里云 DashScope、Ollama 等），切换模型只需修改配置</li>
<li>Spring 生态集成：与 Spring Boot 无缝集成，支持自动配置、依赖注入、声明式调用</li>
<li>内置向量存储支持：原生支持 pgvector、Milvus、Pinecone 等向量数据库，简化 RAG 开发</li>
<li>结构化输出：通过 <code>BeanOutputConverter</code> 将 LLM 输出直接映射为 Java 对象，无需手动解析 JSON</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 示例：Spring AI 结构化输出</span>
<span class="hljs-type">var</span> <span class="hljs-variable">converter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanOutputConverter</span>&lt;&gt;(ResumeAnalysisDTO.class);
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> chatClient.prompt()
    .system(systemPrompt)
    .user(userPrompt + converter.getFormat())
    .call()
    .content();
<span class="hljs-keyword">return</span> converter.convert(result);  <span class="hljs-comment">// 直接得到 Java 对象</span>
</code></pre>
<h3 data-id="heading-15">数据存储为什么选择 PostgreSQL + pgvector？</h3>
<p>本项目需要同时存储结构化数据（简历、面试记录）和向量数据（文档 Embedding）。方案对比：</p>

























<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>PostgreSQL + pgvector</td><td>一套数据库搞定，运维简单</td><td>向量检索性能不如专业向量库</td></tr><tr><td>PostgreSQL + Milvus</td><td>向量检索性能更好</td><td>多一个组件，运维复杂度增加</td></tr><tr><td>PostgreSQL + Pinecone</td><td>云托管，无需运维</td><td>成本高，数据在第三方</td></tr></tbody></table>
<p><strong>选择 pgvector 的理由</strong>：</p>
<ul>
<li>架构简单：不引入额外组件，降低部署和运维复杂度</li>
<li>性能够用：HNSW 索引支持毫秒级检索，万级文档场景完全够用</li>
<li>事务一致性：向量数据和业务数据在同一数据库，天然支持事务</li>
<li>SQL 查询：可以结合 WHERE 条件过滤，比如"只在某个分类的知识库中检索"</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- pgvector 相似度搜索示例</span>
<span class="hljs-keyword">SELECT</span> content, <span class="hljs-number">1</span> <span class="hljs-operator">-</span> (embedding <span class="hljs-operator">&lt;=&gt;</span> $<span class="hljs-number">1</span>) <span class="hljs-keyword">as</span> similarity
<span class="hljs-keyword">FROM</span> vector_store
<span class="hljs-keyword">WHERE</span> metadata<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">'category'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'Java'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> embedding <span class="hljs-operator">&lt;=&gt;</span> $<span class="hljs-number">1</span>
LIMIT <span class="hljs-number">5</span>;
</code></pre>
<p><strong>为什么不选择 MySQL 搭配向量数据库呢？</strong></p>
<p>PostgreSQL 最大的优势，也是它在 AI 时代甩开对手的“王牌”，就是其强大的可扩展性。开发者可以在不修改内核的情况下，像“即插即用”一样为数据库安装各种功能强大的插件，这让 PostgreSQL 变成了一个无所不能的“数据瑞士军刀”。</p>
<ul>
<li><strong>AI 向量检索？</strong> 有官方推荐的 <strong>pgvector</strong> 扩展，性能强大，生态成熟，足以媲美专业的向量数据库。</li>
<li><strong>全文搜索？</strong> 内置支持（能满足基础需求），或使用 <strong>pg_bm25</strong> 等扩展。</li>
<li><strong>时序数据？</strong> 有顶级的 <strong>TimescaleDB</strong> 扩展。</li>
<li><strong>地理信息？</strong> 有行业标准的 <strong>PostGIS</strong> 扩展。</li>
</ul>
<p>这种“一站式”解决能力，正是其魅力所在。它意味着许多项目不再需要依赖 Elasticsearch、Milvus 等大量外部中间件，仅凭一个增强版的 PostgreSQL 即可满足多样化需求，从而极大地简化了技术栈，降低了开发和运维的复杂度与成本。</p>
<p>关于 MySQL 和 PostgreSQL 的详细对比，可以参考我写的这篇文章：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FAPWD-PzTcTqGUuibAw7GGw" target="_blank" title="https://mp.weixin.qq.com/s/APWD-PzTcTqGUuibAw7GGw" ref="nofollow noopener noreferrer">MySQL vs PostgreSQL，如何选择？</a>。</p>
<h3 data-id="heading-16">为什么引入 Redis？</h3>
<p>本项目主要有两个场景用到了 Redis：</p>
<ol>
<li>Redis 替代 <code>ConcurrentHashMap</code> 实现会话的缓存。</li>
<li>基于 Redis Stream 实现简历分析、知识库向量化等场景的异步（还能解耦，分析和向量化可以使用其他编程语言来做）。</li>
</ol>
<p><strong>为什么引入 Redis Stream？为何不选择 Kafka、RabbitMQ 等更成熟的消息队列？</strong></p>
<p>简历分析、知识库向量化等 AI 任务耗时较长（10-60 秒），不适合同步处理。需要消息队列实现异步解耦。</p>


















































































<table><thead><tr><th align="left">维度</th><th align="left">Redis Stream</th><th align="left">RabbitMQ</th><th align="left">Kafka</th><th align="left">内存队列</th></tr></thead><tbody><tr><td align="left"><strong>吞吐量</strong></td><td align="left">高（十万级 QPS）</td><td align="left">中（万级 QPS）</td><td align="left">极高（百万级，水平扩展）</td><td align="left">极高（千万级/秒，受限于 CPU/内存）</td></tr><tr><td align="left"><strong>延迟</strong></td><td align="left">极低（亚毫秒级）</td><td align="left">低（毫秒级）</td><td align="left">中（毫秒到十毫秒级）</td><td align="left">极低（纳秒/微秒级）</td></tr><tr><td align="left"><strong>持久化</strong></td><td align="left">支持（RDB/AOF）</td><td align="left">支持（Mnesia/磁盘）</td><td align="left">强支持（原生分段日志）</td><td align="left">无（进程终止即失）</td></tr><tr><td align="left"><strong>消息堆积能力</strong></td><td align="left">一般（受限于内存）</td><td align="left">中（磁盘堆积，性能下降明显）</td><td align="left">极强（TB 级磁盘存储）</td><td align="left">差（受限于堆内存）</td></tr><tr><td align="left"><strong>消费模式</strong></td><td align="left">发布订阅 / 消费者组</td><td align="left">灵活路由 / 多种交换机模式</td><td align="left">发布订阅 / 消费者组</td><td align="left">点对点 / 多消费者（取决于实现）</td></tr><tr><td align="left"><strong>消息回溯</strong></td><td align="left">支持（按 ID / 时间范围）</td><td align="left">不支持</td><td align="left">强支持（按 Offset / 时间戳）</td><td align="left">不支持</td></tr><tr><td align="left"><strong>消息顺序性</strong></td><td align="left">单 Stream 有序</td><td align="left">单队列有序</td><td align="left">单 Partition 有序</td><td align="left">有序（单队列）</td></tr><tr><td align="left"><strong>可靠性</strong></td><td align="left">中（异步复制可能丢失）</td><td align="left">高（Publisher Confirm / 事务）</td><td align="left">极高（多副本 ISR + acks）</td><td align="left">低（无持久化、无确认）</td></tr><tr><td align="left"><strong>运维复杂度</strong></td><td align="left">低</td><td align="left">中</td><td align="left">高（KRaft 模式已简化）</td><td align="left">极低</td></tr><tr><td align="left"><strong>适用场景</strong></td><td align="left">轻量级流处理、已有 Redis 基础设施</td><td align="left">复杂路由、企业级集成</td><td align="left">大数据流、事件溯源、日志聚合</td><td align="left">进程内解耦、极致性能场景</td></tr></tbody></table>
<p>选择 Redis Stream 的理由：</p>
<ul>
<li>复用现有组件：Redis 已用于会话缓存，无需引入新中间件</li>
<li>功能满足需求：支持消费者组、消息确认（ACK）、持久化</li>
<li>运维简单：对于中小型项目，Redis Stream 完全够用</li>
</ul>
<h3 data-id="heading-17">构建工具为什么选择 Gradle？</h3>
<p>SpringBoot 官方现在用的就是 Gradle，加上国内现在都是 Maven 更多，换个 Gradle 还更新颖一些。</p>
<p>个人也更喜欢用 Gradle，也写过相关的文章：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Ftools%2Fgradle%2Fgradle-core-concepts.html" target="_blank" title="https://javaguide.cn/tools/gradle/gradle-core-concepts.html" ref="nofollow noopener noreferrer">Gradle 核心概念总结</a>。</p>
<h3 data-id="heading-18">为什么使用 MapStruct？</h3>
<p>项目中有大量 Entity ↔ DTO 转换需求，MapStruct 是编译时代码生成的对象映射框架：</p>



































<table><thead><tr><th>方案</th><th>性能</th><th>类型安全</th><th>使用复杂度</th></tr></thead><tbody><tr><td>MapStruct</td><td>零反射，最快</td><td>编译时检查</td><td>定义接口即可</td></tr><tr><td>BeanUtils</td><td>反射，慢</td><td>运行时报错</td><td>一行代码</td></tr><tr><td>ModelMapper</td><td>反射，较慢</td><td>运行时报错</td><td>配置复杂</td></tr><tr><td>手写转换</td><td>最快</td><td>编译时检查</td><td>重复代码多</td></tr></tbody></table>
<h3 data-id="heading-19">为什么使用 Apache Tika？</h3>
<p>系统需要解析多种格式的文档（PDF、Word、TXT），Apache Tika 是 Apache 基金会的文档解析库：</p>
<ul>
<li>格式支持全：PDF、DOCX、DOC、TXT、HTML、Markdown 等上百种格式</li>
<li>自动识别：根据文件内容自动检测格式，无需依赖文件扩展名</li>
<li>文本提取：统一的 API 提取纯文本，屏蔽格式差异</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Tika 解析示例</span>
<span class="hljs-type">Tika</span> <span class="hljs-variable">tika</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Tika</span>();
<span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> tika.parseToString(inputStream);  <span class="hljs-comment">// 自动识别格式并提取文本</span>
</code></pre>
<h3 data-id="heading-20">为什么使用 SSE 而不是 WebSocket？</h3>
<p>知识库问答需要流式输出（像 ChatGPT 那样逐字显示），有两种技术选择：</p>




















<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>SSE</td><td>简单，基于 HTTP，单向推送</td><td>仅支持服务端 → 客户端</td></tr><tr><td>WebSocket</td><td>双向通信，功能强大</td><td>协议复杂，需要维护连接状态</td></tr></tbody></table>
<p>选择 SSE 的理由：</p>
<ul>
<li>场景匹配：LLM 流式输出是单向的（服务端 → 客户端），不需要双向通信</li>
<li>实现简单：基于 HTTP，天然支持重连、跨域</li>
<li>Spring 支持好：<code>Flux&lt;ServerSentEvent&lt;String&gt;&gt;</code> 一行代码搞定</li>
</ul>
<h3 data-id="heading-21">前端为什么选择 React + TypeScript + Tailwind CSS？</h3>

























<table><thead><tr><th>技术</th><th>选择理由</th></tr></thead><tbody><tr><td>React</td><td>生态最成熟，组件化开发，社区资源丰富</td></tr><tr><td>TypeScript</td><td>类型安全，IDE 智能提示，减少运行时错误</td></tr><tr><td>Vite</td><td>开发服务器启动快（秒级），HMR 热更新体验好</td></tr><tr><td>Tailwind CSS</td><td>原子化 CSS，快速开发，无需写 CSS 文件</td></tr></tbody></table>
<h2 data-id="heading-22">效果展示</h2>
<h3 data-id="heading-23">简历与面试</h3>
<p>简历库：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8913d62737e45d38c4debd53e54cd58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563466&amp;x-signature=KyqyQvApNJIkML6bA%2Ftppr2YYjI%3D" alt="" loading="lazy"/></p>
<p>简历上传分析：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23375c516825453ba9e6cb20b6b76135~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563466&amp;x-signature=p8MxEJsdOUWWSunT8WuseCljebw%3D" alt="" loading="lazy"/></p>
<p>简历分析详情：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ad63c510a454b37bd6a5b7616dc21ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563466&amp;x-signature=OTJbmyFckkrj5D%2F4uySU8cTXLKg%3D" alt="" loading="lazy"/></p>
<p>面试记录：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80f94cd5656d4669a36c1e15ab26b169~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563466&amp;x-signature=F34exxhqZiS%2Fx%2BImZzYnpI%2BccwM%3D" alt="" loading="lazy"/></p>
<p>面试详情：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b87a4e2c3c904f388caa6a408d2c4e8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563466&amp;x-signature=p3V0%2BivuGgrdrnAOugrvC5JwvLM%3D" alt="" loading="lazy"/></p>
<p>模拟面试：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e0cda819f3a450aa6a2e2fd279649ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563466&amp;x-signature=qygZxAcfA2GN0vKn4Zq0W9dGBMc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-24">知识库</h3>
<p>知识库管理：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edb4352fe9214eea873d1ca834e9302c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563466&amp;x-signature=%2BjFl5kRabd9iuLVE1Y%2F9pY1bxes%3D" alt="" loading="lazy"/></p>
<p>问答助手：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e17ec6c4bb85455dbc0cde7270a31f9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563466&amp;x-signature=a0XDFTPD5mTGTtH7rfj1clazRJQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-25">学习本项目你将获得什么？</h2>
<p>本项目采用行业最前沿的 Java 21 + Spring Boot 4.0 技术栈，是市面上首个深度集成 Spring AI 2.0 的全栈实战项目。我们不仅提供高质量的代码，更配套了详尽的架构解析教程。</p>
<p>项目整体设计遵循“由浅入深”原则。即使你的编程基础尚浅，只需跟随我们的保姆级教程，也能顺利从零搭建出一套生产级别的 AI 大模型应用。</p>
<h3 data-id="heading-26">深度掌握 AI 应用开发的核心范式</h3>
<p>本项目是你从传统后端转型 AI 应用开发工程师的最佳敲门砖：</p>
<ul>
<li>
<p><strong>Spring AI 2.0 工业级实战</strong>：深入理解 Spring 官方的 AI 抽象层，掌握如何通过统一的声明式接口对接通义千问、OpenAI 等主流模型。</p>
</li>
<li>
<p><strong>Prompt Engineering（提示词工程）深度应用</strong>：告别简单的字符串拼接。学习如何构建结构化的 System/User Prompt，并利用 BeanOutputConverter 实现 LLM 输出向 Java 对象的自动化映射，彻底终结繁琐的 JSON 手动解析。</p>
</li>
<li>
<p><strong>RAG（检索增强生成）全链路闭环</strong>：深度拆解“文档解析 -&gt; 文本分块 -&gt; 向量化 (Embedding) -&gt; 向量数据库存储 -&gt; 相似度检索 -&gt; 上下文增强生成”的完整技术链条。</p>
</li>
</ul>
<h3 data-id="heading-27">现代化的 Java 后端架构思维</h3>
<p>你可以学习到优秀的工程实践：</p>
<ul>
<li><strong>拥抱 Java 21 与 Spring Boot 4.0</strong>：抢先布局虚拟线程 (Virtual Threads)、Record 类等高性能特性。针对 Spring Boot 4.0 的模块化设计进行深度适配，让你的技术栈领先市场。</li>
<li><strong>模块化单体架构</strong>：学习如何通过清晰的层级（Modules + Infrastructure + Common）组织代码。这种设计既具备微服务的解耦优势，又极大降低了单体应用的运维心智负担。</li>
<li><strong>极致的对象转换性能</strong>：通过 MapStruct 在编译期生成映射代码。学习如何在追求极致响应速度的场景下，优雅、安全地处理 Entity 与 DTO 之间的复杂映射。</li>
</ul>
<h3 data-id="heading-28">务实的数据存储与中间件选型</h3>
<p>我们拒绝盲目堆砌中间件，而是教你如何基于业务场景做出“最理智”的选择：</p>
<ul>
<li>**PostgreSQL + pgvector 的“一站式”存储方案：**掌握如何在同一套数据库中高效处理关系型业务数据与高维向量数据。深入学习 HNSW 索引在万级文档场景下的性能调优实践。</li>
<li><strong>Redis + Lua 分布式限流体系</strong>：实战封装高性能分布式限流组件。基于 Lua 脚本 保证限流逻辑的原子性，支持按用户、IP 或全局维度的精准流量控制，有效防御恶意刷接口行为，保障高价值 AI API 的配额安全。</li>
<li><strong>Redis Stream 异步任务处理</strong>：深入探讨在简历分析等耗时场景（10-60s）下，为什么选择轻量级的 Redis Stream 而非 Kafka。实战演示如何通过消息队列实现系统解耦与流量削峰。</li>
<li><strong>企业级文件处理与清洗优化</strong>：不仅利用 Apache Tika 构建通用的文档解析引擎，还配套实现了 TextCleaningService。通过正则清洗、空行标准化及文本去噪（如剔除图片链接、非法控制字符），显著提升 RAG 的召回质量；同时集成 内容哈希检测，从源头拦截重复上传，节省存储与 Token 成本。</li>
</ul>
<h3 data-id="heading-29">标准化的工程化交付与部署</h3>
<ul>
<li>
<p><strong>Gradle 现代构建体系</strong>：摆脱 Maven 的繁琐配置，掌握 Gradle 8.14 及其版本目录 (Version Catalog) 的灵活性，学习如何优雅地管理大型项目依赖。</p>
</li>
<li>
<p><strong>生产级容器化部署</strong>：通过 Docker Compose 一键搭建包含数据库扩展、缓存、对象存储在内的全套运行环境，理解云原生时代下的基础设施配置规范。</p>
</li>
</ul>
<h3 data-id="heading-30">丝滑的前端工程化与交互体验</h3>
<p>对于后端开发者，这更是一次补齐“全栈视野”的绝佳机会：</p>
<ul>
<li>
<p><strong>SSE (Server-Sent Events) 流式渲染</strong>：掌握像 ChatGPT 一样逐字输出回答的底层技术，理解其在单向推送场景下相比 WebSocket 的架构优势。</p>
</li>
<li>
<p><strong>响应式 UI 与动效设计</strong>：利用 Tailwind CSS 极简构建美观界面，结合 Framer Motion 实现高级交互动效。</p>
</li>
<li>
<p><strong>AI 数据可视化</strong>：通过 Recharts 将 AI 分析后的简历评分、多维对比以直观的雷达图形式呈现，让数据“会说话”。</p>
</li>
</ul>
<h2 data-id="heading-31">加入学习</h2>
<p>如果你想学习这个项目，或者希望把它作为个人项目经历 / 毕设选题，我整理的这一套教程非常细致：从基础设施搭建、核心业务实现，到最后如何在面试中讲清楚思路与亮点，尽量把容易卡住的地方讲透。</p>
<p>如果你确实需要更系统的辅导，可以点这里了解详情（<strong>教程为付费内容</strong>，主要是想覆盖一些时间成本，望理解，感谢支持）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fzhuanlan%2Finterview-guide.html" target="_blank" title="https://javaguide.cn/zhuanlan/interview-guide.html" ref="nofollow noopener noreferrer">《SpringAI 智能面试平台+RAG 知识库》</a>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一月存档，二月加载]]></title>    <link>https://juejin.cn/post/7601843004958277678</link>    <guid>https://juejin.cn/post/7601843004958277678</guid>    <pubDate>2026-02-01T15:12:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601843004958277678" data-draft-id="7601715462921322506" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一月存档，二月加载"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-02-01T15:12:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一月存档，二月加载
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T15:12:57.000Z" title="Sun Feb 01 2026 15:12:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>时间过得真快，一转眼一月已经结束，二月悄然来临。二月份马上春节就来临了，今天正好也是二月份第一天，也是周天，我想简单回顾一下过去一个月的生活、工作和学习，也期待新的一年有更多的成长与收获。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fee0e11f0314ac5947cf0c7a78bbc1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563578&amp;x-signature=P%2F3rTQ6f1gUKEibNdKTuhjDATKM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">💼工作：节奏暂缓，整装待发</h2>
<p>一月份的工作节奏相对平缓。阳历元旦之前，我参与的几个项目基本都已顺利交付，这也让我在一月没有太多紧急任务的追赶，基本都是下班就回家，也是让我可以把更多的时间投入到家庭中去。</p>
<h2 data-id="heading-1">🏡生活：新手奶爸，忙中成长</h2>
<p>一月份对我来说，最大的变化就是正式进入了“新手奶爸”的角色。元旦刚休完陪产假，一月份几乎都在学习和适应带娃这件事上。从一开始的手忙脚乱、睡不够觉，娃一哼就醒，到后来逐渐找到一些节奏，虽然还谈不上得心应手，但至少能独立完成换尿不湿、协助看娃这些日常任务。当然，过程中也少不了毛手毛脚，还需要家人帮忙“救场”，但每一次尝试都在积累经验。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7095f0a3afe54c1b9eddf94747ffe798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563578&amp;x-signature=KJ4fevnxMMK6ZkOl610tINPt7J4%3D" alt="" loading="lazy"/></p>
<p>这段日子里，最触动我的，是两代人育儿观念碰撞背后那份深沉的付出。父母带着几十年的经验与无条件的爱前来帮忙，从清晨到深夜，不辞辛劳地分担着带娃的琐碎与沉重。我们在传统与新知之间寻找平衡，在经验与科学之间搭建桥梁——这不是简单的妥协，而是在理解与感恩中完成的爱的接力。母亲顶着困意一次次抱起哭闹的孙子，这些细节里藏着的，是他们从未说出口的“我想帮你们多一点”。这不仅是育儿方式的磨合，更是三代人之间无言的理解与传递。父母用他们的方式，默默地支撑着我们这个小家的起步。而我们，也在这样的碰撞中，更深刻地体会到何为付出，何为传承。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d536282535d041ca95db3d912464e741~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563578&amp;x-signature=gNknFdLN8bo18BjJuUcfU%2BWZXKw%3D" alt="" loading="lazy"/></p>
<p>而最让我心疼的，是妻子成为母亲后那份静默而坚韧的付出。产后恢复本已是一段艰辛的旅程，她却要同时承受身体的虚弱与育儿的重担。每一天，她都在母乳喂养、哄睡安抚、日常照料中循环往复；每一个夜晚，她都在困倦中醒来，在疲惫中坚持。从孕前的神采飞扬到如今的温柔坚强，我看见的不只是面容的疲惫，更是一位母亲从身体到心理的全然蜕变。</p>
<p>这段经历让我深刻意识到：哺乳期的妈妈需要的远不止生活上的照料，更需要心灵上的看见与呵护。她们承受的不仅是生理的负担，还有初为人母的焦虑、自我价值的怀疑、睡眠不足的抑郁倾向，以及随时可能来袭的孤独感。这些看不见的情绪重量，往往比身体的劳累更需要被温柔承接。每一位母亲都在以我们看不见的方式经历着内在的战争——她们用最柔软的心，承担着最沉重的转变。</p>
<p>我希望每个父亲都能给哺乳期的妈妈更多心理上的空间：少一些评判，多一些倾听；少一些要求，多一些包容；少一些理所当然，多一些“我懂你的不容易”。因为母亲的伟大，不仅在于她做了什么，更在于她在承受着什么。</p>
<p>正是在这些昼夜不息的守护中，我渐渐明白：爱不仅是相伴的温暖，更是当一个人最脆弱时的理解，最疲惫时的支撑，最迷茫时的陪伴。而这些，或许才是我们能为一位母亲提供的最珍贵的呵护。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/700f1e62b22647eeaccf748e616cf48a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563578&amp;x-signature=C36fHDCXHxo8FIWBquUMpELvDwM%3D" alt="" loading="lazy"/></p>
<p>最近在网上看到一句话，瞬间被戳中心扉：“遇事不责三冬暖，家人互谅四季安”。是啊，我们都是血肉之躯，没有上帝的视角，看不清彼此生活里的全貌与挣扎。正因如此，才更需要放下苛责，拾起理解。尤其在家庭之中，在那些关于育儿、生活的碰撞时刻，一句体谅的话语，一个换位的思考，远胜过百句抱怨与指责。愿我们都能在琐碎的日常里，修得这份“不责”的智慧与“互谅”的温柔——让家成为彼此最温暖的归处，而不只是道理的战场。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3067244e86bf440c9c46311196c4c161~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770563578&amp;x-signature=dJ%2BWniqefpV64YpGjp3Eeb6VMg8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">📚学习：坚持输出，计划前行</h2>
<p>一月份我在学习上做的最持续的一件事，是坚持每天写一篇技术博文。内容大多围绕开源项目的介绍、使用体验或技术细节展开，虽然算不上多深入，但能保持每日输出，对我来说是一种难得的自律训练。写作过程也反过来推动我去阅读文档、动手实践，形成了良性循环。</p>
<p>接下来，我计划逐渐转向更系统的学习方向——<strong>AI 技术栈</strong>。我打算从基础概念入手，学习一些常见的 AI 工具和框架，并尝试借助 AI 辅助完成一个简单的全栈项目。这不仅是技术上的探索，也是对自己学习能力和工程能力的一次检验。</p>
<h2 data-id="heading-3">✍️写在二月之前</h2>
<p>一月份像是一个温柔的过渡，工作上的暂时舒缓，生活中的角色转变，学习上的持续积累，都让我在新的一年里有了一个温暖而扎实的开端。二月已来，春天也不远了。期待在这个月里，继续保持生活的温度，提升工作的效率，拓展学习的边界。</p>
<p>你好，二月。<br/>
再见，一月，谢谢你带给我的所有体验与成长。</p>
<hr/>
<p><strong>如果你也在一月有些许收获，或是在二月有什么计划，欢迎留言一起交流 🌱</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hello，算法：微博热搜的背后]]></title>    <link>https://juejin.cn/post/7601477334931668998</link>    <guid>https://juejin.cn/post/7601477334931668998</guid>    <pubDate>2026-02-01T15:34:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601477334931668998" data-draft-id="7601427909702500406" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hello，算法：微博热搜的背后"/> <meta itemprop="keywords" content="前端,JavaScript,算法"/> <meta itemprop="datePublished" content="2026-02-01T15:34:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="灵感__idea"/> <meta itemprop="url" content="https://juejin.cn/user/641770521368606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hello，算法：微博热搜的背后
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/641770521368606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    灵感__idea
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T15:34:36.000Z" title="Sun Feb 01 2026 15:34:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>每个系列一本前端好书，帮你轻松学重点。</p>
<p>本系列来自上海交通大学硕士，华为高级算法工程师 <strong>靳宇栋</strong> 的 <strong>《Hello，算法》</strong></p>
<p>截至本文编辑时，hello-algo项目Star数已飙升至<strong>122k</strong>，文末参与活动，获赠微信读书付费会员。</p>
</blockquote>
<p>每天一睁眼，新闻头条、微博热搜都能抓住很多人的目光，购物时也会有商品排行榜，它们无形中对我们的注意力和决策产生重要影响。</p>
<p>那么，生活中随处可见的排行榜，在程序里如何做到，算法又叫什么呢？</p>
<p>它就是“Top-K”。什么是“Top-K”?</p>
<p><strong>给定一个长度为n的无序数组 nums ，返回数组中最大的K个元素。</strong></p>
<p>怎样从海量数据中找出Top-K？</p>
<h2 data-id="heading-0">直觉</h2>
<h4 data-id="heading-1">1、遍历</h4>
<p>从所有数据中找，每轮找出剩余数据中最大的。比如：</p>
<blockquote>
<p>1 10 3 5 13 7 9 15 18</p>
</blockquote>
<p>这样一组数，找出Top3的步骤：第一轮找出18，第二轮找出15，第三轮找出13，以此类推，要找Top几就要找几轮，时间复杂度为 O(n²)。</p>
<h4 data-id="heading-2">2、先排后选</h4>
<p>既然要找Top-K，把整个都排一遍，变成有序的，再从中取前K个，也能达到目的。</p>
<p>这种方案的时间复杂度为 O（nlog n）。</p>
<p>可能还有人对复杂度没有概念，我们直观比较一下：</p>









































<table><thead><tr><th>数据量(n)</th><th>O(n log n)</th><th>O(n²)</th><th>倍差</th></tr></thead><tbody><tr><td>10</td><td>~33</td><td>100</td><td>3倍</td></tr><tr><td>100</td><td>~664</td><td>10,000</td><td>15倍</td></tr><tr><td>1,000</td><td>~9,966</td><td>1,000,000</td><td>100倍</td></tr><tr><td>10,000</td><td>~132,877</td><td>100,000,000</td><td>752倍</td></tr><tr><td>100,000</td><td>~1,660,964</td><td>10,000,000,000</td><td>6,018倍</td></tr></tbody></table>
<p>这么看，随着数量级的跃升，方案二优势越来越大，提升已经十分明显。</p>
<p>还有优化空间么？</p>
<h2 data-id="heading-3">痛点</h2>
<p>1、遍历方案</p>
<p>简单，但效率低。只有在待排数量K和总数N之间差距较大时，能勉强接受，如果K和N接近，时间复杂度就趋向于O（n²），非常耗时。</p>
<p>2、先排后选</p>
<p>看起来已经不错，但不难发现，我们要找的是Top-K，不是Top-N，它做了<strong>多余的工作。</strong></p>
<p>当K和N的差距越大，多余工作越多，二者相等时，就是纯排序了。</p>
<p>此外，实际上对我们有用的只是前K个元素，而不是全部的N个元素，这种方案对<strong>内存也造成浪费</strong>。</p>
<p>可见，从直觉而来的方法，虽然易上手，但不够好，我们要做的，就是 <strong>“升级”直觉</strong>。</p>
<p>那么，谁最适合用来解决Top-K问题？</p>
<h2 data-id="heading-4">初识“堆”</h2>
<p>关于“堆”，其实你也很熟悉，“土堆、沙子堆、垃圾堆”，下面要讲的“堆”和它们没有本质区别。就像这样：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9305ba4b2bbc491c9dbc3ed176e82ee4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G15oSfX19pZGVh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770565990&amp;x-signature=CF30aybd0RHdme0w4siIuJX68bE%3D" alt="image" loading="lazy"/></p>
<p>你可能会说：这不是树吗？</p>
<p>没错，通常来说，树应该是根在下，叶子在上，但在算法中一般是倒过来看，倒过来后它本身就很像是一个，堆...</p>
<p>堆是一种满足特定条件的完全二叉树，问题来了，什么是“完全二叉树”...打住！</p>
<p>我们不能陷入由一个问题带来另一个问题的循环中，只需要关注当下的关键目标。</p>
<p>堆满足的特定条件是：节点间需要固定的相对大小关系，一个节点要么比父大，要么比父小，由此划分为“<strong>大顶堆</strong>”和“<strong>小顶堆</strong>”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82cfeb937cf644bdbcd4311b3d9e4ef4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G15oSfX19pZGVh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770565990&amp;x-signature=gi96g8MBmWdf07cK2eIGpSZARV4%3D" alt="image" loading="lazy"/></p>
<p>形成了堆的特点，它就能发挥自己独有的威力。</p>
<p>很多编程语言都提供了“堆”的数据结构，称作“Heap”，遗憾的是，JavaScript中并没有。</p>
<h2 data-id="heading-5">为什么是它</h2>
<p>“堆”结构有什么优势，为什么它是实现Top-K的最佳方案？</p>
<p>原理如下：</p>
<ol>
<li>初始化一个小顶堆，其堆顶元素最小。</li>
<li>将前 k 个元素依次入堆。</li>
<li>从第 k + 1 个元素开始，若当前元素大于堆顶元素，则将堆顶元素出堆，并将当前元素入堆。</li>
<li>遍历完成后，堆中保存的就是最大的 k 个元素。</li>
</ol>
<p>这4个步骤，弥补了上述方案的短板：</p>
<ul>
<li>不需要维护 N 个元素</li>
<li>不需要遍历 K 轮</li>
<li>支持动态更新，且效率很高</li>
</ul>
<h2 data-id="heading-6">核心代码</h2>
<p>你应该还记得上篇文用数组实现的“哈希”，本篇亦然（一点都不意外~）</p>
<p>可是数组只有一对一的“索引”和“值”，怎么构造成堆呢？需要将其中的元素代表节点值，索引代表节点的位置。节点指针则通过<strong>索引映射公式</strong>来实现。</p>
<p>为方便使用，我们将映射公式封装成函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/* 获取左子节点的索引 */</span>
<span class="hljs-title function_">left</span>(<span class="hljs-params">i</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span> * i + <span class="hljs-number">1</span>;
}

<span class="hljs-comment">/* 获取右子节点的索引 */</span>
<span class="hljs-title function_">right</span>(<span class="hljs-params">i</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span> * i + <span class="hljs-number">2</span>;
}

<span class="hljs-comment">/* 获取父节点的索引 */</span>
<span class="hljs-title function_">parent</span>(<span class="hljs-params">i</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((i - <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>); <span class="hljs-comment">// 向下整除</span>
}
</code></pre>
<p>这些公式什么意思，又是怎么来的？具体表现如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4906559609340bf90bae55c8bc9c919~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G15oSfX19pZGVh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770565990&amp;x-signature=YedZu2rWRT%2B%2BLfSHv7T6ZjAzJm0%3D" alt="image" loading="lazy"/></p>
<p>公式描述的是，<strong>给定一个节点 i，通过它来定位“左、右、父”节点</strong>。这里只关心位置和索引，跟值无关。</p>
<p>当堆结构形成后，就可以进行相关操作了。</p>
<p>主要关注：<strong>入堆</strong>和<strong>出堆</strong>。</p>
<p>因为它们可能打破堆结构已经形成的平衡，要做出调整来重新获得平衡。</p>
<h2 data-id="heading-7">入堆</h2>
<p>关键步骤：</p>
<ol>
<li>将新元素添加至堆底，即数组中新增一个元素；</li>
<li>新增元素可能小于堆顶的元素，也可能大于，小的时候不用动，如果大，则需要自底向上一路比较，这个操作称作“<strong>堆化</strong>”。</li>
<li>堆化的过程就是在做<strong>逐层比较和交换</strong>，直至越过根节点或遇到无须交换的节点，结束。</li>
</ol>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/* 元素入堆 */</span>
push(<span class="hljs-keyword">val</span>) {
    <span class="hljs-comment">// 添加节点</span>
    <span class="hljs-keyword">this</span>.maxHeap.push(<span class="hljs-keyword">val</span>);
    <span class="hljs-comment">// 从底至顶堆化</span>
    <span class="hljs-keyword">this</span>.siftUp(<span class="hljs-keyword">this</span>.size() - <span class="hljs-number">1</span>);
}

<span class="hljs-comment">/* 从节点 i 开始，从底至顶堆化 */</span>
siftUp(i) {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-comment">// 获取节点 i 的父节点</span>
        <span class="hljs-keyword">const</span> p = <span class="hljs-keyword">this</span>.parent(i);
        <span class="hljs-comment">// 当“越过根节点”或“节点无须修复”时，结束堆化</span>
        <span class="hljs-keyword">if</span> (p &lt; <span class="hljs-number">0</span> || <span class="hljs-keyword">this</span>.maxHeap[i] &lt;= <span class="hljs-keyword">this</span>.maxHeap[p]) <span class="hljs-keyword">break</span>;
        <span class="hljs-comment">// 交换两节点</span>
        <span class="hljs-keyword">this</span>.swap(i, p);
        <span class="hljs-comment">// 循环向上堆化</span>
        i = p;
    }
}
</code></pre>
<p>入堆这么麻烦，出堆是不是就容易了，直接删掉？</p>
<p>当然不是，堆中的元素都存在着相互关联，直接删掉带来的结果是，其余所有元素都要发生变化，这不是明智的做法。</p>
<h2 data-id="heading-8">出堆</h2>
<p>出堆操作也分为以下几步：</p>
<ol>
<li>交换堆顶元素与堆底元素（根节点与最右叶节点）。</li>
<li>将堆底元素从列表中删除（注意，由于已经交换，因此实际上删除的是原来的堆顶元素）。</li>
<li>从根节点开始，<strong>从顶至底执行堆化</strong>。</li>
</ol>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/* 元素出堆 */</span>
pop() {
    <span class="hljs-comment">// 判空处理</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isEmpty()) <span class="hljs-keyword">throw</span> new Error(<span class="hljs-string">'堆为空'</span>);
    <span class="hljs-comment">// 交换根节点与最右叶节点（交换首元素与尾元素）</span>
    <span class="hljs-keyword">this</span>.swap(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.size() - <span class="hljs-number">1</span>);
    <span class="hljs-comment">// 删除节点</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> = <span class="hljs-keyword">this</span>.maxHeap.pop();
    <span class="hljs-comment">// 从顶至底堆化</span>
    <span class="hljs-keyword">this</span>.siftDown(<span class="hljs-number">0</span>);
    <span class="hljs-comment">// 返回堆顶元素</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">val</span>;
}

<span class="hljs-comment">/* 从节点 i 开始，从顶至底堆化 */</span>
siftDown(i) {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-comment">// 判断节点 i, l, r 中值最大的节点，记为 ma</span>
        <span class="hljs-keyword">const</span> l = <span class="hljs-keyword">this</span>.left(i),
            r = <span class="hljs-keyword">this</span>.right(i);
        let ma = i;
        <span class="hljs-keyword">if</span> (l &lt; <span class="hljs-keyword">this</span>.size() &amp;&amp; <span class="hljs-keyword">this</span>.maxHeap[l] &gt; <span class="hljs-keyword">this</span>.maxHeap[ma]) ma = l;
        <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-keyword">this</span>.size() &amp;&amp; <span class="hljs-keyword">this</span>.maxHeap[r] &gt; <span class="hljs-keyword">this</span>.maxHeap[ma]) ma = r;
        <span class="hljs-comment">// 若节点 i 最大或索引 l, r 越界，则无须继续堆化，跳出</span>
        <span class="hljs-keyword">if</span> (ma === i) <span class="hljs-keyword">break</span>;
        <span class="hljs-comment">// 交换两节点</span>
        <span class="hljs-keyword">this</span>.swap(i, ma);
        <span class="hljs-comment">// 循环向下堆化</span>
        i = ma;
    }
}
</code></pre>
<h2 data-id="heading-9">Top-K的堆实现</h2>
<p>看完了入堆和出堆代码，来完整看一下基于堆寻找最大 K 元素的示例代码。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/* 元素入堆 */</span>
function <span class="hljs-built_in">pushMinHeap</span>(maxHeap, val) {
    <span class="hljs-comment">// 元素取反</span>
    maxHeap<span class="hljs-selector-class">.push</span>(-val);
}

<span class="hljs-comment">/* 元素出堆 */</span>
function <span class="hljs-built_in">popMinHeap</span>(maxHeap) {
    <span class="hljs-comment">// 元素取反</span>
    return -maxHeap<span class="hljs-selector-class">.pop</span>();
}

<span class="hljs-comment">/* 访问堆顶元素 */</span>
function <span class="hljs-built_in">peekMinHeap</span>(maxHeap) {
    <span class="hljs-comment">// 元素取反</span>
    return -maxHeap<span class="hljs-selector-class">.peek</span>();
}

<span class="hljs-comment">/* 取出堆中元素 */</span>
function <span class="hljs-built_in">getMinHeap</span>(maxHeap) {
    <span class="hljs-comment">// 元素取反</span>
    return maxHeap<span class="hljs-selector-class">.getMaxHeap</span>()<span class="hljs-selector-class">.map</span>((num) =&gt; -num);
}

<span class="hljs-comment">/* 基于堆查找数组中最大的 k 个元素 */</span>
function <span class="hljs-built_in">topKHeap</span>(nums, k) {
    <span class="hljs-comment">// 初始化小顶堆</span>
    <span class="hljs-comment">// 请注意：我们将堆中所有元素取反，从而用大顶堆来模拟小顶堆</span>
    const maxHeap = new <span class="hljs-built_in">MaxHeap</span>([]);
    <span class="hljs-comment">// 将数组的前 k 个元素入堆</span>
    for (let i = <span class="hljs-number">0</span>; i &lt; k; i++) {
        <span class="hljs-built_in">pushMinHeap</span>(maxHeap, nums[i]);
    }
    <span class="hljs-comment">// 从第 k+1 个元素开始，保持堆的长度为 k</span>
    for (let i = k; i &lt; nums.length; i++) {
        <span class="hljs-comment">// 若当前元素大于堆顶元素，则将堆顶元素出堆、当前元素入堆</span>
        if (nums[i] &gt; peekMinHeap(maxHeap)) {
            <span class="hljs-built_in">popMinHeap</span>(maxHeap);
            <span class="hljs-built_in">pushMinHeap</span>(maxHeap, nums[i]);
        }
    }
    <span class="hljs-comment">// 返回堆中元素</span>
    return <span class="hljs-built_in">getMinHeap</span>(maxHeap);
}
</code></pre>
<p>整个过程总共执行了 N 轮入堆和出堆，堆的最大长度为 K ，因此时间复杂度为 O（n log k） 。</p>
<p>该方法的效率很高，当 k 较小时，时间复杂度趋向 O(n)；当 k 较大时，不会超过 O(n log n) 。</p>
<p>当有数据不断加入，它可以持续维护堆内的元素，从而实现最大的 k 个元素的动态更新。</p>
<h2 data-id="heading-10">其他应用</h2>
<ul>
<li><strong>优先队列</strong>：堆通常作为实现优先队列的首选数据结构，其入队和出队操作的时间复杂度均为 O(log n) ，而建堆操作为 O(n) ，都非常高效。</li>
<li><strong>堆排序</strong>：给定一组数据，我们可以用它们建立一个堆，然后不断地执行元素出堆操作，从而得到有序数据。</li>
</ul>
<h2 data-id="heading-11">小结</h2>
<p>本篇文章，我们介绍了使用堆实现Top-K的原理，这是一种经典方式，但不是唯一方式。根据具体场景和数据特点，也可以选择其他方案。比如：快速选择、计数排序/桶排序等。</p>
<p>这就是工程实践中的<strong>经典权衡</strong>，理论复杂度只是起点，实际选择需要考虑内存、实时性、数据特性、系统架构等综合因素。</p>
<p><strong>送“书”活动来啦！</strong></p>
<p>之前总有人问《JavaScript高级程序设计》（第5版）有电子版吗？现在有啦！</p>
<p>参与方式(“前端说书匠”公众号内参与)：</p>
<p>1、点个小❤ + 转发朋友圈</p>
<p>2、分享你2026年的学习计划或者你想要看到解读的书籍/知识点</p>
<p>1、2须同时满足，最终取评论点赞数前三，若有并列，以时间为序</p>
<p>如有特别优质的，可获额外奖励，此条解释权归“说书匠”所有。</p>
<p>开始时间：2026年2月2日早9:00，本篇文章发布后</p>
<p>截止时间：2026年2月6日晚23:00</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从踌躇到拥抱：为什么说 KMP 已迈入黄金时代]]></title>    <link>https://juejin.cn/post/7601313474719957027</link>    <guid>https://juejin.cn/post/7601313474719957027</guid>    <pubDate>2026-02-01T15:42:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601313474719957027" data-draft-id="7601313474719940643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从踌躇到拥抱：为什么说 KMP 已迈入黄金时代"/> <meta itemprop="keywords" content="客户端,Android,Kotlin"/> <meta itemprop="datePublished" content="2026-02-01T15:42:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="fundroid"/> <meta itemprop="url" content="https://juejin.cn/user/3931509309842872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从踌躇到拥抱：为什么说 KMP 已迈入黄金时代
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3931509309842872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    fundroid
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T15:42:33.000Z" title="Sun Feb 01 2026 15:42:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在技术选型的十字路口，开发者社区对一个新兴框架的态度，往往会经历从质疑、观望到最终拥抱的完整周期。对于 Kotlin Multiplatform (KMP) 与其 UI 搭档 Compose Multiplatform (CMP) 而言，2024 至 2025 年无疑是其发展的分水岭。曾经，它们在许多开发者眼中是“听起来很美但用起来很慌”的代名词——对项目复杂性、生态成熟度、乃至学习曲线的担忧，构筑了一道无形的墙。</p>
<p>当开发者真正跨越心理门槛，深入实践后，往往会发现一片新大陆。这种“真香定律”的背后，并非仅仅是个人体验的转变，而是整个技术生态系统在近年来一系列坚实、持续的进化中，共同抵达了“生产力可用”的临界点。</p>
<p>本文将以工程视角，结合 2024 年以来 JetBrains、Google 等核心参与者的官方发布与社区的真实反馈，系统性地论证：<strong>Kotlin Multiplatform 与 Compose Multiplatform 不再是实验性的屠龙之技，而是已经迈入成熟期，成为 2026 年值得技术管理者和移动开发者严肃考虑的务实选项。</strong></p>
<h2 data-id="heading-1">一、基石之变： Kotlin 2.0 与 K2 编译器</h2>
<p>任何跨平台框架的雄心，都必须建立在其语言和编译器的坚实地基之上。KMP 的成熟，首先要归功于其底层核心的革命性升级——<strong>Kotlin 2.0 与其搭载的全新 K2 编译器</strong>。</p>
<p>K2 编译器的正式稳定（GA），对于 Kotlin 语言而言，其意义不亚于一次“引擎换代”。它并非简单的性能优化，而是一次对编译器前端架构的彻底重写。根据 JetBrains 在 2024 年 5 月发布的官方博文，K2 带来的最直观改变是<strong>编译速度的显著提升，部分真实世界项目甚至实现了近乎翻倍的性能</strong>。在 JetBrains 内部一个包含超过 1200 万行 Kotlin 代码的巨型项目中，切换到 K2 模式后，构建时间缩短了 40%。对于长期困扰跨平台开发者的编译耗时与 CI/CD 效率问题，这是一个釜底抽薪式的解决方案。</p>
<blockquote>
<p><strong>K2 的核心价值：统一与加速</strong>
K2 编译器最大的战略意义在于，它<strong>统一了 Kotlin 所支持的所有平台（JVM, Native, JS/Wasm）的分析管线</strong>。过去，不同的后端有着各自独立的前端实现，导致新语言特性和优化需要重复开发、分别适配。如今，所有后端共享一套前端逻辑，这意味着：</p>
<ul>
<li><strong>新功能同步抵达</strong>：语言的新特性（例如 Kotlin 2.2 中备受期待的上下文参数）可以一次性为所有平台实现，大大加速了语言本身的演进。</li>
<li><strong>生态建设提速</strong>：基于统一的分析能力，JetBrains 正在开发下一代 KMP 库分发格式。这将从根本上解决“必须在 macOS 环境下才能发布 iOS 库”等历史遗留问题，使得多平台库的开发体验无限接近于纯粹的 JVM 库，从而极大地促进了 KMP 生态的繁荣。</li>
</ul>
</blockquote>
<p>更重要的是，伴随着 <strong>Kotlin 1.9.20 版本，Kotlin Multiplatform 技术本身正式宣告稳定（Stable）</strong>。这意味着其核心 API、Gradle 插件配置、库发布格式等关键部分都将遵循严格的向后兼容性保证。对于追求技术方案稳定性的企业决策者而言，这无疑是最强有力的定心丸。它标志着 KMP 已经完成了从“Alpha/Beta 探索期”到“生产可用期”的身份转变。</p>
<p>同样关键的是，<strong>Kotlin/Native 的新内存模型也在近年趋于稳定</strong>，彻底告别了过去在并发编程上给开发者带来的心智负担。这为在 KMP 中编写高性能、高并发的共享业务逻辑扫清了最后的障碍。</p>
<p>可以说，一个更快、更智能、更统一的语言和编译器底座，为 KMP 生态的全面成熟打下了最坚实的基础。</p>
<h2 data-id="heading-2">二、逻辑层革命：共享代码生态从“可用”到“丰富”</h2>
<p>如果说 K2 编译器是“发动机”，那么多平台库生态就是让 KMP 这辆车能够跑起来的“车轮”。在 2024-2025 年，KMP 的逻辑层共享生态经历了一场从“基本可用”到“丰富优选”的质变，其核心驱动力源于两大生态的深度融合。</p>
<h3 data-id="heading-3">Jetpack 库的多平台化：Google 的官方背书与赋能</h3>
<p>长期以来，KMP 开发者在构建共享逻辑时，需要依赖社区提供的各类第三方库。尽管社区充满活力，但库的质量、维护持续性以及与 Android 官方实践的一致性，始终是技术管理者心中的一丝顾虑。</p>
<p>这一局面在 <strong>Google I/O 2024 大会宣布正式支持 KMP</strong> 后被彻底改变。这不仅是一句口号，而是实实在在的工程投入。Google 不仅在自家的 Workspace、Google Docs 等核心应用的 iOS 版中大规模采用 KMP，并验证了其生产环境的稳定性与性能，更重要的是，<strong>Google 启动了将核心 Jetpack 库多平台化的战略</strong>。</p>
<p>根据 JetBrains 与 Google 发布的 2025 路线图和相关博客，截至 2025 年底，多个开发者在 Android 端耳熟能详的 Jetpack 库已为 iOS 提供了<strong>一级（Tier-1）支持</strong>，这意味着它们经过了全面测试，可以稳定地用于生产环境：</p>



































<table><thead><tr><th><strong>Jetpack 库</strong></th><th><strong>核心功能</strong></th><th><strong>在 KMP 中的价值</strong></th></tr></thead><tbody><tr><td><strong>Room (2.7.2+)</strong></td><td>结构化本地数据库</td><td>在共享模块中实现统一、类型安全的数据库访问逻辑，告别在 iOS 端手写 SQL 或封装 CoreData 的繁琐。</td></tr><tr><td><strong>DataStore (1.1.7+)</strong></td><td>键值对/对象存储</td><td>替代 SharedPreferences 和 NSUserDefaults，提供基于 Flow 的现代化异步数据存储方案。</td></tr><tr><td><strong>Paging (3.3.6+)</strong></td><td>分页加载</td><td>在共享 ViewModel 中实现复杂的、支持网络和数据库源的分页加载逻辑，UI 层只需简单消费数据流。</td></tr><tr><td><strong>ViewModel (2.9.2+)</strong></td><td>UI 相关的状态管理</td><td>允许开发者在 <code>commonMain</code> 中编写 ViewModel，真正实现业务逻辑与 UI 状态的跨平台共享。</td></tr><tr><td><strong>Lifecycle (2.9.2+)</strong></td><td>生命周期感知</td><td>配合 ViewModel，在共享代码中安全地管理协程作用域，避免内存泄漏。</td></tr></tbody></table>
<blockquote>
<p><strong>范式转移的信号</strong>
Jetpack 库的跨平台化，其意义远超“多了几个可用的库”。它标志着 <strong>Android 官方认可的最佳架构实践，正在通过 KMP 自然地延伸到 iOS 平台</strong>。对于广大 Android 开发者而言，这意味着他们可以将业已纯熟的技能栈（Kotlin + Coroutines + Flow + Jetpack）无缝迁移至跨平台开发，学习曲线被极大地拉平。对于技术管理者，这意味着可以基于同一套经过大规模验证的架构模式来构建和评估两个平台的应用，显著降低了技术栈的复杂度和团队认知负荷。</p>
</blockquote>
<h3 data-id="heading-4">KMP 原生库生态的持续繁荣</h3>
<p>除了 Jetpack 的加持，KMP 自身的原生库生态也愈发成熟。</p>
<ul>
<li>
<p><strong>网络层</strong>：<strong>Ktor</strong> 作为 JetBrains 的亲生子，已经发布了 3.0 版本，与 Kotlin 2.0 深度集成，提供了稳定、易用的 HTTP 客户端。</p>
</li>
<li>
<p><strong>序列化</strong>：<code>kotlinx.serialization</code> 已经成为处理 JSON 等数据格式的事实标准。</p>
</li>
<li>
<p><strong>数据库</strong>：除了 Room，由 Cash App 维护的 <strong>SQLDelight</strong> 依然是备受欢迎的选择，它通过在编译期从 SQL 生成类型安全的 Kotlin API，提供了另一种强大的数据库解决方案。</p>
</li>
<li>
<p><strong>其他关键领域</strong>：从依赖注入（Koin）、日志（Napier），到键值存储（Multiplatform-Settings），社区都提供了稳定且维护良好的解决方案。开发者可以通过官方推荐的 <strong>klibs.io</strong> 平台，方便地检索和评估这些多平台库。</p>
</li>
</ul>
<p>双重生态的加持，使得 KMP 在业务逻辑共享层已经构建起了宽阔的护城河。开发者如今面对的，不再是“有没有库可用”的问题，而是“在多个优秀选项中如何抉择”的幸福烦恼。</p>
<h2 data-id="heading-5">三、UI 层突破：Compose Multiplatform 走向成熟</h2>
<p>如果说 KMP 解决了“里子”的问题，那么 Compose Multiplatform (CMP) 则致力于攻克“面子”的难题。在 2024 至 2025 年间，CMP 经历了一系列里程碑式的发布，尤其是在 iOS 和 Web 两个关键平台上，标志着它正从一个“Android 的延伸”，蜕变为一个真正意义上的全平台 UI 框架。</p>
<h3 data-id="heading-6">iOS 走向稳定：从 Beta 到 Production-Ready</h3>
<p><strong>Compose Multiplatform 1.8.0（2025 年 5 月发布）是整个 KMP 生态最重要的里程碑之一，它正式宣布 Compose for iOS 进入稳定（Stable）阶段</strong>。这意味着其核心 API 已最终确定，并提供了强大的兼容性保证，开发者可以放心地将其用于生产环境。</p>
<p>这一声明并非空谈，而是建立在多项实质性改进之上：</p>
<ul>
<li>
<p><strong>性能对齐原生</strong>：JetBrains 在发布时公布的基准测试数据显示，在滚动性能等关键指标上，CMP for iOS 已与 SwiftUI <strong>不相上下</strong>，并且应用启动时间也与原生应用相当。更重要的是，相比完全使用 SwiftUI 开发的应用，其包体积增量仅为约 <strong>9MB</strong>，打消了业界对性能和包体的核心顾虑。</p>
</li>
<li>
<p><strong>原生质感（Native Look &amp; Feel）</strong>：为了解决“非原生感”的问题，CMP 在细节上做了大量优化，包括：</p>
<ul>
<li>完全匹配 iOS 平台的<strong>滚动物理效果</strong>（即“橡皮筋”效果）。</li>
<li>支持原生的文本编辑行为，包括<strong>文本选择、右到左语言支持</strong>。</li>
<li>与系统<strong>拖放、辅助功能（VoiceOver）、字体大小与对比度设置</strong>等深度集成。</li>
</ul>
</li>
<li>
<p><strong>强大的互操作性</strong>：CMP for iOS 提供了与 SwiftUI 和 UIKit 的无缝互操作能力。开发者不仅可以将一个 Compose 视图嵌入到现有的 SwiftUI/UIKit 页面中，实现渐进式改造；也可以在 Compose 代码中嵌入一个原生的 <code>UIView</code>，以复用那些尚无 KMP 替代品的复杂原生控件（如地图、WebView）。</p>
</li>
</ul>
<blockquote>
<p><strong>战略选择的分野：共享 UI vs. 原生 UI</strong>
CMP for iOS 的稳定，为技术决策者清晰地划分出两条 UI 架构路径：</p>
<ol>
<li><strong>务实主义路径（共享逻辑，原生 UI）</strong>：这是 KMP 最经典的用法。共享模块只包含业务逻辑，UI 层则由 Android (Jetpack Compose/XML) 和 iOS (SwiftUI/UIKit) 团队分别用原生技术栈实现。这种模式能保证<strong>极致的原生体验</strong>，但对团队协作和沟通提出了极高要求。</li>
<li><strong>统一化路径（共享逻辑与 UI）</strong>：利用 Compose Multiplatform 将 UI 代码也一并共享，实现 <strong>95% 以上的代码复用</strong>。这能极大地提升开发效率、统一团队结构，尤其适合 MVP 产品或品牌视觉一致性要求高的应用。但挑战在于，要让 UI 在 iOS 上达到 100% 的原生质感，可能需要额外的定制工作。
如今，这不再是一个“能不能”的问题，而是一个基于项目目标、团队构成和产品定位的“如何选”的战略问题。</li>
</ol>
</blockquote>
<h3 data-id="heading-7">Web 端迈入 Beta：拥抱 Wasm 的未来</h3>
<p>紧随 iOS 的步伐，<strong>Compose Multiplatform 1.9.0（2025 年 10 月发布）宣布其 Web 端（基于 WebAssembly/Wasm）进入 Beta 阶段</strong>。这意味着 API 已经足够稳定，可供早期采用者投入实际应用。</p>
<ul>
<li>
<p><strong>基于 Wasm 的高性能</strong>：与过去基于 Kotlin/JS 的方案不同，新的 Web 目标直接编译到 Wasm，理论上能提供接近原生的运行性能，为在浏览器中构建复杂、高性能的前端应用打开了大门。</p>
</li>
<li>
<p><strong>共享移动端代码与技能</strong>：开发者可以将为 Android/iOS 编写的 Compose UI 和逻辑代码，以极低的成本复用到 Web 端，实现“三端一体”的开发体验。JetBrains 官方的 Kotlin Playground 和 KotlinConf 应用网站，就是 CMP for Web 的最佳实践案例。</p>
</li>
</ul>
<h3 data-id="heading-8">桌面端：久经考验的成熟平台</h3>
<p>相比之下，Compose for Desktop 早已稳定，并被 JetBrains 自身广泛用于开发其下的多款旗舰产品，如 <strong>JetBrains Toolbox App</strong> 和 <strong>JetBrains Fleet IDE</strong> 的部分 UI。这些复杂桌面应用的成功实践，早已证明了 CMP 在桌面端构建高质量、高性能应用的能力。</p>
<p>综上，从移动端到桌面再到 Web，Compose Multiplatform 在 2024-2025 年间完成了关键的版图扩张，构建了一个覆盖主流平台的、统一的声明式 UI 工具集。它为 KMP 技术栈补上了最后，也是最关键的一块拼图，使其真正具备了提供端到端完整解决方案的能力。</p>
<h2 data-id="heading-9">四、工程化提效：日益顺滑的开发者体验</h2>
<p>一个技术框架能否在真实工程中被大规模采用，开发者体验（DX）是决定性的因素。早期的 KMP 因其复杂的 Gradle 配置、不甚理想的 IDE 支持和与原生工作流的摩擦，劝退了不少满怀热情的尝试者。但在 2024-2025 年，JetBrains 在工程化和工具链上投入了巨大精力，力求抚平这些“最后一公里”的褶皱。</p>
<h3 data-id="heading-10">IDE 支持：从割裂到融合</h3>
<ul>
<li>
<p><strong>统一的 KMP 插件</strong>：JetBrains 推出了全新的 Kotlin Multiplatform 插件，并已集成到最新版的 Android Studio 和 IntelliJ IDEA 中。该插件极大地简化了 KMP 项目的创建和配置，提供了统一的运行/调试配置入口，并开始支持在 <code>commonMain</code> 中直接使用 Compose <code>@Preview</code> 注解，解决了过去预览功能只能在平台特定模块使用的痛点。</p>
</li>
<li>
<p><strong>强化的 Swift 互操作</strong>：IDE 对 Kotlin-Swift 互操作的支持得到了显著增强。在 Kotlin 代码和生成的 Swift 接口之间跳转、查找用例、甚至进行跨语言重构，都变得更加流畅。这对于采用“共享逻辑，原生 UI”策略的团队至关重要，它降低了 iOS 开发者将共享模块视为“黑盒”的心理障碍。</p>
</li>
<li>
<p><strong>Hot Reload（热重载）的到来</strong>：Compose Multiplatform for iOS 已支持实验性的 <strong>Compose Hot Reload</strong>，允许开发者在修改 UI 代码后，无需重启应用即可实时看到变化。这极大地提升了 UI 的迭代效率，使得开发体验向 Flutter 等成熟框架看齐。</p>
</li>
</ul>
<blockquote>
<p><strong>路线图前瞻：从插件到专属 IDE 与 Amper 构建系统</strong>
展望未来，JetBrains 的 2025 路线图揭示了更宏大的计划：</p>
<ul>
<li><strong>独立的 KMP IDE</strong>：JetBrains 正在基于 Fleet 架构，打造一款专为 KMP 开发量身定制的 IDE。它将原生支持跨语言（Kotlin/Swift）调试、导航和重构，从根本上解决目前依赖 Xcode 与 Android Studio/IntelliJ 协同工作的割裂感。</li>
<li><strong>Amper 构建工具</strong>：为了解决 Gradle 配置复杂的问题，JetBrains 推出了实验性的 <strong>Amper</strong> 项目。它旨在提供一种更简洁、更具声明性的方式来定义项目结构和依赖，极大地降低 KMP 的上手门槛，尤其是对于不熟悉 JVM 生态的开发者。</li>
</ul>
</blockquote>
<h3 data-id="heading-11">构建与依赖管理：走向标准化</h3>
<ul>
<li>
<p><strong>默认层级源集（Default Hierarchy Template）</strong>：在 Kotlin 1.9.20 中引入的这一特性，让 Gradle 插件能自动为常见的项目结构（如共享代码于 <code>commonMain</code>，平台代码于 <code>androidMain</code>/<code>iosMain</code>）配置源集依赖关系，减少了大量的样板配置代码。</p>
</li>
<li>
<p><strong>更友好的 CocoaPods / SwiftPM 集成</strong>：KMP 对 iOS 依赖管理工具的支持愈发成熟。无论是通过 CocoaPods 还是 SwiftPM，将 KMP 构建的 Framework 集成到原生 Xcode 项目中的流程都变得更加标准化和稳定。</p>
</li>
<li>
<p><strong>诊断与错误提示改进</strong>：新版的 Gradle 插件增加了约 50 项诊断检查，能主动发现常见的构建配置问题，并提供修复建议。同时，在 Xcode 中构建失败时的错误输出也得到了优化，使其更易于定位问题根源。</p>
</li>
</ul>
<p>虽然距离“零配置”的理想状态尚有距离，但 KMP 的工程化体验在近年来的进步是肉眼可见的。JetBrains 正通过“短期优化现有工具（Gradle/IDEA 插件）”和“长期投资下一代工具（Amper/Fleet IDE）”两条腿走路的方式，系统性地解决着开发流程中的痛点，为 KMP 的大规模采用铺平了道路。</p>
<h2 data-id="heading-12">五、现实的引力：生产案例与务实的收益模型</h2>
<p>理论的成熟最终需要由现实世界的采纳来印证。如果说 2023 年之前，KMP 的成功案例还多是些个人项目或小型应用的探索，那么 2024 年之后，我们看到的是越来越多的大型、严肃的商业产品，开始将 KMP 作为其核心技术战略的一部分。</p>
<h3 data-id="heading-13">从 JetBrains 自用到 Google 旗舰</h3>
<ul>
<li>
<p><strong>JetBrains 全家桶</strong>：作为 KMP 的创造者，JetBrains 自身就是其最坚定的实践者。<strong>JetBrains Toolbox App</strong>、下一代 IDE <strong>Fleet</strong>，以及团队协作工具 <strong>Space</strong> 的移动客户端，都深度使用了 KMP 和 Compose Multiplatform。这些产品本身就是对 KMP 构建复杂、高质量应用能力的最好证明。</p>
</li>
<li>
<p><strong>Google Workspace &amp; Google Docs</strong>：Google 在其核心生产力应用（如 Google Docs）的 iOS 版中采用 KMP 共享了大量业务逻辑，并公开分享其带来的收益：<strong>更高的功能一致性、更快的迭代速度，且性能与原生代码持平</strong>。来自 Google 官方的背书，其分量不言而喻。</p>
</li>
<li>
<p><strong>社区与企业标杆</strong>：</p>
<ul>
<li><strong>Netflix</strong>：在其内部使用的 Prodicle 工作室应用中，利用 KMP 共享了包括网络、数据持久化在内的复杂业务逻辑。</li>
<li><strong>McDonald's</strong>：在其全球外送应用中，使用 KMP 共享了支付、订单等关键模块，甚至创新性地将导航逻辑也放入了共享层。</li>
<li><strong>Philips</strong>：在其健康应用中利用 KMP 统一了蓝牙设备通信等底层逻辑。</li>
<li><strong>Baidu</strong>：在国内，百度等大型互联网公司也在积极探索和落地 KMP。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-14">增量引入的现实收益</h3>
<p>KMP 最大的魅力之一在于其<strong>非侵入性</strong>和<strong>渐进式采用</strong>的能力。它不要求团队推倒重来，而是可以像“插件”一样，平滑地集成到现有的原生应用中。</p>
<p>一个典型的增量引入路径是：</p>
<ol>
<li>
<p><strong>识别痛点</strong>：从一个在 Android 和 iOS 两端都存在，且逻辑复杂、频繁变更、容易出 Bug 的模块入手（例如，一个复杂的定价算法、一套网络请求的封装、或一个自定义的数据图表）。</p>
</li>
<li>
<p><strong>剥离与共享</strong>：将这部分逻辑用 Kotlin 在一个独立的 <code>shared</code> 模块中实现。</p>
</li>
<li>
<p><strong>集成与验证</strong>：将该模块编译为 AAR (for Android) 和 Framework (for iOS)，替换掉原有的原生实现。</p>
</li>
<li>
<p><strong>逐步扩展</strong>：在验证了其带来的收益（如减少 Bug、统一行为）后，逐步扩大共享代码的范围。</p>
</li>
</ol>
<p>这种模式的<strong>性价比极高</strong>。它允许团队在不颠覆现有工作流和技术栈的前提下，用最小的成本和风险，精准地解决代码复用的核心痛点，享受到 KMP 带来的直接收益。</p>
<p>对于技术管理者而言，KMP 提供了一个极具吸引力的收益模型：它允许团队在<strong>最大化复用商业逻辑</strong>以降低成本、提升效率的同时，依然<strong>保留了利用原生 UI 打造最佳用户体验的自由</strong>。这种“鱼与熊掌兼得”的灵活性，是 KMP 在与其他跨平台方案竞争时，最独特的价值主张。它不再是一个非黑即白的激进选择，而是一个可以根据业务发展和团队状况动态调整的、充满智慧的务实之道。</p>
<h2 data-id="heading-15">结论：KMP，一个为长期价值而生的务实选择</h2>
<p>回顾 KMP 与 Compose Multiplatform 在 2024-2026 年的演进轨迹，我们可以清晰地看到一条从“底层革新”到“生态成熟”，再到“工程化落地”的完整进化链。</p>
<ul>
<li>
<p><strong>坚实的地基</strong>：以 Kotlin 2.0 和 K2 编译器为核心的语言层升级，为整个生态系统的高速发展提供了强劲、统一的动力。</p>
</li>
<li>
<p><strong>丰饶的生态</strong>：以 Jetpack 多平台库为代表的官方支持，与持续繁荣的社区库相结合，构建了足以支撑复杂业务逻辑的“军火库”。</p>
</li>
<li>
<p><strong>强大的 UI 工具集</strong>：Compose Multiplatform 凭借 iOS 的稳定和 Web 的入场，真正成为一个覆盖主流平台的全能型 UI 框架，并为开发者提供了“共享”或“原生”的灵活选项。</p>
</li>
<li>
<p><strong>持续优化的开发者体验</strong>：尽管仍有挑战，但从 IDE 插件到下一代构建工具的路线图，无不显示出 JetBrains 解决开发者痛点、降低使用门槛的决心。</p>
</li>
<li>
<p><strong>无可辩驳的生产验证</strong>：从 Google 到 Netflix，从大型企业到初创公司，日益增多的生产案例，宣告了 KMP 已经走出了“概念验证”阶段，成为经得起实战考验的成熟技术。</p>
</li>
</ul>
<p><strong>在 2026 年的今天，技术管理者在评估 KMP 时，所面临的问题已经不再是“它能用吗？”，而是“我们应该如何最好地利用它？”</strong></p>
<p>它不是一个试图用一套代码“抹平”所有平台差异的理想主义乌托邦，而是一个深刻理解并尊重平台特性的现实主义工具集。它赋予团队选择的权利：是在追求极致原生体验的同时共享核心业务逻辑，还是在效率与一致性的驱动下统一 UI 与逻辑。</p>
<p>对于那些追求技术方案的长期价值、希望在开发效率与产品质量之间找到最佳平衡、并愿意投资于构建统一、高效移动团队的企业而言，Kotlin Multiplatform 无疑已经准备就绪。它已经从一个勇敢者的游戏，变成了一个智者的选择。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2D 图形系统的渲染抽象]]></title>    <link>https://juejin.cn/post/7601387539334021156</link>    <guid>https://juejin.cn/post/7601387539334021156</guid>    <pubDate>2026-02-01T14:13:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601387539334021156" data-draft-id="7601387539334004772" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2D 图形系统的渲染抽象"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-01T14:13:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="温宇飞"/> <meta itemprop="url" content="https://juejin.cn/user/4300945219403368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2D 图形系统的渲染抽象
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4300945219403368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    温宇飞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T14:13:27.000Z" title="Sun Feb 01 2026 14:13:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1小时+
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2D 模型的渲染抽象(2D Rendering Abstraction)定义了 2D 图形系统的核心能力，包括静态渲染模型和动态渲染模型两个部分。静态渲染模型描述单帧画面的构成方式，包括图层的几何与样式、图层间的影响关系、渲染效果与合成规则。动态渲染模型在静态基础上引入时间维度和交互能力，包括滑动行为、动画系统和事件处理机制。本文从模型层面分析这些共性原理，不涉及具体实现细节。</p>
<h2 data-id="heading-0">静态渲染模型</h2>
<p>静态渲染模型定义了单帧画面的构成规则。它回答三个核心问题：单个图层如何表达（几何与样式）、图层之间如何影响（继承与依赖）、以及渲染系统如何将这些图层组合为最终画面（效果、合成与优化）。</p>
<h3 data-id="heading-1">渲染单元</h3>
<p>Geometry 和 Paint 定义一个渲染单元。Geometry 确定渲染的空间范围（哪些像素需要绘制），Paint 确定这些像素的颜色。渲染单元是 2D 渲染的最小单位，具备完整的独立渲染能力。</p>
<h4 data-id="heading-2">Geometry：在哪里画</h4>
<p><strong>Geometry 是计算结果，不是直接定义</strong></p>
<p>渲染模型不直接定义 Geometry，而是定义 Shape（形状类型）+ Fill/Stroke（应用方式），然后计算出最终的 Geometry：</p>
<pre><code class="hljs">Shape + Fill  → Fill Geometry（填充区域）
Shape + Stroke → Stroke Geometry（描边区域，由 Stroke 参数扩展而来）
</code></pre>
<p><strong>Shape：形状的声明</strong></p>
<p>Shape 是几何的声明式定义，包含：</p>
<ul>
<li><strong>矩形(Rect)</strong>：位置 + 尺寸</li>
<li><strong>圆角矩形(RRect)</strong>：矩形 + 每个角的圆角半径</li>
<li><strong>椭圆(Oval)</strong>：边界矩形</li>
<li><strong>路径(Path)</strong>：贝塞尔曲线序列</li>
<li><strong>文本(Text)</strong>：字符序列 + 字体 + 排版参数</li>
</ul>
<p><strong>Fill 和 Stroke：两种 Geometry 生成方式</strong></p>
<p>Fill 和 Stroke 将 Shape 转换为可渲染的 Geometry：</p>
<ul>
<li><strong>Fill</strong>：填充 Shape 的内部区域。对于封闭路径，内部区域由填充规则(Fill Rule)决定（NonZero 或 EvenOdd）</li>
<li><strong>Stroke</strong>：沿 Shape 的边界扩展出带宽度的区域。Stroke 参数包括：
<ul>
<li>宽度：线条粗细</li>
<li>端点样式(Cap)：线条端点形状</li>
<li>连接样式(Join)：线条转角形状</li>
<li>虚线模式(Dash)：实线段和间隔的模式</li>
</ul>
</li>
</ul>
<p><strong>文本的特殊性</strong></p>
<p>文本是"声明式 Shape"到"实际 Geometry"的二次转换：</p>
<pre><code class="hljs">文本字符串 + 字体 → 字形轮廓路径集合 → Fill/Stroke Geometry
</code></pre>
<p>文本渲染需要字体解析、排版计算，最终生成字形路径参与渲染。</p>
<h4 data-id="heading-3">Paint：画什么</h4>
<p><strong>Paint 的本质：定义空间中每个点的颜色</strong></p>
<p>Paint 不是简单的"颜色值"，而是一个函数：<code>f(x, y) → Color</code>。给定坐标 (x, y)，返回该位置应该绘制的颜色。</p>
<ul>
<li><strong>纯色</strong>：<code>f(x, y) = 常量颜色</code>，与位置无关</li>
<li><strong>渐变</strong>：<code>f(x, y) = 根据 (x, y) 插值的颜色</code>，颜色随位置变化</li>
<li><strong>图像</strong>：<code>f(x, y) = 图像在 (x, y) 的采样值</code>，从图像数据中读取</li>
</ul>
<p>这种抽象使得 Paint 可以表达任意复杂的颜色分布。</p>
<p><strong>Paint 的类型</strong></p>
<p>基于"如何计算颜色"，Paint 分为三类：</p>
<ol>
<li>
<p><strong>纯色(Solid Color)</strong></p>
<ul>
<li>定义：单一 RGBA 值</li>
<li>函数：<code>f(x, y) = color</code></li>
</ul>
</li>
<li>
<p><strong>渐变(Gradient)</strong></p>
<ul>
<li>定义：颜色停止点(Color Stops) + 渐变类型</li>
<li>函数：根据 (x, y) 到渐变轴的距离插值</li>
<li>类型：
<ul>
<li>线性渐变：沿直线方向插值</li>
<li>径向渐变：从中心点向外插值</li>
<li>角度渐变：围绕中心点旋转插值</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>图像(Image)</strong></p>
<ul>
<li>定义：图像数据 + 变换矩阵 + 平铺模式</li>
<li>函数：将 (x, y) 变换到图像坐标，采样像素值</li>
</ul>
</li>
</ol>
<p><strong>坐标空间</strong></p>
<p>Paint 函数的 (x, y) 定义在特定坐标空间中：</p>
<ul>
<li><strong>对象空间(Object Space)</strong>：相对于 Geometry 的边界</li>
<li><strong>用户空间(User Space)</strong>：画布的绝对坐标</li>
</ul>
<p>渐变的起点/终点、图像的变换矩阵都在坐标空间中定义。</p>
<h4 data-id="heading-4">小结</h4>
<p>渲染单元由 Shape + Fill/Stroke + Paint 定义：Shape 声明几何，Fill/Stroke 计算 Geometry，Paint 定义颜色函数。Geometry 是"在哪些像素上绘制"，Paint 是"这些像素的颜色是什么"。</p>
<h3 data-id="heading-5">渲染效果</h3>
<p>渲染效果对渲染单元的像素进行处理，改变最终的视觉呈现。渲染效果分为三类：可见性控制（决定哪些像素可见）、混合模式（控制像素如何与其他内容合成）、后处理效果（对已渲染的像素进行二次处理，包括颜色变换和空间卷积）。</p>
<h4 data-id="heading-6">可见性控制</h4>
<p>可见性控制决定渲染单元的哪些像素最终可见。它不改变像素的颜色，只改变像素的可见状态。</p>
<p><strong>Opacity（透明度）</strong></p>
<p>Opacity 是最简单的可见性控制，通过缩放像素的 Alpha 通道实现：</p>
<pre><code class="hljs language-css" lang="css">result<span class="hljs-selector-class">.rgba</span> = (<span class="hljs-attribute">src</span><span class="hljs-selector-class">.r</span>, <span class="hljs-attribute">src</span><span class="hljs-selector-class">.g</span>, <span class="hljs-attribute">src</span><span class="hljs-selector-class">.b</span>, <span class="hljs-attribute">src</span><span class="hljs-selector-class">.a</span> × <span class="hljs-attribute">opacity</span>)
</code></pre>
<p>Opacity 是连续值（0-1），支持半透明效果。它作用于整个渲染单元，所有像素的透明度统一缩放。</p>
<p><strong>Clip（裁剪）</strong></p>
<p>Clip 通过几何边界裁剪渲染单元，边界外的像素完全不可见。裁剪是硬边界：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">if</span> (x, y) 在裁剪区域内:
    保留像素
<span class="hljs-keyword">else</span>:
    丢弃像素
</code></pre>
<p>裁剪区域可以是矩形、路径、或多个裁剪区域的布尔运算结果。</p>
<p><strong>Mask（遮罩）</strong></p>
<p>Mask 使用另一个渲染单元的 Alpha 通道控制可见性。与 Clip 的硬边界不同，Mask 支持平滑的透明度过渡：</p>
<pre><code class="hljs language-css" lang="css">result<span class="hljs-selector-class">.rgba</span> = (<span class="hljs-attribute">src</span><span class="hljs-selector-class">.r</span>, <span class="hljs-attribute">src</span><span class="hljs-selector-class">.g</span>, <span class="hljs-attribute">src</span><span class="hljs-selector-class">.b</span>, <span class="hljs-attribute">src</span><span class="hljs-selector-class">.a</span> × <span class="hljs-attribute">mask</span><span class="hljs-selector-class">.a</span>)
</code></pre>
<p>Mask 的每个像素提供一个透明度系数，使得边缘可以平滑过渡（抗锯齿、渐变边缘）。</p>
<p><strong>三者的对比</strong></p>





























<table><thead><tr><th>效果</th><th>边界类型</th><th>透明度</th><th>应用场景</th></tr></thead><tbody><tr><td>Opacity</td><td>无边界</td><td>全局统一</td><td>淡入淡出动画</td></tr><tr><td>Clip</td><td>硬边界</td><td>二值（可见/不可见）</td><td>容器裁剪、滚动区域</td></tr><tr><td>Mask</td><td>软边界</td><td>逐像素可变</td><td>复杂形状裁剪、渐变过渡</td></tr></tbody></table>
<h4 data-id="heading-7">混合模式</h4>
<p>混合模式(Blend Mode)定义像素如何与背景合成。它是一个函数：<code>f(src, dst) → result</code>，src 是当前渲染单元的像素，dst 是背景像素。</p>
<p><strong>Porter-Duff 合成</strong></p>
<p>Porter-Duff 是基础的 Alpha 合成算法，定义了如何根据 Alpha 值混合颜色：</p>
<pre><code class="hljs language-css" lang="css">result = <span class="hljs-attribute">src</span><span class="hljs-selector-class">.color</span> × <span class="hljs-attribute">src</span><span class="hljs-selector-class">.alpha</span> + dst<span class="hljs-selector-class">.color</span> × (<span class="hljs-number">1</span> - <span class="hljs-attribute">src</span><span class="hljs-selector-class">.alpha</span>)
</code></pre>
<p>这是默认的 SrcOver 模式，新内容覆盖在背景上方。</p>
<p><strong>扩展混合模式</strong></p>
<p>扩展混合模式对颜色通道应用数学运算：</p>
<ul>
<li><strong>Multiply（正片叠底）</strong>：<code>result = src × dst</code>，颜色变暗</li>
<li><strong>Screen（滤色）</strong>：<code>result = 1 - (1 - src) × (1 - dst)</code>，颜色变亮</li>
<li><strong>Overlay（叠加）</strong>：根据背景亮度选择 Multiply 或 Screen</li>
<li><strong>Darken/Lighten</strong>：选择较暗/较亮的颜色</li>
</ul>
<p>混合模式的本质是定义颜色空间中的混合函数。不同模式产生不同的视觉效果（变暗、变亮、对比、颜色调整等）。</p>
<h4 data-id="heading-8">后处理效果</h4>
<p>后处理效果对已渲染的像素进行变换，分为颜色域变换和空间域变换。</p>
<p><strong>颜色域变换</strong></p>
<p>颜色域变换对每个像素独立处理，不考虑周围像素。它是像素级函数：<code>f(color) → color</code>。</p>
<p>常见的颜色变换：</p>
<ul>
<li><strong>亮度(Brightness)</strong>：缩放 RGB 值</li>
<li><strong>对比度(Contrast)</strong>：拉伸或压缩颜色范围</li>
<li><strong>饱和度(Saturation)</strong>：在 HSL 空间调整饱和度分量</li>
<li><strong>色相旋转(Hue Rotation)</strong>：在 HSL 空间旋转色相</li>
<li><strong>反色(Invert)</strong>：<code>result = 1 - color</code></li>
</ul>
<p>这些变换可以表示为颜色矩阵或查找表(LUT)。</p>
<p><strong>空间域变换</strong></p>
<p>空间域变换需要读取周围像素，是卷积运算：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">result</span>(x, y) = Σ <span class="hljs-built_in">kernel</span>(i, j) × <span class="hljs-attribute">src</span>(x + i, y + j)
</code></pre>
<p><strong>模糊(Blur)</strong>：</p>
<p>模糊是空间域变换的典型应用。高斯模糊使用高斯函数作为卷积核，对周围像素加权平均：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">kernel</span>(x, y) = <span class="hljs-built_in">exp</span>(-(x² + y²) / (<span class="hljs-number">2</span>σ²))
</code></pre>
<p>模糊半径(radius)控制卷积核的大小，半径越大模糊越强。</p>
<h4 data-id="heading-9">综合渲染效果</h4>
<p>复杂的视觉效果由多种渲染效果组合实现，并且涉及多个渲染单元的协作。</p>
<p><strong>外阴影(Drop Shadow)</strong></p>
<p>外阴影涉及的渲染单元是当前节点的所有子节点（不包括已有的模糊等效果）。渲染效果的组合包括：偏移、模糊、Clip。</p>
<p><strong>内阴影(Inner Shadow)</strong></p>
<p>内阴影涉及的渲染单元是当前节点的所有子节点（不包括已有的模糊等效果）。渲染效果的组合包括：偏移、模糊、Clip。</p>
<p><strong>背景模糊(Backdrop Blur)</strong></p>
<p>背景模糊涉及的渲染单元是之前渲染的所有节点（包括兄弟节点、父节点的背景等）。渲染效果的组合包括：模糊、Clip。</p>
<h4 data-id="heading-10">小结</h4>
<p>渲染效果扩展了渲染单元的视觉能力。可见性控制决定像素是否可见，混合模式决定像素如何与背景合成，后处理效果对像素进行数学变换。这些效果组合使用，构成丰富的视觉表现。</p>
<h3 data-id="heading-11">自动布局</h3>
<p>变换(Transform)定义渲染单元在空间中的位置、旋转、缩放。变换使用矩阵表示，包含平移、旋转、缩放等操作。渲染时，渲染单元应用变换矩阵确定最终的屏幕坐标。</p>
<p>自动布局(Auto Layout)根据约束规则自动计算渲染单元的变换。手动设置变换需要显式指定每个渲染单元的位置和尺寸，而自动布局通过声明元素之间的关系（如"水平排列"、"填充父容器"），由系统自动计算变换矩阵。自动布局的本质是：将空间关系的声明转换为变换矩阵的计算。</p>
<h4 data-id="heading-12">为什么需要自动布局</h4>
<p><strong>问题：手动管理变换的复杂性</strong></p>
<p>复杂界面包含数百个渲染单元，手动为每个单元设置变换成本高昂：</p>
<ul>
<li>添加或删除元素，需要手动调整其他元素的变换</li>
<li>内容大小改变（如文本变长），需要重新计算周围元素的位置</li>
<li>响应不同屏幕尺寸，需要为每个尺寸手动调整所有变换</li>
</ul>
<p>自动布局的目标是：声明元素之间的空间关系，由系统自动维护变换。</p>
<h4 data-id="heading-13">布局约束</h4>
<p>布局约束(Layout Constraints)定义元素之间的空间关系。常见的约束类型：</p>
<ul>
<li><strong>线性排列</strong>：子元素按行或列排列，间距固定或自适应</li>
<li><strong>相对定位</strong>：元素相对父容器或兄弟元素定位（如"居中"、"距离边缘 10px"）</li>
<li><strong>尺寸约束</strong>：元素的尺寸填充父容器、按比例分配、或固定大小</li>
<li><strong>对齐约束</strong>：元素的边缘或中心对齐</li>
</ul>
<p>约束是声明式的，描述"应该是什么样"而非"如何实现"。</p>
<h4 data-id="heading-14">布局计算</h4>
<p>布局计算将约束转换为变换矩阵。布局系统是一个函数：</p>
<pre><code class="hljs">输入：布局约束 + 内容固有尺寸
输出：每个渲染单元的变换矩阵
</code></pre>
<p><strong>固有尺寸(Intrinsic Size)</strong></p>
<p>某些元素的大小由内容决定：</p>
<ul>
<li><strong>文本</strong>：由字符数量、字体、换行决定</li>
<li><strong>图像</strong>：由图像的原始分辨率决定</li>
<li><strong>容器</strong>：可能由子元素的总尺寸决定</li>
</ul>
<p>布局计算需要这些固有尺寸作为输入。</p>
<p><strong>计算方向</strong></p>
<p>布局计算可以是自上而下或自下而上，取决于约束的类型：</p>
<p><strong>自上而下</strong>：父容器决定子元素的尺寸和位置。父容器先确定自己的尺寸（如固定宽度或填充屏幕），然后将空间分配给子元素。子元素的尺寸由父容器分配的空间决定。</p>
<pre><code class="hljs language-css" lang="css">父容器（固定 <span class="hljs-number">400px</span>）
  → 子元素 <span class="hljs-selector-tag">A</span>（分配 <span class="hljs-number">200px</span>）
  → 子元素 <span class="hljs-selector-tag">B</span>（分配 <span class="hljs-number">200px</span>）
</code></pre>
<p><strong>自下而上</strong>：父容器的尺寸由子元素决定。子元素先根据内容确定自己的固有尺寸，父容器根据子元素的尺寸计算自己的尺寸。</p>
<pre><code class="hljs language-css" lang="css">子元素 <span class="hljs-selector-tag">A</span>（固有尺寸 <span class="hljs-number">150px</span>）
子元素 <span class="hljs-selector-tag">B</span>（固有尺寸 <span class="hljs-number">200px</span>）
  → 父容器（<span class="hljs-number">350px</span>，适应子元素）
</code></pre>
<p><strong>双向传递</strong>：很多布局系统需要双向传递信息。第一遍自下而上收集固有尺寸，第二遍自上而下分配空间和计算位置。</p>
<h4 data-id="heading-15">布局与变换的关系</h4>
<p>自动布局计算的变换矩阵与手动设置的变换在渲染时处理方式相同。区别在于变换的来源：</p>
<ul>
<li><strong>布局变换</strong>：由布局系统根据约束自动计算</li>
<li><strong>手动变换</strong>：显式设置（如用户拖拽、动画偏移）</li>
</ul>
<p>两者可以叠加，最终的渲染变换是组合结果：</p>
<pre><code class="hljs">最终变换 = 手动变换 × 布局变换
</code></pre>
<p>例如，布局确定元素的基础位置，动画在此基础上添加偏移。</p>
<h4 data-id="heading-16">布局更新</h4>
<p>当约束或固有尺寸改变时，布局需要重新计算。触发布局更新的情况：</p>
<ul>
<li>添加、删除、或重新排序元素</li>
<li>元素的固有尺寸改变（如文本内容变化、图像加载完成）</li>
<li>布局约束改变（如改变排列方向、间距）</li>
<li>父容器的可用空间改变（如窗口调整大小）</li>
</ul>
<p>布局更新可以是局部的：只重新计算受影响的子树，未改变的部分复用之前的计算结果。</p>
<h4 data-id="heading-17">小结</h4>
<p>自动布局通过约束声明空间关系，自动计算变换矩阵。布局计算的输入是约束和固有尺寸，输出是变换矩阵。布局计算可以是自上而下（父容器决定子元素尺寸）或自下而上（子元素决定父容器尺寸），或双向传递。布局变换与手动变换可以叠加，共同决定渲染单元的最终位置。</p>
<h3 data-id="heading-18">渲染单元的相互影响</h3>
<p>单个渲染单元无法表达复杂画面，需要多个渲染单元组合。渲染单元通过树结构组织，父子关系表达"包含"和"层级影响"。树结构使得渲染效果的影响范围可以清晰定义：有的效果影响后代节点，有的效果作用于子节点之间，有的效果依赖先序渲染的内容。</p>
<h4 data-id="heading-19">为什么需要树结构</h4>
<p><strong>问题：多个渲染单元如何组织</strong></p>
<p>复杂画面包含数百个渲染单元。这些单元如何关联？两种可能的组织方式：</p>
<ol>
<li><strong>平铺列表</strong>：所有渲染单元按顺序排列，依次渲染</li>
<li><strong>树形结构</strong>：渲染单元形成父子层级，递归渲染</li>
</ol>
<p>平铺列表的问题：无法表达"包含"关系。一个容器包含三个子元素，容器的变换应该影响所有子元素，但在平铺列表中无法表达这种影响。</p>
<p><strong>树结构的核心能力：继承</strong></p>
<p>树结构使得父节点的某些属性可以影响子节点，这种影响称为继承。继承分为两类：</p>
<ul>
<li><strong>累积继承</strong>：子节点继承父节点的累积结果（如变换矩阵）</li>
<li><strong>调制继承</strong>：父节点的属性调制子节点的渲染结果（如透明度）</li>
</ul>
<p>树结构是表达继承的自然方式：遍历时，父节点的状态自动传递给子节点。</p>
<h4 data-id="heading-20">渲染效果的影响范围</h4>
<p>不同渲染效果作用于树的不同部分，决定了它们"影响谁"。</p>
<p><strong>后代级别：影响所有子孙节点</strong></p>
<p>这类效果作用于节点及其所有后代，形成"整体效果"。</p>
<p><strong>变换(Transform)</strong></p>
<p>变换是位置、旋转、缩放的仿射变换，使用矩阵表示。变换是累积继承：</p>
<pre><code class="hljs">子节点的世界坐标变换 = 父节点变换 × 子节点相对变换
</code></pre>
<p>递归累积使得变换可以传递到任意深度的子孙节点。</p>
<p><strong>透明度(Opacity)</strong></p>
<p>透明度是调制继承。父节点的透明度与子节点的透明度相乘：</p>
<pre><code class="hljs">子节点的最终透明度 = 父节点透明度 × 子节点透明度
</code></pre>
<p>透明度为 0 的节点，其所有后代都不可见。</p>
<p><strong>图层模糊(Layer Blur)</strong></p>
<p>图层模糊对节点及其所有子节点的渲染结果应用模糊。它需要将整个子树渲染到离屏纹理(Offscreen Texture)，然后对纹理应用模糊。</p>
<p>图层模糊的影响是"整体性"的：子节点之间会相互模糊，而不是各自独立模糊。</p>
<p><strong>Children 级别：作用于直接子节点或兄弟节点</strong></p>
<p>这类效果在子节点之间产生相互作用。</p>
<p><strong>蒙版(Mask)</strong></p>
<p>蒙版使用一个节点的 Alpha 通道裁剪另一个节点。常见的蒙版关系是"兄弟节点蒙版"：</p>
<pre><code class="hljs language-css" lang="css">节点 <span class="hljs-selector-tag">A</span> 作为蒙版
节点 <span class="hljs-selector-tag">B</span>、C、D 被蒙版裁剪
</code></pre>
<p>蒙版的影响范围是"后续的兄弟节点"，直到遇到下一个蒙版或容器边界。</p>
<p><strong>路径布尔运算(Path Boolean)</strong></p>
<p>路径布尔运算（并集、交集、差集）作用于多个子节点的几何，生成新的几何。它需要收集多个子节点的 Shape，计算布尔运算结果。</p>
<p>布尔运算的影响范围是"参与运算的子节点"。</p>
<p><strong>先序级别：依赖之前渲染的内容</strong></p>
<p>这类效果需要"回溯"到之前的渲染结果，依赖渲染顺序。</p>
<p><strong>背景模糊(Backdrop Blur)</strong></p>
<p>背景模糊对节点背后的内容应用模糊。"背后的内容"是指：</p>
<ul>
<li>父节点的背景</li>
<li>之前渲染的兄弟节点</li>
<li>更早渲染的祖先节点</li>
</ul>
<p>背景模糊需要在渲染当前节点时，捕获"截至目前的渲染结果"，然后对其模糊。</p>
<p><strong>混合模式(Blend Mode)</strong></p>
<p>混合模式定义当前节点如何与背景合成。背景是"当前节点之前渲染的所有内容"。混合模式依赖渲染顺序：先渲染的内容作为背景，后渲染的内容作为前景。</p>
<h4 data-id="heading-21">小结</h4>
<p>树结构是渲染单元的组织方式，使得继承和影响关系可以清晰表达。变换和透明度通过累积和调制影响后代，蒙版和布尔运算作用于子节点之间，背景模糊和混合模式依赖渲染顺序。</p>
<h3 data-id="heading-22">合成顺序</h3>
<p>合成顺序定义了渲染效果的执行顺序。单个渲染单元可能包含多种渲染效果（Fill、Stroke、阴影、模糊、透明度等），这些效果必须按照特定顺序执行才能产生正确的视觉结果。合成顺序的本质是"渲染管线"：每个阶段处理特定的效果，阶段之间有明确的依赖关系。</p>
<h4 data-id="heading-23">为什么需要合成顺序</h4>
<p><strong>问题：效果的顺序影响结果</strong></p>
<p>假设一个渲染单元包含 Fill 和 Drop Shadow，两种执行顺序会产生不同结果：</p>
<ul>
<li><strong>先 Fill 后 Shadow</strong>：阴影在 Fill 下方，符合物理直觉</li>
<li><strong>先 Shadow 后 Fill</strong>：Fill 覆盖阴影，阴影不可见</li>
</ul>
<p>正确的视觉效果要求固定的执行顺序。</p>
<p>再如透明度和模糊的顺序：</p>
<ul>
<li><strong>先模糊后透明度</strong>：模糊作用于完整图像，然后整体变透明</li>
<li><strong>先透明度后模糊</strong>：透明图像的模糊会扩散 Alpha，改变轮廓</li>
</ul>
<p>不同顺序产生完全不同的视觉效果。</p>
<p><strong>依赖关系</strong></p>
<p>某些效果依赖其他效果的结果：</p>
<ul>
<li><strong>背景模糊依赖背景内容</strong>：必须先渲染背景，才能对其模糊</li>
<li><strong>内阴影依赖 Fill</strong>：需要 Fill 的轮廓作为裁剪边界</li>
<li><strong>混合模式依赖背景</strong>：需要背景像素才能执行混合函数</li>
</ul>
<p>这些依赖关系决定了效果的执行顺序不能任意调整。</p>
<h4 data-id="heading-24">典型的合成顺序</h4>
<p>2D 渲染系统通常采用以下合成顺序：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 外阴影 (Drop Shadow)
<span class="hljs-bullet">2.</span> 背景模糊 (Background Blur)
<span class="hljs-bullet">3.</span> 填充 (Fill)
<span class="hljs-bullet">4.</span> 子节点 (Children)
<span class="hljs-bullet">5.</span> 描边 (Stroke)
<span class="hljs-bullet">6.</span> 内阴影 (Inner Shadow)
<span class="hljs-bullet">7.</span> 图层模糊 (Layer Blur)
<span class="hljs-bullet">8.</span> 透明度 (Opacity)
<span class="hljs-bullet">9.</span> 混合模式 (Blend Mode)
</code></pre>
<p><strong>顺序的逻辑</strong></p>
<p>这个顺序遵循以下逻辑：</p>
<p><strong>阶段 1：背景相关效果（外阴影、背景模糊）</strong></p>
<p>这些效果需要在内容绘制之前准备背景。外阴影绘制在最底层，背景模糊捕获并处理背景。</p>
<p><strong>阶段 2：内容绘制（Fill、Children、Stroke）</strong></p>
<p>这是渲染单元的核心内容。Fill 和 Stroke 定义几何和样式，Children 递归渲染子节点。</p>
<p>Fill 通常在 Children 之前，使得子节点可以覆盖父节点的背景。Stroke 在 Children 之后，确保边框不被子节点遮挡。</p>
<p><strong>阶段 3：内部效果（内阴影）</strong></p>
<p>内阴影依赖 Fill 和 Children 的渲染结果，使用其轮廓作为边界。</p>
<p><strong>阶段 4：整体后处理（图层模糊、透明度）</strong></p>
<p>图层模糊作用于整个渲染单元（Fill + Children + Stroke + 内阴影），产生统一的模糊效果。</p>
<p>透明度调制整个渲染单元的 Alpha 通道，是最后的可见性控制。</p>
<p><strong>阶段 5：合成（混合模式）</strong></p>
<p>混合模式定义渲染单元如何与背景合成，是渲染管线的最后一步。</p>
<h4 data-id="heading-25">顺序的灵活性</h4>
<p>虽然典型顺序是固定的，但某些情况下顺序可以调整：</p>
<p><strong>Stroke 的位置</strong></p>
<p>Stroke 的位置取决于是否需要被 Children 遮挡：</p>
<ul>
<li><strong>Stroke 在 Children 之后</strong>：边框在最上层，不被子节点遮挡（常见于容器边框）</li>
<li><strong>Stroke 在 Children 之前</strong>：子节点可以覆盖边框（常见于图形绘制）</li>
</ul>
<p><strong>效果的嵌套</strong></p>
<p>某些效果可以多次应用。例如，一个节点可以有多个阴影（不同颜色、偏移、模糊半径）。多个阴影按照定义顺序依次应用。</p>
<h4 data-id="heading-26">小结</h4>
<p>合成顺序是渲染管线的执行顺序，确保渲染效果按照正确的依赖关系执行。典型顺序是：背景相关效果 → 内容绘制 → 内部效果 → 整体后处理 → 合成。顺序的选择基于效果之间的依赖关系和视觉逻辑。</p>
<h3 data-id="heading-27">增量更新机制</h3>
<p>增量更新解决渲染模型变化时的性能问题。重新渲染整个场景成本高昂，增量更新只重新计算变化部分，复用未变化的渲染结果。增量更新的核心是：标记变化（哪些节点改变了）、计算影响范围（变化影响了哪些渲染结果）、局部更新（只重新渲染受影响的部分）。</p>
<h4 data-id="heading-28">为什么需要增量更新</h4>
<p><strong>问题：全量更新的成本</strong></p>
<p>一个复杂场景包含数千个渲染单元。用户修改一个节点的颜色，如果重新渲染整个场景：</p>
<ul>
<li>重新计算数千个节点的 Geometry</li>
<li>重新生成数千个渲染指令</li>
<li>重绘整个屏幕</li>
</ul>
<p>但实际上只有一个节点的颜色改变了，其他 99.9% 的内容没有变化。全量更新浪费了大量计算。</p>
<p><strong>增量更新的目标</strong></p>
<p>增量更新的目标是：</p>
<ol>
<li><strong>最小化重新计算</strong>：只重新计算变化的节点</li>
<li><strong>最小化重新渲染</strong>：只重绘变化的屏幕区域</li>
<li><strong>复用不变的结果</strong>：缓存未变化节点的渲染结果</li>
</ol>
<h4 data-id="heading-29">变化的标记</h4>
<p><strong>Dirty 标记</strong></p>
<p>Dirty 标记记录节点的变化类型。不同的变化类型需要不同的更新策略。</p>
<p>常见的 Dirty 类型：</p>
<ul>
<li><strong>属性变化(Property Changed)</strong>：节点的属性改变（颜色、尺寸、透明度等）</li>
<li><strong>几何变化(Geometry Changed)</strong>：节点的 Shape 改变</li>
<li><strong>子节点变化(Children Changed)</strong>：子节点增删或顺序改变</li>
<li><strong>效果变化(Effect Changed)</strong>：渲染效果改变（阴影、模糊等）</li>
</ul>
<p><strong>标记传播</strong></p>
<p>节点的变化会影响其他节点，Dirty 标记需要传播：</p>
<ul>
<li><strong>向上传播</strong>：子节点变化会影响父节点的渲染结果（如父节点有图层模糊）</li>
<li><strong>向下传播</strong>：父节点变化会影响子节点（如父节点的变换改变）</li>
<li><strong>兄弟传播</strong>：节点变化会影响兄弟节点（如蒙版节点改变影响被蒙版的节点）</li>
<li><strong>依赖传播</strong>：节点变化会影响依赖它的节点（如背景改变影响背景模糊节点）</li>
</ul>
<p>标记传播确保所有受影响的节点都被标记为 Dirty。</p>
<h4 data-id="heading-30">影响范围的计算</h4>
<p><strong>局部影响 vs 全局影响</strong></p>
<p>不同的变化有不同的影响范围：</p>
<p><strong>局部影响</strong>：</p>
<ul>
<li>改变 Fill 颜色：只影响当前节点</li>
<li>改变子节点顺序：只影响父节点的 Children 渲染</li>
</ul>
<p><strong>全局影响</strong>：</p>
<ul>
<li>改变变换：影响当前节点及所有子孙节点</li>
<li>改变蒙版：影响当前节点及被蒙版的兄弟节点</li>
<li>改变背景：影响所有依赖背景的节点（背景模糊、混合模式）</li>
</ul>
<p>计算影响范围决定了哪些节点需要重新渲染。</p>
<p><strong>依赖追踪</strong></p>
<p>对于依赖关系（如背景模糊依赖背景节点），系统需要维护依赖图：</p>
<pre><code class="hljs language-css" lang="css">背景节点 <span class="hljs-selector-tag">A</span> → <span class="hljs-selector-attr">[依赖 A 的背景模糊节点列表]</span>
</code></pre>
<p>当 A 改变时，查找依赖图，标记所有依赖节点为 Dirty。</p>
<h4 data-id="heading-31">局部更新策略</h4>
<p><strong>渲染结果缓存</strong></p>
<p>未变化的节点可以缓存其渲染结果（像素数据或渲染指令）。标记为 Dirty 的节点重新渲染，未标记的节点直接复用缓存。</p>
<p><strong>脏矩形(Dirty Rectangle)</strong></p>
<p>只重绘屏幕上变化的区域。每个 Dirty 节点贡献一个脏矩形（节点的边界框），所有脏矩形的并集是需要重绘的区域。</p>
<p><strong>差异化更新</strong></p>
<p>根据 Dirty 类型选择更新策略：</p>
<ul>
<li><strong>颜色改变</strong>：只重新生成 Paint，复用 Geometry</li>
<li><strong>几何改变</strong>：重新计算 Geometry，可能复用 Paint</li>
<li><strong>子节点改变</strong>：Diff 子节点列表，只更新增删的子节点</li>
</ul>
<p>差异化更新进一步减少计算量。</p>
<h4 data-id="heading-32">增量更新的限制</h4>
<p><strong>某些变化无法增量</strong></p>
<p>某些变化必须全量更新：</p>
<ul>
<li><strong>根节点改变</strong>：影响整个场景</li>
<li><strong>全局效果改变</strong>：如色彩空间转换、全局滤镜</li>
<li><strong>渲染后端改变</strong>：从 CPU 渲染切换到 GPU 渲染</li>
</ul>
<p>这些情况下，增量更新退化为全量更新。</p>
<p><strong>缓存的内存开销</strong></p>
<p>缓存渲染结果需要内存。对于大型场景，缓存所有节点的渲染结果会占用大量内存。系统需要平衡内存占用和更新性能，使用 LRU 等策略管理缓存。</p>
<h4 data-id="heading-33">小结</h4>
<p>增量更新通过标记变化、计算影响范围、局部更新三个步骤，最小化重新计算和重绘。Dirty 标记记录变化类型，标记传播确保所有受影响节点被标记，局部更新策略只更新变化部分。增量更新是复杂场景保持高性能的关键。</p>
<h2 data-id="heading-34">动态渲染模型</h2>
<p>动态渲染模型在静态基础上引入交互和时间演化。事件系统捕获用户输入，驱动两种动态行为：滑动和动画。滑动响应拖拽事件，改变渲染单元的空间偏移。动画在时间轴上插值渲染单元的属性，产生平滑的视觉变化。动态渲染模型使得静态画面变为可交互的动态体验。</p>
<h3 data-id="heading-35">滑动</h3>
<p>滑动是响应拖拽事件的空间偏移行为。用户拖拽滚动容器时，容器内的内容产生偏移，超出容器边界的部分被裁剪。滑动的本质是动态改变渲染单元的偏移量，不改变渲染单元的内容。</p>
<h4 data-id="heading-36">滑动的模型</h4>
<p><strong>滚动容器(Scroll Container)</strong></p>
<p>滑动发生在滚动容器中。滚动容器定义：</p>
<ul>
<li><strong>视口(Viewport)</strong>：容器的可见区域</li>
<li><strong>内容区域(Content)</strong>：容器内所有子节点的总边界</li>
<li><strong>滚动偏移(Scroll Offset)</strong>：内容相对视口的偏移量</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">视口：(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">300</span>, <span class="hljs-number">400</span>) - 屏幕上可见的区域
内容：(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">300</span>, <span class="hljs-number">1000</span>) - 实际内容的大小
滚动偏移：(<span class="hljs-number">0</span>, -<span class="hljs-number">200</span>) - 内容向上偏移 <span class="hljs-number">200</span> 像素
</code></pre>
<p><strong>滚动方向</strong></p>
<p>滚动容器支持两个方向的滚动：</p>
<ul>
<li><strong>垂直滚动</strong>：内容高度超出视口高度</li>
<li><strong>水平滚动</strong>：内容宽度超出视口宽度</li>
<li><strong>双向滚动</strong>：内容在两个方向都超出视口</li>
</ul>
<p>滚动方向决定了拖拽事件如何映射为滚动偏移。</p>
<h4 data-id="heading-37">滚动的实现</h4>
<p><strong>动态偏移</strong></p>
<p>滑动通过动态偏移实现，不重新生成渲染单元。滚动容器的子节点应用一个动态变换：</p>
<pre><code class="hljs">子节点的渲染位置 = 子节点的原始位置 + 滚动偏移
</code></pre>
<p>动态偏移使得滑动可以高性能执行：每帧只更新偏移值，不重新计算 Geometry 和 Paint。</p>
<p><strong>裁剪边界</strong></p>
<p>滚动容器使用 Clip 裁剪超出视口的内容。裁剪边界是视口的边界矩形，确保只有视口内的内容可见。</p>
<p><strong>滚动范围限制</strong></p>
<p>滚动偏移不能无限制，受内容和视口大小限制：</p>
<pre><code class="hljs">最小偏移 = 0（内容顶部对齐视口顶部）
最大偏移 = 内容大小 - 视口大小（内容底部对齐视口底部）
</code></pre>
<p>当用户拖拽超出滚动范围时，系统可以选择：</p>
<ul>
<li><strong>硬边界</strong>：偏移固定在边界值，不允许超出</li>
<li><strong>弹性边界</strong>：允许短暂超出，松手后弹回边界</li>
</ul>
<h4 data-id="heading-38">惯性滚动</h4>
<p><strong>物理模拟</strong></p>
<p>用户快速拖拽后松手，内容应该继续滚动并逐渐减速，这是惯性滚动。惯性滚动模拟物理运动：</p>
<pre><code class="hljs">速度 = 拖拽结束时的速度
每帧：
  速度 = 速度 × 阻尼系数（如 0.95）
  偏移 = 偏移 + 速度
  if 速度接近 0：停止滚动
</code></pre>
<p>阻尼系数控制减速快慢，系数越小减速越快。</p>
<p><strong>边界弹性</strong></p>
<p>当惯性滚动超出边界时，应用更强的阻尼并反向弹回：</p>
<pre><code class="hljs language-scss" lang="scss">if 偏移 &gt; 最大偏移：
  超出距离 = 偏移 - 最大偏移
  阻尼 = <span class="hljs-number">1</span> / (<span class="hljs-number">1</span> + 超出距离 / 内容大小)
  偏移 = 最大偏移 + 超出距离 × 阻尼
</code></pre>
<p>超出越远，阻尼越强，形成"橡皮筋"效果。</p>
<h4 data-id="heading-39">固定定位与粘性定位</h4>
<p><strong>固定定位(Fixed Positioning)</strong></p>
<p>固定定位的节点不随滚动偏移移动，始终固定在视口的特定位置。固定定位节点的渲染位置计算：</p>
<pre><code class="hljs">渲染位置 = 视口位置 + 固定偏移（忽略滚动偏移）
</code></pre>
<p>固定定位常用于导航栏、悬浮按钮等始终可见的 UI 元素。</p>
<p><strong>粘性定位(Sticky Positioning)</strong></p>
<p>粘性定位的节点在滚动到特定位置后固定。粘性定位定义：</p>
<ul>
<li><strong>粘性范围</strong>：节点可以粘性固定的滚动范围</li>
<li><strong>粘性偏移</strong>：节点固定时相对视口的位置</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">if</span> 滚动偏移 in 粘性范围：
  渲染位置 = 视口位置 + 粘性偏移（固定）
<span class="hljs-keyword">else</span>：
  渲染位置 = 原始位置 + 滚动偏移（正常滚动）
</code></pre>
<p>粘性定位常用于表格标题、分组标题等需要"吸顶"的元素。</p>
<h4 data-id="heading-40">小结</h4>
<p>滑动通过动态偏移实现内容的空间移动，不改变渲染单元的内容。滚动容器定义视口、内容和偏移的关系，裁剪边界确保只有视口内可见。惯性滚动通过物理模拟产生自然的减速效果。固定定位和粘性定位扩展了滚动行为，使得部分节点不受或部分受滚动影响。</p>
<h3 data-id="heading-41">动画</h3>
<p>动画是渲染属性随时间的变化。渲染属性包括渲染单元的属性（Geometry、Paint）和渲染效果（透明度、变换、模糊等）。动画的生成方式分为两类：状态插值（定义起始和结束状态，在两者之间插值）和程序生成（根据算法计算每帧的值，如物理模拟、数学函数等）。动画的核心问题是：如何生成动画、如何实现动画（可变化的渲染对象）、如何计算属性值（插值或程序生成）、如何控制进度（时间到进度的映射）。</p>
<h4 data-id="heading-42">动画生成</h4>
<p>动画生成定义动画的输入条件。生成方式分为两类：显式定义和自动推导。</p>
<p><strong>显式定义</strong></p>
<p>显式定义由用户直接指定动画的参数：</p>
<ul>
<li><strong>目标属性</strong>：哪些渲染属性需要变化</li>
<li><strong>变化规则</strong>：属性如何随时间变化（插值、程序生成等）</li>
<li><strong>时间参数</strong>：动画的时长、延迟等时间控制</li>
</ul>
<p>显式定义的优势是精确和可控，适用于设计师制作的动画效果。</p>
<p><strong>自动推导</strong></p>
<p>自动推导根据状态变化生成动画。给定两个状态（如场景 A 和场景 B），系统自动计算差异并生成过渡动画。</p>
<p>自动推导的核心是计算"什么改变了"：对比两个状态的渲染属性，找出差异的属性和值，为这些差异生成动画。</p>
<p>自动推导的优势是自动化，无需手动配置每个属性，适用于状态驱动的系统。</p>
<h4 data-id="heading-43">动画实现</h4>
<p>动画实现有两种机制：属性动态变化和图层动态合成。</p>
<p><strong>属性动态变化</strong></p>
<p>属性动态变化使得渲染属性根据进度计算，而非固定值。</p>
<pre><code class="hljs language-scss" lang="scss">静态渲染：属性 = 固定值
动态渲染：属性 = <span class="hljs-built_in">f</span>(进度)
</code></pre>
<p><strong>示例</strong>：</p>
<ul>
<li><strong>动态透明度</strong>：<code>透明度 = lerp(0, 1, 进度)</code> - 淡入效果</li>
<li><strong>动态变换</strong>：<code>变换 = lerp(起始矩阵, 结束矩阵, 进度)</code> - 平移、旋转、缩放</li>
<li><strong>动态颜色</strong>：<code>颜色 = lerp(红色, 蓝色, 进度)</code> - 颜色渐变</li>
<li><strong>动态偏移</strong>：<code>偏移 = 初始速度 × 时间 × 阻尼^时间</code> - 惯性滚动</li>
</ul>
<p><strong>图层动态合成</strong></p>
<p>图层动态合成使得多个渲染单元的组合方式根据进度变化。</p>
<pre><code class="hljs language-scss" lang="scss">静态渲染：多个渲染单元按固定方式组合
动态渲染：组合方式 = <span class="hljs-built_in">g</span>(进度)
</code></pre>
<p><strong>示例</strong>：</p>
<ul>
<li><strong>动态透明度合成</strong>：两个渲染单元，各自的透明度随进度变化，<code>透明度A = 1 - 进度</code>，<code>透明度B = 进度</code></li>
<li><strong>动态裁剪合成</strong>：裁剪区域随进度变化，如擦除动画、展开动画</li>
</ul>
<h4 data-id="heading-44">进度控制</h4>
<p>进度控制将时间映射为进度值（0-1）。不同的映射函数产生不同的动画节奏。</p>
<p><strong>线性进度</strong></p>
<p>最简单的映射是线性：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">progress</span> = (当前时间 - 起始时间) / 时长
</code></pre>
<p>线性进度产生匀速动画，没有加速或减速。</p>
<p><strong>缓动函数(Easing Function)</strong></p>
<p>缓动函数改变进度曲线，产生加速、减速、回弹等效果。缓动函数是 <code>f: [0, 1] → [0, 1]</code> 的映射。</p>
<p>常见的缓动函数：</p>
<ul>
<li><strong>Ease In</strong>：<code>f(t) = t²</code>，开始慢、结束快</li>
<li><strong>Ease Out</strong>：<code>f(t) = 1 - (1 - t)²</code>，开始快、结束慢</li>
<li><strong>Ease In Out</strong>：<code>f(t) = 3t² - 2t³</code>，开始慢、中间快、结束慢</li>
</ul>
<p><strong>贝塞尔缓动</strong></p>
<p>贝塞尔缓动使用三次贝塞尔曲线定义进度曲线。给定两个控制点 (x1, y1) 和 (x2, y2)，曲线从 (0, 0) 到 (1, 1)。</p>
<p>贝塞尔缓动的优势是灵活性：通过调整控制点可以定义任意平滑曲线。</p>
<p><strong>弹簧模拟(Spring Simulation)</strong></p>
<p>弹簧模拟使用物理公式计算进度。给定质量、刚度、阻尼参数，模拟弹簧的振荡运动：</p>
<pre><code class="hljs language-scss" lang="scss">加速度 = <span class="hljs-built_in">-</span>(刚度 / 质量) × (当前位置 - 目标位置) - (阻尼 / 质量) × 速度
速度 = 速度 + 加速度 × 时间步长
位置 = 位置 + 速度 × 时间步长
</code></pre>
<p>弹簧模拟产生自然的回弹效果，常用于交互动画。</p>
<p><strong>程序生成进度</strong></p>
<p>程序生成不依赖固定的起始和结束状态，而是根据算法计算每帧的值。惯性滚动是程序生成的典型例子：</p>
<pre><code class="hljs">每帧：
  速度 = 速度 × 阻尼
  偏移 = 偏移 + 速度
</code></pre>
<p>程序生成的结束时机由算法决定（如速度接近 0），不是预定义的时长。</p>
<h4 data-id="heading-45">小结</h4>
<p>动画通过配置或智能匹配生成，可变渲染对象支持属性的动态变化。属性插值根据不同类型使用不同算法，进度控制通过缓动函数或物理模拟映射时间到进度。动画使得静态画面在时间轴上演化，产生流畅的视觉变化。</p>
<h3 data-id="heading-46">事件系统</h3>
<p>事件系统捕获用户输入并转换为渲染系统可识别的交互信号。事件系统的核心是三层结构：基础事件（原始输入）、事件合成（高级交互）、持续状态（交互过程的状态跟踪）。基础事件来自输入设备，事件合成将基础事件组合为语义化的交互，持续状态记录交互过程的中间状态。</p>
<h4 data-id="heading-47">基础事件</h4>
<p>基础事件是输入设备的原始信号，直接反映用户的物理操作。</p>
<p><strong>指针事件</strong>：</p>
<ul>
<li><strong>Down</strong>：指针按下</li>
<li><strong>Move</strong>：指针移动</li>
<li><strong>Up</strong>：指针抬起</li>
</ul>
<p>每个事件包含位置信息和时间戳。</p>
<p><strong>键盘事件</strong>：KeyDown、KeyUp</p>
<p><strong>其他输入</strong>：滚轮、手势等</p>
<p>基础事件是低级的、无语义的原始信号。</p>
<h4 data-id="heading-48">事件合成</h4>
<p>事件合成将基础事件序列组合为高级的语义化交互。</p>
<p><strong>组合逻辑</strong></p>
<p>事件合成通过分析基础事件的序列、位置、时间间隔，识别用户的意图：</p>
<ul>
<li><strong>点击(Click)</strong>：Down + Up，位置接近、时间短</li>
<li><strong>拖拽(Drag)</strong>：Down + Move(距离超过阈值) + Up</li>
<li><strong>双击(Double Click)</strong>：两次 Click，时间间隔短</li>
<li><strong>长按(Long Press)</strong>：Down 后持续时间长且无 Move</li>
</ul>
<p><strong>空间合成</strong></p>
<p>空间合成基于指针位置与渲染单元边界的关系：</p>
<ul>
<li><strong>MouseEnter / MouseLeave</strong>：指针 Move 事件的位置进入或离开渲染单元的边界</li>
<li><strong>Hover</strong>：MouseEnter 到 MouseLeave 之间的持续状态</li>
</ul>
<p>空间合成需要命中测试：每次 Move 事件判断当前命中的渲染单元，与上一次对比，触发 Enter/Leave 事件。</p>
<p><strong>合成的本质</strong></p>
<p>事件合成是状态机：根据当前状态和新的基础事件，转换到新状态并可能触发高级事件。例如拖拽识别：</p>
<pre><code class="hljs language-scss" lang="scss">状态：Idle → Down → <span class="hljs-built_in">Moving</span>(累积距离) → Dragging → Idle
</code></pre>
<h4 data-id="heading-49">持续状态</h4>
<p>持续状态记录交互过程的状态，用于持续响应和状态查询。</p>
<p><strong>状态的作用</strong></p>
<p>持续状态表达"正在进行"的交互：</p>
<ul>
<li><strong>Hovering</strong>：指针正在悬停在某个渲染单元上</li>
<li><strong>Pressing</strong>：指针正在按压某个渲染单元</li>
<li><strong>Dragging</strong>：正在拖拽某个渲染单元</li>
</ul>
<p><strong>状态的生命周期</strong></p>
<p>持续状态由事件触发，持续到交互结束：</p>
<pre><code class="hljs language-arduino" lang="arduino">进入事件 → 状态 = <span class="hljs-literal">true</span>
过程中：持续响应（如更新位置、显示反馈）
退出事件 → 状态 = <span class="hljs-literal">false</span>
</code></pre>
<p><strong>状态的应用</strong></p>
<p>持续状态用于：</p>
<ul>
<li>显示视觉反馈（如按钮按下状态、悬停高亮）</li>
<li>持续更新（如拖拽时实时更新滚动偏移）</li>
<li>状态查询（如判断"是否正在拖拽"）</li>
</ul>
<h4 data-id="heading-50">事件分发</h4>
<p>事件分发将事件路由到目标渲染单元。</p>
<p><strong>命中测试(Hit Test)</strong></p>
<p>命中测试判断指针位置对应哪个渲染单元。从树的根节点递归遍历，找到最深的包含指针位置的节点。</p>
<p><strong>事件冒泡(Bubbling)</strong></p>
<p>事件可以沿着树向上传播：事件先在命中节点触发，如果未处理则向父节点传播。冒泡机制允许父节点响应子节点的事件。</p>
<h4 data-id="heading-51">小结</h4>
<p>事件系统将原始输入转换为语义化交互。基础事件捕获设备信号，事件合成通过状态机识别用户意图，持续状态记录交互过程。事件分发通过命中测试和冒泡将事件路由到目标。事件系统驱动滑动和动画，是交互能力的基础。</p>
<h2 data-id="heading-52">Figma 的渲染模型</h2>
<p>Figma 是前两章抽象原理的具体实现。Figma 的渲染模型包含静态渲染模型和动态渲染模型，分别对应设计元素的表达和原型交互的能力。本章介绍 Figma 的文档模型：有哪些图形类型、有哪些渲染效果、如何组织层级关系、如何实现动态交互。</p>
<h3 data-id="heading-53">静态 - 渲染单元</h3>
<p>Figma 支持多种图形类型和样式属性。</p>
<p>基础图形类型：</p>
<ul>
<li><strong>矩形(Rectangle)</strong>：轴对齐矩形，支持独立圆角半径</li>
<li><strong>椭圆(Ellipse)</strong>：标准椭圆和圆形</li>
<li><strong>线条(Line)</strong>：直线段</li>
<li><strong>矢量(Vector)</strong>：贝塞尔曲线路径</li>
<li><strong>文本(Text)</strong>：文字内容，支持富文本样式</li>
<li><strong>容器(Frame)</strong>：矩形容器，可包含子元素</li>
<li><strong>分组(Group)</strong>：逻辑分组，不可见边界</li>
</ul>
<p>复合图形：</p>
<ul>
<li><strong>布尔运算(Boolean Operation)</strong>：路径的并集、交集、差集、排除</li>
<li><strong>组件(Component)</strong>：可复用的设计元素</li>
<li><strong>实例(Instance)</strong>：组件的引用实例</li>
</ul>
<p>样式属性：</p>
<p>填充(Fill)：纯色(RGBA)、线性渐变、径向渐变、角度渐变、图像填充。一个图形可以有多个填充，按顺序叠加。</p>
<p>描边(Stroke)：宽度、对齐（居中/内侧/外侧）、端点样式（平直/圆形/方形）、连接样式（尖角/圆角/斜角）、虚线模式。描边使用与填充相同的颜色类型。</p>
<h3 data-id="heading-54">静态 - 渲染效果</h3>
<p>Figma 支持多种渲染效果，扩展图形的视觉表现。</p>
<p>阴影：外阴影(Drop Shadow)在图形外部投射阴影，内阴影(Inner Shadow)在图形内部显示阴影。一个图形可以有多个阴影，叠加显示。</p>
<p>模糊：图层模糊(Layer Blur)对图形及其子元素整体模糊，背景模糊(Background Blur)对图形背后的内容模糊。</p>
<p>透明度与混合：透明度(Opacity)控制 0-100% 的不透明度。混合模式(Blend Mode)定义与下层内容的混合方式，支持穿透、正常、变暗类（变暗、正片叠底、颜色加深）、变亮类（变亮、滤色、颜色减淡）、对比类（叠加、柔光、强光）、差值类（差值、排除）、颜色类（色相、饱和度、颜色、明度）。</p>
<p>遮罩：Alpha 遮罩使用图形的 Alpha 通道裁剪后续兄弟元素，轮廓遮罩(Outline Mask)让图形本身渲染后再作为遮罩。</p>
<p>裁剪：容器裁剪(Clip Content)使 Frame 可以裁剪超出边界的子元素。</p>
<h3 data-id="heading-55">静态 - 层级组织及渲染影响</h3>
<p>Figma 使用树形结构组织元素，通过 Frame 和 Group 形成层级。</p>
<p>层级结构：Frame 是容器，可包含子元素；Group 是逻辑分组，将多个元素组合为一个单元。层级关系定义了元素之间的渲染影响。</p>
<p>渲染影响：</p>
<p>父子影响：变换(Transform)累积到子元素，透明度(Opacity)相乘到子元素，图层模糊(Layer Blur)作用于父元素及其所有子元素。</p>
<p>兄弟影响：遮罩(Mask)裁剪后续的兄弟元素（直到遇到下一个遮罩或容器边界），布尔运算作用于多个兄弟元素的路径。</p>
<p>背景依赖：背景模糊需要元素背后已渲染的内容（父元素背景、之前的兄弟元素），混合模式与背景内容进行像素混合。</p>
<h3 data-id="heading-56">静态 - 合成顺序</h3>
<p>Figma 按照固定的顺序合成元素的视觉效果：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 外阴影 (Drop Shadow)
<span class="hljs-bullet">2.</span> 背景模糊 (Background Blur)
<span class="hljs-bullet">3.</span> 填充 (Fill)
<span class="hljs-bullet">4.</span> 子元素 (Children)
<span class="hljs-bullet">5.</span> 描边 (Stroke)
<span class="hljs-bullet">6.</span> 内阴影 (Inner Shadow)
<span class="hljs-bullet">7.</span> 图层模糊 (Layer Blur)
<span class="hljs-bullet">8.</span> 透明度和混合模式 (Opacity &amp; Blend Mode)
</code></pre>
<p>这个顺序确保效果之间的依赖关系正确。描边的位置可以调整：如果 Frame 的 Clip Content 为 false，描边在子元素之前渲染。</p>
<h3 data-id="heading-57">动态 - 滑动</h3>
<p>Figma 的 Frame 可以作为滚动容器。</p>
<p>滚动容器：支持水平、垂直、双向滚动，滚动边界由内容大小和视口大小决定，溢出行为可以是滚动(Scroll)或隐藏(Hidden)。</p>
<p>定位模式：固定定位(Fixed)不随滚动移动，粘性定位(Sticky)滚动到特定位置后固定。</p>
<p>惯性滚动：原型模式下，滑动手势触发惯性滚动，模拟物理减速效果。</p>
<h3 data-id="heading-58">动态 - 自动布局</h3>
<p>Figma 的 Auto Layout 是自动布局的实现，根据约束自动计算元素的变换。Auto Layout 支持动态响应：当内容改变时，布局自动重新计算，元素的位置和尺寸动态调整。</p>
<p>布局约束：</p>
<ul>
<li><strong>排列方向</strong>：水平(Horizontal)或垂直(Vertical)排列子元素</li>
<li><strong>对齐方式</strong>：子元素在交叉轴上的对齐（顶部/底部/左侧/右侧/居中）</li>
<li><strong>间距</strong>：子元素之间的固定间距</li>
<li><strong>内边距</strong>：容器边缘与子元素之间的距离</li>
</ul>
<p>尺寸模式：</p>
<ul>
<li><strong>Hug Contents</strong>：容器尺寸适应子元素（自下而上）</li>
<li><strong>Fixed</strong>：容器尺寸固定</li>
<li><strong>Fill Container</strong>：元素填充父容器分配的空间（自上而下）</li>
</ul>
<p>动态响应：</p>
<ul>
<li>文本内容改变时，文本框的尺寸自动调整，父容器的布局自动更新</li>
<li>添加或删除子元素时，容器尺寸和其他子元素位置自动重新计算</li>
<li>嵌套的 Auto Layout 容器形成层级响应：子容器的尺寸改变触发父容器的布局更新</li>
</ul>
<p>约束(Constraints)：</p>
<p>Constraints 是相对定位的另一种形式，定义元素相对父容器的固定关系：</p>
<ul>
<li><strong>固定边缘</strong>：元素的某条边缘相对父容器边缘固定距离（如"距离顶部 20px"）</li>
<li><strong>比例缩放</strong>：元素随父容器按比例缩放</li>
<li><strong>居中</strong>：元素在父容器中保持居中</li>
</ul>
<p>Constraints 与 Auto Layout 可以共存：Auto Layout 作用于容器的直接子元素，Constraints 作用于非 Auto Layout 容器中的元素。</p>
<h3 data-id="heading-59">动态 - 动画</h3>
<p>Figma 通过智能动画实现原型的过渡效果。</p>
<p>智能动画(Smart Animate)自动生成两个画面之间的过渡：根据图层名称、ID 匹配对应元素，对比属性差异，为可插值的属性生成平滑过渡，不可插值的使用溶解(Dissolve)。</p>
<p>可动画的属性：变换（位置、旋转、缩放）、透明度、颜色（填充和描边）、尺寸（宽度和高度）、圆角半径、滚动偏移。</p>
<p>溶解过渡：当元素类型改变或属性不可插值时，旧元素淡出、新元素淡入。</p>
<p>缓动控制：支持线性（匀速）、缓入、缓出、缓入缓出、弹簧（物理弹簧效果）。</p>
<p>动作类型：导航(Navigate)跳转到另一个画面，打开弹窗(Open Overlay)和关闭弹窗(Close Overlay)控制浮层，返回(Back)返回上一个画面，滚动到(Scroll To)滚动到指定位置，切换(Toggle)切换组件变体。</p>
<h3 data-id="heading-60">动态 - 事件</h3>
<p>Figma 原型支持交互触发器、持续状态和事件合成。</p>
<p>触发器：点击(On Click)响应鼠标点击或触摸，悬停(On Hover)响应鼠标悬停，按下(On Press)响应鼠标或触摸按下，拖拽(On Drag)响应拖拽手势，键盘(On Key)响应按键。</p>
<p>持续状态：原型执行时维护悬停状态（鼠标悬停在元素上）、按压状态（正在按压元素）、拖拽状态（正在拖拽元素），用于显示交互反馈。</p>
<p>事件合成：基础的指针事件（Down、Move、Up）合成为高级交互（Click、Drag、Hover），基础的键盘事件合成为按键操作。</p>
<h3 data-id="heading-61">小结</h3>
<p>Figma 实现了完整的 2D 渲染模型。静态渲染模型提供丰富的图形类型（矩形、椭圆、矢量、文本等）和渲染效果（阴影、模糊、混合、遮罩），通过树形结构组织元素，按固定顺序合成视觉效果。动态渲染模型支持滚动容器、智能动画和事件触发，使得静态设计可以转化为交互原型。Figma 的渲染模型是前两章抽象原理的完整实现。</p>
<h2 data-id="heading-62">HTML/CSS 的渲染模型</h2>
<p>CSS 是 Web 平台的样式语言，定义了 HTML 元素的视觉呈现。CSS 的渲染模型包含静态渲染模型和动态渲染模型，分别对应元素的样式表达和交互动画能力。本章介绍 CSS 如何实现 2D 渲染抽象：有哪些图形能力、有哪些渲染效果、如何组织层级关系、如何实现动态交互。</p>
<h3 data-id="heading-63">静态 - 渲染单元</h3>
<p>CSS 中的渲染单元是 HTML 元素（Element）。每个元素通过 CSS 属性定义其几何和样式。</p>
<p>基础图形类型：</p>
<p>CSS 不直接提供图形类型，而是通过盒模型（Box Model）定义元素的矩形区域。所有元素默认是矩形，通过 CSS 属性可以变换为其他形状：</p>
<ul>
<li><strong>矩形</strong>：元素的默认形状，由 width、height 定义</li>
<li><strong>圆角矩形</strong>：通过 border-radius 实现</li>
<li><strong>圆形/椭圆</strong>：border-radius 设置为 50%</li>
<li><strong>任意形状</strong>：通过 clip-path 裁剪为多边形、圆形、椭圆、路径</li>
</ul>
<p>背景填充：</p>
<ul>
<li><strong>background-color</strong>：纯色填充</li>
<li><strong>background-image</strong>：图像填充，支持 url() 和渐变</li>
<li><strong>渐变</strong>：linear-gradient（线性）、radial-gradient（径向）、conic-gradient（圆锥）</li>
</ul>
<p>边框：</p>
<ul>
<li><strong>border</strong>：边框样式，包含 border-width、border-style、border-color</li>
<li><strong>border-radius</strong>：圆角半径，支持每个角独立设置</li>
</ul>
<p>文本：</p>
<ul>
<li><strong>font</strong>：字体属性，包含 font-family、font-size、font-weight、font-style</li>
<li><strong>color</strong>：文本颜色</li>
<li><strong>text-decoration</strong>：文本装饰（下划线、删除线等）</li>
</ul>
<p>矢量图形 (SVG)：</p>
<p>SVG (Scalable Vector Graphics) 是 CSS 渲染模型中的矢量表达方式。SVG 元素可以嵌入 HTML 中，通过 SVG 标签定义矢量图形。</p>
<p>SVG 提供完整的矢量图形能力：</p>
<ul>
<li><strong>基础图形</strong>：<code>&lt;rect&gt;</code>（矩形）、<code>&lt;circle&gt;</code>（圆形）、<code>&lt;ellipse&gt;</code>（椭圆）、<code>&lt;line&gt;</code>（直线）、<code>&lt;polyline&gt;</code>（折线）、<code>&lt;polygon&gt;</code>（多边形）</li>
<li><strong>路径</strong>：<code>&lt;path&gt;</code> 使用路径命令（M、L、C、Q、A 等）定义任意形状，支持贝塞尔曲线</li>
<li><strong>文本</strong>：<code>&lt;text&gt;</code> 定义矢量文本</li>
<li><strong>分组</strong>：<code>&lt;g&gt;</code> 将多个图形分组</li>
</ul>
<p>SVG 的样式控制：</p>
<ul>
<li><strong>fill</strong>：填充颜色或渐变</li>
<li><strong>stroke</strong>：描边颜色、宽度、端点样式、连接样式</li>
<li><strong>渐变</strong>：<code>&lt;linearGradient&gt;</code>、<code>&lt;radialGradient&gt;</code> 定义渐变填充</li>
<li><strong>变换</strong>：transform 属性支持平移、旋转、缩放</li>
</ul>
<p>SVG 与 CSS 的结合：</p>
<ul>
<li>SVG 元素可以应用 CSS 样式（如 opacity、filter、clip-path）</li>
<li>CSS 的渲染效果（阴影、模糊、混合模式）同样作用于 SVG 元素</li>
<li>SVG 的坐标系统独立于 HTML 盒模型，通过 viewBox 定义</li>
</ul>
<h3 data-id="heading-64">静态 - 渲染效果</h3>
<p>CSS 提供丰富的渲染效果，对应前文的可见性控制、混合模式、后处理效果。</p>
<p>可见性控制：</p>
<ul>
<li><strong>opacity</strong>：透明度（0-1），创建层叠上下文</li>
<li><strong>visibility</strong>：可见性（visible/hidden），hidden 时不响应事件</li>
</ul>
<p>裁剪：</p>
<ul>
<li><strong>clip-path</strong>：使用几何路径裁剪元素（circle、ellipse、polygon、path）</li>
<li><strong>overflow</strong>：容器溢出处理（visible/hidden/scroll/auto）</li>
</ul>
<p>遮罩：</p>
<ul>
<li><strong>mask-image</strong>：遮罩图像</li>
<li><strong>mask-mode</strong>：遮罩模式（alpha/luminance）</li>
<li><strong>mask-composite</strong>：多个遮罩层的合成方式（add/subtract/intersect/exclude）</li>
</ul>
<p>混合模式：</p>
<ul>
<li><strong>mix-blend-mode</strong>：元素与下层内容的混合（multiply、screen、overlay 等）</li>
<li><strong>background-blend-mode</strong>：元素多个背景层之间的混合</li>
</ul>
<p>后处理效果：</p>
<ul>
<li><strong>filter</strong>：图像滤镜，包含：
<ul>
<li>模糊：blur()</li>
<li>颜色调整：brightness()、contrast()、saturate()、grayscale()、hue-rotate()</li>
<li>其他：invert()、opacity()、drop-shadow()</li>
</ul>
</li>
<li><strong>backdrop-filter</strong>：背景模糊，对元素背后的内容应用滤镜</li>
</ul>
<p>阴影：</p>
<ul>
<li><strong>box-shadow</strong>：盒阴影，支持多个阴影叠加</li>
<li><strong>text-shadow</strong>：文本阴影</li>
</ul>
<h3 data-id="heading-65">静态 - 自动布局</h3>
<p>CSS 提供多种布局系统，自动计算元素的变换。</p>
<p>布局模式：</p>
<ul>
<li><strong>正常流(Normal Flow)</strong>：块级元素垂直排列，行内元素水平排列</li>
<li><strong>Flexbox</strong>：一维弹性布局，通过 display: flex 启用</li>
<li><strong>Grid</strong>：二维网格布局，通过 display: grid 启用</li>
<li><strong>定位(Positioning)</strong>：通过 position 属性改变元素的定位方式</li>
</ul>
<p>Flexbox 布局约束：</p>
<ul>
<li><strong>flex-direction</strong>：排列方向（row/column）</li>
<li><strong>justify-content</strong>：主轴对齐方式</li>
<li><strong>align-items</strong>：交叉轴对齐方式</li>
<li><strong>gap</strong>：子元素间距</li>
<li><strong>flex</strong>：子元素的伸缩比例（flex-grow、flex-shrink、flex-basis）</li>
</ul>
<p>Grid 布局约束：</p>
<ul>
<li><strong>grid-template-rows/columns</strong>：显式定义网格轨道</li>
<li><strong>grid-auto-rows/columns</strong>：隐式网格轨道的尺寸</li>
<li><strong>gap</strong>：网格间距</li>
<li><strong>justify-items/align-items</strong>：单元格内元素的对齐</li>
<li><strong>grid-column/row</strong>：元素在网格中的位置</li>
</ul>
<p>盒模型：</p>
<ul>
<li><strong>box-sizing</strong>：盒模型计算方式（content-box/border-box）</li>
<li><strong>width/height</strong>：元素尺寸</li>
<li><strong>margin</strong>：外边距</li>
<li><strong>padding</strong>：内边距</li>
</ul>
<h3 data-id="heading-66">静态 - 层级组织及渲染影响</h3>
<p>CSS 通过 DOM 树组织元素，HTML 元素形成父子层级关系。</p>
<p>层级结构：DOM 树是 HTML 文档的树形结构，每个 HTML 元素（<code>&lt;div&gt;</code>、<code>&lt;span&gt;</code> 等）是树的节点。CSS 通过选择器匹配元素，应用样式。</p>
<p>渲染影响：</p>
<p>后代级别：</p>
<ul>
<li><strong>transform</strong>：变换累积到子元素</li>
<li><strong>opacity</strong>：透明度相乘到子元素</li>
<li><strong>filter</strong>：作用于元素及其所有子元素</li>
</ul>
<p>兄弟影响：</p>
<p>CSS 没有直接的兄弟影响机制（如蒙版），但通过层叠顺序（z-index）和定位可以实现元素间的覆盖关系。</p>
<p>背景依赖：</p>
<ul>
<li><strong>backdrop-filter</strong>：依赖元素背后已渲染的内容</li>
<li><strong>mix-blend-mode</strong>：与背景内容进行像素混合</li>
</ul>
<h3 data-id="heading-67">静态 - 合成顺序</h3>
<p>CSS 规范定义了固定的渲染顺序：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-number">1</span>. 绘制元素（<span class="hljs-attribute">background</span>, <span class="hljs-attribute">border</span>, <span class="hljs-attribute">content</span>）
<span class="hljs-number">2</span>. backdrop-<span class="hljs-attribute">filter</span> — 对元素背后的内容应用滤镜
<span class="hljs-number">3</span>. <span class="hljs-attribute">filter</span> — 对元素自身应用滤镜
<span class="hljs-number">4</span>. <span class="hljs-attribute">clip-path</span> — 裁剪
<span class="hljs-number">5</span>. <span class="hljs-attribute">mask</span> — 遮罩
<span class="hljs-number">6</span>. <span class="hljs-attribute">opacity</span> — 透明度
<span class="hljs-number">7</span>. <span class="hljs-attribute">mix-blend-mode</span> — 与下层内容混合
<span class="hljs-number">8</span>. compositing — 与父级合成
</code></pre>
<p>这个顺序确保效果之间的依赖关系正确。box-shadow 和 background 在绘制阶段完成，filter 和 mask 在后处理阶段应用。</p>
<h3 data-id="heading-68">动态 - 滑动</h3>
<p>CSS 通过 overflow 属性支持滚动容器。</p>
<p>滚动容器：overflow 设置为 scroll 或 auto 时，元素成为滚动容器。内容超出容器边界时，出现滚动条，用户可以滚动查看隐藏内容。</p>
<p>定位模式：</p>
<ul>
<li><strong>position: fixed</strong>：固定定位，不随滚动移动，相对视口定位</li>
<li><strong>position: sticky</strong>：粘性定位，滚动到特定位置后固定</li>
</ul>
<p>滚动行为：</p>
<ul>
<li><strong>scroll-behavior</strong>：滚动平滑性（auto/smooth）</li>
<li><strong>overscroll-behavior</strong>：滚动边界行为（auto/contain/none）</li>
</ul>
<h3 data-id="heading-69">动态 - 自动布局</h3>
<p>CSS 的布局系统支持动态响应。</p>
<p>响应式布局：</p>
<ul>
<li><strong>媒体查询(Media Query)</strong>：根据屏幕尺寸应用不同样式</li>
<li><strong>容器查询(Container Query)</strong>：根据父容器尺寸应用不同样式</li>
</ul>
<p>内容驱动的尺寸：</p>
<ul>
<li><strong>min-content/max-content</strong>：元素尺寸由内容决定</li>
<li><strong>fit-content</strong>：元素尺寸在 min-content 和 max-content 之间自适应</li>
<li><strong>auto</strong>：尺寸由布局系统自动计算</li>
</ul>
<p>Flexbox 和 Grid 都支持动态响应：子元素的尺寸改变时，容器自动重新分配空间。嵌套的布局容器形成层级响应。</p>
<h3 data-id="heading-70">动态 - 动画</h3>
<p>CSS 提供两种动画机制：过渡(Transition)和动画(Animation)。</p>
<p>过渡(Transition)：</p>
<p>当 CSS 属性值改变时，过渡自动生成从旧值到新值的平滑动画。</p>
<ul>
<li><strong>transition-property</strong>：要过渡的属性</li>
<li><strong>transition-duration</strong>：过渡时长</li>
<li><strong>transition-timing-function</strong>：缓动函数（ease、linear、cubic-bezier）</li>
<li><strong>transition-delay</strong>：延迟时间</li>
</ul>
<p>动画(Animation)：</p>
<p>通过 @keyframes 定义关键帧，元素按时间轴播放动画。</p>
<ul>
<li><strong>animation-name</strong>：动画名称，对应 @keyframes</li>
<li><strong>animation-duration</strong>：动画时长</li>
<li><strong>animation-timing-function</strong>：缓动函数</li>
<li><strong>animation-iteration-count</strong>：重复次数（数字/infinite）</li>
<li><strong>animation-direction</strong>：播放方向（normal/reverse/alternate）</li>
</ul>
<p>可动画的属性：变换（transform）、透明度（opacity）、颜色（color、background-color）、尺寸（width、height）、位置（top、left）等。</p>
<p>变换(Transform)：</p>
<ul>
<li><strong>transform</strong>：变换函数（translate、rotate、scale、skew）</li>
<li><strong>transform-origin</strong>：变换原点</li>
</ul>
<h3 data-id="heading-71">动态 - 事件</h3>
<p>HTML5 提供完整的事件系统，通过 JavaScript 处理用户交互。事件系统包括基础事件、事件合成、事件分发。</p>
<p>基础事件：</p>
<p><strong>鼠标事件</strong>：</p>
<ul>
<li><strong>mousedown</strong>：鼠标按下</li>
<li><strong>mouseup</strong>：鼠标抬起</li>
<li><strong>mousemove</strong>：鼠标移动</li>
<li><strong>mouseenter</strong>：鼠标进入元素（不冒泡）</li>
<li><strong>mouseleave</strong>：鼠标离开元素（不冒泡）</li>
<li><strong>mouseover</strong>：鼠标进入元素或其子元素（冒泡）</li>
<li><strong>mouseout</strong>：鼠标离开元素或其子元素（冒泡）</li>
</ul>
<p><strong>触摸事件</strong>：</p>
<ul>
<li><strong>touchstart</strong>：触摸开始</li>
<li><strong>touchmove</strong>：触摸移动</li>
<li><strong>touchend</strong>：触摸结束</li>
<li><strong>touchcancel</strong>：触摸取消</li>
</ul>
<p><strong>指针事件(Pointer Events)</strong>：</p>
<ul>
<li><strong>pointerdown/pointerup/pointermove</strong>：统一的指针事件，兼容鼠标和触摸</li>
<li><strong>pointerenter/pointerleave</strong>：指针进入/离开元素</li>
</ul>
<p><strong>键盘事件</strong>：</p>
<ul>
<li><strong>keydown</strong>：按键按下</li>
<li><strong>keyup</strong>：按键抬起</li>
</ul>
<p><strong>滚轮事件</strong>：</p>
<ul>
<li><strong>wheel</strong>：鼠标滚轮滚动</li>
</ul>
<p>事件合成：</p>
<p>高级事件由基础事件组合而成：</p>
<ul>
<li><strong>click</strong>：mousedown + mouseup（位置接近、时间短）</li>
<li><strong>dblclick</strong>：两次 click（时间间隔短）</li>
<li><strong>contextmenu</strong>：右键点击</li>
<li><strong>drag 系列</strong>：dragstart、drag、dragend、dragenter、dragleave、drop</li>
</ul>
<p>持续状态：</p>
<p>CSS 伪类反映元素的交互状态：</p>
<ul>
<li><strong>:hover</strong>：鼠标悬停状态（mouseenter 到 mouseleave）</li>
<li><strong>:active</strong>：鼠标按下状态（mousedown 到 mouseup）</li>
<li><strong>:focus</strong>：元素获得焦点状态</li>
</ul>
<p>这些伪类对应前文的持续状态，可以在状态期间应用不同样式。</p>
<p>事件分发：</p>
<p><strong>事件冒泡(Bubbling)</strong>：事件从目标元素向上传播到父元素，直到根节点。</p>
<p><strong>事件捕获(Capturing)</strong>：事件从根节点向下传播到目标元素。</p>
<p>完整的事件流程：捕获阶段 → 目标阶段 → 冒泡阶段。通过 addEventListener 的第三个参数可以选择在捕获阶段或冒泡阶段监听事件。</p>
<p><strong>事件委托</strong>：利用事件冒泡，在父元素上监听子元素的事件，避免为每个子元素单独绑定事件。</p>
<h3 data-id="heading-72">小结</h3>
<p>CSS 实现了完整的 2D 渲染模型。静态渲染模型通过盒模型和 CSS 属性定义元素的几何和样式，提供丰富的渲染效果（阴影、模糊、混合、遮罩），通过 DOM 树组织元素，按固定顺序合成视觉效果。动态渲染模型支持滚动容器、过渡动画、关键帧动画，通过伪类响应交互状态。CSS 的布局系统（Flexbox、Grid）提供强大的自动布局能力，支持响应式和内容驱动的动态响应。</p>
<h2 data-id="heading-73">SVG 的渲染模型</h2>
<p>SVG (Scalable Vector Graphics) 是基于 XML 的矢量图形标记语言，定义了完整的 2D 矢量图形系统。SVG 可以独立使用，也可以嵌入 HTML 中。SVG 的渲染模型专注于矢量图形的精确表达，提供丰富的图形元素、样式系统和动画能力。本章介绍 SVG 如何实现 2D 渲染抽象：有哪些图形元素、渲染效果、以及动画能力。</p>
<h3 data-id="heading-74">静态 - 渲染单元</h3>
<p>SVG 的渲染单元是图形元素(Element)。每个元素通过属性定义其几何、样式和变换。</p>
<p>基础图形元素：</p>
<ul>
<li><strong><code>&lt;rect&gt;</code></strong>：矩形，属性：x、y、width、height、rx（圆角半径）</li>
<li><strong><code>&lt;circle&gt;</code></strong>：圆形，属性：cx、cy（圆心）、r（半径）</li>
<li><strong><code>&lt;ellipse&gt;</code></strong>：椭圆，属性：cx、cy（圆心）、rx、ry（长短轴半径）</li>
<li><strong><code>&lt;line&gt;</code></strong>：直线，属性：x1、y1、x2、y2（起点和终点）</li>
<li><strong><code>&lt;polyline&gt;</code></strong>：折线，属性：points（点坐标序列）</li>
<li><strong><code>&lt;polygon&gt;</code></strong>：多边形，属性：points（点坐标序列，自动闭合）</li>
<li><strong><code>&lt;path&gt;</code></strong>：路径，属性：d（路径命令）</li>
</ul>
<p>路径系统：</p>
<p><code>&lt;path&gt;</code> 是 SVG 最强大的图形元素，通过路径命令定义任意复杂形状。路径命令包括：</p>
<ul>
<li><strong>M/m</strong>：移动到(MoveTo)</li>
<li><strong>L/l</strong>：直线到(LineTo)</li>
<li><strong>H/h</strong>：水平线到</li>
<li><strong>V/v</strong>：垂直线到</li>
<li><strong>C/c</strong>：三次贝塞尔曲线</li>
<li><strong>S/s</strong>：平滑三次贝塞尔曲线</li>
<li><strong>Q/q</strong>：二次贝塞尔曲线</li>
<li><strong>T/t</strong>：平滑二次贝塞尔曲线</li>
<li><strong>A/a</strong>：椭圆弧</li>
<li><strong>Z/z</strong>：闭合路径</li>
</ul>
<p>大写命令使用绝对坐标，小写命令使用相对坐标。</p>
<p>文本元素：</p>
<ul>
<li><strong><code>&lt;text&gt;</code></strong>：文本，属性：x、y（位置）、font-family、font-size、fill 等</li>
<li><strong><code>&lt;tspan&gt;</code></strong>：文本片段，在 <code>&lt;text&gt;</code> 内定义不同样式的文本</li>
<li><strong><code>&lt;textPath&gt;</code></strong>：文本沿路径排列</li>
</ul>
<p>填充和描边：</p>
<p><strong>填充(Fill)</strong>：</p>
<ul>
<li><strong>fill</strong>：填充颜色，支持纯色、渐变、图案
<ul>
<li>纯色：直接指定颜色值（<code>fill="red"</code> 或 <code>fill="#ff0000"</code>）</li>
<li>渐变：引用渐变定义（<code>fill="url(#gradientId)"</code>）</li>
<li>图案：引用图案定义（<code>fill="url(#patternId)"</code>）</li>
</ul>
</li>
<li><strong>fill-opacity</strong>：填充透明度</li>
<li><strong>fill-rule</strong>：填充规则（nonzero/evenodd）</li>
</ul>
<p><strong>描边(Stroke)</strong>：</p>
<ul>
<li><strong>stroke</strong>：描边颜色，支持纯色、渐变、图案</li>
<li><strong>stroke-width</strong>：描边宽度</li>
<li><strong>stroke-opacity</strong>：描边透明度</li>
<li><strong>stroke-linecap</strong>：线条端点样式（butt/round/square）</li>
<li><strong>stroke-linejoin</strong>：线条连接样式（miter/round/bevel）</li>
<li><strong>stroke-dasharray</strong>：虚线模式</li>
<li><strong>stroke-dashoffset</strong>：虚线偏移</li>
</ul>
<p>渐变(Gradient)：</p>
<p>渐变是 Paint 的一种类型，定义颜色在空间中的分布。</p>
<ul>
<li><strong><code>&lt;linearGradient&gt;</code></strong>：线性渐变，属性：x1、y1、x2、y2（渐变方向）</li>
<li><strong><code>&lt;radialGradient&gt;</code></strong>：径向渐变，属性：cx、cy（中心）、r（半径）</li>
<li><strong><code>&lt;stop&gt;</code></strong>：渐变色标，属性：offset（位置 0-1）、stop-color（颜色）、stop-opacity（透明度）</li>
</ul>
<p>渐变定义在 <code>&lt;defs&gt;</code> 中，通过 <code>fill="url(#gradientId)"</code> 或 <code>stroke="url(#gradientId)"</code> 引用。</p>
<p>示例：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">defs</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">linearGradient</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"grad1"</span> <span class="hljs-attr">x1</span>=<span class="hljs-string">"0%"</span> <span class="hljs-attr">y1</span>=<span class="hljs-string">"0%"</span> <span class="hljs-attr">x2</span>=<span class="hljs-string">"100%"</span> <span class="hljs-attr">y2</span>=<span class="hljs-string">"0%"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">stop</span> <span class="hljs-attr">offset</span>=<span class="hljs-string">"0%"</span> <span class="hljs-attr">stop-color</span>=<span class="hljs-string">"red"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">stop</span> <span class="hljs-attr">offset</span>=<span class="hljs-string">"100%"</span> <span class="hljs-attr">stop-color</span>=<span class="hljs-string">"blue"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">linearGradient</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">defs</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">rect</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"200"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"url(#grad1)"</span>/&gt;</span>
</code></pre>
<p>图案(Pattern)：</p>
<p>图案是 Paint 的另一种类型，使用图形元素平铺填充区域。</p>
<ul>
<li><strong><code>&lt;pattern&gt;</code></strong>：图案定义，属性：
<ul>
<li>x、y、width、height：图案单元的尺寸和位置</li>
<li>patternUnits：坐标系统（userSpaceOnUse/objectBoundingBox）</li>
<li>patternContentUnits：图案内容的坐标系统</li>
</ul>
</li>
</ul>
<p>图案定义在 <code>&lt;defs&gt;</code> 中，通过 <code>fill="url(#patternId)"</code> 引用。</p>
<p>示例：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">defs</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"pattern1"</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"20"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"20"</span> <span class="hljs-attr">patternUnits</span>=<span class="hljs-string">"userSpaceOnUse"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">circle</span> <span class="hljs-attr">cx</span>=<span class="hljs-string">"10"</span> <span class="hljs-attr">cy</span>=<span class="hljs-string">"10"</span> <span class="hljs-attr">r</span>=<span class="hljs-string">"5"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"red"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">defs</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">rect</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"200"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"url(#pattern1)"</span>/&gt;</span>
</code></pre>
<h3 data-id="heading-75">静态 - 渲染效果</h3>
<p>SVG 提供丰富的渲染效果，主要通过滤镜系统、裁剪和遮罩实现。</p>
<p>裁剪和遮罩：</p>
<ul>
<li>
<p><strong><code>&lt;clipPath&gt;</code></strong>：裁剪路径，定义可见区域（硬边界）</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">clipPath</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"clip"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">circle</span> <span class="hljs-attr">cx</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">cy</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">r</span>=<span class="hljs-string">"40"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">clipPath</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">rect</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">clip-path</span>=<span class="hljs-string">"url(#clip)"</span>/&gt;</span>
</code></pre>
</li>
<li>
<p><strong><code>&lt;mask&gt;</code></strong>：遮罩，使用像素的亮度或 Alpha 控制可见性（软边界）</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">mask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"mask"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">rect</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"white"</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">circle</span> <span class="hljs-attr">cx</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">cy</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">r</span>=<span class="hljs-string">"40"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"black"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mask</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">rect</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">mask</span>=<span class="hljs-string">"url(#mask)"</span>/&gt;</span>
</code></pre>
</li>
</ul>
<p>滤镜系统：</p>
<p>SVG 的滤镜(Filter)是强大的图像处理系统，通过组合滤镜基元(Filter Primitive)实现复杂效果。</p>
<p>常用滤镜基元：</p>
<ul>
<li><strong><code>&lt;feGaussianBlur&gt;</code></strong>：高斯模糊，属性：stdDeviation（模糊半径）</li>
<li><strong><code>&lt;feOffset&gt;</code></strong>：偏移，属性：dx、dy（偏移距离）</li>
<li><strong><code>&lt;feBlend&gt;</code></strong>：混合，属性：mode（混合模式）</li>
<li><strong><code>&lt;feColorMatrix&gt;</code></strong>：颜色矩阵变换</li>
<li><strong><code>&lt;feComponentTransfer&gt;</code></strong>：颜色通道变换</li>
<li><strong><code>&lt;feComposite&gt;</code></strong>：图像合成，属性：operator（合成操作）</li>
<li><strong><code>&lt;feMorphology&gt;</code></strong>：形态学操作（膨胀/腐蚀）</li>
<li><strong><code>&lt;feConvolveMatrix&gt;</code></strong>：卷积矩阵</li>
<li><strong><code>&lt;feTurbulence&gt;</code></strong>：噪声生成</li>
<li><strong><code>&lt;feDropShadow&gt;</code></strong>：投影（快捷方式）</li>
</ul>
<p>滤镜组合示例（投影效果）：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"shadow"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">feGaussianBlur</span> <span class="hljs-attr">in</span>=<span class="hljs-string">"SourceAlpha"</span> <span class="hljs-attr">stdDeviation</span>=<span class="hljs-string">"3"</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">feOffset</span> <span class="hljs-attr">dx</span>=<span class="hljs-string">"2"</span> <span class="hljs-attr">dy</span>=<span class="hljs-string">"2"</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">feMerge</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">feMergeNode</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">feMergeNode</span> <span class="hljs-attr">in</span>=<span class="hljs-string">"SourceGraphic"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">feMerge</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span>
</code></pre>
<p>透明度和混合：</p>
<ul>
<li><strong>opacity</strong>：元素透明度（0-1）</li>
<li><strong>fill-opacity / stroke-opacity</strong>：填充/描边透明度</li>
</ul>
<h3 data-id="heading-76">静态 - 层级组织</h3>
<p>SVG 通过树形结构组织元素，提供分组、定义和复用机制。</p>
<p>容器元素：</p>
<ul>
<li><strong><code>&lt;svg&gt;</code></strong>：根容器，定义画布的 viewport 和 viewBox</li>
<li><strong><code>&lt;g&gt;</code></strong>：分组容器，将多个元素组合为一个单元</li>
<li><strong><code>&lt;defs&gt;</code></strong>：定义容器，包含可复用的资源（渐变、图案、裁剪路径、符号等），不直接渲染</li>
<li><strong><code>&lt;symbol&gt;</code></strong>：符号定义，可复用的图形模板，包含自己的 viewBox</li>
</ul>
<p>分组(<code>&lt;g&gt;</code>)：</p>
<p>分组将多个元素组合为一个单元，共享属性和变换：</p>
<ul>
<li><strong>变换(transform)</strong>：作用于分组内所有元素，变换累积
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">g</span> <span class="hljs-attr">transform</span>=<span class="hljs-string">"translate(50, 50) rotate(45)"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">circle</span> <span class="hljs-attr">r</span>=<span class="hljs-string">"20"</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">rect</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"40"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"40"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">g</span>&gt;</span>
</code></pre>
</li>
<li><strong>样式继承</strong>：子元素继承分组的 fill、stroke 等属性</li>
<li><strong>透明度(opacity)</strong>：分组的 opacity 作用于整体，子元素先合成再应用透明度</li>
<li><strong>裁剪和遮罩</strong>：clip-path 和 mask 作用于分组内所有元素</li>
</ul>
<p>分组可以嵌套，形成层级树。分组本身不产生渲染，只是组织和控制子元素。</p>
<p>复用机制：</p>
<ul>
<li>
<p><strong><code>&lt;defs&gt;</code> + <code>&lt;use&gt;</code></strong>：定义和引用模式</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">defs</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">circle</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dot"</span> <span class="hljs-attr">r</span>=<span class="hljs-string">"5"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"red"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">defs</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">use</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#dot"</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"10"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"10"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">use</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#dot"</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"30"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"30"</span>/&gt;</span>
</code></pre>
<p><code>&lt;use&gt;</code> 创建元素的实例，可以通过 x、y 属性偏移位置。被引用的元素可以是任何图形元素或分组。</p>
</li>
<li>
<p><strong><code>&lt;symbol&gt;</code> + <code>&lt;use&gt;</code></strong>：定义可复用的图形模板</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">defs</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">symbol</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 20 20"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">circle</span> <span class="hljs-attr">cx</span>=<span class="hljs-string">"10"</span> <span class="hljs-attr">cy</span>=<span class="hljs-string">"10"</span> <span class="hljs-attr">r</span>=<span class="hljs-string">"8"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M 10,5 L 10,15 M 5,10 L 15,10"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">symbol</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">defs</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">use</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#icon"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"50"</span>/&gt;</span>
</code></pre>
<p><code>&lt;symbol&gt;</code> 包含自己的 viewBox，通过 <code>&lt;use&gt;</code> 引用时可以指定渲染尺寸，symbol 内容自动缩放。</p>
</li>
</ul>
<p>复用的优势：同一个定义可以在多处引用，修改定义会影响所有引用。</p>
<h3 data-id="heading-77">静态 - 布局</h3>
<p>SVG 的布局基于坐标系统和变换。SVG 使用多层嵌套的坐标系统，提供灵活的空间映射能力。</p>
<p>viewport 和 viewBox：</p>
<p><strong>viewport（视口）</strong>：</p>
<p>SVG 元素的 width 和 height 属性定义 viewport，即 SVG 在页面上占据的实际尺寸（以像素或其他 CSS 单位）。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"200"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"100"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- viewport 是 200×100 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
</code></pre>
<p><strong>viewBox（用户坐标系统）</strong>：</p>
<p>viewBox 定义 SVG 内容的坐标范围，格式为 <code>min-x min-y width height</code>。viewBox 是内容的逻辑坐标系统，与 viewport 的物理尺寸独立。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"200"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 100 50"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 内容坐标范围是 0,0 到 100,50 --&gt;</span>
  <span class="hljs-comment">&lt;!-- 会自动缩放 2 倍映射到 200×100 的 viewport --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">circle</span> <span class="hljs-attr">cx</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">cy</span>=<span class="hljs-string">"25"</span> <span class="hljs-attr">r</span>=<span class="hljs-string">"20"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
</code></pre>
<p>viewBox 的作用：</p>
<ul>
<li><strong>缩放</strong>：内容自动缩放以适应 viewport</li>
<li><strong>平移</strong>：min-x 和 min-y 控制可见区域的起点</li>
<li><strong>裁剪</strong>：超出 viewBox 范围的内容不可见</li>
</ul>
<p><strong>preserveAspectRatio</strong>：</p>
<p>控制 viewBox 如何映射到 viewport，当两者宽高比不同时如何处理。</p>
<p>格式：<code>&lt;align&gt; [&lt;meetOrSlice&gt;]</code></p>
<ul>
<li><strong>align</strong>：对齐方式（xMinYMin、xMidYMid、xMaxYMax 等，或 none）</li>
<li><strong>meetOrSlice</strong>：
<ul>
<li>meet（默认）：保持宽高比，完整显示内容（类似 contain）</li>
<li>slice：保持宽高比，填满 viewport（类似 cover）</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"200"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 100 100"</span> <span class="hljs-attr">preserveAspectRatio</span>=<span class="hljs-string">"xMidYMid meet"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 内容是正方形，viewport 是矩形 --&gt;</span>
  <span class="hljs-comment">&lt;!-- 内容会缩放到 100×100 并居中 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
</code></pre>
<p>局部坐标系统：</p>
<p>每个元素可以通过 <code>transform</code> 属性定义局部坐标系统。</p>
<p><strong>transform 属性</strong>：</p>
<p>支持多种变换函数，可以组合使用：</p>
<ul>
<li><strong>translate(x, y)</strong>：平移</li>
<li><strong>rotate(angle [cx cy])</strong>：旋转，可选择旋转中心</li>
<li><strong>scale(sx [sy])</strong>：缩放</li>
<li><strong>skewX(angle) / skewY(angle)</strong>：倾斜</li>
<li><strong>matrix(a b c d e f)</strong>：矩阵变换</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">g</span> <span class="hljs-attr">transform</span>=<span class="hljs-string">"translate(50, 50) rotate(45) scale(2)"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">rect</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"20"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"20"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">g</span>&gt;</span>
</code></pre>
<p><strong>变换累积</strong>：</p>
<p>子元素继承父元素的变换，变换从根节点到叶节点累积：</p>
<pre><code class="hljs">子元素世界坐标 = 父元素变换 × 子元素相对坐标
</code></pre>
<p>嵌套的变换形成变换树，每个节点的最终位置是所有祖先变换的累积结果。</p>
<p><strong>坐标空间</strong>：</p>
<p>SVG 中存在多个坐标空间：</p>
<ul>
<li><strong>viewport space</strong>：页面上的物理空间</li>
<li><strong>user space</strong>：viewBox 定义的用户坐标空间</li>
<li><strong>local space</strong>：元素的局部坐标空间（应用 transform 后）</li>
</ul>
<p>元素的坐标从 local space 变换到 user space，再映射到 viewport space。</p>
<h3 data-id="heading-78">静态 - 合成顺序</h3>
<p>SVG 按照元素在 DOM 树中的顺序渲染（绘制顺序），后定义的元素在上层。没有 z-index 概念，层级顺序由 DOM 顺序决定。</p>
<p>渲染顺序：</p>
<ol>
<li>填充(fill)</li>
<li>描边(stroke)</li>
<li>标记(marker)</li>
<li>滤镜(filter)</li>
<li>裁剪(clip-path)</li>
<li>遮罩(mask)</li>
<li>透明度(opacity)</li>
</ol>
<p>这个顺序与 CSS 渲染顺序类似。</p>
<h3 data-id="heading-79">动态 - 动画</h3>
<p>SVG 提供三种动画机制：SMIL 动画、CSS 动画、JavaScript 动画。</p>
<p>SMIL 动画：</p>
<p>SVG 内置的声明式动画系统，通过动画元素定义。</p>
<ul>
<li>
<p><strong><code>&lt;animate&gt;</code></strong>：属性动画</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">circle</span> <span class="hljs-attr">cx</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">cy</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">r</span>=<span class="hljs-string">"20"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">animate</span> <span class="hljs-attr">attributeName</span>=<span class="hljs-string">"cx"</span> <span class="hljs-attr">from</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"200"</span> <span class="hljs-attr">dur</span>=<span class="hljs-string">"2s"</span> <span class="hljs-attr">repeatCount</span>=<span class="hljs-string">"indefinite"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">circle</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong><code>&lt;animateTransform&gt;</code></strong>：变换动画</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">rect</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"20"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"20"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">animateTransform</span> <span class="hljs-attr">attributeName</span>=<span class="hljs-string">"transform"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"rotate"</span>
                    <span class="hljs-attr">from</span>=<span class="hljs-string">"0 10 10"</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"360 10 10"</span> <span class="hljs-attr">dur</span>=<span class="hljs-string">"2s"</span> <span class="hljs-attr">repeatCount</span>=<span class="hljs-string">"indefinite"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">rect</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong><code>&lt;animateMotion&gt;</code></strong>：路径动画，元素沿路径运动</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">circle</span> <span class="hljs-attr">cx</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">cy</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">r</span>=<span class="hljs-string">"5"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">animateMotion</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"M 10,10 Q 50,50 90,10"</span> <span class="hljs-attr">dur</span>=<span class="hljs-string">"3s"</span> <span class="hljs-attr">repeatCount</span>=<span class="hljs-string">"indefinite"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">circle</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong><code>&lt;set&gt;</code></strong>：设置属性值（离散动画）</p>
</li>
</ul>
<p>SMIL 动画属性：</p>
<ul>
<li><strong>attributeName</strong>：动画的目标属性</li>
<li><strong>from/to/by</strong>：起始值/结束值/变化量</li>
<li><strong>dur</strong>：动画时长</li>
<li><strong>repeatCount</strong>：重复次数（数字/indefinite）</li>
<li><strong>fill</strong>：动画结束后的行为（freeze 保持/remove 移除）</li>
<li><strong>begin/end</strong>：动画开始/结束时间，支持事件触发（如 click）</li>
</ul>
<p>CSS 动画：</p>
<p>SVG 元素可以应用 CSS 动画和过渡，与 HTML 元素相同：</p>
<pre><code class="hljs language-css" lang="css">circle {
  <span class="hljs-attribute">transition</span>: cx <span class="hljs-number">0.3s</span> ease;
}
circle<span class="hljs-selector-pseudo">:hover</span> {
  cx: <span class="hljs-number">100</span>;
}
</code></pre>
<p>CSS 动画的限制：某些 SVG 特有属性（如路径 d）不能通过 CSS 动画，需要 SMIL 或 JavaScript。</p>
<p>JavaScript 动画：</p>
<p>通过 JavaScript 操作 SVG DOM，实现动画：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> circle = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'circle'</span>);
circle.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'cx'</span>, <span class="hljs-number">100</span>);
</code></pre>
<p>Web Animations API 也可用于 SVG 元素。</p>
<h3 data-id="heading-80">动态 - 事件</h3>
<p>SVG 元素支持 DOM 事件，与 HTML 元素相同：</p>
<p>鼠标事件：</p>
<ul>
<li><strong>click/dblclick</strong>：点击事件</li>
<li><strong>mousedown/mouseup</strong>：鼠标按下/抬起</li>
<li><strong>mousemove</strong>：鼠标移动</li>
<li><strong>mouseenter/mouseleave</strong>：鼠标进入/离开元素</li>
<li><strong>mouseover/mouseout</strong>：鼠标进入/离开元素或其子元素</li>
</ul>
<p>SVG 特有事件：</p>
<ul>
<li><strong>load</strong>：SVG 文档加载完成</li>
<li><strong>SVGZoom</strong>：缩放事件（已废弃，使用 transform 代替）</li>
</ul>
<p>事件绑定：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">circle</span> <span class="hljs-attr">cx</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">cy</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">r</span>=<span class="hljs-string">"20"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"alert('clicked')"</span>/&gt;</span>
</code></pre>
<p>或通过 JavaScript：</p>
<pre><code class="hljs language-javascript" lang="javascript">circle.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'clicked'</span>);
});
</code></pre>
<p>交互状态：</p>
<p>SVG 元素可以使用 CSS 伪类：</p>
<pre><code class="hljs language-css" lang="css">circle<span class="hljs-selector-pseudo">:hover</span> {
  fill: red;
}
circle<span class="hljs-selector-pseudo">:active</span> {
  fill: blue;
}
</code></pre>
<h3 data-id="heading-81">小结</h3>
<p>SVG 实现了完整的矢量图形渲染模型。静态渲染模型提供丰富的图形元素（基础图形、路径、文本），强大的样式系统（填充、描边、渐变、图案），以及完整的效果系统（滤镜、裁剪、遮罩）。SVG 通过树形结构组织元素，支持分组、变换和复用。动态渲染模型提供三种动画机制（SMIL、CSS、JavaScript），支持属性动画、变换动画、路径动画。SVG 元素支持完整的 DOM 事件系统。SVG 的优势是矢量图形的精确表达和无损缩放，广泛用于图标、图表、插画等场景。</p>
<h2 data-id="heading-82">Lottie 的渲染模型</h2>
<p>Lottie 是由 Airbnb 开发的动画库，解析 Adobe After Effects 导出的动画数据（JSON 格式），在多个平台上原生渲染。Lottie 的渲染模型专注于动画表达，将 After Effects 的动画能力映射到 2D 渲染抽象。本章介绍 Lottie 如何实现 2D 渲染抽象：支持哪些图形类型、渲染效果、以及动画能力。</p>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Flottie.airbnb.tech%2F%23%2Fsupported-features" target="_blank" title="https://lottie.airbnb.tech/#/supported-features" ref="nofollow noopener noreferrer">Lottie 支持特性</a> - 各平台支持的功能对比</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fairbnb%2Flottie-web%2Ftree%2Fmaster%2Fdocs%2Fjson" target="_blank" title="https://github.com/airbnb/lottie-web/tree/master/docs/json" ref="nofollow noopener noreferrer">Lottie JSON 数据结构</a> - 动画数据格式的详细定义</li>
</ul>
<h3 data-id="heading-83">静态 - 渲染单元</h3>
<p>Lottie 中的渲染单元是图层(Layer)。每个图层包含形状(Shape)、变换(Transform)、样式等属性。</p>
<p>图层类型：</p>
<ul>
<li><strong>形状图层(Shape Layer)</strong>：包含矢量形状，支持 Fill 和 Stroke</li>
<li><strong>图像图层(Image Layer)</strong>：显示位图图像</li>
<li><strong>固态图层(Solid Layer)</strong>：纯色矩形</li>
<li><strong>预合成图层(Precomp Layer)</strong>：引用另一个合成作为子图层</li>
<li><strong>空对象图层(Null Layer)</strong>：不可见，用于组织层级和控制变换</li>
<li><strong>文本图层(Text Layer)</strong>：文本内容，支持字体、样式、动画</li>
</ul>
<p>形状类型：</p>
<ul>
<li><strong>Shape</strong>：自定义路径，通过贝塞尔曲线定义</li>
<li><strong>Rectangle</strong>：矩形</li>
<li><strong>Rounded Rectangle</strong>：圆角矩形</li>
<li><strong>Ellipse</strong>：椭圆和圆形</li>
<li><strong>Polystar</strong>：多边形和星形</li>
<li><strong>Group</strong>：形状分组</li>
</ul>
<p>路径运算(Merge Paths)：</p>
<p>对多个形状路径进行布尔运算，生成新的路径几何（Android KitKat+ 和 Windows 支持）：</p>
<ul>
<li><strong>Merge</strong>：合并路径</li>
<li><strong>Add</strong>：并集</li>
<li><strong>Subtract</strong>：差集</li>
<li><strong>Intersect</strong>：交集</li>
<li><strong>Exclude Intersection</strong>：异或</li>
</ul>
<p>路径运算在生成 Geometry 阶段执行，将多个 Shape 合并为一个新的 Shape，然后应用 Fill/Stroke。</p>
<p>填充(Fill)：</p>
<ul>
<li><strong>纯色填充</strong>：RGBA 颜色</li>
<li><strong>线性渐变(Linear Gradient)</strong>：沿直线方向的渐变</li>
<li><strong>径向渐变(Radial Gradient)</strong>：从中心向外辐射的渐变</li>
<li><strong>填充规则(Fill Rule)</strong>：控制路径的填充方式（NonZero/EvenOdd）</li>
</ul>
<p>描边(Stroke)：</p>
<ul>
<li><strong>颜色</strong>：纯色或渐变</li>
<li><strong>宽度</strong>：线条粗细</li>
<li><strong>Line Cap</strong>：线条端点样式（Butt/Round/Square）</li>
<li><strong>Line Join</strong>：线条连接样式（Miter/Round/Bevel）</li>
<li><strong>Miter Limit</strong>：尖角限制</li>
<li><strong>虚线(Dashes)</strong>：虚线模式</li>
</ul>
<h3 data-id="heading-84">静态 - 渲染效果</h3>
<p>Lottie 支持部分渲染效果，主要集中在图层级别的效果。</p>
<p>裁剪(Mask)：</p>
<p>Mask 是几何裁剪，使用路径定义可见区域，本质上是 Clip。Mask 直接裁剪像素，区域外的像素完全不渲染。</p>
<ul>
<li><strong>Mask Path</strong>：裁剪路径，定义可见区域的边界</li>
<li><strong>Mask Opacity</strong>：裁剪区域的透明度（调制可见区域内的像素透明度）</li>
<li><strong>裁剪模式</strong>：
<ul>
<li>Add：叠加裁剪区域（多个 Mask 的并集）</li>
<li>Subtract：从前一个 Mask 中减去当前 Mask</li>
<li>Intersect：交集（部分平台支持）</li>
</ul>
</li>
</ul>
<p>Mask 作用于当前图层，在图层内容渲染完成后应用。多个 Mask 可以组合，通过布尔运算定义最终的裁剪区域。</p>
<p>遮罩(Matte)：</p>
<p>Matte 是基于 Alpha 通道或亮度的软遮罩。Matte 使用一个图层的像素值（Alpha 或亮度）调制另一个图层的透明度，支持平滑的透明度过渡。</p>
<ul>
<li><strong>Alpha Matte</strong>：使用 Matte 图层的 Alpha 通道控制当前图层的可见性
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">result.rgba</span> = (current.r, current.g, current.b, current.a × matte.a)
</code></pre>
</li>
<li><strong>Alpha Inverted Matte</strong>：反转的 Alpha Matte
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">result.rgba</span> = (current.r, current.g, current.b, current.a × (<span class="hljs-number">1</span> - matte.a))
</code></pre>
</li>
<li><strong>Luma Matte</strong>：使用 Matte 图层的亮度控制当前图层的可见性（部分平台支持）
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">luminance</span> = <span class="hljs-number">0.299</span> × matte.r + <span class="hljs-number">0.587</span> × matte.g + <span class="hljs-number">0.114</span> × matte.b
<span class="hljs-attr">result.rgba</span> = (current.r, current.g, current.b, current.a × luminance)
</code></pre>
</li>
</ul>
<p>Matte 的本质区别：Mask 是硬边界的几何裁剪（路径布尔运算），Matte 是软边界的透明度调制（逐像素 Alpha 计算）。Mask 定义"在哪里可见"，Matte 定义"可见多少"。</p>
<p>图层效果(Layer Effects)：</p>
<p>Web 平台支持的效果（Android/iOS 部分支持）：</p>
<ul>
<li><strong>Fill</strong>：图层级填充效果</li>
<li><strong>Stroke</strong>：图层级描边效果</li>
<li><strong>Tint</strong>：色调调整</li>
<li><strong>Tritone</strong>：三色调</li>
<li><strong>Gaussian Blur</strong>：高斯模糊</li>
<li><strong>Drop Shadow</strong>：投影</li>
</ul>
<p>形状效果：</p>
<ul>
<li><strong>Trim Path</strong>：路径修剪，通过起点、终点、偏移控制路径的可见部分</li>
<li><strong>Repeater</strong>：形状重复器，复制形状并应用变换</li>
<li><strong>Round Corners</strong>：圆角效果</li>
</ul>
<h3 data-id="heading-85">静态 - 层级组织</h3>
<p>Lottie 通过合成(Composition)组织图层。合成是图层的容器，定义了渲染的画布尺寸和帧率。</p>
<p>合成结构：</p>
<ul>
<li><strong>根合成(Root Composition)</strong>：动画的顶层合成，包含所有图层和资源</li>
<li><strong>图层列表(Layers)</strong>：合成内的图层按索引顺序排列，后添加的图层在上层</li>
<li><strong>资源(Assets)</strong>：可复用的资源，包括图像和预合成</li>
</ul>
<p>父子关系(Parenting)：</p>
<p>图层可以设置父图层，子图层继承父图层的变换。变换累积：</p>
<pre><code class="hljs">子图层世界变换 = 父图层变换 × 子图层相对变换
</code></pre>
<p>父子关系形成层级变换树，变换从根节点向叶节点累积。空对象图层(Null Layer)常用作父图层，控制一组子图层的变换。</p>
<p>预合成(Precomps)：</p>
<p>预合成是嵌套的合成，作为图层嵌入父合成。预合成的渲染过程：</p>
<ol>
<li>预合成内的所有图层按顺序渲染到离屏纹理</li>
<li>预合成作为一个整体（纹理）渲染到父合成</li>
<li>预合成图层可以应用变换、遮罩、蒙版等效果</li>
</ol>
<p>预合成支持多层嵌套，形成合成树。预合成的优势是复用和封装：同一个预合成可以在多处引用，修改预合成影响所有引用。</p>
<h3 data-id="heading-86">静态 - 合成顺序</h3>
<p>Lottie 按照图层顺序渲染，后添加的图层在上层。图层内的形状按照定义顺序渲染，形状效果（Fill、Stroke）按照添加顺序应用。</p>
<p>遮罩和蒙版在渲染图层内容后应用，裁剪最终的像素。图层效果（如模糊、阴影）作用于图层的所有内容。</p>
<h3 data-id="heading-87">动态 - 动画</h3>
<p>Lottie 的核心是关键帧动画。所有可动画的属性都通过关键帧定义，在关键帧之间插值。</p>
<p>关键帧动画：</p>
<p>Lottie 的动画数据由关键帧序列组成。每个关键帧包含：</p>
<ul>
<li><strong>时间(Time)</strong>：关键帧在时间轴上的位置（帧数）</li>
<li><strong>值(Value)</strong>：该时刻的属性值</li>
<li><strong>缓动函数(Easing)</strong>：到下一个关键帧的插值曲线</li>
</ul>
<p>可动画的属性：</p>
<p><strong>变换(Transform)</strong>：</p>
<ul>
<li><strong>Position</strong>：位置，支持分离的 X/Y 轴</li>
<li><strong>Scale</strong>：缩放</li>
<li><strong>Rotation</strong>：旋转</li>
<li><strong>Anchor Point</strong>：锚点</li>
<li><strong>Opacity</strong>：透明度</li>
<li><strong>Skew</strong>：倾斜</li>
</ul>
<p><strong>形状属性</strong>：</p>
<ul>
<li><strong>Shape Path</strong>：路径顶点位置</li>
<li><strong>Rectangle Size</strong>：矩形尺寸</li>
<li><strong>Ellipse Size</strong>：椭圆尺寸</li>
<li><strong>Polystar Points</strong>：多边形/星形的点数和半径</li>
</ul>
<p><strong>样式属性</strong>：</p>
<ul>
<li><strong>Fill Color</strong>：填充颜色</li>
<li><strong>Fill Opacity</strong>：填充透明度</li>
<li><strong>Stroke Color</strong>：描边颜色</li>
<li><strong>Stroke Width</strong>：描边宽度</li>
<li><strong>Gradient Start/End Point</strong>：渐变起点和终点</li>
</ul>
<p><strong>效果属性</strong>：</p>
<ul>
<li><strong>Trim Path Start/End/Offset</strong>：路径修剪参数</li>
<li><strong>Repeater Copies/Offset</strong>：重复器参数</li>
<li><strong>Mask Path/Opacity</strong>：遮罩路径和透明度</li>
</ul>
<p>插值类型：</p>
<ul>
<li><strong>线性插值(Linear)</strong>：匀速变化</li>
<li><strong>贝塞尔插值(Bezier)</strong>：使用贝塞尔曲线定义缓动函数</li>
<li><strong>保持插值(Hold)</strong>：阶跃变化，不插值</li>
<li><strong>空间贝塞尔插值(Spatial Bezier)</strong>：位置属性的空间路径插值</li>
<li><strong>Rove Across Time</strong>：沿路径匀速运动</li>
</ul>
<p>时间控制：</p>
<p>Lottie 支持对图层的时间轴进行控制：</p>
<ul>
<li><strong>Time Stretch</strong>：拉伸或压缩图层的时间，改变播放速度。值为 2 时，图层以 2 倍速播放；值为 0.5 时，以半速播放。</li>
<li><strong>Time Remap</strong>：重新映射图层的时间轴。Time Remap 本身可以是关键帧动画，通过控制时间轴的进度实现时间倒流、循环、暂停等效果。</li>
</ul>
<p>Time Remap 是强大的时间控制机制：可以让图层在某段时间循环播放，或在不同时刻跳转到不同的帧。</p>
<p>表达式：Web 版 Lottie 支持 After Effects 的表达式(Expressions)。表达式是 JavaScript 代码，在每帧执行，动态计算属性值。表达式可以访问其他图层的属性，实现复杂的关联动画。</p>
<p>表达式使得动画可以响应运行时状态，而不仅仅是播放预定义的关键帧。</p>
<p>文本动画：Lottie 支持文本图层的动画，包括：</p>
<p>基础文本属性：</p>
<ul>
<li><strong>字体(Fonts)</strong>：字体系列和样式</li>
<li><strong>字形(Glyphs)</strong>：字符形状</li>
<li><strong>填充和描边</strong>：文本的填充颜色和描边样式</li>
<li><strong>变换(Transform)</strong>：文本的位置、缩放、旋转</li>
<li><strong>字间距(Tracking)</strong>：字符间距</li>
</ul>
<p>高级文本动画（Web 支持）：</p>
<ul>
<li><strong>Anchor Point Grouping</strong>：锚点分组</li>
<li><strong>Text Path</strong>：文本沿路径排列</li>
<li><strong>Per-character 3D</strong>：逐字符 3D 变换</li>
<li><strong>Range Selector</strong>：范围选择器，选择文本的一部分应用动画</li>
<li><strong>Expression Selector</strong>：表达式选择器，通过表达式控制文本动画</li>
</ul>
<h3 data-id="heading-88">动画控制</h3>
<p>Lottie 提供播放控制接口：</p>
<p>播放控制：</p>
<ul>
<li><strong>play()</strong>：播放动画</li>
<li><strong>pause()</strong>：暂停动画</li>
<li><strong>stop()</strong>：停止并重置动画</li>
<li><strong>goToAndStop(value, isFrame)</strong>：跳转到指定时间或帧</li>
<li><strong>goToAndPlay(value, isFrame)</strong>：跳转并播放</li>
<li><strong>setDirection(direction)</strong>：设置播放方向（正向/反向）</li>
<li><strong>setSpeed(speed)</strong>：设置播放速度</li>
</ul>
<p>片段播放：</p>
<ul>
<li><strong>playSegments(segments, forceFlag)</strong>：播放指定片段</li>
</ul>
<p>标记(Markers)：</p>
<p>Lottie 支持 After Effects 的标记，标记可以命名时间点，用于同步和控制播放。</p>
<h3 data-id="heading-89">小结</h3>
<p>Lottie 实现了以动画为核心的 2D 渲染模型。静态渲染模型支持多种图层类型（形状、图像、文本、预合成），提供矢量形状的完整表达（路径、矩形、椭圆、多边形），支持填充、描边、遮罩、蒙版等渲染效果。动态渲染模型通过关键帧动画驱动所有属性变化，支持多种插值类型，提供灵活的播放控制和表达式能力。Lottie 将 After Effects 的动画能力映射到跨平台的原生渲染，使得设计师可以直接导出动画而无需工程师手动实现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建无障碍组件之Alert Pattern]]></title>    <link>https://juejin.cn/post/7601486204173860914</link>    <guid>https://juejin.cn/post/7601486204173860914</guid>    <pubDate>2026-02-01T14:19:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601486204173860914" data-draft-id="7601843004958146606" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建无障碍组件之Alert Pattern"/> <meta itemprop="keywords" content="前端,HTML,设计"/> <meta itemprop="datePublished" content="2026-02-01T14:19:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="anOnion"/> <meta itemprop="url" content="https://juejin.cn/user/553809592722589"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建无障碍组件之Alert Pattern
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/553809592722589/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    anOnion
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T14:19:42.000Z" title="Sun Feb 01 2026 14:19:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Alert Pattern 详解：构建无障碍通知组件</h2>
<p>Alert（警告通知）是一种无需用户干预即可展示重要信息的组件，它能够在不中断用户当前任务的前提下，吸引用户的注意力并传达关键消息。根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FWAI%2FARIA%2Fapg%2Fpatterns%2Falert%2F" target="_blank" title="https://www.w3.org/WAI/ARIA/apg/patterns/alert/" ref="nofollow noopener noreferrer">W3C WAI-ARIA Alert Pattern</a> 规范，正确实现的 Alert 组件不仅要能够及时通知用户重要信息，更要确保所有用户都能接收到这些通知，包括依赖屏幕阅读器的用户。本文将深入探讨 Alert Pattern 的核心概念、实现要点以及最佳实践。</p>
<h3 data-id="heading-1">一、Alert 的定义与核心功能</h3>
<p>Alert 是一种展示简短、重要消息的组件，它以吸引用户注意力但不中断用户任务的方式呈现信息。Alert 的核心功能是在适当的时机向用户传达关键信息，这些信息可能是操作成功提示、错误警告、或者需要用户注意的事项，但都不会影响用户当前的正常工作流程。</p>
<p>在实际应用中，Alert 组件广泛应用于各种需要即时反馈的场景。例如，表单提交成功后的确认消息、系统错误的警告提示、库存不足的提醒通知、或者需要用户确认的重要信息等。一个设计良好的 Alert 组件能够在不影响用户体验的前提下，确保关键信息能够被用户及时感知和理解。</p>
<h3 data-id="heading-2">二、Alert 的特性与注意事项</h3>
<p>Alert 组件具有几个重要的特性，这些特性决定了它的适用场景和实现方式。首先，动态渲染的 Alert 会被大多数屏幕阅读器自动朗读，这意味着当 Alert 被添加到页面时，屏幕阅读器会立即通知用户有新消息。其次，在某些操作系统中，Alert 甚至可能触发提示音，进一步确保用户能够感知到重要信息。然而，有一个重要的限制需要注意：屏幕阅读器不会朗读页面加载完成前就已存在的 Alert。</p>
<p>Alert 组件的设计还需要考虑几个关键因素。首先，Alert 不应影响键盘焦点，这是 Alert Pattern 的核心原则之一。如果需要中断用户工作流程并获取用户确认，应该使用 Alert Dialog Pattern 而不是普通的 Alert。其次，应避免设计自动消失的 Alert，因为消失过快可能导致用户无法完整阅读信息，这不符合 WCAG 2.0 的 2.2.3 成功标准。另外，Alert 的触发频率也需要谨慎控制，过于频繁的中断会影响视觉和认知障碍用户的可用性，使得满足 WCAG 2.0 的 2.2.4 成功标准变得困难。</p>
<h3 data-id="heading-3">三、WAI-ARIA 角色、状态和属性</h3>
<p>正确使用 WAI-ARIA 属性是构建无障碍 Alert 组件的技术基础。Alert 组件的核心 ARIA 要求非常简单：必须将 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fwai-aria-1.2%2F%23alert" target="_blank" title="https://www.w3.org/TR/wai-aria-1.2/#alert" ref="nofollow noopener noreferrer">role</a> 属性设置为 alert。</p>
<p>role="alert" 是 Alert 组件的必需属性，它向辅助技术表明这个元素是一个警告通知。当这个属性被正确设置时，屏幕阅读器会在 Alert 被添加到 DOM 中时自动朗读其内容。这种自动通知的机制使得 Alert 成为传达即时信息的理想选择，而无需用户执行任何特定操作来触发通知。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 基本 Alert 实现 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span>&gt;</span>您的会话将在 5 分钟后过期，请保存您的工作。<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 错误 Alert --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"error-message"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>❌<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> 提交失败：请检查表单中的必填字段。
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 成功 Alert --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"success-message"</span>
  <span class="hljs-attr">aria-live</span>=<span class="hljs-string">"polite"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>✅<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> 您的更改已成功保存。
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>值得注意的是，虽然 role="alert" 是核心属性，但开发者有时还会结合 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fwai-aria-1.2%2F%23aria-live" target="_blank" title="https://www.w3.org/TR/wai-aria-1.2/#aria-live" ref="nofollow noopener noreferrer">aria-live</a> 属性来增强通知的语义。aria-live="polite" 表示通知会以不打断用户的方式被朗读，而 aria-live="assertive" 则表示通知会立即中断当前内容被朗读。对于 Alert Pattern 来说，role="alert" 本身已经包含了隐式的 aria-live="assertive" 语义，因此通常不需要额外添加 aria-live 属性。</p>
<h3 data-id="heading-4">四、键盘交互规范</h3>
<p>Alert Pattern 的键盘交互具有特殊性。由于 Alert 是被动通知组件，不需要用户进行任何键盘交互来接收或处理通知。用户不需要通过键盘激活、聚焦或操作 Alert 元素，通知会自动被传达给用户。</p>
<p>这种设计遵循了 Alert Pattern 规范的核心原则：Alert 不应影响键盘焦点。规范明确指出，键盘交互不适用于 Alert 组件。这是因为 Alert 的设计目的是在不中断用户工作流程的前提下传达信息，如果用户需要与 Alert 进行交互（例如确认或关闭），那么应该使用 Alert Dialog Pattern。</p>
<h3 data-id="heading-5">五、完整示例</h3>
<p>以下是使用不同方式实现 Alert 组件的完整示例，展示了标准的 HTML 结构和 ARIA 属性应用：</p>
<h4 data-id="heading-6">5.1 基本 Alert 通知</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>系统将在今晚 10 点进行维护，届时服务将暂停 2 小时。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-7">5.2 错误状态 Alert</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"alert alert-error"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>❌<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>保存失败：无法连接到服务器，请检查您的网络连接。<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-8">5.3 成功状态 Alert</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"alert alert-success"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>✅<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>订单已成功提交，订单号为 #12345。<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-9">5.4 警告状态 Alert</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"alert alert-warning"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>⚠️<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>库存不足<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>您选择的商品仅剩 3 件，建议您尽快下单。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-10">5.5 动态添加 Alert 示例</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>
  <span class="hljs-attr">id</span>=<span class="hljs-string">"contact-form"</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"space-y-4"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"email"</span>&gt;</span>电子邮件<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
      <span class="hljs-attr">type</span>=<span class="hljs-string">"email"</span>
      <span class="hljs-attr">id</span>=<span class="hljs-string">"email"</span>
      <span class="hljs-attr">name</span>=<span class="hljs-string">"email"</span>
      <span class="hljs-attr">required</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
    <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary"</span>&gt;</span>
    提交
  <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"alert-success-template"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
    <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"alert alert-success"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>✅<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>表单提交成功！我们将在 24 小时内回复您。<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"alert-error-template"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
    <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"alert alert-error"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>❌<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>请输入有效的电子邮件地址。<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"form-feedback"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-variable language_">document</span>
    .<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'contact-form'</span>)
    .<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'submit'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
      e.<span class="hljs-title function_">preventDefault</span>();
      <span class="hljs-keyword">const</span> feedback = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'form-feedback'</span>);
      <span class="hljs-keyword">const</span> email = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'email'</span>).<span class="hljs-property">value</span>;

      feedback.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;

      <span class="hljs-keyword">if</span> (!email.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'@'</span>)) {
        <span class="hljs-keyword">const</span> template = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'alert-error-template'</span>);
        feedback.<span class="hljs-title function_">appendChild</span>(template.<span class="hljs-property">content</span>.<span class="hljs-title function_">cloneNode</span>(<span class="hljs-literal">true</span>));
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">const</span> template = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'alert-success-template'</span>);
        feedback.<span class="hljs-title function_">appendChild</span>(template.<span class="hljs-property">content</span>.<span class="hljs-title function_">cloneNode</span>(<span class="hljs-literal">true</span>));
      }
    });
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-11">六、<a href="https://link.juejin.cn?target=https%3A%2F%2Fan-onion.github.io%2F088.alert-pattern%2Falert" target="_blank" title="https://an-onion.github.io/088.alert-pattern/alert" ref="nofollow noopener noreferrer">最佳实践</a></h3>
<h4 data-id="heading-12">6.1 语义化结构与内容</h4>
<p>Alert 组件应该使用语义化的 HTML 结构来构建内容。Alert 中可以包含段落、列表、链接等元素，以提供更丰富的信息。然而，需要注意的是，Alert 的内容应该保持简洁明了，避免包含过多复杂信息。如果需要展示更详细的信息，可以考虑提供链接引导用户查看更多内容。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 推荐：简洁明了的 Alert --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>您的密码将在 7 天后过期。<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/settings/security"</span>&gt;</span>立即更改<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 推荐：包含多个相关信息的 Alert --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>验证失败：<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>验证码已过期，请重新获取。<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>请在 5 分钟内完成验证。<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-13">6.2 视觉样式设计</h4>
<p>Alert 组件的视觉样式应该能够清晰传达其重要性和类型。常见的做法是使用颜色编码来表示不同类型的 Alert：红色表示错误或危险，黄色或橙色表示警告，绿色表示成功，蓝色表示信息性通知。此外，Alert 应该有足够的视觉权重来吸引用户注意，但不应该过于突兀以至于干扰用户的工作流程。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* Alert 基础样式 */</span>
<span class="hljs-selector-attr">[role=<span class="hljs-string">'alert'</span>]</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">0.5rem</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: flex-start;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">0.75rem</span>;
}

<span class="hljs-comment">/* 错误状态 */</span>
<span class="hljs-selector-attr">[role=<span class="hljs-string">'alert'</span>]</span><span class="hljs-selector-class">.alert-error</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fef2f2</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid red;
  <span class="hljs-attribute">color</span>: red;
}

<span class="hljs-comment">/* 成功状态 */</span>
<span class="hljs-selector-attr">[role=<span class="hljs-string">'alert'</span>]</span><span class="hljs-selector-class">.alert-success</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f0fdf4</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid green;
  <span class="hljs-attribute">color</span>: green;
}

<span class="hljs-comment">/* 警告状态 */</span>
<span class="hljs-selector-attr">[role=<span class="hljs-string">'alert'</span>]</span><span class="hljs-selector-class">.alert-warning</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fffbeb</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid orange;
  <span class="hljs-attribute">color</span>: orange;
}

<span class="hljs-comment">/* 信息状态 */</span>
<span class="hljs-selector-attr">[role=<span class="hljs-string">'alert'</span>]</span><span class="hljs-selector-class">.alert-info</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#eff6ff</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid blue;
  <span class="hljs-attribute">color</span>: blue;
}
</code></pre>
<h4 data-id="heading-14">6.3 避免自动消失</h4>
<p>应避免设计会自动消失的 Alert 组件。如果 Alert 在用户阅读之前就消失了，会导致信息传达不完整，特别是对于阅读速度较慢的用户或者需要更多时间理解信息的用户。如果业务场景确实需要 Alert 自动消失，应该提供足够长的显示时间（通常不少于 10 秒），并且确保用户有足够的时间阅读和理解信息。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 不推荐：自动消失的 Alert --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"alert autohide"</span>&gt;</span>
  保存成功！
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 推荐：手动关闭的 Alert --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"alert"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>保存成功！<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
    <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"close-btn"</span>
    <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"关闭"</span>&gt;</span>
    ×
  <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-15">6.4 控制 Alert 频率</h4>
<p>频繁触发的 Alert 会严重干扰用户体验，特别是对于有认知障碍的用户。每次 Alert 的出现都会打断用户的工作流程，过于频繁的中断会导致用户无法集中注意力完成任务。因此，在设计系统时应该谨慎控制 Alert 的触发频率，确保只有真正重要的信息才会触发通知。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 不推荐：每次输入都触发 Alert</span>
input.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-title function_">showAlert</span>(<span class="hljs-string">'正在保存...'</span>);
});

<span class="hljs-comment">// 推荐：防抖处理，减少 Alert 频率</span>
<span class="hljs-keyword">let</span> saveTimeout;
input.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-built_in">clearTimeout</span>(saveTimeout);
  saveTimeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">showAlert</span>(<span class="hljs-string">'自动保存完成'</span>);
  }, <span class="hljs-number">1000</span>);
});
</code></pre>
<h3 data-id="heading-16">七、Alert 与 Alert Dialog 的区别</h3>
<p>理解 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FWAI%2FARIA%2Fapg%2Fpatterns%2Falert%2F" target="_blank" title="https://www.w3.org/WAI/ARIA/apg/patterns/alert/" ref="nofollow noopener noreferrer">Alert</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FWAI%2FARIA%2Fapg%2Fpractices%2Falert-dialog%2F" target="_blank" title="https://www.w3.org/WAI/ARIA/apg/practices/alert-dialog/" ref="nofollow noopener noreferrer">Alert Dialog</a> 的区别对于正确选择通知组件至关重要。虽然两者都是用于传达重要信息，但它们服务于不同的目的和使用场景。</p>
<p>Alert 是一种被动通知组件，它不需要用户进行任何交互操作。Alert 会在不被中断用户工作流程的前提下自动通知用户重要信息。用户可以继续当前的工作，Alert 只是在视觉和听觉上提供通知。这种设计适用于不紧急、不需要用户立即响应的信息，例如操作成功确认、后台处理完成通知等。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FWAI%2FARIA%2Fapg%2Fpractices%2Falert-dialog%2F" target="_blank" title="https://www.w3.org/WAI/ARIA/apg/practices/alert-dialog/" ref="nofollow noopener noreferrer">Alert Dialog</a> 则是一种需要用户主动响应的对话框组件。当用户需要做出决定或者提供确认时，应该使用 Alert Dialog。Alert Dialog 会中断用户的工作流程，获取键盘焦点，要求用户必须与之交互才能继续其他操作。这种设计适用于紧急警告、确认删除操作、放弃更改确认等需要用户明确响应的场景。</p>
<h3 data-id="heading-17">八、总结</h3>
<p>构建无障碍的 Alert 组件需要关注角色声明、视觉样式和触发时机三个层面的细节。从 ARIA 属性角度，只需将 role 属性设置为 alert 即可满足基本要求。从视觉设计角度，应该使用明确的颜色编码和足够的视觉权重来传达不同类型的通知。从用户体验角度，应该避免自动消失的 Alert，并控制 Alert 的触发频率以避免过度干扰。</p>
<p>WAI-ARIA <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FWAI%2FARIA%2Fapg%2Fpatterns%2Falert%2F" target="_blank" title="https://www.w3.org/WAI/ARIA/apg/patterns/alert/" ref="nofollow noopener noreferrer">Alert Pattern</a> 为我们提供了清晰的指导方针，遵循这些规范能够帮助我们创建更加包容和易用的 Web 应用。每一个正确实现的 Alert 组件，都是提升用户体验和确保信息有效传达的重要一步。</p>
<p>文章同步于 an-Onion 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fan-Onion%2Fan-Onion.github.io" target="_blank" title="https://github.com/an-Onion/an-Onion.github.io" ref="nofollow noopener noreferrer">Github</a>。码字不易，欢迎点赞。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue-Vue2中的Mixin 混入机制]]></title>    <link>https://juejin.cn/post/7601715462921191434</link>    <guid>https://juejin.cn/post/7601715462921191434</guid>    <pubDate>2026-02-01T14:23:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601715462921191434" data-draft-id="7601441797118165043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue-Vue2中的Mixin 混入机制"/> <meta itemprop="keywords" content="前端,面试,Vue.js"/> <meta itemprop="datePublished" content="2026-02-01T14:23:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue-Vue2中的Mixin 混入机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T14:23:02.000Z" title="Sun Feb 01 2026 14:23:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在开发中，当多个组件拥有相同的逻辑（如分页、导出、权限校验）时，重复编写代码显然不够优雅。Vue 2 提供的 <code>Mixin</code>（混入）正是为了解决逻辑复用而生。本文将从基础用法出发，带你彻底理清 Mixin 的执行机制及其优缺点。</p>
<h2 data-id="heading-1">一、 什么是 Mixin？</h2>
<p><code>Mixin</code> 是一种灵活的分发 Vue 组件中可复用功能的方式。它本质上是一个 JS 对象，它将组件的可复用逻辑或者数据提取出来，哪个组件需要用到时，直接将提取的这部分混入到组件内部就行。类似于react和vue3中hooks。</p>
<hr/>
<h2 data-id="heading-2">二、 Mixin 的实战用法</h2>
<h3 data-id="heading-3">1. 定义混入文件</h3>
<p>我们通常新建一个文件（如 <code>useUser.ts</code>），文件中包含data、methods、created等属性（和vue文件中script部分一致）,导出这个逻辑对象。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/mixins/index.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> myMixin = {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">msg</span>: <span class="hljs-string">"我是来自 Mixin 的数据"</span>,
    };
  },
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"执行：Mixin 中的 created 生命周期"</span>);
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"执行：Mixin 中的 mounted 生命周期"</span>);
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">clickMe</span>(): <span class="hljs-built_in">void</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"执行：Mixin 中的点击事件"</span>);
    },
  },
};
</code></pre>
<h3 data-id="heading-4">2. 组件内引入（局部混入）</h3>
<p>在 Vue 2 的选项式语法中通过 <code>mixins</code> 属性引入。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { defineComponent } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { myMixin } <span class="hljs-keyword">from</span> <span class="hljs-string">"./mixin/index"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineComponent</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"App"</span>,
  <span class="hljs-attr">mixins</span>: [myMixin], <span class="hljs-comment">// 注入混入逻辑</span>
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 此时可以正常访问 mixin 中的 msg</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"组件访问 Mixin 数据:"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">msg</span>);
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"执行：组件自身的 mounted 生命周期"</span>);
  }
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<hr/>
<h2 data-id="heading-5">三、 Mixin 的关键特性与优先级</h2>
<p>在使用 Mixin 时，必须清楚其底层合并策略：</p>
<ol>
<li>
<p><strong>独立性</strong>：在多个组件中引入同一个 Mixin，各组件间的数据是<strong>不共享</strong>的。一个组件改动了 Mixin 里的数据，不会影响到其他组件。</p>
</li>
<li>
<p><strong>生命周期合并</strong>：</p>
<ul>
<li>Mixin 的钩子会与组件自身的钩子合并。</li>
<li><strong>执行顺序</strong>：Mixin 的钩子总是<strong>先于</strong>组件钩子执行。</li>
</ul>
</li>
<li>
<p><strong>冲突处理</strong>：</p>
<ul>
<li>如果 Mixin 与组件定义了同名的 <code>data</code> 属性或 <code>methods</code> 方法，<strong>组件自身的内容会覆盖 Mixin 的内容</strong>。</li>
</ul>
</li>
<li>
<p><strong>全局混入</strong>：</p>
<ul>
<li>在 <code>main.js</code> 中通过 <code>Vue.mixin()</code> 引入。这会影响之后创建的所有 Vue 实例（不推荐，容易污染全局环境）。</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-6">四、 进阶思考：Mixin 的局限性</h2>
<p>虽然 Mixin 解决了复用问题，但在大型项目中存在明显的弊端，这也是为什么 Vue 3 转向了 <strong>Composition API (Hooks)</strong> ：</p>
<ul>
<li><strong>命名冲突</strong>：多个 Mixin 混入时，容易发生变量名冲突，且难以追溯。</li>
<li><strong>来源不明</strong>：在模板中使用一个变量，很难一眼看出它是来自哪个 Mixin，增加了维护成本。</li>
<li><strong>隐式依赖</strong>：Mixin 之间无法方便地相互传参或共享状态。</li>
</ul>
<hr/>
<h2 data-id="heading-7">五、 Vue 3 的更优选：组合式函数 (Hooks)</h2>
<p>如果你正在使用 Vue 3，建议使用更现代的语法来复用逻辑：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/composables/useCount.ts</span>
<span class="hljs-keyword">import</span> { ref, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useCount</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> count = ref&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> msg = ref&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">"我是 Vue 3 Hook 数据"</span>)

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; count.<span class="hljs-property">value</span>++

  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hook 中的 mounted"</span>)
  })

  <span class="hljs-keyword">return</span> { count, msg, increment }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Porffor：用 JavaScript 写的 JavaScript AOT 编译器]]></title>    <link>https://juejin.cn/post/7601441797118197811</link>    <guid>https://juejin.cn/post/7601441797118197811</guid>    <pubDate>2026-02-01T14:23:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601441797118197811" data-draft-id="7601444617695363082" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Porffor：用 JavaScript 写的 JavaScript AOT 编译器"/> <meta itemprop="keywords" content="JavaScript,编译器"/> <meta itemprop="datePublished" content="2026-02-01T14:23:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jump_jump"/> <meta itemprop="url" content="https://juejin.cn/user/4230576474692765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Porffor：用 JavaScript 写的 JavaScript AOT 编译器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4230576474692765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jump_jump
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T14:23:15.000Z" title="Sun Feb 01 2026 14:23:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Porffor：用 JavaScript 写的 JavaScript AOT 编译器</p>
<blockquote>
<p>发音：/ˈpɔrfɔr/（威尔士语中"紫色"的意思）</p>
</blockquote>
<p>如果你写过 JavaScript，你可能习惯了它的动态类型、即时编译（JIT）和无处不在的运行时。但有没有想过，如果把 JavaScript 提前编译成机器码会发生什么？</p>
<p>这就是 <strong>Porffor</strong> 想要回答的问题。</p>
<hr/>
<h2 data-id="heading-0">什么是 Porffor？</h2>
<p>Porffor 是一个实验性的 <strong>AOT（Ahead-of-Time）JavaScript/TypeScript 编译器</strong>，由开发者 Oliver Medhurst 从零构建。它能将 JS/TS 代码编译为 WebAssembly 和原生二进制文件。</p>
<p>听起来不太特别？让我们看看它的核心特点：</p>
<ul>
<li><strong>100% AOT 编译</strong> - 没有 JIT，编译一次，到处运行</li>
<li><strong>极简运行时</strong> - 无常量运行时或预置代码，最小化 Wasm imports</li>
<li><strong>自身编写</strong> - 用 JavaScript 写 JavaScript 引擎，避免内存安全漏洞</li>
<li><strong>原生支持 TypeScript</strong> - 无需额外构建步骤</li>
</ul>
<p>目前项目仍处于 <strong>pre-alpha</strong> 阶段，但已经通过了 61% 的 Test262 测试（ECMAScript 官方兼容性测试套件）。</p>
<hr/>
<h2 data-id="heading-1">它是如何工作的？</h2>
<p>传统 JavaScript 引擎使用解释器或多层 JIT 编译器。代码在运行时被解析、编译和优化。这意味着：</p>
<ol>
<li>冷启动慢（需要预热）</li>
<li>运行时占用内存大（JIT 代码缓存）</li>
<li>需要完整的运行时环境</li>
</ol>
<p>Porffor 采用了不同的方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">JavaScript</span>/<span class="hljs-title class_">TypeScript</span>
        │
        ▼
   <span class="hljs-title class_">WebAssembly</span> / C 代码
        │
        ▼
   原生二进制文件
</code></pre>
<p>这种 AOT 方式让你在开发时编译，在生产环境直接运行已编译的代码——无需预热，最小开销。</p>
<h3 data-id="heading-2">三个自研子引擎</h3>
<p>为了实现这个目标，Porffor 包含三个自研的子引擎：</p>





















<table><thead><tr><th>子引擎</th><th>作用</th></tr></thead><tbody><tr><td><strong>Asur</strong></td><td>自研 Wasm 引擎，简单的解释器实现</td></tr><tr><td><strong>Rhemyn</strong></td><td>自研正则表达式引擎，将正则编译为 Wasm 字节码</td></tr><tr><td><strong>2c</strong></td><td>Wasm → C 转译器，用于生成原生二进制</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-3">快速开始</h2>
<h3 data-id="heading-4">安装</h3>
<pre><code class="hljs language-bash" lang="bash">npm install -g porffor@latest
</code></pre>
<h3 data-id="heading-5">基本用法</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 交互式 REPL</span>
porf

<span class="hljs-comment"># 直接运行 JS 文件</span>
porf script.js

<span class="hljs-comment"># 编译为 WebAssembly</span>
porf wasm script.js out.wasm

<span class="hljs-comment"># 编译为原生二进制</span>
porf native script.js out

<span class="hljs-comment"># 编译为 C 代码</span>
porf c script.js out.c
</code></pre>
<h3 data-id="heading-6">编译选项</h3>
<pre><code class="hljs language-bash" lang="bash">--parser=acorn|@babel/parser|meriyah|hermes-parser|oxc-parser   <span class="hljs-comment"># 选择解析器</span>
--parse-types                                                   <span class="hljs-comment"># 解析 TypeScript</span>
--opt-types                                                     <span class="hljs-comment"># 使用类型注解优化</span>
--valtype=i32|i64|f64                                         <span class="hljs-comment"># 值类型（默认：f64）</span>
-O0, -O1, -O2                                                 <span class="hljs-comment"># 优化级别</span>
</code></pre>
<hr/>
<h2 data-id="heading-7">谁需要 Porffor？</h2>
<h3 data-id="heading-8">编译为 WebAssembly</h3>
<p>Porffor 的 Wasm 输出比现有 JS→Wasm 项目小 <strong>10-30 倍</strong>，性能也快 <strong>10-30 倍</strong>（相比打包解释器的方案）。</p>
<p>这意味着：</p>
<ul>
<li><strong>安全的服务端 JS 托管</strong> - Wasm 沙箱化执行，无需额外隔离</li>
<li><strong>边缘计算运行时</strong> - 快速冷启动，低内存占用</li>
<li><strong>代码保护</strong> - 编译后的代码比混淆更难逆向</li>
</ul>
<h3 data-id="heading-9">编译为原生二进制</h3>
<p>Porffor 生成的二进制文件比传统方案小 <strong>1000 倍</strong>（从 ~90MB 到 &lt;100KB）。</p>
<p>这使得以下场景成为可能：</p>
<ul>
<li><strong>嵌入式系统</strong> - 在资源受限设备上运行 JS</li>
<li><strong>游戏机开发</strong> - 任何支持 C 的地方都可以用 JS</li>
<li><strong>微型 CLI 工具</strong> - 用 JS 写 &lt;1MB 的可执行文件</li>
</ul>
<h3 data-id="heading-10">安全特性</h3>
<ul>
<li>用 JavaScript（内存安全语言）编写引擎本身</li>
<li>不支持 <code>eval</code>，防止动态代码执行</li>
<li>Wasm 沙箱化环境</li>
</ul>
<hr/>
<h2 data-id="heading-11">当然，它也有局限性</h2>
<p>作为实验性项目，Porffor 目前还有一些限制：</p>

























<table><thead><tr><th>限制</th><th>说明</th></tr></thead><tbody><tr><td>异步支持有限</td><td><code>Promise</code> 和 <code>await</code> 支持有限</td></tr><tr><td>作用域限制</td><td>不支持跨作用域变量（除参数和全局变量）</td></tr><tr><td>无动态执行</td><td>不支持 <code>eval()</code>、<code>Function()</code> 等（AOT 特性）</td></tr><tr><td>JS 特性支持不完整</td><td>Test262 通过率约 61%</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-12">与其他 JS 引擎对比</h2>
<h3 data-id="heading-13">架构差异</h3>





























<table><thead><tr><th>引擎</th><th>类型</th><th>编译策略</th><th>输出</th></tr></thead><tbody><tr><td><strong>Porffor</strong></td><td>AOT</td><td>JS → Wasm/Native</td><td>Wasm/二进制</td></tr><tr><td><strong>V8</strong></td><td>JIT</td><td>解释器 + 多层 JIT</td><td>机器码</td></tr><tr><td><strong>QuickJS</strong></td><td>字节码</td><td>JS → 字节码</td><td>字节码</td></tr></tbody></table>
<h3 data-id="heading-14">性能对比</h3>



































<table><thead><tr><th>场景</th><th>Porffor</th><th>JIT 引擎</th><th>字节码引擎</th></tr></thead><tbody><tr><td><strong>冷启动</strong></td><td>最快</td><td>慢（需预热）</td><td>中等</td></tr><tr><td><strong>峰值性能</strong></td><td>中等</td><td>最快</td><td>慢</td></tr><tr><td><strong>内存占用</strong></td><td>低</td><td>高</td><td>中等</td></tr><tr><td><strong>二进制大小</strong></td><td>极小</td><td>N/A</td><td>小</td></tr></tbody></table>
<h3 data-id="heading-15">什么时候选择什么？</h3>
<pre><code class="hljs">Porffor 最适合：
├── 需要极小二进制体积的场景
├── 需要快速冷启动的场景（如 Serverless）
├── 需要安全沙箱执行的场景
└── 嵌入式/游戏机等非传统 JS 平台

V8/SpiderMonkey 最适合：
├── 通用 Web 应用
├── Node.js 服务端应用
└── 需要完整 JS 特性支持的场景

QuickJS/JerryScript 最适合：
├── 嵌入式设备
├── 资源受限环境
└── 不需要极致性能的场景
</code></pre>
<hr/>
<h2 data-id="heading-16">动手试试</h2>
<p>让我们写一个素数计算器来看看 Porffor 的实际效果：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 检查一个数是否为素数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isPrime</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">if</span> (n &lt; <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (n === <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  <span class="hljs-keyword">if</span> (n % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

  <span class="hljs-keyword">const</span> sqrtN = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(n);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">3</span>; i &lt;= sqrtN; i += <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">if</span> (n % i === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
}

<span class="hljs-comment">// 查找指定范围内的所有素数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">findPrimes</span>(<span class="hljs-params">start, end</span>) {
  <span class="hljs-keyword">const</span> primes = [];
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = start; i &lt;= end; i++) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isPrime</span>(i)) {
      primes[count] = i;
      count++;
    }
  }

  primes.<span class="hljs-property">length</span> = count;
  <span class="hljs-keyword">return</span> primes;
}

<span class="hljs-comment">// 主程序</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">START_NUM</span> = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">END_NUM</span> = <span class="hljs-number">100</span>;

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'=== Porffor Prime Calculator ==='</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Range:'</span>, <span class="hljs-variable constant_">START_NUM</span>, <span class="hljs-string">'to'</span>, <span class="hljs-variable constant_">END_NUM</span>);

  <span class="hljs-keyword">const</span> primes = <span class="hljs-title function_">findPrimes</span>(<span class="hljs-variable constant_">START_NUM</span>, <span class="hljs-variable constant_">END_NUM</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Found'</span>, primes.<span class="hljs-property">length</span>, <span class="hljs-string">'primes'</span>);

  <span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; primes.<span class="hljs-property">length</span>; i++) {
    sum += primes[i];
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Sum:'</span>, sum);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Average:'</span>, sum / primes.<span class="hljs-property">length</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-string">'Done!'</span>;
}

<span class="hljs-title function_">main</span>();
</code></pre>
<h3 data-id="heading-17">直接运行</h3>
<pre><code class="hljs language-bash" lang="bash">porf prime.js
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">=== Porffor Prime Calculator ===
<span class="hljs-symbol">Range:</span> <span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-number">100</span>
Found <span class="hljs-number">25</span> primes
<span class="hljs-symbol">Sum:</span> <span class="hljs-number">1060</span>
<span class="hljs-symbol">Average:</span> <span class="hljs-number">42.4</span>
Done!
</code></pre>
<h3 data-id="heading-18">编译为 WebAssembly</h3>
<pre><code class="hljs language-bash" lang="bash">porf wasm prime.js prime.wasm
</code></pre>
<p>编译输出：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">parsed:</span> <span class="hljs-string">5ms</span>
<span class="hljs-attr">generated wasm:</span> <span class="hljs-string">40ms</span>
<span class="hljs-attr">optimized:</span> <span class="hljs-string">7ms</span>
<span class="hljs-attr">assembled:</span> <span class="hljs-string">5ms</span>
[<span class="hljs-string">108ms</span>] <span class="hljs-string">compiled</span> <span class="hljs-string">prime.js</span> <span class="hljs-string">-&gt;</span> <span class="hljs-string">prime.wasm</span> <span class="hljs-string">(36.5KB)</span>
</code></pre>
<h3 data-id="heading-19">编译为原生二进制</h3>
<pre><code class="hljs language-bash" lang="bash">porf native prime.js prime
</code></pre>
<p>编译输出：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">parsed:</span> <span class="hljs-string">5ms</span>
<span class="hljs-attr">generated wasm:</span> <span class="hljs-string">38ms</span>
<span class="hljs-attr">optimized:</span> <span class="hljs-string">7ms</span>
<span class="hljs-attr">assembled:</span> <span class="hljs-string">4ms</span>
<span class="hljs-attr">compiled Wasm to C:</span> <span class="hljs-string">18ms</span>
<span class="hljs-attr">compiled C to native:</span> <span class="hljs-string">959ms</span>
[<span class="hljs-string">1080ms</span>] <span class="hljs-string">compiled</span> <span class="hljs-string">prime.js</span> <span class="hljs-string">-&gt;</span> <span class="hljs-string">prime</span> <span class="hljs-string">(106.6KB)</span>
</code></pre>
<h3 data-id="heading-20">输出格式对比</h3>



































<table><thead><tr><th>格式</th><th>文件大小</th><th>编译时间</th><th>运行方式</th></tr></thead><tbody><tr><td>源 JS</td><td>2.4KB</td><td>-</td><td><code>porf file.js</code></td></tr><tr><td>Wasm</td><td>36KB</td><td>~100ms</td><td>需 Wasm 运行时</td></tr><tr><td>C 代码</td><td>356KB</td><td>~130ms</td><td>需 C 编译</td></tr><tr><td>Native</td><td>106KB</td><td>~1100ms</td><td>独立运行</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-21">生成的 C 代码是什么样的？</h2>
<p>你可能会好奇，Porffor 生成的 C 代码长什么样？让我们对比一下手写版本和自动生成的版本。</p>
<h3 data-id="heading-22">手写 C 版本（96 行，2.3KB）</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;math.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span>

<span class="hljs-type">bool</span> <span class="hljs-title function_">isPrime</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> {
    <span class="hljs-keyword">if</span> (n &lt; <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (n == <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span> (n % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-type">int</span> sqrtN = (<span class="hljs-type">int</span>)<span class="hljs-built_in">sqrt</span>(n);
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">3</span>; i &lt;= sqrtN; i += <span class="hljs-number">2</span>) {
        <span class="hljs-keyword">if</span> (n % i == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-type">int</span> primes[<span class="hljs-number">100</span>];
    <span class="hljs-type">int</span> primeCount = findPrimes(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>, primes);

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Found %d primes:\n"</span>, primeCount);
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; primeCount; i++) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d%s"</span>, primes[i], i &lt; primeCount - <span class="hljs-number">1</span> ? <span class="hljs-string">", "</span> : <span class="hljs-string">"\n"</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-23">Porffor 生成的版本（12,880 行，353KB）</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// generated by porffor 0.61.2</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;math.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>

<span class="hljs-comment">// Wasm 类型定义</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-type">uint8_t</span> u8;
<span class="hljs-keyword">typedef</span> <span class="hljs-type">int32_t</span> i32;
<span class="hljs-keyword">typedef</span> <span class="hljs-type">double</span> f64;

<span class="hljs-comment">// JS 值结构体（数字或对象）</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ReturnValue</span> {</span>
  f64 value;
  i32 type;  <span class="hljs-comment">// 类型标签</span>
};

<span class="hljs-comment">// Wasm 线性内存模拟</span>
<span class="hljs-type">char</span>* _memory;
u32 _memoryPages = <span class="hljs-number">5</span>;

<span class="hljs-comment">// Wasm 指令模拟函数</span>
i32 <span class="hljs-title function_">i32_load</span><span class="hljs-params">(i32 align, i32 offset, i32 pointer)</span>;
<span class="hljs-type">void</span> <span class="hljs-title function_">f64_store</span><span class="hljs-params">(i32 align, i32 offset, i32 pointer, f64 value)</span>;

<span class="hljs-comment">// JS 内置函数实现</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ReturnValue</span> __<span class="hljs-title">ecma262_ToString</span>(...);</span>
f64 __Math_sqrt(f64 l0);
<span class="hljs-type">void</span> __Porffor_printString(...);
<span class="hljs-comment">// ... 数百个内置函数</span>

<span class="hljs-comment">// 用户函数（从 JS 转换）</span>
<span class="hljs-keyword">struct</span> ReturnValue <span class="hljs-title function_">isPrime</span><span class="hljs-params">(...)</span>;
<span class="hljs-keyword">struct</span> ReturnValue <span class="hljs-title function_">findPrimes</span><span class="hljs-params">(...)</span>;

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    _memory = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">65536</span> * _memoryPages);
    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ReturnValue</span> _0 =</span> _main(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-24">对比数据</h3>



































<table><thead><tr><th>指标</th><th>手写 C</th><th>Porffor 生成</th><th>差异</th></tr></thead><tbody><tr><td>源代码行数</td><td>96 行</td><td>12,880 行</td><td><strong>134x</strong></td></tr><tr><td>源文件大小</td><td>2.3KB</td><td>353KB</td><td><strong>153x</strong></td></tr><tr><td>二进制大小</td><td>33KB</td><td>104KB</td><td><strong>3.15x</strong></td></tr><tr><td>编译时间</td><td>~10ms</td><td>~1080ms</td><td><strong>108x</strong></td></tr></tbody></table>
<h3 data-id="heading-25">为什么 Porffor 生成的代码这么大？</h3>





























<table><thead><tr><th>原因</th><th>说明</th></tr></thead><tbody><tr><td><strong>Wasm 模拟层</strong></td><td>需要模拟所有 Wasm 指令（load/store 等）</td></tr><tr><td><strong>JS 类型系统</strong></td><td>JS 值可以是数字、字符串、对象，需要统一的 <code>ReturnValue</code> 结构</td></tr><tr><td><strong>内置函数库</strong></td><td>实现 <code>Math.*</code>、<code>console.log</code>、<code>Array.*</code> 等数百个函数</td></tr><tr><td><strong>内存管理</strong></td><td>Wasm 线性内存 + JS 对象内存的双重管理</td></tr><tr><td><strong>字符串处理</strong></td><td>JS 字符串是 UTF-16，需要复杂的转换逻辑</td></tr></tbody></table>
<p>这是 JavaScript 的灵活性带来的代价——Porffor 需要模拟整个 JS 运行时。</p>
<hr/>
<h2 data-id="heading-26">实际应用建议</h2>





























<table><thead><tr><th>场景</th><th>推荐方案</th></tr></thead><tbody><tr><td>追求极致性能</td><td>手写 C / Rust</td></tr><tr><td>快速原型开发</td><td>Porffor（直接写 JS）</td></tr><tr><td>已有 JS 代码移植</td><td>Porffor（无需重写）</td></tr><tr><td>需要跨平台</td><td>Porffor（一次编译，多平台运行）</td></tr><tr><td>学习/研究</td><td>Porffor（了解 JS→Wasm→C 的转换过程）</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-27">版本号的秘密</h2>
<p>Porffor 使用独特的版本号格式：<code>0.61.2</code></p>
<ul>
<li><strong>0</strong> - Major 版本，始终为 0（项目未成熟）</li>
<li><strong>61</strong> - Minor 版本，<strong>Test262 通过率百分比</strong>（向下取整）</li>
<li><strong>2</strong> - Micro 版本，该 Minor 下的构建号</li>
</ul>
<p>版本号直接告诉你这个项目对 ECMAScript 标准的支持程度！</p>
<hr/>
<h2 data-id="heading-28">WebAssembly 提案支持</h2>
<p>Porffor 只使用广泛实现的 Wasm 提案，确保最大兼容性：</p>



































<table><thead><tr><th>提案</th><th>状态</th><th>说明</th></tr></thead><tbody><tr><td>Multi-value</td><td>必需</td><td>多返回值</td></tr><tr><td>Non-trapping float-to-int</td><td>必需</td><td>安全的浮点转整数</td></tr><tr><td>Bulk memory operations</td><td>可选</td><td>批量内存操作</td></tr><tr><td>Exception handling</td><td>可选</td><td>异常处理</td></tr><tr><td>Tail calls</td><td>可选（默认关闭）</td><td>尾调用优化</td></tr></tbody></table>
<p>值得注意的是，Porffor 有意避免使用尚未广泛实现的提案（如 GC 提案）。</p>
<hr/>
<h2 data-id="heading-29">项目状态与资源</h2>
<h3 data-id="heading-30">当前状态</h3>
<ul>
<li><strong>开发阶段</strong>: Pre-alpha</li>
<li><strong>最新版本</strong>: 0.61.2（2025-11-26 发布）</li>
<li><strong>Test262 通过率</strong>: ~61%</li>
<li><strong>建议用途</strong>: 研究、实验，不建议生产使用</li>
</ul>
<h3 data-id="heading-31">官方资源</h3>
<ul>
<li><strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fporffor.dev%2F" target="_blank" title="https://porffor.dev/" ref="nofollow noopener noreferrer">porffor.dev/</a></li>
<li><strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCanadaHonk%2Fporffor" target="_blank" title="https://github.com/CanadaHonk/porffor" ref="nofollow noopener noreferrer">github.com/CanadaHonk/…</a></li>
<li><strong>作者</strong>: Oliver Medhurst (@CanadaHonk)</li>
</ul>
<h3 data-id="heading-32">学习资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.devtools.fm%2Fepisode%2F157" target="_blank" title="https://www.devtools.fm/episode/157" ref="nofollow noopener noreferrer">DevTools.fm Episode #157</a> - 播客访谈</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Flondonwebstandards.org%2Ftalks%2Fcompiling-javaScript-ahead-of-time%2F" target="_blank" title="https://londonwebstandards.org/talks/compiling-javaScript-ahead-of-time/" ref="nofollow noopener noreferrer">London Web Standards 演讲</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnews.ycombinator.com%2Fitem%3Fid%3D41112854" target="_blank" title="https://news.ycombinator.com/item?id=41112854" ref="nofollow noopener noreferrer">Hacker News 讨论</a></li>
</ul>
<hr/>
<h2 data-id="heading-33">为什么叫 Porffor？</h2>
<p>"Purple"（紫色）的威尔士语就是 "porffor"。</p>
<p>选择紫色的原因很简单：</p>
<ul>
<li>没有其他 JS 引擎使用紫色作为主题色</li>
<li>紫色代表"雄心"（ambition），恰如其分地描述了这个项目</li>
</ul>
<hr/>
<h2 data-id="heading-34">总结</h2>
<p>Porffor 是一个极具实验性的项目。它通过独特的架构设计，尝试解决传统 JS 引擎在以下方面的问题：</p>
<ol>
<li><strong>冷启动性能</strong> - AOT 编译无需预热</li>
<li><strong>输出体积</strong> - 极小的 Wasm 和原生二进制</li>
<li><strong>安全性</strong> - 沙箱化执行 + 内存安全语言编写</li>
<li><strong>新平台</strong> - 将 JavaScript 带到嵌入式和游戏机等新领域</li>
</ol>
<p>虽然目前仍处于早期阶段，JS 特性支持不完整，但其创新的架构为 JavaScript 的未来应用提供了新的可能性。</p>
<p>也许某一天，你真的可以用 JavaScript 写一个只有 100KB 的 CLI 工具，然后编译到任何平台上运行。那将会是怎样的体验？</p>
<hr/>
<blockquote>
<p>"Purple is pretty cool. And it apparently represents 'ambition', which is one word to describe this project." — Oliver Medhurst</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[试试看 94.4k 的 OpenCode 到底火在哪里]]></title>    <link>https://juejin.cn/post/7601384029610967055</link>    <guid>https://juejin.cn/post/7601384029610967055</guid>    <pubDate>2026-02-01T14:22:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601384029610967055" data-draft-id="7601313474719793187" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="试试看 94.4k 的 OpenCode 到底火在哪里"/> <meta itemprop="keywords" content="AIGC,人工智能"/> <meta itemprop="datePublished" content="2026-02-01T14:22:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三金得鑫"/> <meta itemprop="url" content="https://juejin.cn/user/4406498335130216"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            试试看 94.4k 的 OpenCode 到底火在哪里
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498335130216/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三金得鑫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T14:22:36.000Z" title="Sun Feb 01 2026 14:22:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>没错，OpenCode 现在已经 94.4k 了，刚出来的时候，铺天盖地都是它的资讯，标题更是一个比一个吸人眼球，主打一个秒天秒地秒空气，拳打 Claude Code，脚踢 Codex。</p>
<blockquote>
<p>Github 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanomalyco%2Fopencode" target="_blank" title="https://github.com/anomalyco/opencode" ref="nofollow noopener noreferrer">github.com/anomalyco/o…</a></p>
</blockquote>
<p>那为什么 OpenCode 这么牛呢？到底是哪些亮点让众多开发者如此追捧？</p>
<p>今天来跟三金一起探索一下。</p>
<h3 data-id="heading-0">安装</h3>
<p>OpenCode 是一款跨端产品，支持在 MacOS、Linux 和 Windows 上使用，且同时支持 Claude、GPT 以及 Gemini 等 75+ 的 AI 大模型。</p>
<p>在安装方式上，它也支持两种形式安装，分别是：</p>
<ul>
<li>命令行安装</li>
<li>客户端软件</li>
</ul>
<p>另外，它还贴心地提供了编辑器插件，接下来让我们一个一个来进行演示。</p>
<h5 data-id="heading-1">首先是命令行安装</h5>
<p>最简单的方式就是通过以下命令来进行一键安装：</p>
<pre><code class="hljs language-bash" lang="bash">curl -fsSL https://opencode.ai/install | bash
</code></pre>
<p>也可以使用其他包管理工具：</p>
<pre><code class="hljs language-bash" lang="bash">npm i -g opencode-ai@latest <span class="hljs-comment"># or bun/pnpm/yarn</span>
scoop install opencode <span class="hljs-comment"># Windows</span>
choco install opencode <span class="hljs-comment"># Windows</span>
brew install anomalyco/tap/opencode <span class="hljs-comment"># macOS and Linux (recommended, always up to date)</span>
brew install opencode <span class="hljs-comment"># macOS and Linux (official brew formula, updated less)</span>
paru -S opencode-bin <span class="hljs-comment"># Arch Linux</span>
mise use -g opencode <span class="hljs-comment"># Any OS</span>
nix run nixpkgs<span class="hljs-comment">#opencode # or github:anomalyco/opencode for latest dev branch</span>
</code></pre>
<p>使用 <code>opencode -v</code> 来测试是否安装成功。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e96108fc42d450baacabf5720e1477d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=7DVHKes97g1eNNsZIHE%2FM7FsO5U%3D" alt="" loading="lazy"/></p>
<p>输出版本之后，就表示我们已经安装成功了。</p>
<h5 data-id="heading-2">其次是客户端</h5>
<p>桌面客户端现在还处于 BETA 期，我们可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fopencode.ai%2Fdownload" target="_blank" title="https://opencode.ai/download" ref="nofollow noopener noreferrer">opencode.ai/download</a> 页面进行下载：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62a7409b54284bbab2ef5418402141cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=xm82fyqebvdNtJG4RfxtFHsB3IU%3D" alt="" loading="lazy"/></p>
<p>下载打开以后的页面如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b880f95e37274a6683e8871b5a9b6828~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=0aGUEh3SwXgcKNCM4hw3aTgc8Rw%3D" alt="" loading="lazy"/></p>
<p>打开一个项目之后发现，它的界面其实类似于 VSCode 编辑器，区别在于它很“轻”，没有 VSCode 那么多功能：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58dde1a6f6de481fa17dbe9373529fc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=bDKvUVDojRpX3g4SaNtt1fLMksI%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-3">编辑器插件</h5>
<blockquote>
<p>前提：要使用 opencode 插件，必须先安装 opencode CLI。</p>
</blockquote>
<p>打开 VSCode 插件市场，并搜索 opencode，选下载数最多的那个：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4505d5b8f720463a9a821d95d358ff30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=pbKBj6KEw%2BaG7ulRl0blbVpQ64c%3D" alt="" loading="lazy"/></p>
<p>下载好之后，右上角会展示一个 opencode 的图标，点击该图标就可以打开 opencode 的对话框了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35434e01bb0d429a8017ca489d090306~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=ZcKmHi%2FLlRRBFS0E2tYKGDXoHCw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">配置</h3>
<p>在正式使用 OpenCode 之前，我们还需要了解一下它的配置都有哪些，比如：</p>
<ul>
<li>如何接入第三方 API；</li>
<li>如何配置 MCP、Agent、Plugin；</li>
<li>以及其他高阶配置。</li>
</ul>
<p>首先，OpenCode 的配置和其他 CLI 工具一样，也分全局和项目级。另外它还支持自定义配置文件路径和目录。</p>
<p>配置文件的优先级从高到低依次是：自定义配置-&gt;项目级配置-&gt;全局配置。</p>
<ul>
<li><code>OPENCODE_CONFIG</code>：自定义配置文件路径，优先级最高。</li>
<li><code>OPENCODE_CONFIG_DIR</code>：自定义配置目录。</li>
<li><code>&lt;your_project&gt;/opencode.json</code>：项目级配置，优先级高。</li>
<li><code>~/.config/opencode/opencode.json</code>：全局配置，优先级低。</li>
</ul>
<p>其次，是比较常用的几个配置项介绍，比如：</p>
<ul>
<li>模型配置：用来设置主模型和小模型。</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"$schema"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://opencode.ai/config.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"minimax/minimax-m2.1"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 主模型</span>
  <span class="hljs-attr">"small_model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zhipu/glm-6"</span> <span class="hljs-comment">// 小模型</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>Provider 配置（接入中转 API）：比如接入 iflow 的 API Key（iflow：你礼貌吗？)。</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"$schema"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://opencode.ai/config.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"iflow"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"npm"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@ai-sdk/openai-compatible"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"iflow"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"baseURL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://apis.iflow.cn/v1"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"apiKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sk-xxxx"</span> <span class="hljs-comment">// 填入自己的 key</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"glm-4.6"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"glm-4.6"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>自动更新：默认会在启动时自动下载更新，我们也可以使用 <code>autoupdate</code> 配置进行关闭。</li>
<li>TUI 配置：可以用来设置窗口滚动速度和差异样式，三金刚开始用 opencode 的时候发现，在 opencode 内滚动非常灵敏，还专门查了下这个配置，非常有用！</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tui"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"scroll_speed"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 滚动速度倍数</span>
    <span class="hljs-attr">"scroll_acceleration"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-comment">// 启动 macOS 风格加速滚动</span>
      <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"diff_style"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"auto"</span> <span class="hljs-comment">// 差异显示样式</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>还有一些其他配置，大家感兴趣可以查阅官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopencode.ai%2Fdocs" target="_blank" title="https://opencode.ai/docs" ref="nofollow noopener noreferrer">opencode.ai/docs</a></p>
<h3 data-id="heading-5">使用</h3>
<h5 data-id="heading-6"><strong>OpenCode 启动！</strong></h5>
<p>我们进入到一个项目中，并启动 opencod：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e51576a875d492084aa1b7f1415dd01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=DYci8juJTnI%2FU%2FwbXDTYopEnpi4%3D" alt="" loading="lazy"/></p>
<p>在 OpenCode 中，支持 75+ 的 LLM 提供商，也支持本地模型，有时还会提供一些免费模型。在三金写这篇文章的时间，OpenCode 提供了以下几个免费模型：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfa917700db34f32bdf2b2bd16fe6276~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=gFosaG5p6Y6pClFg6cNrbvi74Ag%3D" alt="" loading="lazy"/></p>
<p>当然，我们也可以配置其他的 AI 模型，之前买了智谱的季卡，让我们一起通过 <code>/connect</code> 来配置一下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2d3c8b54a784973b39ca07ad1053cb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=nHcEOSOanm12U4%2BeWY3YAvE8cKk%3D" alt="" loading="lazy"/></p>
<p>直接搜索 <code>zhipu</code> 然后选择对应的选项回车：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a471cb24c83439b8ab65bc819a5d98e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=etYuas%2FyieOSsO%2FelC3yREFzgnc%3D" alt="" loading="lazy"/></p>
<p>填入你的 API key，在 submit 之后再选择一个你要使用的模型就 OK 了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/600c54582040449980cac164a0c771d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=eIDQe9jNhv9AhXUl5VRePvY99j0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e92f826cf9174e3c872e0424704e33ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=VwjqmoBRqj7oQ8wDATPz7r0KXCQ%3D" alt="" loading="lazy"/></p>
<p>配置好之后，左下角就会展示目前正在使用的模型：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c85bbe64eaf74f61b55ba4e64b83cf2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=SUhsQtfg57Kr5fz8C4%2B9Wwck69A%3D" alt="" loading="lazy"/></p>
<p>如果要接入一些第三方中转站的模型，可以按照「配置」章节中的例子进行配置。保存然后重启 opencode 即可。</p>
<blockquote>
<p>❓反重力为啥用不了了？ 已找到根本原因：自 1 月 15 日起，随机的/虚假的 projectId 已不再有效；没有 Antigravity 访问权限的账户必须调用新的 Google API 来创建或获取真实项目（与 Antigravity 驾驶舱测试相同），并且访问令牌必须刷新，否则复制的账户将被跳过，Opencode 将回退到本地登录的账户。</p>
</blockquote>
<h5 data-id="heading-7">初始化项目</h5>
<p>这里说的初始化，并不是我们初始化项目代码，而是通过 opencode 内置的 <code>/init</code> 命令来初始化这个项目的规则文件。</p>
<p>其实像 Claude Code、Codex 等 CLI 工具中都具备这个能力，但 opencode 还做到了：兼容 Claude Code 的规则文件，也就是说它还会去读 <code>CLAUDE.md</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ee252c1cf1244eabb42c1a88017f81d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=zA8hDAQdt326HWCIJIJhIb%2Bk5R4%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-8">内置 Agent</h5>
<p>OpenCode <strong>内置了两个 Primary Agent：Plan 和 Build</strong>。</p>
<p>Primary Agent 也就是主 Agent，可以和用户直接进行对话交互，想<strong>要切换 Agent 时只需要按下 <strong><strong><code>tab</code></strong></strong> 键即可</strong>。</p>
<p>让我们大概了解一下 Plan Agent 和 Build Agent：</p>
<ul>
<li><strong>Build Agent</strong>：OpenCode 的默认 Agent，它有点像 iflow 中的 YOLO 模式，权限比较高。</li>
<li><strong>Plan Agent</strong>：顾名思义，计划模式。它适合进行分析和规划，像在进行修改文件以及执行一些 bash 命令时，会和用户进行确认。</li>
</ul>
<p>给大家简单地演示一下：</p>
<ul>
<li>我有一个 demo 项目，需要 AI 给我一个 TypeScript 重构方案</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42a54d75c74f4c9098e81da6a8af38d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=nuTElfe3l%2FQ7ZCaKx4jzIS7ocvw%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Plan 模式下，AI 会跟我来回沟通，确认重构方案。比如使用 ESM 还是使用 CommonJS？是升级依赖还是保持原有依赖版本。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a98982aabaed4d79b600902fe2c43610~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=siioS2k%2FIwuJZoxEX46eL%2FV7xB4%3D" alt="" loading="lazy"/></p>
<ul>
<li>切换到 Build 模式之后，告诉 AI 开始执行重构</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2f13c7f0bfd43fca8aa7aedb7a8b291~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=m%2FmNl6W3wSrUIuBDIv9245OSEgA%3D" alt="" loading="lazy"/></p>
<p>接下来让我们 check 一下重构后的项目是否可用，以及代码质量如何。</p>
<ul>
<li>在项目根目录下运行 <code>dist/bin/aicr.js --version</code> 来查看工具版本</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">dist/bin/aicr.js --version

1.0.0
</code></pre>
<ul>
<li>再看看代码实现，整体来说还 OK。不过可能是受原来代码的影响，在代码架构上还不是很合理（后面借助其他工具进行强化）。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2e381d1a7a3407b8fc14f12968453a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=dRnwXiZuapDzG1abp%2F%2FAmGs4Aog%3D" alt="" loading="lazy"/></p>
<ul>
<li>是否能进行 AI CR</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d0930eb2ea94c2ab5e44a295680cb4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=WKoacWZWm9hLXYFby4%2Fh5eeHMeY%3D" alt="" loading="lazy"/></p>
<p>效果是可以的！</p>
<p>那有主 Agent，也肯定有 SubAgent，OpenCode 内置了**两个 SubAgent，可以通过 **<strong><code>@</code></strong> <strong>来唤起</strong>：</p>
<ul>
<li><strong>Explore Agent</strong>：算是一个本地代码仓库 RAG，可以快速进行文件、代码段的搜索以及回答代码库问题。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb584784e78a4205b3b78be597b9cacb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=POA9tEuaEcalykM16jg3kmfLUu4%3D" alt="" loading="lazy"/></p>
<p>通过点击<strong>上图中 <strong><strong><code>Explore Task</code></strong></strong> 进入 SubAgent 子会话</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d611c57ec7974e8697bcf08bee717844~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=UU54c3mcHKXIR8LO2EeR3teGwok%3D" alt="" loading="lazy"/></p>
<p>再通过点击上方的 <code>ctrl+x up</code> 回到主会话。需要注意的是，这个子会话的能力三金在 opencode 客户端并没找到，不知道是能力没对齐还是啥，我先提个 issue 先。</p>
<ul>
<li><strong>General SubAgent</strong>：擅长复杂任务和多步骤任务。比如我想要继续优化迭代这个工具，给它一个方向，让它来进行任务分解</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8880cc01c1ae4ac78c4021a6c213792e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770560677&amp;x-signature=sYIRSbAoxEfCS7Ykb%2Byl60N55GY%3D" alt="" loading="lazy"/></p>
<p>基本上到这里我们就可以使用 OpenCode 来进行编码了，因为其强大的兼容能力，我们几乎可以使用任意一种 AI 模型来进行日常开发，不用在多个 CLI 工具之间切来切去，也不用头疼这些工具的配置。我认为这是它最大的亮点。</p>
<p>此外，配合 <code>oh-my-opencode</code>，更让其如虎添翼！但由于篇幅原因，后面再跟大家分享。</p>
<h3 data-id="heading-9">火在哪里？</h3>
<p>三金以为有以下几点：</p>
<ul>
<li>完全开源：OpenCode 不似 Claude Code 那样，它是完全开源的；</li>
<li>基于开源这一点，OpenCode 的生态非常活跃，这也意味着它的迭代更新非常迅速，以后能提供更多强大便捷的功能；</li>
<li>针对不同人群支持不同形态，既有 CLI，又有编辑器插件，又有客户端；</li>
<li>如前面的章节所言，OpenCode 最大的亮点就是不锁定厂商，支持 75+ 的模型供应商，且支持本地模型，还时不时提供一波免费模型。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 Frontend Test Agent: 重新定义前端自动化测试]]></title>    <link>https://juejin.cn/post/7601175299011985423</link>    <guid>https://juejin.cn/post/7601175299011985423</guid>    <pubDate>2026-02-01T14:25:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601175299011985423" data-draft-id="7601384029610950671" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 Frontend Test Agent: 重新定义前端自动化测试"/> <meta itemprop="keywords" content="前端,LLM,测试"/> <meta itemprop="datePublished" content="2026-02-01T14:25:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="宫秋"/> <meta itemprop="url" content="https://juejin.cn/user/4283353030199528"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 Frontend Test Agent: 重新定义前端自动化测试
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4283353030199528/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    宫秋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T14:25:05.000Z" title="Sun Feb 01 2026 14:25:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86a40be8f995455db9c8f7f0899ae46e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6r56eL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770561451&amp;x-signature=eA8y5LMjPNJdoQRTonUSBFJSbsM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">🔥 引言：那些被测试折磨过的日日夜夜</h2>
<p>作为一名前端开发者，你是否也曾有过这样的经历？</p>
<p>深夜加班，功能代码早已完成，却还在为编写测试用例苦熬；上线前焦虑地检查测试覆盖率，担心遗漏了什么边界情况；测试失败时，对着满屏幕的错误信息抓耳挠腮，半天找不到问题根源...</p>
<p>这些痛点，我们都懂。</p>
<p>今天，我想分享一个工具——<strong>Frontend Test Agent</strong>。它不是冷冰冰的代码工具，而是送给所有前端开发者的一份礼物，希望能让测试从折磨变成享受，从负担变成助力。</p>
<p><strong>项目门户</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontend-test-agent.vercel.app%2F" target="_blank" title="https://frontend-test-agent.vercel.app/" ref="nofollow noopener noreferrer">frontend-test-agent.vercel.app/</a><br/>
<strong>开源地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzifenggao%2Ffrontend-test-agent" target="_blank" title="https://github.com/zifenggao/frontend-test-agent" ref="nofollow noopener noreferrer">github.com/zifenggao/f…</a></p>
<h2 data-id="heading-1">🎯 技术挑战：每个前端团队都曾遇到的困境</h2>
<h3 data-id="heading-2">1. 💥 那些写测试的夜晚：效率低下的痛</h3>
<ul>
<li><strong>你可能经历过</strong>：为了一个组件，花上半小时甚至一小时编写测试用例</li>
<li><strong>背后的代价</strong>：测试编写占据了开发时间的20-30%，常常是功能开发完了，测试还没写完</li>
<li><strong>无奈的妥协</strong>：很多团队只能忍痛减少测试，结果就是线上bug频发，用户投诉不断</li>
</ul>
<h3 data-id="heading-3">2. 🚨 看不见的风险：测试覆盖率的困扰</h3>
<ul>
<li><strong>人的局限</strong>：靠人工判断哪些场景需要测试，总是会有遗漏</li>
<li><strong>隐藏的陷阱</strong>：边界情况、错误场景往往是最容易被忽略的</li>
<li><strong>真实的后果</strong>：测试覆盖率通常只有60-70%，很多潜在问题在上线后才暴露</li>
</ul>
<h3 data-id="heading-4">3. 🔍 测试失败时的无助：定位问题的煎熬</h3>
<ul>
<li><strong>熟悉的场景</strong>：测试失败了，翻来覆去看错误信息，一两个小时就这么过去了</li>
<li><strong>经验的门槛</strong>：只有资深开发者才能快速定位问题，新手往往束手无策</li>
<li><strong>延误的进度</strong>：修复测试问题的时间，本可以用来开发新功能</li>
</ul>
<h2 data-id="heading-5">🚀 Frontend Test Agent: 用技术温暖每一位开发者</h2>
<h3 data-id="heading-6">🤖 技术核心：AI与AST的完美结合</h3>
<p>我们相信，好的技术应该是有温度的。Frontend Test Agent的核心创新，就是将<strong>大语言模型AI</strong>的智能理解能力与**抽象语法树(AST)**的精准分析能力结合起来，让测试自动化变得既智能又可靠。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A["你的前端代码&lt;br/&gt;.tsx/.jsx/.vue"] --&gt; B["AST语法分析器&lt;br/&gt;理解你的组件"]
    B --&gt; C["AI测试生成器&lt;br/&gt;为你定制测试"]
    C --&gt; D["测试结果文件&lt;br/&gt;test-results"]
    D --&gt; E["智能分析助手&lt;br/&gt;帮你找问题根因&lt;br/&gt;给你修复建议"]
    E --&gt; F["测试执行引擎&lt;br/&gt;Jest/Cypress/&lt;br/&gt;Playwright"]
    F --&gt; G["可视化报告&lt;br/&gt;一目了然的结果&lt;br/&gt;让你更省心"]
    F --&gt; A
    E --&gt; B
</code></pre>
<h3 data-id="heading-7">🔧 技术亮点：为开发者着想的五大设计</h3>
<h4 data-id="heading-8">1. 🎯 智能测试用例生成：懂你的代码，更懂你的需求</h4>
<ul>
<li><strong>AI驱动</strong>：基于OpenAI GPT-4o-mini模型，就像一位经验丰富的测试工程师</li>
<li><strong>深度理解</strong>：通过AST分析，真正理解你的组件结构和业务逻辑</li>
<li><strong>场景全覆盖</strong>：自动为你考虑正常流程、边界情况、错误场景</li>
<li><strong>多框架支持</strong>：无论是React、Vue还是Angular，都能完美适配</li>
</ul>
<h4 data-id="heading-9">2. ⚡ 并行化测试执行：让等待成为过去</h4>
<ul>
<li><strong>多框架兼容</strong>：统一支持Jest、Cypress、Playwright，你用什么我们就支持什么</li>
<li><strong>智能调度</strong>：根据你的电脑性能和测试类型，自动分配任务</li>
<li><strong>增量测试</strong>：只运行你修改过的代码相关的测试，节省你的时间</li>
<li><strong>环境隔离</strong>：自动处理依赖和配置，你不用再为环境问题头疼</li>
</ul>
<h4 data-id="heading-10">3. 🔍 机器学习驱动的结果分析：你的测试诊断专家</h4>
<ul>
<li><strong>自动根因分析</strong>：测试失败了？我们帮你找出真正的原因</li>
<li><strong>智能修复建议</strong>：不仅告诉你问题在哪，还告诉你怎么修</li>
<li><strong>性能瓶颈检测</strong>：发现慢测试，提醒你优化，让测试跑得更快</li>
<li><strong>质量趋势分析</strong>：跟踪你的代码质量变化，提前预警潜在问题</li>
</ul>
<h4 data-id="heading-11">4. 🔌 无缝集成现有工作流：融入你的开发习惯</h4>
<ul>
<li><strong>构建工具兼容</strong>：不管你用Vite、Webpack还是Rollup，都能轻松集成</li>
<li><strong>CI/CD集成</strong>：在GitHub Actions、GitLab CI、Jenkins中自动运行，不用手动操作</li>
<li><strong>代码托管平台集成</strong>：PR自动生成测试报告，让代码审查更有依据</li>
</ul>
<h4 data-id="heading-12">5. 🧩 VS Code插件：就在你身边的测试助手</h4>
<ul>
<li><strong>编辑器内集成</strong>：右键点击就能生成测试，不用切换窗口</li>
<li><strong>实时测试反馈</strong>：在编辑器里直接看到测试结果，边写边测</li>
<li><strong>测试浏览器</strong>：树形视图管理所有测试用例，一目了然</li>
<li><strong>自动生成</strong>：保存文件时自动更新测试，让测试与代码同步</li>
<li><strong>快捷键支持</strong>：Ctrl+Shift+G生成测试，Ctrl+Shift+R运行测试，顺手又省心</li>
<li><strong>交互式覆盖率</strong>：彩色编码显示代码覆盖率，哪里没测到一眼就知道</li>
</ul>
<h4 data-id="heading-13">5. 📊 可视化测试中心：让数据说话，更让你放心</h4>
<ul>
<li><strong>实时监控</strong>：测试执行进度可视化，不再对着黑屏干等</li>
<li><strong>多维分析</strong>：从覆盖率、性能、稳定性等多个角度看你的代码质量</li>
<li><strong>交互式报告</strong>：生成漂亮的HTML报告，分享给团队也很有面子</li>
<li><strong>告警系统</strong>：关键指标异常时及时提醒你，防患于未然</li>
</ul>
<h2 data-id="heading-14">📈 提效价值：我们用数据证明，更用体验说话</h2>
<h3 data-id="heading-15">🔢 量化对比：传统测试 vs Frontend Test Agent</h3>















































<table><thead><tr><th>指标</th><th>传统手动测试</th><th>Frontend Test Agent</th><th>提升幅度</th></tr></thead><tbody><tr><td>测试用例编写时间</td><td>10小时/100组件</td><td>1小时/100组件</td><td><strong>90% 减少</strong></td></tr><tr><td>平均测试覆盖率</td><td>65%</td><td>95%</td><td><strong>46% 提升</strong></td></tr><tr><td>测试执行效率</td><td>30分钟/轮</td><td>5分钟/轮</td><td><strong>83% 提升</strong></td></tr><tr><td>问题定位时间</td><td>15分钟/问题</td><td>1分钟/问题</td><td><strong>93% 减少</strong></td></tr><tr><td>回归测试完整性</td><td>70%</td><td>99%</td><td><strong>41% 提升</strong></td></tr><tr><td>团队测试投入占比</td><td>30%</td><td>5%</td><td><strong>83% 减少</strong></td></tr></tbody></table>
<h3 data-id="heading-16">💡 真实故事：一家互联网公司的测试革命</h3>
<blockquote>
<p><strong>背景</strong>：这是我们合作的一家客户，100多位前端工程师，每周要发布20多个版本，测试一直是他们的噩梦
<strong>使用前</strong>：</p>
<ul>
<li>每个迭代要花2000多小时写测试，工程师们叫苦不迭</li>
<li>线上bug率高达0.8%，用户投诉让产品团队压力山大</li>
<li>测试覆盖率平均只有72%，上线前总是提心吊胆</li>
</ul>
<p><strong>使用后</strong>：</p>
<ul>
<li>测试编写时间减少到200小时/迭代，工程师们终于有时间陪家人了</li>
<li>线上bug率降到0.1%，用户满意度显著提升</li>
<li>测试覆盖率达到96%，上线变得从容自信</li>
<li>整体开发效率提升25%，业务迭代速度明显加快</li>
</ul>
</blockquote>
<h2 data-id="heading-17">🔧 技术实现细节：我们是如何做到的</h2>
<h3 data-id="heading-18">🧠 AI测试生成的技术内幕</h3>
<h4 data-id="heading-19">1. AST语法树分析流程</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 简化的AST分析流程</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">analyzeComponent</span>(<span class="hljs-params">fileContent: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// 1. 解析代码生成AST</span>
  <span class="hljs-keyword">const</span> ast = parser.<span class="hljs-title function_">parse</span>(fileContent, {
    <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
    <span class="hljs-attr">plugins</span>: [<span class="hljs-string">'jsx'</span>, <span class="hljs-string">'typescript'</span>]
  });

  <span class="hljs-comment">// 2. 遍历AST提取组件信息</span>
  <span class="hljs-keyword">const</span> componentInfo = {
    <span class="hljs-attr">props</span>: [],
    <span class="hljs-attr">state</span>: [],
    <span class="hljs-attr">methods</span>: []
  };

  <span class="hljs-title function_">traverse</span>(ast, {
    <span class="hljs-comment">// 提取props</span>
    <span class="hljs-title class_">ObjectPattern</span>(path) {
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isReactComponent</span>(path)) {
        path.<span class="hljs-property">properties</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">prop</span> =&gt;</span> {
          componentInfo.<span class="hljs-property">props</span>.<span class="hljs-title function_">push</span>({
            <span class="hljs-attr">name</span>: prop.<span class="hljs-property">key</span>.<span class="hljs-property">name</span>,
            <span class="hljs-attr">type</span>: <span class="hljs-title function_">extractType</span>(prop),
            <span class="hljs-attr">required</span>: !prop.<span class="hljs-property">value</span>
          });
        });
      }
    },
    <span class="hljs-comment">// 提取state变量</span>
    <span class="hljs-title class_">CallExpression</span>(path) {
      <span class="hljs-keyword">if</span> (path.<span class="hljs-property">node</span>.<span class="hljs-property">callee</span>.<span class="hljs-property">name</span> === <span class="hljs-string">'useState'</span>) {
        componentInfo.<span class="hljs-property">state</span>.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">name</span>: path.<span class="hljs-property">parent</span>.<span class="hljs-property">id</span>.<span class="hljs-property">name</span>,
          <span class="hljs-attr">initialValue</span>: path.<span class="hljs-property">node</span>.<span class="hljs-property">arguments</span>[<span class="hljs-number">0</span>].<span class="hljs-property">value</span>
        });
      }
    },
    <span class="hljs-comment">// 提取方法</span>
    <span class="hljs-title class_">ArrowFunctionExpression</span>(path) {
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isComponentMethod</span>(path)) {
        componentInfo.<span class="hljs-property">methods</span>.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">name</span>: path.<span class="hljs-property">parent</span>.<span class="hljs-property">id</span>.<span class="hljs-property">name</span>,
          <span class="hljs-attr">parameters</span>: <span class="hljs-title function_">extractParameters</span>(path),
          <span class="hljs-attr">functionality</span>: <span class="hljs-title function_">analyzeFunctionality</span>(path)
        });
      }
    }
  });

  <span class="hljs-keyword">return</span> componentInfo;
}
</code></pre>
<h4 data-id="heading-20">2. AI测试用例生成的Prompt设计</h4>
<p>我们花了无数个日夜，打磨出这套Prompt系统，就像为AI配备了一本《前端测试工程师手册》：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> promptTemplate = <span class="hljs-string">`
你是一位经验丰富、充满耐心的前端测试工程师，
请为以下React组件生成高质量的单元测试：

组件名称：{componentName}
组件类型：{componentType}

Props：
{propsList}

State变量：
{stateList}

方法：
{methodsList}

依赖库：
{dependencies}

请记住：
1. 生成完整的Jest测试代码，确保可以直接运行
2. 覆盖所有props的正常和异常情况，就像你在实际使用中会遇到的
3. 测试所有方法的功能正确性，验证边界情况
4. 每个测试用例都加上清晰的注释，说明测试的目的
5. 估计测试覆盖率，帮助开发者了解测试的完整性
`</span>;
</code></pre>
<h3 data-id="heading-21">⚡ 测试执行引擎的创新设计</h3>
<h4 data-id="heading-22">1. 动态测试调度算法</h4>
<p>我们希望测试能像流水一样顺畅，所以设计了这套智能调度算法，让每一个测试都能在最合适的时间、最合适的资源上运行：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">scheduleTests</span>(<span class="hljs-params">tests: Test[], resources: Resource[]</span>) {
  <span class="hljs-comment">// 1. 分类测试用例</span>
  <span class="hljs-keyword">const</span> unitTests = tests.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">type</span> === <span class="hljs-string">'unit'</span>);
  <span class="hljs-keyword">const</span> e2eTests = tests.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">type</span> === <span class="hljs-string">'e2e'</span>);
  <span class="hljs-keyword">const</span> integrationTests = tests.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">type</span> === <span class="hljs-string">'integration'</span>);

  <span class="hljs-comment">// 2. 基于历史数据预测执行时间</span>
  <span class="hljs-keyword">const</span> estimatedTimes = tests.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">test</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      ...test,
      <span class="hljs-attr">estimatedTime</span>: <span class="hljs-title function_">predictExecutionTime</span>(test, historyData)
    };
  });

  <span class="hljs-comment">// 3. 使用贪心算法分配任务到不同进程</span>
  <span class="hljs-keyword">const</span> tasks = [];
  <span class="hljs-keyword">const</span> workers = resources.<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">timeUsed</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">tests</span>: [] }));

  estimatedTimes.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b.<span class="hljs-property">estimatedTime</span> - a.<span class="hljs-property">estimatedTime</span>);

  estimatedTimes.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">test</span> =&gt;</span> {
    <span class="hljs-comment">// 找到当前最空闲的worker</span>
    <span class="hljs-keyword">const</span> worker = workers.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">min, current</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> current.<span class="hljs-property">timeUsed</span> &lt; min.<span class="hljs-property">timeUsed</span> ? current : min;
    });

    worker.<span class="hljs-property">timeUsed</span> += test.<span class="hljs-property">estimatedTime</span>;
    worker.<span class="hljs-property">tests</span>.<span class="hljs-title function_">push</span>(test);
  });

  <span class="hljs-keyword">return</span> workers;
}
</code></pre>
<h2 data-id="heading-23">🌟 未来规划：与开发者一起成长</h2>
<p>我们的愿景，是让Frontend Test Agent成为每一位前端开发者的贴心伙伴。未来，我们会不断努力：</p>
<h3 data-id="heading-24">🚀 短期规划（接下来3个月）</h3>
<ul>
<li>推出功能更强大的VS Code插件，在你写代码时就给出测试建议</li>
<li>支持更多前端框架，包括Svelte、Solid.js等新兴框架</li>
<li>增强性能测试功能，帮助你打造更快的应用</li>
</ul>
<h3 data-id="heading-25">🎯 中期规划（6-12个月）</h3>
<ul>
<li>引入自我学习系统，逐渐适应你的团队代码风格，生成更符合你习惯的测试</li>
<li>实现测试用例自动维护，当你修改代码时，测试也会自动更新</li>
<li>提供企业级版本，支持私有部署和更多高级功能</li>
</ul>
<h3 data-id="heading-26">🔮 长期愿景（1-3年）</h3>
<ul>
<li>实现完全自动化的端到端测试，从UI到API一站式覆盖</li>
<li>基于AI的测试策略优化，根据你的项目特点自动调整测试方案</li>
<li>与开发全流程深度融合，成为DevOps中不可或缺的一部分</li>
</ul>
<h2 data-id="heading-27">🤝 加入我们：一起让前端测试更温暖</h2>
<p>Frontend Test Agent是一个完全开源的项目，就像它的名字一样，我们希望它能成为前端开发者的贴心助手。</p>
<h3 data-id="heading-28">📦 快速开始</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 全局安装</span>
npm install -g frontend-test-agent

<span class="hljs-comment"># 生成测试</span>
test-agent generate src/components --framework react

<span class="hljs-comment"># 运行测试</span>
test-agent run __tests__ --runner jest

<span class="hljs-comment"># 分析结果</span>
test-agent analyze test-results.json
</code></pre>
<h3 data-id="heading-29">🌱 贡献指南</h3>
<ul>
<li><strong>GitHub仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzifenggao%2Ffrontend-test-agent" target="_blank" title="https://github.com/zifenggao/frontend-test-agent" ref="nofollow noopener noreferrer">github.com/zifenggao/f…</a></li>
<li><strong>Issue提交</strong>：无论你发现了bug，还是有新功能建议，都欢迎告诉我们</li>
<li><strong>PR提交</strong>：你的每一行代码贡献，都在让这个工具变得更好</li>
<li><strong>社区讨论</strong>：加入我们的Discord社区，和其他开发者分享使用心得</li>
</ul>
<h2 data-id="heading-30">🙏 致谢：每一份支持都是温暖的力量</h2>
<p>感谢所有为Frontend Test Agent做出贡献的开发者和用户！这个项目的每一步成长，都离不开大家的支持和反馈。</p>
<p>特别感谢以下开源项目的支持，它们就像我们的伙伴一样：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2F" target="_blank" title="https://openai.com/" ref="nofollow noopener noreferrer">OpenAI</a> - 提供了强大的AI模型，让智能测试成为可能</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fbabeljs.io%2F" target="_blank" title="https://babeljs.io/" ref="nofollow noopener noreferrer">Babel</a> - AST解析支持，帮助我们更好地理解代码</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjestjs.io%2F" target="_blank" title="https://jestjs.io/" ref="nofollow noopener noreferrer">Jest</a> - 优秀的测试框架，是我们的基础</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cypress.io%2F" target="_blank" title="https://www.cypress.io/" ref="nofollow noopener noreferrer">Cypress</a> - E2E测试的得力助手</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fplaywright.dev%2F" target="_blank" title="https://playwright.dev/" ref="nofollow noopener noreferrer">Playwright</a> - 跨浏览器测试的可靠伙伴</li>
</ul>
<h2 data-id="heading-31">📞 联系方式：随时可以找到我们</h2>
<ul>
<li><strong>GitHub Issues</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzifenggao%2Ffrontend-test-agent%2Fissues" target="_blank" title="https://github.com/zifenggao/frontend-test-agent/issues" ref="nofollow noopener noreferrer">提交问题</a></li>
<li><strong>Discord 社区</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.gg%2Fxxx" target="_blank" title="https://discord.gg/xxx" ref="nofollow noopener noreferrer">加入讨论</a></li>
<li><strong>Twitter</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Ftwitter.com%2Fyourusername" target="_blank" title="https://twitter.com/yourusername" ref="nofollow noopener noreferrer">@yourusername</a></li>
<li><strong>电子邮件</strong>: <a href="https://link.juejin.cn?target=mailto%3Ayour.email%40example.com" target="_blank" title="mailto:your.email@example.com" ref="nofollow noopener noreferrer">your.email@example.com</a></li>
</ul>
<h2 data-id="heading-32">🔥 结语：测试，也可以是一种享受</h2>
<p>Frontend Test Agent对我们来说，不仅仅是一个工具，更是一种理念——让技术服务于人，让开发变得更快乐。</p>
<p>我们相信，当测试不再是负担，当开发者能够将更多精力放在创造价值上，前端开发的未来会更加美好。</p>
<p>所以，无论你是测试新手还是资深专家，无论你在大公司还是小团队，我们都邀请你加入我们的旅程。</p>
<p>让我们一起，重新定义前端测试，让它成为开发过程中最温暖的部分。🚀</p>
<hr/>
<p><strong>如果你觉得这个项目有帮助，如果你希望测试变得更简单，请给我们一个 ⭐ 支持。你的每一份鼓励，都是我们前进的动力！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Room必备插件---kapt]]></title>    <link>https://juejin.cn/post/7601715462921256970</link>    <guid>https://juejin.cn/post/7601715462921256970</guid>    <pubDate>2026-02-01T14:32:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601715462921256970" data-draft-id="7601715462921240586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Room必备插件---kapt "/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-02-01T14:32:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="城堡修炼者"/> <meta itemprop="url" content="https://juejin.cn/user/2379804202775341"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Room必备插件---kapt 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2379804202775341/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    城堡修炼者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-01T14:32:45.000Z" title="Sun Feb 01 2026 14:32:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在AndroidManifest，用了room之后，我们可以看到这个：</p>
<pre><code class="hljs language-xml" lang="xml">plugins {
    id("kotlin-kapt")
}
</code></pre>
<p>在这篇文章我就来详细介绍一下这个插件。写在最前面，目前google已经推出了ksp，可以取代kapt，这个也更好更快，大家可以重构的时候用这个，在这我只专门介绍kapt</p>
<h2 data-id="heading-0">前置知识</h2>
<ul>
<li><strong>注解 (Annotation)：</strong> 只是代码里的“标签”，本身没有逻辑。</li>
<li><strong>注解处理器 (APT)：</strong> 是一段在<strong>编译期</strong>运行的代码，它专门扫描这些标签。</li>
<li><strong>Java 的局限：</strong> Java 原生就有 APT（Annotation Processing Tool）。但 Kotlin 的语法和 Java 不同，Java 的编译器看不懂 Kotlin 代码，因为Java 注解处理器（APT）是基于 Java 抽象语法树（AST） 工作的。</li>
</ul>
<h2 data-id="heading-1">编译器生成代码</h2>
<p>我写了一个简单的类，但我希望编译器能帮我自动生成一堆枯燥的模版代码。尤其是在数据库方面，对于 Android 的 Room 框架来说，只需要写一个接口（DAO）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Dao</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDao</span> {
    <span class="hljs-meta">@Query(<span class="hljs-string">"SELECT * FROM user"</span>)</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getAll</span><span class="hljs-params">()</span></span>: List&lt;User&gt;
}
</code></pre>
<p><strong>本质问题是：</strong> 接口是不能运行的。在编译时，必须有某个“东西”读取这个 <code>@Dao</code> 注解，然后生成一个真正的 <code>UserDao_Impl</code> 类，里面写满了复杂的 SQL 执行逻辑。</p>
<p>所以为了解决这些问题，kapt应运而生，所以在这里我们就可以理解kapt其实就一个编译器插件，添加room的时候一定要配它，那么问题又来了，<strong>为什么是room要配它呢？</strong></p>
<h4 data-id="heading-2">Room的编译时安全</h4>
<ol>
<li><strong>验证 SQL：</strong> 当你写下 <code>@Query("SELECT * FROM users")</code> 时，如果你把表名写错了，Room 必须在<strong>编译阶段</strong>就报错，而不是等用户运行 App 崩溃时才发现。</li>
<li><strong>生成实现类：</strong> 正如前面提到的，Room 需要通过注解处理器生成大量的 <code>_Impl</code> 代码来处理数据库连接、游标（Cursor）转换等底层操作。</li>
</ol>
<p>那么我们可以看到room其实用了很多注解，但这其实只是一个注解，像我前面所说的它只是代码里的“标签”，本身没有逻辑。所以我们需要一个让 <strong>Room 的注解处理器（本质是一个 Java 程序）</strong> 能够跨语言读取到 Kotlin 源码里的元数据（Metadata）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>