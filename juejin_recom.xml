<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[学而时习之：C++中的文件处理2]]></title>    <link>https://juejin.cn/post/7582857981894000681</link>    <guid>https://juejin.cn/post/7582857981894000681</guid>    <pubDate>2025-12-13T06:09:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582857981894000681" data-draft-id="7582814236584034342" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学而时习之：C++中的文件处理2"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-12-13T06:09:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="煤球王子"/> <meta itemprop="url" content="https://juejin.cn/user/4088439235949739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学而时习之：C++中的文件处理2
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4088439235949739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    煤球王子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T06:09:48.000Z" title="Sat Dec 13 2025 06:09:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>C++ 中的 I/O 重定向</strong></h2>
<p>在 C++ 中，输入和输出通过“流”（stream）完成。流就是字节序列。常见的流对象有：</p>
<ul>
<li><code>cin</code>：从键盘读取输入</li>
<li><code>cout</code>：把输出显示到屏幕</li>
</ul>
<p>每个流都带有一个“缓冲区”（buffer），用来临时存放数据，让输入输出更快。<br/>
<strong>“I/O 重定向”</strong> 就是改变程序“从哪儿读”或“写到哪儿”。例如，把本来输出到屏幕的内容写进文件。</p>
<h3 data-id="heading-1"><strong>使用 <code>ios::rdbuf()</code> 进行重定向</strong></h3>
<p>函数 <strong><code>ios::rdbuf()</code></strong> 可以把流重定向到别的源头或目的地，让程序读写文件，而不是默认的键盘和屏幕。</p>
<p>示例代码：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    
    ofstream file;      <span class="hljs-comment">// 1. 创建一个输出文件流</span>
    file.<span class="hljs-built_in">open</span>(<span class="hljs-string">"writeFile.txt"</span>);

    streambuf *cout_buf = cout.<span class="hljs-built_in">rdbuf</span>();    <span class="hljs-comment">// 2. 保存 cout 原来的缓冲区指针，以便后续恢复</span>

    streambuf *file_buf = file.<span class="hljs-built_in">rdbuf</span>();    <span class="hljs-comment">// 3. 拿到文件流对应的缓冲区指针</span>

    cout.<span class="hljs-built_in">rdbuf</span>(file_buf); <span class="hljs-comment">// 4. 把 cout 的缓冲区换成文件的缓冲区，实现重定向</span>

    <span class="hljs-comment">// 5. 此时用 cout 输出的内容会写进文件 writeFile.txt</span>
    cout &lt;&lt; <span class="hljs-string">"This line will be written to "</span>  &lt;&lt; <span class="hljs-string">"'writeFile.txt'"</span>;

    <span class="hljs-comment">// 6. 手动刷新，确保数据真正写进文件</span>
    cout.<span class="hljs-built_in">flush</span>();

    <span class="hljs-comment">// 7. 把 cout 的缓冲区恢复成默认（屏幕）</span>
    cout.<span class="hljs-built_in">rdbuf</span>(cout_buf);

    <span class="hljs-comment">// 8. 这条信息会正常显示在控制台</span>
    cout &lt;&lt; <span class="hljs-string">"This line will be writtein to console"</span>;

    <span class="hljs-comment">// 9. 关闭文件流</span>
    file.<span class="hljs-built_in">close</span>();

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>程序运行后屏幕实际只会看到：</p>
<pre><code class="hljs language-arduino" lang="arduino">This line will be writtein to console
</code></pre>
<p>而文件 <code>writeFile.txt</code> 里会多出：</p>
<pre><code class="hljs language-arduino" lang="arduino">This line will be written to <span class="hljs-string">'writeFile.txt'</span>
</code></pre>
<h3 data-id="heading-2"><strong>使用 <code>freopen()</code> 进行重定向</strong></h3>
<p>这是 C++ 里另一种实现 I/O 重定向的办法，但它其实是从 C 语言继承过来的。</p>
<p>语法：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-built_in">freopen</span>(fileName, mode, stream);
</code></pre>
<p>参数说明：</p>
<ul>
<li><code>fileName</code>：要重定向到的文件路径。</li>
<li><code>mode</code>：文件打开模式，例如只读 <code>"r"</code>、写入 <code>"w"</code> 等。</li>
<li><code>stream</code>：要被重定向的标准流指针，如 <code>stdout</code>、<code>stdin</code>、<code>stderr</code>。</li>
</ul>
<p>返回值：<br/>
成功时返回指向新文件流的指针；失败返回 <code>NULL</code>。</p>
<p>示例代码：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// 1. 把标准输出（stdout）重定向到文件 "output_freopen.txt"，模式为写入（"w"）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">freopen</span>(<span class="hljs-string">"output_freopen.txt"</span>, <span class="hljs-string">"w"</span>, stdout) == <span class="hljs-literal">NULL</span>)
    {
        cerr &lt;&lt; <span class="hljs-string">"重定向 stdout 失败！"</span> &lt;&lt; endl;
    }

    <span class="hljs-comment">// 2. 此时用 cout 输出的内容都会写进文件，而不会出现在控制台</span>
    cout &lt;&lt; <span class="hljs-string">"This output will be written to 'output_freopen.txt'"</span> &lt;&lt; endl;
    cout &lt;&lt; <span class="hljs-string">"Another line to the file."</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>程序运行后屏幕不会显示任何内容，</strong>  但文件 <code>output_freopen.txt</code> 里会出现：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">This output will be written <span class="hljs-keyword">to</span> <span class="hljs-comment">'output_freopen.txt'</span>
Another line <span class="hljs-keyword">to</span> the file.
</code></pre>
<h3 data-id="heading-3">为什么需要 I/O 重定向</h3>
<p>把标准输入输出“换道”后，程序能获得以下好处：</p>
<ol>
<li><strong>自动化</strong>：同一份输入数据可反复跑，无需手工敲键盘，批量测试、脚本处理必备。</li>
<li><strong>数据管道</strong>：一个程序的输出直接当另一个程序的输入，命令行里轻松搭起流水线。</li>
<li><strong>测试与调试</strong>：换文件就能换测试场景；把输出抓进文件，随时比对预期结果。</li>
<li><strong>日志与监控</strong>：把正常输出或错误信息重定向到日志文件，方便排错、审计和长期监控。</li>
<li><strong>控制台清爽</strong>：后台跑程序时屏幕保持干净，结果事后看文件即可。</li>
</ol>
<hr/>
<p><strong>ios::rdbuf() 与 freopen() 的区别</strong></p>

























<table><thead><tr><th>ios::rdbuf()</th><th>freopen()</th></tr></thead><tbody><tr><td>用于获取或更换 <code>istream</code>/<code>ostream</code> 的内部缓冲区指针。</td><td>把已存在的文件“绑”到标准流（<code>stdin</code>/<code>stdout</code>/<code>stderr</code>）上。</td></tr><tr><td>只改流对象内部缓冲区，文件描述符不变。</td><td>连文件描述符一起换掉，真正重定向到指定文件。</td></tr><tr><td>可对缓冲机制做细粒度控制（如切回原来缓冲区）。</td><td>仅完成“文件↔流”的映射，不直接操作缓冲区。</td></tr><tr><td>属于 C++ 风格的流库接口。</td><td>继承自 C 标准库，跨 C/C++ 通用。</td></tr></tbody></table>
<h2 data-id="heading-4">C++ 文件流 API简单总结</h2>
<p>C++ 文件流 API 一览（按“干什么”分类，只列标准库 <code>&lt;fstream&gt;</code> + <code>&lt;filesystem&gt;</code> 高频接口，C++17 及以上标⭐）</p>
<h3 data-id="heading-5">1. 打开/关闭/文件状态</h3>

































<table><thead><tr><th>目的</th><th>关键成员</th></tr></thead><tbody><tr><td>构造函数即打开</td><td><code>std::ifstream/ofstream/fstream</code> 带路径构造</td></tr><tr><td>事后打开</td><td><code>.open(path, mode)</code></td></tr><tr><td>关闭</td><td><code>.close()</code></td></tr><tr><td>是否打开成功</td><td><code>operator!</code> / <code>.fail()</code> / <code>.is_open()</code></td></tr><tr><td>文件是否存在⭐</td><td><code>std::filesystem::exists(path)</code></td></tr><tr><td>文件大小⭐</td><td><code>std::filesystem::file_size(path)</code></td></tr></tbody></table>
<h3 data-id="heading-6">2. 读写定位</h3>





























<table><thead><tr><th>目的</th><th>关键成员</th></tr></thead><tbody><tr><td>读位置</td><td><code>.tellg()</code></td></tr><tr><td>写位置</td><td><code>.tellp()</code></td></tr><tr><td>跳读</td><td><code>.seekg(offset, dir)</code></td></tr><tr><td>跳写</td><td><code>.seekp(offset, dir)</code></td></tr><tr><td>dir 枚举</td><td><code>std::ios::beg/cur/end</code></td></tr></tbody></table>
<h3 data-id="heading-7">3. 按字符/行/块   读写</h3>

























<table><thead><tr><th>方式</th><th>关键调用</th></tr></thead><tbody><tr><td>单字符</td><td><code>stream.get(c)</code> / <code>stream.put(c)</code></td></tr><tr><td>行</td><td><code>std::getline(stream, string)</code></td></tr><tr><td>整块</td><td><code>stream.read(buf, n)</code> / <code>stream.write(buf, n)</code></td></tr><tr><td>已读字节数</td><td><code>stream.gcount()</code></td></tr></tbody></table>
<h3 data-id="heading-8">4. 格式化写入，读取</h3>













<table><thead><tr><th>目的</th><th>用法</th></tr></thead><tbody><tr><td>与控制台语法一致</td><td>直接用 读【<code>&gt;&gt;</code>】 ，   写【 <code>&lt;&lt;</code>】</td></tr></tbody></table>
<h3 data-id="heading-9">5. 缓冲区底层控制</h3>

























<table><thead><tr><th>目的</th><th>关键调用</th></tr></thead><tbody><tr><td>换缓冲区</td><td><code>stream.rdbuf(new_buf)</code></td></tr><tr><td>取当前缓冲区</td><td><code>stream.rdbuf()</code></td></tr><tr><td>手动刷盘</td><td><code>stream.flush()</code></td></tr><tr><td>与 std::cout 同步开关</td><td><code>std::ios::sync_with_stdio(bool)</code></td></tr></tbody></table>
<h3 data-id="heading-10">6. 打开模式位（可组合）</h3>

































<table><thead><tr><th>位</th><th>含义</th></tr></thead><tbody><tr><td><code>std::ios::in</code></td><td>读</td></tr><tr><td><code>std::ios::out</code></td><td>写（默认 truncate）</td></tr><tr><td><code>std::ios::app</code></td><td>追加</td></tr><tr><td><code>std::ios::ate</code></td><td>打开后指针置尾</td></tr><tr><td><code>std::ios::trunc</code></td><td>若已存在则截空</td></tr><tr><td><code>std::ios::binary</code></td><td>二进制模式</td></tr></tbody></table>
<h3 data-id="heading-11">7. 错误与状态检测</h3>





























<table><thead><tr><th>状态函数</th><th>含义</th></tr></thead><tbody><tr><td><code>.good()</code></td><td>一切正常</td></tr><tr><td><code>.eof()</code></td><td>读到 EOF</td></tr><tr><td><code>.fail()</code></td><td>格式/逻辑错误</td></tr><tr><td><code>.bad()</code></td><td>严重错误（设备故障）</td></tr><tr><td><code>.clear(flags=std::ios::goodbit)</code></td><td>手动清状态</td></tr></tbody></table>
<h3 data-id="heading-12">8. 文件系统级操作⭐（<code>&lt;filesystem&gt;</code>）</h3>

































<table><thead><tr><th>任务</th><th>调用</th></tr></thead><tbody><tr><td>创建目录</td><td><code>std::filesystem::create_directory/parent_path</code></td></tr><tr><td>拷贝文件</td><td><code>std::filesystem::copy_file</code></td></tr><tr><td>改名/移动</td><td><code>std::filesystem::rename</code></td></tr><tr><td>删除</td><td><code>std::filesystem::remove/all</code></td></tr><tr><td>遍历目录</td><td><code>std::filesystem::directory_iterator</code></td></tr><tr><td>路径拼接</td><td><code>operator/</code> 或 <code>std::filesystem::path::append</code></td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别部署焦虑！PinMe：前端开发者的极简部署神器]]></title>    <link>https://juejin.cn/post/7582844980399898664</link>    <guid>https://juejin.cn/post/7582844980399898664</guid>    <pubDate>2025-12-13T10:43:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582844980399898664" data-draft-id="7582861402278445090" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别部署焦虑！PinMe：前端开发者的极简部署神器"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-13T10:43:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="极速蜗牛"/> <meta itemprop="url" content="https://juejin.cn/user/624178334797944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别部署焦虑！PinMe：前端开发者的极简部署神器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624178334797944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    极速蜗牛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T10:43:56.000Z" title="Sat Dec 13 2025 10:43:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>一行命令，30秒上线，永久免费，无需服务器</p>
</blockquote>
<p>大多数前端开发者在公司里，很少需要直接操心"部署"这件事——那通常是运维或 DevOps 的工作。但一旦回到个人项目，情况就完全不一样了。写个小博客、搭个文档站，或者搞个 demo 想给朋友看，部署往往成了最大的拦路虎。 常见的 Vercel、Netlify 或 GitHub Pages 虽然号称"一键部署"，但实际体验并不轻松：要注册平台账号、要配置域名，还得接受平台的各种限制。国内云服务商管控更严格，操作门槛也更高。更让人担心的是，一旦平台宕机，或者因为地区网络问题导致访问不稳定，你的项目可能随时"消失"在用户面前。</p>
<h2 data-id="heading-0">痛点：为什么传统部署这么麻烦？</h2>
<p>传统部署方案存在几个核心问题： <strong>1. 配置复杂</strong>：需要购买服务器、配置域名、设置 SSL 证书、配置 Nginx 等，对前端开发者来说门槛较高。 <strong>2. 平台依赖</strong>：依赖第三方平台，一旦平台出问题或政策调整，项目可能无法访问。 <strong>3. 成本问题</strong>：免费方案有流量限制，付费方案成本不菲，对于个人项目来说负担较重。 <strong>4. 维护困难</strong>：需要持续维护服务器环境，处理各种兼容性和安全问题。</p>
<h2 data-id="heading-1">解决方案：PinMe 的极简哲学</h2>
<p>PinMe 是一个开源工具，主打"极简部署"。它的使用体验非常直接：</p>
<ul>
<li><strong>不需要服务器</strong>：完全去中心化架构</li>
<li><strong>不用注册账号</strong>：零门槛使用</li>
<li><strong>一条命令搞定</strong>：<code>pinme upload ./dist</code>即可完成部署</li>
<li><strong>永久免费</strong>：无流量限制，无使用费用</li>
</ul>
<h2 data-id="heading-2">实战体验：从 0 到上线只需 3 步</h2>
<h3 data-id="heading-3">第一步：安装</h3>
<pre><code class="hljs">npm install -g pinme
</code></pre>
<h3 data-id="heading-4">第二步：构建项目</h3>
<pre><code class="hljs language-arduino" lang="arduino">npm run build  # 生成 dist 目录
</code></pre>
<h3 data-id="heading-5">第三步：部署上线</h3>
<pre><code class="hljs language-bash" lang="bash">pinme upload ./dist
</code></pre>
<p>等待 1-2 分钟，终端会返回一个类似 <code>https://xxx.pinit.eth.limo</code>的链接，点击即可访问你的项目。</p>
<h2 data-id="heading-6">技术原理：去中心化的硬核支撑</h2>
<p>PinMe 的底层依赖 <strong>IPFS</strong>（星际文件系统），这是一个去中心化的分布式文件系统。与传统中心化部署不同：</p>
<ul>
<li><strong>数据分散存储</strong>：内容分布在全球节点中，不依赖单一服务器</li>
<li><strong>内容寻址</strong>：通过内容哈希检索，文件改动一个字节，哈希就会完全不同</li>
<li><strong>永久存储</strong>：一旦上传到 IPFS 网络，内容将永久保存</li>
<li><strong>抗单点故障</strong>：即使部分节点宕机，其他节点仍可提供服务</li>
</ul>
<p>配合 <strong>ENS</strong>（以太坊域名服务），可以将复杂的 IPFS 哈希换成好记的域名（如 <code>myblog.eth</code>），实现内容和域名的双重去中心化。</p>
<h2 data-id="heading-7">适用场景：哪些项目适合用 PinMe？</h2>
<p>PinMe 特别适合以下场景：</p>
<ul>
<li><strong>个人博客/文档站</strong>：快速上线，无需维护服务器</li>
<li><strong>Demo 展示</strong>：临时分享给朋友或面试官</li>
<li><strong>活动页/Landing Page</strong>：快速发布，随时下线</li>
<li><strong>开源项目演示</strong>：为开源项目提供在线预览</li>
<li><strong>个人作品集</strong>：展示个人项目，方便求职</li>
</ul>
<h2 data-id="heading-8">对比传统方案：优势明显</h2>



































<table><thead><tr><th>维度</th><th>传统部署</th><th>PinMe</th></tr></thead><tbody><tr><td>部署时间</td><td>5-30分钟</td><td>1-2分钟</td></tr><tr><td>配置复杂度</td><td>高（服务器、域名、SSL）</td><td>零配置</td></tr><tr><td>成本</td><td>免费版有限制，付费版昂贵</td><td>完全免费</td></tr><tr><td>稳定性</td><td>依赖平台，单点故障风险</td><td>去中心化，高可用</td></tr><tr><td>维护成本</td><td>需要持续维护</td><td>无需维护</td></tr></tbody></table>
<h2 data-id="heading-9">进阶功能：不止于部署</h2>
<p>除了基础部署功能，PinMe 还提供：</p>
<ul>
<li><strong>历史记录管理</strong>：<code>pinme list</code>查看所有部署记录</li>
<li><strong>版本回滚</strong>：随时删除旧版本，回滚到指定版本</li>
<li><strong>域名绑定</strong>：支持绑定自定义域名</li>
<li><strong>GitHub Actions 集成</strong>：实现自动化部署流水线</li>
</ul>
<h2 data-id="heading-10">使用建议：最佳实践</h2>
<ol>
<li><strong>设置基础路径</strong>：在 Vite 配置中设置 <code>base: "./"</code>，避免资源加载问题</li>
<li><strong>合理规划项目大小</strong>：单文件最大 20MB，单次上传目录不超过 500MB</li>
<li><strong>定期清理</strong>：使用 <code>pinme rm</code>删除不再需要的项目</li>
<li><strong>备份重要项目</strong>：虽然 IPFS 提供永久存储，但建议本地保留源码</li>
</ol>
<h2 data-id="heading-11">结语：拥抱更自由的前端部署</h2>
<p>PinMe 并不是要取代 Vercel 这类成熟平台，但它带来了一种新的选择：更简单、更自由、更去中心化。如果你只是想快速上线一个小项目，或者对去中心化部署感兴趣，PinMe 值得一试。 <strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fglitternetwork%2Fpinme" target="_blank" title="https://github.com/glitternetwork/pinme" ref="nofollow noopener noreferrer">github.com/glitternetw…</a> <strong>在线体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpinme.eth.limo%2F" target="_blank" title="https://pinme.eth.limo/" ref="nofollow noopener noreferrer">pinme.eth.limo/</a> 这是一个完全开源的项目，开发团队也会持续更新。如果你在测试过程中有想法或需求，不妨去 GitHub 提个 Issue，这不仅能帮助项目成长，也能让它更贴近前端开发的实际使用场景！</p>
<hr/>
<p><strong>一句话总结</strong>：别再为五分钟演示搭两小时环境——用 PinMe，一行命令，永久免费上线！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Lalamove PHP 服务 Java 化大型项目的实践之路]]></title>    <link>https://juejin.cn/post/7582517982195220523</link>    <guid>https://juejin.cn/post/7582517982195220523</guid>    <pubDate>2025-12-12T02:59:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582517982195220523" data-draft-id="7581765536373276681" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Lalamove PHP 服务 Java 化大型项目的实践之路"/> <meta itemprop="keywords" content="Java,PHP"/> <meta itemprop="datePublished" content="2025-12-12T02:59:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="货拉拉技术"/> <meta itemprop="url" content="https://juejin.cn/user/1768489241815070"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Lalamove PHP 服务 Java 化大型项目的实践之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1768489241815070/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    货拉拉技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T02:59:27.000Z" title="Fri Dec 12 2025 02:59:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    32
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：TGE-Transaction-唐封云（Terry Tang）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f456ff44a61648339f447ca8c097db11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766114724&amp;x-signature=Uu7PR0xxv%2Bp17iz0SAhAl3gbJyM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">背景</h2>
<p>Lalamove自2013年起就开始基于PHP构建系统，之后逐步迁移至Java。随着海外业务增长，业务复杂度和技术复杂度也快速上升。PHP遗留服务，成为系统顽疾：</p>
<ul>
<li>
<p>技术支持层面：公司最新基建以Java为主，缺少PHP支持。</p>
</li>
<li>
<p>PHP自身特性：稳定性，效率，扩展性等问题困扰研发团队。</p>
</li>
</ul>
<p>因此，我们于24年底启动代号为“P2J"的项目，旨在1年内完成核心链路中全部数十个关键PHP服务的Java化。项目范围庞大，共1000+PHP接口需要Java化，上游100+个服务需要完成1200+接入新的Java接口场景。几乎涉及到Lalamove全部业务团队。</p>
<p>项目最终在时间，效率，质量方面优于预期的情况下完成交付。过程中遇到的问题和解决方案，值得和大家分享。</p>
<h2 data-id="heading-1">项目实施的挑战</h2>
<p>从PHP接口维度看，推进节奏简单明了：PHP接口先完成Java化，上游服务择机完成新接口接入，待所有接入完成，服务即可下线。但是，从工程的角度看，一个大型项目的实施，不仅仅是简单的Java语言翻译，是一个系统工程。对时间，效率，质量的期望，除了常见的技术问题挑战，也会面临一系列工程挑战。</p>
<h3 data-id="heading-2">挑战1 -复杂度和时间的矛盾</h3>
<ul>
<li>
<p>复杂度主要来源于：规模，人员，业务复杂度，技术复杂度等。</p>
</li>
<li>
<p>服务间调用关系错综复杂，任务之间存在依赖耦合，影响资源的高效利用。</p>
</li>
</ul>
<p><img src="https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDE5MDUxZDVjOWYzYWE1M2IxOGFlYTU3YWMyOGRlYThfTmhLSGI5N2NJaEJnUTNXTWRwVXI2SkNjczBCQWFyeXJfVG9rZW46QW0xRGJvSTNDbzNWdE54ZDl1UmMzakxjbm9iXzE3NjU1MDQxNjk6MTc2NTUwNzc2OV9WNA" alt="" loading="lazy"/></p>
<p>案例：OrderInfo.get_order_info 接口，java化之后，有多个上游服务需要接入。该接口正常排期，从开发到完成切流，需要1个半月。如串行推进，每个上游接入至少需要等待1个半月。</p>
<p>问题：如何使用最少的资源，按时交付最多的任务？</p>
<h3 data-id="heading-3">挑战2 - 稳定性与效率的矛盾</h3>
<ul>
<li>
<p>PHP代码经过10多年迭代，大量代码屎山，个别核心服务，无效代码代码占比超过30%。</p>
</li>
<li>
<p>多个任务并行上线，切流等，放大了链路出错概率。</p>
<p>案例：下单链路，25年2月51个接口同时切流。任何问题都会直接影响下单链路可用，P0事故妥妥的。</p>
<p><img src="https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=MTJiNDM1YjQwMDdmYzI0MWZhNGM1NDQ5Y2MyZGYwNjVfamx1czU1OFlRdkJlM3dyRU5ZMDczNlk1blkyaUhFeVNfVG9rZW46WXZwVGJvVXZEb3RpeWt4Y1VIWmNXUVVDbkNoXzE3NjU1MDQxNjk6MTc2NTUwNzc2OV9WNA" alt="" loading="lazy"/></p>
</li>
</ul>
<p>问题：如何在大量干扰，并行情况下，依然保障最佳稳定性？</p>
<h2 data-id="heading-4">解决方案</h2>
<p>过去我们也做过多次中小规模的Java化迁移项目，通常是PHP服务负责团队主导，一次最多涉及到几个服务，下游PHP服务改造完成后，上游服务在某个不确定的时间接入。导致整体时间长，质量上参差不齐。我们吸取了过去Java迁移的教训，有针对性地制定我们的解决方案。</p>
<ul>
<li>
<p>技术方案：识别全局通用技术需求，要做到简单，标准化，可复用。</p>
</li>
<li>
<p>质量保障方案：建立质量保障体系，兼顾测试广度和深度。</p>
</li>
<li>
<p>项目管理：全面的项目管理计划，重点关注风险管理和进度管理。</p>
</li>
</ul>
<h3 data-id="heading-5">技术方案</h3>
<h4 data-id="heading-6">全局切流方案</h4>
<blockquote>
<p><strong>切流方案两个设计原则：</strong></p>
<ol>
<li>
<p>对上游无感，平滑切流</p>
</li>
<li>
<p>Java新契约最大程度和PHP一致，降低接入成本</p>
</li>
</ol>
</blockquote>
<p>基于切流方案原则，统一提供切流方案：</p>
<p><img src="https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=MDcyODYxMzM3NWIwMTMzOTc5OTQzZWZhNzNmZGI1MTBfeVpGT2N5QXdJNlVWb1hKRDVRZUJ1S09uWmV0eWRnWnNfVG9rZW46UmZZVmJZUUdab3BmWUR4S3R3ZmN3OVhIbmNlXzE3NjU1MDQxNjk6MTc2NTUwNzc2OV9WNA" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">全局对比方案</h4>
<p>Lalamove/货拉拉内部自研的录制和对比工具为我们提供了录制对比能力。大于60%的PHP接口通过工具对比后，全程无需QA介入，直接上线。保障质量的同时，能极大减少研发和QA资源。</p>
<p><img src="https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDc3M2MxMWFkM2RhNDQ4ODk5NGRiYTNhZjUyMDJhNmRfbWpKRXd1bExnTU5LUTg4VWZBSHNOUUtiZzNjdTY2dzdfVG9rZW46SVQwT2JDZVZ3b25JaHR4Y3FBb2NhMGhSblVlXzE3NjU1MDQxNjk6MTc2NTUwNzc2OV9WNA" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">全局监控&amp;告警系统</h4>
<p>识别研发流程引进的监控盲点，早发现，早解决。</p>
<p><img src="https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=YzMzOWYxYTcxNTg4NDY0ZjEzMmRmNTIyMDI4MjIxZGRfWWhGZXY4cTBac011UG4wMFhaVG5ORkpZQkQ0c216NHNfVG9rZW46VVlGQmJSMUZYb2dFOG14c2RlZmNyZXRqbkJkXzE3NjU1MDQxNjk6MTc2NTUwNzc2OV9WNA" alt="" loading="lazy"/><img src="https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=NzU2NGJiNjU3NmM3ZmQ4YWNmZTQ3YWFlYWFlNmNkYzJfWnBMZzB2R2ozWVpwY2wwcDFBeDRsS1ZwZEpVWVN6N1FfVG9rZW46U3daT2JESzBqb09QZml4Z3o2aWM1UERSbnZiXzE3NjU1MDQxNjk6MTc2NTUwNzc2OV9WNA" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">重构</h4>
<p>避免炫技式重构，鼓励可控的领域重构。通过重构，整体上减少了20%的任务量：</p>
<ul>
<li>
<p>避免PHP技术债务传递到新的Java服务，实现服务领域化。</p>
</li>
<li>
<p>合并+精简逻辑</p>
</li>
</ul>
<h4 data-id="heading-10">AI提效</h4>
<ul>
<li>AI工具非常适合跨语言迁移项目，使用场景多样，覆盖了研发生命周期。在本项目中，AI生成了约7%（15w行）的代码。</li>
</ul>
<p><img src="https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=NWY3NmEwNWY1MWFjNzFmNDJlNGQ3NWZiMDJmYzAyNDJfdlhEWEZHbFVzODlnZEM5UnRjWjh1VDgzWVltcEtic2FfVG9rZW46Smt4YWJIYkxjb2ZYZTl4OEVVaGNTOTRQbjZkXzE3NjU1MDQxNjk6MTc2NTUwNzc2OV9WNA" alt="" loading="lazy"/></p>
<ul>
<li>
<p>AI使用场景案例 - 司机系统的PHP接口java化</p>
<ul>
<li>
<p>按照编码规范，项目架构规范，手工实现一个接口</p>
</li>
<li>
<p>在Cursor上配置User Rules，要求Cursor参考已实现的接口和规范，生成代码</p>
</li>
<li>
<p>对生成的代码微调，测试，上线。</p>
</li>
<li>
<p>减少50%的工作量。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-11">质量保障</h3>
<h4 data-id="heading-12">测试质量保障体系</h4>
<blockquote>
<p><strong>目标：全面、深入、高效地完成测试交付</strong></p>
</blockquote>
<p><img src="https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=OTNmY2RmNDU3ODEzYjdlNWVjNzdkZDViYThkMjY2NzFfbjNzeEpobXVYcjFLeFN1TVdXZGhsVzA1d05ESUxWN1VfVG9rZW46SjR1d2J0Y2pBb05OMEp4ZHprWmNGaXdQbkNlXzE3NjU1MDQxNjk6MTc2NTUwNzc2OV9WNA" alt="" loading="lazy"/></p>
<h4 data-id="heading-13">测试效率和质量</h4>
<p><strong>测试效率：</strong></p>
<p>我们通过提前规划、动态调整、工具提效的策略，保证整体的测试进度：</p>
<p><img src="https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=YWI4MGE1ZjgyYTk2MGJjNjc5MGE0YjhmZWEwMTUzYjhfWmtTUG9tMnN5NDRaY0JlWHJnWXI5anNOT0dDMFhWdHZfVG9rZW46RENsUGJ2UXhpb3AyQnN4cUY5cmNvb0E5bjhjXzE3NjU1MDQxNjk6MTc2NTUwNzc2OV9WNA" alt="" loading="lazy"/></p>
<p>**案例1：**基于自研的测试场景编排工具Autoflux，进行订单主流程新旧流程巡检，检查不同的支付方式✖️订单类型✖️订单操作，覆盖所有订单核心链路。</p>
<p><img src="https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=MmNmYTk5YWJlMzdiZDE0ODY5MDMwN2RkODVkNzIxZDRfY0N1VjMwQ1BJVTdCZnhsYjgzclB3VG05bFlwSFZCZmdfVG9rZW46RDg2cWJLaGp2b0xlOGR4MFhoYWNiNXdHbk8zXzE3NjU1MDQxNjk6MTc2NTUwNzc2OV9WNA" alt="" loading="lazy"/></p>
<p><strong>案例2：<strong>PHP接口在转Java后，原有接口自动化失活，需要补充对应新接口的自动化用例，用来做日常准出的流水线卡口校验，以OrderInfo服务接口自动化为例，本次项目新增27个接口，使用Cursor自动生成接口自动化测试用例，相比于P2J项目前手动编写的自动化测试用例，编写效果提高了</strong>10</strong>倍。通过使用Cursor补充完全部新Java化接口case节省工时：<strong>800+</strong> mandays</p>
<p><img src="https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=MjkyMTkxNzQyMWUxOTg4N2ZiN2Q4OGE2Y2FmNzIwZWNfWGxBdWdsVHdDWUR6VGNUcEQza0ZmUzltZXZ2VDhqUWZfVG9rZW46UjI4cmI0S1RMb2xiZ0x4RmVlMWNEVVZtblJmXzE3NjU1MDQxNjk6MTc2NTUwNzc2OV9WNA" alt="" loading="lazy"/></p>
<p><strong>测试广度：</strong></p>
<p>在开发自测阶段，我们提供测试工具，赋能开发自测，提高提测质量</p>
<p><img src="https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=YTBhMGFhZWE3OWIzMmY2YmQwZGRlNTU5Y2VhODlmYzNfNkVGR25VbmxJYWFES0NCV0JwVVNIR0FXWWFFUlJTTndfVG9rZW46WmdhWmIzTFljbzh0MmJ4NG9qaGNRTE8ybmtiXzE3NjU1MDQxNjk6MTc2NTUwNzc2OV9WNA" alt="" loading="lazy"/></p>
<p>在QA测试阶段，我们对参与P2J测试的QA进行持续培训，保障测试的基线</p>
<p><img src="https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDBhYTMyOTA4ZmZiOGMzNWFhZTAyOWIxNGMxOWE0N2NfTVZJQjhNTHhzMFB0UEVHQmxXTUxMeloydnh4eHFEMFZfVG9rZW46TlZueGJ2SEEyb3ZkSWR4SllnR2NmSXdDbkVmXzE3NjU1MDQxNjk6MTc2NTUwNzc2OV9WNA" alt="" loading="lazy"/></p>
<p><strong>测试深度：</strong></p>
<p>我们针对接口容易出问题的点，对应进行了多项专项测试：分流测试、并发测试、本地化测试、故障注入测试、兼容性测试、探索性测试、性能测试等，发现了很多深度BUG。</p>
<p>案例：</p>
<p><img src="https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=MWY1ZjY1OGFhMzgzNWJkMmVkNmZiNmZhNDBkYWY1NzVfZUxmVFc0MDJ1alF0b29sUnZNUVM2RUs1SmxZcVBCbndfVG9rZW46Q1Q2NmIzSGhXb3c3N2h4S1lBaGNTU3JkblhoXzE3NjU1MDQxNjk6MTc2NTUwNzc2OV9WNA" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">项目管理</h3>
<p>当技术复杂度与组织/规模复杂度叠加，大型项目单纯依靠技术手段往往容易失控。我们需要做好项目管理规划，确保项目能按预期交付。</p>
<h4 data-id="heading-15">风险管理</h4>
<p>提前识别技术、业务、团队、外部依赖带来的风险。做好风险应对措施。一些常见的风险和应对如下：</p>
<ul>
<li>
<p>团队项目早期经验不足：需要持续培训。</p>
</li>
<li>
<p>切流过程可能出现问题：需要回滚SOP。</p>
</li>
<li>
<p>服务下线后，发现还有遗留流量：需要服务下线SOP。</p>
</li>
<li>
<p>项目临时资源冲突： 需要明确的项目优先级定义，做好资源冲突发现机制和预案。</p>
</li>
</ul>
<h4 data-id="heading-16">进度管理</h4>
<p>项目参与人数众多，避免低效沟通，让相关负责人从低效沟通释放出来。飞书多维表格作为一种轻量级低代码平台，在项目中广泛应用在以下场景：</p>
<p>**任务状态可视化：**让关键信息无所遁形，辅助决策。</p>
<p><img src="https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=OTlhMGQyODlmZDgyNmVjMGQxZjE1MDcyYmNiYmY2YjBfRTVVYkF0V0QzOVFDemZqemxoUFhJTk00NUI0bThJb0lfVG9rZW46THV3MmJOMWZGb1lETXB4czU5eWNJY3NvbmpmXzE3NjU1MDQxNjk6MTc2NTUwNzc2OV9WNA" alt="" loading="lazy"/></p>
<p>**进度风险触达：**让进度风险实时触达相关人员，及时干预。</p>
<p><img src="https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=YjczNWRjNDdiMzU5NDZkMWRjMWI1MzU2MDc4YmRmMDdfRVZCY3lSZU5ReU5mSElHNTZOR3B6ZzBJY1NOTENRbE5fVG9rZW46VnN3V2J3Y2ZubzFJWHN4bW9CUWNoVTYzbmNnXzE3NjU1MDQxNjk6MTc2NTUwNzc2OV9WNA" alt="" loading="lazy"/></p>
<h2 data-id="heading-17">结语</h2>
<p>本文完整的记述了Lalamove一次Java化大型项目的实践过程，可以说是一次相对全面的经验总结。其中一些执行细节，也不是一开始就能做到面面俱到，一些问题在执行过程中被识别，解决后沉淀成研发SOP，或者其他项目规范。这些经验总结考虑到普适性，希望其中的方案能对读者有所帮助，通过参考，不仅仅能使用在Java化项目，其他语言迁移项目，甚至其他的大型项目上。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[突破 LLM 极限！n8n + MemMachine 打造“无限流”小说生成器]]></title>    <link>https://juejin.cn/post/7582561515816484927</link>    <guid>https://juejin.cn/post/7582561515816484927</guid>    <pubDate>2025-12-12T06:12:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582561515816484927" data-draft-id="7582422766731755563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="突破 LLM 极限！n8n + MemMachine 打造“无限流”小说生成器"/> <meta itemprop="keywords" content="AIGC,人工智能,Agent"/> <meta itemprop="datePublished" content="2025-12-12T06:12:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="后端小肥肠"/> <meta itemprop="url" content="https://juejin.cn/user/2966945320667536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            突破 LLM 极限！n8n + MemMachine 打造“无限流”小说生成器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2966945320667536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    后端小肥肠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:12:30.000Z" title="Fri Dec 12 2025 06:12:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小肥肠！今天我们搞点真正的黑科技，挑战一下大模型的“记忆极限”。针对AI写长文容易“失忆”的顽疾，我用 <strong>n8n + MemMachine</strong> 打造了一套“永不忘词”的无限长篇小说工作流。从大纲设定到自动连载，字数无上限，剧情不崩坏，一键直达飞书。想让你的 AI 进化成能写百万字的“网文大神”吗？码住这篇教程，带你零门槛实操起飞！</p>
<h2 data-id="heading-0">1. 效果演示</h2>
<p>上周我写了一个写小说的工作流，很多读者反馈能不能突破篇幅限制，短篇小说不够看的。为了解决这个痛点，我基于 <strong>MemMachine</strong> 实现了这个可以突破大模型上下文限制的 <strong>n8n 无限长篇小说工作流</strong>。做出来以后在群里内测，反馈相当不错。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f16ba78af5a24eb8bd7f9e13f7f967cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=EsNff3fqmyLgpZIRSQ9%2F7x8XbBU%3D" alt="" loading="lazy"/></p>
<p>现在的工作流一共为两部分：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6844602725d4fa6a4e15fa07cb4328b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=FuvYKdJE0rmlo4t0CPOkY%2FtyyG0%3D" alt="" loading="lazy"/></p>
<p><strong>第一部分</strong>是将本地小说录入飞书素材库。有了这一步，我们就可以基于自定义素材，编写任意领域风格的小说。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce23c06e51d8473e90413aec49d7c27d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=2t7%2FVMnRs4DbPAan3ksHqa%2FYDmY%3D" alt="" loading="lazy"/></p>
<p><strong>第二部分</strong>是读取素材库中的小说作为参考配合<strong>MemMachine</strong> 记忆库编写长篇小说，下图中写了整整16章。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd210b311d064fc380ea6773435c2cb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=9%2FBr1kQdpR1LwGngM0T7VaP%2FFYk%3D" alt="" loading="lazy"/></p>
<p>每章的字数在2000—3000字，远远突破了大模型上下文限制。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fab79269d8344cf99c6f75a7546255d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=aIxDEIVAYQ62jpS6c0h8lgPDjME%3D" alt="" loading="lazy"/></p>
<p>接下来就正式开始这个硬核工作流的搭建~</p>
<h2 data-id="heading-1">2. 工作流架构剖析和前置准备</h2>
<h3 data-id="heading-2">2.1 长篇小说工作流架构说明</h3>
<p>长篇小说工作流主要依赖于<strong>MemMachine来存储章节的记忆，每写完一章会将这章的内容存入记忆库，下一章的编写可依赖这一章的内容。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9721119be744040b587ebd0d62a235a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=NWaTB7tteogsSgVxCm0QEcHvGYo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 基于Docker部署MemMachine</h3>
<p><strong>MemMachine</strong>是一个开源的<strong>AI 智能体通用记忆层（Universal Memory Layer）</strong> 项目。简单来说，它的目标是解决大语言模型（LLM）通常存在的<strong>失忆</strong>问题（即无状态），让 AI 智能体能够像人一样拥有长期记忆、个性化认知和上下文理解能力。</p>
<p>现在的 AI 虽然聪明但非常健忘，一旦关闭对话窗口或者换一个模型，它就会把你以前说过的话和你的个人喜好忘得一干二净。MemMachine 就是为了解决这个问题而设计的一个外挂大脑，它能像一个超级记事本一样，自动把你的聊天记录、习惯偏好（比如我不吃香菜）和历史事件永久存储下来。</p>
<p>这样做最大的好处是，AI 拥有了长期记忆。哪怕你过段时间再回来，或者换用了不同公司的 AI 模型，只要连上这个系统，AI 就能立刻想起来你是谁以及你们之前的交情，不需要你重复啰嗦。它让 AI 从一个每次见面都要重新认识的陌生人，变成了一个真正懂你、记得你一切过往的老朋友。</p>
<p><strong>源码地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMemMachine%2FMemMachine" target="_blank" title="https://github.com/MemMachine/MemMachine" ref="nofollow noopener noreferrer">github.com/MemMachine/…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b8154267d3047f3b47c464b56918882~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=GJZnhVqdYWINqabU8Bt7sGS%2Fxis%3D" alt="" loading="lazy"/></p>
<p>进入页面后我们就可以用git clone或下载压缩包的形式来下载源码了，源码下载完后项目的目录如下图。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a837393c1de74baaab22236f57f1feb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=bJnxVd8Edz%2B4Ny%2F6Wmc2szc102A%3D" alt="" loading="lazy"/></p>
<p>只需要配置好.env、docker-compose.yml、configuration.yml这三个文件就可以基于Docker顺利部署<strong>MemMachine</strong>在本地了。</p>
<p><strong>MemMachine</strong>部署也很简单，只需要在文件路径输出cmd，在弹出的命令提示符中输入<strong>docker compose up -d</strong>即可完成部署。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c728e5c6d7d447599edda71c611cddc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=zumsdw0Crh6jcADWoX%2BiZqLjUUo%3D" alt="" loading="lazy"/></p>
<p>部署后可访问<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fdocs%25EF%25BC%258C%25E7%259C%258B%25E5%2588%25B0%25E5%25A6%2582%25E4%25B8%258B%25E7%2595%258C%25E9%259D%25A2%25E5%258D%25B3%25E4%25B8%25BA%25E6%2588%2590%25E5%258A%259F%25E3%2580%2582" target="_blank" title="http://localhost:8080/docs%EF%BC%8C%E7%9C%8B%E5%88%B0%E5%A6%82%E4%B8%8B%E7%95%8C%E9%9D%A2%E5%8D%B3%E4%B8%BA%E6%88%90%E5%8A%9F%E3%80%82" ref="nofollow noopener noreferrer">http://localhost:8080/docs，看到如下界面即为成功。</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6aa0876b3c7414db66afe3e9c552a27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=kihAa4nOYxX8p2hHN6sMZbK8WCQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">3. 工作流搭建</h2>
<p>这个小说工作流和原来的一样，唯一的区别是加了<strong>MemMachine</strong>记忆写入和读取逻辑。这里就不再从头开始搭建，只讲差异部分，需要看从0开始的搭建步骤可以去看<a href="https://juejin.cn/post/7580378958072610826" target="_blank" title="https://juejin.cn/post/7580378958072610826">通吃网文投稿+AI漫剧版权！我用 n8n+飞书搭了个“万字爆款小说流水线”</a></p>
<p><strong>长篇小说工作运行流程如下：</strong></p>
<ol>
<li>
<p>表单提交小说主题和领域内容</p>
</li>
<li>
<p>根据用户提交表单中的小说领域去飞书素材库中找到对应小说素材作为写作参考</p>
</li>
<li>
<p>结合小说素材，用户提供的主题编写小说的大纲和章节梗概列表（数组形式）</p>
</li>
<li>
<p>初始化一个<strong>MemMachine</strong> project，获得一个project_id</p>
</li>
<li>
<p>进入循环开始编写章节内容</p>
</li>
<li>
<p>根据project_id从<strong>MemMachine</strong> 获取上一章节的内容</p>
</li>
<li>
<p>根据前期提要，大纲和本章节的梗概编写本章节的详细内容</p>
</li>
<li>
<p>写入章节内容到飞书表格</p>
</li>
<li>
<p>总结本章节的内容，以project_id为标识写入<strong>MemMachine</strong></p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffb1ee4bbb624cbb881b0b67841863b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=DaVbeqFPjSrJNV6iovE6xdNLB8s%3D" alt="" loading="lazy"/></p>
<p><strong>初始化项目(HTTP Request)：</strong> 这个节点位于编写大纲节点的前面，它的作用是在<strong>MemMachine</strong> 中新建一个<strong>project</strong>，后续编写的章节内容会存入到project中。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f6254a35ed048bc88785197726324bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=gP2Dmh%2F1Qn%2B0Rgt%2BobzpqonCEDM%3D" alt="" loading="lazy"/></p>
<p>跟之前的小说工作流比，这个工作流的变动主要在章节编写部分，故本文的节点搭建讲解主要围绕章节编写部分展开：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0a79c1399af4df796314b5435b857c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=qoGkoW7p7yrLnT9YLHIxhhbXcLY%3D" alt="" loading="lazy"/></p>
<p><strong>读取记忆（HTTP Request）：</strong> 这个节点的作用是根据<strong>project_id</strong>，获取对应<strong>project</strong>中存储的记忆。举个例子，如果<strong>当前章数为3</strong>，那么就会从<strong>project中</strong>获取<strong>前2章的数据</strong>，如果当前章数为1则返回空数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8685abcfbb84d12a15ce564978cc18e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=bkGUfXPO1IkyvxRtkbnzYarJOUQ%3D" alt="" loading="lazy"/></p>
<p><strong>获取章节梗概(Code inJavaScript)：读取记忆（HTTP Request）节点出来后点击【+】新增Code inJavaScript节点。</strong> 它的作用是从前置所有章节列表中取出最后一章的章节内容。如<strong>读取记忆（HTTP Request）</strong> 节点传入了2章数据，那么这个节点就会获取第2章数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cdd0dc5a36f4ef4aaeec0b6e460b8d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=8tg%2BGrIrC61qQtMBcIEtAj1wAbk%3D" alt="" loading="lazy"/></p>
<p><strong>章节编写（AI Agent）：获取章节梗概(Code inJavaScript)节点出来后点击【+】新增AI Agent节点。</strong> 这个节点的作用是根据小说摘要，第2章故事梗概与结尾，和第三章故事梗概<strong>编写第三章内容</strong>，这样就能完美解决大模型无法编写长篇小说以及内容过长导致的内容不连贯或人物OOC。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/356f98bb1e4343659148d3b4c0f94710~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=o57h70mdXvbePjWLvrfX%2BDhqb14%3D" alt="" loading="lazy"/></p>
<p><strong>Code1（将数据改为</strong> <strong>飞书</strong> <strong>表格适配形式）：章节编写（AI Agent）节点出来后点击【+】新增Code inJavaScript节点。</strong> 这是一个代码节点，它的作用是将小说内容适配为飞书表格的形式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/244c35d71f56467280cf28edb7633f94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=q4HIsBgPtVENIJSNSIbRyacVB64%3D" alt="" loading="lazy"/></p>
<p><strong>写入</strong> <strong>飞书</strong> <strong>（Bitable:table:record:add bitable）：Code1（将数据改为飞书表格适配形式）出来后点击【+】新增Bitable:table:record:add bitable节点。</strong> 这是n8n社区节点，负责写入数据到飞书表格。节点的配置使用可参考<a href="https://juejin.cn/post/7578499754553278515" target="_blank" title="https://juejin.cn/post/7578499754553278515">n8n+Coze+飞书：公众号对标文章一键录入+深度拆解，打造你的【爆款素材库】</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f6a8b2286614ff297e33e4bd672340b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=TOdg9Zgky%2BANOmqrNAjdgW5Nw4s%3D" alt="" loading="lazy"/></p>
<p><strong>总结（AI Agent）：写入</strong> <strong>飞书</strong> <strong>（Bitable:table:record:add bitable）节点出来后点击【+】新增AI Agent节点。</strong> 这个节点的作用是对<strong>章节编写（AI Agent）节点</strong>输出的小说内容进行总结，总结剧情摘要，保留结尾内容以便下一章的衔接。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3632bd586d604c39bc6dd4d3409d2bd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=F6NgZTpMVPCpXwa8XkTxDXvg1%2B8%3D" alt="" loading="lazy"/></p>
<p><strong>存入记忆（HTTP Request）：总结（AI Agent）节点出来后点击【+】新增HTTP Request节点。</strong> 这个节点的作用是调用<strong>MemMachine</strong> 接口将章节内容存入<strong>project</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b056994e6bf4445d91aed991430728ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=NFHAiwzVn7bdruKIrSjGFYM7Tck%3D" alt="" loading="lazy"/></p>
<p>以上就是整个工作流的完整流程拆解，动手能力强的读者可以跟着教程实践一遍。<strong>上述工作流已经被收录到了小肥肠行动家社群中，如果想直接获取工作流原件，可以加入社群后我拉你进空间直接学习使用。</strong></p>
<h2 data-id="heading-5">4. 结语</h2>
<p>至此，一个能够自我迭代、拥有长期记忆的<strong>无限长篇小说生成器</strong>就搭建完成了。这套工作流最大的价值，不在于写小说本身，而在于它证明了 <strong>MemMachine + n8n</strong> 组合的无限可能。当我们把<strong>记忆</strong>从大模型中解耦出来，赋予 Agent 真正的长期状态管理能力时，AI就不再是一个聊完即忘的聊天机器人，而是一个能伴随剧情成长的<strong>创作者</strong>。</p>
<p><strong>如本次分享对你有帮助，麻烦一键三连支持一下小肥肠，我们下期再见~</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e48cf94d4e9243909c862e24653280b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=1S%2F%2FmQ1qcrb%2FHOzPy3kIk9TVPqk%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🧩 一文搞懂 HarmonyOS 中的 HAP、HAR 和 HSP：它们到底是什么？怎么用？]]></title>    <link>https://juejin.cn/post/7582848701268361251</link>    <guid>https://juejin.cn/post/7582848701268361251</guid>    <pubDate>2025-12-13T09:49:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582848701268361251" data-draft-id="7582844980399783976" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🧩 一文搞懂 HarmonyOS 中的 HAP、HAR 和 HSP：它们到底是什么？怎么用？"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-13T09:49:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="90后晨仔"/> <meta itemprop="url" content="https://juejin.cn/user/2717648476705773"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🧩 一文搞懂 HarmonyOS 中的 HAP、HAR 和 HSP：它们到底是什么？怎么用？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648476705773/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    90后晨仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T09:49:39.000Z" title="Sat Dec 13 2025 09:49:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0c9edf8690d434d8bb3a445e3641fd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOTDlkI7mmajku5Q=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766224226&amp;x-signature=FbTlU%2FMAoApy4JKPJZKwS78hjPY%3D" alt="Snip20251213_6.png" loading="lazy"/></p>
<h2 data-id="heading-0">🌟 开头一句话总结</h2>
<ul>
<li><strong>HAP</strong> 是你最终安装到手机上的“App 包”；</li>
<li><strong>HAR</strong> 是可被多个 App 共享的“动态库”（像 npm 包）；</li>
<li><strong>HSP</strong> 是只能被一个 App 内部使用的“静态库”（像私有工具函数集合）。</li>
</ul>
<hr/>
<h2 data-id="heading-1">📦 1. HAP：HarmonyOS Ability Package（能力包）</h2>
<h3 data-id="heading-2">✅ 它是什么？</h3>
<p>HAP 是 <strong>鸿蒙应用的安装单元</strong>。你可以把它理解为 Android 的 APK 或 iOS 的 IPA。</p>
<p>每个鸿蒙 App 至少包含一个 HAP，通常分为两种：</p>

















<table><thead><tr><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><strong>Entry HAP</strong></td><td>主模块，用户点击图标启动的就是它（必须有）</td></tr><tr><td><strong>Feature HAP</strong></td><td>可选功能模块，按需下载（比如“直播”、“支付”等独立功能）</td></tr></tbody></table>
<h3 data-id="heading-3">📁 文件结构示例：</h3>
<pre><code class="hljs language-css" lang="css">MyApp/
├── entry/          ← Entry HAP
│   ├── <span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/
│   └── module<span class="hljs-selector-class">.json5</span>
├── feature_live/   ← Feature HAP（可选）
└── build-profile<span class="hljs-selector-class">.json5</span>
</code></pre>
<h3 data-id="heading-4">💡 关键点：</h3>
<ul>
<li>用户安装的是 <code>.hap</code> 文件（实际是 ZIP 格式）。</li>
<li>一个 App 可以有多个 HAP，但只有一个 Entry。</li>
<li>HAP 里包含代码、资源、配置、Ability（页面/服务）等。</li>
</ul>
<hr/>
<h2 data-id="heading-5">🧱 2. HAR：HarmonyOS Archive（共享归档包）</h2>
<h3 data-id="heading-6">✅ 它是什么？</h3>
<p>HAR 是 <strong>可复用的共享库</strong>，类似 Web 开发中的 <code>npm</code> 包，或 Android 的 AAR。</p>
<ul>
<li>多个 App 或多个 HAP <strong>都可以引用同一个 HAR</strong>。</li>
<li>编译后生成 <code>.har</code> 文件。</li>
<li>支持包含 <strong>TS/JS 代码、C++ 原生代码、资源文件（图片、字符串等）</strong> 。</li>
</ul>
<h3 data-id="heading-7">🛠️ 什么时候用 HAR？</h3>
<ul>
<li>你有一套 UI 组件库（比如 Design System）要给多个项目用；</li>
<li>封装了网络请求、日志、加密等通用逻辑；</li>
<li>团队协作，需要模块解耦。</li>
</ul>
<h3 data-id="heading-8">📁 创建方式（DevEco Studio）：</h3>
<p>新建模块 → 选择 <strong>“Shared Library”</strong> → 生成的就是 HAR。</p>
<h3 data-id="heading-9">⚠️ 注意限制：</h3>
<ul>
<li>HAR <strong>不能包含 Ability（页面/服务）</strong> —— 它只是“工具箱”，不是“应用”。</li>
<li>资源 ID 在不同 HAR 间可能冲突（建议加前缀）。</li>
</ul>
<hr/>
<h2 data-id="heading-10">🔒 3. HSP：HarmonyOS Static Package（静态包）</h2>
<h3 data-id="heading-11">✅ 它是什么？</h3>
<p>HSP 是 <strong>仅限当前 App 内部使用的静态库</strong>，编译时会直接“合并”进主 HAP。</p>
<ul>
<li>不会被其他 App 引用；</li>
<li>最终不会生成独立文件，而是“内联”到 HAP 中；</li>
<li>更安全（代码不暴露）、更轻量（无运行时开销）。</li>
</ul>
<h3 data-id="heading-12">🛠️ 什么时候用 HSP？</h3>
<ul>
<li>工具函数、常量、私有业务逻辑，不想对外暴露；</li>
<li>追求极致性能，避免 HAR 的动态加载开销；</li>
<li>模块只在本 App 内使用，无需共享。</li>
</ul>
<h3 data-id="heading-13">📁 创建方式：</h3>
<p>新建模块 → 选择 <strong>“Static Library”</strong> → 生成 HSP。</p>
<hr/>
<h2 data-id="heading-14">🔁 对比总结表</h2>















































<table><thead><tr><th>特性</th><th>HAP</th><th>HAR</th><th>HSP</th></tr></thead><tbody><tr><td><strong>用途</strong></td><td>应用安装包</td><td>共享库</td><td>静态私有库</td></tr><tr><td><strong>能否被安装</strong></td><td>✅ 是</td><td>❌ 否</td><td>❌ 否</td></tr><tr><td><strong>能否包含页面（Ability）</strong></td><td>✅ 是</td><td>❌ 否</td><td>❌ 否</td></tr><tr><td><strong>能否被多个 App 共用</strong></td><td>❌ 否</td><td>✅ 是</td><td>❌ 否</td></tr><tr><td><strong>编译产物</strong></td><td><code>.hap</code></td><td><code>.har</code></td><td>无独立文件（内联）</td></tr><tr><td><strong>创建模板</strong></td><td>Empty Ability</td><td>Shared Library</td><td>Static Library</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-15">🎯 实际开发建议</h2>
<ol>
<li><strong>主 App 功能 → 用 HAP</strong>（Entry + Feature）；</li>
<li><strong>跨项目复用组件/逻辑 → 用 HAR</strong>；</li>
<li><strong>仅本项目内部工具 → 用 HSP</strong>（更安全高效）；</li>
<li><strong>不要把业务页面放进 HAR/HSP</strong> —— 它们只能放“辅助代码”。</li>
</ol>
<hr/>
<h2 data-id="heading-16">🧪 举个例子</h2>
<p>假设你在开发一个电商 App：</p>
<ul>
<li><code>entry</code> → 主 HAP（首页、商品列表）</li>
<li><code>feature_cart</code> → 购物车 HAP（按需加载）</li>
<li><code>common_ui.har</code> → 通用按钮、弹窗组件（多个 App 共用）</li>
<li><code>utils.hsp</code> → 本地加密、时间格式化（仅本 App 用）</li>
</ul>
<p>这样结构清晰，复用性强，也便于团队分工！</p>
<hr/>
<h2 data-id="heading-17">✅ 结语</h2>
<p>HAP、HAR、HSP 是鸿蒙模块化开发的三大基石。<br/>
理解它们的区别，能帮你写出更规范、可维护、高性能的 HarmonyOS 应用。</p>
<blockquote>
<p>📌 记住口诀：<br/>
<strong>HAP 装得下，HAR 分享它，HSP 私藏吧！</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[编写一个 VS Code 扩展：将 Copilot 支持的大模型通过 REST API 方式暴露出来]]></title>    <link>https://juejin.cn/post/7582413770091937830</link>    <guid>https://juejin.cn/post/7582413770091937830</guid>    <pubDate>2025-12-11T22:49:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582413770091937830" data-draft-id="7582425536464109594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="编写一个 VS Code 扩展：将 Copilot 支持的大模型通过 REST API 方式暴露出来"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-11T22:49:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="磊磊落落"/> <meta itemprop="url" content="https://juejin.cn/user/3054882885469577"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            编写一个 VS Code 扩展：将 Copilot 支持的大模型通过 REST API 方式暴露出来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3054882885469577/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    磊磊落落
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T22:49:47.000Z" title="Thu Dec 11 2025 22:49:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>大家好，我是磊磊落落，目前我在技术上主要关注：Java、Golang、AI、架构设计、云原生和自动化测试。欢迎来我的博客（<a href="https://link.juejin.cn?target=https%3A%2F%2Fleileiluoluo.com%2Fposts%2Fcopilot-rest-api-extension.html" target="_blank" title="https://leileiluoluo.com/posts/copilot-rest-api-extension.html" ref="nofollow noopener noreferrer">leileiluoluo.com</a>）获取我的最近更新！</p>
</blockquote>
<p>在 AI 辅助编程的时代，Copilot 已经成为众多开发者的得力助手。我们只要拥有一个 GitHub 账号，只要开通了 Copilot，即可在 VS Code 等编辑器中使用它。而且 Copilot 可选的大模型日益增多，从最初的 Codex 模型到如今支持更强大的 GPT-5 系列，模型能力不断增强。</p>
<p>然而，Copilot 的能力被完全释放了吗？答案是否定的。它依然被限制在 IDE 插件、特定工作流的框架内。如果我们可以将 Copilot 背后的大模型能力「解放」出来，通过简单、通用的 REST API 提供给更多开发者、工具和应用调用，将会带来哪些可能性？</p>
<p>今天，我们就将共同探索这个实践：如何通过编写一个 VS Code 扩展，将 Copilot 支持的大模型转化为可灵活调用的 API 服务。</p>
<h2 data-id="heading-0">1 为什么需要一个 VS Code 扩展</h2>
<p>下面以在 VS Code 中借助 Copilot 批量生成报告为例来说明为什么需要编写一个 VS Code 扩展。</p>
<p>假设，我正在为一个博客聚合网站做年度报告。拥有的初始数据是一个 JSON 数组 <code>blog-posts.json</code>，该数组记录了聚合网站中所有博客在 2025 全年发布的文章。</p>
<p>格式如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"blog"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"leileiluoluo.com"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"articles"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"提示工程需要遵循的五个原则（附实践案例）"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"關於 2026 年即將生效的「吸毒記錄可封存」法案"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"如何使用 Spec Kit 工具进行规范驱动开发？"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
  <span class="hljs-comment">// ...</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<p>如果我想借助 Copilot，让其基于上述数据批量生成所有博客的年度报告 <code>blog-summary.json</code>（格式如下），该如何做呢？</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"blog"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"leileiluoluo.com"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"summary"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"您的博客文章涵盖了技术开发、社会热点和个人生活等多个领域。在技术方面，您深入探讨了提示工程、规范驱动开发、Spring Boot 框架的应用、数据库迁移与优化等主题，展示了对前沿技术的关注与实践经验的分享；同时，您还介绍了 Markdown 编程语言的潜力、MapStruct 对象映射工具的优势，以及 MCP 在浏览器自动化中的应用等内容，体现了对技术趋势的敏锐洞察。在社会热点方面，您关注了吸毒记录封存法案、历史事件以及社会案件，表达了独到的见解。在个人生活方面，您记录了多次旅行与家庭活动，展现了对自然风光的热爱与家庭生活的温馨。这些文章内容丰富，兼具专业性与生活化，体现了广泛的兴趣与深刻的思考。"</span>
  <span class="hljs-punctuation">}</span>
  <span class="hljs-comment">// ...</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<p>要实现这个任务，我们可以先从一个博客开始，编写提示词看看效果，没问题再让 Copilot 运用到所有博客。</p>
<p>针对单个博客生成年度总结的提示词如下：</p>
<pre><code class="hljs language-text" lang="text">下面是一个博客在 2025 年发布的所有文章，请以「您的博客文章涵盖了...」开始写一段 200 字以内的总结：

{
  "blog": "leileiluoluo.com",
  "articles": [
    "提示工程需要遵循的五个原则（附实践案例）",
    "關於 2026 年即將生效的「吸毒記錄可封存」法案",
    "如何使用 Spec Kit 工具进行规范驱动开发？",
    ...
  ]
}
</code></pre>
<p>可以看到 Copilot 完美的完成了任务。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7c8153ec85c466f9cdb82701e3ad843~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766098188&amp;x-signature=otr5lTGjd381RglJobdoCpqvt0k%3D" alt="使用 Copilot 生成单个博客的年度总结" loading="lazy"/></p>
<p>接下来尝试编写提示词，让 Copilot 运用到所有博客。</p>
<pre><code class="hljs language-text" lang="text">annual-report 文件夹下的 blog-posts.json 文件包含了多个博客在 2025 年的所有文章标题。

您需要针对每个博客在这一年发布的所有文章标题，以「您的博客文章涵盖了...」开始写一段 200 字以内的总结。

最后以 `blog-summary.json` 为文件名，输出一个包含所有博客总结的 JSON 数组，格式如下：

[
  {
    "blog": "leileiluoluo.com",
    "summary": "您的博客文章涵盖了技术开发、社会热点和个人生活等多个领域。在技术方面，您深入探讨了提示工程、规范驱动开发、Spring Boot 框架的应用、数据库迁移与优化等主题，展示了对前沿技术的关注与实践经验的分享；同时，您还介绍了 Markdown 编程语言的潜力、MapStruct 对象映射工具的优势，以及 MCP 在浏览器自动化中的应用等内容，体现了对技术趋势的敏锐洞察。在社会热点方面，您关注了吸毒记录封存法案、历史事件以及社会案件，表达了独到的见解。在个人生活方面，您记录了多次旅行与家庭活动，展现了对自然风光的热爱与家庭生活的温馨。这些文章内容丰富，兼具专业性与生活化，体现了广泛的兴趣与深刻的思考。"
  }
  // ...
]
</code></pre>
<p>上述提示词发出后，Copilot 开始编写 Python 脚本，试图用程序的方式去实现这个批量任务。</p>
<p>但是结果很不理想，其生成的总结非常的单薄。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c880d074a8e4747871511dc00b293bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766098188&amp;x-signature=H25NlgH8CWdbvWkzKXoYYsTLq%2BU%3D" alt="使用 Copilot 批量生成博客的年度总结" loading="lazy"/></p>
<p>究其原因，是因为 Copilot 根本没有调用大模型去生成总结，而是在程序中写了一组关键词，只要文章标题匹配了某些关键词就固定输出一个分类，生成的总结死板，没有活力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a4a3b41336e49f9b67181ae724ddbad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766098188&amp;x-signature=bmH%2FVRMnY%2Ffw%2BS9DQ8Uo5uxNm9Q%3D" alt="使用 Copilot 批量生成博客的年度总结之使用的脚本" loading="lazy"/></p>
<p>看到这里，您不禁要问：Copilot 不知道我们想要的总结是用大模型生成吗？还是有哪些难言之隐？</p>
<p>下面我们尝试使用提示词强制让其使用大模型来生成总结。</p>
<p>提示词发出后，Copilot 修改原先的 Python 脚本，改为调用 OpenAI 来生成总结。但是要使用这个程序我们需要有 OpenAI 账号，即必须提供一个 <code>OPENAI_API_KEY</code> 给 Copilot。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dbf542e747949969d9332d257d8066f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766098188&amp;x-signature=%2FxTz01F3tAF3LqkpOO3ccUgtPl4%3D" alt="使用 Copilot 批量生成博客的年度总结之使用的 OpenAI" loading="lazy"/></p>
<p>看到这里您可能跟我一样有一些迷惑，你 Copilot Chat 中支持的那么多模型直接拿来用不就行了吗？还让我专门开通一个大模型账号？或者，你用笨一点的办法，像获取单个博客的总结一样，自己自动组装提示词发给 Chat，然后取回结果；然后再发出，再取回。帮我完成任务，不行吗？</p>
<p>其实，这个问题恰好触碰到了 Copilot 的难言之隐。因为 Copilot 的确没有将可使用的模型用 REST API 的方式暴露出来，所以它编写的脚本想使用模型时，必须让我们提供一个额外模型的 <code>API_KEY</code>。</p>
<p>这就是我为什么要写本文的缘由。我们需要编写一个 VS Code 扩展，来将 Copilot 中模型的能力通过 REST API 释放出来，供程序去使用。</p>
<h2 data-id="heading-1">2 编写这个 VS Code 扩展</h2>
<p>下面着手编写这个「将 Copilot 大模型暴露为 REST API」的 VS Code 扩展。</p>
<p>开始前，需要保证本地已安装 <code>Node.js</code>。</p>
<h3 data-id="heading-2">2.1 准备工作</h3>
<p>下面安装 <code>yo</code> 命令，该命令用于生成 VC Code 扩展工程的脚手架。</p>
<pre><code class="hljs language-shell" lang="shell">npm install --global yo generator-code
</code></pre>
<p>安装完成后，将 npm 的全局 <code>bin</code> 目录添加到系统环境变量，方便直接使用安装的命令。</p>
<pre><code class="hljs language-shell" lang="shell">echo 'export PATH="$(npm config get prefix)/bin:$PATH"' &gt;&gt; ~/.bashrc
source ~/.bashrc
</code></pre>
<p>下面使用 <code>yo code</code> 命令生成 VS Code 扩展工程 <code>copilot-models-rest-api</code> 的脚手架：</p>
<pre><code class="hljs language-shell" lang="shell">yo code
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1f72824cb1044c894bfff1bcd13c8b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766098188&amp;x-signature=pqQ02bnbElAtwgooMMcGKxOLIMk%3D" alt="生成 VS Code 扩展工程脚手架" loading="lazy"/></p>
<p>可以看到，生成的工程为一个标准的 TypeScript 工程，其调用入口为 <code>src/extension.ts</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b474f7e4a01455bb33a3696dec933f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766098188&amp;x-signature=f98yJwzqmzsnBP71nXevAtqo4S8%3D" alt="生成的 VS Code 扩展工程脚手架" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 编写核心逻辑</h3>
<p>接下来在脚手架工程 <code>copilot-models-rest-api</code> 的 <code>src</code> 目录下编写核心逻辑。</p>
<h4 data-id="heading-4">a）LanguageModelService.ts</h4>
<p>首先，新建一个 <code>LanguageModelService.ts</code> 文件，用于通过 VS Code 内置的 API 获取到 Copilot 的可用大语言模型，然后封装出三个方法供别的 <code>ts</code> 文件调用：</p>
<ul>
<li>
<p><code>getAvailableModels()</code></p>
<p>获取 Copilot 支持的所有大模型名称；</p>
</li>
<li>
<p><code>getModelById()</code></p>
<p>根据大模型名称获取特定大模型对象；</p>
</li>
<li>
<p><code>createChatCompletion()</code></p>
<p>指定想用的大模型，然后传入一段文本，并请求大模型返回结果。</p>
</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> vscode <span class="hljs-keyword">from</span> <span class="hljs-string">"vscode"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatRequest</span>, <span class="hljs-title class_">ChatResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./types"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LanguageModelChat</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"vscode"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LanguageModelService</span> {
  <span class="hljs-comment">// ...</span>

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">getAvailableModels</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>[]&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> models = <span class="hljs-keyword">await</span> vscode.<span class="hljs-property">lm</span>.<span class="hljs-title function_">selectChatModels</span>({
        <span class="hljs-attr">vendor</span>: <span class="hljs-string">"copilot"</span>,
      });

      <span class="hljs-keyword">if</span> (models.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"No Copilot models available"</span>);
        <span class="hljs-keyword">return</span> [];
      }

      <span class="hljs-keyword">return</span> models.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">model</span>) =&gt;</span> model.<span class="hljs-property">id</span>);
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Error fetching models:"</span>, error);
      <span class="hljs-keyword">return</span> [];
    }
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">getModelById</span>(
    modelId?: <span class="hljs-built_in">string</span>
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">LanguageModelChat</span> | <span class="hljs-literal">null</span>&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> models = <span class="hljs-keyword">await</span> vscode.<span class="hljs-property">lm</span>.<span class="hljs-title function_">selectChatModels</span>({
        <span class="hljs-attr">vendor</span>: <span class="hljs-string">"copilot"</span>,
      });
      <span class="hljs-comment">// ...</span>

      <span class="hljs-keyword">const</span> model = models.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">m</span>) =&gt;</span> m.<span class="hljs-property">id</span> === modelId);
      <span class="hljs-keyword">return</span> model || <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Error fetching model by ID:"</span>, error);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">createChatCompletion</span>(<span class="hljs-attr">req</span>: <span class="hljs-title class_">ChatRequest</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ChatResponse</span>&gt; {
    <span class="hljs-keyword">const</span> model = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getModelById</span>(req.<span class="hljs-property">model</span>);
    <span class="hljs-comment">// ...</span>

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> messagePayload = req.<span class="hljs-property">messages</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span>
        vscode.<span class="hljs-property">LanguageModelChatMessage</span>.<span class="hljs-title class_">User</span>(msg)
      );
      <span class="hljs-keyword">const</span> resp = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">sendRequest</span>(
        messagePayload,
        {},
        <span class="hljs-keyword">new</span> vscode.<span class="hljs-title class_">CancellationTokenSource</span>().<span class="hljs-property">token</span>
      );

      <span class="hljs-keyword">let</span> <span class="hljs-attr">fullText</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;
      <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> resp.<span class="hljs-property">text</span>) {
        fullText += chunk;
      }
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">reply</span>: fullText, <span class="hljs-attr">model</span>: model.<span class="hljs-property">id</span> };
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Error creating chat completion:"</span>, error);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">error</span>: <span class="hljs-string">"Error creating chat completion: "</span> + error.<span class="hljs-property">message</span> };
    }
  }
}
</code></pre>
<h4 data-id="heading-5">b）ApiServer.ts</h4>
<p>接下来，使用 <code>ApiServer.ts</code> 包装上述 <code>LanguageModelService</code>，以 RESTful API 方式暴露用户与大模型交互的能力。</p>
<p><code>ApiServer.ts</code> 的代码如下：</p>
<p>可以看到，<code>ApiServer.ts</code> 主要负责接收请求并返回响应。其提供了一个 <code>POST /v1/chat/completions</code> API 来接收用户输入信息，并调用 <code>LanguageModelService</code> 的 <code>createChatCompletion()</code> 的方法来给出回答。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> http <span class="hljs-keyword">from</span> <span class="hljs-string">"http"</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> url <span class="hljs-keyword">from</span> <span class="hljs-string">"url"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LanguageModelService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./languageModelService"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./types"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiServer</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">server</span>: http.<span class="hljs-property">Server</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">port</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">languageModelService</span>: <span class="hljs-title class_">LanguageModelService</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">port: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">port</span> = port;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">languageModelService</span> = <span class="hljs-title class_">LanguageModelService</span>.<span class="hljs-title function_">getInstance</span>();
  }

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleRequest</span>(
    <span class="hljs-attr">req</span>: http.<span class="hljs-property">IncomingMessage</span>,
    <span class="hljs-attr">res</span>: http.<span class="hljs-property">ServerResponse</span>
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">const</span> parsedUrl = url.<span class="hljs-title function_">parse</span>(req.<span class="hljs-property">url</span> || <span class="hljs-string">""</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">const</span> path = parsedUrl.<span class="hljs-property">pathname</span> || <span class="hljs-string">""</span>;

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">"POST"</span>) {
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handlePostRequest</span>(path, req, res);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">405</span>, { <span class="hljs-attr">error</span>: <span class="hljs-string">"Method Not Allowed"</span> });
      }
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"request failed"</span>, error);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">500</span>, { <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span> });
    }
  }

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">handlePostRequest</span>(
    <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>,
    <span class="hljs-attr">req</span>: http.<span class="hljs-property">IncomingMessage</span>,
    <span class="hljs-attr">res</span>: http.<span class="hljs-property">ServerResponse</span>
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">if</span> (path === <span class="hljs-string">"/v1/chat/completions"</span>) {
      <span class="hljs-keyword">const</span> body = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">readRequestBody</span>(req);
      <span class="hljs-keyword">const</span> <span class="hljs-attr">chatRequest</span>: <span class="hljs-title class_">ChatRequest</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(body);
      <span class="hljs-keyword">const</span> chatResponse = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">languageModelService</span>.<span class="hljs-title function_">createChatCompletion</span>(
        chatRequest
      );
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">200</span>, chatResponse);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">404</span>, { <span class="hljs-attr">error</span>: <span class="hljs-string">"Not Found"</span> });
    }
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">start</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">server</span> = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Received request: <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.url}</span>`</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleRequest</span>(req, res);
    });
    <span class="hljs-comment">// ...</span>
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">stop</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<h4 data-id="heading-6">c）extension.ts</h4>
<p>最后，修改 VS Code 扩展的入口文件 <code>extension.ts</code>，将 <code>ApiServer</code> 的启动和停止命令注册到 VS Code。</p>
<p><code>extension.ts</code> 的代码如下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> vscode <span class="hljs-keyword">from</span> <span class="hljs-string">"vscode"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ApiServer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./apiServer"</span>;

<span class="hljs-keyword">let</span> <span class="hljs-attr">apiServer</span>: <span class="hljs-title class_">ApiServer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">activate</span>(<span class="hljs-params">context: vscode.ExtensionContext</span>) {
  <span class="hljs-comment">// start API server command</span>
  vscode.<span class="hljs-property">commands</span>.<span class="hljs-title function_">registerCommand</span>(
    <span class="hljs-string">"copilot-models-rest-api.startServer"</span>,
    <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> port = <span class="hljs-number">3001</span>; <span class="hljs-comment">// You can change the port number if needed</span>
      apiServer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiServer</span>(port);

      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> apiServer.<span class="hljs-title function_">start</span>();
        vscode.<span class="hljs-property">window</span>.<span class="hljs-title function_">showInformationMessage</span>(
          <span class="hljs-string">`API Server started on port <span class="hljs-subst">${port}</span>`</span>
        );
      } <span class="hljs-keyword">catch</span> (error) {
        vscode.<span class="hljs-property">window</span>.<span class="hljs-title function_">showErrorMessage</span>(<span class="hljs-string">"Failed to start API Server"</span>);
      }
    }
  );

  <span class="hljs-comment">// stop API server command</span>
  vscode.<span class="hljs-property">commands</span>.<span class="hljs-title function_">registerCommand</span>(
    <span class="hljs-string">"copilot-models-rest-api.stopServer"</span>,
    <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">if</span> (apiServer) {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">await</span> apiServer.<span class="hljs-title function_">stop</span>();
          vscode.<span class="hljs-property">window</span>.<span class="hljs-title function_">showInformationMessage</span>(<span class="hljs-string">"API Server stopped"</span>);
        } <span class="hljs-keyword">catch</span> (error) {
          vscode.<span class="hljs-property">window</span>.<span class="hljs-title function_">showErrorMessage</span>(<span class="hljs-string">"Failed to stop API Server"</span>);
        }
      } <span class="hljs-keyword">else</span> {
        vscode.<span class="hljs-property">window</span>.<span class="hljs-title function_">showWarningMessage</span>(<span class="hljs-string">"API Server is not running"</span>);
      }
    }
  );
}

<span class="hljs-comment">// This method is called when your extension is deactivated</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">deactivate</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (apiServer) {
    apiServer.<span class="hljs-title function_">stop</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Error stopping API Server:"</span>, error);
    });
  }
}
</code></pre>
<p>至此，我们想要的扩展的源码部分就基本实现完成了。</p>
<h3 data-id="heading-7">2.3 生成 vsix 文件</h3>
<p>最后，使用如下 npm 命令安装依赖和打包。</p>
<pre><code class="hljs language-shell" lang="shell">npm install
npm run package
</code></pre>
<p>使用如下 npm 命令安装 <code>vsce</code> 命令，并使用 <code>vsce</code> 命令来将工程打包为一个 <code>.vsix</code> 文件。</p>
<pre><code class="hljs language-shell" lang="shell">npm install -g @vscode/vsce

vsce package
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ab79186e43c46cf82b18d07c6966e4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766098188&amp;x-signature=32Gj5qa0ANovaCJzNJKj3JbGZVU%3D" alt="生成 vsix 文件" loading="lazy"/></p>
<p>这样，有需要的朋友就可以在 VS Code 安装这个扩展，然后使用我们包装好的 API 了。</p>
<h2 data-id="heading-8">3 使用这个 VS Code 扩展</h2>
<p>下面，我们在 VS Code 安装上面生成的 <code>vsix</code> 扩展，然后尝试重新编写提示词，看看其能否实现文章开头的「批量生成博客年度总结」的需求。</p>
<h3 data-id="heading-9">3.1 安装扩展</h3>
<p>首先，点击 VS Code 左侧的 Extensions Tab，然后点击 Install from VSIX，选择上述 <code>.vsix</code> 文件所在位置，即可安装成功。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5be817688ff485a938aca1ad39a7eb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766098188&amp;x-signature=%2Fu5VmnI0IOc%2B0CYUfNpr1xpLJ18%3D" alt="选择 vsix 文件，安装扩展" loading="lazy"/></p>
<p>扩展安装成功后，在 VS Code 键入「Ctrl + Shift + P」后，点击「Start Copilot Models REST API Server」命令，即可启动 API Server。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c891d37894a41028eb4dc43dcc5bee9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766098188&amp;x-signature=spil93jPv%2BIvnpZXzAsyGoaFrFk%3D" alt="运行扩展" loading="lazy"/></p>
<p>Server 启动成功后，尝试用 Postman 调用一下和模型对话的 API，咨询模型的结果被成功返回。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c47c7924e99b4fac9258ac3e5a460753~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766098188&amp;x-signature=Dh3GqphAKeHurv%2BvOTRfZ9X4fS8%3D" alt="运行扩展" loading="lazy"/></p>
<h3 data-id="heading-10">3.2 使用扩展</h3>
<p>最后，尝试将文章开头「批量生成博客年度总结」的提示词修改如下：</p>
<pre><code class="hljs language-markdown" lang="markdown">annual-report 文件夹下的 blog-posts.json 文件包含了多个博客在 2025 年的所有文章标题。

您需要针对每个博客在这一年发布的所有文章标题，调用如下模型对话 API 来生成一段 200 字以内的总结。

API 地址：http://localhost:3001/v1/chat/completions

调用示例如下：

<span class="hljs-code">```text
POST http://localhost:3001/v1/chat/completions

Request Body:

{
    "model": "gpt-4.1",
    "messages": [
        "如下是一个博客于 2025 年发布的所有文章标题，请基于此生成一个 200 字的总结。总结以「您的博客文章涵盖了...」开始，格式为纯文本格式，若有英文或数字字符，前后请使用空格隔开。",

        "提示工程需要遵循的五个原则（附实践案例）",
        "關於 2026 年即將生效的「吸毒記錄可封存」法案",
        "如何使用 Spec Kit 工具进行规范驱动开发？",
        "Markdown 将成为 AI 时代的通用编程语言？"
    ]
}

Response Body:

{
    "reply": "您的博客文章涵盖了 2025 年技术趋势、开发实践、法律政策、旅行见闻及社会观察等多个领域。技术类内容包括 MCP、 Spring Boot 、 Spring Data 、 MapStruct 、 P6Spy 、 Playwright MCP 、 FastMCP 、 Spec Kit 、 Alibaba DataX 等工具和框架的实用教程，涉及数据库操作、对象映射、事件解耦、服务工厂设计、数据迁移及浏览器自动化等主题，并探讨了 Markdown 在 AI 时代的地位。政策与社会类文章关注「吸毒记录可封存」法案、历史事件及社会热点。生活类内容则记录了 2025 年的假期总结及多地旅行体验，展现了丰富多元的个人视角。",
    "model": "gpt-4.1"
}
```</span>

最后以 <span class="hljs-code">`blog-summary.json`</span> 为文件名，输出一个包含所有博客总结的 JSON 数组，格式如下：

<span class="hljs-code">```json
[
  {
    "blog": "leileiluoluo.com",
    "summary": "您的博客文章涵盖了技术开发、社会热点和个人生活等多个领域。在技术方面，您深入探讨了提示工程、规范驱动开发、Spring Boot 框架的应用、数据库迁移与优化等主题，展示了对前沿技术的关注与实践经验的分享；同时，您还介绍了 Markdown 编程语言的潜力、MapStruct 对象映射工具的优势，以及 MCP 在浏览器自动化中的应用等内容，体现了对技术趋势的敏锐洞察。在社会热点方面，您关注了吸毒记录封存法案、历史事件以及社会案件，表达了独到的见解。在个人生活方面，您记录了多次旅行与家庭活动，展现了对自然风光的热爱与家庭生活的温馨。这些文章内容丰富，兼具专业性与生活化，体现了广泛的兴趣与深刻的思考。"
  }
  // ...
]
```</span>
</code></pre>
<p>最后，Copilot 生成的代码使用了我们提供的 API，并最终生成了符合预期的内容：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08d6d1dc02c7422283a15bd65ebc2bb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766098188&amp;x-signature=CI3QTJlkLdr4ixZf%2BJRtl1g8PfE%3D" alt="生成了符合预期的结果" loading="lazy"/></p>
<h2 data-id="heading-11">4 小结</h2>
<p>综上，本文以实际使用 Copilot「批量生成博客年度总结」时，Copilot 因没有直接可用的模型 API 调用而未能按预期完成任务为由，提出了编写 VS Code 扩展暴露 Copilot 自身可用模型的想法。</p>
<p>经过实践，发现通过编写 VS Code 插件，可以成功获取到 Copilot 的可用模型，并成功与模型实现对话，从而将 Copilot 可用模型暴露为 REST API 变为了现实。</p>
<p>本文完整 VS Code 扩展工程已提交至 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fleileiluoluo%2Fdaily-exercises%2Ftree%2Fmain%2Fcopilot-models-rest-api" target="_blank" title="https://github.com/leileiluoluo/daily-exercises/tree/main/copilot-models-rest-api" ref="nofollow noopener noreferrer">GitHub</a>，欢迎关注、Fork，或获取扩展文件来使用。</p>
<blockquote>
<p>参考资料</p>
<p>[1] Visual Studio Code Extension API: Your First Extension - <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2Fapi%2Fget-started%2Fyour-first-extension" target="_blank" title="https://code.visualstudio.com/api/get-started/your-first-extension" ref="nofollow noopener noreferrer">code.visualstudio.com/api/get-sta…</a></p>
<p>[2] Visual Studio Code Extension API: Language Model API - <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2Fapi%2Fextension-guides%2Fai%2Flanguage-model" target="_blank" title="https://code.visualstudio.com/api/extension-guides/ai/language-model" ref="nofollow noopener noreferrer">code.visualstudio.com/api/extensi…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3项目集成monaco-editor实现浏览器IDE代码编辑功能]]></title>    <link>https://juejin.cn/post/7582438310104629294</link>    <guid>https://juejin.cn/post/7582438310104629294</guid>    <pubDate>2025-12-12T02:32:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582438310104629294" data-draft-id="7582182817109180442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3项目集成monaco-editor实现浏览器IDE代码编辑功能"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-12T02:32:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="答案answer"/> <meta itemprop="url" content="https://juejin.cn/user/2634865719391869"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3项目集成monaco-editor实现浏览器IDE代码编辑功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634865719391869/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    答案answer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T02:32:25.000Z" title="Fri Dec 12 2025 02:32:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>相信大家在做一些低代码平台的项目时，都会涉及到一些在线IDE代码编辑的功能吧，比如通过在线代码编辑后实现在线运行代码效果.</p>
<p>本篇给大家分享一下作者个人在开发低代码平台时如何实现如下图所示的vscode在线代码IDE编辑功能的吧</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd1a33b433dc4dc09851cea5eb648216~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg562U5qGIYW5zd2Vy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766111544&amp;x-signature=2nMWABf4CSsRFsT%2FcVp3ySTHKBY%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">一、安装相关插件</h3>
<pre><code class="hljs language-js" lang="js">pnpm add monaco-editor 
pnpm add monaco-editor-vue3
</code></pre>
<p>因为是在Vue3项目中所以这里直接使用 <em>monaco-editor-vue3</em> 这个插件会更加便捷</p>
<h3 data-id="heading-2">二、新增一个monaco.ts 配置文件（这个很重要）</h3>
<p>在安装完插件后其实我们这样直接在页面中引入就可以使用了，但是这个时候页面其实会有报错的，大概就是提示你<em>monaco-editor</em> 相关配置没有处理</p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height: 400px; width: 800px"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">CodeEditor</span>
      <span class="hljs-attr">v-model:value</span>=<span class="hljs-string">"code"</span>
      <span class="hljs-attr">language</span>=<span class="hljs-string">"javascript"</span>
      <span class="hljs-attr">theme</span>=<span class="hljs-string">"vs-dark"</span>
      <span class="hljs-attr">:height</span>=<span class="hljs-string">"600"</span>
      <span class="hljs-attr">:options</span>=<span class="hljs-string">"editorOptions"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CodeEditor</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'monaco-editor-vue3'</span>;

<span class="hljs-keyword">const</span> code = <span class="hljs-title function_">ref</span>(<span class="hljs-string">`function hello() {
console.log('Hello, Monaco Editor!');
}`</span>);

<span class="hljs-keyword">const</span> editorOptions = {
  <span class="hljs-attr">fontSize</span>: <span class="hljs-number">14</span>,
  <span class="hljs-attr">minimap</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">false</span> },
  <span class="hljs-attr">automaticLayout</span>: <span class="hljs-literal">true</span>,
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>这时候我们需要创建一个 <em>monaco.ts</em> 文件并添加以下配置内容</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> editorWorker <span class="hljs-keyword">from</span> <span class="hljs-string">'monaco-editor/esm/vs/editor/editor.worker?worker'</span>;
<span class="hljs-keyword">import</span> htmlWorker <span class="hljs-keyword">from</span> <span class="hljs-string">'monaco-editor/esm/vs/language/html/html.worker?worker'</span>;
<span class="hljs-keyword">import</span> cssWorker <span class="hljs-keyword">from</span> <span class="hljs-string">'monaco-editor/esm/vs/language/css/css.worker?worker'</span>;
<span class="hljs-keyword">import</span> jsonWorker <span class="hljs-keyword">from</span> <span class="hljs-string">'monaco-editor/esm/vs/language/json/json.worker?worker'</span>;
<span class="hljs-keyword">import</span> tsWorker <span class="hljs-keyword">from</span> <span class="hljs-string">'monaco-editor/esm/vs/language/typescript/ts.worker?worker'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> monaco <span class="hljs-keyword">from</span> <span class="hljs-string">'monaco-editor'</span>;

declare <span class="hljs-variable language_">global</span> {
  interface <span class="hljs-title class_">Window</span> {
    <span class="hljs-title class_">MonacoEnvironment</span>?: {
      <span class="hljs-attr">getWorker</span>: <span class="hljs-function">(<span class="hljs-params">moduleId: string, label: string</span>) =&gt;</span> <span class="hljs-title class_">Worker</span>;
    };
  }
}

(self <span class="hljs-keyword">as</span> <span class="hljs-title class_">Window</span>).<span class="hljs-property">MonacoEnvironment</span> = {
  <span class="hljs-title function_">getWorker</span>(<span class="hljs-params">_: string, label: string</span>) {
    <span class="hljs-keyword">if</span> (label === <span class="hljs-string">'json'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">jsonWorker</span>();
    }
    <span class="hljs-keyword">if</span> (label === <span class="hljs-string">'css'</span> || label === <span class="hljs-string">'scss'</span> || label === <span class="hljs-string">'less'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">cssWorker</span>();
    }
    <span class="hljs-keyword">if</span> (label === <span class="hljs-string">'html'</span> || label === <span class="hljs-string">'handlebars'</span> || label === <span class="hljs-string">'razor'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">htmlWorker</span>();
    }
    <span class="hljs-keyword">if</span> (label === <span class="hljs-string">'typescript'</span> || label === <span class="hljs-string">'javascript'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">tsWorker</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">editorWorker</span>();
  },
};
 
</code></pre>
<p>同时在 <em>main.ts</em>  中引入  <em>monaco.ts</em></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'@/utils/monaco'</span>

type <span class="hljs-title class_">AppInstance</span> = <span class="hljs-title class_">AppType</span>&lt;<span class="hljs-title class_">Element</span>&gt;;

<span class="hljs-keyword">const</span> <span class="hljs-attr">app</span>: <span class="hljs-title class_">AppInstance</span> = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>);
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>);
</code></pre>
<p>界面：ok配置成功后界面内容大概就是这样</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca6a6d3278ad465195cb5c176f033b4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg562U5qGIYW5zd2Vy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766111544&amp;x-signature=MqsHAui5Fod3SKdF7lviFooP70A%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">自定义主题</h3>
<p>如果你觉得编辑器默认的主题样式不太好看也可以自定义主题样式，这里简单的配置一下</p>
<p>依旧在<em>monaco.ts</em>中添加代码</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 定义符合项目系统的自定义主题</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">customTheme</span>: monaco.<span class="hljs-property">editor</span>.<span class="hljs-property">IStandaloneThemeData</span> = {
  <span class="hljs-attr">base</span>: <span class="hljs-string">'vs-dark'</span>, <span class="hljs-comment">// 基于官方暗色主题</span>
  <span class="hljs-attr">inherit</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 继承默认语法高亮规则</span>
  <span class="hljs-attr">rules</span>: [
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'comment'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'617b91'</span>, <span class="hljs-attr">fontStyle</span>: <span class="hljs-string">'italic'</span> }, <span class="hljs-comment">// 注释呈现斜体灰蓝</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'keyword'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'c5cceb'</span>, <span class="hljs-attr">fontStyle</span>: <span class="hljs-string">'bold'</span> }, <span class="hljs-comment">// 关键字加粗淡紫</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'string'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'a9b1d6'</span> }, <span class="hljs-comment">// 字符串淡蓝</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'number'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'c5cceb'</span> }, <span class="hljs-comment">// 数字淡紫</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'operator'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'c7cacf'</span> }, <span class="hljs-comment">// 运算符浅灰</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'delimiter'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'c7cacf'</span> }, <span class="hljs-comment">// 分隔符浅灰</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'type'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'c5cceb'</span> }, <span class="hljs-comment">// 类型标识淡紫</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'class'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'c5cceb'</span> }, <span class="hljs-comment">// 类名淡紫</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'function'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'a9b1d6'</span> }, <span class="hljs-comment">// 函数名淡蓝</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'variable'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'c5cceb'</span> }, <span class="hljs-comment">// 变量名淡紫</span>
  ],
  <span class="hljs-attr">colors</span>: {
    <span class="hljs-string">'editor.background'</span>: <span class="hljs-string">'#252837'</span>, <span class="hljs-comment">// 编辑器背景</span>
    <span class="hljs-string">'editor.foreground'</span>: <span class="hljs-string">'#c5cceb'</span>, <span class="hljs-comment">// 默认前景文字</span>
    <span class="hljs-string">'editor.lineHighlightBackground'</span>: <span class="hljs-string">'#29344c'</span>, <span class="hljs-comment">// 当前行高亮背景</span>
    <span class="hljs-string">'editor.inactiveSelectionBackground'</span>: <span class="hljs-string">'rgba(69, 137, 255, 0.15)'</span>, <span class="hljs-comment">// 未激活选区背景</span>
    <span class="hljs-string">'editorCursor.foreground'</span>: <span class="hljs-string">'#c5cceb'</span>, <span class="hljs-comment">// 光标颜色</span>
    <span class="hljs-string">'editorWhitespace.foreground'</span>: <span class="hljs-string">'#535f79'</span>, <span class="hljs-comment">// 空白字符提示色</span>
    <span class="hljs-string">'editorIndentGuide.background'</span>: <span class="hljs-string">'#535f79'</span>, <span class="hljs-comment">// 缩进指示线</span>
    <span class="hljs-string">'editorIndentGuide.activeBackground'</span>: <span class="hljs-string">'#a9b1d6'</span>, <span class="hljs-comment">// 活动缩进指示线</span>
    <span class="hljs-string">'editorLineNumber.foreground'</span>: <span class="hljs-string">'#617b91'</span>, <span class="hljs-comment">// 行号默认颜色</span>
    <span class="hljs-string">'editorLineNumber.activeForeground'</span>: <span class="hljs-string">'#c5cceb'</span>, <span class="hljs-comment">// 当前行号颜色</span>
    <span class="hljs-string">'editorGutter.background'</span>: <span class="hljs-string">'#252837'</span>, <span class="hljs-comment">// 行号区域背景</span>
    <span class="hljs-string">'editorWidget.background'</span>: <span class="hljs-string">'#29344c'</span>, <span class="hljs-comment">// 弹出组件背景</span>
    <span class="hljs-string">'editorWidget.border'</span>: <span class="hljs-string">'#535f79'</span>, <span class="hljs-comment">// 弹出组件边框</span>
    <span class="hljs-string">'editorSuggestWidget.background'</span>: <span class="hljs-string">'#29344c'</span>, <span class="hljs-comment">// 智能提示背景</span>
    <span class="hljs-string">'editorSuggestWidget.border'</span>: <span class="hljs-string">'#535f79'</span>, <span class="hljs-comment">// 智能提示边框</span>
  },
};

<span class="hljs-comment">// 注册自定义主题</span>
monaco.<span class="hljs-property">editor</span>.<span class="hljs-title function_">defineTheme</span>(<span class="hljs-string">'custom-dark'</span>, customTheme);
</code></pre>
<p>界面效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b35ffce6702c462fab6bb45c0bdaafa5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg562U5qGIYW5zd2Vy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766111544&amp;x-signature=6lYfN9mafa1AlN0u0RmwgWvaIrA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">monaco.ts 完整的配置</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> editorWorker <span class="hljs-keyword">from</span> <span class="hljs-string">'monaco-editor/esm/vs/editor/editor.worker?worker'</span>;
<span class="hljs-keyword">import</span> htmlWorker <span class="hljs-keyword">from</span> <span class="hljs-string">'monaco-editor/esm/vs/language/html/html.worker?worker'</span>;
<span class="hljs-keyword">import</span> cssWorker <span class="hljs-keyword">from</span> <span class="hljs-string">'monaco-editor/esm/vs/language/css/css.worker?worker'</span>;
<span class="hljs-keyword">import</span> jsonWorker <span class="hljs-keyword">from</span> <span class="hljs-string">'monaco-editor/esm/vs/language/json/json.worker?worker'</span>;
<span class="hljs-keyword">import</span> tsWorker <span class="hljs-keyword">from</span> <span class="hljs-string">'monaco-editor/esm/vs/language/typescript/ts.worker?worker'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> monaco <span class="hljs-keyword">from</span> <span class="hljs-string">'monaco-editor'</span>;
declare <span class="hljs-variable language_">global</span> {
  interface <span class="hljs-title class_">Window</span> {
    <span class="hljs-title class_">MonacoEnvironment</span>?: {
      <span class="hljs-attr">getWorker</span>: <span class="hljs-function">(<span class="hljs-params">moduleId: string, label: string</span>) =&gt;</span> <span class="hljs-title class_">Worker</span>;
    };
  }
}
(self <span class="hljs-keyword">as</span> <span class="hljs-title class_">Window</span>).<span class="hljs-property">MonacoEnvironment</span> = {
  <span class="hljs-title function_">getWorker</span>(<span class="hljs-params">_: string, label: string</span>) {
    <span class="hljs-keyword">if</span> (label === <span class="hljs-string">'json'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">jsonWorker</span>();
    }
    <span class="hljs-keyword">if</span> (label === <span class="hljs-string">'css'</span> || label === <span class="hljs-string">'scss'</span> || label === <span class="hljs-string">'less'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">cssWorker</span>();
    }
    <span class="hljs-keyword">if</span> (label === <span class="hljs-string">'html'</span> || label === <span class="hljs-string">'handlebars'</span> || label === <span class="hljs-string">'razor'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">htmlWorker</span>();
    }
    <span class="hljs-keyword">if</span> (label === <span class="hljs-string">'typescript'</span> || label === <span class="hljs-string">'javascript'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">tsWorker</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">editorWorker</span>();
  },
};
<span class="hljs-comment">// 定义符合项目系统的自定义主题</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">customTheme</span>: monaco.<span class="hljs-property">editor</span>.<span class="hljs-property">IStandaloneThemeData</span> = {
  <span class="hljs-attr">base</span>: <span class="hljs-string">'vs-dark'</span>, <span class="hljs-comment">// 基于官方暗色主题</span>
  <span class="hljs-attr">inherit</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 继承默认语法高亮规则</span>
  <span class="hljs-attr">rules</span>: [
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'comment'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'617b91'</span>, <span class="hljs-attr">fontStyle</span>: <span class="hljs-string">'italic'</span> }, <span class="hljs-comment">// 注释呈现斜体灰蓝</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'keyword'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'c5cceb'</span>, <span class="hljs-attr">fontStyle</span>: <span class="hljs-string">'bold'</span> }, <span class="hljs-comment">// 关键字加粗淡紫</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'string'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'a9b1d6'</span> }, <span class="hljs-comment">// 字符串淡蓝</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'number'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'c5cceb'</span> }, <span class="hljs-comment">// 数字淡紫</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'operator'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'c7cacf'</span> }, <span class="hljs-comment">// 运算符浅灰</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'delimiter'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'c7cacf'</span> }, <span class="hljs-comment">// 分隔符浅灰</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'type'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'c5cceb'</span> }, <span class="hljs-comment">// 类型标识淡紫</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'class'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'c5cceb'</span> }, <span class="hljs-comment">// 类名淡紫</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'function'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'a9b1d6'</span> }, <span class="hljs-comment">// 函数名淡蓝</span>
    { <span class="hljs-attr">token</span>: <span class="hljs-string">'variable'</span>, <span class="hljs-attr">foreground</span>: <span class="hljs-string">'c5cceb'</span> }, <span class="hljs-comment">// 变量名淡紫</span>
  ],
  <span class="hljs-attr">colors</span>: {
    <span class="hljs-string">'editor.background'</span>: <span class="hljs-string">'#252837'</span>, <span class="hljs-comment">// 编辑器背景</span>
    <span class="hljs-string">'editor.foreground'</span>: <span class="hljs-string">'#c5cceb'</span>, <span class="hljs-comment">// 默认前景文字</span>
    <span class="hljs-string">'editor.lineHighlightBackground'</span>: <span class="hljs-string">'#29344c'</span>, <span class="hljs-comment">// 当前行高亮背景</span>
    <span class="hljs-string">'editor.inactiveSelectionBackground'</span>: <span class="hljs-string">'rgba(69, 137, 255, 0.15)'</span>, <span class="hljs-comment">// 未激活选区背景</span>
    <span class="hljs-string">'editorCursor.foreground'</span>: <span class="hljs-string">'#c5cceb'</span>, <span class="hljs-comment">// 光标颜色</span>
    <span class="hljs-string">'editorWhitespace.foreground'</span>: <span class="hljs-string">'#535f79'</span>, <span class="hljs-comment">// 空白字符提示色</span>
    <span class="hljs-string">'editorIndentGuide.background'</span>: <span class="hljs-string">'#535f79'</span>, <span class="hljs-comment">// 缩进指示线</span>
    <span class="hljs-string">'editorIndentGuide.activeBackground'</span>: <span class="hljs-string">'#a9b1d6'</span>, <span class="hljs-comment">// 活动缩进指示线</span>
    <span class="hljs-string">'editorLineNumber.foreground'</span>: <span class="hljs-string">'#617b91'</span>, <span class="hljs-comment">// 行号默认颜色</span>
    <span class="hljs-string">'editorLineNumber.activeForeground'</span>: <span class="hljs-string">'#c5cceb'</span>, <span class="hljs-comment">// 当前行号颜色</span>
    <span class="hljs-string">'editorGutter.background'</span>: <span class="hljs-string">'#252837'</span>, <span class="hljs-comment">// 行号区域背景</span>
    <span class="hljs-string">'editorWidget.background'</span>: <span class="hljs-string">'#29344c'</span>, <span class="hljs-comment">// 弹出组件背景</span>
    <span class="hljs-string">'editorWidget.border'</span>: <span class="hljs-string">'#535f79'</span>, <span class="hljs-comment">// 弹出组件边框</span>
    <span class="hljs-string">'editorSuggestWidget.background'</span>: <span class="hljs-string">'#29344c'</span>, <span class="hljs-comment">// 智能提示背景</span>
    <span class="hljs-string">'editorSuggestWidget.border'</span>: <span class="hljs-string">'#535f79'</span>, <span class="hljs-comment">// 智能提示边框</span>
  },
};
<span class="hljs-comment">// 注册自定义主题</span>
monaco.<span class="hljs-property">editor</span>.<span class="hljs-title function_">defineTheme</span>(<span class="hljs-string">'custom-dark'</span>, customTheme);
</code></pre>
<h2 data-id="heading-5">总结</h2>
<p>以上就是作者个人在Vue3项目中集成 monaco.editor 的过程</p>
<p>总体来说也是非常的简单</p>
<p>大概就是分三步流程实现</p>
<p>1.安装 <em>monaco-editor</em> 和 <em>monaco-editor-vue3</em> 插件</p>
<p>2.新增和引入 <em>monaco.ts</em> 文件</p>
<p>3.在页面中使用 <em>CodeEditor</em></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fmonaco-editor" target="_blank" title="https://github.com/microsoft/monaco-editor" ref="nofollow noopener noreferrer">github.com/microsoft/m…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbazingaedward%2Fmonaco-editor-vue3" target="_blank" title="https://github.com/bazingaedward/monaco-editor-vue3" ref="nofollow noopener noreferrer">github.com/bazingaedwa…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：基于 Ent 从零实现新服务]]></title>    <link>https://juejin.cn/post/7582763878674579483</link>    <guid>https://juejin.cn/post/7582763878674579483</guid>    <pubDate>2025-12-12T09:10:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582763878674579483" data-draft-id="7582777037863338034" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：基于 Ent 从零实现新服务"/> <meta itemprop="keywords" content="后端,Go,ORM"/> <meta itemprop="datePublished" content="2025-12-12T09:10:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：基于 Ent 从零实现新服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:10:11.000Z" title="Fri Dec 12 2025 09:10:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：基于 Ent 从零实现新服务</h2>
<p>本文将指导开发者在 GoWind Admin 企业级前后端一体中后台框架中，从零开始构建一个完整的 gRPC 服务。我们所指的 “服务” 即 gRPC 中的 service，通常包含特定数据集的 CRUD（增删改查）操作，遵循框架规范实现高可维护性与可扩展性。</p>
<h3 data-id="heading-1">前置准备</h3>
<p>在开始前，请确保已完成以下环境准备：</p>
<h4 data-id="heading-2">开发环境</h4>
<ul>
<li>Go 1.19+（推荐 1.21+，支持最新语言特性）</li>
<li>Git（版本控制）</li>
<li>Protobuf 编译器（<code>protoc</code>，用于编译 proto 文件）</li>
</ul>
<h4 data-id="heading-3">依赖工具</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装相关的命令行工具</span>
make cli

<span class="hljs-comment"># 安装依赖的插件</span>
make plugin
</code></pre>
<h4 data-id="heading-4">项目结构</h4>
<p>克隆 GoWind Admin 项目后，核心目录结构如下（聚焦服务开发相关目录）：</p>
<pre><code class="hljs language-text" lang="text">go-wind-admin/
├── backend/
│   ├── api/gen/go/        # proto 编译生成的 Go 代码（自动生成，无需手动修改）
│   ├── api/proto/         # 存放 proto 接口定义文件
│   ├── app/admin/service/ # 业务服务核心实现
│   │   ├── internal/
│   │   │   ├── data/      # 数据访问层（与数据库交互，基于 ent）
│   │   │   │   └── ent/   # ent ORM 自动生成的数据库操作代码
│   │   │   └── service/   # 业务逻辑层（实现 gRPC 接口）
│   │   └── server/        # 服务注册（将服务绑定到 gRPC/HTTP 服务器）
</code></pre>
<h3 data-id="heading-5">一、设计数据库表结构</h3>
<p>数据库表结构是服务的基础，需根据业务需求设计核心字段。以 “用户表” 为例，需包含：</p>
<ul>
<li>通用字段：ID（主键）、创建时间、更新时间、创建者 ID、更新者 ID（用于审计）</li>
<li>业务字段：用户名（唯一）、密码、昵称、邮箱、手机号等</li>
<li>关联字段：角色 ID、部门 ID 等（用于关联其他表）</li>
<li>状态字段：用户状态（启用 / 禁用）、性别等枚举字段</li>
</ul>
<p><strong>设计原则：</strong></p>
<ul>
<li>核心字段非空（如用户名），非核心字段可空（如地址）</li>
<li>频繁查询的字段添加索引（如用户名）</li>
<li>敏感字段（如密码）需加密存储</li>
</ul>
<h3 data-id="heading-6">二、编写 ent 的 schema</h3>
<p>Ent 是 Go 语言的 ORM 库，通过 schema 定义数据库实体。schema 文件位于 <code>backend/app/admin/service/internal/data/ent/schema</code> 目录。</p>
<p>步骤说明：</p>
<ol>
<li>创建 <code>user.go</code> 文件，定义 Us`er 结构体及其配置。</li>
<li>通过 <code>Annotations</code> 配置表名、字符集等数据库属性。</li>
<li>通过 <code>Fields</code> 定义表字段，包括类型、约束（唯一、非空等）、注释。</li>
<li>通过 <code>Mixin</code> 复用通用字段（如 ID、时间戳），减少重复代码。</li>
<li>通过 <code>Indexes</code> 定义索引，提升查询性能。</li>
</ol>
<h4 data-id="heading-7">关键代码解析：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Annotations 配置表基本信息</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(User)</span></span> Annotations() []schema.Annotation {
    <span class="hljs-keyword">return</span> []schema.Annotation{
        entsql.Annotation{
            Table:     <span class="hljs-string">"sys_users"</span>, <span class="hljs-comment">// 数据库表名</span>
            Charset:   <span class="hljs-string">"utf8mb4"</span>,   <span class="hljs-comment">// 字符集</span>
            Collation: <span class="hljs-string">"utf8mb4_bin"</span>, <span class="hljs-comment">// 排序规则</span>
        },
        schema.Comment(<span class="hljs-string">"用户表"</span>), <span class="hljs-comment">// 表注释</span>
    }
}

<span class="hljs-comment">// Fields 定义表字段</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(User)</span></span> Fields() []ent.Field {
    <span class="hljs-keyword">return</span> []ent.Field{
        field.String(<span class="hljs-string">"username"</span>).
            Comment(<span class="hljs-string">"用户名"</span>).
            Unique().       <span class="hljs-comment">// 唯一索引</span>
            NotEmpty().     <span class="hljs-comment">// 非空</span>
            Immutable(),    <span class="hljs-comment">// 创建后不可修改</span>

        field.String(<span class="hljs-string">"password"</span>).
            Comment(<span class="hljs-string">"登录密码"</span>).
            MaxLen(<span class="hljs-number">255</span>).    <span class="hljs-comment">// 最大长度</span>
            Sensitive(),    <span class="hljs-comment">// 敏感字段（日志中隐藏）</span>

        <span class="hljs-comment">// 其他字段...</span>
    }
}

<span class="hljs-comment">// Mixin 复用通用配置</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(User)</span></span> Mixin() []ent.Mixin {
    <span class="hljs-keyword">return</span> []ent.Mixin{
        mixin.AutoIncrementId{}, <span class="hljs-comment">// 自增 ID</span>
        mixin.TimeAt{},          <span class="hljs-comment">// 创建时间、更新时间</span>
        mixin.OperatorID{},      <span class="hljs-comment">// 创建者、更新者 ID</span>
    }
}
</code></pre>
<h4 data-id="heading-8">生成 ent 代码：</h4>
<p>编写完 schema 后，执行以下命令生成实体代码：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> backend/app/admin/service/
make ent
</code></pre>
<h3 data-id="heading-9">三、编写 gRPC 的 proto 文件</h3>
<p>Protobuf（proto）用于定义 gRPC 服务接口和数据结构，是服务对外暴露的 “契约”。proto 文件通常位于 <code>backend/api/proto/user/service/v1</code> 目录。</p>
<h4 data-id="heading-10">步骤说明：</h4>
<ol>
<li>定义服务接口（<code>service UserService</code>），包含 CRUD 方法（如 <code>CreateUser</code>、<code>ListUser</code>）。</li>
<li>定义请求 / 响应消息（message），映射数据库字段和业务需求。</li>
<li>定义枚举（enum），如用户状态、性别等固定值类型。</li>
</ol>
<h4 data-id="heading-11">关键代码解析：</h4>
<pre><code class="hljs language-protobuf" lang="protobuf">// backend/api/proto/user/service/v1/user.proto

// 定义服务接口
service UserService {
  rpc ListUser (pagination.PagingRequest) returns (ListUserResponse); // 列表查询
  rpc GetUser (GetUserRequest) returns (User);                        // 详情查询
  rpc CreateUser (CreateUserRequest) returns (google.protobuf.Empty); // 创建
  rpc UpdateUser (UpdateUserRequest) returns (google.protobuf.Empty); // 更新
  rpc DeleteUser (DeleteUserRequest) returns (google.protobuf.Empty); // 删除
}

// 枚举定义（用户状态）
enum UserStatus {
  OFF = 0; // 禁用
  ON = 1;  // 启用
}

// 数据模型（与数据库表对应）
message User {
  optional uint32 id = 1 [json_name = "id"]; // 用户ID
  optional string username = 2;              // 用户名
  optional UserStatus status = 3;            // 状态
  // 其他字段...
}
</code></pre>
<h4 data-id="heading-12">生成 Go 代码：</h4>
<p>执行以下命令将 proto 转换为 Go 代码（生成的代码位于 <code>backend/api/gen/go</code> 目录）：</p>
<pre><code class="hljs language-bash" lang="bash">make api
</code></pre>
<h3 data-id="heading-13">四、编写 REST 的 proto 文件</h3>
<p>Protobuf（proto）用于定义 REST 服务接口和数据结构，是服务对外暴露的 “契约”。proto 文件通常位于 <code>backend/api/proto/admin/service/v1</code> 目录。</p>
<h4 data-id="heading-14">关键代码解析：</h4>
<pre><code class="hljs language-protobuf" lang="protobuf">// backend/api/proto/admin/service/v1/i_user.proto

import "user/service/v1/user.proto";

// 用户管理服务
service UserService {
  // 获取用户列表
  rpc List (pagination.PagingRequest) returns (user.service.v1.ListUserResponse) {
    option (redact.v3.internal_method) = true;
    option (google.api.http) = {
      get: "/admin/v1/users"
    };
  }

  // 获取用户数据
  rpc Get (user.service.v1.GetUserRequest) returns (user.service.v1.User) {
    option (redact.v3.internal_method) = true;
    option (google.api.http) = {
      get: "/admin/v1/users/{id}"
      additional_bindings {
        get: "/admin/v1/users/username/{user_name}"
      }
    };
  }

  // 创建用户
  rpc Create (user.service.v1.CreateUserRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/admin/v1/users"
      body: "*"
    };
  }

  // 更新用户
  rpc Update (user.service.v1.UpdateUserRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      put: "/admin/v1/users/{id}"
      body: "*"
    };
  }

  // 删除用户
  rpc Delete (user.service.v1.DeleteUserRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/admin/v1/users/{id}"
    };
  }
}

// 枚举定义（用户状态）
enum UserStatus {
  OFF = 0; // 禁用
  ON = 1;  // 启用
}

// 数据模型（与数据库表对应）
message User {
  optional uint32 id = 1 [json_name = "id"]; // 用户ID
  optional string username = 2;              // 用户名
  optional UserStatus status = 3;            // 状态
  // 其他字段...
}
</code></pre>
<h4 data-id="heading-15">生成代码：</h4>
<p>执行以下命令将 proto 转换为 Go 代码（生成的代码位于 <code>backend/api/gen/go</code> 目录）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成go代码</span>
make api
</code></pre>
<p>执行以下命令将 proto 转换为 OpenAPI文档（生成的文档位于<code>backend/app/admin/service/cmd/server/assets/</code>目录）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成OpenAPI文档</span>
make openapi
</code></pre>
<p>执行以下命令将 proto 转换为 TypeScript代码（生成的代码位于<code>frontend/apps/admin/src/generated/api</code>目录）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成TypeScript代码</span>
make ts
</code></pre>
<h3 data-id="heading-16">五、编写 data 包（数据访问层）</h3>
<p><code>data</code> 包负责与数据库交互，实现 CRUD 操作，是业务逻辑与数据库之间的桥梁。代码位于 <code>backend/app/admin/service/internal/data</code> 目录。</p>
<h4 data-id="heading-17">核心职责：</h4>
<ul>
<li>封装 ent 的数据库操作（查询、插入、更新、删除）。</li>
<li>实现 ent 实体与 proto 消息的转换（如 <code>convertEntToProto</code>）。</li>
<li>处理数据访问过程中的错误（如记录日志、返回业务错误）。</li>
</ul>
<h4 data-id="heading-18">关键代码解析：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> data

<span class="hljs-keyword">type</span> UserRepo <span class="hljs-keyword">struct</span> {
	data *Data
	log  *log.Helper

	mapper             *mapper.CopierMapper[userV1.User, ent.User]
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserRepo</span><span class="hljs-params">(logger log.Logger, data *Data)</span></span> *UserRepo {
	repo := &amp;UserRepo{
		log:                log.NewHelper(log.With(logger, <span class="hljs-string">"module"</span>, <span class="hljs-string">"user/repo/admin-service"</span>)),
		data:               data,
		mapper:             mapper.NewCopierMapper[userV1.User, ent.User](),
	}

	<span class="hljs-keyword">return</span> repo
}

<span class="hljs-comment">// 创建用户</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *UserRepo)</span></span> CreateUser(ctx context.Context, req *userV1.CreateUserRequest) <span class="hljs-type">error</span> {
	<span class="hljs-keyword">if</span> req == <span class="hljs-literal">nil</span> || req.Data == <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, userV1.ErrorBadRequest(<span class="hljs-string">"invalid parameter"</span>)
	}

	<span class="hljs-keyword">if</span> req.Data.Password != <span class="hljs-literal">nil</span> &amp;&amp; req.Data.GetPassword() != <span class="hljs-string">""</span> {
		cryptoPassword, err := crypto.HashPassword(req.Data.GetPassword())
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
		}
		req.Data.Password = &amp;cryptoPassword
	}

    <span class="hljs-comment">// 调用 ent 插入数据</span>
    <span class="hljs-keyword">return</span> r.data.db.Client().User.Create().
        SetUsername(req.Data.Username).
        SetPassword(req.Data.GetPassword()).
        <span class="hljs-comment">// 设置其他字段...</span>
        Exec(ctx)
}
</code></pre>
<h3 data-id="heading-19">六、编写 service 包（业务逻辑层）</h3>
<p>service 包实现核心业务逻辑，调用 data 包进行数据操作，并处理权限校验、参数校验等业务规则。代码位于 <code>backend/app/admin/service/internal/service</code> 目录。</p>
<h4 data-id="heading-20">核心职责：</h4>
<ul>
<li>校验请求参数合法性（如非空检查）。</li>
<li>实现业务规则（如 “禁止删除超级管理员”）。</li>
<li>调用 data 包完成数据操作，并返回结果。</li>
</ul>
<h4 data-id="heading-21">关键代码解析：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 创建用户（包含权限校验）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span></span> CreateUser(ctx context.Context, req *userV1.CreateUserRequest) (*emptypb.Empty, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 参数校验</span>
    <span class="hljs-keyword">if</span> req.Data == <span class="hljs-literal">nil</span> || req.Data.Username == <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"用户名不能为空"</span>)
    }

    <span class="hljs-comment">// 权限校验：只有管理员能创建用户</span>
    operator, err := s.userRepo.GetUser(ctx, req.OperatorId)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || operator.Authority != userV1.UserAuthority_SYS_ADMIN {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"权限不足"</span>)
    }

    <span class="hljs-comment">// 调用 data 包创建用户</span>
    <span class="hljs-keyword">return</span> &amp;emptypb.Empty{}, s.userRepo.CreateUser(ctx, req)
}
</code></pre>
<h3 data-id="heading-22">七、注册服务到 Server</h3>
<p>最后需将服务注册到 gRPC 或 REST 服务器，使客户端能访问服务。注册代码位于 <code>backend/app/admin/service/server</code> 目录。</p>
<h4 data-id="heading-23">gRPC 服务注册：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> (
	<span class="hljs-string">"github.com/go-kratos/kratos/v2/transport/grpc"</span>
)

<span class="hljs-comment">// 注册 gRPC 服务</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewGRPCServer</span><span class="hljs-params">(cfg *conf.Bootstrap, userSvc *service.UserService)</span></span> *grpc.Server {
    srv := grpc.NewServer()

    <span class="hljs-comment">// 将 UserService 注册到 gRPC 服务器</span>
    userV1.RegisterUserServiceServer(srv, userSvc)

    <span class="hljs-keyword">return</span> srv
}
</code></pre>
<h4 data-id="heading-24">REST 服务注册：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> (
	<span class="hljs-string">"github.com/go-kratos/kratos/v2/transport/http"</span>
)

<span class="hljs-comment">// 注册 REST 服务</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewRESTServer</span><span class="hljs-params">(cfg *conf.Bootstrap, userSvc *service.UserService)</span></span> *http.Server {
	<span class="hljs-keyword">if</span> cfg == <span class="hljs-literal">nil</span> || cfg.Server == <span class="hljs-literal">nil</span> || cfg.Server.Rest == <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	}

	srv := rpc.CreateRestServer(cfg)
   
	<span class="hljs-comment">// 将 UserService 注册到 REST 服务器</span>
	adminV1.RegisterUserServiceHTTPServer(srv, userSvc)

	<span class="hljs-keyword">return</span> srv
}
</code></pre>
<h3 data-id="heading-25">八、测试新服务</h3>
<p>服务开发完成后，需验证功能正确性：</p>
<h4 data-id="heading-26">1. <strong>单元测试：</strong></h4>
<p>测试 data 包和 service 包的核心方法（使用 Go 内置测试框架）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/app/admin/service/internal/service/user_service_test.go</span>
<span class="hljs-keyword">package</span> service_test

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"testing"</span>

    <span class="hljs-string">"github.com/stretchr/testify/assert"</span>
    userV1 <span class="hljs-string">"go-wind-admin/api/gen/go/admin/service/v1"</span>
    <span class="hljs-string">"go-wind-admin/app/admin/service/internal/service"</span>
    <span class="hljs-string">"go-wind-admin/mocks"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestCreateUser</span><span class="hljs-params">(t *testing.T)</span></span> {
    <span class="hljs-comment">// 初始化 mock 依赖</span>
    mockUserRepo := mocks.NewUserRepo(t)
    svc := service.NewUserService(mockUserRepo, <span class="hljs-literal">nil</span>)

    <span class="hljs-comment">// 测试用例：用户名空</span>
    req := &amp;userV1.CreateUserRequest{Password: <span class="hljs-string">"12345678"</span>}
    _, err := svc.CreateUser(context.Background(), req)
    assert.ErrorContains(t, err, <span class="hljs-string">"用户名不能为空"</span>)

    <span class="hljs-comment">// 其他测试用例...</span>
}
</code></pre>
<h4 data-id="heading-27">2. <strong>接口测试：</strong></h4>
<h5 data-id="heading-28">gRPC 接口</h5>
<p>使用 <code>grpcurl</code> 调用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出服务接口</span>
grpcurl -plaintext localhost:9000 list admin.service.v1.UserService

<span class="hljs-comment"># 调用创建用户接口</span>
grpcurl -plaintext -d <span class="hljs-string">'{"username":"test","password":"12345678"}'</span> \
  localhost:9000 admin.service.v1.UserService/CreateUser
</code></pre>
<h5 data-id="heading-29">HTTP 接口</h5>
<p>使用 curl 或 Postman 调用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建用户</span>
curl -X POST http://localhost:8080/admin/v1/users \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"username":"test","password":"12345678"}'</span>
</code></pre>
<h3 data-id="heading-30">总结</h3>
<p>通过以上步骤，我们完成了一个新服务从数据库设计到接口暴露的全流程实现。GoWind Admin 框架的分层架构（schema → data → service → server）确保了代码的低耦合与高可维护性：</p>
<ul>
<li><strong>schema 层</strong>：通过 ent 定义数据结构，自动生成数据库操作代码。</li>
<li><strong>data 层</strong>：封装数据库交互，隔离业务逻辑与数据访问。</li>
<li><strong>service 层</strong>：聚焦业务规则，与数据层解耦。</li>
<li><strong>server 层</strong>：统一注册服务，简化部署与扩展。</li>
</ul>
<p>遵循此流程，开发者可快速在框架中扩展新服务，充分利用框架提供的工具链（ent、Protobuf、gRPC）提升开发效率。</p>
<h3 data-id="heading-31">项目代码</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://gitee.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">go-wind-admin Gitee</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://github.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">go-wind-admin Github</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型 MoE,你明白了么？]]></title>    <link>https://juejin.cn/post/7582424649783705600</link>    <guid>https://juejin.cn/post/7582424649783705600</guid>    <pubDate>2025-12-11T16:44:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582424649783705600" data-draft-id="7582358932028899343" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型 MoE,你明白了么？ "/> <meta itemprop="keywords" content="人工智能,LLM"/> <meta itemprop="datePublished" content="2025-12-11T16:44:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吴佳浩"/> <meta itemprop="url" content="https://juejin.cn/user/2696441245481975"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型 MoE,你明白了么？ 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2696441245481975/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吴佳浩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T16:44:25.000Z" title="Thu Dec 11 2025 16:44:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-estuary-dark">.hljs-comment,.hljs-quote{color:#878573}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ba6236}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#ae7313}.hljs-bullet,.hljs-string,.hljs-symbol{color:#7d9726}.hljs-section,.hljs-title{color:#36a166}.hljs-keyword,.hljs-selector-tag{color:#5f9182}.hljs-addition,.hljs-deletion{color:#22221b;display:inline-block;width:100%}.hljs-deletion{background-color:#ba6236}.hljs-addition{background-color:#7d9726}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#22221b;color:#929181}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">大模型 MoE,你明白了么？</h2>
<blockquote>
<p>最近被T4卡搞得有点抽风就多些一点关于大模型的讲解的。由浅至深的讲个透，愿天下用老旧显卡的人儿都可以远离傻*问题。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e53064d7b28447568f9ce11ce5ee2bec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766076341&amp;x-signature=xwaGFHtHHls3TOo8vvj%2B11FnIPU%3D" alt="image.png" loading="lazy"/></p>
<p><strong>作者：吴佳浩</strong></p>
<p><strong>最后更新：2025-12-11</strong></p>
<p><strong>适用人群：大模型上下游相关从业者</strong></p>
<p><strong>——以 Qwen2/Qwen3 为例，从入门到回家</strong></p>
<hr/>
<h3 data-id="heading-1">1. 什么是 MoE（Mixture of Experts）</h3>
<h4 data-id="heading-2">核心概念</h4>
<p><strong>MoE = 混合专家模型</strong>，它让模型由多个"专家网络"组成，每次推理只激活少量专家，从而实现：</p>
<ul>
<li>✅ <strong>保留大模型能力</strong> - 总参数量大，能力强</li>
<li>✅ <strong>降低推理成本</strong> - 只激活部分参数，计算量小</li>
<li>✅ <strong>提升领域能力</strong> - 专家各司其职，术业有专攻</li>
</ul>
<h4 data-id="heading-3">核心理念</h4>
<blockquote>
<p>💡 不需要每个 token 都用 300 亿参数计算，而是只调用其中最适合解决该问题的专家。</p>
</blockquote>
<p>这就像一个医院：</p>
<ul>
<li>你头疼不需要召集所有科室医生</li>
<li>只需要神经科专家诊断</li>
<li>但医院仍然拥有全科能力</li>
</ul>
<h4 data-id="heading-4">为什么需要 MoE？</h4>
<p>Dense 模型的问题：</p>















<table><thead><tr><th>参数量</th><th>推理需要激活</th><th>显存需求</th></tr></thead><tbody><tr><td>70B</td><td>全 70B</td><td>极高（&gt;140GB FP16）</td></tr></tbody></table>
<p>MoE 的改进：</p>















<table><thead><tr><th>总参数量</th><th>每次激活</th><th>实际推理成本</th></tr></thead><tbody><tr><td>70B（含16个专家）</td><td>Top-1=3B</td><td>像跑 3B 模型一样 cheap</td></tr></tbody></table>
<p><strong>核心思想：选对专家，而不是计算全部专家。</strong></p>
<hr/>
<h3 data-id="heading-5">2. MoE 架构全景</h3>
<h4 data-id="heading-6">2.1 基础架构流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[输入 Token:&lt;br/&gt;写一段 Python 代码] --&gt; B{Router 路由器&lt;br/&gt;分析 token 特征}

    B --&gt;|权重 0.8| C1[Expert 1&lt;br/&gt;代码专家]
    B --&gt;|权重 0.2| C2[Expert 5&lt;br/&gt;逻辑专家]

    B -.不激活.-&gt; C3[Expert 2]
    B -.不激活.-&gt; C4[Expert 3]
    B -.不激活.-&gt; C5[Expert 4]

    C1 --&gt; D[加权合并输出]
    C2 --&gt; D
    D --&gt; E[最终输出]

    style B fill:#FFD700
    style C1 fill:#90EE90
    style C2 fill:#90EE90
    style C3 fill:#E0E0E0
    style C4 fill:#E0E0E0
    style C5 fill:#E0E0E0
</code></pre>
<p><strong>关键要素解释：</strong></p>
<ol>
<li><strong>Router（路由器）</strong> - 根据输入内容选择最适合的专家（Top-1 / Top-2）</li>
<li><strong>Experts（专家）</strong> - 每个都是独立的 FFN 网络，拥有专属参数</li>
<li><strong>选择性激活</strong> - 只激活部分专家，其余专家在当前 token 不参与运算</li>
<li><strong>加权合并</strong> - 将激活专家的输出按权重求和</li>
</ol>
<hr/>
<h4 data-id="heading-7">2.2 完整 Transformer 层结构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph "传统 Transformer 层"
        A1[Input] --&gt; A2[Multi-Head Attention]
        A2 --&gt; A3[Add &amp; Norm]
        A3 --&gt; A4[Dense FFN&lt;br/&gt;所有参数激活]
        A4 --&gt; A5[Add &amp; Norm]
        A5 --&gt; A6[Output]
    end
    
    subgraph "MoE Transformer 层"
        B1[Input] --&gt; B2[Multi-Head Attention]
        B2 --&gt; B3[Add &amp; Norm]
        B3 --&gt; B4{MoE Layer&lt;br/&gt;路由器选择}
        B4 --&gt; B5[Expert 1]
        B4 --&gt; B6[Expert 2]
        B4 -.-&gt; B7[Expert N]
        B5 --&gt; B8[Sparse Activation&lt;br/&gt;仅部分专家激活]
        B6 --&gt; B8
        B7 -.-&gt; B8
        B8 --&gt; B9[Add &amp; Norm]
        B9 --&gt; B10[Output]
    end
    
    style A4 fill:#FFB6C1
    style B4 fill:#87CEEB
    style B8 fill:#90EE90
</code></pre>
<p><strong>对比要点：</strong></p>
<ul>
<li>传统模型：FFN 层所有参数都参与计算</li>
<li>MoE 模型：用多专家 + 路由器替代 Dense FFN</li>
</ul>
<hr/>
<h3 data-id="heading-8">3. Dense 模型 vs MoE 模型：显存与计算对比</h3>
<h4 data-id="heading-9">3.1 什么是 Dense（稠密模型）</h4>
<p><strong>Dense = 所有参数全部参与推理</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[输入] --&gt; B[Layer 1&lt;br/&gt;32B 参数]
    B --&gt; C[Layer 2&lt;br/&gt;32B 参数]
    C --&gt; D[Layer 3&lt;br/&gt;32B 参数]
    D --&gt; E[输出]
    
    style B fill:#FF6B6B
    style C fill:#FF6B6B
    style D fill:#FF6B6B
</code></pre>
<p><strong>示例：</strong></p>
<ul>
<li>Qwen2.5-32B Dense
<ul>
<li>
<p>推理时 32B 全激活</p>
</li>
<li>
<p>显存占用 60+ GB（FP16）</p>
</li>
<li>
<p>性能强但成本高</p>
</li>
</ul>
</li>
</ul>
<p>显存对比表：</p>


























<table><thead><tr><th>模型</th><th>FP16</th><th>FP8</th><th>INT8</th><th>INT4</th></tr></thead><tbody><tr><td><strong>Qwen3 Dense 32B</strong>（全激活）</td><td>60+ GB</td><td>30 GB</td><td>28 GB</td><td>15 GB</td></tr><tr><td><strong>Qwen3 MoE 30B</strong>（激活 ~3B）</td><td>6 GB</td><td>3 GB</td><td>3 GB</td><td>1.5 GB</td></tr></tbody></table>
<p>👉 <strong>MoE 推理显存 ≈ Dense 的 1/10~1/20</strong></p>
<hr/>
<h4 data-id="heading-10">3.2 什么是 MoE（混合专家模型）</h4>
<p><strong>MoE = 总参数大，但每次只激活少量专家</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[Input] --&gt; B[Layer 1&lt;br/&gt;Total Params 30B]
    B --&gt; C{Router&lt;br/&gt;Select Top-2}

    C --&gt;|Active| D1[Expert 1&lt;br/&gt;1.5B]
    C --&gt;|Active| D2[Expert 5&lt;br/&gt;1.5B]
    C -.-&gt; D3[Other Experts&lt;br/&gt;Not Activated&lt;br/&gt;27B]

    D1 --&gt; E[Merge Output]
    D2 --&gt; E
    E --&gt; F[Next Layer]

    style D1 fill:#90EE90
    style D2 fill:#90EE90
    style D3 fill:#E0E0E0

</code></pre>
<p><strong>示例：</strong></p>
<ul>
<li>Qwen1.5-MoE-33B
<ul>
<li>总参数：33B</li>
<li>激活专家：Top-1（约 3B）</li>
<li>显存占用：~6GB（FP16）</li>
<li>推理成本 ≈ 3B Dense 模型</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-11">3.3 显存占用对比表（重要！）</h4>
<p>以 <strong>Qwen3 32B Dense</strong> &amp; <strong>Qwen3 30B MoE</strong> 为例：</p>


























<table><thead><tr><th>模型配置</th><th>FP16（全精度）</th><th>FP8</th><th>INT8</th><th>INT4</th></tr></thead><tbody><tr><td><strong>Qwen3 Dense 32B</strong><br/>（全参数激活）</td><td>60+ GB</td><td>~30 GB</td><td>~28 GB</td><td>~15 GB</td></tr><tr><td><strong>Qwen3 MoE 30B</strong><br/>（激活 3B）</td><td>~6 GB</td><td>~3 GB</td><td>~3 GB</td><td>~1.5 GB</td></tr></tbody></table>
<pre><code class="hljs language-mermaid" lang="mermaid">gantt
    title 显存占用对比（GB）
    dateFormat X
    axisFormat %s
    section 30B 模型
    FP16  :0, 60
    FP8   :0, 30
    INT8  :0, 28
    INT4  :0, 15
    section 3B 模型
    FP16  :0, 6
    FP8   :0, 3
    INT8  :0, 3
    INT4  :0, 1.5
</code></pre>
<p><strong>结论：</strong></p>
<blockquote>
<p>⚡ <strong>MoE 推理显存消耗 ≈ Dense 的 1/10</strong></p>
</blockquote>
<p><strong>原因：</strong></p>
<ul>
<li><strong>Dense</strong>：所有层、所有参数都要参与计算</li>
<li><strong>MoE</strong>：每层只用少数专家（如激活 3B）</li>
</ul>
<p>这就是为什么 <strong>30B MoE 可以在消费级显卡运行</strong>。</p>
<hr/>
<h3 data-id="heading-12">4. MoE 的关键概念</h3>
<h4 data-id="heading-13">4.1 专家数量（Experts）</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap
  root((MoE 专家池&lt;br/&gt;16 个专家))
    Expert 1
      推理能力
      逻辑分析
    Expert 2
      创意写作
      故事创作
    Expert 3
      数学计算
      公式推导
    Expert 4
      代码生成
      算法实现
    Expert 5
      语言翻译
      多语言理解
    Expert 6~16
      其他领域
      动态分工
</code></pre>
<p><strong>专家分工示例：</strong></p>
<ul>
<li>Expert 1：推理、逻辑分析</li>
<li>Expert 3：数学、计算</li>
<li>Expert 5：代码生成</li>
<li>Expert 7：语言翻译</li>
<li>Expert 10：创意写作</li>
<li>…</li>
</ul>
<hr/>
<h4 data-id="heading-14">4.2 Top-K（激活专家数量）</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[输入 Token] --&gt; B{Router 打分}
    B --&gt; C[专家得分排序]
    
    subgraph "Top-1 策略"
        C --&gt; D1[选择得分最高的 1 个专家]
        D1 --&gt; E1[速度最快&lt;br/&gt;成本最低]
    end
    
    subgraph "Top-2 策略"
        C --&gt; D2[选择得分最高的 2 个专家]
        D2 --&gt; E2[性能更好&lt;br/&gt;成本适中]
    end
    
    style D1 fill:#90EE90
    style D2 fill:#87CEEB
</code></pre>
<p><strong>常见配置：</strong></p>
<ul>
<li><strong>Top-1</strong>：每次激活 1 个专家（速度快）</li>
<li><strong>Top-2</strong>：每次激活 2 个专家（性能好）</li>
</ul>
<hr/>
<h4 data-id="heading-15">4.3 参数关系图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[MoE 模型&lt;br/&gt;总参数 30B] --&gt; B[共 16 个专家]
    B --&gt; C1[Expert 1&lt;br/&gt;1.9B 参数]
    B --&gt; C2[Expert 2&lt;br/&gt;1.9B 参数]
    B --&gt; C3[Expert 3&lt;br/&gt;1.9B 参数]
    B --&gt; C4[...]
    B --&gt; C5[Expert 16&lt;br/&gt;1.9B 参数]
    
    D[推理时 Top-1] --&gt; E[只激活 1 个专家&lt;br/&gt;约 3B 参数]
    E --&gt; F[其余 15 个专家&lt;br/&gt;不参与计算]
    
    style E fill:#90EE90
    style F fill:#E0E0E0
</code></pre>
<p><strong>关键公式：</strong></p>
<pre><code class="hljs language-css" lang="css">总参数 = 专家数量 × 单专家参数 + 共享参数
激活参数 = <span class="hljs-attribute">Top</span>-K × 单专家参数 + 共享参数
推理成本 ∝ 激活参数（而非总参数）
</code></pre>
<hr/>
<h3 data-id="heading-16">5. 常见疑问：没激活的专家是不是浪费？</h3>
<h4 data-id="heading-17">❌ 错误理解</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[用户提问] --&gt; B[激活 Expert 4&lt;br/&gt;代码专家]
    B --&gt; C[其他 15 个专家&lt;br/&gt;完全没用?]
    
    style C fill:#FFB6C1
</code></pre>
<h4 data-id="heading-18">✅ 正确理解</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    A[MoE 专家池] --&gt; B[不同任务触发不同专家]
    
    B --&gt; C1[任务 1: 写代码&lt;br/&gt;触发 Expert 4]
    B --&gt; C2[任务 2: 数学题&lt;br/&gt;触发 Expert 3]
    B --&gt; C3[任务 3: 翻译&lt;br/&gt;触发 Expert 7]
    B --&gt; C4[任务 4: 创作&lt;br/&gt;触发 Expert 2]
    
    C1 --&gt; D[所有专家都会被使用&lt;br/&gt;只是时机不同]
    C2 --&gt; D
    C3 --&gt; D
    C4 --&gt; D
    
    style D fill:#90EE90
</code></pre>
<p><strong>真相：</strong></p>
<ol>
<li><strong>训练时</strong> - 所有专家都会被激活并学习</li>
<li><strong>推理时</strong> - 根据任务动态选择最合适的专家</li>
<li><strong>长期使用</strong> - 每个专家都会在各自擅长的领域发光</li>
</ol>
<p><strong>类比：</strong></p>
<blockquote>
<p>🏥 医院有 16 个科室，你看病只挂 1 个科室，但其他科室不是浪费，而是在服务其他患者。</p>
</blockquote>
<hr/>
<h3 data-id="heading-19">6. Qwen3（Dense / MoE）部署推荐方案</h3>
<h4 data-id="heading-20">场景分析</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[你的硬件条件?] --&gt; B{显卡显存}
    
    B --&gt;|24GB 消费级| C[推荐方案 1]
    B --&gt;|48GB 专业卡| D[推荐方案 2]
    B --&gt;|80GB+ 服务器| E[推荐方案 3]
    
    C --&gt; C1["Qwen3-14B Dense FP8 显存: ~14GB 性能: 强"]
    C --&gt; C2["Qwen1.5-MoE-33B INT4 显存: ~1.5GB 性能: 中上"]
    
    D --&gt; D1["Qwen3-32B Dense FP8 显存: ~30GB 性能: 极强"]
    
    E --&gt; E1["Qwen3-72B Dense FP8 显存: ~72GB 性能: 顶级"]
    
    style C1 fill:#90EE90
    style C2 fill:#87CEEB
    style D1 fill:#FFD700
    style E1 fill:#FF6B6B
</code></pre>
<hr/>
<h4 data-id="heading-21">方案 1：注重性能（推荐）</h4>
<p><strong>Qwen3-14B Dense（INT4 或 FP8）</strong></p>





























<table><thead><tr><th>精度</th><th>显存占用</th><th>推荐指数</th><th>说明</th></tr></thead><tbody><tr><td>FP16</td><td>~28GB</td><td>❌</td><td>超出 24GB 显存</td></tr><tr><td><strong>FP8</strong></td><td><strong>~14GB</strong></td><td>⭐⭐⭐⭐⭐</td><td><strong>强烈推荐</strong></td></tr><tr><td>INT4</td><td>~7GB</td><td>⭐⭐⭐⭐</td><td>轻量级最佳</td></tr></tbody></table>
<p><strong>优势：</strong></p>
<ul>
<li>性能显著强于 7B</li>
<li>性价比 &gt; 70%</li>
<li>适合日常对话、代码生成</li>
</ul>
<hr/>
<h4 data-id="heading-22">方案 2：大模型能力 + 小显存</h4>
<p><strong>Qwen1.5-MoE-33B（INT4）</strong></p>





















<table><thead><tr><th>指标</th><th>数值</th></tr></thead><tbody><tr><td>总参数</td><td>33B</td></tr><tr><td>激活参数</td><td>~3B</td></tr><tr><td>显存占用</td><td>~1.5GB (INT4)</td></tr></tbody></table>
<p><strong>优势：</strong></p>
<ul>
<li>✅ 显存占用极低（4GB 显卡可跑）</li>
<li>✅ 推理速度快</li>
<li>✅ 性能接近 30B Dense（尤其中文、推理）</li>
</ul>
<p><strong>劣势：</strong></p>
<ul>
<li>⚠️ 特定任务效果可能不如 Dense 精细</li>
</ul>
<hr/>
<h4 data-id="heading-23">方案 3：企业级旗舰</h4>
<p><strong>Qwen3-72B Dense（FP8）</strong></p>
<p><strong>硬件要求：</strong></p>
<ul>
<li>A100 80GB / H100</li>
<li>或多卡 80GB GPU</li>
</ul>
<p><strong>性能：</strong></p>
<ul>
<li>Top 级别</li>
<li>适合企业级应用</li>
</ul>
<hr/>
<h3 data-id="heading-24">7. MoE 的训练机制（进阶）</h3>
<h4 data-id="heading-25">7.1 训练流程图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant D as 训练数据
    participant R as Router&lt;br/&gt;路由器
    participant E1 as Expert 1
    participant E2 as Expert 2
    participant L as Loss&lt;br/&gt;损失函数
    
    D-&gt;&gt;R: 输入 Token
    R-&gt;&gt;R: 计算专家得分
    R-&gt;&gt;E1: 激活 (权重 0.7)
    R-&gt;&gt;E2: 激活 (权重 0.3)
    E1-&gt;&gt;L: 输出 O1
    E2-&gt;&gt;L: 输出 O2
    L-&gt;&gt;L: 计算任务损失&lt;br/&gt;+ 负载均衡损失
    L--&gt;&gt;E1: 反向传播更新
    L--&gt;&gt;E2: 反向传播更新
    L--&gt;&gt;R: 更新路由参数
</code></pre>
<hr/>
<h4 data-id="heading-26">7.2 路由器训练机制</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    A[输入 Token 表示] --&gt; B[Router 小型网络&lt;br/&gt;Linear + Softmax]
    B --&gt; C[输出专家概率分布]
    
    C --&gt; D{Top-K 选择}
    D --&gt; E1[专家得分: 0.35]
    D --&gt; E2[专家得分: 0.28]
    D --&gt; E3[专家得分: 0.15]
    D --&gt; E4[其他专家...]
    
    E1 --&gt; F[选择 Top-2]
    E2 --&gt; F
    
    F --&gt; G[+ 负载均衡损失&lt;br/&gt;防止专家偏向]
    
    style G fill:#FFD700
</code></pre>
<p><strong>训练优化：</strong></p>
<ol>
<li>使用 <strong>Softmax + Top-K</strong></li>
<li>加入 <strong>负载均衡（Load Balancing）损失项</strong></li>
<li>确保专家不会"偏向性过强"</li>
</ol>
<hr/>
<h4 data-id="heading-27">7.3 专家特化过程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[训练初期&lt;br/&gt;专家无明显分工] --&gt; B[中期&lt;br/&gt;逐渐形成偏好]
    B --&gt; C[后期&lt;br/&gt;专家特化完成]
    
    subgraph "训练初期"
        A1[Expert 1&lt;br/&gt;通用能力]
        A2[Expert 2&lt;br/&gt;通用能力]
        A3[Expert 3&lt;br/&gt;通用能力]
    end
    
    subgraph "训练后期"
        C1[Expert 1&lt;br/&gt; 代码专家]
        C2[Expert 2&lt;br/&gt; 数学专家]
        C3[Expert 3&lt;br/&gt; 创意专家]
    end
    
    A1 -.演化.-&gt; C1
    A2 -.演化.-&gt; C2
    A3 -.演化.-&gt; C3
    
    style C1 fill:#90EE90
    style C2 fill:#87CEEB
    style C3 fill:#FFB6C1
</code></pre>
<p><strong>关键训练技术：</strong></p>
<ul>
<li><strong>OBST</strong>（One-Batch Selective Training）</li>
<li><strong>GShard</strong>（Google）</li>
<li><strong>Switch Transformer</strong>（Google）</li>
<li><strong>DeepSpeed-MoE</strong>（微软）</li>
</ul>
<hr/>
<h4 data-id="heading-28">7.4 防止专家闲置的机制</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap
  root((防止专家闲置))
    负载均衡损失
      惩罚过度使用某个专家
      奖励使用冷门专家
    多任务训练
      覆盖不同领域数据
      确保每个专家有用武之地
    随机噪声
      路由器添加随机扰动
      增加专家激活多样性
    Expert Dropout
      训练时随机丢弃专家
      强制其他专家学习
</code></pre>
<p><strong>结果：</strong> 所有专家都有机会参与训练，不会出现"活跃专家"和"僵尸专家"。</p>
<hr/>
<h3 data-id="heading-29">8. 完整知识体系总结</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap
  root((MoE核心知识))
    基础概念
      多专家结构
      稀疏激活
      路由机制
    参数关系
      总参数不等推理成本
      激活参数定成本
      显存占用1/10
    模型对比
      Dense全激活
      MoE选激活
      性能成本权衡
    训练机制
      路由器训练
      专家特化
      负载均衡
    部署方案
      消费级14B
      专业级32B
      企业级72B
    优势
      大模型能力
      小模型成本
      领域特化
</code></pre>
<hr/>
<h3 data-id="heading-30">9. 十句话掌握 MoE</h3>
<ol>
<li><strong>MoE = 多专家结构，每次只激活少数专家</strong></li>
<li><strong>总参数（如 30B）≠ 推理成本</strong></li>
<li><strong>推理成本 ≈ 激活参数（如 3B）</strong></li>
<li><strong>Dense = 全部激活，性能强但成本高</strong></li>
<li><strong>MoE = "大模型能力 + 小模型成本"</strong></li>
<li><strong>INT4/FP8 是量化技术，与 MoE 架构无关</strong></li>
<li><strong>INT4 省显存但会略降性能</strong></li>
<li><strong>MoE 不会浪费参数，未激活专家会在其他任务中使用</strong></li>
<li><strong>Qwen3-14B Dense FP8 是最稳健的部署方案</strong></li>
<li><strong>Qwen-MoE 系列适合显存 4GB~24GB 的场景</strong></li>
</ol>
<hr/>
<h3 data-id="heading-31">10. 个人快速决策指南</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start[开始选择模型] --&gt; Q1{你的显存?}
    
    Q1 --&gt;|4-8GB| A1[Qwen1.5-MoE-33B INT4&lt;br/&gt;显存: 1.5GB&lt;br/&gt;性能: 中上]
    Q1 --&gt;|12-16GB| A2[Qwen3-7B Dense FP8&lt;br/&gt;显存: 7GB&lt;br/&gt;性能: 中]
    Q1 --&gt;|20-24GB| A3{优先什么?}
    Q1 --&gt;|40GB+| A4[Qwen3-32B Dense FP8&lt;br/&gt;显存: 30GB&lt;br/&gt;性能: 极强]
    Q1 --&gt;|80GB+| A5[Qwen3-72B Dense FP8&lt;br/&gt;显存: 72GB&lt;br/&gt;性能: 顶级]
    
    A3 --&gt;|性能| B1[Qwen3-14B Dense FP8&lt;br/&gt;显存: 14GB&lt;br/&gt;性能: 强]
    A3 --&gt;|兼顾| B2[Qwen3-14B Dense INT4&lt;br/&gt;显存: 7GB&lt;br/&gt;性能: 强]
    
    style A1 fill:#87CEEB
    style B1 fill:#90EE90
    style A4 fill:#FFD700
    style A5 fill:#FF6B6B
</code></pre>
<hr/>
<h3 data-id="heading-32">附录：参考资源</h3>
<p><strong>官方文档：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fqwen.readthedocs.io%2F" target="_blank" title="https://qwen.readthedocs.io/" ref="nofollow noopener noreferrer">Qwen 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FQwen" target="_blank" title="https://huggingface.co/Qwen" ref="nofollow noopener noreferrer">Hugging Face Model Hub</a></li>
</ul>
<p><strong>部署工具：</strong></p>
<ul>
<li>vLLM</li>
<li>Ollama</li>
<li>llama.cpp</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 性能优化实战：从10秒到1秒的5个关键技巧，让你的应用飞起来！]]></title>    <link>https://juejin.cn/post/7582533464244469794</link>    <guid>https://juejin.cn/post/7582533464244469794</guid>    <pubDate>2025-12-12T04:17:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582533464244469794" data-draft-id="7582517824498024482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 性能优化实战：从10秒到1秒的5个关键技巧，让你的应用飞起来！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-12T04:17:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 性能优化实战：从10秒到1秒的5个关键技巧，让你的应用飞起来！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T04:17:03.000Z" title="Fri Dec 12 2025 04:17:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vue3 性能优化实战：从10秒到1秒的5个关键技巧，让你的应用飞起来！</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>在当今的前端开发中，性能优化是每个开发者都无法回避的话题。尤其是对于 Vue3 应用来说，随着业务逻辑的复杂化和数据量的增长，应用的性能问题可能会逐渐显现。一个原本响应迅速的页面，可能在某个时刻变得缓慢甚至卡顿，严重影响用户体验。</p>
<p>本文将从实战角度出发，分享 5 个关键的 Vue3 性能优化技巧，帮助你从“10秒加载”优化到“1秒响应”，让你的应用真正“飞起来”。这些技巧不仅基于 Vue3 的核心特性（如 Composition API、响应式系统优化等），还结合了现代前端工程化的最佳实践。</p>
<hr/>
<h3 data-id="heading-2">1. <strong>合理使用 <code>v-once</code> 和 <code>v-memo</code>：减少不必要的渲染</strong></h3>
<p>Vue3 的响应式系统是其核心优势之一，但频繁的组件渲染也可能成为性能瓶颈。<code>v-once</code> 和 <code>v-memo</code> 是两个用于优化渲染的指令：</p>
<ul>
<li>
<p><strong><code>v-once</code></strong>：标记元素或组件只渲染一次，后续不再更新。适用于静态内容或不需要响应式变化的部分。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-once</span>&gt;</span>{{ staticContent }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong><code>v-memo</code></strong>（Vue3.2+）：通过缓存虚拟 DOM 节点，避免不必要的重新渲染。适用于需要频繁更新但内容可能不变的场景。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-memo</span>=<span class="hljs-string">"[dependency]"</span>&gt;</span>{{ dynamicContent }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>只有当 <code>dependency</code> 变化时，才会触发重新渲染。</p>
</li>
</ul>
<h4 data-id="heading-3"><strong>实战建议</strong></h4>
<ul>
<li>对静态内容（如页脚、标题）使用 <code>v-once</code>。</li>
<li>对高频更新但依赖项较少的列表项使用 <code>v-memo</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-4">2. <strong>懒加载与代码分割：按需加载资源</strong></h3>
<p>Vue3 结合现代打包工具（如 Vite、Webpack）可以轻松实现代码分割和懒加载：</p>
<ul>
<li>
<p><strong>路由级懒加载</strong>：通过动态导入拆分路由组件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Home</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/Home.vue'</span>);
</code></pre>
</li>
<li>
<p><strong>组件级懒加载</strong>：对非首屏关键组件使用 <code>defineAsyncComponent</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineAsyncComponent } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">AsyncComponent</span> = <span class="hljs-title function_">defineAsyncComponent</span>(<span class="hljs-function">() =&gt;</span> 
  <span class="hljs-keyword">import</span>(<span class="hljs-string">'./components/HeavyComponent.vue'</span>)
);
</code></pre>
</li>
</ul>
<h4 data-id="heading-5"><strong>实战建议</strong></h4>
<ul>
<li>结合 <code>Suspense</code>（实验性特性）处理异步组件的加载状态。</li>
<li>Vite + Rollup 的天然支持可以进一步优化 Tree Shaking。</li>
</ul>
<hr/>
<h3 data-id="heading-6">3. <strong>响应式数据的精细化控制</strong></h3>
<p>Vue3 的响应式系统基于 Proxy，但仍需避免过度响应式化：</p>
<ul>
<li><strong>使用 <code>shallowRef</code> / <code>shallowReactive</code></strong>：仅对顶层属性进行响应式处理，适合大型对象或数组。</li>
<li><strong>避免在模板中直接访问深层嵌套属性</strong>：例如 <code>user.profile.address.city</code>，这种访问会递归触发依赖收集。</li>
<li><strong>手动控制依赖追踪</strong>：通过 <code>markRaw</code> 跳过不必要的响应式转换。</li>
</ul>
<h4 data-id="heading-7"><strong>实战建议</strong></h4>
<ul>
<li>API返回的大型数据集优先用 <code>shallowRef</code>。</li>
<li>Pinia/Vuex状态管理中可局部使用非响应式数据。</li>
</ul>
<hr/>
<h3 data-id="heading-8">4. <strong>虚拟滚动与列表优化：高效渲染长列表</strong></h3>
<p>长列表是前端性能的“杀手”。Vue3生态提供了成熟的解决方案：</p>
<ul>
<li><strong>虚拟滚动库（如 <code>vue-virtual-scroller</code>）</strong>：仅渲染可视区域的 DOM。</li>
<li><strong>手动实现分片渲染（Time Slicing）</strong>：通过 <code>requestIdleCallback</code>分批渲染数据。</li>
</ul>
<h4 data-id="heading-9"><strong>示例代码（虚拟滚动）</strong></h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">RecycleScroller</span> 
    <span class="hljs-attr">:items</span>=<span class="hljs-string">"largeList"</span>
    <span class="hljs-attr">:item-size</span>=<span class="hljs-string">"50"</span>
    <span class="hljs-attr">key-field</span>=<span class="hljs-string">"id"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">"{ item }"</span>&gt;</span>
      {{ item.name }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">RecycleScroller</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h4 data-id="heading-10"><strong>实战建议</strong></h4>
<ul>
<li>1万条以上数据必须用虚拟滚动。</li>
<li>结合Web Worker预处理数据进一步降低主线程压力。</li>
</ul>
<hr/>
<h3 data-id="heading-11">5. <strong>编译时优化与工具链选择</strong></h3>
<p>Vue3的编译器做了大量静态分析优化：</p>
<ol>
<li><strong>启用模板预编译（Vite模式默认开启）</strong></li>
<li><strong>选择性禁用SourceMap生成</strong></li>
<li><strong>静态节点提升（Hoist Static）</strong></li>
<li><strong>Patch Flags标记动态节点</strong></li>
</ol>
<h4 data-id="heading-12">Vite配置示例：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
 <span class="hljs-attr">build</span>: {
   <span class="hljs-attr">minify</span>: <span class="hljs-string">'terser'</span>,
   <span class="hljs-attr">terserOptions</span>: {
     <span class="hljs-attr">compress</span>: { <span class="hljs-attr">drop_console</span>: <span class="hljs-literal">true</span> }
   }
 }
}
</code></pre>
<h4 data-id="heading-13">Webpack补充：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
 <span class="hljs-attr">optimization</span>: {
   <span class="hljs-attr">splitChunks</span>: { <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span> }
 }
}
</code></pre>
<hr/>
<h3 data-id="heading-14">总结</h3>
<p>从10秒到1秒的性能飞跃并非魔法，而是需要对Vue3运行机制有深刻理解：</p>
<ol>
<li>🚀 <strong>渲染控制</strong>是基础 - v-memo/v-once精准把控更新粒度</li>
<li>⏳ <strong>懒加载策略</strong>解决资源瓶颈</li>
<li>🔍 <strong>响应式调优</strong>避免无意义追踪</li>
<li>📜 <strong>虚拟滚动攻克列表难题</strong></li>
<li>⚙️工具链深度适配释放框架潜力</li>
</ol>
<p>这些技术不是孤立的——实际项目中往往需要组合运用。例如一个电商页面可能同时需要：
-商品列表用虚拟滚动
-购物车数据用shallowReactive
-结算模块异步加载</p>
<p>真正的性能高手不在于知道多少API，而在于准确判断技术选型背后的trade-off</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React性能优化实战：5个被低估的Hooks技巧让你的应用提速30%]]></title>    <link>https://juejin.cn/post/7582419803782053923</link>    <guid>https://juejin.cn/post/7582419803782053923</guid>    <pubDate>2025-12-12T00:16:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582419803782053923" data-draft-id="7582430286916124687" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React性能优化实战：5个被低估的Hooks技巧让你的应用提速30%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-12T00:16:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React性能优化实战：5个被低估的Hooks技巧让你的应用提速30%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T00:16:54.000Z" title="Fri Dec 12 2025 00:16:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    30
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>React性能优化实战：5个被低估的Hooks技巧让你的应用提速30%</strong></h3>
<h3 data-id="heading-1">引言</h3>
<p>在React生态系统中，Hooks自推出以来已成为函数式组件的核心工具。然而，许多开发者仅停留在基础用法（如<code>useState</code>、<code>useEffect</code>）层面，忽略了Hooks在性能优化上的潜力。本文将深入探讨5个被低估的Hooks技巧，通过实际代码示例和性能对比，展示如何通过这些技术实现高达30%的性能提升。</p>
<hr/>
<h3 data-id="heading-2">主体</h3>
<h4 data-id="heading-3">1. <code>useMemo</code>：不仅仅是记忆化的“计算属性”</h4>
<h5 data-id="heading-4">问题场景</h5>
<p>当组件中存在高开销的计算逻辑（如数据过滤、排序）时，每次渲染都会重新计算，即使依赖项未变化。</p>
<h5 data-id="heading-5">优化方案</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> sortedList = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> largeArray.<span class="hljs-title function_">sort</span>(complexSortLogic);
}, [largeArray]); <span class="hljs-comment">// 仅在largeArray变化时重新计算</span>
</code></pre>
<h5 data-id="heading-6">进阶技巧</h5>
<ul>
<li><strong>引用稳定性</strong>：将对象/数组作为依赖项时，配合<code>useState</code>或<code>useReducer</code>确保引用不变</li>
<li><strong>自定义比较函数</strong>：通过第二个参数实现深度比较（需谨慎使用）</li>
</ul>
<h5 data-id="heading-7">实测数据</h5>
<p>在1000条数据的排序场景下，重复渲染性能提升可达45%。</p>
<hr/>
<h4 data-id="heading-8">2. <code>useCallback</code> + <code>React.memo</code>：子组件更新的精准控制</h4>
<h5 data-id="heading-9">问题场景</h5>
<p>父组件状态更新导致所有子组件无差别重渲染，即使它们的props未变化。</p>
<h5 data-id="heading-10">优化方案</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Parent.jsx</span>
<span class="hljs-keyword">const</span> handleClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 事件处理逻辑</span>
}, [dependency]);

<span class="hljs-comment">// Child.jsx</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-title class_">ChildComponent</span>);
</code></pre>
<h5 data-id="heading-11">关键洞察</h5>
<ul>
<li><strong>闭包陷阱</strong>：错误的依赖数组会导致回调函数持有过期状态</li>
<li><strong>记忆化成本</strong>：过度使用可能导致内存压力，适合中大型组件树</li>
</ul>
<h5 data-id="heading-12">典型案例分析</h5>
<p>电商平台商品列表场景中，此组合技可减少60%的子组件渲染。</p>
<hr/>
<h4 data-id="heading-13">3. <code>useReducer</code> vs <code>useState</code>：状态更新的批量处理艺术</h4>
<h5 data-id="heading-14">深层原理</h5>
<ul>
<li><code>useState</code>的setState会触发同步渲染（在Concurrent Mode下可能合并）</li>
<li><code>useReducer</code>天生支持批量更新</li>
</ul>
<h5 data-id="heading-15">性能敏感场景代码对比</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useState版本（可能触发多次渲染）</span>
<span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(initState);
<span class="hljs-keyword">const</span> <span class="hljs-title function_">update</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setState</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> ({...v, <span class="hljs-attr">a</span>:<span class="hljs-number">1</span>}));
  <span class="hljs-title function_">setState</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> ({...v, <span class="hljs-attr">b</span>:<span class="hljs-number">2</span>}));
};

<span class="hljs-comment">// useReducer版本（单次更新）</span>
<span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(reducer, initState);
<span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'MULTI_UPDATE'</span>, <span class="hljs-attr">payload</span>: {<span class="hljs-attr">a</span>:<span class="hljs-number">1</span>, <span class="hljs-attr">b</span>:<span class="hljs-number">2</span>} });
</code></pre>
<h5 data-id="heading-16">Benchmark结果</h5>
<p>复杂表单场景下，更新吞吐量提升28%。</p>
<hr/>
<h4 data-id="heading-17">4. <code>useLayoutEffect</code>的精准计时：减少布局抖动</h4>
<h5 data-id="heading-18">DOM操作的最佳实践</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> element = ref.<span class="hljs-property">current</span>;
  <span class="hljs-comment">// DOM测量和同步修改操作</span>
  
}, [deps]);
</code></pre>
<p>与常规认知不同：</p>
<ul>
<li><strong>并非所有DOM操作都需要</strong>：仅在需要同步布局时使用（如动画起始帧）</li>
<li><strong>SSR警告</strong>：服务端渲染时会触发警告，需配合动态导入解决</li>
</ul>
<h5 data-id="heading-19">Chrome Performance面板分析案例：</h5>
<p>Tooltip定位计算场景中减少42%的Layout Thrashing。</p>
<hr/>
<h4 data-id="heading-20">5. <code>useDeferredValue</code> + Suspense：并发模式下的渐进式加载</h4>
<h5 data-id="heading-21">Concurrent Mode适配方案：</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> deferredValue = <span class="hljs-title function_">useDeferredValue</span>(value);

<span class="hljs-keyword">return</span> (
   <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">ExpensiveComponent</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{deferredValue}</span> /&gt;</span>
   <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
</code></pre>
<h5 data-id="heading-22">Implementation Notes:</h5>
<ol>
<li><strong>优先级标记</strong>：React会自动将延迟值的更新标记为过渡更新(transition)</li>
<li><strong>防抖替代方案</strong>：相比手动防抖能更精准控制时间切片</li>
</ol>
<h5 data-id="heading-23">A/B测试数据：</h5>
<p>大列表过滤场景下首次内容呈现时间(FCP)改善37%。</p>
<hr/>
<h3 data-id="heading-24">Deep Dive扩展知识</h3>
<h4 data-id="heading-25">Hook组合模式创新案例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useOptimizedSelector</span>(<span class="hljs-params">selector</span>) {
    <span class="hljs-keyword">const</span> [, forceUpdate] = <span class="hljs-title function_">useReducer</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> prevValueRef = <span class="hljs-title function_">useRef</span>();
    
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
       <span class="hljs-keyword">const</span> subscription = store.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {
         <span class="hljs-keyword">const</span> newValue = <span class="hljs-title function_">selector</span>(store.<span class="hljs-title function_">getState</span>());
         <span class="hljs-keyword">if</span>(!<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">is</span>(prevValueRef.<span class="hljs-property">current</span>, newValue)) {
           prevValueRef.<span class="hljs-property">current</span> = newValue;
           <span class="hljs-title function_">forceUpdate</span>();
         }
       });
       <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> subscription.<span class="hljs-title function_">unsubscribe</span>();
    }, [selector]);
    
    <span class="hljs-keyword">return</span> prevValueRef.<span class="hljs-property">current</span>;
}
</code></pre>
<p>该自定义Hook实现了Redux选择器的精确更新订阅。</p>
<hr/>
<h3 data-id="heading-26">Web Workers集成策略</h3>
<p>通过Hook封装Web Worker通信：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useWorkerComputation</span>(<span class="hljs-params">task</span>) {
   <span class="hljs-keyword">const</span> [result, setResult] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
   
   <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'worker.js'</span>);
      worker.<span class="hljs-title function_">postMessage</span>(task);
      
      worker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> { 
        <span class="hljs-title function_">setResult</span>(e.<span class="hljs-property">data</span>); 
      };
      
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> worker.<span class="hljs-title function_">terminate</span>();
   }, [task]);
   
   <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>适用于图像处理等CPU密集型任务。</p>
<hr/>
<h3 data-id="heading-27">React Profiler集成指南</h3>
<p>开发环境添加性能检测：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Profiler</span> id=<span class="hljs-string">"ExpensiveComponent"</span> onRender={<span class="hljs-function">(<span class="hljs-params">id, phase, duration</span>) =&gt;</span> {
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${id}</span> <span class="hljs-subst">${phase}</span> took <span class="hljs-subst">${duration}</span>ms`</span>);
}}&gt;
   <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ExpensiveComponent</span> /&gt;</span></span>
&lt;/<span class="hljs-title class_">Profiler</span>&gt;
</code></pre>
<p>生产环境建议使用：</p>
<ul>
<li>User Timing API</li>
<li>React DevTools Profiler Export</li>
</ul>
<hr/>
<h3 data-id="heading-28">SSR特殊处理</h3>
<p>服务端渲染需注意：</p>
<ol>
<li><code>useLayoutEffect</code>警告解决方案：</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> useIsomorphicLayoutEffect = 
   <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> ? useLayoutEffect : useEffect;
</code></pre>
<ol start="2">
<li>Hydration阶段避免状态突变</li>
</ol>
<hr/>
<h3 data-id="heading-29">Browser Rendering Pipeline解析</h3>
<p>Hook执行时机与浏览器帧对齐：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">Input Event</span>] → requestAnimationFrame → React Render Phase →  
               ↳ Commit Phase → requestIdleCallback 
</code></pre>
<p>关键路径优化的黄金法则：</p>
<ul>
<li>Hook中的计算应小于16ms（60fps）</li>
<li>Effect清理函数需轻量级</li>
</ul>
<hr/>
<h3 data-id="heading-30">Fiber架构底层视角</h3>
<p>为什么这些Hook能优化性能？</p>
<ol>
<li>Fiber节点的bailout机制：
<ul>
<li>props浅比较(memo)</li>
<li>hooks依赖项比对</li>
</ul>
</li>
<li>Scheduler的时间切片：
<ul>
<li>Concurrent Mode下的可中断渲染</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-31">TypeScript高级模式</h3>
<p>带类型约束的自定义Hook示例：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> useContextSelector&lt;T, K&gt;(
   <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span>&lt;T&gt;,
   <span class="hljs-attr">selector</span>: <span class="hljs-function">(<span class="hljs-params">value: T</span>) =&gt;</span> K  
): K { ... }
</code></pre>
<p>实现类似Zustand的选择器功能。</p>
<hr/>
<h2 data-id="heading-32">Final Thoughts总结</h2>
<p>这些Hook技巧的共同特征：</p>
<ol>
<li><strong>引用稳定性优先</strong> - Memoization是基础防线</li>
<li><strong>精确更新粒度控制</strong> - ShouldComponentUpdate的现代化身</li>
<li><strong>并发模式友好设计</strong> - Transition/Suspense集成</li>
</ol>
<p>实施路线图建议：</p>
<p>① Audit现有项目性能瓶颈<br/>
② Incrementally应用上述技术<br/>
③ Measure前后关键指标对比</p>
<blockquote>
<p>"Performance optimization is not about clever tricks,
it's about understanding the system's behavior at depth."
—— Dan Abramov</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[压缩而不失智：LLM 量化技术深度解析]]></title>    <link>https://juejin.cn/post/7582422818311864371</link>    <guid>https://juejin.cn/post/7582422818311864371</guid>    <pubDate>2025-12-11T23:53:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582422818311864371" data-draft-id="7582480048957849627" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="压缩而不失智：LLM 量化技术深度解析"/> <meta itemprop="keywords" content="LLM,人工智能,面试"/> <meta itemprop="datePublished" content="2025-12-11T23:53:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Baihai_IDP"/> <meta itemprop="url" content="https://juejin.cn/user/3123071228582343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            压缩而不失智：LLM 量化技术深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3123071228582343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Baihai_IDP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T23:53:51.000Z" title="Thu Dec 11 2025 23:53:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>编者按：</strong> 如何在资源受限的设备上高效部署大语言模型，同时还尽可能保持其性能表现？</p>
<p>我们今天为大家带来的这篇文章，作者的核心观点是：量化技术通过在模型精度与效率之间寻找最优平衡点，使得大语言模型能够在资源受限的设备上高效部署，而几乎不降低其“智能水平”。</p>
<p>文章从量化的基本原理出发，深入剖析了训练后量化（PTQ）与量化感知训练（QAT）的适用场景，详细解释了缩放因子、零点、对称/非对称量化等关键技术细节，并进一步探讨了高级量化技术（如 GPTQ、AWQ、SmoothQuant）以及 KV 缓存量化等前沿方法。作者还结合实战经验，梳理出一套可落地的量化工作流，并展示了量化在端侧 AI、低成本云部署、长上下文处理等场景中的巨大价值。</p>
</blockquote>
<p><strong>作者 | Bhavishya Pandit</strong></p>
<p><strong>编译 | 岳扬</strong></p>
<p>像我们这样的大语言模型，多少有点“养尊处优”。我们钟爱庞大的参数规模、海量的内存和强悍的 GPU。但当有人试图在手机或配备低性能 GPU 的笔记本电脑上运行我们时，现实便会毫不留情地给我们一记耳光。</p>
<p>工程师们如何确保我们在微型设备上依然能流畅智能地运行？</p>
<p>答案就是：量化技术（quantization） —— 它是现代 AI 模型部署中的一项核心技术。</p>
<p>让我们花点时间，真正理解它。</p>
<h2 data-id="heading-0"><strong>01 什么是量化技术？</strong></h2>
<p><strong>量化的本质在于降低数值的存储精度。</strong> LLM的所有运算都离不开数字——每个权重参数、每次激活值、每一个注意力分数，全都建立在浮点数运算之上。这些数值流畅、连续、无限精确。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a426f54215b54c6cb5fbadca06521d21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766102031&amp;x-signature=XroDfzi%2BxwfNUzKd9WJg43hV%2FnA%3D" alt="image.png" loading="lazy"/></p>
<p>但计算机呢？它们更喜欢固定、离散的存储单元（比如整数而不是高精度浮点数）。要么你的数据能塞进去，要么就塞不进去。就像你试图把整个衣柜塞进一个登机箱一样，装得下就装，装不下就没办法。这时候，量化技术站出来说：</p>
<blockquote>
<p>“嘿，大语言模型，如果每个数字不再使用 32 位精度，而是砍到 8 位，甚至 4 位呢？你几乎察觉不到差别，但我们能省下大量内存。”</p>
</blockquote>
<p><strong>32 位浮点数（FP32）→ 黄金标准</strong></p>
<p><strong>8 位整数（INT8）→ 依然智能，体积要小得多</strong></p>
<p><strong>4 位整数（INT4）→ 超紧凑，只是稍微健忘一点</strong></p>
<p>好吧，但大语言模型为什么要在乎这个？</p>
<p>因为现在的 LLM 实在太臃肿了。数十亿参数需要数十亿个数字。一个 70B 参数的模型若用 FP32 表示，需要 280 GB——这已经不是模型了，这是存储灾难。</p>
<p>量化能把这种情况：“我得靠一整个服务器集群才能跑这个东西”</p>
<p>变成这样：“嘿，我或许能在笔记本上运行它，甚至在手机上也行！”</p>
<p>本质上这就是 AI 模型的瘦身方案 —— <strong>在保持智能的前提下剔除冗余数据。</strong></p>
<p>但是，压缩数字精度不会损害模型质量吗？</p>
<p>有时候确实会。但量化的精髓（也是整门技术的重点）在于：</p>
<blockquote>
<p><strong>在模型最不敏感的地方降低精度</strong></p>
<p><strong>在模型最核心的地方保留准确性</strong></p>
</blockquote>
<h2 data-id="heading-1"><strong>02 量化在大语言模型生命周期中的位置：训练 vs 推理</strong></h2>
<p>在我搞清楚“量化是什么”之后，下一个问题便接踵而至：</p>
<p>“挺酷的，但我们到底什么时候做量化？是在训练期间？训练之后？还是两个阶段都需要？”</p>
<p>事实证明，时机的选择非常关键，因为大语言模型非常挑剔。你是在它们学习过程中就引入量化，还是等它们已经记牢所有模式后再量化，表现会大不相同。</p>
<h3 data-id="heading-2"><strong>2.1 训练后量化（Post-Training Quantization, PTQ）</strong></h3>
<p>可以把 PTQ 想象成给模型贴一张便利贴提醒：</p>
<p>“嘿，我要把你的某些数字四舍五入了，试着适应一下。”</p>
<p>你直接拿一个已经完全训练好的模型，然后进行：</p>
<ul>
<li>FP32 → INT8 或 INT4</li>
<li>可能还会用一些花哨的取整技巧</li>
</ul>
<p>优点是：</p>
<ul>
<li>快速又便宜：无需重新训练一个 70B 参数的庞然大物</li>
<li>易于实验：可以先试试 INT8，看模型是否撑得住，再大胆尝试更低精度</li>
</ul>
<p>缺点是（我是吃了亏才明白的）：</p>
<ul>
<li>精度可能下降：某些网络层对量化极其敏感</li>
<li>异常值影响大：如果某个权重特别大，会破坏整个量化尺度，导致所有参数在压缩后严重失真。</li>
<li>有时需要保留原精度层：LayerNorm、嵌入层（embedding layers）或语言模型头（LM head）可能得保持在 FP16 精度</li>
</ul>
<h3 data-id="heading-3"><strong>2.2 量化感知训练（Quantization-Aware Training, QAT）</strong></h3>
<p>QAT 是更成熟、更系统的做法。与其等模型学完后再强迫它适应低精度，不如从一开始训练时就让它习惯。</p>
<p>我探索 QAT 时是这么做的：</p>
<ul>
<li>在训练过程中插入“伪量化层”（fake quantization layers）：模型在学习时就看到低精度的数字</li>
<li>使用直通估计器（straight-through estimators）让梯度正常流动，使模型能主动适应</li>
<li>到训练结束时，权重天然具备对量化噪声的鲁棒性</li>
</ul>
<p>优点是：</p>
<ul>
<li>最终准确率更高，尤其在极低精度（如 INT4 或 3-bit）时</li>
<li>推理更稳定，意外更少</li>
<li>可以进行激进量化而不丢失模型的“聪明劲儿”</li>
</ul>
<p>缺点（我注意到的）：</p>
<ul>
<li>耗时：哪怕只部分重训 7B–70B 的模型，成本也很高</li>
<li>工程投入大：需要谨慎集成到训练流程中</li>
</ul>
<p>如何选择（根据我的实验和阅读）：</p>
<ul>
<li>PTQ → <strong>首选方案</strong>。便宜、快速，在 INT8 上效果出奇地好，配合智能取整策略，INT4 也常常有效</li>
<li>QAT → <strong>仅当你需要最后那 1–2% 的准确率，或要做极低精度（如 4-bit 以下）量化时才用</strong></li>
<li>混合方案 → <strong>先做 PTQ，同时将某些关键层回退到 FP16，再对核心层做轻量微调（近似 mini-QAT）</strong></li>
</ul>
<p>为什么选择在哪个阶段进行量化如此重要？</p>
<p>我意识到，量化不只是一个数学技巧 —— 它会彻底改变整个部署流程：</p>
<ul>
<li><strong>对纯推理任务，PTQ 往往胜出：显存占用更少，吞吐量更高</strong></li>
<li><strong>对需要训练+部署的完整工作流程，QAT 可能更划算：最终模型更小，长上下文处理能力也更强</strong></li>
</ul>
<p>选择在哪个阶段进行量化的问题归根结底是：</p>
<p>你是想要快速、便宜、基本够用，还是谨慎、稍慢、接近完美？</p>
<h2 data-id="heading-4"><strong>03 量化技术背后的运作机制</strong></h2>
<p>在我搞清楚“何时”量化之后，就不得不弄明白“量化究竟是怎么实现的”。老实说，这个过程出人意料地优雅。量化的核心思想很简单：</p>
<blockquote>
<p>把连续且无限精确的数字，映射到一组有限的离散值上，并尽可能保留模型的“智能”。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74a65b1a14bf4704a86e6520128ccbaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766102031&amp;x-signature=6ar06XLIahH8aWLDfZ3JJHu3RzI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5"><strong>3.1 理解缩放因子（Scale）与零点（Zero-Point）</strong></h3>
<p>想象模型中的这样一个权重：</p>
<pre><code class="hljs">0.8921374650012345
</code></pre>
<p>我们真的需要这么多小数位吗？不需要。量化技术是这样做的：</p>
<ul>
<li>选择一个缩放因子（s）→ 决定每个“区间”有多宽</li>
<li>选择一个零点（z）→ 将我们的整数对齐到实际数据的范围</li>
</ul>
<p>公式看起来挺花哨，但概念上其实很简单：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">quantized_value</span> = round(original_value / scale) + zero_point
</code></pre>
<p>当你想还原回 FP32 时：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">dequantized_value</span> = (quantized_value - zero_point) * scale
</code></pre>
<h3 data-id="heading-6"><strong>3.2 对称量化 vs 非对称量化</strong></h3>
<p>我发现，并不是所有量化都一样：</p>
<ul>
<li>对称量化（Symmetric quantization） → 零点为 0，区间以 0 为中心对称
<ul>
<li>优点：更简单，效率极高</li>
<li>常用于权重</li>
</ul>
</li>
<li>非对称量化（Asymmetric quantization） → 零点可调，正负范围不一定相等
<ul>
<li>优点：能更好地捕捉偏态分布</li>
<li>常用于激活值（activations），因为它们通常不是以 0 为中心的</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7"><strong>3.3 按张量量化 vs 按通道量化：粒度很重要</strong></h3>
<p>起初，我尝试了按张量量化（per-tensor quantization）：整个权重矩阵使用一套缩放因子和零点。很简单，但有时会出现灾难性失效。为什么呢？因为 Transformer 很挑剔 —— 权重矩阵中有些行的数值很大，有些则很小。若整行共用一套缩放因子，结果会是：</p>
<ul>
<li>小数值被挤进同一个区间（导致精度损失）</li>
<li>或大数值被截断（产生巨大误差）</li>
</ul>
<p>解决方案？按通道（per-channel，即按行）量化。</p>
<ul>
<li>每一行都有自己独立的缩放因子（和可能的零点）</li>
<li>保留了数值的相对差异</li>
<li>与带来的收益相比，其额外的内存开销微乎其微</li>
</ul>
<h3 data-id="heading-8"><strong>3.4 取整与截断：微小误差，重大影响</strong></h3>
<p>量化并非魔法。它会引入两类误差：</p>
<ul>
<li>取整误差（Rounding error） → 实际值与其最接近的量化区间值之间的差异</li>
<li>截断误差（Clipping error） → 当数值超出可表示范围时被强行裁剪</li>
</ul>
<p>像 GPTQ 或 SmoothQuant 这样的现代 LLM 量化方案，核心就是通过巧妙的取整方法或层间重平衡（rebalancing）来最小化这些误差（后面会细说）。</p>
<h3 data-id="heading-9"><strong>3.5 如何选择量化精度</strong></h3>
<p>这是我每天都要面对的问题：</p>
<p>FP32 → INT8 → INT4 → … 我最多能压缩到多少位？</p>
<p>我的经验是：通常先从 INT8 开始 —— 安全又经济，只有在采用高级取整技术时，才尝试 INT4。低于 4 比特的量化尚处于实验阶段，除非你准备好对模型进行微调，否则风险很高。</p>
<h3 data-id="heading-10"><strong>3.6 一个直观的比喻</strong></h3>
<p>这是我的思维模型：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d50ef1b6cae46f3970a04e906d25b13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766102031&amp;x-signature=ZE1xCmALV20Ifl%2BuURelktKD7D4%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>每个权重 = 一件衣服</li>
<li>每个量化区间 = 行李箱里的一个隔层</li>
<li>缩放因子 = 你的隔层有多大</li>
<li>零点 = 第一个隔层从哪儿开始</li>
</ul>
<h2 data-id="heading-11"><strong>04 量化为何有时会带来副作用</strong></h2>
<p>量化并非魔法 —— 如果我们不够谨慎，它可能会微妙地破坏模型性能。这些误差主要来源于以下几个方面：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60fce357544647f7bbef65bfbe8b3b8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766102031&amp;x-signature=iQaUvaCr6%2FpNLO6kTie2XNWKhYw%3D" alt="image.png" loading="lazy"/></p>
<p><strong>1）取整误差：将 FP32 精度的数值映射到 INT8/INT4 会引入微小的精度损失。</strong></p>
<ul>
<li>单次误差很小，但在 Transformer 中，微小的取整误差会跨层累积。</li>
<li>结果：导致注意力分布或词元概率发生细微变化，有时甚至会引发模型幻觉。</li>
</ul>
<p><strong>2）截断误差：异常值会迫使量化因子变大。</strong></p>
<ul>
<li>这使得大多数权重被压缩到少数几个区间内 → 有效精度大幅下降。</li>
<li>实例：LayerNorm 层中一个罕见的大激活值若被截断，就可能导致模型不稳定。</li>
</ul>
<p>快速应对：<strong>采用百分位数法确定缩放因子，代替极值法，或对敏感层特殊处理。</strong></p>
<p><strong>3）网络层敏感度差异：并非所有网络层对量化的反应都相同：</strong></p>
<ul>
<li>注意力投影层（Attention projections） &amp; 语言模型头（LM head） → 高度敏感</li>
<li>LayerNorm 层 → 极度敏感，通常需保持 FP16 精度</li>
<li>MLP 层 → 中等敏感，可耐受 INT8/INT4</li>
<li>嵌入层（Embeddings） → 中高度敏感，需要小心处理</li>
</ul>
<h2 data-id="heading-12"><strong>05 高级量化技术</strong></h2>
<p>在经历了取整、截断和敏感网络层带来的种种挑战后，研究人员和工程师们开发出一些巧妙的方法，使得 LLM 即使在 4 位精度下也能表现出色。以下是我了解到的一些核心技术。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f5f18678ed94aa699bb4bcc03561b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766102031&amp;x-signature=oRtuPnyUDs%2Fl0nQKmsWEjkGI8G0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13"><strong>5.1 GPTQ：基于 Hessian 矩阵的智能取整</strong></h3>
<ul>
<li>核心思想：并非所有取整误差都同等重要。某些权重对模型输出的影响更大。</li>
<li>GPTQ 通过分析模型的二阶敏感度（Hessian 矩阵）来识别哪些权重可以安全地进行取整处理。</li>
<li>效果：即使在大模型中，INT4 权重量化也能几乎保持原始精度。</li>
</ul>
<h3 data-id="heading-14"><strong>5.2 AWQ：激活感知量化</strong></h3>
<ul>
<li>激活值与权重相互作用，如果在对权重进行取整时不考虑激活值的分布范围，可能会损害模型性能。</li>
<li>AWQ 根据激活值的统计特征来调整权重量化策略，从而降低推理过程中的误差风险。</li>
</ul>
<h3 data-id="heading-15"><strong>5.3 SmoothQuant：层间平衡技术</strong></h3>
<ul>
<li>痛点：某些网络层的激活值范围过大，导致均匀量化效率低下。</li>
<li>SmoothQuant 会在不同层之间对权重和激活值进行重新缩放，但保证它们相乘后的结果（即模型的输出）保持不变。</li>
<li>优势：实现更平滑的量化，大幅减小精度损失。</li>
</ul>
<h3 data-id="heading-16"><strong>5.4 HQQ 与混合方法</strong></h3>
<ul>
<li>该方法将 Hessian 信息与混合精度或分组量化技术相结合。</li>
<li>思路：对层中“安全”的部分使用低比特精度，而对敏感部分保留更高精度。</li>
<li>该技术在对生产级模型进行 INT4 或更低比特量化时尤为实用。</li>
</ul>
<h3 data-id="heading-17"><strong>5.5 混合精度回退机制</strong></h3>
<ul>
<li>有些网络层天生抗拒被量化。</li>
<li>常见策略：将 LayerNorm、LM Head（语言模型输出头）以及部分嵌入层维持在 FP16 精度，其余部分则量化为 INT4/INT8。</li>
<li>权衡：虽略微增加内存占用，却能换来模型质量的大幅提升。</li>
</ul>
<h2 data-id="heading-18"><strong>06 KV 缓存量化</strong></h2>
<p>如果你曾尝试用大语言模型处理长上下文任务，一定对此深有体会：KV 缓存会疯狂占用内存。每个生成的词元都要为每一层保存键（Key）矩阵和值（Value）矩阵，而模型动辄拥有数十亿参数，内存很快就会被吃光。量化技术此时便派上用场。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c754dbca68da450d862d142b00f19dbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766102031&amp;x-signature=6CRawmKZpR087j6QJKKyHy2ffKQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-19"><strong>6.1 为什么 KV 缓存很重要</strong></h3>
<ul>
<li>在解码过程中，Transformer 会为每个历史词元存储键（K）和值（V）。</li>
<li>这样就能在计算注意力时访问所有先前词元，无需重复计算。</li>
<li>问题在于：对于长提示词（如 8K+ 词元）和超大模型（70B+ 参数），缓存可能占用大部分 GPU 内存。</li>
</ul>
<h3 data-id="heading-20"><strong>6.2 INT8/INT4 KV 缓存</strong></h3>
<ul>
<li>将键和值以更低精度（如 INT8 或 INT4）存储，可大幅减少内存占用。</li>
<li>精度损失极小，因为注意力机制对 K/V 矩阵中的微小取整噪声具有较强的容忍度。</li>
</ul>
<p>用一种更为直观的方式理解：注意力机制包容性强，就像听 128kbps 的歌曲 —— 细节虽有损失，但整体旋律依旧清晰。</p>
<h3 data-id="heading-21"><strong>6.3 反量化 or 直接在整数域中进行计算</strong></h3>
<p>两种实现方式：</p>
<p>1）动态反量化（Dequant on-the-fly）</p>
<ul>
<li>在计算注意力时，将 INT8/INT4 临时转回 FP16</li>
<li>有轻微计算开销，但内存效率高</li>
</ul>
<p>2）在整数域中直接计算（Compute directly in integer domain）</p>
<ul>
<li>充分利用支持低精度运算的硬件（如支持 INT8 的 GPU）</li>
<li>速度更快、内存数据移动量更少，但工程实现稍复杂</li>
</ul>
<h3 data-id="heading-22"><strong>6.4 实用建议</strong></h3>
<ul>
<li>将 KV 缓存量化与分层混合精度结合使用，效果最佳。</li>
<li>INT8 KV 缓存通常很安全；若使用 INT4，建议配合高级取整策略（如 GPTQ 或 AWQ）。</li>
<li>务必在长序列上进行测试 —— 短上下文的基准测试无法暴露潜在的模型幻觉或词元错位问题。</li>
</ul>
<h2 data-id="heading-23"><strong>07 量化技术实战工作流</strong></h2>
<p>在深入研究了量化的原理、误差来源和高级技巧后，我意识到真正的挑战不在于理解量化，而在于如何安全地实施它而不破坏模型。以下是我的实践方法。</p>
<h3 data-id="heading-24"><strong>7.1 准备校准数据集</strong></h3>
<p>在调整任何权重之前，首先准备一个体量小但具有代表性的数据集：</p>
<ul>
<li>包含 100-500 条覆盖模型典型任务的输入序列</li>
<li>目的：记录每一层激活值的数值范围和分布形态，从而为后续的量化过程提供准确的统计依据。</li>
<li>原因：如果推理时的激活值分布与校准数据偏差过大，INT4 量化可能会失败</li>
</ul>
<h3 data-id="heading-25"><strong>7.2 逐层确定精度</strong></h3>
<p>并非所有网络层都能同等程度地适应 INT4 精度：</p>
<ul>
<li>MLP 层和大多数注意力权重 → 采用 INT4</li>
<li>嵌入层 → 若存在风险则采用 INT8</li>
<li>LayerNorm、LM Head 及有时首个投影层 → 回退至 FP16 精度</li>
</ul>
<h3 data-id="heading-26"><strong>7.3 执行量化操作</strong></h3>
<ul>
<li>首先进行训练后量化（PTQ），通常将所有权重转为 INT8，检查模型输出</li>
<li>然后使用 GPTQ 或 AWQ 逐步将 MLP /注意力层降至 INT4</li>
<li>始终将敏感网络层保持在 FP16 精度</li>
</ul>
<p>此阶段是迭代过程：应用量化 → 测试 → 调整网络层精度</p>
<h3 data-id="heading-27"><strong>7.4 评估与调试</strong></h3>
<p>这是理论照进现实的环节：</p>
<ul>
<li>使用真实场景的提示词进行测试，而非仅依赖基准数据集</li>
<li>检查是否出现幻觉、词元错位或推理能力下降</li>
<li>若某网络层表现异常，可选择性地恢复其精度或尝试按通道缩放</li>
</ul>
<h3 data-id="heading-28"><strong>7.5 微调（可选步骤）</strong></h3>
<p>对于激进的低比特量化（如 INT4、混合 3-4 位量化），有时需要进行轻量级的量化感知微调：</p>
<ul>
<li>在校准数据上训练几个 epoch</li>
<li>让模型适应量化引入的噪声</li>
<li>通常能将 INT4 的性能表现提升至接近 FP16 水平</li>
</ul>
<h3 data-id="heading-29"><strong>7.6 部署就绪</strong></h3>
<p>当量化稳定后：</p>
<ul>
<li>KV 缓存也进行量化（INT8/INT4），提升内存效率</li>
<li>对那些被特意保留为较高精度的层，已采取保护措施</li>
<li>模型已通过长上下文任务测试</li>
</ul>
<p>最终成果：内存占用更小，推理速度更快，精度损失微乎其微。当第一次看到 70B 参数的模型在单张 GPU 上流畅运行时，那种感觉堪称神奇。</p>
<h2 data-id="heading-30"><strong>08 应用场景</strong></h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d618a8742c514060bc97d26ca460770c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766102031&amp;x-signature=uBZ6sw9uGFogqzFSU%2BxSu%2FZSPNw%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>端侧 AI（On-Device AI）</strong> ：量化让我能直接在笔记本、边缘设备甚至手机上运行大语言模型。过去需要多卡 GPU 服务器的模型，如今单张 GPU 就能装下，让 AI 能够进行实时交互，摆脱云端延迟。我用它来做笔记、进行代码补全、当离线聊天助手 —— 就像把一台超级计算机装进了背包里。</li>
<li><strong>高性价比的云端部署（Cost-Efficient Cloud Deployment）</strong> ：即使在云端，量化也能大幅降低 GPU 内存占用，使单个节点能够服务更多用户，大幅节省运维成本。例如，如果一个 13B 模型在 INT4 精度下的表现几乎与 FP16 相当，但 GPU 内存占用减少了一半，这样使得预算有限的团队也可以部署高性能的 LLM。</li>
<li><strong>长上下文应用（Long-Context Applications）</strong> ：通过降低 KV 缓存的内存占用，使得处理长文档成为可能。借助 INT8 或 INT4 的 KV 缓存，我成功实现了整本书籍的摘要生成、分析法律合同，甚至维持数小时的连续对话而不会爆内存。这让虚拟助手、教学系统和摘要工具能无缝处理超长上下文。</li>
<li><strong>多模型协作流水线（Multi-Model Pipelines）</strong> ：量化模型在混合流水线中表现尤为出色。我经常用小型 INT4 模型做初步筛选或生成初始建议，再将结果交给更大的模型进行最终推理。若无量化技术，并行调度多个模型会很容易超出内存限制。而现在，就像在一台机器上部署了一整个 AI 专家团队。</li>
<li><strong>研究与实验（Research and Experimentation）</strong> ：最后，量化技术让实验变得更快速、更便宜。我可以在消费级 GPU 上迭代新架构、测试模型消融实验或微调模型，无需等待昂贵的专用硬件。这极大加速了我们的学习与实验进程，让大模型研究变得更加触手可及。</li>
</ul>
<p><strong>END</strong></p>
<p><strong>本期互动内容 🍻</strong></p>
<p><strong>❓你觉得未来大模型会默认以量化形式发布，还是保留“原始精度+按需量化”的模式？</strong></p>
<p><strong>本文经原作者授权，由 Baihai IDP 编译。如需转载译文，请联系获取授权。</strong></p>
<p><strong>原文链接：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fbhavishyapandit9.substack.com%2Fp%2Fdeep-dive-into-quantization-of-llms" target="_blank" title="https://bhavishyapandit9.substack.com/p/deep-dive-into-quantization-of-llms" ref="nofollow noopener noreferrer">bhavishyapandit9.substack.com/p/deep-dive…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从JS云函数到MCP：打造跨平台AI Agent工具的工程实践]]></title>    <link>https://juejin.cn/post/7582599972950982683</link>    <guid>https://juejin.cn/post/7582599972950982683</guid>    <pubDate>2025-12-12T08:43:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582599972950982683" data-draft-id="7582422818311372851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从JS云函数到MCP：打造跨平台AI Agent工具的工程实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-12T08:43:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哔哩哔哩技术"/> <meta itemprop="url" content="https://juejin.cn/user/3030701626893405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从JS云函数到MCP：打造跨平台AI Agent工具的工程实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3030701626893405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哔哩哔哩技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:43:39.000Z" title="Fri Dec 12 2025 08:43:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>构建 AI 工具生态这件事上，过去一年我们做了不少尝试。</p>
<p>回头看，会觉得这条路径像是在搭建一条越来越清晰的“能力生产线”：</p>
<blockquote>
<p>从写 JS → Agent Tool 工具 → 成为 MCP 工具 → 成为跨平台 Agent 能力。</p>
</blockquote>
<p>这篇文章我们就按这条演进路线，把底层逻辑、踩坑经验和最终的工程方案完整讲清楚。</p>
<h2 data-id="heading-0"><strong>一、先做简单介绍</strong></h2>
<p>我们做了一个“在线 JS 云函数平台”，它的本质是：把写一个 JS 函数，变成给 AI 赋予一个 Tool 新能力。</p>
<p>这套系统经历了三个阶段：</p>
<p><strong>1.  第一版：</strong> 只是 Flowise 里的一个 LangChain StructuredTool 扩展，能在工作流里被 Agent 调用。</p>
<blockquote>
<p><strong>Flowise</strong>（<em><a href="https://link.juejin.cn?target=https%3A%2F%2Fflowiseai.com%2F" target="_blank" title="https://flowiseai.com/" ref="nofollow noopener noreferrer">flowiseai.com/</a></em> ） 是一款开源、可视化的 AI 工作流工具，通过拖拽节点即可构建 LLM 应用或 Agent。它底层基于 LangChain 的 TypeScript 版本，因此天然具备模型调用、工具调用、链式处理、记忆与向量检索等能力。</p>
<p>当时我们在技术选型时使用 Flowise 做AI工作流平台有两个原因：</p>
<p>一是它基于 LangChain 的 TypeScript 版本——在早期 AI 框架还不成熟时，这是少数原生支持 TS 的方案；二是它提供了可拖拽的可视化工作流，能让我们快速搭建和验证 AI 原型。</p>
</blockquote>
<p><strong>2.  第二版：</strong> 演进为一个浏览器里的 云函数 IDE：在线写代码、调试、沙箱运行时、连内网 gRPC/HTTP/MySQL。</p>
<p><strong>3.  现在：</strong> 接上 MCP 协议，变成一个可以被「任何支持 MCP 的 Agent / Studio」跨平台调用的独立工具平台，并支持 SSE + Streamable HTTP 两种流式协议。</p>
<h2 data-id="heading-1"><strong>二、为什么我们需要“AI 工具能力层”？</strong></h2>
<p>在我们内部构建 AI 应用（客服、直播运营助手等）时，遇到几个非常典型的痛点。</p>
<h3 data-id="heading-2"><strong>1. 工具很多，但每接一次 AI，都要重写一遍工具</strong></h3>
<ul>
<li>想让 AI 查开播状态、查卡顿、查稿件、给用户发通知……</li>
<li>后端能力其实都有，但每接一个新智能体，就要：</li>
</ul>

<ul>
<li>在某个项目里再写一遍调用代码</li>
<li>手动写结构化参数 / 返回值</li>
<li>校验、鉴权</li>
</ul>

<ul>
<li>每个团队都重新写一遍</li>
</ul>
<h3 data-id="heading-3"><strong>2. AI 需要的是“能力”，而不是“接口”</strong></h3>
<p>业务接口往往是这样的：</p>
<pre><code class="hljs language-ini" lang="ini">GET /room/info?<span class="hljs-attr">roomid</span>=<span class="hljs-number">123</span>
</code></pre>
<p>但是用户却会说：“查一下imzerooo开播状态”</p>
<p>这中间的自然语言 → 参数的语义映射，很难靠简单规则完成。</p>
<p>如果让开发者直接暴露接口，AI 是很难用好的。</p>
<h3 data-id="heading-4"><strong>3. JSON 不是 AI 友好的输入格式</strong></h3>
<p>内网接口通常返回一大坨 JSON。LLM 解析 JSON 没问题，但：</p>
<ul>
<li>
<p>字段多、嵌套深 → 容易丢字段</p>
</li>
<li>
<p>字段名杂乱 → 模型记不住</p>
</li>
<li>
<p>文本内容多 → 容易产生幻觉</p>
</li>
</ul>
<p>AI 友好的格式是：</p>
<ul>
<li>Markdown 表格</li>
<li>简洁的自然语言</li>
<li>提炼过的信息</li>
</ul>
<p>而不是整包 JSON。</p>
<h3 data-id="heading-5"><strong>4. 工具没有做成“资产层”</strong></h3>
<p>以前的工具要么：</p>
<ul>
<li>绑死在某个 AI 工作流上</li>
<li>埋在某个项目里</li>
<li>放在某个业务脚本中</li>
</ul>
<p>无法像资产一样复用。</p>
<p>所以一切问题的核心其实是：</p>
<blockquote>
<p>缺少一个可以写工具、管理工具、发布工具、复用工具的统一能力层。</p>
</blockquote>
<p>而我们做的，就是让这件事：<strong>只需写一段 JS 函数</strong>。</p>
<h2 data-id="heading-6"><strong>三、第一版：StructuredTool——</strong> <strong>工具能力的萌芽</strong></h2>
<p>最初我们是在 Flowise 里写 StructuredTool 组件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72ced04a48494603918827c4122ede20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=XtYbdQtaGdZM%2FUDGapbs6%2FslHaY%3D" alt="图片" loading="lazy"/></p>
<p>Flowise 底层基于 LangChain，所以我们写了很多 StructuredTool：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c02f6d395f04297a837fc8d5cc1a732~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=QEbEADudVWccw550Eu1boTTu7bo%3D" alt="截屏2025-12-12 15.43.12.png" loading="lazy"/></p>
<p>这一版有几个优点：</p>
<ul>
<li>
<p>工具能被 Agent 调用</p>
</li>
<li>
<p>参数有 schema</p>
</li>
<li>
<p>有一定的模块化</p>
</li>
</ul>
<p>但有几个局限：</p>
<ul>
<li>
<p>工具生命周期跟 Flowise 项目绑死</p>
</li>
<li>
<p>要写 TS、写 Node 项目，对效率很不友好</p>
</li>
<li>
<p>无法跨平台使用</p>
</li>
<li>
<p>JSON 处理还是要自己写</p>
</li>
<li>
<p>无法注入通用能力（如内网 SDK）</p>
</li>
</ul>
<p>于是我们开始考虑平台化。</p>
<h2 data-id="heading-7"><strong>四、第二版：在线 JS 云函数平台（NodeVM 运行时）</strong></h2>
<p>我们打造了一套全新的平台：在线 JS 云函数平台。</p>
<p>开发者不需要知道 Flowise、LangChain，也不用开Node 项目。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/222439794fe443fdae66e2b1fe4dc93d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=m9boE%2FVLT8PyKrzwBwNFjhVuAg4%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-8"><strong>4.1 NodeVM：一个安全可控的 JS 执行沙箱</strong></h3>
<p>我们基于 vm2（NodeVM）做了一个“可控的 JS 执行环境”。</p>
<ul>
<li>
<p>运行时基于 StructureTool</p>
</li>
<li>
<p>NodeVM 作为安全隔离的执行环境</p>
</li>
<li>
<p>自动注入企业内部能力（统一上下文能力层）</p>
</li>
</ul>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/** 
 * 核心思路抽象版 
 */</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeVM</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vm2'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StructuredTool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/tools'</span>
<span class="hljs-comment">//...</span>

classDynamicToolextendsStructuredTool { 
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ name, description, schema, code }</span>) { 
    <span class="hljs-variable language_">super</span>({ name, description, schema }) 
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">code</span> = code <span class="hljs-comment">// 用户在在线编辑器里写的 JS 代码 </span>
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">_call</span>(<span class="hljs-params">args, runManager, flowContext</span>) {
    <span class="hljs-comment">// 1. 构建沙箱（所有注入能力都放在这里） </span>
    <span class="hljs-keyword">const</span> sandbox = { 
      <span class="hljs-comment">// 用户传入的参数转成 $xxx</span>
      ...<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(args).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">[k, v]</span>) =&gt;</span> [<span class="hljs-string">`$<span class="hljs-subst">${k}</span>`</span>, v])),
      
      <span class="hljs-comment">// 内部上下文（cookie/env/session） </span>
      <span class="hljs-attr">$flow</span>: flowContext,  
      <span class="hljs-attr">$cookie</span>: flowContext.<span class="hljs-property">cookie</span>,
      
      <span class="hljs-comment">// 内网能力封装（gRPC/HTTP） </span>
      <span class="hljs-attr">$yuumi</span>: yuumi,
      
      <span class="hljs-comment">// 结果转换工具（用于把 JSON 转成更 AI 友好的 Markdown 表格）  </span>
      <span class="hljs-attr">$json2MarkdownTable</span>: json2MarkdownTable,
      
      <span class="hljs-comment">// 内部 AI 模型     </span>
      <span class="hljs-attr">$biliLLM</span>: biliLLMClient  
    }
    
    <span class="hljs-comment">// 2. 构建 NodeVM 沙箱 </span>
    <span class="hljs-keyword">const</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NodeVM</span>({ 
      sandbox,   
      <span class="hljs-attr">console</span>: <span class="hljs-string">"inherit"</span>,    
      <span class="hljs-attr">require</span>: {      
        <span class="hljs-attr">builtin</span>: allowedBuiltinDeps,    
        <span class="hljs-attr">external</span>: allowedExternalDeps  
      }
    })
    
    <span class="hljs-comment">// 3. 执行开发者写的云函数代码 </span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> vm.<span class="hljs-title function_">run</span>(   
      <span class="hljs-string">`module.exports = async () =&gt; { <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.code}</span> }()`</span>,   
      __dirname   
    ) 
  }
}
</code></pre>
<p>它既能隔离风险，又能注入能力：</p>
<ul>
<li>
<p>禁止访问文件系统</p>
</li>
<li>
<p>禁止随意 require</p>
</li>
<li>
<p>只开放白名单依赖</p>
</li>
<li>
<p>内置 $yuumi（内网 gRPC/HTTP 调用）</p>
</li>
<li>
<p>内置 $json2MarkdownTable</p>
</li>
<li>
<p>内置 $cookie</p>
</li>
<li>
<p>内置 $flow（上下文）</p>
</li>
<li>
<p>内置 内部 AI 能力</p>
</li>
</ul>
<p>于是开发者传入的业务代码类似这样：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ed89f9e732048ab8bf56270f1d81638~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=pdpqv7yiItuQv7bBXc%2FJTPLjNaw%3D" alt="截屏2025-12-12 16.15.57.png" loading="lazy"/></p>
<h3 data-id="heading-9"><strong>4.2 在线调试：monaco-editor+ Mock</strong> <strong>+ 沙箱日志</strong></h3>
<p>编辑器底层用的是 microsoft/monaco-editor，好处是：</p>
<ul>
<li>
<p>TypeScript / JS 语法高亮</p>
</li>
<li>
<p>可以做一些简单的智能提示</p>
</li>
<li>
<p>UI 很像 VSCode，大家上手成本低</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f3e93016c954b8480957446f806fd1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=TrJO7at%2FgD5xeQNthjhUgHARBpU%3D" alt="图片" loading="lazy"/></p>
<p>调试方面：</p>
<ul>
<li>
<p>提供了一个 参数 Mock 面板：可以填入调用时的 JSON</p>
</li>
<li>
<p>点击「运行」，平台会在沙箱里跑一遍你的函数，把：日志打印（console.log）、返回字符串、可能的异常，全都展示出来</p>
</li>
</ul>
<p>每次保存，我们都会生成一个版本：</p>
<ul>
<li>
<p>当前编辑的是“草稿”</p>
</li>
<li>
<p>发布的时候会把某个版本标记为发布</p>
</li>
<li>
<p>出现问题可以一键回滚到上一版</p>
</li>
</ul>
<p>最后，开发者只需要在编辑器里写一个 “普通 JS 函数”，但：</p>
<ul>
<li>
<p>安全隔离由 NodeVM 负责</p>
</li>
<li>
<p>内网调用靠 $yuumi</p>
</li>
<li>
<p>会话靠 $cookie</p>
</li>
<li>
<p>AI 友好的结果格式靠 $json2MarkdownTable</p>
</li>
</ul>
<h3 data-id="heading-10"><strong>4.3 Tool Arguments：为 AI 帮开发者“定义接口”</strong></h3>
<p>传统开发写接口参数：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">roomid:</span> <span class="hljs-type">string</span>
</code></pre>
<p>为此，我们提供了转为 Tool Arguments 的可视化配置：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b050b1bb0b048d1beff5ef23aa51a69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=wrqLT12vzLcwNyoGAqCWoZMoPjc%3D" alt="图片" loading="lazy"/></p>
<p>它会统一生成：</p>
<ul>
<li>MCP Tool 的 JSON Schema</li>
<li>StructuredTool 的 Zod Schema</li>
<li>NodeVM 内 $roomid 变量</li>
</ul>
<p>一次配置，全平台复用。</p>
<h3 data-id="heading-11"><strong>4.4 工具市场：企业内部的 Agent 工具仓库</strong></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48e9a510bb8e4c23854d4c95e491e9c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=YhlDZS1wc%2Ba51GW36m25sPM4K1c%3D" alt="图片" loading="lazy"/></p>
<p>我们提供了工具市场：</p>
<ul>
<li>各部门把工具上架</li>
<li>其他部门直接复用</li>
<li>工具行为一致，调用方式一致</li>
<li>避免重复开发</li>
</ul>
<p>工具从“项目资产”变成“企业能力”。</p>
<h2 data-id="heading-12"><strong>五、第三版：接入 MCP</strong> <strong>——让工具跨平台、跨模型、跨框架</strong></h2>
<p>做到第二版时，工具已经变得很好用了。但还缺一块：</p>
<blockquote>
<p>同一份工具定义，既能在 Flowise 里当 LangChain StructuredTool 用，又能在 MCP 里变成跨平台 ToolCall。</p>
</blockquote>
<h3 data-id="heading-13"><strong>5.1 MCP 是什么？以及一个常见误区</strong></h3>
<p>MCP 全称 Model Context Protocol，可以简单理解为：</p>
<blockquote>
<p>给“大模型 + 工具调用”定义了一个“统一插线板”</p>
</blockquote>
<p>它解决的是：</p>
<ul>
<li>
<p>大模型想调用一个外部工具</p>
</li>
<li>
<p>这个工具可能跑在本机、另一台服务器、甚至另一个团队的系统里</p>
</li>
<li>
<p>我们希望“调用方式”是统一、可描述、可流式的。</p>
</li>
</ul>
<h3 data-id="heading-14"><strong>5.2 一个常见误区：把旧接口一包就行了？</strong></h3>
<p>很多人第一反应是：</p>
<blockquote>
<p>那我把现在的业务 HTTP 接口包成一个 MCP 工具，不就行了吗？</p>
</blockquote>
<p>理论上可以，实践里有两个坑：</p>
<p><strong>1.  自然语言 ≠ 接口参数</strong></p>
<p>用户会说：“查一下未完成的任务”。但你的接口长这样：/tasks?status=1&amp;owner_id=xxx。中间这层 “自然语言 → status=1” 的映射，需要：</p>
<ul>
<li>prompt / few-shot</li>
<li>枚举表 / 映射关系</li>
<li>甚至分类模型。</li>
</ul>
<p>所以我们在 Tool Arguments 设置时一定要尽量贴近自然语言，比如 status 描述写成“任务的进度状态（未开始/进行中/已完成）”，而不是“1/2/3”。</p>
<p><strong>2.  JSON 返回 ≠ AI 可读</strong></p>
<p>很多内部接口返回一大坨嵌套 JSON，LLM 虽然能解析，但：</p>
<ul>
<li>容易“漏看”字段；</li>
<li>回答会很啰嗦或不稳定。</li>
<li>所以我们在云函数层统一规定：</li>
</ul>
<p><strong>返回给 AI 的一定是“人类可读”的文本/Markdown，</strong> JSON 只是中间态。</p>
<p>这就是前面 $json2MarkdownTable 那段代码存在的原因。</p>
<h3 data-id="heading-15"><strong>5.3 StructuredTool → MCP：我们是怎么做“代理层”的？</strong></h3>
<p>前面说了两件事：</p>
<ul>
<li>
<p>工具在平台内部用 LangChain StructuredTool + NodeVM 来执行</p>
</li>
<li>
<p>我们希望同一份工具定义，既能在 Flowise 里用，也能被任意支持 MCP 的 Agent / Studio 调用</p>
</li>
</ul>
<p><strong>createMCPServer：Express 里的一层 MCP 网关</strong></p>
<p>在服务端，我们做了一层很薄的 MCP 网关，挂在 Express 应用上：</p>
<pre><code class="hljs language-ruby" lang="ruby">export function createMCPServer({ app, <span class="hljs-title class_">AppDataSource</span> }: <span class="hljs-title class_">App</span>){
  <span class="hljs-regexp">//</span> 单个云函数 → <span class="hljs-variable constant_">MCP</span>-<span class="hljs-title class_">Streamable</span>HTTP  
  app.post(<span class="hljs-string">'/api/mcp/function-tool/:toolId'</span>, singleToolCreateStreamableHTTPServer)  
  /<span class="hljs-regexp">/ 多个云函数组合 → MCP-StreamableHTTP  app.post('/api</span><span class="hljs-regexp">/mcp/</span><span class="hljs-symbol">:mcpId<span class="hljs-string">', multipleToolCreateStreamableHTTPServer)
  
  // 会话后续请求复用
  app.get('</span>/api/mcp/function-tool/</span><span class="hljs-symbol">:id<span class="hljs-string">', handleSessionRequest) 
  app.delete('</span>/api/mcp/function-tool/</span><span class="hljs-symbol">:id<span class="hljs-string">', handleSessionRequest)  
  app.get('</span>/api/mcp/</span><span class="hljs-symbol">:mcpId<span class="hljs-string">', handleSessionRequest)
  app.delete('</span>/api/mcp/</span><span class="hljs-symbol">:mcpId<span class="hljs-string">', handleSessionRequest)
  
  const transports = { 
    streamable: {} as Record&lt;string, StreamableHTTPServerTransport&gt;  
  }
  
  // ... 省略 SSE 相关 ...
}
</span></span></code></pre>
<ul>
<li>对外就是几条 HTTP 路由；</li>
<li>对内维护一个 streamable 的 transport 池，用 sessionId 作为 key。</li>
</ul>
<p>这样，不同 AI Studio / Agent 只要知道某个 URL，就可以把它当 MCP 端点来用。</p>
<p><strong>Streamable HTTP：用 session 管住一条“长连接”</strong></p>
<p>StreamableHTTPServerTransport 是 MCP 官方 SDK 提供的一个传输实现，用来做 Streamable HTTP 模式。我们做的事情有两种情况：</p>
<ol>
<li>
<p>客户端第一次初始化（没有 sessionId）；</p>
</li>
<li>
<p>之后所有请求都带上 mcp-session-id 头，复用之前的 session。</p>
</li>
</ol>
<p>核心代码大概是这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createStreamableHTTP</span>(<span class="hljs-params">config: CreateMcpServerConfig</span>){  
  <span class="hljs-keyword">const</span> { req, res, username } = config
  <span class="hljs-keyword">const</span> sessionId = req.<span class="hljs-property">headers</span>[<span class="hljs-string">'mcp-session-id'</span>] <span class="hljs-keyword">as</span> string | <span class="hljs-literal">undefined</span> 
  <span class="hljs-keyword">let</span> <span class="hljs-attr">transport</span>: <span class="hljs-title class_">StreamableHTTPServerTransport</span>
  
  <span class="hljs-keyword">if</span> (sessionId &amp;&amp; transports.<span class="hljs-property">streamable</span>[sessionId]) {   
    <span class="hljs-comment">// ① 有 sessionId，复用之前的 transport   </span>
    transport = transports.<span class="hljs-property">streamable</span>[sessionId]  
  } elseif (!sessionId &amp;&amp; <span class="hljs-title function_">isInitializeRequest</span>(req.<span class="hljs-property">body</span>)) {  
    <span class="hljs-comment">// ② 首次初始化，请求体符合 MCP 初始化格式   </span>
    transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamableHTTPServerTransport</span>({  
      <span class="hljs-attr">sessionIdGenerator</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">randomUUID</span>(),  
      <span class="hljs-attr">onsessioninitialized</span>: <span class="hljs-function">(<span class="hljs-params">sessionId</span>) =&gt;</span> {   
        transports.<span class="hljs-property">streamable</span>[sessionId] = transport    
      }
   })
    
   <span class="hljs-comment">// 连接关闭时清理掉这个 session </span>
   transport.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> {    
     <span class="hljs-keyword">if</span> (transport.<span class="hljs-property">sessionId</span>) {  
       <span class="hljs-keyword">delete</span> transports.<span class="hljs-property">streamable</span>[transport.<span class="hljs-property">sessionId</span>] 
       opsLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`[Streamable] 删除sessionId: username=<span class="hljs-subst">${username}</span> sessionId=<span class="hljs-subst">${transport.sessionId}</span>`</span>)    
     }
   }
   
   <span class="hljs-keyword">const</span> server = <span class="hljs-title function_">buildMcpServer</span>({  
     ...config,   
     <span class="hljs-attr">transport</span>: <span class="hljs-string">'streamable-http'</span>   
   })
   
   <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">connect</span>(transport) 
 } <span class="hljs-keyword">else</span> { 
   <span class="hljs-comment">// 既不是初始化，又没有合法 sessionId：直接返回错误   </span>
   res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>({  
     <span class="hljs-attr">jsonrpc</span>: <span class="hljs-string">'2.0'</span>,   
     <span class="hljs-attr">error</span>: {   
       <span class="hljs-attr">code</span>: -<span class="hljs-number">32000</span>,  
       <span class="hljs-attr">message</span>: <span class="hljs-string">'Bad Request: No valid session ID provided'</span>    
     },
     <span class="hljs-attr">id</span>: <span class="hljs-literal">null</span>  
   })   
   <span class="hljs-keyword">return</span>  
  }
  
  <span class="hljs-keyword">await</span> transport.<span class="hljs-title function_">handleRequest</span>(req, res, req.<span class="hljs-property">body</span>)
}
</code></pre>
<p>配合一个统一的会话请求入口：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">handleSessionRequest</span>(<span class="hljs-params">req: Request, res: Response</span>)</span>{  
  <span class="hljs-keyword">const</span> sessionId = req.headers[<span class="hljs-string">'mcp-session-id'</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span> | <span class="hljs-function">undefined  
  <span class="hljs-title">if</span> (<span class="hljs-params">!sessionId || !transports.streamable[sessionId]</span>)</span> { 
    res.status(<span class="hljs-number">400</span>).send(<span class="hljs-string">'Invalid or missing session ID'</span>)   
    <span class="hljs-keyword">return</span> 
  }
  
  <span class="hljs-keyword">const</span> transport = transports.streamable[sessionId]  
  <span class="hljs-keyword">await</span> transport.handleRequest(req, res)}
</code></pre>
<p>这样实现的好处是：客户端只需要记住一个 mcp-session-id，之后所有请求都可以复用同一条 Streamable HTTP 会话。</p>
<p><strong>buildMcpServer：真正把“工具注册到 MCP 协议”</strong></p>
<p>首先，用户可以将云函数平台创建的智能体工具代理到MCP协议上，一个MCP可以关联多个工具</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd6378fecd66456ab1223de01e0bfd3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=zwA6XxmY7bHCl9wLE6pJI17L0wg%3D" alt="图片" loading="lazy"/></p>
<p>接下来是最关键的一步：用官方 McpServer 把 Tool Registry 里的工具挂成 MCP Tool。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildMcpServer</span>(<span class="hljs-params">config: BuildMcpServerConfig</span>): <span class="hljs-title class_">McpServer</span> {
  <span class="hljs-keyword">const</span> { name, tools, cookie, env, id, <span class="hljs-keyword">type</span>, username, transport } = config
  
  <span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">McpServer</span>({  
    name, 
    <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span> 
  })
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> tool <span class="hljs-keyword">of</span> tools) { 
    <span class="hljs-comment">// 1）把数据库里的元信息，转成 DynamicStructuredTool 入参</span>
    <span class="hljs-keyword">const</span> obj = {      
      <span class="hljs-attr">name</span>: tool.<span class="hljs-property">name</span>,
      <span class="hljs-attr">description</span>: tool.<span class="hljs-property">description</span>,  
      <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>(<span class="hljs-title function_">convertSchemaToZod</span>(tool.<span class="hljs-property">schema</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span> | <span class="hljs-built_in">object</span>)),      
      <span class="hljs-attr">code</span>: tool.<span class="hljs-property">func</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>  
    }
    
    <span class="hljs-comment">// DynamicStructuredTool 内部就是一个“动态 StructuredTool” + NodeVM 沙箱</span>
    <span class="hljs-keyword">const</span> dynamicStructuredTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>(obj)
    
    <span class="hljs-comment">// Flow 信息：cookie + env（来自 MCP URL 上的 sign / 其它query)</span>
    dynamicStructuredTool.<span class="hljs-title function_">setFlowObject</span>({ 
      cookie,  
      <span class="hljs-attr">env</span>: <span class="hljs-keyword">typeof</span> env === <span class="hljs-string">'object'</span> &amp;&amp; <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(env).<span class="hljs-property">length</span> ? env : {}   
    })
    
    <span class="hljs-comment">// 2）把我们在 UI 里配置的 Tool Arguments schema，转成 MCP 需要的 zod 参数定义 </span>
    <span class="hljs-keyword">const</span> schemaParser = (tool.<span class="hljs-property">schema</span> ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(tool.<span class="hljs-property">schema</span>) : []) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Schema</span>[]
    
    <span class="hljs-keyword">const</span> paramsSchema = schemaParser.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">res, cur</span>) =&gt;</span> {  
      <span class="hljs-keyword">if</span> (cur.<span class="hljs-property">required</span>) { 
        res[cur.<span class="hljs-property">property</span>] = z[cur.<span class="hljs-property">type</span>]({ <span class="hljs-attr">required_error</span>: <span class="hljs-string">`<span class="hljs-subst">${cur.property}</span> required`</span> })   
          .<span class="hljs-title function_">describe</span>(cur.<span class="hljs-property">description</span>) <span class="hljs-keyword">as</span> z.<span class="hljs-property">ZodTypeAny</span>   
      } <span class="hljs-keyword">else</span> {   
        res[cur.<span class="hljs-property">property</span>] = z[cur.<span class="hljs-property">type</span>]()   
          .<span class="hljs-title function_">describe</span>(cur.<span class="hljs-property">description</span>)     
          .<span class="hljs-title function_">optional</span>() <span class="hljs-keyword">as</span> z.<span class="hljs-property">ZodTypeAny</span>    
      }
      <span class="hljs-keyword">return</span> res   
    }, {} <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)
    
    <span class="hljs-comment">// 3）用官方 server.tool() 方法注册 MCP Tool </span>
    server.<span class="hljs-title function_">tool</span>(tool.<span class="hljs-property">name</span>, tool.<span class="hljs-property">description</span>, paramsSchema, <span class="hljs-keyword">async</span> (args, _extra) =&gt; {   
      <span class="hljs-comment">// 注意：这里的 call() 对应的就是 LangChain StructuredTool._call()  </span>
      <span class="hljs-keyword">const</span> runnerResult = <span class="hljs-keyword">await</span> dynamicStructuredTool.<span class="hljs-title function_">call</span>({  
        ...args
      })
      
      <span class="hljs-comment">// 线上环境做一层使用上报（方便统计谁在用哪个 MCP）</span>
      <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">DEPLOY_ENV</span> === <span class="hljs-string">'prod'</span>) {   
        <span class="hljs-title function_">reportMcpUse</span>({   
          id,  
          <span class="hljs-keyword">type</span>,   
          name,   
          username,  
          transport  
        })   
       }
       
       <span class="hljs-comment">// MCP 协议统一的返回格式：content[] 数组  </span>
       <span class="hljs-keyword">return</span> {    
         <span class="hljs-attr">content</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attr">text</span>: runnerResult }]  
       }
     })
   }
   
   <span class="hljs-keyword">return</span> server
 }
</code></pre>
<p>把Tool Registry 里的：</p>
<ul>
<li>
<p>name</p>
</li>
<li>
<p>description</p>
</li>
<li>
<p>schema（以数组 JSON 形式存）</p>
</li>
<li>
<p>func（在线编辑器里的 JS 代码）</p>
</li>
</ul>
<p>按 MCP 需要的格式做了一层映射：</p>
<ul>
<li>
<p>输入 → paramsSchema（zod 校验）</p>
</li>
<li>
<p>执行 → dynamicStructuredTool.call()</p>
</li>
<li>
<p>输出 → MCP 标准的 content[{ type: 'text', text: ... }]</p>
</li>
</ul>
<p>StructuredTool 内部：从 MCP 入参到 NodeVM 执行的最后一步</p>
<p>DynamicStructuredTool.call() 里面最终会走到 _call()，这一步就是前面介绍的 NodeVM 沙箱执行：</p>
<ul>
<li>
<p>把 MCP 传进来的参数变成 $xxx 变量</p>
</li>
<li>
<p>把 cookie / env、以及会话信息塞进 $flow</p>
</li>
<li>
<p>注入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mi>u</mi><mi>u</mi><mi>m</mi><mi>i</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">yuumi、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">uu</span><span class="mord mathnormal">mi</span><span class="mord cjk_fallback">、</span></span></span></span></span>json2MarkdownTable、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>i</mi><mi>l</mi><mi>i</mi><mi>I</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>x</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">biliIndex、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord cjk_fallback">、</span></span></span></span></span>deepseek、$chatgpt 等能力</p>
</li>
<li>
<p>在受限依赖白名单下创建 NodeVM</p>
</li>
<li>
<p>以 module.exports = async function() { ${this.code} }() 的形式执行开发者写的 JS</p>
</li>
</ul>
<p>对于上层 MCP 调用方来说：</p>
<blockquote>
<p>调用了一个名字叫 QueryLiveRoomInfo 的 MCP 工具，传了一些参数，收到了一个文本/Markdown 结果</p>
</blockquote>
<p>而对于我们平台来说，这中间其实已经执行了一整套：</p>
<blockquote>
<p>MCP → McpServer.tool → DynamicStructuredTool → NodeVM → 内网服务的完整链路。</p>
</blockquote>
<p><strong>可复用可共享的MCP市场</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ed971fdf5df4a2ab0be5684d57c01e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=Txis9r1N0n1kXq8%2F5QLbV1L1T%2Bs%3D" alt="图片" loading="lazy"/></p>
<p>对于 MCP 新手，我们在平台上还提供了“MCP 市场” 的入口，里面还提供了一键调试：</p>
<ul>
<li>
<p>不需要真的连上一个大模型</p>
</li>
<li>
<p>直接在浏览器里模拟一次 MCP ToolCall</p>
</li>
<li>
<p>看看云函数有没有跑对、返回是不是 AI 友好的格式</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dce174203064e108bcdb39c92288af8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=%2FV0T98v4oJyRcUTStOEOPSyN3tE%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-16"><strong>六、身份鉴权：MCP 是独立服务，安全必须先想清楚</strong></h2>
<p>MCP 本质上是一个“跨平台的服务访问入口”，如果不做鉴权，很容易变成无法管理。我们的做法大致是这样：</p>
<ol>
<li> 注册阶段就要带 sign：</li>
</ol>
<ul>
<li>每个 MCP 工具的注册地址必须带一个 sign 参数</li>
<li>sign 是基于内网规范签出的签名</li>
<li>没有合法签名，工具不会被注册成功</li>
</ul>
<ol start="2">
<li> 调用阶段统一 Proxy：</li>
</ol>
<ul>
<li>外部 Agent 调用 MCP Server</li>
<li>MCP Server 把调用转发给云函数平台的 Proxy 层</li>
<li>Proxy 层会：</li>
</ul>

<ul>
<li>校验 sign</li>
<li>注入对应的 $cookie / 会话</li>
<li>再去调真正的内网业务接口</li>
</ul>
<ol start="3">
<li> 业务侧拿到的是“处理后的内网协议”：</li>
</ol>
<ul>
<li>
<p>Proxy 会把 sign 解密、校验后，以内部统一格式透传给业务</p>
</li>
<li>
<p>避免在业务里掺杂各种外部协议细节</p>
</li>
</ul>
<p>这样，MCP 既可以对外暴露统一的工具接口，又仍然受控在内网的安全体系内</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e5f2ebf9d4142d4bc94d958b15b1ddc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=l%2F1ltMpqyWMkMgGXyElyZedDkM4%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-17"><strong>七、结语：把“接 AI”变成“写一个云函数”</strong></h2>
<p>从 AI工作流 → StructuredTool → 云函数平台 → MCP 的这条路径，我们最终得到了：</p>
<ul>
<li>
<p>一个统一的工具定义方式：元信息</p>
</li>
<li>
<p>一个统一的执行方式：NodeVM</p>
</li>
<li>
<p>一个统一的调用协议：MCP</p>
</li>
<li>
<p>一个统一的共享方式：工具市场</p>
</li>
<li>
<p>一个统一的安全体系：sign + cookie</p>
</li>
</ul>
<p>也让我们真正做到了：</p>
<p>让业务同学不再关心“怎么接 AI”，而是只需要关心“我能给 AI 提供什么能力”。</p>
<p>把写一个 JS 函数，变成给 AI 加一个新能力。</p>
<p>未来我们还会继续提升运行时性能、正确性评估观测、深度研究等方向，把工具能力建设得更现代、更企业级。</p>
<p>-End-</p>
<p>作者丨Zerooo、Gengar</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TiDB详解与应用实战：分布式数据库的核心原理与最佳实践]]></title>    <link>https://juejin.cn/post/7582561515816763455</link>    <guid>https://juejin.cn/post/7582561515816763455</guid>    <pubDate>2025-12-12T07:00:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582561515816763455" data-draft-id="7582502441993977899" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TiDB详解与应用实战：分布式数据库的核心原理与最佳实践"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-12-12T07:00:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TiDB详解与应用实战：分布式数据库的核心原理与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:00:23.000Z" title="Fri Dec 12 2025 07:00:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1 TiDB架构设计与核心原理</h2>
<p>TiDB是PingCAP公司开发的开源分布式关系型数据库，采用计算存储分离的架构设计，完美结合了传统关系型数据库的ACID特性与NoSQL数据库的水平扩展能力。作为新一代的<strong>云原生数据库</strong>，TiDB完全兼容MySQL协议，使得现有MySQL应用可以几乎无缝迁移到TiDB平台，同时获得分布式架构带来的诸多优势。</p>
<h3 data-id="heading-1">1.1 核心架构组件与协作机制</h3>
<p>TiDB采用分层架构设计，包含三个核心组件：TiDB Server（计算层）、TiKV（存储层）和PD（调度层）。这种<strong>组件分离架构</strong>使得每个层级可以独立扩展和优化，提供了极大的灵活性。</p>
<ul>
<li><strong>TiDB Server（计算层）</strong> ：作为无状态SQL层，负责SQL解析、优化和执行。它兼容MySQL协议和大多数MySQL语法，应用程序可以像使用MySQL一样连接TiDB。TiDB Server将SQL请求转换为对TiKV的Key-Value操作，并汇总存储层返回的结果。</li>
<li><strong>TiKV（存储层）</strong> ：分布式键值存储引擎，基于Raft共识算法保证数据强一致性和高可用性。TiKV将数据划分为Region（默认96MB-256MB），每个Region通过Multi-Raft协议维护多个副本，确保数据安全和高可用。</li>
<li><strong>PD（Placement Driver）</strong> ：集群的"大脑"，负责元数据管理、全局时间戳分配、负载均衡和自动故障恢复。PD通过持续监控集群状态，自动调度Region副本，优化数据分布和负载均衡。</li>
</ul>
<h3 data-id="heading-2">1.2 数据分布与Region管理</h3>
<p>TiDB采用基于Range的数据分片策略，将整个Key-Value空间分成多个连续的段，每个段称为一个Region。当Region大小达到阈值（默认256MiB）时，会自动分裂为两个子Region；当Region因大量删除变得太小时，会将相邻小Region合并。这种<strong>自动分片机制</strong>确保了数据分布的动态平衡，避免了传统分库分表需要手动维护的复杂性。</p>
<p>PD组件通过多种调度器实现智能调度：</p>
<ul>
<li><strong>balance-leader-scheduler</strong>：保持不同节点的Leader均衡</li>
<li><strong>balance-region-scheduler</strong>：保持不同节点的Peer均衡</li>
<li><strong>hot-region-scheduler</strong>：保持不同节点的读写热点Region均衡</li>
</ul>
<h3 data-id="heading-3">1.3 分布式事务与一致性机制</h3>
<p>TiDB实现了完整的分布式事务机制，采用优化的两阶段提交（2PC）协议，并基于Percolator事务模型处理分布式事务。关键机制包括：</p>
<ul>
<li><strong>全局时间戳分配</strong>：PD作为全局时间戳分配器（TSO），为每个事务分配全局唯一且递增的时间戳，用于实现MVCC和全局快照隔离。</li>
<li><strong>异步提交优化</strong>：TiDB 4.0引入的Async Commit特性，对于小事务达到类似1PC的效果，减少网络往返次数，显著提升短事务性能。</li>
<li><strong>多版本并发控制（MVCC）</strong> ：TiKV实现多版本并发控制，每个数据修改都会生成新的版本，由时间戳区分版本，实现读写不阻塞的快照隔离。</li>
</ul>
<h2 data-id="heading-4">2 TiDB关键技术深度解析</h2>
<h3 data-id="heading-5">2.1 HTAP混合负载支持</h3>
<p>TiDB通过TiFlash组件实现HTAP能力，同时支持OLTP和OLAP工作负载。TiFlash是列式存储引擎，通过Multi-Raft Learner协议实时从TiKV复制数据，确保与TiKV之间的数据强一致性。</p>
<p><strong>行列混合架构</strong>的优势在于：</p>
<ul>
<li><strong>实时分析</strong>：TiFlash以低消耗不阻塞TiKV写入的方式实时复制数据，同步延迟控制在秒级，实现真正的实时分析。</li>
<li><strong>智能选择</strong>：TiDB优化器会根据查询特征和统计信息智能选择TiKV（行存）或TiFlash（列存），甚至在同一查询内混合使用两种存储。</li>
<li><strong>资源隔离</strong>：OLTP负载运行在TiKV上，OLAP复杂查询运行在TiFlash上，避免分析查询对事务处理的干扰。</li>
</ul>
<p>实际操作中，可以通过以下方式使用TiFlash：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 设置TiFlash副本</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> orders <span class="hljs-keyword">SET</span> TIFLASH REPLICA <span class="hljs-number">2</span>;

<span class="hljs-comment">-- 强制查询走TiFlash（TPC-H Query6优化）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-comment">/*+ read_from_storage(tiflash[lineitem]) */</span> 
       <span class="hljs-built_in">sum</span>(l_extendedprice <span class="hljs-operator">*</span> l_discount) <span class="hljs-keyword">as</span> revenue
<span class="hljs-keyword">FROM</span> lineitem
<span class="hljs-keyword">WHERE</span> l_shipdate <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'1994-01-01'</span>
  <span class="hljs-keyword">AND</span> l_shipdate <span class="hljs-operator">&lt;</span> date_add(<span class="hljs-string">'1994-01-01'</span>, <span class="hljs-type">interval</span> <span class="hljs-string">'1'</span> <span class="hljs-keyword">year</span>)
  <span class="hljs-keyword">AND</span> l_discount <span class="hljs-keyword">between</span> <span class="hljs-number">0.06</span> <span class="hljs-operator">-</span> <span class="hljs-number">0.01</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">0.06</span> <span class="hljs-operator">+</span> <span class="hljs-number">0.01</span>
  <span class="hljs-keyword">AND</span> l_quantity <span class="hljs-operator">&lt;</span> <span class="hljs-number">24</span>;
</code></pre>
<p>此示例展示了如何利用TiFlash加速分析型查询，<code>READ_FROM_STORAGE</code>提示符强制优化器使用列式存储。</p>
<h3 data-id="heading-6">2.2 弹性扩展与自动运维</h3>
<p>TiDB支持<strong>在线弹性扩展</strong>，可在不影响业务的情况下动态增减节点。计算层（TiDB Server）和存储层（TiKV）可以独立扩展，根据业务需求灵活调整。</p>
<p><strong>自动故障恢复</strong>机制基于Raft协议实现。当少数节点故障时，系统会自动选举新Leader，并在其他节点上恢复副本数据，实现金融级100%数据强一致性保证。故障转移过程对应用透明，客户端只需实现重试逻辑即可。</p>
<p>扩缩容操作可通过TiUP工具简单完成：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 水平扩展TiDB Server</span>
tiup cluster scale-<span class="hljs-keyword">out</span> &lt;cluster-name&gt; tidb.yaml

<span class="hljs-meta"># 垂直扩展TiKV节点配置</span>
tiup cluster edit-config &lt;cluster-name&gt;
</code></pre>
<p>这种<strong>无感扩容能力</strong>使TiDB特别适合业务快速增长或流量波动大的场景。</p>
<h3 data-id="heading-7">2.3 数据迁移与生态集成</h3>
<p>TiDB拥有丰富的工具链生态，提供完整的数据管理解决方案。主要工具包括：</p>
<ul>
<li><strong>DM（Data Migration）</strong> ：从MySQL到TiDB的数据迁移工具，支持全量和增量同步。</li>
<li><strong>BR（Backup &amp; Restore）</strong> ：集群级数据备份与恢复工具，支持分布式备份。</li>
<li><strong>TiCDC</strong>：变更数据捕获与同步工具，可将数据同步到MySQL、Kafka等下游系统。</li>
</ul>
<p>与MySQL的高度兼容性是TiDB的一大优势，支持大多数MySQL语法、存储过程、函数和触发器，使得现有MySQL应用可以平滑迁移。此外，TiDB数据可以方便地导入Kafka，接入Flink，乃至Hive、HDFS、Amazon S3、Spark等大数据生态组件，避免了技术锁定风险。</p>
<h2 data-id="heading-8">3 TiDB应用实战与性能优化</h2>
<h3 data-id="heading-9">3.1 应用场景分析</h3>
<p>TiDB特别适用于以下场景：</p>
<ul>
<li><strong>高并发OLTP应用</strong>：电商、金融、游戏等需要处理大量并发事务的场景</li>
<li><strong>实时分析系统</strong>：需要同时处理事务和分析查询的HTAP场景</li>
<li><strong>大数据量存储</strong>：单表数据量达数十亿甚至上百亿的记录存储和查询需求</li>
<li><strong>MySQL迁移升级</strong>：从MySQL迁移到分布式架构的平滑升级路径</li>
</ul>
<p>某金融企业案例显示，通过部署TiDB私有云解决方案，实现了数据的实时分析和高效处理，成功应对了数据量激增和业务复杂度提升的挑战。某电信个人账单系统从MyCAT迁移到TiDB后，单表数据量从80亿扩展到100亿，数据存储周期由半年延长至3-5年，QPS和延迟都有显著改善。</p>
<h3 data-id="heading-10">3.2 SQL优化最佳实践</h3>
<p>在TiDB中，SQL性能优化至关重要。以下是一些核心优化建议：</p>
<ul>
<li><strong>避免全表扫描</strong>：通过创建合适的索引避免全表扫描。使用EXPLAIN分析查询计划，确保查询有效利用索引。</li>
<li><strong>控制事务大小</strong>：将每个事务的记录数控制在200条以内，单条记录的数据大小小于100KB。大事务会增加延迟，容易引发冲突和内存压力。</li>
<li><strong>索引优化</strong>：一张表的索引数量建议不超过7个。使用覆盖索引避免回表操作，对字符串列考虑使用前缀索引节省空间。</li>
</ul>
<p>查询优化示例：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 不好的写法：使用OR导致全表扫描</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'alice'</span> <span class="hljs-keyword">OR</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">'123456'</span>;

<span class="hljs-comment">-- 优化写法：使用UNION替代OR</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'alice'</span> 
<span class="hljs-keyword">UNION</span> 
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">'123456'</span>;

<span class="hljs-comment">-- 创建覆盖索引优化查询</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_name_age <span class="hljs-keyword">ON</span> users(name, age);
<span class="hljs-keyword">SELECT</span> name, age <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'alice'</span>; <span class="hljs-comment">-- 无需回表</span>
</code></pre>
<h3 data-id="heading-11">3.3 分布式事务优化</h3>
<p>TiDB通过以下机制优化分布式事务性能：</p>
<ul>
<li><strong>异步提交（Async Commit）</strong> ：TiDB 5.0的Async Commit特性在事务提交的第二阶段实现异步提交，对于小事务达到类似1PC的效果，减少网络往返。</li>
<li><strong>悲观事务模式</strong>：高冲突场景下使用悲观事务模式，减少事务重试开销。</li>
<li><strong>批量操作</strong>：使用批量插入代替单条插入，显著提升吞吐量。</li>
</ul>
<p>Java应用中使用悲观事务的示例：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Java应用使用悲观事务</span>
try (Connection conn = ds.getConnection()) {
    conn<span class="hljs-selector-class">.setAutoCommit</span>(false);
    <span class="hljs-comment">// 开启悲观事务模式</span>
    conn<span class="hljs-selector-class">.createStatement</span>()<span class="hljs-selector-class">.execute</span>("SET tidb_txn_mode = 'pessimistic'");
    
    <span class="hljs-comment">// 先查询后更新（带锁）</span>
    ResultSet rs = conn<span class="hljs-selector-class">.createStatement</span>()<span class="hljs-selector-class">.executeQuery</span>(
        "SELECT balance FROM accounts WHERE id = <span class="hljs-number">1001</span> FOR UPDATE");
    
    <span class="hljs-comment">// 业务逻辑处理</span>
    BigDecimal newBalance = rs<span class="hljs-selector-class">.getBigDecimal</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.subtract</span>(amount);
    PreparedStatement ps = conn<span class="hljs-selector-class">.prepareStatement</span>(
        "UPDATE accounts SET balance = ? WHERE id = <span class="hljs-number">1001</span>");
    ps<span class="hljs-selector-class">.setBigDecimal</span>(<span class="hljs-number">1</span>, newBalance);
    ps<span class="hljs-selector-class">.executeUpdate</span>();
    conn<span class="hljs-selector-class">.commit</span>();
}
</code></pre>
<p>此示例展示了如何使用悲观事务避免高并发下的数据竞争问题。</p>
<h3 data-id="heading-12">3.4 热点问题处理与资源管理</h3>
<p>TiDB通过多种机制处理热点问题：</p>
<ul>
<li><strong>AUTO_RANDOM</strong>：使用AUTO_RANDOM代替AUTO_INCREMENT来分配主键，避免单调递增主键导致的写热点。</li>
<li><strong>SHARD_ROW_ID_BITS</strong>：通过行号分片分散热点。</li>
<li><strong>缓存策略</strong>：对频繁访问的小表数据使用TiDB内置缓存或应用层缓存（如Redis）。</li>
</ul>
<p>资源隔离配置示例：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># tidb-server资源控制配置</span>
<span class="hljs-attr">resource-control:</span>
  <span class="hljs-attr">request-unit:</span>
    <span class="hljs-comment"># 限制OLTP负载</span>
    <span class="hljs-attr">oltp:</span>
      <span class="hljs-attr">max-tasks:</span> <span class="hljs-number">500</span>
      <span class="hljs-attr">cpu-time-per-sec:</span> <span class="hljs-number">0.8</span>
    <span class="hljs-comment"># 保障OLAP资源</span>
    <span class="hljs-attr">olap:</span>
      <span class="hljs-attr">min-tasks:</span> <span class="hljs-number">200</span>
      <span class="hljs-attr">cpu-time-per-sec:</span> <span class="hljs-number">1.2</span>
</code></pre>
<p>此配置确保OLAP查询不会影响OLTP事务的性能。</p>
<h2 data-id="heading-13">4 部署架构与运维实践</h2>
<h3 data-id="heading-14">4.1 高可用架构设计</h3>
<p>TiDB提供金融级高可用保障，通过以下机制实现：</p>
<ul>
<li><strong>多副本机制</strong>：数据默认保存3副本，分布在不同的故障域。</li>
<li><strong>自动故障转移</strong>：少数节点故障时自动切换，无需人工干预。</li>
<li><strong>跨数据中心部署</strong>：支持同城三中心、两地三中心等部署模式，保证业务连续性。</li>
</ul>
<p>跨数据中心部署示例：</p>
<pre><code class="hljs language-scss" lang="scss">RegionA (主中心)         <span class="hljs-built_in">RegionB</span>(灾备中心)
├── <span class="hljs-number">3</span> PD节点（多数派）    ├── <span class="hljs-number">2</span> PD Learner
├── <span class="hljs-number">10</span> TiKV节点（标签zone=<span class="hljs-selector-tag">a</span>） ├── <span class="hljs-number">5</span> TiKV节点（标签zone=<span class="hljs-selector-tag">b</span>）
└── <span class="hljs-number">2</span> TiDB节点          └── <span class="hljs-number">1</span> TiDB节点
</code></pre>
<p>此拓扑确保单个数据中心故障时服务仍然可用。</p>
<h3 data-id="heading-15">4.2 监控与告警体系</h3>
<p>TiDB集成了Prometheus和Grafana构建完整的监控体系，关键监控指标包括：</p>
<ul>
<li><strong>集群概览</strong>：QPS、延迟、连接数等核心指标</li>
<li><strong>TiDB性能</strong>：查询耗时、执行时间、慢查询分析</li>
<li><strong>TiKV状态</strong>：CPU、IO负载、Region健康状态、调度操作</li>
<li><strong>PD调度</strong>：Balance操作、热点分布、调度队列</li>
</ul>
<p>通过设置合理的告警阈值，可以及时发现并处理潜在问题。例如，当出现"server is busy"或"channel full"错误时，通常意味着系统已达瓶颈，需要扩容或优化。</p>
<h3 data-id="heading-16">4.3 备份与恢复策略</h3>
<p>TiDB提供多种数据保护机制：</p>
<ul>
<li><strong>自动备份</strong>：支持全量和增量备份，可将数据备份到对象存储。</li>
<li><strong>时间点恢复（PITR）</strong> ：支持精确到秒级的数据恢复。</li>
<li><strong>异地容灾</strong>：通过TiCDC将数据同步到异地集群，实现容灾。</li>
</ul>
<p>备份策略示例：</p>
<pre><code class="hljs language-sql" lang="sql"># 使用BR进行全量备份
br backup <span class="hljs-keyword">full</span> \
    <span class="hljs-comment">--pd "&lt;pd-addresses&gt;" \</span>
    <span class="hljs-comment">--storage "s3://backup-data/backup-2023" \</span>
    <span class="hljs-comment">--ratelimit 128</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从一个“不能输负号”的数字输入框说起：Web Component 数字输入组件重构实录]]></title>    <link>https://juejin.cn/post/7582861402278395938</link>    <guid>https://juejin.cn/post/7582861402278395938</guid>    <pubDate>2025-12-13T09:56:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582861402278395938" data-draft-id="7582533464246009890" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从一个“不能输负号”的数字输入框说起：Web Component 数字输入组件重构实录"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-13T09:56:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="莫石"/> <meta itemprop="url" content="https://juejin.cn/user/281920608933006"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从一个“不能输负号”的数字输入框说起：Web Component 数字输入组件重构实录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/281920608933006/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    莫石
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T09:56:13.000Z" title="Sat Dec 13 2025 09:56:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>拿到需求时，因为工期还比较宽松，官网开发，我又只做其中一个组件，框架又没有定。</p>
<p>我决定使用原生开发，并封装为Web Component以适配任何框架（如果不能适配，说明框架有问题）。其中就有一个数字输入框带拉杆的，数字输入框和拉杆这两个东西，原生组件都有。</p>
<p>于是在我的要求下，ai很快给我封装了一个还可以的东西，不过后面ui又去掉拉杆了。</p>
<p>临近发布，要合代码了，同事才发现这个输入框有点儿问题！</p>
<hr/>
<p><span href="https://code.juejin.cn/pen/7582891968616169524" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7582891968616169524" data-src="https://code.juejin.cn/pen/7582891968616169524" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h2 data-id="heading-1">起点：一段“差不多能用”的代码</h2>
<p>这里就不赘述Web Component的开发了，因为确实很简单，看代码就行了。</p>
<p>这是我最初写的 <code>NumInput</code> 组件（为简洁省略部分 CSS）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NumInput</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">HTMLElement</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">attachShadow</span>({ <span class="hljs-attr">mode</span>: <span class="hljs-string">'open'</span> });
    <span class="hljs-comment">// ... 模板里用了 &lt;input type="number" steop="0.1"&gt;</span>
  }
  <span class="hljs-title function_">_onNumberInput</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">const</span> newValue = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">clamp</span>(event.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">min</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">max</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'value'</span>, newValue);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_dispatchEvent</span>();
  }
}
</code></pre>
<p>功能上：</p>
<ul>
<li>支持 <code>label</code>、<code>unit</code>、<code>min</code>、<code>max</code>、<code>step</code></li>
<li>聚焦有高亮效果</li>
<li>值变化会派发 <code>value-changed</code> 事件</li>
<li>还有后缀单位</li>
</ul>
<p>看起来没问题？直到女同事问我：“<strong>为什么我输 <code>-</code> 没反应？</strong>”
我压根儿没想过手输，因为这个组件最开始的时候，还是带拉杆的，纯鼠标操作一点儿问题没有。</p>
<p>当然，现在UI变了。</p>
<hr/>
<h2 data-id="heading-2">问题一：<code>type="number"</code> 不让你输 “-” 和 “.”</h2>
<p>首先，这不是一个bug,嗯。
我仔细研究了一下原生的数字框的机制。</p>
<p>1 实时校验，你每输入一个字符都会校验。
2 只能输入数字相关的,0-9 . -</p>
<p>那么问题来了，为什么她无法输入“-” 和 “.”呢？</p>
<p>实际上，并不是无法输入，只是时机和位置不对。
如果输入框中已经有一个数字1了，这个时候，你就可以在这个数字前面输入一个 “-”，在它后面输入一个“.”，这两种情况（-1和1.）都是合法的。</p>
<p>其余情况都是不合法的，所以无法输入。</p>
<p><strong>结论：<code>type="number"</code>校验过于严苛，鼠标操作足矣，不适合手动输入。</strong></p>
<hr/>
<h2 data-id="heading-3">重构第一步：放弃 <code>type="number"</code>，拥抱 <code>type="text"</code></h2>
<p>使用text输入框，意味着之前数字框有的功能，我现在也都要也有，这是这个手动输入的校验规则要自定义。</p>
<p>我改成了：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">inputmode</span>=<span class="hljs-string">"decimal"</span> /&gt;</span>
</code></pre>
<blockquote>
<p><code>inputmode="decimal"</code> 能让移动端弹出带小数点的数字键盘，体验不降反升。</p>
</blockquote>
<p>但光改类型不够，得自己控制输入内容。</p>
<h3 data-id="heading-4">宽松过滤，只拦非法字符</h3>
<p>在 <code>input</code> 事件中，我只做一件事：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">_onTextInput</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-keyword">let</span> val = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
  val = val.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[^0-9.\-+]/g</span>, <span class="hljs-string">''</span>); <span class="hljs-comment">// 只留数字、点、正负号</span>
  <span class="hljs-comment">// 再处理符号位置、小数点数量...</span>
  e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span> = val;
}
</code></pre>
<p><strong>关键原则</strong>：</p>
<blockquote>
<p>输入过程中，<strong>只过滤，不校验</strong>。<br/>
允许用户输 <code>-</code>、<code>.5</code>、<code>-12.</code>，这些“中间状态”必须保留。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">重构第二步：什么时候才该“认真”校验？</h2>
<p>要保留用户输入的字符，又要在结束后校验，一般可能会想到节流，我觉得太麻烦了，不是指实现节流麻烦，而是节流这个逻辑本身，会一直后延，让js很麻烦。</p>
<p>所以，怎么判断：<strong>输入结束了</strong>？</p>
<p>我定义了两个“结束信号”：</p>
<ol>
<li>失焦（<code>blur</code>）</li>
<li>按下回车（<code>Enter</code>） 刚开始没想到这个，直到我输了数字没有反应，习惯性地回车了一下。</li>
</ol>
<p>在这两个时机，调用同一个函数 <code>_finalizeInput()</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">_finalizeInput</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> raw = <span class="hljs-variable language_">this</span>.<span class="hljs-property">numberEl</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>();
  <span class="hljs-comment">// 如果是中间状态（如 '-'），不处理</span>
  <span class="hljs-keyword">if</span> (raw === <span class="hljs-string">''</span> || raw === <span class="hljs-string">'-'</span> || raw === <span class="hljs-string">'.'</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">let</span> num = <span class="hljs-built_in">parseFloat</span>(raw);
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(num)) {
    <span class="hljs-comment">// 无效？回退到上次合法值</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">numberEl</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'value'</span>) || <span class="hljs-string">''</span>;
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// clamp 到 [min, max]</span>
  num = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(num, <span class="hljs-variable language_">this</span>.<span class="hljs-property">min</span>), <span class="hljs-variable language_">this</span>.<span class="hljs-property">max</span>);

  <span class="hljs-comment">// 修正浮点精度（关键！）</span>
  num = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_roundToStepPrecision</span>(num, <span class="hljs-variable language_">this</span>.<span class="hljs-property">step</span>);

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">numberEl</span>.<span class="hljs-property">value</span> = <span class="hljs-title class_">String</span>(num);
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'value'</span>, num);
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_dispatchEvent</span>(); <span class="hljs-comment">// 派发的是数字，不是字符串！</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-6">问题二：0.1 + 0.2 ≠ 0.3？</h2>
<ul>
<li><code>0.1 + 0.2</code> → 显示 <code>0.30000000000000004</code>
JavaScript 的浮点精度问题是老朋友了。<br/>
但用户不关心这些，他们只看到“<strong>我 step=0.1，怎么变出一串小数？</strong>”</li>
</ul>
<h3 data-id="heading-7">解法：按 <code>step</code> 的小数位数四舍五入</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">_roundToStepPrecision</span>(<span class="hljs-params">value, step</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Number</span>.<span class="hljs-title function_">isInteger</span>(step)) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(value);
  <span class="hljs-keyword">const</span> decimalPlaces = step.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>)[<span class="hljs-number">1</span>]?.<span class="hljs-property">length</span> || <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> factor = <span class="hljs-number">10</span> ** decimalPlaces;
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(value * factor) / factor;
}
</code></pre>
<ul>
<li><code>step=0.1</code> → 保留 1 位 → <code>0.30000000000000004</code> → <code>0.3</code></li>
<li><code>step=0.01</code> → 保留 2 位 → <code>0.13</code></li>
<li><code>step=1</code> → 整数 → <code>4</code></li>
</ul>
<p><strong>所有赋值路径</strong>（手动输入、上下键、外部设置）都走这个修正，彻底告别脏数字。</p>
<hr/>
<p>监听一下回车作为“确认”。</p>
<p>这里直接不仅走了失焦的逻辑，还主动失焦，避免二次“失焦”。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">this</span>.<span class="hljs-property">numberEl</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'Enter'</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_finalizeInput</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">numberEl</span>.<span class="hljs-title function_">blur</span>(); <span class="hljs-comment">// 自动失焦，统一交互</span>
  }
});
</code></pre>
<hr/>
<h2 data-id="heading-8">其他细节打磨</h2>
<ul>
<li><strong>修复 typo</strong>：<code>steop="0.1"</code> → <code>step="0.1"</code>（别笑，真有人写错）</li>
<li><strong>移除无用代码</strong>：原始代码里声明了 <code>rangeEl</code> 但没用，删掉</li>
<li><strong>事件传数字</strong>：<code>value-changed</code> 的 <code>detail.value</code> 是 <code>number</code> 类型，不是字符串</li>
<li><strong>外部设置值也修正</strong>：<code>setAttribute('value', '0.30000000000000004')</code> 会自动转成 <code>0.3</code></li>
</ul>
<hr/>
<h2 data-id="heading-9">最终效果</h2>
<p>✅ 自由输入 <code>-</code>、<code>.</code>、<code>-12.</code><br/>
✅ 按 ↑/↓ 按 <code>step</code> 精确增减<br/>
✅ 按 Enter 或失焦自动校验+修正<br/>
✅ 支持 <code>min</code>/<code>max</code> 限制<br/>
✅ 移动端弹出数字键盘<br/>
✅ 事件传出干净的数字<br/>
✅ 完全 Web Component，零依赖</p>
<hr/>
<h2 data-id="heading-10">结语</h2>
<p>这个组件最终代码比最初长了近一倍，但<strong>用户体验提升是质的飞跃</strong>。</p>
<p>有时候，看似简单的功能，深挖下去全是坑。<br/>
但正是这些“小细节”，决定了产品是“能用”还是“好用”。</p>
<blockquote>
<p>最后,女同事看了一眼说：“这个输入框终于不抽风了。”<br/>
我笑了笑，没告诉她，我让AI改了四版。</p>
</blockquote>
<p>（完）</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python Protobuf 全面教程：常用 API 串联与实战指南]]></title>    <link>https://juejin.cn/post/7582848701268049955</link>    <guid>https://juejin.cn/post/7582848701268049955</guid>    <pubDate>2025-12-13T07:29:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582848701268049955" data-draft-id="7582845425402904616" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python Protobuf 全面教程：常用 API 串联与实战指南"/> <meta itemprop="keywords" content="前端,面试,GitHub"/> <meta itemprop="datePublished" content="2025-12-13T07:29:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小jobleap"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147692910"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python Protobuf 全面教程：常用 API 串联与实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147692910/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小jobleap
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T07:29:27.000Z" title="Sat Dec 13 2025 07:29:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是jobleap.cn的小九。
Protocol Buffers（简称 Protobuf）是 Google 开发的轻量级、高效的序列化数据结构格式，广泛用于跨语言、跨平台的数据传输和存储。Python 作为主流开发语言，其 <code>protobuf</code> 库提供了完整的 API 支持，本文将从环境搭建、Proto 文件定义、核心 API 用法到实战案例，全面串联常用功能，帮助你掌握 Python 操作 Protobuf 的全流程。</p>
<h2 data-id="heading-0">一、环境准备</h2>
<h3 data-id="heading-1">1. 安装核心依赖</h3>
<p>Protobuf 的 Python 开发需要两个核心组件：</p>
<ul>
<li><code>protobuf</code> 库：Python 运行时，用于操作编译后的 Protobuf 消息。</li>
<li><code>protoc</code> 编译器：将 <code>.proto</code> 定义文件编译为 Python 代码。</li>
</ul>
<h4 data-id="heading-2">安装 <code>protobuf</code> 库</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 推荐安装稳定版（与protoc版本匹配）</span>
pip install protobuf==4.25.3  <span class="hljs-comment"># 版本需与protoc兼容</span>
</code></pre>
<h4 data-id="heading-3">安装 <code>protoc</code> 编译器</h4>
<ul>
<li><strong>Windows</strong>：从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fprotocolbuffers%2Fprotobuf%2Freleases" target="_blank" title="https://github.com/protocolbuffers/protobuf/releases" ref="nofollow noopener noreferrer">Protobuf 官方仓库</a> 下载 <code>protoc-{version}-win64.zip</code>，解压后将 <code>bin</code> 目录添加到系统环境变量。</li>
<li><strong>Linux</strong>：<code>sudo apt install protobuf-compiler</code>（Debian/Ubuntu）或 <code>sudo yum install protobuf-compiler</code>（CentOS）。</li>
<li><strong>Mac</strong>：<code>brew install protobuf</code>。</li>
</ul>
<p>验证安装：</p>
<pre><code class="hljs language-bash" lang="bash">protoc --version  <span class="hljs-comment"># 输出如：libprotoc 25.3</span>
python -c <span class="hljs-string">"import google.protobuf; print(google.protobuf.__version__)"</span>  <span class="hljs-comment"># 输出如：4.25.3</span>
</code></pre>
<h2 data-id="heading-4">二、Proto 文件定义（基础语法）</h2>
<p>首先需要通过 <code>.proto</code> 文件定义数据结构，Protobuf 分为 <code>proto2</code> 和 <code>proto3</code> 两个版本（推荐 <code>proto3</code>，语法更简洁）。</p>
<h3 data-id="heading-5">示例 1：基础消息定义（user.proto）</h3>
<pre><code class="hljs language-proto" lang="proto">syntax = "proto3";  // 指定版本，必须是第一行

// 包名，用于避免命名冲突，编译后对应 Python 模块的命名空间
package user;

// 枚举类型：用户状态
enum UserStatus {
    STATUS_UNKNOWN = 0;  // proto3 枚举必须以 0 作为默认值
    STATUS_ACTIVE = 1;
    STATUS_INACTIVE = 2;
}

// 嵌套消息：地址
message Address {
    string province = 1;  // 字段编号（1-15 占用1字节，推荐给高频字段）
    string city = 2;
    string detail = 3;
}

// 核心消息：用户信息
message User {
    // 标量字段：基本类型
    int64 id = 1;  // 用户ID（int64 对应 Python int）
    string name = 2;  // 用户名（string 对应 Python str）
    float score = 3;  // 评分（float 对应 Python float）
    bool is_vip = 4;  // 是否VIP（bool 对应 Python bool）
    
    // 枚举字段
    UserStatus status = 5;
    
    // 嵌套消息字段
    Address address = 6;
    
    // 重复字段（对应 Python list）
    repeated string tags = 7;  // 用户标签
    
    // 映射字段（对应 Python dict）
    map&lt;string, string&gt; ext_info = 8;  // 扩展信息
    
    // 可选字段（proto3 v3.15+ 支持，需显式标注 optional）
    optional string email = 9;  // 可选邮箱（非必填）
}
</code></pre>
<h3 data-id="heading-6">核心语法说明</h3>













































<table><thead><tr><th>语法元素</th><th>说明</th></tr></thead><tbody><tr><td><code>syntax</code></td><td>指定版本（proto2/proto3），必须放在第一行。</td></tr><tr><td><code>package</code></td><td>命名空间，编译后 Python 模块会包含该包名。</td></tr><tr><td><code>message</code></td><td>定义消息结构，对应 Python 中的类。</td></tr><tr><td><code>enum</code></td><td>枚举类型，值必须为整数，默认值为 0。</td></tr><tr><td>字段编号</td><td>每个字段的唯一编号（1-2^29-1），用于序列化/反序列化，<strong>不可随意修改</strong>。</td></tr><tr><td>标量类型映射</td><td>proto3 标量类型 ↔ Python 类型：<br/>int64/uint64 → int<br/>string → str<br/>float/double → float<br/>bool → bool</td></tr><tr><td><code>repeated</code></td><td>重复字段，对应 Python list。</td></tr><tr><td><code>map</code></td><td>映射字段，键只能是标量类型（除 float/double），值可以是任意类型。</td></tr><tr><td><code>optional</code></td><td>可选字段，未赋值时返回默认值（如 string 返回 ""，int 返回 0）。</td></tr></tbody></table>
<h2 data-id="heading-7">三、编译 Proto 文件为 Python 代码</h2>
<p>使用 <code>protoc</code> 编译器将 <code>.proto</code> 文件编译为 Python 可导入的模块：</p>
<h3 data-id="heading-8">编译命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 语法：protoc --python_out=&lt;输出目录&gt; &lt;proto文件路径&gt;</span>
protoc --python_out=./gen user.proto
</code></pre>
<p>执行后会在 <code>./gen</code> 目录下生成 <code>user_pb2.py</code> 文件（命名规则：<code>{proto文件名}_pb2.py</code>），这是 Python 操作 Protobuf 的核心模块。</p>
<blockquote>
<p>注意：编译后的文件无需手动修改，直接导入使用即可。</p>
</blockquote>
<h2 data-id="heading-9">四、核心 API 实战（串联所有常用功能）</h2>
<p>以下基于编译后的 <code>user_pb2.py</code>，演示 Python 操作 Protobuf 的全流程 API。</p>
<h3 data-id="heading-10">1. 导入编译后的模块</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 确保 gen 目录在 Python 路径中（或添加到 sys.path）</span>
<span class="hljs-keyword">import</span> sys
sys.path.append(<span class="hljs-string">"./gen"</span>)

<span class="hljs-keyword">from</span> user_pb2 <span class="hljs-keyword">import</span> User, Address, UserStatus  <span class="hljs-comment"># 导入生成的消息类和枚举</span>
</code></pre>
<h3 data-id="heading-11">2. 创建消息实例（字段赋值）</h3>
<h4 data-id="heading-12">方式1：构造函数直接赋值</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建嵌套消息：地址</span>
addr = Address(
    province=<span class="hljs-string">"广东省"</span>,
    city=<span class="hljs-string">"深圳市"</span>,
    detail=<span class="hljs-string">"科技园路100号"</span>
)

<span class="hljs-comment"># 创建核心消息：用户</span>
user = User(
    <span class="hljs-built_in">id</span>=<span class="hljs-number">1001</span>,
    name=<span class="hljs-string">"张三"</span>,
    score=<span class="hljs-number">98.5</span>,
    is_vip=<span class="hljs-literal">True</span>,
    status=UserStatus.STATUS_ACTIVE,  <span class="hljs-comment"># 枚举赋值</span>
    address=addr,  <span class="hljs-comment"># 嵌套消息赋值</span>
    tags=[<span class="hljs-string">"学生"</span>, <span class="hljs-string">"程序员"</span>],  <span class="hljs-comment"># 重复字段赋值</span>
    ext_info={<span class="hljs-string">"phone"</span>: <span class="hljs-string">"13800138000"</span>, <span class="hljs-string">"age"</span>: <span class="hljs-string">"25"</span>}  <span class="hljs-comment"># 映射字段赋值</span>
)

<span class="hljs-comment"># 可选字段单独赋值（如果未赋值，默认返回空字符串）</span>
user.email = <span class="hljs-string">"zhangsan@example.com"</span>
</code></pre>
<h4 data-id="heading-13">方式2：分步赋值（更灵活）</h4>
<pre><code class="hljs language-python" lang="python">user2 = User()
user2.<span class="hljs-built_in">id</span> = <span class="hljs-number">1002</span>
user2.name = <span class="hljs-string">"李四"</span>
user2.score = <span class="hljs-number">89.0</span>
user2.is_vip = <span class="hljs-literal">False</span>
user2.status = UserStatus.STATUS_INACTIVE

<span class="hljs-comment"># 嵌套消息分步赋值</span>
user2.address.province = <span class="hljs-string">"北京市"</span>
user2.address.city = <span class="hljs-string">"北京市"</span>
user2.address.detail = <span class="hljs-string">"中关村大街1号"</span>

<span class="hljs-comment"># 重复字段添加元素（支持 append/extend/add）</span>
user2.tags.append(<span class="hljs-string">"教师"</span>)
user2.tags.extend([<span class="hljs-string">"博主"</span>, <span class="hljs-string">"旅行者"</span>])
<span class="hljs-comment"># 或使用 add()（仅兼容 proto2 风格，proto3 也可用）</span>
<span class="hljs-comment"># user2.tags.add("博主")</span>

<span class="hljs-comment"># 映射字段赋值</span>
user2.ext_info[<span class="hljs-string">"phone"</span>] = <span class="hljs-string">"13900139000"</span>
user2.ext_info[<span class="hljs-string">"age"</span>] = <span class="hljs-string">"30"</span>

<span class="hljs-comment"># 可选字段赋值</span>
user2.email = <span class="hljs-string">"lisi@example.com"</span>
</code></pre>
<h3 data-id="heading-14">3. 字段访问与校验</h3>
<h4 data-id="heading-15">（1）基础字段访问</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"用户ID:"</span>, user.<span class="hljs-built_in">id</span>)  <span class="hljs-comment"># 1001</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"用户名:"</span>, user.name)  <span class="hljs-comment"># 张三</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"是否VIP:"</span>, user.is_vip)  <span class="hljs-comment"># True</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"枚举状态:"</span>, user.status)  <span class="hljs-comment"># 1（枚举值）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"枚举状态名称:"</span>, UserStatus.Name(user.status))  <span class="hljs-comment"># STATUS_ACTIVE</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"可选邮箱:"</span>, user.email)  <span class="hljs-comment"># zhangsan@example.com</span>

<span class="hljs-comment"># 嵌套消息访问</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"省份:"</span>, user.address.province)  <span class="hljs-comment"># 广东省</span>

<span class="hljs-comment"># 重复字段访问（list 操作）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"标签列表:"</span>, user.tags)  <span class="hljs-comment"># ['学生', '程序员']</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"第一个标签:"</span>, user.tags[<span class="hljs-number">0</span>])  <span class="hljs-comment"># 学生</span>

<span class="hljs-comment"># 映射字段访问（dict 操作）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"手机号:"</span>, user.ext_info[<span class="hljs-string">"phone"</span>])  <span class="hljs-comment"># 13800138000</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"所有扩展信息:"</span>, <span class="hljs-built_in">dict</span>(user.ext_info))  <span class="hljs-comment"># {'phone': '13800138000', 'age': '25'}</span>
</code></pre>
<h4 data-id="heading-16">（2）字段存在性检查（optional 字段专用）</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 检查 optional 字段是否赋值（proto3 仅 optional 字段支持 has_field）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"是否设置邮箱:"</span>, user.HasField(<span class="hljs-string">"email"</span>))  <span class="hljs-comment"># True</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"是否设置性别（未定义字段）:"</span>, user.HasField(<span class="hljs-string">"gender"</span>))  <span class="hljs-comment"># 报错（字段不存在）</span>

<span class="hljs-comment"># 清空字段</span>
user.ClearField(<span class="hljs-string">"email"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"清空后邮箱:"</span>, user.email)  <span class="hljs-comment"># ""（默认值）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"清空后是否存在邮箱:"</span>, user.HasField(<span class="hljs-string">"email"</span>))  <span class="hljs-comment"># False</span>
</code></pre>
<h4 data-id="heading-17">（3）消息完整性校验</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 检查消息是否初始化完成（proto3 中无必填字段，仅检查嵌套消息是否初始化）</span>
<span class="hljs-keyword">try</span>:
    user.CheckInitialized()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"消息初始化完成"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"消息未初始化:"</span>, e)
</code></pre>
<h3 data-id="heading-18">4. 序列化与反序列化（核心功能）</h3>
<p>Protobuf 的核心价值是高效序列化，将消息转换为二进制字节流（用于网络传输/存储），反序列化则是将字节流还原为消息实例。</p>
<h4 data-id="heading-19">（1）序列化：Message → 字节流</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># SerializeToString()：将消息序列化为 bytes（推荐）</span>
user_bytes = user.SerializeToString()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"序列化后字节流:"</span>, user_bytes)  <span class="hljs-comment"># 二进制字节（长度远小于JSON）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"字节流长度:"</span>, <span class="hljs-built_in">len</span>(user_bytes))  <span class="hljs-comment"># 示例：约50字节（JSON需约200字节）</span>

<span class="hljs-comment"># 其他序列化方法（少用）：</span>
<span class="hljs-comment"># SerializePartialToString()：允许未初始化的消息序列化（跳过校验）</span>
<span class="hljs-comment"># user_partial_bytes = user.SerializePartialToString()</span>
</code></pre>
<h4 data-id="heading-20">（2）反序列化：字节流 → Message</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 新建空消息实例，通过 ParseFromString() 反序列化</span>
user_new = User()
user_new.ParseFromString(user_bytes)

<span class="hljs-comment"># 验证反序列化结果</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"反序列化后用户名:"</span>, user_new.name)  <span class="hljs-comment"># 张三</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"反序列化后标签:"</span>, user_new.tags)  <span class="hljs-comment"># ['学生', '程序员']</span>
</code></pre>
<h3 data-id="heading-21">5. 消息与字典/JSON 互转（常用）</h3>
<p>Protobuf 提供了便捷的 API 将消息转换为 Python 字典或 JSON 字符串（便于调试/兼容其他系统）。</p>
<h4 data-id="heading-22">（1）消息 → 字典/JSON</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> google.protobuf.json_format <span class="hljs-keyword">import</span> MessageToDict, MessageToJson

<span class="hljs-comment"># 消息 → 字典（保留原始类型）</span>
user_dict = MessageToDict(
    user,
    preserving_proto_field_name=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 保留字段名（默认驼峰命名，如 userId → id）</span>
    including_default_value_fields=<span class="hljs-literal">True</span>  <span class="hljs-comment"># 包含默认值字段</span>
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"消息转字典:"</span>, user_dict)
<span class="hljs-comment"># 输出示例：</span>
<span class="hljs-comment"># {</span>
<span class="hljs-comment">#   "id": 1001,</span>
<span class="hljs-comment">#   "name": "张三",</span>
<span class="hljs-comment">#   "score": 98.5,</span>
<span class="hljs-comment">#   "is_vip": true,</span>
<span class="hljs-comment">#   "status": "STATUS_ACTIVE",</span>
<span class="hljs-comment">#   ...</span>
<span class="hljs-comment"># }</span>

<span class="hljs-comment"># 消息 → JSON 字符串</span>
user_json = MessageToJson(
    user,
    preserving_proto_field_name=<span class="hljs-literal">True</span>,
    indent=<span class="hljs-number">2</span>  <span class="hljs-comment"># 格式化输出</span>
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"消息转JSON:\n"</span>, user_json)
</code></pre>
<h4 data-id="heading-23">（2）字典/JSON → 消息</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> google.protobuf.json_format <span class="hljs-keyword">import</span> ParseDict, ParseJson

<span class="hljs-comment"># 字典 → 消息</span>
user_dict_new = {
    <span class="hljs-string">"id"</span>: <span class="hljs-number">1003</span>,
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"王五"</span>,
    <span class="hljs-string">"status"</span>: <span class="hljs-string">"STATUS_ACTIVE"</span>,
    <span class="hljs-string">"tags"</span>: [<span class="hljs-string">"设计师"</span>, <span class="hljs-string">"摄影师"</span>],
    <span class="hljs-string">"ext_info"</span>: {<span class="hljs-string">"phone"</span>: <span class="hljs-string">"13700137000"</span>}
}
user_3 = ParseDict(user_dict_new, User(), preserving_proto_field_name=<span class="hljs-literal">True</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"字典转消息后ID:"</span>, user_3.<span class="hljs-built_in">id</span>)  <span class="hljs-comment"># 1003</span>

<span class="hljs-comment"># JSON → 消息</span>
user_json_str = <span class="hljs-string">'''
{
  "id": 1004,
  "name": "赵六",
  "is_vip": true,
  "tags": ["运营", "产品"]
}
'''</span>
user_4 = ParseJson(user_json_str, User(), preserving_proto_field_name=<span class="hljs-literal">True</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"JSON转消息后名称:"</span>, user_4.name)  <span class="hljs-comment"># 赵六</span>
</code></pre>
<h3 data-id="heading-24">6. 重复字段（RepeatedField）高级操作</h3>
<p>重复字段本质是 <code>RepeatedField</code> 类型（继承自 Python list），支持 list 所有操作，且提供额外 API：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 清空重复字段</span>
user.tags.clear()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"清空后标签:"</span>, user.tags)  <span class="hljs-comment"># []</span>

<span class="hljs-comment"># 添加多个元素</span>
user.tags.extend([<span class="hljs-string">"技术"</span>, <span class="hljs-string">"分享"</span>, <span class="hljs-string">"学习"</span>])
<span class="hljs-built_in">print</span>(<span class="hljs-string">"添加后标签:"</span>, user.tags)  <span class="hljs-comment"># ['技术', '分享', '学习']</span>

<span class="hljs-comment"># 插入元素</span>
user.tags.insert(<span class="hljs-number">1</span>, <span class="hljs-string">"Python"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"插入后标签:"</span>, user.tags)  <span class="hljs-comment"># ['技术', 'Python', '分享', '学习']</span>

<span class="hljs-comment"># 删除元素</span>
<span class="hljs-keyword">del</span> user.tags[<span class="hljs-number">2</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-string">"删除后标签:"</span>, user.tags)  <span class="hljs-comment"># ['技术', 'Python', '学习']</span>

<span class="hljs-comment"># 遍历重复字段</span>
<span class="hljs-keyword">for</span> tag <span class="hljs-keyword">in</span> user.tags:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"标签:"</span>, tag)
</code></pre>
<h3 data-id="heading-25">7. 映射字段（MapField）高级操作</h3>
<p>映射字段本质是 <code>MapField</code> 类型（继承自 Python dict），支持 dict 所有操作：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 遍历映射字段</span>
<span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> user.ext_info.items():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"扩展信息 <span class="hljs-subst">{key}</span>: <span class="hljs-subst">{value}</span>"</span>)

<span class="hljs-comment"># 删除映射字段元素</span>
<span class="hljs-keyword">del</span> user.ext_info[<span class="hljs-string">"age"</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-string">"删除后扩展信息:"</span>, <span class="hljs-built_in">dict</span>(user.ext_info))  <span class="hljs-comment"># {'phone': '13800138000'}</span>

<span class="hljs-comment"># 清空映射字段</span>
user.ext_info.clear()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"清空后扩展信息:"</span>, <span class="hljs-built_in">dict</span>(user.ext_info))  <span class="hljs-comment"># {}</span>

<span class="hljs-comment"># 批量添加映射字段</span>
user.ext_info.update({<span class="hljs-string">"job"</span>: <span class="hljs-string">"工程师"</span>, <span class="hljs-string">"salary"</span>: <span class="hljs-string">"30k"</span>})
<span class="hljs-built_in">print</span>(<span class="hljs-string">"批量添加后扩展信息:"</span>, <span class="hljs-built_in">dict</span>(user.ext_info))  <span class="hljs-comment"># {'job': '工程师', 'salary': '30k'}</span>
</code></pre>
<h3 data-id="heading-26">8. 导入其他 Proto 文件（跨文件复用）</h3>
<p>如果消息结构需要复用其他 <code>.proto</code> 文件的定义，可通过 <code>import</code> 实现：</p>
<h4 data-id="heading-27">示例：导入公共枚举（common.proto + order.proto）</h4>
<pre><code class="hljs language-proto" lang="proto">// common.proto
syntax = "proto3";
package common;

enum OrderStatus {
    ORDER_UNKNOWN = 0;
    ORDER_PAID = 1;
    ORDER_SHIPPED = 2;
    ORDER_FINISHED = 3;
}
</code></pre>
<pre><code class="hljs language-proto" lang="proto">// order.proto
syntax = "proto3";
package order;

// 导入其他proto文件
import "common.proto";

message Order {
    int64 order_id = 1;
    int64 user_id = 2;
    float amount = 3;
    common.OrderStatus status = 4;  // 使用导入的枚举
}
</code></pre>
<p>编译命令（需指定导入路径 <code>--proto_path</code>，简称 <code>-I</code>）：</p>
<pre><code class="hljs language-bash" lang="bash">protoc --python_out=./gen -I=./ ./common.proto ./order.proto
</code></pre>
<p>Python 中使用：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> gen.order_pb2 <span class="hljs-keyword">import</span> Order
<span class="hljs-keyword">from</span> gen.common_pb2 <span class="hljs-keyword">import</span> OrderStatus

order = Order(
    order_id=<span class="hljs-number">2001</span>,
    user_id=<span class="hljs-number">1001</span>,
    amount=<span class="hljs-number">299.9</span>,
    status=OrderStatus.ORDER_PAID
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"订单状态:"</span>, OrderStatus.Name(order.status))  <span class="hljs-comment"># ORDER_PAID</span>
</code></pre>
<h3 data-id="heading-28">9. Any 类型（动态消息，proto3 特有）</h3>
<p><code>Any</code> 类型允许在消息中嵌入任意其他消息类型（无需提前定义），适用于动态数据场景：</p>
<h4 data-id="heading-29">定义含 Any 类型的消息（dynamic.proto）</h4>
<pre><code class="hljs language-proto" lang="proto">syntax = "proto3";
package dynamic;

import "google/protobuf/any.proto";  // 导入Any类型

message DynamicData {
    string type = 1;  // 消息类型标识
    google.protobuf.Any data = 2;  // 任意消息类型
}
</code></pre>
<p>编译命令：</p>
<pre><code class="hljs language-bash" lang="bash">protoc --python_out=./gen -I=./ -I=/usr/local/include ./dynamic.proto  <span class="hljs-comment"># -I 指定google/protobuf路径</span>
</code></pre>
<p>Python 中使用：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> gen.dynamic_pb2 <span class="hljs-keyword">import</span> DynamicData
<span class="hljs-keyword">from</span> gen.user_pb2 <span class="hljs-keyword">import</span> User
<span class="hljs-keyword">from</span> gen.order_pb2 <span class="hljs-keyword">import</span> Order
<span class="hljs-keyword">from</span> google.protobuf.any_pb2 <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>

<span class="hljs-comment"># 1. 创建User消息并封装到Any</span>
user = User(<span class="hljs-built_in">id</span>=<span class="hljs-number">1001</span>, name=<span class="hljs-string">"张三"</span>)
any_user = <span class="hljs-type">Any</span>()
any_user.Pack(user)  <span class="hljs-comment"># 打包User消息到Any</span>

<span class="hljs-comment"># 2. 创建DynamicData消息</span>
dynamic_data = DynamicData(
    <span class="hljs-built_in">type</span>=<span class="hljs-string">"user"</span>,
    data=any_user
)

<span class="hljs-comment"># 3. 反序列化Any中的消息</span>
<span class="hljs-keyword">if</span> dynamic_data.data.Is(User.DESCRIPTOR):  <span class="hljs-comment"># 判断Any中的消息类型</span>
    unpacked_user = User()
    dynamic_data.data.Unpack(unpacked_user)  <span class="hljs-comment"># 解包</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"解包后的用户名:"</span>, unpacked_user.name)  <span class="hljs-comment"># 张三</span>

<span class="hljs-comment"># 4. 封装Order消息到Any</span>
order = Order(order_id=<span class="hljs-number">2001</span>, amount=<span class="hljs-number">299.9</span>)
any_order = <span class="hljs-type">Any</span>()
any_order.Pack(order)

dynamic_data.<span class="hljs-built_in">type</span> = <span class="hljs-string">"order"</span>
dynamic_data.data = any_order

<span class="hljs-keyword">if</span> dynamic_data.data.Is(Order.DESCRIPTOR):
    unpacked_order = Order()
    dynamic_data.data.Unpack(unpacked_order)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"解包后的订单ID:"</span>, unpacked_order.order_id)  <span class="hljs-comment"># 2001</span>
</code></pre>
<h2 data-id="heading-30">五、实战案例：用户数据序列化传输</h2>
<p>模拟一个场景：服务端将用户数据序列化为 Protobuf 字节流，客户端接收后反序列化，修改数据后再序列化为 JSON 保存。</p>
<h3 data-id="heading-31">服务端代码（server.py）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sys
sys.path.append(<span class="hljs-string">"./gen"</span>)

<span class="hljs-keyword">from</span> user_pb2 <span class="hljs-keyword">import</span> User, Address, UserStatus
<span class="hljs-keyword">from</span> google.protobuf.json_format <span class="hljs-keyword">import</span> MessageToJson

<span class="hljs-comment"># 1. 构建用户数据</span>
addr = Address(province=<span class="hljs-string">"浙江省"</span>, city=<span class="hljs-string">"杭州市"</span>, detail=<span class="hljs-string">"西湖路10号"</span>)
user = User(
    <span class="hljs-built_in">id</span>=<span class="hljs-number">1005</span>,
    name=<span class="hljs-string">"小明"</span>,
    score=<span class="hljs-number">95.0</span>,
    is_vip=<span class="hljs-literal">True</span>,
    status=UserStatus.STATUS_ACTIVE,
    address=addr,
    tags=[<span class="hljs-string">"学生"</span>, <span class="hljs-string">"竞赛选手"</span>],
    ext_info={<span class="hljs-string">"grade"</span>: <span class="hljs-string">"高三"</span>, <span class="hljs-string">"school"</span>: <span class="hljs-string">"杭州一中"</span>}
)

<span class="hljs-comment"># 2. 序列化为字节流（模拟网络传输）</span>
user_bytes = user.SerializeToString()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"服务端序列化字节流长度: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(user_bytes)}</span>"</span>)

<span class="hljs-comment"># 3. 将字节流写入文件（模拟传输）</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"user_data.bin"</span>, <span class="hljs-string">"wb"</span>) <span class="hljs-keyword">as</span> f:
    f.write(user_bytes)
</code></pre>
<h3 data-id="heading-32">客户端代码（client.py）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sys
sys.path.append(<span class="hljs-string">"./gen"</span>)

<span class="hljs-keyword">from</span> user_pb2 <span class="hljs-keyword">import</span> User
<span class="hljs-keyword">from</span> google.protobuf.json_format <span class="hljs-keyword">import</span> MessageToJson

<span class="hljs-comment"># 1. 读取字节流（模拟接收）</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"user_data.bin"</span>, <span class="hljs-string">"rb"</span>) <span class="hljs-keyword">as</span> f:
    user_bytes = f.read()

<span class="hljs-comment"># 2. 反序列化</span>
user = User()
user.ParseFromString(user_bytes)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"客户端反序列化后用户信息:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"ID: <span class="hljs-subst">{user.<span class="hljs-built_in">id</span>}</span>, 姓名: <span class="hljs-subst">{user.name}</span>, 地址: <span class="hljs-subst">{user.address.city}</span>"</span>)

<span class="hljs-comment"># 3. 修改数据</span>
user.score = <span class="hljs-number">98.0</span>
user.tags.append(<span class="hljs-string">"优秀学生"</span>)
user.ext_info[<span class="hljs-string">"rank"</span>] = <span class="hljs-string">"年级前10"</span>

<span class="hljs-comment"># 4. 转换为JSON保存</span>
user_json = MessageToJson(user, preserving_proto_field_name=<span class="hljs-literal">True</span>, indent=<span class="hljs-number">2</span>)
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"user_data.json"</span>, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
    f.write(user_json)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"客户端已将修改后的数据保存为JSON"</span>)
</code></pre>
<p>运行流程：</p>
<pre><code class="hljs language-bash" lang="bash">python server.py
python client.py
</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">服务端序列化字节流长度: 89</span>
<span class="hljs-section">客户端反序列化后用户信息:</span>
<span class="hljs-section">ID: 1005, 姓名: 小明, 地址: 杭州市</span>
客户端已将修改后的数据保存为JSON
</code></pre>
<h2 data-id="heading-33">六、常见问题与注意事项</h2>
<ol>
<li><strong>版本兼容</strong>：<code>protoc</code> 版本需与 <code>protobuf</code> 库版本匹配（如 protoc 25.x 对应 protobuf 4.25.x），否则可能编译/运行报错。</li>
<li><strong>字段编号</strong>：一旦发布，字段编号不可修改（否则反序列化会出错），新增字段使用新编号即可。</li>
<li><strong>默认值</strong>：proto3 未赋值的字段会返回默认值（int=0、string=""、bool=False、枚举=0），无需判空。</li>
<li><strong>性能优化</strong>：
<ul>
<li>高频字段使用 1-15 的编号（节省字节）。</li>
<li>序列化优先使用 <code>SerializeToString()</code>（带校验），性能要求极高时用 <code>SerializePartialToString()</code>。</li>
</ul>
</li>
<li><strong>跨语言兼容</strong>：确保不同语言的 Protobuf 版本一致，字段类型映射正确（如 Python int64 对应 Java long）。</li>
</ol>
<h2 data-id="heading-34">七、总结</h2>
<p>本文覆盖了 Python Protobuf 的核心 API：</p>
<ul>
<li>环境搭建与 Proto 文件编译；</li>
<li>消息实例的创建、字段赋值与访问；</li>
<li>序列化/反序列化（核心功能）；</li>
<li>消息与字典/JSON 互转；</li>
<li>重复字段、映射字段、枚举、嵌套消息、Any 类型的使用；</li>
<li>跨文件导入与实战案例。</li>
</ul>
<p>Protobuf 相比 JSON/XML 具有更高的序列化效率、更小的字节体积，是微服务、大数据传输场景的首选，掌握上述 API 即可满足绝大多数 Python 开发需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学点java字节码更易于理解一些特殊的java语法效果]]></title>    <link>https://juejin.cn/post/7582791876367220774</link>    <guid>https://juejin.cn/post/7582791876367220774</guid>    <pubDate>2025-12-12T17:45:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582791876367220774" data-draft-id="7582814236583428134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学点java字节码更易于理解一些特殊的java语法效果"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-12T17:45:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码无疆"/> <meta itemprop="url" content="https://juejin.cn/user/1039488983238903"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学点java字节码更易于理解一些特殊的java语法效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1039488983238903/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码无疆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T17:45:29.000Z" title="Fri Dec 12 2025 17:45:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>很多人学习java不会去理解字节码指令，觉得能看懂字节码对写好java代码没什么帮助，但其实不然，不少java语法效果其实可以通过字节码来理解的，掀开字节码的面纱能更好的理解java代码的语法和实际执行结果之间的关系，看了本文会让你有一种字节码也不过如此的感觉。</p>
<h2 data-id="heading-0">名字解释</h2>
<p>由于本文涉及java字节码指令，如果有一点计算机栈和堆的基本认知会更好理解，不清楚该知识点也能大概意会，不影响大家理解其大致的原理。这里简单介绍下本文涉及的几个常见的指令，以便更方便的阅读。</p>






































































<table><thead><tr><th>指令中反复出现字符</th><th>含义</th><th>举例</th></tr></thead><tbody><tr><td><code>a</code></td><td>对引用操作</td><td><code>aload_1</code>：读取栈顶一个32b大小的引用</td></tr><tr><td><code>i</code></td><td>对栈上int长度的空间进行操作</td><td><code>iload_1</code>：读取栈顶一个32b大小的int值 <code>istore_1</code>：把一个int值赋值给栈顶的int变量</td></tr><tr><td><code>l</code></td><td>对栈上long长度的空间进行操作</td><td><code>lload_2</code>：读取栈顶一个long长度（2个32b大小）的long值 <code>lstore_2</code>：把一个long值赋值给栈顶long长度（2个32b大小）的变量</td></tr><tr><td><code>store</code></td><td>把某个值赋值给栈顶的变量</td><td>参考<code>astore_1</code>、<code>istore_1</code>、<code>lstore_2</code></td></tr><tr><td><code>load</code></td><td>读取栈顶的值</td><td>参考<code>aload_1</code>、<code>iload_1</code>、<code>lload_2</code></td></tr><tr><td><code>eq</code></td><td>是否等于1（小于为-1，等于为0，大于为1，false为0，true为1）</td><td><code>ifeq #10</code>：如果等于1则继续执行紧跟的指令，否则跳转到第10个32b位置的指令处继续执行</td></tr><tr><td><code>ne</code></td><td>跟<code>eq</code>反过来</td><td><code>ifne #12</code>： 跟上面是反过来的意思</td></tr><tr><td><code>1</code></td><td>栈上int长度的空间（32b）</td><td>参考<code>aload_1</code>、<code>iload_1</code>、<code>istore_1</code></td></tr><tr><td><code>2</code></td><td>栈上long长度的空间（64b）</td><td>参考<code>lload_2</code>、<code>lstore_2</code></td></tr><tr><td><code>invokestatic</code></td><td>调用静态方法</td><td/></tr><tr><td><code>invokevirtual</code></td><td>调用实例方法</td><td/></tr><tr><td><code>invokespecial</code></td><td>调用构造方法、父类方法、重写的子类方法</td><td/></tr></tbody></table>
<h2 data-id="heading-1">1. 通过java字节码理解代码执行顺序</h2>
<p>案例一：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(Test.class);

    <span class="hljs-comment">// 写法一</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log1</span><span class="hljs-params">(FakeObj fakeObj)</span> {
        <span class="hljs-comment">// 日志框架会自己判断日志级别，如果最低日志级别是info，则该日志不会被打印出来</span>
        log.debug(<span class="hljs-string">"params={}"</span>, JSONObject.toJSONString(fakeObj));
    }
    <span class="hljs-comment">// 写法二</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log2</span><span class="hljs-params">(FakeObj fakeObj)</span> {
        <span class="hljs-keyword">if</span> (log.isDebugEnabled()) {
            log.debug(<span class="hljs-string">"params={}"</span>, JSONObject.toJSONString(fakeObj));
        }
    }
}
</code></pre>
<p>上面的代码编译后，使用<code>javap -v Test.class</code>命令查看其对应的字节码如下：</p>
<pre><code class="hljs language-java" lang="java">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log1</span><span class="hljs-params">(org.example.int_to_long.FakeObj)</span>;
    Code:
         <span class="hljs-number">0</span>: getstatic     #<span class="hljs-number">7</span>               <span class="hljs-comment">// Field log:Lorg/slf4j/Logger;</span>
         <span class="hljs-number">3</span>: ldc           #<span class="hljs-number">13</span>              <span class="hljs-comment">// String params={}</span>
         <span class="hljs-number">5</span>: aload_1
         <span class="hljs-number">6</span>: invokestatic  #<span class="hljs-number">15</span>              <span class="hljs-comment">// Method com/alibaba/fastjson/JSONObject.toJSONString:(Ljava/lang/Object;)Ljava/lang/String;</span>
         <span class="hljs-number">9</span>: invokeinterface #<span class="hljs-number">21</span>,  <span class="hljs-number">3</span>        <span class="hljs-comment">// InterfaceMethod org/slf4j/Logger.debug:(Ljava/lang/String;Ljava/lang/Object;)V</span>
        <span class="hljs-number">14</span>: <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log2</span><span class="hljs-params">(org.example.int_to_long.FakeObj)</span>;
    Code:
         <span class="hljs-number">0</span>: getstatic     #<span class="hljs-number">7</span>               <span class="hljs-comment">// Field log:Lorg/slf4j/Logger;</span>
         <span class="hljs-number">3</span>: invokeinterface #<span class="hljs-number">27</span>,  <span class="hljs-number">1</span>        <span class="hljs-comment">// InterfaceMethod org/slf4j/Logger.isDebugEnabled:()Z</span>
         <span class="hljs-number">8</span>: ifeq          <span class="hljs-number">25</span>               <span class="hljs-comment">// if如果上一句执行结果是0(即false)则跳转到行号25处，是1(tru</span>
)则继续
        <span class="hljs-number">11</span>: getstatic     #<span class="hljs-number">7</span>               <span class="hljs-comment">// Field log:Lorg/slf4j/Logger;</span>
        <span class="hljs-number">14</span>: ldc           #<span class="hljs-number">13</span>              <span class="hljs-comment">// String params={}</span>
        <span class="hljs-number">16</span>: aload_1
        <span class="hljs-number">17</span>: invokestatic  #<span class="hljs-number">15</span>              <span class="hljs-comment">// Method com/alibaba/fastjson/JSONObject.toJSONString:(Ljava/lang/Object;)Ljava/lang/String;</span>
        <span class="hljs-number">20</span>: invokeinterface #<span class="hljs-number">21</span>,  <span class="hljs-number">3</span>        <span class="hljs-comment">// InterfaceMethod org/slf4j/Logger.debug:(Ljava/lang/String;Ljava/lang/Object;)V</span>
        <span class="hljs-number">25</span>: <span class="hljs-keyword">return</span>
</code></pre>
<p>通过字节码可以看出，<code>log1</code>中第6行是执行<code>toJSONString()</code>方法，然后执行的<code>log.debug</code>，而<code>log2</code>方法中是先执行<code>isDebugEnabled</code>后，根据其结果再执行<code>toJSONString()</code>和<code>log.debug</code>，由于生产环境中一般不开启<code>debug</code>日志级别，所以<code>log2</code>方法可以在不开启<code>debug</code>日志级别时不执行<code>toJSONString()</code>，故<code>log2</code>的性能更好。但是对于<code>info</code>、<code>warn</code>和<code>error</code>则不需要这样增加日志级别判断了，因为大部分时候生产环境都会开启这3个日志级别的。</p>
<h2 data-id="heading-2">2. 通过java字节码理解装箱和拆箱到底是怎样的</h2>
<h3 data-id="heading-3">2.1 赋值时自动拆箱可能抛NullPointerException</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>{
        <span class="hljs-type">Long</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">long</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> a;
    }
}
</code></pre>
<p>上面的代码在把变量<code>a</code>赋值给<code>b</code>时就会抛出<code>NullPointerException</code>，使用<code>javap -v Test.class</code>命令查看其对应的字节码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">Test</span><span class="hljs-params">()</span>;
    Code:
       <span class="hljs-number">0</span>: aload_0
       <span class="hljs-number">1</span>: invokespecial #<span class="hljs-number">1</span>        <span class="hljs-comment">// Method java/lang/Object."&lt;init&gt;":()V</span>
       <span class="hljs-number">4</span>: <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(java.lang.String[])</span>;
    Code:
       <span class="hljs-number">0</span>: aconst_null             <span class="hljs-comment">// 把常量null的引用入栈</span>
       <span class="hljs-number">1</span>: astore_1                <span class="hljs-comment">// 给变量a赋值为null</span>
       <span class="hljs-number">2</span>: aload_1                 <span class="hljs-comment">// 读取变量a的值</span>
       <span class="hljs-number">3</span>: invokevirtual #<span class="hljs-number">2</span>        <span class="hljs-comment">// Method java/lang/Long.longValue:()J</span>
       <span class="hljs-number">6</span>: lstore_2                <span class="hljs-comment">// 把变量a转成long的结果赋值到临时变量b上</span>
       <span class="hljs-number">7</span>: <span class="hljs-keyword">return</span>
}
</code></pre>
<p>可以看到<code>main</code>方法行号为3的字节码调用了<code>Long.longValue()</code>方法，行号6的字节码才是把变量<code>a</code>赋值给<code>b</code>，显然由于<code>a</code>是<code>null</code>，所以调用<code>longValue()</code>方法自然会抛空指针了。</p>
<h3 data-id="heading-4">2.2 方法传参时自动拆箱抛NullPointerException</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>{
        <span class="hljs-type">Long</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        increment(a);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">increment</span><span class="hljs-params">(<span class="hljs-type">long</span> n)</span>{
        <span class="hljs-keyword">return</span> n++;
    }
}
</code></pre>
<p>上面把变量<code>a</code>传参给方法<code>increment</code>时就会抛<code>NullPointerException</code>，还是用<code>javap -v Test.class</code>查看其字节码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">Test</span><span class="hljs-params">()</span>;
    Code:
       <span class="hljs-number">0</span>: aload_0
       <span class="hljs-number">1</span>: invokespecial #<span class="hljs-number">1</span>        <span class="hljs-comment">// Method java/lang/Object."&lt;init&gt;":()V</span>
       <span class="hljs-number">4</span>: <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(java.lang.String[])</span>;
    Code:
       <span class="hljs-number">0</span>: aconst_null
       <span class="hljs-number">1</span>: astore_1
       <span class="hljs-number">2</span>: aload_1
       <span class="hljs-number">3</span>: invokevirtual #<span class="hljs-number">2</span>        <span class="hljs-comment">// Method java/lang/Long.longValue:()J</span>
       <span class="hljs-number">6</span>: invokestatic  #<span class="hljs-number">3</span>        <span class="hljs-comment">// Method increment:(J)J</span>
       <span class="hljs-number">9</span>: pop2
      <span class="hljs-number">10</span>: <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">increment</span><span class="hljs-params">(<span class="hljs-type">long</span>)</span>;
    Code:
       <span class="hljs-number">0</span>: lload_0
       <span class="hljs-number">1</span>: dup2
       <span class="hljs-number">2</span>: lconst_1
       <span class="hljs-number">3</span>: ladd
       <span class="hljs-number">4</span>: lstore_0
       <span class="hljs-number">5</span>: lreturn
}
</code></pre>
<p>可以看到<code>main</code>方法行号为3的字节码调用了<code>Long.longValue()</code>方法，行号6的字节码才是真正的执行<code>increment</code>，显然由于<code>a</code>是<code>null</code>，所以调用<code>longValue()</code>方法也会抛空指针了。</p>
<h3 data-id="heading-5">2.3 用于大小比较或运算时拆箱抛NullPointerException</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>{
        <span class="hljs-type">Long</span> <span class="hljs-variable">n1</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">long</span> <span class="hljs-variable">n2</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
        <span class="hljs-keyword">if</span>(n1 == n2){
        }
    }
}
</code></pre>
<p>同样用<code>javap -v Test.class</code>查看字节码内容如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">Test</span><span class="hljs-params">()</span>;
    Code:
       <span class="hljs-number">0</span>: aload_0
       <span class="hljs-number">1</span>: invokespecial #<span class="hljs-number">1</span>        <span class="hljs-comment">// Method java/lang/Object."&lt;init&gt;":()V</span>
       <span class="hljs-number">4</span>: <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(java.lang.String[])</span>;
    Code:
       <span class="hljs-number">0</span>: aconst_null
       <span class="hljs-number">1</span>: astore_1
       <span class="hljs-number">2</span>: lconst_1
       <span class="hljs-number">3</span>: lstore_2
       <span class="hljs-number">4</span>: aload_1
       <span class="hljs-number">5</span>: invokevirtual #<span class="hljs-number">2</span>        <span class="hljs-comment">// Method java/lang/Long.longValue:()J</span>
       <span class="hljs-number">8</span>: lload_2
       <span class="hljs-number">9</span>: lcmp
      <span class="hljs-number">10</span>: ifne          <span class="hljs-number">13</span>
      <span class="hljs-number">13</span>: <span class="hljs-keyword">return</span>
}
</code></pre>
<p>同样的在行号8的字节码通过<code>Long.longValue()</code>方法把变量<code>n1</code>从<code>Long</code>转换成了<code>long</code>，然后行号8为加载变量<code>n2</code>，行号9才是比较两个<code>long</code>（注意不是比较<code>Long</code>）。</p>
<h2 data-id="heading-6">3. int和long直接计算时结果到底是int还是long</h2>
<h3 data-id="heading-7">3.1 int+long计算</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        <span class="hljs-type">long</span> <span class="hljs-variable">l</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
        <span class="hljs-comment">// 看看这里到底是调用下面的哪个print方法</span>
        print(i+l);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">print</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span> {
        System.out.println(<span class="hljs-string">"i="</span> + i);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">print</span><span class="hljs-params">(<span class="hljs-type">long</span> l)</span> {
        System.out.println(<span class="hljs-string">"l="</span> + l);
    }
}
</code></pre>
<p>这段代码输出结果是<code>l=1</code> ，即第二个<code>print</code>方法，同样用<code>javap -v Test.class</code>查看字节码内容如下：</p>
<pre><code class="hljs language-java" lang="java">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(java.lang.String[])</span>;
    Code:
      stack=<span class="hljs-number">4</span>, locals=<span class="hljs-number">4</span>, args_size=<span class="hljs-number">1</span>
         <span class="hljs-number">0</span>: iconst_1
         <span class="hljs-number">1</span>: istore_1
         <span class="hljs-number">2</span>: lconst_1
         <span class="hljs-number">3</span>: lstore_2
         <span class="hljs-number">4</span>: iload_1            <span class="hljs-comment">// 加载变量i</span>
         <span class="hljs-number">5</span>: i2l                <span class="hljs-comment">// 把变量i从int转成long</span>
         <span class="hljs-number">6</span>: lload_2            <span class="hljs-comment">// 加载变量l</span>
         <span class="hljs-number">7</span>: ladd               <span class="hljs-comment">// 计算i+l</span>
         <span class="hljs-number">8</span>: invokestatic  #<span class="hljs-number">7</span>   <span class="hljs-comment">// Method print:(J)V</span>
        <span class="hljs-number">11</span>: <span class="hljs-keyword">return</span>
</code></pre>
<p>这说明编译器在编译的时候就已经把<code>i+l</code>计算后的类型固定为<code>long</code>了，所以调用的直接就是第二个<code>print</code>方法。</p>
<h3 data-id="heading-8">3.2 int和long的三元组计算</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        <span class="hljs-type">long</span> <span class="hljs-variable">l</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        print(<span class="hljs-literal">true</span> ? i : l);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">print</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span> {
        System.out.println(<span class="hljs-string">"i="</span> + i);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">print</span><span class="hljs-params">(<span class="hljs-type">long</span> l)</span> {
        System.out.println(<span class="hljs-string">"l="</span> + l);
    }
}
</code></pre>
<p>这段代码输出结果仍然是<code>l=1</code> ，即第二个<code>print</code>方法，同样用<code>javap -v Test.class</code>查看字节码内容：</p>
<pre><code class="hljs language-java" lang="java">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(java.lang.String[])</span>;
    Code:
      stack=<span class="hljs-number">2</span>, locals=<span class="hljs-number">4</span>, args_size=<span class="hljs-number">1</span>
         <span class="hljs-number">0</span>: iconst_1
         <span class="hljs-number">1</span>: istore_1
         <span class="hljs-number">2</span>: lconst_1
         <span class="hljs-number">3</span>: lstore_2
         <span class="hljs-number">4</span>: iload_1            <span class="hljs-comment">// 加载变量i</span>
         <span class="hljs-number">5</span>: i2l                <span class="hljs-comment">// 把变量i从int转成long</span>
         <span class="hljs-number">6</span>: invokestatic  #<span class="hljs-number">7</span>   <span class="hljs-comment">// Method print:(J)V</span>
         <span class="hljs-number">9</span>: <span class="hljs-keyword">return</span>
</code></pre>
<p>可见尽管<code>print</code>方法的入参实际是变量<code>int</code>类型的<code>i</code>， 编译器仍然会把<code>i</code>强转成<code>long</code>，然后固定调用第二个<code>print</code>方法</p>
<h2 data-id="heading-9">4. 字符串相加跟StringBuilder其实是一样的效果</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">(String a, String b)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> a + b;
        System.out.println(str);
    }
}
</code></pre>
<p>同样用<code>javap -v Test.class</code>查看字节码内容如下：</p>
<pre><code class="hljs language-java" lang="java">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">(java.lang.String, java.lang.String)</span>;
    descriptor: (Ljava/lang/String;Ljava/lang/String;)V
    flags: (<span class="hljs-number">0x0001</span>) ACC_PUBLIC
    Code:
      stack=<span class="hljs-number">2</span>, locals=<span class="hljs-number">4</span>, args_size=<span class="hljs-number">3</span>
         <span class="hljs-number">0</span>: aload_1                <span class="hljs-comment">// 加载变量a</span>
         <span class="hljs-number">1</span>: aload_2                <span class="hljs-comment">// 加载变量B</span>
         <span class="hljs-number">2</span>: invokedynamic #<span class="hljs-number">7</span>,  <span class="hljs-number">0</span>   <span class="hljs-comment">// InvokeDynamic #0:makeConcatWithConstants:(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;</span>
         <span class="hljs-number">7</span>: astore_3
         <span class="hljs-number">8</span>: getstatic     #<span class="hljs-number">11</span>      <span class="hljs-comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span>
        <span class="hljs-number">11</span>: aload_3
        <span class="hljs-number">12</span>: invokevirtual #<span class="hljs-number">17</span>      <span class="hljs-comment">// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
        <span class="hljs-number">15</span>: <span class="hljs-keyword">return</span>

SourceFile: <span class="hljs-string">"Test.java"</span>
BootstrapMethods:
  <span class="hljs-number">0</span>: #<span class="hljs-number">41</span> REF_invokeStatic java/lang/invoke/StringConcatFactory.makeConcatWithConstants:(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/invoke/CallSite;
    Method arguments:
      #<span class="hljs-number">39</span> \u0001\u0001
InnerClasses:
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> #<span class="hljs-number">52</span>= #<span class="hljs-number">48</span> of #<span class="hljs-number">50</span>;    <span class="hljs-comment">// Lookup=class java/lang/invoke/MethodHandles$Lookup of class java/lang/invoke/MethodHandles</span>
</code></pre>
<p><code>test1</code>方法字节码的第2行是调用的 <code>StringConcatFactory.makeConcatWithConstants</code>方法，这个是，<code>String</code>; 这个指令实际上是在运行时动态地创建一个 <code>StringBuilder</code>，并将拼接的字符串常量加入其中，最终返回拼接后的字符串，也就是说跟我们自己直接写<code>StringBuilder</code>其实是差不多的，只是写起来更简洁一些 。</p>
<p>（本文提到的字节码中的行号其实是字节码指令占用空间的偏移量，为了便于理解，暂以行号来理解 ，同时为了方便阅读字节码，移除了字节码中的<code>flags</code>、<code>descriptor</code>、<code>LineNumberTable</code>、<code>LocalVariableTable</code>、<code>StackMapTable</code>、<code>static</code>静态语句块的内容）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[From Nand to Tetris 里的 Project 2]]></title>    <link>https://juejin.cn/post/7582791876367400998</link>    <guid>https://juejin.cn/post/7582791876367400998</guid>    <pubDate>2025-12-13T02:19:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582791876367400998" data-draft-id="7582425536463880218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="From Nand to Tetris 里的 Project 2"/> <meta itemprop="keywords" content="设计"/> <meta itemprop="datePublished" content="2025-12-13T02:19:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="金銀銅鐵"/> <meta itemprop="url" content="https://juejin.cn/user/747323638159757"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            From Nand to Tetris 里的 Project 2
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323638159757/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    金銀銅鐵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T02:19:45.000Z" title="Sat Dec 13 2025 02:19:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>让我们按照 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nand2tetris.org%2Fcourse" target="_blank" title="https://www.nand2tetris.org/course" ref="nofollow noopener noreferrer">From Nand to Tetris</a> 里 <code>Project 2</code> 的要求，来完成下列的设计。</p>
<ol>
<li>实现半加器(<code>HalfAdder</code>)</li>
<li>实现全加器(<code>FullAdder</code>)</li>
<li>实现 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 位加法器(<code>Add16</code>)</li>
<li>实现 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 位自增器(<code>Inc16</code>)</li>
<li>实现算术逻辑单元(<code>ALU</code>) (todo)</li>
</ol>
<h2 data-id="heading-1">正文</h2>
<h3 data-id="heading-2">1. 实现 <code>HalfAdder</code></h3>
<p>前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnand2tetris.github.io%2Fweb-ide%2Fchip%2F" target="_blank" title="https://nand2tetris.github.io/web-ide/chip/" ref="nofollow noopener noreferrer">Nand to Tetris Online IDE</a>，选择 <code>Project 2</code> 里的 <code>HalfAdder</code>，效果如下图所示 ⬇️</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a2693541f9b4ba2bc3626b93bb58289~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766211366&amp;x-signature=bu9%2BnTa2qxModhqK26NOsgwTGdo%3D" alt="image.png" loading="lazy"/></p>
<p>我们的目标是用 <code>Project 1</code> 里已经实现的各种 <code>chip</code> 实现一个 <code>HalfAdder</code>。</p>
<ul>
<li>输入是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></li>
</ul>
</li>
<li>输出是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">sum</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">carry</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">rry</span></span></span></span></span></li>
</ul>
</li>
</ul>
<p>我们可以从它的真值表入手 ⬇️</p>



































<table><thead><tr><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">sum</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">carry</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">rry</span></span></span></span></span></th></tr></thead><tbody><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td></tr></tbody></table>
<p>可见</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi><mo>=</mo><mo stretchy="false">(</mo><mi mathvariant="normal">¬</mi><mi>a</mi><mo>∧</mo><mi>b</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mi>a</mi><mo>⊕</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">sum=(\neg{a}\land b) \lor (a\land \neg{b})=a\oplus b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">a</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">b</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>y</mi><mo>=</mo><mi>a</mi><mo>∧</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">carry=a\land b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">rry</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5556em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></li>
</ul>
<p>所以可以这样实现 ⬇️</p>
<pre><code class="hljs language-hdl" lang="hdl">CHIP HalfAdder {
    IN a, b;    // 1-bit inputs
    OUT sum,    // Right bit of a + b 
        carry;  // Left bit of a + b

    PARTS:
    And(a= a, b= b, out= carry);
    Xor(a = a, b = b, out = sum);
}
</code></pre>
<p>这样的代码可以通过仿真测试，效果如下图所示 ⬇️</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef9818f66b684269880f0fa23c7e50c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766211366&amp;x-signature=KXDeCT%2FZcb7LJyAXzuijV0wc4rk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">2. 实现 <code>FullAdder</code></h3>
<p>前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnand2tetris.github.io%2Fweb-ide%2Fchip%2F" target="_blank" title="https://nand2tetris.github.io/web-ide/chip/" ref="nofollow noopener noreferrer">Nand to Tetris Online IDE</a>，选择 <code>Project 2</code> 里的 <code>FullAdder</code>，效果如下图所示 ⬇️</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/032edf4cedc34b9eaef02e82291791ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766211366&amp;x-signature=qHGfLwstBWDv18%2BM49zfjTxsllw%3D" alt="image.png" loading="lazy"/></p>
<p>我们的目标是用 <code>Project 1</code> 里已经实现的各种 <code>chip</code>，以及刚才实现的 <code>HalfAdder</code> 来实现一个 <code>FullAdder</code>。</p>
<ul>
<li>输入是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span></span></span></span></span></li>
</ul>
</li>
<li>输出是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">sum</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">carry</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">rry</span></span></span></span></span></li>
</ul>
</li>
</ul>
<p>我们还是从真值表入手 ⬇️</p>




































































<table><thead><tr><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">sum</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">carry</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">rry</span></span></span></span></span></th></tr></thead><tbody><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></td></tr></tbody></table>
<p>通过观察真值表，可以将 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">sum</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">carry</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">rry</span></span></span></span></span> 写成对应的析取范式 <code>DNF</code>(<code>Disjunctive Normal Form</code>) 的形式</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi><mo>=</mo><mo stretchy="false">(</mo><mi mathvariant="normal">¬</mi><mi>a</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>b</mi><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi mathvariant="normal">¬</mi><mi>a</mi><mo>∧</mo><mi>b</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>b</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi>b</mi><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">sum=(\neg{a}\land \neg{b}\land c)\lor (\neg{a}\land b\land \neg{c})\lor(a\land\neg{b}\land \neg{c})\lor(a\land b\land c)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">a</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">b</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">a</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">c</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">b</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">c</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>y</mi><mo>=</mo><mo stretchy="false">(</mo><mi mathvariant="normal">¬</mi><mi>a</mi><mo>∧</mo><mi>b</mi><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>b</mi><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi>b</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi>b</mi><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">carry=(\neg{a}\land b\land c)\lor(a\land \neg{b}\land c)\lor(a\land b\land \neg{c})\lor(a\land b\land c)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">rry</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">a</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">b</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">c</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span></span></span></span></span></li>
</ul>
<p>从上面的析取范式出发，我们可以只用 <code>And</code>/<code>Or</code>/<code>Not</code> 来实现 <code>FullAdder</code>。但有没有更简洁的实现方式呢？
我们回忆一下 <code>HalfAdder</code> 中的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">sum</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">carry</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">rry</span></span></span></span></span> 是怎样的 ⬇️ （为了和 <code>FullAdder</code> 的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">sum</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">carry</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">rry</span></span></span></span></span> 进行区分，我把 <code>HalfAdder</code> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">sum</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">carry</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">rry</span></span></span></span></span> 分别改写为的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">sum_{ha}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><msub><mi>y</mi><mrow><mi>h</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">carry_{ha}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>a</mi></mrow></msub><mo>=</mo><mo stretchy="false">(</mo><mi mathvariant="normal">¬</mi><mi>a</mi><mo>∧</mo><mi>b</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mi>a</mi><mo>⊕</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">sum_{ha}=(\neg{a}\land b) \lor (a\land \neg{b})=a\oplus b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">a</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">b</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><msub><mi>y</mi><mrow><mi>h</mi><mi>a</mi></mrow></msub><mo>=</mo><mi>a</mi><mo>∧</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">carry_{ha}=a\land b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5556em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></li>
</ul>
<p>为了便于区分，我把 <code>FullAdder</code> 的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">sum</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">carry</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">rry</span></span></span></span></span> 分别改写为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>f</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">sum_{fa}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><msub><mi>y</mi><mrow><mi>f</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">carry_{fa}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>。
先看 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>f</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">sum_{fa}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">sum_{ha}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 是否有关联。</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>f</mi><mi>a</mi></mrow></msub><mo>=</mo><mo stretchy="false">(</mo><mi mathvariant="normal">¬</mi><mi>a</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>b</mi><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi mathvariant="normal">¬</mi><mi>a</mi><mo>∧</mo><mi>b</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>b</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi>b</mi><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">sum_{fa}=(\neg{a}\land \neg{b}\land c)\lor (\neg{a}\land b\land \neg{c})\lor(a\land\neg{b}\land \neg{c})\lor(a\land b\land c)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">a</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">b</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">a</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">c</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">b</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">c</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>a</mi></mrow></msub><mo>=</mo><mi>a</mi><mo>⊕</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">sum_{ha}=a\oplus b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></li>
</ul>
<h4 data-id="heading-4">如何表示 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">sum</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span></span></span></span></span></h4>
<p>一个思路是看看能否将 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>f</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">sum_{fa}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">sum_{ha}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 表示出来，我试了试，觉得有些繁琐，而且不容易想到。另一个思路是，我们从 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>f</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">sum_{fa}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">sum_{ha}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 背后的含义入手。
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">sum_{ha}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 表示 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo separator="true">,</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a,b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span></span></span></span></span> 的和（忽略进位），所以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>a</mi></mrow></msub><mo>=</mo><mi>a</mi><mo>⊕</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">sum_{ha}=a\oplus b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>。</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>a</mi></mrow></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">sum_{ha}=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span> 时，只有 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">c=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>f</mi><mi>a</mi></mrow></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">sum_{fa}=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span> 才会成立</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>a</mi></mrow></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">sum_{ha}=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span> 时，只有 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">c=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>f</mi><mi>a</mi></mrow></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">sum_{fa}=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span> 才会成立</li>
</ul>
<p>所以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>f</mi><mi>a</mi></mrow></msub><mo>=</mo><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>a</mi></mrow></msub><mo>⊕</mo><mi>c</mi></mrow><annotation encoding="application/x-tex">sum_{fa}=sum_{ha}\oplus c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span></span></span></span></span></p>
<p>而 <code>HalfAdder</code> 的作用就是对输入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo separator="true">,</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a,b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span></span></span></span></span> 分别执行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⊕</mo></mrow><annotation encoding="application/x-tex">\oplus</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord">⊕</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∧</mo></mrow><annotation encoding="application/x-tex">\land</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5556em;"/><span class="mord">∧</span></span></span></span></span> 运算，所以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>f</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">sum_{fa}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 可以通过拼接两个 <code>HalfAdder</code> 来实现 ⬇️</p>
<ul>
<li>第一个 <code>HalfAdder</code> 以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo separator="true">,</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a,b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span></span></span></span></span> 为输入，其 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>a</mi><mn>1</mn></mrow></msub><mo>=</mo><mi>a</mi><mo>⊕</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">sum_{ha1}=a\oplus b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></li>
<li>第二个 <code>HalfAdder</code> 以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>f</mi><mi>a</mi><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">sum_{fa1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span></span></span></span></span> 为输入，其 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>a</mi><mn>2</mn></mrow></msub><mo>=</mo><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>f</mi><mi>a</mi><mn>1</mn></mrow></msub><mo>⊕</mo><mi>c</mi><mo>=</mo></mrow><annotation encoding="application/x-tex">sum_{ha2}=sum_{fa1}\oplus c=</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span></span></span></span></span></li>
</ul>
<h4 data-id="heading-5">如何表示 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">carry</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">rry</span></span></span></span></span></h4>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><msub><mi>y</mi><mrow><mi>f</mi><mi>a</mi></mrow></msub><mo>=</mo><mo stretchy="false">(</mo><mi mathvariant="normal">¬</mi><mi>a</mi><mo>∧</mo><mi>b</mi><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>b</mi><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi>b</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi>b</mi><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">carry_{fa}=(\neg{a}\land b\land c)\lor(a\land \neg{b}\land c)\lor(a\land b\land \neg{c})\lor(a\land b\land c)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">a</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">b</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">c</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>=</mo><mo stretchy="false">(</mo><mi mathvariant="normal">¬</mi><mi>a</mi><mo>∧</mo><mi>b</mi><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>b</mi><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi>b</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi>b</mi><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">=(\neg{a}\land b\land c)\lor(a\land \neg{b}\land c)\lor((a\land b\land \neg{c})\lor(a\land b\land c))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">a</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">b</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">((</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">c</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">))</span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>=</mo><mo stretchy="false">(</mo><mi mathvariant="normal">¬</mi><mi>a</mi><mo>∧</mo><mi>b</mi><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>b</mi><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">=(\neg{a}\land b\land c)\lor(a\land \neg{b}\land c)\lor(a\land b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">a</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">b</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>=</mo><mo stretchy="false">(</mo><mi mathvariant="normal">¬</mi><mi>a</mi><mo>∧</mo><mi>b</mi><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi>a</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>b</mi><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><msub><mi>y</mi><mrow><mi>h</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">=(\neg{a}\land b\land c)\lor(a\land \neg{b}\land c)\lor carry_{ha}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">a</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">¬</span><span class="mord"><span class="mord mathnormal">b</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>=</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mi>a</mi><mo>⊕</mo><mi>b</mi><mo stretchy="false">)</mo><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><msub><mi>y</mi><mrow><mi>h</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">=((a\oplus b)\land c)\lor carry_{ha}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">((</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>=</mo><mo stretchy="false">(</mo><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>a</mi></mrow></msub><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><msub><mi>y</mi><mrow><mi>h</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">=(sum_{ha}\land c)\lor carry_{ha}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>考虑到 <code>HalfAdder</code> 的作用就是对输入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo separator="true">,</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a,b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span></span></span></span></span> 分别执行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⊕</mo></mrow><annotation encoding="application/x-tex">\oplus</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord">⊕</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∧</mo></mrow><annotation encoding="application/x-tex">\land</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5556em;"/><span class="mord">∧</span></span></span></span></span> 运算，所以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><msub><mi>y</mi><mrow><mi>f</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">carry_{fa}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 可以通过拼接两个 <code>HalfAdder</code> <strong>再加上一个 <code>Or</code> 运算</strong> 来实现 ⬇️</p>
<ul>
<li>第一个 <code>HalfAdder</code> 以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo separator="true">,</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a,b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span></span></span></span></span> 为输入，它的
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>f</mi><mi>a</mi><mn>1</mn></mrow></msub><mo>=</mo><mi>a</mi><mo>⊕</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">sum_{fa1}=a\oplus b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><msub><mi>y</mi><mrow><mi>h</mi><mi>a</mi><mn>1</mn></mrow></msub><mo>=</mo><mi>a</mi><mo>∧</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">carry_{ha1}=a\land b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5556em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></li>
</ul>
</li>
<li>第二个 <code>HalfAdder</code> 以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>f</mi><mi>a</mi><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">sum_{fa1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span></span></span></span></span> 为输入，它的
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>a</mi><mn>2</mn></mrow></msub><mo>=</mo><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>f</mi><mi>a</mi><mn>1</mn></mrow></msub><mo>⊕</mo><mi>c</mi></mrow><annotation encoding="application/x-tex">sum_{ha2}=sum_{fa1}\oplus c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><msub><mi>y</mi><mrow><mi>h</mi><mi>a</mi><mn>2</mn></mrow></msub><mo>=</mo><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>f</mi><mi>a</mi><mn>1</mn></mrow></msub><mo>∧</mo><mi>c</mi></mrow><annotation encoding="application/x-tex">carry_{ha2}=sum_{fa1}\land c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8417em;vertical-align:-0.2861em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span></span></span></span></span></li>
</ul>
</li>
</ul>
<p>那么</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><msub><mi>y</mi><mrow><mi>f</mi><mi>a</mi></mrow></msub><mo>=</mo><mo stretchy="false">(</mo><mi>s</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>a</mi><mn>1</mn></mrow></msub><mo>∧</mo><mi>c</mi><mo stretchy="false">)</mo><mo>∨</mo><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><msub><mi>y</mi><mrow><mi>h</mi><mi>a</mi><mn>1</mn></mrow></msub><mo>=</mo><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><msub><mi>y</mi><mrow><mi>h</mi><mi>a</mi><mn>2</mn></mrow></msub><mo>∨</mo><mi>c</mi><mi>a</mi><mi>r</mi><mi>r</mi><msub><mi>y</mi><mrow><mi>h</mi><mi>a</mi><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">carry_{fa}=(sum_{ha1}\land c)\lor carry_{ha1}=carry_{ha2}\lor carry_{ha1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.75em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>至此我们可以用 <code>HalfAdder</code> 和 <code>Or</code> 来实现 <code>FullAdder</code>。具体的代码如下 ⬇️</p>
<pre><code class="hljs language-hdl" lang="hdl">CHIP FullAdder {
    IN a, b, c;  // 1-bit inputs
    OUT sum,     // Right bit of a + b + c
        carry;   // Left bit of a + b + c

    PARTS:
    HalfAdder(a= a, b= b, sum= sumHa, carry= carryHa);
    HalfAdder(a= sumHa, b= c, sum= sum, carry= temp);
    Or(a= carryHa, b= temp, out= carry);
}
</code></pre>
<p>这样的代码可以通过仿真测试，效果如下图所示 ⬇️</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eaa6caf8437f4e1a90c9c51fb86c1fda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766211366&amp;x-signature=bZWTamo4lVDYIZHguUxfK3VgynM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">3. 实现 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 位加法器(<code>Add16</code>)</h3>
<p>前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnand2tetris.github.io%2Fweb-ide%2Fchip%2F" target="_blank" title="https://nand2tetris.github.io/web-ide/chip/" ref="nofollow noopener noreferrer">Nand to Tetris Online IDE</a>，选择 <code>Project 2</code> 里的 <code>Add16</code>，效果如下图所示 ⬇️</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6095eda2739e419da07d69d0b8f29287~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766211366&amp;x-signature=bqxqSDGeI%2FQYbq0Rc%2ByNWmEPiGY%3D" alt="image.png" loading="lazy"/></p>
<p>我们的目标是用 <code>Project 1</code> 里已经实现的各种 <code>chip</code>，以及刚才实现的 <code>HalfAdder</code>/<code>FullAdder</code> 来实现一个 <code>Add16</code>。</p>
<ul>
<li>输入是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">a[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">a</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">b[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">b</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span></li>
</ul>
</li>
<li>输出是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">out[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span></li>
</ul>
</li>
</ul>
<p>要实现的逻辑如下 ⬇️</p>
<pre><code class="hljs language-text" lang="text">16-bit adder: Adds two 16-bit two's complement values.
The most significant carry bit is ignored.
</code></pre>
<p>我写了如下的 <code>java</code> 程序来生成对应的 <code>HDL</code> 代码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.StringJoiner;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Adder16HdlCodeGenerator</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> <span class="hljs-string">"""
                CHIP Add16 {
                    IN a[16], b[16];
                    OUT out[16];
                
                    PARTS:
                %s
                }
                """</span>;
        <span class="hljs-type">StringJoiner</span> <span class="hljs-variable">joiner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringJoiner</span>(System.lineSeparator());
        joiner.add(<span class="hljs-string">"    FullAdder(a= a[0], b= b[0], c= false, sum= out[0], carry= c0);"</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">16</span>; i++) {
            <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"    FullAdder(a= a[%s], b= b[%s], c= c%s, sum= out[%s], carry= c%s);"</span>, i, i, i - <span class="hljs-number">1</span>, i, i);
            joiner.add(line);
        }
        System.out.printf(template, joiner);
    }
}
</code></pre>
<p>请将以上 <code>java</code> 代码保存为 <code>Adder16HdlCodeGenerator.java</code>。用以下命令可以编译 <code>Adder16HdlCodeGenerator.java</code> 并运行其中的 <code>main</code> 方法。</p>
<pre><code class="hljs language-bash" lang="bash">javac Adder16HdlCodeGenerator.java
java Adder16HdlCodeGenerator
</code></pre>
<p>运行结果如下</p>
<pre><code class="hljs language-hdl" lang="hdl">CHIP Add16 {
    IN a[16], b[16];
    OUT out[16];

    PARTS:
    FullAdder(a= a[0], b= b[0], c= false, sum= out[0], carry= c0);
    FullAdder(a= a[1], b= b[1], c= c0, sum= out[1], carry= c1);
    FullAdder(a= a[2], b= b[2], c= c1, sum= out[2], carry= c2);
    FullAdder(a= a[3], b= b[3], c= c2, sum= out[3], carry= c3);
    FullAdder(a= a[4], b= b[4], c= c3, sum= out[4], carry= c4);
    FullAdder(a= a[5], b= b[5], c= c4, sum= out[5], carry= c5);
    FullAdder(a= a[6], b= b[6], c= c5, sum= out[6], carry= c6);
    FullAdder(a= a[7], b= b[7], c= c6, sum= out[7], carry= c7);
    FullAdder(a= a[8], b= b[8], c= c7, sum= out[8], carry= c8);
    FullAdder(a= a[9], b= b[9], c= c8, sum= out[9], carry= c9);
    FullAdder(a= a[10], b= b[10], c= c9, sum= out[10], carry= c10);
    FullAdder(a= a[11], b= b[11], c= c10, sum= out[11], carry= c11);
    FullAdder(a= a[12], b= b[12], c= c11, sum= out[12], carry= c12);
    FullAdder(a= a[13], b= b[13], c= c12, sum= out[13], carry= c13);
    FullAdder(a= a[14], b= b[14], c= c13, sum= out[14], carry= c14);
    FullAdder(a= a[15], b= b[15], c= c14, sum= out[15], carry= c15);
}
</code></pre>
<p>这样的代码可以通过仿真测试，效果如下图所示 ⬇️</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd6621d35116468f957272182875f5ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766211366&amp;x-signature=INbRKYJiiK9TBIMpLSYaI4OxoUk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">4. 实现 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 位自增器(<code>Inc16</code>)</h3>
<p>前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnand2tetris.github.io%2Fweb-ide%2Fchip%2F" target="_blank" title="https://nand2tetris.github.io/web-ide/chip/" ref="nofollow noopener noreferrer">Nand to Tetris Online IDE</a>，选择 <code>Project 2</code> 里的 <code>Inc16</code>，效果如下图所示 ⬇️</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc97e18f6bbe4b7b831d7e6b264203b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766211366&amp;x-signature=iFEWLqE0MHjOsdpUZlBJdSnNPkQ%3D" alt="image.png" loading="lazy"/></p>
<p>我们的目标是用 <code>Project 1</code> 里已经实现的各种 <code>chip</code>，以及刚才实现的 <code>HalfAdder</code>/<code>FullAdder</code>/<code>Add16</code> 来实现一个 <code>Inc16</code>。</p>
<ul>
<li>输入是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>n</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">in[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">in</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span></li>
</ul>
</li>
<li>输出是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">out[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span></li>
</ul>
</li>
</ul>
<p>要实现的逻辑如下 ⬇️</p>
<pre><code class="hljs language-text" lang="text">16-bit incrementer:
out = in + 1
</code></pre>
<p>一个直观的做法是使用上一步实现的 <code>Add16</code>，具体的代码如下 ⬇️</p>
<pre><code class="hljs language-hdl" lang="hdl">CHIP Inc16 {
    IN in[16];
    OUT out[16];

    PARTS:
    Add16(a = in, b[0]= true, b[1..15] = false, out = out);
}
</code></pre>
<p>这样的代码可以通过仿真测试，效果如下图所示 ⬇️</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60ba95181a5a43318079d8996caca682~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766211366&amp;x-signature=OzY7n2K%2BQ0QsjcW9dGfYVojAJIU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">5. 实现算术逻辑单元(<code>ALU</code>)</h3>
<p>前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnand2tetris.github.io%2Fweb-ide%2Fchip%2F" target="_blank" title="https://nand2tetris.github.io/web-ide/chip/" ref="nofollow noopener noreferrer">Nand to Tetris Online IDE</a>，选择 <code>Project 2</code> 里的 <code>ALU</code>，效果如下图所示 ⬇️</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14126a4181a44f2dabbe0f571cd85e41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766211366&amp;x-signature=UHb1OoDOtn83dq1Dmg6K5jf6Y48%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnand2tetris.github.io%2Fweb-ide%2Fchip%2F" target="_blank" title="https://nand2tetris.github.io/web-ide/chip/" ref="nofollow noopener noreferrer">Nand to Tetris Online IDE</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 8日期时间API完全指南：告别Date和Calendar的混乱时代]]></title>    <link>https://juejin.cn/post/7582854603060330538</link>    <guid>https://juejin.cn/post/7582854603060330538</guid>    <pubDate>2025-12-13T05:38:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582854603060330538" data-draft-id="7582854603060314154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 8日期时间API完全指南：告别Date和Calendar的混乱时代"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-13T05:38:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 8日期时间API完全指南：告别Date和Calendar的混乱时代
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T05:38:46.000Z" title="Sat Dec 13 2025 05:38:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">引言：为什么需要新的日期时间API？</h2>
<p>如果你曾经使用过Java的<code>java.util.Date</code>和<code>java.util.Calendar</code>，一定体会过那种混乱和痛苦：月份从0开始、<code>Date</code>既包含日期又包含时间、<code>SimpleDateFormat</code>线程不安全、时区处理复杂... Java 8引入的全新日期时间API彻底解决了这些问题，带来了现代化、易于使用且线程安全的时间处理方式。</p>
<h2 data-id="heading-1">新旧API对比：一场革命</h2>
<h3 data-id="heading-2">传统API的问题</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.*;
<span class="hljs-keyword">import</span> java.text.SimpleDateFormat;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LegacyDateTimeProblems</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 问题1: Date的月份从0开始（0=一月，11=十二月）</span>
        <span class="hljs-type">Date</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">2023</span>, <span class="hljs-number">10</span>, <span class="hljs-number">15</span>); <span class="hljs-comment">// 这实际上是2023年11月15日！</span>
        System.out.println(<span class="hljs-string">"令人困惑的月份: "</span> + date);
        
        <span class="hljs-comment">// 问题2: SimpleDateFormat线程不安全</span>
        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">sdf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">"yyyy-MM-dd"</span>);
        <span class="hljs-type">Date</span> <span class="hljs-variable">parsedDate</span> <span class="hljs-operator">=</span> sdf.parse(<span class="hljs-string">"2023-11-15"</span>);
        System.out.println(<span class="hljs-string">"解析后的日期: "</span> + parsedDate);
        
        <span class="hljs-comment">// 问题3: Calendar操作繁琐且容易出错</span>
        <span class="hljs-type">Calendar</span> <span class="hljs-variable">calendar</span> <span class="hljs-operator">=</span> Calendar.getInstance();
        calendar.set(<span class="hljs-number">2023</span>, Calendar.NOVEMBER, <span class="hljs-number">15</span>); <span class="hljs-comment">// 注意：这里月份是实际的11月</span>
        calendar.add(Calendar.DAY_OF_MONTH, <span class="hljs-number">7</span>);
        System.out.println(<span class="hljs-string">"7天后: "</span> + calendar.getTime());
        
        <span class="hljs-comment">// 问题4: Date同时包含日期和时间，但经常被误用</span>
        <span class="hljs-type">Date</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
        System.out.println(<span class="hljs-string">"Date包含时间: "</span> + now);
        
        <span class="hljs-comment">// 问题5: 时区处理复杂</span>
        <span class="hljs-type">TimeZone</span> <span class="hljs-variable">tz</span> <span class="hljs-operator">=</span> TimeZone.getTimeZone(<span class="hljs-string">"America/New_York"</span>);
        calendar.setTimeZone(tz);
        System.out.println(<span class="hljs-string">"纽约时间: "</span> + calendar.getTime());
    }
}
</code></pre>
<h3 data-id="heading-3">Java 8日期时间API的核心优势</h3>
<ul>
<li><strong>不可变性</strong>：所有日期时间对象都是不可变的，线程安全</li>
<li><strong>清晰的设计</strong>：分离了日期、时间、日期时间等概念</li>
<li><strong>流畅的API</strong>：链式调用，代码更易读</li>
<li><strong>强大的时区支持</strong>：内置完善的时区处理</li>
<li><strong>更好的扩展性</strong>：支持自定义日历系统</li>
</ul>
<h2 data-id="heading-4">核心类概览</h2>
<pre><code class="hljs language-java" lang="java">Java <span class="hljs-number">8</span>日期时间API主要类：
├── 基本日期时间类
│   ├── LocalDate       (日期：年-月-日)
│   ├── LocalTime       (时间：时-分-秒-纳秒)
│   ├── LocalDateTime   (日期时间)
│   ├── ZonedDateTime   (带时区的日期时间)
│   └── OffsetDateTime  (带偏移量的日期时间)
│
├── 时间点与持续时间
│   ├── Instant         (时间戳，基于Unix时间)
│   ├── Duration        (时间段，基于时间)
│   └── Period          (时间段，基于日期)
│
├── 辅助类
│   ├── DateTimeFormatter (日期时间格式化)
│   ├── ZoneId          (时区ID)
│   ├── ZoneOffset      (时区偏移量)
│   └── Chronology      (年表，支持不同日历系统)
│
└── 时间调整器
    ├── TemporalAdjuster (时间调整器)
    └── TemporalAdjusters (预定义调整器)
</code></pre>
<h2 data-id="heading-5">LocalDate：处理日期</h2>
<h3 data-id="heading-6">LocalDate基础操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.time.*;
<span class="hljs-keyword">import</span> java.time.format.*;
<span class="hljs-keyword">import</span> java.time.temporal.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalDateExample</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== LocalDate 基础操作 ==="</span>);
        
        <span class="hljs-comment">// 1. 创建LocalDate的多种方式</span>
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">today</span> <span class="hljs-operator">=</span> LocalDate.now();
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">specificDate</span> <span class="hljs-operator">=</span> LocalDate.of(<span class="hljs-number">2023</span>, <span class="hljs-number">11</span>, <span class="hljs-number">15</span>);
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">parsedDate</span> <span class="hljs-operator">=</span> LocalDate.parse(<span class="hljs-string">"2023-11-15"</span>);
        
        System.out.println(<span class="hljs-string">"今天: "</span> + today);
        System.out.println(<span class="hljs-string">"指定日期: "</span> + specificDate);
        System.out.println(<span class="hljs-string">"解析日期: "</span> + parsedDate);
        
        <span class="hljs-comment">// 2. 获取日期各部分</span>
        System.out.println(<span class="hljs-string">"\n日期分解:"</span>);
        System.out.println(<span class="hljs-string">"年: "</span> + today.getYear());
        System.out.println(<span class="hljs-string">"月: "</span> + today.getMonth() + <span class="hljs-string">" (数值: "</span> + today.getMonthValue() + <span class="hljs-string">")"</span>);
        System.out.println(<span class="hljs-string">"日: "</span> + today.getDayOfMonth());
        System.out.println(<span class="hljs-string">"星期: "</span> + today.getDayOfWeek());
        System.out.println(<span class="hljs-string">"一年中的第几天: "</span> + today.getDayOfYear());
        
        <span class="hljs-comment">// 3. 日期运算</span>
        System.out.println(<span class="hljs-string">"\n日期运算:"</span>);
        System.out.println(<span class="hljs-string">"明天: "</span> + today.plusDays(<span class="hljs-number">1</span>));
        System.out.println(<span class="hljs-string">"一周后: "</span> + today.plusWeeks(<span class="hljs-number">1</span>));
        System.out.println(<span class="hljs-string">"一月后: "</span> + today.plusMonths(<span class="hljs-number">1</span>));
        System.out.println(<span class="hljs-string">"一年后: "</span> + today.plusYears(<span class="hljs-number">1</span>));
        
        System.out.println(<span class="hljs-string">"昨天: "</span> + today.minusDays(<span class="hljs-number">1</span>));
        System.out.println(<span class="hljs-string">"一周前: "</span> + today.minusWeeks(<span class="hljs-number">1</span>));
        System.out.println(<span class="hljs-string">"一月前: "</span> + today.minusMonths(<span class="hljs-number">1</span>));
        System.out.println(<span class="hljs-string">"一年前: "</span> + today.minusYears(<span class="hljs-number">1</span>));
        
        <span class="hljs-comment">// 4. 日期比较</span>
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">otherDate</span> <span class="hljs-operator">=</span> LocalDate.of(<span class="hljs-number">2023</span>, <span class="hljs-number">12</span>, <span class="hljs-number">25</span>);
        System.out.println(<span class="hljs-string">"\n日期比较:"</span>);
        System.out.println(today + <span class="hljs-string">" 在 "</span> + otherDate + <span class="hljs-string">" 之前? "</span> + today.isBefore(otherDate));
        System.out.println(today + <span class="hljs-string">" 在 "</span> + otherDate + <span class="hljs-string">" 之后? "</span> + today.isAfter(otherDate));
        System.out.println(today + <span class="hljs-string">" 等于 "</span> + otherDate + <span class="hljs-string">"? "</span> + today.isEqual(otherDate));
        
        <span class="hljs-comment">// 5. 特殊日期</span>
        System.out.println(<span class="hljs-string">"\n特殊日期:"</span>);
        System.out.println(<span class="hljs-string">"是否是闰年? "</span> + today.isLeapYear());
        System.out.println(<span class="hljs-string">"当月天数: "</span> + today.lengthOfMonth());
        System.out.println(<span class="hljs-string">"当年天数: "</span> + today.lengthOfYear());
        
        <span class="hljs-comment">// 6. 日期调整</span>
        System.out.println(<span class="hljs-string">"\n日期调整:"</span>);
        System.out.println(<span class="hljs-string">"当月第一天: "</span> + today.with(TemporalAdjusters.firstDayOfMonth()));
        System.out.println(<span class="hljs-string">"当月最后一天: "</span> + today.with(TemporalAdjusters.lastDayOfMonth()));
        System.out.println(<span class="hljs-string">"下个月第一天: "</span> + today.with(TemporalAdjusters.firstDayOfNextMonth()));
        System.out.println(<span class="hljs-string">"下个周一: "</span> + today.with(TemporalAdjusters.next(DayOfWeek.MONDAY)));
        System.out.println(<span class="hljs-string">"当月最后一个周五: "</span> + today.with(TemporalAdjusters.lastInMonth(DayOfWeek.FRIDAY)));
        
        <span class="hljs-comment">// 7. 自定义调整器</span>
        <span class="hljs-type">TemporalAdjuster</span> <span class="hljs-variable">nextWorkingDay</span> <span class="hljs-operator">=</span> TemporalAdjusters.ofDateAdjuster(date -&gt; {
            <span class="hljs-type">DayOfWeek</span> <span class="hljs-variable">dayOfWeek</span> <span class="hljs-operator">=</span> date.getDayOfWeek();
            <span class="hljs-keyword">if</span> (dayOfWeek == DayOfWeek.FRIDAY) {
                <span class="hljs-keyword">return</span> date.plusDays(<span class="hljs-number">3</span>); <span class="hljs-comment">// 周五到下周一</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dayOfWeek == DayOfWeek.SATURDAY) {
                <span class="hljs-keyword">return</span> date.plusDays(<span class="hljs-number">2</span>); <span class="hljs-comment">// 周六到下周一</span>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> date.plusDays(<span class="hljs-number">1</span>); <span class="hljs-comment">// 其他日子到明天</span>
            }
        });
        System.out.println(<span class="hljs-string">"下一个工作日: "</span> + today.with(nextWorkingDay));
    }
    
    <span class="hljs-comment">// 实际应用：计算年龄</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateAge</span><span class="hljs-params">(LocalDate birthDate)</span> {
        <span class="hljs-keyword">return</span> Period.between(birthDate, LocalDate.now()).getYears();
    }
    
    <span class="hljs-comment">// 实际应用：计算工作日</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">calculateWorkingDays</span><span class="hljs-params">(LocalDate start, LocalDate end)</span> {
        <span class="hljs-keyword">return</span> start.datesUntil(end.plusDays(<span class="hljs-number">1</span>))
                   .filter(date -&gt; date.getDayOfWeek() != DayOfWeek.SATURDAY &amp;&amp;
                                  date.getDayOfWeek() != DayOfWeek.SUNDAY)
                   .count();
    }
    
    <span class="hljs-comment">// 实际应用：生成日期范围</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;LocalDate&gt; <span class="hljs-title function_">generateDateRange</span><span class="hljs-params">(LocalDate start, LocalDate end, <span class="hljs-type">int</span> stepDays)</span> {
        List&lt;LocalDate&gt; dates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> start;
        <span class="hljs-keyword">while</span> (!current.isAfter(end)) {
            dates.add(current);
            current = current.plusDays(stepDays);
        }
        <span class="hljs-keyword">return</span> dates;
    }
}
</code></pre>
<h2 data-id="heading-7">LocalTime：处理时间</h2>
<h3 data-id="heading-8">LocalTime基础操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.time.*;
<span class="hljs-keyword">import</span> java.time.temporal.ChronoUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalTimeExample</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== LocalTime 基础操作 ==="</span>);
        
        <span class="hljs-comment">// 1. 创建LocalTime的多种方式</span>
        <span class="hljs-type">LocalTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalTime.now();
        <span class="hljs-type">LocalTime</span> <span class="hljs-variable">specificTime</span> <span class="hljs-operator">=</span> LocalTime.of(<span class="hljs-number">14</span>, <span class="hljs-number">30</span>, <span class="hljs-number">45</span>); <span class="hljs-comment">// 14:30:45</span>
        <span class="hljs-type">LocalTime</span> <span class="hljs-variable">parsedTime</span> <span class="hljs-operator">=</span> LocalTime.parse(<span class="hljs-string">"09:15:30"</span>);
        
        System.out.println(<span class="hljs-string">"现在时间: "</span> + now);
        System.out.println(<span class="hljs-string">"指定时间: "</span> + specificTime);
        System.out.println(<span class="hljs-string">"解析时间: "</span> + parsedTime);
        
        <span class="hljs-comment">// 2. 获取时间各部分</span>
        System.out.println(<span class="hljs-string">"\n时间分解:"</span>);
        System.out.println(<span class="hljs-string">"小时: "</span> + now.getHour());
        System.out.println(<span class="hljs-string">"分钟: "</span> + now.getMinute());
        System.out.println(<span class="hljs-string">"秒: "</span> + now.getSecond());
        System.out.println(<span class="hljs-string">"纳秒: "</span> + now.getNano());
        
        <span class="hljs-comment">// 3. 时间运算</span>
        System.out.println(<span class="hljs-string">"\n时间运算:"</span>);
        System.out.println(<span class="hljs-string">"1小时后: "</span> + now.plusHours(<span class="hljs-number">1</span>));
        System.out.println(<span class="hljs-string">"30分钟后: "</span> + now.plusMinutes(<span class="hljs-number">30</span>));
        System.out.println(<span class="hljs-string">"15秒后: "</span> + now.plusSeconds(<span class="hljs-number">15</span>));
        System.out.println(<span class="hljs-string">"100纳秒后: "</span> + now.plusNanos(<span class="hljs-number">100</span>));
        
        System.out.println(<span class="hljs-string">"2小时前: "</span> + now.minusHours(<span class="hljs-number">2</span>));
        System.out.println(<span class="hljs-string">"45分钟前: "</span> + now.minusMinutes(<span class="hljs-number">45</span>));
        System.out.println(<span class="hljs-string">"30秒前: "</span> + now.minusSeconds(<span class="hljs-number">30</span>));
        
        <span class="hljs-comment">// 使用ChronoUnit进行更灵活的时间运算</span>
        System.out.println(<span class="hljs-string">"半小时后: "</span> + now.plus(<span class="hljs-number">30</span>, ChronoUnit.MINUTES));
        System.out.println(<span class="hljs-string">"三刻钟后: "</span> + now.plus(<span class="hljs-number">3</span>, ChronoUnit.HALF_HOURS));
        
        <span class="hljs-comment">// 4. 时间比较</span>
        <span class="hljs-type">LocalTime</span> <span class="hljs-variable">otherTime</span> <span class="hljs-operator">=</span> LocalTime.of(<span class="hljs-number">18</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        System.out.println(<span class="hljs-string">"\n时间比较:"</span>);
        System.out.println(now + <span class="hljs-string">" 在 "</span> + otherTime + <span class="hljs-string">" 之前? "</span> + now.isBefore(otherTime));
        System.out.println(now + <span class="hljs-string">" 在 "</span> + otherTime + <span class="hljs-string">" 之后? "</span> + now.isAfter(otherTime));
        
        <span class="hljs-comment">// 5. 时间调整</span>
        System.out.println(<span class="hljs-string">"\n时间调整:"</span>);
        System.out.println(<span class="hljs-string">"调整到整点: "</span> + now.withMinute(<span class="hljs-number">0</span>).withSecond(<span class="hljs-number">0</span>).withNano(<span class="hljs-number">0</span>));
        System.out.println(<span class="hljs-string">"调整到下一小时: "</span> + now.withHour((now.getHour() + <span class="hljs-number">1</span>) % <span class="hljs-number">24</span>));
        
        <span class="hljs-comment">// 6. 获取最大/最小时间</span>
        System.out.println(<span class="hljs-string">"\n特殊时间:"</span>);
        System.out.println(<span class="hljs-string">"最小时间: "</span> + LocalTime.MIN);
        System.out.println(<span class="hljs-string">"最大时间: "</span> + LocalTime.MAX);
        System.out.println(<span class="hljs-string">"午夜: "</span> + LocalTime.MIDNIGHT);
        System.out.println(<span class="hljs-string">"中午: "</span> + LocalTime.NOON);
        
        <span class="hljs-comment">// 7. 时间范围检查</span>
        System.out.println(<span class="hljs-string">"\n时间范围检查:"</span>);
        <span class="hljs-type">LocalTime</span> <span class="hljs-variable">startWork</span> <span class="hljs-operator">=</span> LocalTime.of(<span class="hljs-number">9</span>, <span class="hljs-number">0</span>);
        <span class="hljs-type">LocalTime</span> <span class="hljs-variable">endWork</span> <span class="hljs-operator">=</span> LocalTime.of(<span class="hljs-number">18</span>, <span class="hljs-number">0</span>);
        System.out.println(now + <span class="hljs-string">" 是否在工作时间内? "</span> + 
                          (now.isAfter(startWork) &amp;&amp; now.isBefore(endWork)));
        
        <span class="hljs-comment">// 8. 时间差计算</span>
        <span class="hljs-type">LocalTime</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> LocalTime.of(<span class="hljs-number">9</span>, <span class="hljs-number">0</span>);
        <span class="hljs-type">LocalTime</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> LocalTime.of(<span class="hljs-number">17</span>, <span class="hljs-number">30</span>);
        System.out.println(<span class="hljs-string">"\n时间差计算:"</span>);
        <span class="hljs-type">long</span> <span class="hljs-variable">hoursBetween</span> <span class="hljs-operator">=</span> ChronoUnit.HOURS.between(start, end);
        <span class="hljs-type">long</span> <span class="hljs-variable">minutesBetween</span> <span class="hljs-operator">=</span> ChronoUnit.MINUTES.between(start, end);
        System.out.println(start + <span class="hljs-string">" 到 "</span> + end + <span class="hljs-string">" 相差 "</span> + hoursBetween + <span class="hljs-string">" 小时"</span>);
        System.out.println(start + <span class="hljs-string">" 到 "</span> + end + <span class="hljs-string">" 相差 "</span> + minutesBetween + <span class="hljs-string">" 分钟"</span>);
    }
    
    <span class="hljs-comment">// 实际应用：计算会议持续时间</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Duration <span class="hljs-title function_">calculateMeetingDuration</span><span class="hljs-params">(LocalTime startTime, LocalTime endTime)</span> {
        <span class="hljs-keyword">return</span> Duration.between(startTime, endTime);
    }
    
    <span class="hljs-comment">// 实际应用：检查是否在营业时间</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBusinessHour</span><span class="hljs-params">(LocalTime time, LocalTime open, LocalTime close)</span> {
        <span class="hljs-keyword">return</span> !time.isBefore(open) &amp;&amp; !time.isAfter(close);
    }
    
    <span class="hljs-comment">// 实际应用：生成时间表</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;LocalTime&gt; <span class="hljs-title function_">generateTimeSchedule</span><span class="hljs-params">(LocalTime start, <span class="hljs-type">int</span> intervalMinutes, <span class="hljs-type">int</span> count)</span> {
        List&lt;LocalTime&gt; schedule = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-type">LocalTime</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> start;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) {
            schedule.add(current);
            current = current.plusMinutes(intervalMinutes);
        }
        <span class="hljs-keyword">return</span> schedule;
    }
}
</code></pre>
<h2 data-id="heading-9">LocalDateTime：日期时间组合</h2>
<h3 data-id="heading-10">LocalDateTime基础操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.time.*;
<span class="hljs-keyword">import</span> java.time.format.*;
<span class="hljs-keyword">import</span> java.time.temporal.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalDateTimeExample</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== LocalDateTime 基础操作 ==="</span>);
        
        <span class="hljs-comment">// 1. 创建LocalDateTime的多种方式</span>
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">specificDateTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(<span class="hljs-number">2023</span>, <span class="hljs-number">11</span>, <span class="hljs-number">15</span>, <span class="hljs-number">14</span>, <span class="hljs-number">30</span>, <span class="hljs-number">45</span>);
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">parsedDateTime</span> <span class="hljs-operator">=</span> LocalDateTime.parse(<span class="hljs-string">"2023-11-15T14:30:45"</span>);
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">fromDateAndTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(LocalDate.now(), LocalTime.now());
        
        System.out.println(<span class="hljs-string">"现在: "</span> + now);
        System.out.println(<span class="hljs-string">"指定日期时间: "</span> + specificDateTime);
        System.out.println(<span class="hljs-string">"解析日期时间: "</span> + parsedDateTime);
        System.out.println(<span class="hljs-string">"从日期和时间组合: "</span> + fromDateAndTime);
        
        <span class="hljs-comment">// 2. 转换操作</span>
        System.out.println(<span class="hljs-string">"\n转换操作:"</span>);
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">datePart</span> <span class="hljs-operator">=</span> now.toLocalDate();
        <span class="hljs-type">LocalTime</span> <span class="hljs-variable">timePart</span> <span class="hljs-operator">=</span> now.toLocalTime();
        System.out.println(<span class="hljs-string">"日期部分: "</span> + datePart);
        System.out.println(<span class="hljs-string">"时间部分: "</span> + timePart);
        
        <span class="hljs-comment">// 3. 日期时间运算</span>
        System.out.println(<span class="hljs-string">"\n日期时间运算:"</span>);
        System.out.println(<span class="hljs-string">"3天后: "</span> + now.plusDays(<span class="hljs-number">3</span>));
        System.out.println(<span class="hljs-string">"2周后: "</span> + now.plusWeeks(<span class="hljs-number">2</span>));
        System.out.println(<span class="hljs-string">"6个月后: "</span> + now.plusMonths(<span class="hljs-number">6</span>));
        System.out.println(<span class="hljs-string">"1年2个月3天后: "</span> + now.plusYears(<span class="hljs-number">1</span>).plusMonths(<span class="hljs-number">2</span>).plusDays(<span class="hljs-number">3</span>));
        
        System.out.println(<span class="hljs-string">"5小时前: "</span> + now.minusHours(<span class="hljs-number">5</span>));
        System.out.println(<span class="hljs-string">"30分钟前: "</span> + now.minusMinutes(<span class="hljs-number">30</span>));
        
        <span class="hljs-comment">// 4. 日期时间比较</span>
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">futureDateTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(<span class="hljs-number">2024</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        System.out.println(<span class="hljs-string">"\n日期时间比较:"</span>);
        System.out.println(now + <span class="hljs-string">" 在 "</span> + futureDateTime + <span class="hljs-string">" 之前? "</span> + now.isBefore(futureDateTime));
        System.out.println(now + <span class="hljs-string">" 在 "</span> + futureDateTime + <span class="hljs-string">" 之后? "</span> + now.isAfter(futureDateTime));
        
        <span class="hljs-comment">// 5. 日期时间调整</span>
        System.out.println(<span class="hljs-string">"\n日期时间调整:"</span>);
        System.out.println(<span class="hljs-string">"调整到当月第一天: "</span> + now.with(TemporalAdjusters.firstDayOfMonth()));
        System.out.println(<span class="hljs-string">"调整到下个周一上午9点: "</span> + 
            now.with(TemporalAdjusters.next(DayOfWeek.MONDAY)).withHour(<span class="hljs-number">9</span>).withMinute(<span class="hljs-number">0</span>));
        
        <span class="hljs-comment">// 6. 格式化与解析</span>
        System.out.println(<span class="hljs-string">"\n格式化与解析:"</span>);
        <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy年MM月dd日 HH:mm:ss"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">formatted</span> <span class="hljs-operator">=</span> now.format(formatter);
        System.out.println(<span class="hljs-string">"格式化后: "</span> + formatted);
        
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">parsed</span> <span class="hljs-operator">=</span> LocalDateTime.parse(<span class="hljs-string">"2023年11月15日 14:30:00"</span>, formatter);
        System.out.println(<span class="hljs-string">"解析后: "</span> + parsed);
        
        <span class="hljs-comment">// 7. 自定义格式化器</span>
        System.out.println(<span class="hljs-string">"\n自定义格式化:"</span>);
        <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">customFormatter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTimeFormatterBuilder</span>()
            .appendPattern(<span class="hljs-string">"yyyy/MM/dd"</span>)
            .appendLiteral(<span class="hljs-string">" "</span>)
            .appendPattern(<span class="hljs-string">"HH:mm"</span>)
            .toFormatter();
        
        System.out.println(<span class="hljs-string">"自定义格式: "</span> + now.format(customFormatter));
        
        <span class="hljs-comment">// 8. 与时间戳的转换</span>
        System.out.println(<span class="hljs-string">"\n与时间戳转换:"</span>);
        <span class="hljs-type">Instant</span> <span class="hljs-variable">instant</span> <span class="hljs-operator">=</span> now.atZone(ZoneId.systemDefault()).toInstant();
        <span class="hljs-type">long</span> <span class="hljs-variable">epochMilli</span> <span class="hljs-operator">=</span> instant.toEpochMilli();
        System.out.println(<span class="hljs-string">"时间戳: "</span> + epochMilli);
        
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">fromTimestamp</span> <span class="hljs-operator">=</span> LocalDateTime.ofInstant(
            Instant.ofEpochMilli(epochMilli), 
            ZoneId.systemDefault()
        );
        System.out.println(<span class="hljs-string">"从时间戳恢复: "</span> + fromTimestamp);
    }
    
    <span class="hljs-comment">// 实际应用：计算项目截止日期</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> LocalDateTime <span class="hljs-title function_">calculateDeadline</span><span class="hljs-params">(LocalDateTime startDate, <span class="hljs-type">int</span> workingDays)</span> {
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">deadline</span> <span class="hljs-operator">=</span> startDate;
        <span class="hljs-type">int</span> <span class="hljs-variable">daysAdded</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">while</span> (daysAdded &lt; workingDays) {
            deadline = deadline.plusDays(<span class="hljs-number">1</span>);
            <span class="hljs-type">DayOfWeek</span> <span class="hljs-variable">dayOfWeek</span> <span class="hljs-operator">=</span> deadline.getDayOfWeek();
            <span class="hljs-keyword">if</span> (dayOfWeek != DayOfWeek.SATURDAY &amp;&amp; dayOfWeek != DayOfWeek.SUNDAY) {
                daysAdded++;
            }
        }
        <span class="hljs-keyword">return</span> deadline;
    }
    
    <span class="hljs-comment">// 实际应用：检查是否在维护窗口</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isInMaintenanceWindow</span><span class="hljs-params">(LocalDateTime dateTime)</span> {
        <span class="hljs-type">LocalTime</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> LocalTime.of(<span class="hljs-number">2</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// 凌晨2点</span>
        <span class="hljs-type">LocalTime</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> LocalTime.of(<span class="hljs-number">4</span>, <span class="hljs-number">0</span>);   <span class="hljs-comment">// 凌晨4点</span>
        <span class="hljs-type">DayOfWeek</span> <span class="hljs-variable">day</span> <span class="hljs-operator">=</span> dateTime.getDayOfWeek();
        
        <span class="hljs-comment">// 假设每周日2-4点维护</span>
        <span class="hljs-keyword">return</span> day == DayOfWeek.SUNDAY &amp;&amp; 
               !dateTime.toLocalTime().isBefore(start) &amp;&amp; 
               dateTime.toLocalTime().isBefore(end);
    }
    
    <span class="hljs-comment">// 实际应用：生成时间轴</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;LocalDateTime, String&gt; <span class="hljs-title function_">generateTimeline</span><span class="hljs-params">(LocalDateTime start, <span class="hljs-type">int</span> intervalHours, <span class="hljs-type">int</span> count)</span> {
        Map&lt;LocalDateTime, String&gt; timeline = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> start;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) {
            timeline.put(current, <span class="hljs-string">"事件 "</span> + (i + <span class="hljs-number">1</span>));
            current = current.plusHours(intervalHours);
        }
        
        <span class="hljs-keyword">return</span> timeline;
    }
}
</code></pre>
<h2 data-id="heading-11">时区处理：ZonedDateTime和OffsetDateTime</h2>
<h3 data-id="heading-12">时区处理实战</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.time.*;
<span class="hljs-keyword">import</span> java.time.format.*;
<span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimeZoneExample</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 时区处理实战 ==="</span>);
        
        <span class="hljs-comment">// 1. 时区基础</span>
        System.out.println(<span class="hljs-string">"\n1. 时区基础:"</span>);
        Set&lt;String&gt; allZoneIds = ZoneId.getAvailableZoneIds();
        System.out.println(<span class="hljs-string">"可用时区数量: "</span> + allZoneIds.size());
        System.out.println(<span class="hljs-string">"前10个时区:"</span>);
        allZoneIds.stream().sorted().limit(<span class="hljs-number">10</span>).forEach(System.out::println);
        
        <span class="hljs-comment">// 2. 创建带时区的时间</span>
        System.out.println(<span class="hljs-string">"\n2. 创建带时区的时间:"</span>);
        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">nowInTokyo</span> <span class="hljs-operator">=</span> ZonedDateTime.now(ZoneId.of(<span class="hljs-string">"Asia/Tokyo"</span>));
        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">nowInNewYork</span> <span class="hljs-operator">=</span> ZonedDateTime.now(ZoneId.of(<span class="hljs-string">"America/New_York"</span>));
        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">nowInLondon</span> <span class="hljs-operator">=</span> ZonedDateTime.now(ZoneId.of(<span class="hljs-string">"Europe/London"</span>));
        
        System.out.println(<span class="hljs-string">"东京时间: "</span> + nowInTokyo);
        System.out.println(<span class="hljs-string">"纽约时间: "</span> + nowInNewYork);
        System.out.println(<span class="hljs-string">"伦敦时间: "</span> + nowInLondon);
        
        <span class="hljs-comment">// 3. 时区转换</span>
        System.out.println(<span class="hljs-string">"\n3. 时区转换:"</span>);
        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">tokyoTime</span> <span class="hljs-operator">=</span> ZonedDateTime.of(
            LocalDateTime.of(<span class="hljs-number">2023</span>, <span class="hljs-number">11</span>, <span class="hljs-number">15</span>, <span class="hljs-number">14</span>, <span class="hljs-number">30</span>),
            ZoneId.of(<span class="hljs-string">"Asia/Tokyo"</span>)
        );
        
        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">newYorkTime</span> <span class="hljs-operator">=</span> tokyoTime.withZoneSameInstant(ZoneId.of(<span class="hljs-string">"America/New_York"</span>));
        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">londonTime</span> <span class="hljs-operator">=</span> tokyoTime.withZoneSameInstant(ZoneId.of(<span class="hljs-string">"Europe/London"</span>));
        
        System.out.println(<span class="hljs-string">"东京 14:30 相当于:"</span>);
        System.out.println(<span class="hljs-string">"  纽约: "</span> + newYorkTime.toLocalDateTime() + <span class="hljs-string">" ("</span> + newYorkTime.getZone() + <span class="hljs-string">")"</span>);
        System.out.println(<span class="hljs-string">"  伦敦: "</span> + londonTime.toLocalDateTime() + <span class="hljs-string">" ("</span> + londonTime.getZone() + <span class="hljs-string">")"</span>);
        
        <span class="hljs-comment">// 4. 夏令时处理</span>
        System.out.println(<span class="hljs-string">"\n4. 夏令时测试:"</span>);
        testDaylightSavingTime();
        
        <span class="hljs-comment">// 5. OffsetDateTime（固定时区偏移）</span>
        System.out.println(<span class="hljs-string">"\n5. OffsetDateTime:"</span>);
        <span class="hljs-type">OffsetDateTime</span> <span class="hljs-variable">offsetDateTime</span> <span class="hljs-operator">=</span> OffsetDateTime.now(ZoneOffset.ofHours(<span class="hljs-number">8</span>));
        System.out.println(<span class="hljs-string">"UTC+8时间: "</span> + offsetDateTime);
        
        <span class="hljs-comment">// 6. 时区偏移计算</span>
        System.out.println(<span class="hljs-string">"\n6. 时区偏移计算:"</span>);
        <span class="hljs-type">ZoneId</span> <span class="hljs-variable">tokyoZone</span> <span class="hljs-operator">=</span> ZoneId.of(<span class="hljs-string">"Asia/Tokyo"</span>);
        <span class="hljs-type">ZoneId</span> <span class="hljs-variable">newYorkZone</span> <span class="hljs-operator">=</span> ZoneId.of(<span class="hljs-string">"America/New_York"</span>);
        
        <span class="hljs-type">Instant</span> <span class="hljs-variable">instant</span> <span class="hljs-operator">=</span> Instant.now();
        <span class="hljs-type">ZoneOffset</span> <span class="hljs-variable">tokyoOffset</span> <span class="hljs-operator">=</span> tokyoZone.getRules().getOffset(instant);
        <span class="hljs-type">ZoneOffset</span> <span class="hljs-variable">newYorkOffset</span> <span class="hljs-operator">=</span> newYorkZone.getRules().getOffset(instant);
        
        System.out.println(<span class="hljs-string">"东京时区偏移: "</span> + tokyoOffset);
        System.out.println(<span class="hljs-string">"纽约时区偏移: "</span> + newYorkOffset);
        System.out.println(<span class="hljs-string">"时差: "</span> + 
            Duration.between(
                instant.atOffset(tokyoOffset).toLocalTime(),
                instant.atOffset(newYorkOffset).toLocalTime()
            ).toHours() + <span class="hljs-string">" 小时"</span>
        );
        
        <span class="hljs-comment">// 7. 实际应用：全球会议时间</span>
        System.out.println(<span class="hljs-string">"\n7. 实际应用：全球会议时间安排:"</span>);
        scheduleGlobalMeeting();
    }
    
    <span class="hljs-comment">// 测试夏令时</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDaylightSavingTime</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ZoneId</span> <span class="hljs-variable">nyZone</span> <span class="hljs-operator">=</span> ZoneId.of(<span class="hljs-string">"America/New_York"</span>);
        
        <span class="hljs-comment">// 纽约2023年夏令时开始于3月12日</span>
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">beforeDST</span> <span class="hljs-operator">=</span> LocalDateTime.of(<span class="hljs-number">2023</span>, <span class="hljs-number">3</span>, <span class="hljs-number">12</span>, <span class="hljs-number">1</span>, <span class="hljs-number">30</span>);
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">afterDST</span> <span class="hljs-operator">=</span> LocalDateTime.of(<span class="hljs-number">2023</span>, <span class="hljs-number">3</span>, <span class="hljs-number">12</span>, <span class="hljs-number">3</span>, <span class="hljs-number">30</span>);
        
        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">zonedBefore</span> <span class="hljs-operator">=</span> ZonedDateTime.of(beforeDST, nyZone);
        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">zonedAfter</span> <span class="hljs-operator">=</span> ZonedDateTime.of(afterDST, nyZone);
        
        System.out.println(<span class="hljs-string">"夏令时变化前: "</span> + zonedBefore);
        System.out.println(<span class="hljs-string">"夏令时变化后: "</span> + zonedAfter);
        System.out.println(<span class="hljs-string">"是否在夏令时中: "</span> + zonedAfter.getZone().getRules().isDaylightSavings(zonedAfter.toInstant()));
        
        <span class="hljs-comment">// 检查转换</span>
        System.out.println(<span class="hljs-string">"\n验证转换:"</span>);
        System.out.println(<span class="hljs-string">"转换到伦敦时间:"</span>);
        System.out.println(<span class="hljs-string">"  前: "</span> + zonedBefore.withZoneSameInstant(ZoneId.of(<span class="hljs-string">"Europe/London"</span>)));
        System.out.println(<span class="hljs-string">"  后: "</span> + zonedAfter.withZoneSameInstant(ZoneId.of(<span class="hljs-string">"Europe/London"</span>)));
    }
    
    <span class="hljs-comment">// 安排全球会议</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleGlobalMeeting</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"=== 全球会议安排 ==="</span>);
        
        <span class="hljs-comment">// 假设会议在旧金山时间上午9点</span>
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">meetingTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(<span class="hljs-number">2023</span>, <span class="hljs-number">11</span>, <span class="hljs-number">15</span>, <span class="hljs-number">9</span>, <span class="hljs-number">0</span>);
        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">meetingSF</span> <span class="hljs-operator">=</span> ZonedDateTime.of(meetingTime, ZoneId.of(<span class="hljs-string">"America/Los_Angeles"</span>));
        
        System.out.println(<span class="hljs-string">"会议时间（旧金山）: "</span> + meetingSF);
        
        <span class="hljs-comment">// 转换到其他城市</span>
        String[] cities = {
            <span class="hljs-string">"Asia/Shanghai"</span>,      <span class="hljs-comment">// 上海</span>
            <span class="hljs-string">"Asia/Tokyo"</span>,         <span class="hljs-comment">// 东京</span>
            <span class="hljs-string">"Europe/London"</span>,      <span class="hljs-comment">// 伦敦</span>
            <span class="hljs-string">"Europe/Paris"</span>,       <span class="hljs-comment">// 巴黎</span>
            <span class="hljs-string">"America/New_York"</span>,   <span class="hljs-comment">// 纽约</span>
            <span class="hljs-string">"Australia/Sydney"</span>    <span class="hljs-comment">// 悉尼</span>
        };
        
        System.out.println(<span class="hljs-string">"\n各城市会议时间:"</span>);
        <span class="hljs-keyword">for</span> (String city : cities) {
            <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">cityTime</span> <span class="hljs-operator">=</span> meetingSF.withZoneSameInstant(ZoneId.of(city));
            System.out.printf(<span class="hljs-string">"%-20s: %s%n"</span>, 
                city.split(<span class="hljs-string">"/"</span>)[<span class="hljs-number">1</span>], 
                cityTime.format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm (zzz)"</span>))
            );
        }
    }
    
    <span class="hljs-comment">// 计算飞行时间（考虑时区）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Duration <span class="hljs-title function_">calculateFlightDuration</span><span class="hljs-params">(ZonedDateTime departure, ZonedDateTime arrival)</span> {
        <span class="hljs-keyword">return</span> Duration.between(departure, arrival);
    }
    
    <span class="hljs-comment">// 检查是否在营业时间内（考虑时区）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBusinessHourGlobal</span><span class="hljs-params">(ZonedDateTime time, ZoneId businessZone, 
                                              LocalTime open, LocalTime close)</span> {
        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">businessZoneTime</span> <span class="hljs-operator">=</span> time.withZoneSameInstant(businessZone);
        <span class="hljs-type">LocalTime</span> <span class="hljs-variable">localTime</span> <span class="hljs-operator">=</span> businessZoneTime.toLocalTime();
        
        <span class="hljs-keyword">return</span> !localTime.isBefore(open) &amp;&amp; !localTime.isAfter(close);
    }
}
</code></pre>
<h2 data-id="heading-13">Instant和Duration：时间点与时间段</h2>
<h3 data-id="heading-14">Instant和Duration实战</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.time.*;
<span class="hljs-keyword">import</span> java.time.temporal.*;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InstantDurationExample</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"=== Instant 和 Duration 实战 ==="</span>);
        
        <span class="hljs-comment">// 1. Instant：时间点（时间戳）</span>
        System.out.println(<span class="hljs-string">"\n1. Instant - 时间点:"</span>);
        
        <span class="hljs-type">Instant</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> Instant.now();
        <span class="hljs-type">Instant</span> <span class="hljs-variable">specificInstant</span> <span class="hljs-operator">=</span> Instant.ofEpochMilli(<span class="hljs-number">1699999999999L</span>);
        <span class="hljs-type">Instant</span> <span class="hljs-variable">parsedInstant</span> <span class="hljs-operator">=</span> Instant.parse(<span class="hljs-string">"2023-11-15T14:30:45.123Z"</span>);
        
        System.out.println(<span class="hljs-string">"当前时刻: "</span> + now);
        System.out.println(<span class="hljs-string">"指定时间戳: "</span> + specificInstant);
        System.out.println(<span class="hljs-string">"解析的ISO格式: "</span> + parsedInstant);
        
        <span class="hljs-comment">// 获取时间戳</span>
        System.out.println(<span class="hljs-string">"\n时间戳获取:"</span>);
        System.out.println(<span class="hljs-string">"毫秒时间戳: "</span> + now.toEpochMilli());
        System.out.println(<span class="hljs-string">"秒时间戳: "</span> + now.getEpochSecond());
        System.out.println(<span class="hljs-string">"纳秒部分: "</span> + now.getNano());
        
        <span class="hljs-comment">// 2. Instant运算</span>
        System.out.println(<span class="hljs-string">"\n2. Instant运算:"</span>);
        System.out.println(<span class="hljs-string">"1小时后: "</span> + now.plus(<span class="hljs-number">1</span>, ChronoUnit.HOURS));
        System.out.println(<span class="hljs-string">"30分钟后: "</span> + now.plus(<span class="hljs-number">30</span>, ChronoUnit.MINUTES));
        System.out.println(<span class="hljs-string">"1天前: "</span> + now.minus(<span class="hljs-number">1</span>, ChronoUnit.DAYS));
        System.out.println(<span class="hljs-string">"500毫秒前: "</span> + now.minus(<span class="hljs-number">500</span>, ChronoUnit.MILLIS));
        
        <span class="hljs-comment">// 3. Duration：时间段（基于时间）</span>
        System.out.println(<span class="hljs-string">"\n3. Duration - 时间段:"</span>);
        
        <span class="hljs-type">Duration</span> <span class="hljs-variable">oneHour</span> <span class="hljs-operator">=</span> Duration.ofHours(<span class="hljs-number">1</span>);
        <span class="hljs-type">Duration</span> <span class="hljs-variable">thirtyMinutes</span> <span class="hljs-operator">=</span> Duration.ofMinutes(<span class="hljs-number">30</span>);
        <span class="hljs-type">Duration</span> <span class="hljs-variable">customDuration</span> <span class="hljs-operator">=</span> Duration.of(<span class="hljs-number">90</span>, ChronoUnit.SECONDS);
        <span class="hljs-type">Duration</span> <span class="hljs-variable">parsedDuration</span> <span class="hljs-operator">=</span> Duration.parse(<span class="hljs-string">"PT1H30M"</span>); <span class="hljs-comment">// ISO-8601格式</span>
        
        System.out.println(<span class="hljs-string">"1小时: "</span> + oneHour);
        System.out.println(<span class="hljs-string">"30分钟: "</span> + thirtyMinutes);
        System.out.println(<span class="hljs-string">"90秒: "</span> + customDuration);
        System.out.println(<span class="hljs-string">"解析1小时30分钟: "</span> + parsedDuration);
        
        <span class="hljs-comment">// 4. Duration运算</span>
        System.out.println(<span class="hljs-string">"\n4. Duration运算:"</span>);
        System.out.println(<span class="hljs-string">"1小时 + 30分钟 = "</span> + oneHour.plus(thirtyMinutes));
        System.out.println(<span class="hljs-string">"2小时 - 30分钟 = "</span> + Duration.ofHours(<span class="hljs-number">2</span>).minus(thirtyMinutes));
        System.out.println(<span class="hljs-string">"30分钟 × 2 = "</span> + thirtyMinutes.multipliedBy(<span class="hljs-number">2</span>));
        System.out.println(<span class="hljs-string">"1小时 ÷ 2 = "</span> + oneHour.dividedBy(<span class="hljs-number">2</span>));
        
        <span class="hljs-comment">// 5. 获取Duration各部分</span>
        System.out.println(<span class="hljs-string">"\n5. Duration分解:"</span>);
        <span class="hljs-type">Duration</span> <span class="hljs-variable">complexDuration</span> <span class="hljs-operator">=</span> Duration.ofHours(<span class="hljs-number">25</span>).plusMinutes(<span class="hljs-number">90</span>);
        System.out.println(<span class="hljs-string">"25小时90分钟分解:"</span>);
        System.out.println(<span class="hljs-string">"  总天数: "</span> + complexDuration.toDays());
        System.out.println(<span class="hljs-string">"  总小时数: "</span> + complexDuration.toHours());
        System.out.println(<span class="hljs-string">"  总分钟数: "</span> + complexDuration.toMinutes());
        System.out.println(<span class="hljs-string">"  总秒数: "</span> + complexDuration.toSeconds());
        System.out.println(<span class="hljs-string">"  总毫秒数: "</span> + complexDuration.toMillis());
        System.out.println(<span class="hljs-string">"  总纳秒数: "</span> + complexDuration.toNanos());
        
        System.out.println(<span class="hljs-string">"\n各部分:"</span>);
        System.out.println(<span class="hljs-string">"  小时部分: "</span> + complexDuration.toHoursPart());
        System.out.println(<span class="hljs-string">"  分钟部分: "</span> + complexDuration.toMinutesPart());
        System.out.println(<span class="hljs-string">"  秒部分: "</span> + complexDuration.toSecondsPart());
        
        <span class="hljs-comment">// 6. Period：时间段（基于日期）</span>
        System.out.println(<span class="hljs-string">"\n6. Period - 基于日期的时间段:"</span>);
        
        <span class="hljs-type">Period</span> <span class="hljs-variable">oneYear</span> <span class="hljs-operator">=</span> Period.ofYears(<span class="hljs-number">1</span>);
        <span class="hljs-type">Period</span> <span class="hljs-variable">sixMonths</span> <span class="hljs-operator">=</span> Period.ofMonths(<span class="hljs-number">6</span>);
        <span class="hljs-type">Period</span> <span class="hljs-variable">complexPeriod</span> <span class="hljs-operator">=</span> Period.of(<span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">15</span>); <span class="hljs-comment">// 1年6个月15天</span>
        <span class="hljs-type">Period</span> <span class="hljs-variable">parsedPeriod</span> <span class="hljs-operator">=</span> Period.parse(<span class="hljs-string">"P1Y6M15D"</span>); <span class="hljs-comment">// ISO-8601格式</span>
        
        System.out.println(<span class="hljs-string">"1年: "</span> + oneYear);
        System.out.println(<span class="hljs-string">"6个月: "</span> + sixMonths);
        System.out.println(<span class="hljs-string">"1年6个月15天: "</span> + complexPeriod);
        System.out.println(<span class="hljs-string">"解析的Period: "</span> + parsedPeriod);
        
        <span class="hljs-comment">// 7. 实际应用：计算两个日期之间的时间段</span>
        System.out.println(<span class="hljs-string">"\n7. 实际应用：计算时间段:"</span>);
        
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">birthDate</span> <span class="hljs-operator">=</span> LocalDate.of(<span class="hljs-number">1990</span>, <span class="hljs-number">5</span>, <span class="hljs-number">15</span>);
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">today</span> <span class="hljs-operator">=</span> LocalDate.now();
        
        <span class="hljs-type">Period</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> Period.between(birthDate, today);
        System.out.println(<span class="hljs-string">"年龄: "</span> + age.getYears() + <span class="hljs-string">"年 "</span> + 
                         age.getMonths() + <span class="hljs-string">"个月 "</span> + 
                         age.getDays() + <span class="hljs-string">"天"</span>);
        
        <span class="hljs-comment">// 8. 实际应用：性能测量</span>
        System.out.println(<span class="hljs-string">"\n8. 性能测量示例:"</span>);
        measurePerformance();
        
        <span class="hljs-comment">// 9. 实际应用：超时控制</span>
        System.out.println(<span class="hljs-string">"\n9. 超时控制示例:"</span>);
        timeoutControl();
    }
    
    <span class="hljs-comment">// 性能测量</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">measurePerformance</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Instant</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> Instant.now();
        
        <span class="hljs-comment">// 模拟耗时操作</span>
        <span class="hljs-keyword">try</span> {
            TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">1500</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-type">Instant</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> Instant.now();
        <span class="hljs-type">Duration</span> <span class="hljs-variable">elapsed</span> <span class="hljs-operator">=</span> Duration.between(start, end);
        
        System.out.println(<span class="hljs-string">"操作耗时: "</span> + elapsed.toMillis() + <span class="hljs-string">" 毫秒"</span>);
        System.out.println(<span class="hljs-string">"操作耗时: "</span> + elapsed.getSeconds() + <span class="hljs-string">" 秒 "</span> + 
                         elapsed.toMillisPart() + <span class="hljs-string">" 毫秒"</span>);
        
        <span class="hljs-comment">// 格式化输出</span>
        <span class="hljs-keyword">if</span> (elapsed.toMinutes() &gt; <span class="hljs-number">0</span>) {
            System.out.printf(<span class="hljs-string">"格式化: %d分 %d秒 %d毫秒%n"</span>,
                elapsed.toMinutes(),
                elapsed.toSecondsPart(),
                elapsed.toMillisPart());
        } <span class="hljs-keyword">else</span> {
            System.out.printf(<span class="hljs-string">"格式化: %d秒 %d毫秒%n"</span>,
                elapsed.toSeconds(),
                elapsed.toMillisPart());
        }
    }
    
    <span class="hljs-comment">// 超时控制</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">timeoutControl</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Duration</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> Duration.ofSeconds(<span class="hljs-number">3</span>);
        <span class="hljs-type">Instant</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> Instant.now();
        
        System.out.println(<span class="hljs-string">"开始执行，超时时间: "</span> + timeout.getSeconds() + <span class="hljs-string">"秒"</span>);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 模拟长时间操作</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">10</span>; i++) {
                <span class="hljs-comment">// 检查是否超时</span>
                <span class="hljs-type">Duration</span> <span class="hljs-variable">elapsed</span> <span class="hljs-operator">=</span> Duration.between(startTime, Instant.now());
                <span class="hljs-keyword">if</span> (elapsed.compareTo(timeout) &gt; <span class="hljs-number">0</span>) {
                    System.out.println(<span class="hljs-string">"操作超时！"</span>);
                    <span class="hljs-keyword">break</span>;
                }
                
                System.out.println(<span class="hljs-string">"第 "</span> + i + <span class="hljs-string">" 步"</span>);
                TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">500</span>);
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-type">Duration</span> <span class="hljs-variable">totalTime</span> <span class="hljs-operator">=</span> Duration.between(startTime, Instant.now());
        System.out.println(<span class="hljs-string">"总耗时: "</span> + totalTime.toMillis() + <span class="hljs-string">"毫秒"</span>);
    }
    
    <span class="hljs-comment">// 计算两个时刻之间的精确时间段</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">formatDurationBetween</span><span class="hljs-params">(Instant start, Instant end)</span> {
        <span class="hljs-type">Duration</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> Duration.between(start, end);
        
        <span class="hljs-type">long</span> <span class="hljs-variable">days</span> <span class="hljs-operator">=</span> duration.toDays();
        <span class="hljs-type">long</span> <span class="hljs-variable">hours</span> <span class="hljs-operator">=</span> duration.toHoursPart();
        <span class="hljs-type">long</span> <span class="hljs-variable">minutes</span> <span class="hljs-operator">=</span> duration.toMinutesPart();
        <span class="hljs-type">long</span> <span class="hljs-variable">seconds</span> <span class="hljs-operator">=</span> duration.toSecondsPart();
        <span class="hljs-type">long</span> <span class="hljs-variable">millis</span> <span class="hljs-operator">=</span> duration.toMillisPart();
        
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-keyword">if</span> (days &gt; <span class="hljs-number">0</span>) sb.append(days).append(<span class="hljs-string">"天 "</span>);
        <span class="hljs-keyword">if</span> (hours &gt; <span class="hljs-number">0</span> || days &gt; <span class="hljs-number">0</span>) sb.append(hours).append(<span class="hljs-string">"小时 "</span>);
        <span class="hljs-keyword">if</span> (minutes &gt; <span class="hljs-number">0</span> || hours &gt; <span class="hljs-number">0</span> || days &gt; <span class="hljs-number">0</span>) sb.append(minutes).append(<span class="hljs-string">"分 "</span>);
        sb.append(seconds).append(<span class="hljs-string">"秒 "</span>);
        sb.append(millis).append(<span class="hljs-string">"毫秒"</span>);
        
        <span class="hljs-keyword">return</span> sb.toString();
    }
    
    <span class="hljs-comment">// 计算工作日的持续时间</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Duration <span class="hljs-title function_">calculateWorkingDuration</span><span class="hljs-params">(LocalDateTime start, LocalDateTime end)</span> {
        <span class="hljs-type">Duration</span> <span class="hljs-variable">totalDuration</span> <span class="hljs-operator">=</span> Duration.between(start, end);
        
        <span class="hljs-comment">// 计算包含的周末天数</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">weekendDays</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">currentDate</span> <span class="hljs-operator">=</span> start.toLocalDate();
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">endDate</span> <span class="hljs-operator">=</span> end.toLocalDate();
        
        <span class="hljs-keyword">while</span> (!currentDate.isAfter(endDate)) {
            <span class="hljs-type">DayOfWeek</span> <span class="hljs-variable">dayOfWeek</span> <span class="hljs-operator">=</span> currentDate.getDayOfWeek();
            <span class="hljs-keyword">if</span> (dayOfWeek == DayOfWeek.SATURDAY || dayOfWeek == DayOfWeek.SUNDAY) {
                weekendDays++;
            }
            currentDate = currentDate.plusDays(<span class="hljs-number">1</span>);
        }
        
        <span class="hljs-comment">// 减去周末的时间</span>
        <span class="hljs-type">Duration</span> <span class="hljs-variable">weekendDuration</span> <span class="hljs-operator">=</span> Duration.ofDays(weekendDays);
        <span class="hljs-keyword">return</span> totalDuration.minus(weekendDuration);
    }
}
</code></pre>
<h2 data-id="heading-15">格式化与解析</h2>
<h3 data-id="heading-16">高级格式化与解析</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.time.*;
<span class="hljs-keyword">import</span> java.time.format.*;
<span class="hljs-keyword">import</span> java.time.temporal.*;
<span class="hljs-keyword">import</span> java.util.Locale;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateTimeFormatting</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 日期时间格式化与解析 ==="</span>);
        
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();
        
        <span class="hljs-comment">// 1. 预定义的格式化器</span>
        System.out.println(<span class="hljs-string">"\n1. 预定义的格式化器:"</span>);
        
        System.out.println(<span class="hljs-string">"ISO格式: "</span> + now.format(DateTimeFormatter.ISO_LOCAL_DATE_TIME));
        System.out.println(<span class="hljs-string">"ISO日期: "</span> + now.format(DateTimeFormatter.ISO_LOCAL_DATE));
        System.out.println(<span class="hljs-string">"ISO时间: "</span> + now.format(DateTimeFormatter.ISO_LOCAL_TIME));
        
        <span class="hljs-comment">// 2. 自定义模式</span>
        System.out.println(<span class="hljs-string">"\n2. 自定义模式:"</span>);
        
        DateTimeFormatter[] formatters = {
            DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd"</span>),
            DateTimeFormatter.ofPattern(<span class="hljs-string">"dd/MM/yyyy"</span>),
            DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy年MM月dd日"</span>),
            DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>),
            DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss.SSS"</span>),
            DateTimeFormatter.ofPattern(<span class="hljs-string">"EEEE, MMMM dd, yyyy"</span>), <span class="hljs-comment">// 星期，月份，日，年</span>
            DateTimeFormatter.ofPattern(<span class="hljs-string">"hh:mm a"</span>),            <span class="hljs-comment">// 12小时制</span>
            DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy年 第Q季度"</span>),       <span class="hljs-comment">// 季度</span>
            DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd'T'HH:mm:ssXXX"</span>) <span class="hljs-comment">// 带时区偏移</span>
        };
        
        <span class="hljs-keyword">for</span> (DateTimeFormatter formatter : formatters) {
            System.out.println(formatter.format(now) + <span class="hljs-string">"  &lt;- "</span> + 
                             formatter.toString().replaceAll(<span class="hljs-string">".*\["</span>, <span class="hljs-string">"["</span>));
        }
        
        <span class="hljs-comment">// 3. 本地化格式化</span>
        System.out.println(<span class="hljs-string">"\n3. 本地化格式化:"</span>);
        
        Locale[] locales = {Locale.US, Locale.UK, Locale.GERMANY, Locale.JAPAN, Locale.CHINA};
        <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">localizedFormatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofLocalizedDateTime(FormatStyle.MEDIUM);
        
        <span class="hljs-keyword">for</span> (Locale locale : locales) {
            <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">localeSpecific</span> <span class="hljs-operator">=</span> localizedFormatter.withLocale(locale);
            System.out.println(locale.getDisplayName() + <span class="hljs-string">": "</span> + localeSpecific.format(now));
        }
        
        <span class="hljs-comment">// 4. 格式化器构建器（复杂格式化）</span>
        System.out.println(<span class="hljs-string">"\n4. 格式化器构建器:"</span>);
        
        <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">complexFormatter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTimeFormatterBuilder</span>()
            .appendLiteral(<span class="hljs-string">"日期: "</span>)
            .appendValue(ChronoField.YEAR, <span class="hljs-number">4</span>)
            .appendLiteral(<span class="hljs-string">"年"</span>)
            .appendValue(ChronoField.MONTH_OF_YEAR, <span class="hljs-number">2</span>)
            .appendLiteral(<span class="hljs-string">"月"</span>)
            .appendValue(ChronoField.DAY_OF_MONTH, <span class="hljs-number">2</span>)
            .appendLiteral(<span class="hljs-string">"日"</span>)
            .appendLiteral(<span class="hljs-string">" 时间: "</span>)
            .appendValue(ChronoField.HOUR_OF_DAY, <span class="hljs-number">2</span>)
            .appendLiteral(<span class="hljs-string">":"</span>)
            .appendValue(ChronoField.MINUTE_OF_HOUR, <span class="hljs-number">2</span>)
            .appendLiteral(<span class="hljs-string">":"</span>)
            .appendValue(ChronoField.SECOND_OF_MINUTE, <span class="hljs-number">2</span>)
            .optionalStart() <span class="hljs-comment">// 可选部分</span>
            .appendLiteral(<span class="hljs-string">"."</span>)
            .appendValue(ChronoField.MILLI_OF_SECOND, <span class="hljs-number">3</span>)
            .optionalEnd()
            .toFormatter();
        
        System.out.println(<span class="hljs-string">"复杂格式化: "</span> + complexFormatter.format(now));
        
        <span class="hljs-comment">// 5. 解析日期时间</span>
        System.out.println(<span class="hljs-string">"\n5. 解析日期时间:"</span>);
        
        String[] dateStrings = {
            <span class="hljs-string">"2023-11-15"</span>,
            <span class="hljs-string">"15/11/2023"</span>,
            <span class="hljs-string">"2023年11月15日"</span>,
            <span class="hljs-string">"2023-11-15 14:30:45"</span>,
            <span class="hljs-string">"November 15, 2023"</span>
        };
        
        DateTimeFormatter[] parsers = {
            DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd"</span>),
            DateTimeFormatter.ofPattern(<span class="hljs-string">"dd/MM/yyyy"</span>),
            DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy年MM月dd日"</span>),
            DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>),
            DateTimeFormatter.ofPattern(<span class="hljs-string">"MMMM dd, yyyy"</span>, Locale.US)
        };
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; dateStrings.length; i++) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">TemporalAccessor</span> <span class="hljs-variable">parsed</span> <span class="hljs-operator">=</span> parsers[i].parse(dateStrings[i]);
                System.out.println(dateStrings[i] + <span class="hljs-string">" -&gt; 解析成功"</span>);
            } <span class="hljs-keyword">catch</span> (DateTimeParseException e) {
                System.out.println(dateStrings[i] + <span class="hljs-string">" -&gt; 解析失败: "</span> + e.getMessage());
            }
        }
        
        <span class="hljs-comment">// 6. 宽松解析与严格解析</span>
        System.out.println(<span class="hljs-string">"\n6. 宽松解析与严格解析:"</span>);
        
        <span class="hljs-type">String</span> <span class="hljs-variable">looseDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">"2023-2-31"</span>; <span class="hljs-comment">// 2月31日不存在</span>
        <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">lenientFormatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-M-d"</span>)
            .withResolverStyle(ResolverStyle.LENIENT);
        <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">strictFormatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-M-d"</span>)
            .withResolverStyle(ResolverStyle.STRICT);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">LocalDate</span> <span class="hljs-variable">parsedLenient</span> <span class="hljs-operator">=</span> LocalDate.parse(looseDate, lenientFormatter);
            System.out.println(<span class="hljs-string">"宽松解析成功: "</span> + parsedLenient); <span class="hljs-comment">// 会自动调整到3月3日</span>
        } <span class="hljs-keyword">catch</span> (DateTimeParseException e) {
            System.out.println(<span class="hljs-string">"宽松解析失败: "</span> + e.getMessage());
        }
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">LocalDate</span> <span class="hljs-variable">parsedStrict</span> <span class="hljs-operator">=</span> LocalDate.parse(looseDate, strictFormatter);
            System.out.println(<span class="hljs-string">"严格解析成功: "</span> + parsedStrict);
        } <span class="hljs-keyword">catch</span> (DateTimeParseException e) {
            System.out.println(<span class="hljs-string">"严格解析失败: "</span> + e.getMessage());
        }
        
        <span class="hljs-comment">// 7. 实际应用：多格式解析器</span>
        System.out.println(<span class="hljs-string">"\n7. 多格式解析器:"</span>);
        
        String[] possibleFormats = {
            <span class="hljs-string">"yyyy-MM-dd"</span>,
            <span class="hljs-string">"yyyy/MM/dd"</span>,
            <span class="hljs-string">"dd-MM-yyyy"</span>,
            <span class="hljs-string">"dd/MM/yyyy"</span>,
            <span class="hljs-string">"yyyy.MM.dd"</span>,
            <span class="hljs-string">"MMM dd, yyyy"</span>,
            <span class="hljs-string">"dd MMM yyyy"</span>
        };
        
        <span class="hljs-type">String</span> <span class="hljs-variable">testDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">"15/11/2023"</span>;
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> parseWithMultipleFormats(testDate, possibleFormats);
        System.out.println(<span class="hljs-string">"多格式解析结果: "</span> + result);
        
        <span class="hljs-comment">// 8. 自定义格式化扩展</span>
        System.out.println(<span class="hljs-string">"\n8. 自定义格式化扩展:"</span>);
        
        <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">customFormatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd"</span>)
            .withZone(ZoneId.of(<span class="hljs-string">"Asia/Shanghai"</span>))
            .withDecimalStyle(DecimalStyle.STANDARD)
            .withChronology(IsoChronology.INSTANCE);
        
        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">zonedDateTime</span> <span class="hljs-operator">=</span> ZonedDateTime.now(ZoneId.of(<span class="hljs-string">"Asia/Shanghai"</span>));
        System.out.println(<span class="hljs-string">"带时区格式化: "</span> + customFormatter.format(zonedDateTime));
    }
    
    <span class="hljs-comment">// 多格式解析器实现</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> LocalDate <span class="hljs-title function_">parseWithMultipleFormats</span><span class="hljs-params">(String dateString, String[] formats)</span> {
        <span class="hljs-keyword">for</span> (String format : formats) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(format);
                <span class="hljs-keyword">return</span> LocalDate.parse(dateString, formatter);
            } <span class="hljs-keyword">catch</span> (DateTimeParseException e) {
                <span class="hljs-comment">// 继续尝试下一个格式</span>
                <span class="hljs-keyword">continue</span>;
            }
        }
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"无法解析日期: "</span> + dateString);
    }
    
    <span class="hljs-comment">// 智能日期解析</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> LocalDate <span class="hljs-title function_">smartDateParse</span><span class="hljs-params">(String input)</span> {
        <span class="hljs-comment">// 移除常见的分隔符，统一处理</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">normalized</span> <span class="hljs-operator">=</span> input.replaceAll(<span class="hljs-string">"[/.-]"</span>, <span class="hljs-string">"-"</span>);
        
        <span class="hljs-comment">// 尝试常见格式</span>
        String[] patterns = {
            <span class="hljs-string">"yyyy-MM-dd"</span>,
            <span class="hljs-string">"yyyy-M-d"</span>,
            <span class="hljs-string">"yy-MM-dd"</span>,
            <span class="hljs-string">"yy-M-d"</span>,
            <span class="hljs-string">"MM-dd-yyyy"</span>,
            <span class="hljs-string">"M-d-yyyy"</span>,
            <span class="hljs-string">"dd-MM-yyyy"</span>,
            <span class="hljs-string">"d-M-yyyy"</span>
        };
        
        <span class="hljs-keyword">for</span> (String pattern : patterns) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(pattern);
                <span class="hljs-keyword">return</span> LocalDate.parse(normalized, formatter);
            } <span class="hljs-keyword">catch</span> (DateTimeParseException e) {
                <span class="hljs-keyword">continue</span>;
            }
        }
        
        <span class="hljs-comment">// 尝试文本月份</span>
        patterns = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{
            <span class="hljs-string">"MMM dd, yyyy"</span>,
            <span class="hljs-string">"MMM d, yyyy"</span>,
            <span class="hljs-string">"MMMM dd, yyyy"</span>,
            <span class="hljs-string">"MMMM d, yyyy"</span>,
            <span class="hljs-string">"dd MMM yyyy"</span>,
            <span class="hljs-string">"d MMM yyyy"</span>
        };
        
        <span class="hljs-keyword">for</span> (String pattern : patterns) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(pattern, Locale.ENGLISH);
                <span class="hljs-keyword">return</span> LocalDate.parse(input, formatter);
            } <span class="hljs-keyword">catch</span> (DateTimeParseException e) {
                <span class="hljs-keyword">continue</span>;
            }
        }
        
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"无法识别的日期格式: "</span> + input);
    }
    
    <span class="hljs-comment">// 生成可读的时间间隔描述</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">formatTimeAgo</span><span class="hljs-params">(LocalDateTime pastTime)</span> {
        <span class="hljs-type">Duration</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> Duration.between(pastTime, LocalDateTime.now());
        
        <span class="hljs-keyword">if</span> (duration.toDays() &gt; <span class="hljs-number">365</span>) {
            <span class="hljs-type">long</span> <span class="hljs-variable">years</span> <span class="hljs-operator">=</span> duration.toDays() / <span class="hljs-number">365</span>;
            <span class="hljs-keyword">return</span> years + <span class="hljs-string">"年前"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (duration.toDays() &gt; <span class="hljs-number">30</span>) {
            <span class="hljs-type">long</span> <span class="hljs-variable">months</span> <span class="hljs-operator">=</span> duration.toDays() / <span class="hljs-number">30</span>;
            <span class="hljs-keyword">return</span> months + <span class="hljs-string">"个月前"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (duration.toDays() &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> duration.toDays() + <span class="hljs-string">"天前"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (duration.toHours() &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> duration.toHours() + <span class="hljs-string">"小时前"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (duration.toMinutes() &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> duration.toMinutes() + <span class="hljs-string">"分钟前"</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"刚刚"</span>;
        }
    }
    
    <span class="hljs-comment">// 生成日历视图</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printCalendar</span><span class="hljs-params">(<span class="hljs-type">int</span> year, <span class="hljs-type">int</span> month)</span> {
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">firstDay</span> <span class="hljs-operator">=</span> LocalDate.of(year, month, <span class="hljs-number">1</span>);
        <span class="hljs-type">DayOfWeek</span> <span class="hljs-variable">firstDayOfWeek</span> <span class="hljs-operator">=</span> firstDay.getDayOfWeek();
        <span class="hljs-type">int</span> <span class="hljs-variable">daysInMonth</span> <span class="hljs-operator">=</span> firstDay.lengthOfMonth();
        
        System.out.printf(<span class="hljs-string">"\n     %d年 %d月\n"</span>, year, month);
        System.out.println(<span class="hljs-string">"日 一 二 三 四 五 六"</span>);
        
        <span class="hljs-comment">// 打印前面的空白</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; firstDayOfWeek.getValue() % <span class="hljs-number">7</span>; i++) {
            System.out.print(<span class="hljs-string">"   "</span>);
        }
        
        <span class="hljs-comment">// 打印日期</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">day</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; day &lt;= daysInMonth; day++) {
            System.out.printf(<span class="hljs-string">"%2d "</span>, day);
            
            <span class="hljs-comment">// 换行</span>
            <span class="hljs-keyword">if</span> ((firstDayOfWeek.getValue() % <span class="hljs-number">7</span> + day) % <span class="hljs-number">7</span> == <span class="hljs-number">0</span>) {
                System.out.println();
            }
        }
        System.out.println();
    }
}
</code></pre>
<h2 data-id="heading-17">实战：完整的企业级应用</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.time.*;
<span class="hljs-keyword">import</span> java.time.format.*;
<span class="hljs-keyword">import</span> java.time.temporal.*;
<span class="hljs-keyword">import</span> java.util.*;
<span class="hljs-keyword">import</span> java.util.concurrent.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnterpriseDateTimeApplication</span> {
    
    <span class="hljs-comment">// 1. 航班预订系统</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FlightBookingSystem</span> {
        
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Flight</span> {
            String flightNumber;
            String airline;
            String departureAirport;
            String arrivalAirport;
            ZonedDateTime departureTime;
            ZonedDateTime arrivalTime;
            Duration flightDuration;
            
            <span class="hljs-keyword">public</span> <span class="hljs-title function_">Flight</span><span class="hljs-params">(String flightNumber, String airline, String departureAirport, 
                         String arrivalAirport, ZonedDateTime departureTime, 
                         ZonedDateTime arrivalTime)</span> {
                <span class="hljs-built_in">this</span>.flightNumber = flightNumber;
                <span class="hljs-built_in">this</span>.airline = airline;
                <span class="hljs-built_in">this</span>.departureAirport = departureAirport;
                <span class="hljs-built_in">this</span>.arrivalAirport = arrivalAirport;
                <span class="hljs-built_in">this</span>.departureTime = departureTime;
                <span class="hljs-built_in">this</span>.arrivalTime = arrivalTime;
                <span class="hljs-built_in">this</span>.flightDuration = Duration.between(departureTime, arrivalTime);
            }
            
            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOverlapping</span><span class="hljs-params">(Flight other)</span> {
                <span class="hljs-keyword">return</span> !(<span class="hljs-built_in">this</span>.arrivalTime.isBefore(other.departureTime) || 
                        <span class="hljs-built_in">this</span>.departureTime.isAfter(other.arrivalTime));
            }
            
            <span class="hljs-keyword">public</span> Duration <span class="hljs-title function_">getLayoverTime</span><span class="hljs-params">(Flight connectingFlight)</span> {
                <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.arrivalAirport.equals(connectingFlight.departureAirport)) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"不是连续的航班"</span>);
                }
                <span class="hljs-keyword">return</span> Duration.between(<span class="hljs-built_in">this</span>.arrivalTime, connectingFlight.departureTime);
            }
            
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
                <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm (zzz)"</span>);
                <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%s %s: %s [%s] -&gt; %s [%s] 时长: %s"</span>,
                    airline, flightNumber,
                    departureTime.format(formatter),
                    departureAirport,
                    arrivalTime.format(formatter),
                    arrivalAirport,
                    formatDuration(flightDuration));
            }
            
            <span class="hljs-keyword">private</span> String <span class="hljs-title function_">formatDuration</span><span class="hljs-params">(Duration duration)</span> {
                <span class="hljs-type">long</span> <span class="hljs-variable">hours</span> <span class="hljs-operator">=</span> duration.toHours();
                <span class="hljs-type">long</span> <span class="hljs-variable">minutes</span> <span class="hljs-operator">=</span> duration.toMinutesPart();
                <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%d小时%d分钟"</span>, hours, minutes);
            }
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bookFlight</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"=== 航班预订系统 ==="</span>);
            
            <span class="hljs-comment">// 定义航班</span>
            <span class="hljs-type">Flight</span> <span class="hljs-variable">flight1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Flight</span>(
                <span class="hljs-string">"CA123"</span>,
                <span class="hljs-string">"中国航空"</span>,
                <span class="hljs-string">"北京首都国际机场 (PEK)"</span>,
                <span class="hljs-string">"上海浦东国际机场 (PVG)"</span>,
                ZonedDateTime.of(<span class="hljs-number">2023</span>, <span class="hljs-number">12</span>, <span class="hljs-number">1</span>, <span class="hljs-number">8</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ZoneId.of(<span class="hljs-string">"Asia/Shanghai"</span>)),
                ZonedDateTime.of(<span class="hljs-number">2023</span>, <span class="hljs-number">12</span>, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">30</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ZoneId.of(<span class="hljs-string">"Asia/Shanghai"</span>))
            );
            
            <span class="hljs-type">Flight</span> <span class="hljs-variable">flight2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Flight</span>(
                <span class="hljs-string">"AA789"</span>,
                <span class="hljs-string">"美国航空"</span>,
                <span class="hljs-string">"上海浦东国际机场 (PVG)"</span>,
                <span class="hljs-string">"纽约肯尼迪机场 (JFK)"</span>,
                ZonedDateTime.of(<span class="hljs-number">2023</span>, <span class="hljs-number">12</span>, <span class="hljs-number">1</span>, <span class="hljs-number">13</span>, <span class="hljs-number">30</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ZoneId.of(<span class="hljs-string">"Asia/Shanghai"</span>)),
                ZonedDateTime.of(<span class="hljs-number">2023</span>, <span class="hljs-number">12</span>, <span class="hljs-number">1</span>, <span class="hljs-number">16</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ZoneId.of(<span class="hljs-string">"America/New_York"</span>))
            );
            
            System.out.println(<span class="hljs-string">"航班1: "</span> + flight1);
            System.out.println(<span class="hljs-string">"航班2: "</span> + flight2);
            
            <span class="hljs-comment">// 检查转机时间</span>
            <span class="hljs-type">Duration</span> <span class="hljs-variable">layover</span> <span class="hljs-operator">=</span> flight1.getLayoverTime(flight2);
            System.out.println(<span class="hljs-string">"\n转机时间: "</span> + 
                layover.toHours() + <span class="hljs-string">"小时"</span> + layover.toMinutesPart() + <span class="hljs-string">"分钟"</span>);
            
            <span class="hljs-keyword">if</span> (layover.toHours() &lt; <span class="hljs-number">1</span>) {
                System.out.println(<span class="hljs-string">"⚠️ 警告：转机时间太短！"</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (layover.toHours() &gt; <span class="hljs-number">4</span>) {
                System.out.println(<span class="hljs-string">"⚠️ 警告：转机时间太长！"</span>);
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"✓ 转机时间合适"</span>);
            }
            
            <span class="hljs-comment">// 显示到达目的地的时间（按目的地时区）</span>
            <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">arrivalInLocalTime</span> <span class="hljs-operator">=</span> flight2.arrivalTime
                .withZoneSameInstant(ZoneId.of(<span class="hljs-string">"America/New_York"</span>));
            System.out.println(<span class="hljs-string">"\n到达纽约时间: "</span> + 
                arrivalInLocalTime.format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm (zzz)"</span>)));
        }
    }
    
    <span class="hljs-comment">// 2. 会议调度系统</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MeetingScheduler</span> {
        
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Meeting</span> {
            String title;
            String organizer;
            ZonedDateTime startTime;
            Duration duration;
            Set&lt;String&gt; participants;
            String location;
            
            <span class="hljs-keyword">public</span> <span class="hljs-title function_">Meeting</span><span class="hljs-params">(String title, String organizer, ZonedDateTime startTime, 
                          Duration duration, Set&lt;String&gt; participants, String location)</span> {
                <span class="hljs-built_in">this</span>.title = title;
                <span class="hljs-built_in">this</span>.organizer = organizer;
                <span class="hljs-built_in">this</span>.startTime = startTime;
                <span class="hljs-built_in">this</span>.duration = duration;
                <span class="hljs-built_in">this</span>.participants = participants;
                <span class="hljs-built_in">this</span>.location = location;
            }
            
            <span class="hljs-keyword">public</span> ZonedDateTime <span class="hljs-title function_">getEndTime</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">return</span> startTime.plus(duration);
            }
            
            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">conflictsWith</span><span class="hljs-params">(Meeting other)</span> {
                <span class="hljs-keyword">return</span> !(<span class="hljs-built_in">this</span>.getEndTime().isBefore(other.startTime) || 
                        <span class="hljs-built_in">this</span>.startTime.isAfter(other.getEndTime()));
            }
            
            <span class="hljs-keyword">public</span> Map&lt;String, ZonedDateTime&gt; <span class="hljs-title function_">getLocalTimesForParticipants</span><span class="hljs-params">()</span> {
                Map&lt;String, ZonedDateTime&gt; localTimes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
                
                <span class="hljs-comment">// 模拟从数据库获取参与者时区</span>
                Map&lt;String, String&gt; participantTimezones = Map.of(
                    <span class="hljs-string">"张三"</span>, <span class="hljs-string">"Asia/Shanghai"</span>,
                    <span class="hljs-string">"李四"</span>, <span class="hljs-string">"America/New_York"</span>,
                    <span class="hljs-string">"王五"</span>, <span class="hljs-string">"Europe/London"</span>,
                    <span class="hljs-string">"山田"</span>, <span class="hljs-string">"Asia/Tokyo"</span>
                );
                
                <span class="hljs-keyword">for</span> (String participant : participants) {
                    <span class="hljs-type">String</span> <span class="hljs-variable">timezone</span> <span class="hljs-operator">=</span> participantTimezones.getOrDefault(participant, <span class="hljs-string">"UTC"</span>);
                    localTimes.put(participant, 
                        startTime.withZoneSameInstant(ZoneId.of(timezone)));
                }
                
                <span class="hljs-keyword">return</span> localTimes;
            }
            
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
                <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm (zzz)"</span>);
                <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"会议: %s\n组织者: %s\n时间: %s - %s\n地点: %s\n参与者: %s"</span>,
                    title, organizer,
                    startTime.format(formatter),
                    getEndTime().format(formatter),
                    location,
                    String.join(<span class="hljs-string">", "</span>, participants));
            }
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleMeeting</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"\n=== 会议调度系统 ==="</span>);
            
            Set&lt;String&gt; participants = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(Arrays.asList(
                <span class="hljs-string">"张三"</span>, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"王五"</span>, <span class="hljs-string">"山田"</span>
            ));
            
            <span class="hljs-type">Meeting</span> <span class="hljs-variable">meeting</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meeting</span>(
                <span class="hljs-string">"季度项目评审"</span>,
                <span class="hljs-string">"张三"</span>,
                ZonedDateTime.of(<span class="hljs-number">2023</span>, <span class="hljs-number">12</span>, <span class="hljs-number">15</span>, <span class="hljs-number">14</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ZoneId.of(<span class="hljs-string">"Asia/Shanghai"</span>)),
                Duration.ofHours(<span class="hljs-number">2</span>),
                participants,
                <span class="hljs-string">"会议室A"</span>
            );
            
            System.out.println(meeting);
            
            <span class="hljs-comment">// 显示各参与者的本地时间</span>
            System.out.println(<span class="hljs-string">"\n各参与者的本地时间:"</span>);
            Map&lt;String, ZonedDateTime&gt; localTimes = meeting.getLocalTimesForParticipants();
            
            <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">timeFormatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"HH:mm"</span>);
            <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">dateFormatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"MM月dd日"</span>);
            
            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, ZonedDateTime&gt; entry : localTimes.entrySet()) {
                <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">localTime</span> <span class="hljs-operator">=</span> entry.getValue();
                System.out.printf(<span class="hljs-string">"%-8s: %s %s%n"</span>,
                    entry.getKey(),
                    localTime.format(dateFormatter),
                    localTime.format(timeFormatter));
            }
            
            <span class="hljs-comment">// 检查时间是否合适</span>
            System.out.println(<span class="hljs-string">"\n时间合适性检查:"</span>);
            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, ZonedDateTime&gt; entry : localTimes.entrySet()) {
                <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">localTime</span> <span class="hljs-operator">=</span> entry.getValue();
                <span class="hljs-type">LocalTime</span> <span class="hljs-variable">meetingLocalTime</span> <span class="hljs-operator">=</span> localTime.toLocalTime();
                
                <span class="hljs-type">boolean</span> <span class="hljs-variable">isWorkingHour</span> <span class="hljs-operator">=</span> meetingLocalTime.isAfter(LocalTime.of(<span class="hljs-number">9</span>, <span class="hljs-number">0</span>)) &amp;&amp;
                                       meetingLocalTime.isBefore(LocalTime.of(<span class="hljs-number">18</span>, <span class="hljs-number">0</span>));
                
                System.out.printf(<span class="hljs-string">"%-8s: %s (%s)%n"</span>,
                    entry.getKey(),
                    isWorkingHour ? <span class="hljs-string">"✓ 工作时间"</span> : <span class="hljs-string">"⚠️ 非工作时间"</span>,
                    meetingLocalTime.format(DateTimeFormatter.ofPattern(<span class="hljs-string">"HH:mm"</span>)));
            }
        }
    }
    
    <span class="hljs-comment">// 3. 任务管理系统</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskManagementSystem</span> {
        
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span> {
            String id;
            String title;
            String description;
            TaskPriority priority;
            LocalDateTime dueDate;
            Duration estimatedEffort;
            LocalDateTime actualStart;
            LocalDateTime actualEnd;
            TaskStatus status;
            
            <span class="hljs-keyword">enum</span> <span class="hljs-title class_">TaskPriority</span> { LOW, MEDIUM, HIGH, CRITICAL }
            <span class="hljs-keyword">enum</span> <span class="hljs-title class_">TaskStatus</span> { PENDING, IN_PROGRESS, BLOCKED, COMPLETED, CANCELLED }
            
            <span class="hljs-keyword">public</span> <span class="hljs-title function_">Task</span><span class="hljs-params">(String id, String title, String description, TaskPriority priority,
                       LocalDateTime dueDate, Duration estimatedEffort)</span> {
                <span class="hljs-built_in">this</span>.id = id;
                <span class="hljs-built_in">this</span>.title = title;
                <span class="hljs-built_in">this</span>.description = description;
                <span class="hljs-built_in">this</span>.priority = priority;
                <span class="hljs-built_in">this</span>.dueDate = dueDate;
                <span class="hljs-built_in">this</span>.estimatedEffort = estimatedEffort;
                <span class="hljs-built_in">this</span>.status = TaskStatus.PENDING;
            }
            
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startTask</span><span class="hljs-params">()</span> {
                <span class="hljs-built_in">this</span>.actualStart = LocalDateTime.now();
                <span class="hljs-built_in">this</span>.status = TaskStatus.IN_PROGRESS;
            }
            
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">completeTask</span><span class="hljs-params">()</span> {
                <span class="hljs-built_in">this</span>.actualEnd = LocalDateTime.now();
                <span class="hljs-built_in">this</span>.status = TaskStatus.COMPLETED;
            }
            
            <span class="hljs-keyword">public</span> Duration <span class="hljs-title function_">getTimeSpent</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">if</span> (actualStart == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> Duration.ZERO;
                <span class="hljs-keyword">if</span> (actualEnd == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> Duration.between(actualStart, LocalDateTime.now());
                <span class="hljs-keyword">return</span> Duration.between(actualStart, actualEnd);
            }
            
            <span class="hljs-keyword">public</span> Duration <span class="hljs-title function_">getTimeRemaining</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">if</span> (status == TaskStatus.COMPLETED) <span class="hljs-keyword">return</span> Duration.ZERO;
                
                <span class="hljs-type">Duration</span> <span class="hljs-variable">timeSpent</span> <span class="hljs-operator">=</span> getTimeSpent();
                <span class="hljs-keyword">if</span> (timeSpent.compareTo(estimatedEffort) &gt;= <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">return</span> Duration.ZERO;
                }
                <span class="hljs-keyword">return</span> estimatedEffort.minus(timeSpent);
            }
            
            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOverdue</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">return</span> status != TaskStatus.COMPLETED &amp;&amp; 
                       LocalDateTime.now().isAfter(dueDate);
            }
            
            <span class="hljs-keyword">public</span> Duration <span class="hljs-title function_">getOverdueDuration</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">if</span> (!isOverdue()) <span class="hljs-keyword">return</span> Duration.ZERO;
                <span class="hljs-keyword">return</span> Duration.between(dueDate, LocalDateTime.now());
            }
            
            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getProgress</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">if</span> (status == TaskStatus.PENDING) <span class="hljs-keyword">return</span> <span class="hljs-string">"0%"</span>;
                <span class="hljs-keyword">if</span> (status == TaskStatus.COMPLETED) <span class="hljs-keyword">return</span> <span class="hljs-string">"100%"</span>;
                
                <span class="hljs-keyword">if</span> (estimatedEffort.isZero()) <span class="hljs-keyword">return</span> <span class="hljs-string">"N/A"</span>;
                
                <span class="hljs-type">long</span> <span class="hljs-variable">spentMillis</span> <span class="hljs-operator">=</span> getTimeSpent().toMillis();
                <span class="hljs-type">long</span> <span class="hljs-variable">totalMillis</span> <span class="hljs-operator">=</span> estimatedEffort.toMillis();
                
                <span class="hljs-type">double</span> <span class="hljs-variable">progress</span> <span class="hljs-operator">=</span> (<span class="hljs-type">double</span>) spentMillis / totalMillis * <span class="hljs-number">100</span>;
                <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%.1f%%"</span>, Math.min(<span class="hljs-number">100</span>, progress));
            }
            
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
                <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm"</span>);
                <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"任务: %s [%s]\n优先级: %s\n截止时间: %s\n预估工作量: %s\n状态: %s\n进度: %s\n%s"</span>,
                    title, id,
                    priority,
                    dueDate.format(formatter),
                    formatDuration(estimatedEffort),
                    status,
                    getProgress(),
                    isOverdue() ? <span class="hljs-string">"⚠️ 已超期 "</span> + formatDuration(getOverdueDuration()) : <span class="hljs-string">"✓ 按时"</span>
                );
            }
            
            <span class="hljs-keyword">private</span> String <span class="hljs-title function_">formatDuration</span><span class="hljs-params">(Duration duration)</span> {
                <span class="hljs-keyword">if</span> (duration.toDays() &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%d天%d小时"</span>, duration.toDays(), duration.toHoursPart());
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (duration.toHours() &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%d小时%d分钟"</span>, duration.toHours(), duration.toMinutesPart());
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%d分钟"</span>, duration.toMinutes());
                }
            }
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">manageTasks</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"\n=== 任务管理系统 ==="</span>);
            
            <span class="hljs-type">Task</span> <span class="hljs-variable">task1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(
                <span class="hljs-string">"TASK-001"</span>,
                <span class="hljs-string">"实现用户登录功能"</span>,
                <span class="hljs-string">"实现用户登录、注册、忘记密码功能"</span>,
                Task.TaskPriority.HIGH,
                LocalDateTime.of(<span class="hljs-number">2023</span>, <span class="hljs-number">11</span>, <span class="hljs-number">30</span>, <span class="hljs-number">18</span>, <span class="hljs-number">0</span>),
                Duration.ofHours(<span class="hljs-number">16</span>)
            );
            
            <span class="hljs-type">Task</span> <span class="hljs-variable">task2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(
                <span class="hljs-string">"TASK-002"</span>,
                <span class="hljs-string">"编写单元测试"</span>,
                <span class="hljs-string">"为核心模块编写单元测试"</span>,
                Task.TaskPriority.MEDIUM,
                LocalDateTime.of(<span class="hljs-number">2023</span>, <span class="hljs-number">12</span>, <span class="hljs-number">5</span>, <span class="hljs-number">18</span>, <span class="hljs-number">0</span>),
                Duration.ofHours(<span class="hljs-number">8</span>)
            );
            
            task1.startTask();
            task1.completeTask();
            
            task2.startTask();
            <span class="hljs-comment">// task2 正在进行中</span>
            
            System.out.println(task1);
            System.out.println(<span class="hljs-string">"\n---\n"</span>);
            System.out.println(task2);
            
            <span class="hljs-comment">// 生成任务报告</span>
            System.out.println(<span class="hljs-string">"\n=== 任务报告 ==="</span>);
            List&lt;Task&gt; tasks = Arrays.asList(task1, task2);
            
            <span class="hljs-type">long</span> <span class="hljs-variable">totalEstimated</span> <span class="hljs-operator">=</span> tasks.stream()
                .mapToLong(t -&gt; t.estimatedEffort.toHours())
                .sum();
            
            <span class="hljs-type">long</span> <span class="hljs-variable">totalActual</span> <span class="hljs-operator">=</span> tasks.stream()
                .mapToLong(t -&gt; t.getTimeSpent().toHours())
                .sum();
            
            <span class="hljs-type">long</span> <span class="hljs-variable">overdueCount</span> <span class="hljs-operator">=</span> tasks.stream()
                .filter(Task::isOverdue)
                .count();
            
            System.out.printf(<span class="hljs-string">"总任务数: %d\n"</span>, tasks.size());
            System.out.printf(<span class="hljs-string">"预估总工时: %d 小时\n"</span>, totalEstimated);
            System.out.printf(<span class="hljs-string">"实际总工时: %d 小时\n"</span>, totalActual);
            System.out.printf(<span class="hljs-string">"超期任务数: %d\n"</span>, overdueCount);
            System.out.printf(<span class="hljs-string">"完成率: %.1f%%\n"</span>, 
                tasks.stream().filter(t -&gt; t.status == Task.TaskStatus.COMPLETED).count() * <span class="hljs-number">100.0</span> / tasks.size());
        }
    }
    
    <span class="hljs-comment">// 4. 缓存过期系统</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheExpirySystem</span>&lt;K, V&gt; {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;K, CacheEntry&lt;V&gt;&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">cleaner</span> <span class="hljs-operator">=</span> Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);
        
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheEntry</span>&lt;V&gt; {
            V value;
            Instant expiryTime;
            
            CacheEntry(V value, Duration ttl) {
                <span class="hljs-built_in">this</span>.value = value;
                <span class="hljs-built_in">this</span>.expiryTime = Instant.now().plus(ttl);
            }
            
            <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExpired</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">return</span> Instant.now().isAfter(expiryTime);
            }
            
            Duration <span class="hljs-title function_">getTimeUntilExpiry</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">return</span> Duration.between(Instant.now(), expiryTime);
            }
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheExpirySystem</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 每5秒清理一次过期缓存</span>
            cleaner.scheduleAtFixedRate(<span class="hljs-built_in">this</span>::cleanExpiredEntries, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, TimeUnit.SECONDS);
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value, Duration ttl)</span> {
            cache.put(key, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheEntry</span>&lt;&gt;(value, ttl));
        }
        
        <span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(K key)</span> {
            CacheEntry&lt;V&gt; entry = cache.get(key);
            <span class="hljs-keyword">if</span> (entry == <span class="hljs-literal">null</span> || entry.isExpired()) {
                cache.remove(key);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">return</span> entry.value;
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(K key)</span> {
            cache.remove(key);
        }
        
        <span class="hljs-keyword">public</span> Set&lt;K&gt; <span class="hljs-title function_">getKeysAboutToExpire</span><span class="hljs-params">(Duration threshold)</span> {
            <span class="hljs-type">Instant</span> <span class="hljs-variable">warningTime</span> <span class="hljs-operator">=</span> Instant.now().plus(threshold);
            Set&lt;K&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
            
            <span class="hljs-keyword">for</span> (Map.Entry&lt;K, CacheEntry&lt;V&gt;&gt; entry : cache.entrySet()) {
                <span class="hljs-keyword">if</span> (entry.getValue().expiryTime.isBefore(warningTime)) {
                    result.add(entry.getKey());
                }
            }
            
            <span class="hljs-keyword">return</span> result;
        }
        
        <span class="hljs-keyword">public</span> Map&lt;K, Duration&gt; <span class="hljs-title function_">getExpiryTimes</span><span class="hljs-params">()</span> {
            Map&lt;K, Duration&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            
            <span class="hljs-keyword">for</span> (Map.Entry&lt;K, CacheEntry&lt;V&gt;&gt; entry : cache.entrySet()) {
                result.put(entry.getKey(), entry.getValue().getTimeUntilExpiry());
            }
            
            <span class="hljs-keyword">return</span> result;
        }
        
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanExpiredEntries</span><span class="hljs-params">()</span> {
            cache.entrySet().removeIf(entry -&gt; entry.getValue().isExpired());
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> {
            cleaner.shutdown();
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demonstrate</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"\n=== 缓存过期系统 ==="</span>);
            
            put(<span class="hljs-string">"user:1001"</span>, <span class="hljs-string">"用户数据A"</span>, Duration.ofSeconds(<span class="hljs-number">30</span>));
            put(<span class="hljs-string">"product:2001"</span>, <span class="hljs-string">"产品数据B"</span>, Duration.ofMinutes(<span class="hljs-number">1</span>));
            put(<span class="hljs-string">"config:3001"</span>, <span class="hljs-string">"配置数据C"</span>, Duration.ofHours(<span class="hljs-number">1</span>));
            
            System.out.println(<span class="hljs-string">"初始缓存状态:"</span>);
            getExpiryTimes().forEach((key, duration) -&gt; 
                System.out.printf(<span class="hljs-string">"  %s: %d秒后过期%n"</span>, key, duration.getSeconds())
            );
            
            System.out.println(<span class="hljs-string">"\n30秒内将过期的缓存:"</span>);
            getKeysAboutToExpire(Duration.ofSeconds(<span class="hljs-number">30</span>)).forEach(key -&gt;
                System.out.println(<span class="hljs-string">"  "</span> + key)
            );
            
            System.out.println(<span class="hljs-string">"\n等待35秒后..."</span>);
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">35000</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                e.printStackTrace();
            }
            
            System.out.println(<span class="hljs-string">"\n当前缓存状态:"</span>);
            getExpiryTimes().forEach((key, duration) -&gt; 
                System.out.printf(<span class="hljs-string">"  %s: %d秒后过期%n"</span>, key, duration.getSeconds())
            );
            
            System.out.println(<span class="hljs-string">"\n获取user:1001: "</span> + get(<span class="hljs-string">"user:1001"</span>));
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 运行各个系统</span>
        FlightBookingSystem.bookFlight();
        MeetingScheduler.scheduleMeeting();
        TaskManagementSystem.manageTasks();
        
        CacheExpirySystem&lt;String, String&gt; cacheSystem = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheExpirySystem</span>&lt;&gt;();
        cacheSystem.demonstrate();
        cacheSystem.shutdown();
    }
}
</code></pre>
<h2 data-id="heading-18">最佳实践与性能优化</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.time.*;
<span class="hljs-keyword">import</span> java.time.format.*;
<span class="hljs-keyword">import</span> java.time.temporal.*;
<span class="hljs-keyword">import</span> java.util.concurrent.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateTimeBestPractices</span> {
    
    <span class="hljs-comment">// 1. 线程安全的日期时间格式化</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadSafeFormatter</span> {
        <span class="hljs-comment">// ❌ 错误做法：SimpleDateFormat不是线程安全的</span>
        <span class="hljs-comment">// private static final SimpleDateFormat unsafeFormatter = new SimpleDateFormat("yyyy-MM-dd");</span>
        
        <span class="hljs-comment">// ✅ 正确做法：DateTimeFormatter是线程安全的</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">safeFormatter</span> <span class="hljs-operator">=</span> 
            DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>);
        
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, DateTimeFormatter&gt; formatterCache = 
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DateTimeFormatter <span class="hljs-title function_">getFormatter</span><span class="hljs-params">(String pattern)</span> {
            <span class="hljs-keyword">return</span> formatterCache.computeIfAbsent(pattern, 
                p -&gt; DateTimeFormatter.ofPattern(p));
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">format</span><span class="hljs-params">(LocalDateTime dateTime, String pattern)</span> {
            <span class="hljs-keyword">return</span> dateTime.format(getFormatter(pattern));
        }
    }
    
    <span class="hljs-comment">// 2. 日期时间对象池（针对高频率创建场景）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateTimePool</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentLinkedQueue&lt;LocalDateTime&gt; pool = 
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentLinkedQueue</span>&lt;&gt;();
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> maxSize;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">DateTimePool</span><span class="hljs-params">(<span class="hljs-type">int</span> maxSize)</span> {
            <span class="hljs-built_in">this</span>.maxSize = maxSize;
        }
        
        <span class="hljs-keyword">public</span> LocalDateTime <span class="hljs-title function_">borrow</span><span class="hljs-params">()</span> {
            <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">dt</span> <span class="hljs-operator">=</span> pool.poll();
            <span class="hljs-keyword">return</span> dt != <span class="hljs-literal">null</span> ? dt : LocalDateTime.now();
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">(LocalDateTime dateTime)</span> {
            <span class="hljs-keyword">if</span> (pool.size() &lt; maxSize) {
                pool.offer(dateTime);
            }
        }
    }
    
    <span class="hljs-comment">// 3. 高效的时间比较</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EfficientDateTimeComparison</span> {
        <span class="hljs-comment">// 比较两个时间段是否重叠</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOverlap</span><span class="hljs-params">(LocalDateTime start1, LocalDateTime end1,
                                       LocalDateTime start2, LocalDateTime end2)</span> {
            <span class="hljs-comment">// 使用时间戳比较，避免多次方法调用</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> start1.atZone(ZoneId.systemDefault()).toInstant().toEpochMilli();
            <span class="hljs-type">long</span> <span class="hljs-variable">e1</span> <span class="hljs-operator">=</span> end1.atZone(ZoneId.systemDefault()).toInstant().toEpochMilli();
            <span class="hljs-type">long</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> start2.atZone(ZoneId.systemDefault()).toInstant().toEpochMilli();
            <span class="hljs-type">long</span> <span class="hljs-variable">e2</span> <span class="hljs-operator">=</span> end2.atZone(ZoneId.systemDefault()).toInstant().toEpochMilli();
            
            <span class="hljs-keyword">return</span> !(e1 &lt;= s2 || s1 &gt;= e2);
        }
        
        <span class="hljs-comment">// 批量检查日期是否在范围内</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;LocalDate&gt; <span class="hljs-title function_">filterDatesInRange</span><span class="hljs-params">(List&lt;LocalDate&gt; dates,
                                                        LocalDate start, 
                                                        LocalDate end)</span> {
            <span class="hljs-type">long</span> <span class="hljs-variable">startEpochDay</span> <span class="hljs-operator">=</span> start.toEpochDay();
            <span class="hljs-type">long</span> <span class="hljs-variable">endEpochDay</span> <span class="hljs-operator">=</span> end.toEpochDay();
            
            <span class="hljs-keyword">return</span> dates.stream()
                .filter(date -&gt; {
                    <span class="hljs-type">long</span> <span class="hljs-variable">epochDay</span> <span class="hljs-operator">=</span> date.toEpochDay();
                    <span class="hljs-keyword">return</span> epochDay &gt;= startEpochDay &amp;&amp; epochDay &lt;= endEpochDay;
                })
                .collect(Collectors.toList());
        }
    }
    
    <span class="hljs-comment">// 4. 避免常见的性能陷阱</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformancePitfalls</span> {
        
        <span class="hljs-comment">// ❌ 错误做法：在循环中重复创建格式化器</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">badPractice</span><span class="hljs-params">(List&lt;LocalDateTime&gt; dateTimes)</span> {
            <span class="hljs-keyword">for</span> (LocalDateTime dt : dateTimes) {
                <span class="hljs-comment">// 每次循环都创建新的格式化器</span>
                <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>);
                <span class="hljs-type">String</span> <span class="hljs-variable">formatted</span> <span class="hljs-operator">=</span> dt.format(formatter);
                <span class="hljs-comment">// 使用 formatted...</span>
            }
        }
        
        <span class="hljs-comment">// ✅ 正确做法：重用格式化器</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">goodPractice</span><span class="hljs-params">(List&lt;LocalDateTime&gt; dateTimes)</span> {
            <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>);
            <span class="hljs-keyword">for</span> (LocalDateTime dt : dateTimes) {
                <span class="hljs-type">String</span> <span class="hljs-variable">formatted</span> <span class="hljs-operator">=</span> dt.format(formatter);
                <span class="hljs-comment">// 使用 formatted...</span>
            }
        }
        
        <span class="hljs-comment">// ❌ 错误做法：不必要的时区转换</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">badTimeZoneConversion</span><span class="hljs-params">()</span> {
            <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">localDateTime</span> <span class="hljs-operator">=</span> LocalDateTime.now();
            <span class="hljs-comment">// 不必要的双重转换</span>
            <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">zoned</span> <span class="hljs-operator">=</span> localDateTime.atZone(ZoneId.systemDefault());
            <span class="hljs-type">Instant</span> <span class="hljs-variable">instant</span> <span class="hljs-operator">=</span> zoned.toInstant();
            <span class="hljs-comment">// ...</span>
        }
        
        <span class="hljs-comment">// ✅ 正确做法：直接转换</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">goodTimeZoneConversion</span><span class="hljs-params">()</span> {
            <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">localDateTime</span> <span class="hljs-operator">=</span> LocalDateTime.now();
            <span class="hljs-comment">// 直接转换为Instant</span>
            <span class="hljs-type">Instant</span> <span class="hljs-variable">instant</span> <span class="hljs-operator">=</span> localDateTime.atZone(ZoneId.systemDefault()).toInstant();
            <span class="hljs-comment">// ...</span>
        }
    }
    
    <span class="hljs-comment">// 5. 内存优化：使用原始类型处理时间戳</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryOptimizedTimeSeries</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span>[] timestamps;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span>[] values;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> size;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MemoryOptimizedTimeSeries</span><span class="hljs-params">(<span class="hljs-type">int</span> capacity)</span> {
            <span class="hljs-built_in">this</span>.timestamps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">long</span>[capacity];
            <span class="hljs-built_in">this</span>.values = <span class="hljs-keyword">new</span> <span class="hljs-title class_">double</span>[capacity];
            <span class="hljs-built_in">this</span>.size = <span class="hljs-number">0</span>;
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addDataPoint</span><span class="hljs-params">(LocalDateTime timestamp, <span class="hljs-type">double</span> value)</span> {
            <span class="hljs-keyword">if</span> (size &gt;= timestamps.length) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"容量已满"</span>);
            }
            
            <span class="hljs-comment">// 存储时间戳（毫秒）</span>
            timestamps[size] = timestamp.atZone(ZoneId.systemDefault())
                                        .toInstant()
                                        .toEpochMilli();
            values[size] = value;
            size++;
        }
        
        <span class="hljs-keyword">public</span> LocalDateTime <span class="hljs-title function_">getTimestamp</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> {
            <span class="hljs-keyword">return</span> LocalDateTime.ofInstant(
                Instant.ofEpochMilli(timestamps[index]),
                ZoneId.systemDefault()
            );
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getValue</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> {
            <span class="hljs-keyword">return</span> values[index];
        }
        
        <span class="hljs-comment">// 高效的时间范围查询</span>
        <span class="hljs-keyword">public</span> List&lt;Integer&gt; <span class="hljs-title function_">queryByTimeRange</span><span class="hljs-params">(LocalDateTime start, LocalDateTime end)</span> {
            <span class="hljs-type">long</span> <span class="hljs-variable">startMillis</span> <span class="hljs-operator">=</span> start.atZone(ZoneId.systemDefault())
                                   .toInstant()
                                   .toEpochMilli();
            <span class="hljs-type">long</span> <span class="hljs-variable">endMillis</span> <span class="hljs-operator">=</span> end.atZone(ZoneId.systemDefault())
                               .toInstant()
                               .toEpochMilli();
            
            List&lt;Integer&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++) {
                <span class="hljs-keyword">if</span> (timestamps[i] &gt;= startMillis &amp;&amp; timestamps[i] &lt;= endMillis) {
                    result.add(i);
                }
            }
            <span class="hljs-keyword">return</span> result;
        }
    }
    
    <span class="hljs-comment">// 6. 基准测试：对比不同实现方式的性能</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateTimeBenchmark</span> {
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">benchmarkFormatting</span><span class="hljs-params">()</span> {
            <span class="hljs-type">int</span> <span class="hljs-variable">iterations</span> <span class="hljs-operator">=</span> <span class="hljs-number">100000</span>;
            <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();
            
            <span class="hljs-comment">// 测试1：重复创建格式化器</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">start1</span> <span class="hljs-operator">=</span> System.nanoTime();
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; iterations; i++) {
                <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>);
                <span class="hljs-type">String</span> <span class="hljs-variable">formatted</span> <span class="hljs-operator">=</span> now.format(formatter);
            }
            <span class="hljs-type">long</span> <span class="hljs-variable">time1</span> <span class="hljs-operator">=</span> System.nanoTime() - start1;
            
            <span class="hljs-comment">// 测试2：重用格式化器</span>
            <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>);
            <span class="hljs-type">long</span> <span class="hljs-variable">start2</span> <span class="hljs-operator">=</span> System.nanoTime();
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; iterations; i++) {
                <span class="hljs-type">String</span> <span class="hljs-variable">formatted</span> <span class="hljs-operator">=</span> now.format(formatter);
            }
            <span class="hljs-type">long</span> <span class="hljs-variable">time2</span> <span class="hljs-operator">=</span> System.nanoTime() - start2;
            
            System.out.println(<span class="hljs-string">"=== 格式化性能测试 ==="</span>);
            System.out.printf(<span class="hljs-string">"重复创建格式化器: %,d ns%n"</span>, time1);
            System.out.printf(<span class="hljs-string">"重用格式化器: %,d ns%n"</span>, time2);
            System.out.printf(<span class="hljs-string">"性能提升: %.1f%%%n"</span>, (time1 - time2) * <span class="hljs-number">100.0</span> / time1);
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">benchmarkComparison</span><span class="hljs-params">()</span> {
            <span class="hljs-type">int</span> <span class="hljs-variable">iterations</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000000</span>;
            List&lt;LocalDate&gt; dates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();
            
            <span class="hljs-comment">// 生成测试数据</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
                dates.add(LocalDate.now().plusDays(random.nextInt(<span class="hljs-number">365</span>)));
            }
            
            <span class="hljs-type">LocalDate</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> LocalDate.now().minusDays(<span class="hljs-number">180</span>);
            <span class="hljs-type">LocalDate</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> LocalDate.now().plusDays(<span class="hljs-number">180</span>);
            
            <span class="hljs-comment">// 测试不同的比较方法</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.nanoTime();
            <span class="hljs-type">long</span> <span class="hljs-variable">count1</span> <span class="hljs-operator">=</span> dates.stream()
                .filter(date -&gt; date.isAfter(start) &amp;&amp; date.isBefore(end))
                .count();
            <span class="hljs-type">long</span> <span class="hljs-variable">time1</span> <span class="hljs-operator">=</span> System.nanoTime() - startTime;
            
            startTime = System.nanoTime();
            <span class="hljs-type">long</span> <span class="hljs-variable">startEpochDay</span> <span class="hljs-operator">=</span> start.toEpochDay();
            <span class="hljs-type">long</span> <span class="hljs-variable">endEpochDay</span> <span class="hljs-operator">=</span> end.toEpochDay();
            <span class="hljs-type">long</span> <span class="hljs-variable">count2</span> <span class="hljs-operator">=</span> dates.stream()
                .filter(date -&gt; {
                    <span class="hljs-type">long</span> <span class="hljs-variable">epochDay</span> <span class="hljs-operator">=</span> date.toEpochDay();
                    <span class="hljs-keyword">return</span> epochDay &gt; startEpochDay &amp;&amp; epochDay &lt; endEpochDay;
                })
                .count();
            <span class="hljs-type">long</span> <span class="hljs-variable">time2</span> <span class="hljs-operator">=</span> System.nanoTime() - startTime;
            
            System.out.println(<span class="hljs-string">"\n=== 日期比较性能测试 ==="</span>);
            System.out.printf(<span class="hljs-string">"使用isAfter/isBefore: %,d ns%n"</span>, time1);
            System.out.printf(<span class="hljs-string">"使用epochDay直接比较: %,d ns%n"</span>, time2);
            System.out.printf(<span class="hljs-string">"性能提升: %.1f%%%n"</span>, (time1 - time2) * <span class="hljs-number">100.0</span> / time1);
        }
    }
    
    <span class="hljs-comment">// 7. 实用的工具方法</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateTimeUtils</span> {
        
        <span class="hljs-comment">// 安全解析日期，支持多种格式</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Optional&lt;LocalDate&gt; <span class="hljs-title function_">safeParseDate</span><span class="hljs-params">(String dateStr)</span> {
            String[] patterns = {
                <span class="hljs-string">"yyyy-MM-dd"</span>,
                <span class="hljs-string">"yyyy/MM/dd"</span>,
                <span class="hljs-string">"dd/MM/yyyy"</span>,
                <span class="hljs-string">"dd-MM-yyyy"</span>,
                <span class="hljs-string">"yyyy.MM.dd"</span>,
                <span class="hljs-string">"MM/dd/yyyy"</span>
            };
            
            <span class="hljs-keyword">for</span> (String pattern : patterns) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(pattern);
                    <span class="hljs-keyword">return</span> Optional.of(LocalDate.parse(dateStr, formatter));
                } <span class="hljs-keyword">catch</span> (DateTimeParseException e) {
                    <span class="hljs-keyword">continue</span>;
                }
            }
            
            <span class="hljs-keyword">return</span> Optional.empty();
        }
        
        <span class="hljs-comment">// 计算两个日期之间的工作日</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">calculateWorkingDays</span><span class="hljs-params">(LocalDate start, LocalDate end)</span> {
            <span class="hljs-keyword">return</span> start.datesUntil(end.plusDays(<span class="hljs-number">1</span>))
                .filter(date -&gt; date.getDayOfWeek() != DayOfWeek.SATURDAY &amp;&amp;
                              date.getDayOfWeek() != DayOfWeek.SUNDAY)
                .count();
        }
        
        <span class="hljs-comment">// 获取下一个工作日</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> LocalDate <span class="hljs-title function_">getNextWorkingDay</span><span class="hljs-params">(LocalDate date)</span> {
            <span class="hljs-type">LocalDate</span> <span class="hljs-variable">nextDay</span> <span class="hljs-operator">=</span> date.plusDays(<span class="hljs-number">1</span>);
            <span class="hljs-keyword">while</span> (nextDay.getDayOfWeek() == DayOfWeek.SATURDAY || 
                   nextDay.getDayOfWeek() == DayOfWeek.SUNDAY) {
                nextDay = nextDay.plusDays(<span class="hljs-number">1</span>);
            }
            <span class="hljs-keyword">return</span> nextDay;
        }
        
        <span class="hljs-comment">// 格式化时间差为可读字符串</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">formatDurationReadable</span><span class="hljs-params">(Duration duration)</span> {
            <span class="hljs-keyword">if</span> (duration.isNegative()) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"已过期"</span>;
            }
            
            <span class="hljs-keyword">if</span> (duration.toDays() &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%d天%d小时"</span>, duration.toDays(), duration.toHoursPart());
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (duration.toHours() &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%d小时%d分钟"</span>, duration.toHours(), duration.toMinutesPart());
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (duration.toMinutes() &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%d分钟"</span>, duration.toMinutes());
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%d秒"</span>, duration.toSeconds());
            }
        }
        
        <span class="hljs-comment">// 检查是否是营业时间（考虑周末和节假日）</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBusinessTime</span><span class="hljs-params">(LocalDateTime dateTime, 
                                            Set&lt;LocalDate&gt; holidays)</span> {
            <span class="hljs-comment">// 检查是否是周末</span>
            <span class="hljs-type">DayOfWeek</span> <span class="hljs-variable">dayOfWeek</span> <span class="hljs-operator">=</span> dateTime.getDayOfWeek();
            <span class="hljs-keyword">if</span> (dayOfWeek == DayOfWeek.SATURDAY || dayOfWeek == DayOfWeek.SUNDAY) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
            
            <span class="hljs-comment">// 检查是否是节假日</span>
            <span class="hljs-keyword">if</span> (holidays.contains(dateTime.toLocalDate())) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
            
            <span class="hljs-comment">// 检查时间是否在营业时间内（假设9:00-18:00）</span>
            <span class="hljs-type">LocalTime</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> dateTime.toLocalTime();
            <span class="hljs-keyword">return</span> !time.isBefore(LocalTime.of(<span class="hljs-number">9</span>, <span class="hljs-number">0</span>)) &amp;&amp; 
                   !time.isAfter(LocalTime.of(<span class="hljs-number">18</span>, <span class="hljs-number">0</span>));
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 日期时间API最佳实践 ==="</span>);
        
        <span class="hljs-comment">// 运行性能测试</span>
        DateTimeBenchmark.benchmarkFormatting();
        DateTimeBenchmark.benchmarkComparison();
        
        <span class="hljs-comment">// 演示实用工具方法</span>
        System.out.println(<span class="hljs-string">"\n=== 实用工具方法演示 ==="</span>);
        
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">today</span> <span class="hljs-operator">=</span> LocalDate.now();
        System.out.println(<span class="hljs-string">"今天: "</span> + today);
        System.out.println(<span class="hljs-string">"下一个工作日: "</span> + DateTimeUtils.getNextWorkingDay(today));
        
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> today.minusDays(<span class="hljs-number">30</span>);
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> today.plusDays(<span class="hljs-number">30</span>);
        System.out.printf(<span class="hljs-string">"%s 到 %s 之间的工作日: %d天%n"</span>, 
            start, end, DateTimeUtils.calculateWorkingDays(start, end));
        
        <span class="hljs-comment">// 测试安全解析</span>
        String[] testDates = {<span class="hljs-string">"2023-11-15"</span>, <span class="hljs-string">"15/11/2023"</span>, <span class="hljs-string">"2023.11.15"</span>, <span class="hljs-string">"无效日期"</span>};
        <span class="hljs-keyword">for</span> (String testDate : testDates) {
            Optional&lt;LocalDate&gt; parsed = DateTimeUtils.safeParseDate(testDate);
            System.out.printf(<span class="hljs-string">"解析 '%s': %s%n"</span>, 
                testDate, 
                parsed.map(LocalDate::toString).orElse(<span class="hljs-string">"解析失败"</span>));
        }
        
        <span class="hljs-comment">// 演示缓存系统</span>
        System.out.println(<span class="hljs-string">"\n=== 线程安全格式化演示 ==="</span>);
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);
        List&lt;Future&lt;String&gt;&gt; futures = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> i;
            futures.add(executor.submit(() -&gt; 
                ThreadSafeFormatter.format(LocalDateTime.now(), <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>) + 
                <span class="hljs-string">" - 线程"</span> + index
            ));
        }
        
        <span class="hljs-keyword">for</span> (Future&lt;String&gt; future : futures) {
            <span class="hljs-keyword">try</span> {
                System.out.println(future.get());
            } <span class="hljs-keyword">catch</span> (Exception e) {
                e.printStackTrace();
            }
        }
        
        executor.shutdown();
    }
}
</code></pre>
<h2 data-id="heading-19">总结：Java 8日期时间API的核心要点</h2>
<h3 data-id="heading-20">主要优势</h3>
<ol>
<li><strong>不可变性</strong>：所有核心类都是不可变的，线程安全</li>
<li><strong>清晰的API设计</strong>：分离了日期、时间、时区等概念</li>
<li><strong>强大的时区支持</strong>：内置完善的时区处理机制</li>
<li><strong>流畅的链式调用</strong>：代码更易读、更易写</li>
<li><strong>ISO标准兼容</strong>：默认使用ISO-8601标准</li>
</ol>
<h3 data-id="heading-21">常见使用场景</h3>













































<table><thead><tr><th>场景</th><th>推荐使用的类</th><th>说明</th></tr></thead><tbody><tr><td>只处理日期</td><td>LocalDate</td><td>生日、纪念日、截止日期</td></tr><tr><td>只处理时间</td><td>LocalTime</td><td>营业时间、会议时间</td></tr><tr><td>日期+时间</td><td>LocalDateTime</td><td>日志时间、创建时间</td></tr><tr><td>跨时区应用</td><td>ZonedDateTime</td><td>国际会议、航班时间</td></tr><tr><td>时间点/时间戳</td><td>Instant</td><td>性能测量、缓存过期</td></tr><tr><td>时间段（时间）</td><td>Duration</td><td>电影时长、任务耗时</td></tr><tr><td>时间段（日期）</td><td>Period</td><td>年龄、订阅期限</td></tr></tbody></table>
<h3 data-id="heading-22">迁移指南（从传统API迁移）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MigrationGuide</span> {
    
    <span class="hljs-comment">// 传统API -&gt; Java 8 API的迁移</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">migrateFromLegacy</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"=== 从传统API迁移到Java 8 API ==="</span>);
        
        <span class="hljs-comment">// 1. Date -&gt; Instant/LocalDateTime</span>
        java.util.<span class="hljs-type">Date</span> <span class="hljs-variable">oldDate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.Date();
        <span class="hljs-type">Instant</span> <span class="hljs-variable">instant</span> <span class="hljs-operator">=</span> oldDate.toInstant();
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">localDateTime</span> <span class="hljs-operator">=</span> LocalDateTime.ofInstant(instant, ZoneId.systemDefault());
        System.out.println(<span class="hljs-string">"Date -&gt; LocalDateTime: "</span> + localDateTime);
        
        <span class="hljs-comment">// 2. Calendar -&gt; ZonedDateTime</span>
        <span class="hljs-type">Calendar</span> <span class="hljs-variable">calendar</span> <span class="hljs-operator">=</span> Calendar.getInstance();
        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">zonedDateTime</span> <span class="hljs-operator">=</span> ZonedDateTime.ofInstant(
            calendar.toInstant(),
            calendar.getTimeZone().toZoneId()
        );
        System.out.println(<span class="hljs-string">"Calendar -&gt; ZonedDateTime: "</span> + zonedDateTime);
        
        <span class="hljs-comment">// 3. SimpleDateFormat -&gt; DateTimeFormatter</span>
        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">sdf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">"yyyy-MM-dd"</span>);
        <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd"</span>);
        System.out.println(<span class="hljs-string">"格式化: "</span> + formatter.format(LocalDate.now()));
        
        <span class="hljs-comment">// 4. 时间运算的迁移</span>
        calendar.add(Calendar.DAY_OF_MONTH, <span class="hljs-number">7</span>);
        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">sevenDaysLater</span> <span class="hljs-operator">=</span> zonedDateTime.plusDays(<span class="hljs-number">7</span>);
        System.out.println(<span class="hljs-string">"7天后: "</span> + sevenDaysLater);
        
        <span class="hljs-comment">// 5. 时间比较的迁移</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isBefore</span> <span class="hljs-operator">=</span> calendar.before(Calendar.getInstance());
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isBefore8</span> <span class="hljs-operator">=</span> zonedDateTime.isBefore(ZonedDateTime.now());
        System.out.println(<span class="hljs-string">"时间比较: "</span> + isBefore8);
    }
    
    <span class="hljs-comment">// 常见陷阱和解决方案</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commonPitfalls</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"\n=== 常见陷阱和解决方案 ==="</span>);
        
        <span class="hljs-comment">// 陷阱1：时区处理不当</span>
        System.out.println(<span class="hljs-string">"\n陷阱1：时区处理"</span>);
        System.out.println(<span class="hljs-string">"❌ LocalDateTime.now() 不包含时区信息"</span>);
        System.out.println(<span class="hljs-string">"✅ 使用 ZonedDateTime.now() 或指定时区"</span>);
        
        <span class="hljs-comment">// 陷阱2：忽略不可变性</span>
        System.out.println(<span class="hljs-string">"\n陷阱2：忽略不可变性"</span>);
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> LocalDate.of(<span class="hljs-number">2023</span>, <span class="hljs-number">11</span>, <span class="hljs-number">15</span>);
        date.plusDays(<span class="hljs-number">1</span>); <span class="hljs-comment">// 这个方法返回新对象，不修改原对象</span>
        System.out.println(<span class="hljs-string">"date.plusDays(1) 后，原date未改变: "</span> + date);
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">newDate</span> <span class="hljs-operator">=</span> date.plusDays(<span class="hljs-number">1</span>);
        System.out.println(<span class="hljs-string">"需要接收返回值: "</span> + newDate);
        
        <span class="hljs-comment">// 陷阱3：格式化模式错误</span>
        System.out.println(<span class="hljs-string">"\n陷阱3：格式化模式"</span>);
        System.out.println(<span class="hljs-string">"❌ yyyy-MM-dd HH:mm:ss - 24小时制"</span>);
        System.out.println(<span class="hljs-string">"❌ yyyy-MM-dd hh:mm:ss - 12小时制（需要a表示上午/下午）"</span>);
        System.out.println(<span class="hljs-string">"✅ yyyy-MM-dd HH:mm:ss - 24小时制"</span>);
        System.out.println(<span class="hljs-string">"✅ yyyy-MM-dd hh:mm:ss a - 12小时制"</span>);
        
        <span class="hljs-comment">// 陷阱4：解析严格性</span>
        System.out.println(<span class="hljs-string">"\n陷阱4：解析严格性"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">dateStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"2023-02-31"</span>; <span class="hljs-comment">// 2月31日不存在</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">LocalDate</span> <span class="hljs-variable">date2</span> <span class="hljs-operator">=</span> LocalDate.parse(dateStr);
            System.out.println(<span class="hljs-string">"宽松解析: "</span> + date2);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.out.println(<span class="hljs-string">"默认严格解析失败: "</span> + e.getMessage());
        }
    }
    
    <span class="hljs-comment">// 性能最佳实践总结</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performanceBestPractices</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"\n=== 性能最佳实践 ==="</span>);
        
        System.out.println(<span class="hljs-string">"1. 重用DateTimeFormatter"</span>);
        System.out.println(<span class="hljs-string">"   ✅ 将格式化器声明为静态常量"</span>);
        System.out.println(<span class="hljs-string">"   ❌ 避免在循环中创建新的格式化器"</span>);
        
        System.out.println(<span class="hljs-string">"\n2. 使用正确的数据结构"</span>);
        System.out.println(<span class="hljs-string">"   ✅ 对于时间序列数据，考虑使用long数组存储时间戳"</span>);
        System.out.println(<span class="hljs-string">"   ❌ 避免存储大量LocalDateTime对象"</span>);
        
        System.out.println(<span class="hljs-string">"\n3. 高效的时间比较"</span>);
        System.out.println(<span class="hljs-string">"   ✅ 对于批量比较，转换为epochDay或时间戳进行比较"</span>);
        System.out.println(<span class="hljs-string">"   ❌ 避免在循环中多次调用isBefore/isAfter"</span>);
        
        System.out.println(<span class="hljs-string">"\n4. 时区处理优化"</span>);
        System.out.println(<span class="hljs-string">"   ✅ 如果不需要时区信息，使用LocalDateTime而不是ZonedDateTime"</span>);
        System.out.println(<span class="hljs-string">"   ✅ 避免不必要的时区转换"</span>);
        System.out.println(<span class="hljs-string">"   ❌ 不要在性能关键路径中频繁转换时区"</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        migrateFromLegacy();
        commonPitfalls();
        performanceBestPractices();
        
        System.out.println(<span class="hljs-string">"\n=== 学习资源推荐 ==="</span>);
        System.out.println(<span class="hljs-string">"1. Oracle官方教程: Java Date Time"</span>);
        System.out.println(<span class="hljs-string">"2. 书籍: 《Java 8 in Action》"</span>);
        System.out.println(<span class="hljs-string">"3. 在线练习: codingbat.com/java/Date-Time"</span>);
        System.out.println(<span class="hljs-string">"4. 开源项目: Joda-Time (Java 8日期时间API的前身)"</span>);
        
        System.out.println(<span class="hljs-string">"\n记住：熟练掌握Java 8日期时间API是现代Java开发的必备技能！"</span>);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 21虚拟线程与平台线程：JVM层面的深度对比与实现原理]]></title>    <link>https://juejin.cn/post/7582787460419371050</link>    <guid>https://juejin.cn/post/7582787460419371050</guid>    <pubDate>2025-12-13T06:06:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582787460419371050" data-draft-id="7582813955212820521" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 21虚拟线程与平台线程：JVM层面的深度对比与实现原理"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-13T06:06:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 21虚拟线程与平台线程：JVM层面的深度对比与实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T06:06:43.000Z" title="Sat Dec 13 2025 06:06:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">引言：线程演进的新篇章</h2>
<p>在Java并发编程的发展历程中，线程始终是核心概念。从早期的绿色线程到如今的操作系统线程，Java一直在寻求并发性能与资源效率的平衡点。Java 21引入的虚拟线程（Virtual Threads）标志着并发编程模式的重大转变。本文将深入JVM层面，解析虚拟线程与传统平台线程的本质区别、实现机制及适用场景。</p>
<h2 data-id="heading-1">一、线程模型的根本差异</h2>
<h3 data-id="heading-2">1.1 平台线程：操作系统资源的直接映射</h3>
<p>传统平台线程（Platform Threads）本质上是操作系统线程的包装器，每个Java平台线程直接对应一个操作系统内核线程：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 传统平台线程创建 - 每个都是昂贵的OS资源</span>
<span class="hljs-type">Thread</span> <span class="hljs-variable">platformThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    System.out.println(<span class="hljs-string">"平台线程运行在OS线程: "</span> + Thread.currentThread());
});
platformThread.start();

<span class="hljs-comment">// 线程池中的平台线程</span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);
</code></pre>
<p><strong>JVM层面的实现细节：</strong></p>
<ul>
<li>每个平台线程在JVM中对应一个<code>java.lang.Thread</code>实例</li>
<li>在HotSpot JVM中，JavaThread对象与OS线程一一绑定</li>
<li>线程栈大小默认1MB（64位JVM），占用连续虚拟内存</li>
<li>上下文切换涉及完整的CPU寄存器保存/恢复</li>
</ul>
<h3 data-id="heading-3">1.2 虚拟线程：用户模式的轻量级抽象</h3>
<p>虚拟线程是JVM管理的轻量级线程，多个虚拟线程可以复用同一个平台线程：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 虚拟线程创建 - 轻量级且数量可扩展</span>
<span class="hljs-type">Thread</span> <span class="hljs-variable">virtualThread</span> <span class="hljs-operator">=</span> Thread.startVirtualThread(() -&gt; {
    System.out.println(<span class="hljs-string">"虚拟线程运行在载体线程: "</span> + Thread.currentThread());
});

<span class="hljs-comment">// 使用虚拟线程的ExecutorService</span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">virtualExecutor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor();
</code></pre>
<p><strong>JVM层面的革新：</strong></p>
<ul>
<li>虚拟线程是<code>java.lang.VirtualThread</code>的实例</li>
<li>栈帧可根据需要动态分配（栈块链式结构）</li>
<li>挂起时保存少量上下文到堆内存</li>
<li>由ForkJoinPool作为默认载体调度器</li>
</ul>
<h2 data-id="heading-4">二、内存结构与调度机制对比</h2>
<h3 data-id="heading-5">2.1 栈内存管理的革命性变化</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 演示虚拟线程栈的弹性特性</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StackDepthDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 虚拟线程支持深度递归而无需担心栈溢出</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">vThread</span> <span class="hljs-operator">=</span> Thread.startVirtualThread(() -&gt; {
            recursiveMethod(<span class="hljs-number">10000</span>); <span class="hljs-comment">// 深度递归</span>
        });
        
        <span class="hljs-comment">// 平台线程同样深度可能导致StackOverflowError</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">pThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            recursiveMethod(<span class="hljs-number">10000</span>); <span class="hljs-comment">// 风险较高</span>
        });
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recursiveMethod</span><span class="hljs-params">(<span class="hljs-type">int</span> depth)</span> {
        <span class="hljs-keyword">if</span> (depth == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
        recursiveMethod(depth - <span class="hljs-number">1</span>);
    }
}
</code></pre>
<p><strong>内存结构差异：</strong></p>






























<table><thead><tr><th>特性</th><th>平台线程</th><th>虚拟线程</th></tr></thead><tbody><tr><td>栈分配</td><td>连续虚拟内存预分配</td><td>堆内存中的栈块链表</td></tr><tr><td>栈大小</td><td>固定（默认1MB）</td><td>按需增长/缩小</td></tr><tr><td>内存开销</td><td>~1MB + 元数据</td><td>初始~200-300字节</td></tr><tr><td>GC影响</td><td>栈根直接扫描</td><td>通过载体线程间接管理</td></tr></tbody></table>
<h3 data-id="heading-6">2.2 调度器架构的JVM实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义虚拟线程调度器</span>
<span class="hljs-keyword">import</span> java.util.concurrent.*;
<span class="hljs-keyword">import</span> java.util.concurrent.atomic.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomVirtualThreadScheduler</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// JVM内部调度器实现概览</span>
        <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">scheduler</span> <span class="hljs-operator">=</span> Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);
        
        <span class="hljs-type">ThreadFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> Thread.ofVirtual()
            .scheduler(scheduler)  <span class="hljs-comment">// 自定义调度器</span>
            .factory();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
            <span class="hljs-type">Thread</span> <span class="hljs-variable">vThread</span> <span class="hljs-operator">=</span> factory.newThread(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    Thread.sleep(<span class="hljs-number">100</span>); <span class="hljs-comment">// 挂起点 - 虚拟线程可能被卸载</span>
                    System.out.println(<span class="hljs-string">"执行任务"</span>);
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            });
            vThread.start();
        }
    }
}
</code></pre>
<p><strong>调度机制对比表：</strong></p>






























<table><thead><tr><th>调度层面</th><th>平台线程调度</th><th>虚拟线程调度</th></tr></thead><tbody><tr><td>调度者</td><td>操作系统内核</td><td>JVM（ForkJoinPool）</td></tr><tr><td>上下文切换</td><td>内核模式切换（~1-10μs）</td><td>用户模式切换（~纳秒级）</td></tr><tr><td>抢占式</td><td>是</td><td>协作式（在挂起点）</td></tr><tr><td>优先级</td><td>操作系统优先级</td><td>无真正优先级概念</td></tr></tbody></table>
<h2 data-id="heading-7">三、JVM内部实现深度解析</h2>
<h3 data-id="heading-8">3.1 虚拟线程的状态机与挂起/恢复机制</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 虚拟线程状态转换演示</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualThreadStateDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 监控虚拟线程状态变化</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">vThread</span> <span class="hljs-operator">=</span> Thread.ofVirtual()
            .unstarted(() -&gt; {
                System.out.println(<span class="hljs-string">"状态: RUNNING"</span>);
                
                <span class="hljs-comment">// 挂起点1: I/O操作</span>
                <span class="hljs-keyword">try</span> {
                    System.out.println(<span class="hljs-string">"状态: PARKING (I/O)"</span>);
                    Thread.sleep(<span class="hljs-number">100</span>);  <span class="hljs-comment">// 虚拟线程在此挂起</span>
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
                
                <span class="hljs-comment">// 挂起点2: 锁获取</span>
                <span class="hljs-keyword">synchronized</span> (VirtualThreadStateDemo.class) {
                    System.out.println(<span class="hljs-string">"状态: RUNNING (临界区)"</span>);
                }
                
                System.out.println(<span class="hljs-string">"状态: TERMINATING"</span>);
            });
        
        System.out.println(<span class="hljs-string">"初始状态: "</span> + vThread.getState()); <span class="hljs-comment">// NEW</span>
        vThread.start();
        vThread.join();
    }
}
</code></pre>
<p><strong>JVM内部状态转换：</strong></p>
<ol>
<li><strong>NEW → RUNNABLE</strong>: 虚拟线程被调度到载体线程</li>
<li><strong>RUNNABLE → PARKING</strong>: 遇到阻塞操作（I/O、sleep、锁）</li>
<li><strong>PARKING → RUNNABLE</strong>: 阻塞操作完成，重新调度</li>
<li><strong>RUNNABLE → TERMINATED</strong>: 执行完成</li>
</ol>
<h3 data-id="heading-9">3.2 载体线程（Carrier Thread）的工作原理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 观察载体线程的复用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CarrierThreadObservation</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">carrierThreadId</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        List&lt;Thread&gt; virtualThreads = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        Set&lt;String&gt; carrierThreads = ConcurrentHashMap.newKeySet();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
            <span class="hljs-type">Thread</span> <span class="hljs-variable">vThread</span> <span class="hljs-operator">=</span> Thread.startVirtualThread(() -&gt; {
                <span class="hljs-comment">// 记录当前运行的载体线程</span>
                carrierThreads.add(Thread.currentThread().toString());
                
                <span class="hljs-keyword">try</span> {
                    Thread.sleep(<span class="hljs-number">50</span>); <span class="hljs-comment">// 虚拟线程挂起，载体线程可被其他虚拟线程使用</span>
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            });
            virtualThreads.add(vThread);
        }
        
        <span class="hljs-keyword">for</span> (Thread t : virtualThreads) {
            t.join();
        }
        
        System.out.println(<span class="hljs-string">"虚拟线程数: "</span> + virtualThreads.size());
        System.out.println(<span class="hljs-string">"使用的载体线程数: "</span> + carrierThreads.size());
        <span class="hljs-comment">// 通常: 载体线程数 &lt;&lt; 虚拟线程数</span>
    }
}
</code></pre>
<h2 data-id="heading-10">四、性能特征与适用场景</h2>
<h3 data-id="heading-11">4.1 并发规模与吞吐量对比</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 高并发场景性能测试</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcurrencyBenchmark</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TASK_COUNT</span> <span class="hljs-operator">=</span> <span class="hljs-number">100_000</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 平台线程池测试</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">platformTime</span> <span class="hljs-operator">=</span> testWithExecutor(
            Executors.newFixedThreadPool(<span class="hljs-number">1000</span>));
        
        <span class="hljs-comment">// 虚拟线程测试</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">virtualTime</span> <span class="hljs-operator">=</span> testWithExecutor(
            Executors.newVirtualThreadPerTaskExecutor());
        
        System.out.printf(<span class="hljs-string">"平台线程池时间: %dms%n"</span>, platformTime);
        System.out.printf(<span class="hljs-string">"虚拟线程时间: %dms%n"</span>, virtualTime);
        System.out.printf(<span class="hljs-string">"性能提升: %.2fx%n"</span>, 
            (<span class="hljs-type">double</span>)platformTime / virtualTime);
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">testWithExecutor</span><span class="hljs-params">(ExecutorService executor)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(TASK_COUNT);
        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; TASK_COUNT; i++) {
            executor.submit(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 模拟I/O密集型操作</span>
                    Thread.sleep(<span class="hljs-number">10</span>);
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                } <span class="hljs-keyword">finally</span> {
                    latch.countDown();
                }
            });
        }
        
        latch.await();
        executor.shutdown();
        <span class="hljs-keyword">return</span> System.currentTimeMillis() - start;
    }
}
</code></pre>
<h3 data-id="heading-12">4.2 适用场景指南</h3>



































<table><thead><tr><th>场景类型</th><th>推荐使用</th><th>原因分析</th></tr></thead><tbody><tr><td>I/O密集型</td><td>虚拟线程</td><td>高并发、频繁阻塞，虚拟线程挂起成本低</td></tr><tr><td>CPU密集型</td><td>平台线程</td><td>持续计算，虚拟线程切换无优势</td></tr><tr><td>低延迟系统</td><td>平台线程</td><td>虚拟线程调度可能引入不确定性</td></tr><tr><td>批量任务处理</td><td>虚拟线程</td><td>可创建大量并行任务，内存效率高</td></tr><tr><td>现有线程池</td><td>评估迁移</td><td>需重写同步代码为异步模式</td></tr></tbody></table>
<h2 data-id="heading-13">五、最佳实践与迁移策略</h2>
<h3 data-id="heading-14">5.1 线程本地存储（ThreadLocal）的挑战</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 虚拟线程中的ThreadLocal使用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualThreadLocalDemo</span> {
    <span class="hljs-comment">// 注意：虚拟线程中大量使用ThreadLocal可能导致内存泄漏</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;<span class="hljs-type">byte</span>[]&gt; THREAD_LOCAL_DATA = 
        ThreadLocal.withInitial(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>]);
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 在虚拟线程中使用ThreadLocal需谨慎</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10_000</span>; i++) {
            Thread.startVirtualThread(() -&gt; {
                <span class="hljs-comment">// 每个虚拟线程都有独立的ThreadLocal副本</span>
                <span class="hljs-type">byte</span>[] data = THREAD_LOCAL_DATA.get();
                
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 使用数据...</span>
                    Thread.sleep(<span class="hljs-number">10</span>);
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-comment">// 必须清理！否则数据会保留到虚拟线程终止</span>
                    THREAD_LOCAL_DATA.remove();
                }
            });
        }
        
        <span class="hljs-comment">// 替代方案：使用Scoped Values（Java 20+预览特性）</span>
        <span class="hljs-comment">// ScopedValue更适合虚拟线程模型</span>
    }
}
</code></pre>
<h3 data-id="heading-15">5.2 同步代码的优化策略</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 将同步阻塞代码重构为非阻塞模式</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SynchronizationOptimization</span> {
    <span class="hljs-comment">// 传统同步方法 - 在虚拟线程中可能阻塞载体线程</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">traditionalSyncMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 长时间操作会阻塞载体线程</span>
        performIOOperation();
    }
    
    <span class="hljs-comment">// 优化为虚拟线程友好的异步模式</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">asyncMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.runAsync(() -&gt; {
            performIOOperation();
        }, Thread.ofVirtual().factory());
    }
    
    <span class="hljs-comment">// 使用ReentrantLock替代synchronized</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lockBasedMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (lock.tryLock()) {  <span class="hljs-comment">// 非阻塞尝试</span>
            <span class="hljs-keyword">try</span> {
                performIOOperation();
            } <span class="hljs-keyword">finally</span> {
                lock.unlock();
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 执行替代逻辑或重试</span>
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performIOOperation</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟I/O操作</span>
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">100</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}
</code></pre>
<h2 data-id="heading-16">六、监控与诊断工具</h2>
<h3 data-id="heading-17">6.1 JFR（Java Flight Recorder）事件</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 启用虚拟线程相关的JFR事件</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualThreadMonitoring</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// JFR可以记录虚拟线程特定事件：</span>
        <span class="hljs-comment">// - jdk.VirtualThreadStart</span>
        <span class="hljs-comment">// - jdk.VirtualThreadEnd</span>
        <span class="hljs-comment">// - jdk.VirtualThreadPinned</span>
        <span class="hljs-comment">// - jdk.VirtualThreadSubmitFailed</span>
        
        <span class="hljs-type">Thread</span> <span class="hljs-variable">vThread</span> <span class="hljs-operator">=</span> Thread.startVirtualThread(() -&gt; {
            System.out.println(<span class="hljs-string">"虚拟线程执行中..."</span>);
            
            <span class="hljs-comment">// 当虚拟线程被固定在载体线程时触发事件</span>
            <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {  <span class="hljs-comment">// 可能导致pinned事件</span>
                System.out.println(<span class="hljs-string">"在同步块中执行"</span>);
            }
        });
        
        vThread.join();
        
        <span class="hljs-comment">// 使用jcmd或JMC查看JFR记录</span>
        <span class="hljs-comment">// jcmd &lt;pid&gt; JFR.start duration=60s filename=recording.jfr</span>
    }
}
</code></pre>
<h3 data-id="heading-18">6.2 线程转储分析</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 虚拟线程的线程转储格式示例</span>
<span class="hljs-string">"VirtualThread[#12345]/runnable@ForkJoinPool-1-worker-3"</span>
   java.base/java.lang.VirtualThread.run(VirtualThread.java:<span class="hljs-number">329</span>)
   com.example.MyClass.myMethod(MyClass.java:<span class="hljs-number">45</span>)
   
<span class="hljs-comment">// 关键信息：</span>
<span class="hljs-comment">// - 线程名称格式：VirtualThread[#id]/状态@载体线程</span>
<span class="hljs-comment">// - 栈跟踪显示实际执行点</span>
<span class="hljs-comment">// - 可以识别被固定的虚拟线程（pinned virtual threads）</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Paimon源码解读 -- Compaction-4.KeyValueFileStoreWrite]]></title>    <link>https://juejin.cn/post/7582872365522501670</link>    <guid>https://juejin.cn/post/7582872365522501670</guid>    <pubDate>2025-12-13T09:58:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582872365522501670" data-draft-id="7582872365522141222" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Paimon源码解读 -- Compaction-4.KeyValueFileStoreWrite"/> <meta itemprop="keywords" content="大数据,Flink"/> <meta itemprop="datePublished" content="2025-12-13T09:58:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="expect7g"/> <meta itemprop="url" content="https://juejin.cn/user/3514471387235735"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Paimon源码解读 -- Compaction-4.KeyValueFileStoreWrite
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3514471387235735/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    expect7g
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T09:58:51.000Z" title="Sat Dec 13 2025 09:58:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文重点介绍压缩中的<code>KeyValueFileStoreWrite</code>类，该类和compact很多流程都相关</p>
<h2 data-id="heading-1">一.KeyValueFileStoreWrite类</h2>
<p>该类的继承路线如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/122032eff8344237b75e871e1dde522a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZXhwZWN0N2c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766224731&amp;x-signature=NFZTIY8j8tT%2BRnEcilVpFpTZ1CY%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">1.代码解析</h3>
<h4 data-id="heading-3">(0) 核心参数</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Factory读写器工厂，根据具体的 partition 和 bucket 动态创建</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> KeyValueFileReaderFactory.Builder readerFactoryBuilder;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> KeyValueFileWriterFactory.Builder writerFactoryBuilder;
<span class="hljs-comment">// 三个关键比较器Supplier</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Supplier&lt;Comparator&lt;InternalRow&gt;&gt; keyComparatorSupplier; <span class="hljs-comment">// 主键比较器</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Supplier&lt;FieldsComparator&gt; udsComparatorSupplier; <span class="hljs-comment">// 自定义序列字段比较器，如sequnce-group和sequnce-field标记字段</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Supplier&lt;RecordEqualiser&gt; logDedupEqualSupplier; <span class="hljs-comment">// 日志相等比较器</span>
<span class="hljs-comment">// 合并函数工厂 - 根据配置的merge-engine，去创建不同的MergeFunction实现类</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MergeFunctionFactory&lt;KeyValue&gt; mfFactory;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CoreOptions options; <span class="hljs-comment">// CoreOptions配置</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> FileIO fileIO; <span class="hljs-comment">// 文件IO</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RowType keyType; <span class="hljs-comment">// Key的RowType信息</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RowType valueType; <span class="hljs-comment">// Value的RowType信息</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RowType partitionType; <span class="hljs-comment">// 分区信息</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String commitUser;
<span class="hljs-meta">@Nullable</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RecordLevelExpire recordLevelExpire; <span class="hljs-comment">// 记录Level的过期机制</span>
<span class="hljs-meta">@Nullable</span> <span class="hljs-keyword">private</span> Cache&lt;String, LookupFile&gt; lookupFileCache; <span class="hljs-comment">// lookup缓存</span>
</code></pre>
<h4 data-id="heading-4">(1) <code>bufferSpillable()</code> -- 是否允许write-buffer溢出磁盘</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@VisibleForTesting</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">bufferSpillable</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 由参数'write-buffer-spillable'绑定，没有则赋值为 (fileIO.isObjectStore() || !isStreamingMode)</span>
    <span class="hljs-keyword">return</span> options.writeBufferSpillable(fileIO.isObjectStore(), isStreamingMode);
}
</code></pre>
<h4 data-id="heading-5">(2) <code>createWriter()</code> -- 核心</h4>
<p>创建写入器的核心流程如下：</p>
<ol>
<li>创建<code>KeyValueFileWriterFactory对象</code> -- WriterFactory</li>
<li>根据主键比较器、存储文件、num-levels参数，去初始化 LSM Tree 层级结构，得到<code>Levels对象</code> -- levels</li>
<li>创建通用压缩策略<code>UniversalCompaction</code>，后续由该类的pick()去指定哪些文件该被压缩 (核心)</li>
</ol>
<blockquote>
<p>注意：通用压缩策略与下游四个参数有关，详情请看<a href="https://juejin.cn/editor/drafts/7582846276506632230" target="_blank" title="https://juejin.cn/editor/drafts/7582846276506632230">Paimon源码解读 -- Compaction-CompactStrategy</a></p>
<ul>
<li>参数'compaction.max-size-amplification-percent'绑定，默认200</li>
<li>参数'compaction.size-ratio'绑定，默认1</li>
<li>参数'num-sorted-run.compaction-trigger'绑定，默认5</li>
<li>参数'compaction.optimization-interval'绑定，没有默认值</li>
</ul>
</blockquote>
<ol start="4">
<li>选择压缩策略</li>
</ol>
<blockquote>
<p>如果needLookup()=true，则使用ForceUpLevel0Compaction强制L0压缩策略；否则，使用UniversalCompaction</p>
<p>规则如下: 下面任意一个为true，则needLookup()返回true</p>
<ol>
<li>merge-engine = first-row</li>
<li>changelog-producer = lookup</li>
<li>deletion-vectors.enabled = true</li>
<li>force-lookup = true</li>
</ol>
</blockquote>
<ol start="5">
<li>调<code>createCompactManager()</code>去创建对应的<code>CompactManager实现类</code></li>
<li>根据上面创建的所有参数，创建<code>MergeTreeWriter</code></li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建写入器Writer</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">protected</span> MergeTreeWriter <span class="hljs-title function_">createWriter</span><span class="hljs-params">(
        <span class="hljs-meta">@Nullable</span> Long snapshotId,
        BinaryRow partition,
        <span class="hljs-type">int</span> bucket,
        List&lt;DataFileMeta&gt; restoreFiles,
        <span class="hljs-type">long</span> restoredMaxSeqNumber,
        <span class="hljs-meta">@Nullable</span> CommitIncrement restoreIncrement,
        ExecutorService compactExecutor,
        <span class="hljs-meta">@Nullable</span> DeletionVectorsMaintainer dvMaintainer)</span> {
    <span class="hljs-keyword">if</span> (LOG.isDebugEnabled()) {
        LOG.debug(
                <span class="hljs-string">"Creating merge tree writer for partition {} bucket {} from restored files {}"</span>,
                partition,
                bucket,
                restoreFiles);
    }
    <span class="hljs-comment">// 步骤 1: 创建 KeyValueFileWriterFactory对象 -- WriterFactory</span>
    <span class="hljs-type">KeyValueFileWriterFactory</span> <span class="hljs-variable">writerFactory</span> <span class="hljs-operator">=</span>
            writerFactoryBuilder.build(partition, bucket, options);
    <span class="hljs-comment">// 步骤 2: 根据主键比较器、存储文件、num-levels参数，去初始化 LSM Tree 层级结构，得到Levels对象 -- levels</span>
    Comparator&lt;InternalRow&gt; keyComparator = keyComparatorSupplier.get();
    <span class="hljs-type">Levels</span> <span class="hljs-variable">levels</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Levels</span>(keyComparator, restoreFiles, options.numLevels());
    <span class="hljs-comment">// 步骤 3: 创建通用压缩策略UniversalCompaction，后续由该类的pick()去指定哪些文件该被压缩 (核心)</span>
    <span class="hljs-type">UniversalCompaction</span> <span class="hljs-variable">universalCompaction</span> <span class="hljs-operator">=</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">UniversalCompaction</span>(
                    options.maxSizeAmplificationPercent(),      <span class="hljs-comment">// 由参数'compaction.max-size-amplification-percent'绑定，默认200</span>
                    options.sortedRunSizeRatio(),               <span class="hljs-comment">// 由参数'compaction.size-ratio'绑定，默认1</span>
                    options.numSortedRunCompactionTrigger(),    <span class="hljs-comment">// 由参数'num-sorted-run.compaction-trigger'绑定，默认5</span>
                    options.optimizedCompactionInterval());     <span class="hljs-comment">// 由参数'compaction.optimization-interval'绑定，没有默认值</span>

    <span class="hljs-comment">/* 步骤 4: 如果needLookup()，则使用ForceUpLevel0Compaction强制L0压缩策略；否则，使用UniversalCompaction
        规则如下: 下面任意一个为true，则needLookup()返回true
        1. merge-engine = first-row
        2. changelog-producer = lookup
        3. deletion-vectors.enabled = true
        4. force-lookup = true
    */</span>
    <span class="hljs-type">CompactStrategy</span> <span class="hljs-variable">compactStrategy</span> <span class="hljs-operator">=</span>
            options.needLookup()
                    ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForceUpLevel0Compaction</span>(universalCompaction)
                    : universalCompaction;
    <span class="hljs-comment">// 步骤 5: 调createCompactManager()去创建对应的CompactManager实现类</span>
    <span class="hljs-type">CompactManager</span> <span class="hljs-variable">compactManager</span> <span class="hljs-operator">=</span>
            createCompactManager(
                    partition, bucket, compactStrategy, compactExecutor, levels, dvMaintainer);
    <span class="hljs-comment">// 步骤 6: 根据上面创建的所有参数，创建MergeTreeWriter()</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MergeTreeWriter</span>(
            bufferSpillable(),
            options.writeBufferSpillDiskSize(),
            options.localSortMaxNumFileHandles(),
            options.spillCompressOptions(),
            ioManager,
            compactManager,
            restoredMaxSeqNumber,
            keyComparator,
            mfFactory.create(),
            writerFactory,
            options.commitForceCompact(),
            options.changelogProducer(),
            restoreIncrement,
            UserDefinedSeqComparator.create(valueType, options));
}
</code></pre>
<h4 data-id="heading-6">(3) <code>createCompactManager()</code> -- 创建压缩管理器CompactManager</h4>
<p>CASE-1: write-only = true，用<code>NoopCompactManager</code>，不执行任何压缩操作<br/>
CASE-2: write-only = false，用<code>MergeTreeCompactManager</code>去管理压缩任务
关于这俩CompactManager实现类详情请看<a href="https://juejin.cn/post/7582872365522190374" target="_blank" title="https://juejin.cn/post/7582872365522190374">Paimon源码解读 -- Compaction-5.CompactManager</a></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> CompactManager <span class="hljs-title function_">createCompactManager</span><span class="hljs-params">(
        BinaryRow partition,
        <span class="hljs-type">int</span> bucket,
        CompactStrategy compactStrategy,
        ExecutorService compactExecutor,
        Levels levels,
        <span class="hljs-meta">@Nullable</span> DeletionVectorsMaintainer dvMaintainer)</span> {
    <span class="hljs-comment">// CASE-1: write-only = true，用NoopCompactManager，不执行任何压缩操作</span>
    <span class="hljs-keyword">if</span> (options.writeOnly()) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoopCompactManager</span>();
    }
    <span class="hljs-comment">// CASE-2: write-only = false，用MergeTreeCompactManager去管理压缩任务</span>
    <span class="hljs-keyword">else</span> {
        Comparator&lt;InternalRow&gt; keyComparator = keyComparatorSupplier.get();
        <span class="hljs-meta">@Nullable</span> <span class="hljs-type">FieldsComparator</span> <span class="hljs-variable">userDefinedSeqComparator</span> <span class="hljs-operator">=</span> udsComparatorSupplier.get();
        <span class="hljs-comment">// 创建CompactRewriter（核心重写器）</span>
        <span class="hljs-type">CompactRewriter</span> <span class="hljs-variable">rewriter</span> <span class="hljs-operator">=</span>
                createRewriter(
                        partition,
                        bucket,
                        keyComparator,
                        userDefinedSeqComparator,
                        levels,
                        dvMaintainer);
        <span class="hljs-comment">// 创建并返回 MergeTreeCompactManager</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MergeTreeCompactManager</span>(
                compactExecutor,
                levels,
                compactStrategy,
                keyComparator,
                options.compactionFileSize(<span class="hljs-literal">true</span>), <span class="hljs-comment">// target-file-size的70%这个是压缩的目标文件大小，以它为界限区分大文件和小文件</span>
                options.numSortedRunStopTrigger(),
                rewriter,
                compactionMetrics == <span class="hljs-literal">null</span>
                        ? <span class="hljs-literal">null</span>
                        : compactionMetrics.createReporter(partition, bucket),
                dvMaintainer,
                options.prepareCommitWaitCompaction());
    }
}
</code></pre>
<h4 data-id="heading-7">(4) <code>createRewriter()</code> -- 合并重写文件的核心入口</h4>
<p>流程如下：</p>
<ol>
<li>创建读写工厂</li>
<li>创建核心合并排序算法类<code>MergeSorter(这是核心)</code>，以及其他合并相关参数</li>
<li>分情况去创建MergeTreeCompactRewriter对象
<ul>
<li><strong>CASE-1: changelog-producer = full-compaction</strong>，创建并返回<code>FullChangelogMergeTreeCompactRewriter</code></li>
<li><strong>CASE-2: needLookup为true(规则在上面createWriter()已经介绍了)</strong>，进一步区分内部工厂，然后创建并返回<code>LookupMergeTreeCompactRewriter</code></li>
<li><strong>CASE-3: 默认情况</strong>，采用<code>MergeTreeCompactRewriter</code></li>
</ul>
</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 核心代码：合并重写文件的核心入口方法</span>
<span class="hljs-keyword">private</span> MergeTreeCompactRewriter <span class="hljs-title function_">createRewriter</span><span class="hljs-params">(
        BinaryRow partition,
        <span class="hljs-type">int</span> bucket,
        Comparator&lt;InternalRow&gt; keyComparator,
        <span class="hljs-meta">@Nullable</span> FieldsComparator userDefinedSeqComparator,
        Levels levels,
        <span class="hljs-meta">@Nullable</span> DeletionVectorsMaintainer dvMaintainer)</span> {
    DeletionVector.<span class="hljs-type">Factory</span> <span class="hljs-variable">dvFactory</span> <span class="hljs-operator">=</span> DeletionVector.factory(dvMaintainer);
    FileReaderFactory&lt;KeyValue&gt; readerFactory =
            readerFactoryBuilder.build(partition, bucket, dvFactory);
    <span class="hljs-keyword">if</span> (recordLevelExpire != <span class="hljs-literal">null</span>) {
        readerFactory = recordLevelExpire.wrap(readerFactory);
    }
    <span class="hljs-comment">// 步1. 创建读写工厂</span>
    <span class="hljs-type">KeyValueFileWriterFactory</span> <span class="hljs-variable">writerFactory</span> <span class="hljs-operator">=</span>
            writerFactoryBuilder.build(partition, bucket, options);
    <span class="hljs-comment">// 步2. 创建核心合并排序算法类MergeSorter(这是核心)，以及其他合并相关参数</span>
    <span class="hljs-type">MergeSorter</span> <span class="hljs-variable">mergeSorter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MergeSorter</span>(options, keyType, valueType, ioManager);
    <span class="hljs-type">int</span> <span class="hljs-variable">maxLevel</span> <span class="hljs-operator">=</span> options.numLevels() - <span class="hljs-number">1</span>;
    <span class="hljs-type">MergeEngine</span> <span class="hljs-variable">mergeEngine</span> <span class="hljs-operator">=</span> options.mergeEngine();
    <span class="hljs-type">ChangelogProducer</span> <span class="hljs-variable">changelogProducer</span> <span class="hljs-operator">=</span> options.changelogProducer();
    <span class="hljs-type">LookupStrategy</span> <span class="hljs-variable">lookupStrategy</span> <span class="hljs-operator">=</span> options.lookupStrategy();
    <span class="hljs-comment">// CASE-1: changelog-producer = full-compaction，创建并返回FullChangelogMergeTreeCompactRewriter</span>
    <span class="hljs-keyword">if</span> (changelogProducer.equals(FULL_COMPACTION)) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FullChangelogMergeTreeCompactRewriter</span>(
                maxLevel,
                mergeEngine,
                readerFactory,
                writerFactory,
                keyComparator,
                userDefinedSeqComparator,
                mfFactory,
                mergeSorter,
                logDedupEqualSupplier.get());
    }
    <span class="hljs-comment">// CASE-2: needLookup为true，进一步区分内部工厂，然后创建并返回LookupMergeTreeCompactRewriter</span>
    <span class="hljs-comment">/* 规则如下: 下面任意一个为true，则needLookup()返回true
        1. merge-engine = first-row
        2. changelog-producer = lookup
        3. deletion-vectors.enabled = true
        4. force-lookup = true
     */</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lookupStrategy.needLookup) {
        LookupLevels.ValueProcessor&lt;?&gt; processor;
        LookupMergeTreeCompactRewriter.MergeFunctionWrapperFactory&lt;?&gt; wrapperFactory;
        FileReaderFactory&lt;KeyValue&gt; lookupReaderFactory = readerFactory;
        <span class="hljs-comment">// SUB-CASE-1: merge-engine为first-row的不需要deletion-vectors.enabled为true</span>
        <span class="hljs-keyword">if</span> (lookupStrategy.isFirstRow) {
            <span class="hljs-keyword">if</span> (options.deletionVectorsEnabled()) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(
                        <span class="hljs-string">"First row merge engine does not need deletion vectors because there is no deletion of old data in this merge engine."</span>);
            }
            <span class="hljs-comment">// 创建简化的读取器（无需读取值，仅判断是否存在）</span>
            lookupReaderFactory =
                    readerFactoryBuilder
                            .copyWithoutProjection()
                            .withReadValueType(RowType.of())
                            .build(partition, bucket, dvFactory);
            processor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContainsValueProcessor</span>();
            wrapperFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FirstRowMergeFunctionWrapperFactory</span>(); <span class="hljs-comment">// 适配first-row合并逻辑</span>
        }
        <span class="hljs-comment">// SUB-CASE-2: 其他需要lookup的场景</span>
        <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 根据是否有删除向量，创建处理键值对位置/内容的处理器</span>
            processor =
                    lookupStrategy.deletionVector
                            ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">PositionedKeyValueProcessor</span>(
                                    valueType,
                                    lookupStrategy.produceChangelog
                                            || mergeEngine != DEDUPLICATE
                                            || !options.sequenceField().isEmpty())
                            : <span class="hljs-keyword">new</span> <span class="hljs-title class_">KeyValueProcessor</span>(valueType);
            <span class="hljs-comment">// 创建包装工厂（适配去重、序列比较等合并逻辑）</span>
            wrapperFactory =
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LookupMergeFunctionWrapperFactory</span>&lt;&gt;(
                            logDedupEqualSupplier.get(),
                            lookupStrategy,
                            UserDefinedSeqComparator.create(valueType, options));
        }
        <span class="hljs-comment">// 返回Lookup专用重写器</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LookupMergeTreeCompactRewriter</span>(
                maxLevel,
                mergeEngine,
                createLookupLevels(partition, bucket, levels, processor, lookupReaderFactory),
                readerFactory,
                writerFactory,
                keyComparator,
                userDefinedSeqComparator,
                mfFactory,
                mergeSorter,
                wrapperFactory,
                lookupStrategy.produceChangelog,
                dvMaintainer,
                options);
    }
    <span class="hljs-comment">// CASE-3: 默认情况，采用MergeTreeCompactRewriter</span>
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MergeTreeCompactRewriter</span>(
                readerFactory,
                writerFactory,
                keyComparator,
                userDefinedSeqComparator,
                mfFactory,
                mergeSorter);
    }
}
</code></pre>
<h4 data-id="heading-8">(5) <code>createLookupLevels()</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建Lookup层级</span>
<span class="hljs-keyword">private</span> &lt;T&gt; LookupLevels&lt;T&gt; <span class="hljs-title function_">createLookupLevels</span><span class="hljs-params">(
        BinaryRow partition,
        <span class="hljs-type">int</span> bucket,
        Levels levels,
        LookupLevels.ValueProcessor&lt;T&gt; valueProcessor,
        FileReaderFactory&lt;KeyValue&gt; readerFactory)</span> {
    <span class="hljs-comment">// 1. 检查临时磁盘目录</span>
    <span class="hljs-keyword">if</span> (ioManager == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(
                <span class="hljs-string">"Can not use lookup, there is no temp disk directory to use."</span>);
    }
    <span class="hljs-comment">// 2. 创建 LookupStoreFactory</span>
    <span class="hljs-type">LookupStoreFactory</span> <span class="hljs-variable">lookupStoreFactory</span> <span class="hljs-operator">=</span>
            LookupStoreFactory.create(
                    options,
                    cacheManager,
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">RowCompactedSerializer</span>(keyType).createSliceComparator());
    <span class="hljs-type">Options</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.options.toConfiguration();
    <span class="hljs-comment">// 3. 创建Lookup文件缓存</span>
    <span class="hljs-keyword">if</span> (lookupFileCache == <span class="hljs-literal">null</span>) {
        lookupFileCache =
                LookupFile.createCache(
                        options.get(CoreOptions.LOOKUP_CACHE_FILE_RETENTION), <span class="hljs-comment">// 由参数'lookup.cache-file-retention'绑定，默认1h</span>
                        options.get(CoreOptions.LOOKUP_CACHE_MAX_DISK_SIZE)); <span class="hljs-comment">// 由参数'lookup.cache-max-disk-size'绑定，默认Long最大值</span>
    }
    <span class="hljs-comment">// 4.创建并返回LookupLevels</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LookupLevels</span>&lt;&gt;(
            levels,
            keyComparatorSupplier.get(),
            keyType,
            valueProcessor,
            readerFactory::createRecordReader,
            file -&gt;
                    ioManager
                            .createChannel(
                                    localFilePrefix(partitionType, partition, bucket, file))
                            .getPathFile(),
            lookupStoreFactory,
            bfGenerator(options),
            lookupFileCache);
}
</code></pre>
<h2 data-id="heading-9">二.总结</h2>
<h3 data-id="heading-10">1.<code>KeyValueFileStoreWrite</code>总结</h3>
<p><code>KeyValueFileStoreWrite</code>是 Paimon Primary Key 表写入和压缩流程的<strong>中央协调者</strong>，承担以下核心职责：</p>
<ol>
<li><strong>Writer 生命周期管理</strong>：为每个 partition-bucket 创建、复用、销毁 <code>MergeTreeWriter</code></li>
<li><strong>压缩管理器工厂</strong>：根据 <code>write-only</code> 配置选择 <code>NoopCompactManager</code> 或 <code>MergeTreeCompactManager</code></li>
<li><strong>压缩重写器工厂</strong>：根据 changelog-producer、lookup 等配置选择最优的 <code>CompactRewriter</code></li>
<li><strong>内存池协调</strong>：继承 <code>MemoryFileStoreWrite</code> 的共享内存池和抢占机制</li>
</ol>
<h3 data-id="heading-11">2.三种重写器对比</h3>
<p>1. <strong>MergeTreeCompactRewriter</strong> (标准重写器)</p>
<ul>
<li><strong>适用场景</strong>: 标准的 Primary Key 表，无特殊优化需求</li>
<li><strong>核心流程</strong>:
读取 SortedRuns → 归并排序 → 应用 MergeFunction → 写入新文件</li>
<li><strong>特点</strong>:
<ul>
<li>简单高效</li>
<li>适合大部分场景</li>
<li>在 <code>rewriteCompaction()</code> 中实现核心逻辑</li>
</ul>
</li>
</ul>
<p>2. <strong>FullChangelogMergeTreeCompactRewriter</strong> (全量 Changelog 重写器)</p>
<ul>
<li><strong>适用场景</strong>: <code>changelog-producer = full-compaction</code></li>
<li><strong>核心特性</strong>:
<ul>
<li>只在最高层级 (maxLevel) 生成 changelog</li>
<li>使用 <code>FullChangelogMergeFunctionWrapper</code> 包装合并函数</li>
<li>判断逻辑在 <code>rewriteChangelog()</code> 中</li>
</ul>
</li>
<li><strong>升级策略</strong>:
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> UpgradeStrategy <span class="hljs-title function_">upgradeStrategy</span><span class="hljs-params">(<span class="hljs-type">int</span> outputLevel, DataFileMeta file)</span> {
    <span class="hljs-keyword">return</span> outputLevel == maxLevel ? 
        CHANGELOG_NO_REWRITE :  <span class="hljs-comment">// 最高层: 生成 changelog, 不重写</span>
        NO_CHANGELOG_NO_REWRITE; <span class="hljs-comment">// 其他层: 不生成, 不重写</span>
}
</code></pre>
</li>
</ul>
<p>3. <strong>LookupMergeTreeCompactRewriter</strong> (Lookup 优化重写器)</p>
<ul>
<li><strong>适用场景</strong>:
<ul>
<li><code>lookup.cache-rows &gt; 0</code> 或 <code>lookup.cache-file-retention &gt; 0</code></li>
<li>需要通过 Lookup 加速查询</li>
</ul>
</li>
<li><strong>核心机制</strong>:
<ul>
<li>构建 <code>LookupLevels</code> 用于快速查找</li>
<li>支持两种处理器:
<ul>
<li><strong>FirstRowMergeFunctionWrapperFactory</strong>: 只保留首行</li>
<li><strong>LookupMergeFunctionWrapperFactory</strong>: 标准 Lookup 合并</li>
</ul>
</li>
<li>使用 <code>createLookupLevels()</code> 创建 Lookup 层级</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[金融行业数据库选型盘点——Kingbase PLSQL迁移指南]]></title>    <link>https://juejin.cn/post/7582890166357131290</link>    <guid>https://juejin.cn/post/7582890166357131290</guid>    <pubDate>2025-12-13T08:12:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582890166357131290" data-draft-id="7582815307440357427" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="金融行业数据库选型盘点——Kingbase PLSQL迁移指南"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-12-13T08:12:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            金融行业数据库选型盘点——Kingbase PLSQL迁移指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T08:12:07.000Z" title="Sat Dec 13 2025 08:12:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>提起金融，电信，能源这些关键行业，Oracle依靠强大的PL/SQL生态和稳定性，称其为“老大哥”实至名归，长时间占据核心地位，但是，“信创”浪潮袭来，而且大家都想降本增效，所以，“去O”这件事可以说是十拿九稳。</p>
<p>然而到了真正的选型阶段，许多 CIO 和 架构师察觉到一个大坑：<strong>搬运数据并非难事，但业务逻辑的迁移却令人头疼不已</strong>，那些沉寂了数十年，代码量高达数万行的存储过程，包（Package），触发器，若要靠人力重新编写，财力将会快速耗尽，而且风险也无法掌控。</p>
<p>这一期的盘点活动，让我们深入探究国产数据库中的“学院派”典型——金仓数据库KingbaseES，探寻其为何称自己具备“硬核”的Oracle兼容能力，又是怎样被选为金融级核心系统替换之选的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0f874bca97344c08e16ce48599a104d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766218326&amp;x-signature=DXAO6x8CFh71ros41kI8oloLkQc%3D" alt="6afab92a91c68b0136e0917b049a9a1a.jpg" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、 为什么说“兼容性”是选型的生死线？</h2>
<p>在金融圈子里，核心业务逻辑那是高度依赖 Oracle 的“独门绝技”的。选型的时候你要是只盯着“支持 SQL 标准”看，后面绝对坑得你怀疑人生。要想真正做到“无缝迁移”，必须得闯过这三道关：</p>
<ol>
<li><strong>语法级兼容</strong>：光支持个标准 <code>SELECT</code> 哪够啊？像 <code>CONNECT BY</code>、<code>DECODE</code>、<code>PIVOT</code> 这些 Oracle 的“方言”，必须得能直接跑。</li>
<li><strong>对象级兼容</strong>：存储过程、函数、包、序列、同义词、视图这些东西，能不能直接导进去？</li>
<li><strong>行为级兼容</strong>：空串到底是不是 NULL？事务隔离级别是不是一个样？异常处理机制能不能对得上？</li>
</ol>
<p><strong>KingbaseES（KES）</strong> 毕竟是源自中国人民大学，作为“数据库国家队”，它手里最大的底牌之一，就是<strong>内核级的 Oracle 兼容引擎</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/911c95000d1a4a30a55998e29d750024~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766218326&amp;x-signature=MJOnfzjeIxZXI6jx8NgV99b8bfY%3D" alt="dd7f5fc10c7baf96d588767148905e4.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">二、 KingbaseES 核心技术盘点：硬核代码实测</h2>
<p>为了验证 KingbaseES 是不是真的像它说的那么能打，我们专门挑了几个金融场景里最让人头疼的迁移痛点，来了一场实测。</p>
<h3 data-id="heading-2">1. 层次查询（Hierarchical Query）</h3>
<p><strong>痛点</strong>：银行的机构树、账户层级，那都是 Oracle <code>CONNECT BY</code> 语法的重灾区。很多国产数据库都要求改写成 <code>WITH RECURSIVE</code>（递归 CTE），这要是改起来，代码量大得吓人。</p>
<p><strong>KingbaseES 表现</strong>：<strong>原生就支持，代码一个字都不用改。</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 准备测试数据</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> branch_offices (
    org_id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    org_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    parent_org_id <span class="hljs-type">INT</span>
);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> branch_offices <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'总行'</span>, <span class="hljs-keyword">NULL</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> branch_offices <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">101</span>, <span class="hljs-string">'北京分行'</span>, <span class="hljs-number">1</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> branch_offices <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">102</span>, <span class="hljs-string">'上海分行'</span>, <span class="hljs-number">1</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> branch_offices <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">10101</span>, <span class="hljs-string">'海淀支行'</span>, <span class="hljs-number">101</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> branch_offices <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">10201</span>, <span class="hljs-string">'浦东支行'</span>, <span class="hljs-number">102</span>);
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 2. 执行 Oracle 兼容的层次查询</span>
<span class="hljs-keyword">SELECT</span> 
    org_id, 
    org_name, 
    PRIOR org_name <span class="hljs-keyword">AS</span> parent_name, 
    LEVEL
<span class="hljs-keyword">FROM</span> branch_offices
<span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> parent_org_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>
<span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">BY</span> PRIOR org_id <span class="hljs-operator">=</span> parent_org_id
<span class="hljs-keyword">ORDER</span> SIBLINGS <span class="hljs-keyword">BY</span> org_name;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/947b8f8a96334785ba1ede0960c4e9d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766218326&amp;x-signature=FRdFuOilTXuZZq6E%2FAk%2FNxL%2BZBI%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p><strong>点评</strong>：在 KingbaseES 里，上面这段 SQL 直接就能跑，不需要做任何转换。这对于那些有着复杂层级关系的金融系统来说，简直是救命稻草，价值千金。</p>
</blockquote>
<h3 data-id="heading-3">2. 专有函数与空值处理</h3>
<p><strong>痛点</strong>：Oracle 里的 <code>DECODE</code>、<code>NVL2</code> 简直是无处不在。而且 Oracle 有个怪癖，它把 <code>''</code>（空串）当成 <code>NULL</code>，但标准 SQL 里这俩可是不一样的。如果数据库行为对不上，查出来的结果那就是两码事了。</p>
<p><strong>KingbaseES 表现</strong>：<strong>完美复刻了 Oracle 的这些行为。</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 准备测试数据</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customers (
    cust_id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">10</span>), <span class="hljs-comment">-- 推荐使用 VARCHAR，避免 CHAR(bpchar) 可能导致的函数参数匹配问题</span>
    risk_rating <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">10</span>),
    mobile_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)
);

<span class="hljs-comment">-- 插入数据：注意第二条数据的 mobile_no 是空串 ''</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customers <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'1'</span>, <span class="hljs-string">'High'</span>, <span class="hljs-string">'13800138000'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customers <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>, <span class="hljs-keyword">NULL</span>, <span class="hljs-string">''</span>); <span class="hljs-comment">-- Oracle模式下 '' 被存为 NULL</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customers <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">'9'</span>, <span class="hljs-string">'Low'</span>, <span class="hljs-string">'13900139000'</span>);
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 2. 执行查询：验证 DECODE、NVL2 及空串=NULL 的行为</span>
<span class="hljs-comment">-- 注意：请确保当前数据库为 Oracle 兼容模式 (database_mode='ORACLE')</span>
<span class="hljs-keyword">SELECT</span> 
    cust_id,
    DECODE(status, <span class="hljs-string">'1'</span>, <span class="hljs-string">'正常'</span>, <span class="hljs-string">'0'</span>, <span class="hljs-string">'冻结'</span>, <span class="hljs-string">'未知'</span>) <span class="hljs-keyword">AS</span> status_desc,
    NVL2(risk_rating, <span class="hljs-string">'已评级'</span>, <span class="hljs-string">'未评级'</span>) <span class="hljs-keyword">AS</span> rating_flag
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> mobile_no <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5b0dad5294947888865a0847738d351~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766218326&amp;x-signature=Kbun6q5ZYuEHVKl8qaLsMDBQo%2FM%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p><strong>点评</strong>：KingbaseES 通过调整参数（比如 <code>ora_input_emptystr_isnull</code>），能在内核层面直接模拟 Oracle 的空值处理逻辑，保证你的业务逻辑能够“原汁原味”地运行。</p>
</blockquote>
<h3 data-id="heading-4">3. PL/SQL 高级特性：包与异常处理</h3>
<p><strong>痛点</strong>：核心交易系统里，往往封装了一堆又一堆的 <code>PACKAGE</code>，里面全是私有变量、重载函数和自定义异常，复杂得很。</p>
<p><strong>KingbaseES 表现</strong>：支持 PL/SQL 块结构、<code>EXCEPTION</code> 捕获、<code>PRAGMA</code> 等高级特性，没在怕的。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 文件名: pkg_test.sql</span>

<span class="hljs-comment">-- 1. 准备表和数据</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> accounts;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> accounts (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    balance NUMBER(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>)
);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> accounts <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">101</span>, <span class="hljs-number">1000.00</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> accounts <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">102</span>, <span class="hljs-number">0.00</span>);
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 2. 创建包规范 (Package Specification)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE PACKAGE pkg_trans_logic <span class="hljs-keyword">IS</span>
    <span class="hljs-keyword">PROCEDURE</span> transfer(p_from <span class="hljs-type">INT</span>, p_to <span class="hljs-type">INT</span>, p_amount NUMBER);
<span class="hljs-keyword">END</span> pkg_trans_logic;
<span class="hljs-operator">/</span>

<span class="hljs-comment">-- 3. 创建包体 (Package Body)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE PACKAGE BODY pkg_trans_logic <span class="hljs-keyword">IS</span>
    <span class="hljs-comment">-- 私有变量</span>
    v_min_balance NUMBER :<span class="hljs-operator">=</span> <span class="hljs-number">100</span>;

    <span class="hljs-comment">-- 存储过程实现</span>
    <span class="hljs-keyword">PROCEDURE</span> transfer(p_from <span class="hljs-type">INT</span>, p_to <span class="hljs-type">INT</span>, p_amount NUMBER) <span class="hljs-keyword">IS</span>
    <span class="hljs-keyword">BEGIN</span>
        IF p_amount <span class="hljs-operator">&lt;</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
            RAISE_APPLICATION_ERROR(<span class="hljs-number">-20001</span>, <span class="hljs-string">'转账金额不能为负'</span>);
        <span class="hljs-keyword">END</span> IF;
        
        <span class="hljs-comment">-- 简单的转账逻辑</span>
        <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> p_amount <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> p_from;
        <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">+</span> p_amount <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> p_to;
        
        <span class="hljs-keyword">COMMIT</span>;
        DBMS_OUTPUT.PUT_LINE(<span class="hljs-string">'转账成功'</span>);
    EXCEPTION
        <span class="hljs-keyword">WHEN</span> OTHERS <span class="hljs-keyword">THEN</span>
            <span class="hljs-keyword">ROLLBACK</span>;
            DBMS_OUTPUT.PUT_LINE(<span class="hljs-string">'交易失败: '</span> <span class="hljs-operator">||</span> SQLERRM);
    <span class="hljs-keyword">END</span>;
<span class="hljs-keyword">END</span> pkg_trans_logic;
<span class="hljs-operator">/</span>

<span class="hljs-comment">-- 4. 调用测试</span>
<span class="hljs-keyword">BEGIN</span>
    pkg_trans_logic.transfer(<span class="hljs-number">101</span>, <span class="hljs-number">102</span>, <span class="hljs-number">200</span>);
<span class="hljs-keyword">END</span>;
<span class="hljs-operator">/</span>

<span class="hljs-comment">-- 5. 验证结果</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> accounts;
</code></pre>
<hr/>
<h2 data-id="heading-5">三、 迁移生态：从“能迁”到“好迁”</h2>
<p>光数据库兼容做得好还不够，KingbaseES 还备好了一套趁手的家伙事儿，号称“迁移三剑客”，把迁移门槛降得那是相当低。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0335ad83e9d4ee2af8178199fa88878~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766218326&amp;x-signature=cHippH7x65%2BEkzpyRYoarNB4dPY%3D" alt="image.png" loading="lazy"/></p>
<p><strong>KDMS（评定工具）</strong> 在开工前会自动扫描Oracle库，并给出一份“适配性评定报告”，该报告准确告知哪些代码需修改（譬如显示99%可自动转换，另有1%要人工调整）。</p>
<p><strong>KDTS（迁移工具）</strong> 具备高速搬运能力，它支持多线程并行迁移，对于大表会自动执行拆分，其速度非常快。 <strong>断点续传</strong>：网络不稳定也不怕，任务断了能接着传，不用从头来。</p>
<p><strong>KFS（同步工具）</strong> 依靠日志分析（CDC）技术，可以达成从Oracle向KingbaseES的即时增量同步。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99e3ffb052694792b7120572370529ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766218326&amp;x-signature=w%2F2wUzPeoyqZELAKqThye%2FzeyAM%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">*</span>   <span class="hljs-strong">**应用场景**</span>：在割接的窗口期，能保证新老库数据是一致的，支持“平滑切换”，万一有啥问题还能“回退”，给你留足了后路。
</code></pre>
<hr/>
<h2 data-id="heading-6">四、 繁荣生态：不仅仅是数据库</h2>
<p>选数据库，其实也是在选生态。电科金仓作为“国产数据库四小龙”之一，在生态建设这块儿走得可是相当靠前。</p>
<h3 data-id="heading-7">1. 强大的社区支持</h3>
<p>遇到技术难题不知道去哪问？</p>
<ul>
<li><strong>官方知识库</strong>：这里面涵盖了从安装部署到内核调优的海量实战案例，简直就是 DBA 的“避坑指南”。
<ul>
<li>🔗 <strong>推荐收藏</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbbs.kingbase.com.cn%2Fknowledge%2Fkes%2FKingbaseES%25E7%259F%25A5%25E8%25AF%2586%25E5%25BA%2593%2FKingbaseES%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%25E7%259F%25A5%25E8%25AF%2586%25E5%259B%25BE%25E8%25B0%25B1" target="_blank" title="https://bbs.kingbase.com.cn/knowledge/kes/KingbaseES%E7%9F%A5%E8%AF%86%E5%BA%93/KingbaseES%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1" ref="nofollow noopener noreferrer">KingbaseES 知识库</a></li>
</ul>
</li>
<li><strong>技术探索博客</strong>：这里汇聚了一帮资深专家的深度好文，从内核原理解析到行业最佳实践，内容那是相当有深度。
<ul>
<li>🔗 <strong>必读干货</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkingbase.com.cn%2Fexplore" target="_blank" title="https://kingbase.com.cn/explore" ref="nofollow noopener noreferrer">金仓技术探索</a></li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">2. 完备的认证体系</h3>
<p>为了解决人才不够用的问题，金仓推出了 <strong>KCA / KCP / KCM</strong> 三级认证体系，还在全国的高校和培训机构里大力推广。对于企业来说，这就意味着招人更容易了，后续的运维也有了保障。</p>
<h3 data-id="heading-9">3. 全面的产品家族</h3>
<p>针对金融行业各种各样的需求，金仓可不光有 KingbaseES，还有：</p>
<ul>
<li><strong>KingbaseES RAC</strong>：共享存储多活集群，直接对标 Oracle RAC，保你核心业务 7x24 小时都不带停机的。</li>
<li><strong>KStudio</strong>：图形化开发工具，让习惯了 PL/SQL Developer 的开发人员能无缝切换，上手就能干活。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bc797718a28493fb79c16916a635fa6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766218326&amp;x-signature=zT0bmwz6HXU3v4Znvy3KY4Ca%2B4o%3D" alt="image.png" loading="lazy"/></li>
</ul>
<hr/>
<h2 data-id="heading-10">五、 结语</h2>
<p>在“信创”这场重大考验当中，“金仓 KingbaseES”可说交上了一份高分试卷，其并非仅仅充当存储数据的容器，而是一整套包含有“高度契合内核 + 智能迁移工具 + 全面知识生态”的完备方案。</p>
<p>对于那些谋求“稳，快，准”迁移的金融和关键行业客户而言，KingbaseES 确实体现出自己是可信赖的“Oracle平替”，也是改良升级的不错之选。</p>
<blockquote>
<p><strong>想了解更多技术干货？</strong>
欢迎来金仓技术社区逛逛，和数万名开发者一起聊聊国产数据库的未来！
🌐 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkingbase.com.cn%2Fexplore" target="_blank" title="https://kingbase.com.cn/explore" ref="nofollow noopener noreferrer">kingbase.com.cn/explore</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RBAC 菜单查询的“标准写法”]]></title>    <link>https://juejin.cn/post/7582814236583772198</link>    <guid>https://juejin.cn/post/7582814236583772198</guid>    <pubDate>2025-12-13T02:29:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582814236583772198" data-draft-id="7582846276506058790" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RBAC 菜单查询的“标准写法”"/> <meta itemprop="keywords" content="MySQL"/> <meta itemprop="datePublished" content="2025-12-13T02:29:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张洪权"/> <meta itemprop="url" content="https://juejin.cn/user/1500154422651518"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RBAC 菜单查询的“标准写法”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1500154422651518/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张洪权
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T02:29:57.000Z" title="Sat Dec 13 2025 02:29:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、先看完整 SQL（原样）</h2>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">select</span> m.*
<span class="hljs-keyword">from</span> menu m
left <span class="hljs-keyword">join</span> role_menu rm <span class="hljs-keyword">on</span> rm.menu_id = m.id
<span class="hljs-keyword">where</span> rm.<span class="hljs-function">role_id <span class="hljs-title">in</span> (<span class="hljs-params">
  <span class="hljs-keyword">select</span> role_id <span class="hljs-keyword">from</span> user_role <span class="hljs-keyword">where</span> user_id = ?
</span>)
order <span class="hljs-keyword">by</span> m.parent_id, m.sort</span>;
</code></pre>
<hr/>
<h2 data-id="heading-1">二、先搞清楚 4 张表在干什么（非常关键）</h2>
<h3 data-id="heading-2">1️⃣ user（用户）</h3>
<pre><code class="hljs language-bash" lang="bash">user
┌────┬──────────┐
│ <span class="hljs-built_in">id</span> │ username │
└────┴──────────┘
</code></pre>
<hr/>
<h3 data-id="heading-3">2️⃣ role（角色）</h3>
<pre><code class="hljs language-bash" lang="bash">role
┌────┬──────────┐
│ <span class="hljs-built_in">id</span> │ role_code│
└────┴──────────┘
</code></pre>
<hr/>
<h3 data-id="heading-4">3️⃣ user_role（用户-角色关系）</h3>
<blockquote>
<p><strong>一个用户可以有多个角色</strong></p>
</blockquote>
<pre><code class="hljs">user_role
┌────────┬────────┐
│ user_id│ role_id│
└────────┴────────┘
</code></pre>
<hr/>
<h3 data-id="heading-5">4️⃣ menu（菜单）</h3>
<pre><code class="hljs language-bash" lang="bash">menu
┌────┬────────┬──────────┬─────────┬──────┐
│ <span class="hljs-built_in">id</span> │parent_id│ name     │ path    │ <span class="hljs-built_in">sort</span> │
└────┴────────┴──────────┴─────────┴──────┘
</code></pre>
<blockquote>
<p><code>parent_id</code> 用来表示菜单层级（父子菜单）</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">5️⃣ role_menu（角色-菜单关系）</h3>
<blockquote>
<p><strong>角色能访问哪些菜单</strong></p>
</blockquote>
<pre><code class="hljs">role_menu
┌────────┬────────┐
│ role_id│ menu_id│
└────────┴────────┘
</code></pre>
<hr/>
<h2 data-id="heading-7">三、整体一句话解释这条 SQL 在干嘛</h2>
<blockquote>
<p><strong>“查出某个用户 → 所有角色 → 能访问的所有菜单，并按菜单层级排序”</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-8">四、逐句拆解（重点）</h2>
<hr/>
<h3 data-id="heading-9">🔹 ① 子查询：先查用户有哪些角色</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">select</span> role_id <span class="hljs-keyword">from</span> user_role <span class="hljs-keyword">where</span> user_id = ?
</code></pre>
<h4 data-id="heading-10">假设：</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">user_id</span> = <span class="hljs-number">10</span>
</code></pre>
<h4 data-id="heading-11">user_role 表：</h4>

















<table><thead><tr><th>user_id</th><th>role_id</th></tr></thead><tbody><tr><td>10</td><td>1</td></tr><tr><td>10</td><td>2</td></tr></tbody></table>
<h4 data-id="heading-12">子查询结果：</h4>
<pre><code class="hljs language-scss" lang="scss">(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
</code></pre>
<p>👉 <strong>意思：这个用户有 2 个角色</strong></p>
<hr/>
<h3 data-id="heading-13">🔹 ② where rm.role_id in (...)</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">where</span> rm.role_id <span class="hljs-keyword">in</span> (1, 2)
</code></pre>
<p>👉 <strong>只要是角色 1 或 角色 2 拥有的菜单，都要</strong></p>
<hr/>
<h3 data-id="heading-14">🔹 ③ left join role_menu</h3>
<pre><code class="hljs language-bash" lang="bash">left <span class="hljs-built_in">join</span> role_menu <span class="hljs-built_in">rm</span> on rm.menu_id = m.id
</code></pre>
<h4 data-id="heading-15">作用一句话：</h4>
<blockquote>
<p><strong>把“菜单”和“角色-菜单关系”连起来</strong></p>
</blockquote>
<h4 data-id="heading-16">示例 role_menu 表：</h4>





















<table><thead><tr><th>role_id</th><th>menu_id</th></tr></thead><tbody><tr><td>1</td><td>101</td></tr><tr><td>1</td><td>102</td></tr><tr><td>2</td><td>103</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-17">🔹 ④ select m.*</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">select</span> m.*
</code></pre>
<p>👉 <strong>只要菜单字段，不关心 role_menu 的字段</strong></p>
<p>最终你得到的，是：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">menu</span> 表中的数据
</code></pre>
<hr/>
<h2 data-id="heading-18">五、整体执行流程（一步一步）</h2>
<h3 data-id="heading-19">🧠 数据库真实执行逻辑是这样的：</h3>
<h3 data-id="heading-20">Step 1️⃣：查用户角色</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">user_id</span> = <span class="hljs-number">10</span>
↓
角色 = <span class="hljs-section">[1, 2]</span>
</code></pre>
<hr/>
<h3 data-id="heading-21">Step 2️⃣：查这些角色能访问的菜单</h3>
<pre><code class="hljs language-css" lang="css">role <span class="hljs-number">1</span> → <span class="hljs-selector-tag">menu</span> <span class="hljs-number">101</span>, <span class="hljs-number">102</span>
role <span class="hljs-number">2</span> → <span class="hljs-selector-tag">menu</span> <span class="hljs-number">103</span>
</code></pre>
<hr/>
<h3 data-id="heading-22">Step 3️⃣：合并去重后菜单</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">menu</span> <span class="hljs-number">101</span>
<span class="hljs-selector-tag">menu</span> <span class="hljs-number">102</span>
<span class="hljs-selector-tag">menu</span> <span class="hljs-number">103</span>
</code></pre>
<hr/>
<h3 data-id="heading-23">Step 4️⃣：排序</h3>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> m.parent_id, m.sort
</code></pre>
<h4 data-id="heading-24">排序目的：</h4>
<ul>
<li>先按父菜单分组</li>
<li>再按菜单顺序排列</li>
</ul>
<p>👉 <strong>方便前端直接生成树形菜单</strong></p>
<hr/>
<h2 data-id="heading-25">六、为什么要用 <code>LEFT JOIN</code> 而不是 <code>INNER JOIN</code>？</h2>
<h3 data-id="heading-26">实际上：</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-operator">+</span> <span class="hljs-keyword">where</span> rm.role_id <span class="hljs-keyword">in</span> (...)
</code></pre>
<p>⬇️<br/>
<strong>效果等同于 INNER JOIN</strong></p>
<h3 data-id="heading-27">那为什么很多人还写 LEFT JOIN？</h3>
<p>1️⃣ 写法更通用<br/>
2️⃣ 以后可以扩展（比如允许空角色）<br/>
3️⃣ 历史代码习惯</p>
<p>👉 <strong>如果你愿意，完全可以改成：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">select</span> m.*
<span class="hljs-keyword">from</span> menu m
inner <span class="hljs-keyword">join</span> role_menu rm <span class="hljs-keyword">on</span> rm.menu_id = m.id
<span class="hljs-keyword">where</span> rm.<span class="hljs-function">role_id <span class="hljs-title">in</span> (<span class="hljs-params">
  <span class="hljs-keyword">select</span> role_id <span class="hljs-keyword">from</span> user_role <span class="hljs-keyword">where</span> user_id = ?
</span>)
order <span class="hljs-keyword">by</span> m.parent_id, m.sort</span>;
</code></pre>
<hr/>
<h2 data-id="heading-28">七、为什么不用三表直接 join？</h2>
<p>你也可以写成：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">select</span> <span class="hljs-keyword">distinct</span> m.*
<span class="hljs-keyword">from</span> user_role ur
<span class="hljs-keyword">join</span> role_menu rm <span class="hljs-keyword">on</span> rm.role_id = ur.role_id
<span class="hljs-keyword">join</span> menu m <span class="hljs-keyword">on</span> m.id = rm.menu_id
<span class="hljs-keyword">where</span> ur.user_id = ?
<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> m.parent_id, m.sort;
</code></pre>
<h3 data-id="heading-29">两种写法对比</h3>

















<table><thead><tr><th>写法</th><th>优点</th></tr></thead><tbody><tr><td>子查询 in</td><td>易读、好理解</td></tr><tr><td>多表 join</td><td>性能稍好、专业</td></tr></tbody></table>
<p>👉 <strong>中小项目两种都完全没问题</strong></p>
<hr/>
<h2 data-id="heading-30">八、最终返回的数据长什么样？</h2>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  {    <span class="hljs-string">"id"</span>: 1,    <span class="hljs-string">"parent_id"</span>: 0,    <span class="hljs-string">"name"</span>: <span class="hljs-string">"系统管理"</span>,    <span class="hljs-string">"path"</span>: <span class="hljs-string">"/system"</span>,    <span class="hljs-string">"sort"</span>: 1  },  {    <span class="hljs-string">"id"</span>: 2,    <span class="hljs-string">"parent_id"</span>: 1,    <span class="hljs-string">"name"</span>: <span class="hljs-string">"用户管理"</span>,    <span class="hljs-string">"path"</span>: <span class="hljs-string">"/system/user"</span>,    <span class="hljs-string">"sort"</span>: 1  }]</span>
</code></pre>
<p>前端可以 <strong>直接递归生成菜单树</strong></p>
<hr/>
<h2 data-id="heading-31">九、这条 SQL 在 RBAC 中的“地位”</h2>
<p>👉 <strong>90% 的后台系统，菜单查询就是这一类 SQL</strong></p>
<p>你学会这一条，就已经：</p>
<ul>
<li>✔ 理解了 RBAC 的核心</li>
<li>✔ 能独立设计菜单权限</li>
<li>✔ 看得懂大多数后台源码</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java并发编程基石：深入解析AQS原理与应用实战]]></title>    <link>https://juejin.cn/post/7582845425402347560</link>    <guid>https://juejin.cn/post/7582845425402347560</guid>    <pubDate>2025-12-13T03:06:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582845425402347560" data-draft-id="7582783931164327971" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java并发编程基石：深入解析AQS原理与应用实战"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-13T03:06:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="科威舟的代码笔记"/> <meta itemprop="url" content="https://juejin.cn/user/1732486058230174"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java并发编程基石：深入解析AQS原理与应用实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1732486058230174/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    科威舟的代码笔记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T03:06:05.000Z" title="Sat Dec 13 2025 03:06:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>[toc]</p>
<h2 data-id="heading-0">1 AQS概述：并发编程的基石</h2>
<p>AbstractQueuedSynchronizer（AQS）是Java并发包（java.util.concurrent.locks）的核心基础框架，为构建锁和同步器提供了可重用的基础设施。AQS通过<strong>模板方法模式</strong>让开发者能够基于状态和队列轻松构建各种同步器，如ReentrantLock、Semaphore、CountDownLatch等常见并发工具。</p>
<p>AQS的核心设计思想是：如果被请求的共享资源空闲，则将当前请求资源的线程设置为有效工作线程，并将共享资源设置为锁定状态；如果共享资源被占用，则需要一套线程阻塞等待以及被唤醒时锁分配的机制。这套机制通过<strong>CLH队列锁</strong>实现，将暂时获取不到锁的线程加入到队列中。</p>
<p>与传统的synchronized关键字相比，AQS具有显著优势：它由Java语言实现（而非C++），提供了更灵活的API，并且在锁竞争激烈的情况下提供了多种解决方案，性能表现更优。</p>
<h2 data-id="heading-1">2 AQS核心原理与架构设计</h2>
<h3 data-id="heading-2">2.1 核心组件：状态变量与同步队列</h3>
<p>AQS的核心架构围绕两个关键组件构建：<strong>同步状态（state）<strong>和</strong>等待队列</strong>。</p>
<p>**同步状态（state）**是一个volatile int类型的变量，表示共享资源的状态。其具体语义由子类定义，例如：</p>
<ul>
<li>在ReentrantLock中，state表示锁的重入次数</li>
<li>在Semaphore中，state表示可用的许可证数量</li>
<li>在CountDownLatch中，state表示未完成的计数</li>
</ul>
<p>AQS提供了三种原子操作方法来管理state：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getState</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> state; }
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setState</span><span class="hljs-params">(<span class="hljs-type">int</span> newState)</span> { state = newState; }
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSetState</span><span class="hljs-params">(<span class="hljs-type">int</span> expect, <span class="hljs-type">int</span> update)</span> {
    <span class="hljs-comment">// CAS操作，保证原子性</span>
}
</code></pre>
<p><strong>等待队列</strong>是AQS管理的CLH（Craig, Landin, and Hagersten）队列的变体，是一个<strong>FIFO双向链表</strong>，用于存储等待获取锁的线程。队列中的每个节点（Node）包含线程引用、等待状态以及前后指针。</p>
<h3 data-id="heading-3">2.2 节点状态与队列管理</h3>
<p>AQS队列中的节点存在多种等待状态，决定了线程的排队行为：</p>
<ul>
<li><strong>CANCELLED（1）</strong>：节点因超时或中断被取消，不再参与同步</li>
<li><strong>SIGNAL（-1）</strong>：后继节点需要被唤醒</li>
<li><strong>CONDITION（-2）</strong>：节点在条件队列中等待</li>
<li><strong>PROPAGATE（-3）</strong>：共享模式下状态变更需要传播</li>
<li><strong>0</strong>：初始状态</li>
</ul>
<p>AQS通过精细的队列管理机制实现高效的线程调度。当线程获取锁失败时，会被包装成Node节点加入队列尾部；当锁释放时，会唤醒队列中的合适节点。</p>
<h2 data-id="heading-4">3 AQS的两种同步模式</h2>
<h3 data-id="heading-5">3.1 独占模式（Exclusive Mode）</h3>
<p>独占模式下，同一时刻只有一个线程能获取同步状态，其他线程必须等待。ReentrantLock是独占模式的典型实现。</p>
<p><strong>获取锁流程（acquire）</strong>：</p>
<ol>
<li>调用tryAcquire()尝试直接获取资源（子类实现）</li>
<li>若成功，则线程继续执行</li>
<li>若失败，将线程包装为独占节点（Node.EXCLUSIVE）加入队列尾部</li>
<li>线程在队列中自旋或阻塞，直到被前驱节点唤醒</li>
<li>被唤醒后，检查前驱是否为头节点，是则尝试获取锁</li>
</ol>
<p><strong>释放锁流程（release）</strong>：</p>
<ol>
<li>调用tryRelease()尝试释放资源（子类实现）</li>
<li>若释放成功（state=0），检查后继节点是否需要唤醒</li>
<li>唤醒后继节点中的线程</li>
</ol>
<p>可重入性是独占模式的重要特性，通过state计数实现——每次重入state加1，释放时相应减1。</p>
<h3 data-id="heading-6">3.2 共享模式（Shared Mode）</h3>
<p>共享模式下，多个线程可以同时获取同步状态，适用于资源限流等场景。Semaphore、CountDownLatch是共享模式的典型实现。</p>
<p><strong>获取共享资源流程</strong>：</p>
<ol>
<li>调用tryAcquireShared()尝试获取资源</li>
<li>返回值表示获取结果：负数表示失败；0表示成功但无剩余资源；正数表示成功且有剩余资源</li>
<li>若失败，线程加入等待队列</li>
<li>成功获取资源后，若还有剩余资源，会唤醒后续共享节点</li>
</ol>
<p><strong>释放共享资源流程</strong>：</p>
<ol>
<li>调用tryReleaseShared()释放资源</li>
<li>若释放成功，唤醒所有可获取资源的后继节点</li>
</ol>
<p>共享模式支持<strong>传播机制</strong>，当资源可用时，会连续唤醒多个等待线程，提高吞吐量。</p>
<h3 data-id="heading-7">3.3 公平与非公平策略</h3>
<p>AQS支持公平与非公平两种调度策略：</p>
<ul>
<li><strong>公平锁</strong>：严格按照FIFO顺序分配锁，保证无饥饿现象</li>
<li><strong>非公平锁</strong>：新线程可插队尝试获取锁，提高吞吐量但可能导致饥饿</li>
</ul>
<p>ReentrantLock的两者实现差异主要在于tryAcquire()方法：公平锁先检查是否有等待线程，有则排队；非公平锁直接尝试CAS获取锁。</p>
<h2 data-id="heading-8">4 AQS源码关键流程解析</h2>
<h3 data-id="heading-9">4.1 独占模式获取资源源码分析</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (!tryAcquire(arg) &amp;&amp; 
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
</code></pre>
<p><strong>addWaiter方法</strong>将当前线程包装成Node节点并插入队列尾部：</p>
<ul>
<li>使用CAS操作确保尾节点插入的原子性</li>
<li>队列为空时进行初始化</li>
</ul>
<p><strong>acquireQueued方法</strong>是线程在队列中的核心逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">acquireQueued</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Node node, <span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-variable">failed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">interrupted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (;;) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> node.predecessor();
            <span class="hljs-keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) {
                setHead(node);
                p.next = <span class="hljs-literal">null</span>; <span class="hljs-comment">// help GC</span>
                failed = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> interrupted;
            }
            <span class="hljs-keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())
                interrupted = <span class="hljs-literal">true</span>;
        }
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (failed)
            cancelAcquire(node);
    }
}
</code></pre>
<p>此方法通过自旋方式，只有当前节点的前驱是头节点时才尝试获取锁，避免不必要的竞争。获取成功后，将当前节点设为新头节点（旧头节点出队）。</p>
<h3 data-id="heading-10">4.2 释放资源与唤醒机制</h3>
<p>释放资源时，AQS调用unparkSuccessor()唤醒合适的后继线程：</p>
<ul>
<li>从队列尾部向前遍历，找到离头节点最近的非取消状态节点</li>
<li>通过LockSupport.unpark()唤醒对应线程</li>
</ul>
<p>这种后向遍历机制确保即使存在取消节点也能找到有效后继。</p>
<h2 data-id="heading-11">5 AQS在Java并发工具中的应用</h2>
<h3 data-id="heading-12">5.1 标准同步器实现对比</h3>



































<table><thead><tr><th>同步器</th><th>同步模式</th><th>state含义</th><th>特性</th></tr></thead><tbody><tr><td>ReentrantLock</td><td>独占</td><td>重入次数</td><td>支持公平/非公平锁</td></tr><tr><td>Semaphore</td><td>共享</td><td>可用许可证数量</td><td>控制并发线程数</td></tr><tr><td>CountDownLatch</td><td>共享</td><td>未完成的任务数</td><td>一次性屏障，不可重置</td></tr><tr><td>ReentrantReadWriteLock</td><td>组合</td><td>高16位读锁，低16位写锁</td><td>读写分离，写锁优先</td></tr></tbody></table>
<h3 data-id="heading-13">5.2 ReentrantLock实现原理</h3>
<p>ReentrantLock通过内部类Sync（继承AQS）实现同步机制。其公平与非公平策略分别由FairSync和NonfairSync实现。</p>
<p>非公平锁尝试获取锁时直接CAS操作：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
    <span class="hljs-comment">// 非公平尝试，直接插队</span>
    <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) {
        setExclusiveOwnerThread(Thread.currentThread());
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p>而公平锁先检查队列：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
    <span class="hljs-comment">// 先检查是否有等待线程</span>
    <span class="hljs-keyword">if</span> (hasQueuedPredecessors())
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-comment">// ...尝试CAS获取</span>
}
</code></pre>
<h3 data-id="heading-14">5.3 读写锁实现技巧</h3>
<p>ReentrantReadWriteLock使用state的高16位记录读锁数量，低16位记录写锁重入次数。这种位运算技巧使单个state变量能同时管理两种锁状态。</p>
<p>读锁（共享锁）允许多线程同时访问，写锁（独占锁）保证互斥访问。当写锁持有时，所有读锁请求被阻塞；当读锁持有时，写锁请求被阻塞。</p>
<h2 data-id="heading-15">6 AQS实战：自定义同步器开发</h2>
<h3 data-id="heading-16">6.1 实现简单的互斥锁</h3>
<p>以下基于AQS实现简易互斥锁：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMutex</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-comment">// CAS将state从0改为1表示获取锁</span>
            <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) {
                setExclusiveOwnerThread(Thread.currentThread());
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> {
            <span class="hljs-keyword">if</span> (getState() == <span class="hljs-number">0</span>)
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();
            setExclusiveOwnerThread(<span class="hljs-literal">null</span>);
            setState(<span class="hljs-number">0</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isHeldExclusively</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> getState() == <span class="hljs-number">1</span>;
        }
        
        <span class="hljs-keyword">public</span> Condition <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConditionObject</span>();
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Sync</span> <span class="hljs-variable">sync</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sync</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> { sync.acquire(<span class="hljs-number">1</span>); }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> { sync.release(<span class="hljs-number">1</span>); }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isLocked</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> sync.isHeldExclusively(); }
    <span class="hljs-keyword">public</span> Condition <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> sync.newCondition(); }
}
</code></pre>
<p>此实现演示了AQS的基本用法：子类重写tryAcquire/tryRelease定义同步语义，外部类委托调用AQS模板方法。</p>
<h3 data-id="heading-17">6.2 实现限流器</h3>
<p>基于AQS共享模式实现简单的限流器：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleLimiter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        Sync(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>) { setState(<span class="hljs-keyword">permits</span>); }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-type">int</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> getState();
                <span class="hljs-type">int</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> available - acquires;
                <span class="hljs-keyword">if</span> (remaining &lt; <span class="hljs-number">0</span> || 
                    compareAndSetState(available, remaining)) {
                    <span class="hljs-keyword">return</span> remaining;
                }
            }
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> {
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> getState();
                <span class="hljs-type">int</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> current + releases;
                <span class="hljs-keyword">if</span> (next &lt; current) <span class="hljs-comment">// overflow</span>
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Maximum permit count exceeded"</span>);
                <span class="hljs-keyword">if</span> (compareAndSetState(current, next))
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleLimiter</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>)</span> { sync = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sync</span>(<span class="hljs-keyword">permits</span>); }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        sync.acquireSharedInterruptibly(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">()</span> {
        sync.releaseShared(<span class="hljs-number">1</span>);
    }
}
</code></pre>
<p>此限流器类似Semaphore，通过state表示可用许可证数，支持多线程同时获取。</p>
<h2 data-id="heading-18">7 AQS进阶特性与最佳实践</h2>
<h3 data-id="heading-19">7.1 条件变量（Condition）</h3>
<p>AQS通过ConditionObject实现条件队列，与同步队列分离。条件变量提供更灵活的线程等待/通知机制。</p>
<p><strong>await()流程</strong>：</p>
<ol>
<li>释放锁，状态保存</li>
<li>线程加入条件队列</li>
<li>被signal()唤醒后，重新获取锁</li>
</ol>
<p><strong>signal()流程</strong>：</p>
<ol>
<li>将条件队列首节点转移到同步队列</li>
<li>节点在同步队列中等待获取锁</li>
</ol>
<h3 data-id="heading-20">7.2 超时与中断控制</h3>
<p>AQS提供acquireInterruptibly()和tryAcquireNanos()方法，支持可中断获取和超时控制。这在避免死锁和实现响应式系统时至关重要。</p>
<h3 data-id="heading-21">7.3 性能优化与注意事项</h3>
<ol>
<li><strong>减少锁竞争</strong>：缩小临界区，缩短锁持有时间</li>
<li><strong>避免死锁</strong>：按固定顺序获取多个锁</li>
<li><strong>状态设计</strong>：子类应确保state操作线程安全，通常使用CAS</li>
<li><strong>避免阻塞操作</strong>：tryAcquire()中不应调用可能阻塞的方法</li>
<li><strong>正确释放</strong>：确保获取锁后最终释放，建议try-finally结构</li>
</ol>
<h2 data-id="heading-22">8 总结</h2>
<p>AQS作为Java并发编程的基石，通过state状态管理和CLH队列机制，为构建各种同步组件提供了强大而灵活的基础设施。其模板方法设计使开发者能专注于同步语义的实现，而无需关注底层线程排队、阻塞/唤醒等复杂细节。</p>
<p>掌握AQS不仅有助于理解Java并发工具的实现原理，更能为构建高性能、高并发的自定义同步组件奠定基础。在实际开发中，应根据具体场景选择合适的同步模式和策略，平衡性能与公平性需求。</p>
<p>AQS的设计思想，如CAS操作、队列管理、状态机控制等，在分布式系统、数据库连接池等场景也有广泛应用，是每个Java开发者必备的进阶技能。</p>
<hr/>
<p>更多技术干货欢迎关注微信公众号“<strong>科威舟的AI笔记</strong>”~</p>
<p>【转载须知】：<strong>转载请注明原文出处及作者信息</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java生态新纪元：虚拟线程、模式匹配与未来的编程范式]]></title>    <link>https://juejin.cn/post/7582862885106319410</link>    <guid>https://juejin.cn/post/7582862885106319410</guid>    <pubDate>2025-12-13T03:09:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582862885106319410" data-draft-id="7582846276506206246" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java生态新纪元：虚拟线程、模式匹配与未来的编程范式"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-13T03:09:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户615126561733"/> <meta itemprop="url" content="https://juejin.cn/user/2561190573653467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java生态新纪元：虚拟线程、模式匹配与未来的编程范式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2561190573653467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户615126561733
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T03:09:23.000Z" title="Sat Dec 13 2025 03:09:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Java生态新纪元：虚拟线程、模式匹配与未来的编程范式</h2>
<p>Java，这门拥有近30年历史的编程语言，始终保持着惊人的活力和创新力。它不仅是企业级应用的基石，也在不断拥抱现代编程范式，以应对云原生、高并发和开发效率的新挑战。本文将带你一览Java生态中最激动人心的最新技术和未来发展趋势。</p>
<h3 data-id="heading-1">一、Project Loom：开启高并发编程新范式</h3>
<p>传统Java并发模型基于操作系统线程，创建和上下文切换成本高昂，限制了应用的并发能力。Project Loom旨在通过引入**虚拟线程（Virtual Threads）**彻底解决这一问题。</p>
<p>虚拟线程是由JVM管理的轻量级线程，其创建成本极低（几乎可以瞬间创建数百万个），并且由少量平台线程（即操作系统线程）来承载和调度。这使得我们能够用同步、阻塞的代码风格编写高并发、高吞吐量的应用，而无需复杂的异步回调或Reactive编程模型。</p>
<h4 data-id="heading-2">代码示例：虚拟线程 vs 平台线程</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用传统的线程池（平台线程）</span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10_000</span>; i++) {
    executor.submit(() -&gt; {
        <span class="hljs-comment">// 模拟I/O操作</span>
        <span class="hljs-keyword">try</span> { Thread.sleep(<span class="hljs-number">1000</span>); } <span class="hljs-keyword">catch</span> (InterruptedException e) {}
        System.out.println(<span class="hljs-string">"Task completed"</span>);
    });
}

<span class="hljs-comment">// 使用虚拟线程</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10_000</span>; i++) {
        executor.submit(() -&gt; {
            <span class="hljs-comment">// 同样的I/O操作</span>
            <span class="hljs-keyword">try</span> { Thread.sleep(<span class="hljs-number">1000</span>); } <span class="hljs-keyword">catch</span> (InterruptedException e) {}
            System.out.println(<span class="hljs-string">"Virtual Task completed"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        });
    }
}
</code></pre>
<p>在上面的例子中，使用固定线程池处理1万个任务会因为线程数量限制而排队执行，耗时很长。而使用虚拟线程，所有任务几乎可以同时开始执行，极大地提升了吞吐量。自JDK 21起，虚拟线程已成为正式特性，是构建下一代高性能服务的关键。</p>
<h3 data-id="heading-3">二、Project Valhalla：重塑Java的内存与性能模型</h3>
<p>Project Valhalla的目标是通过引入<strong>值类型（Value Types）<strong>和</strong>原始类（Primitive Classes）</strong>，消除对象头带来的内存开销和间接访问的性能损耗。</p>
<p>在当前的Java模型中，即使是简单的<code>Integer</code>或<code>Point</code>对象，也包含一个对象头（通常12字节），这在处理大量数据时会造成巨大的内存浪费和缓存未命中。值类型允许我们将这些“纯数据”的实例像<code>int</code>一样内联存储，没有身份标识，从而获得接近C语言的内存效率和性能。</p>
<p>虽然Valhalla尚未完全发布，但其概念已经深刻影响了Java社区对性能优化的思考。</p>
<h3 data-id="heading-4">三、语法糖进化：更简洁、更安全的代码</h3>
<p>Java语言本身也在持续进化，引入了许多提升开发体验的语法特性。</p>
<h4 data-id="heading-5">1. 模式匹配（Pattern Matching）</h4>
<p>从JDK 14开始引入并在后续版本中完善的<code>instanceof</code>模式匹配，以及JDK 21中预览的<code>switch</code>模式匹配，让类型检查和解构变得异常优雅。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// JDK 14+ 的 instanceof 模式匹配</span>
<span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> String s &amp;&amp; s.length() &gt; <span class="hljs-number">5</span>) {
    System.out.println(s.toUpperCase());
}

<span class="hljs-comment">// JDK 21+ 的 switch 模式匹配（预览特性）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">formatted</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">switch</span> (obj) {
    <span class="hljs-keyword">case</span> Integer i -&gt; String.format(<span class="hljs-string">"int %d"</span>, i);
    <span class="hljs-keyword">case</span> String s when s.length() &gt; <span class="hljs-number">0</span> -&gt; String.format(<span class="hljs-string">"String of length %d"</span>, s.length());
    <span class="hljs-keyword">case</span> <span class="hljs-literal">null</span> -&gt; <span class="hljs-string">"null"</span>;
    <span class="hljs-keyword">default</span> -&gt; obj.toString();
};
</code></pre>
<h4 data-id="heading-6">2. Record类</h4>
<p>Record是JDK 14引入的用于声明“纯数据载体”类的简洁方式。编译器会自动生成<code>equals</code>, <code>hashCode</code>, <code>toString</code>以及<code>getter</code>方法。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title class_">User</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {}

<span class="hljs-comment">// 使用</span>
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">30</span>);
System.out.println(user.name()); <span class="hljs-comment">// 自动生成的getter</span>
</code></pre>
<h4 data-id="heading-7">3. 密封类（Sealed Classes）</h4>
<p>密封类（JDK 17正式发布）允许你精确控制哪些类可以继承或实现某个父类/接口，这对于构建领域模型和确保<code>switch</code>表达式的穷尽性非常有用。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Shape</span> <span class="hljs-keyword">permits</span> Circle, Rectangle {}
<span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Shape</span> { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rectangle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Shape</span> { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<h3 data-id="heading-8">四、GraalVM与Native Image：迈向AOT编译</h3>
<p>GraalVM是一个高性能的通用虚拟机，其最引人注目的特性之一是能够将Java应用程序提前编译（AOT）成独立的本地可执行文件（Native Image）。这带来了启动速度的飞跃（毫秒级）和极低的内存占用，非常适合微服务、Serverless（FaaS）等场景。</p>
<p>尽管目前在反射、动态代理等方面仍有一些限制，但GraalVM生态正在快速发展，Spring Native等框架也提供了良好的支持。</p>
<h3 data-id="heading-9">结语</h3>
<p>Java生态正处在一个前所未有的创新高峰期。从底层的并发模型（Loom）、内存模型（Valhalla），到上层的语言语法（Records, Sealed Classes, Pattern Matching），再到运行时的革新（GraalVM），每一项技术都在为开发者提供更强大、更高效、更简洁的工具。对于Java学习者而言，紧跟这些趋势，不仅能写出更好的代码，更能洞察未来软件工程的发展方向。拥抱变化，Java的未来依然光明！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[huggingface_hub 1.0 正式版现已发布：开源机器学习基础五周年回顾]]></title>    <link>https://juejin.cn/post/7582846276506730534</link>    <guid>https://juejin.cn/post/7582846276506730534</guid>    <pubDate>2025-12-13T08:40:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582846276506730534" data-draft-id="7582875640308170802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="huggingface_hub 1.0 正式版现已发布：开源机器学习基础五周年回顾"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-13T08:40:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HuggingFace"/> <meta itemprop="url" content="https://juejin.cn/user/611789528634712"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            huggingface_hub 1.0 正式版现已发布：开源机器学习基础五周年回顾
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/611789528634712/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HuggingFace
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T08:40:38.000Z" title="Sat Dec 13 2025 08:40:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>简要总结：</strong> 经过五年的持续开发，<code>huggingface_hub</code> 发布 v1.0 正式版！这一里程碑标志着这个库的成熟与稳定。它已成为 Python 生态中支撑 <strong>20 万个依赖库</strong> 的核心组件，并提供访问超过 <strong>200 万公开模型</strong>、<strong>50 万公开数据集</strong> 和 <strong>100 万 Space 应用</strong> 的基础能力。本次更新包含为支持未来十年开源机器学习生态而做出的重大变更，由近 300 位贡献者和数百万用户共同推动发展。</p>
<p><strong>🚀 强烈建议尽快升级至 v1.0，以体验更优性能和全新功能。</strong></p>
<pre><code class="hljs language-bash" lang="bash">pip install --upgrade huggingface_hub
</code></pre>
<p>此次重大版本更新包括以下内容：</p>
<ul>
<li>使用 <code>httpx</code> 作为新后端请求库；</li>
<li>全新设计的 <code>hf</code> 命令行工具（取代已弃用的 <code>huggingface-cli</code>），采用 Typer 构建，功能更加丰富；</li>
<li>文件传输全面迁移至 <code>hf_xet</code>，彻底淘汰旧的 <code>hf_transfer</code> 工具。</li>
</ul>
<p>查看完整的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Fhuggingface_hub%2Freleases%2Ftag%2Fv1.0.0" target="_blank" title="https://github.com/huggingface/huggingface_hub/releases/tag/v1.0.0" ref="nofollow noopener noreferrer">v1.0 发布说明</a></p>
<blockquote>
<p>我们尽可能确保 v1.0.0 与旧版本兼容。大多数机器学习库无需修改即可兼容 v0.x 和 v1.x。主要例外是 <code>transformers</code>：v4 版本依赖 v0.x，计划中的 v5 将转向 v1.x。查看此 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Fhuggingface_hub%2Fissues%2F3340" target="_blank" title="https://github.com/huggingface/huggingface_hub/issues/3340" ref="nofollow noopener noreferrer">issue</a> 获取详细的库兼容性表。</p>
</blockquote>
<h2 data-id="heading-0">背后的故事</h2>
<p>每个主流库背后都有一段故事。<code>huggingface_hub</code> 的故事始于一个简单的想法：<strong>如果共享机器学习模型像在 GitHub 上分享代码一样容易，会怎样？</strong></p>
<p>在 Hugging Face Hub 的早期阶段，研究人员和开发者常常面临一个困扰：
训练一个先进的模型不仅耗时、耗资源，而且在训练完成后，模型往往“被困”在个人电脑里，只能通过不稳定的 Google Drive 链接进行分享。
这导致社区重复造轮子，资源浪费严重，协作效率极低。</p>
<p>为了解决这一问题，Hugging Face Hub 应运而生。最初，它的功能很简单，只是用于共享和托管与 <code>transformers</code> 库兼容的模型检查点。而与 Hub 交互的全部 Python 逻辑代码，也都内置在 <code>transformers</code> 库中，其他库无法复用这些功能。</p>
<p>直到 2020 年底，我们推出了 <code>huggingface_hub</code> 的首个版本 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Fhuggingface_hub%2Freleases%2Ftag%2Fv0.0.1" target="_blank" title="https://github.com/huggingface/huggingface_hub/releases/tag/v0.0.1" ref="nofollow noopener noreferrer">v0.0.1</a>，它的初衷是：将原本封装在 <code>transformers</code> 库中的内部逻辑独立出来，构建一个专用库，用于统一访问和共享 Hugging Face Hub 上的机器学习模型与数据集。最早的版本非常简洁，它只是一个 Git 操作的封装工具，用于下载文件和管理仓库。但五年过去，历经 35+ 个版本迭代，<code>huggingface_hub</code> 已远远超越最初的设想。</p>
<p>让我们一起来回顾这段发展历程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9edc43755ee64e6289f6adcc3bb98468~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSHVnZ2luZ0ZhY2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766220038&amp;x-signature=7yR%2BJCcZSTlUDWXEBtVpXILKLi0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">奠基阶段（2020–2021）</h3>
<p>最初的几个版本为整个库打下了基础。
版本 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Fhuggingface_hub%2Freleases%2Ftag%2Fv0.0.8" target="_blank" title="https://github.com/huggingface/huggingface_hub/releases/tag/v0.0.8" ref="nofollow noopener noreferrer">0.0.8</a> 引入了第一个 API，通过封装 Git 命令，实现与模型仓库的交互。
接着在版本 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Fhuggingface_hub%2Freleases%2Ftag%2Fv0.0.17" target="_blank" title="https://github.com/huggingface/huggingface_hub/releases/tag/v0.0.17" ref="nofollow noopener noreferrer">0.0.17</a> 中，加入了基于 token 的认证机制，支持访问私有仓库并安全上传内容。
虽然这些功能看起来很基础，但它们构成了后来所有进步的基石。</p>
<h3 data-id="heading-2">重要转折：从 Git 到 HTTP（2022）</h3>
<p>2022 年 6 月，版本 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Fhuggingface_hub%2Freleases%2Ftag%2Fv0.8.1" target="_blank" title="https://github.com/huggingface/huggingface_hub/releases/tag/v0.8.1" ref="nofollow noopener noreferrer">0.8.1</a> 发布，这是 Hugging Face Hub 发展史上的一个转折点——我们引入了 HTTP Commit API。</p>
<p>从此，用户无需再安装 Git 和 Git LFS，也能直接通过 HTTP 上传文件。新推出的 <code>create_commit()</code> API 极大简化了上传流程，尤其适合处理大型模型文件——这些文件过去通过 Git LFS 操作起来十分繁琐。</p>
<p>此外，该版本还引入了支持 Git 结构感知的缓存机制。所有使用 <code>huggingface_hub</code> 的库（无论是官方的 transformers，还是第三方库）现在都能共享同一套缓存系统，具备显式的版本控制和文件去重功能。</p>
<p>这不仅仅是一次技术优化，更是一次理念上的飞跃。
我们不再只是为 transformers 构建 Git 工具，而是在构建一套专为机器学习模型和数据打造的基础设施，面向整个机器学习生态服务。</p>
<h3 data-id="heading-3">API 能力的全面扩展（2022–2024）</h3>
<p>随着 Hugging Face Hub 从一个模型仓库逐步发展为一个完整的平台，<code>huggingface_hub</code> 的 API 能力也不断拓展，满足更多场景需求。</p>
<p>核心的仓库操作功能不断成熟，支持：</p>
<ul>
<li>列出文件树（list tree）</li>
<li>浏览引用（refs）与提交记录（commits）</li>
<li>读取文件或同步整个文件夹</li>
<li>管理标签、分支和发布周期（release cycle）</li>
<li>查询仓库元数据与设置 webhook，帮助团队实时响应变更</li>
</ul>
<p>与此同时，Hub 上的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdocs%2Fhuggingface_hub%2Fguides%2Fmanage-spaces" target="_blank" title="https://huggingface.co/docs/huggingface_hub/guides/manage-spaces" ref="nofollow noopener noreferrer">Spaces</a> 功能开始崭露头角，它是一个简单却强大的方式，可以直接在 Hub 上托管和分享交互式的机器学习演示项目。<code>huggingface_hub</code> 也逐步实现了对 Spaces 的完整程序化管理能力，包括硬件资源申请、环境配置、密钥管理、文件上传等。</p>
<p>为了支持模型在生产环境中的部署，我们还集成了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdocs%2Fhuggingface_hub%2Fguides%2Finference_endpoints" target="_blank" title="https://huggingface.co/docs/huggingface_hub/guides/inference_endpoints" ref="nofollow noopener noreferrer">Inference Endpoints</a>。而在 2025 年第三季度，<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdocs%2Fhuggingface_hub%2Fguides%2Fjobs" target="_blank" title="https://huggingface.co/docs/huggingface_hub/guides/jobs" ref="nofollow noopener noreferrer">Jobs API</a> 的加入，进一步完善了 Hugging Face 的计算服务能力。</p>
<p>在此过程中，社区与社交层也被提升为一等公民。现在支持：</p>
<ul>
<li>创建和管理 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdocs%2Fhuggingface_hub%2Fguides%2Fcommunity" target="_blank" title="https://huggingface.co/docs/huggingface_hub/guides/community" ref="nofollow noopener noreferrer">Pull Requests 和评论</a></li>
<li>查询用户与组织信息</li>
<li>仓库点赞、关注、粉丝功能</li>
<li>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdocs%2Fhuggingface_hub%2Fguides%2Fcollections" target="_blank" title="https://huggingface.co/docs/huggingface_hub/guides/collections" ref="nofollow noopener noreferrer">Collections</a> 整理和分享资源合集</li>
</ul>
<p>同时，日常使用体验也得到了显著优化：Colab 中的无缝认证、大型文件夹上传的可靠性提升、支持断点续传等功能，使开发更加高效流畅。</p>
<p>随后，在版本 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Fhuggingface_hub%2Freleases%2Ftag%2Fv0.28.0" target="_blank" title="https://github.com/huggingface/huggingface_hub/releases/tag/v0.28.0" ref="nofollow noopener noreferrer">v0.28.0</a> 中，我们推出了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdocs%2Fhuggingface_hub%2Fguides%2Finference" target="_blank" title="https://huggingface.co/docs/huggingface_hub/guides/inference" ref="nofollow noopener noreferrer">推理服务提供方生态</a>。不再依赖单一的推理后端，而是与多家无服务器推理平台合作，包括 Together AI、SambaNova、Replicate、Cerebras、Groq 等，用户通过一个统一的 API 即可调用多个后端，路由透明，按请求计费，真正实现了“按需调用，轻松推理”。</p>
<h3 data-id="heading-4">Ready. Xet. Go!（2024–2025）</h3>
<p>在版本 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Fhuggingface_hub%2Freleases%2Ftag%2Fv0.30.0" target="_blank" title="https://github.com/huggingface/huggingface_hub/releases/tag/v0.30.0" ref="nofollow noopener noreferrer">v0.30.0</a> 中，我们发布了 Xet —— 一种颠覆性的 Git 大文件存储协议。</p>
<p>与传统的 Git LFS（只支持文件级去重）不同，Xet 在更精细的粒度（每 64KB 为一块）进行数据去重与传输优化。当你更新一个大型模型或数据文件时，系统只会上传或下载发生变更的部分，而不是整个文件。</p>
<p>这场<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fspaces%2Fjsulz%2Fready-xet-go" target="_blank" title="https://huggingface.co/spaces/jsulz/ready-xet-go" ref="nofollow noopener noreferrer">大规模迁移</a> 始于 50 多万个仓库，涉及超过 20PB 的数据。但令人惊喜的是，这一迁移过程对用户是完全透明的，100% 向后兼容，无需手动干预，也没有中断现有流程。</p>
<p>一年后，超过 <strong>6,000,000 个仓库</strong>、<strong>77PB+</strong> 的数据已成功迁移至 Xet 后端，带来了更快、更智能的上传与下载体验 🔥</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3765e1c8418484eb425b2e1f9535404~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSHVnZ2luZ0ZhY2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766220038&amp;x-signature=wtT%2Fz%2Ftw%2BvpLT7HwxLmKKoo%2FKxA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">成长与影响力衡量</h2>
<p>衡量一个开源库的成长和影响力并不容易，但有时，数字本身就是最好的证明：</p>
<ul>
<li><strong>每月下载量达 1.135 亿次</strong>，<strong>累计下载超 16 亿次</strong>（截至 2025 年 10 月）</li>
<li>提供访问 <strong>200 万+ 公共模型</strong>、<strong>50 万+ 公共数据集</strong> 和 <strong>100 万+ 公共 Spaces</strong> —— 如果包括私有仓库，总量大约翻倍</li>
<li>每日活跃用户超过 <strong>6 万人</strong>，每月活跃用户超过 <strong>55 万人</strong></li>
<li>被全球 <strong>20 万+ 企业</strong> 信赖使用，从初创公司到《财富》500 强企业</li>
</ul>
<p>但真正体现其规模的，是整个生态的广度和深度。<code>huggingface_hub</code> 已成为 GitHub 上 <strong>超过 20 万个仓库</strong> 和 PyPI 上 <strong>3,000 个软件包</strong> 的 <strong>依赖核心</strong> ，涵盖主流框架如 Keras、LangChain、PaddleOCR、ChatTTS、YOLO、Google Generative AI、Moshi、NVIDIA NeMo、Open Sora 等，还有无数小型工具与项目。Hugging Face 自家生态（如 transformers、diffusers、datasets、sentence-transformers、gradio、peft、trl 等）也都建立在其之上。</p>
<p>最令人欣慰的是，这些第三方集成大多数都是自然发生的，我们并未主动推动。这正是 Hugging Face Hub 释放力量的体现——它让整个机器学习社区能够更加开放、高效地协作与创新，而它如今的广泛使用程度，也远超我们的最初预期。</p>
<h2 data-id="heading-6">面向未来十年的构建</h2>
<p>v1.0 不只是一个版本号的跃迁，它代表的是：<strong>为未来十年开放式机器学习奠定坚实基础</strong>。我们做出的破坏性更新并非随意为之，而是出于战略考虑，为了让 <code>huggingface_hub</code> 能够应对 AI 的高速发展，并保持全球数百万开发者所依赖的稳定性与可靠性。</p>
<h3 data-id="heading-7">现代化 HTTP 架构：httpx 与 hf_xet</h3>
<p>v1.0 最重要的架构变更，是将底层 HTTP 请求库从 <code>requests</code> 迁移至 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.python-httpx.org%2F" target="_blank" title="https://www.python-httpx.org/" ref="nofollow noopener noreferrer"><code>httpx</code></a>。这不仅是依赖项的替换，而是一次真正意义上的升级，使整个库正式迈入现代 HTTP 时代。</p>
<p><strong>为什么选择 httpx？</strong>
它带来的好处非常显著：</p>
<ul>
<li>原生支持 HTTP/2，连接效率更高</li>
<li>完整的线程安全，可在多线程间安全复用连接</li>
<li>最关键的是：提供统一的同步与异步接口，彻底消除原先同步与异步推理客户端之间的微妙差异</li>
</ul>
<p>此次迁移的设计尽可能做到“对用户透明”，大多数用户无需做任何修改。对于使用自定义 HTTP 后端的开发者，我们提供了清晰的迁移路径，将 <code>configure_http_backend()</code> 替换为 <code>set_client_factory()</code> 或 <code>set_async_client_factory()</code>。</p>
<p>同时，<code>hf_xet</code> 现已成为 Hub 上传和下载文件的默认工具包，完全取代此前的可选方案 <code>hf_transfer</code>，后者已被彻底移除。</p>
<h3 data-id="heading-8">MCP 与 Tiny-Agents：让智能体开发触手可及</h3>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Fhuggingface_hub%2Freleases%2Ftag%2Fv0.32.0" target="_blank" title="https://github.com/huggingface/huggingface_hub/releases/tag/v0.32.0" ref="nofollow noopener noreferrer">v0.32.0</a> 中，我们引入了 <strong>Model Context Protocol（模型上下文协议，MCP）集成</strong> 和 <strong>tiny-agents 工具链</strong>，这从根本上改变了构建 AI Agent 的方式。曾经需要复杂框架集成的任务，如今只需大约 70 行 Python 代码即可完成。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdocs%2Fhuggingface_hub%2Fpackage_reference%2Fmcp" target="_blank" title="https://huggingface.co/docs/huggingface_hub/package_reference/mcp" ref="nofollow noopener noreferrer"><code>MCPClient</code></a> 提供了一个标准化接口，使 AI Agent 能够轻松与各种工具进行交互；而 <code>tiny-agents</code> CLI 工具则允许你直接从 Hub 启动 Agent。你可以连接本地或远程 MCP 服务器，将任意 Gradio Space 用作工具，并构建出自然、流畅、响应迅速的对话式智能体。</p>
<p>所有这些，都是在我们现有的 <code>InferenceClient</code> 以及其支持的多家推理服务商的基础上构建的。我们坚信 Agent 是未来，而 <code>huggingface_hub</code> 将持续提供这些构建 AI 工具的基础模块，助力开发者快速落地创新想法。</p>
<h3 data-id="heading-9">面向现代工作流的全功能命令行工具</h3>
<p>Hugging Face 的 CLI 工具已经从一个简单的命令行工具，发展为一个 <strong>功能全面的机器学习操作接口</strong>。全新设计的 <code>hf</code> 命令取代了老旧的 <code>huggingface-cli</code>，采用现代化的“资源-动作”模式：</p>
<ul>
<li><code>hf auth login</code>：用户认证</li>
<li><code>hf download</code> 和 <code>hf upload</code>：文件上传与下载</li>
<li><code>hf repo</code>：仓库管理</li>
<li><code>hf cache ls</code> 和 <code>hf cache rm</code>：缓存管理</li>
<li><code>hf jobs run</code>：运行云端计算任务</li>
</ul>
<p>CLI 提供了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdocs%2Fhuggingface_hub%2Finstallation%23install-the-hugging-face-cli" target="_blank" title="https://huggingface.co/docs/huggingface_hub/installation#install-the-hugging-face-cli" ref="nofollow noopener noreferrer">沙箱式安装器</a>，可以在不破坏现有开发环境的前提下快速安装或升级：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS 或 Linux</span>
curl -LsSf https://hf.co/cli/install.sh | sh

<span class="hljs-comment"># Windows</span>
powershell -ExecutionPolicy ByPass -c <span class="hljs-string">"irm https://hf.co/cli/install.ps1 | iex"</span>
</code></pre>
<p>CLI 还支持命令自动补全，并在各大主流平台上都能顺利运行。如今的 Hugging Face CLI，已经具备与现代开发工具媲美的体验和易用性。</p>
<h3 data-id="heading-10">为未来清理技术债</h3>
<p>在 v1.0 中，我们移除了部分阻碍未来发展的旧功能和用法：</p>
<ul>
<li>基于 Git 的 <code>Repository</code> 类已被移除。</li>
<li>HTTP 接口如 <code>upload_file()</code> 和 <code>create_commit()</code> 变得更简洁、更稳定，也更适应现代化工作流。</li>
<li><code>HfFolder</code> 的 token 管理方式已被显式的 <code>login()</code>、<code>logout()</code> 和 <code>get_token()</code> 函数所取代，使用方式更直观。</li>
<li>原有的 <code>InferenceApi</code> 类被功能更完善的 <code>InferenceClient</code> 替代。</li>
<li>文件传输工具 <code>hf_transfer</code> 被彻底淘汰，现已由全新的二进制工具包 <code>hf_xet</code> 完全接管。</li>
</ul>
<p>这些变更并非仓促决策，我们在数月前就已发布弃用通知，附带清晰的迁移指引。最终目标是打造一个 <strong>更清晰、更易维护</strong> 的代码库，让我们能够集中精力开发面向未来的新特性，而不是继续兼容过时的实现方式。</p>
<h3 data-id="heading-11">迁移指南</h3>
<p>我们理解，破坏性更新可能会对现有项目造成困扰。正因如此，我们投入了大量精力，尽可能让迁移过程顺畅无痛。官方的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdocs%2Fhuggingface_hub%2Fconcepts%2Fmigration" target="_blank" title="https://huggingface.co/docs/huggingface_hub/concepts/migration" ref="nofollow noopener noreferrer">迁移指南</a> 提供了每项变更的 <strong>逐步说明</strong>，并解释了背后的原因。</p>
<p>最重要的是，我们在可能的地方 <strong>保留了向后兼容性</strong>。例如 <code>HfHubHttpError</code> 同时继承了旧版 <code>requests</code> 和新版 <code>httpx</code> 的 <code>HTTPError</code> 异常类，确保原有错误处理逻辑依然生效。</p>
<p>从 v1.0 起，我们将<strong>全面聚焦新版</strong>的开发与维护，确保为社区提供更高性能、更丰富功能和更完善的工具。旧版（v0.*）仍可在 PyPI 下载，但今后只会进行安全性补丁更新，不再添加新功能。</p>
<blockquote>
<p>我们尽力确保 <code>huggingface_hub</code> v1.0.0 与旧版兼容。在实际使用中，大多数机器学习库在 v0.x 与 v1.x 之间都能无缝切换。主要例外是 <code>transformers</code>：其 v4 版本明确依赖 v0.x，而即将发布的 v5 将改为依赖 v1.x。想了解各主流库的兼容情况，请参考这个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Fhuggingface_hub%2Fissues%2F3340" target="_blank" title="https://github.com/huggingface/huggingface_hub/issues/3340" ref="nofollow noopener noreferrer">兼容性汇总表</a>。</p>
</blockquote>
<h2 data-id="heading-12">特别致谢</h2>
<p>感谢 280 多位为本库贡献代码、文档、翻译和社区支持的开发者们！</p>
<p>同时也感谢 Hugging Face 社区提供的反馈、Bug 报告与建议，这些都帮助我们不断完善产品。</p>
<p>最后，衷心感谢广大用户 —— 无论是独立开发者还是大型企业 —— 感谢你们信任 <code>huggingface_hub</code>，让它成为你们工作流程的一部分。是你们的支持激励我们不断前行。</p>
<p>如果你喜欢这个项目，欢迎到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Fhuggingface_hub" target="_blank" title="https://github.com/huggingface/huggingface_hub" ref="nofollow noopener noreferrer">GitHub 点个星 ⭐</a>，支持我们继续建设开源机器学习的未来！</p>
<p>五年已过，但一切才刚刚开始！</p>
<blockquote>
<p>英文原文: <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fblog%2Fhuggingface-hub-v1" target="_blank" title="https://huggingface.co/blog/huggingface-hub-v1" ref="nofollow noopener noreferrer">huggingface.co/blog/huggin…</a></p>
<p>原文作者: Lucain Pouget, Célina Hanouti, Lysandre, Julien Chaumond</p>
<p>译者: Luke,  Hugging Face Fellow</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【后端进阶】并发竞态与锁选型]]></title>    <link>https://juejin.cn/post/7582813955212525609</link>    <guid>https://juejin.cn/post/7582813955212525609</guid>    <pubDate>2025-12-13T03:19:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582813955212525609" data-draft-id="7583139562734764075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【后端进阶】并发竞态与锁选型"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-13T03:19:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="曾富贵"/> <meta itemprop="url" content="https://juejin.cn/user/4212984286289806"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【后端进阶】并发竞态与锁选型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984286289806/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    曾富贵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T03:19:02.000Z" title="Sat Dec 13 2025 03:19:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、 事务的局限性</h2>
<p>首先，我们需要厘清事务的核心作用。</p>
<p>大多数关系型数据库（如 MySQL/PostgreSQL）的事务主要保证 <strong>ACID</strong> 中的 <strong>A（原子性）</strong>：</p>
<blockquote>
<p><strong>原子性</strong>：一系列操作要么全部成功，要么全部失败。</p>
</blockquote>
<p>但它<strong>默认</strong>并不能完全解决并发下的 <strong>I（隔离性）</strong> 问题（多个并发事务之间互不干扰）。</p>
<h3 data-id="heading-1">典型的“读-改-写”死局</h3>
<p>假设我们有一个扣减库存的业务逻辑，代码如下（伪代码）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 开启事务</span>
<span class="hljs-keyword">await</span> prisma.$transaction(<span class="hljs-keyword">async</span> (tx) =&gt; {
  <span class="hljs-comment">// 1. 读：查询当前库存</span>
  <span class="hljs-keyword">const</span> product = <span class="hljs-keyword">await</span> tx.<span class="hljs-property">product</span>.<span class="hljs-title function_">findUnique</span>({ <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> } });
  
  <span class="hljs-comment">// 2. 算：内存判断</span>
  <span class="hljs-keyword">if</span> (product.<span class="hljs-property">stock</span> &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'库存不足'</span>);
  
  <span class="hljs-comment">// 3. 写：更新库存</span>
  <span class="hljs-keyword">await</span> tx.<span class="hljs-property">product</span>.<span class="hljs-title function_">update</span>({
    <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> },
    <span class="hljs-attr">data</span>: { <span class="hljs-attr">stock</span>: product.<span class="hljs-property">stock</span> - <span class="hljs-number">1</span> }
  });
});
</code></pre>
<p><strong>并发场景：</strong>
如果 A 和 B 两个用户同时进来：</p>
<ol>
<li>A 读到库存为 1。</li>
<li>B 读到库存为 1（因为 A 没锁数据）。</li>
<li>A 减 1 写入 0。</li>
<li>B 减 1 写入 0。
<strong>结果：</strong> 卖出了两件商品，库存只减了 1。这就是典型的 <strong>丢失更新（Lost Update）</strong>。</li>
</ol>
<hr/>
<h2 data-id="heading-2">二、 解决方案一：单指令原子化（推荐）</h2>
<p>如果你的业务逻辑非常简单，仅仅是数值的增减，<strong>最好的办法是完全绕过“读-改-写”的步骤</strong>，直接利用数据库自身的原子能力。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 不需要查出来计算，直接推给数据库去算</span>
<span class="hljs-keyword">await</span> prisma.<span class="hljs-property">product</span>.<span class="hljs-title function_">update</span>({
  <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> },
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">stock</span>: { <span class="hljs-attr">decrement</span>: <span class="hljs-number">1</span> } <span class="hljs-comment">// 原子操作：UPDATE product SET stock = stock - 1 ...</span>
  }
});
</code></pre>
<p><strong>优点</strong>：性能最高，不需要复杂的锁机制。
<strong>缺点</strong>：只能处理简单逻辑。如果需要判断“用户等级”、“限购数量”等复杂业务，单条 SQL 无法满足。</p>
<hr/>
<h2 data-id="heading-3">三、 解决方案二：悲观锁（Pessimistic Locking）</h2>
<p>当逻辑复杂必须分步执行，且是<strong>写多（高频并发写入）</strong> 的场景时，我们需要<strong>悲观锁</strong>。</p>
<h3 data-id="heading-4">通俗理解</h3>
<p>“公共厕所的坑位（数据）有限且竞争激烈，为了防止我在里面办事的时候被别人推门而入，我进门的第一件事就是<strong>先把门反锁</strong>。直到我办完事出来，下一个人才能进去。”</p>
<h3 data-id="heading-5">⚠️ 关键前提：必须配合事务</h3>
<p><strong>悲观锁是依赖数据库事务（Transaction）的。</strong></p>
<ul>
<li>只有在 <code>BEGIN</code> ... <code>COMMIT/ROLLBACK</code> 之间，锁才生效。</li>
<li>一旦事务提交或回滚，<strong>锁会自动解除</strong>。如果不开启事务，SQL 语句执行完的瞬间锁就释放了，没有任何意义。</li>
</ul>
<h3 data-id="heading-6">实现方式</h3>
<p>在 SQL 中使用 <code>SELECT ... FOR UPDATE</code>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 必须在事务中进行！</span>
<span class="hljs-keyword">await</span> prisma.$transaction(<span class="hljs-keyword">async</span> (tx) =&gt; {
  <span class="hljs-comment">// 1. 查并加锁（注意：这里必须使用原生 SQL 或特定 ORM 方法）</span>
  <span class="hljs-comment">// 这行代码执行后，数据库会给这行数据挂上一把“排他锁”</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tx.<span class="hljs-property">$queryRaw</span><span class="hljs-string">`SELECT * FROM "Product" WHERE id = <span class="hljs-subst">${id}</span> FOR UPDATE`</span>;
  
  <span class="hljs-keyword">if</span> (result[<span class="hljs-number">0</span>].<span class="hljs-property">stock</span> &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'库存不足'</span>);
  
  <span class="hljs-comment">// 2. 更新</span>
  <span class="hljs-keyword">await</span> tx.<span class="hljs-property">product</span>.<span class="hljs-title function_">update</span>({ ... });
  
  <span class="hljs-comment">// 3. 事务结束 -&gt; 锁自动释放</span>
});
</code></pre>
<h3 data-id="heading-7">🔒 锁的阻塞机制（重点）</h3>
<p>假设事务 A 拿到了锁，且<strong>还没提交</strong>，此时事务 B 如果想操作同一行数据，会遭遇以下情况：</p>

























<table><thead><tr><th align="left">事务 B 的操作</th><th align="left">结果</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><strong>普通查询</strong><br/><code>SELECT * ...</code></td><td align="left"><strong>✅ 通行</strong></td><td align="left"><strong>不阻塞</strong>。基于 MVCC 机制，B 会读到 A 加锁之前的<strong>历史快照</strong>。虽然读不到最新修改，但不会被卡住。</td></tr><tr><td align="left"><strong>悲观锁查询</strong><br/><code>SELECT ... FOR UPDATE</code></td><td align="left"><strong>❌ 阻塞</strong></td><td align="left"><strong>排队等待</strong>。B 也想申请锁，但锁在 A 手里，必须等 A 提交或回滚。</td></tr><tr><td align="left"><strong>修改操作</strong><br/><code>UPDATE / DELETE</code></td><td align="left"><strong>❌ 阻塞</strong></td><td align="left"><strong>排队等待</strong>。修改数据需要获取写锁，必须等 A 释放锁。</td></tr></tbody></table>
<h3 data-id="heading-8">适用场景</h3>
<ul>
<li><strong>写多读多</strong>、强一致性要求高（如秒杀、银行转账）。</li>
<li><strong>代价</strong>：性能较差，容易降低系统吞吐量，处理不当可能导致死锁。</li>
</ul>
<hr/>
<h2 data-id="heading-9">四、 解决方案三：乐观锁（Optimistic Locking）</h2>
<p>当逻辑复杂必须分步执行，且是<strong>读多写少（低频并发写入）</strong> 的场景时，我们使用<strong>乐观锁</strong>。</p>
<h3 data-id="heading-10">实现方式</h3>
<p>通常在数据库表中增加一个 <code>version</code> 字段。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 读数据（不加锁）</span>
<span class="hljs-keyword">const</span> product = <span class="hljs-keyword">await</span> repo.<span class="hljs-title function_">findOne</span>(id); <span class="hljs-comment">// 假设此时 version = 1</span>

<span class="hljs-comment">// 2. 内存计算</span>
<span class="hljs-keyword">const</span> newStock = product.<span class="hljs-property">stock</span> - <span class="hljs-number">1</span>;

<span class="hljs-comment">// 3. 更新（带版本号条件） - CAS (Compare And Swap)</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> repo.<span class="hljs-title function_">update</span>(
  <span class="hljs-comment">// 只有当数据库里的 version 依然等于我读到的 1 时，才更新</span>
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">version</span>: <span class="hljs-number">1</span> }, 
  { <span class="hljs-attr">stock</span>: newStock, <span class="hljs-attr">version</span>: <span class="hljs-number">2</span> }
);

<span class="hljs-comment">// 4. 判断结果</span>
<span class="hljs-keyword">if</span> (result.<span class="hljs-property">affected</span> === <span class="hljs-number">0</span>) {
  <span class="hljs-comment">// 说明在第1步和第3步之间，有人修改了数据</span>
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConflictException</span>(<span class="hljs-string">'手慢了，数据已被修改'</span>);
}
</code></pre>
<h3 data-id="heading-11">失败后的策略</h3>
<p>乐观锁更新失败后，有两种常见处理方式：</p>
<ol>
<li><strong>Fast Fail（快速失败）</strong>：直接报错返回给用户（如：“当前内容已被编辑，请刷新”）。适合用户编辑表单的场景。</li>
<li><strong>Retry（自动重试）</strong>：代码里写个循环，重新查一遍最新数据再试一次。适合库存扣减、积分累加等场景。</li>
</ol>
<hr/>
<h2 data-id="heading-12">五、 总结与选型指南</h2>
<p>在处理“多原子化操作”（即无法用单条 SQL 解决的复杂业务）时，我们需要做如下决策：</p>



































<table><thead><tr><th align="left">维度</th><th align="left">悲观锁 (Pessimistic)</th><th align="left">乐观锁 (Optimistic)</th></tr></thead><tbody><tr><td align="left"><strong>机制</strong></td><td align="left"><strong>先锁后干</strong> (SELECT FOR UPDATE)</td><td align="left"><strong>干完再查</strong> (Version check)</td></tr><tr><td align="left"><strong>并发性能</strong></td><td align="left">低 (串行排队)</td><td align="left">高 (并行奔跑)</td></tr><tr><td align="left"><strong>冲突处理</strong></td><td align="left">阻塞等待</td><td align="left">报错或重试</td></tr><tr><td align="left"><strong>适用场景</strong></td><td align="left"><strong>高并发写、强竞争</strong><br/>(秒杀、支付)</td><td align="left"><strong>低并发写、读多写少</strong><br/>(编辑资料、CMS后台)</td></tr><tr><td align="left"><strong>生活类比</strong></td><td align="left">只有一个厕所坑位，进去就反锁门，后面的人排队。</td><td align="left">开放式文档编辑，提交时发现版本落后，需要合并或重写。</td></tr></tbody></table>
<h3 data-id="heading-13">🚀 极速判断心法：决策流程图</h3>
<ol>
<li>
<p><strong>写代码前问一句：</strong> 会有两个人同时操作这条数据吗？</p>
<ul>
<li><strong>No</strong> -&gt; 随便写。</li>
<li><strong>Yes</strong> -&gt; 继续往下。</li>
</ul>
</li>
<li>
<p><strong>能一条 SQL 更新吗？</strong> (比如 <code>increment</code>)</p>
<ul>
<li><strong>Yes</strong> -&gt; 用它！(原子操作，最安全)</li>
<li><strong>No</strong> -&gt; 继续往下。</li>
</ul>
</li>
<li>
<p><strong>判断业务场景：</strong></p>
<ul>
<li><strong>单纯多步写</strong> (如：先 Insert A，再 Update B)
<ul>
<li>👉 <strong>纯事务</strong> (保证原子性)。</li>
</ul>
</li>
<li><strong>先读后写</strong> (如：Check-then-Act)
<ul>
<li>👉 <strong>上锁 + 事务</strong>。根据竞争程度二选一：
<ul>
<li><strong>冲突高/后果严重</strong>（如库存、金额） -&gt; <strong>悲观锁</strong> (<code>For Update</code>)。</li>
<li><strong>冲突低/后果轻微</strong>（如提示重试） -&gt; <strong>乐观锁</strong> (<code>version</code>)。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nginx 反向代理 403 问题复盘]]></title>    <link>https://juejin.cn/post/7582787460419338282</link>    <guid>https://juejin.cn/post/7582787460419338282</guid>    <pubDate>2025-12-13T05:42:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582787460419338282" data-draft-id="7582857981893984297" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nginx 反向代理 403 问题复盘"/> <meta itemprop="keywords" content="Nginx"/> <meta itemprop="datePublished" content="2025-12-13T05:42:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AlianNiew"/> <meta itemprop="url" content="https://juejin.cn/user/928405543463528"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nginx 反向代理 403 问题复盘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/928405543463528/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AlianNiew
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T05:42:23.000Z" title="Sat Dec 13 2025 05:42:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Nginx 反向代理 403 问题复盘</h2>
<h3 data-id="heading-1">一、问题现象</h3>
<ul>
<li>浏览器访问：</li>
</ul>
<pre><code class="hljs language-perl" lang="perl">
[https:<span class="hljs-regexp">//</span>www.alancode.top/api/search?keyword=王菲&amp;limit=<span class="hljs-number">5</span>](https:<span class="hljs-regexp">//</span>www.alancode.top/api/search?keyword=%E7%<span class="hljs-number">8</span>E%<span class="hljs-number">8</span>B%E8%<span class="hljs-number">8</span>F%B2&amp;limit=<span class="hljs-number">5</span>)

</code></pre>
<p>返回 <strong>403 Forbidden</strong></p>
<ul>
<li>
<p>Nginx 日志显示：</p>
</li>
<li>
<p>请求已成功转发到上游服务器</p>
</li>
<li>
<p>状态码 <strong>200</strong></p>
</li>
<li>
<p>响应体长度为 <strong>0</strong></p>
</li>
<li>
<p>上游服务器（60.204.147.98）日志显示：</p>
</li>
<li>
<p>请求正常接收</p>
</li>
<li>
<p>内部请求成功返回数据（200）</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-2">二、问题本质</h3>
<p><strong>请求到达了上游，响应也生成了，但在 Nginx 反向代理层被拦截 / 丢弃，最终导致前端收到 403。</strong></p>
<p>这是一个典型的：</p>
<blockquote>
<p><strong>Header 配置错误导致的反向代理层问题</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-3">三、具体错误点</h3>
<h4 data-id="heading-4">1️⃣ HTTP Header 拼写错误（致命）</h4>
<pre><code class="hljs language-nginx" lang="nginx">proxy_set_header X-For/warded-Proto $scheme;
</code></pre>
<ul>
<li>Header 名包含 <code>/</code>，属于 <strong>非法 HTTP Header</strong></li>
<li>Nginx 不会报错，但该 Header 会被忽略</li>
<li>上游服务无法识别请求来源协议（http / https）</li>
<li>在 HTTPS 场景下，极易触发 <strong>403 / 强制拒绝</strong></li>
</ul>
<p>✅ 正确写法：</p>
<pre><code class="hljs language-bash" lang="bash">proxy_set_header X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;
</code></pre>
<hr/>
<h4 data-id="heading-5">2️⃣ Host 头转发错误（高频踩坑点）</h4>
<pre><code class="hljs language-bash" lang="bash">proxy_set_header Host <span class="hljs-variable">$host</span>;
</code></pre>
<ul>
<li>
<p><code>$host</code> 是客户端请求的域名（如 <code>www.alancode.top</code>）</p>
</li>
<li>
<p>但真实上游是 IP + 端口</p>
</li>
<li>
<p>当上游存在：</p>
<ul>
<li>Host 校验</li>
<li>防盗链</li>
<li>WAF / 安全策略</li>
</ul>
</li>
<li>
<p>就可能直接拒绝请求（403）</p>
</li>
</ul>
<p>✅ 正确写法：</p>
<pre><code class="hljs language-bash" lang="bash">proxy_set_header Host <span class="hljs-variable">$proxy_host</span>;
</code></pre>
<p>或：</p>
<pre><code class="hljs language-ini" lang="ini">proxy_set_header Host 60.204.147.98<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h4 data-id="heading-6">3️⃣ 表象迷惑点：Nginx access log 显示 200</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"GET /search?... HTTP/1.0"</span> <span class="hljs-number">200</span> <span class="hljs-number">0</span>
</code></pre>
<ul>
<li><code>200</code>：说明上游返回成功</li>
<li><code>0</code>：说明 <strong>响应体未成功返回给客户端</strong></li>
<li>实际响应在代理层被中断或拒绝</li>
</ul>
<p>⚠️ 这是反向代理问题的重要信号</p>
<hr/>
<h3 data-id="heading-7">四、最终正确配置</h3>
<pre><code class="hljs language-ini" lang="ini">location /api/ {
    proxy_pass http://60.204.147.98:15001/<span class="hljs-comment">;</span>

    proxy_http_version 1.1<span class="hljs-comment">;</span>

    proxy_set_header Host $proxy_host<span class="hljs-comment">;</span>
    proxy_set_header X-Real-IP $remote_addr<span class="hljs-comment">;</span>
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class="hljs-comment">;</span>
    proxy_set_header X-Forwarded-Proto $scheme<span class="hljs-comment">;</span>

    proxy_redirect off<span class="hljs-comment">;</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-8">五、经验总结（Checklist）</h3>
<ul>
<li>❌ 不要随意拼写 Header 名（Nginx 不一定报错）</li>
<li>❌ 不要盲目使用 <code>$host</code> 转发给 IP 型上游</li>
<li>✅ 反向代理 HTTPS 时一定要传 <code>X-Forwarded-Proto</code></li>
<li>✅ <code>200 + 响应体为 0</code> 高概率是代理层问题</li>
<li>✅ 出现 403 时，不要只盯后端日志</li>
</ul>
<hr/>
<h3 data-id="heading-9">六、一句话总结</h3>
<blockquote>
<p><strong>反向代理问题，80% 是 Header；403 不一定是后端拒绝，很可能是 Nginx 帮你“挡”了请求。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 PHP 解析 Protobuf 的坑与解法]]></title>    <link>https://juejin.cn/post/7582849187865264179</link>    <guid>https://juejin.cn/post/7582849187865264179</guid>    <pubDate>2025-12-13T06:04:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582849187865264179" data-draft-id="7582815307440046131" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 PHP 解析 Protobuf 的坑与解法"/> <meta itemprop="keywords" content="PHP,protobuf"/> <meta itemprop="datePublished" content="2025-12-13T06:04:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏琢玉"/> <meta itemprop="url" content="https://juejin.cn/user/3551890356308556"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 PHP 解析 Protobuf 的坑与解法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3551890356308556/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏琢玉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T06:04:26.000Z" title="Sat Dec 13 2025 06:04:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前阵子做的一个直播弹幕的机器人，其中有一部分上游数据是通过 Protobuf 返回的。几个朋友问我怎么处理，但我发现大家对「PHP 解析 Protobuf」这件事多少有点迷糊。确实，PHP 处理 Protobuf 的资料不多，而且踩坑成本不算低。</p>
<p>这篇文章不打算科普什么，也没有推荐任何技术栈的意思，就是把我自己摸索的过程整理出来，给遇到类似问题的人一个参考。</p>
<hr/>
<h2 data-id="heading-0">Protobuf 是什么</h2>
<p>很多人第一次接触它时，会把它和 JSON、XML 放在一起理解，但 Protobuf 并不是“另一个 JSON”。它是一种 ​<strong>基于 Schema 的二进制数据格式</strong>，本质上由两个部分组成：</p>
<ul>
<li>​<code>.proto</code>：数据结构的描述文件（类似字典）</li>
<li>二进制格式：根据 <code>.proto</code> 规则编码出来的数据</li>
</ul>
<p>Google 发明它的原因大致是：</p>
<ul>
<li>JSON 太大、太慢</li>
<li>在高性能、跨语言通信场景里不够理想</li>
<li>服务端内部大量 RPC 调用时，序列化效率太重要了</li>
</ul>
<p>于是有了 Protobuf：数据格式紧凑、序列化速度快、跨语言支持也强。</p>
<p>它不是为了可读性，而是为了性能。</p>
<hr/>
<h2 data-id="heading-1">PHP 解析 Protobuf 为什么麻烦</h2>
<p>PHP 能解析 Protobuf，但体验不如其他语言。原因有几个，简单列一下：</p>
<h3 data-id="heading-2">PHP 无法动态解析 Schema</h3>
<p>像 Go、Python、Java 这类语言可以依靠 descriptor 动态解析 Protobuf 数据结构，甚至可以在运行期处理未知结构。</p>
<p>PHP 目前做不到，没有暴露那一套 API。</p>
<p>所以 PHP ​<strong>必须依赖 .proto 文件</strong>，并且必须提前用 protoc 生成对应的 PHP 类。</p>
<h3 data-id="heading-3">PHP 的 Protobuf 扩展是“最小实现”</h3>
<p>google/protobuf 的 PHP 扩展只提供：</p>
<ul>
<li>序列化：serialize</li>
<li>反序列化：mergeFrom</li>
<li>基本的 getter/setter 机制</li>
</ul>
<p>其他高级能力基本没有。</p>
<h3 data-id="heading-4">PHP 的生态也不会把“解析二进制协议”当作主要用途</h3>
<p>PHP 的常见使用场景偏 Web，因此处理二进制协议并不是重点。</p>
<h3 data-id="heading-5">并不是我们主动选择 Protobuf</h3>
<p>在一些服务里，上游服务已经定死使用 Protobuf；或者 PHP 服务只是边缘网关，需要解析一次再转发。</p>
<p>在这种情况下，只有硬着头皮支持。</p>
<p>如果是自己的项目，并没有强约束，其实 JSON 足够了。</p>
<hr/>
<h2 data-id="heading-6">PHP 如何使用 Protobuf</h2>
<p>我自己在服务器上没有安装 Protobuf 扩展，而是采用更常见的一种方式：</p>
<ul>
<li>本地安装 <code>protoc</code></li>
<li>用 <code>.proto</code> 文件生成 PHP 类</li>
<li>服务器端只需要安装 <code>google/protobuf</code> 包即可完成解析</li>
</ul>
<h3 data-id="heading-7">第一步：安装运行时库</h3>
<pre><code class="hljs language-bash" lang="bash">composer require google/protobuf
</code></pre>
<p>这是 PHP 解析 Protobuf 所需的唯一运行时依赖。</p>
<h3 data-id="heading-8">第二步：安装 protoc（在本地）</h3>
<p>protoc 是官方编译器，用于把 <code>.proto</code> 文件生成各种语言的类（包括 PHP）。</p>
<p>下载地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fprotocolbuffers%2Fprotobuf%2Freleases" target="_blank" title="https://github.com/protocolbuffers/protobuf/releases" ref="nofollow noopener noreferrer">github.com/protocolbuf…</a></p>
<p>选择对应平台的压缩包，解压后把 <code>protoc</code> 放到 PATH 中即可。</p>
<p>验证是否安装成功：</p>
<pre><code class="hljs language-bash" lang="bash">protoc --version
</code></pre>
<hr/>
<h2 data-id="heading-9">.proto 文件是什么</h2>
<p>​<code>.proto</code> 文件可以简单理解为“数据结构的一份字典”。</p>
<p>因为 Protobuf 的二进制格式里没有字段名，只有字段编号（tag）。</p>
<p>例如：</p>
<pre><code class="hljs language-text" lang="text">field #1:  123
field #2: "Alice"
</code></pre>
<p>你不知道 #1 是 <code>id</code>​ 还是 <code>age</code>​，也不知道 #2 是 <code>name</code> 还是别的东西。</p>
<p>所以必须依靠 <code>.proto</code> 文件才能解码。</p>
<hr/>
<h2 data-id="heading-10">使用 protoc 生成 PHP 类</h2>
<p>我本地的命令大致如下：</p>
<pre><code class="hljs language-bash" lang="bash">protoc --php_out=./protobuf \
       --proto_path=./protobuf \
       xxx.proto
</code></pre>
<p>含义如下：</p>
<ul>
<li>​<code>--php_out</code>：生成的 PHP 文件存放位置</li>
<li>​<code>--proto_path</code>​：寻找 <code>.proto</code> 的目录</li>
<li>多个 .proto 可以一起编译</li>
</ul>
<p>protoc 会根据 <code>.proto</code>​ 内容生成一堆 PHP 类，每个 <code>message</code> 对应一个 PHP 类，最终这些类会继承：</p>
<pre><code class="hljs language-text" lang="text">Google\Protobuf\Internal\Message
</code></pre>
<p>序列化、反序列化功能都来自这个基类。</p>
<hr/>
<h2 data-id="heading-11">配置 Composer autoload</h2>
<p>如果你希望通过命名空间加载生成的类，可以在 <code>composer.json</code> 中加一条：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"autoload"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"psr-4"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"Proto\\"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"protobuf/"</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后执行：</p>
<pre><code class="hljs language-bash" lang="bash">composer dumpautoload
</code></pre>
<hr/>
<h2 data-id="heading-12">在 PHP 中解析 Protobuf</h2>
<p>解析的核心方法是：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$msg</span>-&gt;<span class="hljs-title function_ invoke__">mergeFromString</span>(<span class="hljs-variable">$binary</span>)
</code></pre>
<p>读完后，数据结构会自动填充在 message 对象里。</p>
<hr/>
<h2 data-id="heading-13">在 PHP 中生成 Protobuf 数据</h2>
<p>序列化对应的方法是：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$binary</span> = <span class="hljs-variable">$msg</span>-&gt;<span class="hljs-title function_ invoke__">serializeToString</span>();
</code></pre>
<p>得到的就是一段 protobuf 二进制字符串，可以直接发送到网络或写入文件。</p>
<hr/>
<h2 data-id="heading-14">快速测试</h2>
<p>创建一个项目，目录结构如下：</p>
<pre><code class="hljs language-bash" lang="bash">.
├── protobuf
│   └── TEST_USER_INFO.proto
└── test.php
</code></pre>
<h3 data-id="heading-15">TEST_USER_INFO.proto</h3>
<pre><code class="hljs language-proto" lang="proto">syntax = "proto3";

option php_namespace = "TestUserInfo";

message User {
  int32 id = 1;
  string name = 2;
}
</code></pre>
<h3 data-id="heading-16">test.php</h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">require</span> <span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">'/vendor/autoload.php'</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">TestUserInfo</span>\<span class="hljs-title">User</span>;

<span class="hljs-variable">$u1</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
<span class="hljs-variable">$u1</span>-&gt;<span class="hljs-title function_ invoke__">setId</span>(<span class="hljs-number">7</span>);
<span class="hljs-variable">$u1</span>-&gt;<span class="hljs-title function_ invoke__">setName</span>(<span class="hljs-string">"PHP Encode Test"</span>);

<span class="hljs-variable">$bin</span> = <span class="hljs-variable">$u1</span>-&gt;<span class="hljs-title function_ invoke__">serializeToString</span>();

<span class="hljs-variable">$u2</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
<span class="hljs-variable">$u2</span>-&gt;<span class="hljs-title function_ invoke__">mergeFromString</span>(<span class="hljs-variable">$bin</span>);

<span class="hljs-title function_ invoke__">var_dump</span>([
    <span class="hljs-string">'原始数据'</span> =&gt; <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-variable">$bin</span>),
    <span class="hljs-string">'id'</span> =&gt; <span class="hljs-variable">$u2</span>-&gt;<span class="hljs-title function_ invoke__">getId</span>(),
    <span class="hljs-string">'name'</span> =&gt; <span class="hljs-variable">$u2</span>-&gt;<span class="hljs-title function_ invoke__">getName</span>(),
]);
</code></pre>
<hr/>
<h3 data-id="heading-17">安装运行时库</h3>
<pre><code class="hljs language-bash" lang="bash">composer require google/protobuf
</code></pre>
<hr/>
<h3 data-id="heading-18">编译 .proto 文件</h3>
<pre><code class="hljs language-bash" lang="bash">protoc --php_out=./protobuf --proto_path=./protobuf TEST_USER_INFO.proto
</code></pre>
<p>这会在 <code>protobuf/</code> 目录下生成 PHP 类文件，供 PHP 使用。</p>
<hr/>
<h3 data-id="heading-19">配置 Composer autoload</h3>
<p>在 <code>composer.json</code> 中增加命名空间映射，例如：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"google/protobuf"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.33"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"autoload"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"psr-4"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"GPBMetadata\\"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"protobuf/GPBMetadata"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"TestUserInfo\\"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"protobuf/TestUserInfo"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后重新加载 Composer 自动加载：</p>
<pre><code class="hljs language-bash" lang="bash">composer clear-cache &amp;&amp; composer dump-autoload -o
</code></pre>
<h3 data-id="heading-20">运行测试</h3>
<pre><code class="hljs language-bash" lang="bash">php test.php
</code></pre>
<p>运行后，你会看到序列化再反序列化的数据被正确输出，证明 PHP 成功处理了 Protobuf 数据。</p>
<h2 data-id="heading-21">写在最后</h2>
<p>PHP 解析 Protobuf 的体验确实不算好，但能用，并且在某些需要兼容上游服务的场景里还是必须用。<br/>
如果你也正在处理类似的数据，希望这篇文章能帮你少踩点坑。</p>
<p>如果感觉文章里哪部分还没说清楚，欢迎继续交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 集成 ElasticSearch 的简单示例]]></title>    <link>https://juejin.cn/post/7582863493259624500</link>    <guid>https://juejin.cn/post/7582863493259624500</guid>    <pubDate>2025-12-13T07:12:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582863493259624500" data-draft-id="7582848701268033571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 集成 ElasticSearch 的简单示例"/> <meta itemprop="keywords" content="Spring Boot,设计"/> <meta itemprop="datePublished" content="2025-12-13T07:12:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Somehow007"/> <meta itemprop="url" content="https://juejin.cn/user/2425968473158731"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 集成 ElasticSearch 的简单示例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2425968473158731/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Somehow007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T07:12:59.000Z" title="Sat Dec 13 2025 07:12:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>示例采用 Spring Boot 3.0.7、 ElasticSearch 8.16.0，其中 es 为本地配置的单机服务</p>
<h3 data-id="heading-0">1. 下载 ElastiSearch</h3>
<p>官方 GitHub 上目前只有源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Felasticsearch" target="_blank" title="https://github.com/elastic/elasticsearch" ref="nofollow noopener noreferrer">github.com/elastic/ela…</a>，并没有发布二进制文件，因此推荐使用 docker 来下载。</p>
<p>官方提供了一个 docker 下载的脚本：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Fstart-local" target="_blank" title="https://github.com/elastic/start-local" ref="nofollow noopener noreferrer">github.com/elastic/sta…</a></p>
<p>这里简单进行介绍一下：</p>
<h4 data-id="heading-1">1.1. 系统要求</h4>
<ul>
<li>支持 Windows（需下载 WSL2）、Linux、macOS</li>
<li>需要有 docker</li>
<li>需要至少 5GB 的硬盘空间</li>
</ul>
<p>其中 Windows 和 macOS 推荐下载 docker-desktop：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.docker.com%2Fproducts%2Fdocker-desktop%2F" target="_blank" title="https://www.docker.com/products/docker-desktop/" ref="nofollow noopener noreferrer">www.docker.com/products/do…</a></p>
<h4 data-id="heading-2">1.2. 安装</h4>
<p>终端里输入一下命令（需确保docker-desktop启动），可指定版本</p>
<pre><code class="hljs language-sql" lang="sql">curl <span class="hljs-operator">-</span>fsSL https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>elastic.co<span class="hljs-operator">/</span><span class="hljs-keyword">start</span><span class="hljs-operator">-</span><span class="hljs-keyword">local</span> <span class="hljs-operator">|</span> sh <span class="hljs-operator">-</span>s <span class="hljs-comment">-- -v 8.16.0</span>
</code></pre>
<ul>
<li>该命令会下载脚本并执行，创建<code>elastic-start-local/</code> 目录，以及在目录里生成必要的配置文件，比如.env、docker-compose.yml，还会自动拉取官方镜像并启动容器。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53d521aa4d29499cb442a34fbd70bda5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU29tZWhvdzAwNw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766214779&amp;x-signature=FAJurrfuJtrvMLhXBkJCR0VOhxY%3D" alt="" loading="lazy"/></p>
<ul>
<li>会包含 Elastic 企业版30天使用许可证，30天后自动降级为Basic（免费开源版）</li>
<li>还会设置安全访问和控制</li>
</ul>

<ul>
<li>
<ul>
<li>自动生成强密码（存储在.env文件，注意，如果需要更改密码，在.env里更改是不会生效的，需要到docker里es的容器中去更改）</li>
<li>自动生成 <strong>API Key</strong></li>
<li><strong>仅绑定 localhost</strong></li>
<li><strong>禁用 HTTPS</strong>（仅 HTTP + Basic Auth），适合本地调试。</li>
</ul>
</li>
</ul>

<ul>
<li>该脚本的其他详细特性可自行去官网查看。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58f6a918aaba409db04e518dc9d858b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU29tZWhvdzAwNw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766214779&amp;x-signature=T7LkC2Xkp8DYc3Vshny3wr0S%2BjE%3D" alt="" loading="lazy"/></p>
<p>安装成功的页面</p>
<p>elastic-search端口在9200，kibana（es可视化控制台）在5601</p>
<h4 data-id="heading-3">1.3. 安装 ik 中文分词器</h4>
<p><strong>ElasticSearch 默认的分词器对中文支持很差</strong>，因此我们需要安装专门的中文分词器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Finfinilabs%2Fanalysis-ik%2Fblob%2Fmaster%2FREADME.md" target="_blank" title="https://github.com/infinilabs/analysis-ik/blob/master/README.md" ref="nofollow noopener noreferrer">github.com/infinilabs/…</a></p>
<p>我们需要在 docker 中打开 elasticsearch 的容器（一般叫做 <strong>es-local-dev</strong>），然后将 ik 分词器安装至 bin/elasticsearch-plugin 目录。</p>
<p>安装命令如下：</p>
<pre><code class="hljs language-bash" lang="bash">bin/elasticsearch-plugin install https://get.infini.cloud/elasticsearch/analysis-ik/8.16.0
</code></pre>
<p>如果你下载了docker exec，可以更便捷的通过可视化进入容器中</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8aa89d113094c81960fe57d9e351e7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU29tZWhvdzAwNw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766214779&amp;x-signature=zk%2FKVBWQr6Nw3gh6ke6fZCHYiAc%3D" alt="" loading="lazy"/></p>
<p>这里我们直接点击 es-local-dev，然后再选择 exec</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffe92ac538b34404a68b9d2f19b23d16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU29tZWhvdzAwNw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766214779&amp;x-signature=aGOaqO5wyW7xXorMeVGoF5EURyw%3D" alt="" loading="lazy"/></p>
<p>此时就可以在这里的终端输入上述的安装命令。</p>
<p>最后，我们在终端里输入</p>
<pre><code class="hljs language-bash" lang="bash">bin/elasticsearch-plugin list
</code></pre>
<p>如果出现 analysis-ik，就完成了下载！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99d42f0bc8294741ad6b9f9358766a8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU29tZWhvdzAwNw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766214779&amp;x-signature=USJkcj36ygnDbQ%2BVDe8pTjcgFco%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">2. 使用示例</h3>
<h4 data-id="heading-5">2.1. 首先导入依赖</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ElasticSearch --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>不需要指定版本，一般 Spring Boot 项目会继承 Spring Boot Starter Parent，或者使用 dependencyManagement。如果都没有，版本号指定为 Spring Boot 的版本号即可。</p>
<h4 data-id="heading-6">2.2. 配置 application.yaml</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">data:</span>
    <span class="hljs-attr">elasticsearch:</span>
      <span class="hljs-attr">repositories:</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-string">//</span> <span class="hljs-string">启用</span> <span class="hljs-string">Spring</span> <span class="hljs-string">Data</span> <span class="hljs-string">Elasticsearch</span> <span class="hljs-string">的</span> <span class="hljs-string">Repository</span> <span class="hljs-string">自动代理功能</span>
  <span class="hljs-attr">elasticsearch:</span>
    <span class="hljs-attr">uris:</span> <span class="hljs-string">http://localhost:9200</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">elastic</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">你的密码</span>
</code></pre>
<h4 data-id="heading-7">2.3. 创建文档实体（ES 文档映射类）</h4>
<p>根据你要搜索的内容，创建文档实体</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Builder;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;
<span class="hljs-keyword">import</span> org.springframework.<span class="hljs-keyword">data</span>.<span class="hljs-keyword">annotation</span>.Id;
<span class="hljs-keyword">import</span> org.springframework.<span class="hljs-keyword">data</span>.elasticsearch.annotations.Document;
<span class="hljs-keyword">import</span> org.springframework.<span class="hljs-keyword">data</span>.elasticsearch.annotations.Field;
<span class="hljs-keyword">import</span> org.springframework.<span class="hljs-keyword">data</span>.elasticsearch.annotations.FieldType;

<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-comment">/**
 * ElasticSearch 文档实体类 | 博客文章
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@Document(indexName = <span class="hljs-string">"blog_articles"</span>)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleDocument</span> {

    <span class="hljs-comment">/**
     * 文档唯一标识
     */</span>
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> String id;

    <span class="hljs-comment">/**
     * 文章标题
     * 这里采用ik分词器
     * ik_smart用于建索引时粗粒度分词节省空间，ik_max_word用于搜索时细粒度分词提高召回率。
     */</span>
    <span class="hljs-meta">@Field(type = FieldType.Text, analyzer = <span class="hljs-string">"ik_smart"</span>, searchAnalyzer = <span class="hljs-string">"ik_max_word"</span>)</span>
    <span class="hljs-keyword">private</span> String title;

    <span class="hljs-comment">/**
     * 文章内容
     */</span>
    <span class="hljs-meta">@Field(type = FieldType.Text, analyzer = <span class="hljs-string">"ik_smart"</span>, searchAnalyzer = <span class="hljs-string">"ik_max_word"</span>)</span>
    <span class="hljs-keyword">private</span> String content;

    <span class="hljs-comment">/**
     * 作者id
     */</span>
    <span class="hljs-meta">@Field(type = FieldType.Keyword)</span> <span class="hljs-comment">// 不分词，用于精确匹配</span>
    <span class="hljs-keyword">private</span> String authorId;

    <span class="hljs-comment">/**
     * 创建时间
     */</span>
    <span class="hljs-meta">@Field(type = FieldType.Date)</span>
    <span class="hljs-keyword">private</span> Date createTime;
}
</code></pre>
<h4 data-id="heading-8">2.4. 创建 Respository：ES 的操作接口</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> io.github.somehow.mysite.dao.mapper;

<span class="hljs-keyword">import</span> io.github.somehow.mysite.elasticsearch.ArticleDocument;
<span class="hljs-keyword">import</span> org.springframework.data.domain.Page;
<span class="hljs-keyword">import</span> org.springframework.data.domain.Pageable;
<span class="hljs-keyword">import</span> org.springframework.data.elasticsearch.repository.ElasticsearchRepository;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * Elasticsearch 持久层 | 博客文章
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ArticleEsRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ElasticsearchRepository</span>&lt;ArticleDocument, String&gt; {

    <span class="hljs-comment">/**
     * 根据标题搜索文章
     *
     * <span class="hljs-doctag">@param</span> title 标题关键词
     * <span class="hljs-doctag">@param</span> pageable 分页参数
     * <span class="hljs-doctag">@return</span> 文章分页结果
     */</span>
    Page&lt;ArticleDocument&gt; <span class="hljs-title function_">findByTitleContaining</span><span class="hljs-params">(String title, Pageable pageable)</span>;

    <span class="hljs-comment">/**
     * 根据内容搜索文章
     *
     * <span class="hljs-doctag">@param</span> content 内容关键词
     * <span class="hljs-doctag">@param</span> pageable 分页参数
     * <span class="hljs-doctag">@return</span> 文章分页结果
     */</span>
    Page&lt;ArticleDocument&gt; <span class="hljs-title function_">findByContentContaining</span><span class="hljs-params">(String content, Pageable pageable)</span>;

    <span class="hljs-comment">/**
     * 根据作者ID列表搜索文章
     *
     * <span class="hljs-doctag">@param</span> authorIds 作者ID列表
     * <span class="hljs-doctag">@param</span> pageable 分页参数
     * <span class="hljs-doctag">@return</span> 文章分页结果
     */</span>
    Page&lt;ArticleDocument&gt; <span class="hljs-title function_">findByAuthorIdIn</span><span class="hljs-params">(List&lt;String&gt; authorIds, Pageable pageable)</span>;
}
</code></pre>
<ul>
<li>这里定义的方法不需要去实现，这是 <strong>Spring Data 的 Repository 动态代理机制</strong>，<strong>Spring 在启动时会根据方法名自动生成查询实现</strong>，因此无需手动编写代码。</li>
<li>注意，此处的 <strong>Page</strong> 是 <strong>org.springframework.data.domain.Page</strong>，如果你使用了 Mybatis-Plus，需要注意和Mybatis-Plus 的 Page 区别开。</li>
<li>ps：底层 ES 查询并不强制分页；不过，<strong>Repository</strong> 接口方法如果返回 <strong>Page</strong> 类型，会<strong>自动进行分页</strong>处理，这是<strong>框架层面的封装。</strong></li>
</ul>
<h4 data-id="heading-9">2.5. 在 Service 业务逻辑层编写 ES 的相关逻辑</h4>
<pre><code class="hljs language-ini" lang="ini">import cn.hutool.core.bean.BeanUtil<span class="hljs-comment">;</span>
import cn.hutool.core.util.IdUtil<span class="hljs-comment">;</span>
import cn.hutool.core.util.StrUtil<span class="hljs-comment">;</span>
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper<span class="hljs-comment">;</span>
import com.baomidou.mybatisplus.core.conditions.update.LambdaUpdateWrapper<span class="hljs-comment">;</span>
import com.baomidou.mybatisplus.core.metadata.IPage<span class="hljs-comment">;</span>
import com.baomidou.mybatisplus.core.toolkit.Wrappers<span class="hljs-comment">;</span>
import com.baomidou.mybatisplus.extension.plugins.pagination.Page<span class="hljs-comment">;</span>
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl<span class="hljs-comment">;</span>
import com.baomidou.mybatisplus.extension.toolkit.SqlHelper<span class="hljs-comment">;</span>
import io.github.somehow.mysite.commons.framework.exception.ClientException<span class="hljs-comment">;</span>
import io.github.somehow.mysite.dao.entity.ArticleDO<span class="hljs-comment">;</span>
import io.github.somehow.mysite.dao.entity.UserDO<span class="hljs-comment">;</span>
import io.github.somehow.mysite.dao.entity.UserFavoriteArticleDO<span class="hljs-comment">;</span>
import io.github.somehow.mysite.dao.mapper.ArticleEsRepository<span class="hljs-comment">;</span>
import io.github.somehow.mysite.dao.mapper.ArticleMapper<span class="hljs-comment">;</span>
import io.github.somehow.mysite.dao.mapper.UserFavoriteArticleMapper<span class="hljs-comment">;</span>
import io.github.somehow.mysite.dao.mapper.UserMapper<span class="hljs-comment">;</span>
import io.github.somehow.mysite.dto.req.article.*<span class="hljs-comment">;</span>
import io.github.somehow.mysite.dto.resp.ArticlePageQueryRespDTO<span class="hljs-comment">;</span>
import io.github.somehow.mysite.dto.resp.ArticleSelectRespDTO<span class="hljs-comment">;</span>
import io.github.somehow.mysite.elasticsearch.ArticleDocument<span class="hljs-comment">;</span>
import io.github.somehow.mysite.service.ArticleService<span class="hljs-comment">;</span>
import lombok.RequiredArgsConstructor<span class="hljs-comment">;</span>
import lombok.extern.slf4j.Slf4j<span class="hljs-comment">;</span>
import org.springframework.dao.DuplicateKeyException<span class="hljs-comment">;</span>
import org.springframework.data.domain.PageRequest<span class="hljs-comment">;</span>
import org.springframework.stereotype.Service<span class="hljs-comment">;</span>
import org.springframework.transaction.annotation.Transactional<span class="hljs-comment">;</span>
import org.springframework.util.CollectionUtils<span class="hljs-comment">;</span>

import java.util.Collections<span class="hljs-comment">;</span>
import java.util.List<span class="hljs-comment">;</span>
import java.util.Objects<span class="hljs-comment">;</span>
import java.util.stream.Collectors<span class="hljs-comment">;</span>

/**
 * 文章业务逻辑实现层
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class ArticleServiceImpl extends ServiceImpl&lt;ArticleMapper, ArticleDO&gt; implements ArticleService {

    private final ArticleEsRepository esRepository<span class="hljs-comment">;</span>
    private final UserMapper userMapper<span class="hljs-comment">;</span>

    @Override
    @Transactional
    public void createArticle(ArticleCreateReqDTO requestParam) {

        // 略，此处为文章创建逻辑，并填入数据库
        articleMapper.insert(articleDO)<span class="hljs-comment">;</span>

        // 需要将数据同步到 ElasticSearch 中
        ArticleDocument <span class="hljs-attr">doc</span> = ArticleDocument.builder()
                .id(articleDO.getId().toString())
                .title(requestParam.getTitle())
                .content(requestParam.getContent())
                .authorId(articleDO.getAuthorId().toString())
                .createTime(articleDO.getCreateTime())
                .build()<span class="hljs-comment">;</span>
        esRepository.save(doc)<span class="hljs-comment">;</span>
    }

    @Override
    public void updateArticle(ArticleUpdateReqDTO requestParam) {

        // 略，此处为更新操作
        baseMapper.update(updateWrapper)<span class="hljs-comment">;</span>

        // 更新ES中的文档
        ArticleDO <span class="hljs-attr">updatedArticle</span> = baseMapper.selectOne(Wrappers.lambdaQuery(ArticleDO.class)
                .eq(ArticleDO::getId, requestParam.getId())
                .eq(ArticleDO::getDelFlag, 0))<span class="hljs-comment">;</span>
        
        if (updatedArticle != null) {
            ArticleDocument <span class="hljs-attr">articleDocument</span> = ArticleDocument.builder()
                    .id(updatedArticle.getId().toString())
                    .title(updatedArticle.getTitle())
                    .content(updatedArticle.getContent())
                    .authorId(updatedArticle.getAuthorId().toString())
                    .createTime(updatedArticle.getCreateTime())
                    .build()<span class="hljs-comment">;</span>

            esRepository.save(articleDocument)<span class="hljs-comment">;</span>
        }
    }

    @Override
    public void deleteArticle(Long id) {

        // 略，此处为删除逻辑
        articleDO.setDelFlag(1)<span class="hljs-comment">;</span>
        baseMapper.update(articleDO, updateWrapper)<span class="hljs-comment">;</span>

        // 删除同步到 ES
        esRepository.deleteById(id.toString())<span class="hljs-comment">;</span>
    }

    @Override
    public IPage&lt;ArticlePageQueryRespDTO&gt; pageQueryArticle(ArticlePageQueryReqDTO requestParam) {
        // 构建ES分页参数
        PageRequest <span class="hljs-attr">pageRequest</span> = PageRequest.of(
                (int) (requestParam.getCurrent() - 1), 
                (int) requestParam.getSize())<span class="hljs-comment">;</span>
        
        // 获取搜索关键词
        String <span class="hljs-attr">keyword</span> = StrUtil.blankToDefault(requestParam.getKeyword(), <span class="hljs-string">""</span>)<span class="hljs-comment">;</span>
        
        // 获取搜索类型，默认按标题搜索
        String <span class="hljs-attr">searchType</span> = StrUtil.blankToDefault(requestParam.getSearchType(), <span class="hljs-string">"title"</span>)<span class="hljs-comment">;</span>
        
        org.springframework.data.domain.Page&lt;ArticleDocument&gt; esPage<span class="hljs-comment">;</span>
        switch (searchType) {
            case "title":
                // 按标题搜索
                <span class="hljs-attr">esPage</span> = esRepository.findByTitleContaining(keyword, pageRequest)<span class="hljs-comment">;</span>
                break<span class="hljs-comment">;</span>
            case "content":
                // 按内容搜索
                <span class="hljs-attr">esPage</span> = esRepository.findByContentContaining(keyword, pageRequest)<span class="hljs-comment">;</span>
                break<span class="hljs-comment">;</span>
            case "author":
                // 按作者搜索
                List&lt;UserDO&gt; <span class="hljs-attr">matchedUsers</span> = userMapper.selectByUsernameLike(keyword)<span class="hljs-comment">;</span>
                if (!CollectionUtils.isEmpty(matchedUsers)) {
                    List&lt;String&gt; <span class="hljs-attr">authorIds</span> = matchedUsers.stream()
                            .map(user -&gt; user.getId().toString())
                            .collect(Collectors.toList())<span class="hljs-comment">;</span>
                    <span class="hljs-attr">esPage</span> = esRepository.findByAuthorIdIn(authorIds, pageRequest)<span class="hljs-comment">;</span>
                } else {
                    // 没有匹配的用户，返回空结果
                    return new Page&lt;&gt;()<span class="hljs-comment">;</span>
                }
                break<span class="hljs-comment">;</span>
            default:
                // 默认按标题搜索
                <span class="hljs-attr">esPage</span> = esRepository.findByTitleContaining(keyword, pageRequest)<span class="hljs-comment">;</span>
                break<span class="hljs-comment">;</span>
        }
        
        // 将ES查询结果转换为需要的DTO格式
        if (esPage.hasContent()) {
            List&lt;Long&gt; <span class="hljs-attr">articleIds</span> = esPage.getContent().stream()
                    .map(doc -&gt; Long.valueOf(doc.getId()))
                    .collect(Collectors.toList())<span class="hljs-comment">;</span>
                    
            // 从数据库获取完整文章信息
            List&lt;ArticleDO&gt; <span class="hljs-attr">articles</span> = baseMapper.selectList(Wrappers.&lt;ArticleDO&gt;lambdaQuery()
                    .in(ArticleDO::getId, articleIds)
                    .eq(ArticleDO::getDelFlag, 0))<span class="hljs-comment">;</span>
            
            // 获取作者信息
            List&lt;Long&gt; <span class="hljs-attr">authorIds</span> = articles.stream()
                    .map(ArticleDO::getAuthorId)
                    .distinct()
                    .collect(Collectors.toList())<span class="hljs-comment">;</span>
            
            List&lt;UserDO&gt; <span class="hljs-attr">authors</span> = userMapper.selectList(Wrappers.&lt;UserDO&gt;lambdaQuery()
                    .in(UserDO::getId, authorIds))<span class="hljs-comment">;</span>
            
            // 构建返回结果
            List&lt;ArticlePageQueryRespDTO&gt; <span class="hljs-attr">records</span> = articles.stream()
                    .map(article -&gt; {
                        ArticlePageQueryRespDTO <span class="hljs-attr">dto</span> = new ArticlePageQueryRespDTO()<span class="hljs-comment">;</span>
                        dto.setId(article.getId())<span class="hljs-comment">;</span>
                        dto.setTitle(article.getTitle())<span class="hljs-comment">;</span>
                        dto.setSummary(article.getSummary())<span class="hljs-comment">;</span>
                        dto.setViewCount(article.getViewCount())<span class="hljs-comment">;</span>
                        dto.setFavoriteCount(article.getFavoriteCount())<span class="hljs-comment">;</span>
                        
                        // 设置作者名称
                        String <span class="hljs-attr">authorName</span> = authors.stream()
                                .filter(user -&gt; user.getId().equals(article.getAuthorId()))
                                .map(UserDO::getUsername)
                                .findFirst()
                                .orElse("")<span class="hljs-comment">;</span>
                        dto.setAuthorName(authorName)<span class="hljs-comment">;</span>
                        
                        return dto<span class="hljs-comment">;</span>
                    })
                    .collect(Collectors.toList())<span class="hljs-comment">;</span>
            
            // 构造MyBatis Plus分页对象
            IPage&lt;ArticlePageQueryRespDTO&gt; <span class="hljs-attr">result</span> = new Page&lt;&gt;(requestParam.getCurrent(), requestParam.getSize(), esPage.getTotalElements())<span class="hljs-comment">;</span>
            result.setRecords(records)<span class="hljs-comment">;</span>
            return result<span class="hljs-comment">;</span>
        } else {
            return new Page&lt;&gt;()<span class="hljs-comment">;</span>
        }
    }

}
</code></pre>
<h4 data-id="heading-10">2.6. Contriller 中设置 API 接口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.metadata.IPage;
<span class="hljs-keyword">import</span> io.github.somehow.mysite.commons.framework.result.Result;
<span class="hljs-keyword">import</span> io.github.somehow.mysite.commons.framework.web.Results;
<span class="hljs-keyword">import</span> io.github.somehow.mysite.dto.req.article.*;
<span class="hljs-keyword">import</span> io.github.somehow.mysite.dto.resp.ArticlePageQueryRespDTO;
<span class="hljs-keyword">import</span> io.github.somehow.mysite.dto.resp.ArticleSelectRespDTO;
<span class="hljs-keyword">import</span> io.github.somehow.mysite.service.ArticleService;
<span class="hljs-keyword">import</span> io.swagger.v3.oas.annotations.Operation;
<span class="hljs-keyword">import</span> io.swagger.v3.oas.annotations.tags.Tag;
<span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.*;

<span class="hljs-comment">/**
 * 文章数据控制层
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-meta">@Tag(name = <span class="hljs-string">"文章数据管理"</span>)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArticleService articleService;

    <span class="hljs-meta">@Operation(summary = <span class="hljs-string">"创建文章"</span>)</span>
    <span class="hljs-meta">@PostMapping(<span class="hljs-string">"/api/article/create"</span>)</span>
    <span class="hljs-keyword">public</span> Result&lt;<span class="hljs-built_in">Void</span>&gt; createArticle(<span class="hljs-meta">@RequestBody</span> ArticleCreateReqDTO requestParam) {
        articleService.createArticle(requestParam);
        <span class="hljs-keyword">return</span> Results.success();
    }

    <span class="hljs-meta">@Operation(summary = <span class="hljs-string">"更新文章"</span>)</span>
    <span class="hljs-meta">@PutMapping(<span class="hljs-string">"/api/article/update"</span>)</span>
    <span class="hljs-keyword">public</span> Result&lt;<span class="hljs-built_in">Void</span>&gt; updateArticle(<span class="hljs-meta">@RequestBody</span> ArticleUpdateReqDTO requestParam) {
        articleService.updateArticle(requestParam);
        <span class="hljs-keyword">return</span> Results.success();
    }

    <span class="hljs-meta">@Operation(summary = <span class="hljs-string">"删除文章"</span>)</span>
    <span class="hljs-meta">@DeleteMapping(<span class="hljs-string">"/api/article/delete/{id}"</span>)</span>
    <span class="hljs-keyword">public</span> Result&lt;<span class="hljs-built_in">Void</span>&gt; deleteArticle(<span class="hljs-meta">@PathVariable(<span class="hljs-string">"id"</span>)</span> String id) {
        articleService.deleteArticle(<span class="hljs-built_in">Long</span>.parseLong(id));
        <span class="hljs-keyword">return</span> Results.success();
    }

    <span class="hljs-meta">@Operation(summary = <span class="hljs-string">"分页搜索文章信息"</span>)</span>
    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"/api/article/search"</span>)</span>
    <span class="hljs-keyword">public</span> Result&lt;IPage&lt;ArticlePageQueryRespDTO&gt;&gt; pageQueryArticle(ArticlePageQueryReqDTO requestParam) {
        <span class="hljs-keyword">return</span> Results.success(articleService.pageQueryArticle(requestParam));
    }

}
</code></pre>
<p>如果有错误或纰漏，欢迎大家在评论区留言指正！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[周末拆解：QLExpress 如何做到不编译就能执行？]]></title>    <link>https://juejin.cn/post/7582814236584329254</link>    <guid>https://juejin.cn/post/7582814236584329254</guid>    <pubDate>2025-12-13T07:30:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582814236584329254" data-draft-id="7582849187865395251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 周末拆解：QLExpress 如何做到不编译就能执行？"/> <meta itemprop="keywords" content="后端,架构,算法"/> <meta itemprop="datePublished" content="2025-12-13T07:30:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             周末拆解：QLExpress 如何做到不编译就能执行？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T07:30:31.000Z" title="Sat Dec 13 2025 07:30:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、为什么要拆解这个轮子</h2>
<p>项目里用了 QLExpress 做规则引擎，配置满减规则、积分计算之类的需求。一直有几个疑问：</p>
<p><strong>疑问1：它不生成 class 文件，怎么执行 if 语句？</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">"if (amount &gt; 100) amount * 0.8"</span>;
<span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> runner.execute(script);  <span class="hljs-comment">// 直接就能跑？</span>
</code></pre>
<p><strong>疑问2：它怎么调用我自己写的 Java 类？</strong></p>
<pre><code class="hljs language-java" lang="java">runner.addFunctionOfClassMethod(<span class="hljs-string">"折扣"</span>, MyMath.class.getName(), <span class="hljs-string">"discount"</span>, ...);
<span class="hljs-comment">// 脚本里就能用：折扣(amount, 0.8)</span>
</code></pre>
<p><strong>疑问3：运算符优先级怎么保证？</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-string">"2 + 3 * 4"</span>  <span class="hljs-comment">// 怎么知道先算乘法？</span>
</code></pre>
<p>周末正好有时间，花了一天手写了一个 700 行的极简版，把这些问题都搞清楚了。</p>
<hr/>
<h2 data-id="heading-1">二、整体流程：从字符串到结果</h2>
<p>先看全局，QLExpress 把脚本执行分成三个阶段：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[脚本字符串] --&gt; B[词法分析&lt;br/&gt;Lexer]
    B --&gt; C[Token流]
    C --&gt; D[语法分析&lt;br/&gt;Parser]
    D --&gt; E[AST树]
    E --&gt; F[解释执行&lt;br/&gt;Interpreter]
    F --&gt; G[结果]
</code></pre>
<p><strong>举个例子</strong>：</p>
<pre><code class="hljs language-java" lang="java">输入脚本：<span class="hljs-keyword">if</span> (amount &gt; <span class="hljs-number">100</span>) amount * <span class="hljs-number">0.8</span>
上下文变量：amount = <span class="hljs-number">150</span>
</code></pre>
<h3 data-id="heading-2">阶段一：词法分析（把字符串切成词）</h3>
<pre><code class="hljs language-scss" lang="scss">输入："if (amount &gt; <span class="hljs-number">100</span>) amount * <span class="hljs-number">0.8</span>"
输出：<span class="hljs-selector-attr">[IF]</span> <span class="hljs-selector-attr">[LPAREN]</span> <span class="hljs-selector-attr">[IDENTIFIER:amount]</span> <span class="hljs-selector-attr">[GREATER]</span> <span class="hljs-selector-attr">[NUMBER:100]</span> <span class="hljs-selector-attr">[RPAREN]</span> 
      <span class="hljs-selector-attr">[IDENTIFIER:amount]</span> <span class="hljs-selector-attr">[MULTIPLY]</span> <span class="hljs-selector-attr">[NUMBER:0.8]</span>
</code></pre>
<p>就像中文分词，把一句话切成一个个单词。代码里用状态机实现，逐个字符扫描。</p>
<h3 data-id="heading-3">阶段二：语法分析（把词组装成树）</h3>
<pre><code class="hljs language-scss" lang="scss">Token流 → AST树

         IfNode
        /      \
   条件节点    执行节点
  (amount&gt;<span class="hljs-number">100</span>) (amount*<span class="hljs-number">0.8</span>)
       |            |
  BinaryOpNode  BinaryOpNode
    /    \        /    \
  amount <span class="hljs-number">100</span>   amount  <span class="hljs-number">0.8</span>
</code></pre>
<p>就像造句，把单词组成有结构的句子。代码里用递归下降实现，一层层往下解析。</p>
<h3 data-id="heading-4">阶段三：解释执行（遍历树算结果）</h3>
<pre><code class="hljs language-ini" lang="ini">遍历 IfNode：
  1. 先执行条件节点：150 &gt; <span class="hljs-attr">100</span> = <span class="hljs-literal">true</span>
  2. 因为条件为 true，执行 then 分支
  3. 执行 then 节点：150 * <span class="hljs-attr">0.8</span> = <span class="hljs-number">120</span>
  4. 返回结果：120
</code></pre>
<p>不生成字节码，直接用 Java 代码遍历树执行。</p>
<hr/>
<h2 data-id="heading-5">三、核心原理一：if 语句的秘密</h2>
<h3 data-id="heading-6">关键问题</h3>
<p>QLExpress 的 if 到底是什么？是 JVM 的 if 指令吗？</p>
<h3 data-id="heading-7">答案：用 Java 的 if 包装</h3>
<p><strong>先看 Groovy 的做法</strong>（编译成字节码）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Groovy 会把脚本编译成真正的 class</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Script123</span> {
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (amount &gt; <span class="hljs-number">100</span>) {  <span class="hljs-comment">// ← 这是 JVM 的 if 指令</span>
            <span class="hljs-keyword">return</span> amount * <span class="hljs-number">0.8</span>;
        }
    }
}
</code></pre>
<p><strong>再看 QLExpress 的做法</strong>（用 Java 代码模拟）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. Parser 解析时，识别 if 关键字</span>
<span class="hljs-keyword">if</span> (peek().getType() == TokenType.IF) {
    <span class="hljs-keyword">return</span> parseIfStatement();  <span class="hljs-comment">// 构造 IfNode</span>
}

<span class="hljs-comment">// 2. 构造 AST 节点</span>
IfNode {
    condition: BinaryOpNode(amount, &gt;, <span class="hljs-number">100</span>)
    thenBranch: BinaryOpNode(amount, *, <span class="hljs-number">0.8</span>)
}

<span class="hljs-comment">// 3. Interpreter 执行时</span>
<span class="hljs-keyword">private</span> Object <span class="hljs-title function_">interpretIf</span><span class="hljs-params">(IfNode node, Context context)</span> {
    <span class="hljs-comment">// 先计算条件表达式</span>
    <span class="hljs-type">Object</span> <span class="hljs-variable">condResult</span> <span class="hljs-operator">=</span> interpret(node.getCondition(), context);
    
    <span class="hljs-comment">// 用 Java 的 if 判断</span>
    <span class="hljs-keyword">if</span> (condResult <span class="hljs-keyword">instanceof</span> Boolean &amp;&amp; (Boolean) condResult) {
        <span class="hljs-keyword">return</span> interpret(node.getThenBranch(), context);  <span class="hljs-comment">// 执行 then 分支</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>核心差异</strong>：</p>
<pre><code class="hljs">Groovy：  脚本的 if → 编译成 JVM 的 if 指令
QLExpress：脚本的 if → 构造 IfNode → 用 Java 的 if 模拟执行
</code></pre>
<h3 data-id="heading-8">执行流程图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[脚本: if amount&gt;100] --&gt; B[Lexer识别关键字 IF]
    B --&gt; C[Parser.parseIfStatement]
    C --&gt; D[构造 IfNode]
    D --&gt; E[存储 condition 和 thenBranch]
    E --&gt; F[Interpreter.interpretIf]
    F --&gt; G[先执行 condition 节点]
    G --&gt; H{结果是 true?}
    H --&gt;|是| I[执行 thenBranch 节点]
    H --&gt;|否| J[返回 null]
    I --&gt; K[返回结果]
</code></pre>
<p><strong>关键代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Parser.java - 如何识别 if 语句</span>
<span class="hljs-keyword">private</span> ASTNode <span class="hljs-title function_">parseIfStatement</span><span class="hljs-params">()</span> {
    consumeToken(TokenType.IF);           <span class="hljs-comment">// 消费 'if'</span>
    consumeToken(TokenType.LPAREN);       <span class="hljs-comment">// 消费 '('</span>
    <span class="hljs-type">ASTNode</span> <span class="hljs-variable">condition</span> <span class="hljs-operator">=</span> parseExpression(); <span class="hljs-comment">// 递归解析条件（重点！）</span>
    consumeToken(TokenType.RPAREN);       <span class="hljs-comment">// 消费 ')'</span>
    <span class="hljs-type">ASTNode</span> <span class="hljs-variable">thenBranch</span> <span class="hljs-operator">=</span> parseExpression();<span class="hljs-comment">// 递归解析 then 分支（重点！）</span>
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IfNode</span>(condition, thenBranch, <span class="hljs-literal">null</span>);
}
</code></pre>
<hr/>
<h2 data-id="heading-9">四、核心原理二：如何调用自定义方法</h2>
<h3 data-id="heading-10">关键问题</h3>
<p>脚本里怎么调用 MyMath.discount 这个我自己写的方法？</p>
<h3 data-id="heading-11">答案：注册 + 反射</h3>
<p><strong>第一步：注册方法</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 用户代码</span>
runner.register(<span class="hljs-string">"MyMath"</span>, MyMath.class);

<span class="hljs-comment">// QLExpress 内部</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(String name, Class&lt;?&gt; clazz)</span> {
    context.registerFunction(name, clazz);  <span class="hljs-comment">// 存到 Map 里</span>
}
</code></pre>
<p><strong>第二步：解析函数调用</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 脚本："MyMath.discount(amount, 0.8)"</span>
<span class="hljs-comment">// Parser 识别到：IDENTIFIER.IDENTIFIER(...)</span>
<span class="hljs-keyword">private</span> ASTNode <span class="hljs-title function_">parseFunctionCall</span><span class="hljs-params">(String className, String methodName)</span> {
    List&lt;ASTNode&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-comment">// 解析参数列表</span>
    <span class="hljs-keyword">do</span> {
        args.add(parseExpression());  <span class="hljs-comment">// 递归解析每个参数</span>
    } <span class="hljs-keyword">while</span> (match(TokenType.COMMA));
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FunctionCallNode</span>(className, methodName, args);
}
</code></pre>
<p><strong>第三步：反射调用</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Interpreter.java</span>
<span class="hljs-keyword">private</span> Object <span class="hljs-title function_">interpretFunctionCall</span><span class="hljs-params">(FunctionCallNode node, Context context)</span> {
    <span class="hljs-comment">// 1. 从注册表找到类</span>
    Class&lt;?&gt; clazz = context.getFunctionClass(node.getClassName());
    
    <span class="hljs-comment">// 2. 准备参数</span>
    Object[] argValues = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[node.getArguments().size()];
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; argValues.length; i++) {
        argValues[i] = interpret(node.getArguments().get(i), context);
    }
    
    <span class="hljs-comment">// 3. 反射调用</span>
    <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> clazz.getMethod(node.getMethodName(), getArgTypes(argValues));
    <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-literal">null</span>, argValues);  <span class="hljs-comment">// 调用静态方法</span>
}
</code></pre>
<h3 data-id="heading-12">执行流程图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[注册: MyMath.class] --&gt; B[存入 Map]
    C[脚本: MyMath.discount] --&gt; D[Parser识别函数调用]
    D --&gt; E[构造 FunctionCallNode]
    E --&gt; F[Interpreter执行]
    F --&gt; G[从Map取出 MyMath.class]
    G --&gt; H[准备参数: 150, 0.8]
    H --&gt; I[反射: method.invoke]
    I --&gt; J[返回结果: 120]
</code></pre>
<p><strong>为什么安全？</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">只能调用注册过的类（白名单机制）
脚本里写 System.<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>) 也没用，因为没注册
</code></pre>
<hr/>
<h2 data-id="heading-13">五、核心原理三：运算符优先级如何保证</h2>
<h3 data-id="heading-14">关键问题</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-string">"2 + 3 * 4"</span>  <span class="hljs-comment">// 结果是 14，说明先算乘法</span>
</code></pre>
<p>Parser 怎么知道先算哪个？</p>
<h3 data-id="heading-15">答案：递归下降 + 调用链层次</h3>
<p><strong>调用链设计</strong>（优先级从低到高）：</p>
<pre><code class="hljs language-java" lang="java">parseExpression()       <span class="hljs-comment">// 入口</span>
    ↓
parseConditional()      <span class="hljs-comment">// if 语句（优先级最低）</span>
    ↓
parseComparison()       <span class="hljs-comment">// 比较运算 &gt;, &lt;, ==</span>
    ↓
parseTerm()             <span class="hljs-comment">// 加减运算 +, -</span>
    ↓
parseFactor()           <span class="hljs-comment">// 乘除运算 *, /</span>
    ↓
parsePrimary()          <span class="hljs-comment">// 基本元素（优先级最高）</span>
</code></pre>
<p><strong>为什么这样设计？</strong></p>
<p>看个例子：<code>2 + 3 * 4</code></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. <span class="hljs-built_in">parseExpression</span>() 调用 <span class="hljs-built_in">parseTerm</span>()
<span class="hljs-number">2</span>. <span class="hljs-built_in">parseTerm</span>() 先调用 <span class="hljs-built_in">parseFactor</span>() 解析左边
   <span class="hljs-built_in">parseFactor</span>() 解析 "<span class="hljs-number">2</span>"，返回 <span class="hljs-built_in">LiteralNode</span>(<span class="hljs-number">2</span>)
<span class="hljs-number">3</span>. <span class="hljs-built_in">parseTerm</span>() 看到 PLUS，继续解析右边
<span class="hljs-number">4</span>. 右边调用 <span class="hljs-built_in">parseFactor</span>() 解析 "<span class="hljs-number">3</span> * <span class="hljs-number">4</span>"
<span class="hljs-number">5</span>. <span class="hljs-built_in">parseFactor</span>() 看到 "<span class="hljs-number">3</span>"，再看到 MULTIPLY
   它会继续解析，构造 <span class="hljs-built_in">BinaryOpNode</span>(<span class="hljs-number">3</span> * <span class="hljs-number">4</span>)
<span class="hljs-number">6</span>. <span class="hljs-built_in">parseTerm</span>() 拿到右边的结果：<span class="hljs-built_in">BinaryOpNode</span>(<span class="hljs-number">3</span> * <span class="hljs-number">4</span>)
<span class="hljs-number">7</span>. 最终构造：<span class="hljs-built_in">BinaryOpNode</span>(<span class="hljs-number">2</span> + (<span class="hljs-number">3</span> * <span class="hljs-number">4</span>))
</code></pre>
<p><strong>核心思想</strong>：</p>
<pre><code class="hljs">优先级高的运算符，在递归调用的更深层
所以会先被解析、先被计算
</code></pre>
<h3 data-id="heading-16">代码展示</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Parser.java</span>
<span class="hljs-keyword">private</span> ASTNode <span class="hljs-title function_">parseTerm</span><span class="hljs-params">()</span> {
    <span class="hljs-type">ASTNode</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> parseFactor();  <span class="hljs-comment">// 先解析高优先级的</span>
    
    <span class="hljs-keyword">while</span> (match(TokenType.PLUS, TokenType.MINUS)) {
        <span class="hljs-type">Token</span> <span class="hljs-variable">operator</span> <span class="hljs-operator">=</span> previous();
        <span class="hljs-type">ASTNode</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> parseFactor();  <span class="hljs-comment">// 递归解析右边</span>
        left = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BinaryOpNode</span>(operator.getType(), left, right);
    }
    
    <span class="hljs-keyword">return</span> left;
}

<span class="hljs-keyword">private</span> ASTNode <span class="hljs-title function_">parseFactor</span><span class="hljs-params">()</span> {
    <span class="hljs-type">ASTNode</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> parsePrimary();  <span class="hljs-comment">// 解析最高优先级的</span>
    
    <span class="hljs-keyword">while</span> (match(TokenType.MULTIPLY, TokenType.DIVIDE)) {
        <span class="hljs-type">Token</span> <span class="hljs-variable">operator</span> <span class="hljs-operator">=</span> previous();
        <span class="hljs-type">ASTNode</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> parsePrimary();  <span class="hljs-comment">// 递归解析右边</span>
        left = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BinaryOpNode</span>(operator.getType(), left, right);
    }
    
    <span class="hljs-keyword">return</span> left;
}
</code></pre>
<h3 data-id="heading-17">解析树对比</h3>
<pre><code class="hljs language-markdown" lang="markdown">错误的解析（如果不分优先级）：
<span class="hljs-bullet">    +</span>
   / \
  2   *
<span class="hljs-code">     / \
    3   4
</span>
正确的解析（parseFactor 先处理乘法）：
<span class="hljs-bullet">    +</span>
   / \
  2   *
<span class="hljs-code">     / \
    3   4
</span></code></pre>
<hr/>
<h2 data-id="heading-18">六、递归：贯穿始终的设计</h2>
<p>整个 QLExpress 的实现，到处都是递归：</p>
<h3 data-id="heading-19">递归一：解析时的递归下降</h3>
<pre><code class="hljs language-java" lang="java">ASTNode <span class="hljs-title function_">parseExpression</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (当前是<span class="hljs-keyword">if</span>) {
        <span class="hljs-type">ASTNode</span> <span class="hljs-variable">condition</span> <span class="hljs-operator">=</span> parseExpression();  <span class="hljs-comment">// 递归解析条件</span>
        <span class="hljs-type">ASTNode</span> <span class="hljs-variable">thenBranch</span> <span class="hljs-operator">=</span> parseExpression(); <span class="hljs-comment">// 递归解析分支</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IfNode</span>(condition, thenBranch, <span class="hljs-literal">null</span>);
    }
    <span class="hljs-keyword">return</span> parseComparison();  <span class="hljs-comment">// 继续递归</span>
}
</code></pre>
<p><strong>好处</strong>：</p>
<pre><code class="hljs language-css" lang="css">条件可以是任意复杂的表达式
if ((<span class="hljs-selector-tag">a</span> &gt; <span class="hljs-number">10</span> &amp;&amp; <span class="hljs-selector-tag">b</span> &lt; <span class="hljs-number">20</span>) || c == <span class="hljs-number">30</span>) ...
不需要单独处理，递归自动搞定
</code></pre>
<h3 data-id="heading-20">递归二：执行时的递归遍历</h3>
<pre><code class="hljs language-java" lang="java">Object <span class="hljs-title function_">interpret</span><span class="hljs-params">(ASTNode node, Context context)</span> {
    <span class="hljs-keyword">if</span> (node <span class="hljs-keyword">instanceof</span> IfNode) {
        <span class="hljs-type">Object</span> <span class="hljs-variable">cond</span> <span class="hljs-operator">=</span> interpret(node.getCondition(), context);  <span class="hljs-comment">// 递归</span>
        <span class="hljs-keyword">if</span> ((Boolean) cond) {
            <span class="hljs-keyword">return</span> interpret(node.getThenBranch(), context);     <span class="hljs-comment">// 递归</span>
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node <span class="hljs-keyword">instanceof</span> BinaryOpNode) {
        <span class="hljs-type">Object</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> interpret(node.getLeft(), context);        <span class="hljs-comment">// 递归</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> interpret(node.getRight(), context);      <span class="hljs-comment">// 递归</span>
        <span class="hljs-keyword">return</span> calculate(left, op, right);
    }
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>好处</strong>：</p>
<pre><code class="hljs">树有多深，自动递归多深
代码简洁，逻辑清晰
</code></pre>
<h3 data-id="heading-21">递归调用栈示例</h3>
<pre><code class="hljs language-scss" lang="scss">脚本：if (amount &gt; <span class="hljs-number">100</span>) amount * <span class="hljs-number">0.8</span>

执行时的调用栈：
<span class="hljs-built_in">interpret</span>(IfNode)
  ├─ <span class="hljs-built_in">interpret</span>(BinaryOpNode &gt;)
  │    ├─ <span class="hljs-built_in">interpret</span>(VariableNode amount) → <span class="hljs-number">150</span>
  │    └─ <span class="hljs-built_in">interpret</span>(LiteralNode <span class="hljs-number">100</span>) → <span class="hljs-number">100</span>
  │    └─ 返回 true
  └─ <span class="hljs-built_in">interpret</span>(BinaryOpNode *)
       ├─ <span class="hljs-built_in">interpret</span>(VariableNode amount) → <span class="hljs-number">150</span>
       └─ <span class="hljs-built_in">interpret</span>(LiteralNode <span class="hljs-number">0.8</span>) → <span class="hljs-number">0.8</span>
       └─ 返回 <span class="hljs-number">120</span>
</code></pre>
<hr/>
<h2 data-id="heading-22">七、关键代码展示</h2>
<h3 data-id="heading-23">词法分析器（Lexer）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> List&lt;Token&gt; <span class="hljs-title function_">tokenize</span><span class="hljs-params">(String script)</span> {
    List&lt;Token&gt; tokens = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-type">int</span> <span class="hljs-variable">position</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">while</span> (position &lt; script.length()) {
        <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> script.charAt(position);
        
        <span class="hljs-keyword">if</span> (Character.isWhitespace(c)) {
            position++;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Character.isDigit(c)) {
            tokens.add(readNumber(script, position));
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Character.isLetter(c)) {
            <span class="hljs-type">Token</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> readIdentifier(script, position);
            <span class="hljs-comment">// 检查是否是关键字</span>
            <span class="hljs-keyword">if</span> (token.getText().equals(<span class="hljs-string">"if"</span>)) {
                tokens.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Token</span>(TokenType.IF, <span class="hljs-string">"if"</span>));
            } <span class="hljs-keyword">else</span> {
                tokens.add(token);
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c == <span class="hljs-string">'&gt;'</span>) {
            tokens.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Token</span>(TokenType.GREATER, <span class="hljs-string">"&gt;"</span>));
            position++;
        }
        <span class="hljs-comment">// ...</span>
    }
    
    <span class="hljs-keyword">return</span> tokens;
}
</code></pre>
<h3 data-id="heading-24">语法分析器（Parser）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> ASTNode <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> parseExpression();
}

<span class="hljs-keyword">private</span> ASTNode <span class="hljs-title function_">parseExpression</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> parseConditional();
}

<span class="hljs-keyword">private</span> ASTNode <span class="hljs-title function_">parseConditional</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (peek().getType() == TokenType.IF) {
        <span class="hljs-keyword">return</span> parseIfStatement();
    }
    <span class="hljs-keyword">return</span> parseComparison();
}

<span class="hljs-keyword">private</span> ASTNode <span class="hljs-title function_">parseIfStatement</span><span class="hljs-params">()</span> {
    consumeToken(TokenType.IF);
    consumeToken(TokenType.LPAREN);
    <span class="hljs-type">ASTNode</span> <span class="hljs-variable">condition</span> <span class="hljs-operator">=</span> parseExpression();  <span class="hljs-comment">// 递归</span>
    consumeToken(TokenType.RPAREN);
    <span class="hljs-type">ASTNode</span> <span class="hljs-variable">thenBranch</span> <span class="hljs-operator">=</span> parseExpression(); <span class="hljs-comment">// 递归</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IfNode</span>(condition, thenBranch, <span class="hljs-literal">null</span>);
}
</code></pre>
<h3 data-id="heading-25">解释执行器（Interpreter）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">interpret</span><span class="hljs-params">(ASTNode node, Context context)</span> {
    <span class="hljs-keyword">if</span> (node <span class="hljs-keyword">instanceof</span> IfNode) {
        <span class="hljs-keyword">return</span> interpretIf((IfNode) node, context);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node <span class="hljs-keyword">instanceof</span> BinaryOpNode) {
        <span class="hljs-keyword">return</span> interpretBinaryOp((BinaryOpNode) node, context);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node <span class="hljs-keyword">instanceof</span> FunctionCallNode) {
        <span class="hljs-keyword">return</span> interpretFunctionCall((FunctionCallNode) node, context);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node <span class="hljs-keyword">instanceof</span> VariableNode) {
        <span class="hljs-keyword">return</span> context.getVariable(((VariableNode) node).getName());
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node <span class="hljs-keyword">instanceof</span> LiteralNode) {
        <span class="hljs-keyword">return</span> ((LiteralNode) node).getValue();
    }
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Unknown node type"</span>);
}

<span class="hljs-keyword">private</span> Object <span class="hljs-title function_">interpretBinaryOp</span><span class="hljs-params">(BinaryOpNode node, Context context)</span> {
    <span class="hljs-type">Object</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> interpret(node.getLeft(), context);   <span class="hljs-comment">// 递归</span>
    <span class="hljs-type">Object</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> interpret(node.getRight(), context); <span class="hljs-comment">// 递归</span>
    
    <span class="hljs-keyword">switch</span> (node.getOperator()) {
        <span class="hljs-keyword">case</span> PLUS:     <span class="hljs-keyword">return</span> (Double) left + (Double) right;
        <span class="hljs-keyword">case</span> MULTIPLY: <span class="hljs-keyword">return</span> (Double) left * (Double) right;
        <span class="hljs-keyword">case</span> GREATER:  <span class="hljs-keyword">return</span> (Double) left &gt; (Double) right;
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-26">八、三板斧总结</h2>
<p>回到最开始的问题，QLExpress 的核心就是三板斧：</p>
<h3 data-id="heading-27">第一斧：词法分析 + 语法分析 + AST</h3>
<pre><code class="hljs">字符串 → Token流 → AST树

技术：手写状态机 + 递归下降
目的：把脚本变成可操作的树形结构
</code></pre>
<h3 data-id="heading-28">第二斧：栈式递归执行</h3>
<pre><code class="hljs">遍历 AST 树，递归计算每个节点

技术：访问者模式 + 递归遍历
目的：用 Java 代码模拟脚本执行
</code></pre>
<h3 data-id="heading-29">第三斧：反射调用</h3>
<pre><code class="hljs language-javascript" lang="javascript">通过注册表 + 反射调用自定义方法

技术：<span class="hljs-title class_">Map</span> 存储 + <span class="hljs-title class_">Java</span> 反射
目的：安全地扩展脚本能力
</code></pre>
<hr/>
<h2 data-id="heading-30">九、对比真实的 QLExpress</h2>
<p>手写版本和真实的 QLExpress 有什么区别？</p>








































<table><thead><tr><th>维度</th><th>手写版</th><th>QLExpress</th></tr></thead><tbody><tr><td>词法分析</td><td>手写状态机</td><td>ANTLR 自动生成</td></tr><tr><td>语法分析</td><td>递归下降</td><td>ANTLR 自动生成</td></tr><tr><td>执行方式</td><td>AST 解释执行</td><td>指令虚拟机（QVM）</td></tr><tr><td>代码量</td><td>700 行</td><td>20000+ 行</td></tr><tr><td>功能完整性</td><td>基础功能</td><td>企业级完整</td></tr><tr><td>依赖</td><td>零依赖</td><td>antlr4-runtime</td></tr></tbody></table>
<p><strong>真实 QLExpress 的额外特性</strong>：</p>
<ul>
<li>变量赋值</li>
<li>循环语句（for/while）</li>
<li>函数定义</li>
<li>异常处理</li>
<li>性能优化（指令缓存、对象池）</li>
</ul>
<p>但核心思想是一样的：不生成 class，用 Java 代码模拟执行。</p>
<hr/>
<h2 data-id="heading-31">十、完整测试</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">MiniQLExpress</span> <span class="hljs-variable">runner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MiniQLExpress</span>();
        runner.register(<span class="hljs-string">"MyMath"</span>, MyMath.class);
        runner.getContext().addVariable(<span class="hljs-string">"amount"</span>, <span class="hljs-number">150.0</span>);
        
        test(runner, <span class="hljs-string">"2 + 3 * 4"</span>);
        test(runner, <span class="hljs-string">"if (amount &gt; 100) amount * 0.8"</span>);
        test(runner, <span class="hljs-string">"MyMath.discount(100, 0.8)"</span>);
        test(runner, <span class="hljs-string">"if (amount &gt; 100) MyMath.discount(amount, 0.8)"</span>);
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(MiniQLExpress runner, String script)</span> {
        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> runner.execute(script);
        System.out.println(<span class="hljs-string">"Result of \""</span> + script + <span class="hljs-string">"\": "</span> + result);
    }
}
</code></pre>
<p><strong>运行结果</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-type">Result</span> of <span class="hljs-string">"2 + 3 * 4"</span>: <span class="hljs-number">14.0</span>
<span class="hljs-type">Result</span> of <span class="hljs-string">"if (amount &gt; 100) amount * 0.8"</span>: <span class="hljs-number">120.0</span>
<span class="hljs-type">Result</span> of <span class="hljs-string">"MyMath.discount(100, 0.8)"</span>: <span class="hljs-number">80.0</span>
<span class="hljs-type">Result</span> of <span class="hljs-string">"if (amount &gt; 100) MyMath.discount(amount, 0.8)"</span>: <span class="hljs-number">120.0</span>
</code></pre>
<p>全部通过。</p>
<hr/>
<h2 data-id="heading-32">十一、收获</h2>
<p>花一天时间手写 700 行代码，搞清楚了几个问题：</p>
<p><strong>1. QLExpress 的 if 不是 JVM 的 if</strong></p>
<pre><code class="hljs">它是用 Java 的 if 包装出来的
所以不需要编译成字节码
</code></pre>
<p><strong>2. 反射不是魔法</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">提前注册 → 存 <span class="hljs-title class_">Map</span>
脚本调用 → 从 <span class="hljs-title class_">Map</span> 取 → method.<span class="hljs-property">invoke</span>
</code></pre>
<p><strong>3. 递归是灵魂</strong></p>
<pre><code class="hljs">解析时递归 → 可以处理任意嵌套
执行时递归 → 可以处理任意复杂度
</code></pre>
<p><strong>4. 不是所有轮子都需要 ANTLR</strong></p>
<pre><code class="hljs">简单场景，手写 Parser 足够了
代码清晰，容易调试
</code></pre>
<hr/>
<h2 data-id="heading-33">十二、代码获取</h2>
<p>完整代码已开源（700 行）：</p>
<ul>
<li>Lexer.java（词法分析）</li>
<li>Parser.java（语法分析）</li>
<li>Interpreter.java（解释执行）</li>
<li>AST 节点定义</li>
<li>完整测试用例</li>
</ul>
<p>可以直接运行，零依赖。</p>
<hr/>
<h2 data-id="heading-34">写在最后</h2>
<p>拆轮子的目的不是重复造轮子，而是理解原理。</p>
<p>下次用 QLExpress 的时候，心里就有底了：</p>
<ul>
<li>知道它为什么快（不编译）</li>
<li>知道它为什么安全（白名单）</li>
<li>知道它的局限（功能相对简单）</li>
</ul>
<p>周末愉快。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Paimon源码解读 -- FULL_COMPACTION_DELTA_COMMITS]]></title>    <link>https://juejin.cn/post/7582872365522173990</link>    <guid>https://juejin.cn/post/7582872365522173990</guid>    <pubDate>2025-12-13T08:01:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582872365522173990" data-draft-id="7582809606067830810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Paimon源码解读 -- FULL_COMPACTION_DELTA_COMMITS"/> <meta itemprop="keywords" content="后端,大数据,Flink"/> <meta itemprop="datePublished" content="2025-12-13T08:01:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="expect7g"/> <meta itemprop="url" content="https://juejin.cn/user/3514471387235735"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Paimon源码解读 -- FULL_COMPACTION_DELTA_COMMITS
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3514471387235735/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    expect7g
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T08:01:06.000Z" title="Sat Dec 13 2025 08:01:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文重点介绍Paimon压缩参数<code>full-compaction.delta-commits</code>的整体调用流程，涉及到CompactTask的详情：<a href="https://juejin.cn/post/7577609608828239898" target="_blank" title="https://juejin.cn/post/7577609608828239898">Paimon源码解读 -- Compaction-1.MergeTreeCompactTask</a></p>
<h2 data-id="heading-1">一.<code>full-compaction.delta-commits</code> 参数源码分析</h2>
<h3 data-id="heading-2">1️.参数定义（CoreOptions）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ConfigOption&lt;Integer&gt; FULL_COMPACTION_DELTA_COMMITS =
    key(<span class="hljs-string">"full-compaction.delta-commits"</span>)
        .intType()
        .noDefaultValue()  <span class="hljs-comment">// 没有默认值</span>
        .withDescription(
            <span class="hljs-string">"Full compaction will be constantly triggered after delta commits."</span>);
</code></pre>
<p><strong>关键信息：</strong></p>
<ul>
<li><strong>参数类型</strong>：<code>Integer</code></li>
<li><strong>默认值</strong>：无（<code>noDefaultValue()</code>）</li>
<li><strong>含义</strong>：经过指定数量的 delta 提交后，触发一次全量压缩</li>
</ul>
<h3 data-id="heading-3">2.入口<code>FlinkSink.createWriteProvider()</code></h3>
<p>CASE-1: write-only = true，后续走专用压缩任务<br/>
CASE-2: write-only = false，走自动压缩</p>
<ol>
<li><strong>优先使用 <code>full-compaction.delta-commits</code> 参数，其次使用 <code>compaction.optimization-interval</code> 参数</strong></li>
</ol>
<blockquote>
<p>deltaCommits参数取值</p>
<ul>
<li>等于full-compaction.delta-commits</li>
<li>等于(compaction.optimization-interval / cp间隔)取整</li>
</ul>
</blockquote>
<ol start="2">
<li>先判断是否配置了<code>changelog-producer = full-compaction</code> 或 配置了任意上面两个参数，走<code>GlobalFullCompactionSinkWrite</code></li>
<li>再判断是否配置了<code>force-lookup = true 且 lookup-wait = false</code>才走异步<code>AsyncLookupSinkWrite</code></li>
</ol>
<p>最后兜底<code>StoreSinkWriteImpl</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> StoreSinkWrite.Provider <span class="hljs-title function_">createWriteProvider</span><span class="hljs-params">(
        CheckpointConfig checkpointConfig, <span class="hljs-type">boolean</span> isStreaming, <span class="hljs-type">boolean</span> hasSinkMaterializer)</span> {
    <span class="hljs-type">SerializableRunnable</span> <span class="hljs-variable">assertNoSinkMaterializer</span> <span class="hljs-operator">=</span>
            () -&gt;
                    Preconditions.checkArgument(
                            !hasSinkMaterializer,
                            String.format(
                                    <span class="hljs-string">"Sink materializer must not be used with Paimon sink. "</span>
                                            + <span class="hljs-string">"Please set '%s' to '%s' in Flink's config."</span>,
                                    ExecutionConfigOptions.TABLE_EXEC_SINK_UPSERT_MATERIALIZE
                                            .key(),
                                    ExecutionConfigOptions.UpsertMaterialize.NONE.name()));

    <span class="hljs-type">Options</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> table.coreOptions().toConfiguration();
    <span class="hljs-type">ChangelogProducer</span> <span class="hljs-variable">changelogProducer</span> <span class="hljs-operator">=</span> table.coreOptions().changelogProducer();
    <span class="hljs-type">boolean</span> waitCompaction;
    <span class="hljs-type">CoreOptions</span> <span class="hljs-variable">coreOptions</span> <span class="hljs-operator">=</span> table.coreOptions();
    <span class="hljs-comment">// CASE-1: write-only = true，后续走专用压缩任务</span>
    <span class="hljs-keyword">if</span> (coreOptions.writeOnly()) {
        waitCompaction = <span class="hljs-literal">false</span>;
    }
    <span class="hljs-comment">// CASE-2: write-only = false，走自动压缩</span>
    <span class="hljs-keyword">else</span> {
        waitCompaction = coreOptions.prepareCommitWaitCompaction();
        <span class="hljs-type">int</span> <span class="hljs-variable">deltaCommits</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;
        <span class="hljs-comment">// 优先使用 full-compaction.delta-commits 参数</span>
        <span class="hljs-keyword">if</span> (options.contains(FULL_COMPACTION_DELTA_COMMITS)) {
            deltaCommits = options.get(FULL_COMPACTION_DELTA_COMMITS);
        }
        <span class="hljs-comment">// 其次使用 compaction.optimization-interval 参数</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options.contains(CHANGELOG_PRODUCER_FULL_COMPACTION_TRIGGER_INTERVAL)) {
            <span class="hljs-type">long</span> <span class="hljs-variable">fullCompactionThresholdMs</span> <span class="hljs-operator">=</span>
                    options.get(CHANGELOG_PRODUCER_FULL_COMPACTION_TRIGGER_INTERVAL).toMillis();
            <span class="hljs-comment">// 根据 checkpoint 间隔将时间转换为提交次数 = compaction.optimization-interval / cp间隔</span>
            deltaCommits =
                    (<span class="hljs-type">int</span>)
                            (fullCompactionThresholdMs
                                    / checkpointConfig.getCheckpointInterval());
        }
        <span class="hljs-comment">// (1) 若配置了changelog-producer = full-compaction 或 配置了上面两个参数，走GlobalFullCompactionSinkWrite</span>
        <span class="hljs-keyword">if</span> (changelogProducer == ChangelogProducer.FULL_COMPACTION || deltaCommits &gt;= <span class="hljs-number">0</span>) {
            <span class="hljs-type">int</span> <span class="hljs-variable">finalDeltaCommits</span> <span class="hljs-operator">=</span> Math.max(deltaCommits, <span class="hljs-number">1</span>);
            <span class="hljs-keyword">return</span> (table, commitUser, state, ioManager, memoryPool, metricGroup) -&gt; {
                assertNoSinkMaterializer.run();
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GlobalFullCompactionSinkWrite</span>(
                        table,
                        commitUser,
                        state,
                        ioManager,
                        ignorePreviousFiles,
                        waitCompaction,
                        finalDeltaCommits, <span class="hljs-comment">// 传递deltaCommits参数</span>
                        isStreaming,
                        memoryPool,
                        metricGroup);
            };
        }
    }

    <span class="hljs-comment">// (2) 若配置了force-lookup = true 且 lookup-wait = false才走异步AsyncLookupSinkWrite</span>
    <span class="hljs-keyword">if</span> (coreOptions.needLookup() &amp;&amp; !coreOptions.prepareCommitWaitCompaction()) {
        <span class="hljs-keyword">return</span> (table, commitUser, state, ioManager, memoryPool, metricGroup) -&gt; {
            assertNoSinkMaterializer.run();
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncLookupSinkWrite</span>(
                    table,
                    commitUser,
                    state,
                    ioManager,
                    ignorePreviousFiles,
                    waitCompaction,
                    isStreaming,
                    memoryPool,
                    metricGroup);
        };
    }
    <span class="hljs-comment">// CASE-1最后走这</span>
    <span class="hljs-keyword">return</span> (table, commitUser, state, ioManager, memoryPool, metricGroup) -&gt; {
        assertNoSinkMaterializer.run();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StoreSinkWriteImpl</span>(
                table,
                commitUser,
                state,
                ioManager,
                ignorePreviousFiles,
                waitCompaction,
                isStreaming,
                memoryPool,
                metricGroup);
    };
}
</code></pre>
<h3 data-id="heading-4">3.<code>GlobalFullCompactionSinkWrite</code>提交全量压缩任务</h3>
<p>该类的继承关系如下
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbe14ae6414048e8bc9fc7f162c940ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZXhwZWN0N2c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766217666&amp;x-signature=r2p9RKaFKZIQVpb33rKUWB%2F8FZA%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">(1) <code>prepareCommit()</code> -- 每次cp都检查是否需要提交全量压缩任务</h4>
<p>步骤如下</p>
<ol>
<li>检查之前提交的全量压缩是否成功</li>
<li>收集当前cp阶段前所有已经写入的buckets -- 赋值给writtenBuckets</li>
<li>判断是否应该触发全量压缩</li>
</ol>
<blockquote>
<p><strong>判断依据</strong>: writtenBuckets 不为空，且当前cpid % deltaCommits==0 时提交触发一次全量压缩，例如：deltaCommits=5，则在 checkpointId=5,10,15,20... 时触发</p>
</blockquote>
<ol start="4">
<li>需要触发全量压缩，调<code>submitFullCompaction()</code>去提交全量压缩任务</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> List&lt;Committable&gt; <span class="hljs-title function_">prepareCommit</span><span class="hljs-params">(<span class="hljs-type">boolean</span> waitCompaction, <span class="hljs-type">long</span> checkpointId)</span>
        <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-comment">// 1.检查之前提交的全量压缩是否成功</span>
    checkuccessfulFullCompaction();

    <span class="hljs-comment">// 2.收集当前cp阶段写入的buckets</span>
    <span class="hljs-keyword">if</span> (!currentWrittenBuckets.isEmpty()) {
        writtenBuckets
                .computeIfAbsent(checkpointId, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;())
                .addAll(currentWrittenBuckets);
        currentWrittenBuckets.clear();
    }

    <span class="hljs-keyword">if</span> (LOG.isDebugEnabled()) {
        <span class="hljs-keyword">for</span> (Map.Entry&lt;Long, Set&lt;Tuple2&lt;BinaryRow, Integer&gt;&gt;&gt; checkpointIdAndBuckets :
                writtenBuckets.entrySet()) {
            LOG.debug(
                    <span class="hljs-string">"Written buckets for checkpoint #{} are:"</span>, checkpointIdAndBuckets.getKey());
            <span class="hljs-keyword">for</span> (Tuple2&lt;BinaryRow, Integer&gt; bucket : checkpointIdAndBuckets.getValue()) {
                LOG.debug(<span class="hljs-string">"  * partition {}, bucket {}"</span>, bucket.f0, bucket.f1);
            }
        }
    }
    <span class="hljs-comment">// 3.判断是否应该触发全量压缩</span>
    <span class="hljs-comment">// 判断依据: 当前writtenBuckets不为null 且 (checkpointId % deltaCommits == 0 || checkpointId == Long.MAX_VALUE)</span>
    <span class="hljs-comment">// isFullCompactedIdentifier()作用: 每隔 deltaCommits 次提交触发一次全量压缩</span>
    <span class="hljs-comment">// 例如：deltaCommits=5，则在 checkpointId=5,10,15,20... 时触发</span>
    <span class="hljs-keyword">if</span> (!writtenBuckets.isEmpty() &amp;&amp; isFullCompactedIdentifier(checkpointId, deltaCommits)) {
        waitCompaction = <span class="hljs-literal">true</span>;
    }
    <span class="hljs-comment">// 4.调`submitFullCompaction()`去提交全量压缩任务</span>
    <span class="hljs-keyword">if</span> (waitCompaction) {
        <span class="hljs-keyword">if</span> (LOG.isDebugEnabled()) {
            LOG.debug(<span class="hljs-string">"Submit full compaction for checkpoint #{}"</span>, checkpointId);
        }
        submitFullCompaction(checkpointId);
        commitIdentifiersToCheck.add(checkpointId);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.prepareCommit(waitCompaction, checkpointId);
}
</code></pre>
<h4 data-id="heading-6">(2) <code>submitFullCompaction()</code></h4>
<p>它其实还是调父类<code>StoreSinkWriteImpl的属性TableWriteImpl</code>对每个bucket桶执行全量压缩操作</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">submitFullCompaction</span><span class="hljs-params">(<span class="hljs-type">long</span> currentCheckpointId)</span> {
    <span class="hljs-keyword">if</span> (LOG.isDebugEnabled()) {
        LOG.debug(<span class="hljs-string">"Submit full compaction for checkpoint #{}"</span>, currentCheckpointId);
    }
    <span class="hljs-comment">// compactedBuckets存储当次压缩任务要压缩的buckets是哪些</span>
    Set&lt;Tuple2&lt;BinaryRow, Integer&gt;&gt; compactedBuckets = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
    <span class="hljs-comment">// 遍历所有历史写入的 buckets</span>
    writtenBuckets.forEach(
            (checkpointId, buckets) -&gt; {
                <span class="hljs-keyword">for</span> (Tuple2&lt;BinaryRow, Integer&gt; bucket : buckets) {
                    <span class="hljs-keyword">if</span> (compactedBuckets.contains(bucket)) {
                        <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// 避免重复压缩</span>
                    }
                    compactedBuckets.add(bucket);
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-comment">// 调父类StoreSinkWriteImpl的属性TableWriteImpl对每个bucket桶执行全量压缩操作</span>
                        write.compact(bucket.f0, bucket.f1, <span class="hljs-literal">true</span>);<span class="hljs-comment">// true表示执行fullCompaction</span>
                    } <span class="hljs-keyword">catch</span> (Exception e) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
                    }
                }
            });
}
</code></pre>
<h3 data-id="heading-7">4.<code>TableWriteImpl.compact()</code></h3>
<p>作用：调<code>FileStoreWrite的实现类的compact()</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">compact</span><span class="hljs-params">(BinaryRow partition, <span class="hljs-type">int</span> bucket, <span class="hljs-type">boolean</span> fullCompaction)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 这里的write是FileStoreWrite的实现类，如KeyValueFileStoreWrite</span>
    write.compact(partition, bucket, fullCompaction); 
}
</code></pre>
<h3 data-id="heading-8">5.<code>FileStoreWrite实现类的compact()</code></h3>
<p>这是个接口，其实现类如下
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd1e1efd28aa4629b9a4571c2b5bc969~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZXhwZWN0N2c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766217666&amp;x-signature=duDDhzxe%2Fr2y2xD%2Brp%2BE6ebgy9w%3D" alt="image.png" loading="lazy"/></p>
<p>下面看<code>AbstractFileStoreWrite实现的comapct()</code>，涉及KeyValueFileStoreWrite详情请看<a href="https://juejin.cn/editor/drafts/7582872365522141222" target="_blank" title="https://juejin.cn/editor/drafts/7582872365522141222">Paimon源码解读 -- KeyValueFileStoreWrite</a></p>
<p>步骤如下:</p>
<ol>
<li>先调<code>getWriterWrapper()</code>获取对应<code>partition-bucket</code>的<code>WriterContainer(其实就是RecordWriter包装起来)</code></li>
<li>用其的<code>RecordWriter实现类如MergeTreeWriter的compact()</code>进行压缩，并传入<code>fullCompaction</code>表示是否需要全量压缩</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">compact</span><span class="hljs-params">(BinaryRow partition, <span class="hljs-type">int</span> bucket, <span class="hljs-type">boolean</span> fullCompaction)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 1.先调getWriterWrapper()获取对于partition-bucket的WriterContainer</span>
    <span class="hljs-comment">// 2.用其中的MergeTreeWriter实现类的compact方法进行压缩，并传入fullCompaction是否需要全量压缩</span>
    getWriterWrapper(partition, bucket).writer.compact(fullCompaction);
}

<span class="hljs-comment">// 调用的getWriterWrapper()</span>
<span class="hljs-keyword">protected</span> WriterContainer&lt;T&gt; <span class="hljs-title function_">getWriterWrapper</span><span class="hljs-params">(BinaryRow partition, <span class="hljs-type">int</span> bucket)</span> {
    <span class="hljs-comment">// 1.获取当前对应partition的buckets</span>
    Map&lt;Integer, WriterContainer&lt;T&gt;&gt; buckets = writers.get(partition);
    <span class="hljs-keyword">if</span> (buckets == <span class="hljs-literal">null</span>) {
        buckets = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        writers.put(partition.copy(), buckets);
    }
    <span class="hljs-comment">// 2.为每个bucket创建WriterContainer对象(其实就是RecordWriter包装起来)</span>
    <span class="hljs-keyword">return</span> buckets.computeIfAbsent(
            bucket, k -&gt; createWriterContainer(partition.copy(), bucket, ignorePreviousFiles));
}
</code></pre>
<h3 data-id="heading-9">6.<code>RecordWriter实现类的compact()</code></h3>
<p>这是个接口，其实现类如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e964e03ecf74e2ebf65cbe492a5ec82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZXhwZWN0N2c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766217666&amp;x-signature=gKMqooK9rSBVR9lJ8Bm%2BExHnLAA%3D" alt="image.png" loading="lazy"/></p>
<p>下面以<code>MergeTreeWriter</code>为例</p>
<h4 data-id="heading-10">(1) <code>compact()</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">compact</span><span class="hljs-params">(<span class="hljs-type">boolean</span> fullCompaction)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 调flushWriteBuffer(true, fullCompaction)</span>
    flushWriteBuffer(<span class="hljs-literal">true</span>, fullCompaction);
}
</code></pre>
<h4 data-id="heading-11">(2) <code>flushWriteBuffer()</code> -- 核心流程</h4>
<p>这是触发压缩的核心流程，其步骤如下</p>
<ol>
<li>检查是否需要等待最近的压缩</li>
</ol>
<blockquote>
<ul>
<li>如果配置的是write-only=true，则不需要等待；</li>
<li>其他情况，则进一步判断，当前levels的Sorted Run文件数 &gt; num-sorted-run.stop-trigger比较，则需要等待压缩；否则，不需要</li>
</ul>
</blockquote>
<ol start="2">
<li>用<code>KeyValueFileWriterFactory</code>去创建的Writer(changelog、Merge)</li>
<li>将<code>writeBuffer</code>缓冲区的数据写入到文件中，用创建的writer去写入到L0层</li>
<li>调<code>writer.result()</code>收集写入后的<code>DataFileMeta文件数据</code>并将这些文件添加到 <code>CompactManager实现类</code>，以便后续压缩执行</li>
<li>调<code>trySyncLatestCompaction(waitForLatestCompaction)</code>等待之前的压缩任务完成</li>
<li>调<code>CompactManager实现类的triggerCompaction()</code>去触发新压缩，携带是否全量压缩参数，详情请看<a href="https://juejin.cn/editor/drafts/7582814236584181798" target="_blank" title="https://juejin.cn/editor/drafts/7582814236584181798">Paimon源码解读 -- CompactManager</a></li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 压缩的核心触发代码,compact()中调用该方法
 * <span class="hljs-doctag">@param</span> waitForLatestCompaction: 是否等待最近的压缩完成
 * <span class="hljs-doctag">@param</span> forcedFullCompaction: 是否全量压缩
 * <span class="hljs-doctag">@throws</span> Exception
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">flushWriteBuffer</span><span class="hljs-params">(<span class="hljs-type">boolean</span> waitForLatestCompaction, <span class="hljs-type">boolean</span> forcedFullCompaction)</span>
        <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-keyword">if</span> (writeBuffer.size() &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 1.检查是否需要等待最近的压缩</span>
        <span class="hljs-comment">// 如果配置的是write-only=true，则不需要等待；</span>
        <span class="hljs-comment">// 其他情况，则进一步判断，当前levels的Sorted Run文件数 &gt; num-sorted-run.stop-trigger比较，则需要等待压缩；否则，不需要</span>
        <span class="hljs-keyword">if</span> (compactManager.shouldWaitForLatestCompaction()) {
            waitForLatestCompaction = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-comment">// 2.用KeyValueFileWriterFactory去创建的Writer</span>
        <span class="hljs-comment">// changelog-producer = input 且 并不是只写入+I，则需要changelogWriter去生成changelog</span>
        <span class="hljs-keyword">final</span> RollingFileWriter&lt;KeyValue, DataFileMeta&gt; changelogWriter =
                (changelogProducer == ChangelogProducer.INPUT &amp;&amp; !isInsertOnly)
                        ? writerFactory.createRollingChangelogFileWriter(<span class="hljs-number">0</span>)
                        : <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// 创建dataWriter，以便写入数据</span>
        <span class="hljs-keyword">final</span> RollingFileWriter&lt;KeyValue, DataFileMeta&gt; dataWriter =
                writerFactory.createRollingMergeTreeFileWriter(<span class="hljs-number">0</span>, FileSource.APPEND);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 3.将writeBuffer缓冲区的数据写入到文件中，用writer去写入到L0层</span>
            writeBuffer.forEach(
                    keyComparator,
                    mergeFunction,
                    changelogWriter == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : changelogWriter::write,
                    dataWriter::write);
        } <span class="hljs-keyword">finally</span> {
            writeBuffer.clear();
            <span class="hljs-keyword">if</span> (changelogWriter != <span class="hljs-literal">null</span>) {
                changelogWriter.close();
            }
            dataWriter.close();
        }
        <span class="hljs-comment">// 4.收集写入后的DataFileMeta文件数据</span>
        List&lt;DataFileMeta&gt; dataMetas = dataWriter.result();
        <span class="hljs-keyword">if</span> (changelogWriter != <span class="hljs-literal">null</span>) {
            newFilesChangelog.addAll(changelogWriter.result());
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (changelogProducer == ChangelogProducer.INPUT &amp;&amp; isInsertOnly) {
            List&lt;DataFileMeta&gt; changelogMetas = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            <span class="hljs-keyword">for</span> (DataFileMeta dataMeta : dataMetas) {
                <span class="hljs-type">String</span> <span class="hljs-variable">newFileName</span> <span class="hljs-operator">=</span> writerFactory.newChangelogFileName(<span class="hljs-number">0</span>);
                <span class="hljs-type">DataFileMeta</span> <span class="hljs-variable">changelogMeta</span> <span class="hljs-operator">=</span> dataMeta.rename(newFileName);
                writerFactory.copyFile(dataMeta, changelogMeta);
                changelogMetas.add(changelogMeta);
            }
            newFilesChangelog.addAll(changelogMetas);
        }
        <span class="hljs-comment">// 将新文件添加到 compactManager</span>
        <span class="hljs-keyword">for</span> (DataFileMeta dataMeta : dataMetas) {
            newFiles.add(dataMeta);
            compactManager.addNewFile(dataMeta);
        }
    }
    <span class="hljs-comment">// 5.等待之前的压缩任务完成</span>
    trySyncLatestCompaction(waitForLatestCompaction);
    <span class="hljs-comment">// 6.调CompactManager实现类的triggerCompaction()去触发新压缩，携带是否全量压缩参数</span>
    compactManager.triggerCompaction(forcedFullCompaction);
}
</code></pre>
<h2 data-id="heading-12">二.总结</h2>
<h3 data-id="heading-13">(1) write-only = true</h3>
<p>用<code>NoopCompactManager()</code>，不执行任何压缩操作，而是由后续专用压缩任务去执行相应的压缩操作</p>
<h3 data-id="heading-14">(2) write-only = false</h3>
<p>write-only = false，走自动压缩，用<code>MergeTreeCompactManager</code></p>
<ol>
<li><strong>优先使用 <code>full-compaction.delta-commits</code> 参数，其次使用 <code>compaction.optimization-interval</code> 参数</strong></li>
</ol>
<blockquote>
<p>deltaCommits参数取值</p>
<ul>
<li>等于full-compaction.delta-commits</li>
<li>等于(compaction.optimization-interval / cp间隔)取整</li>
</ul>
</blockquote>
<ol start="2">
<li>先判断是否配置了<code>changelog-producer = full-compaction</code> 或 配置了任意上面两个参数，走<code>GlobalFullCompactionSinkWrite</code></li>
<li>在判断是否配置了<code>force-lookup = true 且 lookup-wait = false</code>才走异步<code>AsyncLookupSinkWrite</code></li>
</ol>
<p>最后兜底<code>StoreSinkWriteImpl</code></p>
<p>以<code>GlobalFullCompactionSinkWrite</code>为例</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant GFC as GlobalFullCompactionSinkWrite
    participant TW as TableWriteImpl
    participant AFW as AbstractFileStoreWrite
    participant MTW as MergeTreeWriter
    participant CM as MergeTreeCompactManager
    participant Executor as CompactExecutor

    GFC-&gt;&gt;TW: compact(partition, bucket, true)
    TW-&gt;&gt;AFW: write.compact(partition, bucket, true)
    AFW-&gt;&gt;AFW: getWriterWrapper(partition, bucket)
    AFW-&gt;&gt;MTW: writer.compact(true)
    
    MTW-&gt;&gt;MTW: flushWriteBuffer(true, true)
    
    Note over MTW: 1. 刷写WriteBuffer到文件
    MTW-&gt;&gt;MTW: writeBuffer.forEach() -&gt; 写入Level 0文件
    MTW-&gt;&gt;CM: addNewFile(dataMeta)
    
    Note over MTW: 2. 等待之前的压缩完成
    MTW-&gt;&gt;CM: trySyncLatestCompaction(true)
    
    Note over MTW: 3. 触发全量压缩
    MTW-&gt;&gt;CM: triggerCompaction(true)
    
    CM-&gt;&gt;CM: pickFullCompaction() - 选择所有文件
    CM-&gt;&gt;Executor: submit(MergeTreeCompactTask)
    Executor--&gt;&gt;CM: taskFuture
    
    Note over Executor: 异步执行压缩任务&lt;br/&gt;读取所有文件 -&gt; Merge -&gt; 写入新文件
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入解析 React 史上最严重的 RCE 漏洞 CVE-2025-55182]]></title>    <link>https://juejin.cn/post/7582814236583362598</link>    <guid>https://juejin.cn/post/7582814236583362598</guid>    <pubDate>2025-12-12T16:23:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582814236583362598" data-draft-id="7582809606067306522" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入解析 React 史上最严重的 RCE 漏洞 CVE-2025-55182"/> <meta itemprop="keywords" content="前端,React.js,安全"/> <meta itemprop="datePublished" content="2025-12-12T16:23:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Cr4zy_Uru5"/> <meta itemprop="url" content="https://juejin.cn/user/3438928100072813"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入解析 React 史上最严重的 RCE 漏洞 CVE-2025-55182
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3438928100072813/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Cr4zy_Uru5
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T16:23:05.000Z" title="Fri Dec 12 2025 16:23:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025 年 12 月 3 日，React 官方联合 Vercel 发布紧急安全公告，披露 React Server Components（RSC）存在致命远程代码执行漏洞（CVE-2025-55182），CVSS 评分高达 <strong>10.0</strong>（最高风险等级）。该漏洞可通过构造恶意表单请求，在未授权情况下执行服务器任意代码，影响数百万基于 React RSC 和 Next.js 的应用。</p>
<p>这个漏洞波及所有使用了受影响版本 React Server Components 的应用。RSC 作为 React 18 的明星特性，以其独特的“服务器直出组件”能力，正被越来越多的框架（如 Next.js）所集成。然而，正是这个被寄予厚望的特性，却打开了潘多拉的魔盒。这意味着攻击者可以不费吹灰之力，在你的服务器上执行任意代码，你的服务器在他们面前几乎是“裸奔”状态。当然，如果你只是使用 React 在客户端渲染，是不受该漏洞影响的。</p>
<p>本文将详细解析这一严重漏洞，揭开 CVE-2025-55182（又称 React2Shell）的神秘面纱。主要包含以下内容：</p>
<ul>
<li><strong>理解核心概念</strong>：什么是 RSC？什么是反序列化漏洞？</li>
<li><strong>深入攻击原理</strong>：攻击者是如何构造恶意“数据包”的？</li>
<li><strong>源码级剖析</strong>：<code>react-server-dom</code> 的代码里到底藏着什么“后门”？</li>
<li><strong>学习与反思</strong>：我们能从这次事件中学到什么？</li>
</ul>
<h2 data-id="heading-0">一、理解漏洞的必备知识</h2>
<p>在解析漏洞之前，我们必须先理解三个关键概念：RSC、Flight 协议和反序列化漏洞。</p>
<h3 data-id="heading-1">1. React Server Components：前端开发的“新科技”</h3>
<p>你可以把 RSC 想象成一种“混血”组件。它在服务器上运行，可以直接读数据库、访问文件，就像后端代码一样；但它的产物又不是冷冰冰的 HTML，而是一种能被客户端 React “听懂”的特殊指令。</p>
<p><strong>和传统服务端渲染 (SSR) 有什么不一样？</strong></p>
<p>先看两者的加载流程图：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    subgraph "传统 SSR (Server-Side Rendering)"
        A[浏览器请求页面] --&gt; B(服务器);
        B --&gt; C[React 组件渲染成 HTML 字符串];
        C --&gt; D[返回完整 HTML];
        D --&gt; E(客户端);
        E --&gt; F[加载 JS 进行 Hydration];
    end

    subgraph "RSC (React Server Components)"
        G[浏览器请求或触发 UI 更新] --&gt; H(服务器);
        H --&gt; I[服务器组件执行并序列化为 Flight 数据流];
        I --&gt; J[返回 Flight 数据流];
        J --&gt; K(客户端 React);
        K --&gt; L[解析数据流并无缝更新 UI];
    end
</code></pre>
<p>简单来说：</p>
<ul>
<li><strong>SSR</strong> 返回的是“死”的 HTML，客户端需要加载 JavaScript 才能让页面“活”过来（这个过程叫<strong>水合</strong>，Hydration）。</li>
<li><strong>RSC</strong> 返回的是“活”的指令，客户端 React 直接执行这些指令来更新 UI，整个过程更丝滑，而且服务器组件的代码完全不影响客户端的包体积。</li>
</ul>
<h3 data-id="heading-2">2. "Flight" 协议：RSC 的专属“航班”</h3>
<p>RSC 的指令是如何从服务器飞到客户端的呢？答案是搭乘“Flight”这趟专属航班。</p>
<p>Flight 协议就是 React 定义的一套数据传输格式，专门用来打包和运输 RSC 的渲染结果。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as 客户端 (React App)
    participant Server as 服务器 (Node.js)

    Client-&gt;&gt;Server: 发起 Flight 请求 (需要 UserProfile 组件)
    Server-&gt;&gt;Server: 执行  UserProfile  服务器组件
    Server-&gt;&gt;Server: 将组件输出序列化为 Flight 数据格式
    Server--&gt;&gt;Client: 流式返回 Flight 数据
    Client-&gt;&gt;Client: 接收并解析 Flight 数据
    Client-&gt;&gt;Client: 将新 UI 更新到 DOM 中
</code></pre>
<h3 data-id="heading-3">3. 反序列化漏洞：过于信任</h3>
<p>这是我们理解本次漏洞的核心</p>
<ul>
<li><strong>序列化</strong>：把程序中的数据（比如一个对象）变成一串文本（比如 JSON 字符串），方便存储或传输</li>
<li><strong>反序列化</strong>：把那串文本再变回程序里的数据（比如将 JSON 转换为对象）</li>
</ul>
<p><strong>漏洞出在哪？</strong></p>
<p>出在解析时存在不安全的文本。如果服务器在反序列化时，完全信任收到的数据，那么攻击者就可以在文本里藏一颗“炸弹”。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    subgraph "正常流程"
        A["对象：{user: 'React'}"] -- 序列化 --&gt; B["JSON：{&amp;quot;user&amp;quot;:&amp;quot;React&amp;quot;}"];
        B -- 网络传输 --&gt; C(接收端);
        C -- 反序列化 --&gt; D["还原对象：{user: 'React'}"];
    end

    subgraph "攻击场景"
        E["恶意对象"] -- 序列化 --&gt; F["恶意 JSON：{&amp;quot;user&amp;quot;:&amp;quot;hacker&amp;quot;,callback:&amp;quot;恶意代码&amp;quot;}"];
        F -- 网络传输 --&gt; G(接收端);
        G -- 不安全的反序列化 --&gt; H["执行恶意 callback"];
        H -- RCE --&gt; I[服务器被控制];
    end
</code></pre>
<p>想象一下，一个应用在反序列化用户设置时，如果攻击者能控制 JSON，并传入这样的内容：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"username"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"attacker"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"on_load"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"function() { require('child_process').execSync('rm -rf /'); }"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>如果服务器傻傻地把 <code>on_load</code> 的值当作函数来执行，那后果不堪设想。</p>
<p><strong>React2Shell 漏洞，本质上就是 <code>react-server-dom</code> 在处理 Flight “航班”送来的“包裹”时，发生了极其危险的不安全反序列化。</strong></p>
<p>现在，基础知识已经铺垫完毕。下一章，我们将正式进入源码，看看攻击者是如何一步步利用这个缺陷，最终实现远程代码执行（RCE）的。</p>
<h2 data-id="heading-4">二、深入源码：RCE 的三步必杀技</h2>
<p>接下来，我们将一步步还原攻击者是如何利用 <code>react-server-dom</code> 的设计缺陷，完成远程代码执行（RCE）这致命一击的。</p>
<p>整个攻击过程，可以概括为“三步必杀”：</p>
<ol>
<li><strong>第一步：空投“特洛伊木马”</strong> —— 构造一个精心设计的恶意 Flight 数据包</li>
<li><strong>第二步：偷取“万能钥匙”</strong> —— 从 JavaScript 的原型链中“偷”出 <code>Function</code> 构造函数这个危险的工具</li>
<li><strong>第三步：引爆“逻辑炸弹”</strong> —— 诱导 React 的解析器执行一个看似无害、实则致命的操作，引爆炸弹</li>
</ol>
<p>让我们逐一分解。</p>
<h3 data-id="heading-5">1. 空投“特洛伊木马”（恶意 Payload）</h3>
<p>攻击的起点，是向服务器发送一个特制的 HTTP POST 请求。这个请求的 body 部分，是一个 <code>multipart/form-data</code> 格式的数据，也就是我们前面说的 Flight “包裹”。</p>
<p>这个“包裹”里藏着攻击者的“特洛伊木马”。下面是一个简化的 Payload，我们会逐一拆解：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这是一个简化的 Payload</span>
<span class="hljs-keyword">const</span> payload = {
    <span class="hljs-comment">// 入口点，告诉解析器从对象 '1' 开始处理</span>
    <span class="hljs-string">'0'</span>: <span class="hljs-string">'$1'</span>,
    <span class="hljs-comment">// 伪装成一个 Promise 的核心对象</span>
    <span class="hljs-string">'1'</span>: {
        <span class="hljs-comment">// ... (一些迷惑性的属性)</span>
        <span class="hljs-string">'value'</span>: <span class="hljs-string">'{"then":"$3:map","0":{"then":"$B3"},"length":1}'</span>, <span class="hljs-comment">// 触发 Promise 链的核心</span>
        <span class="hljs-string">'_response'</span>: <span class="hljs-string">'$4'</span>, <span class="hljs-comment">// 指向我们伪造的“响应”对象，里面藏着“武器”</span>
        <span class="hljs-string">'then'</span>: <span class="hljs-string">'$2:then'</span> <span class="hljs-comment">// 让自己表现得像一个 Promise</span>
    },
    <span class="hljs-comment">// 一个真正的 Promise，用来驱动流程</span>
    <span class="hljs-string">'2'</span>: <span class="hljs-string">'$@3'</span>,
    <span class="hljs-comment">// 一个普通的空数组，但它的构造函数是我们的目标</span>
    <span class="hljs-string">'3'</span>: [],
    <span class="hljs-comment">// 伪造的“Response”对象，携带了我们的“武器”和“弹药”</span>
    <span class="hljs-string">'4'</span>: {
        <span class="hljs-comment">// “弹药”：想要执行的恶意代码</span>
        <span class="hljs-string">'_prefix'</span>: <span class="hljs-string">'require("child_process").execSync("touch /tmp/pwned"); //'</span>,
        <span class="hljs-comment">// “武器”：指向 Function 构造函数的“小工具” (Gadget)</span>
        <span class="hljs-string">'_formData'</span>: {
            <span class="hljs-string">'get'</span>: <span class="hljs-string">'$3:constructor:constructor'</span>
        },
    }
}
</code></pre>
<p>这个 <code>payload</code> 的核心思想是利用 Flight 协议的引用机制（<code>$</code> 符号），将一堆普通的数据对象（<code>'1'</code>, <code>'4'</code> 等）包装打扮成 React 内部处理流程中的关键角色，比如 <code>Chunk</code>（数据块）和 <code>Response</code>（响应对象），从而骗过服务器的解析器。</p>
<h3 data-id="heading-6">2. 偷取“万能钥匙”（<code>Function</code> 构造函数）</h3>
<p>在 JavaScript 的世界里，<code>eval()</code> 函数因为能直接执行字符串代码，早已臭名昭著。但它有个“兄弟”——<code>Function()</code> 构造函数，同样能实现动态代码执行，却更容易被忽视。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这两种方式都能执行字符串里的代码</span>
<span class="hljs-built_in">eval</span>(<span class="hljs-string">'console.log("Hello from eval")'</span>);

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(<span class="hljs-string">'console.log("Hello from Function constructor")'</span>)();
</code></pre>
<p>攻击者的目标，就是拿到这个 <code>Function</code> 构造函数。他们是怎么做到的呢？答案藏在 <code>payload</code> 的 <code>'4'</code> 号对象里：</p>
<p><code>'get': '$3:constructor:constructor'</code></p>
<p>当 <code>react-server-dom</code> 的解析器看到这个引用时，它会进行一场惊心动魄的“原型链攀爬”：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A("$3") -- 解析为 --&gt; B("空数组 []");
    B -- .constructor --&gt; C(数组的构造函数 Array);
    C -- .constructor --&gt; D(Array 构造函数的构造函数&lt;br&gt;即全局 Function 对象);
    D -- 赋值给 --&gt; E(_formData.get 属性);
</code></pre>
<p>通过两次 <code>.constructor</code> 的访问，攻击者从一个平平无奇的空数组 <code>[]</code> 出发，最终摸到了 JavaScript 的“万能钥匙”——全局 <code>Function</code> 对象！</p>
<p>现在，攻击者的状态是：</p>
<ul>
<li><strong>“弹药”已上膛</strong>：恶意代码字符串 <code>require('child_process')...</code> 存放在 <code>_prefix</code> 属性中。</li>
<li><strong>“武器”已到手</strong>：<code>_formData.get</code> 属性已经变成了 <code>Function</code> 构造函数。</li>
</ul>
<p>至此万事俱备，只欠东风。</p>
<h3 data-id="heading-7">3. 第三步：引爆“逻辑炸弹” (触发 RCE)</h3>
<p>最后的引爆点，隐藏在 <code>react-server-dom</code> 包处理 Flight 数据的某个函数（如 <code>parseModel</code>）中（已简化）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// react-server-dom-webpack/server.node.js (简化后)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">resolveModel</span>(<span class="hljs-params">response, id, model</span>) {
  <span class="hljs-comment">// ... 省略大量代码 ...</span>

  <span class="hljs-keyword">const</span> value = model.<span class="hljs-property">value</span>; <span class="hljs-comment">// value 可能是 '{"then":"$B3"...}'</span>

  <span class="hljs-comment">// 当解析器遇到 '$B' 开头的特殊指令时</span>
  <span class="hljs-keyword">if</span> (value[<span class="hljs-number">0</span>] === <span class="hljs-string">'$'</span> &amp;&amp; value[<span class="hljs-number">1</span>] === <span class="hljs-string">'B'</span>) {
    <span class="hljs-keyword">const</span> props = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(value.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>)); <span class="hljs-comment">// props 会被解析为 3</span>

    <span class="hljs-comment">// 致命的引爆点</span>
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">_formData</span>.<span class="hljs-title function_">get</span>(response.<span class="hljs-property">_prefix</span> + props.<span class="hljs-title function_">toString</span>());
  }

  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>当我们的恶意 <code>payload</code> 被送到这里时，一场“完美的风暴”形成了：</p>
<ol>
<li>解析器处理到对象 <code>'1'</code> 的 <code>value</code> 属性，发现里面有 <code>'$B3'</code> 这个特殊指令，进入了 <code>if</code> 分支。</li>
<li><code>props</code> 被解析为数字 <code>3</code>。</li>
<li>最关键的一行代码被执行：<code>response._formData.get(response._prefix + props.toString())</code>。</li>
</ol>
<p>我们把变量替换成攻击者准备好的东西：</p>
<ul>
<li><code>response</code>：就是我们伪造的 <code>'4'</code> 号对象。</li>
<li><code>response._formData.get</code>：就是 <code>Function</code> 构造函数。</li>
<li><code>response._prefix</code>：就是恶意代码字符串 <code>require('child_process')...</code>。</li>
<li><code>props.toString()</code>：就是字符串 <code>'3'</code>。</li>
</ul>
<p>所以，这行代码实际上等价于：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>(<span class="hljs-string">'require("child_process").execSync("touch /tmp/pwned"); //'</span> + <span class="hljs-string">'3'</span>)
</code></pre>
<p>一个新的匿名函数被动态创建，函数体就是攻击者注入的恶意代码。</p>
<p>由于 React 内部的 Promise 链处理机制，这个刚刚诞生的函数会被立即调用执行。</p>
<p>攻击者成功在服务器上执行了任意代码，RCE 达成。服务器的控制权就此易手。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[接收恶意 Flight 数据包] --&gt; B{解析 Payload};
    B --&gt; C(按引用 '$3:constructor:constructor' 查找);
    C --&gt; D[获得 Function 构造函数并赋值给 _formData.get];
    B --&gt; E[解析到 '$B3' 指令];
    E --&gt; F["执行 _formData.get(_prefix + '3')"];
    F --&gt; G["等价于 Function('恶意代码' + '3')()"];
    G --&gt; H[恶意代码在服务器上执行];
    H --&gt; I((RCE 成功));
</code></pre>
<h2 data-id="heading-8">三、修复方案</h2>
<p>在如此严重的漏洞面前，React 团队的响应是迅速的。他们很快发布了补丁，修复了 React2Shell。那么，他们是如何修复的呢？</p>
<h3 data-id="heading-9">修复的核心思想：“不再信任”</h3>
<p>这次漏洞的根源在于对客户端输入数据的“过度信任”。因此，修复的核心思想就顺理成章地变成了——<strong>“不再信任”</strong>。</p>
<p>具体的修复措施可以总结为三板斧：</p>
<ol>
<li>
<p><strong>增强验证</strong>：在反序列化 Flight 数据流的每一步，都加入了严格的类型和格式校验。解析器不再是“盲目”执行，而是像一个严格的安检员，检查每个“包裹”的尺寸、形状、内容是否符合规定，任何不符合预期的可疑数据都会被直接拒绝。</p>
</li>
<li>
<p><strong>阻断原型链</strong>：补丁特别封堵了通过 <code>.constructor</code> 属性进行原型链攀爬的路径。这意味着，攻击者无法再通过 <code>[].constructor.constructor</code> 这种方式轻易地拿到 <code>Function</code> 构造函数或其他危险的全局对象。通往“万能钥匙”的密道被彻底堵死了。</p>
</li>
<li>
<p><strong>隔离内部状态</strong>：修改了解析逻辑，严格限制了在反序列化过程中对 React 内部状态对象（如 <code>_response</code>）的访问和修改。这相当于给解析器的核心区域加了一道“防火墙”，防止攻击者通过伪造的数据来篡改其内部行为。</p>
</li>
</ol>
<h2 data-id="heading-10">四、总结</h2>
<p>CVE-2025-55182 漏洞虽然已经被修复，但它给我们所有开发者，尤其是前端开发者，敲响了一记响亮的警钟：</p>
<blockquote>
<p><strong>永远不要信任来自外部的任何数据</strong></p>
</blockquote>
<p>无论是用户的输入、API 的返回，还是像 Flight 这样看似“内部”的协议数据，只要它来源于你的应用之外，就必须被视为有潜在威胁的。不安全反序列化漏洞的本质，就是违背了这条法则，破坏了安全的基石。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue2怎么搭建前端性能/错误/行为监控体系]]></title>    <link>https://juejin.cn/post/7582846276505747494</link>    <guid>https://juejin.cn/post/7582846276505747494</guid>    <pubDate>2025-12-12T16:55:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582846276505747494" data-draft-id="7582422818311716915" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue2怎么搭建前端性能/错误/行为监控体系"/> <meta itemprop="keywords" content="监控,Vue.js,面试"/> <meta itemprop="datePublished" content="2025-12-12T16:55:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Aniugel"/> <meta itemprop="url" content="https://juejin.cn/user/3034307824198407"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue2怎么搭建前端性能/错误/行为监控体系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3034307824198407/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Aniugel
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T16:55:20.000Z" title="Fri Dec 12 2025 16:55:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>在 Vue2 项目中搭建<strong>前端监控体系</strong>，核心要覆盖「性能监控、错误监控、用户行为监控」三大维度，以下是一套可落地的完整方案，包含技术选型、代码实现、数据上报、可视化分析全流程：</p>
<h4 data-id="heading-0">一、整体架构设计</h4>
<p>监控体系分为 3 层，轻量化接入且不影响主流程性能：</p>
<pre><code class="hljs language-js" lang="js">前端采集层（<span class="hljs-title class_">Vue2</span> 项目）→ 数据上报层（接口/埋点平台）→ 后台分析层（可视化/告警）
</code></pre>
<ul>
<li>采集层：通过 Vue 钩子、浏览器 API 采集性能 / 错误 / 行为数据；</li>
<li>上报层：批量 + 防抖上报，避免频繁请求；</li>
<li>分析层：可选开源工具（Grafana/ELK）或第三方平台（Fundebug / 监控宝）。</li>
</ul>
<hr/>
<h3 data-id="heading-1">二、性能监控（核心监控首屏 / 页面加载 / 接口性能）</h3>
<h4 data-id="heading-2">1. 核心采集指标</h4>
<ul>
<li>页面性能：FP/FCP/LCP/TTI（通过 <code>performance</code> API）；</li>
<li>接口性能：请求耗时 / 成功率 / 状态码；</li>
<li>Vue 性能：组件渲染耗时（通过 Vue 钩子）。</li>
</ul>
<h4 data-id="heading-3">2. 代码实现（Vue2 中封装性能监控模块）</h4>
<p>新建 <code>src/utils/performanceMonitor.js</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 性能监控核心模块
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 初始化性能监控</span>
  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 页面加载性能（DOMContentLoaded 后采集）</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">collectPagePerformance</span>);
    <span class="hljs-comment">// 2. 接口性能监控（重写 axios）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">wrapAxios</span>();
    <span class="hljs-comment">// 3. Vue 组件渲染性能（全局混入）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">wrapVueComponent</span>();
  },

  <span class="hljs-comment">// 采集页面核心性能指标</span>
  <span class="hljs-title function_">collectPagePerformance</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> perf = performance.<span class="hljs-title function_">getEntriesByType</span>(<span class="hljs-string">'navigation'</span>)[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">if</span> (!perf) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 核心性能指标（对应首屏/加载相关）</span>
    <span class="hljs-keyword">const</span> performanceData = {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'performance'</span>,
      <span class="hljs-attr">pageUrl</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-comment">// 基础加载指标</span>
      <span class="hljs-attr">domReadyTime</span>: perf.<span class="hljs-property">domContentLoadedEventEnd</span> - perf.<span class="hljs-property">navigationStart</span>, <span class="hljs-comment">// DOM 就绪时间</span>
      <span class="hljs-attr">loadTime</span>: perf.<span class="hljs-property">loadEventEnd</span> - perf.<span class="hljs-property">navigationStart</span>, <span class="hljs-comment">// 页面完全加载时间</span>
      <span class="hljs-comment">// 关键绘制指标</span>
      <span class="hljs-attr">fp</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getFP</span>(), <span class="hljs-comment">// 首次绘制</span>
      <span class="hljs-attr">fcp</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getFCP</span>(), <span class="hljs-comment">// 首次内容绘制</span>
      <span class="hljs-attr">lcp</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getLCP</span>(), <span class="hljs-comment">// 最大内容绘制</span>
    };

    <span class="hljs-comment">// 上报性能数据（防抖批量上报）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">report</span>(performanceData);
  },

  <span class="hljs-comment">// 获取 FP（首次绘制）</span>
  <span class="hljs-title function_">getFP</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> entries = performance.<span class="hljs-title function_">getEntriesByType</span>(<span class="hljs-string">'paint'</span>);
    <span class="hljs-keyword">const</span> fpEntry = entries.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">name</span> === <span class="hljs-string">'first-paint'</span>);
    <span class="hljs-keyword">return</span> fpEntry ? fpEntry.<span class="hljs-property">startTime</span> : <span class="hljs-number">0</span>;
  },

  <span class="hljs-comment">// 获取 FCP（首次内容绘制）</span>
  <span class="hljs-title function_">getFCP</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> entries = performance.<span class="hljs-title function_">getEntriesByType</span>(<span class="hljs-string">'paint'</span>);
    <span class="hljs-keyword">const</span> fcpEntry = entries.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">name</span> === <span class="hljs-string">'first-contentful-paint'</span>);
    <span class="hljs-keyword">return</span> fcpEntry ? fcpEntry.<span class="hljs-property">startTime</span> : <span class="hljs-number">0</span>;
  },

  <span class="hljs-comment">// 获取 LCP（最大内容绘制）</span>
  <span class="hljs-title function_">getLCP</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">entryList</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> entries = entryList.<span class="hljs-title function_">getEntries</span>();
        <span class="hljs-keyword">const</span> lcpEntry = entries[entries.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
        <span class="hljs-title function_">resolve</span>(lcpEntry ? lcpEntry.<span class="hljs-property">startTime</span> : <span class="hljs-number">0</span>);
      }).<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'largest-contentful-paint'</span>, <span class="hljs-attr">buffered</span>: <span class="hljs-literal">true</span> });
    });
  },

  <span class="hljs-comment">// 重写 axios 监控接口性能</span>
  <span class="hljs-title function_">wrapAxios</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">'axios'</span>);
    <span class="hljs-keyword">const</span> originalRequest = axios.<span class="hljs-property">request</span>;

    axios.<span class="hljs-property">request</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">config</span>) {
      <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
      <span class="hljs-comment">// 发送请求</span>
      <span class="hljs-keyword">return</span> originalRequest.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, config).<span class="hljs-title function_">then</span>(
        <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
          <span class="hljs-comment">// 成功：采集耗时/状态码</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">report</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">'api'</span>,
            <span class="hljs-attr">pageUrl</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
            <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
            <span class="hljs-attr">url</span>: config.<span class="hljs-property">url</span>,
            <span class="hljs-attr">method</span>: config.<span class="hljs-property">method</span>,
            <span class="hljs-attr">status</span>: response.<span class="hljs-property">status</span>,
            <span class="hljs-attr">costTime</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime,
            <span class="hljs-attr">isSuccess</span>: <span class="hljs-literal">true</span>,
          });
          <span class="hljs-keyword">return</span> response;
        },
        <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
          <span class="hljs-comment">// 失败：采集错误信息</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">report</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">'api'</span>,
            <span class="hljs-attr">pageUrl</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
            <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
            <span class="hljs-attr">url</span>: config.<span class="hljs-property">url</span>,
            <span class="hljs-attr">method</span>: config.<span class="hljs-property">method</span>,
            <span class="hljs-attr">status</span>: error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> || <span class="hljs-string">'network error'</span>,
            <span class="hljs-attr">costTime</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime,
            <span class="hljs-attr">isSuccess</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">errorMsg</span>: error.<span class="hljs-property">message</span>,
          });
          <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
        }
      );
    };
  },

  <span class="hljs-comment">// 监控 Vue 组件渲染耗时</span>
  <span class="hljs-title function_">wrapVueComponent</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">mixin</span>({
      <span class="hljs-title function_">beforeCreate</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$performanceStart</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
      },
      <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> renderTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - <span class="hljs-variable language_">this</span>.<span class="hljs-property">$performanceStart</span>;
        <span class="hljs-comment">// 仅监控渲染耗时 &gt; 100ms 的组件（过滤小组件，减少数据量）</span>
        <span class="hljs-keyword">if</span> (renderTime &gt; <span class="hljs-number">100</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">report</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">'vue-component'</span>,
            <span class="hljs-attr">pageUrl</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
            <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
            <span class="hljs-attr">componentName</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">name</span> || <span class="hljs-string">'unknown'</span>,
            renderTime,
          });
        }
      },
    });
  },

  <span class="hljs-comment">// 数据上报（防抖+批量，避免频繁请求）</span>
  <span class="hljs-title function_">report</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-comment">// 1. 缓存数据到数组</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">__monitorCache</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">__monitorCache</span> || [];
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">__monitorCache</span>.<span class="hljs-title function_">push</span>(data);

    <span class="hljs-comment">// 2. 防抖上报（5s 内只上报一次，或缓存超过 10 条立即上报）</span>
    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">__monitorTimer</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">__monitorCache</span>.<span class="hljs-property">length</span> &gt;= <span class="hljs-number">10</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendReport</span>();
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">__monitorTimer</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendReport</span>();
      }, <span class="hljs-number">5000</span>);
    }
  },

  <span class="hljs-comment">// 发送上报请求（对接后台/第三方平台）</span>
  <span class="hljs-title function_">sendReport</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> cache = <span class="hljs-variable language_">window</span>.<span class="hljs-property">__monitorCache</span> || [];
    <span class="hljs-keyword">if</span> (cache.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 上报接口（替换为你的后台接口）</span>
    axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/monitor/report'</span>, {
      <span class="hljs-attr">data</span>: cache,
      <span class="hljs-attr">userAgent</span>: navigator.<span class="hljs-property">userAgent</span>,
      <span class="hljs-attr">userId</span>: <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'userId'</span>) || <span class="hljs-string">'anonymous'</span>, <span class="hljs-comment">// 关联用户</span>
    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
      <span class="hljs-comment">// 上报失败：缓存到 localStorage，下次重试</span>
      <span class="hljs-keyword">const</span> failCache = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'monitorFailCache'</span>) || <span class="hljs-string">'[]'</span>);
      failCache.<span class="hljs-title function_">push</span>(...cache);
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'monitorFailCache'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(failCache));
    });

    <span class="hljs-comment">// 清空缓存</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">__monitorCache</span> = [];
  },
};
</code></pre>
<h4 data-id="heading-4">3. 在 Vue2 入口挂载</h4>
<p>修改 <code>src/main.js</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>;
<span class="hljs-keyword">import</span> performanceMonitor <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/performanceMonitor'</span>;

<span class="hljs-comment">// 初始化性能监控（生产环境才开启）</span>
<span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span>) {
  performanceMonitor.<span class="hljs-title function_">init</span>();
}

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">el</span>: <span class="hljs-string">'#app'</span>,
  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-params">h</span> =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">App</span>)
});
</code></pre>
<hr/>
<h3 data-id="heading-5">三、错误监控（捕获代码 / 接口 / Vue 运行时错误）</h3>
<h4 data-id="heading-6">1. 核心捕获场景</h4>
<ul>
<li>Vue 运行时错误（通过 <code>Vue.config.errorHandler</code>）；</li>
<li>JS 全局错误（<code>window.onerror</code>）；</li>
<li>资源加载错误（图片 / 脚本 / 样式，<code>window.addEventListener('error')</code>）；</li>
<li>Promise 未捕获错误（<code>window.addEventListener('unhandledrejection')</code>）。</li>
</ul>
<h4 data-id="heading-7">2. 代码实现（新建 <code>src/utils/errorMonitor.js</code>）</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 错误监控核心模块
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 捕获 Vue 运行时错误</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">catchVueError</span>();
    <span class="hljs-comment">// 2. 捕获 JS 全局错误</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">catchJsError</span>();
    <span class="hljs-comment">// 3. 捕获资源加载错误</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">catchResourceError</span>();
    <span class="hljs-comment">// 4. 捕获 Promise 未处理错误</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">catchPromiseError</span>();
  },

  <span class="hljs-comment">// 捕获 Vue 内部错误</span>
  <span class="hljs-title function_">catchVueError</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Vue</span>.<span class="hljs-property">config</span>.<span class="hljs-property">errorHandler</span> = <span class="hljs-function">(<span class="hljs-params">err, vm, info</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">report</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'vue-error'</span>,
        <span class="hljs-attr">pageUrl</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">message</span>: err.<span class="hljs-property">message</span>,
        <span class="hljs-attr">stack</span>: err.<span class="hljs-property">stack</span>,
        <span class="hljs-attr">component</span>: vm.<span class="hljs-property">$options</span>.<span class="hljs-property">name</span> || <span class="hljs-string">'unknown'</span>,
        <span class="hljs-attr">info</span>: info, <span class="hljs-comment">// Vue 错误信息（如生命周期钩子）</span>
      });
    };
  },

  <span class="hljs-comment">// 捕获 JS 全局错误</span>
  <span class="hljs-title function_">catchJsError</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">message, source, line, column, error</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">report</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'js-error'</span>,
        <span class="hljs-attr">pageUrl</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        message,
        source, <span class="hljs-comment">// 错误文件地址</span>
        line, <span class="hljs-comment">// 行号</span>
        column, <span class="hljs-comment">// 列号</span>
        <span class="hljs-attr">stack</span>: error?.<span class="hljs-property">stack</span> || <span class="hljs-string">''</span>,
      });
      <span class="hljs-comment">// 阻止默认行为，避免浏览器控制台重复输出</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    };
  },

  <span class="hljs-comment">// 捕获资源加载错误（图片/脚本/样式）</span>
  <span class="hljs-title function_">catchResourceError</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span>;
      <span class="hljs-comment">// 过滤资源错误（非元素错误跳过）</span>
      <span class="hljs-keyword">if</span> (target <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLImageElement</span> || target <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLLinkElement</span> || target <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLScriptElement</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">report</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">'resource-error'</span>,
          <span class="hljs-attr">pageUrl</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
          <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
          <span class="hljs-attr">resourceType</span>: target.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toLowerCase</span>(),
          <span class="hljs-attr">resourceUrl</span>: target.<span class="hljs-property">src</span> || target.<span class="hljs-property">href</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`Resource load failed: <span class="hljs-subst">${target.src || target.href}</span>`</span>,
        });
      }
    }, <span class="hljs-literal">true</span>); <span class="hljs-comment">// 捕获阶段触发，避免冒泡丢失</span>
  },

  <span class="hljs-comment">// 捕获 Promise 未处理错误</span>
  <span class="hljs-title function_">catchPromiseError</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'unhandledrejection'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">report</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'promise-error'</span>,
        <span class="hljs-attr">pageUrl</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">message</span>: e.<span class="hljs-property">reason</span>?.<span class="hljs-property">message</span> || <span class="hljs-string">'Promise rejection'</span>,
        <span class="hljs-attr">stack</span>: e.<span class="hljs-property">reason</span>?.<span class="hljs-property">stack</span> || <span class="hljs-string">''</span>,
      });
      <span class="hljs-comment">// 阻止默认行为</span>
      e.<span class="hljs-title function_">preventDefault</span>();
    });
  },

  <span class="hljs-comment">// 复用性能监控的上报方法（统一上报入口）</span>
  <span class="hljs-attr">report</span>: performanceMonitor.<span class="hljs-property">report</span>,
};
</code></pre>
<h4 data-id="heading-8">3. 挂载到入口（<code>main.js</code>）</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> errorMonitor <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/errorMonitor'</span>;

<span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span>) {
  performanceMonitor.<span class="hljs-title function_">init</span>();
  errorMonitor.<span class="hljs-title function_">init</span>(); <span class="hljs-comment">// 新增错误监控</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-9">四、用户行为监控（还原操作路径，定位问题根因）</h3>
<h4 data-id="heading-10">1. 核心监控行为</h4>
<ul>
<li>页面跳转（路由变化）；</li>
<li>点击事件（按钮 / 链接）；</li>
<li>输入行为（表单）；</li>
<li>接口调用（和错误 / 性能关联）。</li>
</ul>
<h4 data-id="heading-11">2. 代码实现（新建 <code>src/utils/behaviorMonitor.js</code>）</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 用户行为监控核心模块
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 监控路由变化（Vue Router）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">catchRouterChange</span>();
    <span class="hljs-comment">// 2. 全局监听点击事件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">catchClickEvent</span>();
    <span class="hljs-comment">// 3. 监控表单输入</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">catchFormInput</span>();
  },

  <span class="hljs-comment">// 监控路由变化</span>
  <span class="hljs-title function_">catchRouterChange</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> router = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./router/index.js'</span>); <span class="hljs-comment">// 引入路由实例</span>
    router.<span class="hljs-title function_">afterEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span></span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">report</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'router-change'</span>,
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">from</span>: <span class="hljs-keyword">from</span>.<span class="hljs-property">fullPath</span>,
        <span class="hljs-attr">to</span>: to.<span class="hljs-property">fullPath</span>,
        <span class="hljs-attr">pageTitle</span>: to.<span class="hljs-property">meta</span>.<span class="hljs-property">title</span> || <span class="hljs-string">'unknown'</span>,
      });
    });
  },

  <span class="hljs-comment">// 全局监听点击事件（过滤非业务元素）</span>
  <span class="hljs-title function_">catchClickEvent</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span>;
      <span class="hljs-comment">// 只监控带 data-behavior 标记的元素（避免全量采集）</span>
      <span class="hljs-keyword">const</span> behaviorKey = target.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'data-behavior'</span>);
      <span class="hljs-keyword">if</span> (!behaviorKey) <span class="hljs-keyword">return</span>;

      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">report</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'click'</span>,
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">pageUrl</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
        behaviorKey, <span class="hljs-comment">// 自定义标记（如 "btn-submit-order"）</span>
        <span class="hljs-attr">targetText</span>: target.<span class="hljs-property">innerText</span>.<span class="hljs-title function_">trim</span>(),
        <span class="hljs-attr">targetSelector</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getSelector</span>(target), <span class="hljs-comment">// 元素选择器</span>
      });
    }, <span class="hljs-literal">true</span>);
  },

  <span class="hljs-comment">// 监控表单输入（带 data-behavior 的输入框）</span>
  <span class="hljs-title function_">catchFormInput</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span>;
      <span class="hljs-keyword">const</span> behaviorKey = target.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'data-behavior'</span>);
      <span class="hljs-keyword">if</span> (!behaviorKey || ![<span class="hljs-string">'INPUT'</span>, <span class="hljs-string">'TEXTAREA'</span>].<span class="hljs-title function_">includes</span>(target.<span class="hljs-property">tagName</span>)) <span class="hljs-keyword">return</span>;

      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">report</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'form-input'</span>,
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">pageUrl</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
        behaviorKey,
        <span class="hljs-attr">inputValue</span>: target.<span class="hljs-property">value</span>.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>), <span class="hljs-comment">// 只采集前100字符，避免敏感信息</span>
      });
    }, <span class="hljs-literal">true</span>);
  },

  <span class="hljs-comment">// 获取元素唯一选择器（便于定位）</span>
  <span class="hljs-title function_">getSelector</span>(<span class="hljs-params">el</span>) {
    <span class="hljs-keyword">if</span> (!el) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    <span class="hljs-keyword">let</span> selector = el.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toLowerCase</span>();
    <span class="hljs-keyword">if</span> (el.<span class="hljs-property">id</span>) selector += <span class="hljs-string">`#<span class="hljs-subst">${el.id}</span>`</span>;
    <span class="hljs-keyword">if</span> (el.<span class="hljs-property">className</span>) selector += <span class="hljs-string">`.<span class="hljs-subst">${el.className.replace(/\s+/g, <span class="hljs-string">'.'</span>)}</span>`</span>;
    <span class="hljs-keyword">return</span> selector;
  },

  <span class="hljs-comment">// 复用上报方法</span>
  <span class="hljs-attr">report</span>: performanceMonitor.<span class="hljs-property">report</span>,
};
</code></pre>
<h4 data-id="heading-12">3. 业务中埋点使用</h4>
<p>在需要监控的元素上添加 <code>data-behavior</code> 标记：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 按钮点击监控 --&gt;
  &lt;button data-behavior="btn-home-search" @click="search"&gt;搜索&lt;/button&gt;
  
  &lt;!-- 表单输入监控 --&gt;
  &lt;input data-behavior="input-home-keyword" v-model="keyword" placeholder="请输入关键词"&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-13">4. 挂载到入口（<code>main.js</code>）</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> behaviorMonitor <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/behaviorMonitor'</span>;

<span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span>) {
  performanceMonitor.<span class="hljs-title function_">init</span>();
  errorMonitor.<span class="hljs-title function_">init</span>();
  behaviorMonitor.<span class="hljs-title function_">init</span>(); <span class="hljs-comment">// 新增行为监控</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-14">五、进阶优化（避免监控本身影响性能）</h3>
<h4 data-id="heading-15">1. 白名单 / 黑名单</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 上报时过滤无需监控的页面/接口</span>
<span class="hljs-title function_">report</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">const</span> blacklist = [<span class="hljs-string">'/login'</span>, <span class="hljs-string">'/test'</span>]; <span class="hljs-comment">// 过滤测试/登录页</span>
  <span class="hljs-keyword">if</span> (blacklist.<span class="hljs-title function_">includes</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span>)) <span class="hljs-keyword">return</span>;
  <span class="hljs-comment">// ... 原有逻辑</span>
}
</code></pre>
<h4 data-id="heading-16">2. 敏感信息过滤</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 上报前过滤手机号/密码等敏感信息</span>
<span class="hljs-title function_">filterSensitiveData</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">if</span> (data.<span class="hljs-property">inputValue</span>) {
    data.<span class="hljs-property">inputValue</span> = data.<span class="hljs-property">inputValue</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/1[3-9]\d{9}/g</span>, <span class="hljs-string">'****'</span>); <span class="hljs-comment">// 手机号脱敏</span>
  }
  <span class="hljs-keyword">return</span> data;
}
</code></pre>
<h4 data-id="heading-17">3. 离线缓存重试</h4>
<p>上报失败时缓存到 localStorage，下次页面加载时重试：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 在 sendReport 失败后</span>
<span class="hljs-keyword">const</span> failCache = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'monitorFailCache'</span>) || <span class="hljs-string">'[]'</span>);
failCache.<span class="hljs-title function_">push</span>(...cache);
<span class="hljs-comment">// 限制缓存大小（最多 100 条）</span>
<span class="hljs-keyword">if</span> (failCache.<span class="hljs-property">length</span> &gt; <span class="hljs-number">100</span>) failCache.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, failCache.<span class="hljs-property">length</span> - <span class="hljs-number">100</span>);
<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'monitorFailCache'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(failCache));

<span class="hljs-comment">// 页面加载时重试</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> failCache = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'monitorFailCache'</span>) || <span class="hljs-string">'[]'</span>);
  <span class="hljs-keyword">if</span> (failCache.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/monitor/report'</span>, { <span class="hljs-attr">data</span>: failCache })
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'monitorFailCache'</span>));
  }
});
</code></pre>
<hr/>
<h3 data-id="heading-18">六、数据可视化与告警（可选方案）</h3>
<h4 data-id="heading-19">1. 开源方案（自建）</h4>
<ul>
<li>数据存储：MySQL/ClickHouse（适合海量数据）；</li>
<li>可视化：Grafana/ELK（Kibana）；</li>
<li>告警：Prometheus + AlertManager（触发阈值时邮件 / 钉钉告警）。</li>
</ul>
<h4 data-id="heading-20">2. 第三方平台（快速接入）</h4>
<ul>
<li>错误监控：Fundebug、Sentry、FrontJS；</li>
<li>性能监控：阿里云 ARMS、百度统计、腾讯监控宝；</li>
<li>行为分析：百度统计、友盟 +、GrowingIO。</li>
</ul>
<h4 data-id="heading-21">3. 核心告警阈值参考</h4>

























<table><thead><tr><th>指标</th><th>告警阈值</th></tr></thead><tbody><tr><td>JS 错误率</td><td>&gt; 0.1%</td></tr><tr><td>接口失败率</td><td>&gt; 1%</td></tr><tr><td>LCP</td><td>&gt; 4s</td></tr><tr><td>首屏加载时间</td><td>&gt; 5s</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-22">七、最终集成（main.js 完整示例）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>;
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>;
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;
<span class="hljs-keyword">import</span> performanceMonitor <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/performanceMonitor'</span>;
<span class="hljs-keyword">import</span> errorMonitor <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/errorMonitor'</span>;
<span class="hljs-keyword">import</span> behaviorMonitor <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/behaviorMonitor'</span>;

<span class="hljs-comment">// 生产环境开启监控</span>
<span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span>) {
  <span class="hljs-comment">// 全局挂载 axios（供监控模块使用）</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">axios</span> = axios;
  <span class="hljs-comment">// 初始化监控</span>
  performanceMonitor.<span class="hljs-title function_">init</span>();
  errorMonitor.<span class="hljs-title function_">init</span>();
  behaviorMonitor.<span class="hljs-title function_">init</span>();
}

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  router,
  <span class="hljs-attr">el</span>: <span class="hljs-string">'#app'</span>,
  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-params">h</span> =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">App</span>)
});
</code></pre>
<p>这套方案轻量化、可扩展，既可以对接自建后台，也能快速切换到第三方监控平台，核心优势是：</p>
<ol>
<li>无侵入：通过全局混入、事件监听实现，不修改业务代码；</li>
<li>高性能：批量 + 防抖上报，本地缓存重试，不阻塞主流程；</li>
<li>全覆盖：性能 / 错误 / 行为维度完整，可还原问题现场。</li>
</ol>
<h2 data-id="heading-23">Vue2中项目实战高频用到的设计模式有哪些</h2>
<p>在 Vue2 项目实战中，以下是高频用到的设计模式，结合 Vue2 的特性（如选项式 API、组件化、响应式），它们能有效提升代码的可维护性和复用性：</p>
<h4 data-id="heading-24">1. <strong>单例模式</strong></h4>
<ul>
<li>
<p><strong>核心场景</strong>：全局唯一的实例（如 Vuex Store、全局弹窗、请求拦截器）。</p>
</li>
<li>
<p><strong>实战示例</strong>：</p>
<ul>
<li>Vuex 的<code>store</code>是单例，全局共享状态；</li>
<li>全局提示组件（如<code>Toast</code>），通过<code>Vue.prototype.$toast = new Toast()</code>挂载为单例，避免重复创建实例。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-25">2. <strong>工厂模式</strong></h4>
<ul>
<li>
<p><strong>核心场景</strong>：批量创建相似的组件 / 实例，避免重复代码。</p>
</li>
<li>
<p><strong>实战示例</strong>：</p>
<ul>
<li>表单控件工厂：根据配置（如<code>{ type: 'input', label: '姓名' }</code>）动态生成<code>Input</code>、<code>Select</code>等表单组件；</li>
<li>弹窗工厂：封装<code>createModal</code>函数，传入组件和参数，自动创建并挂载弹窗实例。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-26">3. <strong>观察者模式（发布 - 订阅模式）</strong></h4>
<ul>
<li>
<p><strong>核心场景</strong>：Vue2 的响应式系统本身基于观察者模式（<code>data</code>是被观察者，模板 / 计算属性是观察者）；此外常用于跨组件通信。</p>
</li>
<li>
<p><strong>实战示例</strong>：</p>
<ul>
<li>用<code>Vue.prototype.$bus = new Vue()</code>实现全局事件总线（发布<code>this.$bus.$emit('event')</code>，订阅<code>this.$bus.$on('event', () =&gt; {})</code>）；</li>
<li>计算属性依赖<code>data</code>变化自动更新。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-27">4. <strong>代理模式</strong></h4>
<ul>
<li>
<p><strong>核心场景</strong>：对复杂操作进行封装，对外暴露简化的接口（如<strong>请求代理、权限代理</strong>）。</p>
</li>
<li>
<p><strong>实战示例</strong>：</p>
<ul>
<li><strong>封装<code>api.js</code></strong> 作为接口代理，统一处理请求的 URL 拼接、参数格式化、错误拦截；</li>
<li><strong>权限代理组件</strong>：封装一个<code>AuthButton</code>组件，根据用户权限决定按钮是否渲染 / 可用。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-28">5. <strong>装饰器模式</strong></h4>
<ul>
<li>
<p><strong>核心场景</strong>：<strong>在不修改原组件的前提下，动态扩展其功能</strong>（Vue2 中常用<code>mixin</code>或高阶组件实现）。</p>
</li>
<li>
<p><strong>实战示例</strong>：</p>
<ul>
<li>用<code>mixin</code>给多个组件添加 “加载状态管理” 功能（如<code>loadingMixin</code>包含<code>loading</code>数据和<code>setLoading</code>方法）；</li>
<li><strong>高阶组件（HOC）</strong>：封装<code>withAuth</code>函数，接收组件并返回 “带权限校验” 的新组件。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-29">6. <strong>策略模式</strong></h4>
<ul>
<li>
<p><strong>核心场景</strong>：<strong>将多种 “算法 / 逻辑” 封装为独立策略</strong>，根据条件动态切换（替代大量<code>if-else</code>）。</p>
</li>
<li>
<p><strong>实战示例</strong>：</p>
<ul>
<li><strong>表单验证策略</strong>：定义<code>required</code>、<code>email</code>、<code>maxLength</code>等验证策略，根据表单项的<code>rules</code>动态选择；</li>
<li>支付方式策略：封装<code>Alipay</code>、<code>WechatPay</code>等支付策略，根据用户选择切换支付逻辑。</li>
</ul>
</li>
</ul>
<p>这些模式在 Vue2 项目中并非孤立使用（例如 “组件化 + 策略模式” 实现动态表单），结合 Vue2 的特性（如 mixin、Vuex、事件总线）能更好地落地。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 数组响应式原理深度解析：这些方法为何能被监听到？]]></title>    <link>https://juejin.cn/post/7582815307439472691</link>    <guid>https://juejin.cn/post/7582815307439472691</guid>    <pubDate>2025-12-13T01:45:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582815307439472691" data-draft-id="7582814236583690278" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 数组响应式原理深度解析：这些方法为何能被监听到？"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-13T01:45:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 数组响应式原理深度解析：这些方法为何能被监听到？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T01:45:11.000Z" title="Sat Dec 13 2025 01:45:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、开篇：为什么普通数组操作无法被Vue监听？</h2>
<p>在Vue开发中，我们经常会遇到这样的困惑：为什么直接通过索引修改数组元素，或者修改数组长度时，视图不会更新？</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 这些操作无法触发响应式更新</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">vm </span>= <span class="hljs-keyword">new</span><span class="hljs-title function_ invoke__"> Vue</span>({
<span class="hljs-attr">  data</span>: {
<span class="hljs-attr">    items</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>]
  }
})

vm.items[<span class="hljs-number">1</span>] = <span class="hljs-string">'x'</span>  <span class="hljs-comment">// ❌ 视图不会更新</span>
vm.items.length = <span class="hljs-number">1</span> <span class="hljs-comment">// ❌ 视图不会更新</span>
</code></pre>
<p>这是因为Vue 2.x使用的是<code>Object.defineProperty</code>进行数据劫持，而JavaScript的数组索引并不是对象的"属性"，数组长度的变化也无法通过属性拦截来监听。</p>
<h2 data-id="heading-1">二、Vue能监听的数组方法</h2>
<p>Vue通过重写数组的原型方法，实现了对以下7种数组变更方法的监听：</p>
<h3 data-id="heading-2">1. 变更方法（会触发视图更新）</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 1. push() - 末尾添加元素</span>
vm<span class="hljs-selector-class">.items</span><span class="hljs-selector-class">.push</span>('d')  <span class="hljs-comment">// ✅ 触发更新</span>

<span class="hljs-comment">// 2. pop() - 删除最后一个元素</span>
vm<span class="hljs-selector-class">.items</span><span class="hljs-selector-class">.pop</span>()  <span class="hljs-comment">// ✅ 触发更新</span>

<span class="hljs-comment">// 3. shift() - 删除第一个元素</span>
vm<span class="hljs-selector-class">.items</span><span class="hljs-selector-class">.shift</span>()  <span class="hljs-comment">// ✅ 触发更新</span>

<span class="hljs-comment">// 4. unshift() - 开头添加元素</span>
vm<span class="hljs-selector-class">.items</span><span class="hljs-selector-class">.unshift</span>('z')  <span class="hljs-comment">// ✅ 触发更新</span>

<span class="hljs-comment">// 5. splice() - 删除/替换/添加元素</span>
vm<span class="hljs-selector-class">.items</span><span class="hljs-selector-class">.splice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, 'new')  <span class="hljs-comment">// ✅ 触发更新</span>

<span class="hljs-comment">// 6. sort() - 排序</span>
vm<span class="hljs-selector-class">.items</span><span class="hljs-selector-class">.sort</span>()  <span class="hljs-comment">// ✅ 触发更新</span>

<span class="hljs-comment">// 7. reverse() - 反转</span>
vm<span class="hljs-selector-class">.items</span><span class="hljs-selector-class">.reverse</span>()  <span class="hljs-comment">// ✅ 触发更新</span>
</code></pre>
<h3 data-id="heading-3">2. 替换方法（需重新赋值）</h3>
<p>对于返回新数组的方法，需要重新赋值：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// filter(), concat(), slice() 等</span>
vm.<span class="hljs-property">items</span> = vm.<span class="hljs-property">items</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item !== <span class="hljs-string">'b'</span>)  <span class="hljs-comment">// ✅ 需要重新赋值</span>
</code></pre>
<h2 data-id="heading-4">三、源码解析：Vue如何实现数组响应式</h2>
<h3 data-id="heading-5">1. 核心实现原理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简化版的Vue数组响应式实现</span>
<span class="hljs-keyword">const</span> arrayProto = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
<span class="hljs-keyword">const</span> arrayMethods = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(arrayProto)

<span class="hljs-keyword">const</span> methodsToPatch = [
  <span class="hljs-string">'push'</span>,
  <span class="hljs-string">'pop'</span>,
  <span class="hljs-string">'shift'</span>,
  <span class="hljs-string">'unshift'</span>,
  <span class="hljs-string">'splice'</span>,
  <span class="hljs-string">'sort'</span>,
  <span class="hljs-string">'reverse'</span>
]

methodsToPatch.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">method</span>) {
  <span class="hljs-comment">// 缓存原始方法</span>
  <span class="hljs-keyword">const</span> original = arrayProto[method]
  
  <span class="hljs-comment">// 重写数组方法</span>
  <span class="hljs-title function_">def</span>(arrayMethods, method, <span class="hljs-keyword">function</span> <span class="hljs-title function_">mutator</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-comment">// 1. 执行原始方法</span>
    <span class="hljs-keyword">const</span> result = original.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
    
    <span class="hljs-comment">// 2. 获取数组的Observer实例</span>
    <span class="hljs-keyword">const</span> ob = <span class="hljs-variable language_">this</span>.<span class="hljs-property">__ob__</span>
    
    <span class="hljs-comment">// 3. 对新增元素进行响应式处理</span>
    <span class="hljs-keyword">let</span> inserted
    <span class="hljs-keyword">switch</span> (method) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'push'</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-string">'unshift'</span>:
        inserted = args
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'splice'</span>:
        inserted = args.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>)
        <span class="hljs-keyword">break</span>
    }
    <span class="hljs-keyword">if</span> (inserted) ob.<span class="hljs-title function_">observeArray</span>(inserted)
    
    <span class="hljs-comment">// 4. 通知依赖更新</span>
    ob.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()
    
    <span class="hljs-keyword">return</span> result
  })
})

<span class="hljs-keyword">function</span> <span class="hljs-title function_">def</span>(<span class="hljs-params">obj, key, val, enumerable</span>) {
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, key, {
    <span class="hljs-attr">value</span>: val,
    <span class="hljs-attr">enumerable</span>: !!enumerable,
    <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>
  })
}
</code></pre>
<h3 data-id="heading-6">2. Observer类的关键代码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Observer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dep</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>()
    
    <span class="hljs-comment">// 给数组添加__ob__属性，指向Observer实例</span>
    <span class="hljs-title function_">def</span>(value, <span class="hljs-string">'__ob__'</span>, <span class="hljs-variable language_">this</span>)
    
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(value)) {
      <span class="hljs-comment">// 重写数组的原型方法</span>
      value.<span class="hljs-property">__proto__</span> = arrayMethods
      <span class="hljs-comment">// 对数组中的每个元素进行观察</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">observeArray</span>(value)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">walk</span>(value)
    }
  }
  
  <span class="hljs-title function_">observeArray</span>(<span class="hljs-params">items</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, l = items.<span class="hljs-property">length</span>; i &lt; l; i++) {
      <span class="hljs-title function_">observe</span>(items[i])
    }
  }
}
</code></pre>
<h2 data-id="heading-7">四、流程图解：数组响应式的工作流程</h2>
<pre><code class="hljs">是

否

是

否

初始化响应式数组创建Observer实例是否为数组重写数组原型方法遍历对象属性拦截7个变更方法执行原始数组方法是否有新增元素对新元素进行响应式处理跳过通知依赖更新视图更新
</code></pre>
<h2 data-id="heading-8">五、实战应用场景</h2>
<h3 data-id="heading-9">场景1：动态列表操作</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in list"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span>&gt;</span>
        {{ item.name }}
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"removeItem(index)"</span>&gt;</span>删除<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"addItem"</span>&gt;</span>添加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"sortList"</span>&gt;</span>排序<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">list</span>: [
        { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Item 1'</span> },
        { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'项目 2'</span> },
        { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'アイテム 3'</span> }
      ],
      <span class="hljs-attr">nextId</span>: <span class="hljs-number">4</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">addItem</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 使用push方法，Vue能监听到</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">id</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">nextId</span>++,
        <span class="hljs-attr">name</span>: <span class="hljs-string">`新项目 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.nextId}</span>`</span>
      })
    },
    <span class="hljs-title function_">removeItem</span>(<span class="hljs-params">index</span>) {
      <span class="hljs-comment">// 使用splice方法，Vue能监听到</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>)
    },
    <span class="hljs-title function_">sortList</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 使用sort方法，Vue能监听到</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">name</span>.<span class="hljs-title function_">localeCompare</span>(b.<span class="hljs-property">name</span>))
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">场景2：批量操作优化</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 批量添加元素的高效写法</span>
addMultipleItems() {
  <span class="hljs-comment">// 方法1：使用扩展运算符（需要重新赋值）</span>
  <span class="hljs-keyword">this</span>.list = [...<span class="hljs-keyword">this</span>.list, ...newItems]
  
  <span class="hljs-comment">// 方法2：使用push + 扩展运算符</span>
  <span class="hljs-keyword">this</span>.list.push(...newItems)
  
  <span class="hljs-comment">// 方法3：使用splice</span>
  <span class="hljs-keyword">this</span>.list.splice(<span class="hljs-keyword">this</span>.list.length, <span class="hljs-number">0</span>, ...newItems)
}
</code></pre>
<h2 data-id="heading-11">六、Vue 3的改进：Proxy实现</h2>
<p>在Vue 3中，使用Proxy替代了Object.defineProperty，天然支持数组索引的监听：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Vue 3中使用Proxy，可以监听数组索引操作</span>
<span class="hljs-type">const</span> reactiveArray = <span class="hljs-built_in">reactive</span>([<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>])

<span class="hljs-comment">// ✅ 这些操作在Vue 3中都能被监听</span>
reactiveArray[<span class="hljs-number">1</span>] = <span class="hljs-string">'x'</span>  <span class="hljs-comment">// 直接修改索引</span>
reactiveArray.length = <span class="hljs-number">1</span>  <span class="hljs-comment">// 修改长度</span>
</code></pre>
<h2 data-id="heading-12">七、常见问题与解决方案</h2>
<h3 data-id="heading-13">问题1：如何监听数组长度变化？</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用计算属性监听数组长度</span>
computed: {
  listLength() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.items.length
  }
}

<span class="hljs-comment">// 或者使用$set强制更新</span>
<span class="hljs-keyword">this</span>.$<span class="hljs-keyword">set</span>(<span class="hljs-keyword">this</span>.items, <span class="hljs-string">'length'</span>, newLength)
</code></pre>
<h3 data-id="heading-14">问题2：如何处理嵌套数组？</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 嵌套数组也需要使用响应式方法</span>
<span class="hljs-keyword">data</span>() {
  <span class="hljs-keyword">return</span> {
    nestedArray: [
      { items: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>] },
      { items: [<span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>] }
    ]
  }
},
methods: {
  updateNestedArray() {
    <span class="hljs-comment">// 正确做法：使用Vue.set或数组方法</span>
    <span class="hljs-keyword">this</span>.$<span class="hljs-keyword">set</span>(<span class="hljs-keyword">this</span>.nestedArray[<span class="hljs-number">0</span>].items, <span class="hljs-number">1</span>, <span class="hljs-string">'new'</span>)
    <span class="hljs-comment">// 或者</span>
    <span class="hljs-keyword">this</span>.nestedArray[<span class="hljs-number">0</span>].items.splice(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'new'</span>)
  }
}
</code></pre>
<h3 data-id="heading-15">问题3：性能优化建议</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 避免在模板中直接操作数组</span>
<span class="hljs-comment">// ❌ 不推荐</span>
&lt;div v-<span class="hljs-keyword">for</span>=<span class="hljs-string">"item in list.reverse()"</span>&gt;

<span class="hljs-comment">// ✅ 推荐</span>
&lt;div v-<span class="hljs-keyword">for</span>=<span class="hljs-string">"item in reversedList"</span>&gt;
computed: {
  reversedList() {
    <span class="hljs-keyword">return</span> [...<span class="hljs-keyword">this</span>.list].reverse()
  }
}

<span class="hljs-comment">// 2. 大数据量使用虚拟滚动</span>
</code></pre>
<h2 data-id="heading-16">八、总结与最佳实践</h2>
<ol>
<li>1. <strong>始终使用Vue提供的数组方法</strong>进行数组变更操作</li>
<li>2. <strong>对于返回新数组的方法</strong>，记得重新赋值</li>
<li>3. <strong>使用Vue.set/$set</strong>处理无法监听的情况</li>
<li>4. <strong>在Vue 2中</strong>，避免直接通过索引修改数组</li>
<li>5. <strong>升级到Vue 3</strong>可以获得更好的数组响应式支持</li>
</ol>
<p>理解Vue数组响应式的实现原理，不仅能帮助我们避免常见的坑，还能写出更高效、更可靠的Vue应用。记住这些能触发响应式更新的数组方法，让你的Vue开发更加得心应手！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别卷模型了！上下文工程才是大模型应用的王道！]]></title>    <link>https://juejin.cn/post/7582857981894131753</link>    <guid>https://juejin.cn/post/7582857981894131753</guid>    <pubDate>2025-12-13T07:10:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582857981894131753" data-draft-id="7582787460419502122" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别卷模型了！上下文工程才是大模型应用的王道！"/> <meta itemprop="keywords" content="面试,Java,后端"/> <meta itemprop="datePublished" content="2025-12-13T07:10:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员飞鱼"/> <meta itemprop="url" content="https://juejin.cn/user/1665088861772688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别卷模型了！上下文工程才是大模型应用的王道！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1665088861772688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员飞鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T07:10:25.000Z" title="Sat Dec 13 2025 07:10:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p>现在已经是AI时代了，我之前学过一些AI的东西，所以后续开始分享一些AI相关的内容了。</p>
<blockquote>
<p>如AI工具，AI科普，AI最新技术等等，大家一起拥抱AI，学习AI，利用AI。</p>
</blockquote>
<p><strong>文章内容收录到个人网站，方便阅读</strong>：<a href="https://link.juejin.cn?target=http%3A%2F%2Fhardyfish.top%2F" target="_blank" title="http://hardyfish.top/" ref="nofollow noopener noreferrer">hardyfish.top/</a></p>
<p>对于大多数人来说，处理大量的提示词非常令人头疼，几乎没人愿意花费大量的时间去精心设计这些词。</p>
<blockquote>
<p>用户更倾向于用一句话、一个简单指令，来表达需求。</p>
<p>所以，上下文工程做的事情就是基于用户的<strong>上下文</strong>来补充信息。</p>
</blockquote>
<p>但这里的上下文与大模型的上下文维度有所不同：</p>
<blockquote>
<p>大模型的上下文通常是基于单次输入的上下文，而<strong>这里所指的上下文则是用户的全部历史数据</strong>。</p>
<ul>
<li>甚至可能追溯到用户最初使用平台时的数据。</li>
</ul>
<p>在上下文的处理上，通常采用的方式大体相似，包括检索召回、知识库、向量库、知识图谱等。</p>
<ul>
<li>但关键问题在于如何高效地利用和整合这些数据。</li>
</ul>
</blockquote>
<p><strong>那现在基于大语言模型的聊天应用中的上下文是怎么处理的?</strong></p>
<blockquote>
<p>大模型作为纯粹的推理引擎，不记住任何历史信息。</p>
<ul>
<li>应用层负责维护完整的对话历史。</li>
</ul>
<p>每次向模型发起请求时，都需要携带完整的上下文。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fcc53a841dd4152b877da0c820cb37b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6aOe6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766214624&amp;x-signature=uCoSG5W78WirR0DkH0QmpSETzhQ%3D" alt="" loading="lazy"/></p>
<p>但当应用场景是 Agentic AI 时，上下文管理的复杂度会很高。</p>
<blockquote>
<p>Agentic AI 具备任务分解、多步骤执行、自主思考和工具调用等高级能力。</p>
<p>这些能力的实现都依赖于更加丰富和复杂的上下文结构。</p>
</blockquote>
<p><strong>比如单Agent场景</strong></p>
<blockquote>
<p>假设一个任务被 Agent 分解成了 10 个子任务，每个子任务需要调用两次工具才能完成。</p>
<p>那么这个大任务总共会产生 41 条新增的上下文记录：</p>
<ul>
<li>1 条初始的任务分解思考，加上 10 个子任务各自产生的 4 条记录（1 次工具调用请求 + 1 次工具调用返回，重复两次）。</li>
</ul>
</blockquote>
<p>那目前业界是如何在 Agent 应用上管理上下文的呢？</p>
<blockquote>
<p>上下文优化器会根据当前用户输入、任务目标和模型状态决定是否进行压缩。</p>
<p>还有采用何种压缩策略、丢弃哪些内容、存储为记忆，以及何时进行记忆回填等操作。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b858d928c1384112b1b5ae6aa7329c00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6aOe6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766214624&amp;x-signature=7bt4ZmYGww3iMP1%2BOLla8h3MFX4%3D" alt="" loading="lazy"/></p>
<p><strong>Context Engineering的具体实现方法（参考LangChain）</strong></p>
<p>保存Context：</p>
<blockquote>
<p>将Context筛选总结后保存到内存、硬盘等地方，在模型需要时再发送给它。</p>
<p>如ChatGPT的记忆功能，可将用户输入的信息存入记忆库。</p>
</blockquote>
<p>选择Context：</p>
<blockquote>
<p>静态选择：把永远重要、必须遵守的信息在每次请求时都放入Context。</p>
<ul>
<li>如Cursor的Rules文件、Claude Code的Claude.md文件，确保AI行为符合预期。</li>
</ul>
<p>动态选择：选择与用户问题最相关的内容放入Context。</p>
<p>如ChatGPT从记忆库中挑选相关记忆，从众多工具中挑选相关工具。</p>
<ul>
<li>其中最有名的实现方式是Rag。</li>
</ul>
</blockquote>
<p>压缩Context：</p>
<blockquote>
<p>Agent运行时，Context里会积累大量历史消息，最占空间的是模型输出、文本和工具执行结果。</p>
<p>Claude Code在使用量超过95%时，会运行AutocomPact程序对Context进行压缩。</p>
</blockquote>
<p>隔离Context：</p>
<blockquote>
<p>不同模块的Context互相隔离。</p>
<p>Lead Agent负责任务下发和归纳总结，Sub Agent有独立的工具、运行历史和记忆体系，Context互不影响。</p>
<p>Claude Code中也有类似的SubAgent概念。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于Android Compose架构的思考]]></title>    <link>https://juejin.cn/post/7582857981894148137</link>    <guid>https://juejin.cn/post/7582857981894148137</guid>    <pubDate>2025-12-13T07:11:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582857981894148137" data-draft-id="7582787460419420202" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于Android Compose架构的思考"/> <meta itemprop="keywords" content="Android,前端,MVVM"/> <meta itemprop="datePublished" content="2025-12-13T07:11:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小虎牙007"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036155640"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于Android Compose架构的思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036155640/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小虎牙007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T07:11:36.000Z" title="Sat Dec 13 2025 07:11:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Compose 本身是<strong>声明式 UI 框架</strong>，天然适配「响应式架构」，传统的 MVC/MVP 因「命令式思维」（手动更新 UI）已不再适配，主流架构是 <strong>MVVM（最贴合）</strong>，进阶场景会结合「单向数据流（UDF）」「Clean Architecture（整洁架构）」设计，核心目标是让<strong>数据状态单向流转</strong>，避免 UI 与业务逻辑耦合。</p>
<h3 data-id="heading-0">一、先明确：Compose 为什么“抛弃”MVC/MVP？</h3>





















<table><thead><tr><th>架构</th><th>核心问题（适配 Compose 时）</th></tr></thead><tbody><tr><td>MVC</td><td>Controller 直接操作 UI（Compose 中 UI 由状态驱动，无“ findViewById + 更新”的操作入口），易导致状态混乱</td></tr><tr><td>MVP</td><td>Presenter 持有 View 接口，通过接口回调更新 UI（Compose 中无“View 接口”，回调会破坏声明式思想，增加模板代码）</td></tr><tr><td>MVVM</td><td>ViewModel 持有可观察状态，UI 仅订阅状态（完全贴合 Compose “状态驱动 UI”的核心，无手动更新逻辑）</td></tr></tbody></table>
<h3 data-id="heading-1">二、Compose 主流架构：MVVM + 单向数据流（UDF）</h3>
<p>这是 Google 官方推荐的架构，核心是「状态上移、单向流转」，分为 4 层，职责清晰且适配 Compose 的重组特性：</p>
<h4 data-id="heading-2">1. 架构分层（从上到下）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-operator">┌─────────────────────────┐</span>
<span class="hljs-operator">│</span> <span class="hljs-type">UI</span> 层（<span class="hljs-type">Composable</span> 函数） <span class="hljs-operator">│</span> 仅订阅状态<span class="hljs-operator">、</span>触发事件，无业务逻辑
<span class="hljs-operator">└─────────────┬───────────┘</span>
              <span class="hljs-operator">│</span> 发送事件（如点击）<span class="hljs-operator">/</span> 接收状态更新
<span class="hljs-operator">┌─────────────▼───────────┐</span>
<span class="hljs-operator">│</span> <span class="hljs-type">ViewModel</span> 层（状态持有） <span class="hljs-operator">│</span> 处理<span class="hljs-type">UI事件</span><span class="hljs-operator">、</span>管理状态<span class="hljs-operator">、</span>调用仓库层，不持有<span class="hljs-type">UI引用</span>
<span class="hljs-operator">└─────────────┬───────────┘</span>
              <span class="hljs-operator">│</span> 调用接口<span class="hljs-operator">/</span>本地数据
<span class="hljs-operator">┌─────────────▼───────────┐</span>
<span class="hljs-operator">│</span> <span class="hljs-type">Repository</span> 层（数据仓库）<span class="hljs-operator">│</span> 统一管理数据来源（网络<span class="hljs-operator">/</span>本地<span class="hljs-type">DB</span><span class="hljs-operator">/</span><span class="hljs-type">SharedPref），解耦数据逻辑</span>
<span class="hljs-operator">└─────────────┬───────────┘</span>
              <span class="hljs-operator">│</span> 数据请求<span class="hljs-operator">/</span>存储
<span class="hljs-operator">┌─────────────▼───────────┐</span>
<span class="hljs-operator">│</span> <span class="hljs-type">Data</span> 层（数据源）<span class="hljs-operator">│</span> 网络接口（<span class="hljs-type">Retrofit）</span><span class="hljs-operator">、</span>本地<span class="hljs-type">DB（Room）</span><span class="hljs-operator">、</span><span class="hljs-type">SP等</span>
<span class="hljs-operator">└─────────────────────────┘</span>
</code></pre>
<h4 data-id="heading-3">2. 核心原则：单向数据流（UDF）</h4>
<p>数据只能沿「Data → Repository → ViewModel → UI」方向流转，反向仅通过「事件」触发，避免状态混乱：</p>
<pre><code class="hljs">UI 触发事件（如点击按钮）→ ViewModel 处理事件 → 调用 Repository 获取数据 → ViewModel 更新状态 → UI 自动重组 
</code></pre>
<h3 data-id="heading-4">三、完整示例：MVVM + 单向数据流</h3>
<p>以“登录页”为例，覆盖状态管理、事件处理、数据请求全流程：</p>
<h4 data-id="heading-5">Step 1：Data 层（网络请求）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 数据模型</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginRequest</span>(<span class="hljs-keyword">val</span> username: String, <span class="hljs-keyword">val</span> password: String)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginResponse</span>(<span class="hljs-keyword">val</span> token: String, <span class="hljs-keyword">val</span> userId: String)

<span class="hljs-comment">// 2. 网络接口（Retrofit）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">LoginApi</span> {
    <span class="hljs-meta">@POST(<span class="hljs-string">"login"</span>)</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">login</span><span class="hljs-params">(<span class="hljs-meta">@Body</span> request: <span class="hljs-type">LoginRequest</span>)</span></span>: LoginResponse
}

<span class="hljs-comment">// 3. 本地数据源（示例：SharedPref 保存 Token）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginLocalDataSource</span>(context: Context) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> sp = context.getSharedPreferences(<span class="hljs-string">"login"</span>, Context.MODE_PRIVATE)
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">saveToken</span><span class="hljs-params">(token: <span class="hljs-type">String</span>)</span></span> {
        sp.edit().putString(<span class="hljs-string">"token"</span>, token).apply()
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getToken</span><span class="hljs-params">()</span></span>: String? = sp.getString(<span class="hljs-string">"token"</span>, <span class="hljs-literal">null</span>)
}
</code></pre>
<h4 data-id="heading-6">Step 2：Repository 层（数据仓库）</h4>
<p>统一管理数据来源，ViewModel 无需关心数据从网络/本地来：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginRepository</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> api: LoginApi,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> localDataSource: LoginLocalDataSource
) {
    <span class="hljs-comment">// 登录请求（挂起函数，适配协程）</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">login</span><span class="hljs-params">(username: <span class="hljs-type">String</span>, password: <span class="hljs-type">String</span>)</span></span>: LoginResponse {
        <span class="hljs-keyword">val</span> response = api.login(LoginRequest(username, password))
        <span class="hljs-comment">// 登录成功后保存 Token 到本地</span>
        localDataSource.saveToken(response.token)
        <span class="hljs-keyword">return</span> response
    }
}
</code></pre>
<h4 data-id="heading-7">Step 3：ViewModel 层（状态持有 + 事件处理）</h4>
<p>核心是用 <code>StateFlow</code>/<code>LiveData</code> 持有可观察状态，Compose 订阅后自动重组：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginViewModel</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> repository: LoginRepository
) : ViewModel() {
    <span class="hljs-comment">// 1. UI 状态（聚合所有需要驱动 UI 的数据）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _uiState = MutableStateFlow(LoginUiState())
    <span class="hljs-keyword">val</span> uiState: StateFlow&lt;LoginUiState&gt; = _uiState.asStateFlow() <span class="hljs-comment">// 对外暴露只读流</span>

    <span class="hljs-comment">// 2. 处理登录事件（UI 点击后调用）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleLogin</span><span class="hljs-params">(username: <span class="hljs-type">String</span>, password: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-comment">// 标记加载中</span>
        _uiState.update { it.copy(isLoading = <span class="hljs-literal">true</span>, errorMsg = <span class="hljs-string">""</span>) }
        
        <span class="hljs-comment">// 协程处理异步请求（viewModelScope 自动绑定生命周期）</span>
        viewModelScope.launch {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">val</span> response = repository.login(username, password)
                <span class="hljs-comment">// 登录成功：更新状态</span>
                _uiState.update { 
                    it.copy(
                        isLoading = <span class="hljs-literal">false</span>,
                        isLoginSuccess = <span class="hljs-literal">true</span>,
                        token = response.token
                    )
                }
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                <span class="hljs-comment">// 登录失败：更新错误状态</span>
                _uiState.update { 
                    it.copy(
                        isLoading = <span class="hljs-literal">false</span>,
                        errorMsg = e.message ?: <span class="hljs-string">"登录失败，请重试"</span>
                    )
                }
            }
        }
    }

    <span class="hljs-comment">// 定义 UI 状态数据类（聚合所有 UI 所需状态）</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginUiState</span>(
        <span class="hljs-keyword">val</span> isLoading: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>,
        <span class="hljs-keyword">val</span> errorMsg: String = <span class="hljs-string">""</span>,
        <span class="hljs-keyword">val</span> isLoginSuccess: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>,
        <span class="hljs-keyword">val</span> token: String = <span class="hljs-string">""</span>
    )
}
</code></pre>
<h4 data-id="heading-8">Step 4：UI 层（Composable 函数）</h4>
<p>仅订阅 ViewModel 状态、触发事件，无任何业务逻辑：</p>
<pre><code class="hljs language-ini" lang="ini">@Composable
fun LoginScreen(
    viewModel: <span class="hljs-attr">LoginViewModel</span> = viewModel(), // 自动注入 ViewModel
    onLoginSuccess: (String) -&gt; Unit // 登录成功后的跳转回调
) {
    // 1. 收集 ViewModel 状态（collectAsState 自动订阅，状态变化触发重组）
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    
    // 2. 输入框状态（UI 级临时状态，无需放 ViewModel）
    var username by remember { mutableStateOf("") }
    var password by remember { mutableStateOf("") }

    Column(
        <span class="hljs-attr">modifier</span> = Modifier
            .fillMaxSize()
            .padding(16.dp),
        <span class="hljs-attr">horizontalAlignment</span> = Alignment.CenterHorizontally,
        <span class="hljs-attr">verticalArrangement</span> = Arrangement.Center
    ) {
        // 用户名输入框
        OutlinedTextField(
            <span class="hljs-attr">value</span> = username,
            <span class="hljs-attr">onValueChange</span> = { username = it },
            <span class="hljs-attr">label</span> = { Text(<span class="hljs-string">"用户名"</span>) },
            <span class="hljs-attr">singleLine</span> = <span class="hljs-literal">true</span>,
            <span class="hljs-attr">modifier</span> = Modifier.fillMaxWidth()
        )
        
        Spacer(<span class="hljs-attr">modifier</span> = Modifier.height(<span class="hljs-number">16</span>.dp))
        
        // 密码输入框
        OutlinedTextField(
            <span class="hljs-attr">value</span> = password,
            <span class="hljs-attr">onValueChange</span> = { password = it },
            <span class="hljs-attr">label</span> = { Text(<span class="hljs-string">"密码"</span>) },
            <span class="hljs-attr">singleLine</span> = <span class="hljs-literal">true</span>,
            <span class="hljs-attr">visualTransformation</span> = PasswordVisualTransformation(),
            <span class="hljs-attr">modifier</span> = Modifier.fillMaxWidth()
        )
        
        // 错误提示
        if (uiState.errorMsg.isNotBlank()) {
            Text(
                <span class="hljs-attr">text</span> = uiState.errorMsg,
                <span class="hljs-attr">color</span> = Color.Red,
                <span class="hljs-attr">modifier</span> = Modifier.padding(top = <span class="hljs-number">8</span>.dp)
            )
        }
        
        Spacer(<span class="hljs-attr">modifier</span> = Modifier.height(<span class="hljs-number">16</span>.dp))
        
        // 登录按钮（加载中禁用）
        Button(
            <span class="hljs-attr">onClick</span> = { viewModel.handleLogin(username, password) },
            <span class="hljs-attr">enabled</span> = !uiState.isLoading,
            <span class="hljs-attr">modifier</span> = Modifier.fillMaxWidth()
        ) {
            if (uiState.isLoading) {
                CircularProgressIndicator(
                    <span class="hljs-attr">modifier</span> = Modifier.size(<span class="hljs-number">20</span>.dp),
                    <span class="hljs-attr">strokeWidth</span> = <span class="hljs-number">2</span>.dp
                )
            } else {
                Text("登录")
            }
        }
    }

    // 登录成功：触发跳转（副作用，用 LaunchedEffect 避免重组重复执行）
    LaunchedEffect(uiState.isLoginSuccess) {
        if (uiState.isLoginSuccess) {
            onLoginSuccess(uiState.token)
        }
    }
}
</code></pre>
<h4 data-id="heading-9">Step 5：Activity 层（仅承载 UI）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {
            MyAppTheme {
                LoginScreen(onLoginSuccess = { token -&gt;
                    <span class="hljs-comment">// 登录成功跳转到首页</span>
                    navController.navigate(<span class="hljs-string">"home"</span>)
                })
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-10">四、状态设计的核心规则（避坑关键）</h3>
<h4 data-id="heading-11">1. 状态分类：区分“UI 临时状态”和“业务状态”</h4>























<table><thead><tr><th>状态类型</th><th>示例</th><th>存放位置</th><th>原因</th></tr></thead><tbody><tr><td>UI 临时状态</td><td>输入框内容、列表滚动位置、弹窗显隐</td><td>Composable 内（remember）</td><td>仅影响单个 UI 组件，无需共享/持久化</td></tr><tr><td>业务状态</td><td>登录状态、用户信息、接口返回数据</td><td>ViewModel（StateFlow）</td><td>需跨组件共享、持久化，或随生命周期保活</td></tr></tbody></table>
<h4 data-id="heading-12">2. 状态上移：避免局部状态耦合</h4>
<ul>
<li>若多个子组件需要共享状态（如“登录按钮”和“错误提示”共享 <code>isLoading</code>），将状态上移到父组件/ViewModel；</li>
<li>示例：输入框内容是“局部状态”，但“登录是否成功”是“全局业务状态”，需放在 ViewModel。</li>
</ul>
<h4 data-id="heading-13">3. 不可变状态：用 data class + copy 更新</h4>
<ul>
<li>所有状态数据类（如 <code>LoginUiState</code>）设计为不可变（val），更新时通过 <code>copy</code> 生成新对象；</li>
<li>原因：Compose 依赖“状态对象引用变化”触发重组，可变对象会导致重组失效。</li>
</ul>
<h4 data-id="heading-14">4. 生命周期绑定：用 collectAsStateWithLifecycle</h4>
<ul>
<li>收集 StateFlow 时，优先用 <code>collectAsStateWithLifecycle()</code>（而非 <code>collectAsState()</code>），自动在 Activity/Fragment 进入后台时暂停收集，避免内存泄漏。</li>
</ul>
<h3 data-id="heading-15">五、进阶：MVVM + Clean Architecture（整洁架构）</h3>
<p>中大型项目可在 MVVM 基础上引入 Clean Architecture，进一步分层解耦：</p>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────────────┐
│ Presentation 层 │ UI + ViewModel（与 MVVM 一致）
└─────────┬───────┘
<span class="hljs-code">          │
┌─────────▼───────┐
│ Domain 层       │ 用例（UseCase）+ 领域模型（Entity），封装核心业务逻辑
│                 │ 示例：LoginUseCase 封装“校验参数 + 调用仓库 + 处理结果”
└─────────┬───────┘
          │
┌─────────▼───────┐
│ Data 层         │ Repository + 数据源（网络/本地），Domain 层不关心数据来源
└─────────────────┘
</span></code></pre>
<p>核心优势：Domain 层完全独立于 UI 和数据层，业务逻辑可单独测试，且易适配多端（如 Compose Multiplatform 复用 Domain 层）。</p>
<h3 data-id="heading-16">六、总结</h3>
<p>1.<strong>主流架构</strong>：Compose 首选「MVVM + 单向数据流」，是官方推荐、适配性最好的方案；</p>
<p>2.<strong>状态流转</strong>：UI 触发事件 → ViewModel 处理 → Repository 获取数据 → ViewModel 更新状态 → UI 重组；</p>
<p>3.<strong>核心规则</strong>：状态分类存放、不可变设计、生命周期绑定、状态上移；</p>
<p>4.<strong>进阶优化</strong>：中大型项目加 Clean Architecture 的 Domain 层，解耦业务逻辑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在工具泛滥的时代，我为什么还要做一个“不一样“的工具站]]></title>    <link>https://juejin.cn/post/7582861402278051874</link>    <guid>https://juejin.cn/post/7582861402278051874</guid>    <pubDate>2025-12-13T07:09:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582861402278051874" data-draft-id="7582845425402871848" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在工具泛滥的时代，我为什么还要做一个“不一样“的工具站"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-13T07:09:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="舒一笑不秃头"/> <meta itemprop="url" content="https://juejin.cn/user/4257747754552599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在工具泛滥的时代，我为什么还要做一个“不一样“的工具站
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4257747754552599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    舒一笑不秃头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T07:09:51.000Z" title="Sat Dec 13 2025 07:09:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>这不是一篇产品推广文。</p>
<p>或者说，我不想让它看起来像。</p>
<p>如果你点进来是想看"功能强大"、"一站式解决"、"效率提升 300%"这类话术，可能要让你失望了。我想聊的，是在这个工具站背后，一个开发者对"价值"这件事的思考。</p>
<hr/>
<h2 data-id="heading-1">一、当我们谈论工具时，我们在谈论什么</h2>
<p>打开浏览器，搜索"JSON 格式化工具"，你会得到几十万个结果。</p>
<p>再搜"Base64 编码"、"图片文字识别"，结果只会更多。</p>
<p>工具站，早已是红海中的红海。每一个看起来都差不多：输入框、按钮、输出框，再配上满屏的广告和"立即升级 VIP"的弹窗。</p>
<p>那我为什么还要做一个？</p>
<p>答案很简单：<strong>因为我自己需要，而市面上的工具让我不舒服。</strong></p>
<p>不是功能不够，恰恰相反，是"太多了"。</p>
<p>太多的弹窗、太多的追踪、太多的"智能推荐"、太多的"会员专享"。我只是想格式化一段 JSON，为什么要注册账号？我只是想解码一段 Base64，为什么要看三秒广告？</p>
<p><strong>工具的本质，应该是解决问题，而不是制造问题。</strong></p>
<p>于是，我做了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fstrloom.com" target="_blank" title="https://strloom.com" ref="nofollow noopener noreferrer">StrLoom</a>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e1fe722f2c546ef97a6d9ad6a1dd0d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766214591&amp;x-signature=ucf%2FIMQ01iWVSMjGtcrBlepdUi4%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">二、价值源自需求：一个开发者的日常困境</h2>
<p>作为一个开发者，我每天都在和字符串打交道。</p>
<ul>
<li>后端返回的 JSON 是压缩的，看不清结构</li>
<li>接口传参需要 Base64 编码，手动转换太麻烦</li>
<li>产品发来一张截图，里面有一段代码，我需要把它提取出来</li>
<li>从 PDF 复制的文本，满是换行符和多余空格，粘贴到代码里就报错</li>
</ul>
<p>这些场景，每天都在发生。</p>
<p>我需要的，不是一个"功能全面"的工具站，而是一个<strong>快速、干净、不打扰我的工具</strong>。</p>
<ul>
<li>不需要注册</li>
<li>不需要上传到服务器</li>
<li>不需要等待加载</li>
<li>不需要关闭广告</li>
</ul>
<p><strong>只需要打开，粘贴，点击，复制。</strong></p>
<p>这就是 StrLoom 的全部。</p>
<hr/>
<h2 data-id="heading-3">三、StrLoom 和其他工具站有什么不同？</h2>
<h3 data-id="heading-4">1. 纯前端，零追踪</h3>
<p>所有处理都在你的浏览器中完成。</p>
<p>你的数据不会上传到任何服务器，不会被记录，不会被分析，不会被"用于改进服务"。</p>
<p><strong>你的数据，只属于你。</strong></p>
<h3 data-id="heading-5">2. 极简设计，专注体验</h3>
<p>没有广告，没有弹窗，没有"升级会员"。</p>
<p>界面是赛博朋克风格的深色主题，配色是霓虹青、紫、粉，视觉上舒适，功能上直观。</p>
<p><strong>工具就是工具，不应该成为负担。</strong></p>
<h3 data-id="heading-6">3. 功能精准，不贪多</h3>
<p>StrLoom 只做四件事：</p>
<ul>
<li><strong>JSON 格式化</strong>：支持格式化、压缩、模板合并（这是其他工具少有的功能）</li>
<li><strong>编码/解码</strong>：Base64、URL、Unicode、Hex，一键切换</li>
<li><strong>图片 OCR</strong>：支持粘贴图片，本地识别文字（基于 Tesseract.js）</li>
<li><strong>文本清理</strong>：去除换行、多余空格、制表符，让文本"干净"</li>
</ul>
<p>每个功能都是我自己高频使用的，每个细节都是我反复打磨的。</p>
<p><strong>不求大而全，只求小而美。</strong></p>
<hr/>
<h2 data-id="heading-7">四、价值、共识、模式：一个超级个体的商业思考</h2>
<p>做 StrLoom，不只是为了解决自己的需求。</p>
<p>我想表达的，是一种对"价值"的理解：</p>
<blockquote>
<p><strong>价值源自需求，因为被需求，所以才有价值。</strong><br/>
<strong>共识来自于分歧的超越，共识的成果是成交与关系。</strong><br/>
<strong>模式是自己如何生存与发展，每个人、每个企业都是自身模式与环境互动的产物。</strong></p>
</blockquote>
<p>这三句话，构成了一个商业闭环：</p>
<ol>
<li><strong>洞察需求</strong> → 我发现开发者需要一个干净、快速、隐私的工具站</li>
<li><strong>提供价值</strong> → 我做了 StrLoom，解决这个需求</li>
<li><strong>达成共识</strong> → 用户认可这个价值，使用、分享、推荐</li>
<li><strong>获得成交与关系</strong> → 我获得了用户、反馈、影响力</li>
<li><strong>投资自己</strong> → 我用这些资源继续优化产品，提升竞争力</li>
</ol>
<p>这就是我理解的"超级个体"的生存方式。</p>
<p><strong>不依附于平台，不追逐风口，不盲目扩张。</strong></p>
<p><strong>只做自己擅长的事，只服务真正需要的人，只建立真实的连接。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25684cd4d90d4bd3a4649702e235b792~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766214591&amp;x-signature=rS%2Fs6GWgrNvh4tcoI0dlFK9Gcxc%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-8">五、我不想成为时代的 API</h2>
<p>这个时代，太多人在做"API"。</p>
<p>什么意思？</p>
<p>就是把自己变成一个"接口"，输入需求，输出结果，中间没有思考，没有个性，没有温度。</p>
<ul>
<li>看到 AI 火了，就做 AI 工具</li>
<li>看到短视频火了，就做短视频工具</li>
<li>看到 Web3 火了，就做 Web3 工具</li>
</ul>
<p><strong>追着风口跑，却不知道自己在跑什么。</strong></p>
<p>我不想这样。</p>
<p>我想做一个<strong>有自己身份的超级个体</strong>。</p>
<p>我有自己的审美、自己的价值观、自己的节奏。</p>
<p>我做 StrLoom，不是因为"工具站"是风口，而是因为<strong>我自己需要，我相信也有人和我一样需要</strong>。</p>
<p>我希望通过这个工具站，连接更多<strong>有真实需求、有表达欲、有创造力的构建者</strong>。</p>
<p><strong>我们不是在消费工具，而是在共同创造一种更好的开发体验。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17e36dc2ae9542198803d3e23bbab54a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766214591&amp;x-signature=l2%2BawoTwFF2%2F3VTA9HPlFoUkT1g%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-9">六、StrLoom 的未来</h2>
<p>StrLoom 现在还很简单，只有四个功能。</p>
<p>但我不打算让它变成"大而全"的工具站。</p>
<p>我会继续打磨这四个功能，让它们更快、更稳定、更好用。</p>
<p>我也会根据用户的反馈，慢慢加入新的功能——但前提是，<strong>这些功能是真实需求，而不是为了"看起来功能多"</strong>。</p>
<p>我希望 StrLoom 成为一个<strong>有温度的工具站</strong>。</p>
<p>不是冷冰冰的"输入-输出"，而是一个<strong>让开发者感到舒适、信任、愉悦的地方</strong>。</p>
<hr/>
<h2 data-id="heading-10">七、写在最后</h2>
<p>如果你看到这里，谢谢你的耐心。</p>
<p>我知道这篇文章有点长，有点"不像推广文"。</p>
<p>但我想说的，不只是"来用我的工具吧"，而是：</p>
<p><strong>在这个工具泛滥的时代，我们是否还能做一些"不一样"的东西？</strong></p>
<p><strong>在这个追逐流量的时代，我们是否还能坚持一些"慢"的价值？</strong></p>
<p><strong>在这个人人都想成为"API"的时代，我们是否还能保持自己的身份？</strong></p>
<p>StrLoom 是我的答案。</p>
<p>如果你也认同这些想法，欢迎来试试：</p>
<p>👉 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fstrloom.com" target="_blank" title="https://strloom.com" ref="nofollow noopener noreferrer">strloom.com</a></strong></p>
<p>如果你有任何建议、反馈、或者只是想聊聊天，欢迎联系我。</p>
<p><strong>让我们一起，用心编码，一次一个字符串。</strong></p>
<hr/>
<h2 data-id="heading-11">附：StrLoom 功能速览</h2>
<h3 data-id="heading-12">1. JSON 格式化</h3>
<ul>
<li>一键格式化/压缩 JSON</li>
<li>支持模板合并（独特功能）</li>
<li>实时错误提示</li>
</ul>
<h3 data-id="heading-13">2. 编码/解码</h3>
<ul>
<li>支持 Base64、URL、Unicode、Hex</li>
<li>一键切换编码类型</li>
<li>双向转换</li>
</ul>
<h3 data-id="heading-14">3. 图片 OCR</h3>
<ul>
<li>支持粘贴图片（Ctrl+V）</li>
<li>本地识别，无需上传</li>
<li>基于 Tesseract.js</li>
</ul>
<h3 data-id="heading-15">4. 文本清理</h3>
<ul>
<li>去除换行、多余空格、制表符</li>
<li>实时显示字符数变化</li>
<li>一键复制结果</li>
</ul>
<hr/>
<p><strong>StrLoom: 让字符串找到归宿。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开发可掌握的知识：uber H3网格]]></title>    <link>https://juejin.cn/post/7582861402277871650</link>    <guid>https://juejin.cn/post/7582861402277871650</guid>    <pubDate>2025-12-13T06:38:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582861402277871650" data-draft-id="7573710392212324379" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开发可掌握的知识：uber H3网格"/> <meta itemprop="keywords" content="后端,算法"/> <meta itemprop="datePublished" content="2025-12-13T06:38:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三年之约"/> <meta itemprop="url" content="https://juejin.cn/user/3448523142729784"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开发可掌握的知识：uber H3网格
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3448523142729784/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三年之约
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T06:38:45.000Z" title="Sat Dec 13 2025 06:38:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>H3 是一个<strong>六边形层次空间索引系统</strong>，它将地球表面划分为一个由六边形（和少量五边形）组成的网格。Java 开发者可以通过官方提供的 <code>com.uber.h3core</code> 库来使用这些功能。</p>
<h3 data-id="heading-0">核心概念</h3>
<ul>
<li><strong>六边形网格</strong>：基础单元是六边形，在12个分辨率下具有不同的面积。</li>
<li><strong>H3 索引</strong>：每个六边形（或五边形）都有一个唯一的 64 位 <code>H3Index</code> 来表示，可以简单地用一个 <code>long</code> 类型或十六进制字符串来处理。</li>
<li><strong>分辨率</strong>：共16级（0-15）。分辨率 0 的六边形最大（平均面积约4350 km²），分辨率 15 的六边形最小（平均面积小于1 m²）。</li>
</ul>
<hr/>
<h3 data-id="heading-1">Java 开发中 H3 支持的核心能力</h3>
<p>以下是您可以在 Java 代码中直接使用的主要功能类别：</p>
<h4 data-id="heading-2">1. 地理坐标 ↔ H3 索引转换（核心功能）</h4>
<p>这是最基础也是最重要的功能，用于在经纬度和 H3 索引之间进行转换。</p>
<ul>
<li>
<p><strong><code>geoToH3(double lat, double lng, int resolution)</code></strong></p>
<ul>
<li>
<p><strong>功能</strong>：将给定的经纬度坐标转换为指定分辨率的 H3 索引。</p>
</li>
<li>
<p>分辨率：整数，指定 H3 网格的精度级别（例如 0 到 15），分辨率越高，网格单元越小，覆盖面积越精细</p>
</li>
<li>
<p><strong>Java 示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">H3Core</span> <span class="hljs-variable">h3</span> <span class="hljs-operator">=</span> H3Core.newInstance();
<span class="hljs-type">long</span> <span class="hljs-variable">h3Index</span> <span class="hljs-operator">=</span> h3.geoToH3(<span class="hljs-number">40.7128</span>, -<span class="hljs-number">74.0060</span>, <span class="hljs-number">9</span>); <span class="hljs-comment">// 纽约市坐标，分辨率9</span>
System.out.println(Long.toHexString(h3Index)); <span class="hljs-comment">// 输出：8928308280fffff</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong><code>h3ToGeo(long h3Index)</code></strong></p>
<ul>
<li><strong>功能</strong>：将 H3 索引转换回其中心点的经纬度坐标。</li>
<li><strong>返回</strong>：一个 <code>List&lt;Double&gt;</code>，第一个元素是纬度，第二个是经度。</li>
</ul>
</li>
<li>
<p><strong><code>h3ToGeoBoundary(long h3Index)</code></strong></p>
<ul>
<li><strong>功能</strong>：获取给定 H3 索引所代表的六边形的边界坐标。</li>
<li><strong>返回</strong>：一个 <code>List&lt;List&lt;Double&gt;&gt;</code>，其中每个内层 List 代表一个顶点的 <code>[lat, lng]</code>。这对于在地图上绘制六边形至关重要。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">2. 网格拓扑与邻域分析</h4>
<p>这类功能用于分析六边形之间的空间关系。</p>
<ul>
<li>
<p><strong><code>kRing(long h3Index, int k)</code></strong></p>
<ul>
<li><strong>功能</strong>：获取指定索引周围 <code>k</code> 环（“环”可以理解为距离）内的所有 H3 索引。</li>
<li><strong>示例</strong>：<code>kRing(index, 1)</code> 会返回目标六边形本身和与其直接相邻的6个六边形。</li>
</ul>
</li>
<li>
<p><strong><code>hexRange(long h3Index, int k)</code></strong></p>
<ul>
<li>类似 <code>kRing</code>，但能处理网格变形，在跨越大面积时更可靠，但可能因 pentagon distortion（五边形扭曲）而失败。</li>
</ul>
</li>
<li>
<p><strong><code>h3Distance(long origin, long target)</code></strong></p>
<ul>
<li><strong>功能</strong>：计算两个 H3 索引在网格空间上的距离（以六边形数量为单位）。</li>
</ul>
</li>
<li>
<p><strong><code>getH3UnidirectionalEdge(long origin, long target)</code></strong></p>
<ul>
<li><strong>功能</strong>：获取两个相邻 H3 索引之间的有向边。</li>
</ul>
</li>
<li>
<p><strong><code>getOriginH3IndexFromUnidirectionalEdge(long edge)</code></strong></p>
<ul>
<li><strong>功能</strong>：从有向边获取起始 H3 索引。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">3. 索引层级与关系</h4>
<p>这类功能用于在不同分辨率之间进行转换和检查。</p>
<ul>
<li>
<p><strong><code>h3GetResolution(long h3Index)</code></strong></p>
<ul>
<li><strong>功能</strong>：获取给定 H3 索引的分辨率。</li>
</ul>
</li>
<li>
<p><strong><code>h3ToParent(long h3Index, int parentResolution)</code></strong></p>
<ul>
<li><strong>功能</strong>：获取给定索引在更低分辨率（父级）下的 H3 索引。</li>
<li><strong>示例</strong>：一个分辨率 9 的六边形的父级是分辨率 8 的一个更大的六边形。</li>
</ul>
</li>
<li>
<p><strong><code>h3ToChildren(long h3Index, int childResolution)</code></strong></p>
<ul>
<li><strong>功能</strong>：获取给定索引在更高分辨率（子级）下的所有 H3 索引。</li>
<li><strong>示例</strong>：一个分辨率 8 的六边形通常会被划分为 7 个分辨率 9 的子六边形。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">4. 区域填充与线覆盖</h4>
<p>这是非常强大的空间分析功能。</p>
<ul>
<li>
<p><strong><code>polyfill(List&lt;List&lt;Double&gt;&gt; polygon, List&lt;List&lt;Double&gt;&gt; holes, int resolution)</code></strong></p>
<ul>
<li>
<p><strong>功能</strong>：用一个多边形（带可选空洞）覆盖地球表面，并返回所有被该多边形覆盖的 H3 索引集合。</p>
</li>
<li>
<p><strong>参数</strong>：</p>
<ul>
<li><code>polygon</code>：多边形的外边界，是一个 <code>List</code> 的 <code>[lat, lng]</code> 点。</li>
<li><code>holes</code>：多边形内的洞，格式同外边界。</li>
<li><code>resolution</code>：用于填充的 H3 网格分辨率。</li>
</ul>
</li>
<li>
<p><strong>应用场景</strong>：计算一个城市行政区、一个湖泊或一个配送区域内包含了哪些 H3 六边形。</p>
</li>
</ul>
</li>
<li>
<p><strong><code>h3Line(long start, long end)</code></strong></p>
<ul>
<li><strong>功能</strong>：计算两个 H3 索引之间在网格空间上的最短路径所经过的 H3 索引集合。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">5. 索引验证与属性</h4>
<ul>
<li>
<p><strong><code>h3IsValid(long h3Index)</code></strong></p>
<ul>
<li><strong>功能</strong>：检查一个 long 值是否是有效的 H3 索引。</li>
</ul>
</li>
<li>
<p><strong><code>h3IsResClassIII(long h3Index)</code></strong></p>
<ul>
<li><strong>功能</strong>：检查索引是否是 “Class III” 分辨率（奇数分辨率）的。</li>
</ul>
</li>
<li>
<p><strong><code>getHexAreaKm2(int resolution)</code> / <code>getHexAreaM2(int resolution)</code></strong></p>
<ul>
<li><strong>功能</strong>：获取特定分辨率的六边形的平均面积（平方公里或平方米）。</li>
</ul>
</li>
<li>
<p><strong><code>getNumCells(int resolution)</code></strong></p>
<ul>
<li><strong>功能</strong>：获取全球在特定分辨率下的六边形总数。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-7">geoToH3执行效率如何，底层如何实现</h2>
<p><code>geoToH3</code> 的执行效率非常高，通常可以达到 <strong>微秒级</strong> 甚至 <strong>纳秒级</strong> 的延迟。</p>
<p>这意味着在单核CPU上，每秒可以执行数十万到上百万次的转换操作。这对于绝大多数需要实时处理海量地理位置数据的应用场景（如网约车派单、外卖配送、地理围栏、实时数据分析）来说是绰绰有余的。</p>
<ul>
<li>
<p><strong>性能基准</strong>：根据 Uber 官方和非官方的性能测试，在现代CPU（如 Intel Xeon）上，单次 <code>geoToH3</code> 调用的耗时通常在 <strong>100 ~ 300 纳秒</strong> 之间。</p>
</li>
<li>
<p><strong>影响因素</strong>：</p>
<ul>
<li><strong>分辨率</strong>：转换到不同分辨率对性能影响极小，因为核心算法是一致的。</li>
<li><strong>CPU 架构和主频</strong>：直接影响计算速度。</li>
<li><strong>JVM 状态</strong>：在 HotSpot JVM 中，方法经过 JIT 编译优化后（成为本地代码）性能会达到最佳。</li>
</ul>
</li>
</ul>
<p>这种极高的性能是 H3 能够被广泛应用于大数据和实时系统的关键原因之一。</p>
<hr/>
<h3 data-id="heading-8">底层实现原理</h3>
<p><code>geoToH3</code> 的底层实现是一个非常精妙的几何学和计算机图形学算法。它的目标是将一个球面坐标（经纬度）快速、确定性地映射到一个特定的六边形网格索引上。</p>
<p>整个过程可以概括为三个核心步骤：</p>
<ol>
<li><strong>球面坐标 -&gt; 三维笛卡尔坐标</strong></li>
<li><strong>三维坐标 -&gt; 面片索引（IJK 坐标）</strong></li>
<li><strong>面片索引 -&gt; H3 索引（64位整数）</strong></li>
</ol>
<p>让我们来详细拆解这个过程：</p>
<h4 data-id="heading-9">步骤 1：坐标系统转换和投影</h4>
<ol>
<li>
<p><strong>输入</strong>：经纬度 <code>(lat, lng)</code>。</p>
</li>
<li>
<p><strong>转换到三维向量</strong>：首先将经纬度转换为三维空间中的一个单位向量 <code>(x, y, z)</code>。这个向量位于一个半径为1的“单位球”上。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 伪代码</span>
x = cos(lat) * cos(lng);
y = cos(lat) * sin(lng);
z = sin(lat);
</code></pre>
</li>
<li>
<p><strong>选择正二十面体面片</strong>：H3 的核心基础是一个<strong>展开的正二十面体</strong>。这个多面体有20个正三角形面片。算法会快速确定输入的三维向量指向了这20个面片中的哪一个。这是一个通过向量与面片法向量点积来完成的快速查找过程。</p>
</li>
</ol>
<h4 data-id="heading-10">步骤 2：在选定的面片上进行六边形化网格划分</h4>
<p>这是最复杂也是最核心的一步。算法需要在选定的那个<strong>三角形面片</strong>上，构建一个由六边形和五边形组成的网格。</p>
<ol>
<li>
<p><strong>将三角形面片展开为平面</strong>：通过一种特定的<strong>映射函数</strong>（如 gnomonic projection 或自定义的仿射变换），将三维三角形面片上的点投影到一个二维平面上。</p>
</li>
<li>
<p><strong>定义分辨率和网格</strong>：在投影后的二维平面上，定义不同分辨率下的六边形网格。每个分辨率都对应一个更细粒度的网格划分。</p>
</li>
<li>
<p><strong>计算 IJ 坐标</strong>：对于投影到二维平面上的点 <code>(u, v)</code>，算法会计算它在当前分辨率网格中的 <strong>IJ 坐标</strong>。这可以想象成在一个由许多小六边形组成的“棋盘”上，找到点 <code>(u, v)</code> 落在了哪个格子里。</p>
<ul>
<li><strong>关键算法</strong>：这里使用了一种基于  <strong>“轴坐标”</strong>  的网格系统。确定一个点属于哪个六边形，通常是通过计算它与各个六边形中心点的距离，或者使用一种更高效的、基于平面分割的查找方法。</li>
<li><strong>库实现</strong>：在 H3 的 C 语言底层库中，这部分是通过高度优化的、无分支或少分支的整数运算和查找表来实现的，以追求极致的性能。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-11">步骤 3：编码为 H3Index</h4>
<p>一旦得到了 <strong>面片索引</strong> 和该面片内的 <strong>IJ 坐标</strong> 以及 <strong>分辨率</strong>，最后一步就是将它们打包成一个 64 位的 <code>long</code> 型整数，即 <code>H3Index</code>。</p>
<p><code>H3Index</code> 的 64 位结构如下（简化版）：</p>
<pre><code class="hljs language-text" lang="text">| 0 (1 bit) | Reserved (4 bits) | Mode (4 bits) | Resolution (4 bits) | Base Cell (7 bits) | 子单元索引 (3 bits * (15 - res)) | 0 (1 bit) |
</code></pre>
<ul>
<li><strong>Mode (4 bits)</strong> ：标识这个索引的类型，例如是否是六边形单元、有向边等。对于普通的六边形，这个值是固定的。</li>
<li><strong>Resolution (4 bits)</strong> ：存储分辨率（0-15）。</li>
<li><strong>Base Cell (7 bits)</strong> ：对应步骤1中找到的<strong>正二十面体面片</strong>（实际上是 122 个基础细胞之一，这些基础细胞来自于对20个面片的进一步划分）。</li>
<li><strong>子单元索引</strong>：剩余的位用于存储从基础细胞到目标分辨率细胞路径上的方向序列。这就像是从一个粗粒度的六边形开始，通过一系列“你是我第几个孩子”的指向，最终精确定位到目标六边形。这种表示方法非常紧凑和高效。</li>
</ul>
<h3 data-id="heading-12">Java 层的实现</h3>
<p>在 Java 中，您使用的 <code>com.uber.h3core.H3Core</code> 库实际上是一个 <strong>JNI (Java Native Interface) 包装器</strong>。</p>
<ul>
<li>
<p><strong>核心逻辑在 C 语言中</strong>：所有上述复杂的几何计算和索引生成算法，都是用高度优化的 C 语言实现的，并编译为本地动态库（如 <code>.so</code>, <code>.dll</code>, <code>.dylib</code>）。</p>
</li>
<li>
<p><strong>Java 层是薄封装</strong>：<code>H3Core</code> 类通过 JNI 调用这些底层的 C 函数。当您调用 <code>h3.geoToH3(lat, lng, res)</code> 时：</p>
<ol>
<li>Java 方法将参数 <code>lat</code>, <code>lng</code>, <code>res</code> 通过 JNI 传递到本地侧。</li>
<li>本地侧的 C 函数执行上述三个核心步骤。</li>
<li>计算结果（一个 <code>uint64_t</code>）通过 JNI 返回给 Java 层，作为 <code>long</code> 类型。</li>
</ol>
</li>
</ul>
<p><strong>这种架构的优势</strong>：</p>
<ul>
<li><strong>性能</strong>：关键路径由高效的 C 代码处理。</li>
<li><strong>跨平台</strong>：同一套 Java API 可以在不同操作系统上运行，只需加载对应的本地库即可。</li>
<li><strong>维护性</strong>：核心算法只有一份 C 实现，被所有语言（Java, Python, Go, Rust等）的绑定库共享。</li>
</ul>
<h3 data-id="heading-13">总结</h3>
<p><code>geoToH3</code> 的高效性源于：</p>
<ol>
<li><strong>基于正二十面体的巧妙建模</strong>：用20个面片近似球面，将复杂的球面几何问题分解为20个更简单的平面问题。</li>
<li><strong>高度优化的底层算法</strong>：核心计算使用 C 语言实现，大量使用整数运算和查找表，避免了昂贵的浮点数运算和函数调用。</li>
<li><strong>紧凑的索引编码</strong>：将复杂的空间关系编码为一个 64 位整数，使得存储、传输和计算都非常高效。</li>
<li><strong>JNI 架构</strong>：Java 层只负责简单的调用和封装，计算重任由本地库承担。</li>
</ol>
<p>正是这些设计，使得 H3 成为一个在性能和功能上都极其出色的空间索引工具。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开发需掌握的知识：MQTT协议]]></title>    <link>https://juejin.cn/post/7582845425402757160</link>    <guid>https://juejin.cn/post/7582845425402757160</guid>    <pubDate>2025-12-13T06:29:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582845425402757160" data-draft-id="7572776177690083337" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开发需掌握的知识：MQTT协议"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-13T06:29:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三年之约"/> <meta itemprop="url" content="https://juejin.cn/user/3448523142729784"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开发需掌握的知识：MQTT协议
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3448523142729784/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三年之约
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T06:29:28.000Z" title="Sat Dec 13 2025 06:29:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>MQTT（Message Queuing Telemetry Transport）是一种轻量级的、基于发布/订阅模式的消息传输协议，广泛用于物联网（IoT）和移动应用等低带宽、不稳定网络环境下的消息推送。以下是关于MQTT协议推送的核心概念、工作原理及关键特性的结构化说明：</p>
<hr/>
<h3 data-id="heading-0"><strong>1. MQTT协议核心角色</strong></h3>
<ul>
<li><strong>发布者（Publisher）</strong><br/>
向特定主题（Topic）发送消息的客户端。例如：传感器上报数据。</li>
<li><strong>订阅者（Subscriber）</strong><br/>
订阅感兴趣的主题并接收消息的客户端。例如：仪表盘显示传感器数据。</li>
<li><strong>代理服务器（Broker）</strong><br/>
接收、转发消息的核心服务器（如Mosquitto、EMQX）。负责主题管理、消息路由、QoS控制等。</li>
</ul>
<hr/>
<h3 data-id="heading-1"><strong>2. 主题（Topic）与消息路由</strong></h3>
<ul>
<li>
<p><strong>Topic结构</strong><br/>
使用层级路径标识（如 <code>home/room1/temperature</code>），支持通配符：</p>
<ul>
<li><code>+</code>：单层通配符（<code>home/+/temperature</code> 匹配所有房间温度）。</li>
<li><code>#</code>：多层通配符（<code>home/#</code> 匹配所有子主题）。</li>
</ul>
</li>
<li>
<p><strong>消息路由</strong><br/>
Broker根据Topic将消息推送给所有订阅了该Topic的客户端。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-2"><strong>3. 消息服务质量（QoS）</strong></h3>

























<table><thead><tr><th>QoS等级</th><th>描述</th><th>场景示例</th></tr></thead><tbody><tr><td>0</td><td>最多一次，不保证送达（Fire-and-Forget）</td><td>实时传感器数据流</td></tr><tr><td>1</td><td>至少一次，可能重复（Broker需回复ACK）</td><td>确保设备指令到达</td></tr><tr><td>2</td><td>恰好一次，严格不重不丢（需两次握手）</td><td>金融交易、高敏感操作</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-3"><strong>4. 推送流程示例</strong></h3>
<ol>
<li><strong>连接</strong><br/>
客户端通过TCP/IP连接Broker，使用用户名/密码或Token鉴权（可配置TLS加密）。</li>
<li><strong>订阅</strong><br/>
Subscriber订阅Topic（如 <code>home/room1/+</code>），Broker保留其订阅关系。</li>
<li><strong>发布</strong><br/>
Publisher发送消息至Broker，包含Topic和Payload。</li>
<li><strong>推送</strong><br/>
Broker将消息推送给所有订阅者，根据QoS等待ACK或重试。</li>
<li><strong>断连</strong><br/>
支持遗嘱消息（Last Will）机制，客户端断连时Broker主动推送预设消息。</li>
</ol>
<hr/>
<h3 data-id="heading-4"><strong>5. 关键特性</strong></h3>
<ul>
<li><strong>低延迟与低带宽</strong><br/>
协议头仅2字节，适合嵌入式设备。</li>
<li><strong>会话保持（Persistent Session）</strong><br/>
Broker保存离线客户端的订阅关系和未接收消息（需Clean Session=0）。</li>
<li><strong>双向通信</strong><br/>
订阅者也可发布消息，支持请求/响应模式。</li>
<li><strong>安全机制</strong><br/>
支持TLS/SSL加密、OAuth2.0、客户端证书等。</li>
</ul>
<hr/>
<h3 data-id="heading-5"><strong>6. 典型应用场景</strong></h3>
<ul>
<li><strong>物联网设备遥测</strong><br/>
传感器实时数据上传至云端分析。</li>
<li><strong>移动推送通知</strong><br/>
应用通过MQTT实现低功耗推送（对比HTTP长轮询）。</li>
<li><strong>工业设备监控</strong><br/>
工厂设备状态实时推送到监控大屏。</li>
</ul>
<h3 data-id="heading-6"><strong>6. MQTT与MQ对比</strong></h3>
<p>以下是MQTT与常见传统消息队列（如 <strong>RabbitMQ、Kafka、RocketMQ</strong>）的对比，从Java开发视角整理关键差异点：</p>
































































































<table><thead><tr><th><strong>维度</strong></th><th><strong>MQTT</strong></th><th><strong>传统MQ（RabbitMQ/Kafka/RocketMQ）</strong></th><th><strong>备注</strong></th></tr></thead><tbody><tr><td><strong>设计目标</strong></td><td>低功耗、弱网环境，设备端-云端通信</td><td>高吞吐、企业级服务器间通信</td><td>MQTT的<code>IoT场景</code> vs MQ的<code>大数据/微服务场景</code></td></tr><tr><td><strong>协议头大小</strong></td><td>最小2字节（无消息体时）</td><td>复杂协议头： • AMQP(KB级) • Kafka(动态)</td><td>MQTT在移动网络下显著降低流量消耗</td></tr><tr><td><strong>连接方式</strong></td><td>长连接（基于TCP/IP）</td><td>长连接（TCP）或短连接（HTTP）</td><td>MQTT的<code>Keep-Alive</code>机制更省电</td></tr><tr><td><strong>通信模型</strong></td><td>严格<strong>发布/订阅</strong>，Topic多对多</td><td>多样化模型： • Queue点对点 • Exchange Pub/Sub • Kafka Stream</td><td>MQ的模型更灵活，但需复杂配置（如Kafka分区、RabbitMQ Exchange绑定）</td></tr><tr><td><strong>服务质量(QoS)</strong></td><td>0/1/2三级，协议层保证</td><td>依赖业务层实现（如Kafka的<code>acks=all</code>+生产消费确认）</td><td>MQTT QoS对Java开发者更透明，减少业务代码</td></tr><tr><td><strong>实时性</strong></td><td><strong>服务端主动推送</strong>，延迟可低至100ms</td><td>消费者需主动拉取（Poll），延迟通常100ms-1s</td><td>MQTT适合<code>移动端通知</code>、<code>实时监控</code></td></tr><tr><td><strong>消息保序</strong></td><td>仅支持单主题内有序</td><td>Kafka：分区内严格有序 RabbitMQ：需全局队列</td><td>MQ在<code>交易流水</code>等场景有优势</td></tr><tr><td><strong>吞吐量</strong></td><td>单Broker支持10K-100K级消息/秒</td><td>Kafka可支持百万级/秒，RabbitMQ 10K-50K/秒</td><td>MQ在<code>日志收集</code>、<code>数据管道</code>场景更优</td></tr><tr><td><strong>消息大小</strong></td><td>最大256MB，但推荐&lt;1MB（避免弱网阻塞）</td><td>支持超大消息： • Kafka默认1MB-10MB • RabbitMQ无限制</td><td>MQTT优先优化小包场景</td></tr><tr><td><strong>客户端资源占用</strong></td><td>极低（Paho Java库仅50KB-100KB）</td><td>较高： • Kafka客户端堆内存&gt;100MB • Spring AMQP需多模块依赖</td><td>MQTT适合<code>嵌入式Java</code>（如Android App）</td></tr><tr><td><strong>断连恢复</strong></td><td>自动： • QoS1/2重传 • Persistent Session</td><td>需手动： • Kafka：Rebalance监听 • RabbitMQ：消费者恢复监听</td><td>MQTT弱网下对Java开发者更友好</td></tr><tr><td><strong>主题管理</strong></td><td>动态Topic（无需预创建）</td><td>需预声明： • Exchange/Queue • Kafka Topic</td><td>MQTT的Java代码无需管理Topic生命周期</td></tr><tr><td><strong>安全机制</strong></td><td>支持TLS/SSL，认证简单（用户名/Token）</td><td>复杂： • Kafka：SASL/Kerberos • RabbitMQ：OAuth2+Policy</td><td>MQ的安全功能适合<code>企业级系统</code></td><td/></tr><tr><td><strong>适用Java场景</strong></td><td>• IoT设备管理 • 移动推送 • 跨公网通信</td><td>• 微服务解耦 • 大数据管道 • 金融级事务</td><td>两者可结合使用（如设备→MQTT→Kafka→分析）</td></tr></tbody></table>
<hr/>
<p>以下是<strong>弱网场景</strong>的MQTT与MQ对比：</p>





















































<table><thead><tr><th><strong>弱网问题</strong></th><th><strong>MQTT的解决方案</strong></th><th><strong>传统MQ的局限性</strong></th><th><strong>对Java开发者的意义</strong></th></tr></thead><tbody><tr><td><strong>消息丢失（网络中断）</strong></td><td>• <strong>QoS1/2</strong>：协议层自动重传 • <strong>Persistent Session</strong>：断网后Broker保留离线消息（订阅者恢复后补发） • <strong>本地持久化</strong>：Paho客户端本地磁盘缓存消息</td><td>• 依赖业务层重试（如Kafka的<code>retries=3</code>） • 断连后未消费消息需依赖外部存储（如Redis） • 消费者需监听<code>ConsumerRebalance</code>事件手动恢复消费</td><td>减少Java代码中<strong>手动实现重试、断连恢复</strong>的复杂度，MQTT协议层自动处理，开发者只需配置QoS参数和会话模式</td></tr><tr><td><strong>延迟敏感（高抖动）</strong></td><td>• <strong>长连接+心跳</strong>：持续保活，避免重建TCP • <strong>主动推送</strong>：服务端到客户端无延迟 • <strong>动态QoS</strong>：网络差时可自动降级（如QoS2→1）</td><td>• <strong>短连接轮询</strong>：HTTP模式增加延迟（如RabbitMQ的Web STOMP） • <strong>拉取模式</strong>：<code>poll()</code>间隔导致延迟（Kafka最小间隔500ms）</td><td>Java客户端无需复杂逻辑即可实现<strong>低延迟通信</strong>，尤其在移动设备（如Android App）中显著优化用户体验</td></tr><tr><td><strong>频繁断连（网络切换）</strong></td><td>• <strong>遗嘱消息</strong>：断连时Broker自动通知（如<code>device/123/offline</code>） • <strong>会话保持</strong>：快速重连后恢复订阅状态（无需重复订阅）</td><td>• 需业务层监听<code>connection_closed</code>事件 • 断连后需手动重建资源（如Kafka的<code>consumer.seek()</code>重新定位）</td><td>通过MQTT的<strong>自动断连检测与通知</strong>，Java开发只需处理业务逻辑，无需开发心跳检测、资源重建等通用逻辑</td></tr><tr><td><strong>小包高频（带宽有限）</strong></td><td>• <strong>极简协议头</strong>：最小2字节（vs AMQP/Kafka的KB级） • <strong>消息合并</strong>：单次TCP发送多个消息</td><td>• 固定协议头大（如Kafka每条消息固定元数据） • 多消息需批量（如Kafka Producer的<code>batch.size</code>）</td><td>在4G/WiFi混合网络中，MQTT的<strong>小数据包</strong>降低流量消耗，Java业务层无需手动优化</td></tr><tr><td><strong>服务端压力大（海量弱网设备）</strong></td><td>• <strong>Broker分层集群</strong>：EMQX支持百万级连接 • <strong>低心跳频率</strong>：支持90-120秒长心跳间隔</td><td>• 大量长连接消耗内存（如Kafka单连接需2MB） • 快速重连导致负载峰值（如RabbitMQ的TCP洪水）</td><td>Java服务可通过<strong>横向扩展MQTT Broker</strong>应对设备暴增，而传统MQ需预先计算分区/队列数量，弹性不足</td></tr><tr><td><strong>弱网阻塞（消息积压）</strong></td><td>• <strong>Max Inflight限制</strong>：控制单客户端未ACK消息数（默认20） • <strong>Backoff策略</strong>：自动退避重传（如60秒）</td><td>• 需手动配置消费者限流（如RabbitMQ的<code>prefetch_count</code>） • 积压后需监控Consumer Lag（如Kafka的JMX）</td><td>通过<code>setMaxInflight(50)</code>等参数，Java开发者<strong>一键控制弱网下的内存占用</strong>，无需自己实现消息堆积处理逻辑</td></tr><tr><td><strong>安全握手失败（高延迟SSL）</strong></td><td>• <strong>TLS会话复用</strong>：减少握手次数 • <strong>弱网优化Cipher</strong>：支持低计算量算法（如<code>TLS_PSK</code>）</td><td>• 完整SSL握手耗时1-2秒（高延迟下易失败） • 需手动调整SSL参数（如Kafka的<code>ssl.enabled.protocols</code>）</td><td>MQTT的<strong>轻量级加密</strong>适应弱网，Java代码中仅需配置<code>SSLContext</code>，无需额外优化</td></tr></tbody></table>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[K8S 中使用 YAML 安装 ECK]]></title>    <link>https://juejin.cn/post/7582769411994583092</link>    <guid>https://juejin.cn/post/7582769411994583092</guid>    <pubDate>2025-12-12T14:53:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582769411994583092" data-draft-id="7582776967818100736" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="K8S 中使用 YAML 安装 ECK"/> <meta itemprop="keywords" content="Elasticsearch,Kubernetes"/> <meta itemprop="datePublished" content="2025-12-12T14:53:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小陈运维"/> <meta itemprop="url" content="https://juejin.cn/user/3315782802482007"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            K8S 中使用 YAML 安装 ECK
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3315782802482007/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小陈运维
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T14:53:37.000Z" title="Fri Dec 12 2025 14:53:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">K8S 中使用 YAML 安装 ECK</h2>
<p>Kubernetes 是目前最受欢迎的容器编排技术，越来越多的应用开始往 Kubernetes 中迁移。Kubernetes 现有的 ReplicaSet、Deployment、Service 等资源对象已经可以满足无状态应用对于自动扩缩容、负载均衡等基本需求。但是对于有状态的、分布式的应用，通常拥有各自的一套模型定义规范，例如 Prometheus，Etcd，Zookeeper，Elasticsearch 等等。部署这些分布式应用往往需要熟悉特定领域的知识，并且在扩缩容和升级时需要考虑如何保证应用服务的可用性等问题。为了简化有状态、分布式应用的部署，Kubernetes Operator 应运而生。</p>
<p>Kubernetes Operator 是一种特定的应用控制器，通过 CRD（Custom Resource Definitions，自定义资源定义）扩展 Kubernetes API 的功能，可以用它来创建、配置和管理特定的有状态应用，而不需要直接去使用 Kubernetes 中最原始的一些资源对象，比如 Pod，Deployment，Service 等等。</p>
<p>Elastic Cloud on Kubernetes（ECK） 是其中的一种 Kubernetes Operator，方便我们管理 Elastic Stack 家族中的各种组件，例如 Elasticsearch，Kibana，APM，Beats 等等。比如只需要定义一个 Elasticsearch 类型的 CRD 对象，ECK 就可以帮助我们快速搭建出一套 Elasticsearch 集群。</p>
<h3 data-id="heading-1">使用create安装Elastic的自定义资源定义</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-192-168-1-140 ~]# kubectl create -f https://download.elastic.co/downloads/eck/3.2.0/crds.yaml
customresourcedefinition.apiextensions.k8s.io/agents.agent.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/apmservers.apm.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/beats.beat.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/elasticmapsservers.maps.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/elasticsearchautoscalers.autoscaling.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/elasticsearches.elasticsearch.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/enterprisesearches.enterprisesearch.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/kibanas.kibana.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/logstashes.logstash.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/stackconfigpolicies.stackconfigpolicy.k8s.elastic.co created
[root@k8s-192-168-1-140 ~]# 
</code></pre>
<h3 data-id="heading-2">使用kubectl apply 安装operator及其RBAC规则</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-192-168-1-140 ~]# kubectl apply -f https://download.elastic.co/downloads/eck/3.2.0/operator.yaml
namespace/elastic-system created
serviceaccount/elastic-operator created
secret/elastic-webhook-server-cert created
configmap/elastic-operator created
clusterrole.rbac.authorization.k8s.io/elastic-operator created
clusterrole.rbac.authorization.k8s.io/elastic-operator-view created
clusterrole.rbac.authorization.k8s.io/elastic-operator-edit created
clusterrolebinding.rbac.authorization.k8s.io/elastic-operator created
service/elastic-webhook-server created
statefulset.apps/elastic-operator created
validatingwebhookconfiguration.admissionregistration.k8s.io/elastic-webhook.k8s.elastic.co created
[root@k8s-192-168-1-140 ~]# 
</code></pre>
<h3 data-id="heading-3">查看是否启动完成</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-192-168-1-140 ~]kubectl get -n elastic-system pods
NAME                 READY   STATUS    RESTARTS   AGE
elastic-operator-0   1/1     Running   0          8m38s
[root@k8s-192-168-1-140 ~]# 
</code></pre>
<h3 data-id="heading-4">启动部署</h3>
<p>Operator自动创建和管理Kubernetes资源，以实现Elasticsearch集群的期望状态。可能需要几分钟的时间才能创建所有资源并准备好使用群集。</p>
<pre><code class="hljs language-shell" lang="shell">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: quickstart
spec:
  version: 9.2.2
  nodeSets:
  - name: default
    count: 1
    config:
      node.store.allow_mmap: false
EOF
</code></pre>
<h3 data-id="heading-5">存储用量</h3>
<p>创建时默认为1G存储空间，可以在创建时配置申明空间</p>
<pre><code class="hljs language-shell" lang="shell">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: quickstart
spec:
  version: 9.2.2
  nodeSets:
  - name: default
    count: 1
    volumeClaimTemplates:
    - metadata:
        name: elasticsearch-data
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 5Gi
        storageClassName: nfs-storage
    config:
      node.store.allow_mmap: false
EOF
</code></pre>
<h3 data-id="heading-6">查看部署状态</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-192-168-1-140 ~]# 
[root@k8s-192-168-1-140 ~]# kubectl get pod -A
NAMESPACE        NAME                                       READY   STATUS    RESTARTS            AGE
default          nginx-66686b6766-tdwt2                     1/1     Running   2 (&lt;invalid&gt; ago)   81d
default          quickstart-es-default-0                    0/1     Pending   0                   2m1s
elastic-system   elastic-operator-0                         1/1     Running   0                   12m
kube-system      calico-kube-controllers-78dcb7b647-8f2ph   1/1     Running   2 (&lt;invalid&gt; ago)   81d
kube-system      calico-node-hpwvr                          1/1     Running   2 (&lt;invalid&gt; ago)   81d
kube-system      coredns-6746f4cb74-bhkv8                   1/1     Running   2 (&lt;invalid&gt; ago)   81d
kube-system      metrics-server-55c56cb875-bwbpr            1/1     Running   2 (&lt;invalid&gt; ago)   81d
kube-system      node-local-dns-nz4q7                       1/1     Running   2 (&lt;invalid&gt; ago)   81d
[root@k8s-192-168-1-140 ~]# 
</code></pre>
<h3 data-id="heading-7">查看日志</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-192-168-1-140 ~]# kubectl logs -f quickstart-es-default-0
Defaulted container "elasticsearch" out of: elasticsearch, elastic-internal-init-filesystem (init), elastic-internal-suspend (init)
[root@k8s-192-168-1-140 ~]# 
</code></pre>
<h3 data-id="heading-8">安装NFS动态挂载</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-192-168-1-140 ~]# yum  install  nfs-utils -y
[root@k8s-192-168-1-140 ~]# mkdir /nfs
[root@k8s-192-168-1-140 ~]#  vim /etc/exports
/nfs *(rw,sync,no_root_squash,no_subtree_check)

[root@k8s-192-168-1-140 ~]# systemctl restart rpcbind
[root@k8s-192-168-1-140 ~]# systemctl restart nfs-server
[root@k8s-192-168-1-140 ~]# systemctl  enable  rpcbind
[root@k8s-192-168-1-140 ~]# systemctl  enable  nfs-server
</code></pre>
<h3 data-id="heading-9">K8S 编写NFS供给</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-192-168-1-140 ~]#  vim nfs-storage.yaml
[root@k8s-192-168-1-140 ~]# 
[root@k8s-192-168-1-140 ~]#  cat nfs-storage.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs-storage
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
provisioner: k8s-sigs.io/nfs-subdir-external-provisioner
parameters:
  archiveOnDelete: "true"  ## 删除pv的时候，pv的内容是否要备份


---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nfs-client-provisioner
  labels:
    app: nfs-client-provisioner
<span class="hljs-meta prompt_">  # </span><span class="bash">replace with namespace <span class="hljs-built_in">where</span> provisioner is deployed</span>
  namespace: default
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: nfs-client-provisioner
  template:
    metadata:
      labels:
        app: nfs-client-provisioner
    spec:
      serviceAccountName: nfs-client-provisioner
      containers:
        - name: nfs-client-provisioner
          image: registry.cn-hangzhou.aliyuncs.com/chenby/nfs-subdir-external-provisioner:v4.0.2
          # resources:
          #    limits:
          #      cpu: 10m
          #    requests:
          #      cpu: 10m
          volumeMounts:
            - name: nfs-client-root
              mountPath: /persistentvolumes
          env:
            - name: PROVISIONER_NAME
              value: k8s-sigs.io/nfs-subdir-external-provisioner
            - name: NFS_SERVER
              value: 192.168.1.140 ## 指定自己nfs服务器地址
            - name: NFS_PATH  
              value: /nfs/  ## nfs服务器共享的目录
      volumes:
        - name: nfs-client-root
          nfs:
            server: 192.168.1.140
            path: /nfs/
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nfs-client-provisioner
<span class="hljs-meta prompt_">  # </span><span class="bash">replace with namespace <span class="hljs-built_in">where</span> provisioner is deployed</span>
  namespace: default
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: nfs-client-provisioner-runner
rules:
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["persistentvolumes"]
    verbs: ["get", "list", "watch", "create", "delete"]
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["get", "list", "watch", "update"]
  - apiGroups: ["storage.k8s.io"]
    resources: ["storageclasses"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "update", "patch"]
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: run-nfs-client-provisioner
subjects:
  - kind: ServiceAccount
    name: nfs-client-provisioner
    # replace with namespace where provisioner is deployed
    namespace: default
roleRef:
  kind: ClusterRole
  name: nfs-client-provisioner-runner
  apiGroup: rbac.authorization.k8s.io
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: leader-locking-nfs-client-provisioner
<span class="hljs-meta prompt_">  # </span><span class="bash">replace with namespace <span class="hljs-built_in">where</span> provisioner is deployed</span>
  namespace: default
rules:
  - apiGroups: [""]
    resources: ["endpoints"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: leader-locking-nfs-client-provisioner
<span class="hljs-meta prompt_">  # </span><span class="bash">replace with namespace <span class="hljs-built_in">where</span> provisioner is deployed</span>
  namespace: default
subjects:
  - kind: ServiceAccount
    name: nfs-client-provisioner
    # replace with namespace where provisioner is deployed
    namespace: default
roleRef:
  kind: Role
  name: leader-locking-nfs-client-provisioner
  apiGroup: rbac.authorization.k8s.io
</code></pre>
<h3 data-id="heading-10">开始安装</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-192-168-1-140 ~]#  kubectl apply -f nfs-storage.yaml
storageclass.storage.k8s.io/nfs-storage created
deployment.apps/nfs-client-provisioner created
serviceaccount/nfs-client-provisioner created
clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created
clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created
role.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created
rolebinding.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created
[root@k8s-192-168-1-140 ~]# 
</code></pre>
<h3 data-id="heading-11">查看存储</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-192-168-1-140 ~]# kubectl get storageclasses.storage.k8s.io
NAME                    PROVISIONER                                   RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
nfs-storage (default)   k8s-sigs.io/nfs-subdir-external-provisioner   Delete          Immediate           false                  6h7m
[root@k8s-192-168-1-140 ~]# 

[root@k8s-192-168-1-140 ~]# kubectl get pvc
NAME                                         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
elasticsearch-data-quickstart-es-default-0   Bound    pvc-2df832aa-1c54-4af6-8384-5e5c5f167445   5Gi        RWO            nfs-storage    &lt;unset&gt;                 39s
[root@k8s-192-168-1-140 ~]# 

[root@k8s-192-168-1-140 ~]# kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                                STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
pvc-2df832aa-1c54-4af6-8384-5e5c5f167445   5Gi        RWO            Delete           Bound    default/elasticsearch-data-quickstart-es-default-0   nfs-storage    &lt;unset&gt;                          43s
[root@k8s-192-168-1-140 ~]# 
</code></pre>
<h3 data-id="heading-12">查看ES服务发现</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-192-168-1-140 ~]# kubectl get service
NAME                          TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
kubernetes                    ClusterIP   10.68.0.1      &lt;none&gt;        443/TCP        81d
nginx                         NodePort    10.68.148.53   &lt;none&gt;        80:30330/TCP   81d
quickstart-es-default         ClusterIP   None           &lt;none&gt;        9200/TCP       74s
quickstart-es-http            ClusterIP   10.68.66.232   &lt;none&gt;        9200/TCP       75s
quickstart-es-internal-http   ClusterIP   10.68.121.73   &lt;none&gt;        9200/TCP       75s
quickstart-es-transport       ClusterIP   None           &lt;none&gt;        9300/TCP       75s
[root@k8s-192-168-1-140 ~]# 
</code></pre>
<h3 data-id="heading-13">查看ES密码</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-192-168-1-140 ~]# PASSWORD=$(kubectl get secret quickstart-es-elastic-user -o go-template='{{.data.elastic | base64decode}}')
[root@k8s-192-168-1-140 ~]# 
[root@k8s-192-168-1-140 ~]# kubectl get secret quickstart-es-elastic-user -o go-template='{{.data.elastic | base64decode}}'
V3VPqwQMURTSg6zFYvVIsH13[root@k8s-192-168-1-140 ~]# 
[root@k8s-192-168-1-140 ~]# 
[root@k8s-192-168-1-140 ~]# curl -u "elastic:$PASSWORD" -k "https://10.68.66.232:9200"
{
  "name" : "quickstart-es-default-0",
  "cluster_name" : "quickstart",
  "cluster_uuid" : "JNqGubnmSeao_LO-JmypHg",
  "version" : {
    "number" : "9.2.2",
    "build_flavor" : "default",
    "build_type" : "docker",
    "build_hash" : "ed771e6976fac1a085affabd45433234a4babeaf",
    "build_date" : "2025-11-27T08:06:51.614397514Z",
    "build_snapshot" : false,
    "lucene_version" : "10.3.2",
    "minimum_wire_compatibility_version" : "8.19.0",
    "minimum_index_compatibility_version" : "8.0.0"
  },
  "tagline" : "You Know, for Search"
}
[root@k8s-192-168-1-140 ~]# 
</code></pre>
<h3 data-id="heading-14">安装Kibana服务</h3>
<pre><code class="hljs language-shell" lang="shell">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: kibana.k8s.elastic.co/v1
kind: Kibana
metadata:
  name: quickstart
spec:
  version: 9.2.2
  count: 1
  elasticsearchRef:
    name: quickstart
EOF
</code></pre>
<h3 data-id="heading-15">查看服务状态以及密码信息</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-192-168-1-140 ~]# kubectl get kibana
NAME         HEALTH   NODES   VERSION   AGE
quickstart   red              9.2.2     16s
[root@k8s-192-168-1-140 ~]# 
<span class="hljs-meta prompt_">
# </span><span class="bash">查看密码</span>
[root@k8s-192-168-1-140 ~]# kubectl get secret quickstart-es-elastic-user -o=jsonpath='{.data.elastic}' | base64 --decode; echo
V3VPqwQMURTSg6zFYvVIsH13
[root@k8s-192-168-1-140 ~]#


[root@k8s-192-168-1-140 ~]# kubectl get service 
NAME                          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
kubernetes                    ClusterIP   10.68.0.1       &lt;none&gt;        443/TCP        81d
nginx                         NodePort    10.68.148.53    &lt;none&gt;        80:30330/TCP   81d
quickstart-es-default         ClusterIP   None            &lt;none&gt;        9200/TCP       2m47s
quickstart-es-http            ClusterIP   10.68.66.232    &lt;none&gt;        9200/TCP       2m48s
quickstart-es-internal-http   ClusterIP   10.68.121.73    &lt;none&gt;        9200/TCP       2m48s
quickstart-es-transport       ClusterIP   None            &lt;none&gt;        9300/TCP       2m48s
quickstart-kb-http            ClusterIP   10.68.103.103   &lt;none&gt;        5601/TCP       24s
[root@k8s-192-168-1-140 ~]# 

[root@k8s-192-168-1-140 ~]# kubectl get service quickstart-kb-http
NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
quickstart-kb-http   ClusterIP   10.68.103.103   &lt;none&gt;        5601/TCP   2m39s
[root@k8s-192-168-1-140 ~]# 
</code></pre>
<h3 data-id="heading-16">开启访问</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-192-168-1-140 ~] kubectl port-forward --address 0.0.0.0 service/quickstart-kb-http 5601
Forwarding from 0.0.0.0:5601 -&gt; 5601
<span class="hljs-meta prompt_">


# </span><span class="bash">登录地址</span>
https://192.168.1.140:5601/login

用户：
elastic

密码：
V3VPqwQMURTSg6zFYvVIsH13
</code></pre>
<h3 data-id="heading-17">修改ES副本数</h3>
<pre><code class="hljs language-shell" lang="shell">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: quickstart
spec:
  version: 9.2.2
  nodeSets:
  - name: default
    count: 3
    config:
      node.store.allow_mmap: false
EOF
</code></pre>
<h3 data-id="heading-18">查看状态</h3>
<pre><code class="hljs language-shell" lang="shell">[root@k8s-192-168-1-140 ~]# kubectl get pod -A
NAMESPACE        NAME                                       READY   STATUS    RESTARTS            AGE
default          nfs-client-provisioner-58d465c998-w8mfq    1/1     Running   0                   5h38m
default          nginx-66686b6766-tdwt2                     1/1     Running   2 (&lt;invalid&gt; ago)   81d
default          quickstart-es-default-0                    1/1     Running   0                   5h51m
default          quickstart-kb-57cc78f6b8-b8fpf             1/1     Running   0                   5h24m
elastic-system   elastic-operator-0                         1/1     Running   0                   6h2m
kube-system      calico-kube-controllers-78dcb7b647-8f2ph   1/1     Running   2 (&lt;invalid&gt; ago)   81d
kube-system      calico-node-hpwvr                          1/1     Running   2 (&lt;invalid&gt; ago)   81d
kube-system      coredns-6746f4cb74-bhkv8                   1/1     Running   2 (&lt;invalid&gt; ago)   81d
kube-system      metrics-server-55c56cb875-bwbpr            1/1     Running   2 (&lt;invalid&gt; ago)   81d
kube-system      node-local-dns-nz4q7                       1/1     Running   2 (&lt;invalid&gt; ago)   81d
[root@k8s-192-168-1-140 ~]# kubectl get pod -A -w
NAMESPACE        NAME                                       READY   STATUS    RESTARTS            AGE
default          nfs-client-provisioner-58d465c998-w8mfq    1/1     Running   0                   5h38m
default          nginx-66686b6766-tdwt2                     1/1     Running   2 (&lt;invalid&gt; ago)   81d
default          quickstart-es-default-0                    1/1     Running   0                   5h51m
default          quickstart-kb-57cc78f6b8-b8fpf             1/1     Running   0                   5h24m
elastic-system   elastic-operator-0                         1/1     Running   0                   6h2m
kube-system      calico-kube-controllers-78dcb7b647-8f2ph   1/1     Running   2 (&lt;invalid&gt; ago)   81d
kube-system      calico-node-hpwvr                          1/1     Running   2 (&lt;invalid&gt; ago)   81d
kube-system      coredns-6746f4cb74-bhkv8                   1/1     Running   2 (&lt;invalid&gt; ago)   81d
kube-system      metrics-server-55c56cb875-bwbpr            1/1     Running   2 (&lt;invalid&gt; ago)   81d
kube-system      node-local-dns-nz4q7                       1/1     Running   2 (&lt;invalid&gt; ago)   81d




default          quickstart-es-default-1                    0/1     Pending   0                   0s
default          quickstart-es-default-1                    0/1     Pending   0                   0s
default          quickstart-es-default-1                    0/1     Pending   0                   0s
default          quickstart-es-default-1                    0/1     Init:0/2   0                   0s
default          quickstart-es-default-1                    0/1     Init:0/2   0                   1s
default          quickstart-es-default-0                    1/1     Running    0                   5h51m
default          quickstart-es-default-1                    0/1     Init:0/2   0                   1s
default          quickstart-es-default-0                    1/1     Running    0                   5h51m
default          quickstart-es-default-1                    0/1     Init:0/2   0                   2s
default          quickstart-es-default-1                    0/1     Init:1/2   0                   3s
default          quickstart-es-default-1                    0/1     PodInitializing   0                   4s
default          quickstart-es-default-1                    0/1     Running           0                   5s
default          quickstart-es-default-1                    1/1     Running           0                   26s
default          quickstart-es-default-2                    0/1     Pending           0                   0s
default          quickstart-es-default-2                    0/1     Pending           0                   0s
default          quickstart-es-default-2                    0/1     Pending           0                   0s
default          quickstart-es-default-2                    0/1     Init:0/2          0                   0s
default          quickstart-es-default-2                    0/1     Init:0/2          0                   1s
default          quickstart-es-default-0                    1/1     Running           0                   5h51m
default          quickstart-es-default-1                    1/1     Running           0                   30s
default          quickstart-es-default-2                    0/1     Init:0/2          0                   2s
default          quickstart-es-default-1                    1/1     Running           0                   30s
default          quickstart-es-default-2                    0/1     Init:0/2          0                   2s
default          quickstart-es-default-0                    1/1     Running           0                   5h51m
default          quickstart-es-default-2                    0/1     Init:1/2          0                   3s
default          quickstart-es-default-2                    0/1     PodInitializing   0                   4s
default          quickstart-es-default-2                    0/1     Running           0                   5s
default          quickstart-es-default-2                    1/1     Running           0                   33s
^C[root@k8s-192-168-1-140 ~]# 
[root@k8s-192-168-1-140 ~]# 
[root@k8s-192-168-1-140 ~]# 
[root@k8s-192-168-1-140 ~]# kubectl get pod -A -w

NAMESPACE        NAME                                       READY   STATUS    RESTARTS            AGE
default          nfs-client-provisioner-58d465c998-w8mfq    1/1     Running   0                   5h40m
default          nginx-66686b6766-tdwt2                     1/1     Running   2 (&lt;invalid&gt; ago)   81d
default          quickstart-es-default-0                    1/1     Running   0                   5h53m
default          quickstart-es-default-1                    1/1     Running   0                   2m19s
default          quickstart-es-default-2                    1/1     Running   0                   111s
default          quickstart-kb-57cc78f6b8-b8fpf             1/1     Running   0                   5h26m
elastic-system   elastic-operator-0                         1/1     Running   0                   6h4m
kube-system      calico-kube-controllers-78dcb7b647-8f2ph   1/1     Running   2 (&lt;invalid&gt; ago)   81d
kube-system      calico-node-hpwvr                          1/1     Running   2 (&lt;invalid&gt; ago)   81d
kube-system      coredns-6746f4cb74-bhkv8                   1/1     Running   2 (&lt;invalid&gt; ago)   81d
kube-system      metrics-server-55c56cb875-bwbpr            1/1     Running   2 (&lt;invalid&gt; ago)   81d
kube-system      node-local-dns-nz4q7                       1/1     Running   2 (&lt;invalid&gt; ago)   81d

</code></pre>
<h3 data-id="heading-19">卸载删除</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">
# </span><span class="bash">删除所有命名空间中的所有Elastic资源</span>
kubectl get namespaces --no-headers -o custom-columns=:metadata.name \
  | xargs -n1 kubectl delete elastic --all -n
<span class="hljs-meta prompt_">
# </span><span class="bash">删除operator</span>
kubectl delete -f https://download.elastic.co/downloads/eck/3.2.0/operator.yaml
kubectl delete -f https://download.elastic.co/downloads/eck/3.2.0/crds.yaml
</code></pre>
<p><strong>关于</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oiox.cn%2F" target="_blank" title="https://www.oiox.cn/" ref="nofollow noopener noreferrer">www.oiox.cn/</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oiox.cn%2Findex.php%2Fstart-page.html" target="_blank" title="https://www.oiox.cn/index.php/start-page.html" ref="nofollow noopener noreferrer">www.oiox.cn/index.php/s…</a></p>
<p><strong>CSDN、GitHub、知乎、开源中国、思否、掘金、简书、华为云、阿里云、腾讯云、哔哩哔哩、今日头条、新浪微博、个人博客</strong></p>
<p><strong>全网可搜《小陈运维》</strong></p>
<p><strong>文章主要发布于微信公众号：《Linux运维交流社区》</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day5：线程池进阶——我从「只会跑 void 任务」到「能返回 future」，并用 Demo 验证跑通]]></title>    <link>https://juejin.cn/post/7582849187864657971</link>    <guid>https://juejin.cn/post/7582849187864657971</guid>    <pubDate>2025-12-12T14:55:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582849187864657971" data-draft-id="7582814236583264294" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day5：线程池进阶——我从「只会跑 void 任务」到「能返回 future」，并用 Demo 验证跑通"/> <meta itemprop="keywords" content="操作系统"/> <meta itemprop="datePublished" content="2025-12-12T14:55:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="肆忆_"/> <meta itemprop="url" content="https://juejin.cn/user/3898194938326714"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day5：线程池进阶——我从「只会跑 void 任务」到「能返回 future」，并用 Demo 验证跑通
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3898194938326714/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    肆忆_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T14:55:08.000Z" title="Fri Dec 12 2025 14:55:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是我操作系统 / 多线程手撕题的 <strong>Day5</strong>。<br/>
Day4 我已经写出了基础线程池：队列里放 <code>std::function&lt;void()&gt;</code>，worker 线程循环取任务执行。</p>
<p>但我 Day5 的核心诉求很现实：</p>
<blockquote>
<p><strong>我希望线程池提交一个 <code>int()</code> 任务后，能拿到返回值。</strong><br/>
我想要的是：提交任务立刻返回；结果什么时候取由调用者决定。</p>
</blockquote>
<p>最终我把进阶版本跑通了，并用一个验证 demo 得到输出：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[main]</span> submit tasks, main thread <span class="hljs-attr">id</span> = <span class="hljs-number">111212</span>
<span class="hljs-section">[task1]</span> submit tasks, task1 thread <span class="hljs-attr">id</span> = <span class="hljs-number">111172</span>
<span class="hljs-section">[task2]</span> submit tasks, task2 thread <span class="hljs-attr">id</span> = <span class="hljs-number">125744</span>
<span class="hljs-section">[task3]</span> submit tasks, task3 thread <span class="hljs-attr">id</span> = <span class="hljs-number">111172</span>
<span class="hljs-section">[main]</span> f2 not ready after 50ms (expected timeout)
<span class="hljs-section">[main]</span> results: 1, 2, 3
<span class="hljs-section">[main]</span> done
</code></pre>
<hr/>
<h2 data-id="heading-0">一、我一开始没懂的「进阶线程池结构」到底长啥样？</h2>
<h3 data-id="heading-1">1.1 Day4 的线程池结构（我已经会了）</h3>
<ul>
<li>一个任务队列：<code>queue&lt;function&lt;void()&gt;&gt; tasks_</code></li>
<li>一堆 worker 线程：循环 wait → pop → 执行 <code>fn()</code></li>
<li><code>Enqueue()</code> 往队列里塞 <code>void()</code> 任务</li>
</ul>
<p><strong>问题</strong>：如果任务有返回值（比如 <code>int()</code>），worker 只会执行 <code>void()</code>，返回值怎么传回来？</p>
<h3 data-id="heading-2">1.2 我 Day5 的目标结构（今天才真正理解）</h3>
<p><strong>核心思想</strong>：执行端（worker）不需要理解“返回值”，它只需要执行 <code>void()</code>。<br/>
返回值走另一条通道：<code>future</code>。</p>
<ul>
<li>
<p>队列里仍然只放：<code>std::function&lt;void()&gt;</code></p>
</li>
<li>
<p>但是我可以把一个 <code>int()</code> 任务包装成 <code>void()</code>：</p>
<ul>
<li><code>void()</code> 里执行 <code>packaged_task&lt;int()&gt;</code></li>
<li><code>packaged_task</code> 会把结果写进 <code>future&lt;int&gt;</code> 的共享状态</li>
</ul>
</li>
<li>
<p><code>EnqueueInt()</code> 返回 <code>future&lt;int&gt;</code> 给调用者</p>
</li>
<li>
<p>调用者想什么时候拿结果，就什么时候 <code>get()</code> / <code>wait_for()</code></p>
</li>
</ul>
<p>这就是我今天反复确认的那句话：</p>
<blockquote>
<p><strong>调用者自己决定什么时候 get()（也可以不 get、也可以 wait_for）</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-3">二、我问过的小问题：这里的“调用者”到底指谁？</h2>
<p>我当时有点卡在词上：到底谁是调用者？</p>
<p><strong>结论</strong>：调用者就是“调用 <code>EnqueueInt()</code> 的那个人”。在我的 demo 里就是 <code>main()</code>。</p>
<ul>
<li><code>EnqueueInt()</code> 的职责：提交任务 + 返回 <code>future&lt;int&gt;</code></li>
<li><code>main()</code> 的职责：决定什么时候取结果（<code>get()</code> / <code>wait()</code> / <code>wait_for()</code>）</li>
</ul>
<p>这也解释了我自己的那段理解（后来你也确认了我方向对）：</p>
<blockquote>
<p><code>EnqueueInt()</code> 返回 future；真正的返回值由调用者什么时候 <code>get()</code> 决定。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">三、版本迭代 1：我写出了 EnqueueInt，但出现了两个“理解型坑”</h2>
<p>我当时的雏形是：</p>
<ul>
<li><code>std::packaged_task&lt;int()&gt; pt(task);</code></li>
<li><code>auto fut = pt.get_future();</code></li>
<li>把 <code>pt</code> 放进队列，让 worker 执行</li>
<li>return <code>fut</code></li>
</ul>
<p>这里出现两个关键问题，都是我后来逐步问出来的。</p>
<h3 data-id="heading-5">3.1 我问：为什么 <code>&amp;ThreadPool::Work, this</code> 这么写？我以前不是也能写吗？</h3>
<p>我当时觉得“Work 和构造函数都在一个类里”，为什么还要写得这么麻烦。</p>
<h4 data-id="heading-6">正确理解</h4>
<p><code>Work</code> 是<strong>成员函数</strong>，不是普通函数。成员函数必须依赖对象才能被调用，本质上是：</p>
<ul>
<li>普通函数：<code>Work()</code></li>
<li>成员函数：<code>this-&gt;Work()</code></li>
</ul>
<p>当我用 <code>std::thread</code> 启动线程时，线程入口需要一个“可调用对象”。<br/>
成员函数要成为“可调用”，必须同时提供两样东西：</p>
<ol>
<li>成员函数指针：<code>&amp;ThreadPool::Work</code></li>
<li>对象指针：<code>this</code></li>
</ol>
<p>所以标准写法是：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">workers_.emplace_back(&amp;ThreadPool::Work, <span class="hljs-keyword">this</span>);
</code></pre>
<h4 data-id="heading-7">我追问的“是不是因为函数类型所以要加 &amp;？”</h4>
<p>更准确：不是“因为函数类型”，而是“因为要取成员函数指针”。<br/>
<code>&amp;ThreadPool::Work</code> 表示“指向成员函数 Work 的指针”（pointer-to-member-function）。</p>
<hr/>
<h3 data-id="heading-8">3.2 我问：<code>pt</code> 不是和 <code>fut</code> 绑定吗？<code>pt</code> 是局部变量销毁后，<code>fut</code> 还能有效吗？</h3>
<p>这个问题非常关键，我当时确实没想通。</p>
<h4 data-id="heading-9">正确理解：<code>future</code> 不“绑在 pt 身上”，它们是<strong>共享同一份共享状态</strong></h4>
<ul>
<li><code>packaged_task</code> 内部持有一个“共享状态”（shared state）</li>
<li><code>pt.get_future()</code> 返回的 <code>future</code> 也指向这份共享状态</li>
<li><strong>共享状态才是“结果存放地”</strong></li>
</ul>
<p>所以：</p>
<ul>
<li>
<p><code>pt</code> 是局部变量并不等于 <code>fut</code> 立刻失效</p>
</li>
<li>
<p>但如果 <code>pt</code> 被销毁时共享状态还没被写入结果，那么：</p>
<ul>
<li>要么 <code>future</code> 永远等不到结果（卡住）</li>
<li>要么变成“broken promise”（<code>get()</code> 抛异常）</li>
<li>更糟糕的是：你如果让 worker 执行一个“引用了已销毁 pt 的函数”，会出现悬空引用（UB）</li>
</ul>
</li>
</ul>
<p>所以关键不是“pt 销毁 fut 是否有效”，而是：</p>
<blockquote>
<p><strong>必须保证 worker 最终一定会执行那次 <code>pt()</code>，并且执行时 pt 仍然活着。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-10">四、版本迭代 2：我修到了“能编译”，但又犯了一个很真实的小坑：<code>{ p; }</code> 不等于执行任务</h2>
<p>你那时指出我有一版写成：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[p = std::move(pt)]</span> { <span class="hljs-selector-tag">p</span>; }
</code></pre>
<p>我当时的真实问题就是：我以为“把 p 写在里面就算用了”，结果它根本没执行。</p>
<ul>
<li><code>{ p; }</code>：只是一个无意义表达式</li>
<li>我真正需要的是：<code>p();</code>（调用 packaged_task）</li>
</ul>
<p>而且 <code>packaged_task::operator()</code> 不是 const，所以一般 lambda 要写 <code>mutable</code> 才能调用它。</p>
<p>这个坑我后来自己也认可：它属于“刚学时很容易犯的低级但真实错误”：</p>
<hr/>
<h2 data-id="heading-11">五、版本迭代 3：我把逻辑写对了，但 VS2022 给我一个“类型系统的硬限制”报错（最关键的坑）</h2>
<p>当我终于写成“move 捕获 pt 到 lambda，然后塞进 tasks_”时，我遇到了这个编译错误：</p>
<blockquote>
<p><code>std::function</code> 的 target 必须可拷贝（copy constructible）</p>
</blockquote>
<p>根因是：</p>
<ul>
<li><code>std::packaged_task</code> 是 <strong>move-only</strong></li>
<li>lambda 捕获 move-only 的 pt → lambda 也变成 <strong>move-only</strong></li>
<li>但我的队列类型是 <code>std::function&lt;void()&gt;</code></li>
<li><strong>MSVC 的 <code>std::function</code> 要求可拷贝，不能装 move-only callable</strong></li>
<li>所以 static_assert 直接炸掉</li>
</ul>
<p>这一步我学到一个非常“工程”的点：</p>
<blockquote>
<p><strong>不是我并发逻辑错，是容器/类型擦除工具的约束不允许我这么存。</strong><br/>
在 VS2022 下这是硬限制。</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">六、版本迭代 4（最终跑通）：我用 shared_ptr 让 lambda 可拷贝，成功塞进 <code>std::function&lt;void()&gt;</code></h2>
<p>解决思路很朴素：</p>
<ul>
<li>既然 <code>std::function</code> 要求可拷贝</li>
<li>那我就让 lambda 捕获一个<strong>可拷贝的对象</strong></li>
<li><code>std::shared_ptr</code> 可拷贝</li>
<li>把 <code>packaged_task</code> 放进 <code>shared_ptr</code>，lambda 捕获 <code>shared_ptr</code>，就满足 <code>std::function</code> 的要求了</li>
</ul>
<p>最终我写成了这样（也是我最终版里保留的写法）：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-built_in">std</span>::packaged_task&lt;<span class="hljs-title function_">int</span><span class="hljs-params">()</span>&gt; <span class="hljs-title function_">pt</span><span class="hljs-params">(task)</span>;
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">future</span>&lt;<span class="hljs-type">int</span>&gt; fut = pt.get_future();
<span class="hljs-keyword">auto</span> pt_ptr = <span class="hljs-built_in">std</span>::make_shared&lt;<span class="hljs-built_in">std</span>::packaged_task&lt;<span class="hljs-type">int</span>()&gt;&gt;(<span class="hljs-built_in">std</span>::move(pt));

tasks_.emplace([pt_ptr]() mutable { (*pt_ptr)(); });
<span class="hljs-keyword">return</span> fut;
</code></pre>
<p>到这里，结构完全闭环：</p>
<ul>
<li><code>EnqueueInt</code> 返回 <code>future&lt;int&gt;</code></li>
<li>worker 执行 <code>void()</code> 包装任务</li>
<li>包装任务执行 <code>(*pt_ptr)()</code>，把结果写入 future 的共享状态</li>
</ul>
<hr/>
<h2 data-id="heading-13">七、验证 Demo：我为什么要写这个 demo？它验证了什么？</h2>
<p>我同意你提议“先做验证 demo”，因为它能让我确信这不是“我以为写对了”。</p>
<h3 data-id="heading-14">7.1 我写 demo 的目的（我自己的检查点）</h3>
<ol>
<li>
<p><strong>任务确实跑在 worker 线程，不是在 main 线程同步执行</strong></p>
<ul>
<li>通过打印 <code>std::this_thread::get_id()</code></li>
</ul>
</li>
<li>
<p><strong>future 确实能拿到结果</strong></p>
<ul>
<li><code>get()</code> 返回 1、2、3</li>
</ul>
</li>
<li>
<p><strong>wait_for 能反映“还没完成”这种状态</strong></p>
<ul>
<li>task2 睡 500ms</li>
<li>main 对 fut2 <code>wait_for(50ms)</code> 应该 timeout</li>
</ul>
</li>
</ol>
<p>输出确实符合预期：</p>
<ul>
<li>task thread id ≠ main thread id</li>
<li><code>wait_for(50ms)</code> timeout</li>
<li><code>get()</code> 得到 1,2,3</li>
</ul>
<hr/>
<h2 data-id="heading-15">八、Day5 我学到的所有知识点（这部分我按“复习笔记”来写）</h2>
<h3 data-id="heading-16">8.1 <code>std::packaged_task&lt;R()&gt;</code> 是什么？</h3>
<p>它把“一个可调用对象”包装成“能产生 future 的任务”。</p>
<ul>
<li>
<p><code>packaged_task&lt;int()&gt; pt(task);</code></p>
</li>
<li>
<p><code>future&lt;int&gt; fut = pt.get_future();</code></p>
</li>
<li>
<p>当执行 <code>pt()</code> 时：</p>
<ul>
<li>task 被执行</li>
<li>返回值（或异常）会写进 fut 对应的共享状态</li>
</ul>
</li>
</ul>
<p><strong>关键点</strong>：执行端执行 <code>pt()</code>，调用端持有 <code>fut</code>。</p>
<hr/>
<h3 data-id="heading-17">8.2 <code>std::future</code> 常用方法（面试高频）</h3>
<ul>
<li><code>get()</code>：取结果。若未就绪，会阻塞；只能调用一次（取走结果）</li>
<li><code>wait()</code>：只等待就绪，不取结果</li>
<li><code>wait_for(duration)</code>：等一段时间，返回 <code>future_status</code></li>
<li><code>wait_until(time_point)</code>：等到某个时间点</li>
</ul>
<h4 data-id="heading-18"><code>wait_for</code> 的返回值：<code>std::future_status</code></h4>
<ul>
<li><code>ready</code>：已就绪</li>
<li><code>timeout</code>：超时未就绪</li>
<li><code>deferred</code>：延迟执行（常见于 <code>std::async</code> 的 deferred 策略；线程池一般不会出现）</li>
</ul>
<p>我的 demo 就是在用它观察“50ms 时还没好”。</p>
<hr/>
<h3 data-id="heading-19">8.3 <code>using namespace std::chrono_literals;</code> 是干什么的？</h3>
<p>为了能直接写：</p>
<ul>
<li><code>50ms</code></li>
<li><code>100ms</code></li>
<li><code>2s</code></li>
</ul>
<p>否则要写：</p>
<ul>
<li><code>std::chrono::milliseconds(50)</code></li>
</ul>
<p>所以这句本质上是：<strong>开启 chrono 的字面量后缀</strong>，让 demo 更直观。</p>
<hr/>
<h3 data-id="heading-20">8.4 为什么任务队列里取出任务后要 <code>unlock()</code> 再执行？</h3>
<p>在 worker 里我写的是：</p>
<pre><code class="hljs language-php" lang="php">std::<span class="hljs-variable constant_">function</span>&lt;<span class="hljs-keyword">void</span>()&gt; <span class="hljs-function"><span class="hljs-keyword">fn</span> = <span class="hljs-title">std</span>::<span class="hljs-title">move</span>(<span class="hljs-params">tasks_.front(<span class="hljs-params"/>)</span>)</span>;
tasks_.<span class="hljs-title function_ invoke__">pop</span>();
lock.<span class="hljs-title function_ invoke__">unlock</span>();
<span class="hljs-function"><span class="hljs-keyword">fn</span>(<span class="hljs-params"/>)</span>;
</code></pre>
<p>原因是：锁应该只保护“队列结构”，不应该包住“任务执行”。</p>
<ul>
<li>
<p>如果执行任务时还持锁：</p>
<ul>
<li>其它线程无法入队</li>
<li>其它 worker 也抢不到锁取任务</li>
<li>线程池会退化得很严重</li>
</ul>
</li>
</ul>
<p>这是线程池题里非常关键的工程点：<strong>锁粒度必须小</strong>。</p>
<hr/>
<h3 data-id="heading-21">8.5 <code>std::function</code> 在 VS2022 下的限制：必须可拷贝</h3>
<p>这是 Day5 最大坑：<br/>
<strong>lambda 捕获了 move-only（比如 packaged_task）→ lambda move-only → std::function 装不下</strong>。</p>
<p>解决办法（我最终用的）：</p>
<ul>
<li>用 <code>shared_ptr</code> 让捕获对象可拷贝</li>
<li>使 lambda 可拷贝</li>
<li>使 <code>std::function&lt;void()&gt;</code> 能存</li>
</ul>
<hr/>
<h2 data-id="heading-22">九、我最终跑通的版本</h2>
<p>下面是我 Day5 最终版。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;future&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPool</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">ThreadPool</span><span class="hljs-params">(<span class="hljs-type">size_t</span> thread_count)</span></span>;
    ~<span class="hljs-built_in">ThreadPool</span>();

    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Enqueue</span><span class="hljs-params">(std::function&lt;<span class="hljs-type">void</span>()&gt; task)</span></span>;
    <span class="hljs-function">std::future&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">EnqueueInt</span><span class="hljs-params">(std::function&lt;<span class="hljs-type">int</span>()&gt; task)</span></span>;

<span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Work</span><span class="hljs-params">()</span></span>;

    std::vector&lt;std::thread&gt; workers_;
    std::queue&lt;std::function&lt;<span class="hljs-type">void</span>()&gt;&gt; tasks_;
    std::mutex mtx_;
    std::condition_variable cv_;
    <span class="hljs-type">bool</span> stop_ = <span class="hljs-literal">false</span>;
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ThreadPool::Work</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx_)</span></span>;
        cv_.<span class="hljs-built_in">wait</span>(lock, [<span class="hljs-keyword">this</span>] { <span class="hljs-keyword">return</span> !tasks_.<span class="hljs-built_in">empty</span>() || stop_; });
        <span class="hljs-keyword">if</span> (stop_ &amp;&amp; tasks_.<span class="hljs-built_in">empty</span>()) <span class="hljs-keyword">break</span>;

        std::function&lt;<span class="hljs-type">void</span>()&gt; fn = std::<span class="hljs-built_in">move</span>(tasks_.<span class="hljs-built_in">front</span>());
        tasks_.<span class="hljs-built_in">pop</span>();

        lock.<span class="hljs-built_in">unlock</span>();
        <span class="hljs-built_in">fn</span>();
    }
}

ThreadPool::<span class="hljs-built_in">ThreadPool</span>(<span class="hljs-type">size_t</span> thread_count) {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(thread_count); ++i) {
        workers_.<span class="hljs-built_in">emplace_back</span>(&amp;ThreadPool::Work, <span class="hljs-keyword">this</span>);
    }
}

ThreadPool::~<span class="hljs-built_in">ThreadPool</span>() {
    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx_)</span></span>;
    stop_ = <span class="hljs-literal">true</span>;
    lock.<span class="hljs-built_in">unlock</span>();

    cv_.<span class="hljs-built_in">notify_all</span>();

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; t : workers_) {
        t.<span class="hljs-built_in">join</span>();
    }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ThreadPool::Enqueue</span><span class="hljs-params">(std::function&lt;<span class="hljs-type">void</span>()&gt; task)</span> </span>{
    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx_)</span></span>;
    <span class="hljs-built_in">assert</span>(!stop_ &amp;&amp; <span class="hljs-string">"ThreadPool stopped"</span>);
    tasks_.<span class="hljs-built_in">push</span>(std::<span class="hljs-built_in">move</span>(task));
    lock.<span class="hljs-built_in">unlock</span>();
    cv_.<span class="hljs-built_in">notify_one</span>();
}

<span class="hljs-function">std::future&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">ThreadPool::EnqueueInt</span><span class="hljs-params">(std::function&lt;<span class="hljs-type">int</span>()&gt; task)</span> </span>{
    <span class="hljs-function">std::packaged_task&lt;<span class="hljs-title">int</span><span class="hljs-params">()</span>&gt; <span class="hljs-title">pt</span><span class="hljs-params">(task)</span></span>;
    std::future&lt;<span class="hljs-type">int</span>&gt; fut = pt.<span class="hljs-built_in">get_future</span>();
    <span class="hljs-keyword">auto</span> pt_ptr = std::make_shared&lt;std::packaged_task&lt;<span class="hljs-built_in">int</span>()&gt;&gt;(std::<span class="hljs-built_in">move</span>(pt));

    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx_)</span></span>;
    <span class="hljs-built_in">assert</span>(!stop_ &amp;&amp; <span class="hljs-string">"ThreadPool stopped"</span>);
    tasks_.<span class="hljs-built_in">emplace</span>([pt_ptr]() <span class="hljs-keyword">mutable</span> { (*pt_ptr)(); });
    lock.<span class="hljs-built_in">unlock</span>();

    cv_.<span class="hljs-built_in">notify_one</span>();
    <span class="hljs-keyword">return</span> fut;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std::chrono_literals;

    <span class="hljs-function">ThreadPool <span class="hljs-title">pool</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span></span>;

    std::cout &lt;&lt; <span class="hljs-string">"[main] submit tasks, main thread id = "</span>
              &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; std::endl;

    <span class="hljs-keyword">auto</span> fut1 = pool.<span class="hljs-built_in">EnqueueInt</span>([] {
        std::cout &lt;&lt; <span class="hljs-string">"[task1] submit tasks, task1 thread id = "</span>
                  &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; std::endl;
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    });

    <span class="hljs-keyword">auto</span> fut2 = pool.<span class="hljs-built_in">EnqueueInt</span>([] {
        std::cout &lt;&lt; <span class="hljs-string">"[task2] submit tasks, task2 thread id = "</span>
                  &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; std::endl;
        std::this_thread::<span class="hljs-built_in">sleep_for</span>(<span class="hljs-number">500</span>ms);
        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;
    });

    <span class="hljs-keyword">auto</span> fut3 = pool.<span class="hljs-built_in">EnqueueInt</span>([] {
        std::cout &lt;&lt; <span class="hljs-string">"[task3] submit tasks, task3 thread id = "</span>
                  &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; std::endl;
        std::this_thread::<span class="hljs-built_in">sleep_for</span>(<span class="hljs-number">100</span>ms);
        <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;
    });

    <span class="hljs-keyword">auto</span> st = fut2.<span class="hljs-built_in">wait_for</span>(<span class="hljs-number">50</span>ms);
    <span class="hljs-keyword">if</span> (st == std::future_status::ready) {
        std::cout &lt;&lt; <span class="hljs-string">"[main] f2 is ready (unexpected)\n"</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (st == std::future_status::timeout) {
        std::cout &lt;&lt; <span class="hljs-string">"[main] f2 not ready after 50ms (expected timeout)\n"</span>;
    } <span class="hljs-keyword">else</span> {
        std::cout &lt;&lt; <span class="hljs-string">"[main] f2 deferred (usually not in thread pool)\n"</span>;
    }

    <span class="hljs-type">int</span> r1 = fut1.<span class="hljs-built_in">get</span>();
    <span class="hljs-type">int</span> r2 = fut2.<span class="hljs-built_in">get</span>();
    <span class="hljs-type">int</span> r3 = fut3.<span class="hljs-built_in">get</span>();

    std::cout &lt;&lt; <span class="hljs-string">"[main] results: "</span> &lt;&lt; r1 &lt;&lt; <span class="hljs-string">", "</span> &lt;&lt; r2 &lt;&lt; <span class="hljs-string">", "</span> &lt;&lt; r3 &lt;&lt; <span class="hljs-string">"\n"</span>;
    std::cout &lt;&lt; <span class="hljs-string">"[main] done\n"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-23">十、Day5 小结：我今天真正“从零到有”学会了什么？</h2>
<p>今天我觉得我学到的不是“会写 EnqueueInt”，而是三件更重要的事：</p>
<ol>
<li>
<p><strong>线程池的执行端只做一件事：执行 <code>void()</code> 任务</strong><br/>
返回值不靠 return，靠 future 的共享状态通道。</p>
</li>
<li>
<p><strong>future/packaged_task 的责任边界非常清楚</strong></p>
<ul>
<li>packaged_task：负责把结果写进去</li>
<li>future：负责让调用者在合适的时间取出来</li>
</ul>
</li>
<li>
<p><strong>工程实现会遇到库约束（VS2022 + std::function）</strong><br/>
move-only callable 不能进 std::function → 用 shared_ptr 让它可拷贝，这是面试时也能讲清楚的“工程点”。</p>
</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C语言实战：手搓高并发异步日志库（基于 Ring Buffer + 生产者消费者模型）]]></title>    <link>https://juejin.cn/post/7582785032852078655</link>    <guid>https://juejin.cn/post/7582785032852078655</guid>    <pubDate>2025-12-12T12:36:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582785032852078655" data-draft-id="7582637280218791990" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C语言实战：手搓高并发异步日志库（基于 Ring Buffer + 生产者消费者模型）"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2025-12-12T12:36:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xlp666hub"/> <meta itemprop="url" content="https://juejin.cn/user/2965810860569131"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C语言实战：手搓高并发异步日志库（基于 Ring Buffer + 生产者消费者模型）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2965810860569131/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xlp666hub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T12:36:28.000Z" title="Fri Dec 12 2025 12:36:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读32分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>C语言实战：手搓高并发异步日志库（基于 Ring Buffer + 生产者消费者模型）</strong></h2>
<h2 data-id="heading-1">1. 为什么 <code>printf</code> 不够用？</h2>
<p>在实际项目中，尤其是嵌入式设备、实时系统或高并发服务端程序里，很多人一开始都习惯直接用 printf、fprintf 或 write 把日志打到串口、文件、Flash。这种做法在demo阶段没什么问题，但一旦上了生产环境才发现这玩意儿是个隐形的性能杀手。</p>
<p>我下面列举一下常见的几个<strong>致命问题</strong>（本人也不幸踩到过）：</p>
<ol>
<li>
<p>同步阻塞：像<code>write</code>这样的底层接口是阻塞的，而磁盘 / Flash / 串口通常是比较慢的（Flash 擦除甚至能到几百毫秒），业务线程就只能干等着。</p>
<p>我之前写了个demo实测了一下，直接写入 2000 条日志耗时 <strong>7秒</strong>，而使用异步日志仅需 <strong>0.02秒</strong>，性能差距达 <strong>300倍</strong>。</p>
</li>
<li>
<p>线程中断问题：多任务或中断里同时 printf，没有锁的话日志立刻花屏（A线程打印一半，B线程插进来了），导致日志没法看，而加锁又会带来新的性能和死锁风险。</p>
</li>
<li>
<p>缓存刷新策略失控：<code>printf</code> 默认<strong>行缓存</strong>（遇到 \n 或缓冲区满才刷），在嵌入式里经常忘记 <code>fflush</code>，在嵌入式系统崩溃或断电的瞬间，缓冲区里重要的数据往往还没来得及刷入磁盘就丢失了<strong>导致日志丢失</strong>都不知道。</p>
</li>
<li>
<p>CPU 占用率爆炸：高频率打日志时，CPU 大部分时间都在等 I/O，而不是干正事。</p>
</li>
</ol>
<p>那么正确的操作应该是怎样的呢？</p>
<p>我们要把记录日志和写入磁盘彻底解耦。<strong>业务线程</strong>只负责把日志扔进一个内存缓冲区（大概几微秒），然后立刻返回继续干活。 由一个独立的<strong>后台线程</strong>慢慢把缓冲区内容刷到磁盘/Flash/串口去。这就是经典的 “ 生产者消费者模型 ” 和环形缓冲区的组合。这也是很多工业级日志库的底层原理。</p>
<h2 data-id="heading-2">2. 生产者-消费者模型</h2>
<p>为了解决上面提到的同步阻塞问题，我们不能让业务线程直接去“碰”磁盘。我们需要引入一个中间层，将<strong>产生日志</strong>和<strong>写入磁盘</strong>这两个动作彻底剥离。这正是计算机科学中经典的<strong>生产者-消费者模型</strong>的最佳应用场景。</p>
<h3 data-id="heading-3">2.1 系统架构</h3>
<p>下面要介绍的这个架构也就是<strong>生产者-消费者模型</strong>这个名字的由来。</p>
<p>我们可以把整个日志系统看成一个繁忙的餐厅的厨房。可能有人会想“那生产者就是厨师，消费者就是顾客呗”，我认为这个想法既合理又不合理，合理是因为这个想法是符合我们的常识的，不合理是因为在日志系统这个环境下，是有特殊情况存在的，后面会解释。在这里，其实生产者相当于服务员，消费者相当于厨师，而他们之间有一个窗口，就是缓冲区（放菜单）。所以整个过程其实就是服务员去给大量的客人点菜，然后把菜单放在窗口，厨师从窗口拿菜单，然后做饭，做饭可以类比为写磁盘。到这里就结束，至少在生产者-消费者模型下，这个场景已经很完善了。所以前面那个把顾客当成消费者的想法有点不太合适，如果这样理解就相当于一个顾客坐那一直吃吃吃......（胃口大的话其实也不是不行🌞）</p>
<p>可能有的朋友还是觉得不够形象，下面我放一张图大家可以参考一下：（纯手画的，感觉画的不错的朋友点赞加关注，不想的话就算了😊）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45bdb3055f634675a5cb1fde633fd717~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766147788&amp;x-signature=%2Fs%2Bt7FNsPqgKPmUkHdLOFhFg%2Bys%3D" alt="生产者消费者模型系统架构图.png.png" loading="lazy"/></p>
<p>可能有细心的朋友注意到了，我在图片中生产者用的Producers，而消费者却用的Consumer，他们一个是复数，一个是单数，意思是有多个生产者而只有一个消费者吗？答案是肯定的。这个模型的名称是<strong>MPSC (Multi-Producer Single-Consumer) ，这是高性能日志系统的标准架构。</strong></p>
<p>为什么消费者只有一个呢？多个消费者会怎么样呢？</p>
<ol start="0">
<li>日志文件通常是一个文本文件（log.txt）。如果你搞了 5 个消费者线程同时往一个文件里写，你需要加很重的锁来防止数据错乱（比如线程 A 写了一半“Error...”，线程 B 插进来写了“Warning...”）。既然最终都要<strong>加锁排队写文件</strong>，那多搞几个消费者线程不仅没变快，反而增加了<strong>上下文切换的开销</strong>，还不如就一个线程专门排队写。</li>
<li>对于机械硬盘或嵌入式 Flash，<strong>顺序写入</strong>是最快的。如果有多个消费者并发写，磁头（或 Flash 主控）可能需要跳来跳去，性能反而会下降。</li>
<li>一个消费者线程维护一个文件句柄，逻辑清晰，不容易出 Bug。</li>
</ol>
<p>因此，对于日志落盘这种<strong>I/O密集型</strong>的任务，单消费者是最高效的选择。</p>
<p>还有的朋友可能会问，你第一章明明写了异步日志快，同步阻塞是致命问题，怎么上面的架构图又说实现了线程同步呢？这不是左脑攻击右脑吗？啊，这里确实比较绕，我有时也得想好久才能想通。下面我们详细拆解一下：</p>
<ol start="0">
<li>
<p>在宏观层面：业务流程是异步的</p>
<p>这里的异步描述的是生产者和消费者之间的协作关系。</p>
<p>同步日志（存在缺陷）：业务线程说：“我要写日志”，然后就在那<strong>死等</strong>，直到磁盘写完才走。这叫“同步阻塞”。</p>
<p>异步日志：业务线程说：“我要写日志”，把数据扔进缓冲区，<strong>转身就走</strong>，去干别的事了。写磁盘的事留给后台慢慢做。这叫“异步非阻塞”。</p>
<p>因为业务线程不需要等 I/O，所以我们称之为<strong>异步日志系统</strong>。这是性能大幅度提升的原因。</p>
</li>
<li>
<p>在微观层面：内存访问是需要同步的</p>
<p>这里的同步描述的是两个线程同时访问同一块内存时的安全规则。</p>
<p>如果业务线程正在往 <code>Buffer[0]</code> 写数据，还没写完，后台线程突然跑过来要把 <code>Buffer[5]</code> 读走。这就乱套了。</p>
<p>我们需要一种机制，让他们协调一下：“我要写了，你先别动”（互斥锁），“我写完了，该你读了”（条件变量）。</p>
<p>这种为了保证数据安全、不打架的协调机制，在操作系统里叫<strong>线程同步</strong>。</p>
</li>
</ol>
<p>举一个生活中的例子来比喻一下：</p>
<p>我们把业务线程看作服务员，把<code>Ring buffer</code>看作窗口的菜单钉（固定菜单），把日志线程看作厨师。这里先简单提一下，为什么把<code>Ring Buffer</code>看作菜单钉，因为我们的环形缓冲区<code>Ring Buffer</code>正是一个<code>malloc</code>得来的巨大数组，这个数组<strong>大小是固定的</strong>，正如菜单钉只有一个，菜单只能按顺序一个一个插，能插的菜单数量也是有限的，这个后面还会详细介绍，先回归主题。</p>
<p>在这个场景下理解就容易多了。</p>
<p>异步：服务员写好菜单，往吧台上一插，转身就去招呼下一桌客人了 <strong>（异步）</strong> ，他不需要站在厨房门口等着厨师把菜炒好（同步）。这就是效率高的原因。</p>
<p>线程同步：吧台只有一个，菜单钉只有一个。如果服务员正在往上插菜单，厨师正好伸手去拔菜单，两人的手就会撞在一起（疼）。所以我们需要一个规则（互斥锁）：<strong>当一个人手在接触菜单钉时，另一个人必须在旁边等着。</strong> 这就是<strong>线程同步</strong>，并不是说我们要一起动作，而是我们要<strong>协调好顺序，不要打架</strong>。</p>
<h3 data-id="heading-4">2.2 核心角色定义</h3>
<p>在这个模型中，每个角色都有自己的职责：</p>
<ol start="0">
<li>
<p>生产者：</p>
<p>系统中的业务逻辑线程（如传感器信息采集），它调用 <code>log_push</code> 接口，将格式化好的日志字符串<strong>写入缓冲区</strong>。如果缓冲区没满，写入动作几乎是瞬时的，如果满了，可以选择丢弃或短暂等待（这取决于策略）。</p>
</li>
<li>
<p>环形缓冲区：</p>
<p>一段固定大小的内存空间。作为“蓄水池”，平滑业务线程的流量波峰。使用数组模拟环形队列，避免频繁的内存申请与释放。</p>
</li>
<li>
<p>消费者：</p>
<p>一个独立的后台守护线程。死循环检查缓冲区。有数据就取出，写入文件 <code>write</code>，没数据就挂起 <code>wait</code>，节省 CPU 资源。虽然它写磁盘慢，但它一直在后台默默工作，<strong>不影响前台业务</strong>。</p>
</li>
</ol>
<h3 data-id="heading-5">2.3 为什么这样设计？</h3>
<p>解耦：这样设计可以<strong>让业务逻辑不再依赖磁盘 I/O 的速度</strong>。哪怕磁盘突然卡顿了 1 秒，业务线程依然可以流畅运行，只要缓冲区没满。</p>
<p>削峰填谷：在某一瞬间，日志量可能<strong>瞬间爆发</strong>。缓冲区可以<strong>暂时兜住</strong>这些数据，后台线程再慢慢消化。如果没有缓冲区，这种瞬间的大量 I/O 请求可能会直接把系统拖垮。</p>
<p>批量写入：这里要先提一嘴，本项目演示的是基础异步写入，没有采用批量写入。如果在生产环境中配合<strong>批量写入</strong>（攒够 4KB 再落盘），性能还能进一步压榨，这也是 300 倍差距的来源之一。感兴趣的朋友可以自己实现一下批量写入，看看性能差距相比每条日志写一次有多大。在进阶优化中，消费者可以<strong>一次积攒 4KB 数据再一次性写入磁盘</strong>，进一步减少系统调用次数，延长 Flash 寿命。</p>
<h2 data-id="heading-6">3. 数据结构选型：为何抛弃链表？</h2>
<p>在设计日志缓冲区的存储结构时，有两种数据结构可以供我们挑选：</p>
<ol start="0">
<li>链表：动态增长，理论上无限大。</li>
<li>环形缓冲区：基于定长数组，循环使用。</li>
</ol>
<p>初学者往往<strong>喜欢用链表</strong>，因为简单且不需要考虑内存占满的情况。但在<strong>高性能、高并发、长期运行</strong>的嵌入式/服务端场景下，链表有着致命的缺陷。</p>
<h3 data-id="heading-7">3.1 链表的三大缺陷</h3>
<p>日志系统一般是要长期运行的，采用链表的日志系统在压测和长期运行下通常会暴露下面几个问题：</p>
<h4 data-id="heading-8">3.1.1 内存碎片化</h4>
<p>每当有新日志产生，都需要调用 <code>malloc</code> 分配一个小节点，消费后调用 free释放内存。但在高频日志场景下（如每秒 1000 次），频繁的申请释放会将<strong>堆内存碎片化</strong>。在嵌入式设备长期运行的条件下（7x24小时），极易导致 <strong>OOM (Out Of Memory)</strong> ，即使剩余总内存足够，却申请不到连续的大块内存。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42b3db74a455461f8156b444220e271e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766147788&amp;x-signature=LPRsoj83ibKJ4lrLyNu%2FMqrMRzs%3D" alt="瑞士奶酪.png" loading="lazy"/></p>
<p>这张图片应该是比较形象的，大家看到这张图片应该能够明白内存碎片化大概是什么意思了。</p>
<h4 data-id="heading-9">3.1.2 内存分配的性能开销</h4>
<p><code>malloc</code> 和 <code>free</code> 并不是简单的 C 语句，它们是<strong>系统库函数</strong>。它们内部维护着复杂的内存链表，并且为了<strong>线程安全</strong>，malloc 内部通常也有<strong>锁</strong>。</p>
<p>并且在内存碎片化后，<code>malloc</code>调用产生的<strong>开销会越来越大</strong>，因为内存上的孔洞越来越多，这使得寻找一块合适大小的内存越来越困难。高频调用 <code>malloc</code> 本身就会消耗大量的 CPU 时间，这已经违背了我们极速写入的初衷。</p>
<h4 data-id="heading-10">3.1.3 CPU 缓存对链表不友好</h4>
<p>有朋友就想问了：“为什么CPU缓存对链表不友好呢？难道它对数组就很友好吗？”。是的，他对数组确实友好，但这并不是它歧视链表，而是由CPU本身的特性决定的。</p>
<p>众所周知，数组的内存是连续的，而链表的节点在堆内存中分散分布着，遍历链表需要随机跳跃访问内存，导致 <strong>Cache Miss（缓存未命中）</strong> 率极高，严重拖慢 CPU 效率。</p>
<p>并且CPU读取内存时，会利用 <strong>空间局部性</strong> 将相邻的数据预取到 <strong>L1/L2 Cache</strong> 中，因此数组就占据了天然的优势。</p>
<p>这里有必要拓展一下 <strong>Cache Miss</strong> ，用一句通俗点的话来讲：现代 CPU 性能的极大程度上取决于数据离核心有多近，而 <strong>Cache Miss</strong> 正是由于要访问的数据太远所导致的。</p>
<p>下面要聊的是计算机体系结构中比较经典的内容，可能会比较枯燥，但我会尽力把它描述的形象一点：</p>
<h5 data-id="heading-11">3.1.3.1 Cache的层级结构</h5>
<p>通常我们说L1，L2，L3三层缓存。</p>
<p><strong>L1 Cache（一级缓存）</strong> ：离 CPU 核心最近，就在核心内部。速度最快，但内存最小，大小为32或64KB，速度约<strong>1纳秒</strong>。</p>
<p><strong>L2 Cache（二级缓存）</strong> ：稍微远一点，<strong>通常</strong>也是每个核心独享。比 L1 慢一点，但内存更大，256KB 或 512KB。速度约 <strong>3-10 纳秒</strong>。</p>
<p><strong>L3 Cache（三级缓存）</strong> ：所有 CPU 核心<strong>共享</strong>的。更大，但更慢，几 MB 到几十 MB，速度约 <strong>10-20 纳秒</strong>。</p>
<p><strong>内存</strong>：主板上的内存条。巨大但极慢，速度约 <strong>60-100 纳秒</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fac7d7927354f9395727ac8483640c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766147788&amp;x-signature=XoES%2BtXzfjuhuFYRxitnylI6ITE%3D" alt="三层缓存.png" loading="lazy"/></p>
<p>这张图是我电脑的配置，可以看到它是16核的。L1缓存为1MB，平摊到每个核上面就是64KB/核。L2缓存平摊到每个核上面是1MB/核。L3缓存的64MB是所有16个核心共享的。</p>
<p>这个配置看起来比上面介绍的参数要大一点（实际上大差不差），但是做嵌入式开发时，面对的板子可能根本就没有L2和L3缓存。<strong>Cache Miss</strong> 的代价会直接反应在设备卡顿上。</p>
<h5 data-id="heading-12">3.1.3.2 什么是 Cache Miss</h5>
<p>先介绍一下什么是 <strong>Cache Line（缓存行）</strong> ，如果CPU要访问一个字节，系统不会只给它这一个字节，而是把这个字节所在的 <strong>Cache Line</strong> 全部给它，这个 <strong>Cache Line</strong> 通常是<strong>64字节</strong>。这意味着，当读取内存地址 0x1000 时，CPU 会自动把 0x1000 到 0x103F 的 64 字节全部加载到 Cache 中。</p>
<p><strong>每一次查找失败，都叫一次 Miss。</strong></p>
<p>当CPU要读取一个变量时，它会先查L1，如果L1命中就直接使用，耗时1ns。如果L1未命中就查L2。</p>
<p>如果L2命中，把数据搬到L1再给CPU，耗时5ns。如果L2未命中就查L3。</p>
<p>如果L3命中，把数据搬到L2，再搬到L1再给CPU，耗时15ns。如果L3也查不到，那就悲剧了。</p>
<p>此时，CPU只能挂起等待，让内存控制器去RAM里面找这一等可能就是上百纳秒。对于 2GHz 的 CPU 来说，100ns 意味着它可以空转 <strong>200 个周期</strong>。这段时间 CPU 什么都干不了，纯浪费。</p>
<p>对于数组：数组在内存里是<strong>连续存放</strong>的。当CPU要访问<strong>数组第一个元素</strong>，大概率是不在三层缓存的，他可能要等很久数据才能被拿过来，速度当然就比较慢了，这叫 <strong>Cache Miss</strong> 。但它拿回来的是数组第一个元素所在的 <strong>Cache Line</strong> ，共64个字节。当他处理完第一个元素，要处理第二个时，哎，它发现第二个元素就在他手边，它可以很快的处理完第二个元素，这叫 <strong>Cache Hit（缓存命中）</strong> 。并且后面它要处理的元素可能全都在它手边，也就是说后面可能全部 <strong>Cache Hit</strong> ，这样效率是极高的。</p>
<p>对于链表：链表的结点是<code>malloc</code>出来的，在堆内存里面的分布是没有规矩可言的。这时CPU要访问每一个结点，而这些结点存在于三层缓存的概率很小，并且链表没有像数组那样，一次访问慢但对后面多次访问效率提升具有促进作用的机制。因此，如果使用链表，<strong>Cache Miss</strong> 的概率极高。</p>
<h5 data-id="heading-13">3.1.3.3 一点小补充</h5>
<p>在高端嵌入式 SoC（如树莓派、手机 Cortex-A）中，通常有 L1/L2/L3 三级缓存。但在低端单片机（如 STM32 Cortex-M3/M4）中，通常<strong>没有 Cache</strong> 或者只有简单的 <strong>指令/数据缓存</strong>。 尽管如此，<strong>RAM 的突发读取（Burst Read）</strong> 特性依然使得顺序访问（数组）比随机访问（链表）快得多。</p>
<p>现代 RAM 的 Burst Read 特性让顺序读写 64 字节和随机读 1 字节的硬件成本几乎一样。 配合 CPU 硬件预取器和多级缓存，真正连续、64 字节对齐的顺序访问（Ring Buffer）可以比随机跳跃的链表快 10～50 倍，而且这不是软件优化，是物理底层的硬加速，没得选。</p>
<p>所以： <strong>Ring Buffer 快不是因为代码写得好，而是因为它吃到了 CPU + Cache + DRAM 三者联合的红利</strong>。 链表再优雅，也打不过物理定律。</p>
<h3 data-id="heading-14">3.2 环形缓冲区设计原理</h3>
<p>环形缓冲区本质上是一个<strong>固定大小的数组</strong>，通过维护 <code>head</code>（读指针）和 <code>tail</code>（写指针）两个索引，和<strong>取模运算</strong>来实现首尾相接的循环的效果。</p>
<p>下面介绍一下实现的核心逻辑：</p>
<ol start="0">
<li>
<p>初始化：申请一块大内存（例如 1MB），这显然不会造成内存碎片化。给 <code>head</code> 和 <code>tail</code> 赋0 。</p>
</li>
<li>
<p>写入 (Push)：数据存入 <code>buffer[tail]</code>，然后 <code>tail</code> 向后移动。</p>
<p>然后 <code>tail = (tail + 1) % capacity</code></p>
</li>
<li>
<p>读取 (Pop)：从 <code>buffer[head]</code> 取出数据，然后 <code>head</code> 向后移动。</p>
<p>然后 <code>head = (head + 1) % capacity</code></p>
</li>
<li>
<p>判断是否空或者满：通过一个 <code>count</code> 计数器，或者通过 <code>head</code> 和 <code>tail</code> 的相对位置来判断。</p>
</li>
</ol>
<p>在本项目中，为了简化多线程下的状态判断，我引入了一个<code>count</code>计数器配合互斥锁来精确控制。</p>
<p>小知识：在极度追求性能的场景下（如 Linux 内核 kfifo），通常会将缓冲区大小设置为 <strong>2 的幂次方</strong>（如 1024, 4096）。这样可以用 <strong>位运算 (&amp;)</strong> 代替 <strong>取模运算 (%)</strong> ：</p>
<p>取模：<code>tail = (tail + 1) % 1024</code></p>
<p>对应的位运算：<code>tail = (tail + 1) &amp; (1024 - 1)</code></p>
<h3 data-id="heading-15">3.3 核心数据结构定义</h3>
<p>为了实现通用性与封装性，我定义了下面结构体：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 单条日志的最大长度</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_MSG_SIZE 128</span>
​
<span class="hljs-comment">// 日志</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> {
    <span class="hljs-type">char</span> data[LOG_MSG_SIZE];
} Log;
​
<span class="hljs-comment">// 环形缓冲区管理</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> {
    Log *entries;         <span class="hljs-comment">// 指向 malloc 的大数组</span>
    
    <span class="hljs-type">int</span> capacity;         <span class="hljs-comment">// 缓冲区总容量</span>
    <span class="hljs-type">int</span> count;            <span class="hljs-comment">// 当前已存储的日志数量</span>
    
    <span class="hljs-type">int</span> head;             <span class="hljs-comment">// 读索引 (Consumer 用)</span>
    <span class="hljs-type">int</span> tail;             <span class="hljs-comment">// 写索引 (Producer 用)</span>
    
    <span class="hljs-comment">// 用于优雅退出</span>
    <span class="hljs-type">int</span> is_running;       <span class="hljs-comment">// 1: 正常运行   0: 停止</span>
​
    <span class="hljs-comment">// 线程同步工具</span>
    <span class="hljs-type">pthread_mutex_t</span> mutex;
    <span class="hljs-type">pthread_cond_t</span> cond_producer; <span class="hljs-comment">// 若缓冲区满  生产者睡觉</span>
    <span class="hljs-type">pthread_cond_t</span> cond_consumer; <span class="hljs-comment">// 若缓冲区空  消费者睡觉</span>
    
    <span class="hljs-comment">//存放日志内容的文件的文件描述符</span>
    <span class="hljs-type">int</span> file_fd;
} RingBuffer;
</code></pre>
<p>这种设计即保证了<strong>内存的连续性</strong>，又通过互斥锁和条件变量保证了<strong>线程安全</strong>。在程序启动时 <code>rb_init</code> 一次性分配内存，运行过程中再无内存申请操作，极其稳定。</p>
<p>这里的文件描述符需要再提一嘴，初始化的时候我会把它置为1，代表<code>stdout</code>，也就是说默认的日志输出位置是终端。后面如果要打开文件时那就给他再次赋值。如果只是用来测试，查看终端内容，因而不进行对文件描述符重新赋值的操作，那就要在<code>close</code>之前进行判断，如果文件描述符的值为1，就不进行<code>close</code>操作。但是为了保险起见，我建议不论会不会对文件描述符重新赋值，在关闭文件描述符之前都检查一下它的值。</p>
<h2 data-id="heading-16">4. 核心代码实现</h2>
<p>为了保证代码的<strong>健壮性</strong>与<strong>可维护性</strong>，我将核心逻辑封装在 ring_buffer.c 中，对外提供简洁的 API。以下是几个最关键的实现细节。</p>
<h3 data-id="heading-17">4.1 初始化 —— 一切的起点</h3>
<p>在初始化阶段，我们需要申请内存池，并初始化所有的同步工具（锁与条件变量）。这里有一个设计细节，也就是上文提到的：我们将 <code>file_fd</code> 默认初始化为 <code>STDOUT_FILENO</code> (1)，这意味着默认情况下日志会输出到终端，方便调试。</p>
<pre><code class="hljs language-ini" lang="ini">void rb_init(RingBuffer *rb, int capacity) {
    //一次性申请堆内存
    rb-&gt;<span class="hljs-attr">entries</span> = (Log *)malloc(sizeof(Log) * capacity)<span class="hljs-comment">;</span>
    if (rb-&gt;<span class="hljs-attr">entries</span> == NULL) {
        perror("malloc failed")<span class="hljs-comment">;</span>
        exit(1)<span class="hljs-comment">;</span>
    }
​
    //初始化状态
    rb-&gt;<span class="hljs-attr">capacity</span> = capacity<span class="hljs-comment">;</span>
    rb-&gt;<span class="hljs-attr">head</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    rb-&gt;<span class="hljs-attr">tail</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    rb-&gt;<span class="hljs-attr">count</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    rb-&gt;<span class="hljs-attr">is_running</span> = <span class="hljs-number">1</span><span class="hljs-comment">; //标记系统运行中</span>
​
    //默认输出到终端
    rb-&gt;<span class="hljs-attr">file_fd</span> = STDOUT_FILE<span class="hljs-literal">NO</span><span class="hljs-comment">;</span>
​
    //初始化互斥锁和条件变量
    pthread_mutex_init(&amp;(rb-&gt;mutex), NULL)<span class="hljs-comment">;</span>
    pthread_cond_init(&amp;(rb-&gt;cond_producer), NULL)<span class="hljs-comment">;</span>
    pthread_cond_init(&amp;(rb-&gt;cond_consumer), NULL)<span class="hljs-comment">;</span>
}
</code></pre>
<p>这个初始化函数的内存分配正是结合了我们前面一次性申请一大块连续内存的思路，在加快访问速度的基础上还一定程度上保护了Flash。</p>
<p>默认情况下<code>is_running</code>是为1的，从这个成员的名字很容易就能看出它为1是是正常工作的。后面在<code>main</code>函数成功回收全部生产者时将这个值置为0，在消费者中检测这个值为0后执行相应的退出程序，<strong>防止生产者已经全部退出了消费者还在苦苦等待</strong>日志作无用功这种情况发生。</p>
<p>日志内容的默认输出位置就没必要再讲了，这里只是用宏代替了1，直接用1也是可以的，除了<strong>可读性下降</strong>没有什么坏处。</p>
<p>最后就是初始化锁和条件变量了，这里我设计了两个条件变量，从名字来看一个是属于生产者的，另一个是属于消费者的。若缓冲区为空，则消费者睡觉，直到生产者生产出日志内容，会用 <code>cond_consumer</code> 来叫醒消费者。若缓冲区已满，则生产者睡觉，当消费者消费日志内容使得缓冲区空间空出来时，他会使用 <code>cond_producer</code> 叫醒生产者。这在后面的具体代码实现中会直观的看到。</p>
<h3 data-id="heading-18">4.2 生产者 (<code>Push</code>)拒绝虚假唤醒</h3>
<p>这是<strong>高并发写</strong>的核心逻辑。为了防止“惊群效应”和“虚假唤醒”，必须严格遵守 POSIX 多线程编程规范。</p>
<pre><code class="hljs language-scss" lang="scss">void <span class="hljs-built_in">rb_push</span>(RingBuffer *rb, const Log *entry) {
    <span class="hljs-built_in">pthread_mutex_lock</span>(&amp;(rb-&gt;mutex));
​
    while (rb-&gt;count == rb-&gt;capacity) {
        <span class="hljs-built_in">pthread_cond_wait</span>(&amp;(rb-&gt;cond_producer), &amp;(rb-&gt;mutex));
    }
​
    <span class="hljs-comment">// 直接 memcpy 到数组对应位置</span>
    <span class="hljs-built_in">memcpy</span>(&amp;(rb-&gt;entries[rb-&gt;tail]), entry, <span class="hljs-built_in">sizeof</span>(Log));
​
    <span class="hljs-comment">// 更新索引</span>
    rb-&gt;tail = (rb-&gt;tail + <span class="hljs-number">1</span>) % rb-&gt;capacity;
    rb-&gt;count++;
    
    <span class="hljs-comment">// 唤醒消费者</span>
    <span class="hljs-built_in">pthread_cond_signal</span>(&amp;(rb-&gt;cond_consumer));
    <span class="hljs-built_in">pthread_mutex_unlock</span>(&amp;(rb-&gt;mutex));
}
</code></pre>
<p><code>Push</code>这个单词很形象，我相信不解释大家也能知道这里在干什么，这个函数就是用来把日志内容<code>Push</code>进<code>RingBuffer</code>的。</p>
<p>这里的判断为什么要使用<code>while</code>呢，可能会有些喜欢思考的朋友认真看了之后发现，这里只是判断一下缓冲区内的日志数量是否等于缓冲区最大容量，也就是判断缓冲区满了没有。如果满了那就等呗，没满那就继续生产日志呗。那按道理来说用<code>if</code>来判断也行啊？其实是不行的，这里存在一个<strong>虚假唤醒</strong>的情况。</p>
<p><strong>虚假唤醒</strong>是指，线程在调用 <code>pthread_cond_wait()</code> 开始睡觉之后，即使没有任何人调用 <code>pthread_cond_signal()</code> 或者 <code>pthread_cond_broadcast()</code> ，线程也有可能莫名其妙的醒来。但这个看似存在漏洞的行为其实是 POSIX 标准明确允许的行为。导致虚假唤醒比较常见的原因有：操作系统调度器的内部优化，内存伪共享，信号中断等。所以说醒来并不一定是被 <code>signal</code> 或者 <code>broadcast</code> 唤醒的，意思就是条件不一定能满足。</p>
<p>大家现在来想象一下这个场景，假如线程<strong>由于虚假唤醒醒来</strong>了，但实际上这时缓冲区还是满的，它应该睡觉，不应该醒着。如果使用了 <code>if</code> 来判断，它会什么都不管，直接继续往下执行，先把 <code>entry</code> 的内容拷贝到 <code>RingBuffer</code> ，然后更新索引和日志条数，然后就完蛋了(╯°□°)╯︵ ┻━┻。因为<strong>缓冲区已经溢出</strong>了。</p>
<p>但是如果这里使用<code>while</code>进行判断，在触发虚假唤醒后，他会<strong>重新检查缓冲区是否满了</strong>，如果没满就跳出 <code>while</code> ，继续往下执行。如果满了那就在执行 <code>pthread_cond_wait(&amp;(rb-&gt;cond_producer), &amp;(rb-&gt;mutex));</code> 进入睡眠。不会发生像<code>if</code>那样的可怕场景。</p>
<h3 data-id="heading-19">4.3 消费者 (<code>Pop</code>) 与优雅退出</h3>
<p>消费者不仅要处理数据，还要负责监听<strong>停机指令</strong>。如果只是一个 demo ，那让消费者直接无限循环就完事了，后面直接 Ctrl+C 暴力终止。但是如果想真正应用到工程上，那就要实现<strong>优雅退出</strong>。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 函数返回值：1 表示成功拿到数据，0 表示系统关闭且无数据</span>
int <span class="hljs-built_in">rb_pop</span>(RingBuffer *rb, Log *entry) {
    <span class="hljs-built_in">pthread_mutex_lock</span>(&amp;(rb-&gt;mutex));
​
    <span class="hljs-comment">// 只有当缓冲区为空，且系统还在运行时，才选择等待</span>
    while (rb-&gt;count == <span class="hljs-number">0</span> &amp;&amp; rb-&gt;is_running) {
        <span class="hljs-built_in">pthread_cond_wait</span>(&amp;(rb-&gt;cond_consumer), &amp;(rb-&gt;mutex));
    }
​
    <span class="hljs-comment">// 如果醒来发现没数据了，而且系统标志位已关闭，那就解锁后退出</span>
    if (rb-&gt;count == <span class="hljs-number">0</span> &amp;&amp; !rb-&gt;is_running) {
        <span class="hljs-built_in">pthread_mutex_unlock</span>(&amp;(rb-&gt;mutex));
        return <span class="hljs-number">0</span>; 
    }
​
    <span class="hljs-comment">// 正常消费</span>
    <span class="hljs-built_in">memcpy</span>(entry, &amp;(rb-&gt;entries[rb-&gt;head]), <span class="hljs-built_in">sizeof</span>(Log));
    rb-&gt;head = (rb-&gt;head + <span class="hljs-number">1</span>) % rb-&gt;capacity;
    rb-&gt;count--;
​
    <span class="hljs-comment">// 唤醒生产者</span>
    <span class="hljs-built_in">pthread_cond_signal</span>(&amp;(rb-&gt;cond_producer));
    <span class="hljs-built_in">pthread_mutex_unlock</span>(&amp;(rb-&gt;mutex));
    return <span class="hljs-number">1</span>;
}
</code></pre>
<p>代码中已经有了比较详细的注释，但为了内容的全面性，我还是简单介绍一下这个函数。</p>
<p>先来看 <code>while</code> 循环，只有当缓冲区为空，而且系统还在运行时，才等待。</p>
<p>如果缓冲区为空，但 <code>is_running</code> 被置为0了，那就跳出循环，往下执行到 <code>if</code> ，条件满足，解锁后直接返回0，后面在消费者线程中会检查这个返回值，这个到后面再说吧。</p>
<p>如果缓冲区不为空，且 <code>is_running</code> 为1，正常运行，那就是正常消费后唤醒生产者，函数返回1。</p>
<p>如果缓冲区不为空，且 <code>is_running</code> 为0，也就是说，生产者已经全部退出了，但缓冲区还有些日志内容没有被消费。那我们的逻辑就是<strong>消费完这些日志再退出</strong>。来看代码，这种情况依然会跳出 <code>while</code> 循环，在 <code>if</code> 判断是，是不满足条件的，所以不会在 <code>if</code> 里面退出，而是继续往下执行，正常消费日志，完了返回1，到后面大家会知道，<strong>消费者线程是在循环调用</strong>这个函数的，所以会一直重复上面描述的过程，直到日志全部被消费完，缓冲区空了，这时满足 <code>if</code> 的条件了，返回0。消费者线程检测到0后优雅退出。</p>
<p>这里我还想提一点，我在 4.2 和 本节4.3 里都用了 <code>memcpy</code>。在这里使用 <code>memcpy</code> 是安全的，因为我们在 <code>log_push</code> 里已经用 <code>snprintf</code> 保证了源数据长度不会超过 <code>LOG_MSG_SIZE</code>，所以不会发生越界拷贝。</p>
<p>优雅退出的代码没什么深度，我就不解释了，直接放在下面：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//优雅退出</span>
void <span class="hljs-built_in">rb_stop</span>(RingBuffer *rb)
{
    <span class="hljs-built_in">pthread_mutex_lock</span>(&amp;(rb-&gt;mutex));
​
    rb-&gt;is_running = false;
​
    <span class="hljs-built_in">pthread_cond_broadcast</span>(&amp;(rb-&gt;cond_consumer));<span class="hljs-comment">//唤醒消费者</span>
​
    <span class="hljs-built_in">pthread_mutex_unlock</span>(&amp;(rb-&gt;mutex));
}
</code></pre>
<h3 data-id="heading-20">4.4 安全性封装拒绝缓冲区溢出</h3>
<p>在 C 语言中，<code>strncpy</code> 和 <code>sprintf</code> 都是缓冲区溢出的重灾区。为了保证日志内容的安全，我在业务封装层使用了 <code>snprintf</code>。</p>
<p><code>snprintf</code> 是 C 语言中最重要，最安全的字符串格式化函数之一，它几乎完全取代了老的 <code>sprintf</code>，也是现代 C 代码中<strong>唯一推荐使用的格式化输出到字符串的函数</strong>。</p>
<p>MISRA C 2012（汽车嵌入式规范）：<strong>禁止</strong>使用库函数<code>sprintf</code>，<code>vsprintf</code> ，必须使用带长度限制的替代函数，如<code>snprintf</code>、<code>vsnprintf</code>。</p>
<p>Linux 内核、GNU、LLVM、Chrome、Firefox 等大型项目：全部<strong>禁止</strong> <code>sprintf</code>，强制 <code>snprintf</code>。</p>
<p>除了一些大型项目可能还存在历史遗留的<code>sprintf()</code>调用问题。在现在的新项目中，绝对应该使用<code>snprintf</code>而不是<code>sprintf</code> ，这是工业界的共识，不是可有可无的风格问题，而是安全问题。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">log_push</span><span class="hljs-params">(RingBuffer *rb, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg)</span> </span>{
    Log log_entry = {<span class="hljs-number">0</span>};
    
    <span class="hljs-comment">// 可以自动处理 \0 结尾，防止 msg 过长导致的越界访问</span>
    <span class="hljs-built_in">snprintf</span>(log_entry.data, LOG_MSG_SIZE, <span class="hljs-string">"%s"</span>, msg);
        
    <span class="hljs-built_in">rb_push</span>(rb, &amp;log_entry);
}
</code></pre>
<h2 data-id="heading-21">5. 性能压测与总结</h2>
<p>为了验证这个异步日志库的健壮性，我设计了一个<strong>高并发 + 极小缓冲区</strong>的测试场景。</p>
<h3 data-id="heading-22">5.1 压测场景设计</h3>
<p>为了模拟最恶劣的竞争环境，我特意将缓冲区容量设置得极小，强迫线程<strong>频繁发生阻塞和唤醒</strong>。</p>
<p>生产者：2个线程（Producer1，Producer2），每个狂发1000条日志。</p>
<p>消费者：1个后台线程。</p>
<p>缓冲区容量：设为10，这意味着生产者每生产几条日志就要被迫睡觉，锁竞争将会非常激烈。</p>
<p>预期结果：日志文件应该包含整整2000条数据，无丢失，无乱序（线程内部有序），并且程序可以优雅退出。</p>
<p>这是 main.c 的内容，大家可以照着我上面的解释梳理一下逻辑:</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ring_buffer.h"</span></span>
​
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FILE_NAME <span class="hljs-string">"log.txt"</span></span>
​
<span class="hljs-type">void</span> <span class="hljs-title function_">log_push</span><span class="hljs-params">(RingBuffer *rb,<span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg)</span>
{
    Log log_entry = {<span class="hljs-number">0</span>};
​
    <span class="hljs-built_in">snprintf</span>(log_entry.data,LOG_MSG_SIZE,<span class="hljs-string">"%s"</span>,msg);<span class="hljs-comment">//最推荐的函数</span>
        
    rb_push(rb,&amp;log_entry);
}
​
<span class="hljs-type">void</span> *<span class="hljs-title function_">pthread_producer1</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span>
{
    RingBuffer *rb = (RingBuffer *)arg;
​
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000</span>;i++)
    {
        <span class="hljs-type">char</span> buf[<span class="hljs-number">64</span>];
​
        <span class="hljs-built_in">snprintf</span>(buf, <span class="hljs-keyword">sizeof</span>(buf), <span class="hljs-string">"Producer1 code:%d\n"</span>, i);
​
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Producer1 pushing:%s\n"</span>,buf);
​
        log_push(rb,buf);
​
        usleep(<span class="hljs-number">100</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}
​
<span class="hljs-type">void</span> *<span class="hljs-title function_">pthread_producer2</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span>
{
    RingBuffer *rb = (RingBuffer *)arg;
​
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000</span>;i++)
    {
        <span class="hljs-type">char</span> buf[<span class="hljs-number">64</span>];
​
        <span class="hljs-built_in">snprintf</span>(buf, <span class="hljs-keyword">sizeof</span>(buf), <span class="hljs-string">"Producer2 code:%d\n"</span>, i);
​
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Producer2 pushing:%s\n"</span>,buf);
​
        log_push(rb,buf);
​
        usleep(<span class="hljs-number">100</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}
​
<span class="hljs-type">void</span> *<span class="hljs-title function_">pthread_consumer</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span>
{
    RingBuffer *rb = (RingBuffer *)arg;
    Log entry;
    <span class="hljs-keyword">while</span>(rb_pop(rb,&amp;entry))<span class="hljs-comment">//循环检测返回值，看看是不是要退出</span>
    {
        write(rb-&gt;file_fd,entry.data,<span class="hljs-built_in">strlen</span>(entry.data));
    }
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"消费者线程：优雅退出\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}
​
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
    RingBuffer rb;
​
    rb_init(&amp;rb,<span class="hljs-number">10</span>);
​
    rb.file_fd = open(FILE_NAME,O_RDWR|O_CREAT|O_APPEND,<span class="hljs-number">0644</span>);
    <span class="hljs-keyword">if</span>(rb.file_fd == <span class="hljs-number">-1</span>)
    {
        perror(<span class="hljs-string">"文件打开失败"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
​
    <span class="hljs-type">pthread_t</span> consumer,producer1,producer2;
    pthread_create(&amp;consumer,<span class="hljs-literal">NULL</span>,pthread_consumer,(<span class="hljs-type">void</span> *)&amp;rb);
    pthread_create(&amp;producer1,<span class="hljs-literal">NULL</span>,pthread_producer1,(<span class="hljs-type">void</span> *)&amp;rb);
    pthread_create(&amp;producer2,<span class="hljs-literal">NULL</span>,pthread_producer2,(<span class="hljs-type">void</span> *)&amp;rb);
​
    pthread_join(producer1,<span class="hljs-literal">NULL</span>);
    pthread_join(producer2,<span class="hljs-literal">NULL</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"所有生产者已经结束任务\n"</span>);
​
    rb_stop(&amp;rb);
    pthread_join(consumer,<span class="hljs-literal">NULL</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"消费者已经退出\n"</span>);
​
    close(rb.file_fd);
    rb_destroy(&amp;rb);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>由于篇幅已经比较长了，下面我直接贴出 Makefile ：</p>
<pre><code class="hljs language-makefile" lang="makefile">CC = gcc
CFLAGS = -Wall -g -pthread
​
TARGET = app
SRCS = main.c ring_buffer.c
OBJS = $(SRCS:.c=.o)
​
<span class="hljs-section">all: <span class="hljs-variable">$(TARGET)</span></span>
​
<span class="hljs-variable">$(TARGET)</span>: <span class="hljs-variable">$(OBJS)</span>
    <span class="hljs-variable">$(CC)</span> <span class="hljs-variable">$(CFLAGS)</span> -o <span class="hljs-variable">$(TARGET)</span> <span class="hljs-variable">$(OBJS)</span>
​
<span class="hljs-section">%.o: %.c ring_buffer.h</span>
    <span class="hljs-variable">$(CC)</span> <span class="hljs-variable">$(CFLAGS)</span> -c <span class="hljs-variable">$&lt;</span> -o <span class="hljs-variable">$@</span>
​
​
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: clean test</span>
​
<span class="hljs-section">clean:</span>
    rm -f <span class="hljs-variable">$(OBJS)</span> <span class="hljs-variable">$(TARGET)</span> log.txt
​
<span class="hljs-section">test: <span class="hljs-variable">$(TARGET)</span></span>
    ./<span class="hljs-variable">$(TARGET)</span>
​
</code></pre>
<p>简单介绍一下怎么使用，首先命令行输入make进行编译，然后输入./app运行程序。或者嫌麻烦的可以直接命令行输入make test，这会直接编译并且运行程序。运行完成后可以使用make clean清除程序运行产生的文件。</p>
<h3 data-id="heading-23">5.2 测试结果验证</h3>
<p>运行之后终端输出如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ea5248382774f89b4c9d3136e06afdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766147788&amp;x-signature=9XAYDK424GhAtbqI%2FYGTslXB4jI%3D" alt="终端运行结果1.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82c875e35c244b999d2d65d1c4254a9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766147788&amp;x-signature=OolOP7ml7YuWIaMwN7he370%2BRQc%3D" alt="终端运行结果2.png" loading="lazy"/></p>
<p>由于我在两个生产者中都添加了<code>printf</code>函数，所以在终端会看到他们打印出来的内容，总共2000条，我只截图了最前面和最后面的部分，可以看到已经<strong>实现了优雅退出</strong>（生产者全部退出后，消费者自动退出）。</p>
<p>然后我们再来查看一下日志内容是否存放到了 log.txt 里面：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c80bd751d6914d57a3084604c2530846~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766147788&amp;x-signature=od0ZKrt2fMOBKJvPbGvjx%2B2Yib4%3D" alt="log.txt前面.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49f10a6da1484d768bbe7a38c4724968~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766147788&amp;x-signature=dFx8gDe5MYtcgsLj5MyNsU6U01k%3D" alt="log.txt后面.png" loading="lazy"/></p>
<p>我们同样只截去最前面和最后面的部分，两个生产者线程产生的日志内容都是从0-999，也就是各1000个，总共2000个。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61e8d32684484e5fa04a1415e3db3f76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766147788&amp;x-signature=mgni668%2Bbdx2YAFJU6yBGRQBp2s%3D" alt="日志行数.png" loading="lazy"/></p>
<p>再来查看 log.txt 文件的行数，发现也是2000行。这足以说明<strong>一条日志都没有丢失</strong>。</p>
<p>结果分析：在容量仅为 10 的情况下，2000 条日志全部落盘，证明<strong>条件变量的 <code>wait</code> &amp; <code>signal</code> 逻辑</strong>很严密。主线程成功等待所有子线程结束，证明<strong>优雅退出</strong>机制生效，没有线程卡在 <code>wait</code> 状态。从终端输出可以看到，两个生产者<strong>交替抢占</strong>时间片，证明<strong>互斥锁</strong>有效保护了临界区。</p>
<h3 data-id="heading-24">5.3 项目总结与思考</h3>
<p>从最开始简单的每产生一条日志就用 <code>write</code> 直接写盘，到最终完成这个<strong>异步日志库</strong>，这个过程不仅仅是代码量的增加，更是<strong>工程思维</strong>的提升。下面是我在整个过程中的一些思考：</p>
<h4 data-id="heading-25">5.3.1 向硬件物理特性妥协</h4>
<p>有人可能更关注算法的时间复杂度，但在嵌入式底层开发中，<strong>硬件特性</strong>才是性能的天花板。</p>
<p>放弃链表选择 <strong>Ring Buffer</strong>，不仅仅是为了管理方便，更是为了<strong>确定性</strong>。在长期运行的嵌入式系统中，避免频繁 <code>malloc/free</code> 造成的堆内存碎片是系统稳定的基石。</p>
<p>利用数组的<strong>空间局部性</strong>，大幅减少 <strong>Cache Miss</strong>，让 CPU 流水线跑得更顺畅。</p>
<h4 data-id="heading-26">5.3.2 解耦与削峰填谷</h4>
<p>利用 <strong>生产者-消费者模型</strong> ，将业务逻辑（快）与磁盘 I/O（慢）彻底分离。</p>
<p><code>Ring Buffer</code> 在这里扮演了“蓄水池”的角色。面对突发流量，缓冲区能起到<strong>削峰填谷</strong>的作用，防止瞬间的高频 I/O 请求将系统拖垮。</p>
<p>虽然使用了互斥锁，但配合<strong>条件变量</strong> 避免了忙等待，在保证数据安全的同时，最大程度降低了 CPU 占用率。</p>
<h4 data-id="heading-27">5.3.3 防御性编程与生命周期</h4>
<p>全面禁用 <code>strcpy/sprintf</code>，严格使用 <code>snprintf</code> 防止缓冲区溢出。</p>
<p>实现了<strong>优雅退出</strong> 机制。通过 <code>is_running</code> 标志位和广播唤醒，确保程序退出时，缓冲区内残留的日志能被<strong>全部消费</strong>，做到数据零丢失。</p>
<p>通过结构体封装文件描述符与互斥锁和条件变量，实现了高内聚低耦合，拒绝全局变量的污染。</p>
<h3 data-id="heading-28">5.4 进阶优化方向</h3>
<p>虽然目前的版本已经是一个<strong>稳定、高效</strong>的异步日志库，但在面对更苛刻的工业级场景（如车规级嵌入式、高频交易系统）时，我们还可以从以下几个维度进行深度优化：</p>
<h4 data-id="heading-29">5.4.1 批量写入与页缓存对齐</h4>
<p>前面已经提到批量写入的内容，如果采用批量写入，还能在本项目的基础上把<strong>性能进一步压榨</strong>。而目前的实现是消费者每次 <code>Pop</code> 一条日志就调用一次 <code>write</code> 。</p>
<p>而 <code>write</code> 是系统调用，涉及<strong>用户态到内核态的上下文切换</strong>，存在着巨大的开销。</p>
<p>优化思路：在消费者线程内部维护一个 <strong>4KB（一页内存）</strong> 的中间缓冲区。当积攒的数据达到 4KB 或者超时（可以自己设定一个时间）时，再一次性调用 <code>write</code> 落盘。这能将系统调用的频率降低一个数量级，并更好地利用文件系统的 <strong>Page Cache</strong>。</p>
<h4 data-id="heading-30">5.4.2 存储管理</h4>
<p>嵌入式设备的存储空间（Flash/SD卡）是有限的，我们不能让 log.txt 无限增长。</p>
<p>优化思路：当 log.txt 达到 10MB 时，自动将其重命名为 log.txt.1，并创建新的 log.txt。可以保留最近 N 个备份，自动删除最旧的日志，防止磁盘写满导致系统崩溃。</p>
<h4 data-id="heading-31">5.4.3 无锁队列</h4>
<p>目前的实现使用了 <code>Mutex</code> + <code>Cond</code>。在极高并发（几十个线程同时写入）下，锁竞争会导致 CPU 上下文切换开销增大。</p>
<p>优化思路：参考 Linux 内核 <strong>kfifo</strong> 的实现，利用 <strong>原子操作</strong> 和 <strong>内存屏障</strong> 来管理 head 和 tail 指针。最终目标是实现<strong>单生产者-单消费者</strong>模式下的完全无锁，或<strong>多生产者</strong>模式下的无锁入队，将性能压榨到物理极限。</p>
<h4 data-id="heading-32">5.4.4 零拷贝</h4>
<p>当前的 <code>log_push</code> 涉及两次拷贝（<code>snprintf</code> 到栈，<code>memcpy</code> 到 <code>RingBuffer</code>）。</p>
<p>优化思路：设计函数接口允许业务线程直接在 RingBuffer 的内存区域内进行格式化写入（通过返回写指针），省去中间的栈内存拷贝过程，进一步降低内存带宽占用。</p>
<h2 data-id="heading-33">6. 项目源码</h2>
<p><em><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxlp666hub%2FAsyncLog-RingBuffer" target="_blank" title="https://github.com/xlp666hub/AsyncLog-RingBuffer" ref="nofollow noopener noreferrer">👉 <strong>点击跳转到 GitHub 仓库</strong></a></em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Guava工具库实战]]></title>    <link>https://juejin.cn/post/7582846276505960486</link>    <guid>https://juejin.cn/post/7582846276505960486</guid>    <pubDate>2025-12-13T00:37:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582846276505960486" data-draft-id="7582849187864903731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Guava工具库实战"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-13T00:37:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Guava工具库实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T00:37:25.000Z" title="Sat Dec 13 2025 00:37:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Guava工具库实战：Map、List、Splitter、Joiner高效使用</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae92d257680b431299aeb022e2a09ced~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766191044&amp;x-signature=i224q4JIQTjwZs166YHgkL6YC1Y%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-1">一、引言：为什么选择Guava？</h3>
<p>在Java开发中，我们经常会遇到这样的痛点：</p>
<ul>
<li><strong>创建不可变集合</strong>：JDK原生API过于繁琐</li>
<li><strong>处理null值</strong>：需要大量的判空代码</li>
<li><strong>字符串分割</strong>：<code>String.split()</code>功能有限，无法优雅处理空白</li>
<li><strong>集合操作</strong>：缺少便捷的工具方法</li>
</ul>
<p>Google Guava正是为了解决这些问题而生。它是Google开源的Java核心库，提供了大量优雅、高效的工具类，被Spring、Hibernate、MyBatis等众多知名框架广泛使用。</p>
<p><strong>Guava的核心优势：</strong></p>
<p>✅ <strong>代码简洁</strong>：一行代码完成复杂操作
✅ <strong>空值安全</strong>：内置null处理机制
✅ <strong>性能优化</strong>：经过Google生产环境验证
✅ <strong>易于使用</strong>：流畅的API设计，链式调用</p>
<p>本文将深入介绍Guava中最常用的四大工具：<strong>Map、List、Splitter、Joiner</strong>，通过真实案例展示它们在生产环境中的应用。</p>
<h3 data-id="heading-2">二、Guava Map：强大的映射集合</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33b230e91b2a4fa893e18181ec215d6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766191044&amp;x-signature=f%2FYfEJwV0G4DDTrHaF2FvfQPCEQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>Guava提供了多种增强的Map实现，每种都针对特定场景优化。</p>
<h4 data-id="heading-3">2.1 ImmutableMap：不可变映射</h4>
<p><strong>特点：</strong></p>
<ul>
<li>线程安全，无需同步</li>
<li>创建后不可修改</li>
<li>性能优于Collections.unmodifiableMap()</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.google.common.collect.ImmutableMap;

<span class="hljs-comment">// 方式1：直接构建</span>
ImmutableMap&lt;String, Integer&gt; map = ImmutableMap.of(
    <span class="hljs-string">"Java"</span>, <span class="hljs-number">1</span>,
    <span class="hljs-string">"Python"</span>, <span class="hljs-number">2</span>,
    <span class="hljs-string">"Go"</span>, <span class="hljs-number">3</span>
);

<span class="hljs-comment">// 方式2：Builder模式（超过5个键值对时使用）</span>
ImmutableMap&lt;String, String&gt; configMap = ImmutableMap.&lt;String, String&gt;builder()
    .put(<span class="hljs-string">"db.host"</span>, <span class="hljs-string">"localhost"</span>)
    .put(<span class="hljs-string">"db.port"</span>, <span class="hljs-string">"3306"</span>)
    .put(<span class="hljs-string">"db.name"</span>, <span class="hljs-string">"test"</span>)
    .put(<span class="hljs-string">"db.user"</span>, <span class="hljs-string">"root"</span>)
    .put(<span class="hljs-string">"db.password"</span>, <span class="hljs-string">"123456"</span>)
    .build();

<span class="hljs-comment">// 方式3：从已有Map复制</span>
Map&lt;String, Integer&gt; originalMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
originalMap.put(<span class="hljs-string">"A"</span>, <span class="hljs-number">1</span>);
originalMap.put(<span class="hljs-string">"B"</span>, <span class="hljs-number">2</span>);
ImmutableMap&lt;String, Integer&gt; immutableCopy = ImmutableMap.copyOf(originalMap);
</code></pre>
<p><strong>生产案例：配置管理</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConfig</span> {

    <span class="hljs-comment">// 环境配置映射，不可变且线程安全</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ImmutableMap&lt;String, String&gt; ENV_CONFIG = ImmutableMap.of(
        <span class="hljs-string">"dev"</span>, <span class="hljs-string">"jdbc:mysql://dev-db:3306/app"</span>,
        <span class="hljs-string">"test"</span>, <span class="hljs-string">"jdbc:mysql://test-db:3306/app"</span>,
        <span class="hljs-string">"prod"</span>, <span class="hljs-string">"jdbc:mysql://prod-db:3306/app"</span>
    );

    <span class="hljs-comment">// HTTP状态码映射</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ImmutableMap&lt;Integer, String&gt; HTTP_STATUS =
        ImmutableMap.&lt;Integer, String&gt;builder()
            .put(<span class="hljs-number">200</span>, <span class="hljs-string">"OK"</span>)
            .put(<span class="hljs-number">201</span>, <span class="hljs-string">"Created"</span>)
            .put(<span class="hljs-number">400</span>, <span class="hljs-string">"Bad Request"</span>)
            .put(<span class="hljs-number">401</span>, <span class="hljs-string">"Unauthorized"</span>)
            .put(<span class="hljs-number">403</span>, <span class="hljs-string">"Forbidden"</span>)
            .put(<span class="hljs-number">404</span>, <span class="hljs-string">"Not Found"</span>)
            .put(<span class="hljs-number">500</span>, <span class="hljs-string">"Internal Server Error"</span>)
            .build();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getDbUrl</span><span class="hljs-params">(String env)</span> {
        <span class="hljs-keyword">return</span> ENV_CONFIG.getOrDefault(env, ENV_CONFIG.get(<span class="hljs-string">"dev"</span>));
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getStatusMessage</span><span class="hljs-params">(<span class="hljs-type">int</span> code)</span> {
        <span class="hljs-keyword">return</span> HTTP_STATUS.getOrDefault(code, <span class="hljs-string">"Unknown Status"</span>);
    }
}
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li>避免了同步开销</li>
<li>内存占用更少（优化的内部结构）</li>
<li>编译期就能发现修改错误</li>
</ul>
<h4 data-id="heading-4">2.2 BiMap：双向映射</h4>
<p>BiMap允许你根据值反向查找键，非常适合双向映射场景。</p>
<p><strong>基本用法：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.google.common.collect.BiMap;
<span class="hljs-keyword">import</span> com.google.common.collect.HashBiMap;

<span class="hljs-comment">// 创建BiMap</span>
BiMap&lt;String, Integer&gt; userIdMap = HashBiMap.create();
userIdMap.put(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">1001</span>);
userIdMap.put(<span class="hljs-string">"Bob"</span>, <span class="hljs-number">1002</span>);
userIdMap.put(<span class="hljs-string">"Charlie"</span>, <span class="hljs-number">1003</span>);

<span class="hljs-comment">// 正向查找</span>
<span class="hljs-type">Integer</span> <span class="hljs-variable">aliceId</span> <span class="hljs-operator">=</span> userIdMap.get(<span class="hljs-string">"Alice"</span>);  <span class="hljs-comment">// 1001</span>

<span class="hljs-comment">// 反向查找</span>
BiMap&lt;Integer, String&gt; inverse = userIdMap.inverse();
<span class="hljs-type">String</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> inverse.get(<span class="hljs-number">1002</span>);  <span class="hljs-comment">// "Bob"</span>

<span class="hljs-comment">// 注意：值必须唯一，否则抛出异常</span>
userIdMap.put(<span class="hljs-string">"David"</span>, <span class="hljs-number">1001</span>);  <span class="hljs-comment">// 抛出IllegalArgumentException</span>

<span class="hljs-comment">// 强制替换</span>
userIdMap.forcePut(<span class="hljs-string">"David"</span>, <span class="hljs-number">1001</span>);  <span class="hljs-comment">// Alice被移除，David映射到1001</span>
</code></pre>
<p><strong>生产案例：错误码管理</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorCodeManager</span> {

    <span class="hljs-comment">// 错误码与消息的双向映射</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> BiMap&lt;String, Integer&gt; ERROR_CODES = HashBiMap.create();

    <span class="hljs-keyword">static</span> {
        ERROR_CODES.put(<span class="hljs-string">"USER_NOT_FOUND"</span>, <span class="hljs-number">1001</span>);
        ERROR_CODES.put(<span class="hljs-string">"INVALID_PASSWORD"</span>, <span class="hljs-number">1002</span>);
        ERROR_CODES.put(<span class="hljs-string">"ACCOUNT_LOCKED"</span>, <span class="hljs-number">1003</span>);
        ERROR_CODES.put(<span class="hljs-string">"PERMISSION_DENIED"</span>, <span class="hljs-number">1004</span>);
    }

    <span class="hljs-comment">// 根据错误名获取错误码</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Integer <span class="hljs-title function_">getErrorCode</span><span class="hljs-params">(String errorName)</span> {
        <span class="hljs-keyword">return</span> ERROR_CODES.get(errorName);
    }

    <span class="hljs-comment">// 根据错误码获取错误名</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getErrorName</span><span class="hljs-params">(Integer errorCode)</span> {
        <span class="hljs-keyword">return</span> ERROR_CODES.inverse().get(errorCode);
    }

    <span class="hljs-comment">// 示例：日志记录</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logError</span><span class="hljs-params">(Integer errorCode)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">errorName</span> <span class="hljs-operator">=</span> getErrorName(errorCode);
        System.out.println(<span class="hljs-string">"Error ["</span> + errorCode + <span class="hljs-string">"]: "</span> + errorName);
    }
}
</code></pre>
<h4 data-id="heading-5">2.3 Multimap：一键多值映射</h4>
<p>Multimap允许一个键对应多个值，避免了<code>Map&lt;K, List&lt;V&gt;&gt;</code>的繁琐操作。</p>
<p><strong>基本用法：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.google.common.collect.ArrayListMultimap;
<span class="hljs-keyword">import</span> com.google.common.collect.Multimap;

<span class="hljs-comment">// 创建Multimap</span>
Multimap&lt;String, String&gt; tagMap = ArrayListMultimap.create();

<span class="hljs-comment">// 添加多个值</span>
tagMap.put(<span class="hljs-string">"Java"</span>, <span class="hljs-string">"Spring"</span>);
tagMap.put(<span class="hljs-string">"Java"</span>, <span class="hljs-string">"MyBatis"</span>);
tagMap.put(<span class="hljs-string">"Java"</span>, <span class="hljs-string">"Guava"</span>);
tagMap.put(<span class="hljs-string">"Python"</span>, <span class="hljs-string">"Django"</span>);
tagMap.put(<span class="hljs-string">"Python"</span>, <span class="hljs-string">"Flask"</span>);

<span class="hljs-comment">// 获取某个键的所有值</span>
Collection&lt;String&gt; javaTags = tagMap.get(<span class="hljs-string">"Java"</span>);
<span class="hljs-comment">// ["Spring", "MyBatis", "Guava"]</span>

<span class="hljs-comment">// 获取所有键值对</span>
<span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : tagMap.entries()) {
    System.out.println(entry.getKey() + <span class="hljs-string">" -&gt; "</span> + entry.getValue());
}

<span class="hljs-comment">// 移除特定值</span>
tagMap.remove(<span class="hljs-string">"Java"</span>, <span class="hljs-string">"MyBatis"</span>);
</code></pre>
<p><strong>生产案例：文章标签系统</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleTagService</span> {

    <span class="hljs-comment">// 文章ID -&gt; 标签列表的映射</span>
    <span class="hljs-keyword">private</span> Multimap&lt;Long, String&gt; articleTags = ArrayListMultimap.create();

    <span class="hljs-comment">// 添加标签</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addTag</span><span class="hljs-params">(Long articleId, String tag)</span> {
        articleTags.put(articleId, tag);
    }

    <span class="hljs-comment">// 批量添加标签</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addTags</span><span class="hljs-params">(Long articleId, List&lt;String&gt; tags)</span> {
        articleTags.putAll(articleId, tags);
    }

    <span class="hljs-comment">// 获取文章的所有标签</span>
    <span class="hljs-keyword">public</span> Collection&lt;String&gt; <span class="hljs-title function_">getTags</span><span class="hljs-params">(Long articleId)</span> {
        <span class="hljs-keyword">return</span> articleTags.get(articleId);
    }

    <span class="hljs-comment">// 移除标签</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeTag</span><span class="hljs-params">(Long articleId, String tag)</span> {
        articleTags.remove(articleId, tag);
    }

    <span class="hljs-comment">// 查找包含某标签的所有文章</span>
    <span class="hljs-keyword">public</span> List&lt;Long&gt; <span class="hljs-title function_">findArticlesByTag</span><span class="hljs-params">(String tag)</span> {
        <span class="hljs-keyword">return</span> articleTags.entries().stream()
            .filter(entry -&gt; entry.getValue().equals(tag))
            .map(Map.Entry::getKey)
            .collect(Collectors.toList());
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-type">ArticleTagService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArticleTagService</span>();
service.addTags(<span class="hljs-number">1001L</span>, Arrays.asList(<span class="hljs-string">"Java"</span>, <span class="hljs-string">"Spring"</span>, <span class="hljs-string">"后端"</span>));
service.addTags(<span class="hljs-number">1002L</span>, Arrays.asList(<span class="hljs-string">"Java"</span>, <span class="hljs-string">"MyBatis"</span>, <span class="hljs-string">"数据库"</span>));

Collection&lt;String&gt; tags = service.getTags(<span class="hljs-number">1001L</span>);
<span class="hljs-comment">// ["Java", "Spring", "后端"]</span>

List&lt;Long&gt; javaArticles = service.findArticlesByTag(<span class="hljs-string">"Java"</span>);
<span class="hljs-comment">// [1001, 1002]</span>
</code></pre>
<h4 data-id="heading-6">2.4 Table：双键映射表</h4>
<p>Table提供了类似数据库表的结构，支持行键和列键。</p>
<p><strong>基本用法：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.google.common.collect.HashBasedTable;
<span class="hljs-keyword">import</span> com.google.common.collect.Table;

<span class="hljs-comment">// 创建Table</span>
Table&lt;String, String, Integer&gt; scoreTable = HashBasedTable.create();

<span class="hljs-comment">// 添加数据（学生、科目、分数）</span>
scoreTable.put(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Math"</span>, <span class="hljs-number">95</span>);
scoreTable.put(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"English"</span>, <span class="hljs-number">88</span>);
scoreTable.put(<span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Math"</span>, <span class="hljs-number">82</span>);
scoreTable.put(<span class="hljs-string">"Bob"</span>, <span class="hljs-string">"English"</span>, <span class="hljs-number">90</span>);

<span class="hljs-comment">// 获取特定单元格的值</span>
<span class="hljs-type">Integer</span> <span class="hljs-variable">aliceMath</span> <span class="hljs-operator">=</span> scoreTable.get(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Math"</span>);  <span class="hljs-comment">// 95</span>

<span class="hljs-comment">// 获取某一行</span>
Map&lt;String, Integer&gt; aliceScores = scoreTable.row(<span class="hljs-string">"Alice"</span>);
<span class="hljs-comment">// {Math=95, English=88}</span>

<span class="hljs-comment">// 获取某一列</span>
Map&lt;String, Integer&gt; mathScores = scoreTable.column(<span class="hljs-string">"Math"</span>);
<span class="hljs-comment">// {Alice=95, Bob=82}</span>
</code></pre>
<p><strong>生产案例：权限矩阵</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionMatrix</span> {

    <span class="hljs-comment">// 用户角色、资源、权限的映射表</span>
    <span class="hljs-keyword">private</span> Table&lt;String, String, Set&lt;String&gt;&gt; permissionTable = HashBasedTable.create();

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PermissionMatrix</span><span class="hljs-params">()</span> {
        initPermissions();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initPermissions</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 管理员权限</span>
        permissionTable.put(<span class="hljs-string">"ADMIN"</span>, <span class="hljs-string">"USER"</span>, Sets.newHashSet(<span class="hljs-string">"CREATE"</span>, <span class="hljs-string">"READ"</span>, <span class="hljs-string">"UPDATE"</span>, <span class="hljs-string">"DELETE"</span>));
        permissionTable.put(<span class="hljs-string">"ADMIN"</span>, <span class="hljs-string">"ORDER"</span>, Sets.newHashSet(<span class="hljs-string">"CREATE"</span>, <span class="hljs-string">"READ"</span>, <span class="hljs-string">"UPDATE"</span>, <span class="hljs-string">"DELETE"</span>));

        <span class="hljs-comment">// 普通用户权限</span>
        permissionTable.put(<span class="hljs-string">"USER"</span>, <span class="hljs-string">"USER"</span>, Sets.newHashSet(<span class="hljs-string">"READ"</span>, <span class="hljs-string">"UPDATE"</span>));
        permissionTable.put(<span class="hljs-string">"USER"</span>, <span class="hljs-string">"ORDER"</span>, Sets.newHashSet(<span class="hljs-string">"CREATE"</span>, <span class="hljs-string">"READ"</span>));

        <span class="hljs-comment">// 访客权限</span>
        permissionTable.put(<span class="hljs-string">"GUEST"</span>, <span class="hljs-string">"USER"</span>, Sets.newHashSet(<span class="hljs-string">"READ"</span>));
        permissionTable.put(<span class="hljs-string">"GUEST"</span>, <span class="hljs-string">"ORDER"</span>, Sets.newHashSet(<span class="hljs-string">"READ"</span>));
    }

    <span class="hljs-comment">// 检查权限</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasPermission</span><span class="hljs-params">(String role, String resource, String action)</span> {
        Set&lt;String&gt; permissions = permissionTable.get(role, resource);
        <span class="hljs-keyword">return</span> permissions != <span class="hljs-literal">null</span> &amp;&amp; permissions.contains(action);
    }

    <span class="hljs-comment">// 获取角色在某资源上的所有权限</span>
    <span class="hljs-keyword">public</span> Set&lt;String&gt; <span class="hljs-title function_">getPermissions</span><span class="hljs-params">(String role, String resource)</span> {
        <span class="hljs-keyword">return</span> permissionTable.get(role, resource);
    }
}
</code></pre>
<h3 data-id="heading-7">三、Guava List：强大的列表工具</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3927c675242f4108a99abfc78f374e4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766191044&amp;x-signature=bsCn%2B%2FSZjwnN9CjPza%2FYbP268jE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-8">3.1 ImmutableList：不可变列表</h4>
<p><strong>基本用法：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.google.common.collect.ImmutableList;

<span class="hljs-comment">// 方式1：直接构建</span>
ImmutableList&lt;String&gt; languages = ImmutableList.of(<span class="hljs-string">"Java"</span>, <span class="hljs-string">"Python"</span>, <span class="hljs-string">"Go"</span>);

<span class="hljs-comment">// 方式2：Builder模式</span>
ImmutableList&lt;Integer&gt; numbers = ImmutableList.&lt;Integer&gt;builder()
    .add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
    .add(<span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
    .build();

<span class="hljs-comment">// 方式3：从已有集合复制</span>
List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>));
ImmutableList&lt;String&gt; immutableCopy = ImmutableList.copyOf(list);
</code></pre>
<h4 data-id="heading-9">3.2 Lists工具类</h4>
<p><strong>创建列表：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.google.common.collect.Lists;

<span class="hljs-comment">// 创建ArrayList并初始化</span>
List&lt;String&gt; list = Lists.newArrayList(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>);

<span class="hljs-comment">// 创建指定容量的ArrayList</span>
List&lt;String&gt; listWithCapacity = Lists.newArrayListWithCapacity(<span class="hljs-number">100</span>);

<span class="hljs-comment">// 创建LinkedList</span>
List&lt;Integer&gt; linkedList = Lists.newLinkedList();
</code></pre>
<p><strong>列表分割：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 将大列表分割为固定大小的子列表</span>
List&lt;Integer&gt; bigList = Lists.newArrayList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>);
List&lt;List&lt;Integer&gt;&gt; partitions = Lists.partition(bigList, <span class="hljs-number">3</span>);

<span class="hljs-comment">// 结果：[[1, 2, 3], [4, 5, 6], [7, 8, 9], [10]]</span>
<span class="hljs-keyword">for</span> (List&lt;Integer&gt; partition : partitions) {
    System.out.println(partition);
}
</code></pre>
<p><strong>生产案例：批量处理</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchProcessor</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BATCH_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;

    <span class="hljs-comment">// 批量插入数据</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchInsert</span><span class="hljs-params">(List&lt;User&gt; users)</span> {
        <span class="hljs-comment">// 将用户列表分割为每100个一批</span>
        List&lt;List&lt;User&gt;&gt; batches = Lists.partition(users, BATCH_SIZE);

        <span class="hljs-keyword">for</span> (List&lt;User&gt; batch : batches) {
            <span class="hljs-comment">// 批量插入到数据库</span>
            userDao.batchInsert(batch);

            <span class="hljs-comment">// 避免过快的插入导致数据库压力</span>
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">100</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }

    <span class="hljs-comment">// 批量发送通知</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchNotify</span><span class="hljs-params">(List&lt;Long&gt; userIds, String message)</span> {
        Lists.partition(userIds, <span class="hljs-number">50</span>).forEach(batch -&gt; {
            <span class="hljs-comment">// 每批最多50个用户</span>
            notificationService.sendBatch(batch, message);
        });
    }
}
</code></pre>
<p><strong>列表反转：</strong></p>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; list = Lists.newArrayList(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>);
List&lt;String&gt; reversed = Lists.reverse(list);
<span class="hljs-comment">// ["D", "C", "B", "A"]</span>
</code></pre>
<p><strong>列表转换：</strong></p>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; names = Lists.newArrayList(<span class="hljs-string">"alice"</span>, <span class="hljs-string">"bob"</span>, <span class="hljs-string">"charlie"</span>);

<span class="hljs-comment">// 转换为大写</span>
List&lt;String&gt; upperNames = Lists.transform(names, String::toUpperCase);
<span class="hljs-comment">// ["ALICE", "BOB", "CHARLIE"]</span>

<span class="hljs-comment">// 注意：transform返回的是视图，不是新列表</span>
</code></pre>
<p><strong>笛卡尔积：</strong></p>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; colors = Lists.newArrayList(<span class="hljs-string">"Red"</span>, <span class="hljs-string">"Green"</span>);
List&lt;String&gt; sizes = Lists.newArrayList(<span class="hljs-string">"S"</span>, <span class="hljs-string">"M"</span>, <span class="hljs-string">"L"</span>);

List&lt;List&lt;String&gt;&gt; product = Lists.cartesianProduct(colors, sizes);
<span class="hljs-comment">// [[Red, S], [Red, M], [Red, L], [Green, S], [Green, M], [Green, L]]</span>
</code></pre>
<p><strong>生产案例：商品SKU生成</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductSkuGenerator</span> {

    <span class="hljs-keyword">public</span> List&lt;ProductSku&gt; <span class="hljs-title function_">generateSkus</span><span class="hljs-params">(Product product)</span> {
        <span class="hljs-comment">// 获取所有属性值</span>
        List&lt;String&gt; colors = product.getColors();      <span class="hljs-comment">// ["黑色", "白色"]</span>
        List&lt;String&gt; sizes = product.getSizes();        <span class="hljs-comment">// ["S", "M", "L"]</span>
        List&lt;String&gt; materials = product.getMaterials(); <span class="hljs-comment">// ["棉质", "涤纶"]</span>

        <span class="hljs-comment">// 计算笛卡尔积</span>
        List&lt;List&lt;String&gt;&gt; combinations = Lists.cartesianProduct(
            colors, sizes, materials
        );

        <span class="hljs-comment">// 生成SKU</span>
        <span class="hljs-keyword">return</span> combinations.stream()
            .map(combo -&gt; {
                <span class="hljs-type">ProductSku</span> <span class="hljs-variable">sku</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductSku</span>();
                sku.setProductId(product.getId());
                sku.setColor(combo.get(<span class="hljs-number">0</span>));
                sku.setSize(combo.get(<span class="hljs-number">1</span>));
                sku.setMaterial(combo.get(<span class="hljs-number">2</span>));
                sku.setSkuCode(generateSkuCode(combo));
                <span class="hljs-keyword">return</span> sku;
            })
            .collect(Collectors.toList());
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">generateSkuCode</span><span class="hljs-params">(List&lt;String&gt; attributes)</span> {
        <span class="hljs-keyword">return</span> Joiner.on(<span class="hljs-string">"-"</span>).join(attributes);
    }
}
</code></pre>
<h3 data-id="heading-10">四、Splitter：智能字符串分割</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99312c4744e54be2b452997064040c1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766191044&amp;x-signature=OAmI9fu5n13uDgMnzoYSgtXLXEE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>JDK的<code>String.split()</code>存在诸多问题：无法优雅处理空白、空字符串等。Guava的Splitter提供了更强大的功能。</p>
<h4 data-id="heading-11">4.1 基础用法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.google.common.base.Splitter;

<span class="hljs-comment">// 按逗号分割</span>
<span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">"a,b,c,d"</span>;
Iterable&lt;String&gt; parts = Splitter.on(<span class="hljs-string">','</span>).split(str);
<span class="hljs-comment">// ["a", "b", "c", "d"]</span>

<span class="hljs-comment">// 转换为List</span>
List&lt;String&gt; list = Splitter.on(<span class="hljs-string">','</span>).splitToList(str);
</code></pre>
<h4 data-id="heading-12">4.2 处理空白和空字符串</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">messyStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"a,b,,c, ,d,  ,e"</span>;

<span class="hljs-comment">// 去除空格并忽略空字符串</span>
List&lt;String&gt; cleaned = Splitter.on(<span class="hljs-string">','</span>)
    .trimResults()           <span class="hljs-comment">// 去除每个元素的首尾空格</span>
    .omitEmptyStrings()      <span class="hljs-comment">// 忽略空字符串</span>
    .splitToList(messyStr);

<span class="hljs-comment">// 结果：["a", "b", "c", "d", "e"]</span>
</code></pre>
<p><strong>对比JDK方式：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// JDK方式：繁琐且容易出错</span>
String[] parts = messyStr.split(<span class="hljs-string">","</span>);
List&lt;String&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
<span class="hljs-keyword">for</span> (String part : parts) {
    <span class="hljs-type">String</span> <span class="hljs-variable">trimmed</span> <span class="hljs-operator">=</span> part.trim();
    <span class="hljs-keyword">if</span> (!trimmed.isEmpty()) {
        result.add(trimmed);
    }
}

<span class="hljs-comment">// Guava方式：一行搞定</span>
List&lt;String&gt; result = Splitter.on(<span class="hljs-string">','</span>)
    .trimResults()
    .omitEmptyStrings()
    .splitToList(messyStr);
</code></pre>
<h4 data-id="heading-13">4.3 限制分割次数</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">"key:value:extra:data"</span>;

<span class="hljs-comment">// 最多分割为2部分</span>
List&lt;String&gt; parts = Splitter.on(<span class="hljs-string">':'</span>)
    .limit(<span class="hljs-number">2</span>)
    .splitToList(str);

<span class="hljs-comment">// 结果：["key", "value:extra:data"]</span>
</code></pre>
<h4 data-id="heading-14">4.4 MapSplitter：分割为Map</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">queryString</span> <span class="hljs-operator">=</span> <span class="hljs-string">"name=Alice&amp;age=25&amp;city=Beijing"</span>;

<span class="hljs-comment">// 分割为Map</span>
Map&lt;String, String&gt; params = Splitter.on(<span class="hljs-string">'&amp;'</span>)
    .withKeyValueSeparator(<span class="hljs-string">'='</span>)
    .split(queryString);

<span class="hljs-comment">// 结果：{name=Alice, age=25, city=Beijing}</span>
</code></pre>
<p><strong>生产案例：URL参数解析</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UrlParamParser</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Splitter.<span class="hljs-type">MapSplitter</span> <span class="hljs-variable">PARAM_SPLITTER</span> <span class="hljs-operator">=</span>
        Splitter.on(<span class="hljs-string">'&amp;'</span>)
            .trimResults()
            .omitEmptyStrings()
            .withKeyValueSeparator(<span class="hljs-string">'='</span>);

    <span class="hljs-comment">// 解析URL参数</span>
    <span class="hljs-keyword">public</span> Map&lt;String, String&gt; <span class="hljs-title function_">parseQueryString</span><span class="hljs-params">(String url)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">questionMarkIndex</span> <span class="hljs-operator">=</span> url.indexOf(<span class="hljs-string">'?'</span>);
        <span class="hljs-keyword">if</span> (questionMarkIndex == -<span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> Collections.emptyMap();
        }

        <span class="hljs-type">String</span> <span class="hljs-variable">queryString</span> <span class="hljs-operator">=</span> url.substring(questionMarkIndex + <span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> PARAM_SPLITTER.split(queryString);
    }

    <span class="hljs-comment">// 示例使用</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">UrlParamParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlParamParser</span>();

        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">"https://api.example.com/search?keyword=guava&amp;page=1&amp;size=20"</span>;
        Map&lt;String, String&gt; params = parser.parseQueryString(url);

        System.out.println(<span class="hljs-string">"关键词: "</span> + params.get(<span class="hljs-string">"keyword"</span>));  <span class="hljs-comment">// guava</span>
        System.out.println(<span class="hljs-string">"页码: "</span> + params.get(<span class="hljs-string">"page"</span>));      <span class="hljs-comment">// 1</span>
        System.out.println(<span class="hljs-string">"大小: "</span> + params.get(<span class="hljs-string">"size"</span>));      <span class="hljs-comment">// 20</span>
    }
}
</code></pre>
<h4 data-id="heading-15">4.5 正则表达式分割</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> <span class="hljs-string">"2024-01-15 10:30:45 ERROR User not found"</span>;

<span class="hljs-comment">// 按空格分割</span>
List&lt;String&gt; parts = Splitter.onPattern(<span class="hljs-string">"\\s+"</span>)
    .splitToList(log);

<span class="hljs-comment">// 结果：["2024-01-15", "10:30:45", "ERROR", "User", "not", "found"]</span>
</code></pre>
<p><strong>生产案例：日志解析</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogParser</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Splitter</span> <span class="hljs-variable">LOG_SPLITTER</span> <span class="hljs-operator">=</span> Splitter.onPattern(<span class="hljs-string">"\\s+"</span>)
        .limit(<span class="hljs-number">4</span>);

    <span class="hljs-keyword">public</span> LogEntry <span class="hljs-title function_">parseLog</span><span class="hljs-params">(String logLine)</span> {
        List&lt;String&gt; parts = LOG_SPLITTER.splitToList(logLine);

        <span class="hljs-keyword">if</span> (parts.size() &lt; <span class="hljs-number">4</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Invalid log format"</span>);
        }

        <span class="hljs-type">LogEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogEntry</span>();
        entry.setDate(parts.get(<span class="hljs-number">0</span>));
        entry.setTime(parts.get(<span class="hljs-number">1</span>));
        entry.setLevel(parts.get(<span class="hljs-number">2</span>));
        entry.setMessage(parts.get(<span class="hljs-number">3</span>));  <span class="hljs-comment">// 剩余部分作为消息</span>

        <span class="hljs-keyword">return</span> entry;
    }
}
</code></pre>
<h4 data-id="heading-16">4.6 固定长度分割</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">"123456789012"</span>;

<span class="hljs-comment">// 每3个字符分割</span>
Iterable&lt;String&gt; parts = Splitter.fixedLength(<span class="hljs-number">3</span>).split(str);
<span class="hljs-comment">// ["123", "456", "789", "012"]</span>
</code></pre>
<h3 data-id="heading-17">五、Joiner：优雅的字符串连接</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aae7decb74da44b3ba19080a46660abe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766191044&amp;x-signature=ofiV6RC8hlJvRoHkmCX91Ak74D0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-18">5.1 基础用法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.google.common.base.Joiner;

List&lt;String&gt; list = Arrays.asList(<span class="hljs-string">"Google"</span>, <span class="hljs-string">"Guava"</span>, <span class="hljs-string">"Java"</span>);

<span class="hljs-comment">// 用逗号连接</span>
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Joiner.on(<span class="hljs-string">", "</span>).join(list);
<span class="hljs-comment">// "Google, Guava, Java"</span>

<span class="hljs-comment">// 用换行符连接</span>
<span class="hljs-type">String</span> <span class="hljs-variable">multiLine</span> <span class="hljs-operator">=</span> Joiner.on(<span class="hljs-string">"\n"</span>).join(list);
</code></pre>
<h4 data-id="heading-19">5.2 处理null值</h4>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; listWithNull = Arrays.asList(<span class="hljs-string">"A"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>);

<span class="hljs-comment">// 跳过null值</span>
<span class="hljs-type">String</span> <span class="hljs-variable">skipNull</span> <span class="hljs-operator">=</span> Joiner.on(<span class="hljs-string">", "</span>)
    .skipNulls()
    .join(listWithNull);
<span class="hljs-comment">// "A, B, C"</span>

<span class="hljs-comment">// 用默认值替换null</span>
<span class="hljs-type">String</span> <span class="hljs-variable">useForNull</span> <span class="hljs-operator">=</span> Joiner.on(<span class="hljs-string">", "</span>)
    .useForNull(<span class="hljs-string">"N/A"</span>)
    .join(listWithNull);
<span class="hljs-comment">// "A, N/A, B, C"</span>
</code></pre>
<h4 data-id="heading-20">5.3 连接Map</h4>
<pre><code class="hljs language-java" lang="java">Map&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();
map.put(<span class="hljs-string">"host"</span>, <span class="hljs-string">"localhost"</span>);
map.put(<span class="hljs-string">"port"</span>, <span class="hljs-string">"8080"</span>);
map.put(<span class="hljs-string">"path"</span>, <span class="hljs-string">"/api"</span>);

<span class="hljs-comment">// 连接Map为字符串</span>
<span class="hljs-type">String</span> <span class="hljs-variable">mapStr</span> <span class="hljs-operator">=</span> Joiner.on(<span class="hljs-string">"&amp;"</span>)
    .withKeyValueSeparator(<span class="hljs-string">"="</span>)
    .join(map);

<span class="hljs-comment">// 结果："host=localhost&amp;port=8080&amp;path=/api"</span>
</code></pre>
<p><strong>生产案例：生成URL查询参数</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UrlBuilder</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Joiner.<span class="hljs-type">MapJoiner</span> <span class="hljs-variable">QUERY_JOINER</span> <span class="hljs-operator">=</span>
        Joiner.on(<span class="hljs-string">'&amp;'</span>).withKeyValueSeparator(<span class="hljs-string">'='</span>);

    <span class="hljs-keyword">private</span> String baseUrl;
    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UrlBuilder</span><span class="hljs-params">(String baseUrl)</span> {
        <span class="hljs-built_in">this</span>.baseUrl = baseUrl;
    }

    <span class="hljs-keyword">public</span> UrlBuilder <span class="hljs-title function_">addParam</span><span class="hljs-params">(String key, String value)</span> {
        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
            params.put(key, value);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">build</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (params.isEmpty()) {
            <span class="hljs-keyword">return</span> baseUrl;
        }
        <span class="hljs-keyword">return</span> baseUrl + <span class="hljs-string">"?"</span> + QUERY_JOINER.join(params);
    }

    <span class="hljs-comment">// 示例使用</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlBuilder</span>(<span class="hljs-string">"https://api.example.com/search"</span>)
            .addParam(<span class="hljs-string">"q"</span>, <span class="hljs-string">"guava"</span>)
            .addParam(<span class="hljs-string">"page"</span>, <span class="hljs-string">"1"</span>)
            .addParam(<span class="hljs-string">"size"</span>, <span class="hljs-string">"20"</span>)
            .build();

        System.out.println(url);
        <span class="hljs-comment">// https://api.example.com/search?q=guava&amp;page=1&amp;size=20</span>
    }
}
</code></pre>
<h4 data-id="heading-21">5.4 追加到StringBuilder</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">"Results: "</span>);
List&lt;String&gt; items = Arrays.asList(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>);

Joiner.on(<span class="hljs-string">", "</span>).appendTo(sb, items);
<span class="hljs-comment">// sb内容："Results: A, B, C"</span>
</code></pre>
<p><strong>生产案例：SQL生成</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlBuilder</span> {

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">buildInsertSql</span><span class="hljs-params">(String tableName, Map&lt;String, Object&gt; data)</span> {
        List&lt;String&gt; columns = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(data.keySet());
        List&lt;String&gt; placeholders = Collections.nCopies(columns.size(), <span class="hljs-string">"?"</span>);

        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">"INSERT INTO "</span>);
        sql.append(tableName).append(<span class="hljs-string">" ("</span>);

        Joiner.on(<span class="hljs-string">", "</span>).appendTo(sql, columns);
        sql.append(<span class="hljs-string">") VALUES ("</span>);
        Joiner.on(<span class="hljs-string">", "</span>).appendTo(sql, placeholders);
        sql.append(<span class="hljs-string">")"</span>);

        <span class="hljs-keyword">return</span> sql.toString();
    }

    <span class="hljs-comment">// 示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">SqlBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlBuilder</span>();

        Map&lt;String, Object&gt; data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();
        data.put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"Alice"</span>);
        data.put(<span class="hljs-string">"age"</span>, <span class="hljs-number">35</span>);
        data.put(<span class="hljs-string">"email"</span>, <span class="hljs-string">"alice@example.com"</span>);

        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> builder.buildInsertSql(<span class="hljs-string">"users"</span>, data);
        System.out.println(sql);
        <span class="hljs-comment">// INSERT INTO users (name, age, email) VALUES (?, ?, ?)</span>
    }
}
</code></pre>
<h3 data-id="heading-22">六、Guava vs JDK：性能与易用性对比</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bfd106efd0e4c1d8371bb1ae46a936a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766191044&amp;x-signature=YSyZX50%2BxJEcOaIlB77dC3UxgIA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-23">6.1 代码简洁度对比</h4>
<p><strong>场景：创建不可变Map</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// JDK方式</span>
Map&lt;String, Integer&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
map.put(<span class="hljs-string">"A"</span>, <span class="hljs-number">1</span>);
map.put(<span class="hljs-string">"B"</span>, <span class="hljs-number">2</span>);
map.put(<span class="hljs-string">"C"</span>, <span class="hljs-number">3</span>);
Map&lt;String, Integer&gt; immutableMap = Collections.unmodifiableMap(map);

<span class="hljs-comment">// Guava方式</span>
ImmutableMap&lt;String, Integer&gt; immutableMap = ImmutableMap.of(
    <span class="hljs-string">"A"</span>, <span class="hljs-number">1</span>,
    <span class="hljs-string">"B"</span>, <span class="hljs-number">2</span>,
    <span class="hljs-string">"C"</span>, <span class="hljs-number">3</span>
);
</code></pre>
<p><strong>场景：字符串分割并处理空白</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// JDK方式</span>
<span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">"a,b,,c, ,d"</span>;
String[] parts = str.split(<span class="hljs-string">","</span>);
List&lt;String&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
<span class="hljs-keyword">for</span> (String part : parts) {
    <span class="hljs-type">String</span> <span class="hljs-variable">trimmed</span> <span class="hljs-operator">=</span> part.trim();
    <span class="hljs-keyword">if</span> (!trimmed.isEmpty()) {
        result.add(trimmed);
    }
}

<span class="hljs-comment">// Guava方式</span>
List&lt;String&gt; result = Splitter.on(<span class="hljs-string">','</span>)
    .trimResults()
    .omitEmptyStrings()
    .splitToList(str);
</code></pre>
<h4 data-id="heading-24">6.2 性能对比</h4>
<p>Guava在很多场景下性能优于JDK：</p>
<p><strong>ImmutableMap vs HashMap：</strong></p>
<ul>
<li>内存占用：ImmutableMap更少（优化的数据结构）</li>
<li>访问速度：ImmutableMap略快（无锁开销）</li>
<li>线程安全：ImmutableMap无需同步</li>
</ul>
<p><strong>Splitter vs String.split()：</strong></p>
<ul>
<li>复用性：Splitter可复用，避免重复编译正则</li>
<li>灵活性：Splitter支持链式配置</li>
</ul>
<h3 data-id="heading-25">七、生产实战案例</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fdb0964b50b46c9bca930d1758505d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766191044&amp;x-signature=h06UNGgjzj8nbq%2BGYl%2FhlPUVmiE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-26">案例一：CSV文件解析</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CsvParser</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Splitter</span> <span class="hljs-variable">CSV_SPLITTER</span> <span class="hljs-operator">=</span> Splitter.on(<span class="hljs-string">','</span>)
        .trimResults()
        .omitEmptyStrings();

    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">parseCsvFile</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> IOException {
        List&lt;User&gt; users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(filePath))) {
            <span class="hljs-comment">// 跳过标题行</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">header</span> <span class="hljs-operator">=</span> reader.readLine();

            String line;
            <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) {
                List&lt;String&gt; fields = CSV_SPLITTER.splitToList(line);

                <span class="hljs-keyword">if</span> (fields.size() &gt;= <span class="hljs-number">3</span>) {
                    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
                    user.setName(fields.get(<span class="hljs-number">0</span>));
                    user.setAge(Integer.parseInt(fields.get(<span class="hljs-number">1</span>)));
                    user.setEmail(fields.get(<span class="hljs-number">2</span>));
                    users.add(user);
                }
            }
        }

        <span class="hljs-keyword">return</span> users;
    }
}
</code></pre>
<h4 data-id="heading-27">案例二：配置文件解析</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigLoader</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Splitter.<span class="hljs-type">MapSplitter</span> <span class="hljs-variable">CONFIG_SPLITTER</span> <span class="hljs-operator">=</span>
        Splitter.on(<span class="hljs-string">'\n'</span>)
            .trimResults()
            .omitEmptyStrings()
            .withKeyValueSeparator(<span class="hljs-string">'='</span>);

    <span class="hljs-keyword">public</span> ImmutableMap&lt;String, String&gt; <span class="hljs-title function_">loadConfig</span><span class="hljs-params">(String configText)</span> {
        <span class="hljs-comment">// 移除注释行</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">cleanedConfig</span> <span class="hljs-operator">=</span> Splitter.on(<span class="hljs-string">'\n'</span>)
            .splitToStream(configText)
            .filter(line -&gt; !line.trim().startsWith(<span class="hljs-string">"#"</span>))
            .collect(Collectors.joining(<span class="hljs-string">"\n"</span>));

        <span class="hljs-keyword">return</span> ImmutableMap.copyOf(CONFIG_SPLITTER.split(cleanedConfig));
    }
}
</code></pre>
<h4 data-id="heading-28">案例三：生成缓存Key</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheKeyGenerator</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Joiner</span> <span class="hljs-variable">KEY_JOINER</span> <span class="hljs-operator">=</span> Joiner.on(<span class="hljs-string">':'</span>).skipNulls();

    <span class="hljs-comment">// 生成用户缓存键</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateUserKey</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-keyword">return</span> KEY_JOINER.join(<span class="hljs-string">"user"</span>, userId);
        <span class="hljs-comment">// "user:12345"</span>
    }

    <span class="hljs-comment">// 生成订单缓存键</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateOrderKey</span><span class="hljs-params">(String userId, String orderId)</span> {
        <span class="hljs-keyword">return</span> KEY_JOINER.join(<span class="hljs-string">"order"</span>, userId, orderId);
        <span class="hljs-comment">// "order:user123:order456"</span>
    }

    <span class="hljs-comment">// 生成商品缓存键（带分类）</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateProductKey</span><span class="hljs-params">(String category, String productId)</span> {
        <span class="hljs-keyword">return</span> KEY_JOINER.join(<span class="hljs-string">"product"</span>, category, productId);
        <span class="hljs-comment">// "product:electronics:prod789"</span>
    }
}
</code></pre>
<h3 data-id="heading-29">八、最佳实践与注意事项</h3>
<h4 data-id="heading-30">8.1 Splitter和Joiner复用</h4>
<p>Splitter和Joiner是不可变的，应该声明为静态常量复用：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Constants</span> {
    <span class="hljs-comment">// 推荐：声明为静态常量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Splitter</span> <span class="hljs-variable">COMMA_SPLITTER</span> <span class="hljs-operator">=</span> Splitter.on(<span class="hljs-string">','</span>)
        .trimResults()
        .omitEmptyStrings();

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Joiner</span> <span class="hljs-variable">COMMA_JOINER</span> <span class="hljs-operator">=</span> Joiner.on(<span class="hljs-string">','</span>).skipNulls();

    <span class="hljs-comment">// 不推荐：每次都创建新实例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">badExample</span><span class="hljs-params">(String str)</span> {
        List&lt;String&gt; parts = Splitter.on(<span class="hljs-string">','</span>).splitToList(str);  <span class="hljs-comment">// 每次创建</span>
    }
}
</code></pre>
<h4 data-id="heading-31">8.2 ImmutableMap的大小限制</h4>
<p>ImmutableMap.of()最多支持5个键值对，超过需要使用Builder：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误：超过5个键值对会编译错误</span>
ImmutableMap&lt;String, Integer&gt; map = ImmutableMap.of(
    <span class="hljs-string">"A"</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"B"</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"C"</span>, <span class="hljs-number">3</span>, <span class="hljs-string">"D"</span>, <span class="hljs-number">4</span>, <span class="hljs-string">"E"</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"F"</span>, <span class="hljs-number">6</span>  <span class="hljs-comment">// 编译错误</span>
);

<span class="hljs-comment">// 正确：使用Builder</span>
ImmutableMap&lt;String, Integer&gt; map = ImmutableMap.&lt;String, Integer&gt;builder()
    .put(<span class="hljs-string">"A"</span>, <span class="hljs-number">1</span>)
    .put(<span class="hljs-string">"B"</span>, <span class="hljs-number">2</span>)
    .put(<span class="hljs-string">"C"</span>, <span class="hljs-number">3</span>)
    .put(<span class="hljs-string">"D"</span>, <span class="hljs-number">4</span>)
    .put(<span class="hljs-string">"E"</span>, <span class="hljs-number">5</span>)
    .put(<span class="hljs-string">"F"</span>, <span class="hljs-number">6</span>)
    .build();
</code></pre>
<h4 data-id="heading-32">8.3 BiMap的值唯一性</h4>
<p>BiMap要求值必须唯一，重复会抛异常：</p>
<pre><code class="hljs language-java" lang="java">BiMap&lt;String, Integer&gt; map = HashBiMap.create();
map.put(<span class="hljs-string">"A"</span>, <span class="hljs-number">1</span>);
map.put(<span class="hljs-string">"B"</span>, <span class="hljs-number">1</span>);  <span class="hljs-comment">// 抛出IllegalArgumentException</span>

<span class="hljs-comment">// 使用forcePut强制替换</span>
map.forcePut(<span class="hljs-string">"B"</span>, <span class="hljs-number">1</span>);  <span class="hljs-comment">// A被移除，B映射到1</span>
</code></pre>
<h4 data-id="heading-33">8.4 Lists.transform()的视图特性</h4>
<p>transform()返回的是视图，不是新列表：</p>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; original = Lists.newArrayList(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>);
List&lt;String&gt; transformed = Lists.transform(original, String::toUpperCase);

<span class="hljs-comment">// 修改原列表会影响视图</span>
original.set(<span class="hljs-number">0</span>, <span class="hljs-string">"x"</span>);
System.out.println(transformed.get(<span class="hljs-number">0</span>));  <span class="hljs-comment">// "X"</span>

<span class="hljs-comment">// 如果需要独立的列表，应该复制</span>
List&lt;String&gt; independent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(transformed);
</code></pre>
<h3 data-id="heading-34">九、总结</h3>
<p>Guava工具库为Java开发提供了强大而优雅的解决方案：</p>
<p><strong>Map工具：</strong></p>
<ul>
<li>✅ ImmutableMap：线程安全的不可变映射</li>
<li>✅ BiMap：双向查找的映射</li>
<li>✅ Multimap：一键多值的便捷操作</li>
<li>✅ Table：双键映射的强大功能</li>
</ul>
<p><strong>List工具：</strong></p>
<ul>
<li>✅ ImmutableList：不可变列表</li>
<li>✅ Lists.partition()：批量处理的利器</li>
<li>✅ Lists.transform()：函数式转换</li>
</ul>
<p><strong>Splitter：</strong></p>
<ul>
<li>✅ 智能处理空白和null</li>
<li>✅ 链式API，代码更简洁</li>
<li>✅ MapSplitter解析键值对</li>
</ul>
<p><strong>Joiner：</strong></p>
<ul>
<li>✅ 优雅的字符串连接</li>
<li>✅ 灵活的null处理</li>
<li>✅ Map和集合的统一连接</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 Google MCP Toolbox for Databases 中引入 Elasticsearch 支持]]></title>    <link>https://juejin.cn/post/7583139562734567467</link>    <guid>https://juejin.cn/post/7583139562734567467</guid>    <pubDate>2025-12-13T01:29:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583139562734567467" data-draft-id="7583139562734551083" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 Google MCP Toolbox for Databases 中引入 Elasticsearch 支持"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-13T01:29:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 Google MCP Toolbox for Databases 中引入 Elasticsearch 支持
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T01:29:19.000Z" title="Sat Dec 13 2025 01:29:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fauthor%2Fenrico-zimuel" title="https://www.elastic.co/search-labs/author/enrico-zimuel" target="_blank" ref="nofollow noopener noreferrer">Enrico Zimuel</a> 及 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fauthor%2Flaurent-saint-felix" title="https://www.elastic.co/search-labs/author/laurent-saint-felix" target="_blank" ref="nofollow noopener noreferrer">Laurent Saint-Félix</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e01c6927ec064114996a85a6aecc8f63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766194159&amp;x-signature=PDK8Sb%2FSZcUhFnyNj4IY7iyGbzk%3D" alt="" loading="lazy"/></p>
<p>探索 Elasticsearch 支持现已在 Google MCP Toolbox for Databases 中可用，并利用 ES|QL 工具安全地将你的索引与任何 MCP 客户端集成。</p>
<p>动手体验 Elasticsearch：深入了解我们的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Felasticsearch-labs%3Ftab%3Dreadme-ov-file" title="https://github.com/elastic/elasticsearch-labs?tab=readme-ov-file" target="_blank" ref="nofollow noopener noreferrer">示例 notebooks</a>，开始<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fcloud%2Fcloud-trial-overview" title="https://www.elastic.co/cloud/cloud-trial-overview" target="_blank" ref="nofollow noopener noreferrer">免费的 cloud 试用</a>，或立即在你的<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F143747798" title="https://elasticstack.blog.csdn.net/article/details/143747798" target="_blank" ref="nofollow noopener noreferrer">本地机器</a>上试用 Elastic。</p>
<hr/>
<p>在本文中，我们将介绍如何将 Google MCP Toolbox 与 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Felasticsearch" title="https://github.com/elastic/elasticsearch" target="_blank" ref="nofollow noopener noreferrer">Elasticsearch</a> 一起使用，构建一个用于从 Elasticsearch 索引中提取信息的简单工具。</p>
<p>我们最近为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgoogleapis%2Fgenai-toolbox" title="https://github.com/googleapis/genai-toolbox" target="_blank" ref="nofollow noopener noreferrer">Google MCP Toolbox for Databases</a> 开源项目做出了贡献，新增了对 Elasticsearch 作为数据库的支持。</p>
<p>有了这个新功能，你现在可以使用 Google MCP Toolbox 连接到 Elasticsearch，并直接与你的数据进行 “对话”。</p>
<h2 data-id="heading-0">Elasticsearch</h2>
<p>我们需要运行一个 Elasticsearch 实例。你可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fcloud" title="https://www.elastic.co/cloud" target="_blank" ref="nofollow noopener noreferrer">Elastic Cloud</a> 上激活一个免费试用，或者使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F143747798" title="https://elasticstack.blog.csdn.net/article/details/143747798" target="_blank" ref="nofollow noopener noreferrer">start-local</a> 脚本在本地安装：</p>
<pre><code class="hljs language-sql" lang="sql">`curl <span class="hljs-operator">-</span>fsSL https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>elastic.co<span class="hljs-operator">/</span><span class="hljs-keyword">start</span><span class="hljs-operator">-</span><span class="hljs-keyword">local</span> <span class="hljs-operator">|</span> sh`AI写代码
</code></pre>
<p>这将会在你的电脑上安装 Elasticsearch 和 Kibana，并生成一个 API key，用于配置 Google MCP Toolbox。</p>
<p>API key 将作为前一个命令的输出显示，并存储在 elastic-start-local 文件夹中的 .env 文件里。</p>
<h2 data-id="heading-1">安装示例数据集</h2>
<p>安装完成后，你可以使用用户名 elastic 和由 start-local 脚本生成的密码登录 Kibana（存储在 .env 文件中）。</p>
<p>你可以安装 Kibana 中提供的 <strong>eCommerce orders</strong> 示例数据集。它包含一个名为 <strong>kibana_sample_data_ecommerce</strong> 的索引，其中包含来自一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fenterprise-search%2Fecommerce" title="https://www.elastic.co/enterprise-search/ecommerce" target="_blank" ref="nofollow noopener noreferrer">电商</a>网站的 4,675 个订单的信息。对于每个订单，我们有以下信息：</p>
<ul>
<li>客户信息（姓名、ID、出生日期、邮箱等）</li>
<li>订单日期</li>
<li>订单 ID</li>
<li>产品（所有产品的列表，包括价格、数量、ID、类别、折扣等）</li>
<li>SKU</li>
<li>总价（未含税、含税）</li>
<li>总数量</li>
<li>地理信息（城市、国家、大洲、位置、地区）</li>
</ul>
<p>要安装示例数据，请在 Kibana 中打开 <strong>Integrations</strong> 页面（在顶部搜索栏中搜索 “Integration”），并安装 “Sample Data”。更多细节请参考这里的文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2F%23gs-get-data-into-kibana%25E3%2580%2582" title="https://www.elastic.co/docs/explore-analyze/#gs-get-data-into-kibana%E3%80%82" target="_blank" ref="nofollow noopener noreferrer">www.elastic.co/docs/explor…</a></p>
<p>本文的目标是展示配置 Google MCP Toolbox 连接到 Elasticsearch，并使用自然语言与 <strong>kibana_sample_data_ecommerce</strong> 索引交互是多么简单。</p>
<h2 data-id="heading-2">Google MCP Toolbox</h2>
<p>Google MCP Toolbox 是一个开源的 MCP server，旨在让应用和 AI agents 能够安全、高效地与 databases 交互。该项目之前名为 “GenAI Toolbox for Databases”，在采用了对 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fnews%2Fmodel-context-protocol" title="https://www.anthropic.com/news/model-context-protocol" target="_blank" ref="nofollow noopener noreferrer">Model Context Protocol（MCP）</a>的完全兼容之后进行了重命名。它的目标是消除 agents 连接 databases 时传统上所需的繁重工作，通过在后台处理 connection pooling、authentication、observability 以及其他运维相关问题。</p>
<p>从核心来看，Toolbox 允许开发者定义可复用的高层 tools，用于封装 database 交互。这些 tools 随后可以被任何兼容 MCP 的 client（例如 AI agent）调用，而无需 client 实现底层的 SQL queries 或管理 database connections。这种方式大幅减少了构建具备 database 能力的 agents 所需的样板代码，使得只需几行应用逻辑就能集成高级的数据操作。一旦定义了一个 tool，它就可以在多个 agents、frameworks 或 languages 之间共享（Figure 1）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9779b900c344d15a007ba0354141d19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766194159&amp;x-signature=4iDMFzW%2B9h6g7SDk3SwcFswrlKw%3D" alt="" loading="lazy"/> 图 1：Google MCP Toolbox 的整体架构</p>
<h2 data-id="heading-3">如何安装 MCP Toolbox</h2>
<p>你可以使用以下命令在 Linux 上安装 MCP Toolbox server：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  <span class="hljs-built_in">export</span> VERSION=0.21.0
2.  curl -L -o toolbox https://storage.googleapis.com/genai-toolbox/v<span class="hljs-variable">$VERSION</span>/linux/amd64/toolbox
3.  <span class="hljs-built_in">chmod</span> +x toolbox

`AI写代码
</code></pre>
<p>如果你想在 macOS 或 Windows 上安装，可以按照这里详细说明的说明进行操作。</p>
<h2 data-id="heading-4">为 Elasticsearch 配置 Toolbox</h2>
<p>要为 Elasticsearch 配置 MCP Toolbox，我们需要创建一个 tools.yaml 文件，如下所示：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">`</span>

<span class="hljs-attr">1.  sources:</span>
<span class="hljs-attr">2.    my-cluster:</span>
<span class="hljs-attr">3.      kind:</span> <span class="hljs-string">elasticsearch</span>
<span class="hljs-attr">4.      addresses:</span>
<span class="hljs-number">5</span><span class="hljs-string">.</span>        <span class="hljs-bullet">-</span> <span class="hljs-string">http://localhost:9200</span>
<span class="hljs-attr">6.      apikey:</span> <span class="hljs-string">&lt;insert-here-api-key&gt;</span>

<span class="hljs-attr">8.  tools:</span>
<span class="hljs-attr">9.    customer-orders:</span>
<span class="hljs-attr">10.      kind:</span> <span class="hljs-string">elasticsearch-esql</span>
<span class="hljs-attr">11.      source:</span> <span class="hljs-string">my-cluster</span>
<span class="hljs-attr">12.      description:</span> <span class="hljs-string">Get</span> <span class="hljs-string">the</span> <span class="hljs-string">orders</span> <span class="hljs-string">made</span> <span class="hljs-string">by</span> <span class="hljs-string">a</span> <span class="hljs-string">customer</span> <span class="hljs-string">identified</span> <span class="hljs-string">by</span> <span class="hljs-string">name.</span>
<span class="hljs-attr">13.      query:</span> <span class="hljs-string">|</span>
<span class="hljs-number">14</span><span class="hljs-string">.</span>      	<span class="hljs-string">FROM</span> <span class="hljs-string">kibana_sample_data_ecommerce</span> <span class="hljs-string">|</span> <span class="hljs-string">WHERE</span> <span class="hljs-string">MATCH(customer_full_name,</span> <span class="hljs-string">?name,</span> {<span class="hljs-attr">"operator":</span> <span class="hljs-string">"AND"</span>}<span class="hljs-string">)</span>
<span class="hljs-attr">15.      parameters:</span>
<span class="hljs-attr">16.        - name:</span> <span class="hljs-string">name</span>
<span class="hljs-attr">17.          type:</span> <span class="hljs-string">string</span>
<span class="hljs-attr">18.          description:</span> <span class="hljs-string">The</span> <span class="hljs-string">customer</span> <span class="hljs-string">name.</span>

<span class="hljs-attr">20.  toolsets:</span>
<span class="hljs-attr">21.    elasticsearch-tools:</span>
<span class="hljs-number">22</span><span class="hljs-string">.</span>      <span class="hljs-bullet">-</span> <span class="hljs-string">customer-orders</span>

<span class="hljs-string">`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)</span>
</code></pre>
<p>你需要将 <strong/> 替换为有效的 Elasticsearch API key。如果你使用 start-local 在本地运行 Elasticsearch，可以在 start-local 生成的 .env 文件中找到该 API key，变量名为 <strong>ES_LOCAL_API_KEY</strong>。如果你使用 Elastic Cloud，可以按照<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fdeploy-manage%2Fapi-keys%2Felastic-cloud-api-keys" title="https://www.elastic.co/docs/deploy-manage/api-keys/elastic-cloud-api-keys" target="_blank" ref="nofollow noopener noreferrer">这里</a>描述的步骤生成 API key。</p>
<p>前面的 tools 包含以下用于 Elasticsearch 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2Fquery-filter%2Flanguages%2Fesql" title="https://www.elastic.co/docs/explore-analyze/query-filter/languages/esql" target="_blank" ref="nofollow noopener noreferrer">ES|QL</a> 查询：</p>
<pre><code class="hljs language-sql" lang="sql">`<span class="hljs-keyword">FROM</span> kibana_sample_data_ecommerce <span class="hljs-operator">|</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(customer_full_name, ?name)`AI写代码
</code></pre>
<p>如果你不熟悉 ES|QL，它是由 Elastic 开发的一种查询语言，类似于 SQL，可用于搜索一个或多个索引。你可以在<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql" title="https://www.elastic.co/docs/reference/query-languages/esql" target="_blank" ref="nofollow noopener noreferrer">官方文档</a>中了解更多关于 ES|QL 的信息。</p>
<p>上面的查询会搜索存储在 <strong>kibana_sample_data_ecommerce</strong> 索引中、包含指定客户姓名的所有订单，使用 <strong>?name</strong> 参数（问号表示参数）。</p>
<p>客户姓名在之前的 YAML 配置中定义，类型为 string，描述为 “The customer name”。</p>
<p>该工具可用于回答有关客户订单的问题——例如：<em>How many orders did customer Foo place in October 2025?</em></p>
<p>工具及其参数的描述对于从用户的自然语言请求中提取相关信息至关重要。此提取通过 Large Language Model (LLM) 的 <strong>function-calling</strong> 功能来执行。在实际操作中，LLM 可以确定需要执行哪个函数（工具）以获取所需信息，以及该函数的适当参数。</p>
<p>关于 function calls 的更多信息，我们建议阅读 Ashish Tiwari 撰写的 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F139544698" title="https://elasticstack.blog.csdn.net/article/details/139544698" target="_blank" ref="nofollow noopener noreferrer">OpenAI function calling with Elasticsearch</a> 文章。</p>
<h2 data-id="heading-5">运行 Toolbox server</h2>
<p>你可以使用前面的 tools.yaml 文件通过以下命令运行 MCP Toolbox：</p>
<pre><code class="hljs language-css" lang="css">`./toolbox <span class="hljs-attr">--tools-file</span> tools<span class="hljs-selector-class">.yaml</span> <span class="hljs-attr">--ui</span>`AI写代码
</code></pre>
<p>–ui 参数会在 <a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A5000%2Fui" title="http://127.0.0.1:5000/ui" target="_blank" ref="nofollow noopener noreferrer">http://127.0.0.1:5000/ui</a> 运行一个 web 应用（图 2）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dd43507748f45aab3c0ed9e65a95c1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766194159&amp;x-signature=uGs91kN62hLnxT91a8DIHLtogas%3D" alt="" loading="lazy"/> 图 2：MCP Toolbox UI</p>
<p>你可以选择 Tools &gt; customer-orders，并在参数 name 中输入客户姓名（例如 Gwen Sanders），然后点击 Run Tool 按钮。你应该会看到如图 3 所示的 JSON 响应。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86fda6be990f4b9a930e9b0ce3264dfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766194159&amp;x-signature=G9udZciatj%2FVS%2B37BLO3gvQUgAI%3D" alt="" loading="lazy"/> 图 3：使用 name 值 “Gwen” 执行 customer-orders 工具的结果</p>
<p>设置完成后，MCP Toolbox 可以执行 <strong>customer-orders</strong> 工具，与 Elasticsearch 通信并运行 ES|QL 查询。</p>
<h2 data-id="heading-6">使用 MCP Toolbox 与 Gemini CLI</h2>
<p>我们可以使用任何 MCP client 与 MCP Toolbox for Databases 进行通信。例如，我们可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgoogle-gemini%2Fgemini-cli" title="https://github.com/google-gemini/gemini-cli" target="_blank" ref="nofollow noopener noreferrer">Gemini CLI</a>，这是一款用于使用 Gemini 的命令行工具。你可以按照<a href="https://link.juejin.cn?target=https%3A%2F%2Fgeminicli.com%2Fdocs%2Fget-started%2Finstallation%2F" title="https://geminicli.com/docs/get-started/installation/" target="_blank" ref="nofollow noopener noreferrer">这里</a>的说明安装 Gemini CLI。</p>
<p>Gemini CLI 提供了一个为 MCP Toolbox 预配置的扩展，位于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgemini-cli-extensions%2Fmcp-toolbox" title="https://github.com/gemini-cli-extensions/mcp-toolbox" target="_blank" ref="nofollow noopener noreferrer">gemini-cli-extensions/mcp-toolbox</a>。你可以通过运行以下命令安装此扩展：</p>
<pre><code class="hljs language-arduino" lang="arduino">`gemini extensions install https:<span class="hljs-comment">//github.com/gemini-cli-extensions/mcp-toolbox`AI写代码</span>
</code></pre>
<p>安装完成后，你需要进入存放 MCP Toolbox tools.yaml 配置文件的目录，并按如下方式执行 Gemini CLI（此步骤是为了让 Gemini CLI 自动配置 MCP Toolbox）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`gemini`</span>AI写代码
</code></pre>
<p>你应该会看到如图 4 所示的输出：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f68e53e89804cf5a92b7126c13e9357~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766194159&amp;x-signature=D%2FaJ4MvJvCUd4ClM%2FcyRSDFZDsQ%3D" alt="" loading="lazy"/> 图 4：Gemini CLI 终端</p>
<p>你可以使用以下命令检查 MCP Toolbox 是否已连接：</p>
<pre><code class="hljs language-bash" lang="bash">`/mcp list`AI写代码
</code></pre>
<p>你应该会看到 mcp_toolbox 及其列出的 customer-orders 工具（图 5）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99ec3fbc9fb64de791bcef4d4adc008d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766194159&amp;x-signature=BdMW9Pe26A8MzUrEFPcOECOX7U0%3D" alt="" loading="lazy"/></p>
<p>如果 MCP Toolbox 已连接到 Gemini CLI，我们现在可以尝试提出一些问题，例如：“Give me the orders for the customer Gwen Sanders.” 然后 Gemini CLI 会请求执行来自 mcp_toolbox server 的 customer-orders 工具的权限（见图 6）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab36fae23e534de5b268cf91c53fc2fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766194159&amp;x-signature=GU4QqI6u2Rv7SvI46n9oE8wA3nA%3D" alt="" loading="lazy"/> 图 6：执行 customer-orders 工具的权限请求</p>
<p>确认后，Gemini CLI 会向 MCP Toolbox 执行请求，得到 JSON 响应作为结果，并用它来格式化响应（图 7）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a11aa5f9065f48b9b022501b37c873be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766194159&amp;x-signature=Ipp2rAcq8b%2F5SlJ1C%2BvFd2K9Gog%3D" alt="" loading="lazy"/> 图 7：来自 MCP Toolbox 的响应以及 Gemini CLI 的最终响应</p>
<p>来自 Gemini CLI 的响应会显示 Gwen Sanders 只下了一笔包含 2 个产品的订单，总价为 132 euros。</p>
<h2 data-id="heading-7">MCP Toolbox SDKs</h2>
<p>Google MCP Toolbox 还提供了 SDK，可从用 Go、Python 和 Javascript 编写的程序访问所有功能。</p>
<p>例如，Python SDK 可在 Github 上的以下页面获取：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgoogleapis%2Fmcp-toolbox-sdk-python%25E3%2580%2582" title="https://github.com/googleapis/mcp-toolbox-sdk-python%E3%80%82" target="_blank" ref="nofollow noopener noreferrer">github.com/googleapis/…</a></p>
<p>我们需要创建一个简单的 agent 来连接 MCP Toolbox。需要安装以下包：</p>
<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  pip install toolbox-core
<span class="hljs-bullet">2.</span>  pip install google-adk

`AI写代码
</code></pre>
<p>并使用以下命令创建一个新的 agent 项目：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`adk create my_agent`</span>AI写代码
</code></pre>
<p>这将创建一个名为 my_agent 的新目录，其中包含一个文件 agent.py。</p>
<p>使用以下内容更新 my_agent/agent.py 以连接 Toolbox：</p>
<pre><code class="hljs language-ini" lang="ini">`

1.  from google.adk import Agent
2.  from google.adk.apps import App
3.  from toolbox_core import ToolboxSyncClient

<span class="hljs-attr">5.  client</span> = ToolboxSyncClient(<span class="hljs-string">"http://127.0.0.1:5000"</span>)

<span class="hljs-attr">7.  root_agent</span> = Agent(
<span class="hljs-attr">8.      name</span>=<span class="hljs-string">'root_agent'</span>,
<span class="hljs-attr">9.      model</span>=<span class="hljs-string">'gemini-2.5-flash'</span>,
<span class="hljs-attr">10.      instruction</span>=<span class="hljs-string">"You are a helpful AI assistant designed to search information about a dataset of ecommerce orders."</span>,
<span class="hljs-attr">11.      tools</span>=client.load_toolset(),
12.  )

<span class="hljs-attr">14.  app</span> = App(root_agent=root_agent, )

`AI写代码!<span class="hljs-section">[]</span>(https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>创建一个包含你的 Google API key 的 .env 文件：</p>
<pre><code class="hljs language-bash" lang="bash">`<span class="hljs-built_in">echo</span> <span class="hljs-string">'GOOGLE_API_KEY="YOUR_API_KEY"'</span> &gt; my_agent/.env`AI写代码
</code></pre>
<p>最后，我们可以运行 agent 并观察结果。要执行 agent，你可以运行以下命令：</p>
<pre><code class="hljs language-arduino" lang="arduino">`adk run my_agent`AI写代码
</code></pre>
<p>或者，你可以通过 web 界面来运行它：</p>
<pre><code class="hljs language-css" lang="css">`adk web <span class="hljs-attr">--port</span> <span class="hljs-number">8000</span>`AI写代码
</code></pre>
<p>在这两种情况下，你都可以使用问答界面与 MCP Toolbox 交互。例如，你可以提出之前的问题：Give me the orders of the customer Gwen Sanders。</p>
<p>有关不同 SDK 的更多信息，你可以参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fgoogleapis.github.io%2Fgenai-toolbox%2Fsdks%2F" title="https://googleapis.github.io/genai-toolbox/sdks/" target="_blank" ref="nofollow noopener noreferrer">此文档页面</a>。</p>
<h2 data-id="heading-8">结论</h2>
<p>在本文中，我们演示了 Google MCP Toolbox for Databases 的 Elasticsearch 集成。通过一个简单的 YAML 配置文件，我们可以定义一组工具，将自然语言问题转换为使用 ES|QL 语言的 Elasticsearch 查询。</p>
<p>我们展示了如何与 kibana_sample_data_ecommerce 数据集交互，该数据集包含来自一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fenterprise-search%2Fecommerce" title="https://www.elastic.co/enterprise-search/ecommerce" target="_blank" ref="nofollow noopener noreferrer">电商</a>网站的订单。使用这个配置文件，我们只需运行 MCP Toolbox server，就可以从任何 MCP client 连接到它。</p>
<p>最后，我们演示了如何使用 Gemini CLI 作为客户端连接到 MCP Toolbox for Databases，并查询存储在 Elasticsearch 中的电商数据。我们执行了一个自然语言查询，以检索特定客户（通过姓名标识）的订单信息。</p>
<p>随着 MCP 生态系统的不断发展，这种模式——轻量级工具定义，依托安全、生产就绪的基础设施——为构建越来越强大、具备数据感知能力的 agents 提供了新的机会，且几乎无需额外工作。无论你是在本地使用 Elastic 的示例数据集进行实验，还是将搜索功能集成到更大的应用中，MCP Toolbox 都为使用自然语言与 Elasticsearch 数据交互提供了可靠且可扩展的基础。</p>
<p>有关 agentic AI 应用开发的更多信息，你可以阅读 Anish Mathur 和 Dana Juratoni 撰写的 使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F152024448" title="https://elasticstack.blog.csdn.net/article/details/152024448" target="_blank" ref="nofollow noopener noreferrer">Elasticsearch 构建 AI Agentic 工作流程</a> 文章。</p>
<p>有关 Google MCP Toolbox 的更多信息，你可以访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgoogleapis.github.io%2Fgenai-toolbox%2Fgetting-started%2Fintroduction%2F%25E3%2580%2582" title="https://googleapis.github.io/genai-toolbox/getting-started/introduction/%E3%80%82" target="_blank" ref="nofollow noopener noreferrer">googleapis.github.io/genai-toolb…</a></p>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fblog%2Fgoogle-mcp-toolbox-elasticsearch-support" title="https://www.elastic.co/search-labs/blog/google-mcp-toolbox-elasticsearch-support" target="_blank" ref="nofollow noopener noreferrer">www.elastic.co/search-labs…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 18并发渲染实战：5个核心API让你的应用性能飙升50%]]></title>    <link>https://juejin.cn/post/7582783931164426275</link>    <guid>https://juejin.cn/post/7582783931164426275</guid>    <pubDate>2025-12-13T04:17:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582783931164426275" data-draft-id="7582844980399226920" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 18并发渲染实战：5个核心API让你的应用性能飙升50%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-13T04:17:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 18并发渲染实战：5个核心API让你的应用性能飙升50%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T04:17:24.000Z" title="Sat Dec 13 2025 04:17:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>React 18并发渲染实战：5个核心API让你的应用性能飙升50%</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>React 18的发布标志着React生态正式迈入了并发渲染（Concurrent Rendering）时代。这一重大升级不仅带来了更流畅的用户体验，还为开发者提供了强大的工具来优化应用性能。据统计，合理使用React 18的并发特性可以让应用性能提升高达50%。本文将深入解析React 18的5个核心API，并通过实战案例展示如何利用它们实现性能飞跃。</p>
<h3 data-id="heading-2">什么是并发渲染？</h3>
<p>并发渲染是React 18的核心特性，它允许React在渲染过程中中断和恢复工作，从而优先处理高优先级的任务（如用户交互），避免界面卡顿。这与传统的同步渲染模式有本质区别：同步渲染必须一次性完成所有工作，而并发渲染则更加灵活，能够更好地利用浏览器的主线程资源。</p>
<h3 data-id="heading-3">5个核心API解析与实战</h3>
<h4 data-id="heading-4">1. <code>createRoot</code>：启用并发模式的第一步</h4>
<p>在React 18中，传统的<code>ReactDOM.render</code>被新的<code>createRoot</code> API取代。这是启用并发渲染的基础步骤。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>;

<span class="hljs-keyword">const</span> root = <span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>));
root.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>);
</code></pre>
<p><strong>为什么重要？</strong></p>
<ul>
<li><code>createRoot</code>是并发渲染的入口，只有通过它创建的根节点才能享受并发特性。</li>
<li>与旧版<code>render</code>相比，<code>createRoot</code>提供了更细粒度的控制能力，例如支持批量更新和优先级调度。</li>
</ul>
<h4 data-id="heading-5">2. <code>startTransition</code>：区分紧急与非紧急更新</h4>
<p><code>startTransition</code>是React 18中用于标记非紧急更新的API。通过它，开发者可以明确告诉React哪些更新可以延迟执行，从而确保高优先级任务（如用户输入）不被阻塞。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { startTransition, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchBox</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [input, setInput] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [results, setResults] = <span class="hljs-title function_">useState</span>([]);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; {
    <span class="hljs-title function_">setInput</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>); <span class="hljs-comment">// 紧急更新：立即反映用户输入</span>
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">fetchResults</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>).<span class="hljs-title function_">then</span>(setResults); <span class="hljs-comment">// 非紧急更新：延迟执行</span>
    });
  };

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{input}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span> /&gt;</span></span>;
}
</code></pre>
<p><strong>性能提升点：</strong></p>
<ul>
<li>用户输入不再因为后端请求而卡顿。</li>
<li>React会在浏览器空闲时处理过渡任务，显著提升交互流畅度。</li>
</ul>
<h4 data-id="heading-6">3. <code>useDeferredValue</code>：延迟派生值的更新</h4>
<p><code>useDeferredValue</code>是一个Hook，用于延迟某个值的更新，直到更重要的任务完成后再处理。它是优化派生状态（如搜索结果的过滤）的强大工具。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useDeferredValue, useMemo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ResultsList</span>(<span class="hljs-params">{ query }</span>) {
  <span class="hljs-keyword">const</span> deferredQuery = <span class="hljs-title function_">useDeferredValue</span>(query);
  <span class="hljs-keyword">const</span> results = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">filterResults</span>(deferredQuery), [deferredQuery]);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">List</span> <span class="hljs-attr">items</span>=<span class="hljs-string">{results}</span> /&gt;</span></span>;
}
</code></pre>
<p><strong>适用场景：</strong></p>
<ul>
<li>当计算密集型操作（如大型列表过滤）可能阻塞主线程时。</li>
<li><code>deferredQuery</code>会在高优先级任务完成后自动更新，确保界面响应性。</li>
</ul>
<h4 data-id="heading-7">4. <code>&lt;Suspense&gt;</code> + <code>lazy</code>：更智能的代码拆分与加载状态管理</h4>
<p>虽然<code>Suspense</code>和<code>lazy</code>在React之前版本中就已存在，但在React 18中它们的表现更加出色，尤其是在并发模式下：</p>
<ul>
<li><code>&lt;Suspense&gt;</code>现在可以嵌套使用，并支持更精细的回退（fallback）控制。</li>
<li><code>lazy</code>组件加载时可以与其他并发任务协调工作。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyComponent</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./HeavyComponent'</span>));

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Spinner</span> /&gt;</span>}&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">LazyComponent</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>优化效果：</strong></p>
<ul>
<li>减少首屏加载时间，提升LCP（最大内容绘制）指标。</li>
<li>React会优先渲染已准备好的内容，避免“全有或全无”的加载问题。</li>
</ul>
<h4 data-id="heading-8">5. <code>useId</code>：解决SSR中的Hydration不匹配问题</h4>
<p>在服务器端渲染（SSR）中，客户端和服务器的ID生成不一致可能导致Hydration错误。<code>useId</code>提供了一种稳定的ID生成机制：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Checkbox</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> id = <span class="hljs-title function_">useId</span>();
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">{id}</span>&gt;</span>Accept terms<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">{id}</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
);
}
</code></pre>
<p><strong>为什么需要它？</strong></p>
<ul>
<li>SSR应用中常见的“Warning: Text content did not match”问题通常源于动态ID的不一致。</li>
<li><code>useId</code>生成的ID在服务端和客户端保持一致，彻底解决此类问题。</li>
</ul>
<h3 data-id="heading-9">实战案例：优化一个大型数据表</h3>
<p>假设我们有一个需要渲染10,000行数据的表格。传统同步模式下，用户可能会遇到明显的卡顿；而通过并发特性改造后：</p>
<ol>
<li><strong>使用<code>startTransition</code>延迟排序/筛选操作</strong>：确保滚动和点击等高优先级交互不被阻塞。</li>
<li><strong>结合<code>useDeferredValue</code>优化派生状态</strong>：仅在浏览器空闲时更新过滤后的数据。</li>
<li><strong>虚拟滚动 + <code>&lt;Suspense&gt;</code>分块加载</strong>：按需渲染可见区域的行数据。</li>
</ol>
<p>改造后的性能对比：</p>
<ul>
<li><strong>首次加载时间减少40%</strong>（得益于代码拆分和分块Hydration）。</li>
<li><strong>交互延迟降低50%以上</strong>（通过优先级调度避免主线程阻塞）。</li>
</ul>
<h3 data-id="heading-10">React并发模式的底层原理</h3>
<p>为了更好地理解这些API的工作原理，我们需要简要探讨Fiber架构和调度器（Scheduler）的实现：</p>
<ol>
<li><strong>Fiber节点的可中断性</strong>：每个Fiber节点代表一个工作单元，React可以暂停或恢复其渲染。</li>
<li><strong>基于优先级的调度</strong>：
<ul>
<li>Immediate（立即执行）：如用户输入。</li>
<li>Default（默认）：普通UI更新。</li>
<li>Transition（过渡）：可中断的低优先级任务。</li>
</ul>
</li>
<li><strong>时间切片（Time Slicing）</strong>：将长任务拆分为多个5ms的小块执行。</li>
</ol>
<p>###注意事项与最佳实践</p>
<p>尽管并发模式强大但并非银弹：</p>
<ol>
<li><strong>逐步采用策略</strong>：
-先通过部分路由或组件试用新特性。
-使用StrictMode检测潜在问题。</li>
<li><strong>性能监控必不可少</strong>
-关注TBT(总阻塞时间)和INP(交互到下一次绘制)指标。</li>
</ol>
<p>3.<strong>避免过度优化</strong>
-对简单组件可能引入不必要的复杂性。</p>
<p>###总结</p>
<p>从传统同步模式到现代Web应用的流畅体验之间隔着一道巨大的鸿沟——而React18提供的这5个核心API正是跨越它的桥梁：</p>
<p>1.createRoot开启新时代的大门；
2.startTransition划分任务的轻重缓急；
3.useDeferredValue让派生状态优雅降级；
4.Suspense家族统一异步处理的用户体验；
5.useId解决SSR中的顽疾。</p>
<p>当你将这些工具组合使用时甚至可以实现超过50%的性能提升——这不仅是一个数字更是用户体验质的飞跃。</p>
<p>未来随着更多框架(如Next.js)深度整合这些特性我们有理由相信:2024年将成为真正意义上的"Web应用高性能元年"。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jackson序列化让验签失败？破解JSON转义陷阱]]></title>    <link>https://juejin.cn/post/7582815307439882291</link>    <guid>https://juejin.cn/post/7582815307439882291</guid>    <pubDate>2025-12-13T04:26:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582815307439882291" data-draft-id="7582809606067781658" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jackson序列化让验签失败？破解JSON转义陷阱"/> <meta itemprop="keywords" content="后端,Java,面试"/> <meta itemprop="datePublished" content="2025-12-13T04:26:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="9号达人"/> <meta itemprop="url" content="https://juejin.cn/user/2450136052270077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jackson序列化让验签失败？破解JSON转义陷阱
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2450136052270077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    9号达人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T04:26:32.000Z" title="Sat Dec 13 2025 04:26:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在开发过程中遇到了一个的挺有意思的验签问题。我们的项目采用了前后端签名验证机制来保证数据安全：</p>
<ul>
<li><strong>前端</strong>：请求时对 body 进行签名</li>
<li><strong>后端</strong>：接收后对 body 进行验签</li>
</ul>
<p>正常情况下都没啥问题，但这次比较奇怪：</p>
<ol>
<li>后端接口 A 返回了一个对象，其中某个字段是 <strong>JSON 字符串</strong>（String 类型）</li>
<li>前端拿到这个对象后，会把这个json字符串原模原样的作为参数传给后端接口 B</li>
<li>然后就。。。验签失败了</li>
</ol>
<p>我们就陷入了互相甩锅的局面：</p>
<ul>
<li><strong>后端</strong>认为：前端验签时做了特殊处理</li>
<li><strong>前端</strong>很无辜：用的是公共库，从没改过</li>
<li><strong>折中共识</strong>：可能是 HTTP 传输过程中对 JSON 做了转义</li>
</ul>
<p>经过一番调试发现：</p>
<ul>
<li>前端验签时，JSON 字符串字段有<strong>一次转义字符</strong>（如 <code>"</code>)</li>
<li>后端收到的 body 中，JSON 字符串字段有<strong>二次转义字符</strong>（如 <code>\"</code>)</li>
</ul>
<p>双方验签的数据不一致，自然验证失败。</p>
<p>临时方案：对这个字段做 Base64 编码，绕过转义问题。</p>
<p>但事实真的是 HTTP 传输导致的转义吗？<strong>当然不是</strong></p>
<p><strong>HTTP 请求本身不会对数据进行转义</strong>。那转义字符是从哪里来的？</p>
<h3 data-id="heading-0">问题根源</h3>
<p>整个流程是这样的：</p>
<h4 data-id="heading-1">第一步：后端接口 A 返回数据（第一次序列化）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 后端返回的对象</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Response</span> {
    <span class="hljs-keyword">private</span> String <span class="hljs-keyword">data</span>;  <span class="hljs-comment">// 这里存储的是 JSON 字符串</span>
}

<span class="hljs-comment">// 接口 A 返回数据</span>
<span class="hljs-keyword">return</span> new Response(<span class="hljs-string">"{"</span>name<span class="hljs-string">":"</span>张三<span class="hljs-string">","</span>age<span class="hljs-string">":25}"</span>);
</code></pre>
<p>Spring Boot 在响应时会自动进行 JSON 序列化，由于 <code>data</code> 字段本身是字符串，会对其中的特殊字符进行转义：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{"</span>name<span class="hljs-string">":"</span>张三<span class="hljs-string">","</span>age<span class="hljs-string">":25}"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-2">第二步：前端验签（基于一次转义的数据）</h4>
<p>前端拿到响应后，对整个对象进行验签：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端收到的数据</span>
<span class="hljs-keyword">const</span> response = {
  <span class="hljs-attr">data</span>: <span class="hljs-string">"{"</span>name<span class="hljs-string">":"</span>张三<span class="hljs-string">","</span>age<span class="hljs-string">":25}"</span>  <span class="hljs-comment">// 带有一次转义</span>
};

<span class="hljs-comment">// 对这个对象做验签</span>
<span class="hljs-keyword">const</span> signature = <span class="hljs-title function_">sign</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(response));
</code></pre>
<p>此时验签的原始数据包含<strong>一次转义字符</strong>。</p>
<h4 data-id="heading-3">第三步：前端请求接口 B（第二次序列化）</h4>
<p>前端将这个对象作为 body 请求接口 B：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 将对象发送给接口 B</span>
axios.<span class="hljs-built_in">post</span>(<span class="hljs-string">'/api/b'</span>, response);
</code></pre>
<p>浏览器或 HTTP 库会再次对 body 进行 JSON 序列化，JSON 字符串又会被转义一次：</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"data"</span>: <span class="hljs-string">"{<span class="hljs-subst">\"</span>name<span class="hljs-subst">\"</span>:<span class="hljs-subst">\"</span>张三<span class="hljs-subst">\"</span>,<span class="hljs-subst">\"</span>age<span class="hljs-subst">\"</span>:25}"</span>
}
</code></pre>
<p>注意：<code>"</code> 变成了 <code>\"</code>（二次转义）</p>
<h4 data-id="heading-4">第四步：后端接口 B 验签（基于二次转义的数据）</h4>
<p>后端收到请求后，拿到的是经过<strong>二次转义</strong>的数据进行验签：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 后端收到的 body（二次转义）</span>
<span class="hljs-type">String</span> body <span class="hljs-operator">=</span> <span class="hljs-string">"{<span class="hljs-subst">\"</span>name<span class="hljs-subst">\"</span>:<span class="hljs-subst">\"</span>张三<span class="hljs-subst">\"</span>,<span class="hljs-subst">\"</span>age<span class="hljs-subst">\"</span>:25}"</span>;

<span class="hljs-comment">// 验签失败！因为转义字符数量不一致</span>
</code></pre>
<h3 data-id="heading-5">为什么验签会失败？</h3>
<ul>
<li><strong>前端验签</strong>：基于一次转义的数据 <code>{"name":...}</code></li>
<li><strong>后端验签</strong>：基于二次转义的数据 <code>{\"name\":...}</code></li>
</ul>
<p>两边计算签名的原始数据不一致，自然就验签失败了</p>
<h2 data-id="heading-6">最快的方案</h2>
<p><strong>不要在对象中嵌套 JSON 字符串，直接返回 JSON 对象</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误做法</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Response</span> {
    <span class="hljs-keyword">private</span> String <span class="hljs-keyword">data</span>;  <span class="hljs-comment">// JSON 字符串</span>
}

<span class="hljs-comment">// 正确做法</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Response</span> {
    <span class="hljs-keyword">private</span> UserInfo <span class="hljs-keyword">data</span>;  <span class="hljs-comment">// JSON 对象</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInfo</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Integer age;
}
</code></pre>
<p>这样 Spring Boot 只会进行一次序列化，不会产生转义字符，前后端处理的数据格式完全一致。</p>
<h2 data-id="heading-7">知己知彼</h2>
<p>既然找到了问题根源，正好就深入源码看看 Jackson 是如何对字符串进行序列化的。Spring Boot 默认使用 Jackson 作为 JSON 序列化框架。</p>
<h3 data-id="heading-8">序列化调用链路</h3>
<h4 data-id="heading-9">1. BeanSerializerBase - 对象序列化入口</h4>
<p>序列化一般会调用 <code>BeanSerializer</code>，其核心实现在 <code>BeanSerializerBase</code> 中：</p>
<pre><code class="hljs language-ini" lang="ini">protected void serializeFields(Object bean, JsonGenerator gen, SerializerProvider provider)
        throws IOException {
    final BeanPropertyWriter<span class="hljs-section">[]</span> props<span class="hljs-comment">;  // 对象的所有字段属性</span>
    if (_filteredProps != null &amp;&amp; provider.getActiveView() != null) {
        <span class="hljs-attr">props</span> = _filteredProps<span class="hljs-comment">;</span>
    } else {
        <span class="hljs-attr">props</span> = _props<span class="hljs-comment">;</span>
    }

    int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    try {
        // 遍历所有字段进行序列化
        for (final int <span class="hljs-attr">len</span> = props.length<span class="hljs-comment">; i &lt; len; ++i) {</span>
            BeanPropertyWriter <span class="hljs-attr">prop</span> = props[i]<span class="hljs-comment">;</span>
            if (prop != null) {
                prop.serializeAsField(bean, gen, provider)<span class="hljs-comment">;  // 关键调用</span>
            }
        }
        // ... 省略其他代码
    }
}
</code></pre>
<h4 data-id="heading-10">2. BeanPropertyWriter - 字段序列化处理</h4>
<p>每个字段会调用 <code>serializeAsField</code> 方法，根据字段类型选择对应的序列化器：</p>
<pre><code class="hljs language-ini" lang="ini">public void serializeAsField(Object bean, JsonGenerator gen, SerializerProvider prov)
        throws Exception {
    // 获取字段值
    final Object <span class="hljs-attr">value</span> = (_accessorMethod == null)
        ? _field.get(bean)
        : _accessorMethod.invoke(bean, (Object<span class="hljs-section">[]</span>) null)<span class="hljs-comment">;</span>

    // 处理 null 值
    if (<span class="hljs-attr">value</span> == null) {
        if (_nullSerializer != null) {
            gen.writeFieldName(_name)<span class="hljs-comment">;</span>
            _nullSerializer.serialize(null, gen, prov)<span class="hljs-comment">;</span>
        }
        return<span class="hljs-comment">;</span>
    }

    // 获取序列化器（关键：根据字段类型选择不同的序列化器）
    JsonSerializer&lt;Object&gt; <span class="hljs-attr">ser</span> = _serializer<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">ser</span> == null) {
        Class&lt;?&gt; <span class="hljs-attr">cls</span> = value.getClass()<span class="hljs-comment">;</span>
        PropertySerializerMap <span class="hljs-attr">m</span> = _dynamicSerializers<span class="hljs-comment">;</span>
        <span class="hljs-attr">ser</span> = m.serializerFor(cls)<span class="hljs-comment">;  // String 类型会返回 StringSerializer</span>
        if (<span class="hljs-attr">ser</span> == null) {
            <span class="hljs-attr">ser</span> = _findAndAddDynamic(m, cls, prov)<span class="hljs-comment">;</span>
        }
    }

    // 写入字段名和值
    gen.writeFieldName(_name)<span class="hljs-comment">;</span>
    ser.serialize(value, gen, prov)<span class="hljs-comment">;  // 调用具体的序列化器</span>
}
</code></pre>
<p><strong>核心要点</strong>：</p>
<ul>
<li>如果字段是对象，会递归调用 <code>BeanSerializer</code></li>
<li>如果字段是字符串，会调用 <code>StringSerializer</code></li>
</ul>
<h4 data-id="heading-11">3. StringSerializer</h4>
<p>当字段类型是 <code>String</code> 时，使用 <code>StringSerializer</code> 进行序列化：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object value, JsonGenerator gen, SerializerProvider provider)</span>
        <span class="hljs-keyword">throws</span> IOException {
    gen.writeString((String) value);  <span class="hljs-comment">// 调用 JsonGenerator 写入字符串</span>
}
</code></pre>
<h4 data-id="heading-12">4. UTF8JsonGenerator</h4>
<p>由于默认使用 UTF-8 编码，最终会调用 <code>UTF8JsonGenerator.writeString</code> 方法：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> void writeString(String text) throws IOException {
    <span class="hljs-keyword">this</span>._verifyValueWrite(<span class="hljs-string">"write a string"</span>);
    <span class="hljs-keyword">if</span> (text == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">this</span>._writeNull();
    } <span class="hljs-keyword">else</span> {
        int len = text.length();
        <span class="hljs-keyword">if</span> (len &gt; <span class="hljs-keyword">this</span>._outputMaxContiguous) {
            <span class="hljs-keyword">this</span>._writeStringSegments(text, <span class="hljs-literal">true</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._outputTail + len &gt;= <span class="hljs-keyword">this</span>._outputEnd) {
                <span class="hljs-keyword">this</span>._flushBuffer();
            }

            <span class="hljs-comment">// 添加开始引号</span>
            <span class="hljs-keyword">this</span>._outputBuffer[<span class="hljs-keyword">this</span>._outputTail++] = <span class="hljs-keyword">this</span>._quoteChar;

            <span class="hljs-comment">// 写入字符串内容（这里会对特殊字符进行转义！）</span>
            <span class="hljs-keyword">this</span>._writeStringSegment((String)text, <span class="hljs-number">0</span>, len);

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._outputTail &gt;= <span class="hljs-keyword">this</span>._outputEnd) {
                <span class="hljs-keyword">this</span>._flushBuffer();
            }

            <span class="hljs-comment">// 添加结束引号</span>
            <span class="hljs-keyword">this</span>._outputBuffer[<span class="hljs-keyword">this</span>._outputTail++] = <span class="hljs-keyword">this</span>._quoteChar;
        }
    }
}
</code></pre>
<p><strong>关键点</strong>：<code>_writeStringSegment</code> 方法会对字符串中的特殊字符（如 <code>"</code>、``、换行符等）进行转义处理。</p>
<h3 data-id="heading-13">转义示例对比</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b702a100de444dfaa7164c85df8612e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOeWPt-i-vuS6ug==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766204792&amp;x-signature=UNxR7zkOHVHIvq4YSqd7j9C4Siw%3D" alt="" loading="lazy"/> 序列化之后就多了一层转义符号</p>
<h3 data-id="heading-14">主要的调用链路</h3>
<pre><code class="hljs language-scss" lang="scss">对象序列化
  ↓
BeanSerializerBase<span class="hljs-selector-class">.serializeFields</span>()  <span class="hljs-comment">// 遍历对象字段</span>
  ↓
BeanPropertyWriter<span class="hljs-selector-class">.serializeAsField</span>()  <span class="hljs-comment">// 处理单个字段</span>
  ↓
StringSerializer<span class="hljs-selector-class">.serialize</span>()  <span class="hljs-comment">// String 类型走这里</span>
  ↓
UTF8JsonGenerator<span class="hljs-selector-class">.writeString</span>()  <span class="hljs-comment">// 执行转义</span>
  ↓
<span class="hljs-built_in">_writeStringSegment</span>()  <span class="hljs-comment">// 转义特殊字符（" → "）</span>
</code></pre>
<p>理解了这个调用链路，就能明白为什么 JSON 字符串在序列化时会产生转义字符，以及为什么多次序列化会导致多层转义。</p>
<h2 data-id="heading-15">总结</h2>
<ol>
<li><strong>尽量避免在对象中嵌套 JSON 字符串</strong>，应该使用强类型对象，避免多次序列化带来的转义问题</li>
<li><strong>HTTP 传输不会篡改数据</strong>，问题往往出在序列化/反序列化环节</li>
<li><strong>理解序列化的本质</strong>：每序列化一次，JSON 字符串就会多一层转义</li>
<li><strong>遇到验签问题</strong>，优先检查双方处理数据时经历了几次序列化</li>
</ol>
<p>验签虽然好，但有时候也挺麻烦的。所以理解数据在前后端之间的流转过程和序列化时机，可以更好避免这样的验签问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端常用模式：提升代码质量的四大核心模式]]></title>    <link>https://juejin.cn/post/7583139562735190059</link>    <guid>https://juejin.cn/post/7583139562735190059</guid>    <pubDate>2025-12-13T05:00:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583139562735190059" data-draft-id="7582787460419321898" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端常用模式：提升代码质量的四大核心模式"/> <meta itemprop="keywords" content="前端,JavaScript,设计模式"/> <meta itemprop="datePublished" content="2025-12-13T05:00:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="1024肥宅"/> <meta itemprop="url" content="https://juejin.cn/user/588993964030574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端常用模式：提升代码质量的四大核心模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993964030574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    1024肥宅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T05:00:57.000Z" title="Sat Dec 13 2025 05:00:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">引言</h4>
<p>在前端开发中，随着应用复杂度不断增加，代码的组织和管理变得越来越重要。本文将深入探讨前端开发中四种极其有用的模式：中间件模式、管道模式、链式调用和惰性加载。这些模式不仅能提高代码的可读性和可维护性，还能显著优化应用性能。</p>
<h4 data-id="heading-1">一、中间件模式（Middleware Pattern）</h4>
<p>中间件模式允许我们在请求和响应的处理流程中插入多个处理阶段, 这种模式在Node.js框架(例如Koa、Express)中广泛应用, 但在前端同样有其用武之地。</p>
<h5 data-id="heading-2">1.1 核心概念</h5>
<p>中间件本质上是一个函数, 它可以:</p>
<ul>
<li>访问请求(request)和响应(response)对象</li>
<li>执行任何代码</li>
<li>修改请求和响应对象</li>
<li>结束请求-响应周期</li>
<li>调用下一个中间件</li>
</ul>
<h5 data-id="heading-3">1.2 基础实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简单中间件系统实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MiddlewareSystem</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middlewares</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = {};
  }

  <span class="hljs-comment">// 添加中间件</span>
  <span class="hljs-title function_">use</span>(<span class="hljs-params">middleware</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> middleware !== <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Middleware must be a function'</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middlewares</span>.<span class="hljs-title function_">push</span>(middleware);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// 支持链式调用</span>
  }

  <span class="hljs-comment">// 执行中间件</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">input</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = { ...input };
    
    <span class="hljs-comment">// 创建next函数</span>
    <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">next</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">middlewares</span>.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">const</span> middleware = <span class="hljs-variable language_">this</span>.<span class="hljs-property">middlewares</span>[index++];
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, next);
      }
    };
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Middleware execution error:'</span>, error);
      <span class="hljs-keyword">throw</span> error;
    }
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> system = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MiddlewareSystem</span>();

<span class="hljs-comment">// 添加中间件</span>
system
  .<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx, next) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Middleware 1: Start'</span>);
    ctx.<span class="hljs-property">timestamp</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Middleware 1: End'</span>);
  })
  .<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx, next) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Middleware 2: Start'</span>);
    ctx.<span class="hljs-property">user</span> = { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span> };
    <span class="hljs-comment">// 模拟异步操作</span>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">100</span>));
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Middleware 2: End'</span>);
  })
  .<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx, next) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Middleware 3: Start'</span>);
    ctx.<span class="hljs-property">data</span> = { <span class="hljs-attr">message</span>: <span class="hljs-string">'Hello World'</span> };
    <span class="hljs-comment">// 不再调用next()，结束执行</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Middleware 3: End (no next call)'</span>);
  });

<span class="hljs-comment">// 运行中间件</span>
system.<span class="hljs-title function_">run</span>({ <span class="hljs-attr">requestId</span>: <span class="hljs-string">'123'</span> }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Final context:'</span>, result);
});
</code></pre>
<h5 data-id="heading-4">1.3 错误处理中间件</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorHandlingMiddleware</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middlewares</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMiddlewares</span> = [];
  }

  <span class="hljs-title function_">use</span>(<span class="hljs-params">middleware</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middlewares</span>.<span class="hljs-title function_">push</span>(middleware);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">useError</span>(<span class="hljs-params">errorMiddleware</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMiddlewares</span>.<span class="hljs-title function_">push</span>(errorMiddleware);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">input</span>) {
    <span class="hljs-keyword">const</span> context = { ...input };
    <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> errorIndex = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> error = <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">next</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">err</span>) =&gt; {
      <span class="hljs-keyword">if</span> (err) {
        error = err;
        errorIndex = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">nextError</span>();
      }

      <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">middlewares</span>.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">const</span> middleware = <span class="hljs-variable language_">this</span>.<span class="hljs-property">middlewares</span>[index++];
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">await</span> <span class="hljs-title function_">middleware</span>(context, next);
        } <span class="hljs-keyword">catch</span> (err) {
          <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>(err);
        }
      }
    };

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">nextError</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (errorIndex &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMiddlewares</span>.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">const</span> errorMiddleware = <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMiddlewares</span>[errorIndex++];
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">await</span> <span class="hljs-title function_">errorMiddleware</span>(error, context, nextError);
        } <span class="hljs-keyword">catch</span> (err) {
          error = err;
          <span class="hljs-keyword">await</span> <span class="hljs-title function_">nextError</span>();
        }
      }
    };

    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
    <span class="hljs-keyword">return</span> { context, error };
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> errorSystem = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorHandlingMiddleware</span>();

errorSystem
  .<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx, next) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Processing...'</span>);
    <span class="hljs-comment">// 模拟错误</span>
    <span class="hljs-keyword">if</span> (!ctx.<span class="hljs-property">user</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'User not found'</span>);
    }
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
  })
  .<span class="hljs-title function_">useError</span>(<span class="hljs-keyword">async</span> (err, ctx, next) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error caught:'</span>, err.<span class="hljs-property">message</span>);
    ctx.<span class="hljs-property">error</span> = err.<span class="hljs-property">message</span>;
    ctx.<span class="hljs-property">status</span> = <span class="hljs-string">'error'</span>;
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
  });

errorSystem.<span class="hljs-title function_">run</span>({}).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Result with error handling:'</span>, result);
});
</code></pre>
<h5 data-id="heading-5">1.4 前端应用场景</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端请求拦截中间件</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestInterceptor</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptors</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultConfig</span> = {
      <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span>,
      <span class="hljs-attr">headers</span>: {}
    };
  }

  <span class="hljs-title function_">use</span>(<span class="hljs-params">interceptor</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptors</span>.<span class="hljs-title function_">push</span>(interceptor);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">url, config = {}</span>) {
    <span class="hljs-keyword">const</span> context = {
      url,
      <span class="hljs-attr">config</span>: { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultConfig</span>, ...config },
      <span class="hljs-attr">response</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span>
    };

    <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">next</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptors</span>.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">const</span> interceptor = <span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptors</span>[index++];
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">interceptor</span>(context, next);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 执行实际请求</span>
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeRequest</span>(context);
      }
    };

    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
    <span class="hljs-keyword">return</span> context;
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">executeRequest</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(context.<span class="hljs-property">url</span>, context.<span class="hljs-property">config</span>);
      context.<span class="hljs-property">response</span> = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
    } <span class="hljs-keyword">catch</span> (error) {
      context.<span class="hljs-property">error</span> = error;
    }
  }
}

<span class="hljs-comment">// 创建请求拦截器</span>
<span class="hljs-keyword">const</span> api = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestInterceptor</span>();

api
  .<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx, next) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Auth interceptor'</span>);
    ctx.<span class="hljs-property">config</span>.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${<span class="hljs-variable language_">localStorage</span>.getItem(<span class="hljs-string">'token'</span>)}</span>`</span>;
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
  })
  .<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx, next) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Logging interceptor'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Request to <span class="hljs-subst">${ctx.url}</span>`</span>, ctx.<span class="hljs-property">config</span>);
    <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
    <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - start;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Request completed in <span class="hljs-subst">${duration}</span>ms`</span>);
  })
  .<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx, next) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Cache interceptor'</span>);
    <span class="hljs-keyword">const</span> cacheKey = <span class="hljs-string">`cache_<span class="hljs-subst">${ctx.url}</span>`</span>;
    <span class="hljs-keyword">const</span> cached = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(cacheKey);
    
    <span class="hljs-keyword">if</span> (cached &amp;&amp; !ctx.<span class="hljs-property">config</span>.<span class="hljs-property">noCache</span>) {
      ctx.<span class="hljs-property">response</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(cached);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Using cached response'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
      <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">response</span> &amp;&amp; !ctx.<span class="hljs-property">error</span>) {
        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(cacheKey, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(ctx.<span class="hljs-property">response</span>));
      }
    }
  });

<span class="hljs-comment">// 使用拦截器</span>
api.<span class="hljs-title function_">request</span>(<span class="hljs-string">'https://api.example.com/data'</span>, { <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span> })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Response:'</span>, result.<span class="hljs-property">response</span>));
</code></pre>
<h4 data-id="heading-6">二、管道模式（Pipeline Pattern）</h4>
<p>管道模式将多个处理函数连接起来, 数据像流水一样经过这些函数进行处理和转换。</p>
<h5 data-id="heading-7">2.1 基本实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 同步管道</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">pipeline</span> = (<span class="hljs-params">...fns</span>) =&gt; <span class="hljs-function">(<span class="hljs-params">initialValue</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> fns.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">value, fn</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fn !== <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Pipeline expects functions, got <span class="hljs-subst">${<span class="hljs-keyword">typeof</span> fn}</span>`</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(value);
  }, initialValue);
};

<span class="hljs-comment">// 异步管道</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">asyncPipeline</span> = (<span class="hljs-params">...fns</span>) =&gt; <span class="hljs-keyword">async</span> (initialValue) =&gt; {
  <span class="hljs-keyword">let</span> result = initialValue;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> fn <span class="hljs-keyword">of</span> fns) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fn !== <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Pipeline expects functions, got <span class="hljs-subst">${<span class="hljs-keyword">typeof</span> fn}</span>`</span>);
    }
    result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>(result);
  }
  <span class="hljs-keyword">return</span> result;
};

<span class="hljs-comment">// 可中断的管道</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">breakablePipeline</span> = (<span class="hljs-params">...fns</span>) =&gt; <span class="hljs-function">(<span class="hljs-params">initialValue</span>) =&gt;</span> {
  <span class="hljs-keyword">let</span> shouldBreak = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">let</span> breakValue = <span class="hljs-literal">null</span>;
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">breakFn</span> = (<span class="hljs-params">value</span>) =&gt; {
    shouldBreak = <span class="hljs-literal">true</span>;
    breakValue = value;
  };
  
  <span class="hljs-keyword">const</span> result = fns.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">value, fn</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (shouldBreak) <span class="hljs-keyword">return</span> breakValue;
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(value, breakFn);
  }, initialValue);
  
  <span class="hljs-keyword">return</span> shouldBreak ? breakValue : result;
};
</code></pre>
<h5 data-id="heading-8">2.2 数据处理管道示例</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 数据清洗管道</span>
<span class="hljs-keyword">const</span> dataCleaningPipeline = <span class="hljs-title function_">pipeline</span>(
  <span class="hljs-comment">// 1. 移除空值</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> data.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item != <span class="hljs-literal">null</span>),
  
  <span class="hljs-comment">// 2. 标准化字段</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({
    ...item,
    <span class="hljs-attr">name</span>: item.<span class="hljs-property">name</span>?.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">toLowerCase</span>() || <span class="hljs-string">'unknown'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-title class_">Number</span>(item.<span class="hljs-property">value</span>) || <span class="hljs-number">0</span>
  })),
  
  <span class="hljs-comment">// 3. 去重</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
    <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> key = <span class="hljs-string">`<span class="hljs-subst">${item.name}</span>-<span class="hljs-subst">${item.value}</span>`</span>;
      <span class="hljs-keyword">if</span> (seen.<span class="hljs-title function_">has</span>(key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      seen.<span class="hljs-title function_">add</span>(key);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    });
  },
  
  <span class="hljs-comment">// 4. 排序</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> data.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b.<span class="hljs-property">value</span> - a.<span class="hljs-property">value</span>),
  
  <span class="hljs-comment">// 5. 限制数量</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> data.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>)
);

<span class="hljs-comment">// 使用管道</span>
<span class="hljs-keyword">const</span> rawData = [
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'  John  '</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'100'</span> },
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'Jane'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">200</span> },
  <span class="hljs-literal">null</span>,
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'100'</span> }, <span class="hljs-comment">// 重复</span>
  { <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'invalid'</span> }
];

<span class="hljs-keyword">const</span> cleanedData = <span class="hljs-title function_">dataCleaningPipeline</span>(rawData);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Cleaned data:'</span>, cleanedData);
</code></pre>
<h5 data-id="heading-9">2.3 表单验证管道</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 验证规则</span>
<span class="hljs-keyword">const</span> validators = {
  <span class="hljs-attr">required</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> ({
    <span class="hljs-attr">isValid</span>: value != <span class="hljs-literal">null</span> &amp;&amp; value.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>() !== <span class="hljs-string">''</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'This field is required'</span>
  }),
  
  <span class="hljs-attr">minLength</span>: <span class="hljs-function">(<span class="hljs-params">min</span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> ({
    <span class="hljs-attr">isValid</span>: value?.<span class="hljs-title function_">toString</span>().<span class="hljs-property">length</span> &gt;= min,
    <span class="hljs-attr">message</span>: <span class="hljs-string">`Minimum length is <span class="hljs-subst">${min}</span> characters`</span>
  }),
  
  <span class="hljs-attr">maxLength</span>: <span class="hljs-function">(<span class="hljs-params">max</span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> ({
    <span class="hljs-attr">isValid</span>: value?.<span class="hljs-title function_">toString</span>().<span class="hljs-property">length</span> &lt;= max,
    <span class="hljs-attr">message</span>: <span class="hljs-string">`Maximum length is <span class="hljs-subst">${max}</span> characters`</span>
  }),
  
  <span class="hljs-attr">email</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> ({
    <span class="hljs-attr">isValid</span>: <span class="hljs-regexp">/^[^\s@]+@[^\s@]+\.[^\s@]+$/</span>.<span class="hljs-title function_">test</span>(value),
    <span class="hljs-attr">message</span>: <span class="hljs-string">'Invalid email format'</span>
  }),
  
  <span class="hljs-attr">numeric</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> ({
    <span class="hljs-attr">isValid</span>: !<span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseFloat</span>(value)) &amp;&amp; <span class="hljs-built_in">isFinite</span>(value),
    <span class="hljs-attr">message</span>: <span class="hljs-string">'Must be a number'</span>
  })
};

<span class="hljs-comment">// 表单验证管道</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FormValidator</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">rules</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rules</span> = rules;
  }

  <span class="hljs-title function_">validate</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">const</span> errors = {};
    <span class="hljs-keyword">const</span> results = {};

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [field, fieldRules] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rules</span>)) {
      <span class="hljs-keyword">const</span> value = data[field];
      <span class="hljs-keyword">const</span> fieldErrors = [];

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> rule <span class="hljs-keyword">of</span> fieldRules) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">rule</span>(value);
        <span class="hljs-keyword">if</span> (!result.<span class="hljs-property">isValid</span>) {
          fieldErrors.<span class="hljs-title function_">push</span>(result.<span class="hljs-property">message</span>);
        }
      }

      <span class="hljs-keyword">if</span> (fieldErrors.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        errors[field] = fieldErrors;
      } <span class="hljs-keyword">else</span> {
        results[field] = value;
      }
    }

    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">isValid</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(errors).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>,
      errors,
      results
    };
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> registrationRules = {
  <span class="hljs-attr">username</span>: [
    validators.<span class="hljs-property">required</span>,
    validators.<span class="hljs-title function_">minLength</span>(<span class="hljs-number">3</span>),
    validators.<span class="hljs-title function_">maxLength</span>(<span class="hljs-number">20</span>)
  ],
  <span class="hljs-attr">email</span>: [
    validators.<span class="hljs-property">required</span>,
    validators.<span class="hljs-property">email</span>
  ],
  <span class="hljs-attr">age</span>: [
    validators.<span class="hljs-property">required</span>,
    validators.<span class="hljs-property">numeric</span>,
    <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> ({
      <span class="hljs-attr">isValid</span>: value &gt;= <span class="hljs-number">18</span> &amp;&amp; value &lt;= <span class="hljs-number">100</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'Age must be between 18 and 100'</span>
    })
  ]
};

<span class="hljs-keyword">const</span> validator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormValidator</span>(registrationRules);
<span class="hljs-keyword">const</span> userData = {
  <span class="hljs-attr">username</span>: <span class="hljs-string">'johndoe'</span>,
  <span class="hljs-attr">email</span>: <span class="hljs-string">'john@example.com'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>
};

<span class="hljs-keyword">const</span> validationResult = validator.<span class="hljs-title function_">validate</span>(userData);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Validation result:'</span>, validationResult);
</code></pre>
<h4 data-id="heading-10">三、链式调用（Chaining Pattern）</h4>
<p>链式调用通过返回对象实例本身(<code>this</code>), 允许连续调用多个方法, 使代码更加流畅易读。</p>
<h5 data-id="heading-11">3.1 基础链式调用</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// jQuery风格的链式调用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">QueryBuilder</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span> = {
      <span class="hljs-attr">select</span>: [],
      <span class="hljs-attr">from</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">where</span>: [],
      <span class="hljs-attr">orderBy</span>: [],
      <span class="hljs-attr">limit</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">offset</span>: <span class="hljs-literal">null</span>
    };
  }

  <span class="hljs-title function_">select</span>(<span class="hljs-params">...fields</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>.<span class="hljs-property">select</span>.<span class="hljs-title function_">push</span>(...fields);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">from</span>(<span class="hljs-params">table</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>.<span class="hljs-property">from</span> = table;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">where</span>(<span class="hljs-params">condition</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>.<span class="hljs-property">where</span>.<span class="hljs-title function_">push</span>(condition);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">orderBy</span>(<span class="hljs-params">field, direction = <span class="hljs-string">'ASC'</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>.<span class="hljs-property">orderBy</span>.<span class="hljs-title function_">push</span>({ field, direction });
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">limit</span>(<span class="hljs-params">count</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>.<span class="hljs-property">limit</span> = count;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">offset</span>(<span class="hljs-params">count</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>.<span class="hljs-property">offset</span> = count;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> { select, <span class="hljs-keyword">from</span>, where, orderBy, limit, offset } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>;
    
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">from</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'FROM clause is required'</span>);
    }

    <span class="hljs-keyword">let</span> sql = <span class="hljs-string">`SELECT <span class="hljs-subst">${select.length &gt; <span class="hljs-number">0</span> ? select.join(<span class="hljs-string">', '</span>) : <span class="hljs-string">'*'</span>}</span> FROM <span class="hljs-subst">${<span class="hljs-keyword">from</span>}</span>`</span>;
    
    <span class="hljs-keyword">if</span> (where.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      sql += <span class="hljs-string">` WHERE <span class="hljs-subst">${where.join(<span class="hljs-string">' AND '</span>)}</span>`</span>;
    }
    
    <span class="hljs-keyword">if</span> (orderBy.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">const</span> orderClauses = orderBy.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">{ field, direction }</span>) =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${field}</span> <span class="hljs-subst">${direction}</span>`</span>);
      sql += <span class="hljs-string">` ORDER BY <span class="hljs-subst">${orderClauses.join(<span class="hljs-string">', '</span>)}</span>`</span>;
    }
    
    <span class="hljs-keyword">if</span> (limit !== <span class="hljs-literal">null</span>) {
      sql += <span class="hljs-string">` LIMIT <span class="hljs-subst">${limit}</span>`</span>;
    }
    
    <span class="hljs-keyword">if</span> (offset !== <span class="hljs-literal">null</span>) {
      sql += <span class="hljs-string">` OFFSET <span class="hljs-subst">${offset}</span>`</span>;
    }
    
    <span class="hljs-keyword">return</span> sql + <span class="hljs-string">';'</span>;
  }

  <span class="hljs-title function_">reset</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span> = {
      <span class="hljs-attr">select</span>: [],
      <span class="hljs-attr">from</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">where</span>: [],
      <span class="hljs-attr">orderBy</span>: [],
      <span class="hljs-attr">limit</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">offset</span>: <span class="hljs-literal">null</span>
    };
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> sql = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryBuilder</span>()
  .<span class="hljs-title function_">select</span>(<span class="hljs-string">'id'</span>, <span class="hljs-string">'name'</span>, <span class="hljs-string">'email'</span>)
  .<span class="hljs-title function_">from</span>(<span class="hljs-string">'users'</span>)
  .<span class="hljs-title function_">where</span>(<span class="hljs-string">'active = true'</span>)
  .<span class="hljs-title function_">where</span>(<span class="hljs-string">'age &gt;= 18'</span>)
  .<span class="hljs-title function_">orderBy</span>(<span class="hljs-string">'name'</span>, <span class="hljs-string">'ASC'</span>)
  .<span class="hljs-title function_">limit</span>(<span class="hljs-number">10</span>)
  .<span class="hljs-title function_">offset</span>(<span class="hljs-number">0</span>)
  .<span class="hljs-title function_">build</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Generated SQL:'</span>, sql);
</code></pre>
<h5 data-id="heading-12">3.2 DOM操作链式调用</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DOMElement</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">selector</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> selector === <span class="hljs-string">'string'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span> = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(selector));
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (selector <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Element</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span> = [selector];
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(selector)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span> = selector;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span> = [];
    }
  }

  <span class="hljs-comment">// CSS相关方法</span>
  <span class="hljs-title function_">css</span>(<span class="hljs-params">property, value</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> property === <span class="hljs-string">'object'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(el.<span class="hljs-property">style</span>, property);
      });
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
        el.<span class="hljs-property">style</span>[property] = value;
      });
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">addClass</span>(<span class="hljs-params">className</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
      el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(className);
    });
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">removeClass</span>(<span class="hljs-params">className</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
      el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(className);
    });
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">toggleClass</span>(<span class="hljs-params">className</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
      el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(className);
    });
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">// 内容操作</span>
  <span class="hljs-title function_">text</span>(<span class="hljs-params">content</span>) {
    <span class="hljs-keyword">if</span> (content !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
        el.<span class="hljs-property">textContent</span> = content;
      });
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>[<span class="hljs-number">0</span>]?.<span class="hljs-property">textContent</span> || <span class="hljs-string">''</span>;
  }

  <span class="hljs-title function_">html</span>(<span class="hljs-params">content</span>) {
    <span class="hljs-keyword">if</span> (content !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
        el.<span class="hljs-property">innerHTML</span> = content;
      });
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>[<span class="hljs-number">0</span>]?.<span class="hljs-property">innerHTML</span> || <span class="hljs-string">''</span>;
  }

  <span class="hljs-comment">// 属性操作</span>
  <span class="hljs-title function_">attr</span>(<span class="hljs-params">name, value</span>) {
    <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
        el.<span class="hljs-title function_">setAttribute</span>(name, value);
      });
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>[<span class="hljs-number">0</span>]?.<span class="hljs-title function_">getAttribute</span>(name) || <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">// 事件处理</span>
  <span class="hljs-title function_">on</span>(<span class="hljs-params">event, handler, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
      el.<span class="hljs-title function_">addEventListener</span>(event, handler, options);
    });
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">off</span>(<span class="hljs-params">event, handler, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
      el.<span class="hljs-title function_">removeEventListener</span>(event, handler, options);
    });
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">// 遍历</span>
  <span class="hljs-title function_">each</span>(<span class="hljs-params">callback</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">el, index</span>) =&gt;</span> {
      callback.<span class="hljs-title function_">call</span>(el, index, el);
    });
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">// 查找子元素</span>
  <span class="hljs-title function_">find</span>(<span class="hljs-params">selector</span>) {
    <span class="hljs-keyword">const</span> found = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
      found.<span class="hljs-title function_">push</span>(...<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(el.<span class="hljs-title function_">querySelectorAll</span>(selector)));
    });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMElement</span>(found);
  }

  <span class="hljs-comment">// 获取父元素</span>
  <span class="hljs-title function_">parent</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> parents = <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> el.<span class="hljs-property">parentElement</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMElement</span>(parents.<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>));
  }

  <span class="hljs-comment">// 显示/隐藏</span>
  <span class="hljs-title function_">show</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">css</span>(<span class="hljs-string">'display'</span>, <span class="hljs-string">''</span>);
  }

  <span class="hljs-title function_">hide</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">css</span>(<span class="hljs-string">'display'</span>, <span class="hljs-string">'none'</span>);
  }

  <span class="hljs-comment">// 动画</span>
  <span class="hljs-title function_">animate</span>(<span class="hljs-params">properties, duration = <span class="hljs-number">300</span>, easing = <span class="hljs-string">'ease'</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
      el.<span class="hljs-property">style</span>.<span class="hljs-property">transition</span> = <span class="hljs-string">`all <span class="hljs-subst">${duration}</span>ms <span class="hljs-subst">${easing}</span>`</span>;
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(el.<span class="hljs-property">style</span>, properties);
      
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        el.<span class="hljs-property">style</span>.<span class="hljs-property">transition</span> = <span class="hljs-string">''</span>;
      }, duration);
    });
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-comment">// 假设HTML中有: &lt;div id="myDiv"&gt;Hello&lt;/div&gt;</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">$</span> = (<span class="hljs-params">selector</span>) =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMElement</span>(selector);

$(<span class="hljs-string">'#myDiv'</span>)
  .<span class="hljs-title function_">css</span>({
    <span class="hljs-attr">color</span>: <span class="hljs-string">'white'</span>,
    <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'blue'</span>,
    <span class="hljs-attr">padding</span>: <span class="hljs-string">'10px'</span>
  })
  .<span class="hljs-title function_">addClass</span>(<span class="hljs-string">'highlight'</span>)
  .<span class="hljs-title function_">text</span>(<span class="hljs-string">'Hello, World!'</span>)
  .<span class="hljs-title function_">on</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    $(<span class="hljs-variable language_">this</span>).<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">'active'</span>);
  })
  .<span class="hljs-title function_">animate</span>({
    <span class="hljs-attr">opacity</span>: <span class="hljs-number">0.8</span>,
    <span class="hljs-attr">transform</span>: <span class="hljs-string">'scale(1.1)'</span>
  }, <span class="hljs-number">300</span>);
</code></pre>
<h5 data-id="heading-13">3.3 构建器模式与链式调用</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 配置对象构建器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationBuilder</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = {
      <span class="hljs-attr">api</span>: {},
      <span class="hljs-attr">ui</span>: {},
      <span class="hljs-attr">features</span>: {},
      <span class="hljs-attr">performance</span>: {}
    };
  }

  <span class="hljs-comment">// API配置</span>
  <span class="hljs-title function_">withApi</span>(<span class="hljs-params">baseUrl</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">api</span>.<span class="hljs-property">baseUrl</span> = baseUrl;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">withApiVersion</span>(<span class="hljs-params">version</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">api</span>.<span class="hljs-property">version</span> = version;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">withTimeout</span>(<span class="hljs-params">ms</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">api</span>.<span class="hljs-property">timeout</span> = ms;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">// UI配置</span>
  <span class="hljs-title function_">withTheme</span>(<span class="hljs-params">theme</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">ui</span>.<span class="hljs-property">theme</span> = theme;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">withLanguage</span>(<span class="hljs-params">lang</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">ui</span>.<span class="hljs-property">language</span> = lang;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">withDarkMode</span>(<span class="hljs-params">enabled</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">ui</span>.<span class="hljs-property">darkMode</span> = enabled;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">// 功能配置</span>
  <span class="hljs-title function_">enableFeature</span>(<span class="hljs-params">feature</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">features</span>[feature] = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">disableFeature</span>(<span class="hljs-params">feature</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">features</span>[feature] = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">// 性能配置</span>
  <span class="hljs-title function_">withCache</span>(<span class="hljs-params">enabled</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">performance</span>.<span class="hljs-property">cache</span> = enabled;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">withLazyLoad</span>(<span class="hljs-params">enabled</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">performance</span>.<span class="hljs-property">lazyLoad</span> = enabled;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">withCompression</span>(<span class="hljs-params">enabled</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">performance</span>.<span class="hljs-property">compression</span> = enabled;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">// 构建方法</span>
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 验证配置</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validate</span>();
    <span class="hljs-comment">// 返回不可变配置</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">freeze</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>)));
  }

  <span class="hljs-title function_">validate</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> { api } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>;
    <span class="hljs-keyword">if</span> (!api.<span class="hljs-property">baseUrl</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'API base URL is required'</span>);
    }
    <span class="hljs-keyword">if</span> (api.<span class="hljs-property">timeout</span> &amp;&amp; api.<span class="hljs-property">timeout</span> &lt; <span class="hljs-number">100</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Timeout must be at least 100ms'</span>);
    }
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> config = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigurationBuilder</span>()
  .<span class="hljs-title function_">withApi</span>(<span class="hljs-string">'https://api.example.com'</span>)
  .<span class="hljs-title function_">withApiVersion</span>(<span class="hljs-string">'v1'</span>)
  .<span class="hljs-title function_">withTimeout</span>(<span class="hljs-number">5000</span>)
  .<span class="hljs-title function_">withTheme</span>(<span class="hljs-string">'dark'</span>)
  .<span class="hljs-title function_">withLanguage</span>(<span class="hljs-string">'en'</span>)
  .<span class="hljs-title function_">withDarkMode</span>(<span class="hljs-literal">true</span>)
  .<span class="hljs-title function_">enableFeature</span>(<span class="hljs-string">'analytics'</span>)
  .<span class="hljs-title function_">enableFeature</span>(<span class="hljs-string">'notifications'</span>)
  .<span class="hljs-title function_">disableFeature</span>(<span class="hljs-string">'debug'</span>)
  .<span class="hljs-title function_">withCache</span>(<span class="hljs-literal">true</span>)
  .<span class="hljs-title function_">withLazyLoad</span>(<span class="hljs-literal">true</span>)
  .<span class="hljs-title function_">build</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'App configuration:'</span>, config);
</code></pre>
<h4 data-id="heading-14">四、惰性加载/求值（Lazy Loading/Evaluation）</h4>
<p>惰性加载延迟计算或初始化, 直到真正需要时才执行, 可以显著提高应用性能。</p>
<h5 data-id="heading-15">4.1 惰性求值实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 惰性函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">lazy</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">let</span> result;
  <span class="hljs-keyword">let</span> evaluated = <span class="hljs-literal">false</span>;
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (!evaluated) {
      result = fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
      evaluated = <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> result;
  };
}

<span class="hljs-comment">// 惰性属性</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">lazyProperty</span>(<span class="hljs-params">target, propertyName, getter</span>) {
  <span class="hljs-keyword">let</span> value;
  <span class="hljs-keyword">let</span> evaluated = <span class="hljs-literal">false</span>;
  
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(target, propertyName, {
    <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (!evaluated) {
        value = getter.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>);
        evaluated = <span class="hljs-literal">true</span>;
      }
      <span class="hljs-keyword">return</span> value;
    },
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>
  });
}

<span class="hljs-comment">// 惰性类属性</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyClass</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_expensiveData</span> = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">expensiveData</span>() {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_expensiveData</span> === <span class="hljs-literal">null</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Computing expensive data...'</span>);
      <span class="hljs-comment">// 模拟耗时计算</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_expensiveData</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">computeExpensiveData</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_expensiveData</span>;
  }

  <span class="hljs-title function_">computeExpensiveData</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 复杂的计算逻辑</span>
    <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">let</span> result = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
      result += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(i);
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Computed in <span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now() - start}</span>ms`</span>);
    <span class="hljs-keyword">return</span> result;
  }

  <span class="hljs-comment">// 重置惰性值</span>
  <span class="hljs-title function_">reset</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_expensiveData</span> = <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<h5 data-id="heading-16">4.2 图片懒加载</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyImageLoader</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">root</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">rootMargin</span>: <span class="hljs-string">'0px'</span>,
      <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.1</span>,
      <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'</span>,
      ...options
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">images</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initObserver</span>();
  }

  <span class="hljs-title function_">initObserver</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-string">'IntersectionObserver'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleIntersection</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>),
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>
      );
    }
  }

  <span class="hljs-title function_">registerImage</span>(<span class="hljs-params">imgElement, src</span>) {
    <span class="hljs-keyword">if</span> (!imgElement || !src) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 保存原始src</span>
    <span class="hljs-keyword">const</span> originalSrc = imgElement.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'data-src'</span>) || src;
    imgElement.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'data-src'</span>, originalSrc);
    
    <span class="hljs-comment">// 设置占位符</span>
    imgElement.<span class="hljs-property">src</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">placeholder</span>;
    imgElement.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'lazy-load'</span>);
    
    <span class="hljs-comment">// 添加到观察列表</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">images</span>.<span class="hljs-title function_">set</span>(imgElement, {
      <span class="hljs-attr">src</span>: originalSrc,
      <span class="hljs-attr">loaded</span>: <span class="hljs-literal">false</span>
    });
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span>.<span class="hljs-title function_">observe</span>(imgElement);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 降级方案：立即加载</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadImage</span>(imgElement);
    }
  }

  <span class="hljs-title function_">handleIntersection</span>(<span class="hljs-params">entries</span>) {
    entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) {
        <span class="hljs-keyword">const</span> img = entry.<span class="hljs-property">target</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadImage</span>(img);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span>?.<span class="hljs-title function_">unobserve</span>(img);
      }
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadImage</span>(<span class="hljs-params">imgElement</span>) {
    <span class="hljs-keyword">const</span> imageData = <span class="hljs-variable language_">this</span>.<span class="hljs-property">images</span>.<span class="hljs-title function_">get</span>(imgElement);
    <span class="hljs-keyword">if</span> (!imageData || imageData.<span class="hljs-property">loaded</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 预加载图片</span>
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">preloadImage</span>(imageData.<span class="hljs-property">src</span>);
      
      <span class="hljs-comment">// 应用实际图片</span>
      imgElement.<span class="hljs-property">src</span> = imageData.<span class="hljs-property">src</span>;
      imgElement.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'lazy-load'</span>);
      imgElement.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'lazy-loaded'</span>);
      
      imageData.<span class="hljs-property">loaded</span> = <span class="hljs-literal">true</span>;
      
      <span class="hljs-comment">// 触发加载完成事件</span>
      imgElement.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(<span class="hljs-string">'lazyload'</span>, {
        <span class="hljs-attr">detail</span>: { <span class="hljs-attr">src</span>: imageData.<span class="hljs-property">src</span> }
      }));
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to load image:'</span>, imageData.<span class="hljs-property">src</span>, error);
      imgElement.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'lazy-error'</span>);
      
      imgElement.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(<span class="hljs-string">'lazyloaderror'</span>, {
        <span class="hljs-attr">detail</span>: { <span class="hljs-attr">src</span>: imageData.<span class="hljs-property">src</span>, error }
      }));
    }
  }

  <span class="hljs-title function_">preloadImage</span>(<span class="hljs-params">src</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
      img.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(img);
      img.<span class="hljs-property">onerror</span> = reject;
      img.<span class="hljs-property">src</span> = src;
    });
  }

  <span class="hljs-comment">// 批量注册图片</span>
  <span class="hljs-title function_">registerAll</span>(<span class="hljs-params">selector = <span class="hljs-string">'img[data-src]'</span></span>) {
    <span class="hljs-keyword">const</span> images = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(selector);
    images.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">img</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> src = img.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'data-src'</span>);
      <span class="hljs-keyword">if</span> (src) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">registerImage</span>(img, src);
      }
    });
  }

  <span class="hljs-comment">// 强制加载特定图片</span>
  <span class="hljs-title function_">forceLoad</span>(<span class="hljs-params">imgElement</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadImage</span>(imgElement);
  }

  <span class="hljs-comment">// 清理</span>
  <span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span>?.<span class="hljs-title function_">disconnect</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">images</span>.<span class="hljs-title function_">clear</span>();
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> lazyLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyImageLoader</span>({
    <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.5</span>,
    <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'/images/placeholder.png'</span>
  });
  
  <span class="hljs-comment">// 注册现有图片</span>
  lazyLoader.<span class="hljs-title function_">registerAll</span>();
  
  <span class="hljs-comment">// 动态添加的图片</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'newImagesAdded'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> newImages = event.<span class="hljs-property">detail</span>.<span class="hljs-property">images</span>;
    newImages.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">img</span> =&gt;</span> {
      lazyLoader.<span class="hljs-title function_">registerImage</span>(img, img.<span class="hljs-property">dataset</span>.<span class="hljs-property">src</span>);
    });
  });
  
  <span class="hljs-comment">// 页面离开时清理</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
    lazyLoader.<span class="hljs-title function_">destroy</span>();
  });
});
</code></pre>
<h5 data-id="heading-17">4.3 组件懒加载(Vue/React示例)</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React组件懒加载</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { <span class="hljs-title class_">Suspense</span>, lazy } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 懒加载组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyComponent</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./ExpensiveComponent'</span>));

<span class="hljs-comment">// 使用Suspense包裹</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>My App<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">LazyComponent</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// Vue组件懒加载</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">LazyComponent</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">import</span>(<span class="hljs-string">'./ExpensiveComponent.vue'</span>);

<span class="hljs-comment">// 路由配置中使用懒加载</span>
<span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/dashboard'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/Dashboard.vue'</span>)
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/settings'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/Settings.vue'</span>)
  }
];

<span class="hljs-comment">// 自定义懒加载封装</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createLazyLoader</span>(<span class="hljs-params">importFn, loadingComponent, errorComponent</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">component</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">loading</span>: <span class="hljs-literal">true</span>
      };
    },
    
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> importFn();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">component</span> = <span class="hljs-variable language_">module</span>.<span class="hljs-property">default</span> || <span class="hljs-variable language_">module</span>;
      } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">error</span> = err;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to load component:'</span>, err);
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>;
      }
    },
    
    <span class="hljs-title function_">render</span>(<span class="hljs-params">h</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> &amp;&amp; loadingComponent) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(loadingComponent);
      }
      
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">error</span> &amp;&amp; errorComponent) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(errorComponent, { <span class="hljs-attr">error</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">error</span> });
      }
      
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">component</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">component</span>);
      }
      
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
  };
}
</code></pre>
<h5 data-id="heading-18">4.4 数据懒加载(无限滚动)</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">InfiniteScroll</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">container</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>,
      <span class="hljs-attr">distance</span>: <span class="hljs-number">100</span>,
      <span class="hljs-attr">throttle</span>: <span class="hljs-number">200</span>,
      <span class="hljs-attr">onLoadMore</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(),
      ...options
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hasMore</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">throttleTimer</span> = <span class="hljs-literal">null</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }

  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">container</span> === <span class="hljs-string">'string'</span> 
      ? <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">container</span>)
      : <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">container</span>;
    
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Container not found'</span>);
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">bindEvents</span>();
  }

  <span class="hljs-title function_">bindEvents</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleScroll</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleScroll</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
  }

  <span class="hljs-title function_">handleScroll</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">throttleTimer</span>) {
      <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">throttleTimer</span>);
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">throttleTimer</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkPosition</span>();
    }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">throttle</span>);
  }

  <span class="hljs-title function_">checkPosition</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">hasMore</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> scrollTop = <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-property">scrollTop</span>;
    <span class="hljs-keyword">const</span> scrollHeight = <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-property">scrollHeight</span>;
    <span class="hljs-keyword">const</span> clientHeight = <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-property">clientHeight</span>;
    
    <span class="hljs-keyword">const</span> distanceToBottom = scrollHeight - (scrollTop + clientHeight);
    
    <span class="hljs-keyword">if</span> (distanceToBottom &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">distance</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadMore</span>();
    }
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadMore</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">hasMore</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(<span class="hljs-string">'loadstart'</span>));
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-title function_">onLoadMore</span>();
      
      <span class="hljs-keyword">if</span> (result &amp;&amp; <span class="hljs-keyword">typeof</span> result.<span class="hljs-property">hasMore</span> === <span class="hljs-string">'boolean'</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">hasMore</span> = result.<span class="hljs-property">hasMore</span>;
      }
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(<span class="hljs-string">'load'</span>, { 
        <span class="hljs-attr">detail</span>: result 
      }));
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(<span class="hljs-string">'error'</span>, { 
        <span class="hljs-attr">detail</span>: error 
      }));
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to load more data:'</span>, error);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(<span class="hljs-string">'loadend'</span>));
      
      <span class="hljs-comment">// 检查是否还需要继续加载（数据可能没有填满屏幕）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">hasMore</span>) {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkPosition</span>(), <span class="hljs-number">100</span>);
      }
    }
  }

  <span class="hljs-comment">// 手动触发加载</span>
  <span class="hljs-title function_">triggerLoad</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadMore</span>();
  }

  <span class="hljs-comment">// 重置状态</span>
  <span class="hljs-title function_">reset</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hasMore</span> = <span class="hljs-literal">true</span>;
  }

  <span class="hljs-comment">// 销毁</span>
  <span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleScroll</span>);
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleScroll</span>);
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">throttleTimer</span>) {
      <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">throttleTimer</span>);
    }
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> infiniteScroll = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InfiniteScroll</span>({
  <span class="hljs-attr">container</span>: <span class="hljs-string">'#scrollContainer'</span>,
  <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
  <span class="hljs-attr">throttle</span>: <span class="hljs-number">300</span>,
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onLoadMore</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 模拟API调用</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/items?page=<span class="hljs-subst">${currentPage}</span>`</span>);
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
    
    <span class="hljs-comment">// 渲染新数据</span>
    <span class="hljs-title function_">renderItems</span>(data.<span class="hljs-property">items</span>);
    
    <span class="hljs-comment">// 返回是否有更多数据</span>
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">hasMore</span>: data.<span class="hljs-property">hasMore</span> };
  }
});

<span class="hljs-comment">// 动态更新选项</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateInfiniteScroll</span>(<span class="hljs-params">options</span>) {
  infiniteScroll.<span class="hljs-property">options</span> = { ...infiniteScroll.<span class="hljs-property">options</span>, ...options };
}
</code></pre>
<h4 data-id="heading-19">五、模式对比与应用场景</h4>



































<table><thead><tr><th align="left">模式</th><th align="left">优点</th><th align="left">缺点</th><th align="left">适用场景</th></tr></thead><tbody><tr><td align="left">中间件模式</td><td align="left">解耦、可组合、易于测试</td><td align="left">可能增加复杂性、调试困难</td><td align="left">请求处理、数据处理管道、插件系统</td></tr><tr><td align="left">管道模式</td><td align="left">清晰的数据流向、易于测试和复用</td><td align="left">可能创建太多小函数、错误处理复杂</td><td align="left">数据转换、验证、清洗流程</td></tr><tr><td align="left">链式调用</td><td align="left">代码流畅、易读、减少临时变量</td><td align="left">可能掩盖错误来源、调试困难</td><td align="left">构建器模式、DOM操作、配置设置</td></tr><tr><td align="left">惰性加载</td><td align="left">提高性能】减少内存使用</td><td align="left">初始化延迟、复杂性增加</td><td align="left">图片加载、组件加载、数据计算</td></tr></tbody></table>
<h5 data-id="heading-20">5.1 如何选择模式?</h5>
<ol>
<li><strong>需要处理请求/响应流程</strong> → 中间件模式</li>
<li><strong>需要数据转换流水线</strong> → 管道模式</li>
<li><strong>需要流畅的API接口</strong> → 链式调用</li>
<li><strong>需要优化性能，延迟初始化</strong> → 惰性加载</li>
</ol>
<h4 data-id="heading-21">六、综合应用实例</h4>
<h5 data-id="heading-22">6.1 完整的API客户端</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiClient</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">baseURL</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">baseURL</span> = baseURL;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middlewares</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeaders</span> = {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
    };
  }

  <span class="hljs-comment">// 添加中间件</span>
  <span class="hljs-title function_">use</span>(<span class="hljs-params">middleware</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middlewares</span>.<span class="hljs-title function_">push</span>(middleware);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">// 创建请求管道</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">endpoint, options = {}</span>) {
    <span class="hljs-keyword">const</span> context = {
      <span class="hljs-attr">url</span>: <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.baseURL}</span><span class="hljs-subst">${endpoint}</span>`</span>,
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
        <span class="hljs-attr">headers</span>: { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeaders</span>, ...options.<span class="hljs-property">headers</span> },
        ...options
      },
      <span class="hljs-attr">response</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>
    };

    <span class="hljs-comment">// 执行中间件管道</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeMiddleware</span>(context);
    
    <span class="hljs-keyword">if</span> (context.<span class="hljs-property">error</span>) {
      <span class="hljs-keyword">throw</span> context.<span class="hljs-property">error</span>;
    }

    <span class="hljs-keyword">return</span> context.<span class="hljs-property">response</span>;
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">executeMiddleware</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> middlewares = <span class="hljs-variable language_">this</span>.<span class="hljs-property">middlewares</span>;
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">next</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (index &lt; middlewares.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">const</span> middleware = middlewares[index++];
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">middleware</span>(context, next);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 执行实际请求</span>
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeRequest</span>(context);
      }
    };
    
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">executeRequest</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(context.<span class="hljs-property">url</span>, context.<span class="hljs-property">options</span>);
      context.<span class="hljs-property">response</span> = {
        <span class="hljs-attr">status</span>: response.<span class="hljs-property">status</span>,
        <span class="hljs-attr">headers</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(response.<span class="hljs-property">headers</span>.<span class="hljs-title function_">entries</span>()),
        <span class="hljs-attr">data</span>: <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
      };
    } <span class="hljs-keyword">catch</span> (error) {
      context.<span class="hljs-property">error</span> = error;
    }
  }

  <span class="hljs-comment">// 快捷方法（链式调用）</span>
  <span class="hljs-title function_">get</span>(<span class="hljs-params">endpoint, options = {}</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(endpoint, { ...options, <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span> });
  }

  <span class="hljs-title function_">post</span>(<span class="hljs-params">endpoint, data, options = {}</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(endpoint, {
      ...options,
      <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)
    });
  }

  <span class="hljs-title function_">put</span>(<span class="hljs-params">endpoint, data, options = {}</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(endpoint, {
      ...options,
      <span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>,
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)
    });
  }

  <span class="hljs-title function_">delete</span>(<span class="hljs-params">endpoint, options = {}</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(endpoint, { ...options, <span class="hljs-attr">method</span>: <span class="hljs-string">'DELETE'</span> });
  }
}

<span class="hljs-comment">// 创建API客户端并配置中间件</span>
<span class="hljs-keyword">const</span> api = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiClient</span>(<span class="hljs-string">'https://api.example.com'</span>)
  .<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx, next) =&gt; {
    <span class="hljs-comment">// 认证中间件</span>
    <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'auth_token'</span>);
    <span class="hljs-keyword">if</span> (token) {
      ctx.<span class="hljs-property">options</span>.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>;
    }
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
  })
  .<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx, next) =&gt; {
    <span class="hljs-comment">// 日志中间件</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[API] <span class="hljs-subst">${ctx.options.method}</span> <span class="hljs-subst">${ctx.url}</span>`</span>);
    <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
    <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - start;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[API] Completed in <span class="hljs-subst">${duration}</span>ms`</span>);
  })
  .<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx, next) =&gt; {
    <span class="hljs-comment">// 错误处理中间件</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'[API] Request failed:'</span>, error);
      <span class="hljs-comment">// 可以在这里实现重试逻辑</span>
      <span class="hljs-keyword">throw</span> error;
    }
  });

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUserData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users/1'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'User data:'</span>, response.<span class="hljs-property">data</span>);
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to fetch user:'</span>, error);
  }
}
</code></pre>
<h5 data-id="heading-23">6.2 表单处理系统</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FormProcessor</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">formElement</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">form</span> = formElement;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fields</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">validators</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">transformers</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">submitHandlers</span> = [];
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }

  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 收集表单字段</span>
    <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">form</span>.<span class="hljs-property">elements</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">element</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (element.<span class="hljs-property">name</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">fields</span>.<span class="hljs-title function_">set</span>(element.<span class="hljs-property">name</span>, element);
      }
    });
    
    <span class="hljs-comment">// 绑定提交事件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">form</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'submit'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleSubmit</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
  }

  <span class="hljs-comment">// 添加验证器</span>
  <span class="hljs-title function_">addValidator</span>(<span class="hljs-params">fieldName, validator</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">validators</span>.<span class="hljs-title function_">has</span>(fieldName)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">validators</span>.<span class="hljs-title function_">set</span>(fieldName, []);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">validators</span>.<span class="hljs-title function_">get</span>(fieldName).<span class="hljs-title function_">push</span>(validator);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">// 添加数据转换器</span>
  <span class="hljs-title function_">addTransformer</span>(<span class="hljs-params">transformer</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">transformers</span>.<span class="hljs-title function_">push</span>(transformer);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">// 添加提交处理器</span>
  <span class="hljs-title function_">onSubmit</span>(<span class="hljs-params">handler</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">submitHandlers</span>.<span class="hljs-title function_">push</span>(handler);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">// 获取表单数据</span>
  <span class="hljs-title function_">getData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> data = {};
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fields</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">element, name</span>) =&gt;</span> {
      data[name] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getValue</span>(element);
    });
    <span class="hljs-keyword">return</span> data;
  }

  <span class="hljs-title function_">getValue</span>(<span class="hljs-params">element</span>) {
    <span class="hljs-keyword">if</span> (element.<span class="hljs-property">type</span> === <span class="hljs-string">'checkbox'</span>) {
      <span class="hljs-keyword">return</span> element.<span class="hljs-property">checked</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (element.<span class="hljs-property">type</span> === <span class="hljs-string">'radio'</span>) {
      <span class="hljs-keyword">return</span> element.<span class="hljs-property">checked</span> ? element.<span class="hljs-property">value</span> : <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (element.<span class="hljs-property">type</span> === <span class="hljs-string">'select-multiple'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(element.<span class="hljs-property">selectedOptions</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">opt</span> =&gt;</span> opt.<span class="hljs-property">value</span>);
    }
    <span class="hljs-keyword">return</span> element.<span class="hljs-property">value</span>;
  }

  <span class="hljs-comment">// 验证表单</span>
  <span class="hljs-title function_">validate</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> errors = {};
    <span class="hljs-keyword">const</span> data = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getData</span>();
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">validators</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">validators, fieldName</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> value = data[fieldName];
      <span class="hljs-keyword">const</span> fieldErrors = [];
      
      validators.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">validator</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">validator</span>(value, data);
        <span class="hljs-keyword">if</span> (result !== <span class="hljs-literal">true</span>) {
          fieldErrors.<span class="hljs-title function_">push</span>(result || <span class="hljs-string">`Validation failed for <span class="hljs-subst">${fieldName}</span>`</span>);
        }
      });
      
      <span class="hljs-keyword">if</span> (fieldErrors.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        errors[fieldName] = fieldErrors;
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showFieldError</span>(fieldName, fieldErrors[<span class="hljs-number">0</span>]);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">clearFieldError</span>(fieldName);
      }
    });
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">isValid</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(errors).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>,
      errors,
      data
    };
  }

  <span class="hljs-title function_">showFieldError</span>(<span class="hljs-params">fieldName, message</span>) {
    <span class="hljs-keyword">const</span> field = <span class="hljs-variable language_">this</span>.<span class="hljs-property">fields</span>.<span class="hljs-title function_">get</span>(fieldName);
    <span class="hljs-keyword">if</span> (field) {
      field.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'error'</span>);
      
      <span class="hljs-keyword">let</span> errorElement = field.<span class="hljs-property">parentElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.error-message'</span>);
      <span class="hljs-keyword">if</span> (!errorElement) {
        errorElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
        errorElement.<span class="hljs-property">className</span> = <span class="hljs-string">'error-message'</span>;
        field.<span class="hljs-property">parentElement</span>.<span class="hljs-title function_">appendChild</span>(errorElement);
      }
      errorElement.<span class="hljs-property">textContent</span> = message;
    }
  }

  <span class="hljs-title function_">clearFieldError</span>(<span class="hljs-params">fieldName</span>) {
    <span class="hljs-keyword">const</span> field = <span class="hljs-variable language_">this</span>.<span class="hljs-property">fields</span>.<span class="hljs-title function_">get</span>(fieldName);
    <span class="hljs-keyword">if</span> (field) {
      field.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'error'</span>);
      <span class="hljs-keyword">const</span> errorElement = field.<span class="hljs-property">parentElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.error-message'</span>);
      <span class="hljs-keyword">if</span> (errorElement) {
        errorElement.<span class="hljs-title function_">remove</span>();
      }
    }
  }

  <span class="hljs-comment">// 处理提交</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params">event</span>) {
    event.<span class="hljs-title function_">preventDefault</span>();
    
    <span class="hljs-comment">// 验证</span>
    <span class="hljs-keyword">const</span> validation = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validate</span>();
    <span class="hljs-keyword">if</span> (!validation.<span class="hljs-property">isValid</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Form validation failed:'</span>, validation.<span class="hljs-property">errors</span>);
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 数据转换管道</span>
    <span class="hljs-keyword">let</span> processedData = validation.<span class="hljs-property">data</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> transformer <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">transformers</span>) {
      processedData = <span class="hljs-title function_">transformer</span>(processedData);
    }
    
    <span class="hljs-comment">// 执行提交处理器</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> handler <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">submitHandlers</span>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">handler</span>(processedData);
        <span class="hljs-keyword">if</span> (result === <span class="hljs-literal">false</span> || result?.<span class="hljs-property">stopPropagation</span>) {
          <span class="hljs-keyword">break</span>;
        }
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Submit handler error:'</span>, error);
        <span class="hljs-keyword">break</span>;
      }
    }
  }

  <span class="hljs-comment">// 重置表单</span>
  <span class="hljs-title function_">reset</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">form</span>.<span class="hljs-title function_">reset</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fields</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">field, name</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">clearFieldError</span>(name);
    });
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> formProcessor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormProcessor</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'myForm'</span>))
  .<span class="hljs-title function_">addValidator</span>(<span class="hljs-string">'email'</span>, <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!value) <span class="hljs-keyword">return</span> <span class="hljs-string">'Email is required'</span>;
    <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/^[^\s@]+@[^\s@]+\.[^\s@]+$/</span>.<span class="hljs-title function_">test</span>(value)) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'Invalid email format'</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  })
  .<span class="hljs-title function_">addValidator</span>(<span class="hljs-string">'password'</span>, <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!value) <span class="hljs-keyword">return</span> <span class="hljs-string">'Password is required'</span>;
    <span class="hljs-keyword">if</span> (value.<span class="hljs-property">length</span> &lt; <span class="hljs-number">8</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'Password must be at least 8 characters'</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  })
  .<span class="hljs-title function_">addTransformer</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-comment">// 转换数据</span>
    <span class="hljs-keyword">return</span> {
      ...data,
      <span class="hljs-attr">email</span>: data.<span class="hljs-property">email</span>.<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">trim</span>(),
      <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()
    };
  })
  .<span class="hljs-title function_">onSubmit</span>(<span class="hljs-keyword">async</span> (data) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Submitting data:'</span>, data);
    
    <span class="hljs-comment">// 模拟API调用</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/register'</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
      <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)
    });
    
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Registration failed'</span>);
    }
    
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'Registration successful!'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  })
  .<span class="hljs-title function_">onSubmit</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-comment">// 第二个处理器：发送分析事件</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Analytics event sent for registration'</span>);
  });
</code></pre>
<h4 data-id="heading-24">七、最佳实践与注意事项</h4>
<h5 data-id="heading-25">7.1 中间件模式最佳实践</h5>
<ol>
<li><strong>保持中间件简洁单一:</strong> 每个中间件只做一件事</li>
<li><strong>错误处理:</strong> 确保中间件有适当的错误处理机制</li>
<li><strong>性能考虑:</strong> 避免在中间件中进行昂贵的同步操作</li>
<li><strong>顺序很重要:</strong> 注意中间件的执行顺序对业务逻辑的影响</li>
</ol>
<h5 data-id="heading-26">7.2 管道模式最佳实践</h5>
<ol>
<li><strong>纯函数优先:</strong> 确保管道中的函数是纯函数，避免副作用</li>
<li><strong>类型检查:</strong> 考虑添加运行时类型检查</li>
<li><strong>错误处理:</strong> 现管道级别的错误处理机制</li>
<li><strong>性能优化:</strong> 考虑使用流式处理大数据集</li>
</ol>
<h5 data-id="heading-27">7.3 链式调用最佳实践</h5>
<ol>
<li><strong>返回this:</strong> 确保每个链式方法都返回实例本身</li>
<li><strong>不可变操作:</strong> 考虑实现不可变版本的链式调用</li>
<li><strong>清晰的方法名:</strong> 方法名应该清晰表达其功能</li>
<li><strong>文档完善:</strong> 链式调用可能隐藏复杂度，需要良好文档</li>
</ol>
<h5 data-id="heading-28">7.4 惰性加载最佳实践</h5>
<ol>
<li><strong>适度使用:</strong> 不要过度使用惰性加载，会增加复杂度</li>
<li><strong>预加载策略:</strong> 对于可能很快需要的内容，考虑预加载</li>
<li><strong>错误处理:</strong> 确保惰性加载失败时有降级方案</li>
<li><strong>用户反馈:</strong> 加载过程中给用户适当的反馈</li>
</ol>
<h4 data-id="heading-29">总结</h4>
<p>这四种前端模式-中间件模式、管道模式、链式调用和惰性加载---都是现代前端开发中极其有用的工具。它们各自解决了不同的问题:</p>
<ul>
<li><strong>中间件模式</strong>提供了处理复杂流程的模块化方式</li>
<li><strong>管道模式</strong>让数据转换变得清晰和可组合</li>
<li><strong>链式调用</strong>创造了流畅、易读的API</li>
<li><strong>惰性加载</strong>优化了性能和资源使用</li>
</ul>
<p>掌握这些模式并知道何时使用它们，将帮助你编写更可维护、更高效的前端代码。记住，设计模式是工具，而不是银弹。根据具体场景选择最合适的模式，并始终以代码清晰性和可维护性为首要考虑。</p>
<p>在实际项目中，这些模式经常组合使用。例如，一个API客户端可能同时使用中间件模式处理请求、管道模式处理数据转换、链式调用提供流畅API，并在适当的地方使用惰性加载优化性能。</p>
<p>希望这篇文章能帮助你在前端开发中更好地应用这些强大的模式！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Django 6.0来袭！这些新特性，真的令人振奋！]]></title>    <link>https://juejin.cn/post/7582786655474171947</link>    <guid>https://juejin.cn/post/7582786655474171947</guid>    <pubDate>2025-12-13T03:04:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582786655474171947" data-draft-id="7582785032852701247" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Django 6.0来袭！这些新特性，真的令人振奋！"/> <meta itemprop="keywords" content="Python,Django,人工智能"/> <meta itemprop="datePublished" content="2025-12-13T03:04:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强青铜三"/> <meta itemprop="url" content="https://juejin.cn/user/2942757076730455"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Django 6.0来袭！这些新特性，真的令人振奋！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2942757076730455/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强青铜三
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-13T03:04:24.000Z" title="Sat Dec 13 2025 03:04:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fadamj.eu%2Ftech%2F2025%2F12%2F03%2Fdjango-whats-new-6.0%2F" target="_blank" title="https://adamj.eu/tech/2025/12/03/django-whats-new-6.0/" ref="nofollow noopener noreferrer">adamj.eu/tech/2025/1…</a><br/>
作者：Adam Johnson<br/>
译者：倔强青铜三</p>
<h2 data-id="heading-0">前言</h2>
<p>大家好，我是<strong>倔强青铜三</strong>。欢迎关注我，<strong>微信公众号：倔强青铜三</strong>。欢迎点赞、收藏、关注，一键三连！！！</p>
<p>Django 6.0 已于 2025 年 12 月 3 日发布，为这个已经 20 岁的 Python Web 框架开启了新的发布周期。该版本带来了众多新特性，以下是其中的一些亮点。</p>
<h2 data-id="heading-1">使用 django-upgrade 升级项目</h2>
<p>如果你正在从 Django 5.2 或更早版本升级项目，可以尝试使用我的工具 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdjango-upgrade.readthedocs.io%2Fen%2Flatest%2F" target="_blank" title="https://django-upgrade.readthedocs.io/en/latest/" ref="nofollow noopener noreferrer">django-upgrade</a>。它会自动更新旧的 Django 代码以使用新特性，修复一些弃用警告，包括针对 Django 6.0 的五个修复程序。</p>
<h2 data-id="heading-2">模板局部定义（Template Partials）</h2>
<p>Django 模板语言现在支持模板局部定义（template partials），这使得在模板文件中封装和重用小型命名片段变得更加容易。局部定义由新的 <code>{% partialdef %}</code> 和 <code>{% endpartialdef %}</code> 标签标记，可以在同一模板中重复使用，也可以单独渲染。</p>
<h3 data-id="heading-3">在同一模板中重复使用局部定义</h3>
<p>以下模板在同一个模板中重复使用了一个名为 <code>filter_controls</code> 的局部定义。它在模板顶部定义一次，然后在后面两次使用。使用局部定义可以让模板避免重复，而无需将内容推送到单独的包含文件中。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"videos"</span>&gt;</span>
  {% partialdef filter_controls %}
    <span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
      {{ filter_form }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
  {% endpartialdef %}

  {% partial filter_controls %}

  <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    {% for video in videos %}
      <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{{ video.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        ...
      <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    {% endfor %}
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>

  {% partial filter_controls %}
<span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
</code></pre>
<p>实际上，我们可以通过在 <code>partialdef</code> 标签上使用 <code>inline</code> 选项，进一步简化这种模式，这会导致定义在原地渲染。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"videos"</span>&gt;</span>
  {% partialdef filter_controls inline %}
    <span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
      {{ filter_form }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
  {% endpartialdef %}

  <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    {% for video in videos %}
      <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{{ video.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        ...
      <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    {% endfor %}
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>

  {% partial filter_controls %}
<span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
</code></pre>
<p>当你发现自己在同一个模板中重复模板代码时，可以使用这种模式。因为局部定义可以使用变量，你也可以使用它们来消除重复，当渲染具有不同数据的类似控件时。</p>
<h3 data-id="heading-4">单独渲染局部定义</h3>
<p>以下模板定义了一个 <code>view_count</code> 局部定义，它旨在单独重新渲染。它使用了 <code>inline</code> 选项，因此当整个模板被渲染时，局部定义会被包含。</p>
<p>页面使用了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhtmx.org%2F" target="_blank" title="https://htmx.org/" ref="nofollow noopener noreferrer">htmx</a>，通过我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdjango-htmx.readthedocs.io%2Fen%2Flatest%2F" target="_blank" title="https://django-htmx.readthedocs.io/en/latest/" ref="nofollow noopener noreferrer">django-htmx 包</a>，通过 <code>hx-*</code> 属性定期刷新查看次数。来自 htmx 的请求会发送到一个专用视图，该视图重新渲染 <code>view_count</code> 局部定义。</p>
<pre><code class="hljs language-html" lang="html">{% load django_htmx %}
<span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{{ video.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"1280"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"720"</span> <span class="hljs-attr">controls</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"{{ video.file.url }}"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"video/mp4"</span>&gt;</span>
      Your browser does not support the video tag.
    <span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>

    {% partialdef view_count inline %}
    <span class="hljs-tag">&lt;<span class="hljs-name">section</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"view-count"</span>
      <span class="hljs-attr">hx-trigger</span>=<span class="hljs-string">"every 1s"</span>
      <span class="hljs-attr">hx-swap</span>=<span class="hljs-string">"outerHTML"</span>
      <span class="hljs-attr">hx-get</span>=<span class="hljs-string">"{% url 'video-view-count' video.id %}"</span>
    &gt;</span>
      {{ video.view_count }} views
    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
    {% endpartialdef %}

    {% htmx_script %}
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>两个视图的相关代码可能如下所示：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.shortcuts <span class="hljs-keyword">import</span> render

<span class="hljs-keyword">def</span> <span class="hljs-title function_">video</span>(<span class="hljs-params">request, video_id</span>):
    ...
    <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">"video.html"</span>, {<span class="hljs-string">"video"</span>: video})

<span class="hljs-keyword">def</span> <span class="hljs-title function_">video_view_count</span>(<span class="hljs-params">request, video_id</span>):
    ...
    <span class="hljs-keyword">return</span> render(request, <span class="hljs-string">"video.html#view_count"</span>, {<span class="hljs-string">"video"</span>: video})
</code></pre>
<p>初始的 <code>video</code> 视图渲染了完整的模板 <code>video.html</code>。<code>video_view_count</code> 视图通过在模板名称后附加 <code>#view_count</code> 来仅渲染 <code>view_count</code> 局部定义。这种语法类似于在 URL 中通过其 ID 引用 HTML 片段的方式。</p>
<h2 data-id="heading-5">任务框架（Tasks Framework）</h2>
<p>Django 现在包含了一个内置的任务框架，用于在 HTTP 请求 - 响应周期之外运行代码。这使得可以将工作（如发送电子邮件或处理数据）卸载到后台工作程序中。</p>
<p>本质上，这是一个用于定义和排队后台任务的新 API——非常酷！</p>
<p>后台任务是一种在请求 - 响应周期之外运行代码的方式。它们是 Web 应用程序中的常见需求，用于发送电子邮件、处理图像、生成报告等。</p>
<p>历史上，Django 没有提供任何后台任务系统，而是完全忽略了这个问题。开发人员依赖于第三方包，如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.celeryq.dev%2Fen%2Fstable%2F" target="_blank" title="https://docs.celeryq.dev/en/stable/" ref="nofollow noopener noreferrer">Celery</a> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdjango-q2.readthedocs.io%2Fen%2Fmaster%2F" target="_blank" title="https://django-q2.readthedocs.io/en/master/" ref="nofollow noopener noreferrer">Django Q2</a>。尽管这些系统很好，但它们设置和维护起来可能很复杂，而且通常不符合 Django 的“自然”风格。</p>
<p>新的任务框架通过提供一个定义后台任务的接口来填补这一空白，任务运行器包可以与之集成。这个共同的基础允许第三方 Django 包以标准方式定义任务，假设你会使用兼容的任务运行器来执行它们。</p>
<p>使用新的 <code>@task</code> 装饰器定义任务：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.tasks <span class="hljs-keyword">import</span> task

<span class="hljs-meta">@task</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">resize_video</span>(<span class="hljs-params">video_id</span>):
    ...
</code></pre>
<p>然后使用 <code>Task.enqueue()</code> 方法将它们排队进行后台执行：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> example.tasks <span class="hljs-keyword">import</span> resize_video

<span class="hljs-keyword">def</span> <span class="hljs-title function_">upload_video</span>(<span class="hljs-params">request</span>):
    ...
    resize_video.enqueue(video.<span class="hljs-built_in">id</span>)
    ...
</code></pre>
<h3 data-id="heading-6">执行任务</h3>
<p>目前，Django 并没有包含一个生产就绪的任务后端，只有两个适用于开发和测试的后端：</p>
<ul>
<li><code>ImmediateBackend</code>：同步运行任务，直到它们完成才会阻塞。</li>
<li><code>DummyBackend</code>：当任务被排队时什么都不做，但允许之后检查任务。在测试中很有用，你可以断言任务被排队了，而无需实际运行它们。</li>
</ul>
<p>对于生产使用，你需要使用一个第三方包，其中 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpypi.org%2Fproject%2Fdjango-tasks%2F" target="_blank" title="https://pypi.org/project/django-tasks/" ref="nofollow noopener noreferrer">django-tasks</a> 是主要的选择。它提供了 <code>DatabaseBackend</code>，用于将任务存储在你的 SQL 数据库中，对于许多项目来说是一个很好的解决方案，避免了额外的基础设施，并允许在数据库事务中原子性地排队任务。我们可能会在适当的时候看到这个后端合并到 Django 中，或者至少成为一个官方包，以帮助使 Django 在后台任务方面“开箱即用”。</p>
<p>要使用 django-tasks 的 <code>DatabaseBackend</code>，首先安装该包：</p>
<p>其次，将这两个应用添加到你的 <code>INSTALLED_APPS</code> 设置中：</p>
<pre><code class="hljs language-python" lang="python">INSTALLED_APPS = [
    <span class="hljs-comment"># ...</span>
    <span class="hljs-string">"django_tasks"</span>,
    <span class="hljs-string">"django_tasks.backends.database"</span>,
    <span class="hljs-comment"># ...</span>
]
</code></pre>
<p>第三，将 <code>DatabaseBackend</code> 配置为你的任务后端，使用新的 <code>TASKS</code> 设置：</p>
<pre><code class="hljs language-python" lang="python">TASKS = {
    <span class="hljs-string">"default"</span>: {
        <span class="hljs-string">"BACKEND"</span>: <span class="hljs-string">"django_tasks.backends.database.DatabaseBackend"</span>,
    },
}
</code></pre>
<p>第四，运行迁移以创建必要的数据库表。</p>
<p>最后，要运行任务工作进程，使用包的 <code>db_worker</code> 管理命令：</p>
<pre><code class="hljs language-bash" lang="bash">$ ./manage.py db_worker
Starting worker worker_id=jWLMLrms3C2NcUODYeatsqCFvd5rK6DM queues=default
</code></pre>
<p>该进程会无限期运行，轮询任务并执行它们，同时记录事件：</p>
<pre><code class="hljs language-bash" lang="bash">Task <span class="hljs-built_in">id</span>=10b794ed-9b64-4eed-950c-fcc92cd6784b path=example.tasks.echo state=RUNNING
Hello from <span class="hljs-built_in">test</span> task!
Task <span class="hljs-built_in">id</span>=10b794ed-9b64-4eed-950c-fcc92cd6784b path=example.tasks.echo state=SUCCEEDED
</code></pre>
<p>你希望在生产环境中运行 <code>db_worker</code>，并且如果你希望在开发中测试后台任务执行，也应该运行它。</p>
<h2 data-id="heading-7">内容安全策略（CSP）支持</h2>
<p>Django 现在提供了对 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.djangoproject.com%2Fen%2Fstable%2Ftopics%2Fsecurity%2F%23security-csp" target="_blank" title="https://docs.djangoproject.com/en/stable/topics/security/#security-csp" ref="nofollow noopener noreferrer">内容安全策略（CSP）</a> 标准的内置支持，这使得保护 Web 应用程序免受内容注入攻击（如跨站脚本攻击（XSS））变得更加容易。CSP 允许通过为浏览器提供严格的规则来声明哪些脚本、样式、图像或其他资源可以被加载，从而声明可信的内容来源。</p>
<p>我对此感到非常兴奋，因为我是一个安全爱好者，多年来一直在为客户项目部署 CSP。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTTP%2FGuides%2FCSP" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/HTTP/Guides/CSP" ref="nofollow noopener noreferrer">CSP</a> 是一种安全标准，可以保护你的网站免受跨站脚本攻击（XSS）和其他代码注入攻击。你设置一个 <code>content-security-policy</code> 标头来声明哪些内容来源对你的网站是可信的，然后浏览器会阻止来自其他来源的内容。例如，你可能会声明只有你域名下的脚本才是允许的，因此如果攻击者设法注入一个指向 evil.com 的 <code>&lt;script&gt;</code> 标签，浏览器会阻止加载它，因为该来源未被信任。</p>
<p>以前，Django 没有内置的 CSP 支持，开发人员不得不依赖于自己构建，或者使用像非常流行的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdjango-csp.readthedocs.io%2Fen%2Flatest%2F" target="_blank" title="https://django-csp.readthedocs.io/en/latest/" ref="nofollow noopener noreferrer">django-csp</a> 这样的第三方包。但这有点不方便，因为它意味着其他第三方包无法可靠地与 CSP 集成，因为没有通用的 API 可以使用。</p>
<p>新的 CSP 支持提供了 django-csp 所有的核心功能，并且具有稍微整洁一些且更符合 Django 风格的 API。要开始使用，<strong>首先</strong> 将 <code>ContentSecurityPolicyMiddleware</code> 添加到你的 <code>MIDDLEWARE</code> 设置中：</p>
<pre><code class="hljs language-python" lang="python">MIDDLEWARE = [
    <span class="hljs-comment"># ...</span>
    <span class="hljs-string">"django.middleware.csp.ContentSecurityPolicyMiddleware"</span>,
    <span class="hljs-comment"># ...</span>
]
</code></pre>
<p>将其放置在 <code>SecurityMiddleware</code> 附近，因为它类似于为所有响应添加安全相关标头。（你确实启用了 <code>SecurityMiddleware</code>，对吧？）</p>
<p><strong>其次</strong>，使用新的设置配置你的 CSP 策略：</p>
<ul>
<li><code>SECURE_CSP</code>：配置 <code>content-security-policy</code> 标头，这是你实际执行的策略。</li>
<li><code>SECURE_CSP_REPORT_ONLY</code>：配置 <code>content-security-policy-report-only</code> 标头，这设置了一个非强制策略，浏览器会向指定的端点报告违反策略的情况。这个选项对于在强制执行策略之前测试和监控策略非常有用。</li>
</ul>
<p>例如，要采用 web.dev 推荐的基于 nonce 的严格 CSP，你可以从以下设置开始：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.utils.csp <span class="hljs-keyword">import</span> CSP

SECURE_CSP_REPORT_ONLY = {
    <span class="hljs-string">"script-src"</span>: [CSP.NONCE, CSP.STRICT_DYNAMIC],
    <span class="hljs-string">"object-src"</span>: [CSP.NONE],
    <span class="hljs-string">"base-uri"</span>: [CSP.NONE],
}
</code></pre>
<p>上面使用的 <code>CSP</code> 枚举提供了 CSP 指令的常量，以帮助避免拼写错误。</p>
<p>这个策略非常严格，如果直接部署，会破坏大多数现有网站，因为它需要使用 nonce，接下来会介绍。这就是为什么示例中显示从报告模式标头开始，以帮助在强制执行策略之前跟踪需要修复的地方。你之后会将 <code>SECURE_CSP</code> 设置改为强制执行策略。</p>
<p>总之，这些就是设置新的 CSP 支持的两个基本步骤！</p>
<h3 data-id="heading-8">随机数生成（Nonce Generation）</h3>
<p>新特性的关键部分之一是，当使用 CSP 中间件时，Django 现在内置了 <strong>随机数生成</strong> 功能。随机数是 CSP 中的一种安全特性，允许你通过在 <code>&lt;script&gt;</code> 和 <code>&lt;style&gt;</code> 标签上使用 <code>nonce</code> 属性来标记特定的标签为可信的：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/static/app.js"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">"55vsH4w7ATHB85C3MbPr_g"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>随机数值是按请求随机生成的，并包含在 CSP 标头中。执行内容注入的攻击者无法猜测随机数，因此浏览器可以只信任那些包含正确随机数的标签。因为随机数生成现在是 Django 的一部分，第三方包可以依赖它为它们的 <code>&lt;script&gt;</code> 和 <code>&lt;style&gt;</code> 标签提供随机数，如果你采用带有随机数的 CSP，它们将继续工作。</p>
<p>随机数是当今使用 CSP 的推荐方式，避免了以前基于允许列表的方法所带来的问题。这就是为什么上面推荐的策略启用了随机数。要采用基于随机数的策略，你需要通过以下步骤为 <code>&lt;script&gt;</code> 和 <code>&lt;style&gt;</code> 标签添加随机数值。</p>
<p><strong>首先</strong>，将新的 <code>csp</code> 模板上下文处理器添加到你的 <code>TEMPLATES</code> 设置中：</p>
<pre><code class="hljs language-python" lang="python">TEMPLATES = [
    {
        <span class="hljs-string">"BACKEND"</span>: <span class="hljs-string">"django.template.backends.django.DjangoTemplates"</span>,
        <span class="hljs-string">"OPTIONS"</span>: {
            <span class="hljs-string">"context_processors"</span>: [
                <span class="hljs-comment"># ...</span>
                <span class="hljs-string">"django.template.context_processors.csp"</span>,
            ],
        },
    },
]
</code></pre>
<p><strong>其次</strong>，使用 <code>nonce="{{ csp_nonce }}"</code> 为 <code>&lt;script&gt;</code> 和 <code>&lt;style&gt;</code> 标签添加注释：</p>
<pre><code class="hljs language-html" lang="html">-   <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"{% static 'app.js' %}"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
+   <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"{% static 'app.js' %}"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">"{{ csp_nonce }}"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>这可能会很繁琐且容易出错，因此首先使用报告模式来监控违规情况可能会很有用，尤其是在大型项目中。</p>
<p>总之，正确部署 CSP 可能会成为另一篇博文的主题，甚至是一本书的章节，所以我们就先说到这里。更多信息，请查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Farticles%2Fstrict-csp" target="_blank" title="https://web.dev/articles/strict-csp" ref="nofollow noopener noreferrer">web.dev 文章</a>和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTTP%2FCSP" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" ref="nofollow noopener noreferrer">MDN CSP 指南</a>。</p>
<h2 data-id="heading-9">邮件 API 更新</h2>
<p>Django 中的邮件处理现在使用了 Python 的现代邮件 API，该 API 在 Python 3.6 中引入。这个以 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.python.org%2F3%2Flibrary%2Femail.message.html%23email.message.EmailMessage" target="_blank" title="https://docs.python.org/3/library/email.message.html#email.message.EmailMessage" ref="nofollow noopener noreferrer"><code>email.message.EmailMessage</code></a> 类为中心的 API，为撰写和发送邮件提供了一个更简洁且支持 Unicode 的接口。</p>
<p>这是一个重大变化，但如果你的项目只使用基本的邮件功能，可能不会受到影响。你仍然可以像以前一样使用 Django 的 <code>send_mail()</code> 函数和 <code>EmailMessage</code> 类，例如：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.core.mail <span class="hljs-keyword">import</span> EmailMessage

email = EmailMessage(
    subject=<span class="hljs-string">"🐼 需要更多竹子"</span>,
    body=<span class="hljs-string">"我们的竹子快没了，请在熊猫发现之前补货！"</span>,
    from_email=<span class="hljs-string">"zookeeper@example.com"</span>,
    to=[<span class="hljs-string">"supplies@example.com"</span>],
)
email.attach_file(<span class="hljs-string">"/media/bamboo_cupboard.jpg"</span>)
email.send()
</code></pre>
<p>关键的变化是，在你调用 Django <code>EmailMessage</code> 对象的 <code>send()</code> 方法时，它现在会在发送之前将自己转换为 Python 的新 <code>email.message.EmailMessage</code> 类型。</p>
<p>现代化带来了以下好处：</p>
<ol>
<li><strong>更少的错误</strong>：Python 旧邮件 API 中的许多边缘情况错误已在新 API 中修复。</li>
<li><strong>Django 更简洁</strong>：Django 邮件代码中的一系列变通方法和安全修复已被移除。</li>
<li><strong>更方便的 API</strong>：新 API 支持一些便利功能，例如下面的内联附件示例。</li>
</ol>
<h3 data-id="heading-10">使用 <code>MIMEPart</code> 更容易地添加内联附件</h3>
<p>Django 的 <code>EmailMessage.attach()</code> 方法允许你将文件作为附件添加。电子邮件支持图像作为 <strong>内联附件</strong>，这些图像可以显示在 HTML 邮件正文中。</p>
<p>虽然你以前可以使用 <code>EmailMessage.attach()</code> 添加内联附件，但操作起来有点复杂，需要使用一个遗留类。现在，你可以通过调用该方法并传入一个 Python 的 <code>email.message.MIMEPart</code> 对象，在几个步骤中添加内联附件：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> email.utils
<span class="hljs-keyword">from</span> email.message <span class="hljs-keyword">import</span> MIMEPart
<span class="hljs-keyword">from</span> django.core.mail <span class="hljs-keyword">import</span> EmailMultiAlternatives

message = EmailMultiAlternatives(
    subject=<span class="hljs-string">"可爱熊猫警报"</span>,
    body=<span class="hljs-string">"这里有一张可爱的熊猫照片送给你！"</span>,
    from_email=<span class="hljs-string">"cute@example.com"</span>,
    to=[<span class="hljs-string">"fans@example.com"</span>],
)
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"panda.jpg"</span>, <span class="hljs-string">"rb"</span>) <span class="hljs-keyword">as</span> f:
    panda_jpeg = f.read()

cid = email.utils.make_msgid()
inline_image = MIMEPart()
inline_image.set_content(
    panda_jpeg,
    maintype=<span class="hljs-string">"image"</span>,
    subtype=<span class="hljs-string">"jpeg"</span>,
    disposition=<span class="hljs-string">"inline"</span>,
    cid=cid,
)
message.attach(inline_image)
message.attach_alternative(
    <span class="hljs-string">f'&lt;h1&gt;可爱熊猫宝宝警报！&lt;/h1&gt;&lt;img src="cid:<span class="hljs-subst">{cid[<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>]}</span>"&gt;'</span>,
    <span class="hljs-string">"text/html"</span>,
)
</code></pre>
<p>这个 API 并不简单，但它确实提供了底层邮件系统的全部功能，并且比过去的情况更好。</p>
<h2 data-id="heading-11">位置参数在 <code>django.core.mail</code> API 中的弃用</h2>
<p>我们现在已经完成了主要功能，接下来是与上述邮件更改相关的“次要”更改，这是一个弃用警告：</p>
<blockquote>
<p><code>django.core.mail</code> API 现在要求对于不太常用的参数使用关键字参数。使用这些参数的位置参数现在会发出一个弃用警告，并且在弃用期结束后将引发一个 <code>TypeError</code>：</p>
<ul>
<li>所有可选参数（<code>fail_silently</code> 及之后的参数）必须作为关键字参数传递给 <code>get_connection()</code>、<code>mail_admins()</code>、<code>mail_managers()</code>、<code>send_mail()</code> 和 <code>send_mass_mail()</code>。</li>
<li>在创建 <code>EmailMessage</code> 或 <code>EmailMultiAlternatives</code> 实例时，除了前四个参数（<code>subject</code>、<code>body</code>、<code>from_email</code> 和 <code>to</code>）可以作为位置参数或关键字参数传递外，所有其他参数都必须作为关键字参数传递。</li>
</ul>
</blockquote>
<p>以前，Django 允许你将所有参数作为位置参数传递，这在参数列表较长时会显得有些愚蠢且难以阅读，例如：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.core.mail <span class="hljs-keyword">import</span> send_mail

send_mail(
    <span class="hljs-string">"🐼 本周的熊猫"</span>,
    <span class="hljs-string">"本周的熊猫是 Po Ping，sha-sha booey！"</span>,
    <span class="hljs-string">"updates@example.com"</span>,
    [<span class="hljs-string">"adam@example.com"</span>],
    <span class="hljs-literal">True</span>,
)
</code></pre>
<p>最后一个 <code>True</code> 没有提供任何线索，除非你查找函数签名。现在，使用这些不太常用的参数的位置参数会发出一个弃用警告，提示你写成如下形式：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.core.mail <span class="hljs-keyword">import</span> send_mail

send_mail(
    subject=<span class="hljs-string">"🐼 本周的熊猫"</span>,
    body=<span class="hljs-string">"本周的熊猫是 Po Ping，sha-sha booey！"</span>,
    from_email=<span class="hljs-string">"updates@example.com"</span>,
    recipient_list=[<span class="hljs-string">"adam@example.com"</span>],
    fail_silently=<span class="hljs-literal">True</span>,
)
</code></pre>
<p>这种变化有助于提高 API 的清晰度，Django 正在逐步更多地使用仅关键字参数。django-upgrade 可以通过其 <code>mail_api_kwargs</code> 修复程序自动为你修复这一问题。</p>
<p>再次感谢 Mike Edmunds 在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.djangoproject.com%2Fticket%2F36163" target="_blank" title="https://code.djangoproject.com/ticket/36163" ref="nofollow noopener noreferrer">Ticket #36163</a> 中推动了这一改进。</p>
<h2 data-id="heading-12">扩展自动 <code>shell</code> 导入</h2>
<p>接下来：</p>
<blockquote>
<p>现在默认情况下，<code>django.conf.settings</code> 等常用工具会自动导入到 shell 中。</p>
</blockquote>
<p>Django 5.2 的一个主要功能是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fadamj.eu%2Ftech%2F2025%2F04%2F07%2Fdjango-whats-new-5.2%2F%23automatic-model-imports-in-the-shell" target="_blank" title="https://adamj.eu/tech/2025/04/07/django-whats-new-5.2/#automatic-model-imports-in-the-shell" ref="nofollow noopener noreferrer">shell 中的自动模型导入</a>，使得 <code>./manage.py shell</code> 自动导入所有模型。在此基础上，Django 6.0 现在还导入了其他常用工具，我们可以通过运行 <code>./manage.py shell</code> 并添加 <code>-v 2</code> 参数来查看完整的导入列表：</p>
<pre><code class="hljs language-bash" lang="bash">$ ./manage.py shell -v 2
6 objects imported automatically:

  from django.conf import settings
  from django.db import connection, models, reset_queries
  from django.db.models import <span class="hljs-built_in">functions</span>
  from django.utils import timezone

...
</code></pre>
<p>（这是从一个没有模型的项目中得到的输出，因此只列出了工具。）</p>
<p>所以，这些包括：</p>
<ul>
<li><code>settings</code>：用于检查运行时配置，非常有用：</li>
</ul>
<pre><code class="hljs language-python" lang="python">In [<span class="hljs-number">1</span>]: settings.DEBUG
Out[<span class="hljs-number">1</span>]: <span class="hljs-literal">False</span>
</code></pre>
<ul>
<li><code>connection</code> 和 <code>reset_queries()</code>：非常适合 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.djangoproject.com%2Fen%2Fstable%2Ffaq%2Fmodels%2F%23how-can-i-see-the-raw-sql-queries-django-is-running" target="_blank" title="https://docs.djangoproject.com/en/stable/faq/models/#how-can-i-see-the-raw-sql-queries-django-is-running" ref="nofollow noopener noreferrer">检查执行的查询</a>：</li>
</ul>
<pre><code class="hljs language-python" lang="python">In [<span class="hljs-number">1</span>]: Book.objects.select_related(<span class="hljs-string">'author'</span>)
Out[<span class="hljs-number">1</span>]: &lt;QuerySet []&gt;

In [<span class="hljs-number">2</span>]: connection.queries
Out[<span class="hljs-number">2</span>]:
[{<span class="hljs-string">'sql'</span>: <span class="hljs-string">'SELECT "example_book"."id", "example_book"."title", "example_book"."author_id", "example_author"."id", "example_author"."name" FROM "example_book" INNER JOIN "example_author" ON ("example_book"."author_id" = "example_author"."id") LIMIT 21'</span>,
    <span class="hljs-string">'time'</span>: <span class="hljs-string">'0.000'</span>}]
</code></pre>
<ul>
<li><code>models</code> 和 <code>functions</code>：对于高级 ORM 工作非常有用：</li>
</ul>
<pre><code class="hljs language-python" lang="python">In [<span class="hljs-number">1</span>]: Book.objects.annotate(
     ...:   title_lower=functions.Lower(<span class="hljs-string">"title"</span>)
     ...: ).<span class="hljs-built_in">filter</span>(
     ...:   title_lower__startswith=<span class="hljs-string">"a"</span>
     ...: ).count()
Out[<span class="hljs-number">1</span>]: <span class="hljs-number">71</span>
</code></pre>
<ul>
<li><code>timezone</code>：用于使用 Django 的时区感知日期和时间工具：</li>
</ul>
<pre><code class="hljs language-python" lang="python">In [<span class="hljs-number">1</span>]: timezone.now()
Out[<span class="hljs-number">1</span>]: datetime.datetime(<span class="hljs-number">2025</span>, <span class="hljs-number">12</span>, <span class="hljs-number">1</span>, <span class="hljs-number">23</span>, <span class="hljs-number">42</span>, <span class="hljs-number">22</span>, <span class="hljs-number">558418</span>, tzinfo=datetime.timezone.utc)
</code></pre>
<p>仍然可以按照 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.djangoproject.com%2Fen%2Fstable%2Fhowto%2Fcustom-shell%2F" target="_blank" title="https://docs.djangoproject.com/en/stable/howto/custom-shell/" ref="nofollow noopener noreferrer">如何自定义 <code>shell</code> 命令</a> 文档页面中所述，扩展自动导入内容。</p>
<p>Salvo Polizzi 在 Django 5.2 中贡献了原始的自动 shell 导入功能。然后，他在 Django 6.0 中又回来提供了这些额外的导入，在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.djangoproject.com%2Fticket%2F35680" target="_blank" title="https://code.djangoproject.com/ticket/35680" ref="nofollow noopener noreferrer">Ticket #35680</a> 中。感谢参与论坛讨论并达成一致意见的每个人，以及 Natalia Bidart 和 Sarah Boyce 的审查！</p>
<h2 data-id="heading-13">保存时动态字段刷新</h2>
<p>现在让我们讨论一系列 ORM 改进，从这个重大改进开始：</p>
<blockquote>
<p>在支持 <code>RETURNING</code> 子句的后端（SQLite、PostgreSQL 和 Oracle）上，<code>GeneratedField</code> 和被赋值为表达式的字段在调用 <code>save()</code> 之后会从数据库中刷新。在不支持它的后端（MySQL 和 MariaDB）上，字段会被标记为延迟加载，以在后续访问时触发刷新。</p>
</blockquote>
<p>Django 模型支持在三种情况下让数据库为你生成字段值：</p>
<ol>
<li><code>db_default</code> 字段选项，它允许数据库在创建实例时生成默认值：</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> models
<span class="hljs-keyword">from</span> django.db.models.functions <span class="hljs-keyword">import</span> Now

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Video</span>(models.Model):
    ...
    created = models.DateTimeField(db_default=Now())
</code></pre>
<ol start="2">
<li><code>GeneratedField</code> 字段类型，它始终基于同一实例中的其他字段由数据库计算得出：</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> models
<span class="hljs-keyword">from</span> django.db.models.functions <span class="hljs-keyword">import</span> Concat

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Video</span>(models.Model):
    ...
    full_title = models.GeneratedField(
        models.TextField(),
        expression=Concat(
            <span class="hljs-string">"title"</span>,
            models.Value(<span class="hljs-string">" - "</span>),
            <span class="hljs-string">"subtitle"</span>,
        ),
    )
</code></pre>
<ol start="3">
<li>在保存之前为字段分配表达式值：</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> models
<span class="hljs-keyword">from</span> django.db.models.functions <span class="hljs-keyword">import</span> Now

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Video</span>(models.Model):
    ...
    last_updated = models.DateTimeField()

video = Video.objects.get(<span class="hljs-built_in">id</span>=<span class="hljs-number">1</span>)
...
video.last_updated = Now()
video.save()
</code></pre>
<p>以前，只有第一种方法（使用 <code>db_default</code>）会在保存后从数据库中刷新字段值。其他两种方法会留下旧值或表达式对象，这意味着如果你需要获取更新后的值，就需要调用 <code>Model.refresh_from_db()</code>。这很难记住，并且会额外产生一个数据库查询。</p>
<p>现在，Django 利用 <code>RETURNING</code> SQL 子句在支持它的后端（SQLite、PostgreSQL 和 Oracle）上保存模型实例，并在单个查询中获取更新后的动态字段值。<code>save()</code> 调用现在可能会发出如下查询：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">UPDATE</span> "example_video"
<span class="hljs-keyword">SET</span> "last_updated" <span class="hljs-operator">=</span> NOW()
<span class="hljs-keyword">WHERE</span> "example_video"."id" <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
RETURNING "example_video"."last_updated"
</code></pre>
<p>Django 将返回值放入模型字段中，因此你可以在保存后立即读取它：</p>
<pre><code class="hljs language-python" lang="python">video = Video.objects.get(<span class="hljs-built_in">id</span>=<span class="hljs-number">1</span>)
...
video.last_updated = Now()
video.save()
<span class="hljs-built_in">print</span>(video.last_updated)  <span class="hljs-comment"># 数据库中的更新值</span>
</code></pre>
<p>在不支持 <code>RETURNING</code>（MySQL 和 MariaDB）的后端上，Django 现在会在保存后将动态字段标记为延迟加载。这样，后续访问（如上面的示例）将自动调用 <code>Model.refresh_from_db()</code>。这确保了你总是读取更新后的值，即使这会额外产生一个查询。</p>
<h3 data-id="heading-14">历史</h3>
<p>这个功能在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.djangoproject.com%2Fticket%2F27222" target="_blank" title="https://code.djangoproject.com/ticket/27222" ref="nofollow noopener noreferrer">Ticket #27222</a> 中于 2016 年被提出，由 Anssi Kääriäinen 提出。在过去的九年中，这个提议大部分时间都处于休眠状态，但 ORM 负责人 Simon Charette 今年早些时候接手了这个功能，找到了一个实现方案，并将其推动完成。感谢 Simon 继续推动 ORM 的发展，以及所有参与审查的人员：David Sanders、Jacob Walls、Mariusz Felisiak、nessita、Paolo Melchiorre、Simon Charette 和 Tim Graham。</p>
<h2 data-id="heading-15">通用 <code>StringAgg</code> 聚合函数</h2>
<p>接下来是 ORM 的另一个变化：</p>
<blockquote>
<p>新的 <code>StringAgg</code> 聚合函数将输入值连接成一个字符串，以 <code>delimiter</code> 字符串分隔。这个聚合函数以前仅支持 PostgreSQL。</p>
</blockquote>
<p>这个聚合函数通常用于生成相关项目的逗号分隔列表等。以前，它仅作为 <code>django.contrib.postgres</code> 的一部分支持 PostgreSQL：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.contrib.postgres.aggregates <span class="hljs-keyword">import</span> StringAgg
<span class="hljs-keyword">from</span> example.models <span class="hljs-keyword">import</span> Video

videos = Video.objects.annotate(
    chapter_ids=StringAgg(<span class="hljs-string">"chapter"</span>, delimiter=<span class="hljs-string">","</span>),
)

<span class="hljs-keyword">for</span> video <span class="hljs-keyword">in</span> videos:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Video <span class="hljs-subst">{video.<span class="hljs-built_in">id</span>}</span> has chapters: <span class="hljs-subst">{video.chapter_ids}</span>"</span>)
</code></pre>
<p>这可能会输出如下内容：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Video</span> <span class="hljs-number">104</span> <span class="hljs-selector-tag">has</span> <span class="hljs-selector-tag">chapters</span>: <span class="hljs-number">71</span>,<span class="hljs-number">72</span>,<span class="hljs-number">74</span>
<span class="hljs-selector-tag">Video</span> <span class="hljs-number">107</span> <span class="hljs-selector-tag">has</span> <span class="hljs-selector-tag">chapters</span>: <span class="hljs-number">88</span>,<span class="hljs-number">89</span>,<span class="hljs-number">138</span>,<span class="hljs-number">90</span>,<span class="hljs-number">91</span>,<span class="hljs-number">93</span>
</code></pre>
<p>现在，这个聚合函数已经可以在 Django 支持的所有数据库后端中使用，从 <code>django.db.models</code> 中导入：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.db.models <span class="hljs-keyword">import</span> StringAgg, Value
<span class="hljs-keyword">from</span> example.models <span class="hljs-keyword">import</span> Video

videos = Video.objects.annotate(
    chapter_ids=StringAgg(<span class="hljs-string">"chapter"</span>, delimiter=Value(<span class="hljs-string">","</span>)),
)

<span class="hljs-keyword">for</span> video <span class="hljs-keyword">in</span> videos:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Video <span class="hljs-subst">{video.<span class="hljs-built_in">id</span>}</span> has chapters: <span class="hljs-subst">{video.chapter_ids}</span>"</span>)
</code></pre>
<p>注意，<code>delimiter</code> 参数现在需要一个 <code>Value()</code> 表达式包装器来处理字面字符串，如上所示。这种变化允许你使用数据库函数或字段作为分隔符（如果需要）。</p>
<p>虽然大多数 Django 项目都使用 PostgreSQL，但在所有后端上提供这个聚合函数是一个很好的改进，它提高了跨数据库的兼容性，并且意味着第三方包可以使用它而不会影响其数据库支持。</p>
<h3 data-id="heading-16">历史</h3>
<p>PostgreSQL 特有的 <code>StringAgg</code> 最早在 Django 1.9（2015 年）由 Andriy Sokolovskiy 添加，见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.djangoproject.com%2Fticket%2F24301" target="_blank" title="https://code.djangoproject.com/ticket/24301" ref="nofollow noopener noreferrer">Ticket #24301</a>。在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.djangoproject.com%2Fticket%2F35444" target="_blank" title="https://code.djangoproject.com/ticket/35444" ref="nofollow noopener noreferrer">Ticket #35444</a> 中，Chris Muthig 提出了添加 <code>Aggregate.order_by</code> 选项，这是 <code>StringAgg</code> 用来指定连接元素顺序的选项，而作为副作用，这也使得将 <code>StringAgg</code> 推广到所有后端成为可能。</p>
<p>感谢 Chris 提出并实现了这一变化，以及所有参与审查的人员：Paolo Melchiorre、Sarah Boyce 和 Simon Charette。</p>
<h2 data-id="heading-17"><code>BigAutoField</code> 作为默认主键类型</h2>
<p>接下来：</p>
<blockquote>
<p><code>DEFAULT_AUTO_FIELD</code> 设置的默认值现在改为 <code>BigAutoField</code>。</p>
</blockquote>
<p>这一重要变化有助于锁定更大规模的可扩展主键。</p>
<p>Django 3.2（2021 年）引入了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.djangoproject.com%2Fen%2Fstable%2Fref%2Fsettings%2F%23default-auto-field" target="_blank" title="https://docs.djangoproject.com/en/stable/ref/settings/#default-auto-field" ref="nofollow noopener noreferrer">DEFAULT_AUTO_FIELD 设置</a>，用于更改模型中使用的默认主键类型。Django 使用这个设置为未显式定义主键字段的模型添加一个名为 <code>id</code> 的主键字段。例如，如果你定义了一个模型如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> models

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Video</span>(models.Model):
    title = models.TextField()
</code></pre>
<p>那么它将有两个字段：<code>id</code> 和 <code>title</code>，其中 <code>id</code> 使用 <code>DEFAULT_AUTO_FIELD</code> 定义的类型。</p>
<p>这个设置也可以通过在应用的 <code>apps.py</code> 文件中定义 <code>AppConfig.default_auto_field</code> 来在每个应用的基础上覆盖：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.apps <span class="hljs-keyword">import</span> AppConfig

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChannelConfig</span>(<span class="hljs-title class_ inherited__">AppConfig</span>):
    name = <span class="hljs-string">"channel"</span>
    default_auto_field = <span class="hljs-string">"django.db.models.BigAutoField"</span>
</code></pre>
<p>添加这个设置的一个主要动机是允许项目从 <code>AutoField</code>（32 位整数）切换到 <code>BigAutoField</code>（64 位整数）作为主键，而无需更改每个模型。<code>AutoField</code> 可以存储的值最多约为 21 亿，虽然听起来很大，但在大规模应用中很容易达到。<code>BigAutoField</code> 可以存储的值最多约为 92 京，这在实际用途中是“绰绰有余”的。</p>
<p>如果使用 <code>AutoField</code> 的模型达到了其最大值，它将无法再接受新行，这个问题被称为 <strong>主键耗尽</strong>。该表实际上被阻塞了，需要通过锁定数据库迁移在大型表上紧急将模型从 <code>AutoField</code> 切换到 <code>BigAutoField</code>。关于 Kraken 如何修复这个问题，可以观看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DkZ4q0k_FNhw" target="_blank" title="https://www.youtube.com/watch?v=kZ4q0k_FNhw" ref="nofollow noopener noreferrer">Tim Bell 在 2025 年 DjangoCon Europe 的演讲</a>，其中详细介绍了主动迁移大型表以减少停机时间的一些巧妙技术。</p>
<p>为了避免新项目出现这个问题，Django 3.2 使得通过 <code>startproject</code> 创建的新项目将 <code>DEFAULT_AUTO_FIELD</code> 设置为 <code>BigAutoField</code>，并且通过 <code>startapp</code> 创建的新应用将它们的 <code>AppConfig.default_auto_field</code> 设置为 <code>BigAutoField</code>。它还添加了一个系统检查，以确保项目显式设置 <code>DEFAULT_AUTO_FIELD</code>，以确保用户了解该功能并能够做出明智的选择。</p>
<p>现在，Django 6.0 将设置和应用配置属性的实际默认值改为 <code>BigAutoField</code>。使用 <code>BigAutoField</code> 的项目可以移除该设置：</p>
<pre><code class="hljs language-python" lang="python">-DEFAULT_AUTO_FIELD = <span class="hljs-string">"django.db.models.BigAutoField"</span>
</code></pre>
<p>以及应用配置属性：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.apps <span class="hljs-keyword">import</span> AppConfig

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChannelConfig</span>(<span class="hljs-title class_ inherited__">AppConfig</span>):
    name = <span class="hljs-string">"channel"</span>
-    default_auto_field = <span class="hljs-string">"django.db.models.BigAutoField"</span>
</code></pre>
<p>默认的 <code>startproject</code> 和 <code>startapp</code> 模板也不再设置这些值。这一变化减少了新项目的样板代码，主键耗尽问题也将逐渐成为历史，成为大多数 Django 用户不再需要考虑的问题。</p>
<h3 data-id="heading-18">历史</h3>
<p>在 Django 3.2 中添加 <code>DEFAULT_AUTO_FIELD</code> 是由 Caio Ariede 提出并由 Tom Forbes 实现的，见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.djangoproject.com%2Fticket%2F31007" target="_blank" title="https://code.djangoproject.com/ticket/31007" ref="nofollow noopener noreferrer">Ticket #31007</a>。Django 6.0 中的这一新变化是由前 Fellow Tim Graham 提出并实现的，见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.djangoproject.com%2Fticket%2F36564" target="_blank" title="https://code.djangoproject.com/ticket/36564" ref="nofollow noopener noreferrer">Ticket #36564</a>。感谢 Tim 发现现在可以进行这一清理工作，以及 Jacob Walls 和 Clifford Gama 的审查！</p>
<h2 data-id="heading-19">模板变量 <code>forloop.length</code></h2>
<p>继续来看模板方面的改进，首先是这个小而实用的新增功能：</p>
<blockquote>
<p>在 <code>for</code> 循环中现在可以使用新的变量 <code>forloop.length</code>。</p>
</blockquote>
<p>这一小扩展使得你可以编写如下模板循环：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
  {% for goose in geese %}
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>{{ forloop.counter }}/{{ forloop.length }}<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>: {{ goose.name }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  {% endfor %}
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
</code></pre>
<p>以前，你需要通过其他方式引用长度，例如 <code>{{ geese|length }}</code>，这稍显不够灵活。</p>
<p>感谢 Jonathan Ströbele 在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.djangoproject.com%2Fticket%2F36186" target="_blank" title="https://code.djangoproject.com/ticket/36186" ref="nofollow noopener noreferrer">Ticket #36186</a> 中贡献了这个想法和实现，以及 David Smith、Paolo Melchiorre 和 Sarah Boyce 的审查。</p>
<h2 data-id="heading-20"><code>querystring</code> 模板标签增强</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.djangoproject.com%2Fen%2Fstable%2Fref%2Ftemplates%2Fbuiltins%2F%23django-template" target="_blank" title="https://docs.djangoproject.com/en/stable/ref/templates/builtins/#django-template" ref="nofollow noopener noreferrer">Django 5.1 中引入的 <code>querystring</code> 模板标签</a> 用于帮助构建修改当前请求查询参数的链接，现在有了两个扩展。</p>
<ol>
<li>发行说明：</li>
</ol>
<blockquote>
<p><code>querystring</code> 模板标签现在始终在返回的查询字符串前加上 <code>?</code>，确保链接生成行为的可靠性。</p>
</blockquote>
<p>这一小变化改进了在提供空查询参数映射时标签的行为。假设你有一个模板如下：</p>
<pre><code class="hljs language-django" lang="django">&lt;a href="{% querystring params %}"&gt;Reset search&lt;/a&gt;
</code></pre>
<p>其中 <code>params</code> 是一个可能有时为空的字典。以前，如果 <code>params</code> 为空，输出将是：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">""</span>&gt;</span>Reset search<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre>
<p>浏览器会将此视为指向相同 URL（包括查询参数）的链接，因此不会清除查询参数，这与预期不符。现在，有了这一变化，输出将是：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"?"</span>&gt;</span>Reset search<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre>
<p>浏览器会将 <code>?</code> 视为指向相同 URL（不带任何查询参数）的链接，从而清除查询参数，符合用户的期望。</p>
<p>感谢 Django Fellow Sarah Boyce 发现这一改进并实现了修复，见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.djangoproject.com%2Fticket%2F36268" target="_blank" title="https://code.djangoproject.com/ticket/36268" ref="nofollow noopener noreferrer">Ticket #36268</a>，以及 Django Fellow Natalia Bidart 的审查！</p>
<ol start="2">
<li>发行说明：</li>
</ol>
<blockquote>
<p><code>querystring</code> 模板标签现在可以接受多个位置参数，这些参数必须是映射，例如 <code>QueryDict</code> 或 <code>dict</code>。</p>
</blockquote>
<p>这一增强功能允许标签在构建输出时合并多个查询参数来源。例如，你可能有一个模板如下：</p>
<pre><code class="hljs language-django" lang="django">&lt;a href="{% querystring request.GET super_search_params %}"&gt;Super search&lt;/a&gt;
</code></pre>
<p>其中 <code>super_search_params</code> 是一个包含额外参数的字典，用于将当前搜索升级为“超级搜索”。该标签会合并这两个映射，对于重复的键，后面的映射将优先。</p>
<p>再次感谢 Sarah Boyce 在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.djangoproject.com%2Fticket%2F35529" target="_blank" title="https://code.djangoproject.com/ticket/35529" ref="nofollow noopener noreferrer">Ticket #35529</a> 中提出这一改进，Giannis Terzopoulos 实现了它，以及 Natalia Bidart、Sarah Boyce 和 Tom Carrick 的审查！</p>
<h2 data-id="heading-21">结语</h2>
<p>以上就是本次 Django 6.0 的亮点总结！感谢你的阅读。更多变化可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.djangoproject.com%2Fen%2Fstable%2Freleases%2F6.0%2F" target="_blank" title="https://docs.djangoproject.com/en/stable/releases/6.0/" ref="nofollow noopener noreferrer">发行说明</a> 中查看。</p>
<p>此外，还有许多未进入发行说明的幕后改进和错误修复。优化和微小改进一直在被合并，所以不要延迟，现在就升级吧！</p>
<p>感谢为 Django 6.0 贡献的 <strong>174 人</strong>，这一数字由 Mariusz Felisiak 在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgist.github.com%2Ffelixxm%2F99501cdbf6ed5a69295b4cb3f8c21d80" target="_blank" title="https://gist.github.com/felixxm/99501cdbf6ed5a69295b4cb3f8c21d80" ref="nofollow noopener noreferrer">此列表</a> 中统计。</p>
<p>愿你的升级过程迅速、顺利、安全且可靠！</p>
<blockquote>
<p>最后感谢阅读！欢迎关注我，微信公众号： <strong>倔强青铜三</strong>。<br/>
<strong>点赞、收藏、关注</strong>，一键三连！！<br/>
欢迎 点击 <strong>【👍喜欢作者】</strong> 按钮进行 <strong>打赏💰💰</strong>，请我喝一杯咖啡☕️！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>