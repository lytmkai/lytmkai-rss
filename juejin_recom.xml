<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[.sync 修饰符 | vue前端知识]]></title>    <link>https://juejin.cn/post/7574286569038168127</link>    <guid>https://juejin.cn/post/7574286569038168127</guid>    <pubDate>2025-11-19T17:32:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574286569038168127" data-draft-id="7574281453707837446" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=".sync 修饰符 | vue前端知识"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-19T17:32:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南洋芋嘘片"/> <meta itemprop="url" content="https://juejin.cn/user/1889439483175402"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            .sync 修饰符 | vue前端知识
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1889439483175402/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南洋芋嘘片
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T17:32:00.000Z" title="Wed Nov 19 2025 17:32:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">.sync 修饰符</h2>
<p>在 Vue 2 中，<code>.sync</code> 修饰符是实现父子组件双向数据绑定的语法糖，特别适合用于弹窗这类需要子组件修改父组件状态的场景。</p>
<h3 data-id="heading-1">基本概念</h3>
<p><code>.sync</code> 修饰符，实际上就是将父组件的属性，通过 <code>.sync</code> 修饰符，映射到子组件的 <code>props</code> 属性中，并监听子组件的 <code>props</code> 属性的修改，将修改后的值，通过 <code>$emit</code> 事件发送给父组件，从而实现父子组件的数据同步。</p>
<p>本质是自动为你扩展了一个 <code>v-on</code> 监听器。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 使用 .sync 的写法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> <span class="hljs-attr">:visible.sync</span>=<span class="hljs-string">"dialogVisible"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- 等效于完整写法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span>
    <span class="hljs-attr">:visible</span>=<span class="hljs-string">"dialogVisible"</span>
    @<span class="hljs-attr">update:visible</span>=<span class="hljs-string">"val =&gt; dialogVisible = val"</span>
/&gt;</span>
</code></pre>
<h3 data-id="heading-2">举例</h3>
<h4 data-id="heading-3">1. 引入并注册弹窗组件</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">MyDialog</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./MyDialog.vue"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-attr">components</span>: {
        <span class="hljs-title class_">MyDialog</span>,
    },
    <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">showDialog</span>: <span class="hljs-literal">false</span>,
        };
    },
};
</code></pre>
<h4 data-id="heading-4">2. 注册点击事件并绑定弹窗组件</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"showDialog = true"</span>&gt;</span>打开弹窗<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 使用 .sync 修饰符 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">MyDialog</span> <span class="hljs-attr">:visible.sync</span>=<span class="hljs-string">"showDialog"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"示例弹窗"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">3. 子组件：弹窗逻辑</h4>
<h5 data-id="heading-6">3.1 定义接收的 <code>props</code></h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">props</span>: {
  <span class="hljs-attr">visible</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>
  },
  <span class="hljs-attr">title</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-string">'弹窗标题'</span>
  }
},
</code></pre>
<h5 data-id="heading-7">3.2 使用 <code>v-if</code> 控制弹窗显示</h5>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dialog-overlay"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"visible"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dialog-content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dialog-header"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"close-btn"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"closeDialog"</span>&gt;</span>×<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dialog-body"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个弹窗内容<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 支持插槽内容 --&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dialog-footer"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"closeDialog"</span>&gt;</span>取消<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"confirm"</span>&gt;</span>确定<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h5 data-id="heading-8">3.3 关闭弹窗逻辑</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">methods</span>: {
  <span class="hljs-title function_">closeDialog</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 关键：使用 update:visible 模式触发事件</span>
    <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'update:visible'</span>, <span class="hljs-literal">false</span>);
  },
  <span class="hljs-title function_">confirm</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'确认操作'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">closeDialog</span>();
  }
},
</code></pre>
<h5 data-id="heading-9">3.4 监听 <code>visible</code> 变化（可选）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">watch</span>: {
  <span class="hljs-comment">// 监听 visible 变化，处理外部对弹窗的关闭</span>
  <span class="hljs-title function_">visible</span>(<span class="hljs-params">newVal</span>) {
    <span class="hljs-keyword">if</span> (!newVal) {
      <span class="hljs-comment">// 弹窗关闭时的清理操作</span>
    }
  }
}
</code></pre>
<h4 data-id="heading-10">详细代码</h4>
<h5 data-id="heading-11">父组件（使用弹窗）</h5>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"showDialog = true"</span>&gt;</span>打开弹窗<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 使用.sync修饰符 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">MyDialog</span> <span class="hljs-attr">:visible.sync</span>=<span class="hljs-string">"showDialog"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"示例弹窗"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">import</span> <span class="hljs-title class_">MyDialog</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./MyDialog.vue"</span>;

    <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
        <span class="hljs-attr">components</span>: {
            <span class="hljs-title class_">MyDialog</span>,
        },
        <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">showDialog</span>: <span class="hljs-literal">false</span>,
            };
        },
    };
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h5 data-id="heading-12">子组件弹窗（MyDialog.vue）</h5>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dialog-overlay"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"visible"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dialog-content"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dialog-header"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"close-btn"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"closeDialog"</span>&gt;</span>×<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dialog-body"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个弹窗内容<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
                <span class="hljs-comment">&lt;!-- 支持插槽内容 --&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dialog-footer"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"closeDialog"</span>&gt;</span>取消<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"confirm"</span>&gt;</span>确定<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
        <span class="hljs-attr">props</span>: {
            <span class="hljs-attr">visible</span>: {
                <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
                <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>,
            },
            <span class="hljs-attr">title</span>: {
                <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
                <span class="hljs-attr">default</span>: <span class="hljs-string">"弹窗标题"</span>,
            },
        },
        <span class="hljs-attr">methods</span>: {
            <span class="hljs-title function_">closeDialog</span>(<span class="hljs-params"/>) {
                <span class="hljs-comment">// 关键：使用update:visible模式触发事件</span>
                <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">"update:visible"</span>, <span class="hljs-literal">false</span>);
            },
            <span class="hljs-title function_">confirm</span>(<span class="hljs-params"/>) {
                <span class="hljs-comment">// 执行确认操作...</span>
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"确认操作"</span>);
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">closeDialog</span>();
            },
        },
        <span class="hljs-attr">watch</span>: {
            <span class="hljs-comment">// 监听visible变化，处理外部对弹窗的关闭</span>
            <span class="hljs-title function_">visible</span>(<span class="hljs-params">newVal</span>) {
                <span class="hljs-keyword">if</span> (!newVal) {
                    <span class="hljs-comment">// 弹窗关闭时的清理操作</span>
                }
            },
        },
    };
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span>
    // 样式
<span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-13">总结</h3>
<ol>
<li>
<p><strong><code>.sync</code> 的作用</strong>：</p>
<ul>
<li>实现父子组件双向绑定，简化代码。</li>
<li>特别适合弹窗等需要频繁切换显示状态的场景。</li>
</ul>
</li>
<li>
<p><strong>核心逻辑</strong>：</p>
<ul>
<li>父组件通过 <code>.sync</code> 将状态传递给子组件。</li>
<li>子组件通过 <code>$emit('update:visible', value)</code> 修改父组件的状态。</li>
</ul>
</li>
<li>
<p><strong>可选功能</strong>：</p>
<ul>
<li>如果需要在弹窗关闭时执行清理操作，可以使用 <code>watch</code> 监听 <code>visible</code> 的变化。</li>
</ul>
</li>
<li>
<p><strong>使用场景</strong>：</p>
<ul>
<li>
<p>弹窗显示/隐藏控制</p>
</li>
<li>
<p>表单编辑对话框</p>
</li>
<li>
<p>确认对话框</p>
</li>
<li>
<p>设置面板</p>
</li>
<li>
<p>任何需要子组件修改父组件状态的场景</p>
</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[读这一篇，你能把哨兵模式讲给 HR 听她都能懂！]]></title>    <link>https://juejin.cn/post/7574276404597014580</link>    <guid>https://juejin.cn/post/7574276404597014580</guid>    <pubDate>2025-11-20T02:04:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574276404597014580" data-draft-id="7574329472922501154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="读这一篇，你能把哨兵模式讲给 HR 听她都能懂！"/> <meta itemprop="keywords" content="后端,面试,Redis"/> <meta itemprop="datePublished" content="2025-11-20T02:04:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="软件求生"/> <meta itemprop="url" content="https://juejin.cn/user/1038379932466263"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            读这一篇，你能把哨兵模式讲给 HR 听她都能懂！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1038379932466263/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    软件求生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T02:04:37.000Z" title="Thu Nov 20 2025 02:04:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>大家好，我是小米，31 岁，热爱技术、热爱分享、热爱奶茶（虽然医生说我应该喝无糖）的大哥哥。</p>
<p>最近又陪朋友刷 Java 社招面试，他一脸生无可恋：“面试官又问我 Redis sentinel 哨兵模式，我记得好像是监控主从的？但细节我又忘了……”</p>
<p>我拍着他的肩膀，递上一杯奶茶，笑着说：“兄弟，这题我用一杯奶茶讲给你听。听完包你从懵到精通。”</p>
<p>喝口奶茶，我们开始讲故事。</p>
<h2 data-id="heading-0">如果 Redis 是一家奶茶店</h2>
<p>想象一下：Redis 就像是一家超火爆的奶茶店，排队排到三公里外那种。</p>
<p>店里有：</p>
<ul>
<li><strong>一个店长（master）</strong> ：负责“冲奶茶、点单、打包”，超级忙。</li>
<li><strong>几个店员（slave）</strong> ：负责“复制店长的手艺”，同步店长制作奶茶的过程，但不接单。</li>
</ul>
<p>某天，店长干累了，“啪”地一下晕倒了……</p>
<p>整个奶茶店瞬间瘫痪，顾客全跑了。</p>
<p>这就是：<strong>Redis 单点故障，master 挂了，整条服务崩盘。</strong></p>
<p>怎么办？让我们登场——哨兵（Sentinel）！</p>
<h2 data-id="heading-1">哨兵模式出现：给奶茶店安排一群“店长监督员”</h2>
<p>“哨兵模式”（Redis Sentinel）就是给 Redis 奶茶店安排一群“监督员”。</p>
<p>这些监督员整天围着店长转：</p>
<ul>
<li><strong>盯着店长有没有晕倒</strong></li>
<li><strong>盯着店员们是不是正常复制数据</strong></li>
<li><strong>一旦店长真的倒了，他们会召开“紧急会议”</strong></li>
<li><strong>选一个店员当新店长</strong></li>
<li><strong>通知所有顾客：‘新店长上任了！继续喝奶茶吧！’</strong></li>
</ul>
<p>这就是 Redis 哨兵模式的核心功能，Redis Sentinel 的三大职责：</p>
<ul>
<li><strong>监控（Monitoring）：</strong> Sentinel 会持续监控 master 和 slave 是否正常。</li>
<li><strong>故障恢复（Failover）：</strong> master 挂了，自动选举一个 slave 为新的 master，建立新的主从结构。</li>
<li><strong>通知（Notification）：</strong> 有变化时通过 API 或脚本通知客户端、其他程序：“master 换人啦！”</li>
</ul>
<p>是不是，很像一群专业的店长监督员？</p>
<h2 data-id="heading-2">哨兵是怎么判断“店长真的挂了”的？</h2>
<p>哨兵不会店长一咳嗽就说他挂了，Redis 的 Sentinel 有严格的判断标准。</p>
<p><strong>1. 主观下线（SDOWN）</strong></p>
<p>某个哨兵认为 master 没回应，于是说：</p>
<blockquote>
<p>“我觉得店长晕了。”</p>
<p>但“我觉得”不能作为证据。</p>
</blockquote>
<p>这只是 <strong>主观下线</strong>。</p>
<p><strong>2. 客观下线（ODOWN）</strong></p>
<p>只有当<strong>多个哨兵</strong>一起投票，说：</p>
<blockquote>
<p>“对，我也觉得店长挂了。”</p>
</blockquote>
<p>哨兵集群才会确认：</p>
<blockquote>
<p>“OK，店长真的挂了。”</p>
</blockquote>
<p>这叫 <strong>客观下线</strong>（ODOWN）。只有 ODOWN 状态，哨兵才会启动真正的<strong>故障转移流程</strong>（failover）。</p>
<h2 data-id="heading-3">你以为选新店长很简单？哨兵的“竞选大会”来了！</h2>
<p>当 master 被判定 ODOWN 后，哨兵会启动 failover 流程。流程就像一场严格的竞选：</p>
<p><strong>1、挑选健康的 slave</strong></p>
<ul>
<li>数据同步最好</li>
<li>与主节点延迟最小</li>
<li>网络状态最好</li>
</ul>
<p>有点像：谁的手艺最像店长？谁最靠谱？</p>
<p><strong>2、让候选 slave 执行 slaveof no one</strong></p>
<p>这一步很关键！它意味着：“我不是店员了，我现在升职当店长！”</p>
<p><strong>3、重新配置剩余的 slave</strong></p>
<p>指令：SLAVEOF 新master</p>
<p>意思是：“以后你们都跟着新店长学手艺。”</p>
<p><strong>4、通知所有客户端</strong></p>
<p>以前的客户端都连接旧 master。现在哨兵会告诉客户端：“master 换人了，地址在这里，去找新店长点单吧！”</p>
<p>整个过程自动完成，无需人工干预。</p>
<h2 data-id="heading-4">重点来了：哨兵集群怎么工作？</h2>
<p>要保证哨兵模式可靠，必须部署<strong>多个 Sentinel 节点</strong>。为什么？</p>
<blockquote>
<p>因为一个哨兵说 master 感觉挂了，不准。多个哨兵一起说 master 挂了，才会启动 failover。</p>
</blockquote>
<p>就像：</p>
<blockquote>
<p>一个人说“店长晕了”，可能是看错了；三个人都说“店长躺地板上了”，那八成是真的。</p>
</blockquote>
<h2 data-id="heading-5">哨兵模式的架构：其实是“三层”</h2>
<p>为了让你彻底理解，我用最简单的方式总结哨兵模式三层架构：</p>
<p><strong>1、数据层：master + slave 结构</strong></p>
<p>负责：</p>
<ul>
<li>处理读写（master）</li>
<li>复制数据（slave）</li>
</ul>
<p><strong>2、 哨兵层：多个 Sentinel 组成集群</strong></p>
<p>负责：</p>
<ul>
<li>监控 master/slave 状态</li>
<li>选新 master</li>
<li>通知客户端</li>
</ul>
<p>哨兵之间会互相通信，投票决定 master 是否宕机。</p>
<p><strong>3、客户端层</strong></p>
<p>客户端不再直接写死 master 地址，而是：</p>
<ul>
<li>连哨兵</li>
<li>哨兵告诉客户端真正的 master 是谁</li>
<li>master 改变时，哨兵会通知你</li>
</ul>
<p>这样客户端自动适应故障恢复，非常稳。</p>
<h2 data-id="heading-6">面试问：哨兵模式有什么缺点？</h2>
<p>这是高频问题，我给你总结成三句话，面试官听完会很满意。</p>
<p><strong>1、Redis 哨兵模式仍存在脑裂风险</strong></p>
<p>如果网络分区，可能出现：</p>
<ul>
<li>A 以为 master 挂了，选一个 slave 做新 master</li>
<li>但旧 master 实际还活着</li>
</ul>
<p>就出现两个 master（脑裂）。</p>
<p><strong>2、不支持水平扩展写操作</strong></p>
<p>哨兵模式仍然只有一个 master，写能力受限。</p>
<p><strong>3、可靠性比集群模式弱</strong></p>
<p>哨兵能解决“高可用”，不能解决“数据分片、扩容”问题。</p>
<h2 data-id="heading-7">哨兵和集群有什么区别？</h2>
<p>如果你在面试现场回答下面这句话，面试官会疯狂点头：</p>
<blockquote>
<p>Sentinel 负责“高可用”；</p>
<p>Redis Cluster 负责“高可用 + 分片 + 扩展”。</p>
<p>前者是保护 master，不让它宕机；</p>
<p>后者是让数据可以横向扩展。</p>
</blockquote>
<p>一句话就区分了。</p>
<h2 data-id="heading-8">哨兵模式典型部署方式（面试官超爱问）</h2>
<p>最常见的是：</p>
<ul>
<li><strong>1 主 2 从</strong></li>
<li><strong>3~5 个 Sentinel</strong></li>
</ul>
<p>一个参考部署：</p>
<blockquote>
<p>master（1台）</p>
<p>slave（2台）</p>
<p>sentinel（3台）</p>
</blockquote>
<p>Sentinel 必须是奇数个，因为投票要多数同意才“客观下线”。</p>
<p>面试官问你为什么要奇数个，你就说：</p>
<blockquote>
<p>因为哨兵是投票机制，必须多数派决定才能 failover，奇数能避免平票。</p>
</blockquote>
<p>完美！</p>
<h2 data-id="heading-9">哨兵模式的完整工作流程（面试官最喜欢）</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2fd1775c4cb4c3b8be883d9dd2626ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209076&amp;x-signature=NP4PDhLui1n9LxUBBoBQtOwM3Ws%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>我帮你总结成“六步口诀”——面试答题直接背！</p>
<p><strong>Redis 哨兵模式 六步口诀</strong></p>
<ol>
<li><strong>sentinel 监控 master</strong></li>
<li><strong>master 无心跳 → 主观下线 SDOWN</strong></li>
<li><strong>多数 sentinel 投票 → 客观下线 ODOWN</strong></li>
<li><strong>选 slave 当新 master</strong></li>
<li><strong>通知所有 slave 重新跟随新 master</strong></li>
<li><strong>通知客户端：新的 master 地址是谁</strong></li>
</ol>
<p>这套逻辑你能流利描述出来，这道题基本稳了。</p>
<h2 data-id="heading-10">我朋友面试最终怎么样了？</h2>
<p>第二天，我朋友去面试。面试官果然问了：“你讲一下 Redis 哨兵模式？”</p>
<p>朋友立刻把奶茶故事搬出来——从监控、选主、投票、failover，一路讲得顺溜爆炸。</p>
<p>面试官听得连连点头：“不错，讲得很清楚。”</p>
<p>最终他也顺利拿到了 offer。后来他发消息给我，说：“哨兵模式，我现在讲给 HR 听都能听懂。”</p>
<p>我笑了半天。</p>
<h2 data-id="heading-11">END</h2>
<p>如果你需要在简短面试里速答，可以用下面这段话，逻辑清晰、要点齐全：</p>
<blockquote>
<p>Redis 哨兵模式是一种实现 Redis 高可用的机制。</p>
<p>它由多个 Sentinel 节点组成，负责监控 master 和 slave 的状态。</p>
<p>一旦 master 进入客观下线状态，Sentinel 会通过投票选举一个最佳 slave 作为新 master，并通知其他 slave 重新复制它，也会把新 master 的信息通知客户端。</p>
<p><strong>Sentinel 的核心功能包括：</strong> 监控、故障转移、通知。</p>
<p>它解决了 Redis 单点故障问题，但仍然只有一个 master，不支持分片，因此可用性不如 Redis Cluster。</p>
<p>Sentinel 推荐部署奇数个节点，通过多数派选举避免误判。</p>
</blockquote>
<p>我是小米，一个喜欢分享技术的31岁程序员。如果你喜欢我的文章，欢迎关注我的微信公众号“<strong>软件求生</strong>”，获取更多技术干货！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何实现 Remote MCP-Server]]></title>    <link>https://juejin.cn/post/7574568258788851763</link>    <guid>https://juejin.cn/post/7574568258788851763</guid>    <pubDate>2025-11-20T02:15:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574568258788851763" data-draft-id="7574584245109948467" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何实现 Remote MCP-Server"/> <meta itemprop="keywords" content="前端,MCP,AIGC"/> <meta itemprop="datePublished" content="2025-11-20T02:15:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="袋鼠云数栈UED团队"/> <meta itemprop="url" content="https://juejin.cn/user/2137106333053912"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何实现 Remote MCP-Server
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2137106333053912/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    袋鼠云数栈UED团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T02:15:56.000Z" title="Thu Nov 20 2025 02:15:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>我们是<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dtstack.com%2Fued" target="_blank" title="https://www.dtstack.com/ued" ref="nofollow noopener noreferrer">袋鼠云数栈 UED 团队</a>，致力于打造优秀的一站式数据中台产品。我们始终保持工匠精神，探索前端道路，为社区积累并传播经验价值。</p>
</blockquote>
<blockquote>
<p>本文作者：佳岚</p>
</blockquote>
<h2 data-id="heading-0">背景</h2>
<p>对于公司内部的MCP-Server, 由于隐私性问题不能发布为npm包，那么就没法以<code>npx</code>或者<code>uvx</code>等形式快速的共享使用。所以基本会以STDIO类型的MCP-Server进行开发，在内部进行共享时只能将对应源文件拉取本地使用。</p>
<p>MCP-Server市场中心能够整合内部各团队或个人实现的MCP-Server，提供统一的Streamable HTTP协议访问端口，快速的整合MCP资源。</p>
<h2 data-id="heading-1">现有方案分析</h2>
<p>MCP Market有很多网站已经实现，但基本只能做到聚合功能，即只提供检索与使用概览等基本功能，使用时仍需要本地克隆或者 npx 安装调用或者使用MCP注册者自己提供的HTTP调用url。</p>
<h3 data-id="heading-2">MCPMarket</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmcpmarket.com%2Fzh%2Fserver" target="_blank" title="https://mcpmarket.com/zh/server" ref="nofollow noopener noreferrer">mcpmarket.com/zh/server</a></p>
<p>仅仅做了检索整合</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/644f0a38eb90402094a3daf98dd5f508~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=8AQlsosiRWGMis1lKWliKnWC90Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">百炼-MCP</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fbailian.console.aliyun.com%2F%3Fspm%3Da2c4g.11186623.0.0.462a2aa1vaybZI%26tab%3Dmcp%23%2Fmcp-market" target="_blank" title="https://bailian.console.aliyun.com/?spm=a2c4g.11186623.0.0.462a2aa1vaybZI&amp;tab=mcp#/mcp-market" ref="nofollow noopener noreferrer">bailian.console.aliyun.com/?spm=a2c4g.…</a></p>
<p>实现了MCP服务的一体化流程，包括检索，部署与一键集成</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e4499818287466ca5621f61dcc61d0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=Xi6DITmNw9TFCCaXVgFFdLRTGZY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/849ca228b6a9443baaadcf552b30bf7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=Y08bmq3G%2BU4zqcl4SA8JBzzvzG0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">Nacos-AI</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnacos.io%2Fdocs%2Flatest%2Fmanual%2Fuser%2Fai%2Fmcp-auto-register%2F%3Fspm%3D5238cd80.75598bea.0.0.609e2c09jtluP3" target="_blank" title="https://nacos.io/docs/latest/manual/user/ai/mcp-auto-register/?spm=5238cd80.75598bea.0.0.609e2c09jtluP3" ref="nofollow noopener noreferrer">Nacos-AI</a></p>
<p>nacos本身是一个动态服务注册发现与管理框架，新版本提供了Nacos MCP Router来管理所有MCP</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbd11071acc34f7b9a6b32ebce791cbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=KaOjwipDtehxyMfRK8aW9cuCJ7c%3D" alt="" loading="lazy"/></p>
<p>其内部可以实现不同协议类型的 MCP 服务器转化为统一的 streamable-http 类型，它本身提供一个 nacos mcp 来与客户端交互：</p>
<p>Nacos MCP Router 有两种工作模式：</p>
<ol>
<li>router模式：默认模式，通过MCP Server推荐、安装及代理其他MCP Server的功能，帮助用户更方便的使用MCP Server服务。</li>
<li>proxy模式：使用环境变量MODE=proxy指定，通过简单配置可以把sse、stdio协议MCP Server转换为streamableHTTP协议MCP Server。</li>
</ol>
<p>在router 模式下，Nacos MCP Router 作为一个标准MCP Server，提供MCP Server推荐、分发、安装及代理其他MCP Server的功能。其主要工具列表为</p>
<ol>
<li>search_mcp_server
<ul>
<li>根据任务描述及关键字从MCP注册中心（Nacos）中搜索相关的MCP Server列表</li>
<li>输入:
<ul>
<li><code>task_description</code>(string): 任务描述，示例：今天杭州天气如何</li>
<li><code>key_words</code>(string): 任务关键字，示例：天气、杭州</li>
</ul>
</li>
<li>输出: list of MCP servers and instructions to complete the task.</li>
</ul>
</li>
<li>add_mcp_server
<ul>
<li>添加并初始化一个MCP Server，根据Nacos中的配置与该MCP Server建立连接，等待调用。</li>
<li>输入:
<ul>
<li><code>mcp_server_name</code>(string): 需要添加的MCP Server名字</li>
</ul>
</li>
<li>输出: MCP Server工具列表及使用方法</li>
</ul>
</li>
<li>use_tool
<ul>
<li>代理其他MCP Server的工具</li>
<li>输入:
<ul>
<li><code>mcp_server_name</code>(string): 被调的目标MCP Server名称.</li>
<li><code>mcp_tool_name</code>(string): 被调的目标MCP Server的工具名称</li>
<li><code>params</code>(map): 被调的目标MCP Server的工具的参数</li>
</ul>
</li>
<li>输出: 被调的目标MCP Server的工具的输出结果</li>
</ul>
</li>
</ol>
<p>在proxy 模式下，Nacos MCP Router 仅提供代理功能，无需代码改动即可实现stdio、sse协议一键转换为streamableHTTP协议。</p>
<h3 data-id="heading-5">higress AI网关</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhigress.cn%2Fai%2Fmcp-quick-start%2F%3Fspm%3D36971b57.7beea2de.0.0.d85f20a9xwAfAn" target="_blank" title="https://higress.cn/ai/mcp-quick-start/?spm=36971b57.7beea2de.0.0.d85f20a9xwAfAn" ref="nofollow noopener noreferrer">higress AI网关</a></p>
<p>什么是 AI 网关？
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ee33b485a0c482e82027d4094db3eb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=446jbf9JnIJKk5k%2FCoVzJoC0Zvw%3D" alt="" loading="lazy"/></p>
<p>使用AI网关做MCP Server的统一入口代理</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/814d882d66534fd4959b7547815799a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=8Yw43SsvzbFdi56UFrNhfOIC9Ow%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92db1e64df4d4714be13b332e63b2c4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=9ttQWtwxPKO5u%2BuHYaTdo2IyeCk%3D" alt="" loading="lazy"/></p>
<p>优势：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4962e507faeb4790b4f6bb09a1552757~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=qhW3vOKaGduMvldOztdH%2F%2FJ6q7M%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">设计概览</h2>
<h3 data-id="heading-7">前端设计</h3>
<p>页面需包含以下几个功能</p>
<ol>
<li>
<p>MCP市场 - 用于查询已注册的MCP服务列表，同大多数MCP Market一样，包含使用说明，配置，工具列表等信息
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98e3ba323b904479b3094da1372a04ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=q8qLcIvT6vDolFf4Gj2qbBljV%2FI%3D" alt="" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/684f8db2cced48b69aefd0190e08f724~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=vt%2FaswH1GEkE6RsQ%2F4ZBdIpi8kk%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>MCP注册中心  - 发布自己实现的MCP，针对 Stdio 类型MCP Server，提供资源部署服务
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e081309a01e3487f94dc27cf74137e13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=cWTJ5iGss%2BO%2Bipip%2Bu%2F1TcuMAZ0%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>MCP调试服务  - 使用 <code>@modelcontextprotocol/inspector</code>实现
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78d3b7e698ec483da607c472141f892e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=MOmu0PBODY0A6OnWi1itJ3ufFkY%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>服务管理
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb101eb262be43cf94d06763b5947e49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=wV4x94Z0tzpshnP90FiVojOAf3M%3D" alt="" loading="lazy"/></p>
</li>
</ol>
<h3 data-id="heading-8">后端设计</h3>
<h4 data-id="heading-9">协议转换</h4>
<p>MCP协议已有三个版本: 2024-11-05、2025-03-26、2025-06-18。</p>
<p>主要差异在于协议间的兼容，<code>2024-11-05</code>版本提供了<code>Stdio</code>与<code>SSE</code>两种<code>transport</code>类型，<code>2025-03-26</code>之后的版本提供了<code>Stdio</code>与<code>Streamable HTTP</code>协议。</p>
<p><code>SSE</code>由于其会使用两个端点<code>/sse</code>与<code>/messages</code>且一直会占用长连接的缘故存在设计缺陷，所以我们一般不推荐使用。</p>
<p>基于此，我们定义三种协议的转化规则： Stdio =&gt; HTTP , SSE =&gt; SSE, HTTP =&gt; HTTP</p>
<h5 data-id="heading-10">Stdio转HTTP</h5>
<p>大部分情况下我们会以<code>Stdio</code>形式开发MCP Server，因为它足够简单，<code>Stdio</code>transport是以<strong>子进程</strong>的方式实现 Client 与 Server 之间通信的，实现一对一的关系。</p>
<p>一般有两种使用方式, 在配置时使用 command 指定：</p>
<ul>
<li>npx -y xxx</li>
<li>node ./xxx.js</li>
</ul>
<p>我们在任务管理器中可以看到所有配置的MCP都被以子进程的形式启动了
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecb8c08654cf455781d71a0ccbd8431a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=jpUNUfwlqVulkgIVT0sUY5J2Twg%3D" alt="" loading="lazy"/></p>
<p>问：</p>
<p>假设一个MCP只会在全局创建一个进程，那么如果我开启两个Cursor，同时调用同一个MCP，会如何？</p>
<p>如果将其转为HTTP, 需要做到数据隔离。因为StdioClientTransport与运行Server代码的子进程间是通过事件订阅来接收消息的， 接收到消息时我们需要知道这个消息该回传给哪个http请求。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 接收消息</span>
process.<span class="hljs-property">stdout</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function">(<span class="hljs-params">buffer</span>) =&gt;</span> {});
<span class="hljs-comment">// 发送请求</span>
process.<span class="hljs-property">stdin</span>?.<span class="hljs-title function_">write</span>(msg)
</code></pre>
<p>为了解决数据隔离问题，用两种方式解决：</p>
<ol>
<li>
<p><strong>独立child_process</strong><br/>
为每一个http请求独立创建子进程，消息响应完即销毁，虽能解决数据隔离问题，且每个请求都能定义自己的env信息，但是在20~30并发下，创建子进程的性能消耗会瞬间打满CPU。</p>
</li>
<li>
<p><strong>单体child_process</strong><br/>
单体child_process对于每一个MCP Server只会创建一个子进程，且进程会随哆啦A梦一起启动。</p>
</li>
</ol>
<p>由于不管是哪种 transport，都是以 JSON-RPC 协议进行消息定义，JSON-RPC可以提供 id 参数标识请求，如果请求中携带了id，那么响应的 JSON-RPC 也必须携带同样的id。</p>
<p>client在请求时会自己生成一个id，但这个id我们并不能直接使用，如果同时有多个用户在 client 端发送请求，它们的id可能会一样，因此我们需要内部维护一个唯一的id，同时维护内部id与client生成的id的关系。</p>
<p>在与Server通信时，使用内部id以保证唯一，当Server返回数据时，将JSON-RPC响应体的内部id替换为client id以此实现数据隔离。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a33bf3b98053407db37e07a5c29d8313~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=fhyfh8G67qoFrgXPfatjs6T6xQo%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-11">SSE</h5>
<p>SSE通信流程：</p>
<ol>
<li>SSE transport会开启两个端点，首先客户端会发起一个<code>GET</code>请求到<code>/sse</code>端点，可以不携带任何请求参数</li>
<li><code>/sse</code>端点开启一个流，先返回一个消息端点<code>/messages</code>与<code>sessionId</code>如：/messages?sessionId=xxx<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed18179daa7b442292e2bd079baa7a95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=Z4AwVoWd1ia%2Fjcb%2BuHlrvCFFVyg%3D" alt="" loading="lazy"/></li>
<li>客户端向<code>/messages</code>端点发起实际请求，如 initialize, tools/list，注意此时服务端不会把数据结果支持返回到<code>/messages</code>，而是直接返回202 Accept<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f1c56ad2c3d425cb406e0e33a5e6b7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=Kc7yEy7BgF8AFNJ4m2yV4EfR84U%3D" alt="" loading="lazy"/></li>
<li><code>/sse</code>端点收到响应结果<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a1e112ca4d9473bb82627ba321cf30f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=8cif4wNXjyyy5YLwJRlsCcx51bE%3D" alt="" loading="lazy"/></li>
<li>继续下一轮通信<br/>
对于SSE,  我们在Controller层同样开放两个端点</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript">app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/mcp-endpoint/:serverId/messages'</span>, app.<span class="hljs-property">controller</span>.<span class="hljs-property">mcp</span>.<span class="hljs-property">handleMCPEndpointPost</span>);
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/mcp-endpoint/:serverId/sse'</span>, app.<span class="hljs-property">controller</span>.<span class="hljs-property">mcp</span>.<span class="hljs-property">handleMCPEndpointGet</span>);
</code></pre>
<p>如果单纯的做代理转发，那么无法做到对<strong>消息端点</strong>的转发，因为消息端点是MCP Server动态定义的，可能不是<code>/messages</code>，所以我们需要在哆啦A梦层动态创建 <code>SSEServerTransport</code> 。</p>
<p><code>SSEServerTransport</code>的<code>endpoint</code>仅仅用来指引客户端消息体往哪个API接口发送, 所以我们在哆啦A梦后端创建的<code>endpoint</code>与真实MCP服务器返回的<code>endpoint</code>是没有关系与冲突的。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> messageEndpoint = <span class="hljs-string">'http://localhost:7001/mcp-endpoint/'</span> + serverId + <span class="hljs-string">'/messages'</span>;

<span class="hljs-keyword">const</span> serverTransport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SSEServerTransport</span>(messageEndpoint, res, {
    headers,
});
<span class="hljs-keyword">await</span> serverTransport.<span class="hljs-title function_">start</span>();
</code></pre>
<p>我们在哆啦A梦创建的<code>SSEServerTransport</code>能够帮我们处理客户端发送的SSE请求并自动响应，但是我们目前没有绑定任何的MCP Server, 它仅有一个桥接的作用。</p>
<p>因此，我们还需要在哆啦A梦层创建一个<code>SSEClientTransport</code>, 将我们从真实客户端发送的消息通过<code>SSEClientTransport</code>再发送给真实MCP服务器。</p>
<p><code>SSEClientTransport</code>监听<code>onmessage</code>获取真实MCP服务器消息结果后，将结果 send 到本地创建的<code>SSEServerTransport</code>，<code>SSEServerTransport</code>处理请求完成响应。</p>
<p>GET请求处理如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 处理GET请求
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">serverId</span> - 服务器ID
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">any</span>} <span class="hljs-variable">req</span> - 请求数据
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">object</span>} <span class="hljs-variable">res</span> - 响应数据
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">handleGet</span>(<span class="hljs-params">serverId, req, res</span>) {
  <span class="hljs-keyword">const</span> sseProxy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">sseProxies</span>.<span class="hljs-title function_">get</span>(serverId);
  <span class="hljs-keyword">if</span> (!sseProxy) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`服务器 <span class="hljs-subst">${serverId}</span> 的SSE连接未找到`</span>);
  }

  <span class="hljs-keyword">let</span> transportToClientClosed = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">let</span> transportToServerClosed = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">const</span> headers = {
    ...req.<span class="hljs-property">headers</span>,
    ...sseProxy.<span class="hljs-property">headers</span>,
    <span class="hljs-attr">accept</span>: <span class="hljs-string">'text/event-stream'</span>,
  };

  <span class="hljs-keyword">const</span> clientTransport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SSEClientTransport</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(sseProxy.<span class="hljs-property">url</span>), {
    headers,
  });
  <span class="hljs-keyword">await</span> clientTransport.<span class="hljs-title function_">start</span>();

  <span class="hljs-keyword">const</span> messageEndpoint = <span class="hljs-string">'http://localhost:7001/mcp-endpoint/'</span> + serverId + <span class="hljs-string">'/messages'</span>;
  <span class="hljs-keyword">const</span> serverTransport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SSEServerTransport</span>(messageEndpoint, res, {
    headers,
  });
  <span class="hljs-keyword">await</span> serverTransport.<span class="hljs-title function_">start</span>();

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">serverTransports</span>.<span class="hljs-title function_">set</span>(serverTransport.<span class="hljs-property">sessionId</span>, serverTransport);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">clientTransports</span>.<span class="hljs-title function_">set</span>(serverTransport.<span class="hljs-property">sessionId</span>, clientTransport);

  <span class="hljs-comment">// 桥接数据交换</span>
  serverTransport.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> clientTransport.<span class="hljs-title function_">send</span>(message);
  clientTransport.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> serverTransport.<span class="hljs-title function_">send</span>(message);
  serverTransport.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (transportToServerClosed) {
      <span class="hljs-keyword">return</span>;
    }

    transportToClientClosed = <span class="hljs-literal">true</span>;
    clientTransport.<span class="hljs-title function_">close</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e));
  };
  clientTransport.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (transportToClientClosed) {
      <span class="hljs-keyword">return</span>;
    }
    transportToServerClosed = <span class="hljs-literal">true</span>;
    serverTransport.<span class="hljs-title function_">close</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e));
  };

}
</code></pre>
<p>POST消息请求处理如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 处理POST请求
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">serverId</span> - 服务器ID
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">any</span>} <span class="hljs-variable">req</span> - 请求数据
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">object</span>} <span class="hljs-variable">res</span> - 响应数据
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">handlePost</span>(<span class="hljs-params">serverId, req, res</span>) {
  <span class="hljs-keyword">const</span> sseProxy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">sseProxies</span>.<span class="hljs-title function_">get</span>(serverId);
  <span class="hljs-keyword">if</span> (!sseProxy) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`服务器 <span class="hljs-subst">${serverId}</span> 的SSE连接未找到`</span>);
  }

  <span class="hljs-keyword">const</span> serverTransport = <span class="hljs-variable language_">this</span>.<span class="hljs-property">serverTransports</span>.<span class="hljs-title function_">get</span>(req.<span class="hljs-property">query</span>.<span class="hljs-property">sessionId</span>);

  <span class="hljs-keyword">if</span> (!serverTransport) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`session <span class="hljs-subst">${req.query.sessionId}</span> 不存在`</span>);
  }

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 由于Egg.js已经解析了请求体，我们需要将解析好的body传递给handlePostMessage</span>
    <span class="hljs-keyword">await</span> serverTransport.<span class="hljs-title function_">handlePostMessage</span>(req, res, req.<span class="hljs-property">body</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`SSE POST请求处理错误:`</span>, error);
    <span class="hljs-keyword">throw</span> error;
  }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2eaa5847249c4991b0314a5777543af6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=07gJJ5I7jlP2SvJr2QSGk42lxhM%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-12">Streamable HTTP</h5>
<p>如果本身就是Streamable HTTP类型的，我们只做请求的代理，将目标服务器或者托管在哆啦A梦不同端口上的MCP服务，统一通过哆啦A梦mcp端点访问。</p>
<p>代理实现与SSE相似，此处略。</p>
<p>但注意Streamable HTTP使用一个<code>/mcp</code>端点，但是可以使用3种方式访问：POST、GET、DELETE。</p>
<h4 data-id="heading-13">Stateless VS Statefulness</h4>
<p>Streamable HTTP MCP在定义时存在无状态与有状态模式的区分：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 有状态</span>
transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamableHTTPServerTransport</span>({
  <span class="hljs-attr">sessionIdGenerator</span>: <span class="hljs-function">() =&gt;</span> sessionId,
  <span class="hljs-attr">onsessioninitialized</span>: <span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`新会话初始化: <span class="hljs-subst">${id}</span>`</span>);
  }
});

<span class="hljs-comment">// 无状态</span>
transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamableHTTPServerTransport</span>({
  <span class="hljs-attr">sessionIdGenerator</span>: <span class="hljs-literal">undefined</span>,
});
</code></pre>
<p>在无状态模式下，不会返回<code>MCP-Session-Id</code>响应头，客户端也无法访问<code>GET</code>与<code>DELETE</code>方法，客户端不需要先行通过<code>initialize</code>进行握手连接，可以直接调用目标方法，缺点就是服务器端没法进行实时通知，如<code>ToolListChanged</code>等消息。</p>
<p>Stdio本身是以一对一连接存在的，且会长期维持子进程的存在，所以属于<code>statefulness</code>这一类, 当转化为Streamable HTTP时，需要我们自行管理session（当前暂时处理为stateless）；</p>
<p>SSE肯定是以<code>Statefulness</code>存在，我们会在后端存储代理的session信息。</p>
<p>Streamable HTTP 我们走完全代理模式，是否需要状态由目标MCP服务器决定。</p>
<h3 data-id="heading-14">数据库设计</h3>
<p>采用单表设计，不需要额外关联表</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> `mcp_servers` (
    `id` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'自增主键'</span>,
    `server_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'服务器唯一标识/名称'</span>,
    `title` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'显示标题'</span>,
    `description` text  COMMENT <span class="hljs-string">'服务器描述(支持Markdown)'</span>,
    `author` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'创建者'</span>,
    `version` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'版本号'</span>,
    `tags` json COMMENT <span class="hljs-string">'标签数组'</span>,
    `transport` enum(<span class="hljs-string">'stdio'</span>, <span class="hljs-string">'sse'</span>, <span class="hljs-string">'streamable-http'</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'stdio'</span> COMMENT <span class="hljs-string">'传输协议类型'</span>,
    `command` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)  COMMENT <span class="hljs-string">'启动命令(stdio类型)'</span>,
    `args` json COMMENT <span class="hljs-string">'命令参数数组(stdio类型)'</span>,
    `env` json COMMENT <span class="hljs-string">'环境变量对象(stdio类型)'</span>,
    `http_url` <span class="hljs-type">varchar</span>(<span class="hljs-number">500</span>)  COMMENT <span class="hljs-string">'HTTP访问地址(http类型)'</span>,
    `sse_url` <span class="hljs-type">varchar</span>(<span class="hljs-number">500</span>)  COMMENT <span class="hljs-string">'SSE访问地址(sse类型)'</span>,
    `git_url` <span class="hljs-type">varchar</span>(<span class="hljs-number">500</span>)  COMMENT <span class="hljs-string">'Git源码地址'</span>,
    `deploy_path` <span class="hljs-type">varchar</span>(<span class="hljs-number">500</span>)  COMMENT <span class="hljs-string">'托管部署路径'</span>,
    `status` tinyint <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'1'</span> COMMENT <span class="hljs-string">'服务器状态 1-启用 0-禁用'</span>,
    `is_delete` tinyint <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'是否删除 1-已删除 0-未删除'</span>,
    `use_count` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'使用次数'</span>,
    `tools` json COMMENT <span class="hljs-string">'可用工具列表'</span>,
    `prompts` json COMMENT <span class="hljs-string">'可用提示词列表'</span>,
    `resources` json COMMENT <span class="hljs-string">'可用资源列表'</span>,
    `capabilities` json COMMENT <span class="hljs-string">'服务器能力信息'</span>,
    `last_sync_at` datetime COMMENT <span class="hljs-string">'最后同步时间'</span>,
    `runtime_status` enum(<span class="hljs-string">'running'</span>, <span class="hljs-string">'stopped'</span>, <span class="hljs-string">'error'</span>, <span class="hljs-string">'unknown'</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'unknown'</span> COMMENT <span class="hljs-string">'运行时状态 running-运行中 stopped-已停止 error-错误 unknown-未知'</span>,
    `last_ping_at` datetime COMMENT <span class="hljs-string">'最后ping检查时间'</span>,
    `ping_error` text COMMENT <span class="hljs-string">'最后ping检查错误信息'</span>,
    `created_at` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
    `updated_at` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'更新时间'</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
    <span class="hljs-keyword">UNIQUE</span> KEY `uk_server_id` (`server_id`),
  ) ENGINE <span class="hljs-operator">=</span> InnoDB AUTO_INCREMENT <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8 <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8_bin
</code></pre>
<h3 data-id="heading-15">控制层</h3>
<p>支持 SSE 与 Streamable HTTP端点</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * MCP代理端点
 */</span>
app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/mcp-endpoint/:serverId/mcp'</span>, app.<span class="hljs-property">controller</span>.<span class="hljs-property">mcp</span>.<span class="hljs-property">handleMCPEndpointPost</span>);
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/mcp-endpoint/:serverId/mcp'</span>, app.<span class="hljs-property">controller</span>.<span class="hljs-property">mcp</span>.<span class="hljs-property">handleMCPEndpointGet</span>);
app.<span class="hljs-title function_">delete</span>(<span class="hljs-string">'/mcp-endpoint/:serverId/mcp'</span>, app.<span class="hljs-property">controller</span>.<span class="hljs-property">mcp</span>.<span class="hljs-property">handleMCPEndpointDelete</span>);


app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/mcp-endpoint/:serverId/messages'</span>, app.<span class="hljs-property">controller</span>.<span class="hljs-property">mcp</span>.<span class="hljs-property">handleMCPEndpointPost</span>);
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/mcp-endpoint/:serverId/sse'</span>, app.<span class="hljs-property">controller</span>.<span class="hljs-property">mcp</span>.<span class="hljs-property">handleMCPEndpointGet</span>);
</code></pre>
<h3 data-id="heading-16">服务层</h3>
<h4 data-id="heading-17">MCPService层</h4>
<p>MCPService层包含所有数据库模型操作，但不包含具体的MCP处理，如MCP启动，重启。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> mcpProxy = <span class="hljs-title class_">MCPProxy</span>.<span class="hljs-title function_">getInstance</span>();

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MCPController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Controller</span> {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleMCPEndpointGet</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> { ctx } = <span class="hljs-variable language_">this</span>;
      <span class="hljs-keyword">const</span> { serverId } = ctx.<span class="hljs-property">params</span>;
      <span class="hljs-keyword">await</span> mcpProxy.<span class="hljs-title function_">forwardRequest</span>(serverId, ctx.<span class="hljs-property">request</span>, ctx.<span class="hljs-property">response</span>);
      ctx.<span class="hljs-property">respond</span> = <span class="hljs-literal">false</span>;
  }
}
</code></pre>
<h4 data-id="heading-18">MCPProxy层</h4>
<p>MCPProxy层包含以下组成</p>
<ol>
<li>MCPProxy (核心代理)<br/>
单例模式，统一管理所有MCP服务器连接<br/>
路由请求到对应的传输处理器<br/>
管理服务器生命周期（启动/停止/重启）</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MCPProxy</span> {

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestManager</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MCPRequestManager</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">processManager</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MCPProcessManager</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stdioHandler</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StdioTransportHandler</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">processManager</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestManager</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sseHandler</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SSETransportHandler</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">httpHandler</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamableHttpTransportHandler</span>();
  }
  <span class="hljs-comment">// 单例实现</span>
  <span class="hljs-title function_">getInstance</span>()

  <span class="hljs-comment">// 缓存MCP Server配置与forward具体的协议转换处理</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">startProxy</span>(<span class="hljs-params">serverId, config</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 停止已存在的代理</span>
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stopProxy</span>(serverId);

      <span class="hljs-keyword">const</span> transport = config.<span class="hljs-property">transport</span> || { <span class="hljs-attr">type</span>: <span class="hljs-string">'stdio'</span> };
      <span class="hljs-keyword">let</span> handler;

      <span class="hljs-keyword">switch</span> (transport.<span class="hljs-property">type</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'stdio'</span>:
          handler = <span class="hljs-variable language_">this</span>.<span class="hljs-property">stdioHandler</span>;
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'sse'</span>:
          handler = <span class="hljs-variable language_">this</span>.<span class="hljs-property">sseHandler</span>;
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'streamable-http'</span>:
          handler = <span class="hljs-variable language_">this</span>.<span class="hljs-property">httpHandler</span>;
          <span class="hljs-keyword">break</span>;
        <span class="hljs-attr">default</span>:
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`不支持的传输类型: <span class="hljs-subst">${transport.type}</span>`</span>);
      }

      <span class="hljs-comment">// 启动传输处理器</span>
      <span class="hljs-keyword">await</span> handler.<span class="hljs-title function_">start</span>(serverId, config);

      <span class="hljs-comment">// 记录使用的处理器</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">transportHandlers</span>.<span class="hljs-title function_">set</span>(serverId, handler);

      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`MCP代理已启动: <span class="hljs-subst">${serverId}</span> (<span class="hljs-subst">${transport.type}</span>)`</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`启动MCP代理失败 [<span class="hljs-subst">${serverId}</span>]:`</span>, error);
      <span class="hljs-keyword">throw</span> error;
    }
  }
}
</code></pre>
<ol start="2">
<li>
<p>MCPRequestManager (请求管理器)<br/>
管理待处理请求队列<br/>
ID映射管理（客户端ID ↔ 内部ID）<br/>
请求超时处理<br/>
响应路由回调</p>
</li>
<li>
<p>MCPProcessManager (STDIO transport进程管理器)<br/>
进程生命周期管理<br/>
进程通信（stdin/stdout）<br/>
进程监控和错误处理<br/>
进程重启机制</p>
</li>
<li>
<p>MCPSessionManager (会话管理器)<br/>
SSE会话生命周期管理<br/>
会话超时清理<br/>
协议版本管理<br/>
会话统计</p>
</li>
<li>
<p>传输处理器 (Transport Handlers 核心处理)<br/>
整个协议转换与具体的处理</p>
</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript">abstract <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseTransportHandler</span> {
    <span class="hljs-title function_">start</span>();
    <span class="hljs-title function_">stop</span>();
    <span class="hljs-comment">// 为MCPProxy提供统一的入口</span>
    <span class="hljs-title function_">forward</span>();
    <span class="hljs-title function_">handlePost</span>();
    <span class="hljs-title function_">handleGet</span>();
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">StdioTransportHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BaseTransportHandler</span>{}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SSETransportHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BaseTransportHandler</span>{}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamableHttpTransportHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BaseTransportHandler</span>{}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/375d044f9bc947fdb9f4c7aabdef6914~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=EPD%2B%2FQxaz7hLViocY4SB1JW0NQ8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-19">状态监控</h3>
<p>MCP Server注册后是否可用，可以使用使用ClientTransport发送一个ping请求来识别，数据库中使用<code>status</code>、<code>last_ping_at</code>、<code>ping_error</code>三个字段来存储相关信息。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18%2Fbasic%2Futilities%2Fping" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18/basic/utilities/ping" ref="nofollow noopener noreferrer">modelcontextprotocol.io/specificati…</a></p>
<p>当在注册完成、修改、启动、重启等操作后，应立即调用一次。</p>
<p>除此之外，创建定时任务，每隔一段时间发送一次ping请求。</p>
<h3 data-id="heading-20">Inspector集成</h3>
<p>提供一个在线调试工具尤为重要，那快速的帮助使用者或者服务器拥有者排查问题。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub1s.com%2Fmodelcontextprotocol%2Finspector%2Ftree%2Fmain" target="_blank" title="https://github1s.com/modelcontextprotocol/inspector/tree/main" ref="nofollow noopener noreferrer">@modelcontextprotocal/inspector</a> 是一个mcp官方提供的web端调试工具<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a6c585825e2428a8b004f6e4010f391~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=cZEHbehhnOrZu82XXtDZlOIrBwk%3D" alt="" loading="lazy"/></p>
<p>其实现代码分为前端页面与server端，server端用于跟真实服务器通信。</p>
<p>前端使用vite与radix-ui，后端服务采用exporess</p>
<p>如果要集成进哆啦A梦，考虑三种方案：</p>
<ol>
<li>微服务，将inspector直接按源码级迁移到哆啦A梦中并开放两个新端口，哆啦A梦启动时连带启动inspector前后端服务，需要考虑如何实现打包</li>
<li>合并迁移，inspector的代码实现并不复杂，可以考虑与现有哆啦A梦代码整合合并</li>
<li>独立服务，将inspector以iframe的形式嵌入哆啦A梦，需要在哆啦A梦服务器上单独启动inspector, 割裂感很重。</li>
</ol>
<h3 data-id="heading-21">环境要求</h3>
<p>@modelcontextprotocal/sdk 要求 node 版本v18以上，哆啦A梦 engines.node 要求&gt;=14 &amp; &lt;=16, 使用 node &gt;=18启动哆啦A梦需要添加环境变量<code>NODE_OPTIONS=--openssl-legacy-provider &amp;&amp; egg-bin dev --daemon</code></p>
<h3 data-id="heading-22">多进程集群适配</h3>
<p>egg.js在启动时会通过 master 进程带起所有其他子进程，每个worker用来执行我们的实际业务代码（mvc框架），类似于nginx的负载均衡，此外还会创建一个 agent 进程来做单独的服务，如定时任务。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.eggjs.org%2Fzh-CN%2Fcore%2Fcluster-and-ipc%23agent-%25E6%259C%25BA%25E5%2588%25B6" target="_blank" title="https://www.eggjs.org/zh-CN/core/cluster-and-ipc#agent-%E6%9C%BA%E5%88%B6" ref="nofollow noopener noreferrer">cluster-and-ipc</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f81354edae9d4774ad25e542f9b8871e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6byg5LqR5pWw5qCIVUVE5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764209756&amp;x-signature=yE45fmBK65j%2FeOFGurOyFEbuXpY%3D" alt="" loading="lazy"/></p>
<p>由于doraemon在生产环境下会开启多进程集群来优化性能，每个worker都会重复实例化我们设计的单例MCPProxy，导致不同worker间的mcp相关状态不一致，mcp-session状态也无法共享。</p>
<p>所以需要在 controller 和 service 中，我们需要移除所有直接对 MCPProxy 的操作，为确保实例唯一与状态同步，将MCP底层服务全部移到 agent 进程中。</p>
<p>MCPProxy的主要功能是转发 MCP 的直接请求，因此我们需要在 agent 中开启一个独立的 http 服务（不能利用Controller）</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// agent.js文件</span>

<span class="hljs-comment">// 初始化MCP HTTP处理器</span>
    <span class="hljs-keyword">const</span> mcpHttpHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MCPHttpHandler</span>(agent.<span class="hljs-property">logger</span>);
    <span class="hljs-keyword">let</span> httpServer = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 创建HTTP服务（用于处理MCP端点请求）</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">startHttpServer</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-keyword">const</span> port = process.<span class="hljs-property">env</span>.<span class="hljs-property">MCP_AGENT_HTTP_PORT</span> || env.<span class="hljs-property">mcpAgentHttpPort</span> || <span class="hljs-number">7005</span>;

        httpServer = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-keyword">async</span> (req, res) =&gt; {
            <span class="hljs-keyword">await</span> mcpHttpHandler.<span class="hljs-title function_">handleRequest</span>(req, res);
        });

        httpServer.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> {
            agent.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Agent MCP HTTP服务已启动，监听端口: <span class="hljs-subst">${port}</span>`</span>);
        });

        httpServer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
            agent.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Agent MCP HTTP服务错误:'</span>, error);
        });
    };
</code></pre>
<p>其次 MCPProxy 还包含 MCP 服务的启停, 而 MCP 启停的时机是通过 worker 中 service 层调用的，因此还需要通过IPC（进程间通信）的方式通知 agent。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 一个worker的service中</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-property">messenger</span>.<span class="hljs-title function_">sendToAgent</span>(<span class="hljs-string">'mcpRestart'</span>, { serverId });


<span class="hljs-comment">// agent.js</span>
agent.<span class="hljs-property">messenger</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'mcpRestart'</span>, <span class="hljs-keyword">async</span> ({ serverId }) =&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">McpProxy</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">restartProxy</span>(serverId);
        agent.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`MCP服务器重启成功 [<span class="hljs-subst">${serverId}</span>]`</span>);
    } <span class="hljs-keyword">catch</span> (error) {
        agent.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`MCP服务器重启失败 [<span class="hljs-subst">${serverId}</span>]:`</span>, error);
    }
});

</code></pre>
<h3 data-id="heading-23">MCP Server代码编写约束</h3>
<p>MCP Server中的<code>Server</code>与<code>Transport</code>和<code>Client</code>是一对一对一的关系，也就是同时只能一个人访问你的MCP服务，这对于我们实现Remote-MCP的初衷是不符合的。</p>
<p>即使是新的 transport 协议 streamable-http，也是一对一的关系，当我们在一个tab中调用后，在另一个tab中再次连接调用请求会直接卡住。</p>
<p>官方SDK提供的使用案例中目前存在该问题, Server定义在了外部，导致没法对每个请求分配独立的Transport<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelcontextprotocol%2Ftypescript-sdk" target="_blank" title="https://github.com/modelcontextprotocol/typescript-sdk" ref="nofollow noopener noreferrer">modelcontextprotocol/typescript-sdk</a></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Create an MCP server</span>
<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">McpServer</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'demo-server'</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span>
});

<span class="hljs-comment">// Set up Express and HTTP transport</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/mcp'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
    <span class="hljs-comment">// Create a new transport for each request to prevent request ID collisions</span>
    <span class="hljs-keyword">const</span> transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamableHTTPServerTransport</span>({
        <span class="hljs-attr">sessionIdGenerator</span>: <span class="hljs-literal">undefined</span>,
        <span class="hljs-attr">enableJsonResponse</span>: <span class="hljs-literal">true</span>
    });

    res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {
        transport.<span class="hljs-title function_">close</span>();
    });

    <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">connect</span>(transport);
    <span class="hljs-keyword">await</span> transport.<span class="hljs-title function_">handleRequest</span>(req, res, req.<span class="hljs-property">body</span>);
});

<span class="hljs-keyword">const</span> port = <span class="hljs-built_in">parseInt</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> || <span class="hljs-string">'3000'</span>);
app.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Demo MCP Server running on http://localhost:<span class="hljs-subst">${port}</span>/mcp`</span>);
}).<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Server error:'</span>, error);
    process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);
});
</code></pre>
<p>因此，针对 streamable-http 与 sse 类型，需要将Server的创建放在请求处理中：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 把Server的定义代码封装起来</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">createServer</span> = (<span class="hljs-params"/>) =&gt; { <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">McpServer</span>() }

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/mcp'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
    <span class="hljs-keyword">const</span> server = <span class="hljs-title function_">createServer</span>();
    <span class="hljs-comment">// Create a new transport for each request to prevent request ID collisions</span>
    <span class="hljs-keyword">const</span> transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamableHTTPServerTransport</span>({
        <span class="hljs-attr">sessionIdGenerator</span>: <span class="hljs-literal">undefined</span>,
        <span class="hljs-attr">enableJsonResponse</span>: <span class="hljs-literal">true</span>
    });

    res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {
        transport.<span class="hljs-title function_">close</span>();
    });

    <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">connect</span>(transport);
    <span class="hljs-keyword">await</span> transport.<span class="hljs-title function_">handleRequest</span>(req, res, req.<span class="hljs-property">body</span>);
});
</code></pre>
<h3 data-id="heading-24">Next</h3>
<ul>
<li>一键转化API请求接口 =&gt; Streamable HTTP MCP</li>
<li>弹性启动Stdio进程</li>
</ul>
<h2 data-id="heading-25">最后</h2>
<p>欢迎关注【袋鼠云数栈UED团队】~<br/>
袋鼠云数栈 UED 团队持续为广大开发者分享技术成果，相继参与开源了欢迎 star</p>
<ul>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fdtstack.github.io%2FTaier%2F" target="_blank" title="https://dtstack.github.io/Taier/" ref="nofollow noopener noreferrer">大数据分布式任务调度系统——Taier</a></strong></li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fdtstack.github.io%2Fmolecule%2F" target="_blank" title="https://dtstack.github.io/molecule/" ref="nofollow noopener noreferrer">轻量级的 Web IDE UI 框架——Molecule</a></strong></li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fdtstack.github.io%2Fmonaco-sql-languages%2F" target="_blank" title="https://dtstack.github.io/monaco-sql-languages/" ref="nofollow noopener noreferrer">针对大数据领域的 SQL Parser 项目——dt-sql-parser</a></strong></li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDTStack%2Fcode-review-practices" target="_blank" title="https://github.com/DTStack/code-review-practices" ref="nofollow noopener noreferrer">袋鼠云数栈前端团队代码评审工程实践文档——code-review-practices</a></strong></li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDTStack%2Fko" target="_blank" title="https://github.com/DTStack/ko" ref="nofollow noopener noreferrer">一个速度更快、配置更灵活、使用更简单的模块打包器——ko</a></strong></li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDTStack%2Fant-design-testing" target="_blank" title="https://github.com/DTStack/ant-design-testing" ref="nofollow noopener noreferrer">一个针对 antd 的组件测试工具库——ant-design-testing</a></strong></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[年轻人的第一个 GO 桌面应用：用 Wails 做个学习搭子计时器]]></title>    <link>https://juejin.cn/post/7574318108719530030</link>    <guid>https://juejin.cn/post/7574318108719530030</guid>    <pubDate>2025-11-20T01:03:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574318108719530030" data-draft-id="7574271557939724339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="年轻人的第一个 GO 桌面应用：用 Wails 做个学习搭子计时器"/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2025-11-20T01:03:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Schuyler2025"/> <meta itemprop="url" content="https://juejin.cn/user/605198468525913"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            年轻人的第一个 GO 桌面应用：用 Wails 做个学习搭子计时器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/605198468525913/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Schuyler2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T01:03:38.000Z" title="Thu Nov 20 2025 01:03:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>告别控制台应用，用Go语言打造你的第一个桌面软件</p>
</blockquote>
<h2 data-id="heading-0">🎯 痛点场景：为什么需要桌面应用开发技能？</h2>
<p><strong>你是否遇到这些问题？</strong></p>
<ul>
<li>学了Go语言，却只会写命令行工具？</li>
<li>想学桌面开发，却觉得C++/C#太复杂？</li>
<li>面试官对你的“烂大街”项目不感兴趣？</li>
</ul>
<p><strong>你能学到什么？</strong></p>
<ul>
<li>✅️ Wails 基础使用</li>
<li>✅️ 实时事件通信</li>
<li>✅️ 系统托盘集成</li>
<li>✅️ 多线程编程</li>
<li>✅️ 附完整源码</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6504bca8c83743ecac275e1ada22919c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2NodXlsZXIyMDI1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764205417&amp;x-signature=GuUxO4PrH5yynuUMBaK5FvMyVqg%3D" alt="测试效果.gif" loading="lazy"/></p>
<h2 data-id="heading-1">🛠️ 环境准备</h2>
<h3 data-id="heading-2">步骤1：安装Go语言</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 官网下载安装包：https://golang.org/dl/</span>
go version  <span class="hljs-comment"># 验证安装</span>
</code></pre>
<h3 data-id="heading-3">步骤2：安装Wails框架</h3>
<pre><code class="hljs language-bash" lang="bash">go install github.com/wailsapp/wails/v2/cmd/wails@latest
wails version  <span class="hljs-comment"># 验证安装</span>
</code></pre>
<h3 data-id="heading-4">步骤3：创建项目骨架</h3>
<pre><code class="hljs language-bash" lang="bash">wails init -n Punktime
<span class="hljs-built_in">cd</span> Punktime
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37b3a9978a6b4b7fb90ce1dea8bd1376~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2NodXlsZXIyMDI1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764205417&amp;x-signature=1GrCkiFWVTYEnYETfPVP5dIYc6k%3D" alt="wailsinit.jpg" loading="lazy"/></p>
<h2 data-id="heading-5">🚀 核心功能开发</h2>
<h3 data-id="heading-6">设计 UI （前端）</h3>
<ul>
<li>
<p>使用 HTML/CSS/JavaScript实现：</p>
<ul>
<li>时间/倒计时主界面</li>
<li>倒计时设置遮罩层</li>
</ul>
</li>
<li>
<p>示例代码</p>
</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ============================================================================
     * 主界面结构
     * 应用程序的主要显示区域
     * ============================================================================ --&gt;</span>

    <span class="hljs-comment">&lt;!-- 主容器：显示倒计时/时间 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"countdown"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"countdown"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- ============================================================================
     * 倒计时输入框模态对话框
     * 用于设置倒计时时长的弹出窗口
     * ============================================================================ --&gt;</span>

    <span class="hljs-comment">&lt;!-- 倒计时输入框遮罩层 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">id</span>=<span class="hljs-string">"countdownInputOverlay"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"countdown-input-overlay"</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">"display: none"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"countdown-input-container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"countdown-input-title"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-comment">&lt;!-- 分钟输入框 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span>
            <span class="hljs-attr">id</span>=<span class="hljs-string">"minutesInput"</span>
            <span class="hljs-attr">class</span>=<span class="hljs-string">"countdown-input"</span>
            <span class="hljs-attr">min</span>=<span class="hljs-string">"0"</span>
            <span class="hljs-attr">max</span>=<span class="hljs-string">"59"</span>
            <span class="hljs-attr">value</span>=<span class="hljs-string">"25"</span>
            <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"分"</span>
          /&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"color: lightgreen"</span>&gt;</span>:<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-comment">&lt;!-- 秒数输入框 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span>
            <span class="hljs-attr">id</span>=<span class="hljs-string">"secondsInput"</span>
            <span class="hljs-attr">class</span>=<span class="hljs-string">"countdown-input"</span>
            <span class="hljs-attr">min</span>=<span class="hljs-string">"0"</span>
            <span class="hljs-attr">max</span>=<span class="hljs-string">"59"</span>
            <span class="hljs-attr">value</span>=<span class="hljs-string">"0"</span>
            <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"秒"</span>
          /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"countdown-input-buttons"</span>&gt;</span>
          <span class="hljs-comment">&lt;!-- 确认按钮 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"confirmCountdown"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"countdown-input-button"</span>&gt;</span>
            确定
          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-comment">&lt;!-- 取消按钮 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cancelCountdown"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"countdown-input-button"</span>&gt;</span>
            取消
          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h3 data-id="heading-7">实现计时逻辑（Go后端）</h3>
<ul>
<li>核心代码</li>
</ul>
<pre><code class="hljs language-Go" lang="Go"><span class="hljs-comment">/**
 * @description: 计时器更新循环，每秒执行一次的时间/倒计时更新逻辑
 * 函数作为计时器管理器的核心循环，负责：
 * 1. 每秒更新计时器状态和显示内容
 * 2. 根据当前显示模式（倒计时/时间）执行不同的更新逻辑
 * 3. 处理倒计时结束事件和状态转换
 * 4. 通过Wails事件系统向前端发送更新数据
 *
 * 倒计时模式逻辑：
 * - 运行中：计算剩余时间，倒计时结束时触发timerEnd事件
 * - 暂停中：显示暂停时的剩余时间
 * - 未开始：显示设置的倒计时总时长
 *
 * 时间模式逻辑：
 * - 显示当前系统时间（MM:SS格式）
 *
 * @example
 * // 每秒自动执行，无需手动调用
 * // 倒计时模式：显示"25:00" → "24:59" → ... → "00:00"（触发结束事件）
 * // 时间模式：显示当前时间如"14:30"
 *
 * @see runtime.EventsEmit 发送事件到前端
 * @see time.Since 计算时间间隔
 *
 * @note 使用互斥锁确保线程安全，避免并发访问计时器状态
 * @note 倒计时结束时自动重置状态并发送结束事件
 * @note 时间格式统一为两位数（如"05:09"而非"5:9"）
 */</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tm *TimerManager)</span></span> updateLoop() {
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">range</span> tm.ticker.C {
        tm.mu.Lock()
        <span class="hljs-keyword">if</span> tm.isTimerRunning {
                tm.timerElapsed = time.Since(tm.timerStartTime)
        }
        <span class="hljs-keyword">switch</span> tm.displayMode {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"countdown"</span>:
                <span class="hljs-keyword">if</span> tm.isTimerRunning {
                        remaining := tm.countdownDuration - tm.timerElapsed
                        <span class="hljs-keyword">if</span> remaining &lt;= <span class="hljs-number">0</span> {
                                remaining = <span class="hljs-number">0</span>
                                tm.isTimerRunning = <span class="hljs-literal">true</span>
                                tm.timerElapsed = tm.countdownDuration
                                tm.isPaused = <span class="hljs-literal">false</span>
                                runtime.EventsEmit(tm.ctx, <span class="hljs-string">"timerEnd"</span>)

                                timerText := <span class="hljs-string">"00:00"</span>
                                runtime.EventsEmit(tm.ctx, <span class="hljs-string">"timerUpdate"</span>, timerText)
                        } <span class="hljs-keyword">else</span> {
                                minutes := <span class="hljs-type">int</span>(remaining.Minutes())
                                seconds := <span class="hljs-type">int</span>(remaining.Seconds()) % <span class="hljs-number">60</span>
                                timerText := fmt.Sprintf(<span class="hljs-string">"%02d:%02d"</span>, minutes, seconds)
                                runtime.EventsEmit(tm.ctx, <span class="hljs-string">"timerUpdate"</span>, timerText)
                        }

                } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">if</span> tm.isPaused {
                                remaining := tm.countdownDuration - tm.timerElapsed
                                <span class="hljs-keyword">if</span> remaining &lt; <span class="hljs-number">0</span> {
                                        remaining = <span class="hljs-number">0</span>
                                }
                                minutes := <span class="hljs-type">int</span>(remaining.Minutes())
                                seconds := <span class="hljs-type">int</span>(remaining.Seconds()) % <span class="hljs-number">60</span>
                                timerText := fmt.Sprintf(<span class="hljs-string">"%02d:%02d"</span>, minutes, seconds)
                                runtime.EventsEmit(tm.ctx, <span class="hljs-string">"timerUpdate"</span>, timerText)
                        } <span class="hljs-keyword">else</span> {
                                minutes := <span class="hljs-type">int</span>(tm.countdownDuration.Minutes())
                                seconds := <span class="hljs-type">int</span>(tm.countdownDuration.Seconds()) % <span class="hljs-number">60</span>
                                timerText := fmt.Sprintf(<span class="hljs-string">"%02d:%02d"</span>, minutes, seconds)
                                runtime.EventsEmit(tm.ctx, <span class="hljs-string">"timerUpdate"</span>, timerText)
                        }
                }

        <span class="hljs-keyword">case</span> <span class="hljs-string">"time"</span>:
                currentTime := time.Now().Format(<span class="hljs-string">"15:04"</span>)
                runtime.EventsEmit(tm.ctx, <span class="hljs-string">"timeUpdate"</span>, currentTime)

        }
        tm.mu.Unlock()
}
}
</code></pre>
<ul>
<li>前后端通信
<ul>
<li>前端负责监听更新事件并渲染</li>
<li>后端负责触发更新事件并发送数据</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-comment">// 监听倒计时更新事件</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">runtime</span>.<span class="hljs-title class_">EventsOn</span>(<span class="hljs-string">"timerUpdate"</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"countdown"</span>).<span class="hljs-property">textContent</span> = data;
  });
  <span class="hljs-comment">// 监听时间显示更新事件</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">runtime</span>.<span class="hljs-title class_">EventsOn</span>(<span class="hljs-string">"timeUpdate"</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"countdown"</span>).<span class="hljs-property">textContent</span> = data;
  });
</code></pre>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">if</span> tm.isTimerRunning {
    remaining := tm.countdownDuration - tm.timerElapsed
    <span class="hljs-keyword">if</span> remaining &lt;= <span class="hljs-number">0</span> {
            remaining = <span class="hljs-number">0</span>
            tm.isTimerRunning = <span class="hljs-literal">true</span>
            tm.timerElapsed = tm.countdownDuration
            tm.isPaused = <span class="hljs-literal">false</span>
            runtime.EventsEmit(tm.ctx, <span class="hljs-string">"timerEnd"</span>)

            timerText := <span class="hljs-string">"00:00"</span>
            <span class="hljs-comment">// 发送事件显示更新事件</span>
            runtime.EventsEmit(tm.ctx, <span class="hljs-string">"timerUpdate"</span>, timerText)
    } <span class="hljs-keyword">else</span> {
            minutes := <span class="hljs-type">int</span>(remaining.Minutes())
            seconds := <span class="hljs-type">int</span>(remaining.Seconds()) % <span class="hljs-number">60</span>
            timerText := fmt.Sprintf(<span class="hljs-string">"%02d:%02d"</span>, minutes, seconds)
            <span class="hljs-comment">// 发送事件显示更新事件</span>
            runtime.EventsEmit(tm.ctx, <span class="hljs-string">"timerUpdate"</span>, timerText)
    }
</code></pre>
<h2 data-id="heading-8">📦️ 打包发布</h2>
<pre><code class="hljs language-bash" lang="bash">wails build
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/117292d95bd142ceab2eab7283dc7e34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2NodXlsZXIyMDI1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764205417&amp;x-signature=%2FjvBQi75wyRssJOieuFuJ84b2iY%3D" alt="结尾.jpg" loading="lazy"/></p>
<h2 data-id="heading-9">📖 学习资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwails.io%2Fzh-Hans%2Fdocs%2Fintroduction" target="_blank" title="https://wails.io/zh-Hans/docs/introduction" ref="nofollow noopener noreferrer">Wails官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgobyexample.com%2F" target="_blank" title="https://gobyexample.com/" ref="nofollow noopener noreferrer">Go语言实战教程</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSchuyler2025%2FPunktime" target="_blank" title="https://github.com/Schuyler2025/Punktime" ref="nofollow noopener noreferrer">本项目完整代码</a></li>
</ul>
<blockquote>
<p>👋你还希望有哪些学习搭子？欢迎留言！</p>
<p>❤️如果对你有帮助，别忘了点赞 + 关注！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【URP】Unity[RendererFeatures]渲染对象RenderObjects]]></title>    <link>https://juejin.cn/post/7574568258788720691</link>    <guid>https://juejin.cn/post/7574568258788720691</guid>    <pubDate>2025-11-20T02:02:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574568258788720691" data-draft-id="7574318108720169006" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【URP】Unity[RendererFeatures]渲染对象RenderObjects"/> <meta itemprop="keywords" content="游戏开发,Unity3D,图形学"/> <meta itemprop="datePublished" content="2025-11-20T02:02:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【URP】Unity[RendererFeatures]渲染对象RenderObjects
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T02:02:51.000Z" title="Thu Nov 20 2025 02:02:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13021255.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13021255%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13021255&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【从UnityURP开始探索游戏渲染】</a><strong>专栏-直达</strong></p>
</blockquote>
<h2 data-id="heading-0"><strong>RenderObjects的定义与作用</strong></h2>
<p>RenderObjects是URP提供的RendererFeature之一，允许开发者在不编写代码的情况下对渲染管线进行定制。它通过配置参数实现选择性渲染特定层级的物体、控制渲染顺序、重载材质或渲染状态等功能57。其核心用途包括：</p>
<ul>
<li>‌<strong>层级过滤</strong>‌：仅渲染指定LayerMask的物体</li>
<li>‌<strong>渲染时机控制</strong>‌：通过Event参数插入到渲染管线的不同阶段（如AfterRenderingOpaques）</li>
<li>‌<strong>材质替换</strong>‌：使用Override Material覆盖原有材质</li>
<li>‌<strong>多Pass渲染</strong>‌：配合Shader的LightMode标签实现描边等效果</li>
</ul>
<h2 data-id="heading-1"><strong>发展历史</strong></h2>
<ul>
<li>初始版本（2020年前）作为LWRP实验性功能引入</li>
<li>2020年URP 7.x版本正式集成，提供基础层过滤和材质替换</li>
<li>2021年后增强深度/模板控制，支持透明物体处理</li>
<li>2022年优化API结构，明确ScriptableRendererFeature与RenderPass的分离</li>
</ul>
<h2 data-id="heading-2">原理</h2>
<h3 data-id="heading-3"><strong>底层原理</strong></h3>
<ul>
<li>
<p>‌<strong>架构层级</strong>‌</p>
<p>RenderObjects通过继承<code>ScriptableRendererFeature</code>和<code>ScriptableRenderPass</code>实现管线扩展，核心逻辑在<code>Execute()</code>方法中通过<code>CommandBuffer</code>提交绘制指令。其本质是通过URP的<code>ScriptableRenderContext</code>调度GPU渲染命令，与内置管线不同之处在于采用可编程的轻量级渲染管线架构。</p>
</li>
<li>
<p>‌<strong>渲染流程控制</strong>‌</p>
<p>通过<code>RenderPassEvent</code>枚举插入到URP的固定管线阶段（如AfterRenderingOpaques），底层会触发以下操作：</p>
<ul>
<li>调用<code>ConfigureTarget()</code>设置渲染目标</li>
<li>使用<code>FilteringSettings</code>过滤指定Layer的物体</li>
<li>通过<code>DrawingSettings</code>配置Shader Pass和排序规则</li>
</ul>
</li>
<li>
<p>‌<strong>材质替换机制</strong>‌</p>
<p>当启用Override Material时，URP会临时替换原始材质的Shader，但保留物体的顶点数据。该过程通过<code>MaterialPropertyBlock</code>实现动态参数传递，避免材质实例化开销。</p>
</li>
</ul>
<h3 data-id="heading-4"><strong>实现示例</strong></h3>
<ul>
<li>
<p>OutlineFeature.cs</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> UnityEngine;
<span class="hljs-keyword">using</span> UnityEngine.Rendering;
<span class="hljs-keyword">using</span> UnityEngine.Rendering.Universal;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">OutlineFeature</span> : <span class="hljs-title">ScriptableRendererFeature</span> {
    <span class="hljs-keyword">class</span> <span class="hljs-title">OutlinePass</span> : <span class="hljs-title">ScriptableRenderPass</span> {
        <span class="hljs-keyword">private</span> Material _outlineMat;
        <span class="hljs-keyword">private</span> LayerMask _layerMask;
        <span class="hljs-keyword">private</span> FilteringSettings _filteringSettings;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OutlinePass</span>(<span class="hljs-params">Material mat, LayerMask mask</span>)</span> {
            _outlineMat = mat;
            _layerMask = mask;
            _filteringSettings = <span class="hljs-keyword">new</span> FilteringSettings(RenderQueueRange.opaque, _layerMask);
            renderPassEvent = RenderPassEvent.AfterRenderingOpaques;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Execute</span>(<span class="hljs-params">ScriptableRenderContext context, <span class="hljs-keyword">ref</span> RenderingData data</span>)</span> {
            <span class="hljs-keyword">var</span> drawingSettings = CreateDrawingSettings(
                <span class="hljs-keyword">new</span> ShaderTagId(<span class="hljs-string">"UniversalForward"</span>), 
                <span class="hljs-keyword">ref</span> data, 
                SortingCriteria.CommonOpaque
            );
            drawingSettings.overrideMaterial = _outlineMat;
            context.DrawRenderers(data.cullResults, <span class="hljs-keyword">ref</span> drawingSettings, <span class="hljs-keyword">ref</span> _filteringSettings);
        }
    }

    [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> Material _outlineMaterial;
    [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> LayerMask _outlineLayers = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">private</span> OutlinePass _pass;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Create</span>()</span> =&gt; _pass = <span class="hljs-keyword">new</span> OutlinePass(_outlineMaterial, _outlineLayers);
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddRenderPasses</span>(<span class="hljs-params">ScriptableRenderer renderer, <span class="hljs-keyword">ref</span> RenderingData data</span>)</span> 
        =&gt; renderer.EnqueuePass(_pass);
}
</code></pre>
</li>
<li>
<p>Outline.shader</p>
<pre><code class="hljs language-c" lang="c">Shader <span class="hljs-string">"Custom/Outline"</span> {
    Properties {
        _OutlineColor(<span class="hljs-string">"Color"</span>, Color) = (<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)
        _OutlineWidth(<span class="hljs-string">"Width"</span>, Range(<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>)) = <span class="hljs-number">0.03</span>
    }
    SubShader {
        Tags { <span class="hljs-string">"RenderType"</span>=<span class="hljs-string">"Opaque"</span> <span class="hljs-string">"Queue"</span>=<span class="hljs-string">"Geometry+100"</span> }
        Pass {
            Cull Front
            ZWrite Off
            CGPROGRAM
            <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> vertex vert</span>
            <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> fragment frag</span>
            <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"UnityCG.cginc"</span></span>

            <span class="hljs-type">float</span> _OutlineWidth;
            fixed4 _OutlineColor;

            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">appdata</span> {</span>
                float4 vertex : POSITION;
                float3 normal : NORMAL;
            };

            v2f <span class="hljs-title function_">vert</span><span class="hljs-params">(appdata v)</span> {
                v2f o;
                v.vertex.xyz += v.normal * _OutlineWidth;
                o.pos = UnityObjectToClipPos(v.vertex);
                <span class="hljs-keyword">return</span> o;
            }

            fixed4 <span class="hljs-title function_">frag</span><span class="hljs-params">(v2f i)</span> : SV_Target {
                <span class="hljs-keyword">return</span> _OutlineColor;
            }
            ENDCG
        }
    }
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-5"><strong>关键流程解析</strong></h3>
<ul>
<li>
<p>‌<strong>渲染指令提交</strong>‌</p>
<p><code>DrawRenderers</code>方法内部会构建<code>BatchRendererGroup</code>，将CPU侧的渲染数据批量提交至GPU，相比直接使用CommandBuffer更高效。</p>
</li>
<li>
<p>‌<strong>深度测试控制</strong>‌</p>
<p>示例中<code>ZWrite Off</code>禁用深度写入，使描边始终显示在原始物体表面，该技术也常用于解决透明物体渲染顺序问题。</p>
</li>
<li>
<p>‌<strong>多Pass协作</strong>‌</p>
<p>URP会先执行默认的Forward渲染Pass，再执行RenderObjects插入的Pass，通过<code>RenderPassEvent</code>控制执行顺序</p>
</li>
</ul>
<h2 data-id="heading-6"><strong>完整实现流程示例</strong></h2>
<ul>
<li>
<p>OutlineFeature.cs</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> UnityEngine;
<span class="hljs-keyword">using</span> UnityEngine.Rendering;
<span class="hljs-keyword">using</span> UnityEngine.Rendering.Universal;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">OutlineFeature</span> : <span class="hljs-title">ScriptableRendererFeature</span> {
    <span class="hljs-keyword">class</span> <span class="hljs-title">OutlinePass</span> : <span class="hljs-title">ScriptableRenderPass</span> {
        <span class="hljs-keyword">private</span> Material outlineMat;
        <span class="hljs-keyword">private</span> LayerMask layerMask;
        <span class="hljs-keyword">private</span> RenderTargetIdentifier source;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OutlinePass</span>(<span class="hljs-params">Material mat, LayerMask mask</span>)</span> {
            outlineMat = mat;
            layerMask = mask;
            renderPassEvent = RenderPassEvent.AfterRenderingOpaques;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Execute</span>(<span class="hljs-params">ScriptableRenderContext context, <span class="hljs-keyword">ref</span> RenderingData data</span>)</span> {
            CommandBuffer cmd = CommandBufferPool.Get(<span class="hljs-string">"OutlinePass"</span>);
            <span class="hljs-keyword">var</span> drawSettings = CreateDrawingSettings(
                <span class="hljs-keyword">new</span> ShaderTagId(<span class="hljs-string">"UniversalForward"</span>), 
                <span class="hljs-keyword">ref</span> data, SortingCriteria.CommonOpaque);
            <span class="hljs-keyword">var</span> filterSettings = <span class="hljs-keyword">new</span> FilteringSettings(RenderQueueRange.opaque, layerMask);
            context.DrawRenderers(data.cullResults, <span class="hljs-keyword">ref</span> drawSettings, <span class="hljs-keyword">ref</span> filterSettings);
            CommandBufferPool.Release(cmd);
        }
    }

    [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> Material outlineMaterial;
    [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> LayerMask outlineLayers;
    <span class="hljs-keyword">private</span> OutlinePass pass;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Create</span>()</span> {
        pass = <span class="hljs-keyword">new</span> OutlinePass(outlineMaterial, outlineLayers);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddRenderPasses</span>(<span class="hljs-params">ScriptableRenderer renderer, <span class="hljs-keyword">ref</span> RenderingData data</span>)</span> {
        renderer.EnqueuePass(pass);
    }
}
</code></pre>
</li>
<li>
<p>Outline.shader</p>
<pre><code class="hljs language-c" lang="c">Shader <span class="hljs-string">"Custom/Outline"</span> {
    Properties {
        _OutlineColor(<span class="hljs-string">"Color"</span>, Color) = (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)
        _OutlineWidth(<span class="hljs-string">"Width"</span>, Range(<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>)) = <span class="hljs-number">0.05</span>
    }
    SubShader {
        Tags { <span class="hljs-string">"RenderType"</span>=<span class="hljs-string">"Opaque"</span> <span class="hljs-string">"LightMode"</span>=<span class="hljs-string">"UniversalForward"</span> }
        Pass {
            CGPROGRAM
            <span class="hljs-comment">// Vertex expansion logic...</span>
            ENDCG
        }
    }
}
</code></pre>
</li>
</ul>
<h2 data-id="heading-7"><strong>参数详解与用例</strong></h2>



































<table><thead><tr><th>参数</th><th>说明</th><th>应用场景</th></tr></thead><tbody><tr><td>‌<strong>Event</strong>‌</td><td>渲染时机（如BeforeRenderingPostProcessing）</td><td>控制特效叠加顺序</td></tr><tr><td>‌<strong>LayerMask</strong>‌</td><td>目标渲染层级</td><td>仅对敌人/UI层描边</td></tr><tr><td>‌<strong>Override Material</strong>‌</td><td>替换材质</td><td>角色进入阴影区切换材质</td></tr><tr><td>‌<strong>Depth Test</strong>‌</td><td>深度测试模式</td><td>解决透明物体遮挡问题</td></tr><tr><td>‌<strong>Shader Passes</strong>‌</td><td>匹配的Shader LightMode标签</td><td>多Pass渲染（如"UniversalForward"）</td></tr></tbody></table>
<h2 data-id="heading-8"><strong>配置步骤</strong></h2>
<ul>
<li>创建URP Asset并启用Renderer Features</li>
<li>添加RenderObjects Feature到Forward Renderer</li>
<li>配置Event为AfterRenderingOpaques（不透明物体）或AfterRenderingTransparents（透明物体）</li>
<li>指定目标Layer和替换材质</li>
<li>调整Depth/Stencil参数解决遮挡问题</li>
</ul>
<p>典型应用包括：角色描边、场景分块渲染、特殊效果叠加（如受伤高亮）等。通过组合不同Event和LayerMask可实现复杂的渲染管线控制</p>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13021255.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13021255%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13021255&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【从UnityURP开始探索游戏渲染】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Room 简单使用]]></title>    <link>https://juejin.cn/post/7574343024324509737</link>    <guid>https://juejin.cn/post/7574343024324509737</guid>    <pubDate>2025-11-20T01:35:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574343024324509737" data-draft-id="7574343024324427817" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Room 简单使用"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-20T01:35:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Charlie灬"/> <meta itemprop="url" content="https://juejin.cn/user/2221480830311645"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Room 简单使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2221480830311645/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Charlie灬
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T01:35:07.000Z" title="Thu Nov 20 2025 01:35:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">创建 item 实体</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroidx%2Froom%2FEntity%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/androidx/room/Entity?hl=zh-cn" ref="nofollow noopener noreferrer">Entity</a> 类定义了一个表，该类的每个实例都表示数据库表中的一行。Entity 类以映射告知 Room 它打算如何呈现数据库中的信息并与之交互。在此应用中，实体将保存有关商品目录商品的信息，例如商品名称、商品价格和商品数量。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c56e74d909ee4fa89f1728b43e98e242~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxpZeeBrA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764207307&amp;x-signature=u1xQvfnU1FyQ%2FK0Jp1zKx0YnmZo%3D" alt="" loading="lazy"/></p>
<p><code>@Entity</code> 注解用于将某个类标记为数据库 Entity 类。对于每个 Entity 类，该应用都会创建一个数据库表来保存这些项。除非另行说明，否则 Entity 的每个字段在数据库中都表示为一列。存储在数据库中的每个实体实例都必须有一个主键。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroidx%2Froom%2FPrimaryKey%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/androidx/room/PrimaryKey?hl=zh-cn" ref="nofollow noopener noreferrer">主键</a>用于唯一标识数据库表中的每个记录/条目。应用分配主键后，便无法再修改主键；只要主键存在于数据库中，它就会表示实体对象。</p>
<p>在此任务中，将创建一个 Entity 类，并定义字段来存储每个商品的以下商品目录信息：<code>Int</code> 用于存储主键，<code>String</code> 用于存储商品名称，<code>double</code> 用于存储商品价格，<code>Int</code> 用于存储库存数量。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Entity(tableName = <span class="hljs-string">"items"</span>)</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span>(
    <span class="hljs-meta">@PrimaryKey(autoGenerate = true)</span>
    <span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>,
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> price: <span class="hljs-built_in">Double</span>,
    <span class="hljs-keyword">val</span> quantity: <span class="hljs-built_in">Int</span>
)
</code></pre>
<h2 data-id="heading-1">创建 item DAO</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroidx%2Froom%2FDao%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/androidx/room/Dao?hl=zh-cn" ref="nofollow noopener noreferrer">数据访问对象</a> (DAO) 是一种模式（<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FSingle-responsibility_principle" target="_blank" title="https://en.wikipedia.org/wiki/Single-responsibility_principle" ref="nofollow noopener noreferrer">单一责任原则</a>），其作用是通过提供抽象接口将持久性层与应用的其余部分分离，负责定义用于访问数据库的接口。</p>
<p>DAO 的功能在于，让在底层持久性层执行数据库操作所涉及的所有复杂性与应用的其余部分分离。这样，就可以独立于使用数据的代码更改数据层。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9387fb71af9d459ba6d0086bdd42bd9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxpZeeBrA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764207307&amp;x-signature=Bo%2Facks19fSFaBJmjb8v47aAO2c%3D" alt="" loading="lazy"/></p>
<p><code>Room</code> 库提供了便捷注解（例如 <code>@Insert</code>、<code>@Delete</code> 和 <code>@Update</code>），用于定义执行简单插入、删除和更新的方法，而无需编写 SQL 语句。如果需要定义更复杂的插入、删除或更新操作，或者需要查询数据库中的数据，请改用 <code>@Query</code> 注解。</p>
<p>数据库操作的执行可能用时较长，因此需要在单独的线程上运行。Room 不允许在主线程上访问数据库。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.room.Dao

<span class="hljs-meta">@Dao</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ItemDao</span> {

    <span class="hljs-meta">@Insert(onConflict = OnConflictStrategy.IGNORE)</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">insert</span><span class="hljs-params">(item: <span class="hljs-type">Item</span>)</span></span>

    <span class="hljs-meta">@Update</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">update</span><span class="hljs-params">(item: <span class="hljs-type">Item</span>)</span></span>

    <span class="hljs-meta">@Delete</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">delete</span><span class="hljs-params">(item: <span class="hljs-type">Item</span>)</span></span>

    <span class="hljs-meta">@Query(<span class="hljs-string">"SELECT * from items WHERE id = :id"</span>)</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItem</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: Flow&lt;Item&gt;

    <span class="hljs-meta">@Query(<span class="hljs-string">"SELECT * from items ORDER BY name ASC"</span>)</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getAllItems</span><span class="hljs-params">()</span></span>: Flow&lt;List&lt;Item&gt;&gt;
}
</code></pre>
<blockquote>
<p>添加参数 <code>onConflict</code> 并为其赋值 <code>OnConflictStrategy.``IGNORE</code>。参数 <code>onConflict</code> 用于告知 Room 在发生冲突时应该执行的操作。<code>OnConflictStrategy.``IGNORE</code> 策略会忽略新商品。</p>
<p>由于返回值类型为 <code>Flow</code>，Room 还会在后台线程上运行该查询。无需将其明确设为 <code>suspend</code> 函数并在协程作用域内调用它。</p>
</blockquote>
<h2 data-id="heading-2">创建 Database 实例</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroidx%2Froom%2FDatabase%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/androidx/room/Database?hl=zh-cn" ref="nofollow noopener noreferrer">Database</a> 类可为应用提供定义的 DAO 实例。反过来，应用可以使用 DAO 从数据库中检索数据，作为关联的数据实体对象的实例。此外，应用还可以使用定义的数据实体更新相应表中的行，或者创建新行供插入。</p>
<p>需要创建一个抽象 <code>RoomDatabase</code> 类，并为其添加 <code>@Database</code> 注解。此类有一个方法，如果数据库不存在，该方法会返回 <code>RoomDatabase</code> 的现有实例。</p>
<p><strong>获取 <strong><code>**RoomDatabase**</code></strong> 实例的一般过程：</strong></p>
<ol>
<li>创建一个扩展 <code>RoomDatabase</code> 的 <code>public abstract</code> 类。您定义的新抽象类将用作数据库持有者。您定义的类是抽象类，因为 <code>Room</code> 会为您创建实现。</li>
<li>为该类添加 <code>@Database</code> 注解。在参数中，为数据库列出实体并设置版本号。</li>
<li>定义一个返回 <code>ItemDao</code> 实例的抽象方法或属性，<code>Room</code> 会为您生成实现。</li>
<li>整个应用只需要一个 <code>RoomDatabase</code> 实例，因此请将 <code>RoomDatabase</code> 设为单例。</li>
<li>使用 <code>Room</code> 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroidx%2Froom%2FRoom%3Fhl%3Dzh-cn%23databaseBuilder(android.content.Context%2Cjava.lang.Class%2Ckotlin.String)" target="_blank" title="https://developer.android.com/reference/androidx/room/Room?hl=zh-cn#databaseBuilder(android.content.Context,java.lang.Class,kotlin.String)" ref="nofollow noopener noreferrer">Room.databaseBuilder</a> 创建 (<code>item_database</code>) 数据库。不过，仅当该数据库不存在时才应创建。否则，请返回现有数据库。</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> android.content.Context
<span class="hljs-keyword">import</span> androidx.room.Database
<span class="hljs-keyword">import</span> androidx.room.Room
<span class="hljs-keyword">import</span> androidx.room.RoomDatabase

<span class="hljs-comment">/**
* Database class with a singleton Instance object.
*/</span>
<span class="hljs-meta">@Database(entities = [Item::class], version = 1, exportSchema = false)</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InventoryDatabase</span> : <span class="hljs-type">RoomDatabase</span>() {

    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">itemDao</span><span class="hljs-params">()</span></span>: ItemDao

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-meta">@Volatile</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> Instance: InventoryDatabase? = <span class="hljs-literal">null</span>

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getDatabase</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: InventoryDatabase {
            <span class="hljs-comment">// if the Instance is not null, return it, otherwise create a new database instance.</span>
            <span class="hljs-keyword">return</span> Instance ?: synchronized(<span class="hljs-keyword">this</span>) {
                Room.databaseBuilder(context, InventoryDatabase::<span class="hljs-keyword">class</span>.java, <span class="hljs-string">"item_database"</span>)
                    .build()
                    .also { Instance = it }
            }
        }
    }
}
</code></pre>
<blockquote>
<p>将 <code>exportSchema</code> 设为 <code>false</code>，这样就不会保留架构版本记录的备份。</p>
<p>volatile 变量的值绝不会缓存，所有读写操作都将在主内存中完成。这些功能有助于确保 <code>Instance</code> 的值始终是最新的，并且对所有执行线程都相同。也就是说，一个线程对 <code>Instance</code> 所做的更改会立即对所有其他线程可见。</p>
</blockquote>
<h2 data-id="heading-3">实现存储库</h2>
<p>将实现 <code>ItemsRepository</code> 接口和 <code>OfflineItemsRepository</code> 类，以从数据库提供 <code>get</code>、<code>insert</code>、<code>delete</code> 和 <code>update</code> 实体。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.flow.Flow

<span class="hljs-comment">/**
* Repository that provides insert, update, delete, and retrieve of [Item] from a given data source.
*/</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ItemsRepository</span> {
    <span class="hljs-comment">/**
     * Retrieve all the items from the the given data source.
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getAllItemsStream</span><span class="hljs-params">()</span></span>: Flow&lt;List&lt;Item&gt;&gt;

    <span class="hljs-comment">/**
     * Retrieve an item from the given data source that matches with the [id].
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemStream</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: Flow&lt;Item?&gt;

    <span class="hljs-comment">/**
     * Insert item in the data source
     */</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">insertItem</span><span class="hljs-params">(item: <span class="hljs-type">Item</span>)</span></span>

    <span class="hljs-comment">/**
     * Delete item from the data source
     */</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">deleteItem</span><span class="hljs-params">(item: <span class="hljs-type">Item</span>)</span></span>

    <span class="hljs-comment">/**
     * Update item in the data source
     */</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateItem</span><span class="hljs-params">(item: <span class="hljs-type">Item</span>)</span></span>
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.flow.Flow

<span class="hljs-keyword">class</span> <span class="hljs-title class_">OfflineItemsRepository</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> itemDao: ItemDao) : ItemsRepository {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getAllItemsStream</span><span class="hljs-params">()</span></span>: Flow&lt;List&lt;Item&gt;&gt; = itemDao.getAllItems()

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemStream</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: Flow&lt;Item?&gt; = itemDao.getItem(id)

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">insertItem</span><span class="hljs-params">(item: <span class="hljs-type">Item</span>)</span></span> = itemDao.insert(item)

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">deleteItem</span><span class="hljs-params">(item: <span class="hljs-type">Item</span>)</span></span> = itemDao.delete(item)

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateItem</span><span class="hljs-params">(item: <span class="hljs-type">Item</span>)</span></span> = itemDao.update(item)
}
</code></pre>
<h2 data-id="heading-4">实现 AppContainer 类</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> itemsRepository: ItemsRepository <span class="hljs-keyword">by</span> lazy {
    OfflineItemsRepository(InventoryDatabase.getDatabase(context).itemDao())
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Fiddler抓包工具完整教程 HTTPHTTPS抓包、代理配置与API调试实战技巧（开发者进阶指南）]]></title>    <link>https://juejin.cn/post/7574352425236709395</link>    <guid>https://juejin.cn/post/7574352425236709395</guid>    <pubDate>2025-11-20T02:24:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574352425236709395" data-draft-id="7574366319736258596" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Fiddler抓包工具完整教程 HTTPHTTPS抓包、代理配置与API调试实战技巧（开发者进阶指南）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-20T02:24:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="星星电灯猴"/> <meta itemprop="url" content="https://juejin.cn/user/2848205394945444"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Fiddler抓包工具完整教程 HTTPHTTPS抓包、代理配置与API调试实战技巧（开发者进阶指南）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2848205394945444/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    星星电灯猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T02:24:09.000Z" title="Thu Nov 20 2025 02:24:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常开发中，很多程序员都有这样的经历：接口明明能请求成功，却拿不到数据；测试环境一切正常，生产环境却频繁超时；移动端请求参数总是“神秘消失”，前后端互相甩锅。</p>
<p>这些问题的根源，大多隐藏在网络层。
而想“看清楚网络请求到底发生了什么”，最有效的方式就是使用一款专业的抓包调试工具。</p>
<p>今天要介绍的这款工具，几乎是每位开发者都会安装在电脑上的“标配”——<strong>Fiddler抓包工具</strong>。</p>
<p>本文将系统讲解 Fiddler 的安装配置、代理设置、HTTPS 抓包、Mock 接口与调试技巧，并结合真实开发场景，为你总结出高效、实用的调试方法。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、Fiddler抓包工具简介</strong></h2>
<p><strong>Fiddler</strong> 是 Telerik 公司出品的一款免费 HTTP/HTTPS 抓包与调试工具。
它通过代理机制捕获网络请求，帮助开发者分析、修改、重放、模拟和测试各种接口通信。</p>
<p>与常见工具（如 Charles、Postman、Wireshark）相比，Fiddler 具备以下优势：</p>
<ul>
<li><strong>全面支持 HTTP / HTTPS 协议</strong>；</li>
<li><strong>可查看请求、响应、Header、参数与性能数据</strong>；</li>
<li><strong>支持断点调试与请求修改</strong>；</li>
<li><strong>内置 Mock 功能（AutoResponder）</strong>；</li>
<li><strong>免费、稳定、可扩展性强</strong>。</li>
</ul>
<p>Fiddler 是一款让开发者“看得清、改得动、测得准”的网络调试利器。</p>
<hr/>
<h2 data-id="heading-1"><strong>二、Fiddler安装与配置方法</strong></h2>
<h3 data-id="heading-2"><strong>1. 安装与启动</strong></h3>
<p>在 Windows 系统中安装 Fiddler 后，首次启动时软件会自动接管系统代理。
此时打开任意浏览器访问网站，即可在 Fiddler 主界面看到所有 HTTP 请求。</p>
<p><strong>小提示：</strong></p>
<ul>
<li>左下角显示 “Capturing” 表示抓包功能开启；</li>
<li>若为 “Paused”，点击即可恢复抓包。</li>
</ul>
<hr/>
<h3 data-id="heading-3"><strong>2. Fiddler代理设置（电脑与移动端）</strong></h3>
<p>Fiddler 默认只抓取当前电脑的网络请求。
若要抓取手机、小程序或模拟器流量，需要手动开启远程代理。</p>
<p><strong>设置步骤如下：</strong></p>
<ol>
<li>打开菜单栏 <code>Tools → Options → Connections</code>；</li>
<li>勾选 <strong>Allow remote computers to connect</strong>；</li>
<li>记录电脑 IP 地址与端口号（默认 8888）；</li>
<li>确保手机与电脑连接在同一 Wi-Fi；</li>
<li>在手机 Wi-Fi 设置中配置代理：
<ul>
<li>主机名：电脑 IP</li>
<li>端口：8888</li>
</ul>
</li>
</ol>
<p>完成后，你的手机请求将通过 Fiddler 转发，可实现跨设备抓包分析。</p>
<hr/>
<h3 data-id="heading-4"><strong>3. HTTPS 抓包设置</strong></h3>
<p>现在几乎所有接口都使用 HTTPS 加密协议。
为了查看加密流量内容，需在 Fiddler 中安装根证书并启用解密功能。</p>
<p><strong>配置方法：</strong></p>
<ul>
<li>打开 <code>Tools → Options → HTTPS</code>；</li>
<li>勾选 <strong>Decrypt HTTPS traffic</strong>；</li>
<li>点击 “Actions → Trust Root Certificate”；</li>
<li>安装并信任证书；</li>
<li>若抓取移动端请求，还需导出证书并在设备上设置信任。</li>
</ul>
<p>配置完成后，Fiddler 将能捕获完整的 HTTPS 请求与响应数据。</p>
<hr/>
<h2 data-id="heading-5"><strong>三、Fiddler使用教程：核心功能详解</strong></h2>
<h3 data-id="heading-6"><strong>1. 请求与响应分析</strong></h3>
<p>在主界面中，每条请求都可展开查看详细内容，包括：</p>
<ul>
<li>请求方式（GET、POST、PUT、DELETE）；</li>
<li>请求路径、参数与 Header；</li>
<li>响应状态码、Body 与返回数据；</li>
<li>请求耗时与性能分析。</li>
</ul>
<p><strong>实战经验：</strong>
某项目中登录接口总是返回空响应，通过 Fiddler 发现请求头 <code>Content-Type</code> 缺失，后端未能正确解析数据，几分钟内定位问题。</p>
<hr/>
<h3 data-id="heading-7"><strong>2. 断点调试（Breakpoints）</strong></h3>
<p>Fiddler 支持拦截请求与响应，让开发者可手动修改内容再继续执行。</p>
<p><strong>常见用途：</strong></p>
<ul>
<li>模拟接口错误（返回 404 / 500）；</li>
<li>修改参数验证容错逻辑；</li>
<li>延迟响应测试弱网性能。</li>
</ul>
<p><strong>技巧提示：</strong>
在命令行输入 <code>bpu yourapi.com</code> 即可对特定请求开启断点。</p>
<hr/>
<h3 data-id="heading-8"><strong>3. 模拟接口响应（AutoResponder）</strong></h3>
<p>AutoResponder 模块可用于 Mock 数据与接口模拟。</p>
<p><strong>使用方法：</strong></p>
<ol>
<li>打开 AutoResponder 面板；</li>
<li>添加匹配规则（支持正则或关键字匹配）；</li>
<li>指定本地 JSON 文件或输入模拟响应内容；</li>
<li>启用规则后，请求将自动返回预设数据。</li>
</ol>
<p><strong>典型场景：</strong>
后端接口未开发时，前端可通过 Fiddler 模拟返回 JSON 数据，提前验证页面逻辑，实现前后端解耦调试。</p>
<hr/>
<h3 data-id="heading-9"><strong>4. 构造与重放请求（Composer）</strong></h3>
<p>Composer 模块相当于内置版 Postman。
你可以复制请求、修改参数、编辑 Header 并重放，
实现接口测试与验证。</p>
<p><strong>应用举例：</strong></p>
<ul>
<li>测试签名与 Token；</li>
<li>验证参数格式是否正确；</li>
<li>快速重现线上 Bug。</li>
</ul>
<hr/>
<h3 data-id="heading-10"><strong>5. 性能分析（Timeline）</strong></h3>
<p>Timeline 能展示每个请求的生命周期：
DNS 查询 → TCP 建立 → TLS 握手 → 服务器响应 → 数据下载。</p>
<p>通过可视化的时序分析，开发者可轻松识别性能瓶颈，判断延迟是否来自网络、服务器还是前端资源加载。</p>
<hr/>
<h2 data-id="heading-11"><strong>四、Fiddler实战案例：一次“无响应请求”的排查过程</strong></h2>
<p>某次在调试 App 接口时，发现请求总是卡在“加载中”，没有任何响应。
后端确认服务正常，前端日志无异常。</p>
<p>通过 Fiddler 抓包发现，请求被浏览器缓存策略拦截，未真正发送到服务器。
禁用缓存后，一切恢复正常。</p>
<p>很多“请求失败”的问题，其实请求根本没有发出去。
抓包工具能让你快速判断问题出在哪一层，而不是盲目猜测。</p>
<hr/>
<h2 data-id="heading-12"><strong>五、Fiddler常用功能速览</strong></h2>



































<table><thead><tr><th>功能模块</th><th>主要作用</th><th>应用场景</th></tr></thead><tbody><tr><td><strong>Filters</strong></td><td>按域名或关键字过滤请求</td><td>聚焦关键接口调试</td></tr><tr><td><strong>AutoResponder</strong></td><td>模拟接口返回</td><td>前后端独立开发</td></tr><tr><td><strong>Breakpoints</strong></td><td>拦截与修改请求</td><td>模拟异常场景</td></tr><tr><td><strong>Composer</strong></td><td>构造与重放请求</td><td>API 调试与复现</td></tr><tr><td><strong>Timeline</strong></td><td>请求耗时分析</td><td>网络优化与性能测试</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-13"><strong>六、Fiddler与其他工具的对比</strong></h2>






























<table><thead><tr><th>工具</th><th>优势</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Fiddler</strong></td><td>免费、强大、支持请求修改与Mock</td><td>开发 / 测试</td></tr><tr><td><strong>Charles</strong></td><td>操作简洁、界面直观</td><td>新手调试</td></tr><tr><td><strong>Postman</strong></td><td>请求构造方便</td><td>API 测试</td></tr><tr><td><strong>Wireshark</strong></td><td>底层协议分析能力强</td><td>网络安全研究</td></tr></tbody></table>
<p>Fiddler 的综合能力最强，尤其在接口调试、请求修改与Mock 数据方面几乎无可替代。</p>
<hr/>
<h2 data-id="heading-14"><strong>七、学习与资源推荐</strong></h2>
<p>想更深入学习 Fiddler？访问**<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.fiddler.hk%2F" target="_blank" title="https://www.fiddler.hk/" ref="nofollow noopener noreferrer">Fiddler 中文网</a>**，掌握 <strong>Fiddler使用教程</strong>、<strong>代理设置</strong> 与 <strong>调试技巧</strong></p>
<p>网站内容包括：</p>
<ul>
<li>安装与配置教程；</li>
<li>HTTPS 抓包设置；</li>
<li>移动端代理与证书配置；</li>
<li>常见错误解决方案；</li>
<li>高阶调试与性能优化技巧。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[对象展开运算符 ... 详解]]></title>    <link>https://juejin.cn/post/7574318108720496686</link>    <guid>https://juejin.cn/post/7574318108720496686</guid>    <pubDate>2025-11-20T02:25:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574318108720496686" data-draft-id="7574318108720398382" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="对象展开运算符 ... 详解"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-20T02:25:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倚栏听风雨"/> <meta itemprop="url" content="https://juejin.cn/user/2682464103830750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            对象展开运算符 ... 详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464103830750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倚栏听风雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T02:25:16.000Z" title="Thu Nov 20 2025 02:25:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 基本概念</h2>
<p>对象展开运算符（Spread Operator）<code>...</code> 是 ES6 中引入的重要特性，用于展开对象的可枚举属性。</p>
<h2 data-id="heading-1">2. 基本语法</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> newObj = { ...originalObj };
</code></pre>
<h2 data-id="heading-2">3. 主要用途</h2>
<h3 data-id="heading-3">3.1 对象浅拷贝</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> person = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> };
<span class="hljs-keyword">const</span> copy = { ...person };

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(copy); <span class="hljs-comment">// { name: 'Alice', age: 25 }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(copy === person); <span class="hljs-comment">// false (不同引用)</span>
</code></pre>
<h3 data-id="heading-4">3.2 合并对象</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj1 = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> };
<span class="hljs-keyword">const</span> obj2 = { <span class="hljs-attr">c</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">d</span>: <span class="hljs-number">4</span> };
<span class="hljs-keyword">const</span> merged = { ...obj1, ...obj2 };

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(merged); <span class="hljs-comment">// { a: 1, b: 2, c: 3, d: 4 }</span>
</code></pre>
<h3 data-id="heading-5">3.3 属性覆盖</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> defaults = { <span class="hljs-attr">theme</span>: <span class="hljs-string">'light'</span>, <span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span> };
<span class="hljs-keyword">const</span> userSettings = { <span class="hljs-attr">fontSize</span>: <span class="hljs-number">18</span>, <span class="hljs-attr">language</span>: <span class="hljs-string">'en'</span> };

<span class="hljs-keyword">const</span> finalSettings = { ...defaults, ...userSettings };
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(finalSettings); <span class="hljs-comment">// { theme: 'light', fontSize: 18, language: 'en' }</span>
</code></pre>
<h3 data-id="heading-6">3.4 添加新属性</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">base</span> = { x: <span class="hljs-number">1</span>, y: <span class="hljs-number">2</span> }<span class="hljs-comment">;</span>
const <span class="hljs-attr">extended</span> = { ...base, z: <span class="hljs-number">3</span>, color: <span class="hljs-string">'red'</span> }<span class="hljs-comment">;</span>

console.log(extended)<span class="hljs-comment">; // { x: 1, y: 2, z: 3, color: 'red' }</span>
</code></pre>
<h2 data-id="heading-7">4. 深度特性</h2>
<h3 data-id="heading-8">4.1 展开顺序的重要性</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> objA = { <span class="hljs-attr">prop</span>: <span class="hljs-string">'A'</span> };
<span class="hljs-keyword">const</span> objB = { <span class="hljs-attr">prop</span>: <span class="hljs-string">'B'</span> };

<span class="hljs-keyword">const</span> result1 = { ...objA, ...objB }; <span class="hljs-comment">// { prop: 'B' }</span>
<span class="hljs-keyword">const</span> result2 = { ...objB, ...objA }; <span class="hljs-comment">// { prop: 'A' }</span>
</code></pre>
<h3 data-id="heading-9">4.2 与解构赋值结合  ========》</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> user = { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">'john@example.com'</span> };

<span class="hljs-comment">// 提取特定属性，剩余属性放入rest对象</span>
<span class="hljs-keyword">const</span> { id, name, ...rest } = user;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(id);   <span class="hljs-comment">// 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name); <span class="hljs-comment">// John</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(rest); <span class="hljs-comment">// { age: 30, email: 'john@example.com' }</span>
</code></pre>
<h3 data-id="heading-10">4.3 条件展开</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> condition = <span class="hljs-literal">true</span>;
<span class="hljs-keyword">const</span> extraProps = condition ? { <span class="hljs-attr">admin</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'editor'</span> } : {};

<span class="hljs-keyword">const</span> user = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>,
  ...extraProps
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user); <span class="hljs-comment">// { name: 'Alice', admin: true, role: 'editor' }</span>
</code></pre>
<h2 data-id="heading-11">5. 实际应用场景</h2>
<h3 data-id="heading-12">5.1 React 状态更新</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 不可变状态更新</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(<span class="hljs-function"><span class="hljs-params">prevState</span> =&gt;</span> ({
  ...prevState,
  <span class="hljs-attr">count</span>: prevState.<span class="hljs-property">count</span> + <span class="hljs-number">1</span>
}));
</code></pre>
<h3 data-id="heading-13">5.2 函数参数处理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">processUser</span>(<span class="hljs-params">baseInfo, additionalInfo</span>) {
  <span class="hljs-keyword">return</span> {
    ...baseInfo,
    ...additionalInfo,
    <span class="hljs-attr">processed</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
  };
}

<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">processUser</span>(
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> },
  { <span class="hljs-attr">email</span>: <span class="hljs-string">'bob@example.com'</span> }
);
</code></pre>
<h3 data-id="heading-14">5.3 配置合并</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> defaultConfig = {
  <span class="hljs-attr">apiUrl</span>: <span class="hljs-string">'https://api.example.com'</span>,
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span>,
  <span class="hljs-attr">retries</span>: <span class="hljs-number">3</span>
};

<span class="hljs-keyword">const</span> userConfig = {
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span>,
  <span class="hljs-attr">apiKey</span>: <span class="hljs-string">'12345'</span>
};

<span class="hljs-keyword">const</span> finalConfig = {
  ...defaultConfig,
  ...userConfig
};
</code></pre>
<h2 data-id="heading-15">6. 注意事项</h2>
<h3 data-id="heading-16">6.1 浅拷贝问题</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> original = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span>,
  <span class="hljs-attr">nested</span>: { <span class="hljs-attr">value</span>: <span class="hljs-number">1</span> }
};

<span class="hljs-keyword">const</span> copy = { ...original };
copy.<span class="hljs-property">nested</span>.<span class="hljs-property">value</span> = <span class="hljs-number">2</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(original.<span class="hljs-property">nested</span>.<span class="hljs-property">value</span>); <span class="hljs-comment">// 2 (被修改了!)</span>
</code></pre>
<h3 data-id="heading-17">6.2 原型链属性</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'animal'</span>;
  }
}

<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">speak</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-string">'sound'</span>; };

<span class="hljs-keyword">const</span> dog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>();
dog.<span class="hljs-property">breed</span> = <span class="hljs-string">'Labrador'</span>;

<span class="hljs-keyword">const</span> copy = { ...dog };
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(copy.<span class="hljs-property">type</span>);    <span class="hljs-comment">// 'animal'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(copy.<span class="hljs-property">breed</span>);   <span class="hljs-comment">// 'Labrador'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(copy.<span class="hljs-property">speak</span>);   <span class="hljs-comment">// undefined (原型方法不会被复制)</span>
</code></pre>
<h3 data-id="heading-18">6.3 不可枚举属性</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {};
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, <span class="hljs-string">'hidden'</span>, {
  <span class="hljs-attr">value</span>: <span class="hljs-string">'secret'</span>,
  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>
});

obj.<span class="hljs-property">visible</span> = <span class="hljs-string">'can see'</span>;

<span class="hljs-keyword">const</span> spread = { ...obj };
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(spread); <span class="hljs-comment">// { visible: 'can see' }</span>
</code></pre>
<h2 data-id="heading-19">7. 与数组展开的区别</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 数组展开</span>
<span class="hljs-keyword">const</span> arr1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">const</span> arr2 = [...arr1, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]; <span class="hljs-comment">// [1, 2, 3, 4, 5]</span>

<span class="hljs-comment">// 对象展开</span>
<span class="hljs-keyword">const</span> obj1 = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> };
<span class="hljs-keyword">const</span> obj2 = { ...obj1, <span class="hljs-attr">c</span>: <span class="hljs-number">3</span> }; <span class="hljs-comment">// { a: 1, b: 2, c: 3 }</span>

<span class="hljs-comment">// 数组转为对象</span>
<span class="hljs-keyword">const</span> array = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>];
<span class="hljs-keyword">const</span> objectFromArray = { ...array }; <span class="hljs-comment">// { 0: 'a', 1: 'b', 2: 'c' }</span>
</code></pre>
<h2 data-id="heading-20">8. 浏览器兼容性</h2>
<p>对象展开运算符在现代浏览器中得到良好支持，但在旧版浏览器中可能需要使用 Babel 等工具进行转译。</p>
<h2 data-id="heading-21">总结</h2>
<p>对象展开运算符 <code>...</code> 是一个强大且灵活的工具，它：</p>
<ul>
<li>提供简洁的对象复制和合并语法</li>
<li>支持不可变数据模式</li>
<li>提高代码的可读性和可维护性</li>
<li>在处理配置、状态管理等场景中特别有用</li>
</ul>
<p>使用时需要注意其浅拷贝的特性，对于嵌套对象需要额外的深拷贝处理。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于LangSmith的提示词工程]]></title>    <link>https://juejin.cn/post/7574584245109276723</link>    <guid>https://juejin.cn/post/7574584245109276723</guid>    <pubDate>2025-11-20T00:54:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574584245109276723" data-draft-id="7574322843048755250" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于LangSmith的提示词工程"/> <meta itemprop="keywords" content="LangChain,Agent,Python"/> <meta itemprop="datePublished" content="2025-11-20T00:54:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCode"/> <meta itemprop="url" content="https://juejin.cn/user/1282499717900794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于LangSmith的提示词工程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1282499717900794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:54:35.000Z" title="Thu Nov 20 2025 00:54:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>提示词（Prompt）用于引导大模型（LLM）的行为。提示词工程（Prompt Engineering）是指设计、测试并优化给大模型的指令，以使其生成可靠且有用的响应的过程。</p>
<p>LangSmith提供了用于创建、版本控制、测试提示词以及进行协作的工具。另外还有一些常见概念，例如提示词模板（Prompt Templates）—— 可让你复用结构化的提示词，以及变量（Variables）—— 能让你在提示词中动态插入值（例如用户的问题）。</p>
<p>在本文中，你将通过软件开发工具包（SDK）来创建、测试并优化提示词。本指南以OpenAI作为示例大模型提供商，但相同的工作流程也适用于其他提供商。</p>
<h2 data-id="heading-0">准备</h2>
<p>开始之前，请确保你已具备以下条件：</p>
<ul>
<li>一个 LangSmith 账号：可前往 smith.langchain.com 注册或登录。</li>
<li>一个 LangSmith API 密钥：请参考《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Flangsmith%2Fcreate-account-api-key%23create-an-api-key" target="_blank" title="https://docs.langchain.com/langsmith/create-account-api-key#create-an-api-key" ref="nofollow noopener noreferrer">创建 API 密钥指南</a>》操作。</li>
<li>一个 OpenAI API 密钥：可从OpenAI控制台生成。</li>
</ul>
<h2 data-id="heading-1">搭建环境</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> ls-prompt-quickstart &amp;&amp; <span class="hljs-built_in">cd</span> ls-prompt-quickstart
python -m venv .venv
<span class="hljs-built_in">source</span> .venv/bin/activate
pip install -qU langsmith openai langchain_core
<span class="hljs-built_in">export</span> LANGSMITH_API_KEY=<span class="hljs-string">'&lt;your_api_key&gt;'</span>
<span class="hljs-built_in">export</span> OPENAI_API_KEY=<span class="hljs-string">'&lt;your_api_key&gt;'</span>
</code></pre>
<h2 data-id="heading-2">创建提示词</h2>
<p>要创建提示词，你需要先定义提示词中所需的消息列表，然后将其推送到LangSmith平台。
使用对应编程语言的构造函数与推送方法：</p>
<ul>
<li>Python：通过 ChatPromptTemplate 构建 → 调用 client.push_prompt(...) 推送</li>
<li>TypeScript：通过 ChatPromptTemplate.fromMessages(...) 构建 → 调用 client.pushPrompt(...) 推送。</li>
</ul>
<p>在 create_prompt.py文件中添加以下代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langsmith <span class="hljs-keyword">import</span> Client
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate

client = Client()

prompt = ChatPromptTemplate([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"You are a helpful chatbot."</span>),
    (<span class="hljs-string">"user"</span>, <span class="hljs-string">"{question}"</span>),
])

client.push_prompt(<span class="hljs-string">"prompt-quickstart"</span>, <span class="hljs-built_in">object</span>=prompt)
</code></pre>
<p>此操作会创建一个有序的消息列表，将其封装到 ChatPromptTemplate（对话提示词模板）中，然后按名称将该提示词推送到你的工作区，以便进行版本控制和复用。</p>
<p>执行脚本：
<code>python create_prompt.py</code></p>
<p>点击生成的链接，即可在 LangSmith 用户界面（UI）中查看新创建的 “提示词中心”（Prompt Hub）提示词。</p>
<h2 data-id="heading-3">测试提示词</h2>
<p>在本步骤中，你将通过名称（"prompt-quickstart"）拉取上一步创建的提示词，用测试输入对其进行格式化，转换为 OpenAI 的对话格式，然后调用OpenAI的Chat Completions API。</p>
<p>之后，你可以通过创建新版本来迭代优化该提示词。工作区成员可打开已有提示词，在用户界面（UI）中尝试修改，并将这些修改保存为该提示词的新提交记录，从而为整个团队保留历史版本记录。</p>
<p>在 test_prompt.py文件中添加以下内容：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langsmith <span class="hljs-keyword">import</span> Client
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> convert_to_openai_messages

client = Client()
oai_client = OpenAI()

prompt = client.pull_prompt(<span class="hljs-string">"prompt-quickstart"</span>)

<span class="hljs-comment"># Since the prompt only has one variable you could also pass in the value directly</span>
<span class="hljs-comment"># Equivalent to formatted_prompt = prompt.invoke("What is the color of the sky?")</span>
formatted_prompt = prompt.invoke({<span class="hljs-string">"question"</span>: <span class="hljs-string">"What is the color of the sky?"</span>})

response = oai_client.chat.completions.create(
    model=<span class="hljs-string">"gpt-4o"</span>,
    messages=convert_to_openai_messages(formatted_prompt.messages),
)
</code></pre>
<p>此操作会通过名称加载提示词，使用 pull（拉取）方法获取你正在测试的提示词的最新提交版本。你也可以通过传入"提交哈希值"（格式为 :）来指定某个特定的提交版本。</p>
<p>执行测试：
<code>python test_prompt.py</code></p>
<p>若要创建提示词的新版本，只需使用初始时的相同推送方法，传入相同的提示词名称和更新后的模板即可。LangSmith会将其记录为新的提交记录，并保留之前的版本。</p>
<p>将以下代码复制到 iterate_prompt.py文件中：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langsmith <span class="hljs-keyword">import</span> Client
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate

client = Client()

new_prompt = ChatPromptTemplate([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"You are a helpful chatbot. Respond in Spanish."</span>),
    (<span class="hljs-string">"user"</span>, <span class="hljs-string">"{question}"</span>),
])

client.push_prompt(<span class="hljs-string">"prompt-quickstart"</span>, <span class="hljs-built_in">object</span>=new_prompt)
</code></pre>
<p>执行脚本：
<code>python iterate_prompt.py</code></p>
<p>现在你的提示词将包含两条提交记录。</p>
<p>如需优化你的提示词，可参考以下方式：</p>
<ul>
<li>查阅模型提供商提供的文档，获取提示词创建的最佳实践，例如：
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.openai.com%2Fen%2Farticles%2F6654000-best-practices-for-prompt-engineering-with-the-openai-api" target="_blank" title="https://help.openai.com/en/articles/6654000-best-practices-for-prompt-engineering-with-the-openai-api" ref="nofollow noopener noreferrer">《OpenAI API 提示词工程最佳实践》</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fai.google.dev%2Fgemini-api%2Fdocs%2Fprompting-intro" target="_blank" title="https://ai.google.dev/gemini-api/docs/prompting-intro" ref="nofollow noopener noreferrer">《Gemini 提示词设计入门》</a></li>
</ul>
</li>
<li>使用 LangSmith 中的交互式工具 ——“提示词画布”（Prompt Canvas）构建并优化提示词。更多详情可参考《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Flangsmith%2Fwrite-prompt-with-ai" target="_blank" title="https://docs.langchain.com/langsmith/write-prompt-with-ai" ref="nofollow noopener noreferrer">提示词画布指南</a>》。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[多智能体系统的上下文工程——构建上下文感知的多智能体系统]]></title>    <link>https://juejin.cn/post/7574321422400274458</link>    <guid>https://juejin.cn/post/7574321422400274458</guid>    <pubDate>2025-11-19T15:59:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574321422400274458" data-draft-id="7574322843048427570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="多智能体系统的上下文工程——构建上下文感知的多智能体系统"/> <meta itemprop="keywords" content="MCP,Agent,LLM"/> <meta itemprop="datePublished" content="2025-11-19T15:59:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="数据智能老司机"/> <meta itemprop="url" content="https://juejin.cn/user/430664289626439"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            多智能体系统的上下文工程——构建上下文感知的多智能体系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/430664289626439/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    数据智能老司机
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T15:59:32.000Z" title="Wed Nov 19 2025 15:59:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读34分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上一章中，我们使用 MCP 构建了一个多智能体系统（Multi-Agent System，MAS）。这个系统可以工作，但有一个很大的局限：它的“知识”都是模拟出来的。对于学习来说这没问题，但也意味着这些智能体被困在了我们预先设计好的沙盒里：它们不能访问真实信息，也无法根据当前环境即时调整行为。<br/>
在这一章，我们要把它们从盒子里“放出来”——让智能体通过基于向量存储（vector store）构建的实时信息管道，连接到外部数据。</p>
<p>精彩的部分现在才开始。我们将引入一个更强大的架构：<strong>双 RAG 多智能体系统（dual RAG MAS）</strong> 。<br/>
它会用两种方式来使用检索增强生成（Retrieval-Augmented Generation，RAG）：</p>
<ol>
<li>第一种是你熟悉的：从知识库中检索事实；</li>
<li>第二种则是新的：检索“过程性指令”，也就是实现<strong>过程化 / 动态 RAG</strong>所需的“执行脚本”。</li>
</ol>
<p>这种新增能力改变了游戏规则：<br/>
系统不仅能“学会说什么（what to say）”，还可以“学会怎么说（how to say it）”，并能按需切换风格和结构。</p>
<p>我们会在两个 Notebook 中一步步构建这一系统：</p>
<ul>
<li>第一个 Notebook 聚焦于<strong>数据摄入（ingestion）</strong> ：<br/>
我们会为“事实”创建一个知识库（knowledge base），<br/>
为“语义蓝图（semantic blueprints）”创建一个上下文库（context library）。</li>
<li>第二个 Notebook 负责“运行时执行（runtime execution）”：<br/>
展示智能体如何在实时执行中检索并组合这两类上下文。</li>
</ul>
<p>在这个过程中，我们会介绍一个新的专业智能体：<strong>上下文馆员（Context Librarian）</strong> ，<br/>
并看到 Orchestrator（编排器）如何让整个团队保持协同。</p>
<p>本章主要涵盖以下内容：</p>
<ul>
<li>设计一个双 RAG 的 MAS 架构</li>
<li>将“事实性知识”和“过程性指令”分离管理</li>
<li>为事实构建知识库（Knowledge Base）</li>
<li>为语义蓝图创建上下文库（Context Library）</li>
<li>使用向量存储的命名空间（namespace）管理不同数据类型</li>
<li>实现新的专业智能体，比如 Context Librarian</li>
<li>通过编排让整个系统生成“具备上下文感知能力”的内容</li>
</ul>
<p>接下来，我们先从 RAG MAS 的架构入手。</p>
<h2 data-id="heading-0">设计双 RAG MAS 架构</h2>
<p>Architecting a dual RAG MAS</p>
<p>要构建这个具备上下文感知能力的系统，我们需要先清晰地理解它的架构。<br/>
从高层来看，整个过程被划分为两个互相独立又相互关联的阶段，我们会分别设计和实现：</p>
<ul>
<li><strong>Phase 1：数据准备（Data Preparation）</strong> —— 负责把数据准备好</li>
<li><strong>Phase 2：运行时执行（Runtime Execution）</strong> —— MAS 使用准备好的数据来响应用户目标</li>
</ul>
<p>本章会在两个对应的 Notebook 中完成这两个阶段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ee7d34061aa48a8b0d5f1225d21f88b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5pm66IO96ICB5Y-45py6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172772&amp;x-signature=TFNbO%2FeHl6KcmfZNk7DllAZwmIQ%3D" alt="image.png" loading="lazy"/></p>
<p>图 3.1：双 RAG MAS 的整体架构</p>
<p>上图展示了双 RAG MAS 架构中<strong>数据流与执行流</strong>的全貌，箭头表示组件之间在高层上的连接关系。<br/>
在进入具体代码之前，我们先按图把每个部分梳理一遍。</p>
<h3 data-id="heading-1">阶段一：数据准备（Phase 1: Data preparation）</h3>
<p>在 Phase 1 中，我们专注于<strong>准备数据</strong>，这一部分对应图 3.1 左侧。<br/>
系统从两类不同的输入源开始：</p>
<ul>
<li><strong>知识数据（Knowledge data）</strong> ：<br/>
系统应该“知道”的<strong>事实性信息</strong></li>
<li><strong>上下文数据（Context data）</strong> ：<br/>
结构化指令，或者说<strong>语义蓝图（semantic blueprints）</strong> ，这在第 1 章中已经介绍过</li>
</ul>
<p>这两类数据都由同一个**嵌入模型（embedding model）**来处理：</p>
<ul>
<li>对于<strong>知识数据</strong>，我们会把文本切分成多个 chunk，并对每个 chunk 进行向量化（embedding）。</li>
<li>对于<strong>上下文数据 / 语义蓝图</strong>，我们只对“蓝图意图（intent）的描述”进行向量化。<br/>
之后的检索将基于“意图”来进行匹配。<br/>
完整的蓝图内容则单独存储在一个 JSON 对象中，并与其描述建立关联。</li>
</ul>
<p>所有的向量会存入 Pinecone 向量数据库，这个库会承载系统需要的一切外部数据。<br/>
我们只用一个 Pinecone 索引，但将它划分成两个严格分离的命名空间（namespace）：</p>
<ul>
<li><strong>KnowledgeStore</strong>：<br/>
存储来自“事实数据”的向量</li>
<li><strong>ContextLibrary</strong>：<br/>
存储来自“过程蓝图 / 语义蓝图”的向量</li>
</ul>
<p>当这两个命名空间都就位后，系统就可以进入第二阶段。</p>
<h3 data-id="heading-2">阶段二：运行时执行分析</h3>
<p>Phase 2: Runtime execution analysis</p>
<p>在 Phase 2 中，MAS 会真正开始执行用户请求，对应图 3.1 的右侧。</p>
<p>流程从一个**用户目标（user goal）**开始，这是一条由用户提交的高层指令，例如：</p>
<blockquote>
<p>“写一篇关于阿波罗 11 号的悬疑故事”（Write a suspenseful story about Apollo 11）</p>
</blockquote>
<p>Orchestrator 收到这个目标，作为系统的中央协调者，它会分析这条请求，并识别出两个关键成分：</p>
<ul>
<li>
<p><strong>intent_query</strong>：<br/>
这是用于“馆员（Librarian）查询”的“意图向量”，与<strong>期望的风格或结构</strong>有关</p>
<ul>
<li>在例子中就是： <em>“悬疑故事（suspenseful story）”</em></li>
</ul>
</li>
<li>
<p><strong>topic_query</strong>：<br/>
这是用于“研究员（Researcher）查询”的“主题向量”，与<strong>主题内容本身</strong>有关</p>
<ul>
<li>在例子中就是： <em>“阿波罗 11 号（Apollo 11）”</em></li>
</ul>
</li>
</ul>
<p>随后，Orchestrator 会把这两个查询分派给各自的专业智能体：</p>
<ol>
<li>
<p><strong>Librarian 智能体（上下文馆员）</strong></p>
<ul>
<li>职责：检索“指令脚本”（instruction scripts）。</li>
<li>它通过引擎的 MCP 消息层接收 <code>intent_query</code>，</li>
<li>查询的是 <strong>ContextLibrary 命名空间</strong>，</li>
<li>执行语义检索，找到最匹配本次意图的“蓝图描述”，</li>
<li>然后取回对应的<strong>语义蓝图（semantic blueprint）</strong> 。</li>
</ul>
</li>
<li>
<p><strong>Researcher 智能体（研究员）</strong></p>
<ul>
<li>职责：检索“事实信息”。</li>
<li>它接收 <code>topic_query</code>，</li>
<li>查询的是 <strong>KnowledgeStore 命名空间</strong>，</li>
<li>检索与主题相关的事实性文本块（chunks），</li>
<li>并把这些信息综合为简明的“研究结论”。</li>
</ul>
</li>
</ol>
<p>当这两路结果都准备好之后，Orchestrator 会把：</p>
<ul>
<li>来自 Librarian 的<strong>指令脚本 / 蓝图</strong>，以及</li>
<li>来自 Researcher 的<strong>综合事实</strong></li>
</ul>
<p>一并“交付”给 Writer 智能体。<br/>
在图 3.1 中，这一过程被箭头表示为：<strong>蓝图（blueprint）和事实（facts）从 Librarian 与 Researcher 流向 Writer</strong>。</p>
<p>Writer 智能体作为系统的“生成引擎”：</p>
<ul>
<li>将“事实”用作内容素材；</li>
<li>将“蓝图”用作结构与风格的<strong>强约束指令</strong>；</li>
</ul>
<p>在这双重约束下，它生成最终输出：既满足<strong>事实正确性</strong>，又符合<strong>过程性 / 风格性指令</strong>。</p>
<p>这种架构带来了极高的<strong>灵活性与可扩展性</strong>：</p>
<ul>
<li>更新知识库，不需要修改指令脚本；</li>
<li>新增语义蓝图，也不需要触碰事实数据；</li>
<li>在运行时，智能体会根据检索到的上下文，动态调整自身行为。</li>
</ul>
<p>至此，架构已经讲清楚了。<br/>
接下来，我们就可以进入实现部分：第一步是构建 <strong>RAG 数据摄入管道（RAG ingestion pipeline）</strong> 。</p>
<h2 data-id="heading-3">RAG 流水线中的数据摄入（上下文与知识）</h2>
<p>在第 2 章里，我们用<strong>模拟数据</strong>构建了一个 MAS。<br/>
这些智能体“会查资料”，但它们能查到的东西只来自一个简单的 Python 字典。</p>
<p>本章要迈出下一步：<br/>
用一个<strong>真实的 RAG 流水线</strong>替换掉这个模拟层。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25aeee14196d4eb3b76a9c1b4bf6e5f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5pm66IO96ICB5Y-45py6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172772&amp;x-signature=AL%2FNhGiEkdPnqmtrj6cu8kINsiY%3D" alt="image.png" loading="lazy"/></p>
<p>图 3.2：RAG 数据摄入流水线流程图</p>
<p>图 3.2 展示了这条流水线的整体流程。<br/>
在智能体能够高效检索之前，我们必须先<strong>准备并构建它们要用的数据库</strong>。</p>
<p>这里我们引入两种互补的 RAG 形式：</p>
<ul>
<li>
<p><strong>知识库（Knowledge base，事实型 RAG）</strong> ：<br/>
存储事实信息。这是最经典、工程师们最熟悉的 RAG 用法。</p>
</li>
<li>
<p><strong>上下文库（Context library，过程型 RAG）</strong> ：<br/>
存储指令或<strong>语义蓝图（semantic blueprints）</strong> （在第 1 章中介绍过）。<br/>
智能体查询这个库，是为了决定：</p>
<blockquote>
<p>自己应该用什么结构来组织回答、采用什么风格。</p>
</blockquote>
</li>
</ul>
<p>要实现这一切，请打开本章仓库中的 <code>RAG_Pipeline.ipynb</code>。<br/>
在这个 Notebook 里，我们将：</p>
<ol>
<li>构建两个数据库（知识库与上下文库）；</li>
<li>提取并转换数据为向量（embeddings）；</li>
<li>将这些向量上传到 Pinecone 向量存储中；</li>
<li>并通过 <strong>namespace</strong> 将这两个数据库严格隔离。</li>
</ol>
<h3 data-id="heading-4">安装与环境准备</h3>
<p>Installation and setup</p>
<p>先把运行环境准备好。<br/>
本项目中我使用 <strong>Pinecone</strong> 作为向量数据库，但如果你更习惯其它平台，也可以替换；<br/>
只要满足向量检索能力即可。</p>
<p>同时，为了更实用一点，我们还会引入：</p>
<ul>
<li><code>tqdm</code>：用于监控上传进度；</li>
<li><code>tenacity</code>：用于在网络抖动时，让 API 调用更可靠（自动重试等）。</li>
</ul>
<p>有一个我自己踩过很多次坑的经验要提前说：<br/>
<strong>Python 的库生态变化很快</strong>，如果不锁定版本，很容易从“做系统”变成“打依赖补丁”。<br/>
为了避免你也陷在这些问题里，我们在这里直接冻结一些具体版本：</p>
<pre><code class="hljs language-ini" lang="ini">!pip install <span class="hljs-attr">tqdm</span>==<span class="hljs-number">4.67</span>.<span class="hljs-number">1</span> --upgrade
!pip install <span class="hljs-attr">openai</span>==<span class="hljs-number">1.104</span>.<span class="hljs-number">2</span>
!pip install <span class="hljs-attr">pinecone</span>==<span class="hljs-number">7.0</span>.<span class="hljs-number">0</span> tqdm==<span class="hljs-number">4.67</span>.<span class="hljs-number">1</span> tenacity==<span class="hljs-number">8.3</span>.<span class="hljs-number">0</span>
</code></pre>
<p>接下来，把本 Notebook 需要的模块导入进来：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Imports for this notebook</span>
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> tqdm.auto <span class="hljs-keyword">import</span> tqdm
<span class="hljs-keyword">import</span> tiktoken
<span class="hljs-keyword">from</span> pinecone <span class="hljs-keyword">import</span> Pinecone, ServerlessSpec
<span class="hljs-keyword">from</span> tenacity <span class="hljs-keyword">import</span> retry, stop_after_attempt, wait_random_exponential

<span class="hljs-comment"># general imports required in the notebooks of this book</span>
<span class="hljs-keyword">import</span> re
<span class="hljs-keyword">import</span> textwrap
<span class="hljs-keyword">from</span> IPython.display <span class="hljs-keyword">import</span> display, Markdown
<span class="hljs-keyword">import</span> copy
</code></pre>
<p>要使用 <strong>OpenAI</strong> 和 <strong>Pinecone</strong>，你需要 API Key。<br/>
如果你还没有注册，这两个平台的上手流程都很简单；<br/>
Pinecone 甚至提供带索引数量限制的免费计划，非常适合实验。</p>
<p>在这个 Notebook 里，我使用的是 <strong>Google Colab 的 Secrets Manager</strong> 来提供这些 Key；<br/>
如果你在本地跑，代码会退回到使用环境变量（environment variables）。<br/>
你可以根据自己的环境自由修改这一层。</p>
<p>在嵌入模型上，我使用的是 OpenAI 的 <code>text-embedding-3-small</code>：</p>
<ul>
<li>它会输出 1536 维的向量，</li>
<li>对我们的场景来说已经绰绰有余。</li>
</ul>
<p>你当然可以选择其它嵌入模型，但有一个关键原则：<br/>
<strong>用来创建向量的模型，必须与检索时使用的模型保持一致</strong>。</p>
<p>在完成 API Key 设置之后，我们会把这些细节写进配置变量：</p>
<pre><code class="hljs language-ini" lang="ini">import os
from openai import OpenAI
from google.colab import userdata

<span class="hljs-comment"># Load the API key from Colab secrets, set the env var, then init the client</span>
…
<span class="hljs-comment"># Configuration</span>
<span class="hljs-attr">EMBEDDING_MODEL</span> = <span class="hljs-string">"text-embedding-3-small"</span>
<span class="hljs-attr">EMBEDDING_DIM</span> = <span class="hljs-number">1536</span> <span class="hljs-comment"># Dimension for text-embedding-3-small</span>
<span class="hljs-attr">GENERATION_MODEL</span> = <span class="hljs-string">"gpt-5"</span>
</code></pre>
<blockquote>
<p>关于模型选择的小提示：<br/>
这里我们使用 GPT-5 是为了在本章和后续章节中保持连续性。<br/>
但整个引擎本身是“模型无关”的：<br/>
你可以把 <code>GENERATION_MODEL</code> 换成任何兼容的 LLM（例如 Mistral 或 Claude），<br/>
而架构的其它部分（提示词、注册表、Planner/Executor）都可以保持不变。</p>
</blockquote>
<p>如果一切配置无误，Notebook 会给出类似下面的提示：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">OpenAI API <span class="hljs-keyword">key</span> loaded <span class="hljs-built_in">and</span> environment variable <span class="hljs-keyword">set</span> successfully.
</code></pre>
<p>到这里，我们就可以继续前进，初始化 Pinecone 的索引了。</p>
<h3 data-id="heading-5">初始化 Pinecone 索引</h3>
<p>Initializing the Pinecone index</p>
<p>现在环境已经准备好了，我们来用刚刚配置的 API Key 连接 <strong>OpenAI</strong> 和 <strong>Pinecone</strong>。<br/>
第一步是为 Pinecone 索引起一个名字，本章中我们用：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">INDEX_NAME</span> = <span class="hljs-string">'genai-mas-mcp-ch3'</span>
</code></pre>
<p>接着，获取 Pinecone 的 API Key。示例中依然使用 Colab 的 Secrets Manager：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    <span class="hljs-comment"># Standard way to access secrets securely in Google Colab</span>
    <span class="hljs-keyword">from</span> google.colab <span class="hljs-keyword">import</span> userdata
    PINECONE_API_KEY = userdata.get(<span class="hljs-string">'PINECONE_API_KEY'</span>)
…
</code></pre>
<p>拿到 API Key 后，我们要为本项目定义两个命名空间（namespace）：<br/>
它们会在 Pinecone 中将两类数据严格隔离：</p>
<ul>
<li><code>NAMESPACE_KNOWLEDGE</code>：存储事实（KnowledgeStore）</li>
<li><code>NAMESPACE_CONTEXT</code>：存储语义蓝图 / 指令（ContextLibrary）</li>
</ul>
<p>我们使用的是 Pinecone 的 <strong>serverless 架构</strong>，<br/>
这也是 Pinecone 免费计划推荐的方式。<br/>
本示例中我使用 AWS 的 <code>us-east-1</code> 区域：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># --- Initialize Clients ---</span>
<span class="hljs-attr">client</span> = OpenAI(api_key=OPENAI_API_KEY)
<span class="hljs-attr">pc</span> = Pinecone(api_key=PINECONE_API_KEY)

<span class="hljs-comment"># --- Define Index and Namespaces ---</span>
<span class="hljs-attr">INDEX_NAME</span> = <span class="hljs-string">'genai-mas-mcp-ch3'</span>
<span class="hljs-attr">NAMESPACE_KNOWLEDGE</span> = <span class="hljs-string">"KnowledgeStore"</span>
<span class="hljs-attr">NAMESPACE_CONTEXT</span> = <span class="hljs-string">"ContextLibrary"</span>

<span class="hljs-comment"># Define Serverless Specification</span>
<span class="hljs-attr">spec</span> = ServerlessSpec(cloud=<span class="hljs-string">'aws'</span>, region=<span class="hljs-string">'us-east-1'</span>)
</code></pre>
<p>在使用索引之前，我们需要先检查它是否已经存在：<br/>
如果不存在，就用我们之前定义的维度（1536）创建一个新索引，并将度量方式设为 <strong>cosine 相似度</strong>——这是文本向量对比很常用的指标：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Check if index exists</span>
if INDEX_NAME not in pc.list_indexes().names():
    print(f"Index '{INDEX_NAME}' not found. Creating new serverless index...")
    pc.create_index(
        <span class="hljs-attr">name</span>=INDEX_NAME,
        <span class="hljs-attr">dimension</span>=EMBEDDING_DIM,
        <span class="hljs-attr">metric</span>=<span class="hljs-string">'cosine'</span>,
        <span class="hljs-attr">spec</span>=spec
    )
    <span class="hljs-comment"># Wait for index to be ready</span>
    while not pc.describe_index(INDEX_NAME).status<span class="hljs-section">['ready']</span>:
        print("Waiting for index to be ready...")
        time.sleep(1)
    print("Index created successfully. It is new and empty.")
</code></pre>
<p>如果索引已经存在，我们可以选择是否清空其中数据。<br/>
在本示例中，我们希望每次都从“干净环境”开始，因此会删除两个命名空间里的内容：</p>
<pre><code class="hljs language-ini" lang="ini">else:
    print(f"Index '{INDEX_NAME}' already exists. Clearing namespaces for a fresh start...")
    <span class="hljs-attr">index</span> = pc.Index(INDEX_NAME)
    <span class="hljs-attr">namespaces_to_clear</span> = [NAMESPACE_KNOWLEDGE, NAMESPACE_CONTEXT]
</code></pre>
<p>要清空索引，我们需要依次遍历每个命名空间并删除数据：</p>
<pre><code class="hljs language-ini" lang="ini">    for namespace in namespaces_to_clear:
        <span class="hljs-comment"># Check if namespace exists and has vectors before deleting</span>
        <span class="hljs-attr">stats</span> = index.describe_index_stats()
        if namespace in stats.namespaces \
        AND stats.namespaces<span class="hljs-section">[namespace]</span>.vector_count &gt; 0:
            print(f"Clearing namespace '{namespace}'...")
            index.delete(<span class="hljs-attr">delete_all</span>=<span class="hljs-literal">True</span>, namespace=namespace)
</code></pre>
<p>这里有一个“坑点”：<br/>
删除操作有可能是异步的，而程序可能继续运行得太快。<br/>
这意味着：如果删除比较慢，而我们的上传已经开始，新写入的向量有可能被“顺带”删掉——这虽然不是必然，但显然是我们不想承担的风险。</p>
<p>因此，我们强制系统<strong>等待，直到向量数量真正变成 0</strong> 才继续：</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-comment"># **CRITICAL FUNCTION: Wait for deletion to complete**</span>
            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
                stats = index.describe_index_stats()
                <span class="hljs-keyword">if</span> namespace <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> stats.namespaces <span class="hljs-keyword">or</span> \
                stats.namespaces[namespace].vector_count == <span class="hljs-number">0</span>:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Namespace '<span class="hljs-subst">{namespace}</span>' cleared successfully."</span>)
                    <span class="hljs-keyword">break</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Waiting for namespace '<span class="hljs-subst">{namespace}</span>' to clear..."</span>)
                time.sleep(<span class="hljs-number">5</span>) <span class="hljs-comment"># Poll every 5 seconds</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Namespace '<span class="hljs-subst">{namespace}</span>' is already empty or does not exist. Skipping."</span>)
</code></pre>
<p>最后，我们就可以正式连接到这个索引，供后续操作使用：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Connect to the index for subsequent operations</span>
<span class="hljs-attr">index</span> = pc.Index(INDEX_NAME)
</code></pre>
<p>如果一切顺利，你会看到类似这样的输出：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">Index <span class="hljs-comment">'genai-mas-mcp-ch3' already exists. Clearing namespaces for a fresh start...</span>
<span class="hljs-keyword">Namespace</span> <span class="hljs-comment">'KnowledgeStore' is already empty or does not exist. Skipping.</span>
<span class="hljs-keyword">Namespace</span> <span class="hljs-comment">'ContextLibrary' is already empty or does not exist. Skipping.</span>
</code></pre>
<p>在生产环境中，你通常不会希望<strong>每次运行都清空命名空间</strong>——<br/>
很多时候你希望系统<strong>保留已构建好的知识</strong>。</p>
<p>不过，在我们的学习过程中，每次从“空环境”开始会更加清晰、可控。<br/>
索引准备就绪之后，我们就可以进入下一步：<strong>准备并写入数据</strong>。</p>
<h3 data-id="heading-6">数据准备：上下文库（Context Library，过程型 RAG）</h3>
<p>在本小节中，我们要为<strong>上下文库（context library）<strong>定义数据。<br/>
这是整个</strong>过程型 RAG（procedural RAG）<strong>的核心，因为这里我们引入的不是静态知识，而是</strong>“如何做事”的程序性指令</strong>。<br/>
上下文库建立在第 1 章介绍的“语义蓝图（semantic blueprint）”概念之上，但这次我们会用一个更精确的结构来实现。</p>
<p>每条上下文库中的记录由三部分组成：</p>
<ol>
<li><strong>id</strong>：<br/>
在 Pinecone 索引中的唯一标识符；</li>
<li><strong>description（描述）</strong> ：<br/>
用来说明这个蓝图的用途与风格。<br/>
我们只对 <em>description</em> 做向量化，以便在检索时找到需要的蓝图。<br/>
你可以把它想象成“图书馆的卡片”，而不是书本本身。</li>
<li><strong>blueprint（蓝图）</strong> ：<br/>
真正给 LLM 用的指令内容，以 <strong>JSON</strong> 格式存储。<br/>
蓝图本身不会被 embed；当我们通过 description 找到目标后，就像根据书目去书架取书一样，读取完整 JSON 蓝图。</li>
</ol>
<p>在运行时，这么工作：</p>
<ul>
<li>当 Orchestrator 需要某种特定风格时，</li>
<li>Librarian（馆员智能体）会根据需求检索最匹配的 <strong>description</strong>，</li>
<li>找到后，再把对应的完整 JSON 语义蓝图取出来。</li>
</ul>
<p>这种设计非常<strong>可扩展</strong>：<br/>
你可以在向量库里不断新增新的 LLM 任务蓝图，而<strong>无需重写智能体逻辑</strong>。</p>
<p>下面我们先定义三个示例蓝图：</p>
<ol>
<li>用于写悬疑叙事（creative writing，悬疑故事）</li>
<li>用于技术讲解（technical explanation，强调事实与精确性）</li>
<li>用于轻松口吻的总结（casual summary，常见 LLM 用例）</li>
</ol>
<p>定义语义蓝图本身就是一种关键的<strong>上下文工程技能</strong>。<br/>
LLM 不是读心术，它需要<strong>精心编写的指令</strong>。<br/>
即便你借助 copilots 或 API 来自动生成这些蓝图描述，你仍然必须人工审核其质量。</p>
<p>来看第一个例子 —— <strong>悬疑叙事蓝图</strong>。<br/>
这个蓝图是为“讲故事”设计的，目标是营造紧张氛围，让读者一直“紧绷着神经”：</p>
<pre><code class="hljs language-css" lang="css">context_blueprints = <span class="hljs-selector-attr">[    {        <span class="hljs-string">"id"</span>: <span class="hljs-string">"blueprint_suspense_narrative"</span>,        <span class="hljs-string">"description"</span>: <span class="hljs-string">"A precise Semantic Blueprint designed to generate suspenseful and tense narratives, suitable for children's stories. Focuses on atmosphere, perceived threats, and emotional impact. Ideal for creative writing."</span>,        <span class="hljs-string">"blueprint"</span>: json.dumps({              <span class="hljs-string">"scene_goal"</span>: <span class="hljs-string">"Increase tension and create suspense."</span>,              <span class="hljs-string">"style_guide"</span>: <span class="hljs-string">"Use short, sharp sentences. Focus on sensory details (sounds, shadows). Maintain a slightly eerie but age-appropriate tone."</span>,              <span class="hljs-string">"participants"</span>: [                { <span class="hljs-string">"role"</span>: <span class="hljs-string">"Agent"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"The protagonist experiencing the events."</span> },                { <span class="hljs-string">"role"</span>: <span class="hljs-string">"Source_of_Threat"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"The underlying danger or mystery."</span> }              ]</span>,
            "instruction": <span class="hljs-string">"Rewrite the provided facts into a narrative adhering strictly to the scene_goal and style_guide."</span>
            })
    },
</code></pre>
<p>可以看到，这里的措辞要非常具体。<br/>
写“儿童向的悬疑故事”和写“技术说明文”完全不是一回事，蓝图必须体现这种差异。</p>
<p>下面是第二个蓝图 —— <strong>技术说明蓝图</strong>。<br/>
它和上面的叙事蓝图几乎是反过来的：不用氛围和情绪，而是强调清晰、结构、客观性：</p>
<pre><code class="hljs language-css" lang="css">    {
        "id": <span class="hljs-string">"blueprint_technical_explanation"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"A Semantic Blueprint designed for technical explanation or analysis. This blueprint focuses on clarity, objectivity, and structure. Ideal for breaking down complex processes, explaining mechanisms, or summarizing scientific findings."</span>,
        <span class="hljs-string">"blueprint"</span>: json.<span class="hljs-built_in">dumps</span>({
              "scene_goal": <span class="hljs-string">"Explain the mechanism or findings clearly and concisely."</span>,
              <span class="hljs-string">"style_guide"</span>: <span class="hljs-string">"Maintain an objective and formal tone. Use precise terminology. Prioritize factual accuracy and clarity over narrative flair."</span>,
              <span class="hljs-string">"structure"</span>: [<span class="hljs-string">"Definition"</span>, <span class="hljs-string">"Function/Operation"</span>, <span class="hljs-string">"Key Findings/Impact"</span>],
              <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"Organize the provided facts into the defined structure, adhering to the style_guide."</span>
            })
    },
</code></pre>
<p>这种格式正是你在技术或科学场景中需要的那种<strong>可预测结构</strong>。</p>
<p>最后是第三个蓝图 —— <strong>轻松总结（casual summary）</strong> ，<br/>
这种风格很适合做快速浏览的说明文或“小白向解释”：</p>
<pre><code class="hljs language-css" lang="css">    {
        "id": <span class="hljs-string">"blueprint_casual_summary"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"A goal-oriented context for creating a casual, easy-to-read summary. Focuses on brevity and accessibility, explaining concepts simply."</span>,
        <span class="hljs-string">"blueprint"</span>: json.<span class="hljs-built_in">dumps</span>({
              "scene_goal": <span class="hljs-string">"Summarize information quickly and casually."</span>,
              <span class="hljs-string">"style_guide"</span>: <span class="hljs-string">"Use informal language. Keep it brief and engaging. Imagine explaining it to a friend."</span>,
              <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"Summarize the provided facts using the casual style guide."</span>
            })
    }
]
</code></pre>
<p>在这种场景下，我们不需要太多角色或严格结构，<br/>
而是通过 <code>style_guide</code> 把 LLM 推向：</p>
<ul>
<li>简短、</li>
<li>口语化、</li>
<li>更亲切易懂的语气，好像你在给同事或朋友解释一个概念。</li>
</ul>
<p>为了确认蓝图格式是否正确，我们可以打印一下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">f"\nPrepared <span class="hljs-subst">{<span class="hljs-built_in">len</span>(context_blueprints)}</span> context blueprints."</span>)
</code></pre>
<p>输出表明我们一共定义了三个蓝图：</p>
<pre><code class="hljs language-erlang" lang="erlang">Prepared <span class="hljs-number">3</span> context blueprints.
</code></pre>
<p>这里需要记住的要点是：<strong>创建语义蓝图既强大，也很“烧脑”</strong> 。</p>
<ul>
<li>没有这些蓝图，你可能要为每一种 LLM 任务写一个独立的智能体 —— 这根本不可扩展。</li>
<li>有了语义蓝图，你可以将“过程性指令”一次编码，多处复用。</li>
</ul>
<p>与其在产品界面里不断增加几十个下拉选项，不如构建一个可扩展的自动化<strong>上下文引擎</strong>来调配这些蓝图。</p>
<p>蓝图这边搞定了，接下来就轮到双 RAG 中的另一半：<strong>知识库（Knowledge Base）</strong> 。</p>
<h3 data-id="heading-7">数据准备：知识库（Knowledge Base，事实型 RAG）</h3>
<p>接下来，我们要为**知识库（knowledge base）**准备数据 —— 这是 RAG 架构中“事实侧”的部分。<br/>
它存放相对静态的信息，Researcher 智能体会在其中检索，并把结果综合成简明的“研究结论”。</p>
<p>顺便强调一下现实情况：<br/>
你设计的是<strong>系统本身</strong>，而不是 LLM。<br/>
在那些看起来很酷的平台背后，实际上有大量需要人类细致设计与准备的工作。</p>
<p>在这个教学示例里，我们使用一个关于<strong>太空探索</strong>的小型数据集，包括：</p>
<ul>
<li>太空竞赛与阿波罗 11 号任务；</li>
<li>Juno 木星探测器；</li>
<li>火星探测车等内容。</li>
</ul>
<p>为了让重点落在“架构”上，本章里我们直接用字符串来表示这份数据：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">knowledge_data_raw</span> = <span class="hljs-string">"""
Space exploration is the use of astronomy and space technology to explore outer space. The early era of space exploration was driven by a "Space Race" between the Soviet Union and the United States. The launch of the Soviet Union's Sputnik 1 in 1957, and the first Moon landing by the American Apollo 11 mission in 1969 are key landmarks.
…
Juno is a NASA space probe orbiting the planet Jupiter. It was launched on August 5, 2011, and entered a polar orbit of Jupiter on July 5, 2016.
…
A Mars rover is a remote-controlled motor vehicle designed to travel on the surface of Mars. NASA JPL managed several successful rovers including: Sojourner, Spirit, Opportunity, Curiosity, and Perseverance. The search for evidence of habitability and organic carbon on Mars is now a primary NASA objective. Perseverance also carried the Ingenuity helicopter.
"""</span>
</code></pre>
<p>接下来，我们会写一个小小的辅助函数，把这段文本切分成更适合检索的片段（chunks），再进行向量化。</p>
<h4 data-id="heading-8">分块与向量化的辅助函数</h4>
<p>语言模型并不是直接处理“段落”，而是处理<strong>token</strong> —— 也就是模型能理解的最小文本单元。<br/>
例如，单词 <code>encoding</code> 可能会被拆成两个 token：<code>encod</code> 和 <code>ing</code>。<br/>
模型通过这些更细粒度的 token 来理解词与词之间的关系。</p>
<p>我们会使用 <code>cl100k_base</code> 这个 tokenizer，这是 OpenAI 最新模型的标准配置。<br/>
它有三个优势：</p>
<ol>
<li><strong>更聪明的分词方式</strong>：<br/>
像 <code>encoding</code> 这样的词不会被当作一个整体，而是拆成 <code>encod</code> 和 <code>ing</code> 等有意义的片段，<br/>
有助于模型更好地理解不同词语之间的联系。</li>
<li><strong>高效且适配对话/检索场景</strong>：<br/>
对于聊天模型和要存入数据库的文本，它都非常高效。</li>
<li><strong>与模型训练方式保持一致</strong>：<br/>
你统计和格式化文本的方式与模型的预期一致，<br/>
也就能最大化检索的准确性。</li>
</ol>
<p>这点非常关键：<br/>
如果我们的“分块逻辑”和嵌入模型的训练方式不匹配，<br/>
语义检索的结果就会走样——就像你在一个图书馆里查书，但卡片和书架用的是两套完全不同的编目系统。</p>
<p>先初始化 tokenizer：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Initialize tokenizer for robust, token-aware chunking</span>
<span class="hljs-attr">tokenizer</span> = tiktoken.get_encoding(<span class="hljs-string">"cl100k_base"</span>)
</code></pre>
<p>RAG 在信息被**切分成聚焦的小块（chunks）**时效果最好。<br/>
相比按字符数截断，我们会按 <strong>token 数量</strong> 截断，更适合 LLM。</p>
<p>在示例程序中，我们设定：</p>
<ul>
<li><code>chunk_size = 400</code> tokens</li>
<li><code>overlap = 50</code> tokens</li>
</ul>
<p>**重叠（overlap）**可以帮助相邻块之间保持上下文连续性。<br/>
实际项目中，你需要根据数据类型来调节 chunk 大小与重叠大小。</p>
<p>下面的 <code>chunk_text</code> 函数就负责：</p>
<ul>
<li>按 token 数量将长文本切成一个个重叠窗口，</li>
<li>再将这些窗口还原成文本，供后续向量化使用：</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">chunk_text</span>(<span class="hljs-params">text, chunk_size=<span class="hljs-number">400</span>, overlap=<span class="hljs-number">50</span></span>):
    <span class="hljs-string">"""Chunks text based on token count with overlap (Best practice for RAG)."""</span>
    tokens = tokenizer.encode(text)
    chunks = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(tokens), chunk_size - overlap):
        chunk_tokens = tokens[i:i + chunk_size]
        chunk_text = tokenizer.decode(chunk_tokens)
        <span class="hljs-comment"># Basic cleanup</span>
        chunk_text = chunk_text.replace(<span class="hljs-string">"\n"</span>, <span class="hljs-string">" "</span>).strip()
        <span class="hljs-keyword">if</span> chunk_text:
            chunks.append(chunk_text)
    <span class="hljs-keyword">return</span> chunks
</code></pre>
<p>有了这些 chunk 之后，我们就需要把它们转换成 embeddings。<br/>
由于 API 调用有时会失败（比如网络抖动），我们会加一个<strong>带重试机制的封装</strong>。</p>
<p><code>tenacity</code> 库提供的 <code>@retry</code> 装饰器可以自动重试失败的调用，并采用**指数退避（exponential backoff）**策略：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@retry(<span class="hljs-params">
    wait=wait_random_exponential(<span class="hljs-params"><span class="hljs-built_in">min</span>=<span class="hljs-number">1</span>, <span class="hljs-built_in">max</span>=<span class="hljs-number">60</span></span>),
    stop=stop_after_attempt(<span class="hljs-params"><span class="hljs-number">6</span></span>)
</span>)</span>
</code></pre>
<p>我们不会单条上传 chunk，而是按批成组发送，因此定义 <code>get_embeddings_batch</code> 函数：<br/>
它会将一批文本发送给 OpenAI 的 Embedding API，返回对应的向量：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@retry(<span class="hljs-params">
    wait=wait_random_exponential(<span class="hljs-params"><span class="hljs-built_in">min</span>=<span class="hljs-number">1</span>, <span class="hljs-built_in">max</span>=<span class="hljs-number">60</span></span>),
    stop=stop_after_attempt(<span class="hljs-params"><span class="hljs-number">6</span></span>)
</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_embeddings_batch</span>(<span class="hljs-params">texts, model=EMBEDDING_MODEL</span>):
    <span class="hljs-string">"""Generates embeddings for a batch of texts using OpenAI, with retries."""</span>
    <span class="hljs-comment"># OpenAI expects the input texts to have newlines replaced by spaces</span>
    texts = [t.replace(<span class="hljs-string">"\n"</span>, <span class="hljs-string">" "</span>) <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> texts]
    response = client.embeddings.create(<span class="hljs-built_in">input</span>=texts, model=model)
    <span class="hljs-keyword">return</span> [item.embedding <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> response.data]
</code></pre>
<p>现在，我们已经具备了：</p>
<ul>
<li><strong>按 token 切分文本</strong>的能力，</li>
<li><strong>稳定生成 embeddings</strong> 的能力（带自动重试）。</li>
</ul>
<p>下一步，就可以正式开始对“知识数据”和“上下文数据”进行处理，并把它们上传到向量库中了。</p>
<h3 data-id="heading-9">处理并上传（upsert）数据</h3>
<p>数据准备的最后一步，就是<strong>处理这些数据并把它们上传到 Pinecone</strong>。<br/>
这一步非常关键：只有当向量真正存进向量库后，智能体才能在运行时检索到它们。</p>
<p>我们分两部分来做：</p>
<ol>
<li><strong>上下文库（Context Library）</strong> ：上传语义蓝图（semantic blueprints）</li>
<li><strong>知识库（Knowledge Base）</strong> ：上传事实数据</li>
</ol>
<h4 data-id="heading-10">上下文库（Context Library）</h4>
<p>先从上下文库开始。<br/>
这里存放的是我们的<strong>语义蓝图</strong>，也就是指导系统“该如何写”的程序性指令。</p>
<p>程序会遍历前面定义好的 <code>context_blueprints</code> 列表：</p>
<ul>
<li>
<p>对每个 blueprint，用 <code>get_embeddings_batch</code> 对其 <strong>description</strong> 做向量化；</p>
<ul>
<li>后续做语义检索时，查的就是这个描述文本，所以只有它需要进入向量空间。</li>
</ul>
</li>
<li>
<p>同时构建 Pinecone 的向量对象：</p>
<ul>
<li>
<p><code>id</code>：唯一标识符；</p>
</li>
<li>
<p><code>values</code>：embedding 向量；</p>
</li>
<li>
<p><code>metadata</code>：包含两类信息：</p>
<ul>
<li>再存一份 <code>description</code> 以便人类查看；</li>
<li>最关键的是 <code>blueprint_json</code>，即完整的 JSON 语义蓝图指令。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>注意：<strong>JSON 蓝图本身不做向量化</strong>，而是作为 metadata 存储。<br/>
当我们通过 description 找到这个 vector 时，就能顺带把完整蓝图取出来使用。</p>
<p>代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># --- 6.1. Context Library ---</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\nProcessing and uploading Context Library to namespace: <span class="hljs-subst">{NAMESPACE_CONTEXT}</span>"</span>)
vectors_context = []
<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> tqdm(context_blueprints):
    <span class="hljs-comment"># We embed the DESCRIPTION (the intent)</span>
    embedding = get_embeddings_batch([item[<span class="hljs-string">'description'</span>]])[<span class="hljs-number">0</span>]
    vectors_context.append({
        <span class="hljs-string">"id"</span>: item[<span class="hljs-string">'id'</span>],
        <span class="hljs-string">"values"</span>: embedding,
        <span class="hljs-string">"metadata"</span>: {
            <span class="hljs-string">"description"</span>: item[<span class="hljs-string">'description'</span>],
            <span class="hljs-comment"># The blueprint itself (JSON string) is stored as metadata</span>
            <span class="hljs-string">"blueprint_json"</span>: item[<span class="hljs-string">'blueprint'</span>]
        }
    })
</code></pre>
<p>当所有向量准备好之后，我们就可以把它们<strong>upsert</strong> 到 Pinecone 里。</p>
<blockquote>
<p>upsert = 如果 ID 已存在则更新，否则插入新数据。</p>
</blockquote>
<p>我们将这些向量上传到 <code>NAMESPACE_CONTEXT</code> 对应的 namespace 中：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Upsert data</span>
<span class="hljs-keyword">if</span> vectors_context:
    index.upsert(vectors=vectors_context, namespace=NAMESPACE_CONTEXT)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Successfully uploaded <span class="hljs-subst">{<span class="hljs-built_in">len</span>(vectors_context)}</span> context vectors."</span>)
</code></pre>
<p>如果运行成功，你会看到一条确认信息，说明上传了多少条向量。<br/>
到这一步为止，<strong>上下文库已经写入 ContextLibrary 命名空间</strong>，运行时 Librarian 智能体就可以开始查询它了。</p>
<p>接下来我们处理双 RAG 的另一半：<strong>知识库</strong>。</p>
<h4 data-id="heading-11">知识库（Knowledge Base）</h4>
<p>现在来填充知识库 —— 这里存放事实数据，供 Researcher 智能体检索。</p>
<p>第一步是对原始知识字符串 <code>knowledge_data_raw</code> 调用 <code>chunk_text</code>，<br/>
把它切成更小、易于检索的片段（chunks）。</p>
<p>然后我们按批次处理这些 chunks。<br/>
示例中使用的批大小是 100：</p>
<ul>
<li>
<p>逐批生成 embeddings（<code>get_embeddings_batch</code>）；</p>
</li>
<li>
<p>为 Pinecone 准备向量结构：</p>
<ul>
<li>每个 chunk 分配一个唯一的 <code>id</code>；</li>
<li><code>metadata</code> 中存储原始文本 <code>text</code>，便于检索时返回。</li>
</ul>
</li>
</ul>
<p>代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># --- 6.2. Knowledge Base ---</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\nProcessing and uploading Knowledge Base to namespace: <span class="hljs-subst">{NAMESPACE_KNOWLEDGE}</span>"</span>)
<span class="hljs-comment"># Chunk the knowledge data</span>
knowledge_chunks = chunk_text(knowledge_data_raw)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Created <span class="hljs-subst">{<span class="hljs-built_in">len</span>(knowledge_chunks)}</span> knowledge chunks."</span>)
vectors_knowledge = []
batch_size = <span class="hljs-number">100</span> <span class="hljs-comment"># Process in batches</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(knowledge_chunks), batch_size)):
    batch_texts = knowledge_chunks[i:i+batch_size]
    batch_embeddings = get_embeddings_batch(batch_texts)

    batch_vectors = []
    <span class="hljs-keyword">for</span> j, embedding <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(batch_embeddings):
        chunk_id = <span class="hljs-string">f"knowledge_chunk_<span class="hljs-subst">{i+j}</span>"</span>
        batch_vectors.append({
            <span class="hljs-string">"id"</span>: chunk_id,
            <span class="hljs-string">"values"</span>: embedding,
            <span class="hljs-string">"metadata"</span>: {
                <span class="hljs-string">"text"</span>: batch_texts[j]
            }
        })
    <span class="hljs-comment"># Upsert the batch</span>
    index.upsert(vectors=batch_vectors, namespace=NAMESPACE_KNOWLEDGE)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Successfully uploaded <span class="hljs-subst">{<span class="hljs-built_in">len</span>(knowledge_chunks)}</span> knowledge vectors."</span>)
</code></pre>
<p>运行后，输出会同时展示上下文库与知识库的上传进度：</p>
<ul>
<li>
<p><code>tqdm</code> 进度条会实时显示每一步嵌入的情况；</p>
</li>
<li>
<p>在这个示例中：</p>
<ul>
<li>
<p>上下文库确认成功上传了 3 条蓝图向量；</p>
</li>
<li>
<p>知识库数据很小，被切成 2 个 chunk；</p>
<ul>
<li>它们都落在了同一批（batch）100 条的范围内；</li>
</ul>
</li>
<li>
<p>最终输出确认这 2 个向量也都成功写入：</p>
</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-vbnet" lang="vbnet">Processing <span class="hljs-built_in">and</span> uploading Context Library <span class="hljs-keyword">to</span> <span class="hljs-keyword">namespace</span>: ContextLibrary
[Tqdm output <span class="hljs-keyword">for</span> <span class="hljs-number">3</span>/<span class="hljs-number">3</span> iterations]
Successfully uploaded <span class="hljs-number">3</span> context vectors.
Processing <span class="hljs-built_in">and</span> uploading Knowledge Base <span class="hljs-keyword">to</span> <span class="hljs-keyword">namespace</span>: KnowledgeStore
Created <span class="hljs-number">2</span> knowledge chunks.
[Tqdm output <span class="hljs-keyword">for</span> <span class="hljs-number">1</span>/<span class="hljs-number">1</span> iterations]
Successfully uploaded <span class="hljs-number">2</span> knowledge vectors.
</code></pre>
<p>至此：</p>
<ul>
<li><strong>上下文库（ContextLibrary）</strong> 和</li>
<li><strong>知识库（KnowledgeStore）</strong></li>
</ul>
<p>都已经成功写入向量存储。</p>
<p>接下来，我们就可以在运行时构建真正的<strong>上下文感知多智能体系统</strong>（context-aware MAS），<br/>
让智能体一边查事实，一边查“写作蓝图”，再把两者在生成阶段组合起来。</p>
<h3 data-id="heading-12">构建上下文感知系统</h3>
<p>现在我们的数据已经 idx_4273754a 准备好并存入了 Pinecone，是时候把所有东西组合起来了。本节我们将实现图 3.3 展示的<strong>上下文感知系统（context-aware system）</strong> 。具体步骤在 <code>Context_Aware_MAS.ipynb</code> 笔记本中，对应的是整套架构的<strong>运行时执行阶段</strong>。我们会先定义负责核心任务的专业智能体，然后再看 Orchestrator 是如何协调整个流程的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57404632b2ae45b596e225130c098884~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5pm66IO96ICB5Y-45py6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172772&amp;x-signature=w0Ao0eRpiNGOopemU4GPtQZHyYY%3D" alt="image.png" loading="lazy"/></p>
<p>图 3.3：上下文感知 MAS 流程图</p>
<p>这张流程图展示了一个高层用户目标如何被转化为结构化的工作流。它很好地提醒我们：生成式 AI 并不是“开箱即用就 magically 工作”。<strong>谨慎的工程设计和上下文管理</strong>才是系统可靠运行的关键。</p>
<p>在图中，蓝色方块代表 Orchestrator（编排器），它作为中央协调者，把任务分派给若干<strong>专业智能体（绿色方块）</strong> ：Librarian、Researcher 和 Writer。这些智能体会与外部服务（橙色方块）交互，例如 Pinecone（用于知识和蓝图检索）以及 LLM（用于向量化、分析与生成）。</p>
<p>有了这个全局图，我们就可以深入细节，从智能体本身开始。</p>
<h4 data-id="heading-13">定义智能体</h4>
<p>整个 MAS 依赖三个 idx_82f9cb5d 专门的智能体，每个智能体都有明确的职责：</p>
<ul>
<li><strong>Context Librarian（上下文馆员）</strong> ：从上下文库中检索 idx_71e1c2b3 过程性 idx_0bbfccaf 指令</li>
<li><strong>Researcher（研究员）</strong> ：从知识库中抽取 idx_4f52270a 并综合 idx_6e261e5c 事实数据</li>
<li><strong>Writer（写作者）</strong> ：将 idx_3873fac6 过程性指令 idx_8039414a 与事实数据结合，生成最终输出</li>
</ul>
<p>所有智能体都通过 MCP 进行通信。我们先从 Librarian 智能体开始。</p>
<h5 data-id="heading-14">Context Librarian 智能体</h5>
<p>Context idx_975aad91 Librarian 的职责是从向量库中检索正确的<strong>语义蓝图（Semantic Blueprint）</strong> 。<br/>
这是一种更高级的 RAG 用法：检索的不是“事实”，而是**“写作方式”** —— 也就是过程性指令：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">agent_context_librarian</span>(<span class="hljs-params">mcp_message</span>):
    <span class="hljs-string">"""
    Retrieves the appropriate Semantic Blueprint from the Context Library.
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n[Librarian] Activated. Analyzing intent..."</span>)
    requested_intent = mcp_message[<span class="hljs-string">'content'</span>][<span class="hljs-string">'intent_query'</span>]
    results = query_pinecone(requested_intent, NAMESPACE_CONTEXT, top_k=<span class="hljs-number">1</span>)

    <span class="hljs-keyword">if</span> results:
        <span class="hljs-keyword">match</span> = results[<span class="hljs-number">0</span>]
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[Librarian] Found blueprint '<span class="hljs-subst">{<span class="hljs-keyword">match</span>[<span class="hljs-string">'id'</span>]}</span>' (Score: <span class="hljs-subst">{<span class="hljs-keyword">match</span>[<span class="hljs-string">'score'</span>]:<span class="hljs-number">.2</span>f}</span>)"</span>)
        blueprint_json = <span class="hljs-keyword">match</span>[<span class="hljs-string">'metadata'</span>][<span class="hljs-string">'blueprint_json'</span>]
        content = {<span class="hljs-string">"blueprint"</span>: blueprint_json}
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"[Librarian] No specific blueprint found. Returning default."</span>)
        content = {<span class="hljs-string">"blueprint"</span>: json.dumps({<span class="hljs-string">"instruction"</span>: <span class="hljs-string">"Generate the content neutrally."</span>})}

    <span class="hljs-keyword">return</span> create_mcp_message(<span class="hljs-string">"Librarian"</span>, content)
</code></pre>
<p>这里发生的事情是：</p>
<ul>
<li>Librarian 使用用户的意图 <code>intent_query</code>，在 <code>ContextLibrary</code> 命名空间里做语义检索；</li>
<li>找到匹配的 blueprint 后，从 metadata 中取出 JSON 格式的指令；</li>
<li>再把这些指令封装到一个新的 MCP 消息中返回。</li>
</ul>
<p>这样，Writer 智能体就能根据<strong>动态检索到的程序性指南</strong>来写作。</p>
<p>代码中还包含了一个重要的<strong>兜底机制</strong>：<br/>
如果 Librarian 没找到任何匹配的语义蓝图，它就不会直接报错，而是返回一个<strong>默认蓝图</strong>：</p>
<blockquote>
<p><code>{"instruction": "Generate the content neutrally."}</code></p>
</blockquote>
<p>也就是说，如果用户的意图与现有蓝图都不匹配，系统不会停摆，而是退回到“中性生成”的简单策略。<br/>
这样 Writer 依然能拿到一套过程性指导，哪怕只是“中性写作”，系统也能继续完成任务，而不是 idx_3aa5ac30 整个流程中断。</p>
<h5 data-id="heading-15">Researcher 智能体</h5>
<p>Researcher 智能体 idx_5affbcf7 专注于从知识库中抽取 idx_2c1b5574 相关事实，并把这些信息综合成简明的摘要，方便 Writer 直接使用：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">agent_researcher</span>(<span class="hljs-params">mcp_message</span>):
    <span class="hljs-string">"""
    Retrieves and synthesizes factual information from the Knowledge Base.
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n[Researcher] Activated. Investigating topic..."</span>)
    topic = mcp_message[<span class="hljs-string">'content'</span>][<span class="hljs-string">'topic_query'</span>]

    results = query_pinecone(topic, NAMESPACE_KNOWLEDGE, top_k=<span class="hljs-number">3</span>)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> results:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"[Researcher] No relevant information found."</span>)
        <span class="hljs-keyword">return</span> create_mcp_message(<span class="hljs-string">"Researcher"</span>, {<span class="hljs-string">"facts"</span>: <span class="hljs-string">"No data found."</span>})

    source_texts = [<span class="hljs-keyword">match</span>[<span class="hljs-string">'metadata'</span>][<span class="hljs-string">'text'</span>] <span class="hljs-keyword">for</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">in</span> results]
    system_prompt = <span class="hljs-string">"""You are an expert research synthesis AI. Synthesize the provided source texts into a concise, bullet-pointed summary relevant to the user's topic. Focus strictly on the facts provided in the sources. Do not add outside information."""</span>
    user_prompt = <span class="hljs-string">f"Topic: <span class="hljs-subst">{topic}</span>\n\nSources:\n"</span> + <span class="hljs-string">"\n\n---\n\n"</span>.join(source_texts)

    findings = call_llm(system_prompt, user_prompt)

    <span class="hljs-keyword">return</span> create_mcp_message(<span class="hljs-string">"Researcher"</span>, {<span class="hljs-string">"facts"</span>: findings})
</code></pre>
<p>在这里，Researcher 保持输出<strong>简洁且事实导向</strong>：</p>
<ul>
<li>
<p>只关心从知识库中召回的文本；</p>
</li>
<li>
<p>系统提示（system_prompt）明确要求：</p>
<ul>
<li><strong>严格基于给定来源</strong>；</li>
<li><strong>不得添加外部信息</strong>；</li>
</ul>
</li>
</ul>
<p>即使在更大的系统中，这种受控的“事实摘要”步骤也很关键，它可以避免 Writer 被一大堆原始文本淹没。</p>
<p>接下来，我们还需要一个 Writer 智能体来真正写出内容。</p>
<h5 data-id="heading-16">Writer 智能体</h5>
<p>Writer 智能体是两个信息流的汇合点：<br/>
它把<strong>语义蓝图（过程性指令）<strong>和</strong>事实摘要</strong>结合起来，生成最终结构化的输出：</p>
<pre><code class="hljs language-ini" lang="ini">def agent_writer(mcp_message):
    """
    Combines factual research with the semantic blueprint to generate final output.
    """
    print("\n<span class="hljs-section">[Writer]</span> Activated. Applying blueprint to facts...")

    <span class="hljs-attr">facts</span> = mcp_message[<span class="hljs-string">'content'</span>][<span class="hljs-string">'facts'</span>]
    <span class="hljs-attr">blueprint_json_string</span> = mcp_message[<span class="hljs-string">'content'</span>][<span class="hljs-string">'blueprint'</span>]
    <span class="hljs-comment"># The Writer's System Prompt incorporates the dynamically retrieved blueprint</span>
    <span class="hljs-attr">system_prompt</span> = f<span class="hljs-string">"""You are an expert content generation AI.
Your task is to generate content based on the provided RESEARCH FINDINGS.
Crucially, you MUST structure, style, and constrain your output according to the rules defined in the SEMANTIC BLUEPRINT provided below.

    --- SEMANTIC BLUEPRINT (JSON) ---
    {blueprint_json_string}
    --- END SEMANTIC BLUEPRINT ---

Adhere strictly to the blueprint's instructions, style guides, and goals. The blueprint defines HOW you write; the research defines WHAT you write about.
    """</span>

    <span class="hljs-attr">user_prompt</span> = f<span class="hljs-string">"--- RESEARCH FINDINGS ---\n{facts}\n--- END RESEARCH FINDINGS ---\nGenerate the content now."</span>
    <span class="hljs-attr">final_output</span> = call_llm(system_prompt, user_prompt)

    return create_mcp_message("Writer", {"output": final_output})
</code></pre>
<p>这个智能体的关键点在于，它通过 blueprint 对 LLM 进行<strong>动态“编程”</strong> ：</p>
<ul>
<li>blueprint 规定“<strong>怎么写（HOW）</strong> ”；</li>
<li>facts 决定“<strong>写什么（WHAT）</strong> ”。</li>
</ul>
<p>系统提示里刻意画了一条清晰的界线：</p>
<blockquote>
<p>“The blueprint defines HOW you write; the research defines WHAT you write about.”</p>
</blockquote>
<p>正是这种“职责分离” idx_3b44a307 让整个系统具有很强的可适配性和可扩展性 idx_ab0e706d ——<br/>
你可以更新知识库而不改写作风格蓝图，也可以新增蓝图而不动事实存储。</p>
<p>接下来，我们要构建把这一切串起来的 Orchestrator。</p>
<h4 data-id="heading-17">构建 Orchestrator（编排器）</h4>
<p>Orchestrator（编排器）是整个系统的“指挥家”。它的职责是：接收一个高层目标，把它拆解成可执行的查询，然后协调各个智能体，最终生成结果。你可以把它想象成一个项目经理：自己不干具体活儿，但要确保每个人都在正确的节奏上协同工作。</p>
<h5 data-id="heading-18">目标分析（Goal analysis）</h5>
<p>Orchestrator 首先会把用户的高层目标拆解成两个部分：</p>
<ul>
<li><strong>intent_query</strong>：想要的风格、语气或格式（例如“悬疑叙事蓝图”“客观技术解释结构”）</li>
<li><strong>topic_query</strong>：要处理的事实主题（例如“朱诺号任务目标与供电方式”“阿波罗 11 号登月细节”）</li>
</ul>
<p>代码大致如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">orchestrator</span>(<span class="hljs-params">high_level_goal</span>):
    <span class="hljs-string">"""
    Manages the workflow of the Context-Aware MAS.
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"=== [Orchestrator] Starting New Task ==="</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Goal: <span class="hljs-subst">{high_level_goal}</span>"</span>)

    <span class="hljs-comment"># Step 0: Analyze Goal (Determine Intent and Topic)</span>
    <span class="hljs-comment"># We use the LLM to separate the desired style (intent) from the subject matter (topic).</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n[Orchestrator] Analyzing Goal..."</span>)
    analysis_system_prompt = <span class="hljs-string">"""You are an expert goal analyst.    Analyze the user's high-level goal and extract two components:
    1. 'intent_query': A descriptive phrase summarizing the desired style, tone, or format, optimized for searching a context library (e.g., "suspenseful narrative blueprint", "objective technical explanation structure").
    2. 'topic_query': A concise phrase summarizing the factual subject matter required (e.g., "Juno mission objectives and power", "Apollo 11 landing details").

    Respond ONLY with a JSON object containing these two keys."""</span>

    <span class="hljs-comment"># We request JSON mode for reliable parsing</span>
    analysis_result = call_llm(
        analysis_system_prompt, high_level_goal, json_mode=<span class="hljs-literal">True</span>)
)

    <span class="hljs-keyword">try</span>:
        analysis = json.loads(analysis_result)
        intent_query = analysis[<span class="hljs-string">'intent_query'</span>]
        topic_query = analysis[<span class="hljs-string">'topic_query'</span>]
    <span class="hljs-keyword">except</span> (json.JSONDecodeError, KeyError):
        <span class="hljs-keyword">return</span>
</code></pre>
<p>在这里，Orchestrator 自己会调用一次 LLM，把这个高层目标解析成结构化 JSON。<br/>
如果解析失败，函数就直接 <code>return</code>，从而避免后面整条链路因为脏数据而崩掉。</p>
<p>这个 <code>try...except</code> 块实际上就是一个<strong>回退机制</strong>：<br/>
如果 LLM 返回的 JSON 无法解析或字段缺失，Orchestrator 会<strong>优雅终止</strong>，而不是把错误数据继续往下传。在生产环境中，你还可以用更严格的结构化提示或者模式校验（schema validation）来强化这一步，但对当前原型来说，这种轻量做法已经兼顾了<strong>韧性</strong>和<strong>可读性</strong>。</p>
<h5 data-id="heading-19">智能体协调（Agent coordination）</h5>
<p>一旦目标被拆解完成，Orchestrator 就开始协调各个智能体之间的信息流：</p>
<ul>
<li>把 <strong>intent_query</strong> 发给 Librarian（上下文馆员），用于检索语义蓝图；</li>
<li>把 <strong>topic_query</strong> 发给 Researcher（研究员），用于检索事实信息；</li>
<li>然后把两者结果一起交给 Writer（写作者）。</li>
</ul>
<h6 data-id="heading-20">1. 向 Librarian 请求上下文蓝图（Procedural RAG）</h6>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Step 1: Get the Context Blueprint (Procedural RAG)</span>
<span class="hljs-attr">mcp_to_librarian</span> = create_mcp_message(
    <span class="hljs-attr">sender</span>=<span class="hljs-string">"Orchestrator"</span>,
    <span class="hljs-attr">content</span>={<span class="hljs-string">"intent_query"</span>: intent_query}
)
<span class="hljs-comment"># display_mcp(mcp_to_librarian, "Orchestrator -&gt; Librarian")</span>
<span class="hljs-attr">mcp_from_librarian</span> = agent_context_librarian(mcp_to_librarian)
display_mcp(mcp_from_librarian, "Librarian -&gt; Orchestrator")

<span class="hljs-attr">context_blueprint</span> = mcp_from_librarian[<span class="hljs-string">'content'</span>].get(<span class="hljs-string">'blueprint'</span>)
if not context_blueprint: return
</code></pre>
<p>这里 Orchestrator 通过 MCP 消息，把 <code>intent_query</code> 发送给 Librarian；<br/>
返回后，从消息内容里拿到 <code>blueprint</code>（蓝图）。如果没拿到，就直接返回。</p>
<h6 data-id="heading-21">2. 向 Researcher 请求事实知识（Factual RAG）</h6>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Step 2: Get the Factual Knowledge (Factual RAG)</span>
<span class="hljs-attr">mcp_to_researcher</span> = create_mcp_message(
    <span class="hljs-attr">sender</span>=<span class="hljs-string">"Orchestrator"</span>,
    <span class="hljs-attr">content</span>={<span class="hljs-string">"topic_query"</span>: topic_query}
)
<span class="hljs-comment"># display_mcp(mcp_to_researcher, "Orchestrator -&gt; Researcher")</span>
<span class="hljs-attr">mcp_from_researcher</span> = agent_researcher(mcp_to_researcher)
display_mcp(mcp_from_researcher, "Researcher -&gt; Orchestrator")

<span class="hljs-attr">research_findings</span> = mcp_from_researcher[<span class="hljs-string">'content'</span>].get(<span class="hljs-string">'facts'</span>)
if not research_findings: return
</code></pre>
<p>这一步 Orchestrator 让 Researcher 从知识库中检索与 <code>topic_query</code> 相关的事实，并综合成一个简明摘要 <code>facts</code>。如果没有结果，同样直接退出。</p>
<h6 data-id="heading-22">3. 交给 Writer 生成最终内容</h6>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Step 3: Generate the Final Output</span>
<span class="hljs-comment"># Combine the outputs for the Writer Agent</span>
<span class="hljs-attr">writer_task</span> = {
    "blueprint": context_blueprint,
    "facts": research_findings
}

<span class="hljs-attr">mcp_to_writer</span> = create_mcp_message(
    <span class="hljs-attr">sender</span>=<span class="hljs-string">"Orchestrator"</span>,
    <span class="hljs-attr">content</span>=writer_task
)
<span class="hljs-comment"># display_mcp(mcp_to_writer, "Orchestrator -&gt; Writer")</span>
<span class="hljs-attr">mcp_from_writer</span> = agent_writer(mcp_to_writer)
display_mcp(mcp_from_writer, "Writer -&gt; Orchestrator")

<span class="hljs-attr">final_result</span> = mcp_from_writer[<span class="hljs-string">'content'</span>].get(<span class="hljs-string">'output'</span>)

print("\<span class="hljs-attr">n</span>=== [Orchestrator] Task Complete ===<span class="hljs-string">")
return final_result
</span></code></pre>
<p>这一模式让各自的职责极其清晰：</p>
<ul>
<li><strong>Librarian</strong> 只负责取“怎么写”的过程指导（程序性上下文）；</li>
<li><strong>Researcher</strong> 只负责取“写什么”的事实内容；</li>
<li><strong>Writer</strong> 把“怎么写”和“写什么”组合起来，生成最终文本。</li>
</ul>
<p>同时，这个架构之所以稳健，是因为它既<strong>模块化</strong>又<strong>可扩展</strong>：</p>
<ul>
<li>每个智能体只做一件事（Single Responsibility）；</li>
<li>系统严格按照你提供的过程性指令（语义蓝图）来执行；</li>
<li>Orchestrator 像一个优秀的项目经理：只管拆任务和派任务，而不参与具体实现，把细节交给各个专家智能体。</li>
</ul>
<p>真正的杀手锏在于——<strong>把 “what（内容）” 和 “how（表现形式）” 彻底分离</strong>：</p>
<ul>
<li>事实检索（知识库）与风格/过程指令（上下文库）完全独立；</li>
<li>这样你可以只更新知识库，而不用动任何风格规则；</li>
<li>或者只新增/调整蓝图，而不用动事实数据。</li>
</ul>
<p>这让迭代速度非常快，也让系统变得极灵活：<br/>
只要更换语义蓝图，就能在同一批事实的基础上，瞬间换一种风格、结构或语气来生成内容。</p>
<p>最终，这不仅仅是一个“教学示例”，而是一套<strong>可落地的工程蓝图</strong>，用于构建真正能处理复杂、上下文敏感任务的多智能体系统（MAS）。</p>
<h2 data-id="heading-23">小结（Summary）</h2>
<p>本章我们从第 2 章的 MAS 继续演化，核心升级是引入了<strong>双重 RAG 架构（dual RAG）</strong> 。</p>
<ul>
<li>
<p>在同一个 Pinecone 索引中，我们创建了两个完全独立的数据库：</p>
<ul>
<li><strong>Knowledge Base（知识库）</strong> ：为 Researcher 智能体存储事实信息；</li>
<li><strong>Context Library（上下文库）</strong> ：为新引入的 Context Librarian 智能体存储过程性语义蓝图。</li>
</ul>
</li>
</ul>
<p>这种分离让系统可以<strong>独立管理“知道什么”和“如何行动”</strong> 。</p>
<p>实现上分为两大部分：</p>
<ol>
<li>
<p><strong>数据准备阶段（第一个 notebook）</strong></p>
<ul>
<li>预处理并上传数据到两个 Pinecone 命名空间；</li>
<li>一个用于知识向量（知识库），一个用于蓝图向量（上下文库）。</li>
</ul>
</li>
<li>
<p><strong>运行时执行阶段（第二个 notebook）</strong></p>
<ul>
<li>
<p>定义多智能体工作流：</p>
<ul>
<li>Orchestrator 分析用户目标；</li>
<li>把“事实查询”交给 Researcher；</li>
<li>把“风格/结构检索”交给 Librarian；</li>
<li>Writer 同时接收事实和语义蓝图，按蓝图约束来生成最终输出。</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>现在，这个系统已经可以<strong>动态控制生成过程</strong>：<br/>
既保证内容来自检索到的事实，又保证表达形式严格遵从语义蓝图。</p>
<p>接下来，我们将基于本章构建的能力，设计一个真正意义上的<strong>上下文引擎（context engine）</strong> ，把这一 MAS 提升到新的层级。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[与大模型共舞：从 DeepSeek 到模块化智能应用开发]]></title>    <link>https://juejin.cn/post/7574343024324902953</link>    <guid>https://juejin.cn/post/7574343024324902953</guid>    <pubDate>2025-11-20T02:03:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574343024324902953" data-draft-id="7574306374917390355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="与大模型共舞：从 DeepSeek 到模块化智能应用开发"/> <meta itemprop="keywords" content="DeepSeek"/> <meta itemprop="datePublished" content="2025-11-20T02:03:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="www_stdio"/> <meta itemprop="url" content="https://juejin.cn/user/631558156323657"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            与大模型共舞：从 DeepSeek 到模块化智能应用开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/631558156323657/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    www_stdio
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T02:03:38.000Z" title="Thu Nov 20 2025 02:03:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">与大模型共舞：从 DeepSeek 到模块化智能应用开发</h2>
<p>在人工智能快速发展的今天，大型语言模型（LLM）已成为开发者探索智能应用的重要工具。以 DeepSeek 为代表的开源大模型，依托海量预训练数据中的文本模式进行推理与回答，展现出强大的语言理解与生成能力。然而，正如所有基于静态数据训练的模型一样，DeepSeek 并不具备对新闻、股价等实时信息的感知能力——这恰恰引出了一个关键命题：如何让大模型“走出封闭”，与真实世界互动？本文将结合 ModelScope（魔搭）、Jupyter Notebook 与 OpenAI SDK 等技术生态，探讨构建模块化、可扩展的大模型应用实践路径。</p>
<h3 data-id="heading-1">一、ModelScope：降低 AI 应用门槛的开放平台</h3>
<p>阿里云推出的 <strong>ModelScope（魔搭）</strong> 是一个面向开发者的模型开放平台，汇集了覆盖语音、视觉、自然语言处理（NLP）等领域的海量开源机器学习与深度学习模型。对于希望快速上手大模型的开发者而言，ModelScope 不仅提供一键下载与部署能力，还支持对模型进行微调（fine-tuning），从而适配特定业务场景。这种“模型即服务”（MaaS）的理念，极大降低了 AI 技术的应用门槛，使更多团队能够聚焦于创新而非底层基础设施。</p>
<h3 data-id="heading-2">二、Jupyter Notebook：实验驱动的交互式开发</h3>
<p>在探索大模型能力的过程中，<strong>Jupyter Notebook（.ipynb 文件）</strong> 成为不可或缺的工具。Python 天生适合科学计算与机器学习，而 Jupyter 的交互式特性允许开发者逐条运行代码、即时查看结果，非常适合用于：</p>
<ul>
<li>验证算法逻辑</li>
<li>推导数学公式</li>
<li>测试大模型在不同提示（prompt）下的表现</li>
</ul>
<p>这种“所见即所得”的实验环境，使得从想法到原型的转化过程变得异常高效，尤其适合研究型或探索型项目。</p>
<h3 data-id="heading-3">三、模块化设计：构建可维护的大模型应用</h3>
<p>现代软件工程强调 <strong>模块化</strong> 与 <strong>关注点分离</strong>。在大模型应用开发中，这一原则同样适用。例如，通过引入 OpenAI SDK（尽管 DeepSeek 可能使用兼容接口），我们可以这样组织代码：</p>
<pre><code class="hljs language-ini" lang="ini">from openai import OpenAI

<span class="hljs-attr">client</span> = OpenAI(
    <span class="hljs-attr">api_key</span>=<span class="hljs-string">"your-api-key"</span>,
    <span class="hljs-attr">base_url</span>=<span class="hljs-string">"https://your-deepseek-endpoint/v1"</span>
)
</code></pre>
<p>这种写法不仅清晰表达了依赖关系，还便于后续替换模型后端或调整配置。每个模块专注单一职责——如提示工程、上下文管理、工具调用等——从而提升代码的可读性、可测试性与可扩展性。</p>
<h3 data-id="heading-4">四、多轮对话与角色设定：构建有记忆的智能体</h3>
<p>大模型的 <code>chat.completions</code> 接口支持多轮对话，其核心在于 <strong>消息历史（message history）</strong> 的传递。每条消息包含一个 <code>role</code> 字段，通常分为三类：</p>
<ul>
<li><code>system</code>：定义 AI 的身份、行为准则或任务目标，一般在对话开始时设定一次；</li>
<li><code>user</code>：用户输入的问题或指令；</li>
<li><code>assistant</code>：模型生成的回复。</li>
</ul>
<p>通过精心设计 system prompt 与维护上下文，我们可以引导模型扮演客服、教师、编程助手等角色，实现更连贯、更专业的交互体验。</p>
<h3 data-id="heading-5">五、超越静态知识：教大模型“使用工具”</h3>
<p>尽管 DeepSeek 等模型无法直接获取实时数据，但我们可以通过 <strong>工具调用（Tool Calling）</strong> 赋予其“行动力”。例如：</p>
<ul>
<li>当用户询问“今天北京天气如何？”，模型可识别出需要调用天气 API；</li>
<li>当用户问“特斯拉最新股价是多少？”，模型可触发金融数据接口。</li>
</ul>
<p>这一过程本质上是 <strong>教会 LLM 使用外部工具</strong>：通过函数描述（function schema）告诉模型有哪些工具可用，模型在推理时决定是否调用，并解析返回结果生成自然语言回答。这种“推理 + 工具”的架构，正成为构建实用型 AI 应用的主流范式。</p>
<h3 data-id="heading-6">结语</h3>
<p>从 ModelScope 获取模型，到 Jupyter 中实验验证，再到模块化封装与工具集成，我们正在构建一个开放、灵活且强大的大模型应用开发生态。DeepSeek 这样的开源模型不仅是技术成果，更是创新的起点。未来，随着工具调用、记忆机制与多模态能力的融合，大模型将真正从“知识库”进化为“智能体”，在现实世界中发挥更大价值。</p>
<blockquote>
<p>正如一句开发者格言所说：“模型提供可能性，工程实现价值。” 在这场人与智能协同进化的旅程中，我们既是使用者，也是塑造者。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 深度测评：Gemini 3.0 Pro 时代的降维打击 —— 当 AI 开始“吞噬”整个软件工程]]></title>    <link>https://juejin.cn/post/7574251313884053519</link>    <guid>https://juejin.cn/post/7574251313884053519</guid>    <pubDate>2025-11-19T17:04:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574251313884053519" data-draft-id="7574230586971488262" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 深度测评：Gemini 3.0 Pro 时代的降维打击 —— 当 AI 开始“吞噬”整个软件工程"/> <meta itemprop="keywords" content="程序员,AI编程,AIGC"/> <meta itemprop="datePublished" content="2025-11-19T17:04:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南山安"/> <meta itemprop="url" content="https://juejin.cn/user/1795929588117962"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 深度测评：Gemini 3.0 Pro 时代的降维打击 —— 当 AI 开始“吞噬”整个软件工程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1795929588117962/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南山安
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T17:04:58.000Z" title="Wed Nov 19 2025 17:04:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>如果说 GPT-4o 让我们惊叹于 AI 的“类人交互”，Claude 3.5 Sonnet 展示了 AI 的“代码智商”，那么 Google 借由 Gemini Pro 系列（及预测中的 3.0 架构）所构建的，则是一座通往<strong>AGI（通用人工智能）的工业级基础设施</strong>。</p>
<p>作为一个在 IT 行业摸爬滚打多年的开发者，今天我想跳出简单的“跑分”，从<strong>生产力重构、架构范式转移、生态壁垒</strong>三个维度，全方位剖析 Google 这位巨人苏醒后，对我们手中的饭碗到底意味着什么。</p>
<hr/>
<h2 data-id="heading-1">📊 第一章：诸神之战 —— 全球顶级模型横评</h2>
<p>在聊影响之前，我们先得搞清楚 Gemini Pro 在当前坐标系中的位置。我们将以 Google 最新的旗舰能力（代称 Gemini-3.0-pro）与目前的顶流竞品进行<strong>颗粒度更细</strong>的对比。</p>









































<table><thead><tr><th>核心维度</th><th><strong>Google Gemini 3.0 Pro</strong> (演进版)</th><th><strong>OpenAI GPT-4o</strong></th><th><strong>Anthropic Claude 3.5 Sonnet</strong></th></tr></thead><tbody><tr><td><strong>底层架构</strong></td><td><strong>原生多模态 (Native Multimodal)</strong>  <br/> <em>音频/视频/图像直接作为Token输入，无损耗</em></td><td>文本模型 + 视觉/语音编码器拼接 (虽然4o已高度融合，但Gemini更纯粹)</td><td>文本 + 视觉 (暂无原生音频处理能力)</td></tr><tr><td><strong>上下文窗口 (Context)</strong></td><td><strong>👑 王者级：2M ~ 无限 Token</strong> <br/> <em>能吃下整个 Linux 内核代码库或 2 小时高清电影</em></td><td>128k Token <br/> <em>适合日常对话，处理长文档需切片</em></td><td>200k Token <br/> <em>代码能力强，但长文本记忆稍逊</em></td></tr><tr><td><strong>推理与逻辑</strong></td><td><strong>长程逻辑链 (Long-context Reasoning)</strong>  <br/> <em>擅长在海量杂乱信息中提取关联</em></td><td>极速响应，适合实时交互，逻辑跳跃性较好</td><td><strong>👑 代码逻辑最强</strong> <br/> <em>目前编程界公认的 Coding King</em></td></tr><tr><td><strong>生态整合</strong></td><td><strong>系统级植入</strong> <br/> <em>Android, Chrome, Firebase, Google Cloud</em></td><td>应用级整合 <br/> <em>Copilot, macOS App, ChatGPT</em></td><td>纯 API 服务商 <br/> <em>集成依赖第三方工具</em></td></tr><tr><td><strong>定价策略</strong></td><td><strong>价格屠夫</strong> <br/> <em>Flash版本极低，Pro版本不仅免费额度大，且Token单价激进</em></td><td>较贵，但在持续优化成本</td><td>较贵，主要面向高端开发者</td></tr></tbody></table>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/103d5bd141f745d598950549b5ccc6d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764176698&amp;x-signature=Vmo65ACZf6Zg4t2Y%2BXc9hiFCg58%3D" alt="DM_20251120010042_001.jpg" loading="lazy"/></p>
<h3 data-id="heading-2">核心差异点解读：</h3>
<ul>
<li><strong>GPT-4o 是“全能助理”</strong> ：它的响应速度（Latancy）是极致的，它是为了让你**“爽”**而生的，适合做客服、语音助手、实时翻译。</li>
<li><strong>Claude 3.5 是“天才程序员”</strong> ：给它一段复杂的算法逻辑，它写的 Bug 最少，代码风格最优雅。</li>
<li><strong>Gemini Pro 是“超级数据吞噬者”</strong> ：它不一定写代码最快，但它能<strong>同时读完你公司过去 10 年的所有技术文档</strong>，并告诉你为什么现在的架构是这个鬼样子。<strong>它的护城河是“容量”和“多模态理解深度”。</strong></li>
</ul>
<hr/>
<h2 data-id="heading-3">🛠️ 第二章：对 IT 行业具体岗位的深度冲击</h2>
<p>Gemini Pro 的出现，不仅仅是让我们写代码快了一点，它正在<strong>改变软件生产的流水线</strong>。</p>
<h3 data-id="heading-4">1. 前端开发：从“切图仔”到“交互逻辑架构师”</h3>
<p>在 Gemini 的原生多模态能力下，前端开发的工作流将发生质变：</p>
<ul>
<li>
<p><strong>UI/UX 还原自动化</strong>：以前的 img-to-code 是基于 OCR 识别文字 + 猜测布局。现在的 Gemini 可以直接理解<strong>设计稿的层级结构（DOM Tree）</strong> 。</p>
<ul>
<li><em>场景</em>：上传一段 Figma 的演示视频，Gemini 直接生成包含 CSS 动画状态机（State Machine）的 React 代码。</li>
</ul>
</li>
<li>
<p><strong>WebGL/3D 开发门槛消失</strong>：正如你提到的“地球模型”，以前你需要精通 Three.js 的矩阵变换、着色器（Shader）语言。</p>
<ul>
<li><em>现在</em>：你可以直接发给 Gemini 一张《流浪地球》的剧照，说：“用 Three.js 实现这个光影效果。”它能直接生成 Shader 代码，因为它“看懂”了光是怎么漫反射的。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">2. 后端与架构：遗留代码（Legacy Code）的救世主</h3>
<p>这是 Gemini <strong>超长上下文</strong>发挥威力的主战场。</p>
<ul>
<li>
<p><strong>旧系统重构</strong>：每个公司都有一座“屎山”。以前 AI 读不懂，因为上下文不够。现在，你可以把<strong>整个仓库（Repo）打包</strong>丢给 Gemini。</p>
<ul>
<li><em>Prompt</em>： <em>“阅读这 500 个 Java 文件，找出所有使用旧版 JDBC 连接池的地方，重构为 Spring Boot 3 的风格，并生成迁移的 SQL 脚本。”</em></li>
<li><em>结果</em>：它不仅能改代码，还能通过理解全链路，告诉你改了这个函数会通过依赖注入影响到哪个 Controller。</li>
</ul>
</li>
<li>
<p><strong>日志分析与故障排查</strong>：</p>
<ul>
<li>后端最怕的是<strong>分布式链路追踪</strong>中的断层。Gemini 可以一次性吃下 100MB 的 Trace 日志，跨越几十个微服务找到那个导致雪崩的 <code>NullPointerException</code>。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">3. 移动端（Android/iOS）：On-Device AI 的崛起</h3>
<p>Google 正在推行 <strong>Gemini Nano</strong>（端侧模型）。这意味着：</p>
<ul>
<li><strong>隐私计算</strong>：APP 不再需要把用户数据传回云端处理。</li>
<li><strong>离线智能</strong>：你的 APP 可以在断网情况下，利用手机 NPU 跑一个精简版的 Gemini，实现实时的图片分类、文本摘要。这对于 IT 开发来说，意味着我们要开始学习 <strong>AICore</strong> 和 <strong>TensorFlow Lite</strong> 的部署技术了。</li>
</ul>
<hr/>
<h2 data-id="heading-7">🧠 第三章：架构范式转移 —— RAG 的消亡与新生</h2>
<p>这部分是本文最硬核的观点。</p>
<p>在 2023 年，我们做企业级 AI 应用的标准架构是 <strong>RAG（检索增强生成）</strong> ：</p>
<blockquote>
<p>用户提问 -&gt; 向量数据库检索 -&gt; 召回 Top 5 片段 -&gt; 喂给 LLM -&gt; 生成答案。</p>
</blockquote>
<p><strong>为什么这么做？</strong> 因为以前的模型记不住那么多东西（Context Window 太小）。</p>
<p><strong>Gemini 3.0 Pro 带来的冲击：</strong> 当上下文扩展到 <strong>200 万甚至 1000 万 Token</strong> 时，对于中小型知识库（例如一本技术手册、一个法律合同库、一个项目的代码），<strong>RAG 可能不再被需要</strong>。</p>
<ul>
<li>
<p><strong>In-Context Learning (上下文学习)</strong> ：你可以直接把整本书塞进 Prompt 里。</p>
</li>
<li>
<p><strong>大海捞针（Needle In A Haystack）测试</strong>：Gemini 1.5 Pro 已经证明，在百万级 Token 中检索具体信息的准确率达到了 99% 以上。</p>
</li>
<li>
<p><strong>影响</strong>：</p>
<ol>
<li><strong>向量数据库（Vector DB）</strong>  的市场会被压缩，仅用于海量（TB级）数据检索。</li>
<li>开发者的精力将从“优化检索算法”转移到“如何高效地组织 Prompt 上下文”。</li>
</ol>
</li>
</ul>
<hr/>
<h2 data-id="heading-8">🌩️ 第四章：Google 的终极杀招 —— 生态降维打击</h2>
<p>OpenAI 是一个“应用”，Claude 是一个“工具”，但 Google 是一个 <strong>“操作系统”</strong>。</p>
<p>Gemini 3.0 Pro 对 IT 行业最大的威胁（或机遇）在于它无处不在：</p>
<ol>
<li><strong>IDE 集成 (Android Studio / IDX)</strong> ：Google 正在把 Gemini 植入 IDE 内核。它不是像 Copilot 那样作为一个插件存在，而是作为<strong>编译器的一部分</strong>。它甚至能在你 Debug 时，自动预测你下一个 Breakpoint 应该打在哪里。</li>
<li><strong>Cloud 基础设施</strong>：在 Google Cloud Platform 上，SQL 查询可以直接用自然语言写，Gemini 会自动优化查询计划（Query Plan）。DBA（数据库管理员）的工作将从写 SQL 变成“审核 SQL”。</li>
<li><strong>办公协同</strong>：当 Gemini 读懂了你 Google Drive 里所有的文档、Meet 会议记录和 Gmail 邮件时，它就成为了一个拥有你公司所有<strong>隐性知识（Tacit Knowledge）</strong>  的超级员工。</li>
</ol>
<hr/>
<h2 data-id="heading-9">🔮 第五章：总结 —— 开发者的生存指南</h2>
<p>面对 Gemini 3.0 Pro 这种级别的 AI，IT 从业者该何去何从？</p>
<ol>
<li><strong>从“写码”到“审码”</strong> ：代码生成已经是标配。你的核心竞争力在于<strong>Code Review</strong>的能力，在于你能否一眼看出 AI 生成代码中的安全漏洞和逻辑陷阱。</li>
<li><strong>掌握“多模态交互设计”</strong> ：未来的应用不再是单纯的“点按钮”，而是语音、手势、摄像头画面的混合交互。利用 Gemini 的视觉理解能力开发新一代 App 是巨大的蓝海。</li>
<li><strong>拥抱“长上下文”架构</strong>：学会利用 Million-Context 窗口去解决以前需要复杂工程化（如微服务拆分、复杂 ETL）才能解决的问题。</li>
</ol>
<p><strong>结语：</strong> Gemini 3.0 Pro 并不是要杀死开发者，它是要<strong>杀死平庸的重复劳动</strong>。在这个新时代，<strong>想象力</strong>将成为也是唯一限制你开发能力的瓶颈。与其焦虑，不如现在就去申请 API Key，把那个你构思了很久却因为技术太难而搁置的项目，重新捡起来。</p>
<p>现在Google官网可以免费体验，感兴趣的小伙伴可以去尝试开发自己的应用</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c79e221a10194428903ff31d1298841e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764176698&amp;x-signature=qcPRjuneYMSrpsZN%2Fg55lizLymA%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VimL的“工程化”飞跃（下）：从语言到跨平台生态]]></title>    <link>https://juejin.cn/post/7574352425236660243</link>    <guid>https://juejin.cn/post/7574352425236660243</guid>    <pubDate>2025-11-20T02:20:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574352425236660243" data-draft-id="7574352425236512787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VimL的“工程化”飞跃（下）：从语言到跨平台生态"/> <meta itemprop="keywords" content="架构,算法,程序员"/> <meta itemprop="datePublished" content="2025-11-20T02:20:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="codigger"/> <meta itemprop="url" content="https://juejin.cn/user/3607934576120985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VimL的“工程化”飞跃（下）：从语言到跨平台生态
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3607934576120985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    codigger
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T02:20:32.000Z" title="Thu Nov 20 2025 02:20:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>系列文章导读：</strong> 在上篇中，我们探讨了ObjectSense如何通过引入Class和Package机制，完成了从VimL“脚本”到“现代OOP语言”的第一次关键进化。它解决了VimL在“语言工程化”上的核心短板。</p>
<p>但VimL还有一个更根本的局限：它是一座“孤岛”，它的生命几乎完全依赖Vim编辑器这个“宿主”。</p>
<p>（上篇）从脚本到现代OOP</p>
<p><strong>（下篇）从语言到跨平台生态</strong></p>
<h3 data-id="heading-0">一、VimL的“宿主”困境</h3>
<p>VimL的第二次进化，必须解决这个“宿主困境”。如果一门语言只能活在编辑器里，那它永远无法构建独立的服务、桌面应用或智能合约。</p>
<p>ObjectSense的文档，用大量篇幅展示了它如何试图“越狱”——从VimL的“基因”出发，进化出一个独立、跨平台的完整生态。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0363d084db4745b6a39ef97ca5663973~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kaWdnZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764210500&amp;x-signature=WRcFqXPEpAqm17IPMXCU31FP8UY%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">二、进化的第二步：构建“生态工具链”</h3>
<p>如果说（上篇）的OOP是“语言设计”，那么（下篇）就是“工具链建设”。</p>
<p><strong>1. Sense.ose</strong> <strong>与</strong> <strong>rose</strong> <strong>：从</strong> <strong>“</strong> <strong>插件</strong> <strong>”</strong> <strong>到</strong> <strong>“</strong> <strong>模块</strong> <strong>”</strong></p>
<p>VimL的包管理是“编辑器级别”的（如Vim-plug, Packer）。而ObjectSense则提供了“<strong>语言级别</strong>”的模块化方案。</p>
<p><strong>Sense.ose</strong> <strong>文件：</strong> 扮演了package.json (Node.js) 或 Cargo.toml (Rust) 的角色。它是一个“Module描述文件”，定义了模块的版本、依赖（require）、导出（export）和入口（main）。</p>
<p><strong>rose</strong> <strong>命令行工具：</strong> 扮演了npm或cargo的角色。它提供了install, push, run, create等一系列完整的包管理和项目运行命令。</p>
<p>这两者的结合，标志着它从“Vim插件”正式进化为“<strong>可独立分发的软件模块</strong>”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3b1f7e31ee842feab255fd25f4e8952~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kaWdnZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764210500&amp;x-signature=AcAtHfFtUi%2B7aueJn6vYw2lnp%2B8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">三、进化的第三步：Harmony框架——“逃离”VimL</h3>
<p>这可能是ObjectSense在进化上最大胆的一步。它不再满足于“封装”VimL，而是要“<strong>编译</strong>”VimL。</p>
<p>VimL的宿命是被Vim的解释器执行。而ObjectSense的Harmony Framework（和谐框架）是一个“编译调度”框架。</p>
<p>根据文档，Harmony允许你“<strong>注册和使用不同的</strong> <strong>Compiler</strong> <strong>（编译器）</strong> ”。</p>
<p>这意味着什么？</p>
<p>1.      <strong>AOT</strong> <strong>编译（</strong> <strong>preboot</strong> <strong>）：</strong> 文档中的“实战 OSE-Compiler”章节展示了，Harmony可以使用preboot编译器，将ObjectSense代码<strong>编译为****C</strong> <strong>语言代码</strong>。</p>
<p>2.      <strong>跨语言编译（</strong> <strong>Smart Contract</strong> <strong>）：</strong> 文档明确提到，可以使用SmartContract编译器，将OSE代码“<strong>翻译为</strong> <strong>Solidity</strong> <strong>源程序</strong>，进而编译成Evm Bincode”。</p>
<p>3.      <strong>交叉编译（</strong> <strong>Cross Compiler</strong> <strong>）：</strong> 它甚至提供了交叉编译工具，用于“编译出windows 和 macos 和 linux 多平台动态库或可执行文件”。</p>
<p>这彻底打破了VimL的“孤岛”宿命。ObjectSense不再是Vim的“寄生脚本”，它进化成了一种“<strong>元语言</strong>”：一种可以用Vim的简洁语法编写，但最终可以“变身”为C代码、Solidity合约或其他任何目标代码的工程语言。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0031ad32de3440abb7de120f673fab42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kaWdnZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764210500&amp;x-signature=kIGdSvkbnDtBsCzxcsJsfVD7a44%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">四、进化的“未来时”：Micro（微语言）</h3>
<p>如果说Harmony是“进化”的执行者，那么Micro（微语言）就是“进化”的设计者。</p>
<p>Micro机制（“类似于Lisp宏”）允许开发者自定义语法。这意味着开发者可以“在语言之上设计语言”。</p>
<p>例如，开发者可以为“智能合约”或“GUI”设计一套专用的、声明式的Micro语法，然后通过Harmony框架将其编译成目标代码。</p>
<p>这标志着VimL的基因完成了最终的进化：它从一个“被动”的、用于配置编辑器的脚本，进化成了一个“主动”的、用于创造新工具和新语法的“元编程”平台。</p>
<h3 data-id="heading-4">结论：VimL的“精神续作”</h3>
<p>从VimL出发，ObjectSense的进化路径清晰可见：</p>
<p>1.      <strong>第一次飞跃（语言）：</strong> 引入OOP和包管理，解决了VimL的“工程化”难题。</p>
<p>2.      <strong>第二次飞跃（生态）：</strong> 引入rose工具链，摆脱了“插件”的定位。</p>
<p>3.      <strong>第三次飞跃（跨平台）：</strong> 引入Harmony编译框架，摆脱了“Vim宿主”的依赖，进化为可编译至C、EVM等的“元语言”。</p>
<p>它保留了VimL“千行代码”的简洁内核，但赋予了它现代工程化的“骨架”和“跨平台”的翅膀。无论这个项目未来走向何方，它都为VimL的进化提供了一个极具想象力的范本。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-40、数组中只出现⼀次的数字]]></title>    <link>https://juejin.cn/post/7574322843049689138</link>    <guid>https://juejin.cn/post/7574322843049689138</guid>    <pubDate>2025-11-20T02:31:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574322843049689138" data-draft-id="7572515402795237426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="剑指offer-40、数组中只出现⼀次的数字"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-20T02:31:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            剑指offer-40、数组中只出现⼀次的数字
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T02:31:17.000Z" title="Thu Nov 20 2025 02:31:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>⼀个整型数组⾥除了两个数字之外，其他的数字都出现了两次。请写程序找出这两个只出现⼀次的数字。</p>
<p>示例
输入：[92,3,43,54,92,43,2,2,54,1]
输出：3，1</p>
<h2 data-id="heading-1">思路解答</h2>
<h3 data-id="heading-2">哈希表统计</h3>
<p>使⽤ hashmap 存储数字出现的次数， key 为出现的数字， value 为该数字出现的次数。遍历⾥⾯所有的数字，如果 hashmap 中存在，那么 value （次数）+1，如果 hashmap 中不存在,那么 value 置为1。</p>
<p>遍历完成之后，需要将次数为 1 的数字捞出来，同样是遍历 hashmap ，由于只有两个满⾜条件，我们设置⼀个标识变量，初始化为1，如果找到第⼀个满⾜条件的数字，除了写⼊放回数组中，还需要将该标识置为 2 ，表示接下来找的是第 2 个。</p>
<p>如果找到第 2 个，那么写⼊之后，直接 return 。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">FindNumsAppearOnce</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">int</span> num1[], <span class="hljs-type">int</span> num2[])</span> {
     Map&lt;Integer, Integer&gt; maps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
     <span class="hljs-keyword">if</span> (array != <span class="hljs-literal">null</span>) {
         <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> n : array) {
             <span class="hljs-type">Integer</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> maps.get(n);
             <span class="hljs-keyword">if</span> (num == <span class="hljs-literal">null</span>) {
                 <span class="hljs-comment">// map中不存在</span>
                 maps.put(n, <span class="hljs-number">1</span>);
             } <span class="hljs-keyword">else</span> {
                 <span class="hljs-comment">// map中已经存在</span>
                 maps.put(n, num + <span class="hljs-number">1</span>);
             }
         }
      }
      <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
      <span class="hljs-keyword">for</span> (Map.Entry&lt;Integer, Integer&gt; entry : maps.entrySet()) {
          <span class="hljs-keyword">if</span> (entry.getValue() == <span class="hljs-number">1</span>) {
             <span class="hljs-keyword">if</span> (index == <span class="hljs-number">1</span>) {
                 num1[<span class="hljs-number">0</span>] = entry.getKey();
                 index++;
             } <span class="hljs-keyword">else</span> {
                 num2[<span class="hljs-number">0</span>] = entry.getKey();
                 <span class="hljs-keyword">return</span>;
             }
         }
     }
 }
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，需要遍历数组两次</li>
<li><strong>空间复杂度</strong>：O(n)，需要HashMap存储频率信息</li>
</ul>
<h3 data-id="heading-3">排序遍历</h3>
<p>先对数组排序，然后遍历查找不连续的数字。排序后相同的数字会相邻，遍历找到不连续的数字</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] FindNumsAppearOnce(<span class="hljs-type">int</span>[] nums) {
        <span class="hljs-keyword">if</span> (nums == <span class="hljs-literal">null</span> || nums.length &lt; <span class="hljs-number">2</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">0</span>];
        }
        
        <span class="hljs-comment">// 对数组进行排序</span>
        <span class="hljs-type">int</span>[] sorted = nums.clone();
        Arrays.sort(sorted);
        
        <span class="hljs-type">int</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">2</span>];
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 遍历查找不连续的数字</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; sorted.length; i++) {
            <span class="hljs-comment">// 检查当前数字是否与前后都不同</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isSingle</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
            
            <span class="hljs-comment">// 检查前一个元素（如果不是第一个元素）</span>
            <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span> &amp;&amp; sorted[i] == sorted[i - <span class="hljs-number">1</span>]) {
                isSingle = <span class="hljs-literal">false</span>;
            }
            
            <span class="hljs-comment">// 检查后一个元素（如果不是最后一个元素）</span>
            <span class="hljs-keyword">if</span> (i &lt; sorted.length - <span class="hljs-number">1</span> &amp;&amp; sorted[i] == sorted[i + <span class="hljs-number">1</span>]) {
                isSingle = <span class="hljs-literal">false</span>;
            }
            
            <span class="hljs-keyword">if</span> (isSingle) {
                result[index++] = sorted[i];
                <span class="hljs-keyword">if</span> (index == <span class="hljs-number">2</span>) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 找到两个数字后退出</span>
            }
        }
        
        <span class="hljs-comment">// 确保结果按升序排列</span>
        <span class="hljs-keyword">if</span> (result[<span class="hljs-number">0</span>] &gt; result[<span class="hljs-number">1</span>]) {
            <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> result[<span class="hljs-number">0</span>];
            result[<span class="hljs-number">0</span>] = result[<span class="hljs-number">1</span>];
            result[<span class="hljs-number">1</span>] = temp;
        }
        
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(nlogn)，主要来自排序操作</li>
<li><strong>空间复杂度</strong>：O(1) 或 O(n)，取决于是否克隆数组</li>
</ul>
<h3 data-id="heading-4">位运算（最优解）</h3>
<p>⾸先需要了解⼀定位运算知识，异或是指⼆进制中，⼀个位上的数如果相同结果就是0，不同则结果是0.</p>
<p>也就是如果⼀个数的最低位是0，另⼀个数的最低位是0，那么异或结果的最低位是0；如果⼀个数的最低位是0，另⼀个数的最低位是1，那么异或结果的最低位是1。</p>
<p>异或操作可以交换，不影响结果：A^B^C = A^B^C</p>
<p>A^A=0,任何⼀个数异或⾃身，等于0，因为所有位都相同</p>
<p>A^0 = A，任何⼀个数异或0，等于⾃身，因为所有位如果和0不同，就是1，也就是保留了⾃身的数值</p>
<p>假设⾥⾯出现⼀次的两个元素为 A 和 B ，初始化异或结果 res 为0，遍历数组⾥⾯所有的数，都进⾏异或操作，则最后结果 res = A^B 。</p>
<p>但是我们拿到这个 A 和 B 异或之后的结果，怎么区分呢？</p>
<p>有⼀种巧妙的思路，因为 A 和 B 的某⼀位不同才会在结果中出现 1 ，说明在那⼀位上， A 和 B 中肯定有⼀个是 0 ，有⼀个是 1 。</p>
<p>那我们取出异或结果 res 最低位的1，假设这个数值是 temp （temp只有⼀个位是1，也就是A和B最后不同的位）</p>
<p>遍历数组中的元素，和 temp 进⾏与操作，如果和 temp 相与，不等于0。说明这个元素的该位上也是1。那就说明它很有可能就是 A 和 B 中的⼀个。</p>
<p>只是有可能，其他的数也有可能该位上为 1 。但是符合这种情况的，其他数肯定出现两次，⽽ A 和 B只可能有⼀个符合，并且只有可能出现⼀次 A 或者 B 。</p>
<p>凡是符合和 temp 相与,结果不为0的，我们进⾏异或操作。</p>
<p>也就是可能出现， res1 = B^C^D^C^D...^E^E^B 或者 res1 = A^C^D^C^D...^E^E 。</p>
<p>上⾯的式⼦可以视为 res1 = B 或者 res1 = A</p>
<p>这样操作下来，我们就知道了 res1 肯定是其中⼀个只出现⼀次的数（ A 或者 B ）,⽽同时上⾯计算出了 res = A^B ,也就是可以通过 res1^res 求出另⼀个数。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">FindNumsAppearOnce</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">int</span> num1[], <span class="hljs-type">int</span> num2[])</span> {
     <span class="hljs-comment">// A和B异或的结果</span>
     <span class="hljs-type">int</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
     <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> val : array) {
     	res ^= val;
     }
    
     <span class="hljs-comment">// temp保存了两个数最后⼀个不同的位</span>
     <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> res &amp; (-res);
     <span class="hljs-comment">// 保存和最后⼀个不同的位异或的结果</span>
     <span class="hljs-type">int</span> <span class="hljs-variable">res1</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
     <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> val : array) {
         <span class="hljs-comment">// 不等于0说明可能是其中⼀个数，⾄少排除了另外⼀个数</span>
         <span class="hljs-keyword">if</span> ((temp &amp; val) != <span class="hljs-number">0</span>) {
         	res1 ^= val;
         }
     }
     <span class="hljs-comment">// 由于其他满⾜条件的数字都出现两次，所以结果肯定就是只出现⼀次的数</span>
     num1[<span class="hljs-number">0</span>] = res1;
     <span class="hljs-comment">// 求出另外⼀个数</span>
     num2[<span class="hljs-number">0</span>] = res ^ res1;
 }
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，只需要遍历数组两次</li>
<li><strong>空间复杂度</strong>：O(1)，只使用固定数量的变量</li>
</ul>
<h4 data-id="heading-5">位运算原理解析</h4>
<p>通过示例详细解释算法过程：</p>
<p><strong>输入</strong>：<code>[92,3,43,54,92,43,2,2,54,1]</code>
<strong>单次数</strong>：3 和 1</p>
<p><strong>步骤1：计算所有数字的异或结果</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">92</span> ^ <span class="hljs-number">3</span> ^ <span class="hljs-number">43</span> ^ <span class="hljs-number">54</span> ^ <span class="hljs-number">92</span> ^ <span class="hljs-number">43</span> ^ <span class="hljs-number">2</span> ^ <span class="hljs-number">2</span> ^ <span class="hljs-number">54</span> ^ <span class="hljs-number">1</span>
= (<span class="hljs-number">92</span> ^ <span class="hljs-number">92</span>) ^ (<span class="hljs-number">43</span> ^ <span class="hljs-number">43</span>) ^ (<span class="hljs-number">2</span> ^ <span class="hljs-number">2</span>) ^ (<span class="hljs-number">54</span> ^ <span class="hljs-number">54</span>) ^ <span class="hljs-number">3</span> ^ <span class="hljs-number">1</span>
= <span class="hljs-number">0</span> ^ <span class="hljs-number">0</span> ^ <span class="hljs-number">0</span> ^ <span class="hljs-number">0</span> ^ (<span class="hljs-number">3</span> ^ <span class="hljs-number">1</span>)
= <span class="hljs-number">3</span> ^ <span class="hljs-number">1</span> = <span class="hljs-number">2</span>
</code></pre>
<p><strong>步骤2：找到异或结果的最低位的1</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">3</span>的二进制: <span class="hljs-number">0011</span>
<span class="hljs-number">1</span>的二进制: <span class="hljs-number">0001</span>
<span class="hljs-number">3</span>^<span class="hljs-number">1</span>=<span class="hljs-number">2</span>的二进制: <span class="hljs-number">0010</span>
最低位的<span class="hljs-number">1</span>在从右往左第<span class="hljs-number">2</span>位（值为<span class="hljs-number">2</span>）
</code></pre>
<p><strong>步骤3：根据最低位1分组</strong></p>
<ul>
<li><strong>第1组（第2位为0）</strong>：3(0011), 43(101011), 54(110110), 1(0001), 92(1011100)</li>
<li><strong>第2组（第2位为1）</strong>：2(0010)</li>
</ul>
<p><strong>步骤4：分别异或各组</strong></p>
<pre><code class="hljs language-java" lang="java">第<span class="hljs-number">1</span>组: <span class="hljs-number">3</span> ^ <span class="hljs-number">43</span> ^ <span class="hljs-number">54</span> ^ <span class="hljs-number">1</span> ^ <span class="hljs-number">92</span> ^ <span class="hljs-number">43</span> ^ <span class="hljs-number">54</span> ^ <span class="hljs-number">92</span>
     = (<span class="hljs-number">3</span> ^ <span class="hljs-number">1</span>) ^ (<span class="hljs-number">43</span> ^ <span class="hljs-number">43</span>) ^ (<span class="hljs-number">54</span> ^ <span class="hljs-number">54</span>) ^ (<span class="hljs-number">92</span> ^ <span class="hljs-number">92</span>) 
     = <span class="hljs-number">3</span> ^ <span class="hljs-number">1</span> = <span class="hljs-number">2</span> ❌ 这里应该是 <span class="hljs-number">3</span> ^ <span class="hljs-number">1</span> = <span class="hljs-number">2</span>，但我们需要重新计算正确的分组

让我们重新正确分组计算：
实际分组应该是：
第<span class="hljs-number">1</span>组（第<span class="hljs-number">2</span>位为<span class="hljs-number">0</span>）：<span class="hljs-number">3</span>, <span class="hljs-number">1</span>  <span class="hljs-comment">// 只有这两个数在第2位为0且是单次数</span>
第<span class="hljs-number">2</span>组（第<span class="hljs-number">2</span>位为<span class="hljs-number">1</span>）：所有其他数

正确的计算：
第<span class="hljs-number">1</span>组: <span class="hljs-number">3</span> ^ <span class="hljs-number">1</span> = <span class="hljs-number">2</span>
第<span class="hljs-number">2</span>组: <span class="hljs-number">92</span> ^ <span class="hljs-number">43</span> ^ <span class="hljs-number">54</span> ^ <span class="hljs-number">92</span> ^ <span class="hljs-number">43</span> ^ <span class="hljs-number">2</span> ^ <span class="hljs-number">2</span> ^ <span class="hljs-number">54</span> = <span class="hljs-number">0</span>
</code></pre>
<p><strong>位运算特性利用：</strong></p>
<ul>
<li>相同数字异或为0：<code>a ^ a = 0</code></li>
<li>任何数与0异或为本身：<code>a ^ 0 = a</code></li>
<li>异或满足交换律和结合律</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[.NET集成飞书API最佳实践：基于Mud.Feishu的飞书二次开发实践]]></title>    <link>https://juejin.cn/post/7574318108720529454</link>    <guid>https://juejin.cn/post/7574318108720529454</guid>    <pubDate>2025-11-20T02:27:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574318108720529454" data-draft-id="7574322843049639986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=".NET集成飞书API最佳实践：基于Mud.Feishu的飞书二次开发实践"/> <meta itemprop="keywords" content=".NET,C#"/> <meta itemprop="datePublished" content="2025-11-20T02:27:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mudtools"/> <meta itemprop="url" content="https://juejin.cn/user/2112621078650964"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            .NET集成飞书API最佳实践：基于Mud.Feishu的飞书二次开发实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2112621078650964/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mudtools
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T02:27:21.000Z" title="Thu Nov 20 2025 02:27:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>飞书作为一款集成化的办公平台，为企业提供了强大的组织管理和协作能力。其中，组织管理是构建高效团队协作体系的基础环节。本文将深入解析如何在飞书平台上进行全面的组织管理，包括部门、用户、用户角色、职级、职位等核心要素，帮助开发者更好地理解和运用飞书API进行组织相关操作。</p>
</blockquote>
<h2 data-id="heading-0">Mud.Feishu框架的介绍</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fmudtools%2FMudFeishu" target="_blank" title="https://gitee.com/mudtools/MudFeishu" ref="nofollow noopener noreferrer">Mud.Feishu</a>是一个专为.NET开发者设计的飞书API集成组件库，它封装了飞书开放平台的各种API接口，提供了更加友好和易用的编程接口。该组件基于ASP.NET Core框架开发，充分利用了.NET生态系统的优势，为开发者提供了现代化的开发体验。</p>
<h3 data-id="heading-1">技术架构与支持框架</h3>
<p>Mud.Feishu组件完全基于.NET框架构建，充分利用了其依赖注入、配置管理、日志记录等核心功能。组件设计遵循.NET生态系统最佳实践，能够无缝集成到ASP.NET Core应用程序中。</p>
<p>在服务注册方面，Mud.Feishu采用了标准的ASP.NET Core扩展模式，通过<code>AddFeishuApiService("FeishuSettings")</code>方法将飞书服务注册到服务容器中，其中"FeishuSettings"为appsettings.json配置文件中的配置节名称。这种设计方式使得组件配置更加清晰，避免了直接传递IConfiguration对象可能带来的配置混乱问题。</p>
<h3 data-id="heading-2">第三方库依赖情况</h3>
<p>Mud.Feishu组件在设计时尽量减少了对第三方库的依赖，以降低项目的复杂性和潜在的版本冲突风险。主要依赖包括：</p>
<ol>
<li><strong>System.Text.Json</strong> - 用于JSON序列化和反序列化，这是.NET Core内置的高性能JSON处理库</li>
<li><strong>Microsoft.Extensions.Http</strong> - 用于配置和管理HTTP客户端，提供连接池、生命周期管理等功能</li>
<li><strong>Microsoft.Extensions.Options</strong> - 用于强类型配置绑定和验证</li>
<li><strong>Microsoft.Extensions.Logging</strong> - 用于记录组件运行日志</li>
</ol>
<p>这些依赖都是.NET生态系统中的标准组件，确保了组件的稳定性和兼容性。</p>
<h3 data-id="heading-3">核心特性</h3>
<p>Mud.Feishu组件具有以下核心特性：</p>
<ol>
<li><strong>全面的API覆盖</strong> - 支持飞书开放平台的绝大部分API，包括用户管理、部门管理、消息发送、日历管理等</li>
<li><strong>强类型支持</strong> - 所有API请求和响应都具有明确的类型定义，提供完整的IntelliSense支持</li>
<li><strong>自动令牌管理</strong> - 自动处理访问令牌的获取、刷新和缓存，开发者无需关心令牌细节</li>
<li><strong>内置重试机制</strong> - 对于网络抖动等临时性错误，组件内置了智能重试机制</li>
<li><strong>完善的异常处理</strong> - 提供了丰富的异常类型，便于开发者进行精确的错误处理</li>
<li><strong>可扩展设计</strong> - 采用接口抽象设计，支持自定义扩展和替换组件内部实现</li>
</ol>
<h2 data-id="heading-4">与原生飞书SDK的对比分析</h2>
<p>为了更清晰地展示Mud.Feishu组件相对于原生SDK的优势，下面通过表格形式进行详细对比：</p>



























































<table><thead><tr><th>对比维度</th><th>原生SDK调用</th><th>Mud.Feishu组件</th><th>优势说明</th></tr></thead><tbody><tr><td>开发效率</td><td>需要手动构造HTTP请求、处理响应、解析JSON等大量样板代码</td><td>只需调用简洁的接口方法，一行代码完成操作</td><td>大幅减少代码量，提高开发效率</td></tr><tr><td>类型安全</td><td>手动处理JSON序列化/反序列化，容易出现类型转换错误</td><td>提供完整的强类型支持，编译时就能发现类型错误</td><td>提高代码健壮性，减少运行时错误</td></tr><tr><td>令牌管理</td><td>需要手动获取、刷新和管理访问令牌</td><td>自动处理令牌获取和刷新机制</td><td>减少开发者负担，避免令牌管理错误</td></tr><tr><td>异常处理</td><td>需要手动处理各种网络异常和业务异常</td><td>提供统一的异常处理机制和明确的异常类型</td><td>简化异常处理逻辑，提高代码可读性</td></tr><tr><td>重试机制</td><td>需要手动实现重试逻辑</td><td>内置智能重试机制，自动处理网络抖动等问题</td><td>提高系统稳定性</td></tr><tr><td>可测试性</td><td>直接调用HTTP接口，难以进行单元测试</td><td>基于接口设计，易于进行Mock测试</td><td>提高代码质量和可维护性</td></tr><tr><td>文档完善度</td><td>需要在飞书官方文档中查找各个接口的详细说明</td><td>提供完整的中文API文档和示例代码</td><td>降低学习成本，快速上手</td></tr><tr><td>依赖管理</td><td>需要自行引入和管理各种第三方库</td><td>统一管理所有依赖，避免版本冲突</td><td>简化项目依赖管理</td></tr></tbody></table>
<p>通过以上对比，Mud.Feishu组件在各个方面都优于原生SDK调用方式，特别是在开发效率和代码质量方面有显著提升。</p>
<p>使用Mud.Feishu的简单示例：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用Mud.Feishu</span>
<span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _feishuUserApi.CreateUserAsync(token, userRequest);

<span class="hljs-comment">// 原生方式需要大量样板代码</span>
<span class="hljs-keyword">var</span> client = <span class="hljs-keyword">new</span> HttpClient();
<span class="hljs-keyword">var</span> request = <span class="hljs-keyword">new</span> HttpRequestMessage(HttpMethod.Post, <span class="hljs-string">"https://open.feishu.cn/open-apis/contact/v3/users"</span>);
request.Headers.Add(<span class="hljs-string">"Authorization"</span>, <span class="hljs-string">$"Bearer <span class="hljs-subst">{token}</span>"</span>);
<span class="hljs-keyword">var</span> json = JsonSerializer.Serialize(userRequest);
request.Content = <span class="hljs-keyword">new</span> StringContent(json, Encoding.UTF8, <span class="hljs-string">"application/json"</span>);
<span class="hljs-keyword">var</span> response = <span class="hljs-keyword">await</span> client.SendAsync(request);
<span class="hljs-comment">// ... 更多处理代码</span>
</code></pre>
<h3 data-id="heading-5">Mud.Feishu 的架构设计</h3>
<p>Mud.Feishu 采用现代化的分层架构设计，将复杂的 HTTP 通信细节封装为简单易用的 API 接口，架构层次图如下：</p>
<h4 data-id="heading-6">架构层次图</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                    应用层 (Application Layer)                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   Controller    │  │    Service      │  │   Repository    │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                   API 抽象层 (API Abstraction)                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ IFeishuV3User   │  │ IFeishuV3Dept   │  │ IFeishuV3Role   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                  核心服务层 (Core Services)                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ TokenManager    │  │ HttpClient      │  │ ErrorHandler    │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                  基础设施层 (Infrastructure)                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   Caching       │  │   Logging       │  │ Configuration   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h2 data-id="heading-7">快速入门</h2>
<h3 data-id="heading-8">安装Mud.Feishu</h3>
<p>首先，我们需要安装Mud.Feishu组件库。可以通过NuGet包管理器进行安装：</p>
<pre><code class="hljs language-bash" lang="bash">dotnet add package Mud.Feishu
</code></pre>
<h3 data-id="heading-9">配置飞书应用</h3>
<p>在开始使用飞书API之前，您需要在飞书开放平台创建一个应用，并获取AppId和AppSecret。具体步骤如下：</p>
<ol>
<li>登录飞书开放平台（<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2F%3Flang%3Dzh-CN" target="_blank" title="https://open.feishu.cn/?lang=zh-CN" ref="nofollow noopener noreferrer">飞书开放平台</a>）</li>
<li>创建企业自建应用</li>
<li>获取AppId和AppSecret</li>
<li>配置应用权限，确保开通了所需的API权限</li>
</ol>
<h3 data-id="heading-10">配置服务注册</h3>
<p>在ASP.NET Core应用程序中，我们需要在Program.cs中注册飞书服务：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> builder = WebApplication.CreateBuilder(args);

<span class="hljs-comment">// 添加飞书服务</span>
builder.Services.AddFeishuApiService(<span class="hljs-string">"Feishu"</span>)
                .AddLogging(option =&gt; option.AddConsole());

<span class="hljs-keyword">var</span> app = builder.Build();
</code></pre>
<h3 data-id="heading-11">配置文件设置</h3>
<p>在appsettings.json中添加飞书配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Logging"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"LogLevel"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Default"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Microsoft.AspNetCore"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Warning"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"AllowedHosts"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Feishu"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"AppId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your_feishu_app_id"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"AppSecret"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your_feishu_app_secret"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"BaseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://open.feishu.cn"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-12">如何与ASP.NET Core集成</h2>
<p>Mud.Feishu组件设计时充分考虑了与ASP.NET Core的集成，通过依赖注入机制，我们可以轻松地在控制器中使用飞书API。</p>
<h3 data-id="heading-13">控制器注入示例</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;
<span class="hljs-keyword">using</span> Mud.Feishu;

[<span class="hljs-meta">ApiController</span>]
[<span class="hljs-meta">Route(<span class="hljs-string">"api/[controller]"</span>)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FeishuController</span> : <span class="hljs-title">ControllerBase</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IFeishuV3AuthenticationApi _authApi;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IFeishuV3UserApi _userApi;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IFeishuV3DepartmentsApi _departmentsApi;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IFeishuV3RoleApi _roleApi;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IFeishuV3JobLevelApi _jobLevelApi;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IFeishuV3JobTitleApi _jobTitleApi;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FeishuController</span>(<span class="hljs-params">
        IFeishuV3AuthenticationApi authApi, 
        IFeishuV3UserApi userApi,
        IFeishuV3DepartmentsApi departmentsApi,
        IFeishuV3RoleApi roleApi,
        IFeishuV3JobLevelApi jobLevelApi,
        IFeishuV3JobTitleApi jobTitleApi</span>)</span>
    {
        _authApi = authApi;
        _userApi = userApi;
        _departmentsApi = departmentsApi;
        _roleApi = roleApi;
        _jobLevelApi = jobLevelApi;
        _jobTitleApi = jobTitleApi;
    }
}
</code></pre>
<h3 data-id="heading-14">服务层使用示例</h3>
<p>除了在控制器中直接使用，我们也可以在服务层中使用飞书API：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">OrganizationService</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IFeishuV3DepartmentsApi _departmentsApi;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IFeishuV3UserApi _userApi;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ITokenManager _tokenManager;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OrganizationService</span>(<span class="hljs-params">
        IFeishuV3DepartmentsApi departmentsApi,
        IFeishuV3UserApi userApi,
        ITokenManager tokenManager</span>)</span>
    {
        _departmentsApi = departmentsApi;
        _userApi = userApi;
        _tokenManager = tokenManager;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">string</span>&gt; <span class="hljs-title">CreateDepartmentAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> departmentName, <span class="hljs-built_in">string</span> parentId</span>)</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-keyword">var</span> request = <span class="hljs-keyword">new</span> DepartmentCreateRequest
        {
            Name = departmentName,
            ParentDepartmentId = parentId
        };

        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _departmentsApi.CreateDepartmentAsync(token, request);
        <span class="hljs-keyword">return</span> result.Data.Department.Id;
    }
}
</code></pre>
<h2 data-id="heading-15">部门管理详解</h2>
<p>部门是组织架构的基本单位，在飞书平台中扮演着重要角色。通过部门管理，我们可以构建清晰的组织架构，便于人员管理和权限控制。</p>
<h3 data-id="heading-16">创建部门</h3>
<p>创建部门是组织管理的基础操作之一。飞书提供了完整的部门创建接口，支持设置部门名称、父部门、负责人等信息。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 创建部门示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">HttpPost(<span class="hljs-string">"departments"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">CreateDepartment</span>(<span class="hljs-params">[FromBody] DepartmentCreateRequest request</span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _departmentsApi.CreateDepartmentAsync(token, request);
        
        <span class="hljs-keyword">if</span> (result.Success)
        {
            <span class="hljs-keyword">return</span> Ok(<span class="hljs-keyword">new</span> { Id = result.Data.Department.Id, Message = <span class="hljs-string">"部门创建成功"</span> });
        }
        
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = result.Message });
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = ex.Message });
    }
}
</code></pre>
<h3 data-id="heading-17">更新部门信息</h3>
<p>随着组织发展，部门信息可能会发生变化，这时我们需要更新部门信息：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 更新部门信息示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">HttpPut(<span class="hljs-string">"departments/{departmentId}"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">UpdateDepartment</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> departmentId, [FromBody] DepartmentUpdateRequest request</span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _departmentsApi.UpdateDepartmentAsync(token, departmentId, request);
        
        <span class="hljs-keyword">if</span> (result.Success)
        {
            <span class="hljs-keyword">return</span> Ok(<span class="hljs-keyword">new</span> { Message = <span class="hljs-string">"部门信息更新成功"</span> });
        }
        
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = result.Message });
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = ex.Message });
    }
}
</code></pre>
<h3 data-id="heading-18">获取部门信息</h3>
<p>获取部门信息是日常管理中最频繁的操作之一：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 获取部门信息示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">HttpGet(<span class="hljs-string">"departments/{departmentId}"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">GetDepartment</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> departmentId</span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _departmentsApi.GetDepartmentInfoByIdAsync(token, departmentId);
        
        <span class="hljs-keyword">if</span> (result.Success)
        {
            <span class="hljs-keyword">return</span> Ok(result.Data.Department);
        }
        
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = result.Message });
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = ex.Message });
    }
}
</code></pre>
<h3 data-id="heading-19">获取子部门列表</h3>
<p>获取某个部门下的所有子部门：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 获取子部门列表示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">HttpGet(<span class="hljs-string">"departments/{departmentId}/children"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">GetSubDepartments</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> departmentId, <span class="hljs-built_in">bool</span> fetchChild = <span class="hljs-literal">false</span></span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _departmentsApi.GetDepartmentsByParentIdAsync(
            token, 
            departmentId, 
            fetchChild: fetchChild);
        
        <span class="hljs-keyword">if</span> (result.Success)
        {
            <span class="hljs-keyword">return</span> Ok(result.Data.Departments);
        }
        
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = result.Message });
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = ex.Message });
    }
}
</code></pre>
<h2 data-id="heading-20">用户管理详解</h2>
<p>用户是组织中的基本元素，用户管理是组织管理的核心组成部分。飞书提供了完善的用户管理API，支持用户的创建、更新、查询、删除等操作。</p>
<h3 data-id="heading-21">创建用户</h3>
<p>创建用户是用户管理中最基础的操作之一：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 创建用户示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">HttpPost(<span class="hljs-string">"users"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">CreateUser</span>(<span class="hljs-params">[FromBody] CreateUserRequest request</span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-comment">// 生成唯一的客户端令牌以防重复提交</span>
        <span class="hljs-keyword">var</span> clientToken = Guid.NewGuid().ToString();
        
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _userApi.CreateUserAsync(
            token, 
            request, 
            client_token: clientToken);
        
        <span class="hljs-keyword">if</span> (result.Success)
        {
            <span class="hljs-keyword">return</span> Ok(<span class="hljs-keyword">new</span> { UserId = result.Data.User.UserId, Message = <span class="hljs-string">"用户创建成功"</span> });
        }
        
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = result.Message });
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = ex.Message });
    }
}
</code></pre>
<h3 data-id="heading-22">更新用户信息</h3>
<p>更新用户信息以反映员工状态变化：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 更新用户信息示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">HttpPut(<span class="hljs-string">"users/{userId}"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">UpdateUser</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> userId, [FromBody] UpdateUserRequest request</span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _userApi.UpdateUser_Tenant_Async(token, userId, request);
        
        <span class="hljs-keyword">if</span> (result.Success)
        {
            <span class="hljs-keyword">return</span> Ok(<span class="hljs-keyword">new</span> { Message = <span class="hljs-string">"用户信息更新成功"</span> });
        }
        
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = result.Message });
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = ex.Message });
    }
}
</code></pre>
<h3 data-id="heading-23">查询用户信息</h3>
<p>获取特定用户的信息：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 获取用户信息示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">HttpGet(<span class="hljs-string">"users/{userId}"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">GetUser</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> userId</span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _userApi.GetUserInfoById_Tenant_Async(token, userId);
        
        <span class="hljs-keyword">if</span> (result.Success)
        {
            <span class="hljs-keyword">return</span> Ok(result.Data.User);
        }
        
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = result.Message });
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = ex.Message });
    }
}
</code></pre>
<h3 data-id="heading-24">删除用户</h3>
<p>当员工离职时，需要将其从组织架构中移除：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 删除用户示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">HttpDelete(<span class="hljs-string">"users/{userId}"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">DeleteUser</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> userId, [FromBody] DeleteSettingsRequest request</span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _userApi.DeleteUserByIdAsync(token, userId, request);
        
        <span class="hljs-keyword">if</span> (result.Success)
        {
            <span class="hljs-keyword">return</span> Ok(<span class="hljs-keyword">new</span> { Message = <span class="hljs-string">"用户删除成功"</span> });
        }
        
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = result.Message });
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = ex.Message });
    }
}
</code></pre>
<h2 data-id="heading-25">用户角色管理详解</h2>
<p>角色管理是权限控制系统的重要组成部分。通过为用户分配不同的角色，可以实现细粒度的权限控制。</p>
<h3 data-id="heading-26">创建角色</h3>
<p>创建一个新的角色：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 创建角色示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">HttpPost(<span class="hljs-string">"roles"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">CreateRole</span>(<span class="hljs-params">[FromBody] RoleRequest request</span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _roleApi.CreateRoleAsync(token, request);
        
        <span class="hljs-keyword">if</span> (result.Success)
        {
            <span class="hljs-keyword">return</span> Ok(<span class="hljs-keyword">new</span> { RoleId = result.Data.Role.Id, Message = <span class="hljs-string">"角色创建成功"</span> });
        }
        
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = result.Message });
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = ex.Message });
    }
}
</code></pre>
<h3 data-id="heading-27">更新角色</h3>
<p>更新角色信息：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 更新角色示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">HttpPut(<span class="hljs-string">"roles/{roleId}"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">UpdateRole</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> roleId, [FromBody] RoleRequest request</span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _roleApi.UpdateRoleAsync(token, roleId, request);
        
        <span class="hljs-keyword">if</span> (result.Success)
        {
            <span class="hljs-keyword">return</span> Ok(<span class="hljs-keyword">new</span> { Message = <span class="hljs-string">"角色更新成功"</span> });
        }
        
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = result.Message });
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = ex.Message });
    }
}
</code></pre>
<h3 data-id="heading-28">删除角色</h3>
<p>删除不再需要的角色：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 删除角色示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">HttpDelete(<span class="hljs-string">"roles/{roleId}"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">DeleteRole</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> roleId</span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _roleApi.DeleteRoleByIdAsync(token, roleId);
        
        <span class="hljs-keyword">if</span> (result.Success)
        {
            <span class="hljs-keyword">return</span> Ok(<span class="hljs-keyword">new</span> { Message = <span class="hljs-string">"角色删除成功"</span> });
        }
        
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = result.Message });
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = ex.Message });
    }
}
</code></pre>
<h2 data-id="heading-29">职级管理详解</h2>
<p>职级是组织中表示员工层级关系的重要概念，通过职级管理可以建立清晰的晋升通道。</p>
<h3 data-id="heading-30">创建职级</h3>
<p>创建新的职级：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 创建职级示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">HttpPost(<span class="hljs-string">"joblevels"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">CreateJobLevel</span>(<span class="hljs-params">[FromBody] JobLevelCreateUpdateRequest request</span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _jobLevelApi.CreateJobLevelAsync(token, request);
        
        <span class="hljs-keyword">if</span> (result.Success)
        {
            <span class="hljs-keyword">return</span> Ok(<span class="hljs-keyword">new</span> { JobLevelId = result.Data.JobLevel.Id, Message = <span class="hljs-string">"职级创建成功"</span> });
        }
        
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = result.Message });
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = ex.Message });
    }
}
</code></pre>
<h3 data-id="heading-31">更新职级</h3>
<p>更新职级信息：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 更新职级示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">HttpPut(<span class="hljs-string">"joblevels/{jobLevelId}"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">UpdateJobLevel</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> jobLevelId, [FromBody] JobLevelCreateUpdateRequest request</span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _jobLevelApi.UpdateJobLevelAsync(token, jobLevelId, request);
        
        <span class="hljs-keyword">if</span> (result.Success)
        {
            <span class="hljs-keyword">return</span> Ok(<span class="hljs-keyword">new</span> { Message = <span class="hljs-string">"职级更新成功"</span> });
        }
        
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = result.Message });
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = ex.Message });
    }
}
</code></pre>
<h3 data-id="heading-32">获取职级信息</h3>
<p>获取特定职级的信息：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 获取职级信息示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">HttpGet(<span class="hljs-string">"joblevels/{jobLevelId}"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">GetJobLevel</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> jobLevelId</span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _jobLevelApi.GetJobLevelByIdAsync(token, jobLevelId);
        
        <span class="hljs-keyword">if</span> (result.Success)
        {
            <span class="hljs-keyword">return</span> Ok(result.Data.JobLevel);
        }
        
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = result.Message });
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = ex.Message });
    }
}
</code></pre>
<h3 data-id="heading-33">删除职级</h3>
<p>删除不再使用的职级：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 删除职级示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">HttpDelete(<span class="hljs-string">"joblevels/{jobLevelId}"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">DeleteJobLevel</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> jobLevelId</span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _jobLevelApi.DeleteJobLevelByIdAsync(token, jobLevelId);
        
        <span class="hljs-keyword">if</span> (result.Success)
        {
            <span class="hljs-keyword">return</span> Ok(<span class="hljs-keyword">new</span> { Message = <span class="hljs-string">"职级删除成功"</span> });
        }
        
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = result.Message });
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = ex.Message });
    }
}
</code></pre>
<h2 data-id="heading-34">职位管理详解</h2>
<p>职位是对员工在组织中承担的具体工作的描述，通过职位管理可以明确员工职责。</p>
<h3 data-id="heading-35">获取职位列表</h3>
<p>获取当前租户下的职位列表：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 获取职位列表示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">HttpGet(<span class="hljs-string">"jobtitles"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">GetJobTitles</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> pageSize = <span class="hljs-number">10</span>, <span class="hljs-built_in">string</span>? pageToken = <span class="hljs-literal">null</span></span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _jobTitleApi.GetTenantJobTitlesListAsync(token, pageSize, pageToken);
        
        <span class="hljs-keyword">if</span> (result.Success)
        {
            <span class="hljs-keyword">return</span> Ok(result.Data.JobTitles);
        }
        
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = result.Message });
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = ex.Message });
    }
}
</code></pre>
<h3 data-id="heading-36">获取特定职位信息</h3>
<p>获取特定职位的详细信息：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 获取职位信息示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">HttpGet(<span class="hljs-string">"jobtitles/{jobTitleId}"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">GetJobTitle</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> jobTitleId</span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _jobTitleApi.GetTenantJobTitleByIdAsync(token, jobTitleId);
        
        <span class="hljs-keyword">if</span> (result.Success)
        {
            <span class="hljs-keyword">return</span> Ok(result.Data.JobTitle);
        }
        
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = result.Message });
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = ex.Message });
    }
}
</code></pre>
<h2 data-id="heading-37">完整示例</h2>
<p>以下是一个综合性的、贴近真实场景的代码示例，展示如何使用Mud.Feishu组件进行完整的组织管理操作：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;
<span class="hljs-keyword">using</span> Mud.Feishu;
<span class="hljs-keyword">using</span> Mud.Feishu.DataModels.Departments.RequestModel;
<span class="hljs-keyword">using</span> Mud.Feishu.DataModels.Employees.RequestModel;
<span class="hljs-keyword">using</span> Mud.Feishu.DataModels.JobLevel;
<span class="hljs-keyword">using</span> Mud.Feishu.DataModels.Roles;
<span class="hljs-keyword">using</span> Mud.Feishu.DataModels.Users;

<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 组织管理综合示例</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 演示如何使用Mud.Feishu进行完整的组织管理操作</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
[<span class="hljs-meta">ApiController</span>]
[<span class="hljs-meta">Route(<span class="hljs-string">"api/[controller]"</span>)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">OrganizationManagementController</span> : <span class="hljs-title">ControllerBase</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IFeishuV3DepartmentsApi _departmentsApi;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IFeishuV3UserApi _userApi;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IFeishuV3RoleApi _roleApi;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IFeishuV3JobLevelApi _jobLevelApi;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IFeishuV3JobTitleApi _jobTitleApi;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ITokenManager _tokenManager;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OrganizationManagementController</span>(<span class="hljs-params">
        IFeishuV3DepartmentsApi departmentsApi,
        IFeishuV3UserApi userApi,
        IFeishuV3RoleApi roleApi,
        IFeishuV3JobLevelApi jobLevelApi,
        IFeishuV3JobTitleApi jobTitleApi,
        ITokenManager tokenManager</span>)</span>
    {
        _departmentsApi = departmentsApi;
        _userApi = userApi;
        _roleApi = roleApi;
        _jobLevelApi = jobLevelApi;
        _jobTitleApi = jobTitleApi;
        _tokenManager = tokenManager;
    }

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 初始化组织架构示例</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 创建部门、职位、职级、角色等基础数据</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    [<span class="hljs-meta">HttpPost(<span class="hljs-string">"initialize"</span>)</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">InitializeOrganization</span>()</span>
    {
        <span class="hljs-keyword">try</span>
        {
            <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
            
            <span class="hljs-comment">// 1. 创建根部门 - 公司</span>
            <span class="hljs-keyword">var</span> companyRequest = <span class="hljs-keyword">new</span> DepartmentCreateRequest
            {
                Name = <span class="hljs-string">"某某科技有限公司"</span>,
                ParentDepartmentId = <span class="hljs-string">"0"</span>, <span class="hljs-comment">// 根部门</span>
                LeaderUserId = <span class="hljs-string">""</span>
            };
            
            <span class="hljs-keyword">var</span> companyResult = <span class="hljs-keyword">await</span> _departmentsApi.CreateDepartmentAsync(token, companyRequest);
            <span class="hljs-keyword">if</span> (!companyResult.Success)
            {
                <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = <span class="hljs-string">$"创建公司部门失败: <span class="hljs-subst">{companyResult.Message}</span>"</span> });
            }
            
            <span class="hljs-keyword">var</span> companyId = companyResult.Data.Department.Id;
            
            <span class="hljs-comment">// 2. 创建子部门</span>
            <span class="hljs-keyword">var</span> departments = <span class="hljs-keyword">new</span>[]
            {
                <span class="hljs-keyword">new</span> { Name = <span class="hljs-string">"技术部"</span>, ParentId = companyId },
                <span class="hljs-keyword">new</span> { Name = <span class="hljs-string">"产品部"</span>, ParentId = companyId },
                <span class="hljs-keyword">new</span> { Name = <span class="hljs-string">"市场部"</span>, ParentId = companyId },
                <span class="hljs-keyword">new</span> { Name = <span class="hljs-string">"人事部"</span>, ParentId = companyId }
            };
            
            <span class="hljs-keyword">var</span> departmentIds = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;();
            
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> dept <span class="hljs-keyword">in</span> departments)
            {
                <span class="hljs-keyword">var</span> deptRequest = <span class="hljs-keyword">new</span> DepartmentCreateRequest
                {
                    Name = dept.Name,
                    ParentDepartmentId = dept.ParentId
                };
                
                <span class="hljs-keyword">var</span> deptResult = <span class="hljs-keyword">await</span> _departmentsApi.CreateDepartmentAsync(token, deptRequest);
                <span class="hljs-keyword">if</span> (deptResult.Success)
                {
                    departmentIds[dept.Name] = deptResult.Data.Department.Id;
                }
                <span class="hljs-keyword">else</span>
                {
                    <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = <span class="hljs-string">$"创建部门 <span class="hljs-subst">{dept.Name}</span> 失败: <span class="hljs-subst">{deptResult.Message}</span>"</span> });
                }
            }
            
            <span class="hljs-comment">// 3. 创建职级</span>
            <span class="hljs-keyword">var</span> jobLevels = <span class="hljs-keyword">new</span>[]
            {
                <span class="hljs-keyword">new</span> { Name = <span class="hljs-string">"初级工程师"</span>, Level = <span class="hljs-number">1</span> },
                <span class="hljs-keyword">new</span> { Name = <span class="hljs-string">"中级工程师"</span>, Level = <span class="hljs-number">2</span> },
                <span class="hljs-keyword">new</span> { Name = <span class="hljs-string">"高级工程师"</span>, Level = <span class="hljs-number">3</span> },
                <span class="hljs-keyword">new</span> { Name = <span class="hljs-string">"技术专家"</span>, Level = <span class="hljs-number">4</span> },
                <span class="hljs-keyword">new</span> { Name = <span class="hljs-string">"首席技术官"</span>, Level = <span class="hljs-number">5</span> }
            };
            
            <span class="hljs-keyword">var</span> jobLevelIds = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;();
            
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> jl <span class="hljs-keyword">in</span> jobLevels)
            {
                <span class="hljs-keyword">var</span> jobLevelRequest = <span class="hljs-keyword">new</span> JobLevelCreateUpdateRequest
                {
                    Name = jl.Name,
                    Level = jl.Level,
                    Description = <span class="hljs-string">$"<span class="hljs-subst">{jl.Name}</span>职级描述"</span>
                };
                
                <span class="hljs-keyword">var</span> jobLevelResult = <span class="hljs-keyword">await</span> _jobLevelApi.CreateJobLevelAsync(token, jobLevelRequest);
                <span class="hljs-keyword">if</span> (jobLevelResult.Success)
                {
                    jobLevelIds[jl.Name] = jobLevelResult.Data.JobLevel.Id;
                }
                <span class="hljs-keyword">else</span>
                {
                    <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = <span class="hljs-string">$"创建职级 <span class="hljs-subst">{jl.Name}</span> 失败: <span class="hljs-subst">{jobLevelResult.Message}</span>"</span> });
                }
            }
            
            <span class="hljs-comment">// 4. 创建角色</span>
            <span class="hljs-keyword">var</span> roles = <span class="hljs-keyword">new</span>[]
            {
                <span class="hljs-keyword">new</span> { Name = <span class="hljs-string">"管理员"</span>, Description = <span class="hljs-string">"系统管理员"</span> },
                <span class="hljs-keyword">new</span> { Name = <span class="hljs-string">"部门经理"</span>, Description = <span class="hljs-string">"部门负责人"</span> },
                <span class="hljs-keyword">new</span> { Name = <span class="hljs-string">"普通员工"</span>, Description = <span class="hljs-string">"一般员工"</span> }
            };
            
            <span class="hljs-keyword">var</span> roleIds = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;();
            
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> r <span class="hljs-keyword">in</span> roles)
            {
                <span class="hljs-keyword">var</span> roleRequest = <span class="hljs-keyword">new</span> RoleRequest
                {
                    RoleName = r.Name,
                    DisplayName = r.Description
                };
                
                <span class="hljs-keyword">var</span> roleResult = <span class="hljs-keyword">await</span> _roleApi.CreateRoleAsync(token, roleRequest);
                <span class="hljs-keyword">if</span> (roleResult.Success)
                {
                    roleIds[r.Name] = roleResult.Data.Role.Id;
                }
                <span class="hljs-keyword">else</span>
                {
                    <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = <span class="hljs-string">$"创建角色 <span class="hljs-subst">{r.Name}</span> 失败: <span class="hljs-subst">{roleResult.Message}</span>"</span> });
                }
            }
            
            <span class="hljs-comment">// 5. 创建一些示例用户</span>
            <span class="hljs-keyword">var</span> users = <span class="hljs-keyword">new</span>[]
            {
                <span class="hljs-keyword">new</span> { Name = <span class="hljs-string">"张三"</span>, Department = <span class="hljs-string">"技术部"</span>, JobLevel = <span class="hljs-string">"高级工程师"</span>, Role = <span class="hljs-string">"管理员"</span>, Mobile = <span class="hljs-string">"13800138001"</span> },
                <span class="hljs-keyword">new</span> { Name = <span class="hljs-string">"李四"</span>, Department = <span class="hljs-string">"产品部"</span>, JobLevel = <span class="hljs-string">"中级工程师"</span>, Role = <span class="hljs-string">"部门经理"</span>, Mobile = <span class="hljs-string">"13800138002"</span> },
                <span class="hljs-keyword">new</span> { Name = <span class="hljs-string">"王五"</span>, Department = <span class="hljs-string">"市场部"</span>, JobLevel = <span class="hljs-string">"初级工程师"</span>, Role = <span class="hljs-string">"普通员工"</span>, Mobile = <span class="hljs-string">"13800138003"</span> }
            };
            
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> u <span class="hljs-keyword">in</span> users)
            {
                <span class="hljs-keyword">var</span> userRequest = <span class="hljs-keyword">new</span> CreateUserRequest
                {
                    Name = u.Name,
                    Mobile = u.Mobile,
                    DepartmentIds = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt; { departmentIds[u.Department] },
                    JobLevelId = jobLevelIds[u.JobLevel],
                    EmployeeType = <span class="hljs-number">1</span> <span class="hljs-comment">// 正式员工</span>
                };
                
                <span class="hljs-keyword">var</span> clientToken = Guid.NewGuid().ToString();
                <span class="hljs-keyword">var</span> userResult = <span class="hljs-keyword">await</span> _userApi.CreateUserAsync(token, userRequest, client_token: clientToken);
                <span class="hljs-keyword">if</span> (!userResult.Success)
                {
                    <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = <span class="hljs-string">$"创建用户 <span class="hljs-subst">{u.Name}</span> 失败: <span class="hljs-subst">{userResult.Message}</span>"</span> });
                }
            }
            
            <span class="hljs-keyword">return</span> Ok(<span class="hljs-keyword">new</span> 
            { 
                Message = <span class="hljs-string">"组织架构初始化成功"</span>,
                Departments = departmentIds,
                JobLevels = jobLevelIds,
                Roles = roleIds
            });
        }
        <span class="hljs-keyword">catch</span> (Exception ex)
        {
            <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = <span class="hljs-string">$"初始化组织架构时发生错误: <span class="hljs-subst">{ex.Message}</span>"</span> });
        }
    }

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 添加新员工示例</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    [<span class="hljs-meta">HttpPost(<span class="hljs-string">"employees"</span>)</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">AddEmployee</span>(<span class="hljs-params">[FromBody] EmployeeCreateRequest request</span>)</span>
    {
        <span class="hljs-keyword">try</span>
        {
            <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
            
            <span class="hljs-comment">// 创建用户</span>
            <span class="hljs-keyword">var</span> userRequest = <span class="hljs-keyword">new</span> CreateUserRequest
            {
                Name = request.Name,
                Mobile = request.Mobile,
                Email = request.Email,
                DepartmentIds = request.DepartmentIds,
                JobLevelId = request.JobLevelId,
                EmployeeType = request.EmployeeType,
                JoinTime = request.JoinTime
            };
            
            <span class="hljs-keyword">var</span> clientToken = Guid.NewGuid().ToString();
            <span class="hljs-keyword">var</span> userResult = <span class="hljs-keyword">await</span> _userApi.CreateUserAsync(token, userRequest, client_token: clientToken);
            
            <span class="hljs-keyword">if</span> (userResult.Success)
            {
                <span class="hljs-keyword">return</span> Ok(<span class="hljs-keyword">new</span> 
                { 
                    UserId = userResult.Data.User.UserId, 
                    Message = <span class="hljs-string">"员工添加成功"</span> 
                });
            }
            
            <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = <span class="hljs-string">$"添加员工失败: <span class="hljs-subst">{userResult.Message}</span>"</span> });
        }
        <span class="hljs-keyword">catch</span> (Exception ex)
        {
            <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = <span class="hljs-string">$"添加员工时发生错误: <span class="hljs-subst">{ex.Message}</span>"</span> });
        }
    }

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 获取组织架构树示例</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    [<span class="hljs-meta">HttpGet(<span class="hljs-string">"structure"</span>)</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">GetOrganizationStructure</span>()</span>
    {
        <span class="hljs-keyword">try</span>
        {
            <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">await</span> _tokenManager.GetTokenAsync();
            
            <span class="hljs-comment">// 获取根部门</span>
            <span class="hljs-keyword">var</span> rootDepartments = <span class="hljs-keyword">await</span> _departmentsApi.GetDepartmentsByParentIdAsync(token, <span class="hljs-string">"0"</span>);
            <span class="hljs-keyword">if</span> (!rootDepartments.Success)
            {
                <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = <span class="hljs-string">$"获取根部门失败: <span class="hljs-subst">{rootDepartments.Message}</span>"</span> });
            }
            
            <span class="hljs-keyword">var</span> structure = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">object</span>&gt;();
            
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> rootDept <span class="hljs-keyword">in</span> rootDepartments.Data.Departments)
            {
                <span class="hljs-keyword">var</span> deptStructure = <span class="hljs-keyword">await</span> BuildDepartmentStructure(token, rootDept.Id);
                structure.Add(deptStructure);
            }
            
            <span class="hljs-keyword">return</span> Ok(structure);
        }
        <span class="hljs-keyword">catch</span> (Exception ex)
        {
            <span class="hljs-keyword">return</span> BadRequest(<span class="hljs-keyword">new</span> { Error = <span class="hljs-string">$"获取组织架构时发生错误: <span class="hljs-subst">{ex.Message}</span>"</span> });
        }
    }
    
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 递归构建部门结构树</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">object</span>&gt; <span class="hljs-title">BuildDepartmentStructure</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> token, <span class="hljs-built_in">string</span> departmentId</span>)</span>
    {
        <span class="hljs-keyword">var</span> deptInfo = <span class="hljs-keyword">await</span> _departmentsApi.GetDepartmentInfoByIdAsync(token, departmentId);
        <span class="hljs-keyword">if</span> (!deptInfo.Success)
        {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> { Error = <span class="hljs-string">$"获取部门信息失败: <span class="hljs-subst">{deptInfo.Message}</span>"</span> };
        }
        
        <span class="hljs-keyword">var</span> dept = deptInfo.Data.Department;
        
        <span class="hljs-comment">// 获取子部门</span>
        <span class="hljs-keyword">var</span> childDepts = <span class="hljs-keyword">await</span> _departmentsApi.GetDepartmentsByParentIdAsync(token, departmentId, fetchChild: <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">var</span> children = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">object</span>&gt;();
        
        <span class="hljs-keyword">if</span> (childDepts.Success)
        {
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> child <span class="hljs-keyword">in</span> childDepts.Data.Departments)
            {
                <span class="hljs-keyword">var</span> childStructure = <span class="hljs-keyword">await</span> BuildDepartmentStructure(token, child.Id);
                children.Add(childStructure);
            }
        }
        
        <span class="hljs-comment">// 获取部门成员</span>
        <span class="hljs-keyword">var</span> members = <span class="hljs-keyword">await</span> _userApi.GetUserByDepartmentId_Tenant_Async(token, departmentId);
        <span class="hljs-keyword">var</span> memberList = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">object</span>&gt;();
        
        <span class="hljs-keyword">if</span> (members.Success)
        {
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> member <span class="hljs-keyword">in</span> members.Data.Items)
            {
                memberList.Add(<span class="hljs-keyword">new</span> 
                {
                    UserId = member.UserId,
                    Name = member.Name,
                    Mobile = member.Mobile
                });
            }
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> 
        {
            Id = dept.Id,
            Name = dept.Name,
            Children = children,
            Members = memberList
        };
    }
}
</code></pre>
<h3 data-id="heading-38">使用示例</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 在Program.cs中注册服务</span>
<span class="hljs-keyword">var</span> builder = WebApplication.CreateBuilder(args);

<span class="hljs-comment">// 添加控制器</span>
builder.Services.AddControllers();

<span class="hljs-comment">// 添加飞书服务</span>
builder.Services.AddFeishuApiService(<span class="hljs-string">"Feishu"</span>)
                .AddLogging(option =&gt; option.AddConsole());

<span class="hljs-comment">// 注册Swagger（仅用于演示）</span>
builder.Services.AddSwaggerGen();

<span class="hljs-keyword">var</span> app = builder.Build();

<span class="hljs-comment">// 配置管道</span>
<span class="hljs-keyword">if</span> (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();
app.UseAuthorization();
app.MapControllers();

app.Run();
</code></pre>
<h3 data-id="heading-39">配置文件示例</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Logging"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"LogLevel"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Default"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Microsoft.AspNetCore"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Warning"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"AllowedHosts"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Feishu"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"AppId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your_feishu_app_id"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"AppSecret"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your_feishu_app_secret"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"BaseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://open.feishu.cn"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-40">最佳实践</h2>
<h3 data-id="heading-41">安全性考虑</h3>
<ol>
<li><strong>令牌管理</strong>: 妥善保管访问令牌，避免泄露</li>
<li><strong>权限控制</strong>: 遵循最小权限原则，只授予必要的操作权限</li>
<li><strong>审计日志</strong>: 记录所有组织管理操作，便于追踪和审计</li>
</ol>
<h3 data-id="heading-42">错误处理</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">try</span> 
{
    <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> feishuUserApi.CreateUserAsync(token, userRequest);
    <span class="hljs-keyword">if</span> (!result.Success) 
    {
        <span class="hljs-comment">// 处理API错误</span>
        Console.WriteLine(<span class="hljs-string">$"创建用户失败: <span class="hljs-subst">{result.Message}</span>"</span>);
    }
}
<span class="hljs-keyword">catch</span> (FeishuException ex)
{
    <span class="hljs-comment">// 处理飞书特定异常</span>
    Console.WriteLine(<span class="hljs-string">$"飞书API异常: <span class="hljs-subst">{ex.Message}</span>"</span>);
}
<span class="hljs-keyword">catch</span> (Exception ex)
{
    <span class="hljs-comment">// 处理其他异常</span>
    Console.WriteLine(<span class="hljs-string">$"未知异常: <span class="hljs-subst">{ex.Message}</span>"</span>);
}
</code></pre>
<h3 data-id="heading-43">批量操作优化</h3>
<p>对于大量组织操作，应该采用批量处理方式以提高效率：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 批量获取用户信息示例</span>
<span class="hljs-keyword">var</span> userIds = <span class="hljs-keyword">new</span>[] { <span class="hljs-string">"user1"</span>, <span class="hljs-string">"user2"</span>, <span class="hljs-string">"user3"</span> };
<span class="hljs-keyword">var</span> batchResult = <span class="hljs-keyword">await</span> feishuUserApi.GetUserByIds_Tenant_Async(token, userIds);

<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> userInfo <span class="hljs-keyword">in</span> batchResult.Data.Users)
{
    <span class="hljs-comment">// 处理每个用户信息</span>
    ProcessUserInfo(userInfo);
}
</code></pre>
<h3 data-id="heading-44">数据验证</h3>
<p>在执行组织管理操作前，应对输入数据进行充分验证：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">OrganizationValidator</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">ValidateDepartment</span>(<span class="hljs-params">DepartmentCreateRequest department</span>)</span>
    {
        <span class="hljs-comment">// 验证必要字段</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(department.Name))
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">"部门名称不能为空"</span>);
            
        <span class="hljs-comment">// 验证父部门ID</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(department.ParentDepartmentId))
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">"父部门ID不能为空"</span>);
            
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">ValidateUser</span>(<span class="hljs-params">CreateUserRequest user</span>)</span>
    {
        <span class="hljs-comment">// 验证必要字段</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(user.Name))
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">"用户名不能为空"</span>);
            
        <span class="hljs-comment">// 验证手机号或邮箱</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(user.Mobile) &amp;&amp; <span class="hljs-built_in">string</span>.IsNullOrEmpty(user.Email))
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">"手机号和邮箱至少需要填写一项"</span>);
            
        <span class="hljs-comment">// 验证部门ID</span>
        <span class="hljs-keyword">if</span> (user.DepartmentIds == <span class="hljs-literal">null</span> || user.DepartmentIds.Count == <span class="hljs-number">0</span>)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">"用户必须至少属于一个部门"</span>);
            
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h2 data-id="heading-45">附录</h2>
<h3 data-id="heading-46">A. 相关资源</h3>
<ul>
<li><strong>Mud.Feishu 仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fmudtools%2FMudFeishu" target="_blank" title="https://gitee.com/mudtools/MudFeishu" ref="nofollow noopener noreferrer">gitee.com/mudtools/Mu…</a></li>
<li><strong>飞书开放平台文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2Fdocument%2F" target="_blank" title="https://open.feishu.cn/document/" ref="nofollow noopener noreferrer">open.feishu.cn/document/</a></li>
<li><strong>.NET 官方文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.microsoft.com%2Fdotnet%2F" target="_blank" title="https://docs.microsoft.com/dotnet/" ref="nofollow noopener noreferrer">docs.microsoft.com/dotnet/</a></li>
</ul>
<h3 data-id="heading-47">B. 版本</h3>

















<table><thead><tr><th>Mud.Feishu 版本</th><th>.NET 版本</th><th>飞书 API 版本</th><th>发布日期</th></tr></thead><tbody><tr><td>1.0.0</td><td>.NET 8.0/9.0/10.0</td><td>v3</td><td>2025-11-19</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LeCun在Meta的最后绝唱？50行代码证明AI的另一种可能]]></title>    <link>https://juejin.cn/post/7574584245110456371</link>    <guid>https://juejin.cn/post/7574584245110456371</guid>    <pubDate>2025-11-20T02:43:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574584245110456371" data-draft-id="7574584245110374451" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LeCun在Meta的最后绝唱？50行代码证明AI的另一种可能"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-11-20T02:43:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LeCun在Meta的最后绝唱？50行代码证明AI的另一种可能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T02:43:52.000Z" title="Thu Nov 20 2025 02:43:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>就在AI界为Yann LeCun离职Meta的消息震惊时，一份意外的“告别礼物”悄然出现在arXiv上——这位图灵奖得主与Randall Balestriero合作的新论文 <strong>《LeJEPA：一种简约且可扩展的联合嵌入预测架构》</strong> ，提出了仅需50行代码的自监督学习新框架。</p>
<p>这或许是LeCun在Meta的最后一篇论文。</p>
<ul>
<li><strong>论文地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2511.08544" target="_blank" title="https://arxiv.org/pdf/2511.08544" ref="nofollow noopener noreferrer">arxiv.org/pdf/2511.08…</a></li>
<li><strong>论文名称：</strong> LeJEPA: Provable and Scalable Self-Supervised Learning Without the Heuristics</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b0797bb9f37444d99b1960bd2872e8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211432&amp;x-signature=VvN3X0BbqH2YhSQKyVFswX2o1Ic%3D" alt="图片1.png" loading="lazy"/></p>
<p>2025年7月，Meta做出令人意外的任命——28岁的Scale AI创始人Alexandr Wang成为首席AI官，职位高于LeCun。这一决定在AI圈引起轩然大波。仅仅一个月后，前谷歌大脑研究员赵晟佳被任命为超级智能实验室首席科学家，LeCun在Meta的决策权被进一步削弱。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/964bbb8fee8c4d6c952e26388a2cfa18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211432&amp;x-signature=YzZ6TzlBLEKD5PzDtf7j0FUyQZ4%3D" alt="图片2.png" loading="lazy"/></p>
<p>权力结构的调整在10月达到高潮：LeCun领导的FAIR实验室裁员600余人，其中包括核心研究员田渊栋。这支曾经开创了卷积神经网络等突破性技术的团队，如今面临大幅缩编。</p>
<p>“FAIR正在被边缘化，这已经不是什么秘密了。”一位前Meta员工透露，“当扎克伯格把赌注都压在LLM上时，LeCun的世界模型研究就失去了内部支持。”</p>
<p>LeCun与Meta管理层的分歧早已不是秘密。这位AI先驱多次公开批评大语言模型是“死胡同”，无法实现真正的智能。他主张开发能够通过感知数据学习物理规律的“世界模型”。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6f4f94b9b5a4b62aaf24d0678f274bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211432&amp;x-signature=hbgj56HVQB2lmVFvj5WqrW948Xk%3D" alt="图片3.png" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>新框架LeJEPA：仅50行代码的简洁解决方案</strong></h2>
<p>这篇由LeCun与Randall Balestriero合作的论文，提出了一种名为LeJEPA的新框架，旨在解决当前联合嵌入预测架构方法中存在的多种失效模式。</p>
<p>JEPA方法由于缺乏明确的实践指南和系统理论，目前相关研究大多是临时性探索。而这篇论文给出了一套完整的JEPA理论，并将其具体落地为LeJEPA——一种轻量、可扩展且有坚实理论基础的训练目标。</p>
<p>研究人员证明，若要最小化下游任务的预测风险，JEPA的嵌入理想情况下应服从各向同性高斯分布。为此，他们提出了新的目标函数SIGReg，用于约束嵌入向该理想分布收敛。</p>
<p>LeJEPA融合了JEPA和SIGReg思想，兼具多方面的理论和实践优势：</p>
<ul>
<li>只需要一个权衡超参数</li>
<li>时间与内存复杂度均为线性</li>
<li>在超参数、架构以及不同领域之间表现稳定</li>
<li>不依赖启发式技巧，适合分布式训练</li>
<li>仅需约50行代码即可实现</li>
</ul>
<p>如图1所示，在使用ImageNet-1K进行预训练并对冻结骨干网络做线性评估的设定下，LeJEPA在ViT-H/14上可达到79%的精度，表现出色。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd23d88bd4f04610a6cfcdb4e2a17338~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211432&amp;x-signature=LmSkHt2OwrsGG7ws27AviVGcYsg%3D" alt="图片4.png" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>自监督学习的核心挑战与LeJEPA的解决路径</strong></h2>
<p>在AI领域，一个长期存在的核心问题是让模型学会对世界及其变化形成可用于实际决策的表征。</p>
<p>无论是图像识别、机器人，还是物理学、太空探索，都会面临一个共同问题：如何仅凭观测数据，学习到一个结构清晰、便于操作的高维嵌入空间？</p>
<p>使用深度网络将观测映射到嵌入是解决这一难题的标准第一步。第二步，也是尚未标准化的部分，是如何训练这些网络参数。</p>
<p>JEPA提出一条路径：通过最大化语义相关视图的嵌入之间的一致性预测来训练网络。这些“视图”可以包括掩码、裁剪、模糊、时间或空间平移等多种变换操作。然而，JEPA的预测任务存在一些失败模式，例如表征崩溃——网络将所有输入映射到几乎相同的嵌入（完全崩溃），或只落在低维子空间上（维度崩溃）。</p>
<p>有关JEPA的理论基础研究在很大程度上仍处于空白状态，而LeCun的这项研究正是要打破这一循环。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74b94a25e7c14327a38aa2ea5d4a24e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211432&amp;x-signature=zeCgixpruH2eZyWXw74u0b0b6iE%3D" alt="图片5.png" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>理论基础：各向同性高斯分布是最优嵌入</strong></h2>
<p>研究人员通过重新审视支撑JEPA的基础设计原则，提炼出一种全新且精简的JEPA“原则”：解决预测任务，同时强制嵌入服从各向同性高斯分布。</p>
<p>他们证明，为了在任意下游任务上最小化经验风险，嵌入应该服从各向同性高斯分布。</p>
<p>研究人员首先通过分析线性探针来确定嵌入的最优分布，这是评估冻结编码器时最常用的方法之一。</p>
<p>为了对预训练编码器进行更灵活的评估，研究人员还分析了两类广泛使用的非线性方法：基于半径的k-NN方法和核方法。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7d4761b23944700bf27d0c0fdf23f11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211432&amp;x-signature=HKTWdknqil8AyV%2FpDuSug8I46Bc%3D" alt="图片6.png" loading="lazy"/></p>
<p>上图展示了各向异性嵌入如何比各向同性嵌入产生更高的方差估计值。研究人员对二分类任务抽取了100个训练点，并拟合逻辑回归模型——在多个训练集样本上重复此过程。每次抽样都会产生一个决策边界。</p>
<h2 data-id="heading-3"><strong>SIGReg：高维空间中的高斯正则化</strong></h2>
<p>在证明各向同性高斯分布是最优嵌入分布之后，研究人员引入了SIGReg——一个同时具有可微性、可扩展性、理论可证明性以及可解释性的分布匹配目标函数。</p>
<p>它建立在三个关键创新之上：</p>
<p>首先，研究人员将分布匹配表述为在原假设下的统计假设检验；</p>
<p>其次，构造了一类检验，在保持线性复杂度和高效多GPU扩展的同时，保证梯度和曲率均有界。</p>
<p>第三，SIGReg避免了维度灾难，从而彻底消除了退化的捷径解。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1894429d5f1e4b0b9cbdb360ea1d9d0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211432&amp;x-signature=THZ1DWQqRHEE%2BmnvKRhEDqe8NoE%3D" alt="图片7.png" loading="lazy"/></p>
<p>图4展示了具有不同Sobolev平滑系数α的球面上分布示例。由于目标密度（各向同性高斯分布）是平滑的，嵌入的α系数会迅速增长，从而使SIGReg不受维度灾难的影响。</p>
<p>研究人员证明，SIGReg绘制Epps-Pulley测试图是稳定且可扩展的。</p>
<p>图5显示了构建的数据密度图。其“X”分布的边缘分布为标准高斯分布，协方差为单位矩阵。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2337105c5c54b0a908cea13d6747210~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211432&amp;x-signature=muXI961URoNVZadZ9nOs8i5fSSQ%3D" alt="图片8.png" loading="lazy"/></p>
<p>图6展示了从一个1024维标准高斯分布中抽取100个样本，并改变前两个坐标以生成“X”分布。对于每个统计量，研究人员对样本执行梯度下降以最小化其值。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22a24dc1de10462a82f96893b26afc00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211432&amp;x-signature=pcxWzGCnAi%2FxocDg1xImRIlyIbg%3D" alt="图片9.png" loading="lazy"/></p>
<p>结果表明，尽管这是一个高维分布且样本数量有限，但SIGReg能够捕获退化子空间并相应地调整数据以匹配各向同性高斯分布。</p>
<h2 data-id="heading-4"><strong>LeJEPA的实际表现：跨架构跨领域的稳定性</strong></h2>
<p>在确定各向同性高斯分布是基础模型的最佳嵌入分布，并引入SIGReg来实现该分布之后，研究人员推出了完整的LeJEPA框架，并通过全面实验验证其有效性。</p>
<p>图9展示了使用LeJEPA开箱即用的ImageNet-10预训练和冻结骨干网络线性评估方法在timm模型上的应用。研究人员对学习率和权重衰减进行了交叉验证。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50f0a8620c1643cc9d7baf478ecfa0ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211432&amp;x-signature=jhWMzM3OPKp3CoX37pF2ezQLY5M%3D" alt="图片10.png" loading="lazy"/></p>
<p>虽然最佳模型和最差模型之间存在细微差异，但在涵盖8个模型系列的50个模型中，LeJEPA能够生成非平凡的表示，从而以SOTA水平解决下游任务。</p>
<p>跨架构稳定性是LeJEPA的关键优势之一。大多数现代自监督学习方法都针对Vision Transformer进行了优化，而LeJEPA无需修改，即可在各种不同的架构系列中运行。</p>
<p>为了验证这一结论，研究人员使用ImageNet-10数据集预训练了来自8个不同架构系列的约50个模型，这些模型均来自timm库，且参数量均小于2000万。</p>
<p>所有模型均能学习到高质量的表征，在冻结骨干线性探测的情况下，Top-1准确率达到了91.5%到95%。结果表明，在监督学习环境中表现良好的模型，例如ResNet和Vision Transformer，也同样适用于LeJEPA。</p>
<p>自监督学习的一个关键优势在于学习能够跨任务和领域泛化的通用表征。然而，当前前沿的基础模型（如DINOv2/v3、I-JEPA）都是在自然图像上进行预训练的，这迫使特定领域的从业者需要收集大量的标签来进行监督式微调。</p>
<p>事实上，大多数前沿模型无法直接在这些领域进行训练，因为样本数量可能很少，而且重新搜索超参数会非常耗时。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b4e9b2af0454cbea382b6b6f9ed8589~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211432&amp;x-signature=j0bTC7hrM8srsFWqvN%2BvI8uNmgY%3D" alt="图片11.png" loading="lazy"/></p>
<p>图12展示了使用冻结骨干网络或完全微调以及不同类别样本数的LeJEPA在小型架构上的域内预训练，并结合线性探针评估。研究人员将其与最先进的基础模型在3个不同的随机种子上进行了比较。</p>
<p>结果表明，LeJEPA能够开箱即用地在不同架构上进行域内预训练，并且性能优于目前最先进的基础模型。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9866bdcf928f402bb9f9c954c12e3ca5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211432&amp;x-signature=6Iu38Yfrsnd%2FywDNYmzUrZ7hkS8%3D" alt="图片12.png" loading="lazy"/></p>
<h2 data-id="heading-5"><strong>LeJEPA的涌现能力：自发的分割与语义理解</strong></h2>
<p>LeJEPA通过自监督学习习得了丰富的语义表征，展现出令人惊讶的涌现能力。</p>
<p>图13展示了基于最后一层阈值的涌现式目标分割，LeJEPA无需显式监督即可自然地学习分割和跟踪显著目标（如每个视频右侧的注意力图所示）。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6de70ea1cdac49b584bf91351d57da27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211432&amp;x-signature=dq2TKrXgk2wRnprzh80FWSZCaEs%3D" alt="图片13.png" loading="lazy"/></p>
<p>图14展示了LeJEPA通过自监督学习习得的丰富语义表征。在没有任何监督的情况下，LeJEPA自发地构建出语义丰富的表征：暖色（红色/品红色/粉色）始终用于表示前景物体（鹦鹉的身体、狗的脸），而冷色（青色/绿色/黄色）则用于表示背景和树叶。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89d6e9398b134ebfbbc44b309b90d0b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211432&amp;x-signature=t8rE7o%2BsMe0BBWz93ySfG4QeufY%3D" alt="图片14.png" loading="lazy"/></p>
<p>这种涌现的物体-背景分离和感知分组，完全基于未标记的数据，揭示了世界的视觉结构。</p>
<p>研究人员在多个领域、超过60种架构上验证了LeJEPA，其中包括参数规模高达18亿的巨型模型版本。结果证明，尽管其核心设计非常简单，LeJEPA的核心实现代码不足50行，但仍能够达到当前最先进方法的性能。</p>
<h2 data-id="heading-6"><strong>结语</strong></h2>
<p>在提交的论文中，LeJEPA框架展现出令人惊讶的涌现能力——无需显式监督，即可自然学习分割和跟踪显著目标，自发构建丰富的语义表征。</p>
<p>在论文插图里，暖色始终表示前景物体，冷色表示背景，展现出类似人类感知的分组能力。这一切，完全基于未标记数据学习而得。</p>
<p>这或许正是LeCun想传达的信息：不需要海量标注数据，不需要暴力扩展模型规模，AI依然可以学会理解世界。</p>
<p>随着这篇论文的发布，LeCun在Meta的篇章即将落幕。但对AI界来说，一位摆脱束缚的顶尖科学家，或许能带来更多惊喜。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GPT-5.1 发布当天，文心 5.0 杀回来了]]></title>    <link>https://juejin.cn/post/7574584245110358067</link>    <guid>https://juejin.cn/post/7574584245110358067</guid>    <pubDate>2025-11-20T02:38:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574584245110358067" data-draft-id="7574322843049738290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GPT-5.1 发布当天，文心 5.0 杀回来了"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-20T02:38:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GPT-5.1 发布当天，文心 5.0 杀回来了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T02:38:15.000Z" title="Thu Nov 20 2025 02:38:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/711cde344fb84252901d11113b3bbc92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=0GTsADh95fm5rvfMJIJj86uge2A%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】就在 OpenAI 刚刚教会 GPT-5.1 人情世故的同一天，一款 2.4 万亿的国产大模型证明了，AI 不仅能懂人情，还能更好地理解世界。」</strong></h5>
<p>2.4 万亿参数，原生全模态模型今天杀到了！</p>
<p>一经发布，这款模型的预览版就在多模态理解、指令遵循、创意写作、智能体规划等 40 + 核心赛道表现惊艳。</p>
<p>这一次，出手的还是中国 AI。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94cf064f9f51457d87d5ce02cf45dc0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=bTxj%2Bp9LWvtDwILAEt2WYKdnS6E%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f597276b354e4d9487eff0515cc06950~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=oFU24K9p%2FMLQy80YijyJFn%2B%2BJk0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49187f7c64614e5abc5de5443e684f88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=Bcc8pBDEOsyK9rNPI3pUtcYWZss%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4ccff9abd39429fabf112bdd93d83a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=tyqYbUc1TV7DtHGy2DKEdRLy1TE%3D" alt="" loading="lazy"/></p>
<p>左右滑动查看</p>
<p>2025 百度世界大会上，文心新一代模型——文心 5.0 重磅发布。</p>
<p>作为「原生全模态」模型，它从底层架构上实现了一次深刻的变革。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2429d5f992a42f2b63323dc8f2a52f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=9KP1VJBmXJ8uk1zAvC4IK0PdpU8%3D" alt="" loading="lazy"/></p>
<p>为何这么说？</p>
<p>与业内主流的多模态 AI 不同，文心 5.0 从训练之初融合了语言、图像、视频、音频等多模态数据。</p>
<p>而且，它还支持文、图、视、音的联合输入与输出，实现「原生」的统一理解和生成。</p>
<p>由此，文心 5.0 具备了强大的多模态理解和推理能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee43b024179041cdb17cdf08dd8f11d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=%2BSpNCTyqziclWN1aTiiI6LiThRc%3D" alt="" loading="lazy"/></p>
<p>大会现场，文心 5.0 以「武林外传」佟湘玉的口吻二创「甄嬛传」。「AI 甄嬛」妙语连珠，出人意料的演绎瞬间点燃全场。</p>
<p><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">视频详情</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d869120bc28b4c8398a5a2bf3777e84d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=tDxw1Sm%2F1Df4c3joUkFdsEVA4VM%3D" alt="" loading="lazy"/></p>
<p><strong>「告别「拼接」，原生全模态登场」</strong></p>
<p>原生全模态，不是多模态的「加法」。</p>
<p>一提到多模态 AI，人们可能想到的是，将语言、图像、视频、音频等不同数据「拼接」起来的模型。</p>
<p>当前，业界大多都采用了这种「后期融合」方式的多模态模型。</p>
<p>但文心 5.0 不同，它从根源上构建了一个统一的架构，即新一代「原生全模态大模型」。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb09e5f91bf64c829655535562e7fd1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=oN648LYzVJOWN%2FEAlaPqHan%2F4OA%3D" alt="" loading="lazy"/></p>
<p>自训练伊始，文心 5.0 融合了语言、图像、视频、音频等多模态数据，实现了文、图、视、音的联合输入与输出。</p>
<p>这样一来，文心 5.0 就能真正做到原生的全模态理解与生成。</p>
<p>不过在此之前，百度团队克服了业内普遍面临的难题：</p>
<p>原生多模态架构的「理解与生成一体化」</p>
<p>一般来说，传统方法往往先是处理单一模态，再将所有模态数据融合。这种方法看似优雅，实则会带来很多致命的问题。</p>
<p>后期融合只在输出层进行，也就是说，每个模态的特征在融合之前，就已独立决策完成。</p>
<p>这样的 AI 根本学不到模态之间的「深层语义交互」，比如视频中，人物表情和语音语调高度相关，进而造成信息丢失。</p>
<p>文心 5.0 通过精细建模多模语义特征，让理解和生成相互增强。</p>
<p>同时，它还采用了「自回归统一结构」，对不同模态的训练目标进行离散化建模，确保了多模态特征在统一框架下充分融合并协同优化，由此提升了全模态统一建模的能力。</p>
<p>在参数规模上，文心 5.0 总参数超过 2.4 万亿，业界公开参数的模型之最。</p>
<p>更关键的是，它引入了超稀疏混合专家架构，进行庞大的全模态训练。</p>
<p>其激活参数比例低于 3%，在保持强大能力的同时，显著降低计算和推理成本。</p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/077f4b38edb241fe9eb55bf9bb935fc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=odsJHSZLkx8UuLQxum%2BCIMnmqJU%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「训推双引擎，成本骤降」</strong></p>
<p>要让万亿级全模态 MoE 真正跑得动、跑得快，团队在训练与推理上同时开刀，构建了一套高效的训推体系。</p>
<p><strong>「1. 高效全模态超稀疏混合专家分布式训练」</strong></p>
<p>在训练阶段，依托飞桨框架，他们研发了多模态编码器分离异步训练架构、动态自适应显存卸载技术，以及细粒度通信计算重叠编排专家并行技术。</p>
<p>同时，结合 FP8 混合精度训练，实现了对万亿级参数全模态超稀疏混合专家模型的高效训练。</p>
<p>结果，文心 5.0 预训练性能较基准提速 230%。</p>
<p><strong>「2. 多级分离架构的全模态统一高性能推理」</strong></p>
<p>在推理阶段，文心 5.0 采用了「多模编码器 - 预填充 - 解码 - 多模生成器」的多级分离推理部署框架。</p>
<p>此外，团队还研发了面向超稀疏混合专家、数据负载和注意力计算的均衡算法，以及动态自适应多步投机解码和效果无损低比特键值缓存量化技术。</p>
<p>在推理成本上，文心 5.0 得到大幅压缩，真正实现了效率与能力的平衡，让其更接近实用。</p>
<p>此外，衡量一个模型能否从实验室走向实际应用，长程任务的指标是最重要的衡量因素之一。</p>
<p>为了提升文心 5.0 长程任务的能力，团队基于大规模工具环境，合成了长程任务轨迹数据。</p>
<p>然后，在预训练和后训练阶段，基于思维链和行动链对文心 5.0 进行「端到端」多轮强化学习训练。</p>
<p>由此可见，文心 5.0 的智能体和工具调用能力，得到了显著的提升。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a080e0c55c0413d9a92cb36fa384fdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=rLWIB%2BnIPuCSjqPVk41aJ0h6g2Q%3D" alt="" loading="lazy"/></p>
<p><strong>「文心又回来了！」</strong></p>
<p>过去两年，多模态模型已迅速崛起，成为驱动 AI 时代发展的核心引擎。</p>
<p>与传统大语言模型不同，它突破了单一文本的限制，通过无缝融合图像、音频、视频等多源信息，实现了更接近人类的综合理解与生成能力。</p>
<p>放眼全球，在这场 AI 大战中，OpenAI、谷歌等硅谷巨头早已在多模态赛道上抢先布局。</p>
<p>OpenAI 发布 GPT-4o 时，便向世界生动展示了多模态 AI 应有的交互形态——</p>
<p>一个统一的神经网络，无缝处理文本、音频、视觉等多种模态的输入与输出。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b866381820e4c56944ece980aabbd79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=NV07GPG7uavFX3%2FuU96r68dsFCM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba461a8d828647d383895b160153d994~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=OOfQ0hiMznfB2fGPMg0O4rQgWB0%3D" alt="" loading="lazy"/></p>
<p>而谷歌的 Gemini 系列，更是从诞生之初便被烙上了「原生多模态」的印记。</p>
<p>他们在技术报告中，多次强调了原生多模态与非原生的差异。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ece6ab8dbc8b43eebe630eb3975d588a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=UkdWRIzOjhPti5c9atU%2BK%2FIrS1I%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb5e50c3e4574c269d9d77819808f8e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=IvohxM1OqlVg%2BQ4JBRuE4Smn7Ls%3D" alt="" loading="lazy"/></p>
<p>CEO Demis Hassabis 也曾明确表示，Gemini 的目标就是要让一个模型能原生地理解图像、音频和视频。</p>
<p>最终，实现与物理世界的真实交互。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8d4140b881a4d8397e968ba30a17869~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=1kek%2B%2BU6bkjX82GwHTcnipadzIM%3D" alt="" loading="lazy"/></p>
<p>视线转回国内，阿里、字节等头部大厂同样在多模态赛道上重兵布局。而在众多路径中，百度选择了一条更效率导向的道路——<strong>「「原生全模态」」</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efd1003f41fe4e85b0183500eb99b453~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=2dS7JgCYFW%2BqSu0c156MFbwNdYc%3D" alt="" loading="lazy"/></p>
<p>原生全模态，意味着模型从训练的第一天起，就如人类一般，活在视觉、听觉与文字交融的统一感知中。</p>
<p>和婴儿一样，它学习世界的方式是通过所有感官的同步输入来形成认知。毕竟，人类的思考从来都不是「先看再听再想」的线性接力，而是所有信息洪流的同步融合。</p>
<p>这之中的核心，便是将每一帧画面、每一段声音、乃至每一个词语，都转化为一套统一的离散符号流，并置于同一个自回归框架下建模。</p>
<p>也就是说，当你输入一段街头艺人表演的视频，探寻「背后的故事」时，AI 不再是割裂地解析画面、分析音频，最后拼凑答案。它能在一个统一的语义空间中，同步完成感知、推理与叙事，像人类一样，给予一个完整而深刻的回应。</p>
<p>正是凭借这种全模态的内在优势，文心 5.0 得以突破复杂场景的束缚，为 AI 的未来应用开启无限想象。</p>
<p>更值得一提的是，文心的实力，早已超越了实验室的范畴，在真实应用中形成了技术落地的闭环。</p>
<p>发布会现场，与百度连线的「AI 老罗」便是最好的证明。他不仅能轻松做出「点赞、比心、比耶」的互动三连，更在问答环节中，将罗永浩本人「犀利吐槽」的语言风格模仿得惟妙惟肖。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d856f83569c41a196b4525f6d19f762~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211095&amp;x-signature=gzgqo0KNeDumM5X3ssmhh10RFzg%3D" alt="" loading="lazy"/></p>
<p>技术基于慧播星高说服力数字人</p>
<p>如今，当理解与生成走向统一，当技术与应用协同共生，人机智能的边界也正悄然消融。</p>
<p>在这场全球大模型的激烈角逐中，文心正以全新姿态，强势回归！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用LangGraph构建自主RAG5]]></title>    <link>https://juejin.cn/post/7574584245110620211</link>    <guid>https://juejin.cn/post/7574584245110620211</guid>    <pubDate>2025-11-20T03:00:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574584245110620211" data-draft-id="7574357603406315570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用LangGraph构建自主RAG5"/> <meta itemprop="keywords" content="OpenAI,AIGC,Agent"/> <meta itemprop="datePublished" content="2025-11-20T03:00:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="安思派Anspire"/> <meta itemprop="url" content="https://juejin.cn/user/3044964115417419"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用LangGraph构建自主RAG5
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3044964115417419/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    安思派Anspire
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T03:00:27.000Z" title="Thu Nov 20 2025 03:00:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简单的RAG代码实现</h3>
<p>在这个简单的RAG中，流程如下：</p>
<p><strong>查询 → 检索 → 提示构建（增强） → 生成</strong></p>
<p>该流程使用LangGraph的状态图实现，包含三个节点（步骤）：</p>
<p>1. <strong>检索器</strong>：对 `medical_q_n_a` 集合执行相似性查询，并将排名靠前的文档合并为一个上下文字符串。</p>
<p>2. <strong>PromptBuilder</strong>：创建一个简单的RAG提示，该提示注入检索到的上下文和用户问题，并带有长度限制。</p>
<p>3. <strong>大语言模型</strong>：调用 `get_llm_response(prompt)` 并将模型输出保存到工作流状态中。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Literal</span>
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph,MessagesState, START, END
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">from</span> typing_extensions <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-comment"># === Define workflow node functions ===</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">retrieve_context</span>(<span class="hljs-params">state</span>):
    <span class="hljs-string">"""Retrieve top documents from ChromaDB based on query."""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"---RETRIEVING CONTEXT---"</span>)
    query = state[<span class="hljs-string">"query"</span>] <span class="hljs-comment"># last user message</span>
    results = collection1.query(query_texts=[query], n_results=<span class="hljs-number">3</span>)
    context = <span class="hljs-string">"\n"</span>.join(results[<span class="hljs-string">"documents"</span>][<span class="hljs-number">0</span>])
    <span class="hljs-comment">#state["query"] = query</span>
    state[<span class="hljs-string">"context"</span>] = context
    <span class="hljs-built_in">print</span>(context)
    <span class="hljs-comment"># Save context in the state for later nodes</span>
    <span class="hljs-keyword">return</span> state
<span class="hljs-keyword">def</span> <span class="hljs-title function_">build_prompt</span>(<span class="hljs-params">state</span>):
    <span class="hljs-string">"""Construct the RAG-style prompt."""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"---AUGMENT (BUILDING PROMPT)---"</span>)
    query = state[<span class="hljs-string">"query"</span>]
    context = state[<span class="hljs-string">"context"</span>]
    prompt = <span class="hljs-string">f"""
            Answer the following question using the context below.
            Context:
            <span class="hljs-subst">{context}</span>
            Question: <span class="hljs-subst">{query}</span>
            please limit your answer in 50 words.
            """</span>
    
    state[<span class="hljs-string">"prompt"</span>] = prompt
    <span class="hljs-built_in">print</span>(prompt)
    <span class="hljs-keyword">return</span> state
<span class="hljs-keyword">def</span> <span class="hljs-title function_">call_llm</span>(<span class="hljs-params">state</span>):
    <span class="hljs-string">"""Call your existing LLM function."""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"---GENERATE (CALLING LLM)---"</span>)
    prompt = state[<span class="hljs-string">"prompt"</span>]
    answer = get_llm_response(prompt)
    state[<span class="hljs-string">"response"</span>] = answer
    <span class="hljs-keyword">return</span> state
<span class="hljs-comment"># === Build the workflow ===</span>
<span class="hljs-comment">## Define the state structure</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GraphState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    query : <span class="hljs-built_in">str</span>
    prompt : <span class="hljs-built_in">str</span>
    context : <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]
    response : <span class="hljs-built_in">str</span>
    
workflow = StateGraph(GraphState)
<span class="hljs-comment"># Add nodes</span>
workflow.add_node(<span class="hljs-string">"Retriever"</span>, retrieve_context)
workflow.add_node(<span class="hljs-string">"Augment"</span>, build_prompt)
workflow.add_node(<span class="hljs-string">"Generate"</span>, call_llm)
<span class="hljs-comment"># Define edges</span>
workflow.add_edge(START, <span class="hljs-string">"Retriever"</span>)
workflow.add_edge(<span class="hljs-string">"Retriever"</span>, <span class="hljs-string">"Augment"</span>)
workflow.add_edge(<span class="hljs-string">"Augment"</span>, <span class="hljs-string">"Generate"</span>)
workflow.add_edge(<span class="hljs-string">"Generate"</span>, END)
<span class="hljs-comment"># Compile agent</span>
rag_agent = workflow.<span class="hljs-built_in">compile</span>()
<span class="hljs-comment"># === Run it ===</span>
<span class="hljs-keyword">from</span> IPython.display <span class="hljs-keyword">import</span> Image, display
display(Image(rag_agent.get_graph().draw_mermaid_png()))
</code></pre>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64a6a445e98245b99001ea501bb3ba7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764212427&amp;x-signature=PsEYblTLbhXnZUxki6UjJEGtFpM%3D" alt="" loading="lazy"/></p>
<p>简单的检索增强生成（图片由作者提供）</p>
<p>测试简单RAG：</p>
<pre><code class="hljs language-css" lang="css">input_state = {"query": <span class="hljs-string">"What are the treatments for Kawasaki disease ?"</span>}
<span class="hljs-selector-tag">from</span> pprint import pprint
for step in rag_agent<span class="hljs-selector-class">.stream</span>(input_state):
    for key, value in step.<span class="hljs-built_in">items</span>():
        <span class="hljs-built_in">pprint</span>(f<span class="hljs-string">"Finished running: {key}:"</span>)
<span class="hljs-built_in">pprint</span>(value[<span class="hljs-string">"response"</span>])
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-scala" lang="scala">---<span class="hljs-type">RETRIEVING</span> <span class="hljs-type">CONTEXT</span>---
<span class="hljs-type">Question</span>: <span class="hljs-type">What</span> are the treatments <span class="hljs-keyword">for</span> <span class="hljs-type">Kawasaki</span> disease ?. <span class="hljs-type">Answer</span>: <span class="hljs-type">These</span> resources address the diagnosis or management of <span class="hljs-type">Kawasaki</span> disease:  - <span class="hljs-type">Cincinnati</span> <span class="hljs-type">Children</span>'s <span class="hljs-type">Hospital</span> <span class="hljs-type">Medical</span> <span class="hljs-type">Center</span>  - <span class="hljs-type">Genetic</span> <span class="hljs-type">Testing</span> <span class="hljs-type">Registry</span>: <span class="hljs-type">Acute</span> febrile mucocutaneous lymph node syndrome  - <span class="hljs-type">National</span> <span class="hljs-type">Heart</span>, <span class="hljs-type">Lung</span>, and <span class="hljs-type">Blood</span> <span class="hljs-type">Institute</span>: <span class="hljs-type">How</span> is <span class="hljs-type">Kawasaki</span> <span class="hljs-type">Disease</span> <span class="hljs-type">Treated</span>?   <span class="hljs-type">These</span> resources from <span class="hljs-type">MedlinePlus</span> offer information about the diagnosis and management of various health conditions:  - <span class="hljs-type">Diagnostic</span> <span class="hljs-type">Tests</span>  - <span class="hljs-type">Drug</span> <span class="hljs-type">Therapy</span>  - <span class="hljs-type">Surgery</span> and <span class="hljs-type">Rehabilitation</span>  - <span class="hljs-type">Genetic</span> <span class="hljs-type">Counseling</span>   - <span class="hljs-type">Palliative</span> <span class="hljs-type">Care</span>. <span class="hljs-type">Type</span>: treatment. 
<span class="hljs-type">Question</span>: <span class="hljs-type">What</span> are the treatments <span class="hljs-keyword">for</span> <span class="hljs-type">Krabbe</span> <span class="hljs-type">Disease</span> ?. <span class="hljs-type">Answer</span>: <span class="hljs-type">There</span> is no cure <span class="hljs-keyword">for</span> <span class="hljs-type">Krabbe</span> disease. <span class="hljs-type">Results</span> of a very small clinical trial of children <span class="hljs-keyword">with</span> infantile <span class="hljs-type">Krabbe</span> disease found that children who received umbilical cord blood stem cells from unrelated donors prior to symptom onset developed <span class="hljs-keyword">with</span> little neurological impairment. <span class="hljs-type">Bone</span> marrow transplantation may help some people. <span class="hljs-type">Generally</span>, treatment <span class="hljs-keyword">for</span> the disorder is symptomatic and supportive. <span class="hljs-type">Physical</span> therapy may help maintain or increase muscle tone and circulation.. <span class="hljs-type">Type</span>: treatment. 
<span class="hljs-type">Question</span>: <span class="hljs-type">What</span> are the treatments <span class="hljs-keyword">for</span> <span class="hljs-type">Ehlers</span>-<span class="hljs-type">Danlos</span> syndrome, progeroid <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">?</span>. <span class="hljs-title">Answer</span></span>: <span class="hljs-type">How</span> might <span class="hljs-type">Ehlers</span>-<span class="hljs-type">Danlos</span> syndrome progeroid <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">be</span> <span class="hljs-title">treated?</span> <span class="hljs-title">Individuals</span> <span class="hljs-keyword">with</span> <span class="hljs-title">Ehlers-Danlos</span> <span class="hljs-title">Syndrome</span> <span class="hljs-title">progeroid</span> <span class="hljs-title">type</span> <span class="hljs-title">can</span> <span class="hljs-title">benefit</span> <span class="hljs-title">from</span> <span class="hljs-title">a</span> <span class="hljs-title">variety</span> <span class="hljs-title">of</span> <span class="hljs-title">treatments</span> <span class="hljs-title">depending</span> <span class="hljs-title">on</span> <span class="hljs-title">their</span> <span class="hljs-title">symptoms</span>. <span class="hljs-title">Affected</span> <span class="hljs-title">children</span> <span class="hljs-keyword">with</span> <span class="hljs-title">weak</span> <span class="hljs-title">muscle</span> <span class="hljs-title">tone</span> <span class="hljs-title">and</span> <span class="hljs-title">delayed</span> <span class="hljs-title">development</span> <span class="hljs-title">might</span> <span class="hljs-title">benefit</span> <span class="hljs-title">from</span> <span class="hljs-title">physiotherapy</span> <span class="hljs-title">to</span> <span class="hljs-title">improve</span> <span class="hljs-title">muscle</span> <span class="hljs-title">strength</span> <span class="hljs-title">and</span> <span class="hljs-title">coordination</span>. <span class="hljs-title">Affected</span> <span class="hljs-title">individuals</span> <span class="hljs-keyword">with</span> <span class="hljs-title">joint</span> <span class="hljs-title">pain</span> <span class="hljs-title">might</span> <span class="hljs-title">benefit</span> <span class="hljs-title">from</span> <span class="hljs-title">anti-inflammatory</span> <span class="hljs-title">drugs</span>. <span class="hljs-title">Lifestyle</span> <span class="hljs-title">changes</span> <span class="hljs-title">or</span> <span class="hljs-title">precautions</span> <span class="hljs-title">during</span> <span class="hljs-title">exercise</span> <span class="hljs-title">or</span> <span class="hljs-title">intense</span> <span class="hljs-title">physical</span> <span class="hljs-title">activity</span> <span class="hljs-title">may</span> <span class="hljs-title">be</span> <span class="hljs-title">advised</span> <span class="hljs-title">to</span> <span class="hljs-title">reduce</span> <span class="hljs-title">the</span> <span class="hljs-title">chance</span> <span class="hljs-title">of</span> <span class="hljs-title">accidents</span> <span class="hljs-title">to</span> <span class="hljs-title">the</span> <span class="hljs-title">skin</span> <span class="hljs-title">and</span> <span class="hljs-title">bone</span>. <span class="hljs-title">It</span> <span class="hljs-title">is</span> <span class="hljs-title">recommended</span> <span class="hljs-title">that</span> <span class="hljs-title">affected</span> <span class="hljs-title">individuals</span> <span class="hljs-title">discuss</span> <span class="hljs-title">treatment</span> <span class="hljs-title">options</span> <span class="hljs-keyword">with</span> <span class="hljs-title">their</span> <span class="hljs-title">healthcare</span> <span class="hljs-title">provider</span>.. <span class="hljs-title">Type</span></span>: treatment. 
'<span class="hljs-type">Finished</span> running: <span class="hljs-type">Retriever</span>:'
---<span class="hljs-type">AUGMENT</span> (<span class="hljs-type">BUILDING</span> <span class="hljs-type">PROMPT</span>)---
<span class="hljs-type">Answer</span> the following question using the context below.
            <span class="hljs-type">Context</span>:
            <span class="hljs-type">Question</span>: <span class="hljs-type">What</span> are the treatments <span class="hljs-keyword">for</span> <span class="hljs-type">Kawasaki</span> disease ?. <span class="hljs-type">Answer</span>: <span class="hljs-type">These</span> resources address the diagnosis or management of <span class="hljs-type">Kawasaki</span> disease:  - <span class="hljs-type">Cincinnati</span> <span class="hljs-type">Children</span>'s <span class="hljs-type">Hospital</span> <span class="hljs-type">Medical</span> <span class="hljs-type">Center</span>  - <span class="hljs-type">Genetic</span> <span class="hljs-type">Testing</span> <span class="hljs-type">Registry</span>: <span class="hljs-type">Acute</span> febrile mucocutaneous lymph node syndrome  - <span class="hljs-type">National</span> <span class="hljs-type">Heart</span>, <span class="hljs-type">Lung</span>, and <span class="hljs-type">Blood</span> <span class="hljs-type">Institute</span>: <span class="hljs-type">How</span> is <span class="hljs-type">Kawasaki</span> <span class="hljs-type">Disease</span> <span class="hljs-type">Treated</span>?   <span class="hljs-type">These</span> resources from <span class="hljs-type">MedlinePlus</span> offer information about the diagnosis and management of various health conditions:  - <span class="hljs-type">Diagnostic</span> <span class="hljs-type">Tests</span>  - <span class="hljs-type">Drug</span> <span class="hljs-type">Therapy</span>  - <span class="hljs-type">Surgery</span> and <span class="hljs-type">Rehabilitation</span>  - <span class="hljs-type">Genetic</span> <span class="hljs-type">Counseling</span>   - <span class="hljs-type">Palliative</span> <span class="hljs-type">Care</span>. <span class="hljs-type">Type</span>: treatment. 
<span class="hljs-type">Question</span>: <span class="hljs-type">What</span> are the treatments <span class="hljs-keyword">for</span> <span class="hljs-type">Krabbe</span> <span class="hljs-type">Disease</span> ?. <span class="hljs-type">Answer</span>: <span class="hljs-type">There</span> is no cure <span class="hljs-keyword">for</span> <span class="hljs-type">Krabbe</span> disease. <span class="hljs-type">Results</span> of a very small clinical trial of children <span class="hljs-keyword">with</span> infantile <span class="hljs-type">Krabbe</span> disease found that children who received umbilical cord blood stem cells from unrelated donors prior to symptom onset developed <span class="hljs-keyword">with</span> little neurological impairment. <span class="hljs-type">Bone</span> marrow transplantation may help some people. <span class="hljs-type">Generally</span>, treatment <span class="hljs-keyword">for</span> the disorder is symptomatic and supportive. <span class="hljs-type">Physical</span> therapy may help maintain or increase muscle tone and circulation.. <span class="hljs-type">Type</span>: treatment. 
<span class="hljs-type">Question</span>: <span class="hljs-type">What</span> are the treatments <span class="hljs-keyword">for</span> <span class="hljs-type">Ehlers</span>-<span class="hljs-type">Danlos</span> syndrome, progeroid <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">?</span>. <span class="hljs-title">Answer</span></span>: <span class="hljs-type">How</span> might <span class="hljs-type">Ehlers</span>-<span class="hljs-type">Danlos</span> syndrome progeroid <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">be</span> <span class="hljs-title">treated?</span> <span class="hljs-title">Individuals</span> <span class="hljs-keyword">with</span> <span class="hljs-title">Ehlers-Danlos</span> <span class="hljs-title">Syndrome</span> <span class="hljs-title">progeroid</span> <span class="hljs-title">type</span> <span class="hljs-title">can</span> <span class="hljs-title">benefit</span> <span class="hljs-title">from</span> <span class="hljs-title">a</span> <span class="hljs-title">variety</span> <span class="hljs-title">of</span> <span class="hljs-title">treatments</span> <span class="hljs-title">depending</span> <span class="hljs-title">on</span> <span class="hljs-title">their</span> <span class="hljs-title">symptoms</span>. <span class="hljs-title">Affected</span> <span class="hljs-title">children</span> <span class="hljs-keyword">with</span> <span class="hljs-title">weak</span> <span class="hljs-title">muscle</span> <span class="hljs-title">tone</span> <span class="hljs-title">and</span> <span class="hljs-title">delayed</span> <span class="hljs-title">development</span> <span class="hljs-title">might</span> <span class="hljs-title">benefit</span> <span class="hljs-title">from</span> <span class="hljs-title">physiotherapy</span> <span class="hljs-title">to</span> <span class="hljs-title">improve</span> <span class="hljs-title">muscle</span> <span class="hljs-title">strength</span> <span class="hljs-title">and</span> <span class="hljs-title">coordination</span>. <span class="hljs-title">Affected</span> <span class="hljs-title">individuals</span> <span class="hljs-keyword">with</span> <span class="hljs-title">joint</span> <span class="hljs-title">pain</span> <span class="hljs-title">might</span> <span class="hljs-title">benefit</span> <span class="hljs-title">from</span> <span class="hljs-title">anti-inflammatory</span> <span class="hljs-title">drugs</span>. <span class="hljs-title">Lifestyle</span> <span class="hljs-title">changes</span> <span class="hljs-title">or</span> <span class="hljs-title">precautions</span> <span class="hljs-title">during</span> <span class="hljs-title">exercise</span> <span class="hljs-title">or</span> <span class="hljs-title">intense</span> <span class="hljs-title">physical</span> <span class="hljs-title">activity</span> <span class="hljs-title">may</span> <span class="hljs-title">be</span> <span class="hljs-title">advised</span> <span class="hljs-title">to</span> <span class="hljs-title">reduce</span> <span class="hljs-title">the</span> <span class="hljs-title">chance</span> <span class="hljs-title">of</span> <span class="hljs-title">accidents</span> <span class="hljs-title">to</span> <span class="hljs-title">the</span> <span class="hljs-title">skin</span> <span class="hljs-title">and</span> <span class="hljs-title">bone</span>. <span class="hljs-title">It</span> <span class="hljs-title">is</span> <span class="hljs-title">recommended</span> <span class="hljs-title">that</span> <span class="hljs-title">affected</span> <span class="hljs-title">individuals</span> <span class="hljs-title">discuss</span> <span class="hljs-title">treatment</span> <span class="hljs-title">options</span> <span class="hljs-keyword">with</span> <span class="hljs-title">their</span> <span class="hljs-title">healthcare</span> <span class="hljs-title">provider</span>.. <span class="hljs-title">Type</span></span>: treatment. 
            <span class="hljs-type">Question</span>: <span class="hljs-type">What</span> are the treatments <span class="hljs-keyword">for</span> <span class="hljs-type">Kawasaki</span> disease ?
            please limit your answer in <span class="hljs-number">50</span> words.
            
'<span class="hljs-type">Finished</span> running: <span class="hljs-type">Augment</span>:'
---<span class="hljs-type">GENERATE</span> (<span class="hljs-type">CALLING</span> <span class="hljs-type">LLM</span>)---
'<span class="hljs-type">Finished</span> running: <span class="hljs-type">Generate</span>:'
('<span class="hljs-type">Kawasaki</span> disease is treated mainly <span class="hljs-keyword">with</span> intravenous immunoglobulin (<span class="hljs-type">IVIG</span>) '
 'and high-dose aspirin to reduce inflammation and prevent coronary artery '
 'aneurysms. <span class="hljs-type">If</span> fever recurs or <span class="hljs-type">IVIG</span> resistance occurs, additional treatments '
 '(repeat <span class="hljs-type">IVIG</span>, steroids) may be considered; ongoing monitoring <span class="hljs-keyword">with</span> '
 'echocardiograms is recommended.')
</code></pre>
<p>公平又简单，对吧。但要是有人问出超出大纲的问题呢！！</p>
<p>是的，系统彻底失败了。</p>
<p>别担心，我们有智能增强检索生成（Agentic RAG）作为救星。</p>
<h2 data-id="heading-1">能动RAG - 代码实现</h2>
<p>核心思想：不是始终使用同一个检索器，而是使用一个小型路由代理，它在多个检索选项中进行决策，然后验证检索到的上下文是否相关。</p>
<p>流程如下：</p>
<p><strong>查询 → 路由器（源选择） → 检索 → 相关性检查器 → 如果相关：生成，如果不相关：转到网络搜索 → 结束</strong></p>
<p>这些是使用LangGraph的StateGraph节点实现的。条件是使用“conditional_edge”实现的。</p>
<p>以下是关键节点：</p>
<p><strong>1.</strong> <strong>路由节点</strong>：构建一个简短的决策提示，并要求大语言模型返回三个标签之一：`Retrieve_QnA`、`Retrieve_Device`或`Web_Search`。</p>
<p><strong>2. 检索器节点</strong>：一个用于问答Chroma集合，一个用于设备手册Chroma集合，一个用于网络搜索API。每个节点都会返回一个上下文字符串并设置一个 `source` 标签。</p>
<p><strong>3.</strong> <strong>相关性检查器</strong>：询问大语言模型（LLM）检索到的上下文是否相关（答案应为`是`或`否`）。</p>
<p><strong>4. 条件路由</strong>：如果相关性为`是`，则继续进行提示构建和大语言模型处理。如果为`否`，则回退到`网络搜索`并重新运行相关性检查；流程将迭代次数限制为最多3次尝试。</p>
<p>能动流将这些节点组合成一个带有条件边的状态图。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Literal</span>
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph,MessagesState, START, END
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">from</span> typing_extensions <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-comment"># === Define workflow node functions ===</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">retrieve_context_q_n_a</span>(<span class="hljs-params">state</span>):
    <span class="hljs-string">"""Retrieve top documents from ChromaDB Collection 1 (Medical Q&amp;A Data) based on query."""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"---RETRIEVING CONTEXT---"</span>)
    query = state[<span class="hljs-string">"query"</span>] <span class="hljs-comment"># last user message</span>
    results = collection1.query(query_texts=[query], n_results=<span class="hljs-number">3</span>)
    context = <span class="hljs-string">"\n"</span>.join(results[<span class="hljs-string">"documents"</span>][<span class="hljs-number">0</span>])
    state[<span class="hljs-string">"context"</span>] = context
    state[<span class="hljs-string">"source"</span>] = <span class="hljs-string">"Medical Q&amp;A Collection"</span>
    <span class="hljs-built_in">print</span>(context)
    <span class="hljs-comment"># Save context in the state for later nodes</span>
    <span class="hljs-keyword">return</span> state
<span class="hljs-comment"># === Define workflow node functions ===</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">retrieve_context_medical_device</span>(<span class="hljs-params">state</span>):
    <span class="hljs-string">"""Retrieve top documents from ChromaDB Collection 2 (Medical Device Manuals Data) based on query."""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"---RETRIEVING CONTEXT---"</span>)
    query = state[<span class="hljs-string">"query"</span>] <span class="hljs-comment"># last user message</span>
    results = collection2.query(query_texts=[query], n_results=<span class="hljs-number">3</span>)
    context = <span class="hljs-string">"\n"</span>.join(results[<span class="hljs-string">"documents"</span>][<span class="hljs-number">0</span>])
    state[<span class="hljs-string">"context"</span>] = context
    state[<span class="hljs-string">"source"</span>] = <span class="hljs-string">"Medical Device Manual"</span>
    <span class="hljs-built_in">print</span>(context)
    <span class="hljs-comment"># Save context in the state for later nodes</span>
    <span class="hljs-keyword">return</span> state
<span class="hljs-keyword">def</span> <span class="hljs-title function_">web_search</span>(<span class="hljs-params">state</span>):
    <span class="hljs-string">"""Perform web search using Google Serper API."""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"---PERFORMING WEB SEARCH---"</span>)
    query = state[<span class="hljs-string">"query"</span>]
    search_results = search.run(query=query)
    state[<span class="hljs-string">"context"</span>] = search_results
    state[<span class="hljs-string">"source"</span>] = <span class="hljs-string">"Web Search"</span>
    <span class="hljs-built_in">print</span>(search_results)
    <span class="hljs-keyword">return</span> state
<span class="hljs-keyword">def</span> <span class="hljs-title function_">router</span>(<span class="hljs-params">state: GraphState</span>) -&gt; <span class="hljs-type">Literal</span>[
    <span class="hljs-string">"Retrieve_QnA"</span>, <span class="hljs-string">"Retrieve_Device"</span>, <span class="hljs-string">"Web_Search"</span>
]:
    <span class="hljs-string">"""Agentic router: decides which retrieval method to use."""</span>
    query = state[<span class="hljs-string">"query"</span>]
    <span class="hljs-comment"># A lightweight decision LLM - you can replace this with GPT-4o-mini, etc.</span>
    decision_prompt = <span class="hljs-string">f"""
    You are a routing agent. Based on the user query, decide where to look for information.
    Options:
    - Retrieve_QnA: if it's about general medical knowledge, symptoms, or treatment.
    - Retrieve_Device: if it's about medical devices, manuals, or instructions.
    - Web_Search: if it's about recent news, brand names, or external data.
    Query: "<span class="hljs-subst">{query}</span>"
    Respond ONLY with one of: Retrieve_QnA, Retrieve_Device, Web_Search
    """</span>
    router_decision = get_llm_response(decision_prompt).strip()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"---ROUTER DECISION: <span class="hljs-subst">{router_decision}</span>---"</span>)
    <span class="hljs-built_in">print</span>(router_decision)
    state[<span class="hljs-string">"source"</span>] = router_decision
    <span class="hljs-keyword">return</span> state
<span class="hljs-comment"># Define the routing function for the conditional edge</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">route_decision</span>(<span class="hljs-params">state: GraphState</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-keyword">return</span> state[<span class="hljs-string">"source"</span>]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">build_prompt</span>(<span class="hljs-params">state</span>):
    <span class="hljs-string">"""Construct the RAG-style prompt."""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"---AUGMENT (BUILDING GENERATIVE PROMPT)---"</span>)
    query = state[<span class="hljs-string">"query"</span>]
    context = state[<span class="hljs-string">"context"</span>]
    prompt = <span class="hljs-string">f"""
            Answer the following question using the context below.
            Context:
            <span class="hljs-subst">{context}</span>
            Question: <span class="hljs-subst">{query}</span>
            please limit your answer in 50 words.
            """</span>
    
    state[<span class="hljs-string">"prompt"</span>] = prompt
    <span class="hljs-built_in">print</span>(prompt)
    <span class="hljs-keyword">return</span> state

<span class="hljs-keyword">def</span> <span class="hljs-title function_">call_llm</span>(<span class="hljs-params">state</span>):
    <span class="hljs-string">"""Call your existing LLM function."""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"---GENERATE (CALLING LLM)---"</span>)
    prompt = state[<span class="hljs-string">"prompt"</span>]
    answer = get_llm_response(prompt)
    state[<span class="hljs-string">"response"</span>] = answer
    <span class="hljs-keyword">return</span> state

<span class="hljs-keyword">def</span> <span class="hljs-title function_">check_context_relevance</span>(<span class="hljs-params">state</span>):
    <span class="hljs-string">"""Determine whether to retrieved context is relevant or not."""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"---CONTEXT RELEVANCE CHECKER---"</span>)
    query = state[<span class="hljs-string">"query"</span>]
    context = state[<span class="hljs-string">"context"</span>]
    relevance_prompt = <span class="hljs-string">f"""
            Check the below context if the context is relevent to the user query or.
            ####
            Context:
            <span class="hljs-subst">{context}</span>
            ####
            User Query: <span class="hljs-subst">{query}</span>
            Options:
            - Yes: if the context is relevant.
            - No: if the context is not relevant.
            Please answer with only 'Yes' or 'No'.
            """</span>
    relevance_decision_value = get_llm_response(relevance_prompt).strip()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"---RELEVANCE DECISION: <span class="hljs-subst">{relevance_decision_value}</span>---"</span>)
    state[<span class="hljs-string">"is_relevant"</span>] = relevance_decision_value
    <span class="hljs-keyword">return</span> state
<span class="hljs-comment"># Define the check_context_relevance function for the conditional edge</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">relevance_decision</span>(<span class="hljs-params">state: GraphState</span>) -&gt; <span class="hljs-built_in">str</span>:
    iteration_count = state.get(<span class="hljs-string">"iteration_count"</span>, <span class="hljs-number">0</span>)
    iteration_count += <span class="hljs-number">1</span>
    state[<span class="hljs-string">"iteration_count"</span>] = iteration_count
    <span class="hljs-comment">## Limiting to max 3 iterations</span>
    <span class="hljs-keyword">if</span> iteration_count &gt;= <span class="hljs-number">3</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"---MAX ITERATIONS REACHED, FORCING 'Yes'---"</span>)
        state[<span class="hljs-string">"is_relevant"</span>] = <span class="hljs-string">"Yes"</span>
    <span class="hljs-keyword">return</span> state[<span class="hljs-string">"is_relevant"</span>]

<span class="hljs-comment"># === Build the workflow ===</span>
<span class="hljs-comment">## Define the state structure</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GraphState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    query: <span class="hljs-built_in">str</span>
    context: <span class="hljs-built_in">str</span>
    prompt: <span class="hljs-built_in">str</span>
    response: <span class="hljs-built_in">str</span>
    source: <span class="hljs-built_in">str</span>  <span class="hljs-comment"># Which retriever/tool was used</span>
    is_relevant: <span class="hljs-built_in">str</span>
    iteration_count: <span class="hljs-built_in">int</span>
    
workflow = StateGraph(GraphState)
<span class="hljs-comment"># Add nodes</span>
workflow.add_node(<span class="hljs-string">"Router"</span>, router)
workflow.add_node(<span class="hljs-string">"Retrieve_QnA"</span>, retrieve_context_q_n_a)
workflow.add_node(<span class="hljs-string">"Retrieve_Device"</span>, retrieve_context_medical_device)
workflow.add_node(<span class="hljs-string">"Web_Search"</span>, web_search)
workflow.add_node(<span class="hljs-string">"Relevance_Checker"</span>, check_context_relevance)
workflow.add_node(<span class="hljs-string">"Augment"</span>, build_prompt)
workflow.add_node(<span class="hljs-string">"Generate"</span>, call_llm)
<span class="hljs-comment"># Define edges</span>
workflow.add_edge(START, <span class="hljs-string">"Router"</span>)
workflow.add_conditional_edges(
    <span class="hljs-string">"Router"</span>,
    route_decision,  <span class="hljs-comment"># this function decides the path dynamically</span>
    {
        <span class="hljs-string">"Retrieve_QnA"</span>: <span class="hljs-string">"Retrieve_QnA"</span>,
        <span class="hljs-string">"Retrieve_Device"</span>: <span class="hljs-string">"Retrieve_Device"</span>,
        <span class="hljs-string">"Web_Search"</span>: <span class="hljs-string">"Web_Search"</span>,
    }
)
workflow.add_edge(<span class="hljs-string">"Retrieve_QnA"</span>, <span class="hljs-string">"Relevance_Checker"</span>)
workflow.add_edge(<span class="hljs-string">"Retrieve_Device"</span>, <span class="hljs-string">"Relevance_Checker"</span>)
workflow.add_edge(<span class="hljs-string">"Web_Search"</span>, <span class="hljs-string">"Relevance_Checker"</span>)
workflow.add_conditional_edges(
    <span class="hljs-string">"Relevance_Checker"</span>,
    relevance_decision,  <span class="hljs-comment"># this function decides the path dynamically</span>
    {
        <span class="hljs-string">"Yes"</span>: <span class="hljs-string">"Augment"</span>,
        <span class="hljs-string">"No"</span>: <span class="hljs-string">"Web_Search"</span>,
    }
)
workflow.add_edge(<span class="hljs-string">"Augment"</span>, <span class="hljs-string">"Generate"</span>)
workflow.add_edge(<span class="hljs-string">"Generate"</span>, END)

<span class="hljs-comment"># Compile the dynamic RAG agent</span>
agentic_rag = workflow.<span class="hljs-built_in">compile</span>()

<span class="hljs-comment"># ===================================</span>
<span class="hljs-comment"># ===  Visualize Workflow (Optional) ===</span>
<span class="hljs-comment"># ===================================</span>

<span class="hljs-comment"># === Run it ===</span>
<span class="hljs-keyword">from</span> IPython.display <span class="hljs-keyword">import</span> Image, display
display(Image(agentic_rag.get_graph().draw_mermaid_png()))
</code></pre>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0ecc8e3b96a42ca94bf85dbcc1d38ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764212427&amp;x-signature=hJkZZIBJU7UlRxLExq%2BfuBQmR9U%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Docker + Spring Boot：天生一对的完美部署]]></title>    <link>https://juejin.cn/post/7574318108720709678</link>    <guid>https://juejin.cn/post/7574318108720709678</guid>    <pubDate>2025-11-20T02:57:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574318108720709678" data-draft-id="7574625040629678118" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Docker + Spring Boot：天生一对的完美部署"/> <meta itemprop="keywords" content="后端,Java,Docker"/> <meta itemprop="datePublished" content="2025-11-20T02:57:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悟空码字"/> <meta itemprop="url" content="https://juejin.cn/user/3139860942296830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Docker + Spring Boot：天生一对的完美部署
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860942296830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悟空码字
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T02:57:34.000Z" title="Thu Nov 20 2025 02:57:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>使用Docker部署Spring Boot项目能极大简化环境配置和应用分发。下面是一个清晰的操作流程，以及一些常见问题的解决方法。</p>
<h3 data-id="heading-0">🚀 部署Spring Boot项目到Docker</h3>
<p>要将Spring Boot项目部署到Docker，主要流程是：准备项目、创建Docker镜像、运行Docker容器。以下是关键步骤：</p>
<ol>
<li>
<p><strong>准备Spring Boot项目</strong><br/>
首先，你需要一个可运行的Spring Boot项目，并将其打包成JAR文件。你可以使用Maven命令<code>mvn clean package</code>在项目根目录下完成打包。打包后，生成的JAR文件通常位于项目下的<code>target</code>目录中。</p>
</li>
<li>
<p><strong>编写Dockerfile</strong><br/>
在项目<strong>根目录</strong>下创建一个名为<code>Dockerfile</code>的文件（没有后缀），它是构建Docker镜像的蓝图。这里是一个参考示例：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用OpenJDK作为基础镜像</span>
FROM openjdk:11-jre-slim

<span class="hljs-comment"># 设置工作目录</span>
WORKDIR /app

<span class="hljs-comment"># 将本地的JAR文件复制到容器中的/app目录下，并重命名为app.jar</span>
COPY target/your-spring-boot-app.jar app.jar

<span class="hljs-comment"># 暴露Spring Boot应用默认的8080端口</span>
EXPOSE 8080

<span class="hljs-comment"># 设置启动命令</span>
ENTRYPOINT [<span class="hljs-string">"java"</span>, <span class="hljs-string">"-jar"</span>, <span class="hljs-string">"app.jar"</span>]
</code></pre>
<p><strong>注意</strong>：请务必将<code>your-spring-boot-app.jar</code>替换为你实际的JAR文件名。</p>
</li>
<li>
<p><strong>构建Docker镜像</strong><br/>
在终端中，进入到包含<code>Dockerfile</code>的项目根目录，执行以下命令来构建镜像：</p>
<pre><code class="hljs language-erlang" lang="erlang">docker build -t your-spring-boot-app:latest .
</code></pre>
<p><code>-t</code>参数用于给镜像命名和打标签。</p>
</li>
<li>
<p><strong>运行Docker容器</strong><br/>
镜像构建成功后，使用以下命令来启动容器：</p>
<p>bash</p>
<pre><code class="hljs language-arduino" lang="arduino">docker run -d -p <span class="hljs-number">8080</span>:<span class="hljs-number">8080</span> --name your-container-name your-spring-boot-app:latest
</code></pre>
<ul>
<li><code>-d</code>：表示容器在后台运行。</li>
<li><code>-p 8080:8080</code>：将主机的8080端口映射到容器的8080端口。</li>
<li><code>--name</code>：为容器指定一个名称。</li>
</ul>
</li>
</ol>
<p>完成以上步骤后，你就可以通过浏览器访问 <code>http://你的服务器IP:8080</code> 来查看你的应用了。</p>
<h3 data-id="heading-1">⚠️ 常见问题与解决方法</h3>
<p>在部署过程中，你可能会遇到一些典型问题，这里提供一些解决方案：</p>

















<table><thead><tr><th>问题现象</th><th>可能原因与解决方法</th></tr></thead><tbody><tr><td><strong>构建镜像时无法下载JDK基础镜像</strong>（错误信息可能包含 <code>failed to resolve source metadata</code> 或 <code>DeadlineExceeded</code>）</td><td><strong>网络问题</strong>：Docker默认从Docker Hub拉取镜像，国内网络环境可能导致速度慢或失败。 <strong>解决方法</strong>：配置<strong>国内镜像加速器</strong>。例如，在Docker Desktop中，进入设置 -&gt; Docker Engine，在配置中添加如 <code>https://hub-mirror.c.163.com</code>、<code>https://mirror.baidubce.com</code> 等镜像地址。</td></tr><tr><td><strong>执行 <code>docker build</code> 命令时，提示 <code>COPY failed: file not found</code></strong></td><td><strong>JAR文件路径错误</strong>：<code>Dockerfile</code>中<code>COPY</code>指令指定的JAR文件路径或名称与实际不符。 <strong>解决方法</strong>：确认项目已成功执行<code>mvn package</code>命令打包，并检查<code>Dockerfile</code>中<code>COPY</code>指令的源JAR文件路径和文件名是否正确<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Flinxingliang%2Farticle%2Fdetails%2F149183628" target="_blank" title="https://blog.csdn.net/linxingliang/article/details/149183628" ref="nofollow noopener noreferrer"/>。</td></tr></tbody></table>
<h3 data-id="heading-2">💡 进阶使用：Docker Compose</h3>
<p>如果你的应用还依赖其他服务，例如MySQL、Redis等，推荐使用<code>Docker Compose</code>来定义和运行多容器应用。</p>
<ol>
<li>
<p>在项目根目录下创建一个<code>docker-compose.yml</code>文件。</p>
</li>
<li>
<p>下面是一个简单的示例，它同时启动了Spring Boot应用和MySQL数据库：</p>
<p>yaml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">app:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">your-spring-boot-app:latest</span>  <span class="hljs-comment"># 使用你构建的Spring Boot应用镜像</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8080:8080"</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">db</span>  <span class="hljs-comment"># 表明应用依赖于db服务</span>

  <span class="hljs-attr">db:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:5.7</span>  <span class="hljs-comment"># 使用MySQL 5.7的官方镜像</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">root_password</span>
      <span class="hljs-attr">MYSQL_DATABASE:</span> <span class="hljs-string">your_database_name</span>
      <span class="hljs-attr">MYSQL_USER:</span> <span class="hljs-string">your_database_user</span>
      <span class="hljs-attr">MYSQL_PASSWORD:</span> <span class="hljs-string">your_database_password</span>
</code></pre>
</li>
<li>
<p>在终端中，进入该文件所在目录，运行<code>docker-compose up</code>命令，即可一键启动所有服务。</p>
</li>
</ol>
<h3 data-id="heading-3">💎 总结</h3>
<p>总的来说，使用Docker部署Spring Boot项目主要包含四个步骤：<strong>打包项目 → 编写Dockerfile → 构建镜像 → 运行容器</strong>。掌握这个流程，你就能轻松地将自己的应用容器化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95603a04ecae4222b733c80dcccf0a7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764212254&amp;x-signature=QloIza0nZ3BNwhVo8ajHs0JBABQ%3D" alt="image.png" loading="lazy"/></p>
<p><strong>谢谢你看我的文章，既然看到这里了，如果觉得不错，随手点个赞、转发、在看三连吧，感谢感谢。那我们，下次再见。</strong></p>
<p>您的一键三连，是我更新的最大动力，谢谢</p>
<p>山水有相逢，来日皆可期，谢谢阅读，我们再会</p>
<p>我手中的金箍棒，上能通天，下能探海</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我的王者荣耀有救了！谷歌发布游戏 SIMA 2，不开外挂「像人一样」练级]]></title>    <link>https://juejin.cn/post/7574357603406168114</link>    <guid>https://juejin.cn/post/7574357603406168114</guid>    <pubDate>2025-11-20T02:39:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574357603406168114" data-draft-id="7574568258789294131" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我的王者荣耀有救了！谷歌发布游戏 SIMA 2，不开外挂「像人一样」练级"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-20T02:39:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我的王者荣耀有救了！谷歌发布游戏 SIMA 2，不开外挂「像人一样」练级
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T02:39:43.000Z" title="Thu Nov 20 2025 02:39:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9522a841c2f14a50848ac66f8dafb693~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211183&amp;x-signature=804bTvF8ZcIrQgH8HkM2WL9gPY8%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】如果一个 AI，像人类一样看屏幕、敲键鼠、自己练级变强，这种游戏搭子，你愿意拥有吗？可能不久将来，类似王者荣耀、DOTA 2 这样的游戏就可以选择和 AI 组队，而不是和人组队了！」</strong></h5>
<p>想象一个智能体，它「出生」在一个虚拟 3D 游戏中，能推理，能学习。</p>
<p>并且，它不走后门，去操纵游戏底层指令，而是和人一样，只「观看」屏幕画面，并且使用「虚拟键盘和鼠标」来进行操作。</p>
<p>也就是，创造一个智能体，但完完全全「像人一样」去打游戏。</p>
<p>这就是谷歌 DeepMind 推出的 SIMA 2 智能体！</p>
<p>一个能陪你在虚拟世界中一同游戏、推理和学习的智能体。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a947d0f923e44fa49a81b840efa83c3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211183&amp;x-signature=%2FOnaDd2Dx8t1V7FNG2d0IAZGH7s%3D" alt="" loading="lazy"/></p>
<p>我觉得 DeepMind 才是那个不忘初心的「Open」AI 公司。</p>
<p>不管是从下围棋的 AlphaGo 再到破解生命之谜的 AlphaFold 等等 Alpha 系列。</p>
<p>然后还有谷歌主打的 Gemini 大模型系列，以及世界模型 Genie 3 系列，等等。</p>
<p>可以说谷歌在 AI 领域是全方面、全栈式发力。</p>
<p>SIMA 2 可以说是朝着通用人工智能方向迈出的重要一步。</p>
<p>SIMA，全称 Scalable Instructable Multiworld Agent，可扩展指令多世界智能体。</p>
<p>别看现在它只是观看屏幕打游戏，如果能够「像人」一样理解游戏画面并做出正确的操作。</p>
<p>那么可以将这种推理和理解能力扩展到其他世界中，甚至也可以拓展到具身智能，这就是 SIMA 真正的野心。</p>
<p>这意味着，可能不久以后，我们就可以在游戏中组队类似 SIMA 智能体。</p>
<p>我的 DOTA2、我的王者荣耀、我的英雄联盟手游好像终于有救，希望以后的 MOBA 类游戏都能出一个类似的选项，选择和 AI 组队，而不是和人组队。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3281bb431b56466c9b95cda0de214c03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211183&amp;x-signature=zS2bpw3wItWguqkyz2TZO3MnQE8%3D" alt="" loading="lazy"/></p>
<p><strong>「推理的力量」</strong></p>
<p>在 SIMA 1 中，智能体学会了执行超过 600 种语言指令技能，例如拍梯子、打开地图。</p>
<p>在 SIMA 2 中，智能体已经可以突破单纯的指令跟随的局限。</p>
<p>通过将 Gemini 作为智能体的核心引擎，SIMA 2 不仅能响应指令，还能对指令进行思考与推理。</p>
<p>比如下面 MineDojo 游戏中，SIMA 2 可以完全在这个「从未见过」的游戏中，靠着推理能力完成任务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30cfc5ae3e004321ba3042880e6547b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211183&amp;x-signature=RixGi1LyS%2FJOXFDyqPZXXi1T%2BcE%3D" alt="" loading="lazy"/></p>
<p>SIMA 2 是用什么数据训练的呢？</p>
<p>DeepMind 使用带有人类演示视频、语言标签以及 Gemini 生成标签的混合数据对 SIMA 2 进行训练。</p>
<p>某种意义上，这种思路和特斯拉 FSD 的端到端具有异曲同工之妙，再更深一步，只要给 AI 数据和算力，AI 肯定能学会「人类这点能力」。</p>
<p>SIMA 2 不仅能响应用户提问，还能对其自身行为及所处环境进行逻辑推理。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59fb3944da1840ce8bef78cbd9e69b04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211183&amp;x-signature=gPNa2V%2FFqj5KynxQG0Gvr1NTvq0%3D" alt="" loading="lazy"/></p>
<p>研究人员在博客中也感慨，与 SIMA 2 互动时，真的感觉更像是在与一个「伙伴、游戏搭子」一起系统合作。</p>
<p>这或许也算是 SIMA 2 通过游戏上的「图灵测试」。</p>
<p>谷歌认为这个能力的底层逻辑还是 Gemini 带来的，靠着强大的推流能力，SIMA 2 可以在复杂的 3D 环境中进行感知。</p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5f947037ab64225b77f1e7e945027f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211183&amp;x-signature=lJn%2FhCUCEkmLid1Wy1hKOQv5zUs%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「泛化能力飞跃」</strong></p>
<p>谷歌推出 SIMA 2，除了用游戏训练是初期最合适的手段外，另一个考量就是增强智能体的泛化能力。</p>
<p>SIMA 2 能够理解并完成长期复杂的任务。</p>
<p>短期指令，比如左转、走三步、爬梯子都是比较容易了，但是如何完整的「打通」游戏关卡才是验证通用能力的关键。</p>
<p>SIMA 2 现在可以在未经预训练的情况下攻克全新的游戏。（左边是 Gemini 的推理过程，右边是 SIMA 在操作游戏）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be3fd521a0294bc480a72c4cc92bad1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211183&amp;x-signature=TQdEgif6b4oq1KwkkBwkz01Ntlo%3D" alt="" loading="lazy"/></p>
<p>除了语言指令，SIMA 2 还能理解多模态的提示。</p>
<p>比如，用户在画面中绘制一个路线草图，SIMA 理解玩家的意思，然后再操作。</p>
<p>在游戏中画个红框 + 箭头，让智能体据此操作。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36c089ed206c4be98f858af5302693aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211183&amp;x-signature=P4PVJElaj4MkBk19EyFq5CFGLkE%3D" alt="" loading="lazy"/></p>
<p>其他的理解能力还有，符号。</p>
<p>比如用户发送一个🪓+ 树木的表情符号，然后智能体就屁颠颠的说「好吧，我不睡，我去砍树去」。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d4af20daaa04057a2b714a51ca7dab3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211183&amp;x-signature=38ZS%2BM7YMUQpuwqAPYTW40GowaY%3D" alt="" loading="lazy"/></p>
<p>泛化能力的另一个体现是在不同游戏之间的迁移。</p>
<p>比如 A 游戏中学会的「挖掘」，可以应用于 B 游戏的「采集」。</p>
<p>下面这个图展示 SIMA 2 相对 SIMA 1 能力的巨大提升。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f43d85bff1e64ff1a4d5d79b93fd36ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211183&amp;x-signature=kTEAZvS8fRi8Z%2Fgtofm8b8LRLh4%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d38fc780c59e4639aef6f3284730e5d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211183&amp;x-signature=MOCv6%2BtBs1mdrqtLfvV9XShvRMQ%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「终极考验：畅游想象世界」</strong></p>
<p>谷歌为了测试 SIMA 2 的泛化能力，使用了 Genie 3 来配合。</p>
<p>Genie 3 生成全新的 3D 模拟世界，然后让 SIMA 2 在这些「架空世界」中行动。</p>
<p>Genie 3 本身会遵循物理规律生成世界，但是和真实世界的展现又可能完全不同。</p>
<p>谷歌的测试结果是，SIMA 2 依然能保持良好的环境适应能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2601cc1034df48af9cff70151c7f2d13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211183&amp;x-signature=Vb5lcUm7NTJZcMKHmg%2BDV5agnwo%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cef365499578470b957c59d96188d45a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211183&amp;x-signature=re6RWq45KjZX19l0UjfjEM2fXfc%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「可扩展的多任务自我提升」</strong></p>
<p>SIMA 2 最令人兴奋的能力是能够自我学习，自我进化，自我提升。</p>
<p>谷歌说在整个训练过程中，SIMA 2 智能体能够通过试错和基于 Gemini 的反馈引导，执行更加复杂的任务。</p>
<p>在最初从人类示范中学习后，SIMA 2 能够过渡到完全通过自主游戏继续学习。</p>
<p>在全新世界学习时，无需额外的人类生成数据。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c60293d5181c497f90c22a2e5e803f3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211183&amp;x-signature=7QT86zZw3pmSD1x91952VLLwIBk%3D" alt="" loading="lazy"/></p>
<p>左侧展示的是初代 SIMA 2 智能体未能完成的任务示例。</p>
<p>而右侧则显示经过多轮训练迭代后，SIMA 2 已实现自我提升，整个过程完全无需人类反馈或游戏数据介入。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86c3d490942b486dab80388f1cf4f4bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764211183&amp;x-signature=1Pfp3G79c%2F%2BHD9Y2u6kWOByO7Ek%3D" alt="" loading="lazy"/></p>
<p>SIMA 2 能在很多不同类型的游戏里运行，这对检验「通用智能」非常关键。</p>
<p>在这些游戏中，智能体可以学会各种技能、练习复杂的推理，还能通过自己玩游戏不断提升能力。</p>
<p>不过，SIMA 2 目前还是研究阶段的系统，离真正的「通用具身智能」还有距离。</p>
<p>它在处理那种特别长、特别复杂、需要很多步推理和反复检查目标的大任务时，还是会吃力。</p>
<p>它对交互过程的记忆也不算长，只能在有限的上下文里工作，以保证响应足够快。</p>
<p>另外，想要只用键盘鼠标就做出非常精细的操作，或者稳定地看懂复杂的 3D 场景，这些在整个领域里都还是难题。</p>
<p>这项研究说明了一条新的路：</p>
<p>通过大量、多类型的虚拟世界数据，加上 Gemini 很强的推理能力，可以训练出一个通用的智能体，把原本分散在不同专用系统里的能力整合到一起。</p>
<p>SIMA 2 也为未来的机器人应用打下了基础。</p>
<p>它学到的能力——比如导航、用工具、和他人协作完成任务——正是将来让机器人在现实世界中成为「智能助手」所需要的底层模块。</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeepmind.google%2Fblog%2Fsima-2-an-agent-that-plays-reasons-and-learns-with-you-in-virtual-3d-worlds%2F" target="_blank" title="https://deepmind.google/blog/sima-2-an-agent-that-plays-reasons-and-learns-with-you-in-virtual-3d-worlds/" ref="nofollow noopener noreferrer">deepmind.google/blog/sima-2…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[万字记录：信创上云，国产系统Kylin 压测容器重启，接口响应耗时过长问题排查（openjdk17）]]></title>    <link>https://juejin.cn/post/7574276404596555828</link>    <guid>https://juejin.cn/post/7574276404596555828</guid>    <pubDate>2025-11-19T15:32:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574276404596555828" data-draft-id="7574308545525530639" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="万字记录：信创上云，国产系统Kylin 压测容器重启，接口响应耗时过长问题排查（openjdk17）"/> <meta itemprop="keywords" content="JVM"/> <meta itemprop="datePublished" content="2025-11-19T15:32:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="54ping"/> <meta itemprop="url" content="https://juejin.cn/user/2084329779111320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            万字记录：信创上云，国产系统Kylin 压测容器重启，接口响应耗时过长问题排查（openjdk17）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2084329779111320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    54ping
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T15:32:51.000Z" title="Wed Nov 19 2025 15:32:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">信创上云，国产系统Kylin 压测容器重启，接口响应耗时过长问题排查（openjdk17）</h2>
<p>（内含 60 个 jvm 参数详解、调优思路说明）</p>
<blockquote>
<p>最近扎进信创上云的落地实战，碰到了一个棘手的问题 —— 国产操作系统搭配容器化部署后，核心接口出现了RT拉长、偶发OOM的情况。</p>
<p>搁以前，遇到这类问题常能靠扩容硬件快速化解，内存不够加内存、CPU过载扩节点，JVM调优没什么用武之地。</p>
<p>现在不一样了，都在搞节能减排...呸！降本增效那一套，裁员降薪后服务器资源也一砍再砍，“堆硬件”的简单解法行不通了。</p>
<p>反而倒逼我们沉下心，在信创上云+国产OS容器重启的特定场景里，主动排查根因、攻坚优化，这次就把整个排查过程整理出来和大家分享。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38ebef262a5c4b0bac34dbf70d12daa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=6Qy%2BUe3j9%2BmXVIhxG4bF%2B%2FAH7Yw%3D" alt="MindMap - 信创容器重启及接口响应时间（RT）过长排查.png" loading="lazy"/></p>
<p>▶️▶️▶️ 正文开始 ▶️▶️▶️</p>
<h3 data-id="heading-1">问题一：测试环境发生重启</h3>
<h4 data-id="heading-2">一、现象描述</h4>
<p>Java 服务一开始压测，1小时内必重启。通过 "容器云平台监控" 发现：</p>
<ul>
<li>进程消失了，健康检查失败，故服务重启。</li>
<li>重启前系统资源监控显示 <code>cpu 使用率 100%</code>, <code>内存使用率 98+%</code></li>
</ul>
<h4 data-id="heading-3">二、检查日志和配置</h4>
<h5 data-id="heading-4">1. 主要检查点</h5>
<ol start="0">
<li>检查 是否生成 <code>heapdump（堆转储）</code>文件</li>
<li>检查 <code>GC 日志</code></li>
<li>检查 <code>容器编排配置</code> 文件</li>
<li>检查 <code>容器启动脚本</code></li>
</ol>
<h5 data-id="heading-5">2. 检查结果</h5>
<p>未发现堆转储（heapdump）文件，无 GC 日志；</p>
<p>——&gt; 检查容器 <code>编排配置</code> 和 <code>启动脚本</code>，</p>
<p>——&gt; 均未开启 gc 日志，启动脚本 heapdump 路径非容器挂载路径。</p>
<h5 data-id="heading-6">3. 调整 JVM 参数</h5>
<p>调整 <code>run.sh</code>, 必须包含如下 jvm 参数，</p>
<p>涉及目录路径都要用容器挂载路 <code>spec.containers.args.volumeMounts.mountPath</code></p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 发生 OOM 时，JVM 终止退出</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+ExitOnOutOfMemoryError</span> 
<span class="hljs-comment"># 发生 OOM 时生成 Java 堆转储</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+HeapDumpOnOutOfMemoryError</span> 
​
<span class="hljs-comment"># 堆转储文件保存位置</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:HeapDumpPath=/logs/</span><span class="hljs-variable">${</span><span class="hljs-variable constant_">POD_NAMESPACE</span>}/<span class="hljs-variable">${</span><span class="hljs-variable constant_">APP_NAME</span>}/heapdump_start_<span class="hljs-variable">$(</span>date +<span class="hljs-string">"%Y-%m-%d_%H%M%S"</span>).hprof 
​
<span class="hljs-comment"># JVM 发生致命错误时，日志文件保存位置</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:ErrorFile=/logs/</span><span class="hljs-variable">${</span><span class="hljs-variable constant_">POD_NAMESPACE</span>}/<span class="hljs-variable">${</span><span class="hljs-variable constant_">APP_NAME</span>}/<span class="hljs-variable">${</span><span class="hljs-variable constant_">HOSTNAME</span>}-hs_err_pid.<span class="hljs-variable">$$</span>.log 
​
<span class="hljs-comment"># 开启 gc 日志</span>
-<span class="hljs-title class_">Xlog</span><span class="hljs-symbol">:gc*</span><span class="hljs-symbol">:file=/logs/</span><span class="hljs-variable">${</span><span class="hljs-variable constant_">POD_NAMESPACE</span>}/<span class="hljs-variable">${</span><span class="hljs-variable constant_">APP_NAME</span>}/gc-%t.<span class="hljs-symbol">log:</span>hostname,time,uptime,<span class="hljs-symbol">pid:</span>filecount=<span class="hljs-number">5</span>,filesize=10M 
</code></pre>
<p>还需要在 <code>start_java_server</code> 函数中添加 <strong>日志清理</strong> 的代码：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-function"><span class="hljs-title">start_java_server</span></span>(){
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"----start java process----"</span>
  
  <span class="hljs-built_in">touch</span> /app/bin/test.log
  
  <span class="hljs-built_in">eval</span> java <span class="hljs-variable">$JAVA_OPTS</span> -jar <span class="hljs-variable">$appname</span>
  
<span class="hljs-comment">#  tail -f /app/bin/test.log # 这行代码不要了，可以直接删除</span>
  
  <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-comment"># 清理两天前的 gc 日志</span>
    find <span class="hljs-string">"<span class="hljs-variable">${LOG_PATH}</span>"</span> -mtime +2 -<span class="hljs-built_in">type</span> f -name <span class="hljs-string">"*.log*"</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> {} ;
    <span class="hljs-comment"># 清理 7 天前的 kafka 故障转移日志</span>
    find <span class="hljs-string">"<span class="hljs-variable">${LOG_PATH}</span>"</span> -mtime +7 -maxdepth 1 -<span class="hljs-built_in">type</span> d -not -name <span class="hljs-string">"*<span class="hljs-variable">${HOSTNAME}</span>*"</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> -rf {} ;
    <span class="hljs-comment"># 24 小时执行一次</span>
    <span class="hljs-built_in">sleep</span> 86400
  <span class="hljs-keyword">done</span>
}
</code></pre>
<h5 data-id="heading-7">4. 部署验证</h5>
<p>重启后仍然没有 <code>heapdump</code> 文件，观察 <code>GC 日志</code>，垃圾回收正常。</p>
<h4 data-id="heading-8">三、检查 Linux 内核日志</h4>
<p>执行命令：</p>
<pre><code class="hljs language-perl" lang="perl">dmesg | <span class="hljs-keyword">grep</span> -iE <span class="hljs-string">"killed.*java"</span>
</code></pre>
<p>发现如下日志：</p>
<pre><code class="hljs language-arduino" lang="arduino">Killed process <span class="hljs-number">1939065</span> (java) total-vm:<span class="hljs-number">131428792</span>kB, anon-rss:<span class="hljs-number">869604</span>kB, file-rss:<span class="hljs-number">0</span>kB, shmem-rss:<span class="hljs-number">6678808</span>kB
</code></pre>
<h5 data-id="heading-9">1. 定位原因</h5>
<p>通过 dmesg 日志发现 java 进程被 kill，其中异常指标为：</p>
<ul>
<li><code>shmem-rss</code>: 共享内存（Shared Memory）驻留大小（Resident Set Size）约 6.37G</li>
</ul>
<h5 data-id="heading-10">2. 为什么共享内存这么高？</h5>
<p>通过查阅资料了解到 ZGC 为了实现<strong>亚毫秒级停顿</strong>，使用了<strong>多视图映射技术</strong>，这项技术<strong>重度依赖共享内存</strong>的使用。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span>
​
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// 创建一个共享内存的文件描述符</span>
    <span class="hljs-type">int</span> fd = <span class="hljs-built_in">shm_open</span>(<span class="hljs-string">"/example"</span>, O_RDWR | O_CREAT | O_EXCL, <span class="hljs-number">0600</span>);
    <span class="hljs-keyword">if</span> (fd == <span class="hljs-number">-1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-comment">// 防止资源泄露，需要删除。执行之后共享对象仍然存活，但是不能通过名字访问</span>
    <span class="hljs-built_in">shm_unlink</span>(<span class="hljs-string">"/example"</span>); 
    
    <span class="hljs-comment">// 将共享内存对象的大小设置为4字节</span>
    <span class="hljs-type">size_t</span> size = <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint32_t</span>);
    <span class="hljs-built_in">ftruncate</span>(fd, size); 
    
    <span class="hljs-comment">// 两次调用mmap，把一个共享内存对象映射到两个虚拟地址上。</span>
    <span class="hljs-type">int</span> prot = PROT_READ | PROT_WRITE;    
    <span class="hljs-type">uint32_t</span> *add1 = <span class="hljs-built_in">mmap</span>(<span class="hljs-literal">NULL</span>, size, prot, MAP_SHARED, fd, <span class="hljs-number">0</span>);
    <span class="hljs-type">uint32_t</span> *add2 = <span class="hljs-built_in">mmap</span>(<span class="hljs-literal">NULL</span>, size, prot, MAP_SHARED, fd, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 关闭文件描述符</span>
    <span class="hljs-built_in">close</span>(fd);
    
    <span class="hljs-comment">// 测试，通过一个虚拟地址设置数据，两个虚拟地址得到相同的数据</span>
    *add1 = <span class="hljs-number">0xdeafbeef</span>;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Address of add1 is: %p, value of add1 is: 0x%x\n"</span>, add1, *add1);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Address of add2 is: %p, value of add2 is: 0x%x\n"</span>, add2, *add2);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h5 data-id="heading-11">3. 多视图映射技术</h5>
<blockquote>
<p>有兴趣的可以看看（可以跳过）</p>
</blockquote>

























<table><thead><tr><th>视图</th><th>作用</th><th>对象状态</th></tr></thead><tbody><tr><td>Marked0</td><td>标记周期0的存活对象</td><td>第一次标记后存活</td></tr><tr><td>Marked1</td><td>标记周期1的存活对象</td><td>第二次标记后存活</td></tr><tr><td>Remapped</td><td>已重定位的对象</td><td>转移完成后</td></tr></tbody></table>
<ul>
<li>并发标记（mark）</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 传统GC：需要暂停应用来标记对象</span>
<span class="hljs-comment">// ZGC：完全并发标记，无暂停</span>
​
<span class="hljs-comment">// 标记过程：</span>
<span class="hljs-comment">// 1. 应用线程正常访问对象（通过Remapped视图）</span>
<span class="hljs-comment">// 2. GC线程并发标记，将对象指针切换到Marked0/Marked1视图</span>
<span class="hljs-comment">// 3. 应用线程无感知，继续执行</span>
</code></pre>
<ul>
<li>并发转移（relocate）</li>
</ul>

<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 传统GC：转移对象需要暂停应用</span>
<span class="hljs-comment">// ZGC：并发转移 + 指针自愈</span>
​
<span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> heap.getObject(pointer);  <span class="hljs-comment">// 正常访问</span>
<span class="hljs-comment">// 如果对象正在被转移：</span>
<span class="hljs-comment">// 1. 触发页面异常（page fault）</span>
<span class="hljs-comment">// 2. ZGC处理器将对象转移到新位置</span>
<span class="hljs-comment">// 3. 更新指针到新地址（指针自愈）</span>
<span class="hljs-comment">// 4. 应用线程继续执行，无感知</span>
</code></pre>
<ul>
<li>指针自愈（remap）</li>
</ul>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 指针结构（64位）</span>
<span class="hljs-selector-attr">[ 62位地址 | 2位元数据 ]</span>
​
<span class="hljs-comment">// 元数据位含义：</span>
<span class="hljs-number">00</span> → Remapped 视图
<span class="hljs-number">01</span> → Marked0   视图
<span class="hljs-number">10</span> → Marked1   视图
<span class="hljs-number">11</span> → 保留
​
<span class="hljs-comment">// 当应用访问"旧"指针时：</span>
if (指针视图 != 当前活动视图) {
    <span class="hljs-comment">// 触发指针自愈逻辑</span>
    新指针 = 查找转发表(旧指针);
    <span class="hljs-comment">// 原子性地替换指针</span>
    <span class="hljs-built_in">CAS</span>(对象指针, 旧指针, 新指针);
}
</code></pre>
<h5 data-id="heading-12">4. 调整配置</h5>
<p>这里尝试调整了各种容器编排配置、JVM 参数、Linux 系统参数，都没有效果，最后决定 <strong>放弃 ZGC</strong>，改用 <strong>G1 垃圾回收器</strong>，并补充了一些内存限制参数。</p>
<p>调整 <code>run.sh</code> 添加如下 JVM 参数：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 1C3G 容器配置参考</span>
​
<span class="hljs-comment"># 让 JVM 知道当前运行环境是容器，防止 JVM 读取宿主机的配置</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+UseContainerSupport</span> 
<span class="hljs-comment"># 这里配置容器限制内存，避免 JVM 读取宿主机配置</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:MaxRAM=</span><span class="hljs-number">3072</span> 
<span class="hljs-comment"># JVM 可以使用的最大内存 75% * MaxRAM</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:MaxRAMPercentage=</span><span class="hljs-number">75.0</span> 
​
<span class="hljs-comment"># 删除 ZGC 相关的 JVM 参数，使用 G1 垃圾回收器</span>
<span class="hljs-comment"># 使用 G1 必须删除 -Xmn 配置</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+UseG1GC</span> 
</code></pre>
<h5 data-id="heading-13">5. 部署验证</h5>
<p>不再出现重启。</p>
<h3 data-id="heading-14">问题二：生产环境发生重启</h3>
<h4 data-id="heading-15">一、现象描述</h4>
<p>Java 服务压测发生重启，通过 <code>dmesg</code> 命令查看 Linux 内核日志：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5abd95ca3aa04f8d83110cc1aab16230~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=A%2B1h8ua%2BFXhXTEGW9mXgvDTBdM8%3D" alt="cgroupOOM.jpg" loading="lazy"/></p>
<p>如图所示（<code>最底下3行</code>），<strong>发生了 OOM, java 进程被系统 kill 了</strong>，anon-rss 显示约 <code>2.97G</code>, 其中 java 进程 rss（驻留内存）785586 数据页，<code>785586 * 4kB ≈ 3G</code>.</p>
<blockquote>
<p>与先前测试环境重启现象不同，生产压测的接口也与测试环境不一样。</p>
</blockquote>
<h4 data-id="heading-16">二、测试环境复现</h4>
<p>通过相同的接口压测，立马在测试环境复现了生产环境的问题。</p>
<h5 data-id="heading-17">1. 初步分析</h5>
<p>同样是没有 heapdump 文件生成、GC 正常，但 Linux 内核日志显示 <code>Memory cgroup out of memory</code>.执行 <code>cat /proc/${PID}/cmdline | tr '\0' '\n'</code> 检查 jvm 参数，如下参数存在：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 发生 OOM 时，JVM 终止退出</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+ExitOnOutOfMemoryError</span> 
<span class="hljs-comment"># 发生 OOM 时生成 Java 堆转储</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+HeapDumpOnOutOfMemoryError</span> 
<span class="hljs-comment"># 堆转储文件保存位置</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:HeapDumpPath=/logs/</span>...
</code></pre>
<p>那么，没有发现 heapdump 文件就意味着 JVM 内存没有溢出。</p>
<h5 data-id="heading-18">2. 工具分析</h5>
<p>使用 jmc, jvisualvm, arthas 监控 JVM 内存变化，所有区域（堆、元空间、线程数、直接内存）内存一直很平稳，一直到 java 进程被杀，JVM 内存使用情况都一直在安全区域，甚至离我设置的最大值还差很多。</p>
<p>再次确认 ———— <strong>JVM 内存不存在 OOM 问题</strong>。</p>
<h5 data-id="heading-19">3. 参数调优</h5>
<p>确定了 JVM 内存不存在溢出，那就是 JVM 之外的内存发生了溢出，常见的有：</p>
<ul>
<li><code>java.nio.*</code> 库的方法调用，比如 <code>ByteBuffer.allocateDirect</code></li>
<li><code>sun.misc.Unsafe</code> 类的方法调用</li>
</ul>
<p>这些方法底层都是 使用 <code>JNI（Java Native Interface）的方式</code> 调用 C/C++ 库的函数，这部分函数的执行、内存分配、内存管理 <strong>由操作系统控制，JVM 管不到</strong>。</p>
<blockquote>
<p>调优策略 - 因为 JVM 无法管理 native 区域的内存，也监控不到，那就先把容器内存限制调大，看看到底内存能涨到多少，再调整参数。</p>
</blockquote>
<p>具体如下：</p>
<ul>
<li>
<p>内存调整到 <code>4G</code> ——&gt; 压测</p>
<ul>
<li><strong>溢出</strong></li>
</ul>
</li>
<li>
<p>缩小 heap、metaspace、thread-stack、direct 区域的内存，尽可能把空间都留给 native 区</p>
<ul>
<li><strong>还是溢出</strong></li>
</ul>
</li>
<li>
<p>优化 <code>高CPU占用</code> 的线程调用链上的方法（日志相关）：减少日志输出，调整日志相关的缓存、队列、IO 等参数</p>
<ul>
<li><strong>还是溢出</strong></li>
</ul>
</li>
<li>
<p>调整 log4j2.xml 中 kafka 相关参数，降低 cpu &amp; memory 消耗</p>
<ul>
<li><strong>还是溢出</strong></li>
</ul>
</li>
<li>
<p>调整 nio 相关参数，降低 cpu &amp; memory 消耗</p>
<ul>
<li><strong>还是溢出</strong></li>
</ul>
</li>
<li>
<p>内存调整到 <code>6G</code> 并调整日志输出级别为 ERROR ——&gt; <strong>压测 48 小时</strong></p>
<ul>
<li><strong>没有溢出，内存占用飙升到 5G 多</strong></li>
</ul>
</li>
</ul>
<h5 data-id="heading-20">4. 定位原因</h5>
<p>无论怎么调整，JVM 内存始终稳定在 2G 以内，那多出来的 3G+ 就是 JNI 产生的内存（native memory）。</p>
<p><strong>以上是重点，以下是弯路（方向不对，白费功夫，引以为戒）：</strong></p>
<ul>
<li>
<p>尝试各种命令，写了近 10 个监控脚本，试图追踪 “造成 3G+ native 内存” 的元凶</p>
<ul>
<li>失败</li>
</ul>
</li>
<li>
<p>尝试各种工具，生成堆栈、线程栈，结合监控脚本和代码分析，试图定位 “真凶”</p>
<ul>
<li>失败</li>
</ul>
</li>
</ul>
<p><strong>回到重点：</strong></p>
<ul>
<li>
<p><code>JVM memory</code> vs <code>native memory</code> = <code>1.x : 3.x</code></p>
<ul>
<li>
<p>什么样的代码能导致怎样的比例？</p>
<ul>
<li>“内存泄漏” 的代码</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>native memory</code> <strong>100% 内存泄漏了!!!</strong></p>
<ul>
<li>
<p>通过监控、线程堆栈分析：</p>
<ul>
<li>不存在会产生大量 JNI 调用的 Java API</li>
</ul>
</li>
<li>
<p>通过监控、内存堆栈分析：</p>
<ul>
<li>不存在大量跟 JNI 有关的对象或类</li>
</ul>
</li>
</ul>
</li>
<li>
<p>结合其他情况判断，<strong>可能与业务代码无关</strong>：</p>
<ul>
<li>
<p>常规生产环境、常规测试环境都没有问题</p>
</li>
<li>
<p>其他服务也有重启的现象，gateway 服务也有重启的现象，它甚至都没有业务代码</p>
<ul>
<li>如果不是业务代码的问题，那是某个<strong>第三方依赖包有问题？</strong></li>
</ul>
</li>
<li>
<p>即使停止压测，内存也不会降下来</p>
<ul>
<li><strong>native memory 区域为什么不会回收？</strong></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>第三方依赖包有问题的概率比较小</strong>，毕竟这么夸张的内存泄漏，有问题也轮不到我发现</p>
</li>
</ul>
<h5 data-id="heading-21">5. 确定排查方向</h5>
<blockquote>
<p>既然 JVM 范围内找不出答案，索性从 JVM 之外找找看（<strong>知识盲区，整理上述分析结果，让 AI 给我提供思路</strong>）。</p>
</blockquote>
<ul>
<li>
<p>如图所示，我把 JVM 内存使用情况（需要开启参数<code>-XX:NativeMemoryTracking=summary</code>）喂给 AI 并简单描述了一下。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77dc877ff13844d89c0977d91dc65b74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=HgNNgBLhrNtuF5p0uzIMTgYmuu8%3D" alt="AI问答01-Java内存溢出.png" loading="lazy"/></p>
</li>
<li>
<p>AI 的回答，总结来说就是 <code>Metaspace</code> 的类数量很多，最可能发生溢出，还有就是监控相关的（这个忽略）
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2000d04a7b5b48e2bb50024ae41a7939~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=krPx8GIaMyqlmRuNeccgaqEbRNk%3D" alt="AI问答02-Java内存溢出-可能溢出区.png" loading="lazy"/></p>
</li>
<li>
<p>通过前面的分析，我很肯定的告诉他，<code>Metaspace</code> 不存在溢出，然后补充了详细描述：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a588b884ba3f4ba585932c4cb0cbded9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=OROKgWUiMlMM%2FMKz06MCJiM8uFM%3D" alt="AI问答03-Java内存溢出-Native内存溢出.png" loading="lazy"/></p>
</li>
<li>
<p>结论一致，就是 <code>Native Memory</code> 问题，然后给出很多排查方式，逐一验证，结果：</p>
<ul>
<li><code>gdb</code> 命令报错</li>
<li><code>lsof</code> 命令不存在</li>
<li>需要安装 <code>bpfcc-tools</code> 工具</li>
<li><code>pmap</code> 输出内容并没有什么帮助</li>
</ul>
</li>
<li>
<p>虽然很多验证不了，不过结合前面的分析，还是可以排除很多选项，最后锁定 <code>glibc arena</code> 缓存：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cf069b0c93d426591183b3ad2f01112~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=WEITOKzbRcxDm%2BGyyiM%2Bb%2FNoR9k%3D" alt="AI问答05-Java内存溢出-JVM之外区域.png" loading="lazy"/></p>
</li>
<li>
<p>继续追问 AI，如下描述和我观察到的现象如出一辙</p>
<ul>
<li><strong>glibc 的 malloc arena 缓存、不释放</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56fa6a1bb5cb4ece974f7cbf130341db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=nc7PA9rX3MaZhGKaM6I1l0AG2Z4%3D" alt="AI问答04-Java内存溢出-glibc arena缓存特征.png" loading="lazy"/></li>
</ul>
</li>
</ul>
<h4 data-id="heading-22">三、验证 jemalloc</h4>
<ul>
<li>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjemalloc.net%2F" target="_blank" title="https://jemalloc.net/" ref="nofollow noopener noreferrer">jemalloc.net/</a></li>
<li>GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjemalloc%2Fjemalloc" target="_blank" title="https://github.com/jemalloc/jemalloc" ref="nofollow noopener noreferrer">github.com/jemalloc/je…</a></li>
<li>下载 <code>jemalloc 5.3.0 源码</code>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjemalloc%2Fjemalloc%2Freleases%2Fdownload%2F5.3.0%2Fjemalloc-5.3.0.tar.bz2" target="_blank" title="https://github.com/jemalloc/jemalloc/releases/download/5.3.0/jemalloc-5.3.0.tar.bz2" ref="nofollow noopener noreferrer">github.com/jemalloc/je…</a></li>
</ul>
<h5 data-id="heading-23">1. 编译</h5>
<pre><code class="hljs language-bash" lang="bash">tar xvf jemalloc-5.3.0.tar.bz2
<span class="hljs-built_in">cd</span> jemalloc-5.3.0
./configure --prefix=<span class="hljs-variable">$HOME</span>/.local
make -j$(<span class="hljs-built_in">nproc</span>)
make install
​
<span class="hljs-comment"># 编译完成，拷贝 libjemalloc.so.2 到 /lib64</span>
<span class="hljs-built_in">cp</span> <span class="hljs-variable">$HOME</span>/.local/lib/libjemalloc.so.2 /lib64/
</code></pre>
<h5 data-id="heading-24">2. 修改容器启动脚本</h5>
<p><code>run.sh</code> 最顶部添加：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># ===== 关键内存参数 (必须放在最顶部) =====</span>
export <span class="hljs-attr">MALLOC_ARENA_MAX</span>=<span class="hljs-number">2</span>             <span class="hljs-comment"># 1核CPU只需2个arena (默认8)</span>
export <span class="hljs-attr">MALLOC_TRIM_THRESHOLD_</span>=<span class="hljs-number">131072</span>  <span class="hljs-comment"># 128KB空闲立即归还OS (默认128KB但失效)</span>
export <span class="hljs-attr">MALLOC_MMAP_THRESHOLD_</span>=<span class="hljs-number">131072</span>  <span class="hljs-comment"># &gt;128KB分配走mmap (独立释放)</span>
export <span class="hljs-attr">MALLOC_TOP_PAD_</span>=<span class="hljs-number">0</span>              <span class="hljs-comment"># 禁用顶部填充 (防碎片)</span>
export <span class="hljs-attr">GLIBC_TUNABLES</span>=glibc.malloc.trim_threshold=<span class="hljs-number">131072</span>  <span class="hljs-comment"># 双重保险</span>
​
<span class="hljs-comment"># ===== 强制使用 jemalloc（容器环境必须） =====</span>
export <span class="hljs-attr">LD_PRELOAD</span>=/lib64/libjemalloc.so.<span class="hljs-number">2</span>
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  A[Java 进程启动] --&gt; B{LD_PRELOAD 检查}
  B --&gt;|存在| C[加载 libjemalloc.so.2]
  B --&gt;|不存在| D[加载 glibc 的 malloc]
  C --&gt; E[替换符号表]
  E --&gt; F[所有 malloc/free 调用指向 jemalloc]
  D --&gt; G[所有 malloc/free 调用指向 glibc]
</code></pre>
<h5 data-id="heading-25">3. 深度优化</h5>
<p>在 <code>/etc/malloc.conf</code> 添加如下配置</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1C3G 容器黄金配置</span>
dirty_decay_ms:1000,      <span class="hljs-comment"># 1秒后归还 dirty pages</span>
muzzy_decay_ms:100,       <span class="hljs-comment"># 100ms后归还 muzzy pages</span>
background_thread:<span class="hljs-literal">true</span>,   <span class="hljs-comment"># 启用后台回收线程 (关键!)</span>
max_background_threads:1, <span class="hljs-comment"># 1核容器只需1个线程</span>
metadata_thp:auto,        <span class="hljs-comment"># 优化元数据内存</span>
tcache:<span class="hljs-literal">false</span>,             <span class="hljs-comment"># 禁用 thread cache (防 TLS 碎片)</span>
arena_bind:<span class="hljs-literal">true</span>,          <span class="hljs-comment"># 1核CPU绑定1个arena</span>
abort_conf:<span class="hljs-literal">true</span>           <span class="hljs-comment"># 配置错误时崩溃 (防静默失效)</span>
</code></pre>
<p>容器中可以在 <code>dockerfile</code> 文件中，通过如下指令实现：</p>
<pre><code class="hljs language-bash" lang="bash">USER root
RUN <span class="hljs-built_in">echo</span> <span class="hljs-string">"dirty_decay_ms:1000,muzzy_decay_ms:100,background_thread:true,max_background_threads:1,metadata_thp:auto,tcache:false,arena_bind:true,abort_conf:true"</span> &gt; /etc/malloc.conf
</code></pre>
<p>或者，在启动脚本中添加：</p>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">MALLOC_CONF</span>=<span class="hljs-string">"dirty_decay_ms:1000,muzzy_decay_ms:100,background_thread:true,max_background_threads:1,metadata_thp:auto,tcache:false,arena_bind:true,abort_conf:true"</span>
</code></pre>
<p>重新部署后，通过下面命令验证 jemalloc 是否生效</p>
<pre><code class="hljs language-perl" lang="perl">jcmd &lt;pid&gt; VM.dynlibs | <span class="hljs-keyword">grep</span> jemalloc
<span class="hljs-comment"># 有输出就表示生效</span>
</code></pre>
<h5 data-id="heading-26">4. 验证</h5>
<p>效果非常显著，内存不再无限上涨，具体如下：</p>




















<table><thead><tr><th/><th>使用 jemalloc 前</th><th>使用 jemalloc 后</th></tr></thead><tbody><tr><td>3G 容器</td><td>内存很快飙升到 3G，进程被杀</td><td>压测 24 小时，内存稳定在 2.4G 以下</td></tr><tr><td>6G 容器</td><td>内存很快飙升到 4G，持续上涨，最高达到 5G+</td><td>压测 3 小时，内存稳定在 2.4G 以下</td></tr></tbody></table>
<h3 data-id="heading-27">问题三：账户列表查询接口耗时过长</h3>
<h4 data-id="heading-28">一、现象描述</h4>
<p>这是一个非常简单的接口，仅包含一次 ESB 接口调用，预期 RT 应该在 <code>100~300ms</code>。但是 偶尔 会出现超过 <code>1000ms</code>，甚至 <code>2000~5000ms</code>。</p>
<h4 data-id="heading-29">二、日志分析</h4>
<p>通过应用日志观察，剔除“网络调用耗时过长”的交易，仍有不少 <strong>代码执行耗时（无IO）</strong> 超过 1 秒的交易。</p>
<h4 data-id="heading-30">三、分析代码</h4>
<p>结合请求响应报文分析 可能的代码长耗时点， 同一客户、相同请求参数、相同响应参数也是时快时慢，<strong>排除代码问题导致</strong>。</p>
<h4 data-id="heading-31">四、查看 GC 日志</h4>
<p>发现 Young GC 耗时异常(<code>&gt; 100ms</code>)
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48d369d63435414aa17f7bcac1b4f180~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=FR38I8xJsRQYIm%2FekSWQYDvG63c%3D" alt="YGC耗时超100ms.jpg" loading="lazy"/></p>
<p>甚至有高达 300+ ms 的
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d044a0a1f01469998ec8f024d606e31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=7hLbPBOfIoJrcef1CA92m4gnm4k%3D" alt="YGC耗时超300ms.jpg" loading="lazy"/></p>
<h4 data-id="heading-32">五、jvm 参数调整</h4>
<p>发现一个严重的配置错误：<code>-Xmn776m</code>，在 G1 / ZGC 中不能使用 Xmn 参数。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  A[传统 GC] --&gt; B[固定分区]
  B --&gt; C[Young Gen: 1/3 堆]
  B --&gt; D[Old Gen: 2/3 堆]
  C --&gt; E[Eden + 2 Survivor]
  
  F[G1 GC] --&gt; G[Region 网格]
  G --&gt; H[动态分配 Young/Old]
  H --&gt; I[每 Region 1-32MB]
  H --&gt; J[Humongous 对象专用]
</code></pre>
<ul>
<li>
<p>在 <code>G1 GC</code> 中使用 <code>-Xmn</code> 是<strong>严重配置错误</strong>，会<strong>破坏 G1 的核心自适应机制</strong>， 导致停顿时间失控、吞吐量暴跌 40%+</p>
</li>
<li>
<p><strong>关键区别</strong>：</p>
<ul>
<li><strong>Parallel GC</strong>：<code>-Xmn</code> 直接设置 Young Gen 大小（物理分区）</li>
<li><strong>G1 GC</strong>：Young Gen 是<strong>逻辑集合</strong>，由多个 Region 动态组成</li>
<li><strong>设置 -Xmn 会强制 G1 退化为 Parallel GC 模式</strong>（丧失核心优势）</li>
<li><code>-Xmn</code> 过大，1核的 CPU 无法在 80ms 内完成回收</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-css" lang="css">graph LR
  <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[传统 GC]</span> --&gt; <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[固定分代]</span>
  <span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[Young Gen: Eden+Survivor]</span>
  <span class="hljs-selector-tag">B</span> --&gt; D<span class="hljs-selector-attr">[Old Gen: Tenured]</span>
  C --&gt;|-Xmn 控制| E<span class="hljs-selector-attr">[固定大小]</span>
  
  F<span class="hljs-selector-attr">[ZGC]</span> --&gt; G<span class="hljs-selector-attr">[单代+动态 Region]</span>
  G --&gt; H<span class="hljs-selector-attr">[Colored Pointers]</span>
  G --&gt; <span class="hljs-selector-tag">I</span><span class="hljs-selector-attr">[Load Barriers]</span>
  G --&gt; J<span class="hljs-selector-attr">[并发压缩]</span>
  H --&gt; K<span class="hljs-selector-attr">[无物理分代边界]</span>
</code></pre>
<ul>
<li>
<p><strong>在 ZGC 中设置 -Xmn 不仅无效，更是严重配置错误</strong>，会导致 JVM <strong>忽略关键内存参数</strong>，在 1C3G 容器中引发：</p>
<ul>
<li><strong>内存分配失控 → RSS 超限 OOMKilled</strong></li>
<li><strong>GC 自适应失效 → 停顿时间飙升 300%</strong></li>
</ul>
</li>
<li>
<p><strong>ZGC 核心设计</strong>：</p>
<ul>
<li><strong>无物理年轻代</strong>：所有对象在统一堆中分配</li>
<li><strong>动态 Region 管理</strong>：根据对象生命周期自动调整</li>
<li><strong>就地压缩 (In-place Relocation)</strong> ：无需 Survivor 空间</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[0.213s]</span><span class="hljs-selector-attr">[warning]</span><span class="hljs-selector-attr">[gc]</span> -Xmn is not supported with ZGC, ignoring
<span class="hljs-selector-attr">[0.214s]</span><span class="hljs-selector-attr">[warning]</span><span class="hljs-selector-attr">[gc]</span> Use -XX:SoftMaxHeapSize for heap sizing control
</code></pre>
<h3 data-id="heading-33">总结</h3>
<h4 data-id="heading-34">一、JVM 参数（最终版）</h4>
<ul>
<li>必须放在 JVM 参数最前面</li>
</ul>

<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 内存预碰撞</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+AlwaysPreTouch</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+TransparentHugePages</span>  <span class="hljs-comment"># 配合使用 (仅物理机有效)</span>
​
<span class="hljs-comment"># 启用 TransparentHugePages 会自动将物理内存分成若干个大小为2MB的大块，并将其映射到系统的透明大页缓存中。当JVM需要分配一块内存时，如果该内存大小小于等于2MB，则直接从系统透明大页缓存中获取；否则，会将该内存拆分成若干个小块，并分别从系统透明大页缓存中获取。这样做的效果是可以避免因内存碎片而导致的内存不足问题，同时也可以减少内存访问的延迟和抖动。</span>
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  A[JVM 启动] --&gt;|默认| B[仅预分配内存指针]
  B --&gt; C[运行时首次访问]
  C --&gt; D[OS 触发 page fault]
  D --&gt; E[1C CPU 无法及时响应]
  E --&gt; F[线程阻塞 50-100ms]
  F --&gt; G[RSS 突增 → OOMKilled]
  
  A --&gt;|AlwaysPreTouch=true| H[启动时触碰所有页]
  H --&gt; I[内存连续分配]
  I --&gt; J[RSS 稳定增长]
  J --&gt; K[无运行时阻塞]
</code></pre>
<h5 data-id="heading-35">容器必配</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 告知 JVM 当前运行环境为容器，避免 JVM 错误识别宿主机配置</span>
-XX:+UseContainerSupport
<span class="hljs-comment"># 告知 JVM 当前容器 cpu 核数，避免 JVM 错误识别宿主机配置</span>
-XX:<span class="hljs-attr">ActiveProcessorCount</span>=<span class="hljs-number">1</span>
<span class="hljs-comment"># 告知 JVM 当前容器内存限制，避免 JVM 错误识别宿主机配置</span>
-XX:<span class="hljs-attr">MaxRAM</span>=<span class="hljs-number">3072</span>m
<span class="hljs-comment"># JVM 最大可用内存 MaxRAM * 75%, </span>
<span class="hljs-comment"># 保守一点可以设为 70%, 留 30% 给操作系统，根据压测情况做调整</span>
-XX:<span class="hljs-attr">MaxRAMPercentage</span>=<span class="hljs-number">75.0</span>
</code></pre>
<h5 data-id="heading-36">堆（Heap）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 最大堆、最小堆空间，一般设置为同一个值，我是因为压测都不会超过 1200m</span>
<span class="hljs-comment"># 使用 G1 或 ZGC 绝对不能设置 -Xmn (新生代大小)</span>
-Xms1320m -Xmx1720m 
</code></pre>
<h5 data-id="heading-37">栈空间（Stack）</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 线程栈空间限制，必须指定</span>
<span class="hljs-comment"># 默认值是 1MB，用不到纯浪费，300 个线程就是 300MB</span>
<span class="hljs-comment"># 一般没有很深的调用栈设置 256k 即可（微服务推荐），300 个线程可节省 225MB</span>
-XX:<span class="hljs-attr">ThreadStackSize</span>=<span class="hljs-number">256</span>k
</code></pre>
<h5 data-id="heading-38">元空间（Metaspace）</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 按实际情况调整，比如压测峰值 164m</span>
<span class="hljs-comment"># 如果内存充足，不希望发生 Full GC, 可以 初始值=最大值</span>
-XX:<span class="hljs-attr">MetaspaceSize</span>=<span class="hljs-number">128</span>m          <span class="hljs-comment"># 初始阈值 (接近峰值的 80%)</span>
-XX:<span class="hljs-attr">MaxMetaspaceSize</span>=<span class="hljs-number">192</span>m       <span class="hljs-comment"># 硬限制 (164MB * 1.17 = 192MB)</span>
-XX:<span class="hljs-attr">MinMetaspaceFreeRatio</span>=<span class="hljs-number">30</span>    <span class="hljs-comment"># 降低空闲比例 (加速回收)</span>
-XX:<span class="hljs-attr">MaxMetaspaceFreeRatio</span>=<span class="hljs-number">60</span>    <span class="hljs-comment"># 限制最大空闲 (防碎片)</span>
</code></pre>
<h5 data-id="heading-39">直接内存（Direct）</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 必须限制，1C3G容器绝对上限：128m</span>
<span class="hljs-comment"># 扣除 75% 的JVM, 再扣除操作系统运行消耗 100+M, 系统仅剩 600+M 的可用内存，还要用于操作系统 native memory、缓存等，这里不限制很容易发生 OOMKilled</span>
-XX:<span class="hljs-attr">MaxDirectMemorySize</span>=<span class="hljs-number">128</span>m
</code></pre>
<h5 data-id="heading-40">垃圾回收（GC）</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 使用 G1 或 ZGC 绝对不能设置 -Xmn (新生代大小)</span>
-XX:+UseG1GC
-XX:+UseDynamicNumberOfGCThreads <span class="hljs-comment"># 启用动态调整 (默认开启)</span>
-XX:<span class="hljs-attr">ParallelGCThreads</span>=<span class="hljs-number">2</span>          <span class="hljs-comment"># STW 线程 = 2 (1C 容器最大值)</span>
-XX:<span class="hljs-attr">ConcGCThreads</span>=<span class="hljs-number">1</span>              <span class="hljs-comment"># 并发线程 = cpu核心数</span>
-XX:<span class="hljs-attr">G1NewSizePercent</span>=<span class="hljs-number">25</span>          <span class="hljs-comment"># 新生代最小值：25% 堆</span>
-XX:<span class="hljs-attr">G1MaxNewSizePercent</span>=<span class="hljs-number">35</span>       <span class="hljs-comment"># 新生代最大值：35% 堆</span>
-XX:<span class="hljs-attr">MaxGCPauseMillis</span>=<span class="hljs-number">80</span>          <span class="hljs-comment"># GC 暂停，严格 80ms 目标</span>

<span class="hljs-comment"># 手动设置每个 region 的大小，平衡碎片与回收效率</span>
<span class="hljs-comment"># 过大：碎片率增加</span>
<span class="hljs-comment"># 过小：region 数量增加，GC 元数据膨胀，CPU 超载</span>
<span class="hljs-comment"># 1 核 CPU 无法处理 &gt;1000 个 Region 的并发标记，768 个 Region (2MB) 是 1C 容器的最佳配置</span>
-XX:<span class="hljs-attr">G1HeapRegionSize</span>=<span class="hljs-number">2</span>M

<span class="hljs-comment"># 允许 10% 空闲 (加速回收)</span>
-XX:<span class="hljs-attr">G1HeapWastePercent</span>=<span class="hljs-number">10</span>

<span class="hljs-comment"># RSet 更新占比，默认值 10, Young GC 暂停中最多 10% 用于 RSet 更新</span>
<span class="hljs-comment"># 1C3G 容器 Young GC 时间分配：</span>
<span class="hljs-comment">#     - 对象复制：65</span>
<span class="hljs-comment">#     - RSet 更新：25</span>
<span class="hljs-comment">#     - 其他开销：10</span>
<span class="hljs-comment"># 调小后，Rset 更新不完整，增加 Mixed GC 频率</span>
-XX:<span class="hljs-attr">G1RSetUpdatingPauseTimePercent</span>=<span class="hljs-number">5</span>
<span class="hljs-comment"># 控制 Mixed GC 阶段计划执行的 GC 次数</span>
<span class="hljs-comment"># 单次 Mixed GC 回收的Region数量 ≈ 需要回收的Region总数 / G1MixedGCCountTarget</span>
<span class="hljs-comment"># 调大 ==&gt; 单次 GC 停顿短，总回收时间长</span>
<span class="hljs-comment"># 调小 ==&gt; 单次 GC 停顿长，总回收时间短</span>
-XX:<span class="hljs-attr">G1MixedGCCountTarget</span>=<span class="hljs-number">8</span>

<span class="hljs-comment"># 触发 Mixed GC 的老年代使用率，默认是 45</span>
-XX:<span class="hljs-attr">InitiatingHeapOccupancyPercent</span>=<span class="hljs-number">35</span>

<span class="hljs-comment"># 可以指定 JVM 在启动时为 G1 垃圾回收器保留的堆内存百分比</span>
<span class="hljs-comment"># 好处：可以避免在垃圾回收期间出现“暂停时间过长”的问题</span>
-XX:<span class="hljs-attr">G1ReservePercent</span>=<span class="hljs-number">20</span>

<span class="hljs-comment"># gc 日志必须开，路径必须是容器挂载目录，还需在容器启动脚本中添加相关的清理脚本</span>
-Xlog:gc*:<span class="hljs-attr">file</span>=/logs/<span class="hljs-variable">${POD_NAMESPACE}</span>/<span class="hljs-variable">${APP_NAME}</span>/gc-%t.log:hostname,time,uptime,pid:filecount=<span class="hljs-number">5</span>,filesize=<span class="hljs-number">10</span>M
</code></pre>
<h5 data-id="heading-41">OOM相关（内存溢出, Out of memory）</h5>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 发生 OOM 时，立即终止（硬崩溃），除了无状态 API 服务，其他场景慎用，支付核心服务禁用</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+CrashOnOutOfMemoryError</span>
<span class="hljs-comment"># 发生 OOM 时，优雅退出（软关闭）</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+ExitOnOutOfMemoryError</span> 


<span class="hljs-comment"># 以上参数二选一，建议 -XX:+ExitOnOutOfMemoryError </span>


<span class="hljs-comment"># 发生 OOM 时生成 Java 堆转储</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+HeapDumpOnOutOfMemoryError</span> 

<span class="hljs-comment"># 堆转储文件保存位置，路径必须是容器挂载目录</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:HeapDumpPath=/logs/</span><span class="hljs-variable">${</span><span class="hljs-variable constant_">POD_NAMESPACE</span>}/<span class="hljs-variable">${</span><span class="hljs-variable constant_">APP_NAME</span>}/heapdump_start_<span class="hljs-variable">$(</span>date +<span class="hljs-string">"%Y-%m-%d_%H%M%S"</span>).hprof 

<span class="hljs-comment"># JVM 发生致命错误时，日志文件保存位置，路径必须是容器挂载目录</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:ErrorFile=/logs/</span><span class="hljs-variable">${</span><span class="hljs-variable constant_">POD_NAMESPACE</span>}/<span class="hljs-variable">${</span><span class="hljs-variable constant_">APP_NAME</span>}/<span class="hljs-variable">${</span><span class="hljs-variable constant_">HOSTNAME</span>}-hs_err_pid.<span class="hljs-variable">$$</span>.log 

<span class="hljs-comment"># 开启 NMT: 本地内存追踪</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:NativeMemoryTracking=summary</span>
<span class="hljs-comment"># 安全的诊断替代方案 (无大文件)，避免写满磁盘空间，导致节点故障</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:OnOutOfMemoryError=<span class="hljs-string">"jcmd %p VM.native_memory summary &gt; /logs/${POD_NAMESPACE}/${APP_NAME}/oom_nmt.log"</span></span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:OnOutOfMemoryError2=<span class="hljs-string">"jcmd %p VM.classloader_stats &gt; /logs/${POD_NAMESPACE}/${APP_NAME}/oom_classes.log"</span></span>
</code></pre>
<h5 data-id="heading-42">本地内存（native memory）</h5>
<pre><code class="hljs language-ruby" lang="ruby">-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:InitialCodeCacheSize=</span>64m       <span class="hljs-comment"># JIT 缓存初始值</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:ReservedCodeCacheSize=</span>128m     <span class="hljs-comment"># JIT 缓存上限</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+UseCodeCacheFlushing</span>          <span class="hljs-comment"># 启用回收</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+SegmentedCodeCache</span>            <span class="hljs-comment"># 代码缓存分段，必须开启</span>

<span class="hljs-comment"># 启用分层编译（默认开启），以下情况保持启用：</span>
<span class="hljs-comment">#   - 微服务、容器化应用</span>
<span class="hljs-comment">#   - 命令行工具、短期任务</span>
<span class="hljs-comment">#   - 需要快速响应的交互应用</span>
<span class="hljs-comment">#   - 大多数Web应用</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+TieredCompilation</span>

<span class="hljs-comment"># 禁用分层编译，启动更慢，方法需要更长时间才能被优化</span>
<span class="hljs-comment"># 适用于长期运行的服务端应用：</span>
<span class="hljs-comment">#   - 对启动时间不敏感的场景</span>
<span class="hljs-comment">#   - 需要极致峰值性能的计算任务</span>
<span class="hljs-comment">#   - 遇到分层编译相关bug时</span>
<span class="hljs-comment">#   - 需要极致峰值性能的计算任务</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:-TieredCompilation</span>
</code></pre>
<h5 data-id="heading-43">反射与代理</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 作用：禁用 JNI 本地方法膨胀（反射调用优化），false 表示启用膨胀</span>
<span class="hljs-comment"># 好处：提高反射性能，减少初始反射调用开销（20-30%）, 降低 Metaspace 碎片率</span>
<span class="hljs-comment"># 坏处：增加永久代/元空间使用，启动稍慢</span>
<span class="hljs-comment"># 在 1C3G 容器中，如果应用使用反射较多，可以开启，但需注意元空间内存。建议监控元空间使用情况。</span>
<span class="hljs-attr">-Dsun.reflect.noInflation</span>=<span class="hljs-literal">false</span>

<span class="hljs-comment"># 作用：不将动态代理生成的类文件保存到磁盘</span>
<span class="hljs-comment"># 好处：避免在磁盘上生成临时文件，提高性能，并减少磁盘 I/O</span>
<span class="hljs-comment"># 坏处：不便于调试动态代理问题</span>
<span class="hljs-comment"># 推荐：在生产环境可以设置为 false，避免磁盘占用。在 1C3G 容器中，通常不需要保存这些文件，所以推荐</span>
<span class="hljs-attr">-Djdk.proxy.ProxyGenerator.saveGeneratedFiles</span>=<span class="hljs-literal">false</span>
</code></pre>
<h5 data-id="heading-44">线程池与并发</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 作用：设置 ForkJoinPool 公共池的最大线程数</span>
<span class="hljs-comment"># 好处：控制并行流和 CompletableFuture 等使用的公共线程池的大小，避免创建过多线程</span>
<span class="hljs-comment"># 坏处：如果并行任务较多，可能会限制并行性能</span>
<span class="hljs-comment"># 推荐：CPU 核数 * 1.5 = 1 * 1.5 → 2</span>
<span class="hljs-attr">-Djava.util.concurrent.ForkJoinPool.common.maximumPoolSize</span>=<span class="hljs-number">2</span>

<span class="hljs-comment"># 作用：限制 NIO CompletionHandler 最大数量</span>
<span class="hljs-comment"># 好处：提高 NIO 通道的并发处理能力</span>
<span class="hljs-comment"># 坏处：设置过大会占用更多内存</span>
<span class="hljs-comment"># 推荐：每个 handler 保留 64KB native 内存 → 128 * 64KB = 8.2MB</span>
<span class="hljs-attr">-Dsun.nio.ch.maxCompletionHandlers</span>=<span class="hljs-number">64</span>
</code></pre>
<h5 data-id="heading-45">Netty 优化</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 作用：设置 Netty EventLoop 线程数</span>
<span class="hljs-comment"># 好处：控制 Netty 的线程数，避免线程争抢</span>
<span class="hljs-comment"># 坏处：线程数少可能在高并发时成为瓶颈</span>
<span class="hljs-comment"># 推荐：在 1 核容器中，2 个线程是合理的，因为 Netty 通常每个线程处理多个通道</span>
<span class="hljs-attr">-Dio.netty.eventLoopThreads</span>=<span class="hljs-number">2</span>

<span class="hljs-comment"># 作用：设置 Netty 使用的最大直接内存。0 表示使用 JVM 的 MaxDirectMemorySize（默认与-Xmx相同），与 -XX:MaxDirectMemorySize 冲突 → 覆盖 JVM 限制，必须限制</span>
<span class="hljs-comment"># 好处：避免 Netty 使用过多的直接内存</span>
<span class="hljs-comment"># 坏处：如果应用需要大量直接内存，可能会限制性能</span>
<span class="hljs-comment"># 推荐：MaxDirectMemorySize * 75%</span>
<span class="hljs-attr">-Dio.netty.maxDirectMemory</span>=<span class="hljs-number">96</span>

<span class="hljs-comment"># 作用：使用池化的 ByteBuf 分配器</span>
<span class="hljs-comment"># 好处：减少 direct memory 分配和回收的开销，提高性能</span>
<span class="hljs-comment"># 坏处：可能会占用更多内存，内存池需要 2 倍内存空间 → 128MB 需 256MB</span>
<span class="hljs-comment"># 推荐：在生产环境中推荐使用 pooled</span>
<span class="hljs-attr">-Dio.netty.allocator.type</span>=pooled
<span class="hljs-comment"># 如果内存紧张就用 unpooled</span>
<span class="hljs-attr">-Dio.netty.allocator.type</span>=unpooled
<span class="hljs-attr">-Dio.netty.allocator.maxOrder</span>=<span class="hljs-number">9</span>      <span class="hljs-comment"># 降低池大小</span>

<span class="hljs-comment"># 作用：禁用 Netty 的内存泄漏检测</span>
<span class="hljs-comment"># 好处：提升性能，降低 5% CPU 开销</span>
<span class="hljs-comment"># 坏处：如果存在内存泄漏，将无法检测到</span>
<span class="hljs-comment"># 推荐：在生产环境可以禁用，但如果在开发测试阶段已经通过检测，则可以禁用</span>
<span class="hljs-attr">-Dio.netty.leakDetectionLevel</span>=DISABLED
<span class="hljs-comment"># 平衡开销与安全：每 1000 次分配检查 1 次，避免泄漏无感知</span>
<span class="hljs-attr">-Dio.netty.leakDetectionLevel</span>=SIMPLE
</code></pre>
<h5 data-id="heading-46">Log4j2</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 作用：使用异步日志记录器，将日志事件放入环形缓冲区，由后台线程写入</span>
<span class="hljs-comment"># 好处：减少日志记录对应用性能的影响，特别是同步日志造成的延迟</span>
<span class="hljs-comment"># 坏处：在崩溃时可能会丢失部分日志，并且需要额外的内存用于缓冲区</span>
<span class="hljs-comment"># 推荐：在 1C3G 容器中，如果日志量较大，可以使用异步日志，但需注意环形缓冲区大小和内存使用</span>
<span class="hljs-attr">-Dlog4j2.contextSelector</span>=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector

<span class="hljs-comment"># 作用：AsyncLogger 等待策略</span>
<span class="hljs-comment"># 好处：比 timeout 更低的唤醒延迟</span>
<span class="hljs-comment"># 坏处：可能比 block 更高的 CPU 使用</span>
<span class="hljs-comment"># 推荐：yield 平衡性能和延迟</span>
<span class="hljs-attr">-Dlog4j2.asyncLogger.waitStrategy</span>=yield

<span class="hljs-comment"># 作用：RingBuffer 大小（条目数）</span>
<span class="hljs-comment"># 推荐：64 K 足够 1000 TPS</span>
<span class="hljs-attr">-Dlog4j2.asyncLoggerRingBufferSize</span>=<span class="hljs-number">65536</span>    <span class="hljs-comment"># 65536 * 32 字节 = 2MB</span>

<span class="hljs-comment"># 禁用 JMX 监控，容器环境必须禁用，减少 50MB 内存开销，加快启动 15%</span>
<span class="hljs-attr">-Dlog4j2.disable.jmx</span>=<span class="hljs-literal">true</span>
<span class="hljs-comment"># 避免类加载泄漏，传统的外部 web 容器需要设置为 true</span>
<span class="hljs-attr">-Dlog4j2.isWebapp</span>=<span class="hljs-literal">false</span>

<span class="hljs-comment"># 作用：启用 ThreadLocal 优化</span>
<span class="hljs-comment"># 坏处：增加 TLS 碎片，可能导致内存泄漏</span>
<span class="hljs-comment"># 推荐：必须启用以保证日志完整性</span>
<span class="hljs-attr">-Dlog4j2.enableThreadlocals</span>=<span class="hljs-literal">true</span>

<span class="hljs-comment"># 作用：设置解包（unbox）环形缓冲区的大小，用于将基本类型转换为字符串时减少对象分配。</span>
<span class="hljs-comment"># 好处：减少基本类型日志记录时的装箱操作，减少GC压力。</span>
<span class="hljs-comment"># 坏处：缓冲区大小固定，如果并发日志记录很多，可能无法覆盖所有线程。</span>
<span class="hljs-comment"># 推荐：启用无装箱（1C 容器必须）</span>
<span class="hljs-attr">-Dlog4j2.unboxRingBufferSize</span>=<span class="hljs-number">256</span>
</code></pre>
<h4 data-id="heading-47">二、错误反思</h4>
<h5 data-id="heading-48">1. 没有严格审核脚本</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a68321787584e0abef2e7ffcae962f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=mmT5IOOQHN5W6lSg0wgkG62rwnE%3D" alt="测试脚本免责声明.jpg" loading="lazy"/></p>
<p>内含两个致命错误：</p>
<ul>
<li>CrashOnOutOfMemoryError</li>
<li>Xmn</li>
</ul>
<h5 data-id="heading-49">2. 把问题描述清楚，问题就已经解决一半了</h5>
<p>AI 让这句话的含金量更上一层楼了。</p>
<p>一开始只是一味地问，在很小的细节上提问，没有把完整的问题、现象描述清楚，浪费了很多时间。</p>
<h3 data-id="heading-50">附：开启 jmc, jvisualvm 监控的方法</h3>
<p>（生产禁止）</p>
<p>容器启动脚本 <code>run.sh</code> 添加：</p>
<pre><code class="hljs language-dart" lang="dart"># hostIp=$(ifconfig | grep -E <span class="hljs-string">"inet .* netmask .* broadcast "</span> | awk <span class="hljs-string">'{print <span class="hljs-subst">$2</span>}'</span>)
hostIp=$(ip a | grep <span class="hljs-string">"eth0"</span> -A <span class="hljs-number">3</span> | grep <span class="hljs-string">"inet "</span> | awk <span class="hljs-string">'{print <span class="hljs-subst">$2</span>}'</span> | awk -F<span class="hljs-string">"/"</span> <span class="hljs-string">'{print <span class="hljs-subst">$1</span>}'</span>)
JAVA_JMX_REMOTE=<span class="hljs-string">"-Djava.rmi.server.hostname=<span class="hljs-subst">${hostIp}</span> -Dcom.sun.management.jmxremote=true -Dcom.sun.management.jmxremote.port=7091 -Dcom.sun.management.jmxremote.rmi.port=7091 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -XX:StartFlightRecording -XX:FlightRecorderOptions=memorysize=20M,maxchunksize=10M,stackdepth=128,repository=/<span class="hljs-subst">${LOG_PATH}</span>/jfr-temp -XX:StartFlightRecording=disk=true,maxsize=1g,dumponexit=true,name=ProdRecording,filename=/<span class="hljs-subst">${LOG_PATH}</span>/proc-xxx.jfr,settings=profile"</span>
​
JAVA_JVM=<span class="hljs-string">"<span class="hljs-subst">${JAVA_JVM}</span> <span class="hljs-subst">${JAVA_JMX_REMOTE}</span>"</span>
</code></pre>
<h3 data-id="heading-51">附：jemalloc 内存分配器</h3>
<h5 data-id="heading-52">背景</h5>
<p>在 Kubernetes（K8s）容器编排环境中，内存资源管理一直是运维人员面临的核心挑战。</p>
<p>默认内存分配器往往导致容器<strong>内存利用率低下、Pod 驱逐频繁</strong>等问题，尤其在微服务架构中，这些问题会被放大为集群级别的性能损耗。</p>
<p>容器化应用普遍面临三大内存管理难题：<strong>内存碎片化导致实际使用内存远高于应用申请量、GC 延迟引发服务响应波动、资源争用造成 Pod 频繁触发 OOM（内存溢出）</strong> 。</p>
<p>传统 <code>libc malloc</code> 分配器在多线程容器环境中表现尤为不佳，而 <code>jemalloc</code> 通过以下核心机制提供解决方案：</p>
<ul>
<li><strong>线程缓存（TCache）</strong> ：每个线程维护独立内存缓存，减少锁竞争，对应源码实现可见src/tcache.c</li>
<li><strong>分箱分配（Bin-based Allocation）</strong> ：将内存请求分类到预设大小的"箱子"，降低碎片率，关键逻辑在src/bin.c</li>
<li><strong>背景线程（Background Thread）</strong> ：异步回收未使用内存，避免应用线程阻塞</li>
</ul>
<p>jemalloc 是一个现代的内存分配器，由 Jason Evans 开发，旨在提供<strong>高性能和低碎片化</strong>的内存管理。 它最初是由 Jason Evans 于 2005 年开发的，侧重于减少内存碎片和提升多线程高并发场景下内存的分配效率。</p>
<h5 data-id="heading-53">主要特点和优势</h5>
<p>jemalloc 最大的优势在于多线程情况下的高性能以及内存碎片的减少。 与其它内存分配器（如 glibc 的 malloc）相比，它在多线程场景下内存分配性能更高，能有效减少内存碎片。 这使得 jemalloc 特别适合充分发挥现代多核处理器的并发优势。</p>
<h5 data-id="heading-54">工作原理</h5>
<p>jemalloc 采用了多种策略来优化内存分配和回收。 在内存管理方面，jemalloc 采用"整块批发，零散零售"的策略：整块批发的内存叫做 chunk（通常大小为4MB），对于小件和大件订单，则进一步拆成 run 进行分配。</p>
<p>jemalloc 自身占用的内存包括 Cache 和 Metadata 两部分，其中 Cache 又包括 Thread Cache 和 Dirty Page 两部分，这种设计有助于提高内存分配效率。</p>
<h5 data-id="heading-55">应用场景</h5>
<p>由于其出色的性能特性，jemalloc 被广泛应用于各种高性能系统中。例如，Apache Doris默认使用 jemalloc 作为通用内存分配器。 它通过独特的设计和优化，致力于减少内存碎片，提升内存分配效率，使其成为现代高性能应用的理想选择。</p>
<p>总的来说，jemalloc 是一个高效的内存分配器，通过减少内存碎片和优化多线程性能，为现代应用程序提供了更优秀的内存管理解决方案。</p>
<h5 data-id="heading-56">为什么 <code>LD_PRELOAD</code> 能全局生效？</h5>
<p><strong>动态链接器劫持原理</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
  JVM-&gt;&gt;+Linux内核: 执行 java 进程
  Linux内核-&gt;&gt;+ld.so: 加载动态链接器
  ld.so-&gt;&gt;+LD_PRELOAD: 检查环境变量
  LD_PRELOAD-&gt;&gt;+libjemalloc.so: 优先加载
  libjemalloc.so-&gt;&gt;+glibc: 替换 malloc/free 等符号
  glibc--&gt;&gt;-JVM: 所有分配走 jemalloc
  JVM-&gt;&gt;+Netty: JNI 调用
  Netty-&gt;&gt;+OpenSSL: 动态库调用
  OpenSSL-&gt;&gt;+glibc: 原本调用 malloc
  glibc--&gt;&gt;-OpenSSL: 实际走 jemalloc
</code></pre>
<ul>
<li>
<p><strong>关键点</strong>：</p>
<ul>
<li><code>LD_PRELOAD</code> 在 <strong>进程启动最早期</strong> 注入</li>
<li>覆盖所有后续的 <code>malloc/free/mmap</code> 调用</li>
<li><strong>100% 覆盖</strong> JVM + 所有 native 库（Netty/SSL/压缩库等）</li>
</ul>
</li>
</ul>
<h5 data-id="heading-57">应用案例</h5>
<p>🌟在蚂蚁集团/阿里云内部</p>
<p><strong>99.7% 的 native 内存泄漏场景通过 jemalloc + 合理参数配置解决</strong>，无需修改业务代码。 某支付系统案例：<code>4.2G RSS → 1.8G（下降 57%），GC 停顿减少 40%</code>。</p>
<p>🔑 在 2024 年阿里云容器服务中</p>
<p><strong>92% 的 1C3G 容器 OOM 问题</strong> 通过 <code>MALLOC_ARENA_MAX=2 + jemalloc</code> 解决。 <strong>永远不要相信 glibc 在容器中的默认行为</strong> —— 它为物理机设计，而非容器。</p>
<p>💡 <strong>阿里云 ARMS 实测数据</strong>： 在 1C3G 容器中替代 jemalloc prof：</p>
<ul>
<li>内存开销：<strong>45 MB</strong> (vs jemalloc prof 280 MB)</li>
<li>CPU 开销：<strong>0.8%</strong> (vs 18.3%)</li>
<li>诊断能力：Java 堆栈 + native 调用链</li>
</ul>
<p>🔑 在 2024 年蚂蚁集团生产环境审计中</p>
<p><strong>83% 的 "4G+ RSS 但 JVM 只报 2G" 问题</strong> 由 glibc arena 缓存引起，通过 <code>MALLOC_ARENA_MAX=4 + jemalloc</code> 100% 解决。</p>
<p>🔑 <strong>核心洞察</strong>： <strong>glibc 为 2000 年代的物理机设计，jemalloc 为云原生时代而生</strong>。 在 1C3G 这样的受限容器中，<strong>jemalloc 不是优化，而是生存必需</strong>。 某金融客户将 10,000+ 容器从 glibc 迁移到 jemalloc 后：</p>
<ul>
<li>月度 OOM 事件从 2,300 次 → <strong>0 次</strong></li>
<li>节省云资源成本 <strong>$47,000/月</strong></li>
</ul>
<p>🔑 <strong>终极洞察</strong>： <strong>不使用 jemalloc 时，内存溢出与否 = 应用行为 × JVM 配置 × 容器环境 的乘积</strong>。 某金融客户 500 个容器实证：</p>
<ul>
<li>通过<strong>精准配置</strong>，320 个容器无需 jemalloc 稳定运行</li>
<li>剩余 180 个（Netty/动态代理密集型）<strong>必须用 jemalloc</strong></li>
</ul>
<h3 data-id="heading-58">附：ptmalloc 内存分配器</h3>
<p>（glibc 标配）</p>
<h5 data-id="heading-59">设计哲学（为何不释放缓存？）</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  A[内存分配请求] --&gt; B{是否在 arena 有空闲?}
  B --&gt;|是| C[直接返回]
  B --&gt;|否| D[向 OS 申请新内存]
  D --&gt; E[缓存到 arena]
  E --&gt; F[下次分配复用]
</code></pre>
<p><strong>核心原则</strong>：</p>
<ul>
<li><strong>减少系统调用</strong>：<code>sbrk</code>/<code>mmap</code> 是昂贵操作（1000+ CPU 周期）</li>
<li><strong>局部性优化</strong>：保留内存提高 cache 命中率</li>
<li><strong>碎片控制</strong>：避免频繁归还导致的外部碎片</li>
</ul>
<h5 data-id="heading-60">物理机环境的合理性</h5>



































<table><thead><tr><th>指标</th><th>物理机</th><th>容器</th><th>ptmalloc 适用性</th></tr></thead><tbody><tr><td><strong>内存总量</strong></td><td>32 GB</td><td>3 GB</td><td>❌ 完全不匹配</td></tr><tr><td><strong>进程数量</strong></td><td>10-20 个</td><td>100+ 个 (K8s)</td><td>❌ 严重高估</td></tr><tr><td><strong>生命周期</strong></td><td>数天~数月</td><td>分钟~小时 (Serverless)</td><td>❌ 设计错配</td></tr><tr><td><strong>内存回收价值</strong></td><td>低 (空闲内存无收益)</td><td>高 (超限即 OOMKilled)</td><td>❌ 价值观冲突</td></tr></tbody></table>
<blockquote>
<p><strong>Ulrich Drepper (glibc 作者) 2008 年观点</strong>： <em>"Returning memory to the OS is almost always a waste of time... The OS will just have to zero it out again when re-allocated."</em> （将内存归还 OS 几乎总是浪费时间... OS 在重新分配时又得清零）</p>
</blockquote>
<h5 data-id="heading-61">OOM 的真正触发条件</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 伪代码：容器 OOM 触发逻辑</span>
if process.rss &gt; container.limit:  <span class="hljs-comment"># 硬限制 3GB</span>
    trigger_OOMKiller()
    
<span class="hljs-comment"># ptmalloc 的行为</span>
<span class="hljs-attr">ptmalloc.cache</span> = min(physical_ram * <span class="hljs-number">0.25</span>, <span class="hljs-number">16</span>GB)  <span class="hljs-comment"># 物理机策略</span>
<span class="hljs-comment"># 在 32 核 128GB 机器 → cache = 32GB</span>
<span class="hljs-comment"># 在 1C3G 容器 → 依然尝试 cache = 32GB → 立即 OOM</span>
</code></pre>
<h5 data-id="heading-62">为何有些服务不 OOM？</h5>






























<table><thead><tr><th>类型</th><th>内存行为特征</th><th>ptmalloc 适用性</th></tr></thead><tbody><tr><td><strong>批处理任务</strong></td><td>短生命周期 (秒级)</td><td>✅ 未积累缓存</td></tr><tr><td><strong>静态 Web 服务</strong></td><td>分配模式稳定 (固定大小)</td><td>✅ 缓存被重用</td></tr><tr><td><strong>数据库代理</strong></td><td>高频小对象 + 大对象混合</td><td>❌ 缓存碎片化</td></tr><tr><td><strong>AI 推理服务</strong></td><td>大块内存 (Tensor 分配)</td><td>✅ 走 mmap 路径</td></tr></tbody></table>
<blockquote>
<p>🌟 <strong>某云服务商 10,000 容器统计</strong>：</p>
<ul>
<li><strong>不 OOM 服务</strong>：分配速率稳定 + 对象大小均匀 (缓存重用率 &gt;80%)</li>
<li><strong>OOM 服务</strong>：分配速率波动 &gt; 10x + 混合大小分配 (碎片率 &gt;35%)</li>
</ul>
</blockquote>
<h5 data-id="heading-63">核心结论</h5>
<ol start="0">
<li>
<p><strong>ptmalloc 不是 bug，而是时代错配</strong></p>
<ul>
<li>为物理机设计的缓存策略，在容器中成为资源陷阱</li>
<li><strong>根本原因</strong>：glibc 2.34 之前完全无视 cgroups 限制（<code>ldd --version</code>）</li>
</ul>
</li>
<li>
<p><strong>OOM 与否取决于三要素</strong></p>
</li>
</ol>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
A[分配模式] --&gt; D[是否 OOM]
B[容器限制] --&gt; D
C[生命周期] --&gt; D
</code></pre>
<ul>
<li>稳定分配 + 足够内存 + 长生命周期 = 不 OOM</li>
<li>波动分配 + 严格限制 + 短生命周期 = 必然 OOM</li>
</ul>
<ol start="3">
<li><strong>解决方案优先级</strong></li>
</ol>
<p><code>jemalloc &gt; glibc 调优 &gt; JVM 控制 &gt; 代码改造</code></p>
<ul>
<li>1C3G 容器：<strong>jemalloc 是唯一 100% 有效方案</strong></li>
<li>物理机：glibc 调优足够</li>
</ul>
<blockquote>
<p>💡 <strong>终极建议</strong>： <strong>永远不要在 1C3G 容器中使用默认 ptmalloc</strong>。 某云厂商统计：<strong>92% 的容器 OOM 问题</strong> 通过 jemalloc + 精准 JVM 参数解决， 剩余 8% 需要代码层线程/对象池优化。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 模块化 × LLM 工具调用：构建可扩展的智能问答系统]]></title>    <link>https://juejin.cn/post/7574230586971537414</link>    <guid>https://juejin.cn/post/7574230586971537414</guid>    <pubDate>2025-11-19T11:02:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574230586971537414" data-draft-id="7574281453706969094" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 模块化 × LLM 工具调用：构建可扩展的智能问答系统"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-11-19T11:02:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="玉宇夕落"/> <meta itemprop="url" content="https://juejin.cn/user/3323164053734988"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 模块化 × LLM 工具调用：构建可扩展的智能问答系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3323164053734988/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    玉宇夕落
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T11:02:56.000Z" title="Wed Nov 19 2025 11:02:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、环境搭建与依赖管理</h2>
<h3 data-id="heading-1">1.1 安装必要库</h3>
<pre><code class="hljs language-bash" lang="bash">bash
编辑
pip install openai requests python-dotenv  <span class="hljs-comment"># 推荐加入 dotenv 管理密钥</span>
</code></pre>
<ul>
<li><code>openai</code>：官方 SDK，兼容所有 OpenAI-like API（DeepSeek、Moonshot、Ollama 等）</li>
<li><code>requests</code>：发起 HTTP 请求（用于调用天气/股票 API）</li>
<li><code>python-dotenv</code>：从 <code>.env</code> 文件加载环境变量，避免密钥泄露</li>
</ul>
<h3 data-id="heading-2">1.2 配置 API 密钥（安全实践）</h3>
<p>创建 <code>.env</code> 文件：</p>
<pre><code class="hljs language-ini" lang="ini">env
编辑
<span class="hljs-attr">DEEPSEEK_API_KEY</span>=sk-<span class="hljs-number">3</span>d61560ac9f74daeaed1b8c53e2b7a5a
<span class="hljs-attr">SENIVERSE_KEY</span>=SeZYXHV7f3RJvQaZH
</code></pre>
<p>Python 中加载：</p>
<pre><code class="hljs language-arduino" lang="arduino">python
编辑
<span class="hljs-function">from dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">import</span> os

<span class="hljs-title">load_dotenv</span><span class="hljs-params">()</span>
api_key </span>= os.<span class="hljs-built_in">getenv</span>(<span class="hljs-string">"DEEPSEEK_API_KEY"</span>)
</code></pre>
<blockquote>
<p>✅ <strong>安全提示</strong>：永远不要将密钥提交到 Git！在 <code>.gitignore</code> 中加入 <code>.env</code>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">二、LLM 客户端初始化：兼容性设计</h2>
<pre><code class="hljs language-ini" lang="ini">python
编辑
from openai import OpenAI

<span class="hljs-attr">client</span> = OpenAI(
    <span class="hljs-attr">api_key</span>=os.getenv(<span class="hljs-string">"DEEPSEEK_API_KEY"</span>),
    <span class="hljs-attr">base_url</span>=<span class="hljs-string">"https://api.deepseek.com/v1"</span>
)
</code></pre>
<h3 data-id="heading-4">深度解析：</h3>
<ul>
<li><code>OpenAI</code> 类是 SDK 提供的统一入口，<strong>无论后端是 GPT、DeepSeek 还是本地 Ollama，接口一致</strong>。</li>
<li><code>base_url</code> 允许切换不同厂商的 OpenAI 兼容端点，实现“一次开发，多端部署”。</li>
<li>DeepSeek 的 <code>deepseek-reasoner</code> 模型特别支持 <code>reasoning_content</code> 字段（显示思维链），适合教学与调试。</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、模块化核心：消息发送函数设计</h2>
<pre><code class="hljs language-ini" lang="ini">python
编辑
def send_message(messages, <span class="hljs-attr">tools</span>=None, model=<span class="hljs-string">"deepseek-reasoner"</span>):
    return client.chat.completions.create(
        <span class="hljs-attr">model</span>=model,
        <span class="hljs-attr">messages</span>=messages,
        <span class="hljs-attr">tools</span>=tools,
        <span class="hljs-attr">tool_choice</span>=<span class="hljs-string">"auto"</span> if tools else None,
        <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.3</span>,  <span class="hljs-comment"># 降低随机性，提升工具调用稳定性</span>
        <span class="hljs-attr">max_tokens</span>=<span class="hljs-number">1000</span>
    )
</code></pre>
<h3 data-id="heading-6">关键参数详解：</h3>






























<table><thead><tr><th>参数</th><th>作用</th><th>建议值</th></tr></thead><tbody><tr><td><code>tools</code></td><td>告诉 LLM 可用的工具列表</td><td>列表 of Tool Schema</td></tr><tr><td><code>tool_choice</code></td><td>控制工具调用策略</td><td><code>"auto"</code>（自动）、<code>"none"</code>、<code>{"type": "function", "function": {"name": "xxx"}}</code>（强制调用）</td></tr><tr><td><code>temperature</code></td><td>控制输出随机性</td><td>工具调用场景建议 ≤0.5，避免胡乱调用</td></tr><tr><td><code>max_tokens</code></td><td>限制输出长度</td><td>防止无限生成</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>设计哲学</strong>：函数应只做一件事（发送请求），不包含业务逻辑，便于测试和复用。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">四、工具定义：OpenAI Tool Schema 深度解读</h2>
<pre><code class="hljs language-ini" lang="ini">python
编辑
<span class="hljs-attr">tools</span> = [
    {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>,
        <span class="hljs-string">"function"</span>: {
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"get_weather"</span>,
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"获取指定城市的当前天气，仅支持中国大陆城市"</span>,
            <span class="hljs-string">"parameters"</span>: {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                <span class="hljs-string">"properties"</span>: {
                    <span class="hljs-string">"location"</span>: {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                        <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市拼音或中文名，如'beijing'或'北京'"</span>
                    }
                },
                <span class="hljs-string">"required"</span>: [<span class="hljs-string">"location"</span>]
            }
        }
    }
]
</code></pre>
<h3 data-id="heading-8">Schema 各字段含义：</h3>
<ul>
<li><code>type</code>: 目前仅支持 <code>"function"</code>，未来可能扩展 <code>"retrieval"</code>、<code>"code_interpreter"</code> 等。</li>
<li><code>name</code>: 函数标识符，必须与本地 Python 函数名一致。</li>
<li><code>description</code>: <strong>极其重要！</strong>  LLM 依靠此描述判断何时调用该工具。应清晰、具体、带约束。</li>
<li><code>parameters</code>: 使用 <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">JSON Schema</a> 描述输入格式，确保 LLM 生成合法参数。</li>
</ul>
<blockquote>
<p>📌 <strong>经验法则</strong>：<code>description</code> 越详细，调用准确率越高。例如加上“仅支持中国大陆城市”可避免用户问“纽约天气”时错误调用。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">五、本地函数实现：健壮性与错误处理</h2>
<pre><code class="hljs language-python" lang="python">python
编辑
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">location: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    url = <span class="hljs-string">"https://api.seniverse.com/v3/weather/now.json"</span>
    params = {
        <span class="hljs-string">"key"</span>: os.getenv(<span class="hljs-string">"SENIVERSE_KEY"</span>),
        <span class="hljs-string">"location"</span>: location,
        <span class="hljs-string">"language"</span>: <span class="hljs-string">"zh-Hans"</span>
    }
    
    <span class="hljs-keyword">try</span>:
        resp = requests.get(url, params=params, timeout=<span class="hljs-number">8</span>)
        resp.raise_for_status()  <span class="hljs-comment"># 抛出 HTTP 错误</span>
        
        data = resp.json()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data.get(<span class="hljs-string">"results"</span>):
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"未找到城市 '<span class="hljs-subst">{location}</span>' 的天气信息，请检查名称是否正确。"</span>
            
        r = data[<span class="hljs-string">"results"</span>][<span class="hljs-number">0</span>]
        city = r[<span class="hljs-string">"location"</span>][<span class="hljs-string">"name"</span>]
        now = r[<span class="hljs-string">"now"</span>]
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{city}</span>当前天气：<span class="hljs-subst">{now[<span class="hljs-string">'text'</span>]}</span>，气温 <span class="hljs-subst">{now[<span class="hljs-string">'temperature'</span>]}</span>℃"</span>
        
    <span class="hljs-keyword">except</span> requests.exceptions.Timeout:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"天气服务响应超时，请稍后再试。"</span>
    <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"网络请求失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
    <span class="hljs-keyword">except</span> (KeyError, json.JSONDecodeError):
        <span class="hljs-keyword">return</span> <span class="hljs-string">"天气服务返回格式异常。"</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"未知错误：<span class="hljs-subst">{<span class="hljs-built_in">repr</span>(e)}</span>"</span>
</code></pre>
<h3 data-id="heading-10">错误处理层次：</h3>
<ol>
<li><strong>网络层</strong>：超时、DNS 失败、SSL 错误 → <code>requests.exceptions</code></li>
<li><strong>HTTP 层</strong>：404、500 → <code>resp.raise_for_status()</code></li>
<li><strong>数据层</strong>：JSON 解析失败、字段缺失 → <code>KeyError</code>, <code>JSONDecodeError</code></li>
<li><strong>兜底层</strong>：捕获所有异常，避免程序崩溃</li>
</ol>
<blockquote>
<p>✅ <strong>最佳实践</strong>：函数返回<strong>人类可读的字符串</strong>，而非原始数据或异常对象，便于 LLM 理解。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">六、完整工具调用流程：两阶段交互详解</h2>
<p>这是整个系统的核心逻辑，分为两个阶段：</p>
<h3 data-id="heading-12">阶段 1：LLM 决策是否调用工具</h3>
<pre><code class="hljs language-ini" lang="ini">python
编辑
<span class="hljs-attr">messages</span> = [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"上海明天会下雨吗？"</span>}]
<span class="hljs-attr">response</span> = send_message(messages, tools=tools)
<span class="hljs-attr">msg</span> = response.choices[<span class="hljs-number">0</span>].message
</code></pre>
<p>此时，<code>msg</code> 可能包含：</p>
<ul>
<li><code>content</code>: 一段文字（无需工具）</li>
<li><code>tool_calls</code>: 一个列表，每个元素包含 <code>id</code>, <code>function.name</code>, <code>function.arguments</code></li>
</ul>
<blockquote>
<p>🔍 <strong>内部机制</strong>：LLM 在生成过程中，若判断需要外部信息，会<strong>停止生成自然语言</strong>，转而输出一个结构化的函数调用请求（以特殊 token 标记）。</p>
</blockquote>
<h3 data-id="heading-13">阶段 2：执行工具并回传结果</h3>
<pre><code class="hljs language-ini" lang="ini">python
编辑
if msg.tool_calls:
    messages.append(msg)  <span class="hljs-comment"># 保存 LLM 的决策</span>
    
    for tool_call in msg.tool_calls:
        <span class="hljs-attr">func_name</span> = tool_call.function.name
        <span class="hljs-attr">args</span> = json.loads(tool_call.function.arguments)  <span class="hljs-comment"># 注意：arguments 是 JSON 字符串！</span>
        
        <span class="hljs-comment"># 动态调用函数（可用字典映射替代 if-else）</span>
        <span class="hljs-attr">available_functions</span> = {
            "get_weather": get_weather,
            "get_closing_price": get_closing_price
        }
        <span class="hljs-attr">func</span> = available_functions.get(func_name)
        <span class="hljs-attr">result</span> = func(**args) if func else <span class="hljs-string">"未知工具"</span>
        
        <span class="hljs-comment"># 将结果作为 'tool' 消息加入对话历史</span>
        messages.append({
            "role": "tool",
            "tool_call_id": tool_call.id,
            "name": func_name,
            "content": result
        })
    
    <span class="hljs-comment"># 阶段 3：LLM 整合结果生成最终回答</span>
    <span class="hljs-attr">final_resp</span> = send_message(messages)
    print(final_resp.choices<span class="hljs-section">[0]</span>.message.content)
</code></pre>
<h3 data-id="heading-14">关键细节：</h3>
<ul>
<li><code>tool_call_id</code>：用于关联“请求”与“响应”，确保多工具调用时不混淆。</li>
<li><code>role="tool"</code>：这是 OpenAI 协议规定的特殊角色，LLM 会识别此消息为函数返回值。</li>
<li><strong>对话历史必须完整保留</strong>：包括 system、user、assistant、tool 消息，否则 LLM 无法理解上下文。</li>
</ul>
<hr/>
<h2 data-id="heading-15">七、扩展：支持多工具与动态注册</h2>
<p>为支持未来新增工具（如查快递、翻译），可设计注册机制：</p>
<pre><code class="hljs language-ruby" lang="ruby">python
编辑
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolRegistry</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):
        <span class="hljs-variable language_">self</span>.functions = {}
        <span class="hljs-variable language_">self</span>.schemas = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, func, schema</span>):
        name = func.__name__
        <span class="hljs-variable language_">self</span>.functions[name] = func
        <span class="hljs-variable language_">self</span>.schemas.append(schema)
        <span class="hljs-keyword">return</span> func

registry = <span class="hljs-title class_">ToolRegistry</span>()

<span class="hljs-comment"># 注册天气工具</span>
<span class="hljs-variable">@registry</span>.register
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params"><span class="hljs-symbol">location:</span> str</span>) -&gt; <span class="hljs-symbol">str:</span>
    <span class="hljs-comment"># ... 实现同上 ...</span>

weather_schema = { <span class="hljs-regexp">/* 同上 */</span> }
registry.register(get_weather, weather_schema)

<span class="hljs-comment"># 调用时</span>
tools = registry.schemas
func = registry.functions[tool_call.function.name]
</code></pre>
<blockquote>
<p>🚀 此模式类似 Flask 的 <code>@app.route</code>，实现“声明式工具注册”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-16">八、性能与安全考量</h2>
<h3 data-id="heading-17">8.1 性能优化</h3>
<ul>
<li><strong>缓存</strong>：对高频查询（如茅台股价）加内存缓存（<code>functools.lru_cache</code>）</li>
<li><strong>异步</strong>：使用 <code>httpx.AsyncClient</code> + <code>async/await</code> 提升并发能力</li>
<li><strong>限流</strong>：在函数内加计数器，防止恶意用户刷接口</li>
</ul>
<h3 data-id="heading-18">8.2 安全防护</h3>
<ul>
<li><strong>输入校验</strong>：对 <code>location</code> 做白名单或正则过滤，防止 SSRF（如 <code>location=http://internal.server</code>）</li>
<li><strong>沙箱执行</strong>：若工具涉及代码执行（如 <code>code_interpreter</code>），务必在隔离环境中运行</li>
<li><strong>日志审计</strong>：记录所有工具调用，便于追踪与分析</li>
</ul>
<hr/>
<h2 data-id="heading-19">九、调试技巧：如何排查工具调用失败？</h2>
<ol>
<li><strong>打印完整 messages</strong>：确认对话历史格式正确</li>
<li><strong>检查 arguments 是否合法 JSON</strong>：常见错误是 LLM 生成了非 JSON 字符串</li>
<li><strong>验证 function name 是否匹配</strong>：大小写敏感！</li>
<li><strong>查看模型是否支持 tool calling</strong>：并非所有模型都支持（如 <code>gpt-3.5-turbo-instruct</code> 不支持）</li>
</ol>
<p>示例调试代码：</p>
<pre><code class="hljs language-vbscript" lang="vbscript">python
编辑
pr<span class="hljs-built_in">int</span>(<span class="hljs-string">"LLM 返回:"</span>, msg)
<span class="hljs-keyword">if</span> msg.tool_calls:
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">call</span> <span class="hljs-keyword">in</span> msg.tool_calls:
        pr<span class="hljs-built_in">int</span>(<span class="hljs-string">"欲调用函数:"</span>, <span class="hljs-keyword">call</span>.<span class="hljs-keyword">function</span>.name)
        pr<span class="hljs-built_in">int</span>(<span class="hljs-string">"参数 (raw):"</span>, <span class="hljs-keyword">call</span>.<span class="hljs-keyword">function</span>.arguments)
        pr<span class="hljs-built_in">int</span>(<span class="hljs-string">"参数 (parsed):"</span>, json.loads(<span class="hljs-keyword">call</span>.<span class="hljs-keyword">function</span>.arguments))
</code></pre>
<hr/>
<h2 data-id="heading-20">十、总结与展望</h2>
<h3 data-id="heading-21">核心收获</h3>

























<table><thead><tr><th>维度</th><th>内容</th></tr></thead><tbody><tr><td><strong>架构</strong></td><td>两阶段交互（决策 → 执行 → 整合）是 Tool Use 的标准范式</td></tr><tr><td><strong>模块化</strong></td><td>分离 LLM 调用、工具定义、业务函数，提升可维护性</td></tr><tr><td><strong>健壮性</strong></td><td>全链路错误处理 + 输入校验 = 生产级系统</td></tr><tr><td><strong>扩展性</strong></td><td>通过注册机制，轻松新增工具</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于cesium的primitive的modelMatrix的应用]]></title>    <link>https://juejin.cn/post/7574270661872173094</link>    <guid>https://juejin.cn/post/7574270661872173094</guid>    <pubDate>2025-11-19T11:04:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574270661872173094" data-draft-id="7574204970746363950" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于cesium的primitive的modelMatrix的应用"/> <meta itemprop="keywords" content="cesium,JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-19T11:04:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="整点可乐"/> <meta itemprop="url" content="https://juejin.cn/user/1603526542767677"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于cesium的primitive的modelMatrix的应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1603526542767677/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    整点可乐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T11:04:55.000Z" title="Wed Nov 19 2025 11:04:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在阅读这篇文章之前,建议先了解什么是<strong>仿射变换矩阵</strong></p>
<h2 data-id="heading-0">序. 仿射变换矩阵</h2>
<h3 data-id="heading-1">1、核心概念：什么是仿射变换？</h3>
<p>仿射变换是一类 “线性变换 + 平移” 的组合变换，具体包括：</p>
<ul>
<li><strong>线性变换</strong>：旋转（Rotation）、缩放（Scaling）、剪切（Shearing）；</li>
<li><strong>平移变换</strong>：将图形沿某个方向移动（Translation）。</li>
</ul>
<p>例如：把一张图片旋转 30° 后再向右移动 100 像素，就是一次仿射变换。</p>
<h3 data-id="heading-2">2、仿射变换矩阵的结构（以 3D 为例，Cesium 中最常用）</h3>
<p>在 3D 空间中，仿射变换矩阵是一个<strong>4×4 的矩阵</strong>（齐次坐标矩阵），结构如下（列优先存储，Cesium 默认格式）：</p>
<pre><code class="hljs language-arduino" lang="arduino">[
  a, d, g, j,  <span class="hljs-comment">// 第1列：X轴线性变换参数</span>
  b, e, h, k,  <span class="hljs-comment">// 第2列：Y轴线性变换参数</span>
  c, f, i, l,  <span class="hljs-comment">// 第3列：Z轴线性变换参数</span>
  <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>   <span class="hljs-comment">// 第4列：齐次坐标固定项（确保矩阵乘法合法性）</span>
]
</code></pre>
<ul>
<li>
<p><strong>前 3×3 子矩阵（a-i）</strong> ：负责线性变换（旋转、缩放、剪切）；</p>
<p>这里详细分解一下旋转和缩放:</p>
<p>缩放变换：由前 3×3 子矩阵的 “对角线元素” 控制</p>
</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">  Sx,  <span class="hljs-number">0</span>,  <span class="hljs-number">0</span>,  <span class="hljs-comment">// X轴缩放因子（m00）</span>
   <span class="hljs-number">0</span>, Sy,  <span class="hljs-number">0</span>,  <span class="hljs-comment">// Y轴缩放因子（m05）</span>
   <span class="hljs-number">0</span>,  <span class="hljs-number">0</span>, Sz   <span class="hljs-comment">// Z轴缩放因子（m10）</span>
</code></pre>
<p>      旋转变换：由前 3×3 子矩阵的 “所有元素共同控制”（正交矩阵）</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 绕 Z 轴旋转（航向角 Heading，对应 yaw）,旋转角度为`θ`，矩阵元素：</span>
[
  cosθ, -sinθ, <span class="hljs-number">0</span>,  <span class="hljs-comment">// 第0列：m00=cosθ, m01=-sinθ, m02=0</span>
  sinθ,  cosθ, <span class="hljs-number">0</span>,  <span class="hljs-comment">// 第1列：m04=sinθ, m05=cosθ, m06=0</span>
  <span class="hljs-number">0</span>,      <span class="hljs-number">0</span>,   <span class="hljs-number">1</span>   <span class="hljs-comment">// 第2列：m08=0, m09=0, m10=1</span>
]

<span class="hljs-comment">// 绕 X 轴旋转（翻滚角 Roll）,旋转角度为`φ`，矩阵元素:</span>
[
  <span class="hljs-number">1</span>,   <span class="hljs-number">0</span>,    <span class="hljs-number">0</span>,   <span class="hljs-comment">// 第0列：m00=1, m01=0, m02=0</span>
  <span class="hljs-number">0</span>, cosφ, -sinφ, <span class="hljs-comment">// 第1列：m04=0, m05=cosφ, m06=-sinφ</span>
  <span class="hljs-number">0</span>, sinφ,  cosφ  <span class="hljs-comment">// 第2列：m08=0, m09=sinφ, m10=cosφ</span>
]

<span class="hljs-comment">// 绕 Y 轴旋转（俯仰角 Pitch）,旋转角度为`ψ`，矩阵元素：</span>
[
  cosψ, <span class="hljs-number">0</span>, sinψ,  <span class="hljs-comment">// 第0列：m00=cosψ, m01=0, m02=sinψ</span>
  <span class="hljs-number">0</span>,    <span class="hljs-number">1</span>,    <span class="hljs-number">0</span>,  <span class="hljs-comment">// 第1列：m04=0, m05=1, m06=0</span>
  -sinψ,<span class="hljs-number">0</span>, cosψ   <span class="hljs-comment">// 第2列：m08=-sinψ, m09=0, m10=cosψ</span>
]
</code></pre>
<ul>
<li>
<p><strong>第 4 列前 3 个元素（j, k, l）</strong> ：负责平移变换（X、Y、Z 方向的平移量）；</p>
</li>
<li>
<p><strong>最后一行（0,0,0,1）</strong> ：齐次坐标的 “标识行”，确保矩阵乘法能正确融合线性变换和平移。</p>
</li>
</ul>
<h3 data-id="heading-3">3、为什么用 4×4 矩阵？（齐次坐标的作用）</h3>
<p>线性变换（如旋转、缩放）可以用 3×3 矩阵表示，但<strong>平移无法用 3×3 矩阵单独实现</strong>（因为线性变换的原点映射后仍是原点，而平移会改变原点位置）。</p>
<p>通过引入 “齐次坐标”（3D 点用 4 个分量<code>(x, y, z, 1)</code>表示），4×4 矩阵可以<strong>统一处理线性变换和平移</strong>：</p>
<ul>
<li>对一个点<code>(x, y, z, 1)</code>应用仿射变换矩阵后，结果为：<code>x' = a*x + d*y + g*z + j``y' = b*x + e*y + h*z + k``z' = c*x + f*y + i*z + l</code>（同时满足线性变换和平移的组合效果）</li>
</ul>
<h3 data-id="heading-4">4、Cesium 中的仿射变换矩阵实例</h3>
<p>Cesium 中几乎所有模型 / 物体的位置和姿态调整，都依赖 4×4 仿射变换矩阵（如<code>modelMatrix</code>）：</p>
<p>a.  <strong>纯平移矩阵</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">``</span><span class="hljs-string">`
// 沿X轴平移10，Y轴平移20，Z轴平移30
const translateMatrix = Cesium.Matrix4.fromTranslation(new Cesium.Cartesian3(10, 20, 30));
`</span><span class="hljs-string">``</span>

矩阵结构为：

<span class="hljs-string">``</span><span class="hljs-string">`
[1,0,0,10,  
 0,1,0,20,  
 0,0,1,30,  
 0,0,0,1]
`</span><span class="hljs-string">``</span>
</code></pre>
<p>b.  <strong>旋转 + 平移矩阵</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">``</span><span class="hljs-string">`
// 以center为原点，应用HPR旋转，生成包含旋转和平移的仿射矩阵
const hprMatrix = Cesium.Transforms.headingPitchRollToFixedFrame(center, hpr);
`</span><span class="hljs-string">``</span>

其中前 <span class="hljs-number">3</span>×<span class="hljs-number">3</span> 子矩阵是旋转（线性变换），第 <span class="hljs-number">4</span> 列是 center 的坐标（平移）。
</code></pre>
<h3 data-id="heading-5">5、核心作用：统一组合多个变换</h3>
<p>仿射变换矩阵的最大价值是<strong>支持矩阵乘法组合多个变换</strong>。例如：先缩放→再旋转→最后平移，只需将三个变换矩阵按顺序相乘（注意顺序：从右到左应用）：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Cesium中矩阵的乘法为右乘!即</span>
<span class="hljs-comment">//matA * matB,写作</span>
 Cesium.Matrix4.<span class="hljs-built_in">multiply</span>(matB, matA, <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Matrix4</span>())
 
<span class="hljs-comment">// 缩放矩阵 → 旋转矩阵 → 平移矩阵</span>
<span class="hljs-type">const</span> temp = Cesium.Matrix4.<span class="hljs-built_in">multiply</span>(rotateMatrix, scaleMatrix)
<span class="hljs-type">const</span> finalMatrix = Cesium.Matrix4.<span class="hljs-built_in">multiply</span>(translateMatrix, temp);
</code></pre>
<h2 data-id="heading-6">一.平移</h2>
<h3 data-id="heading-7">1. 世界坐标平移(原点目标点皆为世界坐标)</h3>
<p>思路,获取向量差,将向量差转为平移矩阵</p>
<pre><code class="hljs language-ini" lang="ini">// origin 为原点坐标,target为目标坐标
const <span class="hljs-attr">sub</span> = Cesium.Cartesian3.subtract(target, origin, new Cesium.Cartesian3())
<span class="hljs-attr">primitive.modelMatrix</span> = Cesium.Matrix4.fromTranslation(sub)
</code></pre>
<h3 data-id="heading-8">2. 局部坐标平移(如模型向南平移200米)</h3>
<p>思路,计算出目标点世界坐标,获取向量差,将向量差转为平移矩阵</p>
<pre><code class="hljs language-ini" lang="ini">// origin 为原点坐标,local_translation为平移向量
const <span class="hljs-attr">originMatrix4</span> = Cesium.Transforms.eastNorthUpToFixedFrame(origin)<span class="hljs-comment">;</span>
// 平移向量的构建为:new Cesium.Cartesian3(东,北,上)
const <span class="hljs-attr">local_translation</span> = new Cesium.Cartesian3(<span class="hljs-number">300</span>, <span class="hljs-number">200</span>, <span class="hljs-number">100</span>)<span class="hljs-comment">; </span>
const <span class="hljs-attr">result</span> = new Cesium.Cartesian3(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
// 转换矩阵左乘局部平移向量，结果存储在 result 中，结果是世界坐标下的平移终点向量,即目标点的世界坐标
Cesium.Matrix4.multiplyByPoint(frompoint_to_world_matrix, local_translation, result)<span class="hljs-comment">; </span>
// 获取世界坐标平移向量
const <span class="hljs-attr">sub</span> = Cesium.Cartesian3.subtract(result, origin, new Cesium.Cartesian3())
// 应用平移
<span class="hljs-attr">primitive.modelMatrix</span> = Cesium.Matrix4.fromTranslation(sub)
</code></pre>
<h2 data-id="heading-9">二.旋转</h2>
<p>思路,因为Cesium的Primitive旋转中心为坐标系中心, 所以必须先来到坐标系中心,再做操作,最后返回原点</p>
<pre><code class="hljs language-arduino" lang="arduino">    <span class="hljs-comment">// 获取从坐标系中心到原点的位移矩阵</span>
    <span class="hljs-type">const</span> backMat = Cesium.Matrix4.<span class="hljs-built_in">fromTranslation</span>(origin)
    <span class="hljs-comment">// 将向量取反,用于获取相反的位移矩阵,用于前往坐标系中心</span>
    <span class="hljs-type">const</span> toVec = <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Cartesian3</span>(-origin.x, -origin.y, -origin.z)
    <span class="hljs-type">const</span> toMat = Cesium.Matrix4.<span class="hljs-built_in">fromTranslation</span>(toVec)
    
    <span class="hljs-comment">// 获取旋转参数</span>
    <span class="hljs-type">const</span> hpr = <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">HeadingPitchRoll</span>(heading,pitch,roll)
    <span class="hljs-comment">// 因为目前模型在坐标系中心,第一个参数要写Cesium.Cartesian3.ZERO</span>
    <span class="hljs-type">const</span> rotateMatrix = Cesium.Transforms.<span class="hljs-built_in">headingPitchRollToFixedFrame</span>(Cesium.Cartesian3.ZERO, hpr, Cesium.Ellipsoid.WGS84)
    
    <span class="hljs-comment">// 获取完整矩阵,根据顺序应当 原点→中心→变换→原点,所以应当是 toMat * rotateMatrix * backMat</span>
    <span class="hljs-comment">// 注意Cesium矩阵相乘是右乘!!!!!!</span>
    <span class="hljs-type">const</span> temp = Cesium.Matrix4.<span class="hljs-built_in">multiply</span>(rotateMatrix, toMat, <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Matrix4</span>())
    <span class="hljs-type">const</span> res = Cesium.Matrix4.<span class="hljs-built_in">multiply</span>(backMat, temp, <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Matrix4</span>())
    Primitive.modelMatrix = res
</code></pre>
<h2 data-id="heading-10">三.缩放</h2>
<p>思路,依旧必须先来到坐标系中心,再做缩放,最后返回原点</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 省略来回位移的代码,rotateMatrix替换成scaleMat</span>
<span class="hljs-comment">// 获取缩放参数</span>
<span class="hljs-type">const</span> scaleVec = <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Cartesian3</span>(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>)
<span class="hljs-type">const</span> scaleMat = Cesium.Matrix4.<span class="hljs-built_in">fromScale</span>(scaleVec, <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Matrix4</span>())
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Trae 帮我做了一个小插件后，我反而发现了它最该优化的 6 个地方]]></title>    <link>https://juejin.cn/post/7574245125028708371</link>    <guid>https://juejin.cn/post/7574245125028708371</guid>    <pubDate>2025-11-19T11:10:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574245125028708371" data-draft-id="7574230586971521030" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Trae 帮我做了一个小插件后，我反而发现了它最该优化的 6 个地方"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-19T11:10:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ouma_syu"/> <meta itemprop="url" content="https://juejin.cn/user/2728363512824729"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Trae 帮我做了一个小插件后，我反而发现了它最该优化的 6 个地方
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2728363512824729/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ouma_syu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T11:10:17.000Z" title="Wed Nov 19 2025 11:10:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用 Trae 做 Hulk 插件之后，我发现了 6 个值得优化的地方</h2>
<p>用 Trae 生成一个“把网页背景变成绿色”的 Chrome 扩展并不算难。但做完之后你会发现：<strong>难的不是实现功能，而是让整个开发流程更顺滑、更易维护、更能复用到下一个项目。</strong></p>
<p>这篇文章总结lq我在用 Trae 搭建这个 Hulk 插件时，认为最值得优化的六个点。它们能显著提升你用 Trae 做扩展程序时的效率和体验。</p>
<hr/>
<h3 data-id="heading-1"><strong>1. Instruction 太“硬编码”，需要拆成更灵活的 Prompt 模板</strong></h3>
<p>我最开始的 instruction 写得非常具体：</p>
<ul>
<li>打开弹窗</li>
<li>显示某段提示文案</li>
<li>按下按钮后改为绿色</li>
<li>图标来自 icons 文件夹</li>
</ul>
<p>虽然 agent 确实照做了，但缺点也很明显：</p>
<ul>
<li><strong>复用性极低</strong>：下次做另一个插件还得重写一大段</li>
<li><strong>扩展性差</strong>：每一个变化都要手动改 instruction</li>
<li><strong>Agent 没有思考空间</strong>，只能完全按照文字执行</li>
</ul>
<p>为了让 Trae 更“聪明”，我后来把整个 instruction 拆成三类模板：</p>
<h4 data-id="heading-2">模板 1：功能需求 Prompt（只描述“做什么”）</h4>
<p>如：改变背景颜色、按钮文案、颜色参数等。</p>
<h4 data-id="heading-3">模板 2：工程结构 Prompt（描述“怎么组织文件”）</h4>
<p>如：固定扩展目录结构、manifest.json 模板、icons 规则。</p>
<h4 data-id="heading-4">模板 3：质量校验 Prompt（描述“应该检查什么”）</h4>
<p>如：检查权限、检查路径、补齐缺失字段、判断是否需要 background script。</p>
<p><strong>这样一来，重用率大幅提升。</strong><br/>
以后做各种小插件，只需要换几个参数，而不是重写整份 instruction。</p>
<hr/>
<h3 data-id="heading-5"><strong>2. 文件生成可以更智能，而不是“Agent 想怎么写就怎么写”</strong></h3>
<p>Trae 的文件生成机制本质是：</p>
<pre><code class="hljs">描述 → Agent 生成文件内容 → 写文件节点
</code></pre>
<p>但这样有几个常见问题：</p>
<ul>
<li>文件名可能会被误解</li>
<li>manifest.json 字段容易缺</li>
<li>popup.html 不会自动生成对应的 CSS、JS</li>
</ul>
<p>所以很有必要做一个“半自动 scaffold（脚手架）”流程：</p>
<h4 data-id="heading-6">建议：预置好插件基础结构模板</h4>
<pre><code class="hljs language-lua" lang="lua">/hulk-extension
|<span class="hljs-comment">-- manifest.json</span>
|<span class="hljs-comment">-- popup/</span>
|     |<span class="hljs-comment">-- popup.html</span>
|     |<span class="hljs-comment">-- popup.js</span>
|<span class="hljs-comment">-- icons/</span>
</code></pre>
<p>然后让 agent 只负责填内容，而不是猜结构。</p>
<p>再进一步完善：</p>
<ul>
<li>popup.html 自动补 script</li>
<li>按钮 id 与 JS 自动对应</li>
<li>manifest 自动补 permissions、icons 等</li>
</ul>
<p><strong>这样可以避免大量低级错误，并让 Agent 输出更稳定。</strong></p>
<hr/>
<h3 data-id="heading-7"><strong>3. 文案、颜色等参数不要写死，应该“变量化”处理</strong></h3>
<p>最初 instruction 中写的是：</p>
<ul>
<li>按钮文字固定</li>
<li>提示文字固定</li>
<li>目标颜色固定为“绿色”</li>
</ul>
<p>这种写法对一次性任务没问题，但对插件开发非常不友好。</p>
<h4 data-id="heading-8">🔧 建议：在 Trae 工作流程中加入参数化</h4>
<p>例如：</p>
<ul>
<li><code>targetColor = "#00FF00"</code></li>
<li><code>buttonLabel = "改变颜色"</code></li>
<li><code>popupTitle = "改变背景颜色"</code></li>
<li><code>htmlTip = "点击按钮将页面变成绿色"</code></li>
</ul>
<p>然后自动注入到 popup 页面中。</p>
<p>这样你就可以轻松扩展到：</p>
<ul>
<li>自定义颜色</li>
<li>多主题切换</li>
<li>用户选择颜色</li>
<li>记忆上次设置</li>
</ul>
<p>让同一个流程能覆盖更多功能。</p>
<hr/>
<h3 data-id="heading-9"><strong>4. Trae 可以自动生成 README，这一步不要忽略</strong></h3>
<p>很多 Chrome 插件最大的缺点就是 <strong>没有 README</strong>。<br/>
这会导致：</p>
<ul>
<li>自己过几天再看忘得一干二净</li>
<li>上传 GitHub 毫无可读性</li>
<li>想发布到 Chrome 商店还得重新写说明</li>
</ul>
<p>Trae 完全可以自动帮你生成这些内容：</p>
<ul>
<li>插件简介</li>
<li>使用方式</li>
<li>项目结构</li>
<li>权限说明</li>
<li>下一步扩展计划</li>
</ul>
<p><strong>省事、省心、省时间。</strong></p>
<hr/>
<h3 data-id="heading-10"><strong>5. 流程里缺少“自动调试提示”，第一次做插件的体验会很痛苦</strong></h3>
<p>Trae 可以生成代码，但它不能加载浏览器插件；<br/>
而初次做扩展的开发者最常遇到的问题是：</p>
<ul>
<li>为什么 popup 不显示？</li>
<li>为什么点击没反应？</li>
<li>为什么 manifest 报错？</li>
</ul>
<p>所以我给流程加了一段“自动调试 checklist”作为最后输出：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 打开 Chrome 扩展程序管理页面
<span class="hljs-bullet">2.</span> 启用开发者模式
<span class="hljs-bullet">3.</span> 加载已解压的扩展程序
<span class="hljs-bullet">4.</span> 检查 popup 是否正常弹出
<span class="hljs-bullet">5.</span> 控制台是否报错
<span class="hljs-bullet">6.</span> 颜色是否成功改变
</code></pre>
<p>这种“检查单”极其实用，尤其对新人友好。</p>
<hr/>
<h3 data-id="heading-11"><strong>6. icons 文件的校验很重要，但容易被忽略</strong></h3>
<p>指明“使用 icons 文件夹里的图标”并不代表 Agent 会：</p>
<ul>
<li>检查文件是否存在</li>
<li>名称是否规范</li>
<li>manifest 是否正确引用</li>
</ul>
<p>建议你让 Trae 自动确认：</p>
<pre><code class="hljs language-markdown" lang="markdown">icons/
<span class="hljs-bullet">  -</span> 16.png
<span class="hljs-bullet">  -</span> 48.png
<span class="hljs-bullet">  -</span> 128.png
</code></pre>
<p>并生成：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"icons"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"16"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icons/16.png"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"48"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icons/48.png"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"128"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icons/128.png"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这可以避免 Chrome 一直报图标找不到的烦人问题。</p>
<hr/>
<h2 data-id="heading-12">这 6 个优化点能让 Trae 项目更加优秀</h2>








































<table><thead><tr><th>优化方向</th><th>为什么值得做？</th><th>能带来什么变化？</th></tr></thead><tbody><tr><td>Prompt 模块化</td><td>减少重复工作</td><td>每次做插件都能复用</td></tr><tr><td>文件生成智能化</td><td>降低结构问题</td><td>项目更“标准化”</td></tr><tr><td>参数化处理</td><td>提高扩展性</td><td>多功能插件轻松做</td></tr><tr><td>自动 README</td><td>文档不再遗漏</td><td>可发布、可维护</td></tr><tr><td>调试提示</td><td>快速排错</td><td>开发更顺滑</td></tr><tr><td>icons 校验</td><td>避免 manifest 错误</td><td>图标稳定显示</td></tr></tbody></table>
<p>Trae 的强大不在于让你少写多少代码，而在于帮你 <strong>把流程变得更自动化、更可复用、更可扩展</strong>。<br/>
只要把这些优化点做到位，你之后开发 Chrome 插件的效率会成倍提升。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[pwa实现动态start_url和scope等实现方案]]></title>    <link>https://juejin.cn/post/7574269207362453513</link>    <guid>https://juejin.cn/post/7574269207362453513</guid>    <pubDate>2025-11-19T11:47:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574269207362453513" data-draft-id="7574254039023534106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="pwa实现动态start_url和scope等实现方案"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-19T11:47:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="1024小神"/> <meta itemprop="url" content="https://juejin.cn/user/70007368988926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            pwa实现动态start_url和scope等实现方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/70007368988926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    1024小神
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T11:47:38.000Z" title="Wed Nov 19 2025 11:47:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我的开源项目PakePlus可以将网页/Vue/React项目打包为桌面/手机应用并且小于5M只需几分钟，官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpakeplus.com" target="_blank" title="https://pakeplus.com" ref="nofollow noopener noreferrer">pakeplus.com</a></p><p><img alt="" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6efa95aecf914071a661c688fb776aad~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" width="1968" loading="lazy"/></p><p/>
<p>要想实现动态的start_url，比如定制不同的路径或者添加参数，就可以使用这段代码，但是！！！！！这个在safari中不生效，所以如果你是ipad设备或者ios设备是不生效的，这个是坑</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">transformManifest</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'transformManifest'</span>)
    <span class="hljs-keyword">const</span> url = <span class="hljs-string">'/manifest.webmanifest'</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'url'</span>, url)
    <span class="hljs-keyword">const</span> manifest = <span class="hljs-keyword">await</span> (<span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url)).<span class="hljs-title function_">json</span>()
    <span class="hljs-keyword">const</span> path = location.<span class="hljs-property">pathname</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'/'</span>)
    <span class="hljs-keyword">const</span> newPath =
        path &amp;&amp; provideruuid &amp;&amp; stationeuuid
            ? <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span> +
              <span class="hljs-string">'?provideruuid='</span> +
              provideruuid +
              <span class="hljs-string">'&amp;stationeuuid='</span> +
              stationeuuid
            : <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'newPath'</span>, newPath)
    manifest.<span class="hljs-property">start_url</span> = newPath
    manifest.<span class="hljs-property">scope</span> = newPath
    manifest.<span class="hljs-property">id</span> = <span class="hljs-string">'/'</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'manifest'</span>, manifest)
    <span class="hljs-keyword">const</span> manifestString = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(manifest)
    <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([manifestString], { <span class="hljs-attr">type</span>: <span class="hljs-string">'application/json'</span> })
    <span class="hljs-keyword">const</span> manifestURL = <span class="hljs-variable constant_">URL</span>.<span class="hljs-title function_">createObjectURL</span>(blob)
    <span class="hljs-variable language_">document</span>
        .<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'[rel="manifest"]'</span>)
        ?.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'href'</span>, manifestURL)
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(manifestURL)
}</code></pre>
<p/>
大家好，我是1024小神，技术群 / 私活群 / 股票群 或 交朋友 都可以私信我。
如果你觉得本文有用，一键三连 (点赞、评论、关注)，就是对我最大的支持~</div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[pnpm 拉取github的n8n项目运行]]></title>    <link>https://juejin.cn/post/7574270661872386086</link>    <guid>https://juejin.cn/post/7574270661872386086</guid>    <pubDate>2025-11-19T12:05:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574270661872386086" data-draft-id="7574040813750370355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="pnpm 拉取github的n8n项目运行"/> <meta itemprop="keywords" content="前端,AIGC"/> <meta itemprop="datePublished" content="2025-11-19T12:05:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="姜姜小妞"/> <meta itemprop="url" content="https://juejin.cn/user/3069492196290718"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            pnpm 拉取github的n8n项目运行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3069492196290718/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    姜姜小妞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T12:05:52.000Z" title="Wed Nov 19 2025 12:05:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前言：</p>
<blockquote>
<p>本文章旨在记录单纯通过pnpm拉取拉取github开源项目n8n并成功运行期间遇到的问题</p>
<p>已退坑多年，私信可能不及时回复，请谅解（已换用户名由“鬼小妞”改为“姜姜小妞”）</p>
</blockquote>
<p><code>请确保已安装git及nvm</code>，或移步
专栏文章<a href="https://juejin.cn/column/7122745024520912903" target="_blank" title="https://juejin.cn/column/7122745024520912903">前端环境搭建与准备</a>安装git及nvm后再回来</p>
<h2 data-id="heading-0">流程</h2>
<ul>
<li>1.<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fn8n-io%2Fn8n" target="_blank" title="https://github.com/n8n-io/n8n" ref="nofollow noopener noreferrer"><strong>在github上下载n8n项目</strong></a></li>
<li>2.<strong>切换或下载 <code>"node"</code>: "&gt;=22.16", <code>"pnpm"</code>: "&gt;=10.22.0"</strong></li>
<li>3.<strong>pnpm install安装依赖</strong>，（出错后清除pnpm缓存删除node_moudles依赖包后重试）</li>
<li>4.<strong>pnpm build 打包项目</strong>（打包出错大部分是依赖安装问题请重复执行步骤3）
<ul>
<li><code>必须打包成功后才可成功pnpm start运行项目</code></li>
</ul>
</li>
<li>5.<strong>pnpm start运行项目</strong>
<ul>
<li>出错请检查打包后是否有packages\cli\dist\config是否存在，5678端口是否被占用，全局安装的n8n依赖包是否正在启动（我是直接删除了npm全局安装路径的n8n，非当前项目依赖）</li>
</ul>
</li>
</ul>
<p>具体步骤如下：</p>
<h2 data-id="heading-1">1. 下载n8n</h2>
<p>我们可以根据自己喜好git clone下载或者下载zip后解压，两种方式下载后基本都是一样的，我使用的是zip方式会快一点。</p>
<h3 data-id="heading-2">方式1：通过git clone下载</h3>
<p>你可以直接通过git clone下载：</p>
<pre><code class="hljs language-js" lang="js">git clone <span class="hljs-attr">https</span>:<span class="hljs-comment">//github.com/n8n-io/n8n.git</span>
</code></pre>
<h3 data-id="heading-3">方式2：通过下载zip解压</h3>
<blockquote>
<p>为了避免由于网络等原因导致下载不完整或失败的问题，我们也可通过下载zip包解压方式进行。</p>
</blockquote>
<p>进入 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fn8n-io%2Fn8n" target="_blank" title="https://github.com/n8n-io/n8n" ref="nofollow noopener noreferrer">github.com/n8n-io/n8n</a> 下载zip</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b544be508ce04f50985155538d7beebc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=AAoHbT69xD8oFHflwx2TEkGOV9Y%3D" alt="image.png" loading="lazy"/></p>
<p>把下载好的压缩包（25M左右）解压到n8n-master（73.7M左右）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfaa9960707245f3ada1f939df35eb6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=FNZHo7C%2FSTEoB6Ps5eWgTzlMsbc%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c798438271e34fb0845c6624aac17837~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=g0TG7KZ4bwo7mFCsAgnN85U9wss%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">2. 切换node版本并下载pnpm</h2>
<p>我们查看项目package.json文件可以看到，对于node和pnpm是需要固定版本及以上的，如下</p>
<blockquote>
<p>"node": "&gt;=22.16",</p>
<p>"pnpm": "&gt;=10.22.0"</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06d5087e6f714be384a294d4fb7bfd8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=1PwJZIRf7KxS77DD1oBr8r%2FmFXs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">2.1 安装node 22.16.0</h3>
<p>由于我是使用nvm管理node版本，我是通过cmd管理员身份运行nvm下载node22.16.0</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b822db2501e74f63817236fa25e78bed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=Opi9XdyYC5OR9MAlCK8uuFYBXhA%3D" alt="image.png" loading="lazy"/></p>
<p>使用nvm依次输入命令行</p>
<pre><code class="hljs language-js" lang="js">nvm install <span class="hljs-number">22.16</span><span class="hljs-number">.0</span>
nvm use <span class="hljs-number">22.16</span><span class="hljs-number">.0</span>
nvm ls
</code></pre>
<p>关于使用nvm管理node版本不再介绍，请移步查看
专栏文章<a href="https://juejin.cn/column/7122745024520912903" target="_blank" title="https://juejin.cn/column/7122745024520912903">前端环境搭建与准备</a>---&gt; <a href="https://juejin.cn/post/7120267871950733320" target="_blank" title="https://juejin.cn/post/7120267871950733320"> <code>nvm安装与配置</code> </a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd8f9bcccdad497aa59a05cf62690878~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=5CBoNdJk3Q6tiC6ILXujWNMY7Q8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">2.2 安装pnpm 10.22.0</h3>
<p>npm全局安装pnpm 10.22.0</p>
<pre><code class="hljs language-js" lang="js">npm install -g pnpm@<span class="hljs-number">10.22</span><span class="hljs-number">.0</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/071fd908bad745a3b622fd7d5f33ffc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=Hk8oFuv6%2FMEn3C3fJfR5tgxVDUc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-7">3. 项目运行前准备</h2>
<h3 data-id="heading-8">3.1 pnpm install安装模块依赖</h3>
<p>通过pnpm install进行项目依赖安装（默认国外的下载源需要网络非常好，网络差可能导致依赖下载失败）</p>
<pre><code class="hljs language-js" lang="js">pnpm install
</code></pre>
<p>如果觉得依赖安装太慢，你可以通过指定下载源（镜像）来安装（可能会存在源库中缺失某些依赖问题）</p>
<pre><code class="hljs language-js" lang="js">pnpm install --registry <span class="hljs-attr">https</span>:<span class="hljs-comment">//registry.npmmirror.com/</span>
</code></pre>
<p>依赖下载失败后，重新安装未成功的问题如图，<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e79ae91517e549cb82f700c90532b12f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=lsgx9CNjqy5bZKnMzEAIAySMzew%3D" alt="image.png" loading="lazy"/>
请按以下操作：</p>
<p>1.删除存储中未被任何项目使用的包版本</p>
<pre><code class="hljs">pnpm store prune
</code></pre>
<p>2.删除node_modules文件夹：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">rm</span> -rf node_modules
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9643fb85cb25489194a9f9adfd9ad173~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=Jw9kweuIrHy%2Fztuw%2F8S0emE1w4E%3D" alt="image.png" loading="lazy"/></p>
<p>必要时删除 pnpm-lock.yaml文件，建议暂时不要删除（有时候pnpm-lock.yaml中的版本与我们下载的版本不匹配，所以一般项目配置当中都忽略提交此文件）
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99742a06bbb94fc582a5113d76c3f817~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=vnX1o7PUQHA3gqRNA8axuupyssY%3D" alt="image.png" loading="lazy"/></p>
<p>3.重新执行强制安装命令</p>
<pre><code class="hljs language-js" lang="js">pnpm install --force
</code></pre>
<p>4.如果依赖重复安装失败，缺失部分依赖，只能手动一个个添加（我就是因为这个一直弄了很久），<code>如果重复因为以上问题如：“ELIFECYCLE  Command failed with exit code 1.”，请执行以上步骤1到4，非必要请勿进行步骤5操作</code>,一般有问题都是因为依赖包安装缺失问题。</p>
<p>5.如果强制安装后提示补丁<code>patchedDependencies</code>相关信息导致安装失败，如下图：</p>
<blockquote>
<p>一般到提示<code>patchedDependencies</code>字段的,那基本上，按照我在重复演示此流程的经验，就是依赖出错了，即使你在删除<code>patchedDependencies</code>字段内容后安装成功，后续依旧会在pnpm build打包环境出现问题。请你重新开始下载依赖安装，必要时请从github 下载n8n项目这个步骤重新开始。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5565b948d63e464294ef4d075997c3e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=bHsNuHS4%2BdiPWhKC8QBGZxrRW6c%3D" alt="image.png" loading="lazy"/></p>
<p>可以先删除package.json文件夹中的<code>patchedDependencies</code>字段内容，</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cbebd16c757483b94bf35de6253ba83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=hdS2KbOINoiAKpELwAcW1BWstk8%3D" alt="image.png" loading="lazy"/></p>
<p>删除补丁如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d013aeadb31443c4ad5af9842682326c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=XwoRRj2ELXb0yk1eVEXH42%2B7JRw%3D" alt="image.png" loading="lazy"/>
删除后：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b7ff73a03da45399d5af6a738e84ea4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=a9NbIZX9O5kKhhqLa76LyzVD2Ok%3D" alt="image.png" loading="lazy"/></p>
<p>在安装后记得恢复该字段内容。如果删除后重新安装依赖到pnpm build打包出现报错 <code>@n8n/imap#build</code>问题，那一定是依赖安装不成功导致的出错，一般到提示<code>patchedDependencies</code>字段的那基本上，我在重复演示此流程经验，就是依赖出错了，即使你在删除<code>patchedDependencies</code>字段内容后安装成功，后续依旧会在pnpm build打包环境出现问题。请你重新开始下载依赖安装，必要时请从github 下载n8n项目这个步骤重新开始。</p>
<h3 data-id="heading-9">3.2 pnpm build项目</h3>
<pre><code class="hljs language-js" lang="js">pnpm build
</code></pre>
<p>打包成功如下所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5da475ec9e549c79598705f507f1f73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=G1jOXwv2DBLNKf308Gixem2hsyA%3D" alt="image.png" loading="lazy"/></p>
<p><code>必须打包成功后有/dist/config目录文件才可成功pnpm start运行项目</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14b629cd977842a19450ed4bc661e475~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=HTqIfxfKEWhagZQ%2BtQR0%2BTmU5As%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79f2dc53ea3c452b929c2144f39d8e8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=BKtHXIqVk2Ym7f95eDx0s3TAuZI%3D" alt="image.png" loading="lazy"/></p>
<p>为何需要打包</p>
<p>当使用<code>pnpm start</code>命令运行项目后出现非模块的问题，如果出现 <code>Error: Cannot find module '../dist/config'</code>如下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/155a5e373fad4c04a5fb8126a954e519~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=OOCL4zF%2BviGRfvptS8VVVR8Cr8I%3D" alt="image.png" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/092e8499953746a69ce182b922e5f1d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=OBH2ljY2NTk6%2Fa1YrMOucDwmkLQ%3D" alt="75ca7dbad29450afa0a185b57735e73f.png" loading="lazy"/>
是因为缺失打包文件（很无语的），<code>必须打包成功后才可成功pnpm start运行项目</code>
可以先进行打包产生build相关文件，再运行pnpm start</p>
<p><code>必须打包成功后才可成功pnpm start运行项目</code></p>
<p>如果遇到如下打包问题，
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e07dc958bf4418ab58dc8bd155281e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=Uy0aRuIAb5dOkKJB%2BTZj2c4SPqQ%3D" alt="image.png" loading="lazy"/></p>
<p>报错 <code>@n8n/imap#build</code>问题，请重新安装依赖，我试过很多次，重复操作都遇到这个问题，而后我重新重启，解压下载的n8n项目包重新下载依赖，删除依赖node_moudles包</p>
<h2 data-id="heading-10">4. 运行项目</h2>
<p><code>必须打包成功后有/dist/config目录文件才可成功pnpm start运行项目</code></p>
<pre><code class="hljs language-js" lang="js">pnpm start
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/344dc4f757a340488e5b980c876f9a5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=ViHNZeV9BRwqXYGa0N%2BawcDeUoA%3D" alt="image.png" loading="lazy"/></p>
<p>打开运行端口就可以看到页面
<code>（首次进入页面需要进行登录注册）</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfb12dc4913245c29a6ff469a49b28a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=VA%2BgSDScQ5hPR5g5VtWy83x3RLY%3D" alt="image.png" loading="lazy"/></p>
<p>如果运行项目出现如下问题<code>EntityMetadataNotFoundError: No metadata for "InstalledPackages" was found.</code>，请检查全局安装包或者n8n的默认端口占用情况，我之前全局安装过n8n，然后我删除之后，重新运行pnpm start命令就可以正常启动</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/897b6689071f4f138be184bda559a41f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=%2FWdYj6DKe7cB45NJeurEbaIdV%2FA%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af488980a1744e5f8a7247a16561d2a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=RSeanGEkj1DHYdyAhDQF8ySmVRk%3D" alt="image.png" loading="lazy"/></p>
<p>如果出现 <code>Error: Cannot find module '../dist/config'</code>如下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/155a5e373fad4c04a5fb8126a954e519~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=OOCL4zF%2BviGRfvptS8VVVR8Cr8I%3D" alt="image.png" loading="lazy"/>
请先进行 pnpm build打包成功生成dist文件夹后再进行pnpm start启动项目，
<code>必须打包成功后有/dist/config目录文件才可成功pnpm start运行项目</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14b629cd977842a19450ed4bc661e475~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=HTqIfxfKEWhagZQ%2BtQR0%2BTmU5As%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79f2dc53ea3c452b929c2144f39d8e8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=BKtHXIqVk2Ym7f95eDx0s3TAuZI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">5.流程复盘</h2>
<ul>
<li>1.<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fn8n-io%2Fn8n" target="_blank" title="https://github.com/n8n-io/n8n" ref="nofollow noopener noreferrer"><strong>在github上下载n8n项目</strong></a></li>
<li>2.<strong>切换或下载 <code>"node"</code>: "&gt;=22.16", <code>"pnpm"</code>: "&gt;=10.22.0"</strong></li>
<li>3.<strong>pnpm install安装依赖</strong>，（出错后清除pnpm缓存删除node_moudles依赖包后重试）</li>
<li>4.<strong>pnpm build 打包项目</strong>（打包出错大部分是依赖安装问题请重复执行步骤3）
<ul>
<li><code>必须打包成功后才可成功pnpm start运行项目</code></li>
</ul>
</li>
<li>5.<strong>pnpm start运行项目</strong>
<ul>
<li>出错请检查打包后是否有packages\cli\dist\config是否存在，5678端口是否被占用，全局安装的n8n依赖包是否正在启动（我是直接删除了npm全局安装路径的n8n，非当前项目依赖）</li>
</ul>
</li>
</ul>
<h2 data-id="heading-12">作者已退坑，私信评论不及时，请谅解</h2>
<p>个人认为docker部署会更简单，当然，如果你想就是单纯研究n8n源码，那么本篇文章出现的问题可以作为参考，如果你是想把n8n集成到项目中，最好的情况就是vue3作为壳引入n8n，建议是：
vue3+n8n+axios（请求）+CORS（跨域）+Pinia或Vuex（数据存储或共享）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[去噪扩散模型，根本不去噪？何恺明新论文回归「去噪」本质]]></title>    <link>https://juejin.cn/post/7574568258788573235</link>    <guid>https://juejin.cn/post/7574568258788573235</guid>    <pubDate>2025-11-20T01:49:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574568258788573235" data-draft-id="7574318108719693870" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="去噪扩散模型，根本不去噪？何恺明新论文回归「去噪」本质"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-11-20T01:49:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            去噪扩散模型，根本不去噪？何恺明新论文回归「去噪」本质
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T01:49:27.000Z" title="Thu Nov 20 2025 01:49:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>导读</p>
<p>高质量的图像生成如今几乎都由扩散模型实现。从艺术创作到商业设计，从人脸生成到自然场景合成，基于扩散的生成模型已经成为多模态领域的重要基石。</p>
<p>但有没有一种可能，<strong>「去噪扩散模型」实际上并没有做到「去噪」？</strong></p>
<p>ResNet 之父、超70万引用的 AI 大神何恺明的新论文《Back to Basics: Let Denoising Generative Models Denoise》敏锐地捕捉了这一现象，并带领扩散模型回归其最初的本源。&gt;&gt;<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkzOTg3NTAyNA%3D%3D%26mid%3D2247488797%26idx%3D2%26sn%3D27701bde826862b6a70302fd32f752c0%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkzOTg3NTAyNA==&amp;mid=2247488797&amp;idx=2&amp;sn=27701bde826862b6a70302fd32f752c0&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">更多资讯可加入CV技术群获取了解哦</a></p>
<p>在如今的大模型时代，扩散模型（Diffusion Models）几乎统治了图像生成领域：从 Stable Diffusion、Flux 到各种 rectified flow，大多数方法都遵循一个“默认套路”——让神经网络预测 噪声（ε） 或 混合了噪声的数据（v）。</p>
<p>但 MIT 与何恺明（Kaiming He）给这一逻辑来了一个漂亮的反向质疑：</p>
<p>既然叫做“去噪模型”，为什么不真正让模型去预测“干净的图像”？</p>
<p>他们提出的答案就是——预测干净图像 x，才是扩散模型在高维空间中更自然、更有效的方式。</p>
<p>并由此带来了一个极简、却强大的新框架：</p>
<blockquote>
<p>JiT：Just image Transformers</p>
<p>不预训练、不对齐、不用 VAE、不用额外损失，只靠一个纯粹的 Vision Transformer 在像素层面做扩散。</p>
</blockquote>
<h2 data-id="heading-0"><strong>什么扩散模型这些年偏离了“去噪”？</strong></h2>
<p>传统扩散理论的核心思想很简单：</p>
<p>给图像加噪声，再学着把噪声去掉。</p>
<p>但在实践中，人们发现“预测噪声 ε”比预测干净图像 x 更容易，效果更强。</p>
<p>于是整个行业默认采用：</p>
<ul>
<li><strong>ε-prediction</strong></li>
<li><strong>v-prediction（流速度）</strong></li>
</ul>
<p>然而，这里隐藏着一个被忽视的问题——<strong>噪声不是“数据”。噪声是高维的、无结构的。</strong></p>
<p>论文从“流形假设（Manifold Assumption）”出发提出：</p>
<ul>
<li>真正的自然图像 位于一个低维流形上</li>
<li>但噪声 ε、速度 v 在整个高维空间中均匀分布</li>
</ul>
<p>也就是说：</p>
<p>预测一个“结构化”的干净图像很容易</p>
<p>预测一个“高维噪声”非常难</p>
<p>尤其在像素级扩散模型中，这个问题变得格外明显，例如：</p>
<ul>
<li>512×512 图像，一个 patch 就是 32×32×3 = 3072 维</li>
<li>ViT 的 hidden size 往往才 768、1024、1280…</li>
</ul>
<p>这意味着：</p>
<p><strong>网络根本没有能力同时编码如此高维的噪声信息。</strong></p>
<p>这就导致了：ε/v-prediction 在高维像素扩散中完全崩溃</p>
<p>而 MIT 和何恺明的实验验证了：<strong>只有 x-prediction（预测干净图像）能在高维条件下稳定工作。</strong></p>
<h2 data-id="heading-1"><strong>让模型直接预测干净图像（x-prediction）</strong></h2>
<p>研究最大的贡献是 非常“朴素”但非常革命性的一点：</p>
<p><strong>扩散模型本来应该做“去噪”，所以让它预测干净图像 x 才是自然的。</strong></p>
<p>何恺明团队指出，预测干净数据与预测带噪量在本质上是不同的。这一洞见基于机器学习中的流形假设（Manifold Assumption）。</p>
<p>流形假设认为，自然图像在高维像素空间中位于一个低维流形上。干净图像 𝒙 可以建模为处于流形上（on-manifold），而噪声 ϵ 或流速度 𝒗（例如 𝒗 = 𝒙 − ϵ）则本质上处于流形之外（off-manifold）。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad7c571afb2546f0a09eaa3ddd96948b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208167&amp;x-signature=2tQ%2F0Ah%2FXc6esskZZmLkpHJNaU8%3D" alt="screenshot_2025-11-19_13-35-17.png" loading="lazy"/></p>
<p>该图直观展示了干净图像位于低维流形上，而噪声和流速处于流形之外的本质差异</p>
<p>因此，让神经网络预测干净图像（即 𝒙-prediction）在本质上不同于让其预测噪声或带噪的量（即 ϵ/𝒗-prediction）。</p>
<p>这一差异在高维空间中尤为关键。当需要预测高维的噪声或带噪量时，网络需要足够的容量来保留所有相关信息；而预测干净图像时，即使容量有限的网络也能有效工作，因为它只需要保留低维流形上的信息。</p>
<p>他们的核心观点：</p>
<p> x 位于低维流形，Transformer 不需要建模高维噪声，只需要保留“图像结构”。</p>
<p> ε / v 是高维无结构分布，噪声包含 100% 的高维信息，网络必须“记住全部细节”，难度指数增长。</p>
<p>他们用一个很有说服力的玩具实验：</p>
<p>2 维真实数据被投影到 512 维空间，使用同一个小网络生成数据</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb377f42d51c42cba0eeadf3796c594f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208167&amp;x-signature=P8WSukSIHGsr%2FhaAkwB4Xx25CL8%3D" alt="screenshot_2025-11-19_13-48-39.png" loading="lazy"/></p>
<p>结果发现：</p>
<p><strong>x-prediction 在高维空间依然能恢复数据结构， ε 和 v-prediction 完全崩溃，这个现象和 ImageNet 像素扩散中的结果高度一致。</strong></p>
<h2 data-id="heading-2"><strong>JiT：纯粹、极简，却非常强大的像素级扩散模型</strong></h2>
<p>基于 x-prediction，作者提出了 <strong>JiT（Just image Transformers）</strong> ：</p>
<p>JiT 使用普通的 Vision Transformer，直接在高维像素块上进行 𝒙-prediction，无需任何预训练、额外的损失函数或复杂的架构设计。这种方法在 ImageNet 256×256 和 512×512 分辨率上取得了有竞争力的结果，而在相同设置下，传统的 ϵ-prediction 和 𝒗-prediction 则会灾难性地失败。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a0e4795f10a428a8bf7e2407fe44221~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208167&amp;x-signature=9ha6G5nWs9CCuR3dVZ%2FSbDy%2Fdv0%3D" alt="screenshot_2025-11-19_13-42-56.png" loading="lazy"/></p>
<p>简洁的ViT架构直接在像素块上进行𝒙-prediction，无需复杂设计</p>
<p>令人惊讶的是，研究还发现，在嵌入层引入瓶颈设计（降低维度）甚至能提高生成质量，这与经典流形学习的观察一致。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/405308a65f4842659badbe47cb5dd53d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208167&amp;x-signature=SCPCTa5dI6ZV%2BqSdGZ1DOIV9Qdg%3D" alt="screenshot_2025-11-19_13-43-52.png" loading="lazy"/></p>
<p>即使将768维的patch压缩到16维的小瓶颈，模型仍能有效工作，且适度瓶颈反而提升性能</p>
<h2 data-id="heading-3"><strong>实验验证：𝒙-prediction 的显著优势</strong></h2>
<p>为了验证这一理论，研究团队进行了系统的实验对比：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb332fb2b89c4c508429ee50b5eb04af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208167&amp;x-signature=tNmd11JqMXOHIM%2BGcgeUUQjUktU%3D" alt="screenshot_2025-11-19_13-46-20.png" loading="lazy"/></p>
<p>在ImageNet 256×256数据集上，只有𝒙-prediction能够取得合理结果，而ϵ-prediction和𝒗-prediction都灾难性失败</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b55af76f6eb48a09fa282a704e0190e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208167&amp;x-signature=fpUhqzOi8yys6%2FhNvHMsNGcjG%2Bk%3D" alt="screenshot_2025-11-19_13-47-15.png" loading="lazy"/></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0971e4a929ff4b6189f3cd779eb5e5f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208167&amp;x-signature=GU4ck4XfaFQttq8wOkF0KXfX8Js%3D" alt="screenshot_2025-11-19_13-47-22.png" loading="lazy"/></p>
<p>JiT在不同分辨率下都保持良好性能，显示其强大的扩展能力和计算效率</p>
<h2 data-id="heading-4"><strong>对AI开发平台的启示</strong></h2>
<p>这一研究使去噪扩散模型回归本源，探索一种在原始自然数据上构建基于 Transformer 的扩散模型的自洽范式。它不仅对计算机视觉领域有重要意义，也为其他涉及原始高维自然数据的领域（如蛋白质、分子或气象数据）提供了启示。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/911b45d10beb4b228fe652087ffacb0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208167&amp;x-signature=Qwn24aMRUbXh6npS3SMClTTbw6A%3D" alt="Coovally操作动图.gif" loading="lazy"/></p>
<p><strong>！！点击下方链接，立即体验Coovally！！</strong></p>
<p><strong>平台链接：</strong> <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.coovally.com" target="_blank" title="https://www.coovally.com" ref="nofollow noopener noreferrer">www.coovally.com</a></strong></p>
<p>在Coovally这样的AI开发平台中，这种简洁而强大的方法尤为值得关注。 Coovally致力于简化AI开发流程，让开发者能够更高效地构建和部署模型。何恺明团队的研究方向与这一理念不谋而合——通过减少领域特定的设计，使「Diffusion + Transformer」的通用范式能够在更广泛的领域中应用。</p>
<h2 data-id="heading-5"><strong>总结</strong></h2>
<p>何恺明团队的这项工作提醒我们，有时最有效的解决方案往往是最直接的。在追求复杂架构和额外组件的同时，不妨回归基础，重新思考问题的本质。</p>
<p>「噪声与自然数据本质不同」，神经网络的能力不是无限的，它们应该更好地利用自身的容量来建模数据而非噪声。在这一视角下，𝒙-prediction 的优越性在 hindsight 看来是自然而然的结果。</p>
<p>随着越来越多像Coovally这样的平台将这类先进技术封装成易用的工具，我们可以期待，高质量的图像生成技术将被更广泛地应用，赋能更多领域的创新和发展。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文解读深浅拷贝的理解和几种使用方法]]></title>    <link>https://juejin.cn/post/7574245125029036051</link>    <guid>https://juejin.cn/post/7574245125029036051</guid>    <pubDate>2025-11-19T12:39:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574245125029036051" data-draft-id="7574230586971291654" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文解读深浅拷贝的理解和几种使用方法"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-19T12:39:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeeAt"/> <meta itemprop="url" content="https://juejin.cn/user/1889440069849484"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文解读深浅拷贝的理解和几种使用方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1889440069849484/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeeAt
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T12:39:02.000Z" title="Wed Nov 19 2025 12:39:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>深拷贝和浅拷贝是面试中经常被问到了，理解其原理和深浅拷贝差异以及多种深浅拷贝方法才能熟练在实际项目中使用做到游刃有余。本文将从作用原理到具体代码实现和多种使用方法进行展开解读。</p>
<h2 data-id="heading-0">深浅拷贝的理解</h2>
<h3 data-id="heading-1">浅拷贝</h3>
<p><strong>浅拷贝</strong>从字面意义上就是浅层的拷贝对象，不涉及到深层次的拷贝，也就是说只复制对象表层数据，只是为原来的对象创建新的内存，但是嵌套的引用类型（如：数组、子对象）仍然需要与原对象共享内存，修改副本的嵌套字段会同步影响原对象，进而产生污染。</p>
<p>其核心就是，由于JS的数据类型的存储机制，<code>基本类型</code>（字符串、数字等）直接存在<strong>栈</strong>内存中,<code>复杂类型</code>（对象、数组等）<strong>在栈中只存堆内存的地址引用，而堆内存才存实际的数据</strong>。浅拷贝时，只是复制栈内存而不对堆内存进行复制。
如图：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24232a68d5eb4e3cb90e0b3a77467118~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVlQXQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764160742&amp;x-signature=%2BEu1l9Hkr%2B3i7pBF87RJIOP6%2Bns%3D" alt="image.png" width="50%" loading="lazy"/></p>
<p>极简代码理解就是：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 原始对象</span>
<span class="hljs-keyword">const</span> userInfo = { 
    <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>, <span class="hljs-comment">// 基本类型（直接存在栈内存里） </span>
    <span class="hljs-attr">address</span>: { <span class="hljs-attr">city</span>: <span class="hljs-string">"北京"</span> } <span class="hljs-comment">// 复杂数据类型（地址引用在栈，实际数据在堆） </span>
    };
<span class="hljs-comment">// 浅拷贝：创建新对象</span>
<span class="hljs-keyword">const</span> formData = { ...userInfo }; 
<span class="hljs-comment">// 1. 对比新对象本身的地址</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(userInfo === formData); <span class="hljs-comment">// false，说明地址不同，是新的内存</span>
<span class="hljs-comment">// 2. 对比嵌套address的地址</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(userInfo.<span class="hljs-property">address</span> === formData.<span class="hljs-property">address</span>); <span class="hljs-comment">// true，相同，说明内存共享，指向的是同一个地址</span>
<span class="hljs-comment">// 3. 修改嵌套字段，验证污染 </span>
formData.<span class="hljs-property">address</span>.<span class="hljs-property">city</span> = <span class="hljs-string">"上海"</span>; 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(userInfo.<span class="hljs-property">address</span>.<span class="hljs-property">city</span>); <span class="hljs-comment">// 输出"上海"，说明原对象被污染了</span>
</code></pre>
<h3 data-id="heading-2">深拷贝</h3>
<p>理解了浅拷贝，深拷贝就是<strong>完全复制原始对象及所有的嵌套数据</strong>，会为原对象和所有嵌套的引用类型（如数组、子对象）创建独立的内存空间，副本与原对象彻底隔离，<strong>修改副本不会影响到原对象</strong>。</p>
<h2 data-id="heading-3">深浅拷贝的方法</h2>
<h3 data-id="heading-4">浅拷贝的5种常用方法</h3>
<p><strong>1. 对象展开运算符<code>{...obj}</code></strong>，最简洁的实现方式，适用于普通对象</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> shallowCopy = { ...userInfo };
</code></pre>
<p><strong>2.数组展开运算符</strong>,数组专属浅拷贝</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> shallowCopy = { ...originArr };
</code></pre>
<p><strong><code>3.Object.assign(target,source)</code></strong>,可以合并多个对象，仅浅拷贝源对象表层</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> shallowCopy = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({},userInfo1,userInfo2,userInfo3,....);
</code></pre>
<p><strong>4.数组<code>slice()</code></strong>，数组截取（不传参时等价于浅拷贝）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> shallowCopy = originalArr.<span class="hljs-title function_">slice</span>();
</code></pre>
<p><strong>5.数组<code>concat()</code></strong>，拼接空数组实现浅拷贝</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> shallowArr = originalArr.<span class="hljs-title function_">concat</span>([]);
</code></pre>
<h3 data-id="heading-5">深拷贝的4种常用方法</h3>
<p><strong>1.JSON.parse(JSON.stringify(obj))</strong>,最常用（局限性：不支持函数、Symbol、Date、RegExp）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> deepCopy = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(userInfo));
</code></pre>
<p><strong>2.递归遍历拷贝，</strong> 自定义实现（灵活处理所有类型，需手写逻辑），面试手写题常考</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">deepClone</span>(<span class="hljs-params">obj</span>){
    <span class="hljs-comment">// 类型判断 </span>
    <span class="hljs-keyword">if</span>(obj isntanceof <span class="hljs-title class_">Date</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(obj);
    <span class="hljs-keyword">if</span>(obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">RegExp</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(obj);
    <span class="hljs-keyword">if</span>(obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(obj.<span class="hljs-property">message</span>);
    <span class="hljs-keyword">if</span>(obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>){
        <span class="hljs-keyword">return</span> obj.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,...args);
    };
    <span class="hljs-keyword">if</span>( obj === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> obj !== <span class="hljs-string">'object'</span>) <span class="hljs-keyword">return</span> obj;
    
    <span class="hljs-keyword">const</span> newObj = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(obj) ? [] : {};
    
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> obj){
        <span class="hljs-keyword">if</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">hasOwn</span>(obj,key)){
            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> obj[key] === <span class="hljs-string">"object"</span>){
                newObj[key] = <span class="hljs-title function_">deepClone</span>(obj[key]); <span class="hljs-comment">// 递归拷贝嵌套层</span>
            }
            <span class="hljs-keyword">else</span>{
                newObj[key] = obj[key]
            }
        }
         
    }
    <span class="hljs-keyword">return</span> newObj;
}
</code></pre>
<p><strong>3.第三方库，</strong> 稳定可靠（开发首选）</p>
<ul>
<li>Lodash中的 <code>_.cloneDeep(obj)</code>（支持所有类型，处理循环引用）</li>
<li>jQuery中的 <code>$.extend(true,{},obj)</code>（第一个参数为true表示深拷贝）</li>
</ul>
<p><strong>4.structuredClone()，</strong> 浏览器原生API，支持循环引用、Date/RegExp,但不支持函数</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gird快速入门（手把手敲demo）]]></title>    <link>https://juejin.cn/post/7574271557939167283</link>    <guid>https://juejin.cn/post/7574271557939167283</guid>    <pubDate>2025-11-19T13:02:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574271557939167283" data-draft-id="7574244766424154121" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gird快速入门（手把手敲demo）"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-11-19T13:02:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新晨437"/> <meta itemprop="url" content="https://juejin.cn/user/3957868231143133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gird快速入门（手把手敲demo）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3957868231143133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新晨437
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T13:02:44.000Z" title="Wed Nov 19 2025 13:02:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Gird 布局是 CSS 中目前最强大、最成熟的二维布局方案，它可以让您轻松创建复杂的网页结构。</p>
<p>这份快速入门指南将带您从零开始，快速掌握 Grid 的核心概念和用法。</p>
<h3 data-id="heading-0">1. 什么是 CSS Grid？</h3>
<p>CSS Grid Layout（网格布局）是一个二维的布局系统，意味着它可以同时处理<strong>行</strong>和<strong>列</strong>。这与 Flexbox（一维布局，主要处理行<em>或</em>列）形成鲜明对比。</p>
<p><strong>核心思想</strong>：将一个容器划分为一个个网格，你可以将子元素放置在这些网格的任意位置，甚至可以创建复杂的、不对称的布局。</p>
<hr/>
<h3 data-id="heading-1">2. 基本概念</h3>
<p>在开始之前，先了解两个核心概念：</p>
<ul>
<li><strong>Grid Container（网格容器）</strong>：应用了 <code>display: grid;</code> 的元素。它的所有<strong>直接子元素</strong>将成为 Grid Item。</li>
<li><strong>Grid Item（网格项目）</strong>：Grid Container 的<strong>直接子元素</strong>。</li>
</ul>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span> <span class="hljs-comment">&lt;!-- Grid Container --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-comment">&lt;!-- Grid Item --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-comment">&lt;!-- Grid Item --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-comment">&lt;!-- Grid Item --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">3. 快速启动：创建一个简单的网格</h3>
<p>让我们通过一个简单的例子，一步步创建一个 3x3 的网格。</p>
<h4 data-id="heading-3">步骤 1：定义网格容器</h4>
<p>首先，将一个元素的 <code>display</code> 属性设置为 <code>grid</code> 或 <code>inline-grid</code>。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: grid;
}
</code></pre>
<p>现在，<code>.container</code> 就成为了一个网格容器，它的直接子元素自动成为了网格项目。</p>
<h4 data-id="heading-4">步骤 2：划分行和列（定义网格轨道）</h4>
<p>这是 Grid 布局的核心。我们使用 <code>grid-template-columns</code> 和 <code>grid-template-rows</code> 属性来定义网格的结构。</p>
<ul>
<li><code>grid-template-columns</code>：定义每一列的宽度。</li>
<li><code>grid-template-rows</code>：定义每一行的高度。</li>
</ul>
<p>让我们定义一个 3 列（每列 100px）和 3 行（每行 100px）的网格：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">100px</span> <span class="hljs-number">100px</span> <span class="hljs-number">100px</span>; <span class="hljs-comment">/* 三列，每列100px */</span>
  <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-number">100px</span> <span class="hljs-number">100px</span> <span class="hljs-number">100px</span>;    <span class="hljs-comment">/* 三行，每行100px */</span>
}
</code></pre>
<p><strong>更现代的写法：使用 <code>repeat()</code> 函数</strong>
当列或行很多时，<code>repeat()</code> 函数非常有用。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">100px</span>); <span class="hljs-comment">/* 等同于 100px 100px 100px */</span>
  <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">100px</span>);
}
</code></pre>
<p><strong>灵活的写法：使用 <code>fr</code> 单位</strong>
<code>fr</code>（fraction）单位代表网格容器中的等分空间，它让布局变得非常灵活。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">1</span>fr <span class="hljs-number">2</span>fr <span class="hljs-number">1</span>fr; <span class="hljs-comment">/* 总宽度分为4份，第二列占2份，第一、三列各占1份 */</span>
  <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">100px</span>);
}
</code></pre>
<p><strong>混合使用：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">200px</span> <span class="hljs-number">1</span>fr <span class="hljs-number">20%</span>; <span class="hljs-comment">/* 第一列固定200px，第三列是容器的20%，中间列占据剩余空间 */</span>
}
</code></pre>
<h4 data-id="heading-5">步骤 3：网格间隙（Gap）</h4>
<p>使用 <code>gap</code> 属性可以设置网格项目之间的间距。它是 <code>row-gap</code> 和 <code>column-gap</code> 的简写。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">100px</span>);
  <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">100px</span>);
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>; <span class="hljs-comment">/* 行和列的间隙都是10px */</span>
  <span class="hljs-comment">/* 或者分开写： */</span>
  <span class="hljs-comment">/* row-gap: 15px; */</span>
  <span class="hljs-comment">/* column-gap: 10px; */</span>
}
</code></pre>
<p>到此为止，一个标准的 3x3 网格就创建好了！你的 HTML 和 CSS 看起来应该是这样的：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-class">.container</span> {
      <span class="hljs-attribute">display</span>: grid;
      <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">100px</span>);
      <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">100px</span>);
      <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f0f0f0</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
    }
    <span class="hljs-selector-class">.item</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#4CAF50</span>;
      <span class="hljs-attribute">color</span>: white;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">text-align</span>: center;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>4<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>6<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>7<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>9<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">4. 高级操作：放置网格项目</h3>
<p>默认情况下，项目会按顺序逐行逐列填充网格。但 Grid 的强大之处在于你可以精确控制每个项目的位置。</p>
<p>我们通过 <strong>网格线（Grid Lines）</strong> 来定位项目。网格线是划分网格的线，从 1 开始编号（也从 -1 开始倒序编号）。</p>
<p><img alt="CSS Grid Lines转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>
<p>使用以下属性来控制项目位置：</p>
<ul>
<li><code>grid-column-start</code></li>
<li><code>grid-column-end</code></li>
<li><code>grid-row-start</code></li>
<li><code>grid-row-end</code></li>
<li>简写：<code>grid-column</code> 和 <code>grid-row</code></li>
</ul>
<p><strong>示例：让第一个 item 横跨两列</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.item</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">1</span>) {
  <span class="hljs-attribute">grid-column-start</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">grid-column-end</span>: <span class="hljs-number">3</span>; <span class="hljs-comment">/* 从第1条纵线开始，到第3条纵线结束 */</span>
  <span class="hljs-comment">/* 简写： */</span>
  <span class="hljs-comment">/* grid-column: 1 / 3; */</span>
}
</code></pre>
<p><strong>示例：创建一个页面的经典布局</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>Header<span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">aside</span>&gt;</span>Sidebar<span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>Main Content<span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>Footer<span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">200px</span> <span class="hljs-number">1</span>fr; <span class="hljs-comment">/* 侧边栏固定宽度，主内容区自适应 */</span>
  <span class="hljs-attribute">grid-template-rows</span>: auto <span class="hljs-number">1</span>fr auto; <span class="hljs-comment">/* 页头和页脚高度由内容决定，主内容区占据剩余空间 */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>; <span class="hljs-comment">/* 让容器充满整个视口高度 */</span>
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>;
}

<span class="hljs-selector-tag">header</span> {
  <span class="hljs-attribute">grid-column</span>: <span class="hljs-number">1</span> / -<span class="hljs-number">1</span>; <span class="hljs-comment">/* 从第1条纵线开始，到最后一条纵线结束（横跨所有列） */</span>
  <span class="hljs-attribute">background</span>: lightblue;
}

<span class="hljs-selector-tag">aside</span> {
  <span class="hljs-attribute">grid-column</span>: <span class="hljs-number">1</span> / <span class="hljs-number">2</span>; <span class="hljs-comment">/* 占据第一列 */</span>
  <span class="hljs-attribute">background</span>: lightcoral;
}

<span class="hljs-selector-tag">main</span> {
  <span class="hljs-attribute">grid-column</span>: <span class="hljs-number">2</span> / <span class="hljs-number">3</span>; <span class="hljs-comment">/* 占据第二列 */</span>
  <span class="hljs-attribute">background</span>: lightgreen;
}

<span class="hljs-selector-tag">footer</span> {
  <span class="hljs-attribute">grid-column</span>: <span class="hljs-number">1</span> / -<span class="hljs-number">1</span>; <span class="hljs-comment">/* 横跨所有列 */</span>
  <span class="hljs-attribute">background</span>: lightgray;
}
</code></pre>
<hr/>
<h3 data-id="heading-7">5. 快速总结与最佳实践</h3>
<ol>
<li><strong>启动</strong>：<code>display: grid;</code></li>
<li><strong>定义结构</strong>：
<ul>
<li><code>grid-template-columns</code>: 定义列。</li>
<li><code>grid-template-rows</code>: 定义行。</li>
<li>善用 <code>repeat()</code> 和 <code>fr</code> 单位。</li>
</ul>
</li>
<li><strong>设置间距</strong>：<code>gap</code>。</li>
<li><strong>精细控制项目</strong>：使用 <code>grid-column</code> 和 <code>grid-row</code> 基于<strong>网格线</strong>进行定位。</li>
<li><strong>命名网格线</strong>：对于复杂布局，可以给网格线起名字，让代码更易读。
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">grid-template-columns</span>: [sidebar-start] <span class="hljs-number">200px</span> [sidebar-end content-start] <span class="hljs-number">1</span>fr [content-end];
}
<span class="hljs-selector-tag">header</span> {
  <span class="hljs-attribute">grid-column</span>: sidebar-start / content-end;
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-8">练习建议</h3>
<p>打开浏览器的开发者工具，在 <code>Elements</code> 或 <code>Inspector</code> 面板中，找到你的网格容器，旁边会有一个 <code>grid</code> 的标签，点击它可以在页面上可视化你的网格结构。这是学习和调试 Grid 的绝佳方式！</p>
<p>Grid 布局功能非常丰富，还包括<strong>网格区域（grid-template-areas）</strong>、对齐属性（<code>justify-items</code>, <code>align-content</code>等），但掌握了以上核心内容，你已经可以应对 90% 的布局需求了。快去动手试试吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 响应式系统源码解析：Map/Set Collection 响应式核心实现]]></title>    <link>https://juejin.cn/post/7574338918489784346</link>    <guid>https://juejin.cn/post/7574338918489784346</guid>    <pubDate>2025-11-20T01:52:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574338918489784346" data-draft-id="7574568258788606003" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 响应式系统源码解析：Map/Set Collection 响应式核心实现"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-20T01:52:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="excel"/> <meta itemprop="url" content="https://juejin.cn/user/2911162520062862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 响应式系统源码解析：Map/Set Collection 响应式核心实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2911162520062862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    excel
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T01:52:53.000Z" title="Thu Nov 20 2025 01:52:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文解析 Vue3 <code>reactivity</code> 模块中 Collection(Map/Set/WeakMap/WeakSet) 的响应式处理逻辑，重点在设计思路与源码结构，而不是 API 使用。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">1. 背景：为什么 Map/Set 要单独写代码？</h2>
<p>Vue 对普通对象 <code>{}</code> 的响应式靠 <code>get/set</code> 即可，但对 Map/Set：</p>
<ul>
<li><strong>方法是函数</strong>（如 <code>.set()</code>、<code>.get()</code>）</li>
<li><strong>键可能是对象</strong></li>
<li><strong>有迭代器</strong>（<code>keys</code>、<code>values</code>、<code>entries</code>、<code>for…of</code>）</li>
<li><strong>弱集合 WeakMap/WeakSet 无法遍历</strong></li>
</ul>
<p>因此，Vue 必须提供一套专门的“仪表方法”（instrumentations）来接管所有操作。</p>
<p>这一段源码就是专门为此而设计的。</p>
<hr/>
<h2 data-id="heading-1">2. createIterableMethod —— 迭代器逻辑封装</h2>
<h4 data-id="heading-2">代码片段</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createIterableMethod</span>(<span class="hljs-params">method, isReadonly, isShallow</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> target = <span class="hljs-variable language_">this</span>[<span class="hljs-title class_">ReactiveFlags</span>.<span class="hljs-property">RAW</span>]
    <span class="hljs-keyword">const</span> rawTarget = <span class="hljs-title function_">toRaw</span>(target)
    <span class="hljs-keyword">const</span> targetIsMap = <span class="hljs-title function_">isMap</span>(rawTarget)
    <span class="hljs-keyword">const</span> isPair = method === <span class="hljs-string">'entries'</span> || (method === <span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span> &amp;&amp; targetIsMap)
    <span class="hljs-keyword">const</span> isKeyOnly = method === <span class="hljs-string">'keys'</span> &amp;&amp; targetIsMap

    <span class="hljs-keyword">const</span> innerIterator = target[method](...args)
    <span class="hljs-keyword">const</span> wrap = isShallow ? toShallow : isReadonly ? toReadonly : toReactive

    !isReadonly &amp;&amp; <span class="hljs-title function_">track</span>(
      rawTarget,
      <span class="hljs-title class_">TrackOpTypes</span>.<span class="hljs-property">ITERATE</span>,
      isKeyOnly ? <span class="hljs-variable constant_">MAP_KEY_ITERATE_KEY</span> : <span class="hljs-variable constant_">ITERATE_KEY</span>,
    )

    <span class="hljs-keyword">return</span> {
      <span class="hljs-title function_">next</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> { value, done } = innerIterator.<span class="hljs-title function_">next</span>()
        <span class="hljs-keyword">return</span> done
          ? { value, done }
          : { <span class="hljs-attr">value</span>: isPair ? [<span class="hljs-title function_">wrap</span>(value[<span class="hljs-number">0</span>]), <span class="hljs-title function_">wrap</span>(value[<span class="hljs-number">1</span>])] : <span class="hljs-title function_">wrap</span>(value), done }
      },
      [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]() {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>
      },
    }
  }
}
</code></pre>
<hr/>
<h4 data-id="heading-3">逐段解释：</h4>
<h5 data-id="heading-4"><strong>① 获取原始对象</strong></h5>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">target</span> = this[ReactiveFlags.RAW]
const <span class="hljs-attr">rawTarget</span> = toRaw(target)
</code></pre>
<p>Map 可能是嵌套 reactive 包装，这里确保拿到真正的原对象。</p>
<h5 data-id="heading-5"><strong>② 判断返回值是 key/value/key+value</strong></h5>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">isPair</span> = method === <span class="hljs-string">'entries'</span> ...
const <span class="hljs-attr">isKeyOnly</span> = method === <span class="hljs-string">'keys'</span>
</code></pre>
<h5 data-id="heading-6"><strong>③ 执行原生迭代器</strong></h5>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">innerIterator</span> = target[method](...args)
</code></pre>
<h5 data-id="heading-7"><strong>④ 依赖收集</strong></h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">track</span>(rawTarget, TrackOpTypes.ITERATE, ITERATE_KEY)
</code></pre>
<p><strong>关键点</strong>：只要调用 keys、values、entries、for-of，都要追踪依赖。</p>
<p>这样当集合结构变化时才能触发更新。</p>
<h5 data-id="heading-8"><strong>⑤ 迭代器包装：将每个值转成 reactive</strong></h5>
<pre><code class="hljs language-css" lang="css">value: <span class="hljs-built_in">wrap</span>(...)
</code></pre>
<p>Map 中存的值可能是对象，Vue 自动转换成 reactive 或 readonly。</p>
<p>这一部分是最核心的“响应式迭代器”实现。</p>
<hr/>
<h2 data-id="heading-9">3. createReadonlyMethod —— 用于 readonly 集合</h2>
<h4 data-id="heading-10">代码片段</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createReadonlyMethod</span>(<span class="hljs-params"><span class="hljs-keyword">type</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-title function_">warn</span>(<span class="hljs-string">`<span class="hljs-subst">${capitalize(<span class="hljs-keyword">type</span>)}</span> operation failed: target is readonly.`</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">type</span> === <span class="hljs-title class_">TriggerOpTypes</span>.<span class="hljs-property">DELETE</span>
      ? <span class="hljs-literal">false</span>
      : <span class="hljs-keyword">type</span> === <span class="hljs-title class_">TriggerOpTypes</span>.<span class="hljs-property">CLEAR</span> ? <span class="hljs-literal">undefined</span> : <span class="hljs-variable language_">this</span>
  }
}
</code></pre>
<h4 data-id="heading-11">思路：</h4>
<ul>
<li>任何修改（set/add/delete/clear）都会提示错误</li>
<li>并返回合理的 fallback 值</li>
</ul>
<p>举例：</p>
<ul>
<li><code>delete()</code> → <code>false</code></li>
<li><code>clear()</code> → <code>undefined</code></li>
<li><code>set/add</code> → 返回 this（保持链式调用）</li>
</ul>
<hr/>
<h2 data-id="heading-12">4. createInstrumentations —— 生成 Map/Set 全量代理方法</h2>
<p>它会根据参数 <code>readonly</code> 和 <code>shallow</code> 返回不同版本的方法表。</p>
<hr/>
<h3 data-id="heading-13">（1）get(key)</h3>
<h4 data-id="heading-14">代码片段</h4>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">get</span>(<span class="hljs-keyword">key</span>) {
  <span class="hljs-keyword">const</span> target = this[ReactiveFlags.RAW]
  <span class="hljs-keyword">const</span> rawTarget = toRaw(target)
  <span class="hljs-keyword">const</span> rawKey = toRaw(<span class="hljs-keyword">key</span>)

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">readonly</span>) {
    <span class="hljs-keyword">if</span> (hasChanged(<span class="hljs-keyword">key</span>, rawKey)) track(rawTarget, TrackOpTypes.<span class="hljs-keyword">GET</span>, <span class="hljs-keyword">key</span>)
    track(rawTarget, TrackOpTypes.<span class="hljs-keyword">GET</span>, rawKey)
  }

  <span class="hljs-keyword">const</span> { has } = getProto(rawTarget)

  <span class="hljs-keyword">const</span> wrap = shallow ? toShallow : <span class="hljs-keyword">readonly</span> ? toReadonly : toReactive

  <span class="hljs-keyword">if</span> (has.<span class="hljs-keyword">call</span>(rawTarget, <span class="hljs-keyword">key</span>)) {
    <span class="hljs-keyword">return</span> wrap(target.<span class="hljs-keyword">get</span>(<span class="hljs-keyword">key</span>))
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (has.<span class="hljs-keyword">call</span>(rawTarget, rawKey)) {
    <span class="hljs-keyword">return</span> wrap(target.<span class="hljs-keyword">get</span>(rawKey))
  }
}
</code></pre>
<h4 data-id="heading-15">关键细节：</h4>
<h5 data-id="heading-16"><strong>① key 和 rawKey 都要 track</strong></h5>
<p>原因：用户可能用 reactive(obj) 或 raw obj 作为 map key。</p>
<h5 data-id="heading-17"><strong>② 始终 wrap 返回值</strong></h5>
<p>所有 get 到的 value 必须返回 reactive/readonly 版本。</p>
<hr/>
<h3 data-id="heading-18">（2）size 属性</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">get</span> <span class="hljs-title">size</span>()</span> {
  <span class="hljs-keyword">const</span> target = <span class="hljs-keyword">this</span>[ReactiveFlags.RAW]
  !<span class="hljs-keyword">readonly</span> &amp;&amp; track(toRaw(target), TrackOpTypes.ITERATE, ITERATE_KEY)
  <span class="hljs-keyword">return</span> target.size
}
</code></pre>
<p><strong>size 依赖整个集合结构</strong>，所以也要使用 ITERATE 依赖类型。</p>
<hr/>
<h3 data-id="heading-19">（3）has(key)</h3>
<p>逻辑和 get 类似，也要对 key 与 rawKey 都进行 track。</p>
<hr/>
<h3 data-id="heading-20">（4）forEach</h3>
<p>Vue 为回调参数做响应式包装：</p>
<pre><code class="hljs language-scss" lang="scss">callback<span class="hljs-selector-class">.call</span>(thisArg, wrap(value), <span class="hljs-built_in">wrap</span>(key), observed)
</code></pre>
<p>确保：</p>
<ul>
<li>value 是 reactive</li>
<li>key 是 reactive</li>
<li>this 是 reactive</li>
</ul>
<hr/>
<h2 data-id="heading-21">5. Mutation（增删改清）操作</h2>
<p>如果不是 readonly，则提供真正的 set/add/delete/clear。</p>
<hr/>
<h3 data-id="heading-22">（1）add (for Set)</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">add</span>(value) {
  value = <span class="hljs-built_in">toRaw</span>(value)
  const hadKey = target<span class="hljs-selector-class">.has</span>(value)
  if (!hadKey) {
    target<span class="hljs-selector-class">.add</span>(value)
    <span class="hljs-built_in">trigger</span>(target, TriggerOpTypes.ADD, value, value)
  }
  return this
}
</code></pre>
<hr/>
<h3 data-id="heading-23">（2）set (for Map)</h3>
<h4 data-id="heading-24">核心逻辑</h4>
<ul>
<li>把 value 转 raw</li>
<li>判断 key 是否存在</li>
<li>触发 ADD 或 SET</li>
</ul>
<hr/>
<h3 data-id="heading-25">（3）delete</h3>
<p>触发 DELETE 类型依赖，并将旧值传递给 watcher。</p>
<hr/>
<h3 data-id="heading-26">（4）clear</h3>
<p>触发 CLEAR，且如果是 Map 会克隆 oldTarget（仅 dev）。</p>
<hr/>
<h2 data-id="heading-27">6. iterator 方法统一挂载</h2>
<pre><code class="hljs language-sql" lang="sql">[<span class="hljs-string">'keys'</span>,<span class="hljs-string">'values'</span>,<span class="hljs-string">'entries'</span>,Symbol.iterator].forEach(<span class="hljs-keyword">method</span> <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> {
  instrumentations[<span class="hljs-keyword">method</span>] <span class="hljs-operator">=</span> createIterableMethod(<span class="hljs-keyword">method</span>, readonly, shallow)
})
</code></pre>
<p>这是响应式迭代器的核心。</p>
<hr/>
<h2 data-id="heading-28">7. createInstrumentationGetter —— Proxy.get 捕获器</h2>
<p>它定义了所有 Collection 的代理行为。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">get</span>(target, <span class="hljs-keyword">key</span>, receiver) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">key</span> === ReactiveFlags.IS_REACTIVE) <span class="hljs-keyword">return</span> !isReadonly
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">key</span> === ReactiveFlags.IS_READONLY) <span class="hljs-keyword">return</span> isReadonly
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">key</span> === ReactiveFlags.RAW) <span class="hljs-keyword">return</span> target

  <span class="hljs-keyword">return</span> Reflect.<span class="hljs-keyword">get</span>(
    hasOwn(instrumentations, <span class="hljs-keyword">key</span>) &amp;&amp; <span class="hljs-keyword">key</span> <span class="hljs-keyword">in</span> target
      ? instrumentations
      : target,
    <span class="hljs-keyword">key</span>,
    receiver,
  )
}
</code></pre>
<h4 data-id="heading-29">逻辑：</h4>
<ol>
<li>读标识位（isReactive/isReadonly/raw）</li>
<li>如果有对应的 instrumentations 方法，则从那里取</li>
<li>否则取集合原本的方法</li>
</ol>
<hr/>
<h2 data-id="heading-30">8. 最终导出的四种 handler</h2>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> <span class="hljs-type">const</span> mutableCollectionHandlers
<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> shallowCollectionHandlers
<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> readonlyCollectionHandlers
<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> shallowReadonlyCollectionHandlers
</code></pre>
<p>Vue 会根据：</p>
<ul>
<li>reactive()</li>
<li>shallowReactive()</li>
<li>readonly()</li>
<li>shallowReadonly()</li>
</ul>
<p>来使用不同的 handler。</p>
<hr/>
<h2 data-id="heading-31">总结</h2>
<p>这段源码是 Vue3 响应式系统中最复杂的一部分之一，核心设计理念包括：</p>
<ul>
<li><strong>以 instrumentations 表包装所有 Collection 方法</strong></li>
<li><strong>迭代器统一代理，确保 for-of / keys / values 都能被追踪</strong></li>
<li><strong>返回值自动 wrap 成 reactive 或 readonly</strong></li>
<li><strong>同时支持 raw key 与 reactive key 的一致性检查</strong></li>
<li><strong>对不同模式（shallow / readonly）进行统一抽象</strong></li>
</ul>
<p>它是 Vue 能优雅支持 Map/Set 响应式的关键。</p>
<hr/>
<p><strong>本文部分内容借助 AI 辅助生成，并由作者整理审核。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[飞书多维表格用户不要错过！重大福利🎁~]]></title>    <link>https://juejin.cn/post/7574529034647257140</link>    <guid>https://juejin.cn/post/7574529034647257140</guid>    <pubDate>2025-11-20T01:52:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574529034647257140" data-draft-id="7574327911659618304" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="飞书多维表格用户不要错过！重大福利🎁~"/> <meta itemprop="keywords" content="前端,程序员,产品"/> <meta itemprop="datePublished" content="2025-11-20T01:52:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱听书的程序员阿超"/> <meta itemprop="url" content="https://juejin.cn/user/3905881963247111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            飞书多维表格用户不要错过！重大福利🎁~
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3905881963247111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱听书的程序员阿超
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T01:52:45.000Z" title="Thu Nov 20 2025 01:52:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99b152fb4341494e8f4de14352f5c9f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCs5Lmm55qE56iL5bqP5ZGY6Zi_6LaF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208365&amp;x-signature=YVRMIGA6Eu9b22fbtkb0n%2Bp%2BMiE%3D" alt="image.png" loading="lazy"/>
阿超作为每天都在用飞书多维表格的重度用户，并且给多维表格开发了 20 多个好用的插件，也收到了很多的插件用户好评~</p>
<p>最近，阿超帮大家争取到了一些飞书多维表格VIP的福利🎉，真的很香~</p>
<p>新用户可以领3个月会员，原价买得花一百多，而且现在不用下软件，网页就能用，微信钉钉也能用，超级方便。</p>
<p>兑换码：New9L2m7F3z8K77</p>
<p>兑换链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffcna6swh3rtl.feishu.cn%2Fshare%2Fbase%2Fform%2Fshrcn8BkxqoKYeA6XyZZAB7zK73" target="_blank" title="https://fcna6swh3rtl.feishu.cn/share/base/form/shrcn8BkxqoKYeA6XyZZAB7zK73" ref="nofollow noopener noreferrer">fcna6swh3rtl.feishu.cn/share/base/…</a></p>
<p>尽快兑换，双十一活动很快就结束了，兑换完得等几天到账。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41c49254502548df9f27bc43cc0f072f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCs5Lmm55qE56iL5bqP5ZGY6Zi_6LaF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208365&amp;x-signature=M01VbNfAS75HMFxzxYQpGkRzN3A%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端开发者也能玩转大模型：使用HTTP请求调用DeepSeek全记录]]></title>    <link>https://juejin.cn/post/7574253222607568937</link>    <guid>https://juejin.cn/post/7574253222607568937</guid>    <pubDate>2025-11-19T15:27:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574253222607568937" data-draft-id="7574281453707591686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端开发者也能玩转大模型：使用HTTP请求调用DeepSeek全记录"/> <meta itemprop="keywords" content="前端,人工智能,DeepSeek"/> <meta itemprop="datePublished" content="2025-11-19T15:27:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ohyeah"/> <meta itemprop="url" content="https://juejin.cn/user/740446536480618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端开发者也能玩转大模型：使用HTTP请求调用DeepSeek全记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/740446536480618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ohyeah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T15:27:31.000Z" title="Wed Nov 19 2025 15:27:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>无需后端支持，纯前端技术栈也能集成人工智能大模型</p>
</blockquote>
<p>作为一名前端开发者，我最近探索了一个有趣的技术方案：如何在前端项目中直接调用大型语言模型。在这个过程中，我发现了不少值得分享的经验和技巧，今天就带大家一步步实现前端调用DeepSeek大模型的全过程。</p>
<h2 data-id="heading-0">项目背景与初衷</h2>
<p>传统上，调用AI大模型通常需要后端服务的支持，前端通过API与自己的服务器交互，再由服务器调用AI服务。这样做主要是出于安全考虑，特别是为了保护API密钥。但有时候，我们只是想快速原型验证，或者构建简单的个人项目，这时候如果能直接从前端调用大模型，会大大简化开发流程。</p>
<p>我决定尝试使用纯前端技术栈调用DeepSeek大模型，并记录下整个过程。</p>
<h2 data-id="heading-1">项目初始化：从零搭建</h2>
<p>为了简化开发流程，我使用了 Trae（一种 AI 辅助开发工具）帮我快速初始化了一个基于 Vite 的前端项目。V</p>
<h3 data-id="heading-2">选择构建工具</h3>
<p>我选择了Vite作为项目构建工具，它不仅速度快，而且内置了丰富的功能，特别是对环境变量的支持，这对保护API密钥至关重要。</p>
<pre><code class="hljs language-bash" lang="bash">npm create vite@latest frontend-llm-demo
<span class="hljs-built_in">cd</span> frontend-llm-demo
npm install
</code></pre>
<h3 data-id="heading-3">项目结构设计</h3>
<p>保持简洁的项目结构：</p>
<pre><code class="hljs language-lua" lang="lua">frontend-llm-demo/
├── index.html
├── styles/
│   └── style.css
├── scripts/
│   └── app.js
└── .env.<span class="hljs-keyword">local</span>
</code></pre>
<p>其中，<code>index.html</code> 是主页面，<code>app.js</code> 负责发起 API 请求，而 <code>.env.local</code> 将用于存放敏感的 API Key。</p>
<h2 data-id="heading-4">核心实现：HTTP请求调用LLM</h2>
<h3 data-id="heading-5">构建API请求</h3>
<p>在<code>app.js</code>中，我实现了完整的API调用逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// DeepSeek API端点</span>
<span class="hljs-keyword">const</span> endpoint = <span class="hljs-string">'https://api.deepseek.com/chat/completions'</span>

<span class="hljs-comment">// 设置请求头</span>
<span class="hljs-keyword">const</span> headers = {
  <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
  <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${<span class="hljs-keyword">import</span>.meta.env.VITE_DEEPSEEK_API_KEY}</span>`</span>
}

<span class="hljs-comment">// 构建请求体</span>
<span class="hljs-keyword">const</span> payload = {
  <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span>,
  <span class="hljs-attr">messages</span>: [
    {
      <span class="hljs-attr">role</span>: <span class="hljs-string">'system'</span>,
      <span class="hljs-attr">content</span>: <span class="hljs-string">'You are a helpful assistant.'</span>
    },
    {
      <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>,
      <span class="hljs-attr">content</span>: <span class="hljs-string">'你好 DeepSeek'</span>
    }
  ]
}

<span class="hljs-comment">// 发送请求并处理响应</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(endpoint, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
  <span class="hljs-attr">headers</span>: headers,
  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(payload)
})

<span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)

<span class="hljs-comment">// 将模型回复动态挂载到页面</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'reply'</span>).<span class="hljs-property">textContent</span> = data.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">content</span>
</code></pre>
<h3 data-id="heading-6">关键技术点解析</h3>
<h4 data-id="heading-7">1. 请求方法选择</h4>
<p>我使用了POST而非GET方法，原因有二：</p>
<ul>
<li>POST请求更安全，参数不会暴露在URL中</li>
<li>我们需要传递请求体，GET请求通常不包含请求体 而 LLM 调用需要传递复杂的 <code>messages</code> 结构，必须使用 POST</li>
</ul>
<h4 data-id="heading-8">2. 请求头设置</h4>
<p>请求头包含了两个关键信息：</p>
<ul>
<li><code>Content-Type: application/json</code> - 告诉服务器我们发送的是JSON格式数据</li>
<li><code>Authorization: Bearer ...</code> - 用于身份验证的API密钥</li>
</ul>
<h4 data-id="heading-9">3. 请求体构建</h4>
<p>请求体是一个JSON对象，包含：</p>
<ul>
<li><code>model</code> - 指定要使用的模型版本</li>
<li><code>messages</code> - 对话消息数组，包含角色和内容</li>
</ul>
<h4 data-id="heading-10">4. 数据序列化</h4>
<p>使用<code>JSON.stringify()</code>将JavaScript对象转换为JSON字符串，因为HTTP协议只能传输文本或二进制数据，不能直接传输对象。</p>
<h2 data-id="heading-11">安全考虑：保护API密钥</h2>
<h3 data-id="heading-12">环境变量的重要性</h3>
<p>直接将API密钥硬编码在前端代码中是极其危险的，任何用户都可以查看源代码获取密钥。为了解决这个问题，我使用了环境变量。</p>
<h3 data-id="heading-13">Vite环境变量配置</h3>
<p>Vite使用特殊的<code>import.meta.env</code>对象来访问环境变量。以<code>VITE_</code>开头的变量会被嵌入到客户端代码中。</p>
<ol>
<li>创建<code>.env</code>文件：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">VITE_DEEPSEEK_API_KEY</span>=your_api_key_here
</code></pre>
<ol start="2">
<li>在代码中访问：</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> apiKey = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_DEEPSEEK_API_KEY</span>
</code></pre>
<p><strong>注意</strong>：即使使用环境变量，前端代码中的API密钥仍然可能被有心人获取。对于生产环境，最佳实践仍然是使用后端服务作为代理。</p>
<h2 data-id="heading-14">异步处理：从Promise到async/await</h2>
<h3 data-id="heading-15">传统的Promise链式调用</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">fetch</span>(endpoint, options)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
    <span class="hljs-comment">// 处理数据</span>
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-comment">// 错误处理</span>
  })
</code></pre>
<h3 data-id="heading-16">现代的async/await</h3>
<p>我选择了async/await语法，因为它更简洁、更易读：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(endpoint, options)
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
  <span class="hljs-comment">// 处理数据</span>
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-comment">// 错误处理</span>
}
</code></pre>
<h2 data-id="heading-17">结果展示：动态更新DOM</h2>
<p>获取到API响应后，需要将结果显示在页面上：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'reply'</span>).<span class="hljs-property">textContent</span> = data.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">content</span>
</code></pre>
<p>这里使用了直接操作DOM的方式，在现代前端框架流行的今天，这种原生方法依然简单有效。</p>
<h2 data-id="heading-18">完整HTML结构</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"color-scheme"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"light dark"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>前端调用大模型示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"styles/style.css"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello DeepSeek<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"reply"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./scripts/app.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-19">开发心得与总结</h2>
<p>通过这个项目，我获得了以下几点经验：</p>
<h3 data-id="heading-20">1. 前端调用LLM的可行性</h3>
<p>事实证明，前端直接调用大模型API是完全可行的，这为快速原型开发和个人项目提供了便利。但需要注意安全性问题，不建议在生产环境中直接暴露API密钥。</p>
<h3 data-id="heading-21">2. HTTP请求的细节重要性</h3>
<p>调用外部API时，请求的每个部分都很重要：</p>
<ul>
<li>正确的端点URL</li>
<li>恰当的HTTP方法</li>
<li>必要的请求头</li>
<li>正确格式化的请求体</li>
</ul>
<h3 data-id="heading-22">3. 现代JavaScript特性的价值</h3>
<p>ES6+的特性让代码更加简洁：</p>
<ul>
<li>模板字符串</li>
<li>箭头函数</li>
<li>解构赋值</li>
<li>async/await</li>
</ul>
<h3 data-id="heading-23">4. 构建工具的重要性</h3>
<p>Vite等现代构建工具不仅提供开发服务器和打包功能，还解决了环境变量、模块化等工程化问题。</p>
<h3 data-id="heading-24">5. 安全意识的培养</h3>
<p>即使是在个人项目中，也应该养成良好的安全习惯，使用环境变量管理敏感信息。</p>
<h2 data-id="heading-25">结语</h2>
<p>前端技术日新月异，如今我们甚至可以直接在前端调用强大的人工智能模型。这个项目虽然简单，但展示了前端开发的强大能力和无限可能性。作为前端开发者，我们不应该将自己局限在传统的界面开发中，而应该积极探索前端技术的边界。</p>
<p>希望这篇文章能为想要在前端项目中集成AI能力的开发者提供一些参考和启发。前端的世界很精彩，让我们一起探索更多可能性！</p>
<hr/>
<p><em>注意：本文示例仅适用于开发和测试环境，生产环境中请务必通过后端服务调用第三方API，确保API密钥的安全性。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2.Kotlin 函数：函数进阶：可变参数 (vararg) 与局部函数]]></title>    <link>https://juejin.cn/post/7574276404595884084</link>    <guid>https://juejin.cn/post/7574276404595884084</guid>    <pubDate>2025-11-19T10:38:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574276404595884084" data-draft-id="7574250031248654370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2.Kotlin 函数：函数进阶：可变参数 (vararg) 与局部函数"/> <meta itemprop="keywords" content="Android,Kotlin,Android Jetpack"/> <meta itemprop="datePublished" content="2025-11-19T10:38:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android_小雨"/> <meta itemprop="url" content="https://juejin.cn/user/220360279590862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2.Kotlin 函数：函数进阶：可变参数 (vararg) 与局部函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/220360279590862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android_小雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T10:38:21.000Z" title="Wed Nov 19 2025 10:38:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>希望帮你在Kotlin进阶路上少走弯路，在技术上稳步提升。当然，由于个人知识储备有限，笔记中难免存在疏漏或表述不当的地方，也非常欢迎大家提出宝贵意见，一起交流进步。 —— Android_小雨</p>
</blockquote>
<p>整体目录：<a href="https://juejin.cn/spost/7573592952242602036" target="_blank" title="https://juejin.cn/spost/7573592952242602036">Kotlin 进阶不迷路：41 个核心知识点，构建完整知识体系</a></p>
<h2 data-id="heading-0">一、前言</h2>
<h3 data-id="heading-1">1.1 函数进阶的核心意义</h3>
<p>在 Kotlin 开发中，基础函数语法能满足简单场景的需求，但面对“需要处理不确定数量的参数”“函数内部有重复逻辑”等复杂场景时，就需要借助进阶函数特性来优化代码。函数进阶的核心价值在于<strong>提升代码的灵活性、复用性和可读性</strong>——既让函数能适配更多样的调用场景，又能通过合理封装减少冗余代码，让逻辑更清晰。</p>
<p>比如我们经常会遇到“计算多个数字的和”“批量打印数据”这类需求，若用基础函数只能一次次传递固定数量的参数；还有函数内部多次执行相同的校验逻辑，直接重复编写会让代码显得臃肿。而今天要讲的<strong>可变参数（vararg）<strong>和</strong>局部函数</strong>，正是解决这两类问题的“利器”。</p>
<h3 data-id="heading-2">1.2 本文核心内容预告（可变参数 + 局部函数）</h3>
<p>本文将聚焦 Kotlin 中两个高频进阶函数特性：可变参数（vararg）和局部函数。我们会从“是什么、怎么用、注意什么、在哪用”四个维度，逐步拆解每个特性的核心知识点，最后再通过结合示例展示它们的协同优势。无论你是刚接触 Kotlin 的新手，还是想优化现有代码的开发者，都能通过本文快速掌握这两个特性的实战技巧。</p>
<h2 data-id="heading-3">二、可变参数 (vararg) 详解</h2>
<h3 data-id="heading-4">2.1 什么是可变参数？（简单定义：接收任意数量同类型参数）</h3>
<p>可变参数（vararg，全称 variable number of arguments）是 Kotlin 提供的一种特殊参数类型，它允许函数<strong>接收任意数量的同类型参数</strong>。简单来说，就是调用函数时可以传递 1 个、2 个……甚至 0 个该类型的参数，函数内部会将这些参数封装成一个数组来处理。</p>
<p>比如定义一个“求和函数”，如果用基础函数只能固定参数数量（如 sum(a: Int, b: Int) 只能求两个数的和），而用可变参数就能实现“求任意个整数的和”，适配“求 2 个数、3 个数甚至 10 个数的和”等所有场景。</p>
<h3 data-id="heading-5">2.2 可变参数的基本用法（语法格式 + 基础示例）</h3>
<h4 data-id="heading-6">2.2.1 语法格式</h4>
<p>定义可变参数只需在参数类型前加上 <code>vararg</code> 关键字，格式如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> 函数名<span class="hljs-params">(<span class="hljs-keyword">vararg</span> 参数名: 参数类型)</span></span>: 返回类型 {
    <span class="hljs-comment">// 函数体中，参数名可直接当作数组使用（如参数名.size、参数名[0]）</span>
}

</code></pre>
<h4 data-id="heading-7">2.2.2 基础示例</h4>
<p>以“求任意个整数的和”为例，用可变参数实现如下，调用时可传递任意数量的整数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 可变参数基础示例：求任意个整数的和
 * <span class="hljs-doctag">@param</span> numbers 可变参数，接收任意数量的 Int 类型参数
 * <span class="hljs-doctag">@return</span> 所有参数的和
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sumNumbers</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> numbers: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">var</span> total = <span class="hljs-number">0</span>
    <span class="hljs-comment">// 可变参数在函数内部会被当作数组处理，可通过循环遍历</span>
    <span class="hljs-keyword">for</span> (num <span class="hljs-keyword">in</span> numbers) {
        total += num
    }
    <span class="hljs-keyword">return</span> total
}

<span class="hljs-comment">// 调用示例</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 传递 2 个参数</span>
    <span class="hljs-keyword">val</span> sum2 = sumNumbers(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>)
    println(<span class="hljs-string">"两个数的和：<span class="hljs-variable">$sum2</span>"</span>) <span class="hljs-comment">// 输出：两个数的和：30</span>

    <span class="hljs-comment">// 2. 传递 5 个参数</span>
    <span class="hljs-keyword">val</span> sum5 = sumNumbers(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
    println(<span class="hljs-string">"五个数的和：<span class="hljs-variable">$sum5</span>"</span>) <span class="hljs-comment">// 输出：五个数的和：15</span>

    <span class="hljs-comment">// 3. 传递 0 个参数（返回默认值 0）</span>
    <span class="hljs-keyword">val</span> sum0 = sumNumbers()
    println(<span class="hljs-string">"零个数的和：<span class="hljs-variable">$sum0</span>"</span>) <span class="hljs-comment">// 输出：零个数的和：0</span>
}

</code></pre>
<p>从示例可以看出，可变参数让函数的调用场景变得极度灵活，无需为不同数量的参数定义多个重载函数。</p>
<h3 data-id="heading-8">2.3 可变参数的关键注意点（位置要求、与数组的配合）</h3>
<h4 data-id="heading-9">2.3.1 参数位置要求：可变参数最好放在最后</h4>
<p>Kotlin 中一个函数只能有一个可变参数，且为了避免调用时参数解析混乱，<strong>可变参数建议放在参数列表的最后一位</strong>。如果可变参数前面有其他参数，调用时需要通过“命名参数”明确区分，否则会编译报错。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误示例：可变参数放在非最后位置，调用时易混淆</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printInfo</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> names: <span class="hljs-type">String</span>, prefix: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Unit</span> {
    <span class="hljs-keyword">for</span> (name <span class="hljs-keyword">in</span> names) {
        println(<span class="hljs-string">"<span class="hljs-variable">$prefix</span>：<span class="hljs-variable">$name</span>"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 直接调用会编译报错：无法区分哪个是 prefix，哪个是 names 的参数</span>
    <span class="hljs-comment">// printInfo("张三", "李四", "前缀")</span>

    <span class="hljs-comment">// 必须用命名参数指定 prefix，才能正确调用（不推荐这种定义方式）</span>
    printInfo(<span class="hljs-string">"张三"</span>, <span class="hljs-string">"李四"</span>, prefix = <span class="hljs-string">"姓名"</span>)
}

<span class="hljs-comment">// 正确示例：可变参数放在最后一位</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printInfo</span><span class="hljs-params">(prefix: <span class="hljs-type">String</span>, <span class="hljs-keyword">vararg</span> names: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Unit</span> {
    <span class="hljs-keyword">for</span> (name <span class="hljs-keyword">in</span> names) {
        println(<span class="hljs-string">"<span class="hljs-variable">$prefix</span>：<span class="hljs-variable">$name</span>"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 直接按顺序调用，无需命名参数，清晰简洁</span>
    printInfo(<span class="hljs-string">"姓名"</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"王五"</span>)
    <span class="hljs-comment">// 输出：</span>
    <span class="hljs-comment">// 姓名：张三</span>
    <span class="hljs-comment">// 姓名：李四</span>
    <span class="hljs-comment">// 姓名：王五</span>
}

</code></pre>
<h4 data-id="heading-10">2.3.2 与数组的配合：用 spread 运算符（*）传递数组</h4>
<p>如果我们有一个现成的数组，想将数组中的所有元素作为可变参数传递给函数，不能直接传递数组（会被当作一个参数处理），需要在数组前加上 <code>*</code> 运算符（称为 spread 运算符，即“展开运算符”），它会将数组中的元素逐个展开为可变参数。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sumNumbers</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> numbers: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> numbers.sum() <span class="hljs-comment">// 数组的 sum() 方法，直接求总和</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 定义一个数组</span>
    <span class="hljs-keyword">val</span> numArray = intArrayOf(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>, <span class="hljs-number">40</span>)

    <span class="hljs-comment">// 错误示例：直接传递数组，会被当作一个参数（数组类型），编译报错</span>
    <span class="hljs-comment">// val sum = sumNumbers(numArray)</span>

    <span class="hljs-comment">// 正确示例：用 * 运算符展开数组</span>
    <span class="hljs-keyword">val</span> sum = sumNumbers(*numArray)
    println(<span class="hljs-string">"数组元素的和：<span class="hljs-variable">$sum</span>"</span>) <span class="hljs-comment">// 输出：数组元素的和：100</span>
}

</code></pre>
<p>注意：spread 运算符只能用于数组，不能用于 List 等集合；如果是 List，需要先通过 <code>toIntArray()</code> 等方法转为数组再展开。</p>
<h3 data-id="heading-11">2.4 实用场景举例（如：求和、打印多个数据）</h3>
<h4 data-id="heading-12">2.4.1 场景 1：批量处理数据（求和、求平均值）</h4>
<p>可变参数最常用的场景就是“批量处理同类型数据”，比如计算多个数字的平均值、找出最大值等。下面以“求多个浮点数的平均值”为例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 求多个浮点数的平均值
 * <span class="hljs-doctag">@param</span> nums 可变参数，接收任意数量的 Float 类型数据
 * <span class="hljs-doctag">@return</span> 平均值（若没有参数返回 0.0）
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculateAverage</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> nums: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Float</span> {
    <span class="hljs-keyword">if</span> (nums.isEmpty()) <span class="hljs-keyword">return</span> <span class="hljs-number">0.0f</span>
    <span class="hljs-comment">// 计算总和：nums.sum() 是数组的扩展函数</span>
    <span class="hljs-keyword">val</span> total = nums.sum()
    <span class="hljs-comment">// 平均值 = 总和 / 元素个数</span>
    <span class="hljs-keyword">return</span> total / nums.size
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> avg1 = calculateAverage(<span class="hljs-number">85.5f</span>, <span class="hljs-number">92.0f</span>, <span class="hljs-number">78.5f</span>, <span class="hljs-number">90.0f</span>)
    println(<span class="hljs-string">"4个成绩的平均值：<span class="hljs-variable">$avg1</span>"</span>) <span class="hljs-comment">// 输出：4个成绩的平均值：86.5</span>

    <span class="hljs-keyword">val</span> avg2 = calculateAverage(<span class="hljs-number">95.0f</span>, <span class="hljs-number">88.0f</span>)
    println(<span class="hljs-string">"2个成绩的平均值：<span class="hljs-variable">$avg2</span>"</span>) <span class="hljs-comment">// 输出：2个成绩的平均值：91.5</span>
}

</code></pre>
<h4 data-id="heading-13">2.4.2 场景 2：批量打印数据（带统一前缀）</h4>
<p>开发中经常需要“批量打印一组数据”，比如打印用户列表、日志列表等，用可变参数可以轻松实现“传递任意个数据，统一添加前缀后打印”：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 批量打印数据，带统一前缀
 * <span class="hljs-doctag">@param</span> prefix 每个数据的前缀
 * <span class="hljs-doctag">@param</span> data 可变参数，接收任意数量的 String 类型数据
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">batchPrint</span><span class="hljs-params">(prefix: <span class="hljs-type">String</span>, <span class="hljs-keyword">vararg</span> <span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span> {
    println(<span class="hljs-string">"=== 批量打印开始 ==="</span>)
    <span class="hljs-keyword">data</span>.forEachIndexed { index, item -&gt;
        <span class="hljs-comment">// 索引从 1 开始，格式：前缀 + 序号 + 数据</span>
        println(<span class="hljs-string">"<span class="hljs-variable">$prefix</span> <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>：<span class="hljs-variable">$item</span>"</span>)
    }
    println(<span class="hljs-string">"=== 批量打印结束 ==="</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 打印用户列表</span>
    batchPrint(<span class="hljs-string">"用户"</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"王五"</span>, <span class="hljs-string">"赵六"</span>)
    <span class="hljs-comment">// 打印日志列表</span>
    batchPrint(<span class="hljs-string">"日志"</span>, <span class="hljs-string">"系统启动成功"</span>, <span class="hljs-string">"用户登录"</span>, <span class="hljs-string">"数据同步完成"</span>)
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-comment">=== 批量打印开始 ===</span>
用户 1：张三
用户 2：李四
用户 3：王五
用户 4：赵六
<span class="hljs-comment">=== 批量打印结束 ===</span>
<span class="hljs-comment">=== 批量打印开始 ===</span>
日志 1：系统启动成功
日志 2：用户登录
日志 3：数据同步完成
<span class="hljs-comment">=== 批量打印结束 ===</span>

</code></pre>
<h2 data-id="heading-14">三、局部函数 详解</h2>
<h3 data-id="heading-15">3.1 什么是局部函数？（函数内部定义的函数）</h3>
<p>局部函数（Local Function）是指在<strong>另一个函数内部定义的函数</strong>，它只在外部函数的作用域内有效，外部函数之外无法调用。简单来说，就是“函数里套函数”，局部函数专门为外部函数服务，用于封装外部函数内部的重复逻辑。</p>
<p>比如一个“用户注册”函数，内部需要多次校验“用户名不为空”“密码长度不小于 6 位”这些逻辑，如果直接重复编写校验代码会很冗余，这时就可以把校验逻辑封装成局部函数，在外部函数内部重复调用。</p>
<h3 data-id="heading-16">3.2 局部函数的基本用法（语法格式 + 基础示例）</h3>
<h4 data-id="heading-17">3.2.1 语法格式</h4>
<p>局部函数的定义语法和普通函数一致，只是位置在另一个函数的内部：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> 外部函数名<span class="hljs-params">(外部参数: 类型)</span></span>: 返回类型 {
    <span class="hljs-comment">// 外部函数的变量</span>
    <span class="hljs-keyword">val</span> 变量名 = 初始值

    <span class="hljs-comment">// 定义局部函数（仅在外部函数内部可见）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> 局部函数名<span class="hljs-params">(局部参数: 类型)</span></span>: 返回类型 {
        <span class="hljs-comment">// 局部函数体：可访问外部函数的变量和参数</span>
    }

    <span class="hljs-comment">// 外部函数体：调用局部函数</span>
    <span class="hljs-keyword">val</span> 结果 = 局部函数名(参数值)
    <span class="hljs-keyword">return</span> 结果
}

</code></pre>
<h4 data-id="heading-18">3.2.2 基础示例</h4>
<p>以“用户注册”为例，将“校验用户名”和“校验密码”的逻辑封装成局部函数，实现代码如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 外部函数：用户注册
 * <span class="hljs-doctag">@param</span> username 用户名
 * <span class="hljs-doctag">@param</span> password 密码
 * <span class="hljs-doctag">@return</span> 注册结果（成功/失败原因）
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">userRegister</span><span class="hljs-params">(username: <span class="hljs-type">String</span>, password: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-comment">// 局部函数1：校验用户名（仅在 userRegister 内部可用）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkUsername</span><span class="hljs-params">()</span></span>: String? {
        <span class="hljs-comment">// 可直接访问外部函数的参数 username</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> {
            username.isEmpty() -&gt; <span class="hljs-string">"用户名不能为空"</span>
            username.length &lt; <span class="hljs-number">3</span> -&gt; <span class="hljs-string">"用户名长度不能小于3位"</span>
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-literal">null</span> <span class="hljs-comment">// 校验通过，返回 null</span>
        }
    }

    <span class="hljs-comment">// 局部函数2：校验密码（仅在 userRegister 内部可用）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkPassword</span><span class="hljs-params">()</span></span>: String? {
        <span class="hljs-comment">// 可直接访问外部函数的参数 password</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> {
            password.isEmpty() -&gt; <span class="hljs-string">"密码不能为空"</span>
            password.length &lt; <span class="hljs-number">6</span> -&gt; <span class="hljs-string">"密码长度不能小于6位"</span>
            !password.any { it.isDigit() } -&gt; <span class="hljs-string">"密码必须包含数字"</span>
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-literal">null</span> <span class="hljs-comment">// 校验通过，返回 null</span>
        }
    }

    <span class="hljs-comment">// 外部函数逻辑：调用局部函数进行校验</span>
    <span class="hljs-keyword">val</span> usernameError = checkUsername()
    <span class="hljs-keyword">if</span> (usernameError != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"注册失败：<span class="hljs-variable">$usernameError</span>"</span>
    }

    <span class="hljs-keyword">val</span> passwordError = checkPassword()
    <span class="hljs-keyword">if</span> (passwordError != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"注册失败：<span class="hljs-variable">$passwordError</span>"</span>
    }

    <span class="hljs-comment">// 校验通过，返回成功信息</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"注册成功！用户名：<span class="hljs-variable">$username</span>"</span>
}

<span class="hljs-comment">// 调用外部函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(userRegister(<span class="hljs-string">"zhangsan"</span>, <span class="hljs-string">"123456"</span>)) <span class="hljs-comment">// 输出：注册成功！用户名：zhangsan</span>
    println(userRegister(<span class="hljs-string">"zh"</span>, <span class="hljs-string">"123456"</span>)) <span class="hljs-comment">// 输出：注册失败：用户名长度不能小于3位</span>
    println(userRegister(<span class="hljs-string">"lisi"</span>, <span class="hljs-string">"12345"</span>)) <span class="hljs-comment">// 输出：注册失败：密码长度不能小于6位</span>
    println(userRegister(<span class="hljs-string">"wangwu"</span>, <span class="hljs-string">"abcdef"</span>)) <span class="hljs-comment">// 输出：注册失败：密码必须包含数字</span>
}

</code></pre>
<p>从示例可以看出，局部函数将外部函数的冗余逻辑抽离出来，让外部函数的主逻辑（注册流程）更清晰，同时局部函数可直接访问外部函数的参数，无需额外传递。</p>
<h3 data-id="heading-19">3.3 局部函数的核心特性（访问外部函数变量、封装复用）</h3>
<h4 data-id="heading-20">3.3.1 特性 1：可直接访问外部函数的变量和参数</h4>
<p>局部函数的最大特性之一是“作用域嵌套”——它可以直接访问外部函数的参数、局部变量，甚至修改外部函数的可变变量（如 var 修饰的变量）。这种特性让局部函数无需通过参数传递就能获取外部数据，简化了调用逻辑。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 外部函数：计算多个数字的平方和
 * <span class="hljs-doctag">@param</span> numbers 可变参数，接收多个整数
 * <span class="hljs-doctag">@return</span> 所有数字的平方和
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">squareSum</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> numbers: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">var</span> total = <span class="hljs-number">0</span> <span class="hljs-comment">// 外部函数的可变变量</span>

    <span class="hljs-comment">// 局部函数：计算单个数字的平方，并累加到 total</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addSquare</span><span class="hljs-params">(num: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 直接访问并修改外部函数的变量 total</span>
        total += num * num
    }

    <span class="hljs-comment">// 遍历所有数字，调用局部函数累加</span>
    numbers.forEach { addSquare(it) }
    <span class="hljs-keyword">return</span> total
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> sum1 = squareSum(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
    println(<span class="hljs-string">"1²+2²+3² = <span class="hljs-variable">$sum1</span>"</span>) <span class="hljs-comment">// 输出：1²+2²+3² = 14</span>

    <span class="hljs-keyword">val</span> sum2 = squareSum(<span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
    println(<span class="hljs-string">"4²+5² = <span class="hljs-variable">$sum2</span>"</span>) <span class="hljs-comment">// 输出：4²+5² = 41</span>
}

</code></pre>
<p>示例中，局部函数 <code>addSquare</code> 直接修改了外部函数的 <code>total</code> 变量，避免了通过返回值传递中间结果，逻辑更简洁。</p>
<h4 data-id="heading-21">3.3.2 特性 2：封装复用，隐藏内部逻辑</h4>
<p>局部函数仅在外部函数内部可见，外部无法调用，这种“隐藏性”让它非常适合封装外部函数的内部辅助逻辑——既实现了重复逻辑的复用，又不会污染外部作用域（避免定义不必要的顶层函数）。</p>
<p>比如前面的用户注册示例，校验逻辑只在注册函数中用到，封装成局部函数后，不会在其他地方被误调用，保证了代码的“高内聚”。</p>
<h3 data-id="heading-22">3.4 实用场景举例（如：校验逻辑封装、重复逻辑提取）</h3>
<h4 data-id="heading-23">3.4.1 场景 1：表单校验逻辑封装</h4>
<p>表单提交是开发中最常见的场景之一，如登录、注册、信息修改等，这类场景通常需要校验多个字段，且校验逻辑只针对当前表单。用局部函数封装校验逻辑，能让表单处理函数的主逻辑更清晰。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 外部函数：处理登录表单提交
 * <span class="hljs-doctag">@param</span> username 用户名
 * <span class="hljs-doctag">@param</span> password 密码
 * <span class="hljs-doctag">@param</span> verifyCode 验证码
 * <span class="hljs-doctag">@return</span> 提交结果
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loginSubmit</span><span class="hljs-params">(username: <span class="hljs-type">String</span>, password: <span class="hljs-type">String</span>, verifyCode: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-comment">// 局部函数：统一的非空校验逻辑</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkNotEmpty</span><span class="hljs-params">(value: <span class="hljs-type">String</span>, fieldName: <span class="hljs-type">String</span>)</span></span>: String? {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (value.isEmpty()) <span class="hljs-string">"<span class="hljs-variable">$fieldName</span>不能为空"</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
    }

    <span class="hljs-comment">// 局部函数：验证码校验逻辑</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkVerifyCode</span><span class="hljs-params">()</span></span>: String? {
        <span class="hljs-keyword">val</span> correctCode = <span class="hljs-string">"123456"</span> <span class="hljs-comment">// 实际开发中从缓存获取</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (verifyCode != correctCode) <span class="hljs-string">"验证码错误"</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
    }

    <span class="hljs-comment">// 1. 调用局部函数校验各字段</span>
    <span class="hljs-keyword">val</span> usernameError = checkNotEmpty(username, <span class="hljs-string">"用户名"</span>)
    <span class="hljs-keyword">if</span> (usernameError != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"登录失败：<span class="hljs-variable">$usernameError</span>"</span>

    <span class="hljs-keyword">val</span> passwordError = checkNotEmpty(password, <span class="hljs-string">"密码"</span>)
    <span class="hljs-keyword">if</span> (passwordError != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"登录失败：<span class="hljs-variable">$passwordError</span>"</span>

    <span class="hljs-keyword">val</span> codeError = checkVerifyCode()
    <span class="hljs-keyword">if</span> (codeError != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"登录失败：<span class="hljs-variable">$codeError</span>"</span>

    <span class="hljs-comment">// 2. 校验通过，执行登录逻辑（模拟）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"登录成功！欢迎 <span class="hljs-variable">$username</span>"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(loginSubmit(<span class="hljs-string">"zhangsan"</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-string">"123456"</span>)) <span class="hljs-comment">// 登录成功</span>
    println(loginSubmit(<span class="hljs-string">""</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-string">"123456"</span>)) <span class="hljs-comment">// 登录失败：用户名不能为空</span>
    println(loginSubmit(<span class="hljs-string">"lisi"</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-string">"654321"</span>)) <span class="hljs-comment">// 登录失败：验证码错误</span>
}

</code></pre>
<h4 data-id="heading-24">3.4.2 场景 2：函数内部重复逻辑提取</h4>
<p>如果一个函数内部有多次重复执行的代码片段（比如重复的计算、打印逻辑），将其提取为局部函数，能大幅减少代码冗余。下面以“生成指定格式的日志”为例，日志前缀需要重复拼接，用局部函数优化：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 外部函数：模拟数据处理，并打印不同阶段的日志
 * <span class="hljs-doctag">@param</span> data 待处理的数据
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processData</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// 局部函数：生成带时间戳的日志前缀（重复逻辑提取）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getLogPrefix</span><span class="hljs-params">(phase: <span class="hljs-type">String</span>)</span></span>: String {
        <span class="hljs-keyword">val</span> time = System.currentTimeMillis() <span class="hljs-comment">// 获取当前时间戳</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"[<span class="hljs-variable">$time</span>] [<span class="hljs-subst">${phase}</span>]"</span>
    }

    <span class="hljs-comment">// 阶段1：数据接收</span>
    println(<span class="hljs-string">"<span class="hljs-subst">${getLogPrefix(<span class="hljs-string">"接收数据"</span>)}</span> 数据已接收：<span class="hljs-variable">$data</span>"</span>)
    <span class="hljs-comment">// 模拟处理延迟</span>
    Thread.sleep(<span class="hljs-number">100</span>)

    <span class="hljs-comment">// 阶段2：数据解析</span>
    <span class="hljs-keyword">val</span> parsedData = <span class="hljs-keyword">data</span>.uppercase() <span class="hljs-comment">// 模拟解析：转为大写</span>
    println(<span class="hljs-string">"<span class="hljs-subst">${getLogPrefix(<span class="hljs-string">"解析数据"</span>)}</span> 数据解析完成：<span class="hljs-variable">$parsedData</span>"</span>)
    Thread.sleep(<span class="hljs-number">100</span>)

    <span class="hljs-comment">// 阶段3：数据存储</span>
    println(<span class="hljs-string">"<span class="hljs-subst">${getLogPrefix(<span class="hljs-string">"存储数据"</span>)}</span> 数据存储成功"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    processData(<span class="hljs-string">"kotlin-vararg-local-function"</span>)
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[1731678900123]</span> <span class="hljs-selector-attr">[接收数据]</span> 数据已接收：kotlin-vararg-local-function
<span class="hljs-selector-attr">[1731678900225]</span> <span class="hljs-selector-attr">[解析数据]</span> 数据解析完成：KOTLIN-VARARG-LOCAL-FUNCTION
<span class="hljs-selector-attr">[1731678900326]</span> <span class="hljs-selector-attr">[存储数据]</span> 数据存储成功

</code></pre>
<p>示例中，“生成日志前缀”的逻辑被提取为局部函数 <code>getLogPrefix</code>，避免了在三个阶段重复编写“获取时间戳+拼接前缀”的代码，让代码更简洁可维护。</p>
<h2 data-id="heading-25">四、可变参数与局部函数 结合示例</h2>
<h3 data-id="heading-26">4.1 简单复合场景（如：可变参数接收数据 + 局部函数处理数据）</h3>
<p>可变参数的优势是“接收任意数量的同类型数据”，局部函数的优势是“封装函数内部重复逻辑”，两者结合可以实现“批量接收数据 + 统一处理数据”的场景。下面以“批量校验手机号格式，并返回校验结果”为例，展示两者的协同作用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 复合场景：批量校验手机号格式
 * <span class="hljs-doctag">@param</span> phones 可变参数，接收任意数量的手机号字符串
 * <span class="hljs-doctag">@return</span> 校验结果列表（每个手机号对应一个结果）
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">batchCheckPhone</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> phones: <span class="hljs-type">String</span>)</span></span>: List&lt;String&gt; {
    <span class="hljs-comment">// 局部函数：单个手机号格式校验（封装重复处理逻辑）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkSinglePhone</span><span class="hljs-params">(phone: <span class="hljs-type">String</span>)</span></span>: String {
        <span class="hljs-comment">// 手机号正则表达式（简单匹配11位数字）</span>
        <span class="hljs-keyword">val</span> phoneRegex = <span class="hljs-string">"^1[3-9]\\d{9}$"</span>.toRegex()
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (phone.matches(phoneRegex)) {
            <span class="hljs-string">"手机号 <span class="hljs-variable">$phone</span>：格式正确"</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-string">"手机号 <span class="hljs-variable">$phone</span>：格式错误（需为11位有效数字）"</span>
        }
    }

    <span class="hljs-comment">// 可变参数接收数据，遍历后调用局部函数处理，收集结果</span>
    <span class="hljs-keyword">val</span> resultList = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">for</span> (phone <span class="hljs-keyword">in</span> phones) {
        <span class="hljs-keyword">val</span> result = checkSinglePhone(phone)
        resultList.add(result)
    }
    <span class="hljs-keyword">return</span> resultList
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 传递多个手机号（可变参数），获取校验结果</span>
    <span class="hljs-keyword">val</span> checkResults = batchCheckPhone(
        <span class="hljs-string">"13800138000"</span>,
        <span class="hljs-string">"1234567890"</span>,
        <span class="hljs-string">"139123456789"</span>,
        <span class="hljs-string">"18888888888"</span>
    )

    <span class="hljs-comment">// 打印校验结果</span>
    checkResults.forEach { println(it) }
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs">手机号 13800138000：格式正确
手机号 1234567890：格式错误（需为11位有效数字）
手机号 139123456789：格式错误（需为11位有效数字）
手机号 18888888888：格式正确

</code></pre>
<p>这个示例中，可变参数 <code>phones</code> 实现了“批量接收手机号”的需求，局部函数 <code>checkSinglePhone</code> 封装了“单个手机号校验”的重复逻辑，两者结合让代码既灵活又简洁——既支持任意数量的手机号校验，又避免了重复编写校验逻辑。</p>
<h2 data-id="heading-27">五、总结与注意事项</h2>
<h3 data-id="heading-28">5.1 核心知识点回顾</h3>
<h4 data-id="heading-29">5.1.1 可变参数（vararg）</h4>
<ul>
<li><strong>定义</strong>：用 <code>vararg</code> 修饰参数，允许接收任意数量的同类型参数，函数内部当作数组处理。</li>
<li><strong>用法</strong>：调用时可直接传递多个参数，传递数组需用  运算符展开。</li>
<li><strong>关键</strong>：一个函数只能有一个可变参数，建议放在参数列表最后。</li>
</ul>
<h4 data-id="heading-30">5.1.2 局部函数</h4>
<ul>
<li><strong>定义</strong>：在函数内部定义的函数，仅在外部函数内部可见。</li>
<li><strong>特性</strong>：可直接访问/修改外部函数的变量和参数，实现内部逻辑封装复用。</li>
<li><strong>优势</strong>：减少外部函数冗余代码，隐藏内部辅助逻辑，不污染外部作用域。</li>
</ul>
<h4 data-id="heading-31">5.1.3 两者结合</h4>
<p>可变参数负责“批量接收数据”，局部函数负责“封装重复处理逻辑”，结合后可高效实现“批量数据处理”场景。</p>
<h3 data-id="heading-32">5.2 日常开发使用建议（何时用、避坑点）</h3>
<h4 data-id="heading-33">5.2.1 何时使用可变参数？</h4>
<ul>
<li>函数需要接收“不确定数量的同类型参数”时，如求和、批量打印、批量校验等场景。</li>
<li>避免定义多个参数数量不同的重载函数（如 sum2、sum3、sum4），用一个可变参数函数替代。</li>
</ul>
<h4 data-id="heading-34">5.2.2 何时使用局部函数？</h4>
<ul>
<li>外部函数内部有“重复执行的逻辑片段”时，如多次校验、重复计算、重复格式化等。</li>
<li>辅助逻辑仅在当前函数中用到，无需暴露给外部（避免定义顶层辅助函数）。</li>
</ul>
<h4 data-id="heading-35">5.2.3 避坑点</h4>
<ul>
<li><strong>可变参数避坑</strong>：① 不要将可变参数放在非最后位置，否则调用需用命名参数，易出错；② 传递数组必须加  运算符，否则会被当作单个参数。</li>
<li><strong>局部函数避坑</strong>：① 局部函数不能访问外部函数的 <code>val</code> 变量后又修改它（val 不可变）；② 避免局部函数嵌套过深（如函数里套函数再套函数），会降低代码可读性。</li>
<li><strong>通用避坑</strong>：无论使用哪种特性，都要保证代码逻辑清晰——不要为了用特性而用特性，冗余代码少、可读性高才是核心目标。</li>
</ul>
<p>可变参数和局部函数是 Kotlin 中提升代码质量的重要进阶特性，它们的用法不算复杂，但能解决很多实际开发中的痛点。建议大家在开发中根据场景灵活运用，让代码更简洁、更易维护。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3.Kotlin 流程控制：告别 if-else 嵌套：If 表达式]]></title>    <link>https://juejin.cn/post/7574245883635449908</link>    <guid>https://juejin.cn/post/7574245883635449908</guid>    <pubDate>2025-11-19T10:41:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574245883635449908" data-draft-id="7574250031248670754" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3.Kotlin 流程控制：告别 if-else 嵌套：If 表达式"/> <meta itemprop="keywords" content="Android Jetpack,Android,Kotlin"/> <meta itemprop="datePublished" content="2025-11-19T10:41:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android_小雨"/> <meta itemprop="url" content="https://juejin.cn/user/220360279590862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3.Kotlin 流程控制：告别 if-else 嵌套：If 表达式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/220360279590862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android_小雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T10:41:27.000Z" title="Wed Nov 19 2025 10:41:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>希望帮你在Kotlin进阶路上少走弯路，在技术上稳步提升。当然，由于个人知识储备有限，笔记中难免存在疏漏或表述不当的地方，也非常欢迎大家提出宝贵意见，一起交流进步。 —— Android_小雨</p>
</blockquote>
<p>整体目录：<a href="https://juejin.cn/spost/7573592952242602036" target="_blank" title="https://juejin.cn/spost/7573592952242602036">Kotlin 进阶不迷路：41 个核心知识点，构建完整知识体系</a></p>
<h2 data-id="heading-0">一、前言</h2>
<h3 data-id="heading-1">1.1 if-else 嵌套的痛点（代码冗余、可读性差）</h3>
<p>做过Java开发的同学一定对“if-else嵌套地狱”深有体会。当业务逻辑存在多个条件分支时，我们不得不层层嵌套if-else语句，最终写出的代码就像“金字塔”一样，缩进越来越深。这种代码不仅冗余啰嗦，还会严重降低可读性——后续维护者需要顺着嵌套层级逐行梳理逻辑，稍不注意就会遗漏某个分支；更麻烦的是，修改中间某个条件时，很容易因为层级混淆导致逻辑错误。</p>
<p>比如一个简单的“根据考试分数评级”的逻辑，用嵌套if-else写出来是这样的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 嵌套 if-else 示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getGrade</span><span class="hljs-params">(<span class="hljs-type">int</span> score)</span> {
    String grade;
    <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">0</span> &amp;&amp; score &lt;= <span class="hljs-number">100</span>) {
        <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">90</span>) {
            grade = <span class="hljs-string">"优秀"</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">80</span>) {
                grade = <span class="hljs-string">"良好"</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">60</span>) {
                    grade = <span class="hljs-string">"及格"</span>;
                } <span class="hljs-keyword">else</span> {
                    grade = <span class="hljs-string">"不及格"</span>;
                }
            }
        }
    } <span class="hljs-keyword">else</span> {
        grade = <span class="hljs-string">"分数无效"</span>;
    }
    <span class="hljs-keyword">return</span> grade;
}

</code></pre>
<p>这段代码仅仅4个评级分支就嵌套了3层，若业务逻辑更复杂（如增加“良好-”“及格+”等细分等级），嵌套层级会直线增加，维护成本陡升。</p>
<h3 data-id="heading-2">1.2 Kotlin If 表达式的核心优势（简洁、可赋值）</h3>
<p>Kotlin的If语句在设计上做了一个关键优化：它不仅仅是用于流程控制的“语句”，更是可以返回值的“表达式”。这个特性直接击中了嵌套if-else的痛点，带来两大核心优势：</p>
<ul>
<li><strong>可直接赋值</strong>：If表达式的结果可以直接赋值给变量，无需像Java那样先定义变量再在分支中赋值，减少代码冗余。</li>
<li><strong>天然去嵌套</strong>：通过链式If表达式替代层级嵌套，将“金字塔”式代码拉平为“线性”代码，可读性大幅提升。</li>
</ul>
<p>还是刚才“分数评级”的例子，用Kotlin If表达式改写后，代码会变得异常简洁：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin If 表达式示例</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getGrade</span><span class="hljs-params">(score: <span class="hljs-type">Int</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (score !<span class="hljs-keyword">in</span> <span class="hljs-number">0.</span><span class="hljs-number">.100</span>) <span class="hljs-string">"分数无效"</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">90</span>) <span class="hljs-string">"优秀"</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">80</span>) <span class="hljs-string">"良好"</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">60</span>) <span class="hljs-string">"及格"</span>
    <span class="hljs-keyword">else</span> <span class="hljs-string">"不及格"</span>
}

</code></pre>
<p>没有多余的嵌套缩进，逻辑分支一目了然，这就是If表达式的魅力。</p>
<h3 data-id="heading-3">1.3 本文核心内容预告</h3>
<p>本文将从Kotlin If表达式的基础概念入手，先讲清它与Java if语句的核心差异，再通过实际场景演示如何用If表达式简化if-else嵌套，最后总结适用场景和避坑技巧。无论你是刚从Java转Kotlin的新手，还是想优化现有Kotlin代码的开发者，都能通过本文掌握用If表达式提升代码质量的实用方法。</p>
<h2 data-id="heading-4">二、Kotlin If 基础：不止是判断，更是表达式</h2>
<h3 data-id="heading-5">2.1 什么是 If 表达式？（区别于 Java 的 if 语句）</h3>
<p>在编程中，“语句”和“表达式”是两个不同的概念：<strong>语句</strong>用于执行某个操作（如Java的if语句仅控制流程，不返回值）；<strong>表达式</strong>则是一个会计算并返回结果的代码片段。Kotlin的If恰恰是后者——它在完成条件判断的同时，会返回满足条件的分支中的值，这是它与Java if语句的本质区别。</p>
<p>这个“返回值”特性是Kotlin If表达式的核心，也是它能简化嵌套的关键基础。</p>
<h3 data-id="heading-6">2.2 基本用法（简单条件判断 + 直接赋值示例）</h3>
<h4 data-id="heading-7">2.2.1 简单条件判断</h4>
<p>Kotlin If表达式的基本语法与Java if语句相似，但无需在单分支代码块外加花括号（单条语句时），且支持直接返回值：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 单分支 If 表达式</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printGreater</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>)</span></span> {
    <span class="hljs-comment">// If 表达式返回满足条件的值，直接用于打印</span>
    println(<span class="hljs-keyword">if</span> (a &gt; b) <span class="hljs-string">"a 大于 b"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"a 不大于 b"</span>)
}

<span class="hljs-comment">// 多分支 If 表达式</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getMax</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>, c: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-comment">// 多分支 If 表达式，返回最大值</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (a &gt; b &amp;&amp; a &gt; c) a
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (b &gt; a &amp;&amp; b &gt; c) b
    <span class="hljs-keyword">else</span> c
}

</code></pre>
<h4 data-id="heading-8">2.2.2 直接赋值示例</h4>
<p>由于If表达式有返回值，它可以直接赋值给变量，这是Java无法直接做到的（Java需用三元运算符或先定义变量再赋值）。比如“根据性别返回问候语”：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> gender = <span class="hljs-string">"男"</span>
    <span class="hljs-comment">// If 表达式结果直接赋值给变量</span>
    <span class="hljs-keyword">val</span> greeting = <span class="hljs-keyword">if</span> (gender == <span class="hljs-string">"男"</span>) <span class="hljs-string">"先生，您好！"</span>
                   <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (gender == <span class="hljs-string">"女"</span>) <span class="hljs-string">"女士，您好！"</span>
                   <span class="hljs-keyword">else</span> <span class="hljs-string">"您好！"</span>
    println(greeting) <span class="hljs-comment">// 输出：先生，您好！</span>

    <span class="hljs-comment">// 更简洁的单分支赋值（含默认值）</span>
    <span class="hljs-keyword">val</span> age = <span class="hljs-number">25</span>
    <span class="hljs-keyword">val</span> isAdult = <span class="hljs-keyword">if</span> (age &gt;= <span class="hljs-number">18</span>) <span class="hljs-literal">true</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">false</span>
    println(isAdult) <span class="hljs-comment">// 输出：true</span>
}

</code></pre>
<p>这种“判断+赋值”一步完成的写法，比Java的“先定义变量再在分支中赋值”少了至少一行代码，且逻辑更连贯。</p>
<h3 data-id="heading-9">2.3 与 Java if 的核心差异（无需三元运算符）</h3>
<p>Java中存在“if-else语句”和“三元运算符（?:）”两种条件判断方式：简单的二选一赋值用三元运算符，复杂的流程控制用if-else。但三元运算符仅支持二分支，且嵌套时可读性极差；if-else虽支持多分支却不能直接赋值。</p>
<p>Kotlin的If表达式直接融合了两者的优势：既支持多分支判断，又能直接返回值赋值给变量，因此<strong>Kotlin中没有专门的三元运算符</strong>——If表达式完全可以替代它，且更灵活。</p>
<p>对比Java三元运算符和Kotlin If表达式：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 三元运算符（仅支持二分支）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">greeting</span> <span class="hljs-operator">=</span> gender.equals(<span class="hljs-string">"男"</span>) ? <span class="hljs-string">"先生您好"</span> : <span class="hljs-string">"女士您好"</span>;

</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin If 表达式（支持二分支，更直观）</span>
<span class="hljs-keyword">val</span> greeting = <span class="hljs-keyword">if</span> (gender == <span class="hljs-string">"男"</span>) <span class="hljs-string">"先生您好"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"女士您好"</span>

<span class="hljs-comment">// Kotlin If 表达式支持多分支（Java需嵌套三元运算符，可读性差）</span>
<span class="hljs-keyword">val</span> greeting = <span class="hljs-keyword">if</span> (gender == <span class="hljs-string">"男"</span>) <span class="hljs-string">"先生您好"</span>
               <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (gender == <span class="hljs-string">"女"</span>) <span class="hljs-string">"女士您好"</span>
               <span class="hljs-keyword">else</span> <span class="hljs-string">"您好"</span>
<span class="hljs-comment">// Java 嵌套三元运算符（可读性差，不推荐）</span>
String greeting = gender.equals(<span class="hljs-string">"男"</span>) ? <span class="hljs-string">"先生您好"</span> : (gender.equals(<span class="hljs-string">"女"</span>) ? <span class="hljs-string">"女士您好"</span> : <span class="hljs-string">"您好"</span>);

</code></pre>
<p>可以看到，多分支场景下，Kotlin If表达式的可读性远超Java嵌套三元运算符。</p>
<h2 data-id="heading-10">三、If 表达式简化 if-else 嵌套</h2>
<h3 data-id="heading-11">3.1 嵌套场景示例（传统 if-else 写法对比）</h3>
<p>我们先看一个典型的嵌套if-else场景：“根据学生的成绩和出勤率判断是否能参加考试”。业务逻辑：</p>
<ol>
<li>首先判断出勤率是否≥90%：不满足则直接不能参加；</li>
<li>出勤率满足后，判断成绩是否≥60分：满足则可以参加，不满足则需补考。</li>
</ol>
<p>用Java嵌套if-else写法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 嵌套 if-else 写法</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">canTakeExam</span><span class="hljs-params">(<span class="hljs-type">double</span> attendanceRate, <span class="hljs-type">double</span> score)</span> {
    String result;
    <span class="hljs-comment">// 第一层：判断出勤率</span>
    <span class="hljs-keyword">if</span> (attendanceRate &gt;= <span class="hljs-number">0.9</span>) {
        <span class="hljs-comment">// 第二层：判断成绩</span>
        <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">60</span>) {
            result = <span class="hljs-string">"可以参加考试"</span>;
        } <span class="hljs-keyword">else</span> {
            result = <span class="hljs-string">"需参加补考"</span>;
        }
    } <span class="hljs-keyword">else</span> {
        result = <span class="hljs-string">"出勤率不足，不能参加考试"</span>;
    }
    <span class="hljs-keyword">return</span> result;
}

</code></pre>
<p>这段代码有2层嵌套，逻辑不算复杂，但已能看出缩进带来的层次感。接下来用Kotlin If表达式改写，看看如何“拉平”嵌套。</p>
<h3 data-id="heading-12">3.2 单层 If 表达式简化（二选一逻辑）</h3>
<p>对于“单条件二分支”的嵌套场景（如上述场景中“出勤率满足后判断成绩”），Kotlin If表达式可以通过“else if”将嵌套改为线性结构，消除缩进。</p>
<p>改写上述Java代码为Kotlin If表达式：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin If 表达式简化二分支嵌套</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">canTakeExam</span><span class="hljs-params">(attendanceRate: <span class="hljs-type">Double</span>, score: <span class="hljs-type">Double</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (attendanceRate &lt; <span class="hljs-number">0.9</span>) <span class="hljs-string">"出勤率不足，不能参加考试"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">60</span>) <span class="hljs-string">"可以参加考试"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-string">"需参加补考"</span>
}

</code></pre>
<p>对比Java版本：嵌套层级从2层变为0层，代码从“金字塔”变为“水平线”，逻辑流向更清晰——先判断最严格的条件（出勤率），不满足直接返回，满足则继续判断下一个条件。</p>
<p>核心思路：<strong>将嵌套的内层条件改为外层的“else if”分支</strong>，优先处理“不满足则直接返回”的异常分支，减少嵌套。</p>
<h3 data-id="heading-13">3.3 多层 If 表达式简化（多条件分支）</h3>
<p>对于3层及以上的复杂嵌套，If表达式同样可以通过“链式else if”拉平层级。比如更复杂的“成绩评级+奖励判断”场景：</p>
<ol>
<li>先判断分数是否在0-100之间：无效分数直接返回；</li>
<li>有效分数中，90分以上：优秀+奖学金；</li>
<li>80-89分：良好+学习用品；</li>
<li>60-79分：及格+鼓励信；</li>
<li>60分以下：不及格+补考通知。</li>
</ol>
<p>Java嵌套if-else写法（3层嵌套）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 多层嵌套 if-else</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getScoreReward</span><span class="hljs-params">(<span class="hljs-type">int</span> score)</span> {
    String result;
    <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">0</span> &amp;&amp; score &lt;= <span class="hljs-number">100</span>) {
        <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">90</span>) {
            result = <span class="hljs-string">"优秀，获得500元奖学金"</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">80</span>) {
                result = <span class="hljs-string">"良好，获得笔记本套装"</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">60</span>) {
                    result = <span class="hljs-string">"及格，获得鼓励信"</span>;
                } <span class="hljs-keyword">else</span> {
                    result = <span class="hljs-string">"不及格，需参加补考"</span>;
                }
            }
        }
    } <span class="hljs-keyword">else</span> {
        result = <span class="hljs-string">"分数无效"</span>;
    }
    <span class="hljs-keyword">return</span> result;
}

</code></pre>
<p>用Kotlin If表达式改写（0层嵌套）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin 链式 If 表达式简化多层嵌套</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getScoreReward</span><span class="hljs-params">(score: <span class="hljs-type">Int</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (score !<span class="hljs-keyword">in</span> <span class="hljs-number">0.</span><span class="hljs-number">.100</span>) <span class="hljs-string">"分数无效"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">90</span>) <span class="hljs-string">"优秀，获得500元奖学金"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">80</span>) <span class="hljs-string">"良好，获得笔记本套装"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">60</span>) <span class="hljs-string">"及格，获得鼓励信"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-string">"不及格，需参加补考"</span>
}

</code></pre>
<p>改写后的代码完全消除了嵌套，每个条件分支平行排列，逻辑一目了然。即使后续增加“70-79分：良好-，获得书签”这样的分支，也只需新增一个“else if”，无需调整缩进。</p>
<h3 data-id="heading-14">3.4 关键技巧：保持表达式简洁性</h3>
<p>虽然If表达式能简化嵌套，但如果每个分支的代码逻辑过于复杂（如包含多行代码、循环、异常处理等），直接写在If表达式中会导致代码臃肿。此时需要遵循“单一职责”原则，将复杂逻辑抽离为单独的函数，保持If表达式的简洁性。</p>
<p>反例（分支逻辑复杂，If表达式臃肿）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 反例：分支逻辑复杂，If表达式可读性差</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleOrder</span><span class="hljs-params">(status: <span class="hljs-type">String</span>, orderId: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (status == <span class="hljs-string">"待支付"</span>) {
        <span class="hljs-comment">// 分支内包含多行逻辑，导致If表达式臃肿</span>
        <span class="hljs-keyword">val</span> currentTime = System.currentTimeMillis()
        <span class="hljs-keyword">val</span> expireTime = currentTime + <span class="hljs-number">30</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> <span class="hljs-comment">// 30分钟后过期</span>
        <span class="hljs-string">"订单<span class="hljs-variable">$orderId</span> 待支付，过期时间：<span class="hljs-subst">${expireTime}</span>"</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status == <span class="hljs-string">"已支付"</span>) {
        <span class="hljs-keyword">val</span> logistics = <span class="hljs-string">"顺丰快递，单号：SF123456789"</span>
        <span class="hljs-string">"订单<span class="hljs-variable">$orderId</span> 已支付，物流信息：<span class="hljs-variable">$logistics</span>"</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-string">"订单<span class="hljs-variable">$orderId</span> 状态异常"</span>
    }
}

</code></pre>
<p>正例（抽离复杂逻辑为函数，If表达式简洁）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 正例：抽离分支逻辑为单独函数，If表达式简洁清晰</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleOrder</span><span class="hljs-params">(status: <span class="hljs-type">String</span>, orderId: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (status == <span class="hljs-string">"待支付"</span>) getPendingPaymentMsg(orderId)
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status == <span class="hljs-string">"已支付"</span>) getPaidMsg(orderId)
           <span class="hljs-keyword">else</span> <span class="hljs-string">"订单<span class="hljs-variable">$orderId</span> 状态异常"</span>
}

<span class="hljs-comment">// 抽离待支付逻辑</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getPendingPaymentMsg</span><span class="hljs-params">(orderId: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-keyword">val</span> currentTime = System.currentTimeMillis()
    <span class="hljs-keyword">val</span> expireTime = currentTime + <span class="hljs-number">30</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"订单<span class="hljs-variable">$orderId</span> 待支付，过期时间：<span class="hljs-subst">${expireTime}</span>"</span>
}

<span class="hljs-comment">// 抽离已支付逻辑</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getPaidMsg</span><span class="hljs-params">(orderId: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-keyword">val</span> logistics = <span class="hljs-string">"顺丰快递，单号：SF123456789"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"订单<span class="hljs-variable">$orderId</span> 已支付，物流信息：<span class="hljs-variable">$logistics</span>"</span>
}

</code></pre>
<p>核心技巧：<strong>If表达式的每个分支应尽量只做“返回结果”的操作，复杂逻辑通过私有函数封装</strong>，这样既保留了If表达式去嵌套的优势，又保证了代码的可维护性。</p>
<h2 data-id="heading-15">四、If 表达式的实用场景</h2>
<h3 data-id="heading-16">4.1 变量赋值（直接通过条件返回结果）</h3>
<p>这是If表达式最常用的场景——根据条件动态给变量赋值，替代“先定义变量再在分支中赋值”的繁琐写法。比如“根据用户等级设置折扣”：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> userLevel = <span class="hljs-string">"VIP"</span> <span class="hljs-comment">// 普通用户、VIP、超级VIP</span>
    <span class="hljs-comment">// 根据用户等级赋值折扣率</span>
    <span class="hljs-keyword">val</span> discount = <span class="hljs-keyword">if</span> (userLevel == <span class="hljs-string">"超级VIP"</span>) <span class="hljs-number">0.7</span>
                   <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userLevel == <span class="hljs-string">"VIP"</span>) <span class="hljs-number">0.8</span>
                   <span class="hljs-keyword">else</span> <span class="hljs-number">0.95</span>
    println(<span class="hljs-string">"当前折扣：<span class="hljs-subst">${discount * <span class="hljs-number">10</span>}</span>折"</span>) <span class="hljs-comment">// 输出：当前折扣：8.0折</span>

    <span class="hljs-comment">// 更复杂的条件赋值（结合范围判断）</span>
    <span class="hljs-keyword">val</span> age = <span class="hljs-number">16</span>
    <span class="hljs-keyword">val</span> ticketPrice = <span class="hljs-keyword">if</span> (age &lt; <span class="hljs-number">6</span>) <span class="hljs-number">0.0</span> <span class="hljs-comment">// 6岁以下免票</span>
                      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (age &lt; <span class="hljs-number">18</span>) <span class="hljs-number">50.0</span> <span class="hljs-comment">// 6-17岁半价</span>
                      <span class="hljs-keyword">else</span> <span class="hljs-number">100.0</span> <span class="hljs-comment">// 18岁以上全价</span>
    println(<span class="hljs-string">"门票价格：<span class="hljs-variable">$ticketPrice</span> 元"</span>) <span class="hljs-comment">// 输出：门票价格：50.0 元</span>
}

</code></pre>
<p>这种写法的优势在于“赋值逻辑集中”，变量的所有赋值分支都在一个If表达式中，后续修改时无需在代码中四处查找赋值位置。</p>
<h3 data-id="heading-17">4.2 简单逻辑判断（替代复杂嵌套）</h3>
<p>对于需要根据条件执行不同逻辑（而非赋值）的场景，If表达式同样可以简化嵌套。比如“用户登录验证”：</p>
<ol>
<li>验证用户名是否为空：为空则提示“用户名不能为空”；</li>
<li>用户名不为空时，验证密码长度是否≥6位：不足则提示“密码过短”；</li>
<li>密码符合要求时，验证用户名密码是否匹配：匹配则登录成功，否则提示“账号密码不匹配”。</li>
</ol>
<p>Java嵌套if-else写法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 嵌套逻辑判断</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">login</span><span class="hljs-params">(String username, String password)</span> {
    <span class="hljs-keyword">if</span> (username.isEmpty()) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"用户名不能为空"</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (password.length() &lt; <span class="hljs-number">6</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"密码过短（至少6位）"</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (username.equals(<span class="hljs-string">"admin"</span>) &amp;&amp; password.equals(<span class="hljs-string">"123456"</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"登录成功"</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"账号密码不匹配"</span>;
            }
        }
    }
}

</code></pre>
<p>Kotlin If表达式简化写法：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin If 表达式简化逻辑判断</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">login</span><span class="hljs-params">(username: <span class="hljs-type">String</span>, password: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (username.isEmpty()) <span class="hljs-string">"用户名不能为空"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (password.length &lt; <span class="hljs-number">6</span>) <span class="hljs-string">"密码过短（至少6位）"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (username == <span class="hljs-string">"admin"</span> &amp;&amp; password == <span class="hljs-string">"123456"</span>) <span class="hljs-string">"登录成功"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-string">"账号密码不匹配"</span>
}

</code></pre>
<p>逻辑判断从3层嵌套变为线性分支，代码更简洁，且优先处理异常场景（用户名空、密码短），符合“提前返回”的编码规范。</p>
<h3 data-id="heading-18">4.3 与其他语法配合（如函数返回值）</h3>
<p>If表达式作为返回值时，可以与Kotlin的“单表达式函数”语法结合，进一步简化代码。单表达式函数是指函数体仅包含一个表达式，可省略花括号和return关键字，直接用等号连接函数定义和表达式。</p>
<p>比如“判断是否为偶数”的单表达式函数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 单表达式函数 + If 表达式（极致简洁）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isEven</span><span class="hljs-params">(num: <span class="hljs-type">Int</span>)</span></span> = <span class="hljs-keyword">if</span> (num % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) <span class="hljs-literal">true</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">false</span>

<span class="hljs-comment">// 更简洁的写法（布尔表达式可直接返回）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isEvenSimpler</span><span class="hljs-params">(num: <span class="hljs-type">Int</span>)</span></span> = num % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(isEven(<span class="hljs-number">4</span>)) <span class="hljs-comment">// 输出：true</span>
    println(isEvenSimpler(<span class="hljs-number">5</span>)) <span class="hljs-comment">// 输出：false</span>
}

</code></pre>
<p>再比如结合“空安全”判断：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// If 表达式结合空安全，返回非空值</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserName</span><span class="hljs-params">(user: <span class="hljs-type">User</span>?)</span></span>: String {
    <span class="hljs-comment">// 若user不为空则返回name，否则返回默认值</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) user.name <span class="hljs-keyword">else</span> <span class="hljs-string">"匿名用户"</span>
}

<span class="hljs-comment">// 单表达式函数简化</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserNameSimpler</span><span class="hljs-params">(user: <span class="hljs-type">User</span>?)</span></span> = user?.name ?: <span class="hljs-string">"匿名用户"</span>

<span class="hljs-comment">// 数据类</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> name: String)

</code></pre>
<p>这里If表达式与空安全操作符（?.、?:）配合，实现了“空值处理+返回值”的简洁逻辑。</p>
<h2 data-id="heading-19">五、总结与使用建议</h2>
<h3 data-id="heading-20">5.1 核心知识点回顾（If 表达式特性、去嵌套优势）</h3>
<ul>
<li><strong>核心特性</strong>：Kotlin If是表达式而非语句，具有返回值，可直接赋值给变量或作为函数返回值；支持多分支（else if），无需三元运算符。</li>
<li><strong>去嵌套优势</strong>：通过“链式else if”将传统if-else的“金字塔”嵌套拉平为线性分支，消除缩进，提升代码可读性和可维护性。</li>
<li><strong>关键差异</strong>：与Java相比，融合了if-else的多分支能力和三元运算符的赋值能力，语法更统一。</li>
</ul>
<h3 data-id="heading-21">5.2 适用场景与避坑点（何时用、避免过度复杂）</h3>
<h4 data-id="heading-22">5.2.1 适用场景</h4>
<ol>
<li><strong>变量赋值场景</strong>：需要根据条件动态给变量赋值（替代Java的“定义变量+分支赋值”）。</li>
<li><strong>简单逻辑判断场景</strong>：包含2-5个条件分支的逻辑判断（过多分支建议用when表达式，后续文章讲解）。</li>
<li><strong>单表达式函数场景</strong>：函数逻辑仅为条件判断并返回结果，可结合单表达式函数简化代码。</li>
</ol>
<h4 data-id="heading-23">5.2.2 避坑点</h4>
<ul>
<li><strong>避免分支逻辑过于复杂</strong>：若某个分支包含多行代码、循环或异常处理，需抽离为单独函数，不要直接写在If表达式中，否则会降低可读性。</li>
<li><strong>分支数量不宜过多</strong>：当条件分支超过5个时，If表达式的链式else if会变得冗长，建议改用Kotlin的when表达式（更适合多分支场景）。</li>
<li><strong>注意代码块的返回值</strong>：若分支是代码块（用花括号包裹），需确保代码块的最后一行是返回值（Kotlin代码块的返回值为最后一行表达式的结果）。</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 注意：代码块分支需确保最后一行是返回值</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getMsg</span><span class="hljs-params">(type: <span class="hljs-type">Int</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-number">1</span>) {
        <span class="hljs-comment">// 代码块最后一行是返回值</span>
        <span class="hljs-keyword">val</span> prefix = <span class="hljs-string">"类型1："</span>
        <span class="hljs-string">"<span class="hljs-variable">$prefix</span> 消息内容"</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-string">"其他类型消息"</span>
    }
}

</code></pre>
<h3 data-id="heading-24">5.3 代码简洁性提升小技巧</h3>
<ul>
<li><strong>优先处理异常场景</strong>：在If表达式中先判断“不满足则直接返回”的异常条件，减少后续分支的嵌套（即使不用If表达式，这也是通用编码规范）。</li>
<li><strong>简化布尔表达式</strong>：若If表达式的分支是布尔值（true/false），可直接返回条件表达式，无需显式写true/false。比如 <code>val isAdult = if (age &gt;= 18) true else false</code> 可简化为 <code>val isAdult = age &gt;= 18</code>。</li>
<li><strong>结合单表达式函数</strong>：对于简单的条件返回函数，用“等号+If表达式”的单表达式函数写法，省略花括号和return。</li>
</ul>
<p>Kotlin的If表达式看似是一个简单的语法优化，却能从根本上解决传统if-else嵌套的痛点。掌握它的核心是理解“表达式有返回值”这一本质，然后在实际开发中主动用If表达式替代嵌套if-else，逐步养成简洁的编码习惯。下一篇我们将讲解Kotlin更强大的多分支控制结构——when表达式，让复杂分支逻辑更上一层楼！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[打造稳健的 Android 应用：协程异常处理的实用策略]]></title>    <link>https://juejin.cn/post/7574244766424006665</link>    <guid>https://juejin.cn/post/7574244766424006665</guid>    <pubDate>2025-11-19T11:50:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574244766424006665" data-draft-id="7569143122686836790" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="打造稳健的 Android 应用：协程异常处理的实用策略"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-19T11:50:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="潜龙勿用之化骨龙"/> <meta itemprop="url" content="https://juejin.cn/user/2313028195058471"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            打造稳健的 Android 应用：协程异常处理的实用策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313028195058471/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    潜龙勿用之化骨龙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T11:50:38.000Z" title="Wed Nov 19 2025 11:50:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>异常处理是保障应用稳健性的基石，在不同开发环境中，异常的表现与处理方式大相径庭。本文将带您解码Java、Android与Kotlin协程中的异常行为差异，剖析常见陷阱，并最终提供一套构建坚不可摧应用的最佳实践与“避坑指南”。</p>
<hr/>
<h2 data-id="heading-0"><strong>Java 与 Android 异常处理的区别</strong></h2>
<h3 data-id="heading-1"><strong>Java 异常处理</strong></h3>
<p>在 Java 中，异常是局限于发生异常的线程的。如果子线程抛出未捕获的异常，它不会影响主线程或其他线程。主线程可以继续正常运行，即使子线程遇到错误。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaThreadExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Exception in child thread"</span>);
            }).start();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.out.println(<span class="hljs-string">"Caught exception: "</span> + e.getMessage());
        }
        System.out.println(<span class="hljs-string">"Main thread continues..."</span>);
    }
}
</code></pre>
<p><strong>输出：</strong>
子线程中的异常不会被主线程的 <code>try-catch</code> 捕获，主线程继续执行。</p>
<hr/>
<h3 data-id="heading-2"><strong>Android 异常处理</strong></h3>
<p>在 Android 中，异常处理更加严格。如果子线程抛出未捕获的异常，整个应用会崩溃。这是因为未捕获的异常会传播到主进程级别，导致应用终止。Android 的这种机制旨在确保应用的稳定性。</p>
<p><strong>关键点：</strong>
在 Android 中，异常必须在发生的线程内捕获。如果未捕获异常，应用将崩溃。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">thread1</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">try</span> {
        thread {
            Thread.sleep(<span class="hljs-number">2000</span>)
            <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"Exception inside thread"</span>)
        }
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        Log.e(<span class="hljs-string">"test"</span>, e.message.toString())
    }
}
</code></pre>
<p><strong>结果：</strong>
线程内部的异常无法被外部的 <code>try-catch</code> 捕获，必须在线程内部处理。</p>
<hr/>
<h2 data-id="heading-3"><strong>Kotlin 协程中的异常处理</strong></h2>
<p>Kotlin 协程引入了一种新的并发编程范式，与线程类似，协程中的异常局限于发生异常的协程。外部的 <code>try-catch</code> 无法捕获协程内部抛出的异常。</p>
<h3 data-id="heading-4"><strong>示例：</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">launch1</span><span class="hljs-params">()</span></span> = coroutineScope {
    <span class="hljs-keyword">try</span> {
        launch {
            delay(<span class="hljs-number">2000</span>)
            <span class="hljs-number">1</span> / <span class="hljs-number">0</span> <span class="hljs-comment">// 抛出异常</span>
        }
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        Log.e(<span class="hljs-string">"test"</span>, e.message.toString())
    }
}
</code></pre>
<p><strong>结果：</strong>
协程内部的异常无法被外部的 <code>try-catch</code> 捕获，必须在协程内部处理。</p>
<hr/>
<h2 data-id="heading-5"><strong>coroutineScope 与 supervisorScope 的区别</strong></h2>
<p>在使用协程时，理解 <code>coroutineScope</code> 和 <code>supervisorScope</code> 的区别对于有效的异常处理至关重要。</p>
<h3 data-id="heading-6"><strong>coroutineScope</strong></h3>
<p>在 <code>coroutineScope</code> 中，如果一个子协程失败，会取消所有其他兄弟协程。这种行为确保错误能够一致地传播和处理，但可能导致意外的取消。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">exampleCoroutineScope2</span><span class="hljs-params">()</span></span> = coroutineScope {
    launch {
        <span class="hljs-keyword">try</span> {
            delay(<span class="hljs-number">1000</span>)
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 1 completed"</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 1 failed: <span class="hljs-subst">${e.message}</span>"</span>)
        }
    }
    launch {
        <span class="hljs-keyword">try</span> {
            delay(<span class="hljs-number">500</span>)
            <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"Child 2 failed"</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 2 failed: <span class="hljs-subst">${e.message}</span>"</span>)
        }
    }
    launch {
        <span class="hljs-keyword">try</span> {
            delay(<span class="hljs-number">1500</span>)
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 3 completed"</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 3 failed: <span class="hljs-subst">${e.message}</span>"</span>)
        }
    }
}
</code></pre>
<p><strong>结果：</strong>
如果 <code>Child 2</code> 失败，所有其他兄弟协程（<code>Child 1</code> 和 <code>Child 3</code>）都会被取消。</p>
<hr/>
<h3 data-id="heading-7"><strong>supervisorScope</strong></h3>
<p>在 <code>supervisorScope</code> 中，兄弟协程是相互独立的。如果一个协程失败，它不会影响其他协程的执行。这在需要隔离错误并确保其他任务能够继续时非常有用。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">exampleSupervisorScope2</span><span class="hljs-params">()</span></span> = supervisorScope {
    launch {
        <span class="hljs-keyword">try</span> {
            delay(<span class="hljs-number">1000</span>)
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 1 completed"</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 1 failed: <span class="hljs-subst">${e.message}</span>"</span>)
        }
    }
    launch {
        <span class="hljs-keyword">try</span> {
            delay(<span class="hljs-number">500</span>)
            <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"Child 2 failed"</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 2 failed: <span class="hljs-subst">${e.message}</span>"</span>)
        }
    }
    launch {
        <span class="hljs-keyword">try</span> {
            delay(<span class="hljs-number">1500</span>)
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 3 completed"</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 3 failed: <span class="hljs-subst">${e.message}</span>"</span>)
        }
    }
}
</code></pre>
<p><strong>结果：</strong>
如果 <code>Child 2</code> 失败，<code>Child 1</code> 和 <code>Child 3</code> 不会受到影响，继续执行。</p>
<hr/>
<h3 data-id="heading-8"><strong>如果异常在repo处理，coroutineScope 和 supervisorScope 的区别会消失</strong></h3>
<p>在实际开发中，如果我们将异常处理集中在仓库层（Repository Layer），那么 <code>coroutineScope</code> 和 <code>supervisorScope</code> 的区别就会变得不那么重要。因为仓库层会捕获所有与数据相关的异常（如网络错误或数据库错误），并将其转化为可控的结果返回给上层（如 ViewModel 或 UI 层）。这样，无论是 <code>coroutineScope</code> 还是 <code>supervisorScope</code>，都不会因为未捕获的异常导致协程取消或传播。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchData</span><span class="hljs-params">()</span></span> = <span class="hljs-keyword">try</span> {
    repository.getData() <span class="hljs-comment">// 在仓库层处理异常</span>
} <span class="hljs-keyword">catch</span> (e: Exception) {
    Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Error in repository: <span class="hljs-subst">${e.message}</span>"</span>)
    <span class="hljs-literal">null</span> <span class="hljs-comment">// 返回一个安全的结果</span>
}
</code></pre>
<p>通过这种方式，协程的异常处理逻辑被集中管理，减少了代码的复杂性，同时提高了应用的稳定性。</p>
<hr/>
<h2 data-id="heading-9"><strong>CoroutineExceptionHandler 的挑战</strong></h2>
<p>虽然 <code>CoroutineExceptionHandler</code> 提供了一种处理协程中未捕获异常的机制，但它也存在一些局限性。主要问题在于每次启动协程时都需要显式传递 <code>CoroutineExceptionHandler</code>，这会导致代码冗长且不够优雅。</p>
<h3 data-id="heading-10"><strong>为什么不推荐过度使用 CoroutineExceptionHandler？</strong></h3>
<ol>
<li><strong>复杂性：</strong> 在多个应用层中管理 <code>CoroutineExceptionHandler</code> 会导致代码分散且难以维护。</li>
<li><strong>分层架构：</strong> 更好的做法是将异常处理集中在仓库层（Repository Layer），在这里可以统一管理与数据相关的错误（如网络错误或数据库错误）。这样可以确保异常不会传播到更高的层级（如 ViewModel 或 UI 层）。</li>
</ol>
<hr/>
<h2 data-id="heading-11"><strong>异常处理的最佳实践</strong></h2>
<h3 data-id="heading-12"><strong>在repo处理异常</strong></h3>
<p>将异常处理集中在仓库层，确保与数据相关的错误能够得到有效管理。这种方法提高了代码的可维护性，同时让更高层级（如 ViewModel 和 UI 层）专注于自己的职责。</p>
<h2 data-id="heading-13"><strong>总结</strong></h2>
<p>在 Java、Android 和 Kotlin 协程中，异常处理的机制和行为各不相同。通过遵循最佳实践（如在仓库层集中处理异常、使用 <code>supervisorScope</code> 处理独立任务、在协程内部捕获异常），可以构建健壮且易于维护的应用。如果异常处理集中在仓库层，那么 <code>coroutineScope</code> 和 <code>supervisorScope</code> 的区别将变得不那么重要，因为异常已经被统一管理，协程的取消和传播逻辑不会影响应用的稳定性。理解这些细微差别将帮助开发者避免常见问题，确保应用在面对意外错误时能够保持稳定和弹性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-158 Apache Kylin 3.1.1 在 Hadoop 2.9/Hive 2.3/HBase 1.3 的最小可用部署实录（含坑位与修复）]]></title>    <link>https://juejin.cn/post/7574584245109751859</link>    <guid>https://juejin.cn/post/7574584245109751859</guid>    <pubDate>2025-11-20T01:53:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574584245109751859" data-draft-id="7574289653178843174" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-158 Apache Kylin 3.1.1 在 Hadoop 2.9/Hive 2.3/HBase 1.3 的最小可用部署实录（含坑位与修复）"/> <meta itemprop="keywords" content="后端,大数据,Apache Kylin"/> <meta itemprop="datePublished" content="2025-11-20T01:53:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-158 Apache Kylin 3.1.1 在 Hadoop 2.9/Hive 2.3/HBase 1.3 的最小可用部署实录（含坑位与修复）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T01:53:15.000Z" title="Thu Nov 20 2025 01:53:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：3 节点（h121/122/123）资源吃紧环境，部署 Apache Kylin 3.1.1（HBase1.x 版）。</li>
<li>结论：通过环境变量与软链补齐、修正 HADOOP_CONF_DIR、按序启动组件，成功启动并登录 Kylin（7070）。</li>
<li>产出：完整命令序列、版本矩阵（已验证）、错误速查卡（常见症状→定位→修复）。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69249ccbe6604c8dbed6e767e9173ddd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=fKY3Pa0V3tFtPQZF%2FU%2Bxht%2BSuDQ%3D" alt="大数据-158 Apache Kylin 3.1.1 在 Hadoop 2.9/Hive 2.3/HBase 1.3 的最小可用部署实录（含坑位与修复）" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>















































<table><thead><tr><th>组件/包名</th><th>版本</th><th>已验证</th><th>说明</th></tr></thead><tbody><tr><td>Apache Kylin</td><td>3.1.1 (apache-kylin-3.1.1-bin-hbase1x)</td><td>是</td><td>来自 archive.apache.org，运行于 h122，Web 端口 7070，默认 ADMIN/KYLIN（大写）。</td></tr><tr><td>Hadoop</td><td>2.9.2</td><td>是</td><td>HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop；先启 HDFS，再启 YARN；HADOOP_CLASSPATH=<code>hadoop classpath</code>。</td></tr><tr><td>Hive</td><td>2.3.9</td><td>是</td><td>独立启动 Metastore（9083），日志 /tmp/metastore.log。</td></tr><tr><td>HBase</td><td>1.3.1</td><td>是</td><td>hbase.zookeeper.quorum 仅填主机名；三节点协同启动。</td></tr><tr><td>Spark</td><td>2.4.5 (without-hadoop, Scala 2.12)</td><td>是</td><td>作为依赖配置软链；未跑计算作业。</td></tr><tr><td>ZooKeeper</td><td>版本未记录（三节点）</td><td>是</td><td>各节点 zkServer.sh start。</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1026e620f8a64d92851fbdfe3cf5a0f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=7J7Ryn9uYG5Oz7R1DnTuTvJeSxo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-2">依赖环境</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1176ef6460a435e9ce995de4db96437~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=vc%2Fkk6KIdtLJ2fAVhHstMgrMASo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-3">集群规划</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/789a7aa5f7f94ca7a694f5a1a82457dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=D3z566Sg6EY2s%2F2BVhgmMB3JuA0%3D" alt="在这里插入图片描述" loading="lazy"/>
我这里就不根据上图来做了，因为我的服务器资源比较紧张，我就自由安排了。
需要注意：要求HBase的hbase.zookeeper.quorum值必须只能是 host1、host2这种，不允许host1:2181、host2:2181这种。</p>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/hbase-1.3.1/conf
vim hbase-site.xml
</code></pre>
<p>（之前HBase实验已经做过了，配置就是这样的）</p>
<p>保险起见，放一个截图：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72c9eee4ebca41338db053725670d94d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=xn0UFvatMZgC6rMvn8l%2Ft2jzEQA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-4">项目下载</h2>
<p>下载地址如下：</p>
<pre><code class="hljs language-shell" lang="shell">https://archive.apache.org/dist/kylin/
</code></pre>
<p>这里使用的是：</p>
<pre><code class="hljs language-shell" lang="shell">https://archive.apache.org/dist/kylin/apache-kylin-3.1.1/apache-kylin-3.1.1-bin-hbase1x.tar.gz
</code></pre>
<p>你可以通过wegt或者本地下载完传到服务器上，按照需求，我这里是上传到 h122 节点上</p>
<pre><code class="hljs language-shell" lang="shell">cd /opt/software
wget https://archive.apache.org/dist/kylin/apache-kylin-3.1.1/apache-kylin-3.1.1-bin-hbase1x.tar.gz
</code></pre>
<p>等待下载完毕
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cce3320d7b74ce09d49b200f517a541~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=1KcwoqTVohDXJcPA7anCGmsMMFQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-5">解压移动</h2>
<pre><code class="hljs language-shell" lang="shell">cd /opt/software
tar -zxvf apache-kylin-3.1.1-bin-hbase1x.tar.gz
</code></pre>
<p>运行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab9d95ae4c0845649dcf61ce2760904b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=yrp02lkT3IboaVlnxCeGjlKefsU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>接着将其移动到servers目录，方便后续的管理：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48c4c971634e492481c5aa408978bd1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=nQL6fiumB7kKP0wCK4Dte9rqhn4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-6">环境变量</h2>
<pre><code class="hljs language-shell" lang="shell">vim /etc/profile
</code></pre>
<p>我们需要加入Kylin的环境变量：（记得刷新环境变量）</p>
<pre><code class="hljs language-shell" lang="shell">export KYLIN_HOME=/opt/servers/apache-kylin-3.1.1-bin-hbase1x
export PATH=$PATH:$KYLIN_HOME/bin
</code></pre>
<p>配置环境变量如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52d2944ad4794c00b329a904a2e3850d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=%2FZspoTWW398TSkJSpj2bFMTuNKo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-7">依赖组件</h2>
<pre><code class="hljs language-shell" lang="shell">cd $KYLIN_HOME/conf
ln -s $HADOOP_HOME/etc/hadoop/hdfs-site.xml hdfs-site.xml
ln -s $HADOOP_HOME/etc/hadoop/core-site.xml core-site.xml
ln -s $HBASE_HOME/conf/hbase-site.xml hbase-site.xml
ln -s $HIVE_HOME/conf/hive-site.xml hive-site.xml
ln -s $SPARK_HOME/conf/spark-defaults.conf spark-defaults.conf
</code></pre>
<p>执行的结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdd0181f029d440aad07d2de6b9427ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=%2FHODV8rtDjacQfSK6PJYacG8kro%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-8">配置环境</h2>
<p>我们需要修改 kylin.sh</p>
<pre><code class="hljs language-shell" lang="shell">cd $KYLIN_HOME/bin
vim kylin.sh
<span class="hljs-meta prompt_">
# </span><span class="bash">需要写入这些依赖 防止后续报错</span>
export HADOOP_HOME=/opt/servers/hadoop-2.9.2
export HIVE_HOME=/opt/servers/apache-hive-2.3.9-bin
export HBASE_HOME=/opt/servers/hbase-1.3.1
export SPARK_HOME=/opt/servers/spark-2.4.5-bin-without-hadoop-scala-2.12

</code></pre>
<p>配置结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2afb4f8ff5e4957894ae1d0fdf7adb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=8Zm2q8XxEWnoko1dFftJyf3WWQs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-9">检查依赖</h2>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash">KYLIN_HOME/bin/check-env.sh</span>
</code></pre>
<p>我这里报错了，可能是之前的环境变量有问题：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fafede4e3c143f88d7a3b118cd93d59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=Sx8CNWTCQ7fzj13pV3a8lxa4oXw%3D" alt="在这里插入图片描述" loading="lazy"/>
我找了一圈，看到 Flink YARN 这里HADOOP_CONF_DIR可能配置错了：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">Flink YRAN</span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">export</span> HADOOP_CONF_DIR=<span class="hljs-variable">$HADOOP_HOME</span></span>
export HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop
export YARN_CONF_DIR=$HADOOP_HOME/etc/hadoop
export HADOOP_CLASSPATH=`hadoop classpath`
</code></pre>
<p>修改完的结果为如下：（这里我暂时注释了，防止我的FlinkYRAN以后不能用了）
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfa37adbd5fd4bb1b231eeca9b7ebc1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=WmNCPmbKH7mEboX7G3lbJ0skoog%3D" alt="在这里插入图片描述" loading="lazy"/>
重新进行测试环境，检查顺利通过，看里边还有一些和Flink、Kafka的配置等，你需要的话可以加入：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12e120f9be704d19a9bf17cf4f0f9925~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=vQxq2uqh21tWz493rOS8TqImmYs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-10">启动集群</h2>
<h3 data-id="heading-11">ZooKeeper</h3>
<p>启动 h121 h122 h123集群模式
需要每个节点都运行</p>
<pre><code class="hljs language-shell" lang="shell">zkServer.sh start
</code></pre>
<h3 data-id="heading-12">HDFS</h3>
<p>启动 h121 h122 h123
h121运行即可，但是要检查确认</p>
<pre><code class="hljs language-shell" lang="shell">start-dfs.sh
</code></pre>
<h3 data-id="heading-13">YRAN</h3>
<p>启动 h121 h122 h123
h121运行即可，但是要检查确认</p>
<pre><code class="hljs language-shell" lang="shell">start-yarn.sh
</code></pre>
<h3 data-id="heading-14">HBase</h3>
<p>启动 h121 h122 h123
h121运行即可，但是要检查确认</p>
<pre><code class="hljs language-shell" lang="shell">start-hbase.sh
</code></pre>
<h3 data-id="heading-15">Metastore</h3>
<p>启动 h121 即可</p>
<pre><code class="hljs language-shell" lang="shell">nohup hive --service metastore &gt; /tmp/metastore.log 2&gt;&amp;1 &amp;
</code></pre>
<p>运行结果如下图：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ffb7939bc3846a0acbc1d8b84843109~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=GUYZp4KuYQDK4KkwtHkd1P2ISq4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-16">history server</h3>
<p>启动 h121 即可</p>
<pre><code class="hljs language-shell" lang="shell">mr-jobhistory-daemon.sh start historyserver
</code></pre>
<h3 data-id="heading-17">Kylin</h3>
<p>启动 h122</p>
<pre><code class="hljs language-shell" lang="shell">kylin.sh start
</code></pre>
<p>运行过程如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d81ad5eb227743e6ad53b0a2b9394802~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=4qkGuuD2QA2h51Y6x49Jaiw%2FdCU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-18">节点详情</h2>
<h3 data-id="heading-19">h121</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fb8b908b45843a5925bd165d26e8b79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=PLl7ZoB5kNiMzTfj98wqdn7bbrg%3D" alt="在这里插入图片描述" loading="lazy"/>
与上图对应一下：</p>
<ul>
<li>Metastore</li>
<li>Zookeeper</li>
<li>HBase</li>
<li>HDFS</li>
<li>JPS跳过</li>
<li>YARN</li>
<li>Hadoop</li>
</ul>
<h3 data-id="heading-20">h122</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5466bd76a6184775961315842b107e10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=hhKbCnb%2F4Ipx7BLrgcVehF1YS9I%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ul>
<li>JPS跳过</li>
<li>YRAN</li>
<li>ZooKeeper</li>
<li>HBase</li>
<li>好像是Kylin</li>
<li>HDFS</li>
</ul>
<h3 data-id="heading-21">h123</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31eca846ce374e18b1bcd0d1bf68ecbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=Z2BjzHUcSKJNgs3FcRsvBpS4qug%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ul>
<li>YARN</li>
<li>JPS跳过</li>
<li>HBase</li>
<li>ZooKeeper</li>
<li>Hadoop</li>
<li>HDFS</li>
</ul>
<h2 data-id="heading-22">启动结果</h2>
<pre><code class="hljs language-shell" lang="shell">http://h122.wzk.icu:7070/kylin/login
</code></pre>
<p>我们访问之后可以看到如下的内容：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6aee09322c694bc786925d0f898c5513~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=wD6hWVq4fqO1pbDIbf%2BW8LRDvjM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-23">登录进入</h2>
<pre><code class="hljs language-shell" lang="shell">默认都是大写
账号 ADMIN
密码 KYLIN
</code></pre>
<p>登录进入之后，就是如下的结果：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbb21ebedce4477e95973ff719753e48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=Fto7G6Rt8AaieLOVPA8BdXVMV9Q%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-24">错误速查</h2>





















































<table><thead><tr><th>症状</th><th>根因定位</th><th>修复</th><th/></tr></thead><tbody><tr><td>check-env.sh 自检失败，提示找不到 Hadoop 配置</td><td>HADOOP_CONF_DIR 指向 $HADOOP_HOME 而非 .../etc/hadoop</td><td>运行自检脚本输出 <code>export HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop &amp;&amp; export YARN_CONF_DIR=$HADOOP_HOME/etc/hadoop &amp;&amp; export HADOOP_CLASSPATH=\</code>hadoop classpath`<code>后</code>source /etc/profile` 重新自检</td><td/></tr><tr><td>Kylin 启动后连接 HBase 报 ZK 相关异常</td><td>hbase.zookeeper.quorum 误写成 host1:2181,host2:2181</td><td>将 quorum 改为仅主机名（如 host1,host2），重启 HBase 与 Kylin</td><td/></tr><tr><td>访问 :7070 无响应/拒连</td><td>Kylin 未成功拉起；或防火墙/端口未放行</td><td>ps -ef</td><td>grep Kylin、netstat -lntp 检查服务状态与端口</td></tr><tr><td>各类 "No FileSystem for scheme: hdfs"/找不到配置</td><td>$KYLIN_HOME/conf 缺少软链到 Hadoop/HBase/Hive/Spark 配置目录</td><td>检查 $KYLIN_HOME/conf 依照文中命令补齐 core/hdfs/hbase/hive/spark 的软链并重启</td><td/></tr><tr><td>Hive Metastore 连接拒绝/NoSuchObjectException</td><td>未启动 Metastore 或 9083 被占用</td><td>检查 <code>/tmp/metastore.log</code>、`netstat -lntp</td><td>grep 9083`</td></tr><tr><td>登录失败/账号密码不对</td><td>账号密码大小写错误或自定义覆盖</td><td>使用默认大写 ADMIN/KYLIN；如改过，在 conf 内确认账号策略并重置</td><td/></tr><tr><td>启动时报 JDK 版本不兼容（常见于旧栈）</td><td>使用了非 JDK8</td><td>切换至 JDK8 并确保 JAVA_HOME 与 PATH 指向一致</td><td/></tr></tbody></table>
<h2 data-id="heading-25">其他系列</h2>
<h3 data-id="heading-26">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-127 Qwen2.5-Omni 深解：Thinker-Talker 双核、TMRoPE 与流式语音</strong></p>
<h3 data-id="heading-27">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-174 FastFDS 从单机到分布式文件存储：实战与架构取舍</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 正在更新，深入浅出助你打牢基础！</p>
<h3 data-id="heading-28">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C#运算符与表达式终极指南：从入门到精通的万字长文]]></title>    <link>https://juejin.cn/post/7574529034647289908</link>    <guid>https://juejin.cn/post/7574529034647289908</guid>    <pubDate>2025-11-20T01:55:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574529034647289908" data-draft-id="7573670400153092148" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C#运算符与表达式终极指南：从入门到精通的万字长文"/> <meta itemprop="keywords" content="前端,C#"/> <meta itemprop="datePublished" content="2025-11-20T01:55:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烛阴"/> <meta itemprop="url" content="https://juejin.cn/user/950397795841032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C#运算符与表达式终极指南：从入门到精通的万字长文
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/950397795841032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烛阴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T01:55:39.000Z" title="Thu Nov 20 2025 01:55:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、什么是运算符与表达式？</h2>
<ul>
<li><strong>运算符（Operator）</strong>：是一种特殊的符号，用于执行特定的数学、逻辑或位运算。例如 <code>+</code> 是加法运算符，<code>==</code> 是相等运算符。</li>
<li><strong>操作数（Operand）</strong>：是参与运算的数据。例如，在 <code>5 + 3</code> 中，<code>5</code> 和 <code>3</code> 就是操作数。</li>
<li><strong>表达式（Expression）</strong>：是由操作数和运算符组成的序列，其计算结果会产生一个新值。例如 <code>5 + 3</code> 是一个表达式，它的计算结果是 <code>8</code>。<code>x &gt; y</code> 也是一个表达式，它的计算结果是 <code>true</code> 或 <code>false</code>。</li>
</ul>
<p><strong>表达式是C#程序的基本执行单元。</strong> 理解它们，就是理解程序如何思考。</p>
<hr/>
<h2 data-id="heading-1">二、基础运算符</h2>
<h3 data-id="heading-2">1. 算术运算符</h3>
<p>它们负责处理基本的数学计算，与你在小学数学课上学到的几乎一样。</p>









































<table><thead><tr><th align="center">运算符</th><th align="center">名称</th><th align="left">示例</th><th align="left">结果</th></tr></thead><tbody><tr><td align="center"><code>+</code></td><td align="center">加法</td><td align="left"><code>10 + 5</code></td><td align="left"><code>15</code></td></tr><tr><td align="center"><code>-</code></td><td align="center">减法</td><td align="left"><code>10 - 5</code></td><td align="left"><code>5</code></td></tr><tr><td align="center"><code>*</code></td><td align="center">乘法</td><td align="left"><code>10 * 5</code></td><td align="left"><code>50</code></td></tr><tr><td align="center"><code>/</code></td><td align="center">除法</td><td align="left"><code>10 / 5</code></td><td align="left"><code>2</code></td></tr><tr><td align="center"><code>%</code></td><td align="center">取模 (求余数)</td><td align="left"><code>10 % 3</code></td><td align="left"><code>1</code></td></tr></tbody></table>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span> a = <span class="hljs-number">10</span>;
<span class="hljs-built_in">int</span> b = <span class="hljs-number">3</span>;

Console.WriteLine(<span class="hljs-string">$"加法: <span class="hljs-subst">{a + b}</span>"</span>);       <span class="hljs-comment">// 输出: 13</span>
Console.WriteLine(<span class="hljs-string">$"减法: <span class="hljs-subst">{a - b}</span>"</span>);       <span class="hljs-comment">// 输出: 7</span>
Console.WriteLine(<span class="hljs-string">$"乘法: <span class="hljs-subst">{a * b}</span>"</span>);       <span class="hljs-comment">// 输出: 30</span>
Console.WriteLine(<span class="hljs-string">$"除法: <span class="hljs-subst">{a / b}</span>"</span>);       <span class="hljs-comment">// 输出: 3 (注意：整数除法)</span>
Console.WriteLine(<span class="hljs-string">$"取模: <span class="hljs-subst">{a % b}</span>"</span>);       <span class="hljs-comment">// 输出: 1</span>
</code></pre>
<blockquote>
<p><strong>注意事项：整数除法</strong></p>
<p>当两个整数相除时，结果也是一个整数，小数部分会被直接<strong>截断</strong>（不是四舍五入）。例如 <code>10 / 3</code> 的结果是 <code>3</code>。如果你想得到精确的小数结果，至少要有一个操作数是浮点类型。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">double</span> result = <span class="hljs-number">10.0</span> / <span class="hljs-number">3</span>; <span class="hljs-comment">// 结果是 3.333...</span>
<span class="hljs-built_in">double</span> result2 = (<span class="hljs-built_in">double</span>)<span class="hljs-number">10</span> / <span class="hljs-number">3</span>; <span class="hljs-comment">// 结果也是 3.333...</span>
</code></pre>
</blockquote>
<h3 data-id="heading-3">2. 赋值运算符</h3>
<p>赋值运算符用于给变量分配一个值。最基本的是 <code>=</code>，但C#提供了一系列复合赋值运算符，让代码更简洁。</p>








































<table><thead><tr><th align="center">运算符</th><th align="center">示例</th><th align="center">等价于</th></tr></thead><tbody><tr><td align="center"><code>=</code></td><td align="center"><code>x = 5</code></td><td align="center"><code>x = 5</code></td></tr><tr><td align="center"><code>+=</code></td><td align="center"><code>x += 5</code></td><td align="center"><code>x = x + 5</code></td></tr><tr><td align="center"><code>-=</code></td><td align="center"><code>x -= 5</code></td><td align="center"><code>x = x - 5</code></td></tr><tr><td align="center"><code>*=</code></td><td align="center"><code>x *= 5</code></td><td align="center"><code>x = x * 5</code></td></tr><tr><td align="center"><code>/=</code></td><td align="center"><code>x /= 5</code></td><td align="center"><code>x = x / 5</code></td></tr><tr><td align="center"><code>%=</code></td><td align="center"><code>x %= 5</code></td><td align="center"><code>x = x % 5</code></td></tr></tbody></table>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span> score = <span class="hljs-number">100</span>;
score += <span class="hljs-number">10</span>; <span class="hljs-comment">// score 现在是 110</span>
score -= <span class="hljs-number">20</span>; <span class="hljs-comment">// score 现在是 90</span>
score *= <span class="hljs-number">2</span>;  <span class="hljs-comment">// score 现在是 180</span>
score /= <span class="hljs-number">3</span>;  <span class="hljs-comment">// score 现在是 60</span>
</code></pre>
<p>使用复合赋值运算符不仅代码更短，而且可读性更好，是专业代码的标志之一。</p>
<h3 data-id="heading-4">3. 一元运算符</h3>
<p>这些运算符只需要一个操作数。</p>



































<table><thead><tr><th align="center">运算符</th><th align="center">名称</th><th align="left">示例</th><th align="left">描述</th></tr></thead><tbody><tr><td align="center"><code>+</code></td><td align="center">正号</td><td align="left"><code>+5</code></td><td align="left">表示一个正数 (通常省略)</td></tr><tr><td align="center"><code>-</code></td><td align="center">负号</td><td align="left"><code>-5</code></td><td align="left">表示一个负数 (取反)</td></tr><tr><td align="center"><code>++</code></td><td align="center">递增</td><td align="left"><code>x++</code> 或 <code>++x</code></td><td align="left">将变量的值加1</td></tr><tr><td align="center"><code>--</code></td><td align="center">递减</td><td align="left"><code>x--</code> 或 <code>--x</code></td><td align="left">将变量的值减1</td></tr></tbody></table>
<p><code>++</code> 和 <code>--</code> 有两种形式：<strong>前缀</strong>和<strong>后缀</strong>，它们的区别在于<strong>表达式求值的时机</strong>。</p>
<ul>
<li><strong>前缀 (Prefix) <code>++x</code></strong>: 先将 <code>x</code> 的值加1，然后返回<strong>加1后</strong>的值。</li>
<li><strong>后缀 (Postfix) <code>x++</code></strong>: 先返回 <code>x</code> 的<strong>原始值</strong>，然后再将 <code>x</code> 的值加1。</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span> i = <span class="hljs-number">5</span>;
<span class="hljs-built_in">int</span> j = <span class="hljs-number">5</span>;

<span class="hljs-comment">// 前缀：先自增，再赋值</span>
<span class="hljs-built_in">int</span> prefixResult = ++i; <span class="hljs-comment">// i 变成 6, prefixResult 也被赋值为 6</span>
Console.WriteLine(<span class="hljs-string">$"i: <span class="hljs-subst">{i}</span>, prefixResult: <span class="hljs-subst">{prefixResult}</span>"</span>); <span class="hljs-comment">// 输出: i: 6, prefixResult: 6</span>

<span class="hljs-comment">// 后缀：先赋值，再自增</span>
<span class="hljs-built_in">int</span> postfixResult = j++; <span class="hljs-comment">// postfixResult 被赋值为 5, 然后 j 变成 6</span>
Console.WriteLine(<span class="hljs-string">$"j: <span class="hljs-subst">{j}</span>, postfixResult: <span class="hljs-subst">{postfixResult}</span>"</span>); <span class="hljs-comment">// 输出: j: 6, postfixResult: 5</span>
</code></pre>
<hr/>
<h2 data-id="heading-5">三、逻辑与比较</h2>
<h3 data-id="heading-6">1. 关系运算符</h3>
<p>也叫比较运算符，用于比较两个操作数，其结果总是一个布尔值 (<code>true</code> 或 <code>false</code>)。</p>















































<table><thead><tr><th align="center">运算符</th><th align="center">名称</th><th align="left">示例</th><th align="center">结果为<code>true</code>的条件</th></tr></thead><tbody><tr><td align="center"><code>==</code></td><td align="center">等于</td><td align="left"><code>a == b</code></td><td align="center">a 和 b 的值相等</td></tr><tr><td align="center"><code>!=</code></td><td align="center">不等于</td><td align="left"><code>a != b</code></td><td align="center">a 和 b 的值不相等</td></tr><tr><td align="center"><code>&gt;</code></td><td align="center">大于</td><td align="left"><code>a &gt; b</code></td><td align="center">a 的值大于 b</td></tr><tr><td align="center"><code>&lt;</code></td><td align="center">小于</td><td align="left"><code>a &lt; b</code></td><td align="center">a 的值小于 b</td></tr><tr><td align="center"><code>&gt;=</code></td><td align="center">大于等于</td><td align="left"><code>a &gt;= b</code></td><td align="center">a 的值大于或等于 b</td></tr><tr><td align="center"><code>&lt;=</code></td><td align="center">小于等于</td><td align="left"><code>a &lt;= b</code></td><td align="center">a 的值小于或等于 b</td></tr></tbody></table>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span> age = <span class="hljs-number">20</span>;
<span class="hljs-built_in">bool</span> isAdult = age &gt;= <span class="hljs-number">18</span>; <span class="hljs-comment">// isAdult 的值为 true</span>
<span class="hljs-built_in">bool</span> isVoter = age == <span class="hljs-number">21</span>; <span class="hljs-comment">// isVoter 的值为 false</span>
</code></pre>
<p>这些运算符是 <code>if</code> 语句、<code>while</code> 循环等所有控制流语句的核心。</p>
<h3 data-id="heading-7">2. 逻辑运算符</h3>
<p>用于组合多个布尔表达式，构建更复杂的判断逻辑。</p>

































<table><thead><tr><th align="center">运算符</th><th align="center">名称</th><th align="center">示例</th><th align="left">描述</th></tr></thead><tbody><tr><td align="center"><code>!</code></td><td align="center">逻辑非 (NOT)</td><td align="center"><code>!isValid</code></td><td align="left">如果操作数为<code>true</code>，结果为<code>false</code>；反之亦然</td></tr><tr><td align="center"><code>&amp;&amp;</code></td><td align="center">逻辑与 (AND)</td><td align="center"><code>isLogin &amp;&amp; isAdmin</code></td><td align="left">两个操作数都为<code>true</code>时，结果才为<code>true</code></td></tr><tr><td align="center">`</td><td align="center"/><td align="center">`</td><td align="left">逻辑或 (OR)</td><td>`isMember</td><td/><td>isVIP`</td><td>只要有一个操作数为<code>true</code>，结果就为<code>true</code></td></tr></tbody></table>
<p><strong>短路求值 (Short-circuiting)</strong></p>
<p><code>&amp;&amp;</code> 和 <code>||</code> 有一个非常重要的特性叫“短路”。</p>
<ul>
<li>对于 <code>expr1 &amp;&amp; expr2</code>：如果 <code>expr1</code> 的计算结果为 <code>false</code>，那么整个表达式的结果必定是 <code>false</code>，此时 <code>expr2</code> <strong>将不会被计算</strong>。</li>
<li>对于 <code>expr1 || expr2</code>：如果 <code>expr1</code> 的计算结果为 <code>true</code>，那么整个表达式的结果必定是 <code>true</code>，此时 <code>expr2</code> <strong>将不会被计算</strong>。</li>
</ul>
<p>这个特性非常有用，常用于避免空引用异常或减少不必要的计算：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> name = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// 如果不使用短路，当 name 为 null 时，name.Length 会抛出 NullReferenceException</span>
<span class="hljs-comment">// if (name != null &amp; name.Length &gt; 0) { ... }  // 注意这里是 &amp;，非短路</span>

<span class="hljs-comment">// 使用短路 &amp;&amp;，当 name 为 null 时，第一个条件为 false，第二个条件根本不会执行，非常安全</span>
<span class="hljs-keyword">if</span> (name != <span class="hljs-literal">null</span> &amp;&amp; name.Length &gt; <span class="hljs-number">0</span>)
{
    Console.WriteLine(<span class="hljs-string">"Name is not empty."</span>);
}
</code></pre>
<hr/>
<h2 data-id="heading-8">四、位运算符</h2>









































<table><thead><tr><th align="center">运算符</th><th align="center">名称</th><th align="left">描述</th></tr></thead><tbody><tr><td align="center"><code>&amp;</code></td><td align="center">按位与</td><td align="left">两个操作数中，对应位都为1时，结果位才为1</td></tr><tr><td align="center">`</td><td align="center">`</td><td align="left">按位或</td><td>两个操作数中，对应位只要有一个为1，结果位就为1</td></tr><tr><td align="center"><code>^</code></td><td align="center">按位异或</td><td align="left">两个操作数中，对应位不同时，结果位为1</td></tr><tr><td align="center"><code>~</code></td><td align="center">按位取反</td><td align="left">单目运算符，将操作数的所有位反转 (0变1，1变0)</td></tr><tr><td align="center"><code>&lt;&lt;</code></td><td align="center">左移</td><td align="left">将操作数的所有位向左移动指定的位数，右侧补0</td></tr><tr><td align="center"><code>&gt;&gt;</code></td><td align="center">右移</td><td align="left">将操作数的所有位向右移动指定的位数</td></tr></tbody></table>
<p><strong>应用场景：权限管理</strong>
枚举经常与位运算符结合，用于管理一组开关状态（Flags）。</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">Flags</span>]
<span class="hljs-keyword">public</span> <span class="hljs-built_in">enum</span> Permissions
{
    None = <span class="hljs-number">0</span>,       <span class="hljs-comment">// 0000</span>
    Read = <span class="hljs-number">1</span>,       <span class="hljs-comment">// 0001</span>
    Write = <span class="hljs-number">2</span>,      <span class="hljs-comment">// 0010</span>
    Execute = <span class="hljs-number">4</span>,    <span class="hljs-comment">// 0100</span>
    All = Read | Write | Execute <span class="hljs-comment">// 0111</span>
}

Permissions userPermissions = Permissions.Read | Permissions.Write;

<span class="hljs-comment">// 检查是否包含写权限</span>
<span class="hljs-keyword">if</span> ((userPermissions &amp; Permissions.Write) == Permissions.Write)
{
    Console.WriteLine(<span class="hljs-string">"User has Write permission."</span>);
}

<span class="hljs-comment">// 添加执行权限</span>
userPermissions |= Permissions.Execute;

<span class="hljs-comment">// 移除写权限</span>
userPermissions &amp;= ~Permissions.Write;
</code></pre>
<hr/>
<h2 data-id="heading-9">五、那些强大的“语法糖”</h2>
<p>随着C#语言的演进，出现了许多新的运算符，它们极大地简化了代码，使其更具表现力和健壮性。</p>
<h3 data-id="heading-10">1. Null 合并运算符 (<code>??</code> 和 <code>??=</code>)</h3>
<p>用于处理 <code>null</code> 值的利器。</p>
<ul>
<li><strong><code>??</code> (Null-Coalescing Operator)</strong>: <code>a ?? b</code>
如果 <code>a</code> 不为 <code>null</code>，则表达式的结果是 <code>a</code>；如果 <code>a</code> 为 <code>null</code>，则结果是 <code>b</code>。</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> userName = <span class="hljs-literal">null</span>;
<span class="hljs-built_in">string</span> displayName = userName ?? <span class="hljs-string">"Guest"</span>; <span class="hljs-comment">// displayName 的值将是 "Guest"</span>

<span class="hljs-built_in">string</span> userName2 = <span class="hljs-string">"Admin"</span>;
<span class="hljs-built_in">string</span> displayName2 = userName2 ?? <span class="hljs-string">"Guest"</span>; <span class="hljs-comment">// displayName2 的值将是 "Admin"</span>
</code></pre>
<p>这完美地替代了冗长的 <code>if</code> 或三元表达式 <code>(userName != null) ? userName : "Guest"</code>。</p>
<ul>
<li><strong><code>??=</code> (Null-Coalescing Assignment Operator)</strong> (C# 8.0+)
<code>variable ??= value</code>
仅当 <code>variable</code> 为 <code>null</code> 时，才将 <code>value</code> 赋给 <code>variable</code>。</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">List&lt;<span class="hljs-built_in">int</span>&gt; numbers = <span class="hljs-literal">null</span>;
numbers ??= <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt;(); <span class="hljs-comment">// 因为 numbers 是 null，所以为其创建一个新实例</span>

numbers.Add(<span class="hljs-number">1</span>);

numbers ??= <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt;(); <span class="hljs-comment">// 因为 numbers 不再是 null，所以这条语句什么也不做</span>
</code></pre>
<p>这对于延迟初始化（Lazy Initialization）非常有用。</p>
<h3 data-id="heading-11">2. Null 条件运算符 (<code>?.</code> 和 <code>?[]</code>)</h3>
<p>用于优雅地避免 <code>NullReferenceException</code>，告别层层嵌套的 <code>if (obj != null)</code> 检查。</p>
<ul>
<li><strong><code>?.</code> (Null-Conditional Member Access)</strong>:
在访问对象成员（方法或属性）之前，检查对象是否为 <code>null</code>。如果是 <code>null</code>，整个表达式直接返回 <code>null</code>，而不会抛出异常。</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> street = <span class="hljs-string">""</span>;

User user = <span class="hljs-literal">null</span>; <span class="hljs-comment">// GetUser();</span>


<span class="hljs-comment">// 传统方式，需要层层检查</span>
<span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>)
{
    <span class="hljs-keyword">if</span> (user.UserAddress != <span class="hljs-literal">null</span>)
    {
        street = user.UserAddress.Street;
    }
}

<span class="hljs-comment">// 使用 ?. 运算符，一行搞定！</span>
<span class="hljs-comment">// 如果 user 或 user.UserAddress 是 null，street 将被赋值为 null</span>
<span class="hljs-built_in">string</span> streetElegant = user?.UserAddress?.Street;


<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">User</span> { <span class="hljs-keyword">public</span> Address UserAddress { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } }
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Address</span> { <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Street { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } }
</code></pre>
<ul>
<li><strong><code>?[]</code> (Null-Conditional Element Access)</strong>:
用于访问数组或索引器。</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">List&lt;<span class="hljs-built_in">string</span>&gt; names = <span class="hljs-literal">null</span>;
<span class="hljs-built_in">string</span> firstName = names?[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 如果 names 为 null，firstName 为 null，不抛异常</span>
</code></pre>
<h3 data-id="heading-12">3. 条件运算符 (<code>?:</code>) - 三元表达式</h3>
<p>它是 <code>if-else</code> 语句的紧凑形式，适用于简单的条件赋值。</p>
<p><strong>语法</strong>: <code>condition ? first_expression : second_expression;</code>
如果 <code>condition</code> 为 <code>true</code>，则计算 <code>first_expression</code> 并将其作为结果；否则计算 <code>second_expression</code>。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span> age = <span class="hljs-number">20</span>;
<span class="hljs-built_in">string</span> status = (age &gt;= <span class="hljs-number">18</span>) ? <span class="hljs-string">"Adult"</span> : <span class="hljs-string">"Minor"</span>; <span class="hljs-comment">// status 的值为 "Adult"</span>
</code></pre>
<h3 data-id="heading-13">4. 类型相关运算符</h3>






























<table><thead><tr><th align="center">运算符</th><th align="center">名称</th><th align="left">描述</th></tr></thead><tbody><tr><td align="center"><code>is</code></td><td align="center">类型判断</td><td align="left">检查对象是否与给定类型兼容，返回布尔值。C# 7.0+支持模式匹配。</td></tr><tr><td align="center"><code>as</code></td><td align="center">类型转换</td><td align="left">尝试将对象转换为指定类型，如果转换失败，返回<code>null</code>而不是抛出异常。</td></tr><tr><td align="center"><code>typeof</code></td><td align="center">获取类型</td><td align="left">返回一个表示类型的 <code>System.Type</code> 对象。</td></tr><tr><td align="center"><code>sizeof</code></td><td align="center">获取大小</td><td align="left">（仅限非托管类型）返回给定类型值在内存中占用的字节数。</td></tr></tbody></table>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">object</span> obj = <span class="hljs-string">"Hello World"</span>;

<span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> <span class="hljs-built_in">string</span>)
{
    Console.WriteLine(<span class="hljs-string">"It's a string."</span>);
}

<span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> <span class="hljs-built_in">string</span> s) <span class="hljs-comment">// 如果是string，则直接转换并赋值给 s</span>
{
    Console.WriteLine(<span class="hljs-string">$"The string has <span class="hljs-subst">{s.Length}</span> characters."</span>);
}

<span class="hljs-built_in">string</span> str = obj <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 转换成功，str 为 "Hello World"</span>
StringBuilder sb = obj <span class="hljs-keyword">as</span> StringBuilder; <span class="hljs-comment">// 转换失败，sb 为 null</span>
</code></pre>
<hr/>
<h2 data-id="heading-14">六、运算符的规则 - 优先级与结合性</h2>
<p>当一个表达式中包含多个运算符时，谁先计算？这就是**优先级（Precedence）<strong>和</strong>结合性（Associativity）**要解决的问题。</p>
<ul>
<li><strong>优先级</strong>：决定了不同运算符的计算顺序。例如，<code>*</code> 和 <code>/</code> 的优先级高于 <code>+</code> 和 <code>-</code>，所以 <code>2 + 3 * 4</code> 的结果是 <code>14</code> 而不是 <code>20</code>。</li>
<li><strong>结合性</strong>：当多个具有相同优先级的运算符在一起时，决定它们的计算方向。
<ul>
<li><strong>左结合性 (Left-associative)</strong>：从左到右计算。例如 <code>a - b - c</code> 等价于 <code>(a - b) - c</code>。大多数二元运算符都是左结合的。</li>
<li><strong>右结合性 (Right-associative)</strong>：从右到左计算。例如赋值运算符 <code>a = b = c</code> 等价于 <code>a = (b = c)</code>。三元运算符也是右结合的。</li>
</ul>
</li>
</ul>
<p><strong>C#运算符优先级（由高到低摘录）</strong></p>
<ol>
<li><strong>主要</strong>: <code>x.y</code>, <code>f(x)</code>, <code>a[i]</code>, <code>x++</code>, <code>x--</code>, <code>new</code>, <code>typeof</code>, <code>sizeof</code></li>
<li><strong>一元</strong>: <code>+</code>, <code>-</code>, <code>!</code>, <code>~</code>, <code>++x</code>, <code>--x</code>, <code>(T)x</code></li>
<li><strong>乘法</strong>: <code>*</code>, <code>/</code>, <code>%</code></li>
<li><strong>加法</strong>: <code>+</code>, <code>-</code></li>
<li><strong>移位</strong>: <code>&lt;&lt;</code>, <code>&gt;&gt;</code></li>
<li><strong>关系</strong>: <code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>, <code>&gt;=</code>, <code>is</code>, <code>as</code></li>
<li><strong>相等</strong>: <code>==</code>, <code>!=</code></li>
<li><strong>位与</strong>: <code>&amp;</code></li>
<li><strong>位异或</strong>: <code>^</code></li>
<li><strong>位或</strong>: <code>|</code></li>
<li><strong>逻辑与</strong>: <code>&amp;&amp;</code></li>
<li><strong>逻辑或</strong>: <code>||</code></li>
<li><strong>Null合并</strong>: <code>??</code></li>
<li><strong>条件</strong>: <code>?:</code></li>
<li><strong>赋值与Lambda</strong>: <code>=</code>, <code>*=</code>, <code>/=</code>, <code>+=</code>, <code>-=</code>, <code>=&gt;</code></li>
</ol>
<h2 data-id="heading-15">结语</h2>
<p><strong>点个赞，关注我获取更多实用 C# 技术干货！如果觉得有用，记得收藏本文！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让弹幕飞一会儿！一个轻量级iOS弹幕库的实现与使用]]></title>    <link>https://juejin.cn/post/7574253222606897193</link>    <guid>https://juejin.cn/post/7574253222606897193</guid>    <pubDate>2025-11-19T11:15:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574253222606897193" data-draft-id="7574281453706985478" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让弹幕飞一会儿！一个轻量级iOS弹幕库的实现与使用"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-19T11:15:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarkCoder"/> <meta itemprop="url" content="https://juejin.cn/user/207173399875662"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让弹幕飞一会儿！一个轻量级iOS弹幕库的实现与使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/207173399875662/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarkCoder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T11:15:49.000Z" title="Wed Nov 19 2025 11:15:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀 让弹幕飞一会儿！一个轻量级iOS弹幕库的实现与使用</h2>
<blockquote>
<p>本文完整源码地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchengshixin%2FBarrageView" target="_blank" title="https://github.com/chengshixin/BarrageView" ref="nofollow noopener noreferrer">github.com/chengshixin…</a></p>
</blockquote>
<h3 data-id="heading-1">🎯 前言</h3>
<p>"前方高能！"、"233333"、"awsl"... 这些熟悉的弹幕是不是让你想起了在B站追番的快乐时光？弹幕已经成为现代视频应用的标配功能，它不仅能够增强用户互动，还能创造独特的社区氛围。</p>
<p>今天，我要为大家介绍一个我自己开发的轻量级iOS弹幕库——<strong>BarrageView</strong>！这个库不仅功能丰富，而且代码优雅，绝对是你在iOS应用中集成弹幕功能的不二之选！</p>
<h3 data-id="heading-2">✨ 功能特色</h3>
<h4 data-id="heading-3">🎮 四大弹幕方向</h4>
<ul>
<li><strong>从右到左</strong>：经典模式，B站同款</li>
<li><strong>从左到右</strong>：反向思维，别具一格</li>
<li><strong>从上到下</strong>：竖屏专属，瀑布流效果</li>
<li><strong>从下到上</strong>：逆流而上，视觉冲击</li>
</ul>
<h4 data-id="heading-4">🔄 两种播放模式</h4>
<ul>
<li><strong>单次播放</strong>：适合展示重要信息</li>
<li><strong>循环播放</strong>：营造持续的热闹氛围</li>
</ul>
<h4 data-id="heading-5">🎨 全面自定义</h4>
<ul>
<li>字体大小、颜色随心配</li>
<li>背景透明度自由调节</li>
<li>移动速度精准控制</li>
<li>弹幕间距智能避让</li>
</ul>
<h3 data-id="heading-6">🛠 快速上手</h3>
<h4 data-id="heading-7">基本使用</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 创建弹幕视图</span>
<span class="hljs-keyword">let</span> barrageView <span class="hljs-operator">=</span> <span class="hljs-type">BarrageView</span>(frame: <span class="hljs-type">CGRect</span>(x: <span class="hljs-number">0</span>, y: <span class="hljs-number">100</span>, width: view.bounds.width, height: <span class="hljs-number">200</span>))

<span class="hljs-comment">// 设置弹幕数据</span>
barrageView.setBarrageData([
    <span class="hljs-string">"前方高能预警！"</span>,
    <span class="hljs-string">"这个功能太棒了！"</span>,
    <span class="hljs-string">"iOS开发者福音"</span>,
    <span class="hljs-string">"已star，感谢作者"</span>
])

<span class="hljs-comment">// 开始播放</span>
barrageView.startBarrage()
</code></pre>
<h4 data-id="heading-8">高级配置</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 自定义样式和效果</span>
barrageView.setDirection(.rightToLeft)
barrageView.setPlayMode(.loop)
barrageView.setSpeed(<span class="hljs-number">80.0</span>)
barrageView.setFontSize(<span class="hljs-number">18.0</span>)
barrageView.setTextColor(.red)
barrageView.setTextBackgroundColor(<span class="hljs-type">UIColor</span>.black.withAlphaComponent(<span class="hljs-number">0.8</span>))
</code></pre>
<h3 data-id="heading-9">🔧 核心实现原理</h3>
<h4 data-id="heading-10">🎪 弹幕调度机制</h4>
<p>BarrageView采用<strong>定时器+动画</strong>的双重调度机制：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 定时器负责生成新弹幕</span>
timer <span class="hljs-operator">=</span> <span class="hljs-type">Timer</span>.scheduledTimer(withTimeInterval: <span class="hljs-number">2.0</span>, repeats: <span class="hljs-literal">true</span>) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.createBarrageLabel()
}

<span class="hljs-comment">// UIView动画负责移动效果</span>
<span class="hljs-type">UIView</span>.animate(withDuration: duration, delay: <span class="hljs-number">0</span>, options: .curveLinear) {
    label.frame.origin <span class="hljs-operator">=</span> endPoint
}
</code></pre>
<h4 data-id="heading-11">🚦 智能避让算法</h4>
<p>为了防止弹幕重叠，我们实现了智能的位置检测：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">isYPositionOccupied</span>(<span class="hljs-params">y</span>: <span class="hljs-type">CGFloat</span>, <span class="hljs-params">labelHeight</span>: <span class="hljs-type">CGFloat</span>) -&gt; <span class="hljs-type">Bool</span> {
    <span class="hljs-keyword">for</span> label <span class="hljs-keyword">in</span> activeLabels {
        <span class="hljs-keyword">let</span> labelMinY <span class="hljs-operator">=</span> label.frame.minY <span class="hljs-operator">-</span> <span class="hljs-number">10</span>  <span class="hljs-comment">// 预留安全间距</span>
        <span class="hljs-keyword">let</span> labelMaxY <span class="hljs-operator">=</span> label.frame.maxY <span class="hljs-operator">+</span> <span class="hljs-number">10</span>
        
        <span class="hljs-keyword">if</span> y <span class="hljs-operator">&gt;</span> labelMinY <span class="hljs-operator">&amp;&amp;</span> y <span class="hljs-operator">&lt;</span> labelMaxY {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>  <span class="hljs-comment">// 位置被占用</span>
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>  <span class="hljs-comment">// 位置可用</span>
}
</code></pre>
<h4 data-id="heading-12">⏸️ 流畅的暂停恢复</h4>
<p>通过CALayer扩展实现精准的动画控制：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">CALayer</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">pauseAnimation</span>() {
        <span class="hljs-keyword">let</span> pausedTime <span class="hljs-operator">=</span> convertTime(<span class="hljs-type">CACurrentMediaTime</span>(), from: <span class="hljs-literal">nil</span>)
        speed <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>
        timeOffset <span class="hljs-operator">=</span> pausedTime
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">resumeAnimation</span>() {
        <span class="hljs-keyword">let</span> pausedTime <span class="hljs-operator">=</span> timeOffset
        speed <span class="hljs-operator">=</span> <span class="hljs-number">1.0</span>
        timeOffset <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>
        beginTime <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>
        <span class="hljs-keyword">let</span> timeSincePause <span class="hljs-operator">=</span> convertTime(<span class="hljs-type">CACurrentMediaTime</span>(), from: <span class="hljs-literal">nil</span>) <span class="hljs-operator">-</span> pausedTime
        beginTime <span class="hljs-operator">=</span> timeSincePause
    }
}
</code></pre>
<h3 data-id="heading-13">🎨 自定义扩展指南</h3>
<h4 data-id="heading-14">添加弹幕边框</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 在createLabel方法中扩展</span>
label.layer.borderWidth <span class="hljs-operator">=</span> <span class="hljs-number">1.0</span>
label.layer.borderColor <span class="hljs-operator">=</span> <span class="hljs-type">UIColor</span>.orange.cgColor
</code></pre>
<h4 data-id="heading-15">实现渐变背景</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> gradientLayer <span class="hljs-operator">=</span> <span class="hljs-type">CAGradientLayer</span>()
gradientLayer.colors <span class="hljs-operator">=</span> [<span class="hljs-type">UIColor</span>.red.cgColor, <span class="hljs-type">UIColor</span>.blue.cgColor]
gradientLayer.frame <span class="hljs-operator">=</span> label.bounds
label.layer.insertSublayer(gradientLayer, at: <span class="hljs-number">0</span>)
</code></pre>
<h4 data-id="heading-16">添加弹幕阴影</h4>
<pre><code class="hljs language-swift" lang="swift">label.layer.shadowColor <span class="hljs-operator">=</span> <span class="hljs-type">UIColor</span>.black.cgColor
label.layer.shadowOffset <span class="hljs-operator">=</span> <span class="hljs-type">CGSize</span>(width: <span class="hljs-number">2</span>, height: <span class="hljs-number">2</span>)
label.layer.shadowOpacity <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span>
</code></pre>
<h3 data-id="heading-17">📱 实际应用场景</h3>
<h4 data-id="heading-18">🎥 视频播放器</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 在视频播放时启动弹幕</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">videoDidStartPlaying</span>() {
    barrageView.startBarrage()
}

<span class="hljs-keyword">func</span> <span class="hljs-title function_">videoDidPause</span>() {
    barrageView.pauseBarrage()
}

<span class="hljs-keyword">func</span> <span class="hljs-title function_">videoDidResume</span>() {
    barrageView.resumeBarrage()
}
</code></pre>
<h4 data-id="heading-19">🎮 直播互动</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 收到新消息时实时添加弹幕</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">didReceiveNewMessage</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">message</span>: <span class="hljs-type">String</span>) {
    <span class="hljs-keyword">var</span> currentData <span class="hljs-operator">=</span> barrageView.barrageTexts
    currentData.append(message)
    barrageView.setBarrageData(currentData)
}
</code></pre>
<h4 data-id="heading-20">🎉 活动庆典</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 节日特效弹幕</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">setupFestivalBarrage</span>() {
    barrageView.setTextColor(.red)
    barrageView.setFontSize(<span class="hljs-number">20</span>)
    barrageView.setBarrageData(festivalWishes)
}
</code></pre>
<h3 data-id="heading-21">🚀 性能优化技巧</h3>
<h4 data-id="heading-22">内存管理</h4>
<ul>
<li>使用<code>weak self</code>避免循环引用</li>
<li>及时移除完成动画的标签</li>
<li>合理控制同时显示的弹幕数量</li>
</ul>
<h4 data-id="heading-23">动画优化</h4>
<ul>
<li>使用<code>curveLinear</code>保证匀速运动</li>
<li>避免频繁创建销毁对象</li>
<li>复用UILabel减少内存分配</li>
</ul>
<h3 data-id="heading-24">🔮 未来规划</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 支持富文本弹幕</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 添加弹幕点击事件</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 实现3D弹幕效果</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 支持弹幕轨道管理</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 添加弹幕过滤机制</li>
</ul>
<h3 data-id="heading-25">💫 结语</h3>
<p>BarrageView不仅仅是一个工具库，更是我对iOS动画和用户体验的一次深度探索。通过这个项目，我学习到了：</p>
<ul>
<li>🎯 <strong>精准的动画控制</strong>：如何让弹幕平滑移动又不失性能</li>
<li>🧠 <strong>智能的布局算法</strong>：如何避免弹幕间的"交通事故"</li>
<li>🎨 <strong>优雅的代码设计</strong>：如何构建可扩展、易维护的架构</li>
</ul>
<p>如果你对这个项目感兴趣，欢迎：</p>
<p>⭐ <strong>Star</strong> → <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchengshixin%2FBarrageView" target="_blank" title="https://github.com/chengshixin/BarrageView" ref="nofollow noopener noreferrer">github.com/chengshixin…</a></p>
<p>🐛 <strong>提交Issue</strong> → 反馈bug或提出新功能建议</p>
<p>🔀 <strong>Pull Request</strong> → 一起让这个项目变得更好</p>
<hr/>
<p><strong>让我们的应用也拥有B站一样的弹幕文化吧！</strong> 🎊</p>
<p><em>"弹幕虽小，却能承载万千情感；代码虽简，却能创造无限可能。"</em></p>
<p><em>本文由BarrageView作者撰写，转载请注明出处。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 源码深度解析：Computed 的完整实现机制]]></title>    <link>https://juejin.cn/post/7574357603405676594</link>    <guid>https://juejin.cn/post/7574357603405676594</guid>    <pubDate>2025-11-20T02:00:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574357603405676594" data-draft-id="7574322843049295922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 源码深度解析：Computed 的完整实现机制"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-20T02:00:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="excel"/> <meta itemprop="url" content="https://juejin.cn/user/2911162520062862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 源码深度解析：Computed 的完整实现机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2911162520062862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    excel
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T02:00:49.000Z" title="Thu Nov 20 2025 02:00:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本系列前三篇我们已经拆解了 <code>reactive</code>、<code>collection handlers</code>、<code>effect</code> 体系，本篇继续深入 Vue3 响应式系统的第四个核心：<strong>computed 派生值</strong>。<br/>
本文依旧沿用统一结构：<strong>概念 → 架构 → 核心流程 → 源码逐段解析 → 与 effect 的关系 → 使用示例 → 扩展 → 潜在问题。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、Computed 是什么？（概念篇）</h2>
<p>在 Vue3 的响应式系统中，<code>computed</code> 属于 <strong>派生类型（Derived State）</strong> ：</p>
<ul>
<li>由其他响应式值计算得来</li>
<li>自动追踪依赖</li>
<li>自动缓存（不重复执行 getter）</li>
<li>支持可写/只读两种模式</li>
<li>与 <code>effect</code> 解耦，不再使用 effect 实现</li>
</ul>
<p>在新版实现中，computed 更像一个 <strong>“双重身份单元”</strong> ：</p>
<ul>
<li>作为 <strong>被动目标</strong>：被外部 effect 读取时，需要收集依赖（自身被依赖）</li>
<li>作为 <strong>主动订阅者</strong>：自己要订阅其他响应式源，以便在源更新时“变脏”</li>
</ul>
<p>这种结构使得 computed 更轻、更快、更可控。</p>
<hr/>
<h2 data-id="heading-1">二、Computed 的总体架构</h2>
<p>在 Vue3 中，<code>computed</code> 的主要结构如下：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">ComputedRefImpl
 ├─ _value           <span class="hljs-comment">// 缓存的计算结果</span>
 ├─ fn               <span class="hljs-comment">// getter</span>
 ├─ <span class="hljs-keyword">setter</span>           <span class="hljs-comment">// 可写 computed 才有</span>
 ├─ dep              <span class="hljs-comment">// 哪些 effect 依赖 computed</span>
 ├─ deps / depsTail  <span class="hljs-comment">// computed 依赖哪些 ref/reactive（反向链）</span>
 ├─ flags            <span class="hljs-comment">// 当前 computed 是否 dirty</span>
 ├─ globalVersion    <span class="hljs-comment">// 版本号控制是否要重新计算</span>
 ├─ isSSR            <span class="hljs-comment">// SSR 模式不同逻辑</span>
</code></pre>
<p>其中最关键的是 <strong>flags（dirty） + globalVersion（版本校验）</strong><br/>
这两个共同控制 computed 的缓存刷新逻辑。</p>
<hr/>
<h2 data-id="heading-2">三、核心流程：Computed 的运行机制</h2>
<p>Vue3 中 computed 工作流程可以分为四个步骤：</p>
<hr/>
<h3 data-id="heading-3">1）初始化</h3>
<ul>
<li>创建 <code>ComputedRefImpl</code></li>
<li>记录 getter</li>
<li>若有 setter 则为可写模式</li>
<li>标记为 dirty（需要首次计算）</li>
</ul>
<hr/>
<h3 data-id="heading-4">2）首次访问 <code>.value</code></h3>
<ul>
<li>触发 <code>dep.track()</code> 收集依赖</li>
<li>触发 <code>refreshComputed(this)</code></li>
<li>执行 getter 得到新值</li>
<li>缓存 <code>_value</code></li>
<li>清除 dirty / 更新版本号</li>
</ul>
<hr/>
<h3 data-id="heading-5">3）依赖更新 → 触发 notify()</h3>
<p>如果 computed 所依赖的数据改变：</p>
<ul>
<li>computed.flags |= DIRTY</li>
<li>下一次访问 <code>.value</code> 时会重新执行 getter</li>
</ul>
<hr/>
<h3 data-id="heading-6">4）再次访问 <code>.value</code></h3>
<p>若 dirty = false 且版本号未变：</p>
<p>→ <strong>不重新计算，直接返回缓存</strong></p>
<p>若 dirty = true 或版本号变化：</p>
<p>→ <strong>重新计算</strong></p>
<hr/>
<h2 data-id="heading-7">四、源码逐段解析（与你前三篇风格完全一致）</h2>
<p>以下代码全部来自你给的源码，我将按模块拆解并解释。</p>
<hr/>
<h3 data-id="heading-8">① 依赖导入</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { isFunction } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vue/shared'</span>
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">DebuggerEvent</span>,
  <span class="hljs-title class_">DebuggerOptions</span>,
  <span class="hljs-title class_">EffectFlags</span>,
  <span class="hljs-title class_">Subscriber</span>,
  activeSub,
  batch,
  refreshComputed,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'./effect'</span>
<span class="hljs-keyword">import</span> { warn } <span class="hljs-keyword">from</span> <span class="hljs-string">'./warning'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Dep</span>, <span class="hljs-title class_">Link</span>, globalVersion } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dep'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ReactiveFlags</span>, <span class="hljs-title class_">TrackOpTypes</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./constants'</span>
</code></pre>
<h4 data-id="heading-9">解析</h4>
<ul>
<li><code>batch()</code> → 批量通知 effect，避免频繁触发</li>
<li><code>refreshComputed()</code> → computed 的核心刷新逻辑</li>
<li><code>Dep</code> → 用于记录计算属性被哪些 effect 依赖</li>
<li><code>globalVersion</code> → 全局版本号（优化）</li>
</ul>
<p>computed 不再依赖 effect，而是依赖 Dep（更轻量）。</p>
<hr/>
<h3 data-id="heading-10">② ComputedRefImpl 类定义</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ComputedRefImpl</span>&lt;T = <span class="hljs-built_in">any</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Subscriber</span> {
</code></pre>
<p>computed 自身是一个 <strong>Subscriber（订阅者）</strong><br/>
它能订阅其他 reactive/ref。</p>
<hr/>
<h3 data-id="heading-11">③ 内部字段</h3>
<pre><code class="hljs language-ini" lang="ini">_value: <span class="hljs-attr">any</span> = undefined
dep: <span class="hljs-attr">Dep</span> = new Dep(this)
<span class="hljs-attr">__v_isRef</span> = <span class="hljs-literal">true</span>
__v_isReadonly: boolean
deps?: <span class="hljs-attr">Link</span> = undefined
depsTail?: <span class="hljs-attr">Link</span> = undefined
flags: <span class="hljs-attr">EffectFlags</span> = EffectFlags.DIRTY
globalVersion: <span class="hljs-attr">number</span> = globalVersion - <span class="hljs-number">1</span>
isSSR: boolean
</code></pre>
<h4 data-id="heading-12">字段解析</h4>





























<table><thead><tr><th>字段</th><th>作用</th></tr></thead><tbody><tr><td>_value</td><td>缓存的计算结果</td></tr><tr><td>dep</td><td>谁依赖了这个 computed</td></tr><tr><td>deps</td><td>computed 依赖的响应式源（反向）</td></tr><tr><td>flags</td><td>是否 dirty，需要重新计算</td></tr><tr><td>globalVersion</td><td>避免重复计算的版本号控制</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-13">④ 构造函数</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">constructor</span>(fn, setter, isSSR) {
  <span class="hljs-keyword">this</span>[ReactiveFlags.IS_READONLY] = !setter
  <span class="hljs-keyword">this</span>.isSSR = isSSR
}
</code></pre>
<p>没有 setter → readonly computed。<br/>
这部分设计和前三篇响应式系统一致。</p>
<hr/>
<h3 data-id="heading-14">⑤ notify：依赖发生变化时触发 dirty</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">notify() {
  <span class="hljs-keyword">this</span>.flags |= EffectFlags.DIRTY

  <span class="hljs-keyword">if</span> (
    !(<span class="hljs-keyword">this</span>.flags &amp; EffectFlags.NOTIFIED) &amp;&amp;
    activeSub !== <span class="hljs-keyword">this</span>
  ) {
    batch(<span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  }
}
</code></pre>
<h4 data-id="heading-15">原理说明</h4>
<p>当依赖更新时：</p>
<ul>
<li>标记本 computed 为 dirty</li>
<li>通过 batch 通知依赖它的 effect</li>
<li>避免 self-recursion（避免自己递归触发自己）</li>
</ul>
<p>这与上一篇 Collection 里的触发机制一致。</p>
<hr/>
<h3 data-id="heading-16">⑥ get value：读取并刷新缓存</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">get</span> value() {
  <span class="hljs-keyword">const</span> link = <span class="hljs-keyword">this</span>.dep.track()

  refreshComputed(<span class="hljs-keyword">this</span>)

  <span class="hljs-keyword">if</span> (link) {
    link.version = <span class="hljs-keyword">this</span>.dep.version
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._value
}
</code></pre>
<h4 data-id="heading-17">核心关键点（非常重要）</h4>
<ol>
<li><strong>dep.track()</strong><br/>
表示 “外部 effect 正在依赖我”</li>
<li><strong>refreshComputed(this)</strong><br/>
若 dirty 或版本号变化 → 执行 getter</li>
<li><strong>返回缓存值</strong></li>
</ol>
<p>这是 computed 靠缓存优化性能的关键。</p>
<hr/>
<h3 data-id="heading-18">⑦ set value：支持可写 computed</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">set</span> value(newValue) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.setter) {
    <span class="hljs-keyword">this</span>.setter(newValue)
  } <span class="hljs-keyword">else</span> {
    warn(<span class="hljs-string">'Write operation failed: computed value is readonly'</span>)
  }
}
</code></pre>
<p>这个很好理解。</p>
<hr/>
<h3 data-id="heading-19">⑧ computed() 工厂函数</h3>
<pre><code class="hljs language-ini" lang="ini">export function computed(getterOrOptions, debugOptions, <span class="hljs-attr">isSSR</span> = <span class="hljs-literal">false</span>) {
  let getter
  let setter

  if (isFunction(getterOrOptions)) {
    <span class="hljs-attr">getter</span> = getterOrOptions
  } else {
    <span class="hljs-attr">getter</span> = getterOrOptions.get
    <span class="hljs-attr">setter</span> = getterOrOptions.set
  }

  const <span class="hljs-attr">cRef</span> = new ComputedRefImpl(getter, setter, isSSR)

  if (__DEV__ &amp;&amp; debugOptions &amp;&amp; !isSSR) {
    <span class="hljs-attr">cRef.onTrack</span> = debugOptions.<span class="hljs-literal">on</span>Track
    <span class="hljs-attr">cRef.onTrigger</span> = debugOptions.<span class="hljs-literal">on</span>Trigger
  }

  return cRef
}
</code></pre>
<h4 data-id="heading-20">支持两种形式</h4>
<ul>
<li>computed(getter)</li>
<li>computed({ get, set })</li>
</ul>
<p>同 Vue3 文档。</p>
<hr/>
<h2 data-id="heading-21">五、Computed 与 Effect 的关系</h2>
<p>Vue3 中：</p>

























<table><thead><tr><th>项目</th><th>Vue2</th><th>Vue3</th></tr></thead><tbody><tr><td>computed 内部实现</td><td>基于 watcher</td><td>不再使用 effect</td></tr><tr><td>依赖收集</td><td>watcher.deps</td><td>dep + version</td></tr><tr><td>缓存策略</td><td>lazy watcher</td><td>version + dirty</td></tr></tbody></table>
<p>Computed 更轻、更纯，不会参与 effect 的副作用队列。</p>
<hr/>
<h2 data-id="heading-22">六、实战示例</h2>
<pre><code class="hljs language-scss" lang="scss">const count = <span class="hljs-built_in">ref</span>(<span class="hljs-number">1</span>)

const plusOne = <span class="hljs-built_in">computed</span>(() =&gt; count<span class="hljs-selector-class">.value</span> + <span class="hljs-number">1</span>)

console<span class="hljs-selector-class">.log</span>(plusOne.value) <span class="hljs-comment">// 2</span>
count<span class="hljs-selector-class">.value</span>++
console<span class="hljs-selector-class">.log</span>(plusOne.value) <span class="hljs-comment">// 3（重新计算）</span>
</code></pre>
<p>使用体验不变，但实现更加高效。</p>
<hr/>
<h2 data-id="heading-23">七、扩展：Computed 为什么要分版本号？</h2>
<p>原因：<strong>提升性能、减少不必要计算</strong></p>
<p>例如：</p>
<p>多个 ref 改变但 getter 内只依赖其中一个时，版本号能避免无效计算。</p>
<p>Vue3 响应式系统中 version 机制广泛存在：</p>
<ul>
<li>ref</li>
<li>reactive</li>
<li>computed</li>
</ul>
<p>都依赖 version。</p>
<hr/>
<h2 data-id="heading-24">八、潜在问题与注意事项</h2>
<ol>
<li>getter 必须是纯函数（不要做副作用）</li>
<li>computed 不适合包含异步（会变成 Promise）</li>
<li>多层嵌套 computed 可能产生链式 dirty — Vue 已做优化</li>
<li>setter 写入不要和 getter 逻辑矛盾</li>
</ol>
<hr/>
<h2 data-id="heading-25">总结</h2>
<p>本篇从 computed 的整体设计、数据结构、dirty 机制、版本号策略、依赖链结构，到源码逐段拆解，完整讲解了 Vue3 计算属性的底层实现，使其风格与前三篇完全保持一致。</p>
<hr/>
<p><strong>本文部分内容借助 AI 辅助生成，并由作者整理审核。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Trae Que：用智能提示词提升编程效率的新范式]]></title>    <link>https://juejin.cn/post/7574321422400258074</link>    <guid>https://juejin.cn/post/7574321422400258074</guid>    <pubDate>2025-11-19T15:46:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574321422400258074" data-draft-id="7574289653177876518" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Trae Que：用智能提示词提升编程效率的新范式"/> <meta itemprop="keywords" content="代码规范,人工智能,JavaScript"/> <meta itemprop="datePublished" content="2025-11-19T15:46:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="San30"/> <meta itemprop="url" content="https://juejin.cn/user/1766294768060816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Trae Que：用智能提示词提升编程效率的新范式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1766294768060816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    San30
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T15:46:24.000Z" title="Wed Nov 19 2025 15:46:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><blockquote>
<p>在 AI 编程助手的时代，掌握正确的提示词技巧比编写代码本身更加重要。本文通过实际案例展示如何利用 Trae Que 等工具实现高效的智能代码补全。</p>
</blockquote>
<h2 data-id="heading-0">从 Copilot 到 Trae Que：AI 编程助手的演进</h2>
<p>传统的代码补全工具如 GitHub Copilot 已经改变了我们的编程方式，但它们主要基于局部上下文进行预测。而新一代的 AI 编程助手如 Trae Que、Cursor Agent 和 Claude Sonet 则将智能代码补全提升到了新的高度——它们能够理解完整的代码逻辑和架构意图。</p>
<p>目前这些工具已经能够达到 <strong>85 分</strong>的实用水平，不再是玩具，而是真正的生产力工具。</p>
<h2 data-id="heading-1">核心技巧：注释驱动的开发模式</h2>
<h3 data-id="heading-2">1. 注释即蓝图</h3>
<p>传统的开发流程是：思考 → 编码 → 注释。在 AI 编程时代，我们应该调整为：思考 → 注释 → AI 编码。</p>
<p><strong>示例对比：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统方式</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">findUser</span>(<span class="hljs-params">id, users</span>) {
    <span class="hljs-keyword">return</span> users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">id</span> === id);
}

<span class="hljs-comment">// AI 时代的方式</span>
<span class="hljs-comment">/**
 * <span class="hljs-doctag">@func</span> 根据用户ID获取用户信息
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} id 用户ID
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} users 用户列表
 * <span class="hljs-doctag">@returns</span> 用户对象或undefined
 */</span>
<span class="hljs-comment">// ↑ 写完这些注释后，AI 会自动补全函数实现</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params">id, users</span>) {
    <span class="hljs-keyword">return</span> users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">id</span> === id);
}
</code></pre>
<h3 data-id="heading-3">2. 类型注解的力量</h3>
<p>TypeScript 的类型系统为 AI 提供了丰富的上下文信息：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 用户ID</span>
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 用户名</span>
    <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 用户邮箱</span>
    <span class="hljs-attr">status</span>: <span class="hljs-string">'ACTIVE'</span> | <span class="hljs-string">'INACTIVE'</span> <span class="hljs-comment">// 用户状态</span>
}

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@func</span> 根据ID获取用户信息，如果用户不存在则抛出错误
 * <span class="hljs-doctag">@param</span> id 用户ID
 * <span class="hljs-doctag">@param</span> users 用户列表
 * <span class="hljs-doctag">@returns</span> 用户对象
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, users: User[]</span>) {
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">id</span> === id);
    <span class="hljs-keyword">if</span> (!user) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'User not found'</span>)
    }
    <span class="hljs-keyword">return</span> user;
}
</code></pre>
<p>有了这样的类型定义，AI 能够：</p>
<ul>
<li>理解数据的完整结构</li>
<li>提供准确的自动补全</li>
<li>检测潜在的类型错误</li>
<li>生成类型安全的代码</li>
</ul>
<h2 data-id="heading-4">实战案例：用户管理系统</h2>
<h3 data-id="heading-5">案例1：多维度用户查询</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@func</span> 根据用户ID获取用户信息
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} id 
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} users 
 * <span class="hljs-doctag">@returns</span> 
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params">id, users</span>) {
    <span class="hljs-keyword">return</span> users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">id</span> === id);
}

<span class="hljs-comment">// 根据邮箱获取用户信息</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserByEmail</span>(<span class="hljs-params">email, users</span>) {
    <span class="hljs-keyword">return</span> users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">email</span> === email);
}

<span class="hljs-comment">// 根据用户名获取用户信息  </span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserByUsername</span>(<span class="hljs-params">username, users</span>) {
    <span class="hljs-keyword">return</span> users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">username</span> === username);
}
</code></pre>
<p><strong>AI 辅助效果</strong>：写完第一个函数的详细注释后，AI 能够自动推断出后续类似函数的模式和结构。</p>
<h3 data-id="heading-6">案例2：状态过滤功能</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@func</span> 查找所有非活跃用户
 * <span class="hljs-doctag">@params</span> users 用户列表  
 * <span class="hljs-doctag">@return</span> 非活跃用户列表
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getInactiveUsers</span>(<span class="hljs-params">users</span>) {
    <span class="hljs-keyword">const</span> inactiveUsers = <span class="hljs-keyword">await</span> users.<span class="hljs-title function_">filter</span>(
        <span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">status</span> === <span class="hljs-string">'INACTIVE'</span>
    )
    <span class="hljs-keyword">return</span> inactiveUsers;
}
</code></pre>
<p><strong>AI 辅助效果</strong>：清晰的注释让 AI 理解业务逻辑，自动生成正确的过滤条件。</p>
<h3 data-id="heading-7">案例3：测试数据验证</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> users = [
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">username</span>: <span class="hljs-string">'admin'</span>,
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, 
        <span class="hljs-attr">username</span>: <span class="hljs-string">'user1'</span>,
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>,
        <span class="hljs-attr">username</span>: <span class="hljs-string">'user2'</span>,
    },
];

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
    users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">id</span> === <span class="hljs-number">2</span>)
);
</code></pre>
<p><strong>AI 辅助效果</strong>：基于数据结构，AI 可以建议相关的查询操作和测试用例。</p>
<h2 data-id="heading-8">高级技巧：跨文件上下文理解</h2>
<p>Trae Que 的强大之处在于它能够理解跨文件的代码关系：</p>
<h3 data-id="heading-9">场景：用户状态管理</h3>
<p>在 <code>userService.js</code> 中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@func</span> 激活用户账户
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} userId 用户ID
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} users 用户列表
 * <span class="hljs-doctag">@returns</span> 更新后的用户列表
 */</span>
</code></pre>
<p>在 <code>userController.js</code> 中工作时，AI 仍然记得这个函数的存在和用途，能够提供准确的调用建议。</p>
<h2 data-id="heading-10">最佳实践指南</h2>
<h3 data-id="heading-11">1. 注释要具体且有价值</h3>
<ul>
<li>✅ 好注释：<code>@func 根据用户状态和注册时间筛选有效用户</code></li>
<li>❌ 差注释：<code>@func 筛选用户</code></li>
</ul>
<h3 data-id="heading-12">2. 利用 JSDoc 标准</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 计算用户活跃度分数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">User</span>} user 用户对象
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Date</span>} startDate 开始日期
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Date</span>} endDate 结束日期
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} 活跃度分数(0-100)
 * <span class="hljs-doctag">@throws</span> {<span class="hljs-type">Error</span>} 当日期范围无效时
 */</span>
</code></pre>
<h3 data-id="heading-13">3. 保持代码结构清晰</h3>
<p>AI 在处理良好结构的代码时表现更好：</p>
<ul>
<li>单一职责的函数</li>
<li>一致的命名约定</li>
<li>合理的模块划分</li>
</ul>
<h3 data-id="heading-14">4. 迭代式提示</h3>
<p>如果第一次生成的结果不理想，可以：</p>
<ul>
<li>补充更多上下文信息</li>
<li>提供示例输入输出</li>
<li>指定代码风格要求</li>
</ul>
<h2 data-id="heading-15">生产力提升实测</h2>
<p>根据实际使用经验，采用 Trae Que 等工具后：</p>
<ul>
<li><strong>代码编写速度</strong>：提升 40-60%</li>
<li><strong>样板代码编写</strong>：减少 80%</li>
<li><strong>API 查阅时间</strong>：减少 70%</li>
<li><strong>错误检测</strong>：提前发现 30% 的潜在问题</li>
</ul>
<h2 data-id="heading-16">未来展望</h2>
<p>随着 AI 编程助手的不断发展，我们正在走向：</p>
<ol>
<li><strong>语义级理解</strong>：AI 不仅理解语法，更能理解业务逻辑</li>
<li><strong>架构级建议</strong>：从代码片段到系统设计的智能建议</li>
<li><strong>自动化重构</strong>：智能识别代码坏味道并提供重构方案</li>
<li><strong>团队知识传承</strong>：基于团队代码库的学习和风格适应</li>
</ol>
<h2 data-id="heading-17">结语</h2>
<p>Trae Que 代表的不仅仅是另一个代码补全工具，它标志着编程范式的转变。在这个新时代，<strong>表达意图的能力</strong>比<strong>实现细节的能力</strong>更加重要。</p>
<p>通过掌握注释驱动开发、类型注解和结构化提示词这些技巧，我们不仅是在使用工具，更是在与 AI 协作编程。这种协作关系将释放开发者的创造力，让我们能够专注于解决更有价值的复杂问题。</p>
<p>记住：在未来，最好的程序员不是最会写代码的人，而是最会与 AI 协作的人。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个不会画图的程序员不是好的设计师]]></title>    <link>https://juejin.cn/post/7574584245109145651</link>    <guid>https://juejin.cn/post/7574584245109145651</guid>    <pubDate>2025-11-20T00:13:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574584245109145651" data-draft-id="7574271557939560499" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个不会画图的程序员不是好的设计师"/> <meta itemprop="keywords" content="设计师,设计"/> <meta itemprop="datePublished" content="2025-11-20T00:13:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员晓凡"/> <meta itemprop="url" content="https://juejin.cn/user/1829211147871415"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个不会画图的程序员不是好的设计师
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1829211147871415/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员晓凡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:13:27.000Z" title="Thu Nov 20 2025 00:13:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是晓凡。</p>
<h3 data-id="heading-0">写在前面</h3>
<p>你有没有遇到过这样的困扰：面对一堆密密麻麻的数据、文字，看了半天还是一头雾水？</p>
<p>或者想要向别人解释一个复杂的流程，说了半天对方还是似懂非懂？</p>
<p>有时候不是我们不会表达，而是画图更直观明了。</p>
<h3 data-id="heading-1">一、ER图 (实体关系图)</h3>
<ul>
<li><strong>作用</strong>：描述数据库中实体之间的关系</li>
<li><strong>使用场景</strong>：数据库设计、系统分析阶段</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f08a5cb4e06e48c0a889fd7de32a6c91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=Loum6f%2F3GLll%2Bf8i1vluf46XfiI%3D" alt="ER图" loading="lazy"/></p>
<h3 data-id="heading-2">二、甘特图</h3>
<ul>
<li><strong>作用</strong>：展示项目进度和时间安排</li>
<li><strong>使用场景</strong>：项目管理、任务规划、进度跟踪</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbf7deb5f5a344f49a99264317fbdef5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=fYOu2gUgzGmyQlzQMiEURcNn2js%3D" alt="甘特图" loading="lazy"/></p>
<h3 data-id="heading-3">三、时间图</h3>
<ul>
<li><strong>作用</strong>：显示事件或数据随时间的变化趋势</li>
<li><strong>使用场景</strong>：数据分析、历史趋势展示、监控</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78c5adf6719b45e3b56c53d9fa045317~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=I0IppM88WAxymmF7dPIXeLaQdsA%3D" alt="时间线图" loading="lazy"/></p>
<h3 data-id="heading-4">四、树形图</h3>
<ul>
<li><strong>作用</strong>：表示层次结构关系</li>
<li><strong>使用场景</strong>：组织架构图、文件目录结构、决策树</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10cf998225af4c0cbe87708afc0cfefd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=3uCq2BfGk7ijMqsdq1Mt8%2FBFxAY%3D" alt="树形图" loading="lazy"/></p>
<h3 data-id="heading-5">五、网络拓扑图</h3>
<ul>
<li><strong>作用</strong>：展示网络设备间的连接关系</li>
<li><strong>使用场景</strong>：IT网络规划、系统运维、网络安全</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/248ff5528d5f471d890fdd35961e3726~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=RKRO%2BPiFEe59CBQLsdUGOhL77E8%3D" alt="网络拓扑图" loading="lazy"/></p>
<h3 data-id="heading-6">六、架构图</h3>
<ul>
<li><strong>作用</strong>：描述系统的整体结构和组件关系</li>
<li><strong>使用场景</strong>：软件设计、系统规划、技术文档</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49625c83fea142a0be8acff5f9b0bf1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=GjtwiwJP%2FM838VVbdyG%2F8LY60zo%3D" alt="三层架构图" loading="lazy"/></p>
<h3 data-id="heading-7">七、数据流图</h3>
<ul>
<li><strong>作用</strong>：展示数据在系统中的流动过程</li>
<li><strong>使用场景</strong>：系统分析、业务流程梳理、需求分析</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da873e36c9354dc9b97264f12090adb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=SwGCmWWzhPHDe2RNJVFtVvuOcR4%3D" alt="数据流图" loading="lazy"/></p>
<h3 data-id="heading-8">八、状态图</h3>
<ul>
<li><strong>作用</strong>：描述对象或系统的状态变化</li>
<li><strong>使用场景</strong>：软件开发、工作流程建模、协议设计</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b6b500fd1864517b42445b59f32669c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=5bRll9VDMBDfG%2F9Dsi%2BSbGSQRr8%3D" alt="状态图" loading="lazy"/></p>
<h3 data-id="heading-9">九、泳道图</h3>
<ul>
<li><strong>作用</strong>：展示跨部门或角色的业务流程</li>
<li><strong>使用场景</strong>：业务流程优化、跨部门协作分析</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd56b3c1ff5e45f1a902f776be3b9a3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=6uzxGTxddbbAFfokC0DGcPP%2Bf%2B8%3D" alt="泳道图" loading="lazy"/></p>
<h3 data-id="heading-10">十、概念图</h3>
<ul>
<li><strong>作用</strong>：可视化展示概念间的关系</li>
<li><strong>使用场景</strong>：知识整理、教学、头脑风暴</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5d1f2dc6bb54e1791b12d9b65113da0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=ELkRUlbOBs7fjCSZ2rA%2BlZlCle8%3D" alt="概念图" loading="lazy"/></p>
<h3 data-id="heading-11">十一、鱼骨图</h3>
<ul>
<li><strong>作用</strong>：分析问题的根本原因</li>
<li><strong>使用场景</strong>：问题分析、质量改进、根因分析</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52efc4eb1bfd4e74848f184b87c2712d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=695yCqBZvF7zag44f7GiNRRRy18%3D" alt="鱼骨图" loading="lazy"/></p>
<h3 data-id="heading-12">十二、金字塔图</h3>
<ul>
<li><strong>作用</strong>：展示层次结构和重要性递减关系</li>
<li><strong>使用场景</strong>：管理体系、需求优先级排序、营销策略</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/213a335335d94b28b91503f74938cdf8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=2FCgdULal3MmqJHUdQPCZxyzVgE%3D" alt="金字塔图" loading="lazy"/></p>
<h3 data-id="heading-13">十三、漏斗图</h3>
<ul>
<li><strong>作用</strong>：展示逐步减少的过程</li>
<li><strong>使用场景</strong>：销售转化率分析、用户行为分析、营销效果评估</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0592c30f8f044326a52ab38f6daf0850~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=kJEUCP23%2FFwHw3ur%2B94OCSxvM5w%3D" alt="漏斗图" loading="lazy"/></p>
<h3 data-id="heading-14">十四、韦恩图</h3>
<ul>
<li><strong>作用</strong>：展示集合间的逻辑关系和重叠部分</li>
<li><strong>使用场景</strong>：数据分析、集合关系展示、比较分析</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87bee6822e7d48a6ac0f280a0663691d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=o1dtwx4OEGhlpi60%2BD1VrPkl17I%3D" alt="韦恩图" loading="lazy"/></p>
<h3 data-id="heading-15">十五、矩阵图</h3>
<ul>
<li><strong>作用</strong>：展示多维数据间的关系强度</li>
<li><strong>使用场景</strong>：风险评估、优先级排序、关联分析</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3153475ac4824e40997e4576949e6c95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=5z%2F4lE2AukI0guQC7uzKImYm4wo%3D" alt="矩阵图" loading="lazy"/></p>
<h3 data-id="heading-16">十六、信息图</h3>
<ul>
<li><strong>作用</strong>：综合可视化展示复杂信息</li>
<li><strong>使用场景</strong>：数据报告、宣传材料、知识传播</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript性能优化：7个90%开发者不知道的V8引擎隐藏技巧]]></title>    <link>https://juejin.cn/post/7574251313884102671</link>    <guid>https://juejin.cn/post/7574251313884102671</guid>    <pubDate>2025-11-20T00:16:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574251313884102671" data-draft-id="7574250031249424418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript性能优化：7个90%开发者不知道的V8引擎隐藏技巧"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-20T00:16:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript性能优化：7个90%开发者不知道的V8引擎隐藏技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:16:54.000Z" title="Thu Nov 20 2025 00:16:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>JavaScript性能优化：7个90%开发者不知道的V8引擎隐藏技巧</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在现代Web开发中，JavaScript的性能优化是一个永恒的话题。作为最流行的JavaScript引擎之一，V8（驱动Chrome和Node.js的核心）在背后默默执行了无数优化。然而，许多开发者对V8的内部工作机制知之甚少，导致编写的代码无法充分发挥其潜力。</p>
<p>本文将揭示7个被大多数开发者忽视的V8引擎隐藏技巧，帮助你写出更高效的JavaScript代码。这些技巧不仅基于V8的官方文档和源码分析，还结合了实际性能测试数据，确保内容的专业性和可靠性。</p>
<hr/>
<h2 data-id="heading-2">1. 隐藏类（Hidden Classes）与属性顺序的重要性</h2>
<h3 data-id="heading-3">什么是隐藏类？</h3>
<p>V8使用“隐藏类”（也称为“Shape”）来优化对象属性的访问。当对象的结构（如属性的顺序和类型）相同时，它们会共享同一个隐藏类，从而加速属性查找。</p>
<h3 data-id="heading-4">优化技巧</h3>
<ul>
<li><strong>保持属性顺序一致</strong>：动态添加属性的顺序会影响隐藏类的生成。例如：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 不好的写法：导致多个隐藏类</span>
<span class="hljs-keyword">const</span> obj1 = {};
obj1.<span class="hljs-property">a</span> = <span class="hljs-number">1</span>;
obj1.<span class="hljs-property">b</span> = <span class="hljs-number">2</span>;

<span class="hljs-keyword">const</span> obj2 = {};
obj2.<span class="hljs-property">b</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// 顺序不同！</span>
obj2.<span class="hljs-property">a</span> = <span class="hljs-number">1</span>;

<span class="hljs-comment">// 好的写法：保持顺序一致</span>
<span class="hljs-keyword">const</span> obj3 = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> };
<span class="hljs-keyword">const</span> obj4 = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> };
</code></pre>
</li>
<li><strong>避免动态删除属性</strong>：使用<code>delete</code>操作符会破坏隐藏类，导致性能下降。如果需要移除属性，可以将其设为<code>null</code>或<code>undefined</code>。</li>
</ul>
<hr/>
<h2 data-id="heading-5">2. Inline Caching（内联缓存）与函数单态性</h2>
<h3 data-id="heading-6">Inline Caching的工作原理</h3>
<p>V8通过内联缓存（IC）来加速函数调用和属性访问。它记录最近的操作类型（如对象的隐藏类），并在下次直接复用缓存结果。</p>
<p>###如何利用单态性优化？</p>
<ul>
<li><strong>确保函数参数类型稳定</strong>：如果一个函数频繁接收不同类型的参数，V8会退化为“多态”调用，降低性能。例如：</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Bad: Mixed types trigger polymorphic calls</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
<span class="hljs-keyword">return</span> a + b;
}
<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);      <span class="hljs-comment">// Monomorphic (numbers)</span>
<span class="hljs-title function_">add</span>(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>); <span class="hljs-comment">// Polymorphic (now strings)</span>

<span class="hljs-comment">// Good: Stick to one type per function</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addNumbers</span>(<span class="hljs-params">a, b</span>) {
<span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<hr/>
<p>##3.避免try-catch在热点路径中的使用</p>
<p>###为什么try-catch代价高昂？
V8对包含try-catch的函数难以优化因为它要求额外的运行时上下文切换并阻止内联等关键优化。</p>
<p>###替代方案：
-将try-catch移出循环或高频执行路径。
-对于异步错误处理优先使用Promise.catch()而非包裹await在try中。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Bad:</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000000</span>;i++){
 <span class="hljs-keyword">try</span>{ <span class="hljs-title function_">hotPath</span>(); }
 <span class="hljs-keyword">catch</span>(e){}
}

<span class="hljs-comment">// Good:</span>
<span class="hljs-keyword">try</span> {
 <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000000</span>;i++){
   <span class="hljs-title function_">hotPath</span>();
 }
} <span class="hljs-keyword">catch</span>(e){}
</code></pre>
<hr/>
<p>##4.Optimizing Arrays for V8</p>
<p>###数组类型的内部表示
V8会根据元素类型自动选择最优存储方式：
-PACKED_SMI_ELEMENTS（纯小整数）
-PACKED_DOUBLE_ELEMENTS（双精度浮点）
-PACKED_ELEMENTS（任意对象）</p>
<p>####关键优化点：
-<strong>避免混合类型数组</strong>:一旦数组包含非SMI数字或对象就无法降级到高效表示。
-<strong>预分配固定大小数组</strong>:比动态push更快因为不需要反复扩容。
-<strong>谨慎使用稀疏数组</strong>:空槽位会导致退化为字典模式。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">100</span>);<span class="hljs-comment">//预先分配优于[]</span>
arr.<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">//初始化保证PACKED_SMI</span>

<span class="hljs-comment">//比以下高效得多：</span>
<span class="hljs-keyword">const</span> arr=[];
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">100</span>;i++)arr.<span class="hljs-title function_">push</span>(i);
</code></pre>
<hr/>
<p>##5.String连接的高效模式</p>
<p>###传统+=的性能陷阱
连续使用+=拼接字符串会产生大量中间字符串触发垃圾回收压力。</p>
<p>####现代解决方案：
-<strong>数组join法</strong>:仍然是最可靠的跨浏览器方法。
-<strong>模板字符串</strong>:现代JS引擎已深度优化。
-<strong>String.prototype.concat():在某些情况下比+更快</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> result=<span class="hljs-string">''</span>;
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;data.<span class="hljs-property">length</span>;i++){
 result+=data[i];<span class="hljs-comment">//Bad for large loops</span>
}

<span class="hljs-comment">// Better:</span>
<span class="hljs-keyword">const</span> parts=[];
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;data.<span class="hljs-property">length</span>;i++){
 parts.<span class="hljs-title function_">push</span>(data[i]);
}
result=parts.<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
</code></pre>
<hr/>
<p>##6.Optimizing Number Operations</p>
<p>###V8的数字表示体系
-V8使用31位带符号整数(SMi)和双精度浮点数两种表示。-超出SMi范围(-231~231-1)的数字会被升级为堆分配的Double对象。</p>
<p>####关键技巧：
-<strong>尽量使用31位有符号整数</strong>:算术运算最快。
-<strong>避免频繁切换数字类型</strong>:会导致不断拆箱/装箱。
-<strong>位运算仅对32位有效</strong>:|0可强制转为32位整数.</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_SMI</span>=<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>,<span class="hljs-number">30</span>)-<span class="hljs-number">1</span>;<span class="hljs-comment">//最大的SMi值</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">expensiveCalc</span>(<span class="hljs-params"/>){
 <span class="hljs-keyword">let</span> sum=<span class="hljs-number">0</span>;<span class="hljs-comment">//SMi optimized</span>
 <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10000</span>;i++){
   sum+=i;<span class="hljs-comment">//保持在SMi范围内最快 </span>
 }
 <span class="hljs-keyword">return</span> sum; 
}
</code></pre>
<hr/>
<p>##7.Leveraging Concurrent Compilation in V8</p>
<p>###后台编译机制自2017年起现代V8采用并发编译：
-解析器和编译器在工作线程上运行不影响主线程执行.</p>
<p>####如何配合此机制？
-<strong>代码分块</strong>:让编译器可以并行处理不同函数.
-<strong>避免巨型单体函数</strong>:大函数会延迟编译完成时间.
-<strong>注意TurboFan优化的触发条件</strong>:热函数需要足够调用次数.</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//Bad:Huge monolithic function </span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">giantFunction</span>(<span class="hljs-params"/>){
 <span class="hljs-comment">//...500+ lines of code </span>
}

<span class="hljs-comment">//Better:Split into logical units </span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">taskA</span>(<span class="hljs-params"/>){<span class="hljs-comment">/*...*/</span>}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">taskB</span>(<span class="hljs-params"/>){<span class="hljs-comment">/*...*/</span>}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">workflow</span>(<span class="hljs-params"/>){
 <span class="hljs-title function_">taskA</span>();
 <span class="hljs-title function_">taskB</span>(); <span class="hljs-comment">//Each can be compiled separately </span>
}
</code></pre>
<hr/>
<p>##总结</p>
<p>理解V8引擎的这些底层机制可以让你的JavaScript代码获得数量级的性能提升从正确的数据结构选择到符合编译器优化的编码模式每个微小的改进都能在高频执行的代码路径上产生显著影响。</p>
<p>记住这些原则并非教条主义的金科玉律而是需要在具体场景中验证的工具随着V8的持续进化定期重新审视你的性能假设非常重要最好的优化策略往往是那些能够优雅地适应运行时特性的策略</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习 LiteLLM 的认证机制]]></title>    <link>https://juejin.cn/post/7574318108719382574</link>    <guid>https://juejin.cn/post/7574318108719382574</guid>    <pubDate>2025-11-20T00:14:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574318108719382574" data-draft-id="7574289653178040358" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习 LiteLLM 的认证机制"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-20T00:14:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="日习一技"/> <meta itemprop="url" content="https://juejin.cn/user/3913917125896190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习 LiteLLM 的认证机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917125896190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    日习一技
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:14:58.000Z" title="Thu Nov 20 2025 00:14:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在之前的两篇文章中，我们分别学习了 LiteLLM 的快速入门和模型管理。我们了解到，LiteLLM 不仅是一个统一的 SDK，更是一个功能强大的企业级 LLM 网关。在生产环境中，如何确保 LLM 资源的安全访问？如何为不同用户和团队分配不同的权限？如何追踪每个用户的使用情况和成本？如何精确控制成本和防止滥用？这些都是访问控制需要解决的核心问题。</p>
<p>LiteLLM 的访问控制系统采用多层次的安全架构，从基础的 API Key 认证到企业级的 JWT 认证，从简单的用户管理到复杂的团队权限体系，为不同规模的应用提供了灵活的解决方案：</p>
<p><strong>认证层次</strong>：</p>
<ul>
<li><strong>虚拟 API Key</strong>：为每个用户或团队生成唯一的虚拟 Key</li>
<li><strong>JWT Token</strong>：支持企业级 OpenID Connect (OIDC) 认证</li>
<li><strong>自定义认证</strong>：集成企业现有的身份认证系统</li>
</ul>
<p><strong>授权体系</strong>：</p>
<ul>
<li><strong>用户级权限</strong>：基于角色的访问控制（RBAC）</li>
<li><strong>团队级权限</strong>：团队成员共享模型访问权限</li>
<li><strong>组织级权限</strong>：大型企业的多层级管理</li>
</ul>
<p><strong>控制维度</strong>：</p>
<ul>
<li><strong>模型访问</strong>：控制用户可以使用的模型</li>
<li><strong>接口访问</strong>：限制可调用的 API 接口</li>
<li><strong>流量控制</strong>：请求频率和并发数限制</li>
<li><strong>成本控制</strong>：预算限制和消费追踪</li>
</ul>
<p>我们今天主要关注第一部分，来学习下 LiteLLM 的认证机制。</p>
<h2 data-id="heading-0">虚拟 Key 认证</h2>
<p>在之前的学习中，我们在调用模型接口时使用的 API Key 一直都是 <code>sk-1234</code>，这个是我们在配置文件中配置的 <strong>Master Key</strong>，也就是管理员密钥：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">general_settings:</span>
  <span class="hljs-attr">master_key:</span> <span class="hljs-string">sk-1234</span>
</code></pre>
<p>对于个人开发者来说，只用一个简单的 API Key 可能就足够了，但是对于团队或企业来说，一个 Key 无法区分不同的用户或应用，而且 Master Key 的权限过大，这时我们就需要引入 Virtual Key 的概念了。</p>
<p><strong>虚拟 Key（Virtual Key）</strong> 是 LiteLLM 最核心的认证机制，它借鉴了云服务商的 API Key 管理模式，为每个用户或应用生成独立的访问密钥。LiteLLM 的虚拟 Key 提供了一层抽象，使得：</p>
<ul>
<li>你可以为不同的用户、团队、应用生成不同的 Key</li>
<li>每个 Key 可以独立配置访问权限和预算限制</li>
<li>支持 Key 的轮换和撤销</li>
<li>所有使用行为都由 Proxy 记录和追踪</li>
</ul>
<p>接下来我们生成一个虚拟 Key 验证下。虚拟 Key 的生成需要数据库支持，因此首先配置数据库连接（昨天学习模型的动态管理时已经配过）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">general_settings:</span>
  <span class="hljs-attr">master_key:</span> <span class="hljs-string">sk-1234</span>
  <span class="hljs-attr">database_url:</span> <span class="hljs-string">"postgresql://postgres:password@127.0.0.1:5432/litellm"</span>
</code></pre>
<p>然后通过 <code>/key/generate</code> 接口生成 Key：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl <span class="hljs-string">'http://127.0.0.1:4000/key/generate'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-1234'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "models": ["gpt-4o"],
    "metadata": {"user": "zhangsan@example.com"}
  }'</span>
</code></pre>
<p>接口响应如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>    
  <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sk-qC5b02PjnQVdq3FPYY37wQ"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"key_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sk-...37wQ"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"gpt-4o"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"user"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zhangsan@example.com"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"team_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"model_max_budget"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"model_rpm_limit"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"model_tpm_limit"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"max_budget"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"max_parallel_requests"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"guardrails"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"allowed_routes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// ...</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>可以看到，接口响应中除了 <code>key</code> 之外，还有一些关于用户、团队、请求频率、并发限制等信息，这些内容涉及 LiteLLM 的授权体系和访问控制机制，我们后面再具体学习。</p>
</blockquote>
<p>使用这个虚拟 Key 请求 <code>/chat/completions</code> 接口：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-qC5b02PjnQVdq3FPYY37wQ'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "你好"}]
  }'</span>
</code></pre>
<p>接口验证正常，说明虚拟 Key 生成成功。</p>
<h3 data-id="heading-1">支持多种 Header 格式</h3>
<p>LiteLLM 的灵活设计使其能够支持多种 Header 格式，兼容不同的客户端库和工具：</p>













































<table><thead><tr><th>Header 名称</th><th>用途</th><th>优先级</th></tr></thead><tbody><tr><td><code>x-litellm-api-key</code></td><td>LiteLLM 自定义 Key</td><td>1 (最高)</td></tr><tr><td><code>Authorization</code></td><td>OpenAI 兼容格式</td><td>2</td></tr><tr><td><code>API-Key</code></td><td>Azure 风格</td><td>3</td></tr><tr><td><code>x-api-key</code></td><td>Anthropic 格式</td><td>4</td></tr><tr><td><code>x-goog-api-key</code></td><td>Google AI Studio</td><td>5</td></tr><tr><td><code>Ocp-Apim-Subscription-Key</code></td><td>Azure APIM</td><td>6</td></tr><tr><td>其他自定义 Header</td><td>配置化支持</td><td>7</td></tr></tbody></table>
<p>比如像下面这样请求也是可以的：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'x-litellm-api-key: sk-qC5b02PjnQVdq3FPYY37wQ'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "你好"}]
  }'</span>
</code></pre>
<p>这样的设计让 LiteLLM 可以轻松地代理来自各种来源的请求，而无需修改客户端代码。</p>
<h3 data-id="heading-2">虚拟 Key 的存储和验证</h3>
<p>为了保证安全性，虚拟 Key 在数据库中采用 <strong>哈希值存储</strong>，这样做的好处是，即使数据库被泄露，攻击者也无法直接使用 Key（因为数据库中只有哈希值）。</p>
<p>另外，LiteLLM 使用 <strong>分层缓存策略</strong> 进行虚拟 Key 的验证：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38871ce009b94ea09931d51f812e6643~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=tdCatIzimvMm5k4LEPlzMI3Cgck%3D" alt="api-key-verification.png" loading="lazy"/></p>
<p>通过分层缓存，大多数请求不需要访问数据库，大大提高了虚拟 Key 的验证性能。</p>
<h3 data-id="heading-3">客户端凭据透传</h3>
<p>除了传统的服务器端认证，LiteLLM 还支持让客户端直接传递自己的 API Key，这在某些场景下可能有用，比如开发者使用自己的 API Key 进行测试，或者用户希望使用自己的 API Key，但又不希望配置到 LiteLLM 里。</p>
<p>通过下面的参数启用客户端凭据透传：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">model_list:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gpt-4o</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">openai/gpt-4o</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/OPENAI_API_KEY</span>
      <span class="hljs-attr">configurable_clientside_auth_params:</span> [<span class="hljs-string">"api_key"</span>, <span class="hljs-string">"api_base"</span>] <span class="hljs-comment"># 支持透传的字段</span>
</code></pre>
<p>客户端调用示例如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> openai

client = openai.OpenAI(
  api_key=<span class="hljs-string">"sk-1234"</span>,
  base_url=<span class="hljs-string">"http://localhost:4000"</span>
)

response = client.chat.completions.create(
  model=<span class="hljs-string">"gpt-4o"</span>,
  messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Hello"</span>}],
  extra_body={
    <span class="hljs-string">"api_key"</span>: <span class="hljs-string">"sk-client-xxx"</span>,  <span class="hljs-comment"># 客户端自己的 API 密钥</span>
    <span class="hljs-string">"api_base"</span>: <span class="hljs-string">"https://api.openai.com/v1"</span>
  }
)
</code></pre>
<p>LiteLLM 会遍历 <code>configurable_clientside_auth_params</code> 参数，将客户端传递的参数和系统配置的参数进行合并。</p>
<blockquote>
<p>有意思的，客户端不仅可以传 <code>api_key</code> 或 <code>api_base</code> 等字段，甚至可以传整个 <code>model_list</code>，将 LiteLLM 的配置完全架空。</p>
</blockquote>
<h2 data-id="heading-4">JWT 认证与 OIDC 集成</h2>
<p>虽然虚拟 Key 是 LiteLLM 最核心的认证方式，但对于某些企业场景，这种认证方式可能不够灵活，企业往往已经有一套比较成熟的 <strong>身份认证系统（Identity Provider, IDP）</strong>，比如：</p>
<ul>
<li><strong>Azure AD</strong>：Microsoft 的企业身份平台</li>
<li><strong>Keycloak</strong>：开源身份和访问管理解决方案</li>
<li><strong>Google Cloud Identity</strong>：Google 的企业 SSO</li>
<li><strong>Okta</strong>：专业的身份管理服务</li>
</ul>
<p>他们更希望能直接复用这套认证机制。</p>
<p>LiteLLM 支持通过 <strong>JWT 令牌</strong> 与这些系统集成，而无需维护独立的用户数据库。</p>
<blockquote>
<p>注意，这是一个企业级特性，需要购买授权。</p>
</blockquote>
<h3 data-id="heading-5">OIDC 简介</h3>
<p>LiteLLM 和身份认证系统之间的交互遵循 <a href="https://link.juejin.cn?target=https%3A%2F%2Fopenid.net%2F" target="_blank" title="https://openid.net/" ref="nofollow noopener noreferrer">OIDC</a> 标准。</p>
<p><strong>OpenID Connect (OIDC)</strong> 是一个基于 OAuth 2.0 的身份认证协议，它在 OAuth 2.0 的基础上增加了身份层，使得应用可以验证用户的身份，它已经成为企业级应用的标准认证方式。</p>
<p>OIDC 的核心优势如下：</p>
<ul>
<li><strong>标准化</strong>：遵循 OAuth 2.0 和 OpenID Connect 规范</li>
<li><strong>单点登录</strong>：支持 SSO，用户一次登录，全组织访问</li>
<li><strong>令牌安全</strong>：JWT 令牌可以包含丰富的用户信息，支持签名和加密</li>
<li><strong>广泛支持</strong>：被所有主流云服务和身份提供商支持</li>
</ul>
<p>下面是 OIDC 规范，对此感兴趣的朋友可以看看：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenid.net%2Fdevelopers%2Fhow-connect-works%2F" target="_blank" title="https://openid.net/developers/how-connect-works/" ref="nofollow noopener noreferrer">openid.net/developers/…</a></li>
</ul>
<h3 data-id="heading-6">JWT 简介</h3>
<p><strong>JWT（JSON Web Token）</strong> 是一种基于 JSON 的轻量级身份认证与信息交换标准（RFC 7519），广泛用于分布式系统、API 接口、前后端分离架构中，核心作用是在客户端与服务器之间安全传递 <strong>可验证的声明</strong>（如用户身份、权限范围等），无需服务器存储会话状态。</p>
<p>在传统的会话认证（如 Session）中，服务器需要存储用户的会话信息，当用户量增大或服务分布式部署时，会面临会话同步复杂、服务器存储压力大等问题。而 JWT 通过 <strong>客户端存储令牌 + 服务器验证令牌</strong> 的模式，解决了这些痛点，其核心优势包括：</p>
<ul>
<li><strong>无状态</strong>：服务器无需存储会话数据，仅通过令牌本身即可验证合法性，降低服务器存储成本，便于服务水平扩展（多台服务器可共享认证逻辑）；</li>
<li><strong>跨域友好</strong>：JWT 基于 HTTP 头传递，天然支持跨域场景（如前后端分离、多服务间调用）；</li>
<li><strong>轻量灵活</strong>：基于 JSON 格式，体积小、传输快，且可自定义声明字段，满足不同业务需求；</li>
<li><strong>自包含</strong>：令牌本身包含了用户身份、权限等核心信息，减少服务器查询数据库的次数（无需每次认证都查用户表）；</li>
</ul>
<p>一个 JWT 令牌由三部分组成，用点号分隔：</p>
<pre><code class="hljs language-erlang" lang="erlang">eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.
eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIn0.
SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
</code></pre>
<p>分别代表：</p>
<ul>
<li><strong>Header</strong>：算法和令牌类型信息</li>
<li><strong>Payload</strong>：用户信息和声明（Claims）</li>
<li><strong>Signature</strong>：数字签名，用于验证数据完整性</li>
</ul>
<p>可以通过下面的网站验证和查看 JWT 令牌中的内容：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jwt.io%2F" target="_blank" title="https://www.jwt.io/" ref="nofollow noopener noreferrer">www.jwt.io/</a></li>
</ul>
<h3 data-id="heading-7">基于 Keycloak 的 JWT 认证实战</h3>
<p>下面我使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.keycloak.org%2F" target="_blank" title="https://www.keycloak.org/" ref="nofollow noopener noreferrer">Keycloak</a> 这款开源的身份认证系统来演示下如何在 LiteLLM 中实现 JWT 认证。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c0dc0743c894fbabb5e7fcf343ddf9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=gTLFhtDHdKAwl9T9IXCPPuUbJ3c%3D" alt="keycloak.png" loading="lazy"/></p>
<p>这是一款由 Red Hat 主导开发并维护的开源 <strong>身份和访问管理（IAM）</strong> 工具，旨在为现代应用（包括 Web 应用、移动应用、API 服务等）提供统一、安全且标准化的 <strong>身份认证（Authentication）</strong> 与 <strong>授权（Authorization）</strong> 能力，帮助开发者快速集成身份管理功能，无需重复造轮子。</p>
<h4 data-id="heading-8">Keycloak 环境准备</h4>
<p>首先使用下面的命令启动 Keycloak 服务：</p>
<pre><code class="hljs language-bash" lang="bash">$ docker run \
  -p 8080:8080 \
  -e KC_BOOTSTRAP_ADMIN_USERNAME=admin \
  -e KC_BOOTSTRAP_ADMIN_PASSWORD=admin \
  quay.io/keycloak/keycloak:26.4.2 start-dev
</code></pre>
<p>服务启动成功后，在浏览器访问 <code>http://localhost:8080/</code> 并使用默认的用户名和密码登录：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37903599eb7443418bfb9b57e6ac837f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=3zZDJ0K0%2Ba4iEB80cKMc2YBLwRU%3D" alt="keycloak-admin-ui.png" loading="lazy"/></p>
<p>点击 “Manage realms” 菜单，创建一个名为 <code>litellm</code> 的 <strong>领域（Realm）</strong>，这是 Keycloak 中最高级别的隔离单位，相当于 <strong>租户</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f779bed4fd8a49398765042a80b0d400~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=ZZHyvHFdSCiiYAmxAlVMqGRYTk0%3D" alt="keycloak-create-realm.png" loading="lazy"/></p>
<p>创建完成后会自动切到这个领域，然后点击 “Users” 菜单，在这个领域下创建一个用户，用户名为 <code>zhangsan</code>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93b0dff04281403584ad8708cd4cf5ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=86sgZr3gStRn3mmWTZ3ChoYBxbA%3D" alt="keycloak-create-user.png" loading="lazy"/></p>
<p>创建完成后进入该用户的详情，点击 “Credentials” 菜单，再点击 “Set password” 按钮，为用户设置一个长期密码（注意将 Temporary 勾掉）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97638d1e0efb4ef9b0d92d94f9d8dd7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=4FOsPptmam5M3ZWP%2F3asy861CVU%3D" alt="keycloak-create-user-set-password.png" loading="lazy"/></p>
<p>然后再点击 “Clients” 菜单，创建一个客户端：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/532116b6217f4a6db499bfe25f75bb1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=LRdYTBKKNrf0gBGvlk7z9X%2BZrZs%3D" alt="keycloak-create-client.png" loading="lazy"/></p>
<p>其中 Client ID 命名为 <code>litellm</code>，点击 Next 进入 “Capability Config” 页面：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1eab1281a8b3464f8c05892a4660c63c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=NoOvXWMvhr%2B217njYuFj%2FZxgCJE%3D" alt="keycloak-create-client-capability.png" loading="lazy"/></p>
<p>将 “Client authentication” 选项开启，同时在 “Authentication flow” 中将 “Direct access grants” 开启。接着，点击 Next 进入 “Login Settings” 页面，保持默认即可，点击 Save 按钮，完成客户端的创建。</p>
<h4 data-id="heading-9">开启 JWT 认证</h4>
<p>至此 Keycloak 环境准备就绪，接下来让 LiteLLM 开启 JWT 认证。第一步，通过环境变量设置 Keycloak 的公钥端点：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 注意 `litellm` 是领域名称</span>
<span class="hljs-built_in">export</span> JWT_PUBLIC_KEY_URL=<span class="hljs-string">"http://localhost:9009/realms/litellm/protocol/openid-connect/certs"</span>
</code></pre>
<p>这个 URL 是 OpenID Connect 标准的 <strong>JWKS（JSON Web Key Set）</strong> 端点，方便客户端批量获取所需密钥，里面包含了用于验证签名或加密的公钥。</p>
<p>第二步，在配置中启用 JWT 认证：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">general_settings:</span>
  <span class="hljs-attr">master_key:</span> <span class="hljs-string">sk-1234</span>
  <span class="hljs-attr">database_url:</span> <span class="hljs-string">"postgresql://postgres:password@127.0.0.1:5432/litellm"</span>
  <span class="hljs-attr">enable_jwt_auth:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 开启 JWT 认证</span>
</code></pre>
<p>第三步，重启 LiteLLM Proxy 服务：</p>
<pre><code class="hljs language-bash" lang="bash">$ litellm -c config.yaml
</code></pre>
<p>第四步，使用 Client ID、Client Secret、用户名、密码，调用 Keycloak 获取 JWT 令牌：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST \
  http://localhost:9009/realms/litellm/protocol/openid-connect/token \
  -H <span class="hljs-string">"Content-Type: application/x-www-form-urlencoded"</span> \
  -d <span class="hljs-string">"grant_type=password"</span> \
  -d <span class="hljs-string">"client_id=litellm"</span> \
  -d <span class="hljs-string">"client_secret=0CtlgEvGHU3XNjDAmwHPn5p8wT78JGEp"</span> \
  -d <span class="hljs-string">"username=zhangsan"</span> \
  -d <span class="hljs-string">"password=12345678"</span>
</code></pre>
<p>其中 Client Secret 可以在 Client 详情中找到：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/259acabf8b4141a4ac3a3f6c2eae9d2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=bEMnW8vB2ja4HYUfz41qBIQSHFk%3D" alt="keycloak-clients-details.png" loading="lazy"/></p>
<p>接口返回结果如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"access_token"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eyJhbGciOiJSUzI1NiIsInR5..."</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"expires_in"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">300</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"refresh_expires_in"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1800</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"refresh_token"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eyJhbGciOiJIUzUxMiIsInR5..."</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"token_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bearer"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"not-before-policy"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"session_state"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dca8f2d7-eac4-d6e7-799b-f7b80da4d841"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scope"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"profile email"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这个 <code>access_token</code> 就是 JWT 令牌，我们可以用它来调用 <code>/chat/completions</code> 接口：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5...'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "你好"}]
  }'</span>
</code></pre>
<p>LiteLLM 会根据从 <code>JWT_PUBLIC_KEY_URL</code> 获取的公钥对该令牌进行验证（类似数字签名的原理），这就是 LiteLLM 的 JWT 认证流程。</p>
<h2 data-id="heading-10">自定义认证</h2>
<p>虽然 LiteLLM 提供了虚拟 Key、JWT 等多种认证方式，但在某些高度定制化的场景中，你可能需要实现自己的认证逻辑。比如：</p>
<ul>
<li><strong>现有系统集成</strong>：你有一套自定义的用户认证系统</li>
<li><strong>特殊业务规则</strong>：需要根据特定条件验证用户</li>
<li><strong>外部服务集成</strong>：需要调用外部服务进行认证</li>
<li><strong>多步认证</strong>：需要组合多个认证因素</li>
</ul>
<p>LiteLLM 允许你提供自定义的认证函数，完全控制身份认证过程。其核心是实现一个异步函数，该函数接收请求和 API Key，然后返回一个认证对象：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Request
<span class="hljs-keyword">from</span> litellm.proxy._types <span class="hljs-keyword">import</span> UserAPIKeyAuth

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">user_api_key_auth</span>(<span class="hljs-params">request: Request, api_key: <span class="hljs-built_in">str</span></span>) -&gt; UserAPIKeyAuth: 
  <span class="hljs-string">"""
  自定义认证函数

  参数:
    request: FastAPI 请求对象，包含 HTTP 请求的所有信息
    api_key: 从请求头中提取的 API Key

  返回:
    UserAPIKeyAuth: 认证成功时返回用户认证对象

  异常:
    Exception: 认证失败时抛出异常
  """</span>
  <span class="hljs-keyword">try</span>: 
    <span class="hljs-keyword">if</span> api_key.startswith(<span class="hljs-string">"my-custom-key-"</span>):
      <span class="hljs-keyword">return</span> UserAPIKeyAuth(api_key=api_key)
    <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">"Invalid API key"</span>)
  <span class="hljs-keyword">except</span>: 
    <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">"Authentication failed"</span>)
</code></pre>
<p>将上面的内容保存到 <code>custom_auth.py</code> 文件中，并放置于和 <code>config.yaml</code> 文件同级的目录下。在配置文件中指定自定义认证函数的位置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">general_settings:</span>
  <span class="hljs-attr">master_key:</span> <span class="hljs-string">sk-1234</span>
  <span class="hljs-attr">database_url:</span> <span class="hljs-string">"postgresql://postgres:password@127.0.0.1:5432/litellm"</span>
  <span class="hljs-attr">custom_auth:</span> <span class="hljs-string">custom_auth.user_api_key_auth</span>  <span class="hljs-comment"># 模块路径.函数名</span>
</code></pre>
<p>然后重启 LiteLLM Proxy 服务，此时，任何 <code>my-custom-key-</code> 开头的 Key 都能通过验证了：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer my-custom-key-888'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "你好"}]
  }'</span>
</code></pre>
<p>值得注意的是，在认证流程中，自定义认证是最优先执行的，因此如果开启了该功能，Master Key 和 虚拟 Key 就不起作用了。为了同时兼容，企业版的 LiteLLM 支持一个更灵活的混合模式：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">general_settings:</span>
  <span class="hljs-attr">custom_auth:</span> <span class="hljs-string">custom_auth.user_api_key_auth</span>
  <span class="hljs-attr">custom_auth_settings:</span>
    <span class="hljs-attr">mode:</span> <span class="hljs-string">"auto"</span>  <span class="hljs-comment"># 支持虚拟 Key 和自定义认证混用</span>
</code></pre>
<p>当自定义认证失败后，LiteLLM 会继续沿用虚拟 Key 的验证流程。</p>
<h2 data-id="heading-11">小结</h2>
<p>通过这篇文章，我们系统地学习了 LiteLLM Proxy 的认证机制，这是构建企业级 LLM 网关的核心基础。主要内容包括：</p>
<ul>
<li><strong>虚拟 Key 认证</strong>：LiteLLM 最核心的认证方式，通过为每个用户或应用生成独立的 API Key，实现细粒度的权限隔离和使用追踪；采用哈希存储和分层缓存策略确保了安全性和性能的平衡；支持多种 Header 格式使其能够兼容各种客户端和工具；</li>
<li><strong>JWT 认证与 OIDC 集成</strong>：为企业用户提供了一条与现有身份认证系统无缝集成的路径，无需在 LiteLLM 中维护独立的用户数据库，充分利用企业已有的 IAM 基础设施；</li>
<li><strong>自定义认证</strong>：完全开放的认证扩展机制，允许企业根据特定的业务规则实现复杂的认证逻辑，支持与任何现有系统的集成；企业版提供了混合模式，可以同时支持虚拟 Key 和自定义认证；</li>
</ul>
<p>LiteLLM 的认证设计体现了分层的思想：从基础的虚拟 Key 面向个人开发者和小型团队，到 JWT/OIDC 面向已有 IAM 的企业，再到自定义认证面向有特殊需求的场景。这种分层的、可扩展的设计，使得 LiteLLM 能够适应从个人项目到大规模企业级应用的各种场景。</p>
<p>在后续的学习中，我们将继续深入 LiteLLM 的权限管理和访问控制系统，学习如何为不同的用户和团队分配不同的权限，如何追踪使用情况和成本，如何设置预算限额防止滥用。敬请期待！</p>
<h2 data-id="heading-12">欢迎关注</h2>
<p>如果这篇文章对您有所帮助，欢迎关注我的同名公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fi-study-everyday.online%2Fabout-me.html" target="_blank" title="https://i-study-everyday.online/about-me.html" ref="nofollow noopener noreferrer">日习一技，每天学一点新技术</a>。</p>
<p>我会每天花一个小时，记录下我学习的点点滴滴。内容包括但不限于：</p>
<ul>
<li>某个产品的使用小窍门</li>
<li>开源项目的实践和心得</li>
<li>技术点的简单解读</li>
</ul>
<p>目标是让大家用5分钟读完就能有所收获，不需要太费劲，但却可以轻松获取一些干货。不管你是技术新手还是老鸟，欢迎给我提建议，如果有想学习的技术，也欢迎交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你的游戏没有这个怎么能够顺利出海？]]></title>    <link>https://juejin.cn/post/7574289653178105894</link>    <guid>https://juejin.cn/post/7574289653178105894</guid>    <pubDate>2025-11-20T00:37:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574289653178105894" data-draft-id="7573899782803046446" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你的游戏没有这个怎么能够顺利出海？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-20T00:37:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亿元程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1972988307323236"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你的游戏没有这个怎么能够顺利出海？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972988307323236/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亿元程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:37:01.000Z" title="Thu Nov 20 2025 00:37:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>点击上方亿元程序员+关注和★星标</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/299cb16684744dafae89656a99903bb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=ilujT9mI1Y9zXFOvGcBFVrHuRCs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p><strong>哈喽大家好</strong>，不知道小伙伴们最近有没有发现，如今的游戏出海，已经不是从前的粗放买量靠堆砌素材喂算法了，现在都在拼长线运营或者<code>AI</code>了。</p>
<p><strong>其中</strong><code>Supercell</code>的《荒野乱斗》就是最好的例子，上线五年了，如今成功逆袭。</p>
<p><strong>笔者想起</strong>，八年前就已经参与过游戏的多语言版本了，那时候的主流是港台（繁体）、东南亚（英文）、韩国（韩文）。</p>
<p><strong>除去</strong>接入对应的<code>SDK</code>外，最为深刻的就是翻译和本地化，那时候不需要很高端的操作，就是把游戏内所有的中文整理出来，给到专门负责翻译的人，完成后导回到游戏即可。</p>
<p><strong>其中</strong>最头疼的就是英文，两个字能变<code>10</code>多个字母，很容易导致超框，以上的处理有个“国际化”的简称，叫<code>i18n</code>。</p>
<p><strong>言归正传</strong>，今天我们就来聊聊<code>i18n</code>。</p>
<h2 data-id="heading-1">什么是i18n？</h2>
<p><strong>先简单科普一下</strong></p>
<blockquote>
<p><code>i18n</code>是国际化的简称，来源是英文单词<code>internationalization</code>的首末字符<code>i</code>和<code>n</code>，<code>18</code>为单词中间的字符数。</p>
<p><strong>在资讯领域</strong>，国际化（<code>i18n</code>）可以让产品无需做大的改变，就能够满足不同语言和地区的需要。</p>
</blockquote>
<h2 data-id="heading-2">i18n的优势是什么？</h2>
<p><strong>对程序来说</strong>，在不修改内部代码的情况下，就能根据不同语言及地区切换相应的语言界面。</p>
<p><strong>正如笔者</strong>引言所说，把文本交给翻译人员，回来后原路返回即可。</p>
<p><strong>从</strong>最开始就制定严格的规范，所有的文本都需要通过<code>i18n</code>，这样能够减少后期提取文本和导回文本的麻烦操作。</p>
<h2 data-id="heading-3">一起来看个例子</h2>
<p><strong>既然</strong><code>i18n</code>如此重要，那么我们一起来看看它在<code>Cocos</code>游戏开发中如何使用。</p>
<h3 data-id="heading-4">1.安装插件</h3>
<p><strong>首先</strong>在<code>Store</code>找到<code>i18n多语言化插件</code>，选择添加到项目即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ba7c927e27b4c2e8d6dc4ab1158732f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=XgylglRwvdPzCZ54aT8puW9khFA%3D" alt="" loading="lazy"/></p>
<p><strong>添加</strong>完成之后，就可以在资源管理器看到插件对应的脚本，分别对应数据、<code>Label</code>管理和<code>Sprite</code>管理。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2984acb3e8004703a35d16fdb311c9c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=E6XzlE38gCsdMTS7innLa1Fpcok%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">2.添加语言</h3>
<p><strong>首先</strong>通过菜单<code>扩展-&gt;I18n Setting</code>打开本地化控制面板。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54a3bf11e5f842719cc58935a9b4d7fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=wZpTzVLf2sctnN8Wn1swZ0LGHIs%3D" alt="" loading="lazy"/></p>
<p><strong>简单</strong>添加<code>8</code>个语言，从下到上分别为中文、俄语、韩语、日语、法语、西班牙语、英语和德语（首字母排序）。</p>
<p><strong>为什么</strong>是<code>8</code>个？因为可以和别人说你“精通”八国语言（你好，世界）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/892140f7b7ef41ffaffcb76cd110341e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=YymRssWPjfSa2qyJCr9r2RGvrWg%3D" alt="" loading="lazy"/></p>
<p><strong>编辑完成</strong>后，插件会自动在<code>resources\i18n</code>目录生成对应的<code>Ts</code>配置文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b9aa737c71c429e86900d236b3226f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=DNLVfReFpMXmYxejlz5a6hnuL9E%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">3.编辑中文</h3>
<p><strong>在</strong><code>zh.ts</code>中添加<code>你好，世界</code>，作为示例。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddc9c93f7b4046bd98ccf7e4dc456acf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=jyJA1BGp0117tt2q%2FBZf%2BmANOc0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">4.翻译其他7种语言</h3>
<p><strong>把</strong>完成的所有中文内容，交给专业的翻译人员进行翻译，获得其余<code>7</code>种语言，我们这里简单示例就找搭子就行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48b7b66f083a4e9280fa3b449062b6c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=bIEOrl%2BO5iiBahbiGpJvV%2B66itU%3D" alt="" loading="lazy"/></p>
<p><strong>还是</strong>非常靠谱的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e2eb2ec3e4c4ea89fe4c5606d918867~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=m0BEn5rmyk%2FWhD2le%2BUEh0LGNEs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">5.LocalizedLabel组件</h3>
<p><strong>插件</strong>生成的<code>LocalizedLabel</code>组件，就是对<code>Label</code>的简单封装，根据<code>key</code>和语言配置获取对应的文本。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc58329c3de342b5b4bcaa8347faae93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=2vF0wLoAQnBlZOkCcSD70y6D00I%3D" alt="" loading="lazy"/></p>
<p><strong>直接</strong>挂到<code>Label</code>组件上，配置对应的文本的<code>key</code>即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0253d1d04d9541be82ceb25ba638cce9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=KVVLx8oGfuA3dD2r1thhUFDvY4E%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">6.效果演示</h3>
<p><strong>我们</strong>通过点击本地化编辑面板中不同语言的“小眼睛”，即可完成语言的切换，并且看到切换语言后的效果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd63b17827cc4690810f76b9c26da1fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=yE08QY7JkL3To3aIbJPgeCnNMkY%3D" alt="" loading="lazy"/></p>
<p><strong>上面</strong>只是编辑器演示，实际需要修改默认语言，可以在脚本中修改。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9131cf818e74fec8f0a6b2e71d79c53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=eMSCKBSv2B%2BRpT5db2tEUrustZY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">7.进阶</h3>
<p><strong>如果</strong>一个包体内有多种语言，想要支持动态切换语言，可以通过<code>import * as i18n from 'db://i18n/LanguageData';</code>导入<code>i18n</code>，并通过<code>i18n.init('en');</code>进行语言切换，最后通过<code>i18n.updateSceneRenderers();</code>刷新即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ca0bdb886d147c18ac70c63cd24a594~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=%2FlcJuCW6%2BdSbO1szbYtuEpK4rNo%3D" alt="" loading="lazy"/></p>
<p><strong>此外</strong>，<code>LocalizedSprite</code>组件也是同理，对<code>Sprite</code>的简单封装。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b9e67854df947fb81528a7f6a093dca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=mcpVumlYqm4VFB6sTskVI%2BYH6yw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">结语</h2>
<p><strong>当然了</strong>，并非所有的项目都需要使用这套插件，国际化的逻辑还是简单的，一般公司项目都有自己的技术积累，有自己的实现。</p>
<p><strong>其实</strong>最主要是一个规范的问题，通过语言包的限制，避免文本到处都是。但是也使得配置表比较难以配置，这个需要小伙伴们自己权衡了。</p>
<p><strong>你们使用的是什么方案？</strong></p>
<p><strong>我是"亿元程序员"，一位有着8年游戏行业经验的主程。在游戏开发中，希望能给到您帮助, 也希望通过您能帮助到大家。</strong></p>
<p>AD:笔者线上的小游戏《打螺丝闯关》《贪吃蛇掌机经典》《重力迷宫球》《填色之旅》《方块掌机经典》大家可以自行点击搜索体验。</p>
<p>实不相瞒，想要个<strong>赞</strong>和<strong>爱心</strong>！请把该文章<strong>分享</strong>给你觉得有需要的其他小伙伴。谢谢！</p>
<p>推荐专栏：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3175880857546129410%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3175880857546129410#wechat_redirect" ref="nofollow noopener noreferrer">知识付费专栏</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26mid%3D2247487282%26idx%3D1%26sn%3De3cb8ab6f5c0d5f804d5c29e2e90b9ad%26chksm%3Dc00daec5f77a27d33933e877464d8cde24c4c947d3755f5e8262c634634617e7c26de3953a54%26token%3D336413522%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg5NTY2MjIzMg==&amp;mid=2247487282&amp;idx=1&amp;sn=e3cb8ab6f5c0d5f804d5c29e2e90b9ad&amp;chksm=c00daec5f77a27d33933e877464d8cde24c4c947d3755f5e8262c634634617e7c26de3953a54&amp;token=336413522&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">你知道和不知道的微信小游戏常用API整理，赶紧收藏用起来~</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3207702867494305797%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3207702867494305797#wechat_redirect" ref="nofollow noopener noreferrer">100个Cocos实例</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3073771187570999299%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3073771187570999299#wechat_redirect" ref="nofollow noopener noreferrer">8年主程手把手打造Cocos独立游戏开发框架</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3121583619634626562%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3121583619634626562#wechat_redirect" ref="nofollow noopener noreferrer">和8年游戏主程一起学习设计模式</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3Faction%3Dgetalbum%26__biz%3DMzg5NTY2MjIzMg%3D%3D%26scene%3D1%26album_id%3D3038883468588089350%26count%3D3%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?action=getalbum&amp;__biz=Mzg5NTY2MjIzMg==&amp;scene=1&amp;album_id=3038883468588089350&amp;count=3#wechat_redirect" ref="nofollow noopener noreferrer">从零开始开发贪吃蛇小游戏到上线系列</a></p>
<p>点击下方灰色按钮+关注。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini 3.0来，它带着王炸来了]]></title>    <link>https://juejin.cn/post/7574343024324083753</link>    <guid>https://juejin.cn/post/7574343024324083753</guid>    <pubDate>2025-11-20T00:37:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574343024324083753" data-draft-id="7574286569038856255" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini 3.0来，它带着王炸来了"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-20T00:37:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MobotStone"/> <meta itemprop="url" content="https://juejin.cn/user/3839909554568840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini 3.0来，它带着王炸来了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3839909554568840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MobotStone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:37:43.000Z" title="Thu Nov 20 2025 00:37:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>期待半个多月，Gemini 3.0 终于登场了。</p>
<p>真正让我瞠目结舌的，却不是模型本身，而是它身后那款全新的开发工具——Google Antigravity IDE。消息一出，我的舆情监控小应用第一时间也推送了这个好消息。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c2ef0e0421946bba53f25ab42ba109b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203863&amp;x-signature=h3tKlS2Kev3IF7hE1Ejl2jKpsgo%3D" alt="" loading="lazy"/></p>
<p>老实说，哪怕这两年眼看着 AI 产品一波接一波地涌出来，谷歌这次的出手，还是有点让人猝不及防。</p>
<p>自从 2023 年底 Gemini 首次亮相，我就一直盯着谷歌在 AI 领域的每一步：模型怎么迭代、产品怎么整合、和自家生态怎么绑在一起。到了 Gemini 3，这条产品线突然加速，开始尝试一件此前从未做过的事——在发布的第一天，就把一个全新的模型直接塞进搜索里，让亿级用户当“首批内测用户”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4eb746ac24146169714dd7690382ce5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203863&amp;x-signature=p4Wy7SvEKqMPuQJn4TMNCc4riKQ%3D" alt="" loading="lazy"/></p>
<p>更有意思的是，谷歌并不满足于“做个模型给别人用”，而是顺手又扔出来一个全新的智能编码平台：Google Antigravity。这个平台的定位很明确，就是奔着 Cursor 2.0 这类工具去的，正面对刚，毫不遮掩。</p>
<p>从第三方评测来看，Gemini 3 Pro 在 LMArena 上拿到了 1501 分，已经把前代的 1451 分甩在身后，同时也超过了目前市面上其他所有主流前沿模型。数据当然不是全部，但至少说明一件事：这不是例行公事的“小升级”，而是一次有备而来的重提速。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/514c0d55f85249c8a17df9db1c330787~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203863&amp;x-signature=qbeeI0yrDhrrKAOR6Eh5ZPiofH4%3D" alt="" loading="lazy"/></p>
<p>它已经具备了堪比博士的推理水准，既懂学术规范，也熟悉研究流程，还能在一轮对话中同时处理多达一百万个词元的上下文信息。</p>
<p>但有意思的地方，不只是“更强一点”这么简单。</p>
<p>谷歌真正动手改造的，是整个模型的能力版图——<em><strong>从实时生成可交互的视觉界面，到自主搭建一整套应用，再顺带把自己的代码拉出来测试一遍。</strong></em></p>
<h2 data-id="heading-0">什么是 Gemini 3 Pro？</h2>
<p>谷歌发布了新的基础模型 Gemini 3。今天开始，用户可以在 Gemini 应用、AI Studio、Vertex AI 和谷歌搜索中试用公开预览版。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0858e83bdef4431ca809a2ab0ac53256~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203863&amp;x-signature=zQ4BPpEOUPYuG3XjQMi9BvmTJEQ%3D" alt="" loading="lazy"/></p>
<p>谷歌说，这是他们"最智能的模型"，能够帮助用户"将任何想法变为现实"。</p>
<p>这次发布有两个版本。</p>
<ul>
<li>第一个是 Gemini 3 Pro，现在所有用户都能使用。它的推理能力、多模态理解能力和编码功能都很先进。</li>
<li>第二个是 Gemini 3 Deep Think，这是一个增强型推理模式。谷歌说，需要进行额外的安全测试，几周后才会向 Google AI Ultra 订阅用户开放。</li>
</ul>
<h2 data-id="heading-1">技术基础</h2>
<p>Gemini 3 Pro 用了一种叫“稀疏混合专家”的架构，参数规模超过1万亿——听着吓人，但实际用起来很聪明。它不会傻乎乎地每次把整个模型都拉出来干活，而是像老中医把脉一样，精准地把任务分给最对口的“专家小组”。你想啊，一家1000人的公司，开个产品讨论会，总不能把保洁阿姨和财务总监都叫来吧？Gemini 3 就是这个道理：输入一个问题，它自动挑出最懂行的子网络来处理，其他部分该休息就休息。这样既省电费（计算成本低），效果还一点不打折，性能照样顶尖。这设计真像极了我们日常：人尽其才，物尽其用。</p>
<h2 data-id="heading-2">核心能力</h2>
<ul>
<li><strong>超大记忆容量</strong>：上下文窗口有100万个词符——相当于70万单词，或者一口气聊完10本《三体》的篇幅。长对话、复杂任务？它都能稳稳记住上下文，不会前言不搭后语。</li>
<li><strong>多面手本事</strong>：文字、图片、音频、视频、代码？统统能嚼碎了消化。不是简单“支持”，是真能融会贯通，像你同时用眼睛看图、耳朵听声、脑子写代码一样自然。</li>
<li><strong>输出不缩水</strong>：每次回复最多吐出64,000个token，写篇万字长文或生成完整代码模块都不在话下。</li>
<li><strong>知识保鲜期</strong>：学到的内容更新到2025年1月，像刚出炉的面包，新鲜度刚好。</li>
</ul>
<h2 data-id="heading-3">用起来有多方便？</h2>
<p>今天起，Gemini 3 已经铺好路，你挑条顺脚的走就行：</p>
<ul>
<li><strong>Gemini App</strong>：手机点开就用，全民免费——技术普及就该这样，别搞成贵族游戏。</li>
<li><strong>Google AI Studio</strong>：开发者福音，免费额度宽松，调接口、测模型像玩玩具一样轻松。</li>
<li><strong>Vertex AI</strong>：企业级重装备，数据安全、高并发需求？交给它，省心。</li>
<li><strong>Gemini CLI</strong>：命令行极客的最爱，几行代码调用大模型，效率翻倍。</li>
<li><strong>AI Mode in Search</strong>：Google AI Pro 和 Ultra 订阅用户的彩蛋，搜索时秒变智能助手。</li>
<li><strong>Google Antigravity</strong>：全新智能体开发平台（下文细聊），让AI自主干活成为日常。</li>
</ul>
<p>Gemini 3 也已经接入了一些常用的开发与协作平台，如 Cursor、GitHub Copilot、JetBrains 和 Replit 等，可以比较自然地融入现有工作流。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6423c7aaac644ba19dcafcace90ed56e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203863&amp;x-signature=gfskiDhlwEZ8h%2F4g1fYEPIVQBI8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">工作原理</h2>
<p>和前几代相比，Gemini 3 更像是“听得懂人话”的模型。 你不必精心设计提示词，也不用和它打太多“哑谜”，只要正常说明需求，它基本都能领会你的意思，并给出相对合适的回答。</p>
<p>它被设计成可以抓住“深度和细微差别”的系统——既能读懂创意表达中的小心思，也能一层层拆解复杂问题。</p>
<p>在训练阶段，Google 给它喂了非常广泛的数据： 包括网页文档、程序代码、图片、音频、视频，以及由其他 AI 系统生成的合成数据等。</p>
<p>所有训练数据都要先经过过滤：不合规的内容会被剔除，比如色情、极端暴力，以及任何违反儿童安全相关法律的材料。</p>
<p>训练过程中，用到的是 Google 自家的张量处理单元（TPU），配合 JAX 和 ML Pathways 这套软件栈来完成大规模训练。</p>
<h2 data-id="heading-5">Gemini 3 的“深度思考模式”：不止聪明，更会思考</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/859b44ea9be04111b5c36f499c243a65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203863&amp;x-signature=zX79H0A6ppI3wQgjCs4JRoOljoo%3D" alt="" loading="lazy"/></p>
<p>现在，Gemini 3 又推出了一项杀手锏——“深度思考模式”。顾名思义，它能让模型在面对那些最烧脑、最具挑战性的问题时，展现出更强大的推理能力。</p>
<p>这项新能力，让它的“考试成绩”也实现了飞跃：</p>
<ul>
<li><strong>人类的最后考试</strong>：它的得分是<strong>41.0%</strong> （而标准版 Gemini 3 Pro 只有 37.5%）。</li>
<li><strong>GPQA钻石级测试</strong>：成功率达到了惊人的<strong>93.8%</strong> （此前是 91.9%）。</li>
<li><strong>ARC-AGI-2</strong>：在这个需要创新性问题解决能力的测试中，它的代码执行成功率高达<strong>45.1%</strong> 。这可不仅仅是记住答案，而是真正展现出了“举一反三”的创新思考能力。</li>
</ul>
<blockquote>
<p><strong>不过，这个“深度思考模式”不会一下子全部开放。谷歌会采取分阶段策略：它将首先面向安全测试人员开放体验，收集反馈。在接下来的几周内，Google AI Ultra 的订阅用户也将陆续能够尝鲜。</strong></p>
</blockquote>
<p>这种“小步快跑”的实施方式，是为了给谷歌留足充分的时间，来收集用户反馈，并确保这项增强的推理能力在大规模应用时，也能保持稳定高效。</p>
<h2 data-id="heading-6">竞争格局分析</h2>
<p>Gemini 3 Pro 的发布，正值大模型市场竞争最白热化的阶段。目前的市场环境可谓强敌环伺：</p>
<ul>
<li>OpenAI GPT-5 &amp; 5.1：于 2025 年 8 月发布，11 月进行了更新。虽然 OpenAI 号称 ChatGPT 周活用户达到 8 亿，但 8 月份的首发普遍被市场认为表现平平，缺乏惊喜。</li>
<li>Anthropic Claude Sonnet 4.5 &amp; Opus 4：以强大的推理能力著称，在开发者和企业用户中口碑极佳，具有很强的“人格化”特征。</li>
<li>xAI Grok 4.1：2025 年 11 月发布，主打卖点是相比前代大幅减少了“幻觉”问题。</li>
</ul>
<p>基准测试（Benchmarks）显示，Gemini 3 Pro 在推理和多模态任务上处于领先地位。不过，在实际应用场景中，性能差异往往因人而异。</p>
<p>从技术架构上看，Gemini 3 采用了混合专家模型（MoE）。相比 GPT 和 Claude 等密集型模型，这种架构在运行效率上更具优势。</p>
<blockquote>
<p><em><strong>但真正的竞争优势在于生态链使用。</strong></em></p>
</blockquote>
<p>技术指标固然重要，但谷歌真正的杀手锏在于生态链使用。</p>
<blockquote>
<p><em><strong>这一次，谷歌展示了什么是绝对的规模优势。</strong></em></p>
</blockquote>
<p>看看这组数据：</p>
<ul>
<li><strong>AI Overviews</strong>：月活跃用户 20 亿。</li>
<li><strong>Gemini App</strong>：月活跃用户 6.5 亿（作为对比，ChatGPT 的周活跃用户为 7 亿）。</li>
<li><strong>Google Cloud AI</strong>：超过 70% 的云客户已接入。</li>
<li><strong>开发者生态</strong>：1300 万开发者正在使用 Gemini 模型构建应用。</li>
</ul>
<p>这意味着什么？意味着谷歌可以将 Gemini 3 无缝集成到搜索、Gmail、文档、YouTube、Android 等数十个产品中。</p>
<blockquote>
<p><strong>这些产品每天都有数十亿人在使用。</strong></p>
</blockquote>
<p>目前，没有其他人工智能公司拥有丰富的生态链。</p>
<h2 data-id="heading-7">Gemini 3.0 的局限性</h2>
<p>当然，完美的模型并不存在。谷歌在模型卡（Model Card）中坦诚了 Gemini 3 存在的局限：</p>
<ul>
<li><strong>幻觉（Hallucinations）</strong> ：模型仍然可能产生错误信息，并且一本正经地当作事实陈述。</li>
<li><strong>偶发性卡顿</strong>：在处理复杂查询时，响应速度可能会变慢。</li>
<li><strong>上下文混淆</strong>：在冗长的对话中，模型有时会“忘记”之前的细节。</li>
<li><strong>安全边界</strong>：系统严格限制了涉及危险活动、色情、暴力、仇恨言论和虚假信息的生成。</li>
</ul>
<p>值得一提的是，该模型接受了谷歌迄今为止最全面的安全评估，测试方包括英国 AISI、Apollo、Vaultis、Dreadnode 等独立机构。</p>
<blockquote>
<p><strong>相比前代版本，Gemini 3 减少了“阿谀奉承”的倾向，更能抵御提示词注入（Prompt Injection）攻击，并且针对网络攻击滥用做了更好的防护。</strong></p>
</blockquote>
<h2 data-id="heading-8">最后想说的话</h2>
<p>谷歌这次的发布与以往有所不同。</p>
<blockquote>
<p><strong>Gemini 3 Pro 不仅刷榜了几乎所有基准测试，更重要的是引入了新范式：比如“生成式 UI”（Generative UI）以及 Antigravity 中的“<strong><strong>Agent</strong></strong>优先”（Agent-first）开发体验。</strong></p>
</blockquote>
<p>这是一个全球同步推进的战略举措。</p>
<p>目前的局面是：OpenAI 的 GPT-5 反响平平，Anthropic 赢得了开发者的心，而谷歌手握绝对的生态优势。</p>
<p>Antigravity 直接对标 Cursor 等代码工具，试图挑战现有的编程工作流；生成式 UI 则试图将 AI 的文本回复直接转化为交互式应用程序。</p>
<p>Gemini 时代开启已有两年。从目前的态势看，谷歌似乎暂时处于领先地位。</p>
<p>至于未来如何，时间会给出答案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小米技术教父，离职创业了！]]></title>    <link>https://juejin.cn/post/7574269207363256329</link>    <guid>https://juejin.cn/post/7574269207363256329</guid>    <pubDate>2025-11-20T00:39:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574269207363256329" data-draft-id="7574322843048722482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小米技术教父，离职创业了！"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-20T00:39:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CodeSheep"/> <meta itemprop="url" content="https://juejin.cn/user/4371313961738616"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小米技术教父，离职创业了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313961738616/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CodeSheep
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:39:31.000Z" title="Thu Nov 20 2025 00:39:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近，科技圈的又一位技术大佬被曝入局创业了。</p>
<p>没错，他就是小米的技术教父、小米前副总裁，同时也是雷军在武大念书时的下铺兄弟，并且在拍照时可以和雷军并列而坐的技术大佬崔神：</p>
<p><strong>崔宝秋</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb1de87a2f434f29ad09f736f77d6c50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203970&amp;x-signature=s3e6CjinS8aBnNyyVTtxnw7Opx0%3D" alt="崔宝秋（第一排右二）" loading="lazy"/></p>
<p>那这一次创业，据说大佬瞄准的也是当下炙手可热的「<strong>具身智能</strong>」赛道，创业方向为「<strong>家庭服务机器人</strong>」方向。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/976faa20965545f8be70e03eeb8a967e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203970&amp;x-signature=0EEXmWMiIRW7A2m0IIp6RZ7Jeww%3D" alt="" loading="lazy"/></p>
<p>并且在这次创业消息被曝之前，据传大佬已与多家顶级 VC 深入接洽，融资等进展顺利。</p>
<p><strong>说回到小米的发展历程，崔宝秋是其绕不开的一个人</strong>。</p>
<p>大家都知道，小米这个公司以产品见长。</p>
<p>提到小米产品，大家基本上都耳熟能详。从智能手机到影音数码，从家电生活到智能家居，另外各种软件、平台、云服务、OS等都在持续发力，包括现在又在全速力推新能源智能汽车，软硬件产品线可以说覆盖得非常广泛。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d3c9d5d49a74888b30e511d32cc9c15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203970&amp;x-signature=uN%2FQ4C9C55KsyemyBoCr%2F3nNWP8%3D" alt="" loading="lazy"/></p>
<p>但是说到「<strong>小米技术</strong>」，大家反而可能没有什么特别深的印象。</p>
<p>不过提到小米技术，就不得不提：<strong>小米集团技术委员会</strong>，其诞生于 2019 年初。</p>
<p>当时的 2018 年 Q4 季度，国内智能手机市场前五曾分别为：</p>
<p>华为、OPPO、VIVO、苹果、小米。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d6960606f90400eac7c06571b99a159~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203970&amp;x-signature=b9tmTdZ5kSVsap035wggBkmUTbo%3D" alt="" loading="lazy"/></p>
<p>其中前三家国产手机厂商出货量增幅均为正增长，而当时排名第 5 的小米则出现了较大跌幅。</p>
<p>彼时的雷军开始在内部会议中一直强调的一件事情就是：</p>
<p><strong>技术事关小米生死存亡</strong>。</p>
<p>在随后不久后的 2019 年 2 月，小米就专门成立了<strong>集团技术委员会</strong>，主要负责把握集团的技术方向，预研前沿技术，以及推动技术创新和成果转化。</p>
<p>小米技术委员会在小米的科技创新和产品研发中扮演着重要的角色。</p>
<p>而首任挂帅的正是小米当时的技术大牛：<strong>崔宝秋</strong>。</p>
<p>而聊起小米的技术研发，他更是绕不开的一个人。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42e257311fa84cb2bbedbee80090f3bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203970&amp;x-signature=Zi%2By%2FTASOi4wnRn1aLGdXSw82rA%3D" alt="" loading="lazy"/></p>
<p>崔宝秋和雷军都是武汉大学计算机系的同学，而且同时还是同寝室的上下铺室友。</p>
<p>在加入小米之前，崔宝秋在国外生活工作过很多年。</p>
<p>他曾在 IBM、雅虎和 LinkedIn 等知名公司负责研发，积累了丰富的技术和管理经验。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67047633f4cd42f990940b7b2d2063d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203970&amp;x-signature=rwKuHjGLlv0ovd%2FOfd%2FIqEpzxoI%3D" alt="" loading="lazy"/></p>
<p>众所周知，2012 年时候小米的手机业务初露头角。</p>
<p>同样也是这一年，崔宝秋应雷军之邀回国加入小米工作，并成为小米的首席架构师。</p>
<p>提到崔宝秋，有网友称其为“小米的技术教父”。</p>
<p>确实，崔宝秋在小米期间担任过多个重要职务，包括首席架构师、人工智能与云平台副总裁、集团技术委员会主席和集团学习发展部总经理等。</p>
<p>除此之外，他在小米期间的一个重大贡献就是主导并推动了小米「<strong>云计算-大数据-人工智能</strong>」的技术变革主线，为小米后来的技术发展奠定了基础。</p>
<p>然而，根据小米发布的内部全员信，2022 年底崔宝秋因个人原因从小米离职。</p>
<p>至此，崔神在小米的这段长达十年的职业生涯，也宣告结束了。</p>
<p>而这十年，也是小米这家公司从蓄力到发展，从厚积到薄发的十年。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/421ce1bbc3304c0f8e5802a0cb67bd7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203970&amp;x-signature=SFrQ5Wl1LDdQUVtp1Cxd8YBBMtA%3D" alt="" loading="lazy"/></p>
<p>自 2022 年底，崔宝秋从小米集团离职后在业界似乎一直就“隐身”了，随后几年也一直没有看到他比较明显的下一步职场动向。</p>
<p>那这一次机器人创业也是崔宝秋离职小米两年多后的一个比较大的动作。</p>
<p>怎么说呢，祝福崔神，也期待后续能看到大佬更多的发展和动向。</p>
<blockquote>
<p>注：本文在GitHub开源仓库「编程之路」 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frd2coding%2FRoad2Coding" target="_blank" title="https://github.com/rd2coding/Road2Coding" ref="nofollow noopener noreferrer">github.com/rd2coding/R…</a> 中已经收录，里面有我整理的6大编程方向(岗位)的自学路线+知识点大梳理、面试考点、我的简历、几本硬核pdf笔记，以及程序员生活和感悟，欢迎star。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Prisma 7 重磅发布：告别 Rust，拥抱 TypeScript，性能提升 3 倍]]></title>    <link>https://juejin.cn/post/7574343024324149289</link>    <guid>https://juejin.cn/post/7574343024324149289</guid>    <pubDate>2025-11-20T00:45:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574343024324149289" data-draft-id="7469816262752878603" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Prisma 7 重磅发布：告别 Rust，拥抱 TypeScript，性能提升 3 倍"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-20T00:45:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Prisma 7 重磅发布：告别 Rust，拥抱 TypeScript，性能提升 3 倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:45:47.000Z" title="Thu Nov 20 2025 00:45:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>最近在使用 NestJs 和 NextJs 在做一个协同文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">DocFlow</a>，如果感兴趣，欢迎 star，有任何疑问，欢迎加我微信进行咨询 <code>yunmz777</code></p>
<p>2025 年 11 月 19 日，Prisma 团队正式发布了 Prisma ORM 和 Prisma Postgres 的最新版本——Prisma 7。在过去的一年中，Prisma 团队始终将开发者体验放在首位，致力于让使用 Prisma 构建应用程序变得更加简单、高效。无论开发者使用何种开发工具，或选择在哪个平台部署，Prisma 7 都将带来卓越的开发体验。</p>
<h2 data-id="heading-0">为未来而设计</h2>
<h3 data-id="heading-1">愿景与承诺</h3>
<p>2024 年 12 月，Prisma 团队发布了 Prisma ORM 的未来发展路线图，详细阐述了他们的愿景以及实现这些目标的计划。这不仅仅是一份产品规划文档，更是 Prisma 团队对 Prisma ORM 未来发展的明确承诺，以及他们如何持续支持开发者社区的坚定决心。</p>
<p>与此同时，Prisma 团队还推出了自己的托管 Postgres 服务——Prisma Postgres。这款产品以简洁性和高性能为核心设计理念，旨在为开发者提供一个开箱即用的数据库解决方案，让开发者能够享受到与 Prisma ORM 同样出色的开发者体验。</p>
<p>随着 ORM 路线图的发布和 Prisma Postgres 的推出，Prisma 团队为构建下一代工具奠定了坚实的基础。市场反馈超出了他们的预期：ORM 的市场份额和使用量实现了显著增长，而 Prisma Postgres 在个人项目和商业应用中的采用率也令人瞩目。</p>
<h2 data-id="heading-2">重大技术突破</h2>
<h3 data-id="heading-3">从 Rust 到 TypeScript：一次大胆的架构转型</h3>
<p>在 Prisma 6.0.0 发布时，Prisma 团队承诺将带来更好的性能、更强的灵活性以及更完善的类型安全性。为了实现这些目标，他们需要做出一些根本性的改变。</p>
<h4 data-id="heading-4">为什么选择离开 Rust？</h4>
<p>Prisma 团队做出了一个看似反直觉的决定：将 Prisma Client 从 Rust 迁移到 TypeScript。对于许多人来说，这可能是一个令人困惑的选择，毕竟 Rust 以其卓越的性能而闻名。但在 Prisma 的场景下，性能只是故事的一部分。</p>
<p>使用 Rust 构建客户端的一个显著副作用是，它限制了社区贡献者的参与门槛。如果开发者没有深厚的 Rust 开发经验，想要为 ORM 做出有意义的贡献将变得非常困难。从技术角度来看，Rust 与 JavaScript 运行时之间的通信层比纯 JavaScript 实现要慢得多，同时还会在运行时层面引入额外的依赖关系。</p>
<p>Deno 团队的 Luca Casonato 对此深有感触：</p>
<blockquote>
<p>"当我们听说 Prisma 要从 Rust 迁移时，我们意识到不再需要处理原生插件 API，这将让在 Deno 中支持 Prisma 变得简单得多。我们所有人都对此感到非常兴奋！"</p>
</blockquote>
<h4 data-id="heading-5">迁移带来的显著收益</h4>
<p>迁移到纯 TypeScript 客户端为更快的运行时、更小的体积和更简单的部署流程奠定了基础。开发者不再需要担心特定运行时的兼容性问题，也不必担心像 Cloudflare Workers 这样的基础设施提供商对应用大小的限制。</p>
<p>经过持续迭代和优化，Prisma 团队取得了令人瞩目的成果：</p>
<ul>
<li>体积减少 90%：打包输出大幅缩小</li>
<li>性能提升 3 倍：查询执行速度显著加快</li>
<li>资源占用降低：CPU 和内存利用率大幅下降</li>
<li>部署更简单：Vercel Edge 和 Cloudflare Workers 的部署流程更加顺畅</li>
</ul>
<p>这些改进都有详尽的基准测试数据支持。更重要的是，开发者无需重构整个应用程序就能享受到这些好处，迁移过程非常简单直接。</p>
<p>知名开发者 Kent C. Dodds 在体验后给出了积极反馈：</p>
<blockquote>
<p>"我在几周前完成了升级，整个过程非常顺利。切换到新的无 Rust 客户端是如此简单，这真是太棒了。"</p>
</blockquote>
<h3 data-id="heading-6">生成代码的新归宿：从 node_modules 到项目源码</h3>
<h4 data-id="heading-7">工作流程的优化</h4>
<p>Prisma 团队认真听取了社区关于生成代码处理方式的反馈，并进行了重大改进。此前，Prisma 习惯在项目的 <code>node_modules</code> 目录中生成客户端代码。虽然这样做让生成的客户端看起来像普通库一样，但随着时间推移，他们发现这种方式严重影响了开发者的工作流程。</p>
<p>当客户端需要更新时，所有应用相关的进程都必须先停止，然后才能重新生成类型。这不仅打断了开发流程，还降低了开发效率。</p>
<p>现在，Prisma 默认在项目源代码目录中生成类型和 Prisma Client。这样一来，开发者现有的开发和构建工具会将其视为应用程序的一部分。当开发者修改模型并运行 <code>prisma generate</code> 时，工具和文件监视器可以立即响应这些变化，保持开发工作流程的连续性。整个 Prisma 配置现在真正成为了项目的一部分，而不再是隐藏在 <code>node_modules</code> 中的"黑盒"。</p>
<h4 data-id="heading-8">全新的配置文件系统</h4>
<p>Prisma 团队还引入了全新的 Prisma 配置文件，支持动态项目配置。这个配置文件的核心目的是将数据定义与 Prisma 的数据交互方式分离开来。</p>
<p>在此之前，项目配置分散在 Prisma schema 文件或 <code>package.json</code> 中。新的 Prisma 配置文件统一了配置管理，开发者可以在一个地方定义 schema 位置、种子脚本或数据库 URL。由于配置文件支持 JavaScript 或 TypeScript 格式，开发者可以使用 <code>dotenv</code> 等工具进行动态配置，这为开发者提供了更大的灵活性，也符合现代开发工具的标准。</p>
<h3 data-id="heading-9">类型系统的性能革命</h3>
<h4 data-id="heading-10">与 ArkType 的合作</h4>
<p>类型安全是 Prisma ORM 的核心优势之一。Prisma 团队不仅要确保提供正确的类型，还要以最高效的方式实现。为了改进类型生成系统，他们与 ArkType 的创建者 David Blass 展开了深度合作，全面评估了类型生成表现。</p>
<p>评估结果令人振奋：</p>
<ul>
<li>Schema 评估类型减少 98%：大幅降低了类型系统的复杂度</li>
<li>查询评估类型减少 45%：查询相关的类型开销显著降低</li>
<li>类型检查速度提升 70%：完整的类型检查过程更加快速</li>
</ul>
<h4 data-id="heading-11">为什么这很重要？</h4>
<p>与生态系统中的其他 ORM 相比，Prisma 生成的类型不仅评估速度更快，而且需要更少的类型定义就能为开发者提供有用的 TypeScript 信息。这意味着开发者可以更自信地构建应用程序，因为 Prisma 提供的类型安全不仅快速，而且开销更小。</p>
<h2 data-id="heading-12">Prisma Postgres：为所有人打造的数据库服务</h2>
<h3 data-id="heading-13">不仅仅是 ORM</h3>
<p>Prisma 不仅仅是一个 ORM 工具。Prisma 团队推出的托管 Postgres 数据库服务旨在解决开发者在开始使用 Prisma ORM 时面临的首要问题——如何快速获得一个可用的数据库。</p>
<h3 data-id="heading-14">技术架构优势</h3>
<p>Prisma Postgres 基于由 unikernel microVM 驱动的裸机基础设施构建。这意味着数据库服务不仅启动快速，而且能够持续保持高性能。Prisma 团队始终将开发者体验放在首位，自动处理所有复杂的运维工作，让开发者无需关心服务器配置、资源分配等底层细节。</p>
<p>所有配置和管理工作都由 Prisma 团队负责，Prisma Postgres 与 Prisma ORM 实现了原生集成，为开发者提供与 ORM 同样出色的开发者体验。</p>
<h3 data-id="heading-15">极简的启动流程</h3>
<p>开始使用 Prisma Postgres 非常简单，只需在终端运行一个命令即可。系统会自动为开发者配置数据库，并提供认领链接。对于在开发工作流程中使用 AI 代理的开发者，Prisma 还提供了专用的 API 和 MCP 服务器，可以在需要时自动创建和管理数据库。</p>
<p>Jason Lengstorf 分享了他的使用体验：</p>
<blockquote>
<p>"每当我使用 Prisma 时，我都会按照入门指南安装各种工具，然后才意识到我还需要去获取一个数据库。我总是在这个过程中感到困惑，所以能够如此轻松地创建数据库真是太棒了！"</p>
</blockquote>
<h3 data-id="heading-16">标准协议支持</h3>
<p>Prisma Postgres 并没有止步于简单的数据库托管。Prisma 团队现在采用了标准的 Postgres 连接协议，这意味着更广泛的生态系统工具都可以与数据库通信。无论是 Cloudflare Hyperdrive、TablePlus、Retool，还是其他 ORM 工具，都可以无缝使用 Prisma Postgres。</p>
<p>这一切都得益于 Prisma Postgres 基于标准 Postgres 构建，同时针对最佳使用体验进行了优化。</p>
<h2 data-id="heading-17">其他重要更新</h2>
<p>这个版本包含了大量改进和新功能，如果一一详述，这篇文章会变得非常冗长。</p>
<p>Prisma 团队花费了大量时间处理积压的问题和功能请求，解决了一些最受社区关注的需求，包括：</p>
<ul>
<li>映射枚举支持</li>
<li>更新了项目所需的最低 Node.js 和 TypeScript 版本</li>
<li>全新版本的 Prisma Studio（通过 <code>npx prisma studio</code> 访问）</li>
</ul>
<p>开发者可以在 Prisma 的更新日志中找到此版本的所有详细内容，Prisma 团队还提供了完整的迁移指南帮助开发者顺利升级。</p>
<h2 data-id="heading-18">结语</h2>
<p>对 Prisma 团队而言，Prisma 7 不仅仅是一个版本发布，更是 Prisma ORM 和 Prisma Postgres 未来发展的基石。他们希望构建的工具能够为开发者提供最佳体验，让开发者能够专注于构建和发布出色的应用程序。</p>
<p>Prisma 团队特别感谢他们令人难以置信的社区，以及所有在预发布阶段提供宝贵反馈的开发者。如果开发者正在尝试 Prisma 7，可以向 Prisma 团队反馈想法和体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手教你实现 Rust 迭代器]]></title>    <link>https://juejin.cn/post/7574251313884250127</link>    <guid>https://juejin.cn/post/7574251313884250127</guid>    <pubDate>2025-11-20T00:54:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574251313884250127" data-draft-id="7571355989132771343" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手教你实现 Rust 迭代器"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2025-11-20T00:54:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手教你实现 Rust 迭代器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:54:59.000Z" title="Thu Nov 20 2025 00:54:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#5f6368;background-image:linear-gradient(90deg,rgba(240,191,213,.1) 3%,transparent 0),linear-gradient(1turn,rgba(240,191,213,.1) 3%,transparent 0);background-size:20px 20px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-left:50px;padding-bottom:5px;color:#5f6368}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:0;display:block;content:""}.markdown-body h1{font-size:32px;margin-bottom:5px}.markdown-body h1:before{top:0;content:"🦄";font-size:32px}.markdown-body h2{padding-bottom:24px;border-bottom:1px solid #ececec}.markdown-body h2:before{top:0;left:8px;content:"🐳";font-size:24px}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{top:-2px;left:8px;content:"🐄";font-size:20px}.markdown-body h4{font-size:16px}.markdown-body h4:before{top:-2px;left:8px;content:"🦥";font-size:18px}.markdown-body h5{font-size:14px}.markdown-body h5:before{top:-2px;left:9px;content:"🦩";font-size:16px}.markdown-body h6{font-size:12px;margin-top:5px}.markdown-body h6:before{top:-1px;left:10px;content:"🐧";font-size:14px}.markdown-body p{line-height:1.9;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid rgba(253,121,168,.5);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#a6accd;background:#292d3e;border-radius:8px}.markdown-body a{text-decoration:none;color:#fd79a8;border-bottom:1px solid #fd79a8;padding:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(253,121,168,.1);color:#ee69a9}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body th{color:#fd79a8}.markdown-body th,.markdown-body tr:hover{background:rgba(253,121,168,.1)}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;color:#666;padding:23px;margin:22px 0;border-left:4px solid #ee69a9;background-color:rgba(253,121,168,.1)}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;display:block;font-size:27px;color:#fd79a8;opacity:.8}.markdown-body blockquote:before{left:10px;top:0;content:"❝"}.markdown-body blockquote:after{right:10px;bottom:0;content:"❞"}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body strong{position:relative;color:#fd79a8}.markdown-body strong:before{content:"· "}.markdown-body strong:after{content:" ·"}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#fd79a8}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ee69a9}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15c6522aca6c455eb033fa92e4593acb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764204899&amp;x-signature=Q632iWiQ3UHqHpydBhqxNqGUNYc%3D" alt="0.png" loading="lazy"/></p>
<p>在完成前面三篇关于 Rust 迭代器的深入学习之后，本篇文章我们尝试自己写一下 Rust 迭代器，即给我们自己的数据加上迭代器的功能。</p>
<p>如果有读者想复习之前的文章：</p>
<ul>
<li><a href="https://juejin.cn/post/7566474134688595983" target="_blank" title="https://juejin.cn/post/7566474134688595983">深入 Rust 迭代器（上）</a></li>
<li><a href="https://juejin.cn/post/7568471321954779170" target="_blank" title="https://juejin.cn/post/7568471321954779170">深入 Rust 迭代器（中）</a></li>
<li><a href="https://juejin.cn/post/7572028313930776616" target="_blank" title="https://juejin.cn/post/7572028313930776616">深入 Rust 迭代器（下）</a></li>
</ul>
<h2 data-id="heading-0">开始之前</h2>
<p>Rust 原生的 <code>Vec</code> 以及数组，已经支持迭代器相关功能了：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">a</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;a {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

a.<span class="hljs-title function_ invoke__">iter_mut</span>().<span class="hljs-title function_ invoke__">for_each</span>(|i| {
    *i = <span class="hljs-number">100</span>;
});

<span class="hljs-built_in">println!</span>(<span class="hljs-string">"{:?}"</span>, a);

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// [100, 100, 100]</span>
</code></pre>
<p><em>上述代码如果将 <code>vec![1, 2, 3]</code> 改成 <code>[1, 2, 3]</code>，效果是一样的。</em></p>
<p>如果你的数据结构有基于 <code>Vec</code> 或者数组去实现迭代器，其实可以直接用 <code>Vec</code> 或者数组的迭代器，完全没有必要自己实现。</p>
<p>但是为了让我们更加了解迭代器的内部原理以及相关的实现细节，该篇文章我们尝试为自己的数据实现一个迭代器。</p>
<p>首先，你需要一个简单的类：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rect</span> {
    a: <span class="hljs-type">f32</span>,
    b: <span class="hljs-type">f32</span>,
    c: <span class="hljs-type">f32</span>,
    d: <span class="hljs-type">f32</span>,
}
</code></pre>
<h2 data-id="heading-1">为类实现迭代器</h2>
<p>在 <a href="https://juejin.cn/post/7566474134688595983" target="_blank" title="https://juejin.cn/post/7566474134688595983">深入 Rust 迭代器（上）</a> 文中已经知道，如果我们要为自己的数据实现一个迭代器，就需要实现 <code>Iterator</code> <code>trait</code>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Rect</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-comment">//...</span>
    }
}
</code></pre>
<p>该 <code>trait</code> 需要实现的函数非常简单 —— <code>next</code> 即可。</p>
<p><code>next</code> 返回一个 <code>Option</code>，如果迭代器结束，直接返回 <code>None</code>。</p>
<p>为了能够实现迭代器功能，我们需要对 <code>Rect</code> 进行一点改造，添加一个迭代器下标：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rect</span> {
    a: <span class="hljs-type">f32</span>,
    b: <span class="hljs-type">f32</span>,
    c: <span class="hljs-type">f32</span>,
    d: <span class="hljs-type">f32</span>,

    iter_index:<span class="hljs-type">u8</span>, <span class="hljs-comment">// 用于计数当前迭代的位置</span>
}
</code></pre>
<p>然后，为 <code>Rect</code> 实现迭代器：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Rect</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">next</span> = <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.iter_index {
            <span class="hljs-number">0</span> =&gt; {
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.a)
            }
            <span class="hljs-number">1</span> =&gt; {
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.b)
            }
            <span class="hljs-number">2</span> =&gt; {
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.c)
            }
            <span class="hljs-number">3</span> =&gt; {
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.d)
            }
            _ =&gt; <span class="hljs-literal">None</span>,
        };

        <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;

        next
    }
}
</code></pre>
<p><em>现在知道为什么 <code>next</code> 需要的入参是 <code>&amp;mut self</code> 了吧！</em></p>
<p>每次调用 <code>next</code> 的时候，我们先返回当前的值，然后对迭代的下标 <code>+1</code>。</p>
<p>如果迭代结束了，则返回 <code>None</code>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
    iter_index: <span class="hljs-number">0</span>,
};

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> rect {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// 4</span>
</code></pre>
<p>OK，很简单。</p>
<p>但是这样写，会有两个严重问题：</p>
<ul>
<li><code>iter_index</code> 对迭代的影响很大，如果这个值设置错误，迭代就不能从头开始。</li>
<li>无法再次使用迭代，即不能再次使用 <code>for i in rect</code>。</li>
</ul>
<p>我们来看第一个问题，如果我们给 <code>iter_index</code> 为 <code>3</code>。结果就会变成：</p>
<pre><code class="hljs language-txt" lang="txt">4
</code></pre>
<p>对，只会输出一个 <code>4</code>，因为我们的 <code>next</code> 实现，是基于 <code>iter_index</code> 做的。</p>
<p>第二个问题，当我们再次使用 <code>rect</code> 进行迭代的时候：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/783ddd43b6e74cdbb4e06d6a176b1dcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764204899&amp;x-signature=InEjz2VEKQz5Dw8Kv6n8fqBoBQ0%3D" alt="1.png" loading="lazy"/></p>
<p>会得到这样一个错误。</p>
<p>原因是，<code>for i in rect</code> 是 Rust 提供的语法糖，实际上那段代码会被编译成如下的代码：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">iter</span> = <span class="hljs-built_in">IntoIterator</span>::<span class="hljs-title function_ invoke__">into_iter</span>(collection);
<span class="hljs-keyword">loop</span> {
    <span class="hljs-keyword">match</span> iter.<span class="hljs-title function_ invoke__">next</span>() {
        <span class="hljs-title function_ invoke__">Some</span>(i) =&gt; {
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
        }
        <span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">break</span>,
    }
}
</code></pre>
<p>查看 <code>IntoIterator::into_iter</code> 的源码，我们发现：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[inline]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> I {
    <span class="hljs-keyword">self</span>
}
</code></pre>
<p><code>IntoIterator::into_iter</code> 会获取入参的所有权，这也就是为什么不能写两次 <code>for i in rect</code> 的原因。</p>
<p>为了解决上面两个问题，我们看看正确的迭代器是如何实现的。</p>
<h2 data-id="heading-2">IntoIterator</h2>
<p>Rust 提供了一个 <code>trait</code> —— <code>IntoIterator</code>，它的作用就是<strong>把一个“可迭代的东西”（比如容器）转换成一个“迭代器”</strong>。</p>
<p>这里，我们的 <code>Rect</code> 就是一个可迭代的数据，通过实现 <code>IntoIterator</code> 就可以变成一个迭代器了。</p>
<pre><code class="hljs language-rust" lang="rust">
<span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rect</span> {
    a: <span class="hljs-type">f32</span>,
    b: <span class="hljs-type">f32</span>,
    c: <span class="hljs-type">f32</span>,
    d: <span class="hljs-type">f32</span>,
    <span class="hljs-comment">// 这里去掉了 iter_index</span>
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectIter</span> {
    data: Rect,
    iter_index: <span class="hljs-type">u8</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectIter</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.iter_index {
            <span class="hljs-number">0</span> =&gt; {
                <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.data.a)
            }
            <span class="hljs-number">1</span> =&gt; {
                <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.data.b)
            }
            <span class="hljs-number">2</span> =&gt; {
                <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.data.c)
            }
            <span class="hljs-number">3</span> =&gt; {
                <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.data.d)
            }
            _ =&gt; <span class="hljs-literal">None</span>,
        }
    }
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">IntoIterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Rect</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">IntoIter</span> = RectIter;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span>::IntoIter {
        RectIter {
            data: <span class="hljs-keyword">self</span>,
            iter_index: <span class="hljs-number">0</span>,
        }
    }
}
</code></pre>
<p>读者会发现，我们对 <code>Rect</code> 实现了 <code>IntoIterator</code>，该 <code>trait</code> 要求返回一个 <code>IntoIter</code> 类型，<code>IntoIter</code> 实际上是 <code>type IntoIter: Iterator&lt;Item = Self::Item&gt;;</code>，也就是一个迭代器。</p>
<p>此处，我们定义了一个新的迭代器类型 <code>RectIter</code> 并实现了 <code>Iterator</code>，最后 <code>IntoIterator</code> 中的 <code>into_iter(self)</code> 返回 <code>RectIter</code>。</p>
<p>好的，现在我们来看看效果：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
};

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> rect {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// 4</span>
</code></pre>
<p>我们不用再在 <code>Rect</code> 中定义迭代下标了，当使用迭代器的时候，<code>RectIter</code> 中的迭代下标，都会设置为 <code>0</code> 开始。</p>
<p>但是它依然没有解决重复使用的问题，也就是我们不能再次迭代 <code>Rect</code>。</p>
<h2 data-id="heading-3">迭代 &amp;</h2>
<p>我们要做的事情实际上很简单，就是为 <code>&amp;Rect</code> 提供一个迭代器，这样我们就可以针对 <code>&amp;Rect</code> 进行迭代了。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 为 &amp;Rect 创建一个迭代器结构体（借用型）</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    rect: &amp;<span class="hljs-symbol">'a</span> Rect,
    index: <span class="hljs-type">usize</span>,
}

<span class="hljs-comment">// 为 RectRefIterator 实现 Iterator trait</span>
<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.index {
            <span class="hljs-number">0</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.a),
            <span class="hljs-number">1</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.b),
            <span class="hljs-number">2</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.c),
            <span class="hljs-number">3</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.d),
            _ =&gt; <span class="hljs-literal">None</span>,
        };
        <span class="hljs-keyword">self</span>.index += <span class="hljs-number">1</span>;
        result
    }
}

<span class="hljs-comment">// 为 &amp;Rect 实现 IntoIterator trait（借用型）</span>
<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">IntoIterator</span> <span class="hljs-keyword">for</span> &amp;<span class="hljs-symbol">'a</span> Rect {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">IntoIter</span> = RectRefIterator&lt;<span class="hljs-symbol">'a</span>&gt;;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span>::IntoIter {
        RectRefIterator {
            rect: <span class="hljs-keyword">self</span>,
            index: <span class="hljs-number">0</span>,
        }
    }
}
</code></pre>
<p>我们直接定义让 <code>&amp;Rect</code> 实现 <code>IntoIterator</code> <code>trait</code>，这里的写法比较长：<code>impl&lt;'a&gt; IntoIterator for &amp;'a Rect</code>。</p>
<p><code>'a</code> 是一个生命周期标注，如果你还不熟悉生命周期标注，可以先跳过，我们可以简单的理解为如果你有引用类型，需要帮助编译器来确定这个引用能存活多长时间。</p>
<p>此时，返回的 <code>IntoIter</code> 类型我们需要重新定义一个 <code>RectRefIterator&lt;'a&gt;</code>，同样，它会持有一个 <code>&amp;'a Rect</code>，即 <code>&amp;Rect</code> 类型。</p>
<p>这样，我们就可以多次遍历了。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
};

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;rect { <span class="hljs-comment">// 注意这里是 &amp;rect</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;rect {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;rect {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}
</code></pre>
<p>如果你想消耗掉 <code>rect</code>，<code>for i in rect</code> 即可。</p>
<p>那么，如果我想支持 <code>&amp;mut</code> 呢？</p>
<h2 data-id="heading-4">迭代 &amp;mut</h2>
<p><code>for i in &amp;mut rect</code> 一般这种迭代形式，是说我想在迭代的时候更改元素，例如下面这个在迭代的时候更改数组里面的值：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;<span class="hljs-keyword">mut</span> a {
    *i = <span class="hljs-number">100</span>;
}
</code></pre>
<p>好的，这应该是所有迭代器中，编写最麻烦的一个了。</p>
<p>我们尝试，按照上面那个写法，写一个迭代器试试：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectMutRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    rect: &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> Rect,
    index: <span class="hljs-type">usize</span>,
}

<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectMutRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {

        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">index</span> = <span class="hljs-keyword">self</span>.index;
        <span class="hljs-keyword">self</span>.index += <span class="hljs-number">1</span>;

        <span class="hljs-keyword">match</span> index {
            <span class="hljs-number">0</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.rect.a),
            <span class="hljs-number">1</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.rect.b),
            <span class="hljs-number">2</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.rect.c),
            <span class="hljs-number">3</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.rect.d),
            _ =&gt; <span class="hljs-literal">None</span>,
        }
    }
}
</code></pre>
<p>其实就是把 <code>&amp;Rect</code> 变成了 <code>&amp;mut Rect</code>。</p>
<p>但是这段代码是无法通过编译的，你会得到这样一段提示</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef5186aa630045f3b147d72129ed0b46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764204899&amp;x-signature=TZ7vjlo4Gy4d%2Ft%2BIQqjycdxyNr8%3D" alt="2.png" loading="lazy"/></p>
<p>这里简单解释一下，<code>fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt;</code> 实际上是 <code>fn next(&amp;mut self) -&gt; Option&lt;&amp;'a mut f32&gt;</code>，这个函数需要返回一个带 <code>'a</code> 生命周期的引用，但是 Rust 编译器不知道这个 <code>'a</code> 从哪儿来的，Rust 函数的生命周期标注，必须要有一个来源。</p>
<p>那么如果我们改成 <code>fn next(&amp;'a mut self)</code> ?</p>
<p>也不行，因为 <code>impl&lt;'a&gt; Iterator</code> 的函数定义不是这样的，此时，似乎陷入一个僵局了···</p>
<p>由于这个地方过于复杂，我们不再深入探讨，我先给出用正确答案的一种：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-comment">// 1. 自定义迭代器结构体</span>
<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectMutIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-comment">// 指向 Rect 内部当前 f32 元素的原始可变指针。</span>
    ptr: *<span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>,
    <span class="hljs-comment">// 剩余的元素数量。</span>
    len: <span class="hljs-type">usize</span>,
    <span class="hljs-comment">// 生命周期标记：将迭代器的生命周期 'a 绑定到 Rect 的 &amp;mut 借用上。</span>
    _marker: PhantomData&lt;&amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>&gt;,
}

<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-comment">// 2. 针对 &amp;mut Rect 实现 IntoIterator</span>
<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-keyword">impl</span> &lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">IntoIterator</span> <span class="hljs-keyword">for</span> &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> Rect {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>;
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">IntoIter</span> = RectMutIterator&lt;<span class="hljs-symbol">'a</span>&gt;;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span>::IntoIter {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">ptr_f32</span> = <span class="hljs-keyword">self</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> Rect <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>;

        RectMutIterator {
            ptr: ptr_f32,
            len: <span class="hljs-number">4</span>, <span class="hljs-comment">// 字段总数</span>
            _marker: PhantomData,
        }
    }
}

<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-comment">// 3. 迭代器的实现</span>
<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectMutIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>; <span class="hljs-comment">// 返回 f32 的可变引用</span>

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-comment">// 1. 检查是否迭代完毕</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.len == <span class="hljs-number">0</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>;
        }

        <span class="hljs-comment">// 2. 减少剩余元素计数</span>
        <span class="hljs-keyword">self</span>.len -= <span class="hljs-number">1</span>;

        <span class="hljs-comment">// 3. 核心 unsafe 逻辑</span>
        <span class="hljs-keyword">unsafe</span> {
            <span class="hljs-comment">// 获取当前元素的指针</span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">current_ptr</span> = <span class="hljs-keyword">self</span>.ptr;

            <span class="hljs-comment">// 将内部指针移动到下一个元素</span>
            <span class="hljs-comment">// offset(1) 是一个 safe 抽象，但它内部执行的是 unsafe 指针算术</span>
            <span class="hljs-comment">// 它确保 `self.ptr` 现在指向下一个 f32 (即下一个字段)</span>
            <span class="hljs-keyword">self</span>.ptr = <span class="hljs-keyword">self</span>.ptr.<span class="hljs-title function_ invoke__">offset</span>(<span class="hljs-number">1</span>);

            <span class="hljs-comment">// 4. 将当前的原始指针转换回安全的 &amp;mut f32 引用</span>
            <span class="hljs-comment">// 这是安全的，因为我们通过 len 和 ptr 的管理，</span>
            <span class="hljs-comment">// 确保了当前元素是独占的，且生命周期被正确绑定。</span>
            <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> *current_ptr)
        }
    }
}
</code></pre>
<p>我们测试一下看看：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">rect</span> = Rect {
     a: <span class="hljs-number">1.0</span>,
     b: <span class="hljs-number">2.0</span>,
     c: <span class="hljs-number">3.0</span>,
     d: <span class="hljs-number">4.0</span>,
 };

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;<span class="hljs-keyword">mut</span> rect {
     *i += <span class="hljs-number">10.0</span>;
 }

<span class="hljs-built_in">println!</span>(<span class="hljs-string">"{:?}"</span>, rect);

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// Rect { a: 11.0, b: 12.0, c: 13.0, d: 14.0 }</span>
</code></pre>
<p>结果是正确的。</p>
<p>好的，到此，几种基本的迭代器类型我们已经实现完毕了。除了 <code>&amp;mut</code> 比较复杂以外，其他两种还算是轻松。</p>
<h2 data-id="heading-5">Rust 的一些习惯</h2>
<p>实际上，Rust 中针对迭代器，还有一些习惯，我们在 <a href="https://juejin.cn/post/7566474134688595983" target="_blank" title="https://juejin.cn/post/7566474134688595983">深入 Rust 迭代器（上）</a> 提到 Rust 迭代器中，有三种等价情况：</p>
<ul>
<li><code>for i in &amp;vec</code> 等价于 <code>for i in vec.iter()</code>。</li>
<li><code>for i in &amp;mut</code> 等价于 <code>for i in vec.iter_mut()</code>。</li>
<li><code>for i in vec</code> 等价于 <code>for i in vec.into_iter()</code>。</li>
</ul>
<p>所以，我们给 <code>Rect</code> 添加一下这三个方法：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Rect</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">iter_mut</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> RectMutIterator {
        RectMutIterator {
            ptr: <span class="hljs-keyword">self</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> Rect <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>,
            len: <span class="hljs-number">4</span>,
            _marker: PhantomData,
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">iter</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> RectRefIterator {
        RectRefIterator {
            rect: <span class="hljs-keyword">self</span>,
            index: <span class="hljs-number">0</span>,
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> RectIter {
        RectIter {
            data: <span class="hljs-keyword">self</span>,
            iter_index: <span class="hljs-number">0</span>,
        }
    }
}
</code></pre>
<p>这样，我们就可以使用迭代器适配器方法和管道了：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
};

rect.<span class="hljs-title function_ invoke__">iter_mut</span>().<span class="hljs-title function_ invoke__">for_each</span>(|i| {
    *i += <span class="hljs-number">10.0</span>;
});

rect.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">for_each</span>(|a| <span class="hljs-built_in">print!</span>(<span class="hljs-string">"{:?} "</span>, a));

<span class="hljs-built_in">println!</span>();

rect.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">for_each</span>(|a| <span class="hljs-built_in">print!</span>(<span class="hljs-string">"{:?} "</span>, a));

<span class="hljs-built_in">println!</span>();

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 11.0 12.0 13.0 14.0</span>
<span class="hljs-comment">// 11.0 12.0 13.0 14.0</span>
</code></pre>
<h2 data-id="heading-6">倒序</h2>
<p>在 <a href="https://juejin.cn/post/7572028313930776616" target="_blank" title="https://juejin.cn/post/7572028313930776616">深入 Rust 迭代器（下）</a> 中，我们最后提到一个 <code>rev()</code>，也就是迭代器倒序。这里我们也实现一下，这样你就能明白那篇文章中，为什么输出结果是那样的了。</p>
<p>我们仅针对 <code>&amp;Rect</code> 实现倒序。</p>
<p>为了实现倒序，我们需要给 <code>RectRefIterator</code> 添加一个 <code>end</code> 字段，该字段和 <code>index</code> 其实效果是一样的，用于标识当前应该返回哪个数据。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    rect: &amp;<span class="hljs-symbol">'a</span> Rect,
    index: <span class="hljs-type">usize</span>,
    end: <span class="hljs-type">usize</span>,
}
</code></pre>
<p>接下来在所有用到 <code>RectRefIterator</code> 的地方，设置 <code>end</code> 为 <code>4</code>：</p>
<pre><code class="hljs language-rust" lang="rust">RectRefIterator {
    rect: <span class="hljs-keyword">self</span>,
    index: <span class="hljs-number">0</span>,
    end: <span class="hljs-number">4</span>,
}
</code></pre>
<p>为了能够让迭代器支持 <code>rev()</code>，我们需要实现一个 <code>DoubleEndedIterator</code> 的 <code>trait</code>，该 <code>trait</code> 只需要实现 <code>fn next_back(&amp;mut self)</code> 即可，即倒着返回数据。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> &lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">DoubleEndedIterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next_back</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.end {
            <span class="hljs-number">1</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.a),
            <span class="hljs-number">2</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.b),
            <span class="hljs-number">3</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.c),
            <span class="hljs-number">4</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.d),
            _ =&gt; <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>,
        };
        <span class="hljs-keyword">self</span>.end -= <span class="hljs-number">1</span>;
        result
    }
}
</code></pre>
<p>好，万事俱备，我们测试一下：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
};

rect.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">rev</span>().<span class="hljs-title function_ invoke__">for_each</span>(|a| <span class="hljs-built_in">print!</span>(<span class="hljs-string">"{:?} "</span>, a));

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 4.0 3.0 2.0 1.0</span>
</code></pre>
<p>完美。</p>
<h2 data-id="heading-7">总结</h2>
<p>好的，关于 Rust 迭代器的这个系列，终于迎来了完结。</p>
<p>我们在最后这篇文章中，给自己的数据实现了迭代器功能。</p>
<p>通过我们手动编写迭代器，我们不仅学会了如何实现迭代器，也加深了对 Rust 中数据使用的理解，你会发现，Rust 始终围绕<strong>所有权</strong>、<strong>借用</strong>、<strong>可变借用</strong>来实现数据的访问。</p>
<p>这种设计不是限制，而是一种引导——它迫使我们在编写代码的时候就思考：</p>
<ul>
<li>谁拥有数据？</li>
<li>谁在读取或修改它？</li>
<li>生命周期是否安全？</li>
</ul>
<p>正是这些看似“严格”的规则，让 Rust 能在不依赖垃圾回收的情况下，既保证内存安全，又实现零成本抽象。而迭代器，正是这一哲学的完美体现：它把控制权交给开发者，又用类型系统默默守护着每一份引用的安全。</p>
<p>现在，当你再看到 <code>for x in vec</code> 时，或许不再只觉得它简洁优雅，更能体会到背后那套精密、可靠、充满智慧的机制在默默运转。</p>
<p>感谢你一路走到这里。愿你在 Rust 的旅程中，继续享受这种“被约束的自由”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 编程实战：内存管理与垃圾回收机制]]></title>    <link>https://juejin.cn/post/7574289653178253350</link>    <guid>https://juejin.cn/post/7574289653178253350</guid>    <pubDate>2025-11-20T00:56:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574289653178253350" data-draft-id="7574269207363338249" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 编程实战：内存管理与垃圾回收机制"/> <meta itemprop="keywords" content="后端,Python,Trae"/> <meta itemprop="datePublished" content="2025-11-20T00:56:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 编程实战：内存管理与垃圾回收机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:56:57.000Z" title="Thu Nov 20 2025 00:56:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>Python 把“内存管理”做得很贴心，大部分时候你不用自己管，但作为进阶开发者，理解它的原理会让你在写高性能、长运行、数据量大的程序时更有把握。</p>
</blockquote>
<p>本篇带你一次吃透：</p>
<ul>
<li>内存是怎么分配的</li>
<li>Python 如何判断对象能不能回收</li>
<li>循环引用为什么会成为坑</li>
<li>如何手动介入优化内存</li>
</ul>
<hr/>
<h2 data-id="heading-0">1. Python 内存管理的整体设计</h2>
<p>简单一句话：</p>
<p><strong>Python 使用引用计数（Reference Counting）为主，垃圾回收（Garbage Collection）为辅，同时内置私有内存池以提升性能。</strong></p>
<p>也就是说：</p>
<ul>
<li>小对象 → Python 自己管理（小对象池）</li>
<li>大对象 → 交给操作系统</li>
<li>对象什么时候能被释放 → 主要看“引用计数”</li>
<li>引用计数无法解决的“循环引用”，交给“垃圾回收器（gc）”</li>
</ul>
<p>这套机制让 Python 运行时保持高效而稳定。</p>
<hr/>
<h2 data-id="heading-1">2. 引用计数：Python 最核心的内存判定机制</h2>
<p>每个对象都有一个引用计数（refcount）：</p>
<ul>
<li>当一个变量指向对象 → 计数 +1</li>
<li>变量重新赋值/离开作用域 → 计数 -1</li>
<li>数量变为 0 → 对象立刻释放内存</li>
</ul>
<p>例如：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sys

a = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
<span class="hljs-built_in">print</span>(sys.getrefcount(a))   <span class="hljs-comment"># 2 （一个是a，一个是参数传递）</span>
b = a
<span class="hljs-built_in">print</span>(sys.getrefcount(a))   <span class="hljs-comment"># 3</span>
<span class="hljs-keyword">del</span> b
<span class="hljs-built_in">print</span>(sys.getrefcount(a))   <span class="hljs-comment"># 2</span>
</code></pre>
<p>引用计数机制简单直接，“计数为 0 就释放”，所以 Python 中大多数对象释放是 <strong>即时</strong> 的。</p>
<hr/>
<h2 data-id="heading-2">3. 循环引用：引用计数搞不定的硬茬子</h2>
<p>问题来了：如果两个对象互相引用，会怎样？</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.<span class="hljs-built_in">next</span> = <span class="hljs-literal">None</span>

a = Node()
b = Node()

a.<span class="hljs-built_in">next</span> = b
b.<span class="hljs-built_in">next</span> = a
</code></pre>
<p>即便你执行：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">del</span> a
<span class="hljs-keyword">del</span> b
</code></pre>
<p>对象的引用计数依然不为 0，因为它们互相指着自己。
这种情况就需要 Python 的 <strong>GC（垃圾回收器）</strong> 出手了。</p>
<hr/>
<h2 data-id="heading-3">4. Python 的垃圾回收：处理循环引用之神</h2>
<p>Python 内存回收使用 <strong>分代垃圾回收（Generational GC）</strong>。</p>
<p>它将对象分成三代：</p>
<ul>
<li>0 代（新生代）：新创建的对象</li>
<li>1 代</li>
<li>2 代（老年代）：长时间存在的对象</li>
</ul>
<p>为什么要这样？</p>
<p>因为经验告诉我们：</p>
<blockquote>
<p>“存活越久的对象越不可能被回收。”</p>
</blockquote>
<p>GC 工作流程：</p>
<ol>
<li>重点检查 <strong>新生代对象</strong></li>
<li>如果回收效果不佳，才继续检查老年代</li>
<li>检测策略主要针对“容器类”（list, dict, set, class 等）</li>
<li>发现无法到达的引用 → 回收</li>
</ol>
<hr/>
<h2 data-id="heading-4">5. 手动使用垃圾回收模块：gc</h2>
<p>Python 提供了一个模块 <code>gc</code> 可以让你：</p>
<ul>
<li>查看当前垃圾回收状态</li>
<li>手动触发 GC</li>
<li>调试循环引用问题</li>
</ul>
<h4 data-id="heading-5">查看 GC 是否启用</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> gc
<span class="hljs-built_in">print</span>(gc.isenabled())
</code></pre>
<h4 data-id="heading-6">手动触发垃圾回收（常用于大批量数据处理）</h4>
<pre><code class="hljs language-python" lang="python">gc.collect()
</code></pre>
<h4 data-id="heading-7">调试循环引用对象（高级用法）</h4>
<pre><code class="hljs language-python" lang="python">gc.set_debug(gc.DEBUG_LEAK)
</code></pre>
<hr/>
<h2 data-id="heading-8">6. 内存优化实战技巧</h2>
<h4 data-id="heading-9">① 尽量使用生成器（节省大量内存）</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen</span>():
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10_000_000</span>):
        <span class="hljs-keyword">yield</span> i
</code></pre>
<p>生成器一次只产生一个元素，比列表省太多内存。</p>
<hr/>
<h4 data-id="heading-10">② 用 <code>del</code> 显式删除大型对象</h4>
<p>适合大规模数据处理：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">del</span> big_list
gc.collect()
</code></pre>
<hr/>
<h4 data-id="heading-11">③ 避免不必要的变量引用</h4>
<p>例如数据处理中：</p>
<pre><code class="hljs language-python" lang="python">df2 = df1  <span class="hljs-comment"># 共享内存！不会复制</span>
</code></pre>
<p>如需复制，务必用：</p>
<pre><code class="hljs language-python" lang="python">df2 = df1.copy()
</code></pre>
<hr/>
<h4 data-id="heading-12">④ 大量小对象：使用 <code>slots</code> 优化内存</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    __slots__ = (<span class="hljs-string">"name"</span>, <span class="hljs-string">"age"</span>)
</code></pre>
<p>对象不再使用 <code>__dict__</code> 存储属性，节省 30%-50% 内存。</p>
<hr/>
<h4 data-id="heading-13">⑤ 尽量使用内建类型/库，而不是自己造轮子</h4>
<p>比如：</p>
<ul>
<li><code>list</code> append 比自己实现的链表快得多</li>
<li>numpy 数组比 Python list 省 10 倍空间</li>
</ul>
<hr/>
<h2 data-id="heading-14">7. 总结</h2>
<p>Python 的内存管理并不复杂，本质上就是：</p>
<ul>
<li>引用计数：负责即时释放</li>
<li>垃圾回收：处理循环引用</li>
<li>内存池：提升对象创建效率</li>
</ul>
<p>理解这些机制，你就能：</p>
<ul>
<li>避免内存泄漏</li>
<li>写出更快更节省资源的代码</li>
<li>在长运行项目（爬虫/服务端）中更稳定</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>