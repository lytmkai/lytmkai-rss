<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Vue 3 组件开发最佳实践：可复用组件设计模式]]></title>    <link>https://juejin.cn/post/7582533464245878818</link>    <guid>https://juejin.cn/post/7582533464245878818</guid>    <pubDate>2025-12-12T08:28:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582533464245878818" data-draft-id="7582776967817248768" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3 组件开发最佳实践：可复用组件设计模式"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-12T08:28:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="微芒不朽"/> <meta itemprop="url" content="https://juejin.cn/user/3702810894153592"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3 组件开发最佳实践：可复用组件设计模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810894153592/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    微芒不朽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:28:44.000Z" title="Fri Dec 12 2025 08:28:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body ::selection{color:#fff;background-color:#ed7373}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:.6em;margin-top:1.5em;padding-bottom:4px;color:#ed7373}.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px}.markdown-body h4{font-size:16px}.markdown-body h5,.markdown-body h6{font-size:14px}.markdown-body p{line-height:inherit;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border-top:1px solid #dfe1e6;margin:33px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:rgba(239,198,221,.2666666667);color:#7b164f;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==") 10px 10px no-repeat;background-size:40px;background-color:#fdf8f8}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#fdf8f8}.markdown-body a{position:relative;text-decoration:underline;text-decoration-color:#ffd4d4;color:#ed7373;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAAAXNSR0IArs4c6QAAD1lJREFUeF7tnV122zgShQHJG5gT9/OkV2J7JR3voI/U707eI5/eQeyVRFlJa56nc2YDFjkHEulWHP3g5xZYAK5eku6QYOFWfSwUAJLW8EcFqMBJBSy1oQJU4LQCBITRQQXOKEBAGB5UgIAwBqhAnALMIHG68axGFCAgjTia3YxTgIDE6cazGlGAgDTiaHYzTgECEqcbz2pEAQLSiKPZzTgFCEicbjyrEQUISCOOZjfjFCAgcbrxrEYUICCNOJrdjFOAgMTpxrMaUYCANOJodjNOAQISpxvPakQBAtKIo9nNOAUISJxuPKsRBQhII45GdfN/v//+/l9//rlBtae9HQKi3UOZ7ft7sfhgjfm3sfa9u3RvzHtrjPv77r8PfpvemB0o1v3Z95tuNvt29fKyqQkgApI5ADVebgeFtTfGmA8I+3pj1rbv17Ouey4dFgKCiIgC2/i+WDwYax0QbzMDtDcjLC67/PL58xraeIbGCEgGkTVd4vty+QWVKUL75WCZb7f3JWUVAhLq5UKPHzLGRyXmP822208lgEJAlESMlBlDfeGyhsafelAIiMawAdjkpmO38/kXa8wtoDnRJvq+v79+fHwSvUhk4wQkUjjNp/33jz9uZ33/VbONP9nW9x/fPT5+0mYzAdHmkUR7lNUaob1RN+QiIKEuVHz838vl1xKGVOck1DbTRUAUB7yvaSXVG5592sy22zsNs1wExNNjWg+rEI5XqWfb7a9TQ0JAtEa+h101wzF0f/JMQkA8AlHjIQ3AMco+KSQERGP0X7CpITj2Skw4BUxACgOkOThG/0wECQEpCJBm4Rh81Fl7l3tHMAEpBJCJ4Hjq+/7bvOt229THGSVny8vV1W6b/Kzrbnprb088VAVXN/fMFgGBuxDfYE443L4oB0TM9OqwxcVtjJR7xiTzUIuA4OMZ2mI2OICBN+wgfpACJWcWISDQcMY2lgMOt7XjerW6w1q+b03sqUUgzJf6TUAuKTTRv+eAI8f0qdSwK1cWISATAXDusjngyDkj5PrTzedu+z2uNsmURQiIMkBqg2OUVwKSHFmEgCgCpFY4xCDJkEUIiBJAaodjlBlZuEtOMIz2EhAFgLQCxxtIIG9YkR5mEZCJAWkNjldIlsu/EEW79AsfCMiEgLQKx8EaCSKLPL1bre6l3EhApJS90G7LcKCziOQwi4BMAAjh+GGlPTmLSK7pEJDMgBCOfwRHvb9Lsg4hIBkBIRw/i/0dUawLrocQkEyAEI7jQoPeNi9WqBOQDIAQjtMig16uTUAyxLHIJQjHeVkRdYjkijoziAgW+0YJx2VxEYAYYzbvVqtfL18t/AgCEq6Z1xmEw0um3U2km8/dqnrS791qJRLLIo0m9bSCkwmHvxNBgDCD+Es+7ZGEI0x/DrHC9Cr6aMIR7j7ELBaL9HDds59BOOIkB33wh9O8cfLnOYtwxOsM+egPV9LjHSB9JuFIU/j7ctmntSD7cmvOYiV6B3IHPGOD5E7VxK4nnw4q0A03Kya7QqYBwpGmK6j+MFJrIK53zCCRPgZtsjt59Zozh+s0aP3DNSW2BkJAIuFATE2eu3TtcLi+w24wggU6AYkABDVuPnXpFuAAZg8jrReHWAGQIB177LLSzg7oqtih4Dcsig6vmEECw0CyKG8BDic3VEPh4RUBCQAENePSaubY1R2LxYOxNvklDa8aEpCACBY+FLKgdcTGZjLHYvHBWuu+PoX6iQ+vmEE8XQW/8w3XJRyeDjhymOTi4OHlWKRf8JFUYU444uGQXvsgIAG+kcgesXAM6y83/fAhGtv36242+5b708i+8kmtF+XKHhxiTZA9YuDwCLSn2Xb7KebLtL7BHnqch82hTY7HZ6k9xotxiHXGTejsEQXHcvnVGnPrEU2b2XZ7pwESQTjEFwbf6kxAzgGCeOvf2H7ElGQMoDmHH8ekk4RD8snBU2FAQE4oAy7Og594S7p+BIweGeriIZJw5CzMWaRfdDV0UStqzByTPX7oVt9/nHXdc64hV41wsEjPMLyKqTucWZAtGZkyiTAc2esOZpBMs1cpY2bIW89dP4UhkYZj6pqKNcgRWFBb2lO+fAQDxBiTYse5e4k0HMaY4NrNY/QcdAgBOSJX8vjf3biNWV+vVndB3jg4GPZA0b5N+BSwNByp+sXqzmleD+UQgMTWHqN5AgEIg0TAtrdemTxzjAYxgxzLIMul23X6wYOlU4dEzVy9bQw5zNq1DahHpOGYuuZgBvGI+uQZJEAgOjOHWsjB+t7DbK9DUgIQkVnPGZmadb0ECDyIGeR4Bkl6mRnS0WhIYsf2LcLhQoOACACCfk8T+Dnu4BetJa3qe9yxkTcUj8sFHUJAjgPiPugSO6yB1B9vzUJCEppFBLPHprP2Xut2fWaQE/eSxOJYBJDR1ETbXnscUosk12THdVYPBwE5AUhiQIgCAswk3tO+As/ji2oUNIa6cDCHWOBp3tDhS4wzUZD4ZhEkIDn0idH01DkEBAyIaw5dpB9zHqgu8FqQgw3rEncXIAPft60qAXF32JRt3qnBJ7X36a1TUwPX926O2Pbiey3fwM11XBWADGsFv5n9o6m72SfnkJ2Iff98/fj4FCJo6mpxrmnLVJCdJj4wp+pRKhxVFOmeBXXwSw2S7s6glXQfqJPs3N0/+nufG0jCdbyGcT59neKYYjNIxKfPvGdtnCM8wTvpM587M8LhgOGPVwDHTAz4wofQQaqNIgGJgGOvX8CdPXVYEXKtFOcm2+k5zHI2hmx7yTXMTNHO59ziAEne9uAJCeChqaCM5eOsY8cA7PSqQw6vPWSt13rvjV1PnbXPmlfHQ7QuChBEMIQUjAnj7uCMFeI09GxW7N1+54+uuxkmRf4z77p1yuxhigZS5xYDCAKOUUTfdQrELFGOoVZqvRQLiFRQamq3CECQcPhObY5OSs4iATNFsYGRamMNxXSsdpfOUw8IGg4nSMgdE5JFhCEhIJfCPP7fVQOCmKE5Ik3wRrnUABxtkLpTJ9vnOXERH2blnqkWECE4ot42gsoiodnLN6wAmwm91kJ87anpOJWAABa/Tvso8m6ZfJf+xyLo9G/ytPduCqr/+O7x8VNNgY3qizpAROEwJnh4NQodskh20TnAgITUaEB7Lva9sANUAZI6XXlB++Q7N3KohdqKgrApZNKisPhONlcNIMJwBM1cnVMVEZDIWgShGwrW5GhU2IAKQBBOPqct+g4JqUcAwxpI/ZHpAS+Fse9l0qSARG869Ora/iA0HK7NmJ2tP5kMAASUzaLrsgA3FHvopICUljkOvZwKCQJcRCYL2ZtWbJQnGD4ZICXDMeo93MHdO3yD36Hlux/slG8hs1ec4r2IziSAgIYGJzuHuDtfVG44IGr6FzG8An1gNKdWvppqOi47ILA73wkVp3B4ICTJY37gDSbZFk3BLGFLVkBQsy6nhJgCjtEWn5oEMd6HagjIZBJBqanNbIBAHXtEwSnhODRn2EP2MPy/sTaBPWWHrN20aKYJiLe2ZANEcguJVkenvp/rrbOQcEz13XHNMByzLQsgktlDKxzoQADWHXvTOLzyclEWQMB3vteOtQKHxNZ/bi/x4kP+AzpS2YNw+Dn46FHMHt7iiWcQiexBOLz9e+xATu0GyCcKiMSaB+EI8O6xQ5k9ggQUBQSxV+iwN4QjyLfMHslyCX7EE157NHLnkyjIxziRemkEIA7VNiGWQcDTkk28VEAUjgI/XqOBGjFAgMV5E0WlJBxcFIxHTQQQ5PCqhbpDGo7ZdntX2ztz40M+7EwRQICzV9VnD2E4RJ6oDAuxso8WAQRVf9S+2isNB4vydDhlAFku+3TT4t9hBbi2eBPScBhjmpjYkHaUXkAqntaVhgPx3Il04JXSPhwQVIFe6/CKcJSCxt5OrYBUWZwTjrLgEAEEMYNV4xCBcJQHhwggoECoqsAEaXIywmq8oWjBCT7EgkzxVlSgEw4toR5nBwGJ083rLMLhJZPqg/CALJdfjDHubYPxvwoyCOGId7+mM+GAgAKj6BoEpAFrDgWkqASk5KKTcCiIaqAJcEBanuYlHMDIVNIUHJBWV9IJh5KIBpsBB8TZB/gssSlpJyrhAEelouakAPkr5psZb3QpolAnHIqiWcAUEUBQj9tq37BIOAQiUlmTMoAsFh+stW49JO2neD2EcKS5tpSzRQBBzGSNAmrMIoSjlPBOt1MEkKFQR9Qh6t5CTjjSg66kFiQBSd9yMiqpZKhFOEoKbYytYoAgh1muq1MPtQgHJuBKa0UMEOgwa6/qZqr3OxGO0sIaZ68sIIvFg7H2I87c/JBAnm85I0DJ+86AflXblCggAlkkayZBreec8j7hUMvFq2HygOCzyM54ya0obj/Zdj7/Yo25lXIh4ZBSFtuuOCBCWWQPiTHr+XZ7j3zvrHS9Mdp9vVrdYV3J1iQUyAOIUBY5EORptt1+SgFlAMN933z8trmE3juoCYeItCKNZgFEMoscquKCz/b9etZ1zz6wDFDcmP1QShQMZg6R+BVvNBsgw7qIWzwUD8RBtU1vzMb93Q5/DkH63u5tyGXH63CQmUM8nuEXyAbILovID7XgAiEa5LAKoeI0bWQFpEVICMc0gY26anZActUjKIFS2iEcKerpOHcSQIbn1r/mrgNySk44cqotd61JAHHdqRkSwiEXsLlbngwQ19EJZrbE9SUc4hJnvcCkgFQHiZLnVrJGUOUXmxyQUV/pjYHSfmzhc9XSGmpsXw0gBU8Bbzpr73/5/Hmt0cG0KU0BVYAcQOLeDp91pTtGRtYbMaqVdY46QMa6xPb9g+R282Q3sd5IlrCEBlQCMgqndJariDc+lhB8JdioGpDXAn7/IjrxregXHJa8pb6EgKCNPypQBCATg0IwGqamKEB+GHp13U1v7a3Q1vWnvu+/XT8+PjUcG+z6/lGJ8n+uVhmK+nHmK2QGzD0zsnZAzLtu7fOgVfmKsQe+ClQByLHOur1eL1dXO1Bs170C089mm6uXl92DVITBN0zaPa5aQNp1KXuOVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFTg//8JNVC78ovQAAAAAElFTkSuQmCC");background-size:100%}.markdown-body a:active,.markdown-body a:hover{opacity:.66}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #ed7373;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#ed7373}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#fdf2f2}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #ed7373;background-color:#fdf2f2}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ed7373}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]{appearance:none;-webkit-appearance:none;-moz-appearance:none;outline:none;width:16px;height:16px;border-radius:2px;background-color:transparent;box-shadow:inset 0 0 0 1px rgba(28,31,35,.3490196078);vertical-align:middle;margin:0;transform:translateY(-2px)}.markdown-body input[type=checkbox]:checked{background-color:#ed7373;background-image:url("data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjFlbSIgaGVpZ2h0PSIxZW0iIGFyaWEtaGlkZGVuPSJ0cnVlIj48cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTE3LjQxMSA3LjMwOGExLjUgMS41IDAgMDEuMjggMi4xMDNsLTYuNSA4LjVhMS41IDEuNSAwIDAxLTIuMzc1LjAxbC0zLjUtNC41YTEuNSAxLjUgMCAxMTIuMzY4LTEuODQybDIuMzA2IDIuOTY1IDUuMzE4LTYuOTU1YTEuNSAxLjUgMCAwMTIuMTAzLS4yOHoiIGZpbGw9IiNmZmYiLz48L3N2Zz4=");box-shadow:inset 0 0 0 1px #ed7373}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">Vue 3 组件开发最佳实践：可复用组件设计模式</h2>
<h3 data-id="heading-1">前言</h3>
<p>组件化是现代前端开发的核心思想之一，而在 Vue 3 中，借助 Composition API 和更完善的响应式系统，我们能够设计出更加灵活、可复用的组件。本文将深入探讨 Vue 3 组件开发的最佳实践，介绍多种可复用组件的设计模式，帮助开发者构建高质量的组件库。</p>
<h3 data-id="heading-2">组件设计基本原则</h3>
<h4 data-id="heading-3">1. 单一职责原则</h4>
<p>每个组件应该只负责一个明确的功能，避免功能过于复杂。</p>
<h4 data-id="heading-4">2. 开放封闭原则</h4>
<p>组件对扩展开放，对修改封闭，通过合理的接口设计支持定制化。</p>
<h4 data-id="heading-5">3. 可组合性</h4>
<p>组件应该易于与其他组件组合使用，形成更复杂的 UI 结构。</p>
<h3 data-id="heading-6">基础组件设计模式</h3>
<h4 data-id="heading-7">1. Props 透传模式</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- BaseButton.vue --&gt;
&lt;template&gt;
  &lt;button 
    :class="buttonClasses"
    v-bind="$attrs"
    @click="handleClick"
  &gt;
    &lt;slot /&gt;
  &lt;/button&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { computed } from 'vue'

const props = defineProps({
  variant: {
    type: String,
    default: 'primary',
    validator: (value) =&gt; ['primary', 'secondary', 'danger', 'ghost'].includes(value)
  },
  size: {
    type: String,
    default: 'medium',
    validator: (value) =&gt; ['small', 'medium', 'large'].includes(value)
  },
  block: {
    type: Boolean,
    default: false
  },
  disabled: {
    type: Boolean,
    default: false
  }
})

const emit = defineEmits(['click'])

const buttonClasses = computed(() =&gt; [
  'btn',
  `btn--${props.variant}`,
  `btn--${props.size}`,
  {
    'btn--block': props.block,
    'btn--disabled': props.disabled
  }
])

const handleClick = (event) =&gt; {
  if (!props.disabled) {
    emit('click', event)
  }
}

// 允许父组件访问子组件实例
defineExpose({
  focus: () =&gt; {
    // 实现焦点管理
  }
})
&lt;/script&gt;

&lt;style scoped&gt;
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s ease;
  text-decoration: none;
}

.btn--primary {
  background-color: #42b883;
  color: white;
}

.btn--secondary {
  background-color: #6c757d;
  color: white;
}

.btn--danger {
  background-color: #dc3545;
  color: white;
}

.btn--ghost {
  background-color: transparent;
  color: #42b883;
  border: 1px solid #42b883;
}

.btn--small {
  padding: 4px 8px;
  font-size: 12px;
}

.btn--medium {
  padding: 8px 16px;
  font-size: 14px;
}

.btn--large {
  padding: 12px 24px;
  font-size: 16px;
}

.btn--block {
  display: flex;
  width: 100%;
}

.btn--disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn:hover:not(.btn--disabled) {
  opacity: 0.8;
  transform: translateY(-1px);
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-8">2. 插槽分发模式</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Card.vue --&gt;
&lt;template&gt;
  &lt;div class="card" :class="cardClasses"&gt;
    &lt;!-- 默认插槽 --&gt;
    &lt;div v-if="$slots.header || title" class="card__header"&gt;
      &lt;slot name="header"&gt;
        &lt;h3 class="card__title"&gt;{{ title }}&lt;/h3&gt;
      &lt;/slot&gt;
    &lt;/div&gt;
  
    &lt;!-- 内容插槽 --&gt;
    &lt;div class="card__body"&gt;
      &lt;slot /&gt;
    &lt;/div&gt;
  
    &lt;!-- 底部插槽 --&gt;
    &lt;div v-if="$slots.footer" class="card__footer"&gt;
      &lt;slot name="footer" /&gt;
    &lt;/div&gt;
  
    &lt;!-- 操作区域插槽 --&gt;
    &lt;div v-if="$slots.actions" class="card__actions"&gt;
      &lt;slot name="actions" /&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { computed } from 'vue'

const props = defineProps({
  title: {
    type: String,
    default: ''
  },
  bordered: {
    type: Boolean,
    default: true
  },
  shadow: {
    type: Boolean,
    default: false
  },
  hoverable: {
    type: Boolean,
    default: false
  }
})

const cardClasses = computed(() =&gt; ({
  'card--bordered': props.bordered,
  'card--shadow': props.shadow,
  'card--hoverable': props.hoverable
}))
&lt;/script&gt;

&lt;style scoped&gt;
.card {
  background: #fff;
  border-radius: 8px;
}

.card--bordered {
  border: 1px solid #e5e5e5;
}

.card--shadow {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.card--hoverable:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.card__header {
  padding: 16px 24px;
  border-bottom: 1px solid #f0f0f0;
}

.card__title {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #333;
}

.card__body {
  padding: 24px;
}

.card__footer {
  padding: 16px 24px;
  border-top: 1px solid #f0f0f0;
}

.card__actions {
  padding: 16px 24px;
  text-align: right;
}
&lt;/style&gt;
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;Card title="用户信息" bordered hoverable&gt;
    &lt;template #header&gt;
      &lt;div class="custom-header"&gt;
        &lt;h3&gt;用户详情&lt;/h3&gt;
        &lt;BaseButton size="small" variant="ghost"&gt;编辑&lt;/BaseButton&gt;
      &lt;/div&gt;
    &lt;/template&gt;
  
    &lt;p&gt;这里是卡片内容&lt;/p&gt;
  
    &lt;template #footer&gt;
      &lt;div class="card-footer"&gt;
        &lt;span&gt;创建时间: 2023-01-01&lt;/span&gt;
      &lt;/div&gt;
    &lt;/template&gt;
  
    &lt;template #actions&gt;
      &lt;BaseButton variant="primary"&gt;保存&lt;/BaseButton&gt;
      &lt;BaseButton variant="ghost"&gt;取消&lt;/BaseButton&gt;
    &lt;/template&gt;
  &lt;/Card&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-9">高级组件设计模式</h3>
<h4 data-id="heading-10">1. Renderless 组件模式</h4>
<p>Renderless 组件专注于逻辑处理，不包含任何模板，通过作用域插槽传递数据和方法：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- FetchData.vue --&gt;
&lt;template&gt;
  &lt;slot 
    :loading="loading"
    :data="data"
    :error="error"
    :refetch="fetchData"
  /&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, onMounted } from 'vue'

const props = defineProps({
  url: {
    type: String,
    required: true
  },
  immediate: {
    type: Boolean,
    default: true
  }
})

const loading = ref(false)
const data = ref(null)
const error = ref(null)

const fetchData = async () =&gt; {
  loading.value = true
  error.value = null

  try {
    const response = await fetch(props.url)
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    data.value = await response.json()
  } catch (err) {
    error.value = err.message
  } finally {
    loading.value = false
  }
}

onMounted(() =&gt; {
  if (props.immediate) {
    fetchData()
  }
})

defineExpose({
  fetchData
})
&lt;/script&gt;
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;FetchData url="/api/users" v-slot="{ loading, data, error, refetch }"&gt;
    &lt;div class="user-list"&gt;
      &lt;div v-if="loading"&gt;加载中...&lt;/div&gt;
      &lt;div v-else-if="error"&gt;错误: {{ error }}&lt;/div&gt;
    
      &lt;template v-else&gt;
        &lt;div v-for="user in data" :key="user.id" class="user-item"&gt;
          {{ user.name }}
        &lt;/div&gt;
      
        &lt;button @click="refetch"&gt;刷新&lt;/button&gt;
      &lt;/template&gt;
    &lt;/div&gt;
  &lt;/FetchData&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-11">2. Compound Components 模式</h4>
<p>复合组件模式允许相关组件协同工作，共享状态和配置：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Tabs.vue --&gt;
&lt;template&gt;
  &lt;div class="tabs"&gt;
    &lt;div class="tabs__nav" role="tablist"&gt;
      &lt;slot name="nav" :active-key="activeKey" :change-tab="changeTab" /&gt;
    &lt;/div&gt;
    &lt;div class="tabs__content"&gt;
      &lt;slot :active-key="activeKey" /&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, provide } from 'vue'

const props = defineProps({
  modelValue: {
    type: [String, Number],
    default: ''
  }
})

const emit = defineEmits(['update:modelValue'])

const activeKey = ref(props.modelValue)

const changeTab = (key) =&gt; {
  activeKey.value = key
  emit('update:modelValue', key)
}

// 提供给子组件使用的上下文
provide('tabs-context', {
  activeKey,
  changeTab
})
&lt;/script&gt;

&lt;style scoped&gt;
.tabs {
  border: 1px solid #e5e5e5;
  border-radius: 8px;
  overflow: hidden;
}

.tabs__nav {
  display: flex;
  background-color: #f8f9fa;
  border-bottom: 1px solid #e5e5e5;
}

.tabs__content {
  padding: 24px;
}
&lt;/style&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- TabNav.vue --&gt;
&lt;template&gt;
  &lt;div class="tab-nav"&gt;
    &lt;slot /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.tab-nav {
  display: flex;
}
&lt;/style&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- TabNavItem.vue --&gt;
&lt;template&gt;
  &lt;button
    :class="classes"
    :aria-selected="isActive"
    @click="handleClick"
  &gt;
    &lt;slot /&gt;
  &lt;/button&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { inject, computed } from 'vue'

const props = defineProps({
  tabKey: {
    type: [String, Number],
    required: true
  },
  disabled: {
    type: Boolean,
    default: false
  }
})

const tabsContext = inject('tabs-context')

const isActive = computed(() =&gt; tabsContext.activeKey.value === props.tabKey)

const classes = computed(() =&gt; [
  'tab-nav-item',
  {
    'tab-nav-item--active': isActive.value,
    'tab-nav-item--disabled': props.disabled
  }
])

const handleClick = () =&gt; {
  if (!props.disabled) {
    tabsContext.changeTab(props.tabKey)
  }
}
&lt;/script&gt;

&lt;style scoped&gt;
.tab-nav-item {
  padding: 12px 24px;
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 14px;
  color: #666;
  transition: all 0.2s ease;
}

.tab-nav-item:hover:not(.tab-nav-item--disabled) {
  color: #42b883;
  background-color: rgba(66, 184, 131, 0.1);
}

.tab-nav-item--active {
  color: #42b883;
  font-weight: 600;
  background-color: #fff;
  border-bottom: 2px solid #42b883;
}

.tab-nav-item--disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
&lt;/style&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- TabPanel.vue --&gt;
&lt;template&gt;
  &lt;div v-show="isActive" class="tab-panel" role="tabpanel"&gt;
    &lt;slot /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { inject, computed } from 'vue'

const props = defineProps({
  tabKey: {
    type: [String, Number],
    required: true
  }
})

const tabsContext = inject('tabs-context')

const isActive = computed(() =&gt; tabsContext.activeKey.value === props.tabKey)
&lt;/script&gt;

&lt;style scoped&gt;
.tab-panel {
  outline: none;
}
&lt;/style&gt;
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;Tabs v-model="activeTab"&gt;
    &lt;template #nav="{ activeKey, changeTab }"&gt;
      &lt;TabNavItem tab-key="profile"&gt;个人信息&lt;/TabNavItem&gt;
      &lt;TabNavItem tab-key="settings"&gt;设置&lt;/TabNavItem&gt;
      &lt;TabNavItem tab-key="security" disabled&gt;安全&lt;/TabNavItem&gt;
    &lt;/template&gt;
  
    &lt;TabPanel tab-key="profile"&gt;
      &lt;p&gt;这是个人信息面板&lt;/p&gt;
    &lt;/TabPanel&gt;
  
    &lt;TabPanel tab-key="settings"&gt;
      &lt;p&gt;这是设置面板&lt;/p&gt;
    &lt;/TabPanel&gt;
  
    &lt;TabPanel tab-key="security"&gt;
      &lt;p&gt;这是安全面板&lt;/p&gt;
    &lt;/TabPanel&gt;
  &lt;/Tabs&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'

const activeTab = ref('profile')
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-12">3. Higher-Order Component (HOC) 模式</h4>
<p>虽然 Vue 更推荐使用 Composition API，但在某些场景下 HOC 仍然有用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// withLoading.js</span>
<span class="hljs-keyword">import</span> { h, ref, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">withLoading</span>(<span class="hljs-params">WrappedComponent, loadingMessage = <span class="hljs-string">'加载中...'</span></span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">`WithLoading(<span class="hljs-subst">${WrappedComponent.name || <span class="hljs-string">'Component'</span>}</span>)`</span>,
    <span class="hljs-attr">inheritAttrs</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">props</span>: <span class="hljs-title class_">WrappedComponent</span>.<span class="hljs-property">props</span>,
    <span class="hljs-attr">emits</span>: <span class="hljs-title class_">WrappedComponent</span>.<span class="hljs-property">emits</span>,
    <span class="hljs-title function_">setup</span>(<span class="hljs-params">props, { attrs, slots, emit }</span>) {
      <span class="hljs-keyword">const</span> isLoading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>)
    
      <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 模拟异步操作</span>
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          isLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
        }, <span class="hljs-number">1000</span>)
      })
    
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (isLoading.<span class="hljs-property">value</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, { <span class="hljs-attr">class</span>: <span class="hljs-string">'loading-wrapper'</span> }, loadingMessage)
        }
      
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">WrappedComponent</span>, {
          ...props,
          ...attrs,
          <span class="hljs-attr">on</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(emit).<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, key</span>) =&gt;</span> {
            acc[key] = <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> <span class="hljs-title function_">emit</span>(key, ...args)
            <span class="hljs-keyword">return</span> acc
          }, {})
        }, slots)
      }
    }
  }
}
</code></pre>
<h4 data-id="heading-13">4. State Reducer 模式</h4>
<p>借鉴 React 的理念，通过 reducer 函数管理复杂状态：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Toggle.vue --&gt;
&lt;template&gt;
  &lt;div class="toggle"&gt;
    &lt;slot 
      :on="on"
      :toggle="toggle"
      :set-on="setOn"
      :set-off="setOff"
    /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'

const props = defineProps({
  modelValue: {
    type: Boolean,
    default: false
  },
  reducer: {
    type: Function,
    default: null
  }
})

const emit = defineEmits(['update:modelValue'])

const internalOn = ref(props.modelValue)

const getState = () =&gt; ({
  on: internalOn.value
})

const dispatch = (action) =&gt; {
  const changes = props.reducer 
    ? props.reducer(getState(), action)
    : defaultReducer(getState(), action)
  
  if (changes.on !== undefined) {
    internalOn.value = changes.on
    emit('update:modelValue', changes.on)
  }
}

const defaultReducer = (state, action) =&gt; {
  switch (action.type) {
    case 'toggle':
      return { on: !state.on }
    case 'setOn':
      return { on: true }
    case 'setOff':
      return { on: false }
    default:
      throw new Error(`Unknown action type: ${action.type}`)
  }
}

const toggle = () =&gt; dispatch({ type: 'toggle' })
const setOn = () =&gt; dispatch({ type: 'setOn' })
const setOff = () =&gt; dispatch({ type: 'setOff' })

defineExpose({
  toggle,
  setOn,
  setOff
})
&lt;/script&gt;
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;Toggle :reducer="toggleReducer" v-slot="{ on, toggle, setOn, setOff }"&gt;
    &lt;div class="toggle-demo"&gt;
      &lt;p&gt;状态: {{ on ? '开启' : '关闭' }}&lt;/p&gt;
      &lt;BaseButton @click="toggle"&gt;切换&lt;/BaseButton&gt;
      &lt;BaseButton @click="setOn"&gt;开启&lt;/BaseButton&gt;
      &lt;BaseButton @click="setOff"&gt;关闭&lt;/BaseButton&gt;
    &lt;/div&gt;
  &lt;/Toggle&gt;
&lt;/template&gt;

&lt;script setup&gt;
const toggleReducer = (state, action) =&gt; {
  switch (action.type) {
    case 'toggle':
      // 添加日志记录
      console.log('Toggle state changed:', !state.on)
      return { on: !state.on }
    case 'setOn':
      return { on: true }
    case 'setOff':
      return { on: false }
    default:
      return state
  }
}
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-14">组件通信最佳实践</h3>
<h4 data-id="heading-15">1. Provide/Inject 模式</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// theme.js</span>
<span class="hljs-keyword">import</span> { ref, readonly, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> themeSymbol = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'theme'</span>)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createThemeStore</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> currentTheme = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'light'</span>)

  <span class="hljs-keyword">const</span> themes = {
    <span class="hljs-attr">light</span>: {
      <span class="hljs-attr">primary</span>: <span class="hljs-string">'#42b883'</span>,
      <span class="hljs-attr">background</span>: <span class="hljs-string">'#ffffff'</span>,
      <span class="hljs-attr">text</span>: <span class="hljs-string">'#333333'</span>
    },
    <span class="hljs-attr">dark</span>: {
      <span class="hljs-attr">primary</span>: <span class="hljs-string">'#42b883'</span>,
      <span class="hljs-attr">background</span>: <span class="hljs-string">'#1a1a1a'</span>,
      <span class="hljs-attr">text</span>: <span class="hljs-string">'#ffffff'</span>
    }
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTheme</span> = (<span class="hljs-params"/>) =&gt; {
    currentTheme.<span class="hljs-property">value</span> = currentTheme.<span class="hljs-property">value</span> === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>
  }

  <span class="hljs-keyword">const</span> themeConfig = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> themes[currentTheme.<span class="hljs-property">value</span>])

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">currentTheme</span>: <span class="hljs-title function_">readonly</span>(currentTheme),
    themeConfig,
    toggleTheme
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">provideTheme</span>(<span class="hljs-params">themeStore</span>) {
  <span class="hljs-title function_">provide</span>(themeSymbol, themeStore)
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useTheme</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> themeStore = <span class="hljs-title function_">inject</span>(themeSymbol)
  <span class="hljs-keyword">if</span> (!themeStore) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'useTheme must be used within provideTheme'</span>)
  }
  <span class="hljs-keyword">return</span> themeStore
}
</code></pre>
<h4 data-id="heading-16">2. Event Bus 替代方案</h4>
<p>使用 mitt 库替代传统的事件总线：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// eventBus.js</span>
<span class="hljs-keyword">import</span> mitt <span class="hljs-keyword">from</span> <span class="hljs-string">'mitt'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> eventBus = <span class="hljs-title function_">mitt</span>()

<span class="hljs-comment">// 在组件中使用</span>
<span class="hljs-comment">// eventBus.emit('user-login', userInfo)</span>
<span class="hljs-comment">// eventBus.on('user-login', handler)</span>
</code></pre>
<h3 data-id="heading-17">性能优化策略</h3>
<h4 data-id="heading-18">1. 组件懒加载</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// router/index.js</span>
<span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/heavy-component'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/components/HeavyComponent.vue'</span>)
  }
]

<span class="hljs-comment">// 组件内部懒加载</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HeavyChart</span> = <span class="hljs-title function_">defineAsyncComponent</span>(<span class="hljs-function">() =&gt;</span> 
  <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/components/charts/HeavyChart.vue'</span>)
)
</code></pre>
<h4 data-id="heading-19">2. 虚拟滚动</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- VirtualList.vue --&gt;
&lt;template&gt;
  &lt;div 
    ref="containerRef" 
    class="virtual-list"
    @scroll="handleScroll"
  &gt;
    &lt;div :style="{ height: totalHeight + 'px' }" class="virtual-list__spacer"&gt;
      &lt;div 
        :style="{ transform: `translateY(${offsetY}px)` }"
        class="virtual-list__content"
      &gt;
        &lt;div
          v-for="item in visibleItems"
          :key="item.id"
          :style="{ height: itemHeight + 'px' }"
          class="virtual-list__item"
        &gt;
          &lt;slot :item="item" /&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, computed, onMounted, onUnmounted } from 'vue'

const props = defineProps({
  items: {
    type: Array,
    required: true
  },
  itemHeight: {
    type: Number,
    default: 50
  },
  bufferSize: {
    type: Number,
    default: 5
  }
})

const containerRef = ref(null)
const scrollTop = ref(0)

const totalHeight = computed(() =&gt; props.items.length * props.itemHeight)

const startIndex = computed(() =&gt; {
  return Math.max(0, Math.floor(scrollTop.value / props.itemHeight) - props.bufferSize)
})

const endIndex = computed(() =&gt; {
  const containerHeight = containerRef.value?.clientHeight || 0
  return Math.min(
    props.items.length - 1,
    Math.floor((scrollTop.value + containerHeight) / props.itemHeight) + props.bufferSize
  )
})

const visibleItems = computed(() =&gt; {
  return props.items.slice(startIndex.value, endIndex.value + 1)
})

const offsetY = computed(() =&gt; {
  return startIndex.value * props.itemHeight
})

const handleScroll = () =&gt; {
  scrollTop.value = containerRef.value.scrollTop
}

onMounted(() =&gt; {
  // 初始化滚动监听
})

onUnmounted(() =&gt; {
  // 清理资源
})
&lt;/script&gt;

&lt;style scoped&gt;
.virtual-list {
  height: 400px;
  overflow-y: auto;
  border: 1px solid #e5e5e5;
}

.virtual-list__spacer {
  position: relative;
}

.virtual-list__content {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
}

.virtual-list__item {
  display: flex;
  align-items: center;
  padding: 0 16px;
  border-bottom: 1px solid #f0f0f0;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-20">测试友好的组件设计</h3>
<h4 data-id="heading-21">1. 明确的 Props 定义</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Button.test.js</span>
<span class="hljs-keyword">import</span> { mount } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vue/test-utils'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">BaseButton</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/BaseButton.vue'</span>

<span class="hljs-title function_">describe</span>(<span class="hljs-string">'BaseButton'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">test</span>(<span class="hljs-string">'renders slot content'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">BaseButton</span>, {
      <span class="hljs-attr">slots</span>: {
        <span class="hljs-attr">default</span>: <span class="hljs-string">'Click me'</span>
      }
    })
    <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Click me'</span>)
  })

  <span class="hljs-title function_">test</span>(<span class="hljs-string">'emits click event when clicked'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">BaseButton</span>)
    <span class="hljs-keyword">await</span> wrapper.<span class="hljs-title function_">trigger</span>(<span class="hljs-string">'click'</span>)
    <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">emitted</span>()).<span class="hljs-title function_">toHaveProperty</span>(<span class="hljs-string">'click'</span>)
  })

  <span class="hljs-title function_">test</span>(<span class="hljs-string">'applies correct CSS classes based on props'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">BaseButton</span>, {
      <span class="hljs-attr">props</span>: {
        <span class="hljs-attr">variant</span>: <span class="hljs-string">'primary'</span>,
        <span class="hljs-attr">size</span>: <span class="hljs-string">'large'</span>
      }
    })
    <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">classes</span>()).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'btn--primary'</span>)
    <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">classes</span>()).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'btn--large'</span>)
  })
})
</code></pre>
<h4 data-id="heading-22">2. 可访问性考虑</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- AccessibleModal.vue --&gt;
&lt;template&gt;
  &lt;teleport to="body"&gt;
    &lt;div 
      v-if="visible"
      ref="modalRef"
      role="dialog"
      aria-modal="true"
      :aria-labelledby="titleId"
      :aria-describedby="descriptionId"
      class="modal"
      @keydown.esc="close"
    &gt;
      &lt;div class="modal__overlay" @click="close"&gt;&lt;/div&gt;
      &lt;div class="modal__content" ref="contentRef"&gt;
        &lt;div class="modal__header"&gt;
          &lt;h2 :id="titleId" class="modal__title"&gt;{{ title }}&lt;/h2&gt;
          &lt;button 
            type="button"
            class="modal__close"
            @click="close"
            aria-label="关闭对话框"
          &gt;
            ×
          &lt;/button&gt;
        &lt;/div&gt;
      
        &lt;div :id="descriptionId" class="modal__body"&gt;
          &lt;slot /&gt;
        &lt;/div&gt;
      
        &lt;div v-if="$slots.footer" class="modal__footer"&gt;
          &lt;slot name="footer" /&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/teleport&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, watch, nextTick } from 'vue'

const props = defineProps({
  visible: {
    type: Boolean,
    default: false
  },
  title: {
    type: String,
    required: true
  }
})

const emit = defineEmits(['update:visible', 'close'])

const modalRef = ref(null)
const contentRef = ref(null)
const titleId = `modal-title-${Math.random().toString(36).substr(2, 9)}`
const descriptionId = `modal-desc-${Math.random().toString(36).substr(2, 9)}`

const close = () =&gt; {
  emit('update:visible', false)
  emit('close')
}

watch(() =&gt; props.visible, async (newVal) =&gt; {
  if (newVal) {
    await nextTick()
    // 自动聚焦到模态框
    contentRef.value?.focus()
  }
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-23">结语</h3>
<p>Vue 3 组件开发的最佳实践涉及多个方面，从基础的 Props 和插槽使用，到高级的设计模式如 Renderless 组件和 Compound Components，每种模式都有其适用场景。关键是要根据具体需求选择合适的设计模式，并遵循以下原则：</p>
<ol>
<li><strong>保持组件简洁</strong>：每个组件专注于单一功能</li>
<li><strong>提供良好的 API</strong>：清晰的 Props 定义和事件接口</li>
<li><strong>重视可访问性</strong>：确保所有用户都能正常使用组件</li>
<li><strong>考虑性能影响</strong>：特别是在处理大量数据或复杂交互时</li>
<li><strong>便于测试</strong>：设计易于测试的组件接口</li>
</ol>
<p>通过合理运用这些设计模式和最佳实践，我们可以构建出既灵活又可靠的组件库，为整个应用提供一致且高质量的用户体验。记住，好的组件设计不是一次性的任务，而是需要在实践中不断迭代和完善的过程。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[分布式事务及实现方案]]></title>    <link>https://juejin.cn/post/7582601349580046336</link>    <guid>https://juejin.cn/post/7582601349580046336</guid>    <pubDate>2025-12-12T09:08:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582601349580046336" data-draft-id="7576479344040083508" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="分布式事务及实现方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-12T09:08:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="atwednesday"/> <meta itemprop="url" content="https://juejin.cn/user/35646320687101"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            分布式事务及实现方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/35646320687101/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    atwednesday
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:08:20.000Z" title="Fri Dec 12 2025 09:08:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>文章主要参考的是<a href="https://link.juejin.cn?target=https%3A%2F%2Fpdai.tech%2Fmd%2Farch%2Farch-z-transection.html" target="_blank" title="https://pdai.tech/md/arch/arch-z-transection.html" ref="nofollow noopener noreferrer">分布式系统 - 分布式事务及实现方案</a>，之所以二次编辑，是为了增加部分自己理解的内容。</p>
<h2 data-id="heading-1">什么是事务</h2>
<p>参考文章<a href="https://juejin.cn/post/7576676694783606818" target="_blank" title="https://juejin.cn/post/7576676694783606818">事务</a></p>
<h2 data-id="heading-2">什么是分布式事务</h2>
<p>分布式事务是指在分布式系统中需要保证原子性、隔离性、一致性和持久性的一个或多个数据库操作。而且这些操作可能是位于不同的服务中。</p>
<h3 data-id="heading-3">从分布式的理论的角度看</h3>
<ul>
<li>
<p><strong>分布式理论的CP</strong> -&gt; 刚性事务</p>
<ul>
<li>遵循ACID，对数据要求强一致性</li>
</ul>
</li>
<li>
<p><strong>分布式理论的AP+BASE</strong> -&gt; 柔性事务</p>
<ul>
<li>遵循BASE，允许一定时间内不同节点的数据不一致，但要求最终一致。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-4">分布式事务体系</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    %% --- 样式定义 (去掉分号，防止解析错误) ---
    classDef rootFill fill:#800000,stroke:#333,stroke-width:2px,color:#fff
    classDef orangeFill fill:#E65100,stroke:#333,stroke-width:1px,color:#fff
    classDef greenFill fill:#43A047,stroke:#333,stroke-width:1px,color:#fff
    classDef blueFill fill:#01579B,stroke:#333,stroke-width:1px,color:#fff
    classDef purpleFill fill:#6200EA,stroke:#333,stroke-width:1px,color:#fff
    classDef yellowFill fill:#FBC02D,stroke:#333,stroke-width:1px,color:#333

    %% --- 主树结构 ---
    Root["分布式事务"]:::rootFill

    %% 第一层
    Tech["技术方案"]:::orangeFill
    Mid["中间件"]:::orangeFill
    Root --&gt; Tech
    Root --&gt; Mid

    %% --- 技术方案分支 ---
    XA["基于XA协议&lt;br/&gt;(DB层)"]:::greenFill
    Comp["基于补偿&lt;br/&gt;(业务层)"]:::blueFill
    Final["基于最终一致性"]:::blueFill

    Tech --&gt; XA
    Tech --&gt; Comp
    Tech --&gt; Final

    %% XA 细节
    TwoPC["2PC"]:::greenFill
    ThreePC["3PC"]:::greenFill
    JTA["JTA,JTS"]:::greenFill

    XA --&gt; TwoPC
    XA -- "Java规范和实现" --&gt; JTA
    TwoPC -- "优化" --&gt; ThreePC

    %% 补偿 细节
    TCC_Biz["TCC"]:::blueFill
    Saga_Biz["Saga"]:::blueFill
    Comp --&gt; TCC_Biz
    Comp --&gt; Saga_Biz

    %% 最终一致性 细节
    MsgTable["消息表"]:::blueFill
    MsgQueue["消息队列"]:::blueFill
    BestEffort["最大努力通知"]:::blueFill
    Final --&gt; MsgTable
    Final --&gt; MsgQueue
    Final --&gt; BestEffort

    %% --- 中间件分支 ---
    Atomiks["Atomiks"]:::greenFill
    Seata["Seata"]:::orangeFill
    TXLCN["TX-LCN"]:::orangeFill
    Other["..."]:::orangeFill

    Mid --&gt; Atomiks
    Mid --&gt; Seata
    Mid --&gt; TXLCN
    Mid --&gt; Other

    %% 中间件子节点
    Atom_XA["XA"]:::greenFill
    Atomiks --&gt; Atom_XA

    Seata_XA["XA"]:::greenFill
    Seata_AT["AT"]:::greenFill
    Seata_TCC["TCC"]:::blueFill
    Seata_Saga["Saga"]:::blueFill
    Seata --&gt; Seata_XA
    Seata --&gt; Seata_AT
    Seata --&gt; Seata_TCC
    Seata --&gt; Seata_Saga

    LCN_LCN["LCN"]:::yellowFill
    LCN_TCC["TCC"]:::blueFill
    LCN_TXC["TXC"]:::yellowFill
    TXLCN --&gt; LCN_LCN
    TXLCN --&gt; LCN_TCC
    TXLCN --&gt; LCN_TXC

    %% --- 底部理论部分 ---
    %% 使用子图将底部理论框起来，并保证逻辑清晰

    subgraph Theory["从分布式理论理解"]
        direction LR
        TheoryRoot["从分布式理论理解"]:::purpleFill
        
        Rigid["CP + ACID =&gt; 刚性事务"]:::greenFill
        Soft["AP + BASE =&gt; 柔性事务"]:::blueFill
        
        ApplyDB["适用数据库层"]:::greenFill
        ApplyBiz["适用业务层"]:::blueFill

        TheoryRoot --&gt; Rigid --&gt; ApplyDB
        TheoryRoot --&gt; Soft --&gt; ApplyBiz
    end
</code></pre>
<p><strong>刚性事务：</strong> 分布式理论的CP，遵循ACID，对数据要求强一致性。</p>
<ul>
<li>
<p><strong>XA协议</strong> 是一个基于数据库层面的分布式事务协议，它定义了两个角色如何配合工作：</p>
<ul>
<li><strong>事务管理器 (Transaction Manager, TM)</strong> ：即“协调者/指挥官”。它负责统筹全局，指挥各个数据库是该提交还是回滚。</li>
<li><strong>本地资源管理器 (Resource Manager, RM)</strong> ：即“参与者/干活的”。通常就是指数据库本身（如 MySQL, Oracle）。</li>
</ul>
<p><strong>二阶段提交 (2PC)</strong> ：是基于 XA 接口的具体<strong>执行流程</strong>。</p>
<ol>
<li><strong>第一阶段（准备/投票阶段）</strong> ：协调者问所有参与者：“你们都能执行成功吗？”参与者执行操作但不提交，锁住资源，然后告诉协调者：“我可以”或“我不行”。</li>
<li><strong>第二阶段（提交/执行阶段）</strong> ：
<ul>
<li>
<p>如果大家都说“我可以”，协调者下令：“全体提交 (Commit)！”</p>
</li>
<li>
<p>只要有一个说“我不行”，协调者下令：“全体回滚 (Rollback)！”</p>
</li>
</ul>
</li>
</ol>
<blockquote>
<ol>
<li><strong>如果 <code>prepare</code> 返回 YES，但 <code>commit</code> 阶段硬件出问题了怎么办？</strong></li>
</ol>
<p>    一旦参与者在 <code>prepare</code> 阶段返回了 <code>YES</code>，它就<strong>失去了对自己命运的掌控权</strong>。它必须无条件服从协调者（Coordinator）的最终决定。它承诺了：“我已经准备好了，只要你一声令下，我随时可以提交，也随时可以回滚。”</p>
<p>    <strong>如果是短暂宕机（如重启）</strong> ：数据库重启后，会检查事务日志（WAL）。它会发现有一条处于 <code>Prepared</code> 状态但没有 <code>Commit</code> 标记的记录（即**“不决状态” In-Doubt Transaction**）。此时，它必须主动去联系协调者：“喂，刚才那个 XID 的事务，大家最后到底是提交了还是回滚了？”</p>
<ul>
<li>如果协调者说“提交”，它就补做提交。</li>
<li>如果协调者说“回滚”，它就补做回滚。</li>
</ul>
<p>    <strong>如果是协调者也挂了</strong>：这就是最坏的情况。参与者联系不上协调者，不知道其他兄弟节点是成功还是失败了。为了保证数据一致性（不能别人回滚了我却提交了），它<strong>只能阻塞等待</strong>，一直持有锁，直到协调者恢复。这通常需要人工介入（DBA 手动强行 Commit 或 Rollback）。</p>
<ol start="2">
<li><strong><code>p.prepare()</code> 和 <code>p.commit()</code> 中间一直在锁着资源吗？</strong>
<strong>一直锁着。</strong> 这正是 2PC 性能差的根本原因。</li>
</ol>
</blockquote>
<p><strong>三阶段提交 (2PC)</strong> ：是基于 XA 接口的具体<strong>执行流程</strong>。</p>
<ol>
<li><strong>第一阶段（询问阶段）</strong>：协调者问：“大家身体健康吗？网络通吗？能接单吗？”。参与者答：Yes/No。</li>
<li><strong>第二阶段（预提交阶段）</strong>：如果第一阶段大家都说 Yes。协调者说：“好，现在大家开始<strong>锁资源、写日志</strong>（执行事务逻辑），但<strong>别提交</strong>！如果我后面不理你们了，你们就自己看着办。”</li>
<li><strong>第三阶段（提交阶段）</strong>：
<ul>
<li>
<p>如果大家都说“我可以”，协调者下令：“全体提交 (Commit)！”</p>
</li>
<li>
<p>只要有一个说“我不行”，协调者下令：“全体回滚 (Rollback)！”</p>
</li>
</ul>
</li>
</ol>
<blockquote>
<ol>
<li>如果第一阶段大家都说 No，但是协调者挂了，怎么办？</li>
</ol>
<p>此时参与者将无法正常收到消息，但在分布式系统中， <strong>“没有收到消息”</strong> 有两种可能：</p>
<ul>
<li>协调者挂了（3PC 赌的是这个）。</li>
<li>协调者没挂，只是网络断了，而且协调者其实刚刚决定了要 Abort。
一旦协调者挂了，在等待一段时间后，参与者会默认提交对应的事务。导致数据一致性问题。</li>
</ul>
</blockquote>
</li>
</ul>
<p><strong>柔性事务</strong>：分布式理论的AP，遵循BASE，允许一定时间内不同节点的数据不一致，但要求最终一致。</p>
<ul>
<li><strong>TCC</strong>: TCC（Try-Confirm-Cancel）又被称补偿事务，TCC与2PC的思想很相似，事务处理流程也很相似，但2PC是应用于在DB层面，TCC则可以理解为在应用层面的2PC，是需要我们编写业务逻辑来实现。
<blockquote>
<p>在 2PC (XA) 中，只需要告诉数据库 <code>Prepare</code>（准备）和 <code>Commit</code>（提交）。如果在 <code>Prepare</code> 阶段失败了，<strong>数据库引擎</strong>会自动利用 Undo Log 把数据回滚回去。不需要写代码去恢复数据。</p>
<p><strong>“应用层面”<strong>的意思是：事务的控制权掌握在</strong>代码 (Business Logic)</strong> 手里。数据库把普通的本地事务处理完了，这个过程中程序员需要利用好本地事务。</p>
</blockquote>
</li>
<li><strong>SAGA</strong>：Saga是由一系列的本地事务构成。每一个本地事务在更新完数据库之后，会发布一条消息或者一个事件来触发Saga中的下一个本地事务的执行。如果一个本地事务因为某些业务规则无法满足而失败，Saga会执行在这个失败的事务之前成功提交的所有事务的补偿操作。Saga的实现有很多种方式，其中最流行的两种方式是：基于事件的方式和基于命令的方式。</li>
<li><strong>最终一致性</strong>
<ul>
<li><strong>消息表</strong>：本地消息表的方案最初是由 eBay 提出，核心思路是将分布式事务拆分成本地事务进行处理。</li>
<li><strong>消息队列</strong>：基于 MQ 的分布式事务方案其实是对本地消息表的封装，将本地消息表基于 MQ 内部，其他方面的协议基本与本地消息表一致。</li>
<li><strong>最大努力通知</strong>：最大努力通知也称为定期校对，是对MQ事务方案的进一步优化。它在事务主动方增加了消息校对的接口，如果事务被动方没有接收到消息，此时可以调用事务主动方提供的消息校对的接口主动获取。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-5">分布式事务方案之刚性事务</h2>
<p>说到刚性事务，首先要讲的是XA协议。</p>
<p>XA协议是一个基于 <strong>数据库</strong> 的分布式事务协议，其分为两部分：<strong>事务管理器（Transaction Manager）</strong> 和 <strong>本地资源管理器（Resource Manager）</strong> 。事务管理器作为一个全局的调度者，负责对各个本地资源管理器统一号令提交或者回滚。<code>二阶提交协议（2PC）</code>和<code>三阶提交协议（3PC）</code>就是根据此协议衍生出来而来。主流的诸如Oracle、MySQL等数据库均已实现了XA接口。</p>
<h3 data-id="heading-6">两段提交（2PC）</h3>
<blockquote>
<p>引入一个作为协调者（coordinator）的组件来统一掌控所有参与者（participant）的操作结果，并最终指示这些节点是否要把操作结果进行真正的提交。</p>
</blockquote>
<ul>
<li>
<p><em>第一阶段</em>: 准备阶段；</p>
<ul>
<li>协调者向所有参与者发送 REQUEST-TO-PREPARE</li>
<li>当参与者收到REQUEST-TO-PREPARE 消息后, 它向协调者发送消息PREPARED或者NO，表示事务是否准备好；如果发送的是NO，那么事务要回滚；</li>
</ul>
</li>
<li>
<p><em>第二阶段</em>: 提交阶段。</p>
<ul>
<li>协调者收集所有参与者的返回消息, 如果所有的参与者都回复的是PREPARED， 那么协调者向所有参与者发送COMMIT 消息；否则，协调者向所有回复PREPARED的参与者发送ABORT消息；</li>
<li>参与者如果回复了PREPARED消息并且收到协调者发来的COMMIT消息，或者它收到ABORT消息，它将执行提交或回滚，并向协调者发送DONE消息以确认。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65f1be6556094b54900bdfb3dd26e96f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=VV3qwLec4ZR3OYfq5XKuVTSyRiI%3D" alt="image.png" loading="lazy"/></p>
<p><strong>两段提交（2PC）的缺点</strong>：</p>
<p>二阶段提交看似能够提供原子性的操作，但它存在着严重的缺陷：</p>
<ul>
<li><strong>网络抖动导致的数据不一致</strong>：第二阶段中协调者向参与者发送commit命令之后，一旦此时发生网络抖动，导致一部分参与者接收到了commit请求并执行，可其他未接到commit请求的参与者无法执行事务提交。进而导致整个分布式系统出现了数据不一致。</li>
<li><strong>超时导致的同步阻塞问题</strong>：2PC中的所有的参与者节点都为事务阻塞型，当某一个参与者节点出现通信超时，其余参与者都会被动阻塞占用资源不能释放。</li>
<li><strong>单点故障的风险</strong>：由于严重的依赖协调者，一旦协调者发生故障，而此时参与者还都处于锁定资源的状态，无法完成事务commit操作。虽然协调者出现故障后，会重新选举一个协调者，可无法解决因前一个协调者宕机导致的参与者处于阻塞状态的问题。</li>
</ul>
<h3 data-id="heading-7">三段提交（3PC）</h3>
<blockquote>
<p>三段提交（3PC）是对两段提交（2PC）的一种升级优化，<strong>3PC在2PC的第一阶段和第二阶段中插入一个准备阶段</strong>。保证了在最后提交阶段之前，各参与者节点的状态都一致。同时在协调者和参与者中都引入超时机制，当参与者各种原因未收到协调者的commit请求后，会对本地事务进行commit，不会一直阻塞等待，解决了2PC的单点故障问题，但3PC还是没能从根本上解决数据一致性的问题。</p>
</blockquote>
<p><strong>3PC的三个阶段分别是CanCommit、PreCommit、DoCommit</strong>：</p>
<ul>
<li><strong>CanCommit</strong>：协调者向所有参与者发送CanCommit命令，询问是否可以执行事务提交操作。如果全部响应YES则进入下一个阶段。</li>
<li><strong>PreCommit</strong>：协调者向所有参与者发送PreCommit命令，询问是否可以进行事务的预提交操作，参与者接收到PreCommit请求后，如参与者成功的执行了事务操作，则返回Yes响应，进入最终commit阶段。一旦参与者中有向协调者发送了No响应，或因网络造成超时，协调者没有接到参与者的响应，协调者向所有参与者发送abort请求，参与者接受abort命令执行事务的中断。</li>
<li><strong>DoCommit</strong>：在前两个阶段中所有参与者的响应反馈均是YES后，协调者向参与者发送DoCommit命令正式提交事务，如协调者没有接收到参与者发送的ACK响应，会向所有参与者发送abort请求命令，执行事务的中断。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9584d6277667455e8f25368bb7fc82ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=cD83vQPRT1B0OrIw%2F0U9NY%2FuSl8%3D" alt="image.png" loading="lazy"/></p>
<p><strong>3PC存在的问题</strong></p>
<p>3PC工作在同步网络模型上，它假设消息传输时间是有上界的，只存在机器失败而不存在消息失败。这个假设太强，现实的情形是，机器失败是无法完美地检测出来的，消息传输可能因为网络拥堵花费很多时间。同时, 说阻塞是相对, 存在协调者和参与者同时失败的情形下, 3PC事务依然会阻塞。实际上，很少会有系统实现3PC，多数现实的系统会通过复制状态机解决2PC阻塞的问题。比如，如果失败模型不是失败-停止, 而是消息失败（消息延迟或网络分区），那样3PC会产生不一致的情形。</p>
<p><strong>3PC小结</strong></p>
<blockquote>
<p><em>3PC并没有完美解决2PC的阻塞，也引入了新的问题（不一致问题），所以3PC很少会被真正的使用</em>。</p>
</blockquote>
<h2 data-id="heading-8">分布式事务方案之柔性事务</h2>
<blockquote>
<p>柔性事务：分布式理论的AP，遵循BASE，允许一定时间内不同节点的数据不一致，但要求最终一致。</p>
</blockquote>
<h3 data-id="heading-9">补偿事务 (TCC)</h3>
<blockquote>
<p>TCC（Try-Confirm-Cancel）又被称补偿事务，TCC与2PC的思想很相似，事务处理流程也很相似，但<strong>2PC是应用于在DB层面，TCC则可以理解为在应用层面的2PC，是需要我们编写业务逻辑来实现</strong>。</p>
</blockquote>
<p>TCC它的核心思想是："针对每个操作都要注册一个与其对应的确认（Try）和补偿（Cancel）"。</p>
<p>还拿下单扣库存解释下它的三个操作：</p>
<ul>
<li><strong>Try阶段</strong>：下单时通过Try操作去扣除库存预留资源。</li>
<li><strong>Confirm阶段</strong>：确认执行业务操作，在只预留的资源基础上，发起购买请求。</li>
<li><strong>Cancel阶段</strong>：只要涉及到的相关业务中，有一个业务方预留资源未成功，则取消所有业务资源的预留请求。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ad3a7365a8140c0bf59e1ccaeafcc53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=uYBwiJvy507DP1rkiz5EIoZWONk%3D" alt="image.png" loading="lazy"/></p>
<p><strong>TCC的缺点</strong>：</p>
<ol>
<li>
<p>空回滚</p>
<p>当一个分支事务所在的服务发生宕机或者网络异常导致调用失败，并未执行try方法，当恢复后事务执行回滚操作就会调用此分支事务的cancel方法,如果cancel方法不能处理此种情况就会出现空回滚。</p>
<p>是否出现空回滚，我们需要需要判断是否执行了try方法，如果执行了就没有空回滚。解决方法就是当主业务发起事务时，生成一个全局事务记录，并生成一个全局唯一ID，贯穿整个事务，再创建一张分支事务记录表，用于记录分支事务，try执行时将全局事务ID和分支事务ID存入分支事务表中，表示执行了try阶段，当cancel执行时，先判断表中是否有该全局事务ID的数据，如果有则回滚，否则不做任何操作。比如seata的AT模式中就有分支事务表。</p>
</li>
<li>
<p>幂等问题</p>
<p>由于服务宕机或者网络问题，方法的调用可能出现超时，为了保证事务正常执行我们往往会加入重试的机制，因此就需要保证confirm和cancel阶段操作的幂等性。</p>
<p>我们可以在分支事务记录表中增加事务执行状态，每次执行confirm和cancel方法时都查询该事务的执行状态，以此判断事务的幂等性。</p>
</li>
<li>
<p>悬挂问题</p>
<p>TCC中，在调用try之前会先注册分支事务，注册分支事务之后，调用出现超时，此时try请求还未到达对应的服务，因为调用超时了，所以会执行cancel调用，此时cancel已经执行完了，然而这个时候try请求到达了，这个时候执行了try之后就没有后续的操作了，就会导致资源挂起，无法释放。</p>
<p>执行try方法时我们可以判断confirm或者cancel方法是否执行，如果执行了那么就不执行try阶段。同样借助分支事务表中事务的执行状态。如果已经执行了confirm或者cancel那么try就执行。</p>
</li>
</ol>
<h3 data-id="heading-10">Saga事务</h3>
<p>Saga是由一系列的本地事务构成。每一个本地事务在更新完数据库之后，会发布一条消息或者一个事件来触发Saga中的下一个本地事务的执行。如果一个本地事务因为某些业务规则无法满足而失败，Saga会执行在这个失败的事务之前成功提交的所有事务的补偿操作。</p>
<p>Saga的实现有很多种方式，其中最流行的两种方式是：</p>
<ul>
<li><strong>基于事件的方式</strong>。这种方式没有协调中心，整个模式的工作方式就像舞蹈一样，各个舞蹈演员按照预先编排的动作和走位各自表演，最终形成一只舞蹈。处于当前Saga下的各个服务，会产生某类事件，或者监听其它服务产生的事件并决定是否需要针对监听到的事件做出响应。</li>
<li><strong>基于命令的方式</strong>。这种方式的工作形式就像一只乐队，由一个指挥家（协调中心）来协调大家的工作。协调中心来告诉Saga的参与方应该执行哪一个本地事务。</li>
</ul>
<p>我们继续以订单流程为例，说明一下该模式。</p>
<p>假设一个完整的订单流程包含了如下几个服务：</p>
<ol>
<li>Order Service：订单服务</li>
<li>Payment Service：支付服务</li>
<li>Stock Service：库存服务</li>
<li>Delivery Service：物流服务</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31b5eca0a8c54c3c8a5b13b0ac930dda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=2LiiwMOzv0NA6mzt2tydypSYFl8%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-11">基于事件的方式</h4>
<p>在基于事件的方式中，第一个服务执行完本地事务之后，会产生一个事件。其它服务会监听这个事件，触发该服务本地事务的执行，并产生新的事件。</p>
<p>采用基于事件的saga模式的订单处理流程如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/361a50e422c144a3aef5584ee7ad8526~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=N%2FuX7g%2BD8MxPtkGZn2UNxX72O10%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>订单服务创建一笔新订单，将订单状态设置为"待处理"，产生事件ORDER_CREATED_EVENT。</li>
<li>支付服务监听ORDER_CREATED_EVENT，完成扣款并产生事件BILLED_ORDER_EVENT。</li>
<li>库存服务监听BILLED_ORDER_EVENT，完成库存扣减和备货，产生事件ORDER_PREPARED_EVENT。</li>
<li>物流服务监听ORDER_PREPARED_EVENT，完成商品配送，产生事件ORDER_DELIVERED_EVENT。</li>
<li>订单服务监听ORDER_DELIVERED_EVENT，将订单状态更新为"完成"。</li>
</ul>
<p>在这个流程中，订单服务很可能还会监听BILLED_ORDER_EVENT，ORDER_PREPARED_EVENT来完成订单状态的实时更新。将订单状态分别更新为"已经支付"和"已经出库"等状态来及时反映订单的最新状态。</p>
<p><strong>该模式下分布式事务的回滚</strong></p>
<p>为了在异常情况下回滚整个分布式事务，我们需要为相关服务提供补偿操作接口。</p>
<p>假设库存服务由于库存不足没能正确完成备货，我们可以按照下面的流程来回滚整个Saga事务：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b490d43e81c4c79b2a25802e0de66cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=UftlYvhJFKQkZTa%2BMtD3FWCzdy8%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>库存服务产生事件PRODUCT_OUT_OF_STOCK_EVENT。</li>
<li>订单服务和支付服务都会监听该事件并做出响应：
<ol>
<li>支付服务完成退款。</li>
<li>订单服务将订单状态设置为"失败"。</li>
</ol>
</li>
</ol>
<p><strong>基于事件方式的优缺点</strong></p>
<p><strong>优点</strong>：简单且容易理解。各参与方相互之间无直接沟通，完全解耦。这种方式比较适合整个分布式事务只有2-4个步骤的情形。</p>
<p><strong>缺点</strong>：这种方式如果涉及比较多的业务参与方，则比较容易失控。各业务参与方可随意监听对方的消息，以至于最后没人知道到底有哪些系统在监听哪些消息。更悲催的是，这个模式还可能产生环形监听，也就是两个业务方相互监听对方所产生的事件。</p>
<p>接下来，我们将介绍如何使用命令的方式来克服上面提到的缺点。</p>
<h4 data-id="heading-12">基于命令的方式</h4>
<p>在基于命令的方式中，我们会定义一个新的服务，这个服务扮演的角色就和一支交响乐乐队的指挥一样，告诉各个业务参与方，在什么时候做什么事情。我们管这个新服务叫做协调中心。协调中心通过命令/回复的方式来和Saga中其它服务进行交互。</p>
<p>我们继续以之前的订单流程来举例。下图中的Order Saga Orchestrator就是新引入的协调中心。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcd85f7dda8d49a99cc4aa9fa379cd51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=ChKhKFxWMUZExWvvmbyBxKljafk%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>订单服务创建一笔新订单，将订单状态设置为"待处理"，然后让Order Saga Orchestrator（OSO）开启创建订单事务。</li>
<li>OSO发送一个"支付命令"给支付服务，支付服务完成扣款并回复"支付完成"消息。</li>
<li>OSO发送一个"备货命令"给库存服务，库存服务完成库存扣减和备货，并回复"出库"消息。</li>
<li>OSO发送一个"配送命令"给物流服务，物流服务完成配送，并回复"配送完成"消息。</li>
<li>OSO向订单服务发送"订单结束命令"给订单服务，订单服务将订单状态设置为"完成"。</li>
<li>OSO清楚一个订单处理Saga的具体流程，并在出现异常时向相关服务发送补偿命令来回滚整个分布式事务。</li>
</ul>
<p>实现协调中心的一个比较好的方式是使用<strong>状态机(Sate Machine)</strong> 。</p>
<p><strong>该模式下分布式事务的回滚</strong></p>
<p>该模式下的回滚流程如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88bc3e6a2b4640399e044a653333bd10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=VpUopw9hJKUmC0inf8CRGTZFtts%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>库存服务回复OSO一个"库存不足"消息。</li>
<li>OSO意识到该分布式事务失败了，触发回滚流程：</li>
<li>OSO发送"退款命令"给支付服务，支付服务完成退款并回复"退款成功"消息。</li>
<li>OSO向订单服务发送"将订单状态改为失败命令"，订单服务将订单状态更新为"失败"。</li>
</ol>
<p><strong>基于命令方式的优缺点</strong></p>
<p>优点：</p>
<ol>
<li>避免了业务方之间的环形依赖。</li>
<li>将分布式事务的管理交由协调中心管理，协调中心对整个逻辑非常清楚。</li>
<li>减少了业务参与方的复杂度。这些业务参与方不再需要监听不同的消息，只是需要响应命令并回复消息。</li>
<li>测试更容易（分布式事务逻辑存在于协调中心，而不是分散在各业务方）。</li>
<li>回滚也更容易。</li>
</ol>
<p>缺点：</p>
<ol>
<li>一个可能的缺点就是需要维护协调中心，而这个协调中心并不属于任何业务方。</li>
</ol>
<h5 data-id="heading-13">Saga模式建议</h5>
<p>1，给每一个分布式事务创建一个唯一的Tx id。这个唯一的Tx id可以用来在各个业务参与方沟通时精确定位哪一笔分布式事务。
2，对于基于命令的方式，在命令中携带回复地址。这种方式可以让服务同时响应多个协调中心请求。
3，幂等性。幂等性能够增加系统的容错性，让各个业务参与方服务提供幂等性操作，能够在遇到异常情况下进行重试。
4，尽量在命令或者消息中携带下游处理需要的业务数据，避免下游处理时需要调用消息产生方接口获取更多数据。减少系统之间的相互依赖。</p>
<h3 data-id="heading-14">本地消息表</h3>
<blockquote>
<p>本地消息表核心思路是将分布式事务拆分成本地事务进行处理。</p>
</blockquote>
<p>角色：</p>
<ul>
<li>事务主动方</li>
<li>事务被动方</li>
</ul>
<p>通过在事务主动发起方额外新建事务消息表，事务发起方处理业务和记录事务消息在本地事务中完成，轮询事务消息表的数据发送事务消息，事务被动方基于消息中间件消费事务消息表中的事务。</p>
<p>这样可以避免以下两种情况导致的数据不一致性：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66837a1c30f4459f80d7c2db024a3bf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=leT52VQU8qQxZtCbIm8pFBztiy4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-15">场景描述</h4>
<ul>
<li><strong>上游服务</strong>：订单服务（Order Service），负责修改订单状态。</li>
<li><strong>下游服务</strong>：积分服务（Points Service），负责给用户增加积分。</li>
<li><strong>中间件</strong>：消息队列（MQ，如 RabbitMQ/RocketMQ）。</li>
<li><strong>目标</strong>：保证只要订单支付变成了“成功”，用户最终一定能收到积分，且不会多发。</li>
</ul>
<p>数据库包括：订单表，本地消息表，积分表。</p>
<p><strong>执行流程详解：</strong></p>
<ol>
<li>
<p>第一阶段：上游业务操作（利用本地事务的原子性）</p>
<p>当用户支付成功时，订单服务执行以下逻辑，<strong>重点是将这两步包裹在同一个数据库事务（Transaction）中</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 开启事务</span>
<span class="hljs-keyword">BEGIN</span>;

<span class="hljs-comment">-- 1. 更新订单状态为已支付</span>
<span class="hljs-keyword">UPDATE</span> t_order <span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">101</span>;

<span class="hljs-comment">-- 2. 插入一条待发送的消息到本地消息表</span>
<span class="hljs-comment">-- 注意：此时消息并没有发给 MQ，只是存在数据库里</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_local_message (msg_id, content, status) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'uuid-123'</span>, <span class="hljs-string">'{"userId":888, "points":10}'</span>, <span class="hljs-number">0</span>);

<span class="hljs-comment">-- 提交事务</span>
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<ul>
<li><strong>如果 Commit 成功</strong>：订单变了，消息也肯定在表里了。</li>
<li><strong>如果 Commit 失败/回滚</strong>：订单没变，消息表里也没数据。MQ 也不会收到消息。这就保证了<strong>强一致性</strong>。</li>
</ul>
</li>
<li>
<p>第二阶段：异步发送消息（依靠轮询/定时任务）</p>
<p>订单服务中有一个<strong>独立的后台线程（定时任务）</strong> ，专门处理 <code>t_local_message</code> 表：</p>
<ol>
<li><strong>查询</strong>：定时（比如每 5 秒）扫描 <code>t_local_message</code> 表中状态为 <code>0 (待发送)</code> 的记录。</li>
<li><strong>发送</strong>：将这些记录的内容发送到消息队列（MQ）。</li>
<li><strong>更新状态</strong>：
<ul>
<li>如果发送成功（MQ 返回 Ack），更新本地表状态为 <code>1 (已发送)</code>。</li>
<li>如果发送失败，更新 <code>retry_count + 1</code>，等待下次扫描重试。</li>
</ul>
</li>
</ol>
</li>
<li>
<p>第三阶段：下游消费（依靠幂等性）</p>
</li>
</ol>
<p>积分服务监听 MQ：</p>
<ol>
<li><strong>接收消息</strong>：收到 <code>{"userId":888, "points":10}</code>。</li>
<li><strong>幂等检查</strong>：<strong>非常重要！</strong>
<ul>
<li>检查该 <code>msg_id</code> (uuid-123) 是否已经处理过。</li>
<li>如果处理过，直接返回成功（丢弃消息）。</li>
<li>如果没处理过，往下走。</li>
</ul>
</li>
<li><strong>执行业务</strong>：给用户 888 增加 10 积分。</li>
<li><strong>确认消息</strong>：向 MQ 发送 ACK，表示消费成功。</li>
</ol>
<p><strong>异常情况分析：</strong></p>
<ul>
<li><strong>情况 A：第一阶段数据库挂了</strong>
<ul>
<li>结果：事务回滚，订单没成功，消息也没写入。用户重试支付即可，数据一致。</li>
</ul>
</li>
<li><strong>情况 B：消息发送给 MQ 时网络断了</strong>
<ul>
<li>结果：第一阶段已提交，订单已成功。后台定时任务会发现这条消息还是 <code>0 (待发送)</code>，它会不断重试发送，直到 MQ 恢复。<strong>保证了消息最终一定能发出去</strong>。</li>
</ul>
</li>
<li><strong>情况 C：下游积分服务挂了</strong>
<ul>
<li>结果：MQ 会保留消息。等积分服务重启后，继续消费。</li>
</ul>
</li>
<li><strong>情况 D：消息重复发送了（定时任务刚发完，更新数据库失败，下次又发了一次）</strong>
<ul>
<li>结果：下游积分服务必须实现<strong>幂等性</strong>，通过唯一 <code>msg_id</code> 判断，发现处理过就不再加积分。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-16">MQ事务方案</h3>
<blockquote>
<p>基于 MQ 的分布式事务方案其实是对本地消息表的封装，将本地消息表基于 MQ 内部，其他方面的协议基本与本地消息表一致。</p>
</blockquote>
<p>MQ事务方案整体流程和本地消息表的流程很相似，如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/640d2b3bb4cb4bd9a526ee5d0d31818e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=m3fZwfS7otFhsaZe2iWUdXiXl9o%3D" alt="image.png" loading="lazy"/></p>
<p>从上图可以看出和本地消息表方案唯一不同就是将本地消息表存在了MQ内部，而不是业务数据库中。</p>
<p>那么MQ内部的处理尤为重要，下面主要基于 RocketMQ 4.3 之后的版本介绍 MQ 的分布式事务方案。</p>
<p>在本地消息表方案中，保证事务主动方发写业务表数据和写消息表数据的一致性是基于数据库事务，RocketMQ 的事务消息相对于普通 MQ提供了 2PC 的提交接口，方案如下：</p>
<p><strong>正常情况：事务主动方发消息</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9050d97b48d440fb9674283c7a685b00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=oTtRafKlz7%2BGsBsZskrH53aA7U8%3D" alt="image.png" loading="lazy"/></p>
<p>这种情况下，事务主动方服务正常，没有发生故障，发消息流程如下：</p>
<ul>
<li>发送方向 MQ 服务端(MQ Server)发送 half 消息。</li>
<li>MQ Server 将消息持久化成功之后，向发送方 ack 确认消息已经发送成功。</li>
<li>发送方开始执行本地事务逻辑。</li>
<li>发送方根据本地事务执行结果向 MQ Server 提交二次确认（commit 或是 rollback）。</li>
<li>MQ Server 收到 commit 状态则将半消息标记为可投递，订阅方最终将收到该消息；MQ Server 收到 rollback 状态则删除半消息，订阅方将不会接受该消息。</li>
</ul>
<p><strong>异常情况：事务主动方消息恢复</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/838ce8fe22d744f59c7a3a18286cad8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=5QruhGmBeCRIztHjzVFrL8jp5ug%3D" alt="image.png" loading="lazy"/></p>
<p>在断网或者应用重启等异常情况下，上图中提交的二次确认超时未到达 MQ Server，此时处理逻辑如下：</p>
<ul>
<li>MQ Server 对该消息发起消息回查。</li>
<li>发送方收到消息回查后，需要检查对应消息的本地事务执行的最终结果。</li>
<li>发送方根据检查得到的本地事务的最终状态再次提交二次确认。</li>
<li>MQ Server基于 commit/rollback 对消息进行投递或者删除。</li>
</ul>
<p><strong>优点</strong></p>
<p>相比本地消息表方案，MQ 事务方案优点是：</p>
<ul>
<li>消息数据独立存储 ，降低业务系统与消息系统之间的耦合。</li>
<li>吞吐量大于使用本地消息表方案。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>一次消息发送需要两次网络请求(half 消息 + commit/rollback 消息) 。</li>
<li>业务处理服务需要实现消息状态回查接口。</li>
</ul>
<h3 data-id="heading-17">最大努力通知</h3>
<blockquote>
<p>最大努力通知也称为定期校对，是对MQ事务方案的进一步优化。它在事务主动方增加了消息校对的接口，如果事务被动方没有接收到消息，此时可以调用事务主动方提供的消息校对的接口主动获取。</p>
</blockquote>
<p>最大努力通知的整体流程如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a430691aafcc4f5686fa9615addbc753~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXR3ZWRuZXNkYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135300&amp;x-signature=TTFS4Rq0jppe1P1uB4HKdR36w0I%3D" alt="image.png" loading="lazy"/></p>
<p>在可靠消息事务中，事务主动方需要将消息发送出去，并且消息接收方成功接收，这种可靠性发送是由事务主动方保证的.</p>
<p>但是最大努力通知，事务主动方尽最大努力（重试，轮询....）将事务发送给事务接收方，但是仍然存在消息接收不到，此时需要事务被动方主动调用事务主动方的消息校对接口查询业务消息并消费，这种通知的可靠性是由事务被动方保证的。</p>
<p>最大努力通知适用于业务通知类型，例如微信交易的结果，就是通过最大努力通知方式通知各个商户，既有回调通知，也有交易查询接口。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：基于 Ent 从零实现新服务]]></title>    <link>https://juejin.cn/post/7582763878674579483</link>    <guid>https://juejin.cn/post/7582763878674579483</guid>    <pubDate>2025-12-12T09:10:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582763878674579483" data-draft-id="7582777037863338034" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：基于 Ent 从零实现新服务"/> <meta itemprop="keywords" content="后端,Go,ORM"/> <meta itemprop="datePublished" content="2025-12-12T09:10:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：基于 Ent 从零实现新服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:10:11.000Z" title="Fri Dec 12 2025 09:10:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：基于 Ent 从零实现新服务</h2>
<p>本文将指导开发者在 GoWind Admin 企业级前后端一体中后台框架中，从零开始构建一个完整的 gRPC 服务。我们所指的 “服务” 即 gRPC 中的 service，通常包含特定数据集的 CRUD（增删改查）操作，遵循框架规范实现高可维护性与可扩展性。</p>
<h3 data-id="heading-1">前置准备</h3>
<p>在开始前，请确保已完成以下环境准备：</p>
<h4 data-id="heading-2">开发环境</h4>
<ul>
<li>Go 1.19+（推荐 1.21+，支持最新语言特性）</li>
<li>Git（版本控制）</li>
<li>Protobuf 编译器（<code>protoc</code>，用于编译 proto 文件）</li>
</ul>
<h4 data-id="heading-3">依赖工具</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装相关的命令行工具</span>
make cli

<span class="hljs-comment"># 安装依赖的插件</span>
make plugin
</code></pre>
<h4 data-id="heading-4">项目结构</h4>
<p>克隆 GoWind Admin 项目后，核心目录结构如下（聚焦服务开发相关目录）：</p>
<pre><code class="hljs language-text" lang="text">go-wind-admin/
├── backend/
│   ├── api/gen/go/        # proto 编译生成的 Go 代码（自动生成，无需手动修改）
│   ├── api/proto/         # 存放 proto 接口定义文件
│   ├── app/admin/service/ # 业务服务核心实现
│   │   ├── internal/
│   │   │   ├── data/      # 数据访问层（与数据库交互，基于 ent）
│   │   │   │   └── ent/   # ent ORM 自动生成的数据库操作代码
│   │   │   └── service/   # 业务逻辑层（实现 gRPC 接口）
│   │   └── server/        # 服务注册（将服务绑定到 gRPC/HTTP 服务器）
</code></pre>
<h3 data-id="heading-5">一、设计数据库表结构</h3>
<p>数据库表结构是服务的基础，需根据业务需求设计核心字段。以 “用户表” 为例，需包含：</p>
<ul>
<li>通用字段：ID（主键）、创建时间、更新时间、创建者 ID、更新者 ID（用于审计）</li>
<li>业务字段：用户名（唯一）、密码、昵称、邮箱、手机号等</li>
<li>关联字段：角色 ID、部门 ID 等（用于关联其他表）</li>
<li>状态字段：用户状态（启用 / 禁用）、性别等枚举字段</li>
</ul>
<p><strong>设计原则：</strong></p>
<ul>
<li>核心字段非空（如用户名），非核心字段可空（如地址）</li>
<li>频繁查询的字段添加索引（如用户名）</li>
<li>敏感字段（如密码）需加密存储</li>
</ul>
<h3 data-id="heading-6">二、编写 ent 的 schema</h3>
<p>Ent 是 Go 语言的 ORM 库，通过 schema 定义数据库实体。schema 文件位于 <code>backend/app/admin/service/internal/data/ent/schema</code> 目录。</p>
<p>步骤说明：</p>
<ol>
<li>创建 <code>user.go</code> 文件，定义 Us`er 结构体及其配置。</li>
<li>通过 <code>Annotations</code> 配置表名、字符集等数据库属性。</li>
<li>通过 <code>Fields</code> 定义表字段，包括类型、约束（唯一、非空等）、注释。</li>
<li>通过 <code>Mixin</code> 复用通用字段（如 ID、时间戳），减少重复代码。</li>
<li>通过 <code>Indexes</code> 定义索引，提升查询性能。</li>
</ol>
<h4 data-id="heading-7">关键代码解析：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Annotations 配置表基本信息</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(User)</span></span> Annotations() []schema.Annotation {
    <span class="hljs-keyword">return</span> []schema.Annotation{
        entsql.Annotation{
            Table:     <span class="hljs-string">"sys_users"</span>, <span class="hljs-comment">// 数据库表名</span>
            Charset:   <span class="hljs-string">"utf8mb4"</span>,   <span class="hljs-comment">// 字符集</span>
            Collation: <span class="hljs-string">"utf8mb4_bin"</span>, <span class="hljs-comment">// 排序规则</span>
        },
        schema.Comment(<span class="hljs-string">"用户表"</span>), <span class="hljs-comment">// 表注释</span>
    }
}

<span class="hljs-comment">// Fields 定义表字段</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(User)</span></span> Fields() []ent.Field {
    <span class="hljs-keyword">return</span> []ent.Field{
        field.String(<span class="hljs-string">"username"</span>).
            Comment(<span class="hljs-string">"用户名"</span>).
            Unique().       <span class="hljs-comment">// 唯一索引</span>
            NotEmpty().     <span class="hljs-comment">// 非空</span>
            Immutable(),    <span class="hljs-comment">// 创建后不可修改</span>

        field.String(<span class="hljs-string">"password"</span>).
            Comment(<span class="hljs-string">"登录密码"</span>).
            MaxLen(<span class="hljs-number">255</span>).    <span class="hljs-comment">// 最大长度</span>
            Sensitive(),    <span class="hljs-comment">// 敏感字段（日志中隐藏）</span>

        <span class="hljs-comment">// 其他字段...</span>
    }
}

<span class="hljs-comment">// Mixin 复用通用配置</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(User)</span></span> Mixin() []ent.Mixin {
    <span class="hljs-keyword">return</span> []ent.Mixin{
        mixin.AutoIncrementId{}, <span class="hljs-comment">// 自增 ID</span>
        mixin.TimeAt{},          <span class="hljs-comment">// 创建时间、更新时间</span>
        mixin.OperatorID{},      <span class="hljs-comment">// 创建者、更新者 ID</span>
    }
}
</code></pre>
<h4 data-id="heading-8">生成 ent 代码：</h4>
<p>编写完 schema 后，执行以下命令生成实体代码：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> backend/app/admin/service/
make ent
</code></pre>
<h3 data-id="heading-9">三、编写 gRPC 的 proto 文件</h3>
<p>Protobuf（proto）用于定义 gRPC 服务接口和数据结构，是服务对外暴露的 “契约”。proto 文件通常位于 <code>backend/api/proto/user/service/v1</code> 目录。</p>
<h4 data-id="heading-10">步骤说明：</h4>
<ol>
<li>定义服务接口（<code>service UserService</code>），包含 CRUD 方法（如 <code>CreateUser</code>、<code>ListUser</code>）。</li>
<li>定义请求 / 响应消息（message），映射数据库字段和业务需求。</li>
<li>定义枚举（enum），如用户状态、性别等固定值类型。</li>
</ol>
<h4 data-id="heading-11">关键代码解析：</h4>
<pre><code class="hljs language-protobuf" lang="protobuf">// backend/api/proto/user/service/v1/user.proto

// 定义服务接口
service UserService {
  rpc ListUser (pagination.PagingRequest) returns (ListUserResponse); // 列表查询
  rpc GetUser (GetUserRequest) returns (User);                        // 详情查询
  rpc CreateUser (CreateUserRequest) returns (google.protobuf.Empty); // 创建
  rpc UpdateUser (UpdateUserRequest) returns (google.protobuf.Empty); // 更新
  rpc DeleteUser (DeleteUserRequest) returns (google.protobuf.Empty); // 删除
}

// 枚举定义（用户状态）
enum UserStatus {
  OFF = 0; // 禁用
  ON = 1;  // 启用
}

// 数据模型（与数据库表对应）
message User {
  optional uint32 id = 1 [json_name = "id"]; // 用户ID
  optional string username = 2;              // 用户名
  optional UserStatus status = 3;            // 状态
  // 其他字段...
}
</code></pre>
<h4 data-id="heading-12">生成 Go 代码：</h4>
<p>执行以下命令将 proto 转换为 Go 代码（生成的代码位于 <code>backend/api/gen/go</code> 目录）：</p>
<pre><code class="hljs language-bash" lang="bash">make api
</code></pre>
<h3 data-id="heading-13">四、编写 REST 的 proto 文件</h3>
<p>Protobuf（proto）用于定义 REST 服务接口和数据结构，是服务对外暴露的 “契约”。proto 文件通常位于 <code>backend/api/proto/admin/service/v1</code> 目录。</p>
<h4 data-id="heading-14">关键代码解析：</h4>
<pre><code class="hljs language-protobuf" lang="protobuf">// backend/api/proto/admin/service/v1/i_user.proto

import "user/service/v1/user.proto";

// 用户管理服务
service UserService {
  // 获取用户列表
  rpc List (pagination.PagingRequest) returns (user.service.v1.ListUserResponse) {
    option (redact.v3.internal_method) = true;
    option (google.api.http) = {
      get: "/admin/v1/users"
    };
  }

  // 获取用户数据
  rpc Get (user.service.v1.GetUserRequest) returns (user.service.v1.User) {
    option (redact.v3.internal_method) = true;
    option (google.api.http) = {
      get: "/admin/v1/users/{id}"
      additional_bindings {
        get: "/admin/v1/users/username/{user_name}"
      }
    };
  }

  // 创建用户
  rpc Create (user.service.v1.CreateUserRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/admin/v1/users"
      body: "*"
    };
  }

  // 更新用户
  rpc Update (user.service.v1.UpdateUserRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      put: "/admin/v1/users/{id}"
      body: "*"
    };
  }

  // 删除用户
  rpc Delete (user.service.v1.DeleteUserRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/admin/v1/users/{id}"
    };
  }
}

// 枚举定义（用户状态）
enum UserStatus {
  OFF = 0; // 禁用
  ON = 1;  // 启用
}

// 数据模型（与数据库表对应）
message User {
  optional uint32 id = 1 [json_name = "id"]; // 用户ID
  optional string username = 2;              // 用户名
  optional UserStatus status = 3;            // 状态
  // 其他字段...
}
</code></pre>
<h4 data-id="heading-15">生成代码：</h4>
<p>执行以下命令将 proto 转换为 Go 代码（生成的代码位于 <code>backend/api/gen/go</code> 目录）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成go代码</span>
make api
</code></pre>
<p>执行以下命令将 proto 转换为 OpenAPI文档（生成的文档位于<code>backend/app/admin/service/cmd/server/assets/</code>目录）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成OpenAPI文档</span>
make openapi
</code></pre>
<p>执行以下命令将 proto 转换为 TypeScript代码（生成的代码位于<code>frontend/apps/admin/src/generated/api</code>目录）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成TypeScript代码</span>
make ts
</code></pre>
<h3 data-id="heading-16">五、编写 data 包（数据访问层）</h3>
<p><code>data</code> 包负责与数据库交互，实现 CRUD 操作，是业务逻辑与数据库之间的桥梁。代码位于 <code>backend/app/admin/service/internal/data</code> 目录。</p>
<h4 data-id="heading-17">核心职责：</h4>
<ul>
<li>封装 ent 的数据库操作（查询、插入、更新、删除）。</li>
<li>实现 ent 实体与 proto 消息的转换（如 <code>convertEntToProto</code>）。</li>
<li>处理数据访问过程中的错误（如记录日志、返回业务错误）。</li>
</ul>
<h4 data-id="heading-18">关键代码解析：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> data

<span class="hljs-keyword">type</span> UserRepo <span class="hljs-keyword">struct</span> {
	data *Data
	log  *log.Helper

	mapper             *mapper.CopierMapper[userV1.User, ent.User]
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserRepo</span><span class="hljs-params">(logger log.Logger, data *Data)</span></span> *UserRepo {
	repo := &amp;UserRepo{
		log:                log.NewHelper(log.With(logger, <span class="hljs-string">"module"</span>, <span class="hljs-string">"user/repo/admin-service"</span>)),
		data:               data,
		mapper:             mapper.NewCopierMapper[userV1.User, ent.User](),
	}

	<span class="hljs-keyword">return</span> repo
}

<span class="hljs-comment">// 创建用户</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *UserRepo)</span></span> CreateUser(ctx context.Context, req *userV1.CreateUserRequest) <span class="hljs-type">error</span> {
	<span class="hljs-keyword">if</span> req == <span class="hljs-literal">nil</span> || req.Data == <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, userV1.ErrorBadRequest(<span class="hljs-string">"invalid parameter"</span>)
	}

	<span class="hljs-keyword">if</span> req.Data.Password != <span class="hljs-literal">nil</span> &amp;&amp; req.Data.GetPassword() != <span class="hljs-string">""</span> {
		cryptoPassword, err := crypto.HashPassword(req.Data.GetPassword())
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
		}
		req.Data.Password = &amp;cryptoPassword
	}

    <span class="hljs-comment">// 调用 ent 插入数据</span>
    <span class="hljs-keyword">return</span> r.data.db.Client().User.Create().
        SetUsername(req.Data.Username).
        SetPassword(req.Data.GetPassword()).
        <span class="hljs-comment">// 设置其他字段...</span>
        Exec(ctx)
}
</code></pre>
<h3 data-id="heading-19">六、编写 service 包（业务逻辑层）</h3>
<p>service 包实现核心业务逻辑，调用 data 包进行数据操作，并处理权限校验、参数校验等业务规则。代码位于 <code>backend/app/admin/service/internal/service</code> 目录。</p>
<h4 data-id="heading-20">核心职责：</h4>
<ul>
<li>校验请求参数合法性（如非空检查）。</li>
<li>实现业务规则（如 “禁止删除超级管理员”）。</li>
<li>调用 data 包完成数据操作，并返回结果。</li>
</ul>
<h4 data-id="heading-21">关键代码解析：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 创建用户（包含权限校验）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span></span> CreateUser(ctx context.Context, req *userV1.CreateUserRequest) (*emptypb.Empty, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 参数校验</span>
    <span class="hljs-keyword">if</span> req.Data == <span class="hljs-literal">nil</span> || req.Data.Username == <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"用户名不能为空"</span>)
    }

    <span class="hljs-comment">// 权限校验：只有管理员能创建用户</span>
    operator, err := s.userRepo.GetUser(ctx, req.OperatorId)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || operator.Authority != userV1.UserAuthority_SYS_ADMIN {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"权限不足"</span>)
    }

    <span class="hljs-comment">// 调用 data 包创建用户</span>
    <span class="hljs-keyword">return</span> &amp;emptypb.Empty{}, s.userRepo.CreateUser(ctx, req)
}
</code></pre>
<h3 data-id="heading-22">七、注册服务到 Server</h3>
<p>最后需将服务注册到 gRPC 或 REST 服务器，使客户端能访问服务。注册代码位于 <code>backend/app/admin/service/server</code> 目录。</p>
<h4 data-id="heading-23">gRPC 服务注册：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> (
	<span class="hljs-string">"github.com/go-kratos/kratos/v2/transport/grpc"</span>
)

<span class="hljs-comment">// 注册 gRPC 服务</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewGRPCServer</span><span class="hljs-params">(cfg *conf.Bootstrap, userSvc *service.UserService)</span></span> *grpc.Server {
    srv := grpc.NewServer()

    <span class="hljs-comment">// 将 UserService 注册到 gRPC 服务器</span>
    userV1.RegisterUserServiceServer(srv, userSvc)

    <span class="hljs-keyword">return</span> srv
}
</code></pre>
<h4 data-id="heading-24">REST 服务注册：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> (
	<span class="hljs-string">"github.com/go-kratos/kratos/v2/transport/http"</span>
)

<span class="hljs-comment">// 注册 REST 服务</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewRESTServer</span><span class="hljs-params">(cfg *conf.Bootstrap, userSvc *service.UserService)</span></span> *http.Server {
	<span class="hljs-keyword">if</span> cfg == <span class="hljs-literal">nil</span> || cfg.Server == <span class="hljs-literal">nil</span> || cfg.Server.Rest == <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	}

	srv := rpc.CreateRestServer(cfg)
   
	<span class="hljs-comment">// 将 UserService 注册到 REST 服务器</span>
	adminV1.RegisterUserServiceHTTPServer(srv, userSvc)

	<span class="hljs-keyword">return</span> srv
}
</code></pre>
<h3 data-id="heading-25">八、测试新服务</h3>
<p>服务开发完成后，需验证功能正确性：</p>
<h4 data-id="heading-26">1. <strong>单元测试：</strong></h4>
<p>测试 data 包和 service 包的核心方法（使用 Go 内置测试框架）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/app/admin/service/internal/service/user_service_test.go</span>
<span class="hljs-keyword">package</span> service_test

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"testing"</span>

    <span class="hljs-string">"github.com/stretchr/testify/assert"</span>
    userV1 <span class="hljs-string">"go-wind-admin/api/gen/go/admin/service/v1"</span>
    <span class="hljs-string">"go-wind-admin/app/admin/service/internal/service"</span>
    <span class="hljs-string">"go-wind-admin/mocks"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestCreateUser</span><span class="hljs-params">(t *testing.T)</span></span> {
    <span class="hljs-comment">// 初始化 mock 依赖</span>
    mockUserRepo := mocks.NewUserRepo(t)
    svc := service.NewUserService(mockUserRepo, <span class="hljs-literal">nil</span>)

    <span class="hljs-comment">// 测试用例：用户名空</span>
    req := &amp;userV1.CreateUserRequest{Password: <span class="hljs-string">"12345678"</span>}
    _, err := svc.CreateUser(context.Background(), req)
    assert.ErrorContains(t, err, <span class="hljs-string">"用户名不能为空"</span>)

    <span class="hljs-comment">// 其他测试用例...</span>
}
</code></pre>
<h4 data-id="heading-27">2. <strong>接口测试：</strong></h4>
<h5 data-id="heading-28">gRPC 接口</h5>
<p>使用 <code>grpcurl</code> 调用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出服务接口</span>
grpcurl -plaintext localhost:9000 list admin.service.v1.UserService

<span class="hljs-comment"># 调用创建用户接口</span>
grpcurl -plaintext -d <span class="hljs-string">'{"username":"test","password":"12345678"}'</span> \
  localhost:9000 admin.service.v1.UserService/CreateUser
</code></pre>
<h5 data-id="heading-29">HTTP 接口</h5>
<p>使用 curl 或 Postman 调用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建用户</span>
curl -X POST http://localhost:8080/admin/v1/users \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"username":"test","password":"12345678"}'</span>
</code></pre>
<h3 data-id="heading-30">总结</h3>
<p>通过以上步骤，我们完成了一个新服务从数据库设计到接口暴露的全流程实现。GoWind Admin 框架的分层架构（schema → data → service → server）确保了代码的低耦合与高可维护性：</p>
<ul>
<li><strong>schema 层</strong>：通过 ent 定义数据结构，自动生成数据库操作代码。</li>
<li><strong>data 层</strong>：封装数据库交互，隔离业务逻辑与数据访问。</li>
<li><strong>service 层</strong>：聚焦业务规则，与数据层解耦。</li>
<li><strong>server 层</strong>：统一注册服务，简化部署与扩展。</li>
</ul>
<p>遵循此流程，开发者可快速在框架中扩展新服务，充分利用框架提供的工具链（ent、Protobuf、gRPC）提升开发效率。</p>
<h3 data-id="heading-31">项目代码</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://gitee.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">go-wind-admin Gitee</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://github.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">go-wind-admin Github</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[护航隐私！小程序纯前端“证件加水印”：OffscreenCanvas 全屏平铺实战]]></title>    <link>https://juejin.cn/post/7582777037862879282</link>    <guid>https://juejin.cn/post/7582777037862879282</guid>    <pubDate>2025-12-12T08:34:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582777037862879282" data-draft-id="7582777037862846514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="护航隐私！小程序纯前端“证件加水印”：OffscreenCanvas 全屏平铺实战"/> <meta itemprop="keywords" content="前端,JavaScript,微信小程序"/> <meta itemprop="datePublished" content="2025-12-12T08:34:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小皮虾"/> <meta itemprop="url" content="https://juejin.cn/user/1468603263091623"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            护航隐私！小程序纯前端“证件加水印”：OffscreenCanvas 全屏平铺实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1468603263091623/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小皮虾
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:34:45.000Z" title="Fri Dec 12 2025 08:34:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 背景与痛点：证件“裸奔”的风险</h2>
<p>在日常生活中，我们经常需要上传身份证、驾照或房产证照片来办理各种业务。然而，直接发送原图存在巨大的安全隐患：</p>
<ul>
<li><strong>被二次盗用</strong>：不法分子可能将你的证件照用于网贷、注册账号等非法用途。</li>
<li><strong>服务器隐私泄露</strong>：如果使用在线工具加水印，图片必须上传到第三方服务器，这就好比“把钥匙交给陌生人保管”，风险不可控。</li>
</ul>
<p>为了解决这一痛点，可利用小程序的 <code>OffscreenCanvas</code> 能力，在用户手机本地毫秒级合成水印，<strong>图片数据永远不会离开用户手机</strong>。</p>
<h2 data-id="heading-1">2. 核心思路：离屏渲染 + 矩阵平铺</h2>
<p>实现全屏倾斜水印，主要难点在于<strong>坐标计算</strong>和<strong>性能平衡</strong>。我们的方案如下：</p>
<ol>
<li><strong>离屏渲染 (OffscreenCanvas)</strong>：
使用离屏画布在内存中处理，避免页面闪烁，且支持高性能的 2D 渲染模式。</li>
<li><strong>智能 DPR 降级</strong>：
沿用我们之前文章提到的防爆内存策略。证件照通常分辨率很高，必须计算安全尺寸，防止 Canvas 内存溢出闪退。</li>
<li><strong>矩阵平铺算法</strong>：
不简单的旋转画布，而是采用 <strong>“保存环境 -&gt; 平移 -&gt; 旋转 -&gt; 绘制 -&gt; 恢复环境”</strong> 的策略，在一个网格循环中将文字铺满全屏，确保无论图片比例如何，水印都能均匀分布。</li>
</ol>
<h2 data-id="heading-2">3. 硬核代码实现</h2>
<p>以下是封装好的 <code>watermarkUtils.js</code>。包含了<strong>智能 DPR 计算</strong>和<strong>全屏水印绘制</strong>的核心逻辑。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/watermarkUtils.js</span>

<span class="hljs-comment">// 1. 获取系统基础信息</span>
<span class="hljs-keyword">const</span> wxt = {
  <span class="hljs-attr">dpr</span>: wx.<span class="hljs-title function_">getSystemInfoSync</span>().<span class="hljs-property">pixelRatio</span> || <span class="hljs-number">2</span>
};

<span class="hljs-comment">// 图片缓存，避免重复加载</span>
<span class="hljs-keyword">const</span> cacheCanvasImageMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-comment">/**
 * 内部方法：获取/创建 Canvas Image 对象
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCanvasImage</span>(<span class="hljs-params">canvas, imageUrl</span>) {
  <span class="hljs-keyword">if</span> (cacheCanvasImageMap.<span class="hljs-title function_">has</span>(imageUrl)) <span class="hljs-keyword">return</span> cacheCanvasImageMap.<span class="hljs-title function_">get</span>(imageUrl);
  
  <span class="hljs-comment">// 兼容性处理：若不支持 Promise.withResolvers，请改用 new Promise</span>
  <span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
  <span class="hljs-keyword">const</span> image = canvas.<span class="hljs-title function_">createImage</span>();
  image.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
    cacheCanvasImageMap.<span class="hljs-title function_">set</span>(imageUrl, image);
    <span class="hljs-title function_">resolve</span>(image);
  };
  image.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`加载失败: <span class="hljs-subst">${e.errMsg}</span>`</span>));
  image.<span class="hljs-property">src</span> = imageUrl;
  <span class="hljs-keyword">await</span> promise;
  <span class="hljs-keyword">return</span> image;
}

<span class="hljs-comment">/**
 * 给图片添加全屏倾斜水印
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} imageUrl 图片路径
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} text 水印文字，如 "仅供办理租房业务使用"
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">object</span>} options 配置项 { color, size, opacity }
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">addWatermark</span>(<span class="hljs-params">imageUrl, text = <span class="hljs-string">'仅供办理业务使用'</span>, options = {}</span>) {
  <span class="hljs-comment">// 默认配置</span>
  <span class="hljs-keyword">const</span> config = {
    <span class="hljs-attr">color</span>: <span class="hljs-string">'#aaaaaa'</span>,
    <span class="hljs-attr">opacity</span>: <span class="hljs-number">0.5</span>,
    <span class="hljs-attr">fontSize</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 0 表示自动计算</span>
    <span class="hljs-attr">gap</span>: <span class="hljs-number">100</span>,    <span class="hljs-comment">// 水印间距</span>
    ...options
  };

  <span class="hljs-keyword">const</span> offscreenCanvas = wx.<span class="hljs-title function_">createOffscreenCanvas</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'2d'</span> });
  <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getCanvasImage</span>(offscreenCanvas, imageUrl);
  <span class="hljs-keyword">const</span> { width, height } = image;

  <span class="hljs-comment">// --- ⚡️ 性能优化：智能 DPR 计算 (防止大图闪退) ---</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LIMIT_SIZE</span> = <span class="hljs-number">4096</span>; 
  <span class="hljs-keyword">let</span> useDpr = wxt.<span class="hljs-property">dpr</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(width, height) * useDpr &gt; <span class="hljs-variable constant_">LIMIT_SIZE</span>) {
    useDpr = <span class="hljs-variable constant_">LIMIT_SIZE</span> / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(width, height);
  }

  <span class="hljs-comment">// 设置画布尺寸</span>
  offscreenCanvas.<span class="hljs-property">width</span> = width * useDpr;
  offscreenCanvas.<span class="hljs-property">height</span> = height * useDpr;

  <span class="hljs-keyword">const</span> ctx = offscreenCanvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
  ctx.<span class="hljs-title function_">scale</span>(useDpr, useDpr);
  
  <span class="hljs-comment">// 1. 绘制底图</span>
  ctx.<span class="hljs-title function_">drawImage</span>(image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);

  <span class="hljs-comment">// 2. 配置水印样式</span>
  <span class="hljs-comment">// 自动计算字号：约为图片宽度的 4%</span>
  <span class="hljs-keyword">const</span> fontSize = config.<span class="hljs-property">fontSize</span> || <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(width * <span class="hljs-number">0.04</span>); 
  ctx.<span class="hljs-property">font</span> = <span class="hljs-string">`bold <span class="hljs-subst">${fontSize}</span>px sans-serif`</span>;
  ctx.<span class="hljs-property">fillStyle</span> = config.<span class="hljs-property">color</span>;
  ctx.<span class="hljs-property">globalAlpha</span> = config.<span class="hljs-property">opacity</span>;
  ctx.<span class="hljs-property">textBaseline</span> = <span class="hljs-string">'middle'</span>;
  ctx.<span class="hljs-property">textAlign</span> = <span class="hljs-string">'center'</span>;

  <span class="hljs-comment">// 3. 计算平铺逻辑</span>
  <span class="hljs-comment">// 旋转 45 度后，覆盖范围需要比原图大，这里简单取对角线长度作为边界</span>
  <span class="hljs-keyword">const</span> maxSize = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(width * width + height * height);
  <span class="hljs-comment">// 步长 = 文字宽度 + 间距</span>
  <span class="hljs-keyword">const</span> step = ctx.<span class="hljs-title function_">measureText</span>(text).<span class="hljs-property">width</span> + config.<span class="hljs-property">gap</span>; 
  
  <span class="hljs-comment">// 4. 循环绘制水印</span>
  <span class="hljs-comment">// 从负坐标开始绘制，确保旋转后边缘也有水印</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x = -maxSize; x &lt; maxSize; x += step) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> y = -maxSize; y &lt; maxSize; y += step) {
      ctx.<span class="hljs-title function_">save</span>();
      
      <span class="hljs-comment">// 核心变换：平移到网格点 -&gt; 旋转 -&gt; 绘制</span>
      ctx.<span class="hljs-title function_">translate</span>(x, y);
      ctx.<span class="hljs-title function_">rotate</span>(-<span class="hljs-number">45</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">180</span>); <span class="hljs-comment">// 逆时针旋转 45 度</span>
      ctx.<span class="hljs-title function_">fillText</span>(text, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
      
      ctx.<span class="hljs-title function_">restore</span>();
    }
  }

  <span class="hljs-comment">// 5. 导出图片</span>
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> wx.<span class="hljs-title function_">canvasToTempFilePath</span>({
    <span class="hljs-attr">canvas</span>: offscreenCanvas,
    <span class="hljs-attr">fileType</span>: <span class="hljs-string">'jpg'</span>,
    <span class="hljs-attr">quality</span>: <span class="hljs-number">0.8</span>, <span class="hljs-comment">// 稍微压缩以减小体积</span>
  });

  <span class="hljs-keyword">return</span> res.<span class="hljs-property">tempFilePath</span>;
}
</code></pre>
<h2 data-id="heading-3">4. 业务调用示例</h2>
<p>在小程序页面中，用户选择图片并输入水印文字后，实时预览效果。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// pages/watermark/index.js</span>
<span class="hljs-keyword">import</span> { addWatermark } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../utils/watermarkUtils'</span>;

<span class="hljs-title class_">Page</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">originImg</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">resultImg</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">watermarkText</span>: <span class="hljs-string">'仅供本次业务使用 他用无效'</span>
  },

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onAddWatermark</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">originImg</span>) <span class="hljs-keyword">return</span>;

    wx.<span class="hljs-title function_">showLoading</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'安全合成中...'</span> });
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> tempFilePath = <span class="hljs-keyword">await</span> <span class="hljs-title function_">addWatermark</span>(
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">originImg</span>, 
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">watermarkText</span>,
        {
          <span class="hljs-attr">color</span>: <span class="hljs-string">'#ffffff'</span>, <span class="hljs-comment">// 白色水印</span>
          <span class="hljs-attr">opacity</span>: <span class="hljs-number">0.4</span>,     <span class="hljs-comment">// 半透明</span>
          <span class="hljs-attr">gap</span>: <span class="hljs-number">120</span>          <span class="hljs-comment">// 间距疏松一点</span>
        }
      );
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">resultImg</span>: tempFilePath });
      
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
      wx.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'合成失败'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span> });
    } <span class="hljs-keyword">finally</span> {
      wx.<span class="hljs-title function_">hideLoading</span>();
    }
  }
})
</code></pre>
<h2 data-id="heading-4">5. 避坑与实战经验</h2>
<ol>
<li><strong>自动字号的重要性</strong>：
不要写死 <code>fontSize = 20px</code>。用户上传的图片分辨率差异极大（有的 500px 宽，有的 4000px 宽）。最佳实践是<strong>根据图片宽度动态计算字号</strong>（如 <code>width * 0.04</code>），这样无论处理缩略图还是 4K 原图，水印比例看起来都是协调的。</li>
<li><strong>平铺范围的陷阱</strong>：
因为文字需要旋转 45 度，如果循环只从 <code>0</code> 到 <code>width</code>，图片的左下角和右上角可能会出现空白。代码中我们从 <code>-maxSize</code>（负数区域）开始循环，确保旋转后的文字能完全覆盖画布的每一个角落。</li>
<li><strong>隐私第一</strong>：
在工具的 UI 界面上，建议显著提示 <strong>“纯本地处理，无上传服务器”</strong>，这能极大地增加用户的信任感，提升工具的使用率。</li>
</ol>
<h2 data-id="heading-5">写在最后</h2>
<p>通过<code>帮小忙工具箱</code>的这个实践案例，我们可以看到，利用小程序强大的 Canvas 能力，开发者完全可以在保护用户隐私的前提下，提供专业级的图片处理服务。</p>
<p><strong>技术不只是代码，更是对用户安全的守护。</strong> 希望这篇分享能帮你在小程序中实现更安全、更高效的功能！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[制作一个简单的HTML个人网页]]></title>    <link>https://juejin.cn/post/7582786292087046195</link>    <guid>https://juejin.cn/post/7582786292087046195</guid>    <pubDate>2025-12-12T08:54:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582786292087046195" data-draft-id="7582777037863157810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="制作一个简单的HTML个人网页"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-12T08:54:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="yingjuxia菜鸟com"/> <meta itemprop="url" content="https://juejin.cn/user/1065848795830204"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            制作一个简单的HTML个人网页
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1065848795830204/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    yingjuxia菜鸟com
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:54:44.000Z" title="Fri Dec 12 2025 08:54:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    20
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>下面给你一个<strong>超级<a href="https://link.juejin.cn?target=https%3A%2F%2Fyingjuxia.com%2Farchives%2F7064" target="_blank" title="https://yingjuxia.com/archives/7064" ref="nofollow noopener noreferrer">简单但又好看</a>、手机电脑都能完美访问</strong>的个人主页模板，5 分钟就能改成你自己的专属网页！</p>
<h3 data-id="heading-0">功能特点</h3>
<ul>
<li>纯 HTML + CSS（一行 JavaScript 都不用）</li>
<li>自适应移动端（手机看起来也好看）</li>
<li>深色/浅色自动切换（跟随系统）</li>
<li>一键替换头像、姓名、简介、社交链接就完事</li>
<li>支持添加博客、项目、作品、摄影等模块</li>
</ul>
<h3 data-id="heading-1">完整代码（直接复制保存为 index.html 双击打开即可）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>张三的个人主页<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-pseudo">:root</span> {
            <span class="hljs-attr">--bg</span>: <span class="hljs-number">#f8f9fa</span>;
            <span class="hljs-attr">--text</span>: <span class="hljs-number">#2c3e50</span>;
            <span class="hljs-attr">--card</span>: <span class="hljs-number">#ffffff</span>;
            <span class="hljs-attr">--accent</span>: <span class="hljs-number">#ff6b6b</span>;   <span class="hljs-comment">/* 主色调，喜欢可换成 #e91e63、#4ecdc4 等 */</span>
        }
        <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">prefers-color-scheme</span>: dark) {
            <span class="hljs-selector-pseudo">:root</span> {
                <span class="hljs-attr">--bg</span>: <span class="hljs-number">#121212</span>;
                <span class="hljs-attr">--text</span>: <span class="hljs-number">#e0e0e0</span>;
                <span class="hljs-attr">--card</span>: <span class="hljs-number">#1e1e1e</span>;
            }
        }

        * { <span class="hljs-attribute">margin</span>:<span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>:<span class="hljs-number">0</span>; <span class="hljs-attribute">box-sizing</span>:border-box; }
        <span class="hljs-selector-tag">body</span> {
            <span class="hljs-attribute">font-family</span>: <span class="hljs-string">"Segoe UI"</span>, Arial, sans-serif;
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--bg);
            <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text);
            <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.6</span>;
            <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100vh</span>;
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">justify-content</span>: center;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
        }
        <span class="hljs-selector-class">.card</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--card);
            <span class="hljs-attribute">max-width</span>: <span class="hljs-number">420px</span>;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">overflow</span>: hidden;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">15px</span> <span class="hljs-number">35px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span>;
        }
        <span class="hljs-selector-class">.card</span><span class="hljs-selector-pseudo">:hover</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">10px</span>); }

        <span class="hljs-selector-class">.avatar</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">120px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">120px</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">30px</span> auto <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">object-fit</span>: cover;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">5px</span> solid <span class="hljs-built_in">var</span>(--accent);
        }
        <span class="hljs-selector-tag">h1</span> {
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">28px</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span> <span class="hljs-number">0</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--accent);
        }
        <span class="hljs-selector-class">.tagline</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#888</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
        }
        <span class="hljs-selector-class">.bio</span> {
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">30px</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">25px</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">15px</span>;
        }
        <span class="hljs-selector-class">.links</span> {
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">flex-wrap</span>: wrap;
            <span class="hljs-attribute">justify-content</span>: center;
            <span class="hljs-attribute">gap</span>: <span class="hljs-number">12px</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-number">30px</span>;
        }
        <span class="hljs-selector-class">.links</span> <span class="hljs-selector-tag">a</span> {
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--accent);
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">text-decoration</span>: none;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50px</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
            <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span>;
        }
        <span class="hljs-selector-class">.links</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.08</span>);
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-number">15px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>,<span class="hljs-number">107</span>,<span class="hljs-number">107</span>,<span class="hljs-number">0.4</span>);
        }
        <span class="hljs-selector-class">.links</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">i</span> { <span class="hljs-attribute">font-size</span>: <span class="hljs-number">18px</span>; }

        <span class="hljs-selector-tag">footer</span> {
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">40px</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#aaa</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 图标库（可选） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 1. 替换成你的头像（放同目录下或用网络链接） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://avatars.githubusercontent.com/u/你的githubid?v=4"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"头像"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"avatar"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 或者本地图片：src="myphoto.jpg" --&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>张三<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tagline"</span>&gt;</span>前端开发者 / 摄影爱好者 / 正在努力变厉害的人<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bio"</span>&gt;</span>
        Hi～我是张三，目前在广州做前端，喜欢写代码、拍风景、撸猫。<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>
        生活很普通，但希望每天都能进步一点点
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"links"</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 直接改链接和图标就行 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://github.com/yourname"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fab fa-github"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> GitHub
        <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://weibo.com/yourname"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fab fa-weibo"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 微博
        <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://space.bilibili.com/123456"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fab fa-bilibili"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> B站
        <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"mailto:your@email.com"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-envelope"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 邮件
        <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://yourblog.com"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-blog"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 博客
        <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://juejin.cn/user/你的id"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fab fa-juejin"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 掘金
        <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>© 2025 张三 | 手工码的个人主页<span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">只需要改 4 处就完全是你自己的网页了！</h3>
<ol>
<li>头像：把 <code>src="https://..."</code> 换成你自己的照片链接（推荐放同目录下改成 <code>src="avatar.jpg"</code>）</li>
<li>名字：改 <code>&lt;h1&gt;张三&lt;/h1&gt;</code></li>
<li>一句话介绍：改 <code>.tagline</code> 那行</li>
<li>自我介绍 + 社交链接：按需增删即可</li>
</ol>
<h3 data-id="heading-3">想更炫酷？再加这几行（任选）</h3>
<ul>
<li>背景粒子特效（加在 <code>&lt;body&gt;</code> 前面）：</li>
</ul>
<pre><code class="hljs language-xml" lang="xml">  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"particles-js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-title function_">particlesJS</span>(<span class="hljs-string">"particles-js"</span>, {<span class="hljs-string">"particles"</span>:{<span class="hljs-string">"number"</span>:{<span class="hljs-string">"value"</span>:<span class="hljs-number">80</span>},<span class="hljs-string">"color"</span>:{<span class="hljs-string">"value"</span>:<span class="hljs-string">"#ff6b6b"</span>},<span class="hljs-string">"shape"</span>:{<span class="hljs-string">"type"</span>:<span class="hljs-string">"circle"</span>},<span class="hljs-string">"opacity"</span>:{<span class="hljs-string">"value"</span>:<span class="hljs-number">0.5</span>},<span class="hljs-string">"size"</span>:{<span class="hljs-string">"value"</span>:<span class="hljs-number">3</span>},<span class="hljs-string">"move"</span>:{<span class="hljs-string">"speed"</span>:<span class="hljs-number">1</span>}}});
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"><span class="hljs-selector-id">#particles-js</span>{<span class="hljs-attribute">position</span>:fixed;<span class="hljs-attribute">top</span>:<span class="hljs-number">0</span>;<span class="hljs-attribute">left</span>:<span class="hljs-number">0</span>;<span class="hljs-attribute">width</span>:<span class="hljs-number">100%</span>;<span class="hljs-attribute">height</span>:<span class="hljs-number">100%</span>;<span class="hljs-attribute">z-index</span>:-<span class="hljs-number">1</span>;}</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<ul>
<li>音乐自动播放（七夕专用）：</li>
</ul>
<pre><code class="hljs language-css" lang="css">  &lt;<span class="hljs-selector-tag">audio</span> <span class="hljs-attribute">src</span>="your-music<span class="hljs-selector-class">.mp3</span>" autoplay loop hidden&gt;&lt;/<span class="hljs-selector-tag">audio</span>&gt;
</code></pre>
<p>5 分钟搞定一个高颜值个人主页，赶紧发给朋友/对象/面试官吧～<br/>
需要再加「作品集」「时间轴」「留言板」等功能，随时告诉我，我继续给你升级！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# 🌟 JavaScript原型与原型链终极指南：从Function到Object的完整闭环解析 ，深入理解JavaScript原型系统核心]]></title>    <link>https://juejin.cn/post/7582763878674448411</link>    <guid>https://juejin.cn/post/7582763878674448411</guid>    <pubDate>2025-12-12T08:55:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582763878674448411" data-draft-id="7581828086019932175" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# 🌟 JavaScript原型与原型链终极指南：从Function到Object的完整闭环解析  ，深入理解JavaScript原型系统核心"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-12T08:55:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AY1024"/> <meta itemprop="url" content="https://juejin.cn/user/2232439936132313"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # 🌟 JavaScript原型与原型链终极指南：从Function到Object的完整闭环解析  ，深入理解JavaScript原型系统核心
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2232439936132313/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AY1024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:55:31.000Z" title="Fri Dec 12 2025 08:55:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><h2 data-id="heading-0"><strong>深入理解JavaScript原型系统核心</strong></h2>
<h3 data-id="heading-1">📖 目录</h3>
<ul>
<li><a href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5" title="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">核心概念</a></li>
<li><a href="#%E6%98%BE%E5%BC%8F%E5%8E%9F%E5%9E%8B%E4%B8%8E%E9%9A%90%E5%BC%8F%E5%8E%9F%E5%9E%8B" title="#%E6%98%BE%E5%BC%8F%E5%8E%9F%E5%9E%8B%E4%B8%8E%E9%9A%90%E5%BC%8F%E5%8E%9F%E5%9E%8B">显式原型与隐式原型</a></li>
<li><a href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E7%9A%84%E6%8C%87%E5%90%91" title="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E7%9A%84%E6%8C%87%E5%90%91">构造函数的指向</a></li>
<li><a href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E5%85%B3%E7%B3%BB%E5%9B%BE" title="#%E5%8F%AF%E8%A7%86%E5%8C%96%E5%85%B3%E7%B3%BB%E5%9B%BE">可视化关系图</a></li>
<li><a href="#%E4%BB%A3%E7%A0%81%E9%AA%8C%E8%AF%81" title="#%E4%BB%A3%E7%A0%81%E9%AA%8C%E8%AF%81">代码验证</a></li>
<li><a href="#%E7%89%B9%E5%88%AB%E8%AF%B4%E6%98%8E" title="#%E7%89%B9%E5%88%AB%E8%AF%B4%E6%98%8E">特别说明</a></li>
</ul>
<hr/>
<h3 data-id="heading-2">🎯 核心概念</h3>
<h4 data-id="heading-3">四大基本原则</h4>
<ol>
<li>
<p><strong>原则一：每个对象都有构造函数（constructor）</strong></p>
<ul>
<li>指向构建该对象或实例的函数</li>
</ul>
</li>
<li>
<p><strong>原则二：只有函数对象才有prototype属性</strong></p>
<ul>
<li>非函数对象没有prototype属性</li>
<li>实例只有<code>__proto__</code>属性</li>
<li>两者指向同一个对象（函数的原型对象）</li>
</ul>
</li>
<li>
<p><strong>原则三：Function函数是所有函数的构造函数</strong></p>
<ul>
<li>包括它自己</li>
<li>代码中声明的所有函数都是Function的实例</li>
</ul>
</li>
<li>
<p><strong>原则四：Object也是函数</strong></p>
<ul>
<li>所以Object也是Function函数的实例</li>
</ul>
</li>
</ol>
<h3 data-id="heading-4">实例，函数，对象，原型对象，构造函数，关系总览图</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c44a9f53d4049e196b167e4449e2da2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=H1O2jR3fUmx7IK2xXJCNP0XPiro%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">🔍 非函数对象分类</h4>
<ul>
<li>实例对象，<code>const person = new Foo()</code>,<strong>person</strong>就是实例对象</li>
<li>普通对象（<code>{}</code> 或 <code>new Object()</code>）</li>
<li>内置非函数对象实例</li>
</ul>
<hr/>
<h3 data-id="heading-6">🔄 显式原型与隐式原型</h3>
<h4 data-id="heading-7">对象分类</h4>
<ul>
<li><strong>函数对象</strong>：拥有<code>prototype</code>属性</li>
<li><strong>非函数对象</strong>：只有<code>__proto__</code>属性</li>
</ul>
<h4 data-id="heading-8">相同点</h4>
<ul>
<li>都指向同一个原型对象</li>
</ul>
<h4 data-id="heading-9">📝 示例代码</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>){}
<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Person.prototype指向:"</span>, <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"person.__proto__指向"</span>, person.<span class="hljs-property">__proto__</span>)
</code></pre>
<h4 data-id="heading-10">🖼️ 执行结果</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75efb24e532949a6bcb546dfbea5def0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=u3Krc1lI6HuPgwV49gh%2FlLzwOE0%3D" alt="显式原型" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d94345698af74b2286cc67e713e3dcdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=OjZxIA6%2BtOwDD4e2lsEIff8FKJw%3D" alt="隐式原型" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-11">🎯 构造函数的指向</h3>
<h4 data-id="heading-12">默认情况</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>){}
<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Person.prototype.constructor指向"</span>, <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span>)
<span class="hljs-comment">// 输出：[Function: Person]</span>
</code></pre>
<h4 data-id="heading-13">执行结果</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ad1a034f38248f5b1178c09ff599799~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=l%2BCyV9g3Z4Dnu8t52LS7vcL44RQ%3D" alt="默认构造函数指向" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eaa17783b7954f6ebaa997acc9cb82d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=XIyqvF8bK92JcL19rBHExvmYIKk%3D" alt="默认构造函数指向详情" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-14">修改原型对象后</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>){}
<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_">foo</span>();  <span class="hljs-comment">// 修改原型对象</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Person.prototype.constructor指向"</span>, <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span>)
<span class="hljs-comment">// 输出：[Function: foo]</span>
</code></pre>
<h4 data-id="heading-15">执行结果</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1945c4ccb5224c8e92b481725289b54c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=EW7wn2UXR%2FEUf7UGyWCxXEcihng%3D" alt="修改后构造函数指向" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/276f3f0c840a454f9b1f050477a5a38a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=yL1%2B%2FQcikuMGuZd8KlACBJmvBMQ%3D" alt="修改后构造函数指向详情" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-16">📊 核心原理说明</h3>
<h4 data-id="heading-17">解释</h4>
<p><code>Person.prototype</code>被当作函数foo的实例，继承了foo函数（此篇不展开继承详解）</p>
<h4 data-id="heading-18">总结规律</h4>
<ul>
<li>每个原型对象或实例都有<code>.constructor</code>属性</li>
<li>实例通过原型链查找constructor</li>
<li>原型对象默认指向自身的函数（如果不是其他函数的实例）</li>
</ul>
<h4 data-id="heading-19">查找过程示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Person.prototype被当作实例时</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> → foo.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> → <span class="hljs-title function_">foo</span>()
</code></pre>
<hr/>
<h3 data-id="heading-20">🖼️ 可视化关系图</h3>
<h4 data-id="heading-21">三者关系图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0da7158ab94b47ceae930e03320e299d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=kYputO3NXnapYQgPE3dKCobRNOg%3D" alt="原型关系图" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-22">🔬 代码验证</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>){}

<span class="hljs-comment">// 创建新的原型对象</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"杨"</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-string">"18"</span>,
    <span class="hljs-attr">histype</span>: <span class="hljs-string">"sleep"</span>
}

<span class="hljs-comment">// 添加方法</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">print</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"你好我是原型对象"</span>);
}

<span class="hljs-comment">// 创建实例</span>
<span class="hljs-keyword">const</span> person01 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();
<span class="hljs-keyword">const</span> person02 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-comment">// 验证指向</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Person.prototype指向:"</span>, <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"person01.__proto__指向"</span>, person01.<span class="hljs-property">__proto__</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"person02.__proto__指向"</span>, person02.<span class="hljs-property">__proto__</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Person.prototype.constructor指向"</span>, <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span>)
</code></pre>
<h4 data-id="heading-23">执行结果</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fb5d21f26944fe2bdd35d2319d03cbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=iYpl9%2Bpiquppx321Lmdju1TVqEQ%3D" alt="代码验证结果" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-24">⚠️ 特别说明</h3>
<h4 data-id="heading-25">关键细节</h4>
<p>创建新对象时，<code>Person.prototype.constructor</code>指向<code>Object</code>，因为<code>Person.prototype</code>成了<code>Object</code>的实例。</p>
<h4 data-id="heading-26">对比情况</h4>
<ul>
<li><strong>创建新对象时</strong>：<code>Person.prototype.constructor</code> → <code>Object</code></li>
<li><strong>未创建新对象时</strong>：<code>Person.prototype.constructor</code> → <code>Person</code></li>
</ul>
<h4 data-id="heading-27">示意图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c9ba507074041c288d945ed873309d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=vMMtCPQAXQ7sXQQ2yluuta1lG4s%3D" alt="构造函数指向对比" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4365ef09062e4b80af90692c3c838d22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=Ri3KDzQBVDTXFudXhrgg8r69T0E%3D" alt="构造函数指向对比详情" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-28">Function和Object</h2>
<h2 data-id="heading-29">小故事</h2>
<p>从前有个力大无穷的大力神，能举起任何东西，有一天，小A在路上和这个大力神相遇了。</p>
<p>大力神：小子，我可是力大无穷的大力神，我能举起任何东西，你信不信？</p>
<p>小A:呦呦呦，还大力神，你说你能举起任何东西，那你能把你自己抬起来吗？</p>
<p>...</p>
<ul>
<li>
<p>Function是所有函数的加工厂，你在代码声明的所有函数都是Function的实例，包括Function函数本身，Object也是函数，所以它也是Functiod的实例</p>
</li>
<li>
<p>Function就是这样的大力神，而且是可以把自己抬起来的大力神，这听起来比较扯，但是这就是事实，请看VCR：</p>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span> (){}

<span class="hljs-keyword">const</span> person01 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Function.__proto__指向"</span>,<span class="hljs-title class_">Function</span>.<span class="hljs-property">__proto__</span>)<span class="hljs-comment">//Function.__proto__指向 [Function (anonymous)] Object</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Function.prototype指向"</span>,<span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)<span class="hljs-comment">//Function.prototype指向 [Function (anonymous)] Object</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Function.__proto__ == Function.prototype???"</span>,<span class="hljs-title class_">Function</span>.<span class="hljs-property">__proto__</span> == <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)
<span class="hljs-comment">//Function.__proto__ == Function.prototype??? true</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f959ab9fe3a4b15a6bff89bea078b60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=s5lVNg0t3PqA7ArU8DMKUX%2FX2c8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d522369f0bce4dcd98dd6226be71d772~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=6F9t2jUSNGy%2FEyCexsejvd78zJU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-30">Object 在 JavaScript 中扮演三重角色：</h2>
<ul>
<li>
<p>构造函数：用于创建对象</p>
</li>
<li>
<p>命名空间：提供一系列静态方法用于对象操作</p>
</li>
<li>
<p>原型终点：Object.prototype 是所有原型链的终点，在往上没有了，值==null</p>
</li>
</ul>
<p>请看VCR:</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span> (){};

<span class="hljs-keyword">const</span> persoon01 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();
<span class="hljs-keyword">const</span> obj = {};<span class="hljs-comment">//通过对象字面量{}创建obj实例</span>
<span class="hljs-keyword">const</span> obj1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<span class="hljs-comment">//通过构造函数new Object()创建obj1实例</span>
<span class="hljs-keyword">const</span> obj2 = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);<span class="hljs-comment">//通过委托创建，或者叫原型创建，来创建obj2实例</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Person.prototype.__proto__指向"</span>,<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span>);
<span class="hljs-comment">//Person.prototype.__proto__指向 [Object: null prototype] {}</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Function.prototype.__proto__指向"</span>,<span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span>)
<span class="hljs-comment">//Function.prototype.__proto__指向 [Object: null prototype] {}</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"通过对象字面量{}创建的obj实例,obj.__proto__指向"</span>,obj.<span class="hljs-property">__proto__</span>);
<span class="hljs-comment">//通过对象字面量{}创建的obj实例,obj.__proto__指向 [Object: null prototype] {}</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"通过构造函数new Object()创建obj1实例,指向"</span>,obj1.<span class="hljs-property">__proto__</span>);
<span class="hljs-comment">//通过构造函数new Object()创建obj1实例,指向 [Object: null prototype] {}</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"通过委托创建,或者叫原型创建,来创建obj2实例,指向"</span>,obj2.<span class="hljs-property">__proto__</span>);
<span class="hljs-comment">//通过委托创建,或者叫原型创建,来创建obj2实例,指向 [Object: null prototype] {}</span>
</code></pre>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a57a0c9c8c19400b818089efed2e8067~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=%2Bk%2FtNQnXONsfCk2tuBC14MzpvjU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/082ce993339a42bbb14d4a585e515e31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQVkxMDI0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135618&amp;x-signature=j7P%2BWVGh%2F3gHwmUptx92mcXLhvg%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-31">Function和Object的关系</h2>
<ul>
<li>相互依赖的循环引用
<ul>
<li>
<p>Object 是 Function 的实例（构造函数层面）</p>
</li>
<li>
<p>Function 是 Object 的子类（原型继承层面）</p>
</li>
<li>
<p>这是 JavaScript 的自举（Bootstrap）机制</p>
</li>
</ul>
</li>
</ul>
<p>根据<strong>关系总览图</strong>，我们可以看到，Function和Object,它们两形成了一个闭环，将所有的函数和对象都包裹在这个闭环里</p>
<h2 data-id="heading-32">📋 JavaScript 原型系统核心概念表</h2>















































<table><thead><tr><th>概念</th><th>描述</th><th>示例</th><th>特殊说明</th></tr></thead><tbody><tr><td><strong>prototype</strong></td><td>函数特有，指向原型对象</td><td><code>Person.prototype</code></td><td>只有函数对象才有此属性</td></tr><tr><td><strong><strong>proto</strong></strong></td><td>所有对象都有，指向构造函数的原型</td><td><code>person.__proto__</code></td><td>实际应使用 <code>Object.getPrototypeOf()</code></td></tr><tr><td><strong>constructor</strong></td><td>指向创建该对象的构造函数</td><td><code>Person.prototype.constructor</code></td><td>可被修改，查找时沿原型链进行</td></tr><tr><td><strong>原型链查找</strong></td><td>通过 <code>__proto__</code> 逐级向上查找</td><td><code>person.__proto__.__proto__</code></td><td>终点为 <code>null</code></td></tr><tr><td><strong>Function</strong></td><td>所有函数的构造函数</td><td><code>Function.prototype</code></td><td><code>Function.__proto__ === Function.prototype</code></td></tr><tr><td><strong>Object</strong></td><td>所有对象的基类</td><td><code>Object.prototype</code></td><td>原型链终点，<code>Object.prototype.__proto__ === null</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-33">🔍 补充说明</h3>
<h4 data-id="heading-34"><strong>prototype 补充</strong></h4>
<ul>
<li>函数的 <code>prototype</code> 属性默认包含 <code>constructor</code> 属性指向函数自身</li>
<li>用于实现基于原型的继承</li>
</ul>
<h4 data-id="heading-35"><strong><strong>proto</strong> 补充</strong></h4>
<ul>
<li>现在更推荐使用 <code>Object.getPrototypeOf(obj)</code> 和 <code>Object.setPrototypeOf(obj, proto)</code></li>
<li><code>__proto__</code> 是访问器属性，不是数据属性</li>
</ul>
<h4 data-id="heading-36"><strong>constructor 补充</strong></h4>
<ul>
<li><code>constructor</code> 属性可以通过原型链查找</li>
<li>示例：<code>person.constructor === Person</code>（实际查找的是 <code>person.__proto__.constructor</code>）</li>
</ul>
<h4 data-id="heading-37"><strong>原型链查找补充</strong></h4>
<ul>
<li>当访问对象属性时，如果对象自身没有，会沿着原型链向上查找</li>
<li>直到找到该属性或到达原型链终点 <code>null</code></li>
</ul>
<h4 data-id="heading-38"><strong>Function 补充</strong></h4>
<ul>
<li>是所有函数的构造函数，包括内置构造函数（Object、Array等）和自定义函数</li>
<li>自身也是函数，所以 <code>Function.__proto__ === Function.prototype</code></li>
</ul>
<h4 data-id="heading-39"><strong>Object 补充</strong></h4>
<ul>
<li><code>Object.prototype</code> 是所有原型链的最终原型对象</li>
<li>通过 <code>Object.create(null)</code> 可以创建没有原型的"纯净对象"</li>
</ul>
<h4 data-id="heading-40">💡 记忆口诀</h4>
<ul>
<li><strong>函数看prototype，实例看__proto__</strong></li>
<li><strong>constructor找根源，原型链上寻答案</strong></li>
<li><strong>Object是终点，Function是关键</strong></li>
</ul>
<h2 data-id="heading-41">结语：</h2>
<p>看完这篇文章，你应该可以读懂上面的关系总览图了，望学习愉快！！！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTML标签 - 表格标签]]></title>    <link>https://juejin.cn/post/7582786655472779307</link>    <guid>https://juejin.cn/post/7582786655472779307</guid>    <pubDate>2025-12-12T08:46:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582786655472779307" data-draft-id="7582516300050235419" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTML标签 - 表格标签"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-12T08:46:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GinoWi"/> <meta itemprop="url" content="https://juejin.cn/user/687651121011707"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTML标签 - 表格标签
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/687651121011707/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GinoWi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:46:36.000Z" title="Fri Dec 12 2025 08:46:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><h2 data-id="heading-0">HTML标签 - 表格标签</h2>
<p>在过去网站开发过程中，表格标签的使用是非常非常多，绝大多数的网站都是使用表格标签来制作的，也就是说表格标签是一个时代的代表。</p>
<h4 data-id="heading-1">什么是表格标签？</h4>
<p>表格标签的作用是用来给一堆数据<strong>添加表格语义</strong>，其实表格是一种数据的展现形式，当数据量非常大的时候，表格这种展现形式被认为是最为清晰的一种展现形式。</p>
<h4 data-id="heading-2">表格结构</h4>
<p>由于表格中存储的数据比较复杂，为了方便管理、阅读以及提升语义，我们可以对表格中存储的数据进行分类。</p>
<ul>
<li>
<p>表格中存储的数据可以分为四类：</p>
<ol>
<li>表格标题</li>
<li>表格表头</li>
<li>表格主体</li>
<li>表格的页尾信息</li>
</ol>
</li>
<li>
<p>表格完整结构</p>
</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">caption</span>&gt;</span>表格的标题<span class="hljs-tag">&lt;/<span class="hljs-name">caption</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>每一列的标题<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>数据<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">tfoot</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>数据<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">tfoot</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
</code></pre>
<h4 data-id="heading-3">表格标签</h4>
<ul>
<li>
<p><code>table</code>标签</p>
<ul>
<li>作用：表格标签中的<code>table</code>代表整个表格，也就是一对<code>table</code>标签就是一个表格。</li>
</ul>
</li>
<li>
<p><code>tr</code>标签</p>
<ul>
<li>作用：表格标签的<code>tr</code>代表表格中的一行数据，也就是说一对<code>tr</code>标签就是表格中的一行。</li>
</ul>
</li>
<li>
<p><code>td</code>标签</p>
<ul>
<li>作用：表格标签中的<code>td</code>标签代表表格中的一个单元格，也就是说一对<code>td</code>标签就是表格中的一个单元格。</li>
</ul>
</li>
<li>
<p><code>caption</code>标签</p>
<ul>
<li>作用：在表格标签中提供了一个标签专门用来设置表格的标题，这个标签叫做<code>caption</code>。只要将标题写在<code>caption</code>标签中，那么标题就会自动相对于表格的宽度居中。</li>
<li>注意点：
<ul>
<li><code>caption</code>标签一定要写在<code>table</code>标签中，否则无效。</li>
<li><code>caption</code>一定要紧跟在<code>table</code>标签后面。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>th</code>标签</p>
<ul>
<li>作用：在表格标签中提供了一个标签专门用来展示每一列的标题，这个标签叫做<code>th</code>标签，只要使用<code>th</code>标签展现当前列的标题，这时标题就会在该标签单元格中自动居中。</li>
</ul>
</li>
<li>
<p><code>thead</code>标签</p>
<ul>
<li>作用：指定表格表头信息。</li>
</ul>
</li>
<li>
<p><code>tbody</code>标签</p>
<ul>
<li>作用：指定表格主体信息。</li>
<li>注意点：如果我们没有编写<code>tbody</code>，系统会自动给我门添加<code>tbody</code></li>
</ul>
</li>
<li>
<p><code>tfoot</code>标签</p>
<ul>
<li>作用：指定表格附加信息。</li>
<li>注意点：如果指定了<code>thead</code>和<code>tfoot</code>，那么在修改整个表格的高度时，<code>thead</code>和<code>tfoot</code>有自己的默认高度，不会随着表格的高度变化而变化。</li>
</ul>
</li>
</ul>
<p>总结：</p>
<ul>
<li>
<p>表格标签有一个边框属性，这个属性决定了边框的宽度，默认情况下这个属性的值是0，所以看不到边框。</p>
</li>
<li>
<p>表格标签和列表标签一样，它是一个组合标签，所以<code>table/tr/td</code>要么一起出现，要么一起不出现，不会单独出现。</p>
</li>
<li>
<p>表格中有两种单元格，一种是<code>td</code>，一种是<code>th</code>，<code>td</code>是专门用来存储数据的，<code>th</code>是专门用来存储当前列的标题的。</p>
</li>
</ul>
<h4 data-id="heading-4">表格标签的属性（这部分内容仅为了解，以后均通过CSS来进行修改）：</h4>
<ul>
<li>
<p>宽度和高度的属性（可以给<code>table</code>标签和<code>td</code>标签使用）</p>
<ul>
<li>表格的宽度和高度默认按照内容尺寸调整，也可以通过给<code>table</code>标签设置<code>width/height</code>属性的方式来手动指定表格宽高。</li>
<li>如果给<code>td</code>标签设置<code>width/height</code>属性，会修改当前单元格的宽度（会同时影响当前列单元格宽度）和高度（会同时影响当前行单元格高度），不会影响整个表格的宽度和高度。
<ul>
<li>当给一行中不同单元格设置不同的<code>height</code>属性，保留一行中高度最高的属性值作为该行单元格的高度。</li>
<li>当给一列中不同单元格设置不同的<code>width</code>属性，保留一行中宽度最宽的属性值作为该列单元格的宽度。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>水平对齐和垂直对齐的属性（其中水平对齐可以给<code>table</code>标签和<code>tr</code>标签和<code>td</code>标签使用，垂直对齐只能给<code>tr</code>标签和<code>td</code>标签使用）</p>
<ul>
<li>给<code>table</code>标签设置<code>align</code>属性，可以控制表格在水平方向的对齐方式。</li>
<li>给<code>tr</code>标签设置<code>align</code>属性，可以控制当前行中所有单元格内容的水平方向对齐方式。</li>
<li>给<code>td</code>标签设置<code>align</code>属性，可以控制当前单元格中内容在水平方向的对齐方式（如果<code>td</code>标签中设置了<code>align</code>属性，<code>tr</code>中也设置了<code>align</code>属性，那么单元格中的内容会按照<code>td</code>中设置的来对齐）。</li>
<li>给<code>tr</code>标签设置<code>valign</code>属性，可以控制当前行中所有单元格内容的垂直方向对齐方式。</li>
<li>给<code>td</code>标签设置<code>valign</code>属性，可以控制当前单元格中内容在垂直方向对齐方式。（如果<code>td</code>标签中设置了<code>valign</code>属性，<code>tr</code>中也设置了<code>valign</code>属性，那么单元格中的内容会按照<code>td</code>中设置的来对齐。</li>
</ul>
</li>
<li>
<p>外边距和内边距的属性（只能给<code>table</code>标签使用）</p>
<ul>
<li>外边距（cellspacing）就是单元格和单元格之间的距离（默认情况下单元格与单元格的外边距是2px）</li>
<li>内边距（cellpadding）就是文字距离单元格之间的距离（默认情况下内边距是1px）</li>
</ul>
</li>
<li>
<p>通过属性设置完成细线表格的绘制：</p>
<ul>
<li>
<p>在表格标签中想通过指定外边距为0来实现细线表格是不靠谱的，其实它是将2条合并为了一条线，所以看上去很不舒服。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eee691f1461c41efbca084b48b46365a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2lub1dp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134384&amp;x-signature=HFYD59BvxoRfHXhIo7Z8t%2F%2BpMDU%3D" alt="通过设置外边距实现的表格" loading="lazy"/></p>
</li>
<li>
<p>细线表格的制作方式：（<code>table</code>标签、<code>tr</code>标签以及<code>td</code>标签都支持<code>bgcolor</code>属性，但是样式以后通过css完成控制。）</p>
<ol>
<li>给<code>table</code>标签设置<code>bgcolor</code>属性</li>
<li>给<code>tr</code>标签设置<code>bgcolor</code>属性</li>
<li>给<code>table</code>标签设置<code>cellspacing="1px"</code></li>
</ol>
</li>
<li>
<p>代码：</p>
</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">bgcolor</span>=<span class="hljs-string">"black"</span> <span class="hljs-attr">cellspacing</span>=<span class="hljs-string">"1px"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"500px"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"300px"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">bgcolor</span>=<span class="hljs-string">"white"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">bgcolor</span>=<span class="hljs-string">"white"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">bgcolor</span>=<span class="hljs-string">"white"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
</code></pre>
<ul>
<li>
<p>效果展示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b3c4a13da9f485a9397019c040decd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2lub1dp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134384&amp;x-signature=XMHdVs2w3CJ%2BaPaWWcRmUB0qsao%3D" alt="通过设置背景颜色实现的表格" loading="lazy"/></p>
<p>通过放大比较上述两张表格图片，就能够很明显的看出表格边框的差别。</p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">单元格合并</h4>
<ul>
<li>
<p>水平方向上的单元格合并</p>
<ul>
<li>可以给<code>td</code>标签添加<code>colspan</code>属性，把某一个单元格当作多个单元格来看待（水平）。</li>
<li>格式：<code>&lt;td colspan="2"&gt;&lt;/td&gt;</code>含义：把当前单元格当作两个单元格来看待。</li>
<li>注意点：
<ul>
<li>由于把某一个单元格当作多个单元格来看待，所以就会多出一些单元格，需要删掉一些单元格确保表格正常显示。</li>
<li>单元格合并永远都是向后或者向下合并，而不能向前或者向上合并。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>垂直方向上的单元格合并</p>
<ul>
<li>可以给<code>td</code>标签添加<code>rowspan</code>属性，把某一个单元格当作多个单元格来看待（垂直）。</li>
<li>格式：<code>&lt;td rowspan="2"&gt;&lt;/td&gt;</code>含义：把当前单元格当作两个单元格来看待。</li>
<li>注意点：
<ul>
<li>由于把某一个单元格当作多个单元格来看待，所以就会多出一些单元格，需要删掉一些单元格确保表格正常显示。</li>
<li>单元格合并永远都是向后或者向下合并，而不能向前或者向上合并。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>参考链接：</strong></p>
<p>W3School官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3school.com.cn%2F" target="_blank" title="https://www.w3school.com.cn/" ref="nofollow noopener noreferrer">www.w3school.com.cn</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[BlackstoneOne 实现业务十倍增长]]></title>    <link>https://juejin.cn/post/7582539701147271209</link>    <guid>https://juejin.cn/post/7582539701147271209</guid>    <pubDate>2025-12-12T07:36:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582539701147271209" data-draft-id="7582535649276428329" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="BlackstoneOne 实现业务十倍增长"/> <meta itemprop="keywords" content="人工智能,云计算"/> <meta itemprop="datePublished" content="2025-12-12T07:36:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AKAMAI"/> <meta itemprop="url" content="https://juejin.cn/user/829502942352628"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            BlackstoneOne 实现业务十倍增长
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/829502942352628/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AKAMAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:36:30.000Z" title="Fri Dec 12 2025 07:36:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>"在我们发展的每个阶段，Akamai始终相伴。从可预测的定价到区域技术支持，再到便捷的使用体验，它已成为我们让中小企业也能享受高效IT安全服务这一征程中不可或缺的伙伴。"</p>
<p>——BlackstoneOne 合伙人兼高级开发工程师 Jacob Honoré</p>
</blockquote>
<h4 data-id="heading-0"><strong><strong>为中小企业简化IT安全防护</strong></strong></h4>
<p>BlackstoneOne致力于革新中小企业的IT安全防护，提供先进的漏洞管理与攻击面管理解决方案。2019年，合伙人兼高级开发工程师Jacob Honoré离开德勤，加入BlackstoneOne并肩负起管理公司技术基础设施的重任——这套基础设施当时已部署在Akamai<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-a-cloud-platform%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_251212_external1_blogarticles235" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-a-cloud-platform?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_251212_external1_blogarticles235" ref="nofollow noopener noreferrer">云计算平台</a>服务（前身为Linode）之上。他的核心任务就是扩展公司解决方案，以满足快速增长的客户群体需求。</p>
<p>在短短五年内，BlackstoneOne不仅客户数量增长十倍，还成功开拓了新市场，推出了AI驱动洞察等高级功能以及攻击面管理等重点方案。所有这些成就，都依托于Akamai平台实现。</p>
<p>当Akamai收购Linode时，BlackstoneOne曾有过疑虑。但无缝的过渡和新功能的快速推出很快打消了他们的顾虑。"收购后服务和支持反而更上一层楼，"Honoré表示，"虚拟私有云和托管数据库等功能对我们具有革命性意义。"</p>
<h4 data-id="heading-1"><strong><strong>应对安全业务规模化挑战</strong></strong></h4>
<p>自2015年成立以来，BlackstoneOne从服务丹麦30家客户，已扩展至丹麦、挪威、瑞典、德国和格陵兰的350多家客户。公司的愿景是：简化漏洞管理，降低风险，让企业用上既强大又易用的安全工具。</p>
<p>扩展IT解决方案绝非易事，但Akamai让它变得可控。"Akamai云计算让扩展变得简单。我们实现了巨大增长，而Akamai始终相伴，提供所需的功能和可靠性，且没有带来不必要的复杂性，"Honoré解释道。</p>
<p>据Honoré介绍，Akamai让他的精干开发团队能够灵活配置服务器，避免了其他云平台的臃肿管理和复杂流程。"通过直接访问虚拟机，Akamai让配置变得简单。其云计算服务非常适合我们这种规模的企业，在强大功能和简洁易用之间取得了完美平衡。"</p>
<p>对成长型企业而言，意外账单可能是致命的。Akamai的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linode.com%2Fzh%2Fpricing%2F%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_251212_external2_blogarticles235" target="_blank" title="https://www.linode.com/zh/pricing/?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_251212_external2_blogarticles235" ref="nofollow noopener noreferrer">可预测定价模式</a>为BlackstoneOne提供了关键支持。"我曾用过那些意外成本几乎拖垮企业的平台。而Akamai让我始终清楚费用明细，这对我们规模扩张中的预算管理至关重要，"Honoré补充道。</p>
<h4 data-id="heading-2"><strong><strong>选择Akamai作为云平台</strong></strong></h4>
<p>BlackstoneOne业务主要分布在斯堪的纳维亚地区，Akamai位于瑞典等地的区域云计算数据中心使其受益匪浅。值得注意的是，公司在向挪威和瑞典扩张的同时，始终保持着高性能和高可靠性。"靠近客户的数据中心确保了低延迟，这对高效的漏洞扫描至关重要。这对我们和客户都是巨大优势，"Honoré表示。</p>
<p>事实上，正是Akamai支撑着BlackstoneOne的服务实现。其服务需要扫描大量敏感流量（部分可能被标记）。与其他阻止漏洞扫描流量的云提供商不同，Akamai无缝满足了BlackstoneOne的需求。"Akamai确保我们的扫描操作平稳运行，无需面对不必要的干扰——这是我们在其他平台上曾遇到的挑战，"Honoré指出。</p>
<p>BlackstoneOne引领创新，持续提供尖端解决方案——Honoré带领团队依托Akamai实现公司愿景，专注于以客户为中心的创新。BlackstoneOne近期将AI集成至平台，帮助中小企业更好地理解并处理漏洞，同时轻松应对IT安全的复杂性。</p>
<p>公司最新推出的外部攻击面管理服务，依托虚拟私有云（VPC）实现增强安全。Honoré表示："创建新虚拟机非常简单。此外，VPC让我们能将服务器置于后台，为敏感客户数据增添额外保护层。"</p>
<h4 data-id="heading-3"><strong><strong>展望未来</strong></strong></h4>
<p>随着业务持续扩展，BlackstoneOne专注于在应对欧洲合规性与数据保护挑战的同时，持续提供有价值的IT安全解决方案。凭借Akamai不断丰富的工具集和对中小企业的支持承诺，BlackstoneOne已为未来增长做好充分准备。</p>
<p>当被问及对其他开发者的建议时，Honoré总结道："Akamai在功能与易用性间的平衡无与伦比，透明定价让我们能无忧扩展，而及时有效的技术支持更使其在众多提供商中脱颖而出。"</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[瀚高硬核助力 PG 社区：Postgres 19 迎来并行 TID 范围扫描，速度提升 3 倍]]></title>    <link>https://juejin.cn/post/7582539701147746345</link>    <guid>https://juejin.cn/post/7582539701147746345</guid>    <pubDate>2025-12-12T08:30:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582539701147746345" data-draft-id="7582535649276854313" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="瀚高硬核助力 PG 社区：Postgres 19 迎来并行 TID 范围扫描，速度提升 3 倍"/> <meta itemprop="keywords" content="PostgreSQL,开源,数据库"/> <meta itemprop="datePublished" content="2025-12-12T08:30:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IvorySQL"/> <meta itemprop="url" content="https://juejin.cn/user/761327331579511"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            瀚高硬核助力 PG 社区：Postgres 19 迎来并行 TID 范围扫描，速度提升 3 倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/761327331579511/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IvorySQL
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:30:57.000Z" title="Fri Dec 12 2025 08:30:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>对于任何需要维护超大表（更新旧数据、分批删除、数据迁移）的 DBA 或开发者来说，使用 <code>ctid</code>（元组物理位置）将大表切分为多个小块进行处理是标准操作。然而，直到现在，这种操作都有一个巨大的痛点：<strong>它严格依赖单进程</strong>。</p>
<p>随着最近的一个 Commit (<code>0ca3b169</code>) 合并入 PostgreSQL 19 (master 分支)，<strong>TID 范围扫描（TID Range Scans）终于支持并行了</strong>。</p>
<blockquote>
<p>该功能由瀚高的 Cary Huang 提出并主导开发，由微软的 David Rowley 协助测试及审阅，并最终提交。他们密切合作以完善并行安全逻辑，确保工作进程正确处理扫描限制——最终促成了这个落地到 master 分支的健壮实现。</p>
</blockquote>
<blockquote>
<p>瀚高以“用开源链接世界”为使命，强调开源技术在数据库基础软件领域的核心作用，致力于通过共享和合作，推动行业发展，同时链接和赋能全球用户。开源技术是中国软件技术发展的必由之路，瀚高作为亚太地区 PostgreSQL 国际社区顶级贡献者之一，长期深度参与 PostgreSQL 国际社区发展与建设。自 2025 年 7 月以来，瀚高被 PostgreSQL 社区采纳的贡献就已超过 2000 行代码。</p>
</blockquote>
<p>根据基准测试，新特性的速度提升高达 <strong>3 倍</strong>。</p>
<h2 data-id="heading-0">1. 核心痛点：规划器（Planner）的权衡</h2>
<p>Postgres 自版本 14 起就支持了 <code>TID Range Scans</code>。这允许你基于物理块号扫描表的特定切片：</p>
<p><code>SELECT * FROM my_large_table WHERE ctid &gt;= '(0,0)' AND ctid &lt; '(10000,0)';</code></p>
<p>这是像 AWS DMS 这样的工具或逻辑复制初始化器拆分海量表的标准方式。问题在于，直到现在这种扫描节点严格来说都是<strong>单工作进程（single worker）</strong> 的。</p>
<p>这迫使 Postgres 查询规划器陷入了两难境地。当你在大数据集上运行查询时，规划器必须在以下两者之间做出选择：</p>
<ul>
<li>
<p>TID Range Scan： I/O 高效（只读取你请求的块），但是单工作进程。</p>
</li>
<li>
<p>Parallel Seq Scan（并行顺序扫描）： CPU 高效（占用所有 CPU 内核），但 I/O 浪费（可能会为了过滤而读取超出你范围的块）。</p>
</li>
</ul>
<p>规划器经常会错误地选择并行顺序扫描，CPU 收益似乎超过了 I/O 损耗带来的负面影响。这导致数据库为了利用可用的工作进程，读取了比必要多得多的数据。</p>
<h2 data-id="heading-1">2. 修复方案：并行性与可变分块</h2>
<p>由 Cary Huang 开发并由 David Rowley 提交的代码，引入了允许 <code>Tid Range Scan</code> 参与并行查询计划的基础架构。该逻辑有效地将块范围分配给可用的并行工作进程。不再是一个进程从块 0 扫描到 N，多个工作进程可以并发地获取数据块。</p>
<p>实现（约 500 行代码）重用了并行顺序扫描中的“块分块（block chunking）”逻辑。但它不仅仅是将块范围平均分配给工作进程，因为如果表的某个部分数据密度更高，这种简单分配可能导致负载不均衡。</p>
<p>相反，它使用了衰减块大小策略 (decaying chunk size strategy)：</p>
<ul>
<li>大块开始 (Large Start)： 工作进程开始时领取大块的块，以最大限度地减少共享状态上的锁定开销。</li>
<li>逐渐减小 (Tapering Down)： 随着扫描的进行，分块大小会缩小。</li>
<li>颗粒化结束 (Granular Finish)： 到扫描结束时，工作进程每次只领取 1 个块。</li>
</ul>
<p>这种“缓慢减少”确保了我们不会最后只剩下一个工作进程在处理一个巨大的最终块，而其他工作进程却闲置着。它强制所有进程大致在同一时间跨过终点线。</p>
<h2 data-id="heading-2">3. 基准测试数据</h2>
<p>为了看到实际效果，我创建了一个包含 1000 万行的表 <code>bench_tid_range</code>，并使用 ctid 范围条件对表的前 50% 运行了 <code>count(*)</code> 查询。</p>
<p><strong>测试环境：</strong></p>
<ul>
<li>数据量：1000 万行</li>
<li>查询：<code>SELECT count(*) FROM bench_tid_range WHERE ctid &gt;= '(0,0)' AND ctid &lt; '(41667,0)'</code></li>
</ul>







































































<table><thead><tr><th align="left">环境</th><th align="left">工作进程数 (Workers)</th><th align="left">执行时间 (中位数)</th><th align="left">加速比</th></tr></thead><tbody><tr><td align="left"><strong>Before (Pg 18)</strong></td><td align="left">0</td><td align="left">448 ms</td><td align="left">1.00x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">0</td><td align="left">435 ms</td><td align="left">1.03x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">1</td><td align="left">238 ms</td><td align="left">1.88x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">2</td><td align="left">174 ms</td><td align="left">2.58x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">3</td><td align="left">151 ms</td><td align="left">2.97x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">4</td><td align="left">150 ms</td><td align="left">2.98x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">5</td><td align="left">147 ms</td><td align="left">3.05x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">6</td><td align="left">143 ms</td><td align="left">3.14x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">7</td><td align="left">147 ms</td><td align="left">3.04x</td></tr><tr><td align="left"><strong>After (Pg 19)</strong></td><td align="left">8</td><td align="left">147 ms</td><td align="left">3.04x</td></tr></tbody></table>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75f5747229bf40ba9a48d04f819011e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZvcnlTUUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133057&amp;x-signature=Y1K0Vej4ssh8IcXRQVx6GSy5HB8%3D" alt="1.png" loading="lazy"/></p>
<p>我们可以看到，仅仅启用 1 个工作进程（这实际上给了我们 2 个扫描进程：Leader + 1 个 Worker），执行时间就大幅下降。对于这个特定的工作负载，“最佳平衡点”似乎在 2-3 个工作进程左右。</p>
<h2 data-id="heading-3">4. 为什么不直接用“并行顺序扫描”？</h2>
<p>你可能会问：“为什么 Postgres v18 不直接选择并行顺序扫描？用 4 个工作进程扫描整个表难道不比用 1 个进程扫描半个表快吗？”</p>
<p>我通过强制设置 <code>enable_tidscan = off</code> 并使用 4 个工作进程测试了这一点：</p>
<ul>
<li>执行时间： ~230 ms。</li>
<li>I/O： 访问了所有 ~83k 个页面。</li>
</ul>
<p>新的并行 TID 范围扫描（~150 ms）仍然比暴力/强制的并行顺序扫描快 35%，而且它产生的 I/O 负载只有后者的一半（只访问了 ~41k 个页面）。这可谓两全其美：快速的执行时间（并行）和高效的资源使用（类似索引的范围界定）。</p>
<h2 data-id="heading-4">5. 这对工具意味着什么</h2>
<p>如果你维护在 Postgres 实例之间移动数据的内部脚本，你可能编写了手动计算块范围并将巨大的表划分为块、然后生成进程来运行它们的代码。</p>
<p>随着 PostgreSQL 19 的推出，这种复杂性可能可以被删除了。你可以发出更广泛的 TID 范围查询，并相信规划器会有效地在集群的 I/O 和 CPU 资源之间分配工作。</p>
<h2 data-id="heading-5">6. 如何复现测试</h2>
<p>这是设置测试表和运行基准测试的 SQL：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 创建表</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> bench_tid_range;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> bench_tid_range (id <span class="hljs-type">int</span>, payload text);

<span class="hljs-comment">-- 2. 插入 10M 行以生成 ~41k 个页面</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> bench_tid_range
<span class="hljs-keyword">SELECT</span> x, <span class="hljs-string">'payload_'</span> <span class="hljs-operator">||</span> x
<span class="hljs-keyword">FROM</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">10000000</span>) x;

<span class="hljs-comment">-- 3. Vacuum 以设置可见性映射并冻结（对于稳定的基准测试很重要）</span>
VACUUM (ANALYZE, FREEZE) bench_tid_range;

<span class="hljs-comment">-- 4. 为会话启用并行</span>
<span class="hljs-keyword">SET</span> max_parallel_workers_per_gather <span class="hljs-operator">=</span> <span class="hljs-number">4</span>; <span class="hljs-comment">-- 尝试 2, 4, 8</span>
<span class="hljs-keyword">SET</span> min_parallel_table_scan_size <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;    <span class="hljs-comment">-- 即使对于较小的表也强制并行扫描</span>

<span class="hljs-comment">-- 5. 运行查询</span>
EXPLAIN (ANALYZE, BUFFERS)
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>)
<span class="hljs-keyword">FROM</span> bench_tid_range
<span class="hljs-keyword">WHERE</span> ctid <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'(0,0)'</span> <span class="hljs-keyword">AND</span> ctid <span class="hljs-operator">&lt;</span> <span class="hljs-string">'(41667,0)'</span>;
</code></pre>
<h2 data-id="heading-6">7. 结论</h2>
<p>这是一项令人欣喜的“底层”改进。它或许不会改变您日常的临时查询，但对于构建自定义数据维护脚本的数据库管理员和开发人员而言，并行执行基于 TID 的扫描功能是优化工具包中一项强大的新工具。</p>
<h2 data-id="heading-7">8. 参考</h2>
<p>本文部分内容是来自 <strong>Grant Zhou</strong> 和 <strong>Robins Tharakan</strong> 撰写的英文博客。</p>
<ul>
<li>提交 0ca3b169：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgit.postgresql.org%2Fgitweb%2F%3Fp%3Dpostgresql.git%3Ba%3Dcommitdiff%3Bh%3D0ca3b16973a8bb1c185f56e65edcadc0d9d2c406" target="_blank" title="https://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=0ca3b16973a8bb1c185f56e65edcadc0d9d2c406" ref="nofollow noopener noreferrer">git.postgresql.org/gitweb/?p=p…</a></li>
<li>讨论贴：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.postgresql.org%2Fmessage-id%2Fflat%2F18f2c002a24.11bc2ab825151706.3749144144619388582%2540highgo.ca" target="_blank" title="https://www.postgresql.org/message-id/flat/18f2c002a24.11bc2ab825151706.3749144144619388582%40highgo.ca" ref="nofollow noopener noreferrer">www.postgresql.org/message-id/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhornetlabs.ca%2F2025%2F12%2F08%2Fspeeding-up-large-table-scans-with-parallel-tid-ranges-in-postgresql-19%2F" target="_blank" title="https://hornetlabs.ca/2025/12/08/speeding-up-large-table-scans-with-parallel-tid-ranges-in-postgresql-19/" ref="nofollow noopener noreferrer">hornetlabs.ca/2025/12/08/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.thatguyfromdelhi.com%2F2025%2F12%2F3x-faster-tid-range-scans-postgres-19.html" target="_blank" title="https://www.thatguyfromdelhi.com/2025/12/3x-faster-tid-range-scans-postgres-19.html" ref="nofollow noopener noreferrer">www.thatguyfromdelhi.com/2025/12/3x-…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[七大产品设计方法论：构建卓越软件产品的思维工具箱]]></title>    <link>https://juejin.cn/post/7582759716188012544</link>    <guid>https://juejin.cn/post/7582759716188012544</guid>    <pubDate>2025-12-12T09:18:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582759716188012544" data-draft-id="7582601349580062720" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="七大产品设计方法论：构建卓越软件产品的思维工具箱"/> <meta itemprop="keywords" content="产品,产品经理,资讯"/> <meta itemprop="datePublished" content="2025-12-12T09:18:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yoo前端"/> <meta itemprop="url" content="https://juejin.cn/user/2791012486624116"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            七大产品设计方法论：构建卓越软件产品的思维工具箱
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2791012486624116/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yoo前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:18:06.000Z" title="Fri Dec 12 2025 09:18:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">七大产品设计方法论：构建卓越软件产品的思维工具箱</h2>
<blockquote>
<p>在快速变化的数字时代，打造一款成功的软件产品早已不是“功能堆砌”或“技术炫技”的游戏。真正打动用户、驱动增长的产品，背后往往有一套系统化的方法论支撑。本文将带你深入理解七种被全球顶尖团队广泛采用的产品设计框架——从洞察用户到衡量体验，从构思创意到快速验证——它们共同构成了现代产品人的“思维工具箱”。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">1. 用户中心设计（UCD）：一切从人出发</h3>
<p><strong>核心理念</strong>：产品是为用户服务的，设计必须围绕真实用户的需求、行为和情境展开。</p>
<p>UCD 不是一种具体流程，而是一种<strong>设计哲学</strong>。它强调在整个开发周期中持续引入用户反馈——通过访谈、观察、可用性测试等方式，确保每一步决策都基于对用户的深刻理解。</p>
<blockquote>
<p>📌 <strong>实践建议</strong>：不要等到上线才问用户“好不好用”。在需求阶段就邀请目标用户参与，哪怕只是草图评审。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">2. 双钻模型（Double Diamond）：结构化的问题解决路径</h3>
<p>由英国设计委员会提出，双钻模型将产品设计分为四个阶段：</p>
<ol>
<li><strong>发现（Discover）</strong> ：广泛探索问题空间（发散）</li>
<li><strong>定义（Define）</strong> ：聚焦核心问题（收敛）</li>
<li><strong>开发（Develop）</strong> ：生成多种解决方案（发散）</li>
<li><strong>交付（Deliver）</strong> ：打磨并落地最优方案（收敛）</li>
</ol>
<p>这个模型的价值在于<strong>明确区分“问题定义”与“方案设计”</strong> ，避免团队在没搞清“到底要解决什么”之前就急着写代码。</p>
<blockquote>
<p>💡 <strong>小技巧</strong>：用“5 Why 分析法”帮助你在 Define 阶段挖到真正的用户痛点。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">3. 设计思维（Design Thinking）：以人为本的创新引擎</h3>
<p>源自 IDEO 和斯坦福 d.school，设计思维强调<strong>共情 → 定义 → 构思 → 原型 → 测试</strong>的循环迭代。</p>
<p>与双钻模型类似，但更强调<strong>跨学科协作</strong>与<strong>快速原型验证</strong>。它特别适合面对模糊、复杂甚至“未知的未知”问题（比如：如何提升老年人的数字包容性？）。</p>
<blockquote>
<p>✨ <strong>关键差异</strong>：设计思维不仅是流程，更是一种文化——鼓励试错、拥抱不确定性。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">4. 敏捷开发 + Scrum：让价值持续流动</h3>
<p>如果说前面的方法聚焦“做什么”，那么敏捷开发回答的是“怎么做”。</p>
<p><strong>敏捷宣言</strong>的核心是：个体互动 &gt; 流程工具，可工作软件 &gt; 详尽文档，客户合作 &gt; 合同谈判，响应变化 &gt; 遵循计划。</p>
<p>而 <strong>Scrum</strong> 是最流行的敏捷框架之一，通过<strong>短周期冲刺（Sprint）</strong> 、每日站会、产品待办列表（Product Backlog）等机制，确保团队能快速响应反馈、持续交付价值。</p>
<blockquote>
<p>⚠️ 注意：敏捷不是“不做规划”，而是“用更灵活的方式规划”。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">5. 精益创业（Lean Startup）与 MVP：用最小成本验证假设</h3>
<p>埃里克·莱斯提出的“构建—测量—学习”（Build-Measure-Learn）循环，彻底改变了产品验证逻辑。</p>
<p><strong>MVP（最小可行产品）</strong> 的本质不是“做简陋版”，而是<strong>用最低成本验证最关键假设</strong>。例如：</p>
<ul>
<li>Airbnb 最初只是用 Craigslist 上的照片搭建一个简单网页；</li>
<li>Dropbox 用一段演示视频测试用户兴趣。</li>
</ul>
<blockquote>
<p>🔍 <strong>关键问题</strong>：你的 MVP 能否回答“用户是否愿意为这个价值买单？”</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">6. JTBD（Jobs To Be Done）：用户“雇佣”你的产品做什么？</h3>
<p>传统用户画像常停留在“年龄、职业、兴趣”，而 JTBD 问的是更深层的问题：<strong>用户在什么情境下，想要完成什么“任务”？</strong></p>
<p>例如，用户买电钻不是为了“拥有一个钻头”，而是为了“在墙上打个洞挂画”。理解“任务”而非“产品”，能帮你发现未被满足的需求。</p>
<blockquote>
<p>🧩 <strong>应用示例</strong>：Slack 的成功并非因为“更好的聊天工具”，而是因为它帮团队完成了“减少邮件沟通、提升协作效率”这项任务。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">7. HEART 框架：用数据衡量用户体验</h3>
<p>Google 提出的 HEART 模型，将抽象的“用户体验”拆解为五个可度量维度：</p>
<ul>
<li><strong>H</strong>appiness（满意度）：NPS、用户评分</li>
<li><strong>E</strong>ngagement（参与度）：使用频率、停留时长</li>
<li><strong>A</strong>doption（采纳率）：新用户激活比例</li>
<li><strong>R</strong>etention（留存率）：回访用户占比</li>
<li><strong>T</strong>ask Success（任务完成率）：转化率、错误率</li>
</ul>
<p>有了 HEART，你就不再说“感觉体验变好了”，而是说：“通过优化注册流程，任务成功率从 65% 提升至 89%”。</p>
<blockquote>
<p>📊 <strong>最佳实践</strong>：为每个关键功能设定 1–2 个 HEART 指标，并纳入产品 OKR。</p>
</blockquote>
<hr/>
<h3 data-id="heading-8">如何组合使用这些方法论？</h3>
<p>没有哪一种方法能解决所有问题。高手的做法是<strong>按需调用、灵活组合</strong>：</p>
<ul>
<li>项目初期 → 用 <strong>UCD + JTBD + 设计思维</strong> 深度理解用户；</li>
<li>定义方向 → 用 <strong>双钻模型</strong> 聚焦真问题；</li>
<li>快速验证 → 用 <strong>精益创业 + MVP</strong> 测试核心假设；</li>
<li>开发落地 → 用 <strong>敏捷 + Scrum</strong> 高效协作；</li>
<li>上线后 → 用 <strong>HEART 框架</strong> 量化体验、驱动迭代。</li>
</ul>
<hr/>
<h3 data-id="heading-9">结语：方法论是脚手架，不是牢笼</h3>
<p>这些框架的价值，不在于你背得多熟，而在于你能否在复杂现实中<strong>灵活运用、持续反思、不断进化</strong>。正如设计师 Charles Eames 所说：</p>
<blockquote>
<p>“设计的细节不在形式，而在关系。”<br/>
——而这些方法论，正是帮我们理清“人、问题、方案、价值”之间关系的指南针。</p>
</blockquote>
<p>愿你在产品之路上，既有系统的思考，也有创造的勇气。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[对标MinIO！全新一代分布式文件系统诞生！]]></title>    <link>https://juejin.cn/post/7582763878674661403</link>    <guid>https://juejin.cn/post/7582763878674661403</guid>    <pubDate>2025-12-12T09:18:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582763878674661403" data-draft-id="7582791876365926438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="对标MinIO！全新一代分布式文件系统诞生！"/> <meta itemprop="keywords" content="后端,数据库"/> <meta itemprop="datePublished" content="2025-12-12T09:18:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JavaGuide"/> <meta itemprop="url" content="https://juejin.cn/user/166781497383294"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            对标MinIO！全新一代分布式文件系统诞生！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781497383294/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JavaGuide
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:18:49.000Z" title="Fri Dec 12 2025 09:18:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近 MinIO 官方在 README 中正式宣布项目进入“维护模式”：</p>
<ul>
<li><strong>不再接受新功能、增强或拉取请求</strong>：代码库仅进行维护，不再开发新特性。</li>
<li><strong>安全补丁和关键bug修复</strong>：会根据个案评估，但不是保证全面支持。</li>
<li><strong>问题和PR审查停止</strong>：现有issue不会积极处理，社区支持仅通过Slack提供最佳努力（best-effort）。</li>
<li><strong>企业版转向</strong>：官方推荐转向付费的MinIO AIStor（起价约$96,000/年，针对400TB），该版提供完整管理功能。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd4d81998bf14db5a202ef97554a87eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=YAfP8v9YWT%2FmRnf9oMF4vvIq7uI%3D" alt="" loading="lazy"/></p>
<p>这对很多把 MinIO 当作长期基础设施的团队来说，确实是一个坏消息。</p>
<p>不过也要理解，MinIO 开源这么多年，为 S3 兼容对象存储的普及立下了汗马功劳，社区里无数项目都曾经或正在依赖它。现在它选择把主要精力放在商业版上，这属于公司正常的商业决定。我们不骂它，只向前看：<strong>接下来用什么来替代它？</strong></p>
<h2 data-id="heading-0">RustFS（Rust，性能屠夫）</h2>
<p>在 MinIO 众多替代品中，<strong>RustFS</strong> 是最近热度最高的一颗新星。这个由国人团队主导的开源项目，目前GitHub Star数已狂飙至<strong>15k+</strong>，增速非常夸张。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04ea701c9c1b461a9350a3eabb5f6855~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=o4TCHxVHimgbi9JooRDc%2FnAu8YE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/717970a34ad44d45bd21717902bd31cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=pkuqvEdyTXbUHPcjmY0A3VbADXw%3D" alt="" loading="lazy"/></p>
<p>RustFS 是一个基于 Rust 语言开发的高性能分布式对象存储软件，定位与 MinIO 高度相似，功能基本对齐 MinIO 开源版（包括分片上传、桶策略、版本控制、事件通知、生命周期管理等），完全兼容 AWS S3 协议，部署简单（Docker 一键启动），并提供现代化的可视化管理控制台。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcabc11ac4954aa0a882fc3b46a57e56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=LMyHyRbYK21plnkV8%2FCfOax4M3o%3D" alt="" loading="lazy"/></p>
<p>根据官方同等硬件压测，RustFS在小对象（4KB）场景下吞吐量约为MinIO的<strong>2.3倍</strong>，大对象场景也高达<strong>1.8~2.2倍</strong>。</p>
<p>与 MinIO 不同的是，RustFS 采用宽松的Apache 2.0许可证，对商业闭源产品更加友好。</p>
<p>这是官方提供的RustFS 与其他存储产品对比：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d84b4368269d4d6eae08cb5470522191~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=MxBApBirXcrP9fqlgTt7GqW9yN8%3D" alt="" loading="lazy"/></p>
<p>项目还比较新（2024年底后才真正火起来），分布式模式仍在快速迭代中。对于追求极致稳定的大规模生产集群，建议先在测试/灰度环境中充分验证，或观望社区再演进6-12个月等1.0 正式版发布！</p>
<p>项目还比较新（真正火起来是 2024 年底之后），目前还处在 <code>1.0.0-alpha</code> 阶段，分布式模式仍在快速迭代中。对于追求极致稳定、规模很大的生产集群，<strong>建议先在测试 / 灰度环境中充分验证，或观望社区再演进 6～12 个月，等 1.0 正式版发布再做全面迁移决策。</strong></p>
<p>如果是单机 / 小规模集群的话，完全可以上生产环境用了，根据大量使用者反馈，非常稳定。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac24264bd2b443c48a9dbf568ec23cae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=y6yYguLZ5K4M7oX7UfRF1Y5Kjf8%3D" alt="" loading="lazy"/></p>
<p>再多一点，RustFS 的贡献者名单里能看到不少技术大佬，比如 PHP 大神安正超。而且，这个项目处理 issue 的速度比较快，使用遇到什么 bug，一般能够在比较短的时间就处理解决。</p>
<p>项目地址：</p>
<ul>
<li>官网：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Frustfs.com" target="_blank" title="https://rustfs.com" ref="nofollow noopener noreferrer">rustfs.com</a></strong></li>
<li>GitHub：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Frustfs" target="_blank" title="https://github.com/rustfs/rustfs" ref="nofollow noopener noreferrer">github.com/rustfs/rust…</a></strong></li>
</ul>
<h2 data-id="heading-1">Garage（Rust，中小规模自托管）</h2>
<p>Garage 是一款 <strong>S3 兼容的分布式对象存储服务</strong>，主要面向 <strong>小到中型的自托管环境</strong>。它的目标不是构建超大规模云平台，而是让你能在几台服务器上，轻松跑起一个可靠、容错的对象存储。而且，能轻松跨越不同物理位置（如多个机房、家庭宽带+云主机组合）部署，即使部分节点掉线，数据依然可用。</p>
<p>用一句话概括：<strong>Garage 是一套适合“自己搭、小团队用、多节点部署”的 S3 存储系统。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3413954ac7604dd1b7f6724075ca8bb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=1EFVmrYYy%2FTaZTh1EG3fWierqcA%3D" alt="" loading="lazy"/></p>
<p>为了让管理更简单，Garage 同样提供了一个独立的 Web 管理界面 —— <strong>Garage Web UI</strong>。它是 Garage 对象存储的前端控制台，帮助你通过浏览器完成日常运维工作，主要功能包括：健康状态监控、桶（Bucket）管理、对象浏览、访问密钥管理等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0bdccdb07a34d22bcd8d576e1fd9286~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=ZGS%2FuzNs2tKwoxyPV83Qgu%2BQkQU%3D" alt="" loading="lazy"/></p>
<p>项目地址：</p>
<ul>
<li>官网：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgaragehq.deuxfleurs.fr" target="_blank" title="https://garagehq.deuxfleurs.fr" ref="nofollow noopener noreferrer">garagehq.deuxfleurs.fr</a></strong></li>
<li>仓库（自托管）：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgit.deuxfleurs.fr%2FDeuxfleurs%2Fgarage" target="_blank" title="https://git.deuxfleurs.fr/Deuxfleurs/garage" ref="nofollow noopener noreferrer">git.deuxfleurs.fr/Deuxfleurs/…</a></strong></li>
</ul>
<h2 data-id="heading-2">Ceph（C++，老牌分布式存储鼻祖）</h2>
<p>Ceph 是开源分布式存储领域的元老项目，社区活跃度和成熟度都非常高，当前仍是开源分布式存储第一梯队。它提供 <strong>对象存储（RGW，兼容 S3）</strong>、<strong>块存储（RBD）</strong> 和 <strong>文件存储（CephFS）</strong> 三合一的统一存储平台，能够在普通硬件之上，构建从PB到EB级、无单点故障的大规模集群。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/369d9514f7634c85b59b2d7bbbff1841~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=ukSHtPIWhXWNupLI8RD4n8GGNJU%3D" alt="" loading="lazy"/></p>
<p>Ceph 还支持多租户隔离，满足复杂企业环境的需求。</p>
<p>与MinIO最大的区别在于：<strong>Ceph是“全能型平台”，MinIO是“专精型工具”</strong>。Ceph架构复杂，运维门槛高，适合有专业存储/运维团队的中大型企业。</p>
<p>Ceph不太适合单机或小规模存储、对单次请求延迟极其敏感的业务、高频率小文件读写以及对运维简单性要求很高的中小团队。</p>
<p>项目地址：</p>
<ul>
<li>官网：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fceph.io%2F" target="_blank" title="https://ceph.io/" ref="nofollow noopener noreferrer">ceph.io/</a></strong></li>
<li>Github：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fceph%2Fceph" target="_blank" title="https://github.com/ceph/ceph" ref="nofollow noopener noreferrer">github.com/ceph/ceph</a></strong></li>
</ul>
<h2 data-id="heading-3">SeaweedFS（Go，海量小文件神器）</h2>
<p>SeaweedFS 是专为“几十亿小文件 + 高并发读写”场景设计的高性能分布式存储系统。其核心设计灵感源自 Facebook 的 Haystack 论文，通过将元数据分散到卷服务器（Volume Server），实现了单次磁盘访问 O(1) 的极致读取效率。它社区活跃度高，文档完善，且架构轻量，运维成本远低于 Ceph。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88a859c8503b4992ae31d9b3d1a598a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=693ewp58%2BLIypx41hy7eur2yf3g%3D" alt="" loading="lazy"/></p>
<p>和 Ceph/MinIO 的区别在于：<strong>SeaweedFS 是为“小文件性能”而生的特种部队</strong>。它解决了传统文件系统在处理海量小文件时元数据成为瓶颈的痛点。不过，这并不代表其不可以存储大文件，只是在小文件场景优势更大。</p>
<p><strong>适合的场景：</strong></p>
<ul>
<li>海量小文件存储，如图片、社交媒体内容。</li>
<li>需要极低延迟读取的业务，如实时头像获取、缩略图服务。</li>
<li>包含数亿张小图片或音频片段的机器学习训练集存储。</li>
<li>大规模日志文件的顺序写入与存储。</li>
</ul>
<p>项目地址：</p>
<ul>
<li>官网：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fseaweedfs.com%2F" target="_blank" title="https://seaweedfs.com/" ref="nofollow noopener noreferrer">seaweedfs.com/</a></strong></li>
<li>Github：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fseaweedfs%2Fseaweedfs" target="_blank" title="https://github.com/seaweedfs/seaweedfs" ref="nofollow noopener noreferrer">github.com/seaweedfs/s…</a></strong></li>
</ul>
<h2 data-id="heading-4">云厂商对象存储（OSS / COS / S3 等）</h2>
<p>云厂商提供的对象存储服务（Object Storage Service，OSS / COS / S3）是一种<strong>海量、安全、低成本且高度可靠</strong>的云存储形态，适合存放任意类型的文件。容量与吞吐可以按需弹性扩展，并提供多种存储类型，帮助优化整体存储成本。</p>
<p>常见提供对象存储服务的云厂商包括：<strong>阿里云 OSS、腾讯云 COS、七牛云、AWS S3</strong> 等。</p>
<p>云厂商对象存储的优势如下：</p>
<ul>
<li><strong>可靠性强</strong> ： 拿阿里云对象存储 OSS（Object Storage Service）为例说明，其可提供 99.9999999999%（12 个 9）的数据持久性，99.995%的数据可用性。</li>
<li><strong>安全性强</strong>：对象存储服务一般都会支持防盗链配置（可屏蔽恶意来源的访问）、基于 SSL 和 TLS 的 HTTPS 数据加密传输、文件版本控制（防止文件被误删除或覆盖而造成数据丢失）、控制每个单独文件的读写权限等功能。</li>
<li><strong>扩展性强</strong>：不限制存储空间大小。您可以根据所需存储量无限扩展存储空间，解决了传统硬件存储扩容问题。</li>
<li><strong>成本较低</strong>：无需传统硬件的采购、部署和运维，支持按量付费。</li>
<li><strong>接入方便</strong>：对象存储服务一般都会提供标准的 RESTful API 接口、丰富的 SDK 包、客户端工具、控制台。</li>
<li>……</li>
</ul>
<h2 data-id="heading-5">总结</h2>
<p>这张表格是我让 Gemini 3 Pro 做的总结对比，可供参考（会有幻觉问题）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d2e630d579e4fb8a6c8382afd7278e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=NXLV0RgTH%2FzWdreQ8%2FCF0n4ydVg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58f9b240e0ac423083b17621bddeb7df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766135929&amp;x-signature=Z9iWh7yGN9wiA%2BhclYm2Sv6Oeuo%3D" alt="" loading="lazy"/></p>
<p><strong>对于个人开发者或中小团队：</strong></p>
<ul>
<li>如果你的需求是快速自建一个S3兼容存储，数据量不大，强烈推荐先尝试<strong>Garage</strong>（部署最轻量、对环境要求低）或 <strong>RustFS</strong>（功能更全，性能更强）。</li>
<li>如果只是存一些图片、视频等普通业务文件，而且对“可用性省心、少运维”更看重，  那么直接用<strong>云厂商的 OSS / COS / S3</strong> 往往是成本和精力投入都更优的选择（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FGCVnMF2WojsG34wRzXy3JA" target="_blank" title="https://mp.weixin.qq.com/s/GCVnMF2WojsG34wRzXy3JA" ref="nofollow noopener noreferrer">JavaGuide(javaguide.cn)</a>上所有的图片都存放在 OSS 中）。</li>
</ul>
<p><strong>如果你已经在用 MinIO</strong>：如果老版本还能稳定运行，完全可以“让子弹再飞一会儿”。可以考虑利用这段时间搭一套 RustFS / Garage / 其他方案的测试环境，预研迁移路径和成本。等到 <strong>RustFS</strong> 发布 <strong>1.0 正式版</strong>，再结合自身业务节奏做整体迁移决策，会更稳妥。</p>
<p><strong>对于中大型企业或有复杂需求的用户：</strong></p>
<ul>
<li>预算允许、对可用性和合规要求高时，直接用 <strong>云厂商 OSS / COS / S3</strong> 依然是总体成本最低、心智负担最小的选择——把精力放在业务而不是存储底座上。</li>
<li>必须自建时：
<ul>
<li>追求 <strong>统一块 / 文件 / 对象 + 超大规模集群</strong> → 重点评估 <strong>Ceph / CubeFS</strong>。</li>
<li>业务以 <strong>海量小文件、高并发访问</strong> 为主 → <strong>SeaweedFS</strong> 会比通用对象存储更合适。</li>
<li>可以接受新技术栈、希望在对象存储层拿到 <strong>更高性能与更友好的开源协议（Apache 2.0）</strong> → <strong>RustFS</strong> 值得列入中长期主力选型。</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI产品经理的核心竞争力：在技术、用户与商业的交叉点上创造价值]]></title>    <link>https://juejin.cn/post/7582759716188061696</link>    <guid>https://juejin.cn/post/7582759716188061696</guid>    <pubDate>2025-12-12T09:24:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582759716188061696" data-draft-id="7582783931162820643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI产品经理的核心竞争力：在技术、用户与商业的交叉点上创造价值"/> <meta itemprop="keywords" content="产品,产品经理,资讯"/> <meta itemprop="datePublished" content="2025-12-12T09:24:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yoo前端"/> <meta itemprop="url" content="https://juejin.cn/user/2791012486624116"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI产品经理的核心竞争力：在技术、用户与商业的交叉点上创造价值
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2791012486624116/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yoo前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:24:31.000Z" title="Fri Dec 12 2025 09:24:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在大模型浪潮席卷全球的今天，“AI产品经理”已成为科技行业最炙手可热的角色之一。但热潮之下，一个关键问题浮出水面：<br/>
<strong>当人人都在谈“AI+产品”，真正能驾驭这场变革的产品经理，究竟靠什么脱颖而出？</strong></p>
<p>答案不是会写 Prompt，也不是背诵 Transformer 原理，而是——<strong>在技术可能性、用户真实需求与商业可持续性之间，构建精准的判断力与高效的执行力</strong>。</p>
<p>本文将从四大维度，系统拆解 AI 产品经理的核心竞争力。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、技术理解力：不是成为工程师，而是成为“技术翻译者”</h2>
<p>AI PM 不需要写训练代码，但必须<strong>理解关键技术的边界、成本与适用场景</strong>。这是你与算法团队高效协作、避免“空中楼阁”式需求的基础。</p>
<h3 data-id="heading-1">关键能力项：</h3>
<ul>
<li>
<p><strong>掌握主流 AI 架构的适用逻辑</strong><br/>
能清晰区分何时用 RAG、何时微调、何时构建 Agent，并说明理由。例如：</p>
<blockquote>
<p>“RAG 适合知识高频更新、领域广但深度要求不高的场景；而微调更适合语言风格、术语体系高度定制化的垂直任务。”</p>
</blockquote>
</li>
<li>
<p><strong>理解数据闭环与模型迭代机制</strong><br/>
知道 bad case 如何被自动捕获、标注、回流训练，形成“产品→数据→模型→产品”的飞轮。</p>
</li>
<li>
<p><strong>关注推理成本与工程约束</strong><br/>
能预判延迟（latency）、并发量（QPS）、显存占用对用户体验的影响。例如：“70B 模型虽强，但响应超 5 秒，用户流失率上升 60%”。</p>
</li>
</ul>
<h3 data-id="heading-2">面试体现方式：</h3>
<blockquote>
<p>“我们在设计智能投研助手时，评估了三种方案：全微调、RAG、RAG+轻量微调。最终选择后者，因为既要保证金融术语准确性（需微调），又要支持实时财报问答（需 RAG）。我们用 LoRA 将微调成本控制在每日 $15，同时通过缓存高频 query 降低 API 调用频次。”</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">二、用户洞察力：穿透“AI 幻觉”，回归真实任务</h2>
<p>AI 的强大容易让人陷入“技术自嗨”——以为炫酷的生成能力就是用户所需。但真正的 AI PM 必须追问：</p>
<blockquote>
<p><strong>用户到底想完成什么“任务”？AI 是帮手，还是干扰？</strong></p>
</blockquote>
<h3 data-id="heading-4">关键能力项：</h3>
<ul>
<li>
<p><strong>用 JTBD（Jobs-To-Be-Done）框架定义问题</strong><br/>
不问“用户想要什么功能”，而问“用户在什么情境下，试图完成什么目标？”<br/>
例：用户不是要“聊天机器人”，而是要“快速起草一封专业英文邮件”。</p>
</li>
<li>
<p><strong>识别 AI 的“可用性陷阱”</strong></p>
<ul>
<li>幻觉（Hallucination）导致信任崩塌</li>
<li>输出不稳定引发操作焦虑</li>
<li>缺乏可解释性让用户不敢决策</li>
</ul>
</li>
<li>
<p><strong>设计“人机协同”体验</strong><br/>
明确 AI 负责什么（信息聚合、初稿生成），人类负责什么（审核、决策、情感表达），并提供清晰的控制权（如“重写”、“引用来源”、“调整语气”）。</p>
</li>
</ul>
<h3 data-id="heading-5">面试体现方式：</h3>
<blockquote>
<p>“我们发现用户对 AI 生成的法律合同不敢直接使用。于是我们在输出中强制标注每条条款的法规依据，并加入‘风险提示’模块。同时提供‘人工律师复核’入口——转化率提升 2.3 倍，NPS 从 -15 升至 +42。”</p>
</blockquote>
<hr/>
<h2 data-id="heading-6">三、产品架构力：从功能堆砌到系统设计</h2>
<p>传统 PM 关注功能列表，而 AI PM 必须设计<strong>端到端的智能系统</strong>——包括数据流、反馈环、失败处理、安全边界。</p>
<h3 data-id="heading-7">关键能力项：</h3>
<ul>
<li>
<p><strong>构建可扩展的 AI 产品架构</strong><br/>
能绘制包含以下模块的系统图：</p>
<ul>
<li>输入层（用户 query / 多模态信号）</li>
<li>意图识别与路由（是否走 RAG？是否调工具？）</li>
<li>执行引擎（Agent 工作流、工具链）</li>
<li>输出层（生成 + 引用 + 可控参数）</li>
<li>监控层（幻觉检测、延迟告警、用户反馈）</li>
</ul>
</li>
<li>
<p><strong>设计评估与迭代机制</strong><br/>
不仅看准确率，更建立多维指标：</p>
<ul>
<li><strong>任务成功率</strong>（Task Success Rate）</li>
<li><strong>用户干预率</strong>（Human Takeover Rate）</li>
<li><strong>信任度评分</strong>（Trust Score via A/B Test）</li>
<li><strong>单位经济模型</strong>（Cost per Query vs. Revenue）</li>
</ul>
</li>
<li>
<p><strong>预设失败路径（Fallback Strategy）</strong><br/>
当 AI 不确定时，如何优雅降级？转人工？返回空结果？提供选项？这直接决定产品鲁棒性。</p>
</li>
</ul>
<h3 data-id="heading-8">面试体现方式：</h3>
<blockquote>
<p>“我们的 Agent 系统内置三层 fallback：第一层是置信度阈值，低于 0.7 则追问澄清；第二层是规则引擎兜底（如查天气走固定 API）；第三层是转接人工客服。上线后，用户投诉率下降 78%。”</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">四、商业判断力：让 AI 从成本中心走向价值引擎</h2>
<p>AI 项目往往烧钱快、见效慢。优秀的 AI PM 必须回答：</p>
<blockquote>
<p><strong>这个 AI 功能，如何带来收入、降低成本、或构建竞争壁垒？</strong></p>
</blockquote>
<h3 data-id="heading-10">关键能力项：</h3>
<ul>
<li>
<p><strong>量化 ROI</strong><br/>
计算：AI 替代人力节省的成本 vs. 模型推理+维护成本。<br/>
例：“客服机器人每月节省 200 人天，但 API 成本 $8K，净收益为正。”</p>
</li>
<li>
<p><strong>设计可变现的 AI 产品形态</strong></p>
<ul>
<li>按 query 计费（如 Perplexity）</li>
<li>按能力分级（基础版免费，高级分析付费）</li>
<li>嵌入工作流（如 Notion AI 提升留存）</li>
</ul>
</li>
<li>
<p><strong>识别“伪 AI 需求”</strong><br/>
警惕为了“蹭热点”而强行加 AI 的功能。例如：一个简单的表单填写，用规则引擎比 LLM 更可靠、更便宜。</p>
</li>
</ul>
<h3 data-id="heading-11">面试体现方式：</h3>
<blockquote>
<p>“我们最初想给 CRM 加‘AI 自动生成客户画像’，但测算发现：销售团队每天只花 2 分钟手动录入，而 AI 方案月成本 $12K。于是我们转向高价值场景——用 AI 分析会议录音生成行动项，该功能成为 Premium 订阅的关键卖点，带动 ARPU 提升 18%。”</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">五、核心竞争力总结：AI PM 的“黄金三角”</h2>

























<table><thead><tr><th>维度</th><th>能力</th><th>衡量标准</th></tr></thead><tbody><tr><td><strong>技术理解力</strong></td><td>知道 AI 能做什么、不能做什么、代价是什么</td><td>能与算法工程师对齐技术方案，避免不切实际的需求</td></tr><tr><td><strong>用户洞察力</strong></td><td>穿透技术表象，抓住真实任务与情感诉求</td><td>用户愿意为你的 AI 功能付费或主动使用</td></tr><tr><td><strong>商业判断力</strong></td><td>将 AI 转化为可持续的价值单元</td><td>项目有明确 ROI，或构建长期竞争壁垒</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>终极标志</strong>：你不再说“我们要做一个 AI 产品”，而是说<br/>
<strong>“我们用 AI 解决 X 用户在 Y 场景下的 Z 问题，成本可控、效果可测、价值可扩。”</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-13">结语：AI 产品经理，是新时代的“系统设计师”</h2>
<p>未来的 AI 产品，不再是“前端+后端+数据库”的组合，而是“用户意图 + 数据引擎 + 智能代理 + 反馈闭环”的复杂系统。<br/>
AI 产品经理，正是这个系统的<strong>架构师、翻译官与守门人</strong>。</p>
<p>你不需要成为最懂算法的人，但必须是最懂“如何让算法服务于人”的人。</p>
<p>而这，就是不可替代的核心竞争力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 iPhone 文件管理，从沙盒结构到开发调试的多工具协同实践]]></title>    <link>https://juejin.cn/post/7582637280218103862</link>    <guid>https://juejin.cn/post/7582637280218103862</guid>    <pubDate>2025-12-12T09:20:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582637280218103862" data-draft-id="7582561515817779263" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 iPhone 文件管理，从沙盒结构到开发调试的多工具协同实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-12T09:20:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂的程序猴"/> <meta itemprop="url" content="https://juejin.cn/user/2760245749234147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 iPhone 文件管理，从沙盒结构到开发调试的多工具协同实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760245749234147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂的程序猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:20:59.000Z" title="Fri Dec 12 2025 09:20:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在很多开发者眼中，<strong>iPhone 文件管理</strong> 似乎只是“看看 Documents 里有什么文件”，但在真实的开发、测试与问题排查过程中，文件系统往往是最容易被忽略、却又最容易出问题的一环。</p>
<p>无论是以下场景：</p>
<ul>
<li>App 占用空间越来越大</li>
<li>图片、音频、视频缓存无法回收</li>
<li>WebView / Hybrid 页面缓存异常</li>
<li>SQLite / Realm 文件膨胀</li>
<li>日志文件过多导致性能下降</li>
<li>测试环境需要快速替换本地数据</li>
<li>崩溃日志、运行日志需要导出分析</li>
</ul>
<p>这些问题的核心，其实都指向一个点：<strong>iPhone 文件管理是否可控、可观测、可操作</strong>。</p>
<p>本文基于真实工程实践，从开发者角度系统梳理 iPhone 文件管理的技术背景，并结合 <strong>Xcode、Finder / iTunes、克魔（KeyMob）、Safari Inspector、Charles、Console.app</strong> 等工具，构建一套可落地的多工具文件管理与调试方案。</p>
<hr/>
<h2 data-id="heading-0">一、为什么 iPhone 文件管理对开发者如此重要？</h2>
<p>iOS 的安全机制决定了文件管理并非“随便看看文件”那么简单，但这并不意味着它不重要，恰恰相反：</p>
<h3 data-id="heading-1"><strong>1. 文件系统直接影响性能</strong></h3>
<ul>
<li>缓存文件过多 → 启动变慢</li>
<li>日志文件暴涨 → I/O 压力增加</li>
<li>数据库频繁读写 → 卡顿、耗电</li>
</ul>
<h3 data-id="heading-2"><strong>2. 很多线上问题只能从文件层面解释</strong></h3>
<ul>
<li>图片缓存异常</li>
<li>视频重复下载</li>
<li>WebView 缓存不释放</li>
<li>App 占用空间异常增长</li>
</ul>
<h3 data-id="heading-3"><strong>3. 文件是调试、测试、复现问题的关键媒介</strong></h3>
<ul>
<li>通过替换本地文件快速构造测试环境</li>
<li>导出用户数据进行问题复现</li>
<li>分析日志文件还原真实执行路径</li>
</ul>
<p>如果无法有效管理 iPhone 文件系统，很多问题只能“靠猜”。</p>
<hr/>
<h2 data-id="heading-4">二、iOS 沙盒结构：iPhone 文件管理的基础认知</h2>
<p>每个 iOS App 都运行在独立沙盒中，核心目录包括：</p>
<h3 data-id="heading-5"><strong>Documents</strong></h3>
<ul>
<li>用户生成数据</li>
<li>需要长期保存的数据</li>
<li>会参与 iCloud 备份</li>
</ul>
<h3 data-id="heading-6"><strong>Library</strong></h3>
<ul>
<li>Application Support（数据库、配置）</li>
<li>Caches（缓存数据）</li>
<li>Preferences（plist）</li>
</ul>
<h3 data-id="heading-7"><strong>tmp</strong></h3>
<ul>
<li>临时文件</li>
<li>系统可随时清理</li>
</ul>
<p>理解这些目录的用途，是文件管理的前提。</p>
<hr/>
<h2 data-id="heading-8">三、Xcode：开发阶段最基础的文件查看方式</h2>
<h3 data-id="heading-9"><strong>1. Devices and Simulators</strong></h3>
<p>通过 Xcode 可以：</p>
<ul>
<li>下载 App 容器</li>
<li>查看沙盒文件</li>
<li>导出数据库、日志、配置文件</li>
</ul>
<p>适合：</p>
<ul>
<li>开发阶段验证</li>
<li>简单文件检查</li>
</ul>
<h3 data-id="heading-10"><strong>局限性</strong></h3>
<ul>
<li>操作效率低</li>
<li>无法实时同步</li>
<li>不适合频繁文件操作</li>
<li>不支持复杂批量管理</li>
</ul>
<p>Xcode 更像是“应急查看工具”，而不是完整的文件管理方案。</p>
<hr/>
<h2 data-id="heading-11">四、Finder / iTunes：面向用户级别的文件管理</h2>
<p>通过 Finder（macOS Catalina+）或 iTunes（旧系统），可以：</p>
<ul>
<li>访问 App 的 Documents 目录</li>
<li>拖拽导入 / 导出文件</li>
<li>用于测试资源替换</li>
</ul>
<p>适合场景：</p>
<ul>
<li>测试环境构造</li>
<li>Demo 数据导入</li>
</ul>
<p>但它同样存在明显不足：</p>
<ul>
<li>只能访问 Documents</li>
<li>无法查看 Library、Caches</li>
<li>无法分析系统文件</li>
<li>无法配合调试流程</li>
</ul>
<hr/>
<h2 data-id="heading-12">五、克魔（KeyMob）：开发者视角下的 iPhone 文件管理工具</h2>
<p>在真实工程中，开发者更需要的是<strong>跨平台、可视化、可操作的文件管理能力</strong>。</p>
<h3 data-id="heading-13"><strong>1. 全沙盒文件结构查看</strong></h3>
<p>KeyMob 可以查看：</p>
<ul>
<li>Documents</li>
<li>Library / Caches</li>
<li>Application Support</li>
<li>日志文件</li>
<li>数据库文件</li>
<li>WebView 缓存目录</li>
</ul>
<p>这对于定位文件膨胀、缓存异常非常关键。</p>
<h3 data-id="heading-14"><strong>2. 文件操作能力</strong></h3>
<p>支持：</p>
<ul>
<li>创建 / 删除文件</li>
<li>上传文件到 iPhone</li>
<li>从 iPhone 导出文件</li>
<li>批量操作</li>
</ul>
<p>适用于：</p>
<ul>
<li>快速替换测试数据</li>
<li>复现用户问题</li>
<li>调试复杂业务逻辑</li>
</ul>
<h3 data-id="heading-15"><strong>3. 不越狱前提下的文件管理</strong></h3>
<p>这是 iOS 文件管理中非常重要的一点，避免破坏系统环境。</p>
<hr/>
<h2 data-id="heading-16">六、文件管理与日志分析的结合价值</h2>
<p>文件管理不只是“看文件”，更重要的是 <strong>与日志、性能问题关联分析</strong>。</p>
<h3 data-id="heading-17">常见场景：</h3>
<ul>
<li>查看日志文件是否无限增长</li>
<li>对比不同版本生成的配置文件差异</li>
<li>分析 WebView 缓存文件大小变化</li>
<li>检查数据库文件是否异常增大</li>
</ul>
<p>通过文件层面，很多问题可以直观暴露。</p>
<hr/>
<h2 data-id="heading-18">七、Safari Inspector：WebView 文件与缓存的调试入口</h2>
<p>对于 Hybrid / uni-app 项目，文件管理离不开 Safari Inspector。</p>
<h3 data-id="heading-19">可辅助分析：</h3>
<ul>
<li>WebView 缓存目录</li>
<li>IndexedDB / LocalStorage 使用情况</li>
<li>资源是否重复缓存</li>
<li>JS 生成文件是否未清理</li>
</ul>
<p>很多 WebView 占用空间异常的问题，其实源自前端资源管理不当。</p>
<hr/>
<h2 data-id="heading-20">八、Charles：网络资源与本地文件的对应关系</h2>
<p>文件管理还需要结合网络行为一起看：</p>
<h3 data-id="heading-21">Charles 可以帮助你确认：</h3>
<ul>
<li>资源是否重复下载</li>
<li>是否缺失缓存控制</li>
<li>大文件是否落盘到缓存目录</li>
<li>失败重试是否生成多份临时文件</li>
</ul>
<p>通过 Charles + 文件管理工具，可以建立“网络 → 本地文件”的完整链路。</p>
<hr/>
<h2 data-id="heading-22">九、Console.app：从系统角度观察文件相关异常</h2>
<p>某些文件问题会直接反映在系统日志中，例如：</p>
<pre><code class="hljs language-css" lang="css">disk <span class="hljs-selector-tag">I</span>/O error
no space <span class="hljs-attribute">left</span> on device
failed <span class="hljs-selector-tag">to</span> write file
sandbox deny file-write
</code></pre>
<p>这些日志往往是文件管理问题的直接证据。</p>
<hr/>
<h2 data-id="heading-23">十、构建开发者视角的 iPhone 文件管理工具矩阵</h2>








































<table><thead><tr><th>需求场景</th><th>工具组合</th><th>作用</th></tr></thead><tbody><tr><td>基础查看</td><td>Xcode</td><td>简单导出容器</td></tr><tr><td>用户数据导入</td><td>Finder / iTunes</td><td>Documents 文件</td></tr><tr><td>全沙盒管理</td><td>KeyMob</td><td>文件浏览与操作</td></tr><tr><td>WebView 缓存分析</td><td>Safari Inspector</td><td>前端存储</td></tr><tr><td>网络文件对应</td><td>Charles</td><td>资源与缓存</td></tr><tr><td>系统异常定位</td><td>Console.app</td><td>文件错误日志</td></tr></tbody></table>
<p>这是一个真正实用的文件管理体系。</p>
<hr/>
<h2 data-id="heading-24">iPhone 文件管理是开发调试的重要基础能力</h2>
<p>一个成熟的 iOS 团队，文件管理能力至少应做到：</p>
<p><strong>可查看 → 可操作 → 可分析 → 可对比 → 可清理</strong></p>
<p>而这依赖多工具协同：</p>
<ul>
<li>Xcode（基础容器）</li>
<li>Finder / iTunes（用户数据）</li>
<li>KeyMob（全沙盒管理）</li>
<li>Safari Inspector（WebView 文件）</li>
<li>Charles（网络资源）</li>
<li>Console.app（系统日志）</li>
</ul>
<p>当文件管理能力完善后，性能、稳定性、调试效率都会显著提升。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[重磅更新！OpenAI最新模型GPT 5.2上线]]></title>    <link>https://juejin.cn/post/7582755817671557130</link>    <guid>https://juejin.cn/post/7582755817671557130</guid>    <pubDate>2025-12-12T09:23:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582755817671557130" data-draft-id="7582763878674726939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="重磅更新！OpenAI最新模型GPT 5.2上线"/> <meta itemprop="keywords" content="OpenAI"/> <meta itemprop="datePublished" content="2025-12-12T09:23:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哪吒编程"/> <meta itemprop="url" content="https://juejin.cn/user/581021766790141"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            重磅更新！OpenAI最新模型GPT 5.2上线
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/581021766790141/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哪吒编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:23:52.000Z" title="Fri Dec 12 2025 09:23:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4499529ec3754c7f9f5dfdd25c6cc033~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=yQneV42uVCKjuqMBVj4AkSimEos%3D" alt="" loading="lazy"/></p>
<p>11月18日，谷歌发布最新旗舰模型Gemini 3 Pro。</p>
<p>11月20日，谷歌发布最新AI绘画模型Nano Banana Pro。</p>
<p>11月25日，Anthropic公司发布最新旗舰模型Claude Opus 4.5。</p>
<p>Gemini 3 Pro和Claude Opus 4.5获得了很高的关注和评测评价，给 OpenAI 现有产品 GPT 5.1 带来显著竞争压力。</p>
<p>OpenAI CEO 山姆·奥特曼 在 2025 年 12 月初向全体员工发布内部备忘录，宣布 OpenAI 进入 “红色警报/Code Red”紧急状态。</p>
<p>这是OpenAI对竞争压力做出最高级别的战略响应。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72492c7c67344d8baf5c2757a1e39619~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=a9l862XXpb4RQzG2WmMBS8SeKSw%3D" alt="" loading="lazy"/></p>
<p>12月12日，也就是今日凌晨，OpenAI打响反击战，GPT 5.2发布。</p>
<p>上线三种模型，GPT‑5.2 Instant、GPT‑5.2 Thinking 和 GPT‑5.2 Pro。</p>
<h2 data-id="heading-0">国内直接使用Gemini 3 Pro</h2>
<p>谷歌浏览器访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nezhasoft.com" target="_blank" title="https://www.nezhasoft.com" ref="nofollow noopener noreferrer">www.nezhasoft.com</a></p>
<p><strong>私信哪吒，备注体验ai，领取体验码。</strong></p>
<p>包含GPT-5.2、GPT-5.2 Thinking、Gemini 3 Pro、Nano Banana Pro、Claude Sonnet 4.5、Codex、Sora2、Grok4.1等模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4d74d024e524002929b6106952496a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=YxABx6eZ2lW8pXAV7pRIfFcqC7U%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">排行榜SOTA水平</h2>
<h3 data-id="heading-2">1、通用测试</h3>
<p>GPT‑5.2 在通用智能、长上下文理解、智能体工具调用以及视觉方面都有显著提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18ee691cab5e412f913f6164404faf96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=%2F%2FoV9uxxAXRwqmNGqhOZXxftAM0%3D" alt="" loading="lazy"/></p>
<p>GPT‑5.2在制作电子表格、设计演示文稿、编写代码、识别图像、理解长文本上下文、使用工具以及处理复杂的多步骤项目方面表现更佳。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e5c9b6124574530b44afcde75e3225f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=5APl0n3iLlzcQ8O9m4U3FkYvzGs%3D" alt="幻觉率" loading="lazy"/></p>
<p>幻觉率</p>
<h3 data-id="heading-3">2、幻觉率</h3>
<p>OpenAI 最新发布的 GPT-5.2 整体更聪明、更可靠，尤其是在减少“胡说”方面进步明显。</p>
<p>GPT-5.2在商业、金融、法律等专业领域的错误率都比之前版本更低，内容更准确；学术写作也更稳健。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5839615d6c634554aafa0b84de48b1cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=zUs0HuYRLMEyxPjcXUIKp1AjTTY%3D" alt="AI 大模型能力评测" loading="lazy"/></p>
<p>AI 大模型能力评测</p>
<h3 data-id="heading-4">3、AI 大模型能力评测</h3>
<p>GPT 5.2 在 AI 大模型能力评测对比中，全部刷新SOTA。</p>
<p>在多项能力测试中全面领先上一代模型GPT 5.1。</p>
<p>它在科学题、数学竞赛、图表理解和抽象推理等高难度任务上都有大幅提升，例如数学拿到 100%，科学题达 92.4%。</p>
<p>与 Claude 和 Gemini 相比也表现更突出。</p>
<p>总体来说，GPT-5.2 推理更强、答题更准，更适合处理复杂专业问题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2d00374acca49299eb7181150aaa0e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=SilXT3hNE6clwL6CDuhVkPUNybk%3D" alt="ARC-AGI-1 智能推理排行榜" loading="lazy"/></p>
<p>ARC-AGI-1 智能推理排行榜</p>
<h3 data-id="heading-5">4、ARC-AGI-1 智能推理排行榜</h3>
<p>ARC-AGI-1 智能推理排行榜。横轴是单题成本，纵轴是解题成功率，用来比较各大AI模型在复杂抽象推理任务上的能力与效率。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2fec1ef3c6e416a9dd5c699e4a96ded~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=HIDYe9o%2F%2BB%2F8970jJdlj2JXp4kE%3D" alt="" loading="lazy"/></p>
<p>OpenAI 最新发布的 GPT-5.2（一代更比一代强）在成功率上接近人类水平，同时保持较高性价比，处于当前最强SOTA水平，反超Gemini 3 Pro、Claude Opus 4.5，成为现阶段，综合实力最强的AI大模型。</p>
<h2 data-id="heading-6">GPT-5.2初体验</h2>
<h3 data-id="heading-7">1、版本号</h3>
<p>你是什么模型，具体是什么版本号，知识截止日期是几号</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edceee6f05a045b0b0542cb37d3b151e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=0dukrPsJhu1dayKqbOBzbY9hgYU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">2、联网实时查询</h3>
<p>请联网查询：截至今天，OpenAI 最近一次官方发布的重要产品或模型更新是什么？请给出发布时间、核心变化点，并注明信息来源。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dc56cebbdce47528a984b1549be76df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=ysrcv3ExTWDzyEiYjgVGWPmiNKY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">3、写作</h3>
<p>GPT-5.2在写作方面相比GPT-5.1更聪明、更实用。</p>
<ol>
<li>它能理解更长、更复杂的文本，更好地抓住重点、组织结构，使文章逻辑更清晰、信息更准确;</li>
<li>在多步骤写作任务（比如报告、说明文）中表现更稳定，输出质量更高;</li>
<li>响应更快，提升整体写作效率。</li>
</ol>
<p>提示词：</p>
<p>全国一卷作文题目："民族魂" 材料内容： "他想要给孩子们唱上一段，可是心里直翻腾，开不了口。" ——老舍《鼓书艺人》 "假如我是一只鸟，我也应该用嘶哑的喉咙歌唱" ——艾青《我爱这土地》 "我要以带血的手和你们一一拥抱，因为一个民族已经起来" ——穆旦《赞美》 写作要求： 以上材料引发了你怎样的联想和思考？请写一篇文章。 要求选准角度，确定立意，明确文体，自拟标题；不要套作，不得抄袭；不得泄露个人信息；不少于800字。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dc9e09eea9e46da9d86214062d91cbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=Z8hdcLiRRkOCb6PZtONQ9DZkNRM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">4、编程</h3>
<p>GPT-5.2 在编程能力上相比 GPT-5.1 有明显提升：</p>
<ol>
<li>它理解更长、更复杂的代码和需求，生成代码更准确、逻辑更清晰；</li>
<li>执行多步骤编程任务（如调试、重构、自动测试等）更稳定、效率更高；</li>
<li>处理大型项目、跨文件依赖关系时错误更少，还能更好地配合工具链（如自动格式、lint、构建脚本等），让开发体验更顺畅。</li>
<li>整体编程输出质量和生产力都有显著提升。</li>
</ol>
<p>提示词：请用 Java 设计并实现一个支持高并发的电商微服务系统（基于 Spring Boot/Spring Cloud），要求包含订单、库存等服务，需解决分布式事务与超卖问题，使用 Redis/Kafka 进行异步解耦，并提供核心代码、配置及部署方案，同时说明高并发优化与容错限流设计思路。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56615940b82e43ebac00b3ea110fb826~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=MxYgAqr0Ec%2BPrSNKm%2BL%2BSNcYtyw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/badf64742dd341d0aea80c11ba899631~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=JCt15qVV5fYcBTGe%2BJn%2BrXKnteQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">5、多模态-识别图片</h3>
<p>GPT-5.2 在多模态能力方面相比 GPT-5.1 有明显提升：</p>
<ol>
<li>它能更精准理解和生成图像、图表等视觉内容，与文本结合得更好；</li>
<li>对复杂长文档、长上下文里的视觉＋语言信息处理更稳定；</li>
<li>整体多模态推理更快、更准确，减少误判和错误输出，使“看图+理解+输出”这类任务更流畅、更可靠。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f250df3d9c345c795fcd4a815c252d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=MTne0WaafPkgmG3EsX0dz1H%2FDFk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">6、上传文件</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb049225879e4392a5c0191df08ed6c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=9nFh2Bcb%2FW9lWTPb7ZosDWkj7S0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5095261e7b4747a79620671acd029f37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq5ZCS57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766136231&amp;x-signature=GP6coM%2BGquIa5SOmROsLRWL7oPA%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[稀土掘金联合中国信通院邀请您填写2025 AI4SE现状调研问卷]]></title>    <link>https://juejin.cn/post/7582785032851652671</link>    <guid>https://juejin.cn/post/7582785032851652671</guid>    <pubDate>2025-12-12T09:51:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582785032851652671" data-draft-id="7582791876366221350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="稀土掘金联合中国信通院邀请您填写2025 AI4SE现状调研问卷"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-12-12T09:51:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XCaptaino"/> <meta itemprop="url" content="https://juejin.cn/user/3052665287739005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            稀土掘金联合中国信通院邀请您填写2025 AI4SE现状调研问卷
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3052665287739005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XCaptaino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:51:43.000Z" title="Fri Dec 12 2025 09:51:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当前以大模型、智能体等技术为代表的新一代人工智能技术，正加速落地“千行百业”。软件作为数字转型的核心支撑与新技术落地的关键载体，软件行业的智能化变革尤为迫切，AI在软件生产全流程的价值凸显，持续推动软件研发范式转变，提升研发质效。然而，AI在软件研发部分环节虽已进入规模化落地阶段，但在技术落地成效对比、场景选择、成熟度对标等关键信息仍缺乏系统性梳理，企业在技术选型、路径规划上仍面临决策困惑，亟需行业提供科学指引。</p>
<p>长期以来中国信息通信研究院（简称“中国信通院”）人工智能研究所高度重视智能化软件工程（AI4SE）发展，联合中国人工智能产业发展联盟（AIIA）软件智能化委员会围绕技术研究、标准、报告、评估等多个维度开展工作，已建成《智能化软件工程技术和应用要求》《面向软件工程智能体技术和应用要求》《软件智能化成熟度模型》等标准体系，发布《智能化软件开发落地实践指南（2024年）》等研究报告，并开展行业现状调研，于今年4月联合发布了《AI4SE行业现状调查报告（2024年度）》，旨在为软件研发各阶段的智能化落地提供参考。</p>
<p>为进一步深入了解智能化软件工程发展现状、各阶段应用情况及未来落地趋势等行业关键数据，中国信通院人工智能研究所联合中国工商银行、中国邮政储蓄银行、交通银行、TRAE团队、腾讯、讯飞、百度、京东、软通动力、Testin云测、硅心科技、新炬网络、IT168、测试窝等单位共同发起2025年度智能化软件工程现状调研。调研对象为各行业中具有软件研发团队的企业。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fv.wjx.cn%2Fvm%2FQ07VNmj.aspx" target="_blank" title="https://v.wjx.cn/vm/Q07VNmj.aspx" ref="nofollow noopener noreferrer">立即填写</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fv.wjx.cn%2Fvm%2FQ07VNmj.aspx" target="_blank" title="https://v.wjx.cn/vm/Q07VNmj.aspx" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceff7f8699734477a857abc3b48d0c0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWENhcHRhaW5v:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138580&amp;x-signature=HMpHXoIZWvf1%2FruE6ZDUkI6DdG8%3D" alt="img_v3_02st_ef98b0da-188c-4472-9cde-166ad561140g.png" loading="lazy"/>
</a></p>
<p>本次调研问卷的收集截止日期为2026年1月15日，调研结果分析整理后，将于2026年以调研报告的形式正式发布，旨在为行业提供最新的发展趋势分析和决策参考，推动软件工程智能化转型升级。</p>
<p>欢迎各企业或专家参与问卷，有效填写者将有机会获得精美奖品。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e35e8615e9d44398b30111d41b690d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWENhcHRhaW5v:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138580&amp;x-signature=oHVAZuil1Pjn%2BQrGh9kkuRla8do%3D" alt="图片" loading="lazy"/></p>
<p>无论您所在企业在软件研发过程中，已经落地了智能化能力，还是处于试点探索阶段，我们都诚挚邀请您参与此次调研，分享您的真知灼见，您的宝贵经验将为行业的发展提供重要的参考价值。我们将对您提供的信息严格保密，并承诺仅用于报告的编写。期待您的积极参与，共同为软件行业的智能化发展贡献力量！</p>
<p><strong>联系方式：</strong> 中国信通院/人工智能研究所</p>
<ul>
<li>
<p>齐老师 18686962307(微信同号)</p>
</li>
<li>
<p>闫老师 13041008356(微信同号)</p>
</li>
<li>
<p>秦老师 13488684897(微信同号)</p>
</li>
</ul>
<h3 data-id="heading-0">关于中国人工智能产业发展联盟（AIIA）软件智能化委员会</h3>
<p>中国人工智能产业发展联盟（AIIA）软件智能化委员会是原AI4SE工作组的扩充与升级，在原有工作基础上继续深挖与扩展。一是持续深耕软件研发全流程智能化转型，二是推动软件产品形态智能创新，三是推动软件企业智能化转型升级，充分释放AI在软件领域的价值。AI4SE工作组已吸纳180+成员单位，覆盖金融、电信、软件等诸多行业，欢迎更多企业加入。</p>
<h3 data-id="heading-1"><strong>联系方式：</strong></h3>
<p>齐老师 18686962307(微信同号)</p>
<p>闫老师 13041008356(微信同号)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[突然发布！GPT-5.2深夜来袭，3个版本碾压人类专家，打工人该怎么选？]]></title>    <link>https://juejin.cn/post/7582791876366270502</link>    <guid>https://juejin.cn/post/7582791876366270502</guid>    <pubDate>2025-12-12T09:57:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582791876366270502" data-draft-id="7582777037863583794" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="突然发布！GPT-5.2深夜来袭，3个版本碾压人类专家，打工人该怎么选？"/> <meta itemprop="keywords" content="OpenAI,算法,AI编程"/> <meta itemprop="datePublished" content="2025-12-12T09:57:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="算家计算"/> <meta itemprop="url" content="https://juejin.cn/user/1426490793396571"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            突然发布！GPT-5.2深夜来袭，3个版本碾压人类专家，打工人该怎么选？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1426490793396571/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    算家计算
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:57:01.000Z" title="Fri Dec 12 2025 09:57:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>GPT5.2来了，三级模型矩阵精准戳中不同用户痛点。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1485241f440d485ab61136a5f3c2246c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg566X5a626K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138220&amp;x-signature=FE652%2FGzgDSKoHiS0y76n63hjgM%3D" alt="图片" loading="lazy"/>（图片源自网络，侵删）     </p>
<p>没有发布会，没有预热海报，12月12日凌晨，OpenAI突然扔出重磅炸弹——GPT-5.2系列模型低调上线，仅用一篇技术博客和CEO奥特曼的一句话宣告，就搅动了整个AI行业的神经。这不是一次常规迭代，而是谷歌 Gemini 3上月惊艳亮相后，OpenAI 拉响“红色警报”的背水一战，目标直指“专业知识工作第一模型”宝座。</p>
<p><strong>核心亮点：3个版本精准狙击不同场景</strong></p>
<p>OpenAI这次的产品策略堪称教科书级，直接拆分出三级模型矩阵，彻底告别“一刀切”：
Instant极速版：日常轻量任务首选，主打快响应 + 温暖语调，信息查询、翻译、简单文档撰写秒级反馈，完美替代 GPT-5.1 日常使用场景；
Thinking思考版：专业人士主力款，聚焦深度推理与复杂项目，长文档分析、图表解读、多步骤工具调用能力拉满，是智能体工作流的核心引擎；
Pro专业版：天花板级性能，面向科研与高端商业场景，错误率最低、推理链条最长，在金融建模、复杂编程等任务中达到人类顶尖专家水准。
目前模型已向Plus、Pro、Business等付费用户逐步开放，GPT-5.1将保留三个月后停用，API同步上线，缓存输入可享90%折扣。</p>
<p><strong>实测封神：这些数据颠覆认知</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b56c268a32fa452ea9acb1236b8dcd8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg566X5a626K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138220&amp;x-signature=Ftg5tiCJ27Ztihoq8EjzsNSUBr4%3D" alt="图片" loading="lazy"/>（图片源自网络，侵删）</p>
<p>OpenAI掏出的全新GDPval基准测试（覆盖9大行业44类职业），让GPT-5.2的实力无可辩驳：
1、Pro版本在74.1%的真实工作任务中，击败或打平人类专家，投行建模、PPT制作等场景效率提升11倍，成本却不足人类1%；
2、256k超长上下文（约数十万字）处理准确率接近100%，几百份合同、财报“大海捞针”不再遗漏关键信息；
3、编程能力刷新纪录，SWE-bench Pro得分达55.6%，能独立完成多语言复杂工程、调试生产代码，被开发者称为“智能体编程的最大飞跃”；数学推理实现“封神”，AIME 2025测试拿下满分，ARC-AGI-1抽象推理突破 90%，金融预测、数据分析能力再上台阶。</p>
<p>更惊喜的是视觉进化，Thinking版本对图表、仪表盘、UI界面的解读错误率大降50%，甚至能精准识别主板组件空间布局，彻底摆脱前代“胡言乱语”的尴尬。</p>
<p><strong>光鲜背后：短板与争议并存</strong></p>
<p>不过GPT-5.2并非完美无缺。OpenAI坦言，复杂任务生成可能需要数分钟，“慢思考”带来的延迟问题，在实时交互场景中堪称体验倒退。价格也让用户直呼“肉痛”：Instant和Thinking版每百万输入Token1.75美元、输出14美元，Pro版更是高达输入21美元、输出168美元，比Claude 4.5高阶版贵50%。更值得关注的是行业竞争格局的巨变。曾经OpenAI领先对手一年以上，如今GPT-5.2虽刷新多项纪录，但与Gemini 3、Claude 4.5的差距已缩小到几周。德国一位AI博主直言：“当所有模型都能拿高分，真正的价值在于工作流整合与实际应用能力。”</p>
<p><strong>行业解读：OpenAI 的战略定力与焦虑</strong></p>
<p>这次GPT-5.2的发布，暴露了OpenAI的双重心态：一方面，它不再执着于“全能第一”，而是聚焦“经济价值”，通过细分版本深耕专业场景，展现出成熟的商业战略；另一方面，三个月内两次迭代的速度，以及“红色警报”的内部动员，都暗示着对竞争的焦虑。对普通用户而言，Instant版足以应对日常需求，性价比最高；职场人、开发者优先冲Thinking版，长文档处理和编程能力能直接提升工作效率；企业客户则可关注Pro版的智能体协作能力，多工具编排、跨系统数据处理能大幅降低运营成本。目前GPT-5.2仍在分批开放中，付费用户可在ChatGPT内切换版本体验。面对3个版本，大家会怎么选择呢，欢迎在评论区留下你的看法！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端全栈进阶：使用 Node.js Crypto 模块处理 AES 加密与天远API数据聚合]]></title>    <link>https://juejin.cn/post/7582786655472893995</link>    <guid>https://juejin.cn/post/7582786655472893995</guid>    <pubDate>2025-12-12T09:28:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582786655472893995" data-draft-id="7582561515817746495" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端全栈进阶：使用 Node.js Crypto 模块处理 AES 加密与天远API数据聚合"/> <meta itemprop="keywords" content="API,大数据"/> <meta itemprop="datePublished" content="2025-12-12T09:28:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天远数科"/> <meta itemprop="url" content="https://juejin.cn/user/3511153810487162"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端全栈进阶：使用 Node.js Crypto 模块处理 AES 加密与天远API数据聚合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3511153810487162/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天远数科
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:28:16.000Z" title="Fri Dec 12 2025 09:28:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、在 BFF 层拦截多头借贷风险</h2>
<p>在现代金融科技架构中，<strong>Node.js</strong> 常驻于业务网关层，负责聚合数据并为前端提供响应。当用户在 APP 端发起借款申请时，网关层需要在毫秒级时间内判断用户的风险等级，从而决定是直接拒绝、弹窗警告还是进入人工审核。</p>
<p><strong>天远API</strong> 的“多头借贷行业风险版”，提供了区别于传统征信的<strong>精细化行为画像</strong>。它不仅能区分用户是在“银行”还是“P2P”平台借贷，还能识别出用户是否在“凌晨”进行高频申请。然而，该接口返回的 <code>List&lt;KV&gt;</code> 格式数据（如 <code>[{"riskCode": "41001", "riskCodeValue": "50"}]</code>）对前端展示并不友好。</p>
<p>本文将演示如何在 Node.js 环境中，利用原生 <code>crypto</code> 模块实现高安全的 AES-128-CBC 通信，并编写高效的数据转换（Transformer）函数，将<strong>天远API</strong>的原始数据清洗为业务友好的结构化 JSON。</p>
<h2 data-id="heading-1">二、API接口调用示例（Node.js版）</h2>
<h3 data-id="heading-2">1. 接口技术规范</h3>
<ul>
<li><strong>接口地址</strong>：<code>https://api.tianyuanapi.com/api/v1/DWBG7F3A</code></li>
<li><strong>HTTP方法</strong>：POST</li>
<li><strong>鉴权</strong>：Header 需携带 <code>Access-Id</code>。</li>
<li><strong>Payload</strong>：Body 中的 <code>data</code> 字段为 AES 加密并 Base64 编码后的字符串 1。</li>
</ul>
<h3 data-id="heading-3">2. Node.js 完整实现代码</h3>
<p>在 Node.js 中，我们使用 <code>axios</code> 发起请求，使用 <code>crypto</code> 处理加解密。特别注意：加密后的密文需要与 IV（初始化向量）拼接后再进行 Base64 编码。</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">'axios'</span>);
<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);

<span class="hljs-comment">// 配置信息</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CONFIG</span> = {
    <span class="hljs-attr">apiUrl</span>: <span class="hljs-string">'&lt;https://api.tianyuanapi.com/api/v1/DWBG7F3A&gt;'</span>,
    <span class="hljs-attr">accessId</span>: <span class="hljs-string">'YOUR_ACCESS_ID'</span>,      
    <span class="hljs-attr">accessKey</span>: <span class="hljs-string">'YOUR_ACCESS_KEY_HEX'</span> <span class="hljs-comment">// 16字节HEX字符串</span>
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">IndustryRiskService</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 确保 Key 为 Buffer</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span> = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable constant_">CONFIG</span>.<span class="hljs-property">accessKey</span>, <span class="hljs-string">'utf-8'</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">algorithm</span> = <span class="hljs-string">'aes-128-cbc'</span>;
    }

    <span class="hljs-comment">// --- AES 加密 ---</span>
    <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">dataObj</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> iv = crypto.<span class="hljs-title function_">randomBytes</span>(<span class="hljs-number">16</span>); <span class="hljs-comment">// 随机生成IV</span>
            <span class="hljs-keyword">const</span> plaintext = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(dataObj);
            
            <span class="hljs-keyword">const</span> cipher = crypto.<span class="hljs-title function_">createCipheriv</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">algorithm</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>, iv);
            <span class="hljs-keyword">let</span> encrypted = cipher.<span class="hljs-title function_">update</span>(plaintext, <span class="hljs-string">'utf8'</span>, <span class="hljs-string">'base64'</span>);
            encrypted += cipher.<span class="hljs-title function_">final</span>(<span class="hljs-string">'base64'</span>);
            
            <span class="hljs-comment">// 拼接 IV + 密文 -&gt; Base64</span>
            <span class="hljs-keyword">const</span> ivBuffer = iv;
            <span class="hljs-keyword">const</span> encryptedBuffer = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(encrypted, <span class="hljs-string">'base64'</span>);
            <span class="hljs-keyword">const</span> combinedBuffer = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">concat</span>([ivBuffer, encryptedBuffer]);
            
            <span class="hljs-keyword">return</span> combinedBuffer.<span class="hljs-title function_">toString</span>(<span class="hljs-string">'base64'</span>);
        } <span class="hljs-keyword">catch</span> (err) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Encrypt Error:'</span>, err.<span class="hljs-property">message</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">// --- AES 解密 ---</span>
    <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">base64Str</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> combinedBuffer = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(base64Str, <span class="hljs-string">'base64'</span>);
            <span class="hljs-keyword">const</span> iv = combinedBuffer.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>);       <span class="hljs-comment">// 提取前16字节 IV</span>
            <span class="hljs-keyword">const</span> content = combinedBuffer.<span class="hljs-title function_">slice</span>(<span class="hljs-number">16</span>);     <span class="hljs-comment">// 提取剩余密文</span>
            
            <span class="hljs-keyword">const</span> decipher = crypto.<span class="hljs-title function_">createDecipheriv</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">algorithm</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>, iv);
            <span class="hljs-keyword">let</span> decrypted = decipher.<span class="hljs-title function_">update</span>(content, <span class="hljs-string">'base64'</span>, <span class="hljs-string">'utf8'</span>);
            decrypted += decipher.<span class="hljs-title function_">final</span>(<span class="hljs-string">'utf8'</span>);
            
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(decrypted);
        } <span class="hljs-keyword">catch</span> (err) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Decrypt Error:'</span>, err.<span class="hljs-property">message</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">// --- 数据清洗 Transformer ---</span>
    <span class="hljs-comment">// 将数组 [{"riskCode": "41001", "riskCodeValue": "50"}] 转换为对象 {"41001": 50}</span>
    <span class="hljs-title function_">transformReport</span>(<span class="hljs-params">rawData</span>) {
        <span class="hljs-keyword">const</span> reportList = rawData[<span class="hljs-string">'riskInfo_report_v3.1'</span>] || [];
        <span class="hljs-keyword">return</span> reportList.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, item</span>) =&gt;</span> {
            acc[item.<span class="hljs-property">riskCode</span>] = <span class="hljs-title class_">Number</span>(item.<span class="hljs-property">riskCodeValue</span>); <span class="hljs-comment">// 转为数字方便计算</span>
            <span class="hljs-keyword">return</span> acc;
        }, {});
    }

    <span class="hljs-comment">// --- 业务调用主流程 ---</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">queryRisk</span>(<span class="hljs-params">userParams</span>) {
        <span class="hljs-keyword">const</span> encryptedData = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">encrypt</span>(userParams);
        <span class="hljs-keyword">if</span> (!encryptedData) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> url = <span class="hljs-string">`<span class="hljs-subst">${CONFIG.apiUrl}</span>?t=<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
            <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(url, { <span class="hljs-attr">data</span>: encryptedData }, {
                <span class="hljs-attr">headers</span>: { 
                    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
                    <span class="hljs-string">'Access-Id'</span>: <span class="hljs-variable constant_">CONFIG</span>.<span class="hljs-property">accessId</span> 
                }
            });

            <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> === <span class="hljs-number">0</span>) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'API调用成功，解析数据...'</span>);
                <span class="hljs-keyword">const</span> rawResult = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">decrypt</span>(res.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>);
                
                <span class="hljs-comment">// 执行数据清洗</span>
                <span class="hljs-keyword">const</span> cleanData = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">transformReport</span>(rawResult);
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">analyzeRisk</span>(cleanData);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'API业务错误:'</span>, res.<span class="hljs-property">data</span>.<span class="hljs-property">message</span>);
            }
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'网络请求失败:'</span>, error.<span class="hljs-property">message</span>);
        }
    }

    <span class="hljs-comment">// --- 简单的风控逻辑 ---</span>
    <span class="hljs-title function_">analyzeRisk</span>(<span class="hljs-params">data</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- 用户风险画像 ---'</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`多头借贷通用分 (41001): <span class="hljs-subst">${data[<span class="hljs-string">'41001'</span>]}</span>`</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`银行系借贷分 (41005): <span class="hljs-subst">${data[<span class="hljs-string">'41005'</span>]}</span>`</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`互金系借贷分 (41004): <span class="hljs-subst">${data[<span class="hljs-string">'41004'</span>]}</span>`</span>);
        
        <span class="hljs-comment">// 示例规则：如果是深夜申请且互金分高</span>
        <span class="hljs-keyword">if</span> (data[<span class="hljs-string">'40105'</span>] &gt; <span class="hljs-number">0</span> &amp;&amp; data[<span class="hljs-string">'41004'</span>] &gt; <span class="hljs-number">60</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'【高危预警】检测到“深夜高频借贷”行为，建议拦截！'</span>);
        }
    }
}

<span class="hljs-comment">// 运行示例</span>
<span class="hljs-keyword">const</span> service = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndustryRiskService</span>();
service.<span class="hljs-title function_">queryRisk</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"王五"</span>,
    <span class="hljs-attr">id_card</span>: <span class="hljs-string">"310101199001011234"</span>,
    <span class="hljs-attr">mobile_no</span>: <span class="hljs-string">"13800138000"</span>
});
</code></pre>
<h2 data-id="heading-4">三、核心数据结构解析</h2>
<p>对于 Node.js 开发者，处理<strong>天远API</strong>返回的数据时，最核心的工作是将 <code>Array</code> 转换为 <code>Object</code> (Map)。</p>
<h3 data-id="heading-5">1. 原始数据困境</h3>
<p>API 返回的数据是为了传输效率优化的 2：</p>
<p>JavaScript</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"riskInfo_report_v3.1"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"riskCode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"41001"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"riskCodeValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"43"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 需要遍历才能找到</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"riskCode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"40105"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"riskCodeValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5"</span> <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<h3 data-id="heading-6">2. 清洗后的数据优势</h3>
<p>通过 <code>reduce</code> 函数转换后，我们可以直接通过 Key 访问，这在编写风控规则引擎（Rule Engine）时至关重要：</p>
<p>JavaScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin">{
    <span class="hljs-string">"41001"</span>: <span class="hljs-number">43</span>,
    <span class="hljs-string">"40105"</span>: <span class="hljs-number">5</span>,
    <span class="hljs-string">"41005"</span>: <span class="hljs-number">34</span>
}
<span class="hljs-comment">// 规则书写变得极其简单：</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>[<span class="hljs-string">'41001'</span>] &gt; <span class="hljs-number">80</span>) <span class="hljs-keyword">return</span> reject();
</code></pre>
<h2 data-id="heading-7">四、字段详解（Node.js 实战关注点）</h2>
<p>以下字段是开发 BFF 层接口时，最常需要 透传给前端 或 用于 网关拦截 的关键指标。</p>
<h3 data-id="heading-8">1. 宏观评分（用于前端展示或分流）</h3>





























<table><thead><tr><th><strong>字段 Code</strong></th><th><strong>字段含义</strong></th><th><strong>说明</strong></th><th><strong>Node.js 处理建议</strong></th></tr></thead><tbody><tr><td><strong>41001</strong></td><td>多头申请通用分</td><td>0-100分 3</td><td>可直接透传给信审员后台展示。</td></tr><tr><td><strong>41002</strong></td><td>短周期多头共债子分</td><td>0-100分，窗口期7天-3个月 4</td><td>用于判断是否“近期突发缺钱”。</td></tr><tr><td><strong>41005</strong></td><td><strong>银行多头共债子分</strong></td><td>0-100分 5</td><td>银行系数据的权重，通常代表资质上限。</td></tr></tbody></table>
<h3 data-id="heading-9">2. 行为特征（用于自动拦截）</h3>





























<table><thead><tr><th><strong>字段 Code</strong></th><th><strong>字段含义</strong></th><th><strong>阈值参考</strong></th><th><strong>业务逻辑</strong></th></tr></thead><tbody><tr><td><strong>40105</strong></td><td><strong>7天总申请夜晚次数</strong></td><td>&gt; 0 即关注</td><td>夜间（0点-7点）申请是典型的高危欺诈特征 6。</td></tr><tr><td><strong>40161</strong></td><td>7天相对过去30天新增平台数</td><td>&gt; 3 即预警</td><td>突然新增大量平台（撸口子），大概率是将要“跑路”的前兆 7。</td></tr><tr><td><strong>40004</strong></td><td>7天内互金申请次数</td><td>High</td><td>频繁申请P2P/网贷，意味着银行渠道已拒绝或额度耗尽 8。</td></tr></tbody></table>
<h2 data-id="heading-10">五、应用价值分析</h2>
<p>在 Node.js 架构中集成<strong>天远API</strong>的行业风险版，主要解决以下痛点：</p>
<ol>
<li>
<p>分流策略（Routing）：</p>
<p>在网关层，根据 41005 (银行分) 和 41004 (非银分) 的比值，将流量分发给不同的资金方。</p>
<ul>
<li><em>银行分高</em> -&gt; 路由至低息、大额资金方接口。</li>
<li><em>非银分高</em> -&gt; 路由至高息、小额助贷机构接口。</li>
</ul>
</li>
<li>
<p>反欺诈中间件：</p>
<p>开发一个 Express/Koa 中间件，在请求进入核心业务逻辑前，先调用 API 校验 40105 (夜间申请次数)。如果发现该指标异常，直接在中间件层返回 "Risk Reject"，无需消耗后端复杂的授信计算资源，保护核心系统。</p>
</li>
<li>
<p>用户画像补全：</p>
<p>利用 Node.js 的高并发特性，批量清洗存量用户的 40037 (360天总申请次数) 和 40038 (360天银行申请次数) 9，计算出用户的“银行偏好度”，用于精准营销。</p>
</li>
</ol>
<h2 data-id="heading-11">六、总结</h2>
<p><strong>天远API</strong> 的多头借贷行业风险版，通过分行业、分时段的维度，为风控提供了“显微镜”级别的观察能力。</p>
<p>对于 Node.js 开发者，虽然需要处理 AES 加密和 Buffer 拼接的底层细节，但通过简单的封装（如本文的 Service 类），即可轻松获得强大的数据清洗能力。建议开发者在 BFF 层重点关注 <strong>夜间申请</strong> (<code>40105</code>) 和 <strong>新增平台数</strong> (<code>40161</code>) 这两个“杀手级”指标，它们往往是识别欺诈用户最有效的手段。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大疆不同任务类型执行逻辑，上云API源码分析]]></title>    <link>https://juejin.cn/post/7582809606066339866</link>    <guid>https://juejin.cn/post/7582809606066339866</guid>    <pubDate>2025-12-12T09:31:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582809606066339866" data-draft-id="7582809606066323482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大疆不同任务类型执行逻辑，上云API源码分析"/> <meta itemprop="keywords" content="后端,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-12T09:31:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="深紫色的三北六号"/> <meta itemprop="url" content="https://juejin.cn/user/4101625032221256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大疆不同任务类型执行逻辑，上云API源码分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4101625032221256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    深紫色的三北六号
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:31:45.000Z" title="Fri Dec 12 2025 09:31:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">大疆不同任务类型执行逻辑，上云API源码分析</h2>
<p>大疆司空2中有不同的任务类型：立即任务、定时任务、条件任务。
最初我们实现时，选择的是用Quartz创建定时任务，调用API中executeFlightTask接口实现任务下发。
在功能实现之后，随着对API的深入了解，发现大疆API中有相关的任务下发逻辑。
当时只看了实现逻辑，因为活比较多，加上懒，就一直拖到现在。
<strong>本文是对源码的学习总结。</strong></p>
<p>所有任务下发的逻辑都从**publishFlightTask()**方法开始。
com.dji.sample.wayline.service.impl.FlightTaskServiceImpl#publishFlightTask</p>
<h3 data-id="heading-1">立即任务</h3>
<ol>
<li><code>fillImmediateTime(param)</code>方法，如果是 <strong>“立即任务（IMMEDIATE）”</strong>，就把任务的执行日期<code>taskDays</code>与执行时间段<code>taskPeriods</code>强制设置为当前服务器时间。</li>
<li>由于<code>taskDays = [now]</code>，<code>taskPeriods = [ [now]</code> ]，所以只会进入循环一次，并且beginTime = 当前毫秒时间点，endTime = beginTime。</li>
<li>创建一条飞行任务记录存到数据库中---- <code>waylineJobOpt</code>。</li>
<li>调用<code>publishOneFlight()</code>方法发布任务</li>
</ol>
<p><strong>[1]publishFlightTask</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * 发布飞行任务的核心入口方法。
     * 功能：
     * 1. 处理立即任务（IMMEDIATE），强制以服务器当前时间作为任务执行时间；
     * 2. 根据用户提交的任务日期（taskDays）与时间段（taskPeriods），
     *    生成多个 beginTime/endTime 的任务实例；
     * 3. 为每个时间段创建一条 WaylineJob（航线任务记录）；
     * 4. 若为条件任务，写入对应的触发条件；
     * 5. 立即调用 publishOneFlightTask 将任务下发给飞行设备（Dock）；
     * 6. 如果任何一次下发失败，则返回失败并终止流程；
     * 7. 所有任务下发成功后返回成功响应。
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> HttpResultResponse <span class="hljs-title function_">publishFlightTask</span><span class="hljs-params">(CreateJobParam param, CustomClaim customClaim)</span> <span class="hljs-keyword">throws</span> SQLException {
        fillImmediateTime(param);

        <span class="hljs-comment">//立即任务只会进入循环一次</span>
        <span class="hljs-keyword">for</span> (Long taskDay : param.getTaskDays()) {
            <span class="hljs-type">LocalDate</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> LocalDate.ofInstant(Instant.ofEpochSecond(taskDay), ZoneId.systemDefault());
            <span class="hljs-keyword">for</span> (List&lt;Long&gt; taskPeriod : param.getTaskPeriods()) {
                <span class="hljs-comment">//立即任务的beginTime = endTime = 当前毫秒时间</span>
                <span class="hljs-type">long</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, LocalTime.ofInstant(Instant.ofEpochSecond(taskPeriod.get(<span class="hljs-number">0</span>)), ZoneId.systemDefault()))
                        .atZone(ZoneId.systemDefault()).toInstant().toEpochMilli();
                <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> taskPeriod.size() &gt; <span class="hljs-number">1</span> ?
                        LocalDateTime.of(date, LocalTime.ofInstant(Instant.ofEpochSecond(taskPeriod.get(<span class="hljs-number">1</span>)), ZoneId.systemDefault()))
                                .atZone(ZoneId.systemDefault()).toInstant().toEpochMilli() : beginTime;
                <span class="hljs-comment">//立即任务直接跳过这个判断</span>
                <span class="hljs-keyword">if</span> (TaskTypeEnum.IMMEDIATE != param.getTaskType() &amp;&amp; endTime &lt; System.currentTimeMillis()) {
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-comment">//创建一条飞行任务记录</span>
                Optional&lt;WaylineJobDTO&gt; waylineJobOpt = waylineJobService.createWaylineJob(param, customClaim.getWorkspaceId(), customClaim.getUsername(), beginTime, endTime);
                <span class="hljs-keyword">if</span> (waylineJobOpt.isEmpty()) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">"Failed to create wayline job."</span>);
                }
                <span class="hljs-type">WaylineJobDTO</span> <span class="hljs-variable">waylineJob</span> <span class="hljs-operator">=</span> waylineJobOpt.get();
                
                <span class="hljs-comment">//立即任务直接跳过这个方法</span>
                <span class="hljs-comment">// If it is a conditional task type, add conditions to the job parameters.</span>
                addConditions(waylineJob, param, beginTime, endTime);

                <span class="hljs-comment">//发布任务</span>
                <span class="hljs-type">HttpResultResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.publishOneFlightTask(waylineJob);
                <span class="hljs-keyword">if</span> (HttpResultResponse.CODE_SUCCESS != response.getCode()) {
                    <span class="hljs-keyword">return</span> response;
                }
            }
        }
        <span class="hljs-keyword">return</span> HttpResultResponse.success();
    }
    
    <span class="hljs-comment">/**
     * 如果任务类型为 IMMEDIATE（立即任务），则忽略用户传入的任何日期和时间段，
     * 将任务的执行日期（taskDays）与执行时间段（taskPeriods）强制设置为当前服务器时间。
     * 立即任务必须由服务器当前时间触发，不允许由客户端自定义时间。
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fillImmediateTime</span><span class="hljs-params">(CreateJobParam param)</span> {
        <span class="hljs-keyword">if</span> (TaskTypeEnum.IMMEDIATE != param.getTaskType()) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis() / <span class="hljs-number">1000</span>;
        param.setTaskDays(List.of(now));
        param.setTaskPeriods(List.of(List.of(now)));
    }
 
</code></pre>
<ol start="5">
<li><code>deviceRedisService.checkDeviceOnline</code>判断机场是否在线</li>
<li>调用<code>prepareFlightTask</code>方法，下发飞行准备指令</li>
<li>调用<code>executeFlightTask</code>方法，下发飞行任务执行指令</li>
</ol>
<p><strong>[2]publishOneFlight</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> HttpResultResponse <span class="hljs-title function_">publishOneFlightTask</span><span class="hljs-params">(WaylineJobDTO waylineJob)</span> <span class="hljs-keyword">throws</span> SQLException {

        <span class="hljs-comment">//判断机场是否在线</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isOnline</span> <span class="hljs-operator">=</span> deviceRedisService.checkDeviceOnline(waylineJob.getDockSn());
        <span class="hljs-keyword">if</span> (!isOnline) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Dock is offline."</span>);
        }

        <span class="hljs-comment">//下发飞行准备指令</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.prepareFlightTask(waylineJob);
        <span class="hljs-keyword">if</span> (!isSuccess) {
            <span class="hljs-keyword">return</span> HttpResultResponse.error(<span class="hljs-string">"Failed to prepare job."</span>);
        }

        <span class="hljs-comment">//下发立即任务执行指令</span>
        <span class="hljs-comment">// Issue an immediate task execution command.</span>
        <span class="hljs-keyword">if</span> (TaskTypeEnum.IMMEDIATE == waylineJob.getTaskType()) {
            <span class="hljs-keyword">if</span> (!executeFlightTask(waylineJob.getWorkspaceId(), waylineJob.getJobId())) {
                <span class="hljs-keyword">return</span> HttpResultResponse.error(<span class="hljs-string">"Failed to execute job."</span>);
            }
        }

        ..............(省略部分代码)

        <span class="hljs-keyword">return</span> HttpResultResponse.success();
    }

</code></pre>
<h3 data-id="heading-2">定时任务</h3>
<ol>
<li>遍历定时任务设置中每一天的每一个时间段</li>
<li>忽略已经过期的时间段</li>
<li>创建waylineJob并存到数据库中。</li>
<li>调用<code>publishOneFlightTask()</code>发布任务</li>
</ol>
<p><strong>[1]publishFlightTask</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> HttpResultResponse <span class="hljs-title function_">publishFlightTask</span><span class="hljs-params">(CreateJobParam param, CustomClaim customClaim)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">//定时任务在这个方法中直接返回，不会进行任何处理</span>
        fillImmediateTime(param);

        <span class="hljs-comment">//遍历每一天每一个时间段</span>
        <span class="hljs-keyword">for</span> (Long taskDay : param.getTaskDays()) {
            <span class="hljs-type">LocalDate</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> LocalDate.ofInstant(Instant.ofEpochSecond(taskDay), ZoneId.systemDefault());
            <span class="hljs-keyword">for</span> (List&lt;Long&gt; taskPeriod : param.getTaskPeriods()) {
                <span class="hljs-type">long</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, LocalTime.ofInstant(Instant.ofEpochSecond(taskPeriod.get(<span class="hljs-number">0</span>)), ZoneId.systemDefault()))
                        .atZone(ZoneId.systemDefault()).toInstant().toEpochMilli();
                <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> taskPeriod.size() &gt; <span class="hljs-number">1</span> ?
                        LocalDateTime.of(date, LocalTime.ofInstant(Instant.ofEpochSecond(taskPeriod.get(<span class="hljs-number">1</span>)), ZoneId.systemDefault()))
                                .atZone(ZoneId.systemDefault()).toInstant().toEpochMilli() : beginTime;
                
                <span class="hljs-comment">//忽略已经过期的时间段</span>
                <span class="hljs-keyword">if</span> (TaskTypeEnum.IMMEDIATE != param.getTaskType() &amp;&amp; endTime &lt; System.currentTimeMillis()) {
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-comment">//创建waylineJob</span>
                Optional&lt;WaylineJobDTO&gt; waylineJobOpt = waylineJobService.createWaylineJob(param, customClaim.getWorkspaceId(), customClaim.getUsername(), beginTime, endTime);
                <span class="hljs-keyword">if</span> (waylineJobOpt.isEmpty()) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">"Failed to create wayline job."</span>);
                }
                <span class="hljs-type">WaylineJobDTO</span> <span class="hljs-variable">waylineJob</span> <span class="hljs-operator">=</span> waylineJobOpt.get();
                
                <span class="hljs-comment">//不是条件任务，进入这个方法会直接返回。</span>
                <span class="hljs-comment">// If it is a conditional task type, add conditions to the job parameters.</span>
                addConditions(waylineJob, param, beginTime, endTime);

                <span class="hljs-comment">//发布任务</span>
                <span class="hljs-type">HttpResultResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.publishOneFlightTask(waylineJob);
                <span class="hljs-keyword">if</span> (HttpResultResponse.CODE_SUCCESS != response.getCode()) {
                    <span class="hljs-keyword">return</span> response;
                }
            }
        }
        <span class="hljs-keyword">return</span> HttpResultResponse.success();
    }
</code></pre>
<ol start="5">
<li><code>deviceRedisService.checkDeviceOnline</code>检查机场是否在线。</li>
<li>调用<code>prepareFlightTask</code>方法，下发飞行准备指令.</li>
<li>把定时任务添加到Redis的一个Sorted Set（有序集合）里，用任务的开始时间作为排序依据。</li>
</ol>
<p><strong>[2]publishOneFlightTask</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> HttpResultResponse <span class="hljs-title function_">publishOneFlightTask</span><span class="hljs-params">(WaylineJobDTO waylineJob)</span> <span class="hljs-keyword">throws</span> SQLException {

        <span class="hljs-comment">//检查机场是否在线</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isOnline</span> <span class="hljs-operator">=</span> deviceRedisService.checkDeviceOnline(waylineJob.getDockSn());
        <span class="hljs-keyword">if</span> (!isOnline) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Dock is offline."</span>);
        }

        <span class="hljs-comment">//下发飞行准备指令</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.prepareFlightTask(waylineJob);
        <span class="hljs-keyword">if</span> (!isSuccess) {
            <span class="hljs-keyword">return</span> HttpResultResponse.error(<span class="hljs-string">"Failed to prepare job."</span>);
        }
        
        ..........(省略部分代码)
        
        <span class="hljs-comment">//把定时任务添加到Redis有序集合里，用开始时间排序</span>
        <span class="hljs-keyword">if</span> (TaskTypeEnum.TIMED == waylineJob.getTaskType()) {
            <span class="hljs-comment">// key: wayline_job_timed, value: {workspace_id}:{dock_sn}:{job_id}</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isAdd</span> <span class="hljs-operator">=</span> RedisOpsUtils.zAdd(RedisConst.WAYLINE_JOB_TIMED_EXECUTE,
                    waylineJob.getWorkspaceId() + RedisConst.DELIMITER + waylineJob.getDockSn() + RedisConst.DELIMITER + waylineJob.getJobId(),
                    waylineJob.getBeginTime().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());
            <span class="hljs-keyword">if</span> (!isAdd) {
                <span class="hljs-keyword">return</span> HttpResultResponse.error(<span class="hljs-string">"Failed to create scheduled job."</span>);
            }
        }

        <span class="hljs-keyword">return</span> HttpResultResponse.success();
    }
</code></pre>
<ol start="8">
<li><code>checkScheduledJob</code>定时任务，每<code>5s</code>对 Redis 中的定时任务集合扫描一次。</li>
<li>获取最早的定时任务，拆解任务信息。</li>
<li>如果任务信息开始比现在早<code>30s (offset)</code>以上，认为任务过期，删除 Redis 队列中的任务，更新任务状态为失败。</li>
<li>如果任务执行时间在<code>now + offset</code>这个时间区间内，调用<code>executeFlightTask</code>下发执行任务命令，且无论成功或失败，都从 Redis 队列中删除任务信息。</li>
</ol>
<p><strong>[3]checkScheduledJob定时任务</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Scheduled(initialDelay = 10, fixedRate = 5, timeUnit = TimeUnit.SECONDS)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkScheduledJob</span><span class="hljs-params">()</span> {
        
        <span class="hljs-comment">//获取最早的定时任务，并拆解任务信息</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">jobIdValue</span> <span class="hljs-operator">=</span> RedisOpsUtils.zGetMin(RedisConst.WAYLINE_JOB_TIMED_EXECUTE);
        <span class="hljs-keyword">if</span> (Objects.isNull(jobIdValue)) {
            <span class="hljs-keyword">return</span>;
        }
        log.info(<span class="hljs-string">"Check the timed tasks of the wayline. {}"</span>, jobIdValue);
        <span class="hljs-comment">// format: {workspace_id}:{dock_sn}:{job_id}</span>
        String[] jobArr = String.valueOf(jobIdValue).split(RedisConst.DELIMITER);
        <span class="hljs-type">double</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> RedisOpsUtils.zScore(RedisConst.WAYLINE_JOB_TIMED_EXECUTE, jobIdValue);
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> <span class="hljs-number">30_000</span>;

        
        <span class="hljs-comment">//任务信息开始比现在早30s以上，认为任务过期，删除Redis队列中的任务，更新任务状态为失败。</span>
        <span class="hljs-comment">// Expired tasks are deleted directly.</span>
        <span class="hljs-keyword">if</span> (time &lt; now - offset) {
            RedisOpsUtils.zRemove(RedisConst.WAYLINE_JOB_TIMED_EXECUTE, jobIdValue);
            waylineJobService.updateJob(WaylineJobDTO.builder()
                    .jobId(jobArr[<span class="hljs-number">2</span>])
                    .status(WaylineJobStatusEnum.FAILED.getVal())
                    .executeTime(LocalDateTime.now())
                    .completedTime(LocalDateTime.now())
                    .code(HttpStatus.SC_REQUEST_TIMEOUT).build());
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">//判断任务执行时间在now + offset这个时间区间内，下发执行任务命令。</span>
        <span class="hljs-keyword">if</span> (now &lt;= time &amp;&amp; time &lt;= now + offset) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-built_in">this</span>.executeFlightTask(jobArr[<span class="hljs-number">0</span>], jobArr[<span class="hljs-number">2</span>]);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.info(<span class="hljs-string">"The scheduled task delivery failed."</span>);
                waylineJobService.updateJob(WaylineJobDTO.builder()
                        .jobId(jobArr[<span class="hljs-number">2</span>])
                        .status(WaylineJobStatusEnum.FAILED.getVal())
                        .executeTime(LocalDateTime.now())
                        .completedTime(LocalDateTime.now())
                        .code(HttpStatus.SC_INTERNAL_SERVER_ERROR).build());
            } <span class="hljs-keyword">finally</span> {
                RedisOpsUtils.zRemove(RedisConst.WAYLINE_JOB_TIMED_EXECUTE, jobIdValue);
            }
        }
    }
</code></pre>
<h3 data-id="heading-3">条件任务</h3>
<ol>
<li>条件任务和定时任务的 1-3步相同</li>
<li>同上</li>
<li>同上</li>
<li>调用<code>addConditions()</code>方法,设置<code>readyConditions(预备条件)、executableConditions(执行条件)</code>，然后将任务存入Redis，</li>
</ol>
<pre><code class="hljs language-css" lang="css">wayline_job_condition_prepare（zset） → 按开始时间排序
wayline_job_condition:{jobId} → 任务详情。
</code></pre>
<ol start="5">
<li>调用<code>publishOneFlightTask()</code>发布任务</li>
</ol>
<p><strong>[1]publishFlightTask</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> HttpResultResponse <span class="hljs-title function_">publishFlightTask</span><span class="hljs-params">(CreateJobParam param, CustomClaim customClaim)</span> <span class="hljs-keyword">throws</span> SQLException {
        fillImmediateTime(param);

        <span class="hljs-keyword">for</span> (Long taskDay : param.getTaskDays()) {
            <span class="hljs-type">LocalDate</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> LocalDate.ofInstant(Instant.ofEpochSecond(taskDay), ZoneId.systemDefault());
            <span class="hljs-keyword">for</span> (List&lt;Long&gt; taskPeriod : param.getTaskPeriods()) {
                <span class="hljs-type">long</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, LocalTime.ofInstant(Instant.ofEpochSecond(taskPeriod.get(<span class="hljs-number">0</span>)), ZoneId.systemDefault()))
                        .atZone(ZoneId.systemDefault()).toInstant().toEpochMilli();
                <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> taskPeriod.size() &gt; <span class="hljs-number">1</span> ?
                        LocalDateTime.of(date, LocalTime.ofInstant(Instant.ofEpochSecond(taskPeriod.get(<span class="hljs-number">1</span>)), ZoneId.systemDefault()))
                                .atZone(ZoneId.systemDefault()).toInstant().toEpochMilli() : beginTime;
                <span class="hljs-keyword">if</span> (TaskTypeEnum.IMMEDIATE != param.getTaskType() &amp;&amp; endTime &lt; System.currentTimeMillis()) {
                    <span class="hljs-keyword">continue</span>;
                }

                Optional&lt;WaylineJobDTO&gt; waylineJobOpt = waylineJobService.createWaylineJob(param, customClaim.getWorkspaceId(), customClaim.getUsername(), beginTime, endTime);
                <span class="hljs-keyword">if</span> (waylineJobOpt.isEmpty()) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">"Failed to create wayline job."</span>);
                }
                <span class="hljs-type">WaylineJobDTO</span> <span class="hljs-variable">waylineJob</span> <span class="hljs-operator">=</span> waylineJobOpt.get();
                
                <span class="hljs-comment">//条件任务，添加条件参数！！</span>
                <span class="hljs-comment">// If it is a conditional task type, add conditions to the job parameters.</span>
                addConditions(waylineJob, param, beginTime, endTime);

                <span class="hljs-type">HttpResultResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.publishOneFlightTask(waylineJob);
                <span class="hljs-keyword">if</span> (HttpResultResponse.CODE_SUCCESS != response.getCode()) {
                    <span class="hljs-keyword">return</span> response;
                }
            }
        }
        <span class="hljs-keyword">return</span> HttpResultResponse.success();
    }
    
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addConditions</span><span class="hljs-params">(WaylineJobDTO waylineJob, CreateJobParam param, Long beginTime, Long endTime)</span> {
        <span class="hljs-keyword">if</span> (TaskTypeEnum.CONDITIONAL != param.getTaskType()) {
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">//填入readyConditions(预备条件)、executableConditions(执行条件)</span>
        waylineJob.setConditions(
                WaylineTaskConditionDTO.builder()
                        .executableConditions(Objects.nonNull(param.getMinStorageCapacity()) ?
                                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutableConditions</span>().setStorageCapacity(param.getMinStorageCapacity()) : <span class="hljs-literal">null</span>)
                        .readyConditions(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ReadyConditions</span>()
                                .setBatteryCapacity(param.getMinBatteryCapacity())
                                .setBeginTime(beginTime)
                                .setEndTime(endTime))
                        .build());

        waylineRedisService.setConditionalWaylineJob(waylineJob);
        <span class="hljs-comment">// key: wayline_job_condition, value: {workspace_id}:{dock_sn}:{job_id}</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isAdd</span> <span class="hljs-operator">=</span> waylineRedisService.addPrepareConditionalWaylineJob(waylineJob);
        <span class="hljs-keyword">if</span> (!isAdd) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Failed to create conditional job."</span>);
        }
    }
    
    
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">addPrepareConditionalWaylineJob</span><span class="hljs-params">(WaylineJobDTO waylineJob)</span> {
        <span class="hljs-keyword">if</span> (Objects.isNull(waylineJob.getBeginTime())) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-comment">// value: {workspace_id}:{dock_sn}:{job_id}</span>
        <span class="hljs-keyword">return</span> RedisOpsUtils.zAdd(RedisConst.WAYLINE_JOB_CONDITION_PREPARE,
                waylineJob.getWorkspaceId() + RedisConst.DELIMITER + waylineJob.getDockSn() + RedisConst.DELIMITER + waylineJob.getJobId(),
                waylineJob.getBeginTime().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());
    }
</code></pre>
<ol start="6">
<li><code>deviceRedisService.checkDeviceOnline</code>检查机场是否在线。</li>
<li>调用<code>prepareFlightTask</code>方法，下发飞行准备指令。</li>
</ol>
<p><strong>[2]publishOneFlightTask</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> HttpResultResponse <span class="hljs-title function_">publishOneFlightTask</span><span class="hljs-params">(WaylineJobDTO waylineJob)</span> <span class="hljs-keyword">throws</span> SQLException {

        <span class="hljs-type">boolean</span> <span class="hljs-variable">isOnline</span> <span class="hljs-operator">=</span> deviceRedisService.checkDeviceOnline(waylineJob.getDockSn());
        <span class="hljs-keyword">if</span> (!isOnline) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Dock is offline."</span>);
        }

        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.prepareFlightTask(waylineJob);
        <span class="hljs-keyword">if</span> (!isSuccess) {
            <span class="hljs-keyword">return</span> HttpResultResponse.error(<span class="hljs-string">"Failed to prepare job."</span>);
        }

       ..........(省略部分代码)

        <span class="hljs-keyword">return</span> HttpResultResponse.success();
    }
    
    
     <span class="hljs-keyword">private</span> Boolean <span class="hljs-title function_">prepareFlightTask</span><span class="hljs-params">(WaylineJobDTO waylineJob)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// get wayline file</span>
        Optional&lt;GetWaylineListResponse&gt; waylineFile = waylineFileService.getWaylineByWaylineId(waylineJob.getWorkspaceId(), waylineJob.getFileId());
        <span class="hljs-keyword">if</span> (waylineFile.isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">"Wayline file doesn't exist."</span>);
        }

        <span class="hljs-comment">// get file url</span>
        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> waylineFileService.getObjectUrl(waylineJob.getWorkspaceId(), waylineFile.get().getId());

        <span class="hljs-type">FlighttaskPrepareRequest</span> <span class="hljs-variable">flightTask</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FlighttaskPrepareRequest</span>()
                .setFlightId(waylineJob.getJobId())
                .setExecuteTime(waylineJob.getBeginTime().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli())
                .setTaskType(waylineJob.getTaskType())
                .setWaylineType(waylineJob.getWaylineType())
                .setRthAltitude(waylineJob.getRthAltitude())
                .setOutOfControlAction(waylineJob.getOutOfControlAction())
                .setExitWaylineWhenRcLost(ExitWaylineWhenRcLostEnum.EXECUTE_RC_LOST_ACTION)
                .setFile(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FlighttaskFile</span>()
                        .setUrl(url.toString())
                        .setFingerprint(waylineFile.get().getSign()));

        <span class="hljs-keyword">if</span> (TaskTypeEnum.CONDITIONAL == waylineJob.getTaskType()) {
            <span class="hljs-keyword">if</span> (Objects.isNull(waylineJob.getConditions())) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();
            }
            flightTask.setReadyConditions(waylineJob.getConditions().getReadyConditions());
            flightTask.setExecutableConditions(waylineJob.getConditions().getExecutableConditions());
        }

        TopicServicesResponse&lt;ServicesReplyData&gt; serviceReply = abstractWaylineService.flighttaskPrepare(
                SDKManager.getDeviceSDK(waylineJob.getDockSn()), flightTask);
        <span class="hljs-keyword">if</span> (!serviceReply.getData().getResult().isSuccess()) {
            log.info(<span class="hljs-string">"Prepare task ====&gt; Error code: {}"</span>, serviceReply.getData().getResult());
            waylineJobService.updateJob(WaylineJobDTO.builder()
                    .workspaceId(waylineJob.getWorkspaceId())
                    .jobId(waylineJob.getJobId())
                    .executeTime(LocalDateTime.now())
                    .status(WaylineJobStatusEnum.FAILED.getVal())
                    .completedTime(LocalDateTime.now())
                    .code(serviceReply.getData().getResult().getCode()).build());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
</code></pre>
<ol start="8">
<li><code>prepareConditionJob</code>定时任务，每<code>5s</code>对 Redis 中的条件任务集合扫描一次。</li>
<li>获取最近的条件任务，以及任务的开始时间，判断如果<code>当前时间 + 1天 &lt; 任务开始时间</code>，直接返回。【判断任务开始时间是否达到提前准备阈值,默认提前一天】</li>
<li>从Redis中获取任务完整信息，再次调用<code>publishOneFlightTask()</code>发布任务,移除Redis中的条件任务，成功就直接返回
【两次调用<code>publishOneFlightTask()</code>方法，个人认为是为了冗余安全设计，避免条件任务因定时方法间隔没收到任务而触发失败】</li>
<li>失败，删除Redis中<code>WAYLINE_JOB_CONDITION_PREFIX+jobId</code>对应的条件任务，判断任务是否已经过期，过期就直接放弃，未过期就调用 <code>retryPrepareJob()</code>生成子任务并重新加入准备队列。</li>
</ol>
<p><strong>[3]prepareConditionJob定时方法</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Scheduled(initialDelay = 10, fixedRate = 5, timeUnit = TimeUnit.SECONDS)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepareConditionJob</span><span class="hljs-params">()</span> {
    
        <span class="hljs-comment">//获取最近的条件任务，如果队列为空，不做任何事。</span>
        Optional&lt;ConditionalWaylineJobKey&gt; jobKeyOpt = waylineRedisService.getNearestConditionalWaylineJob();
        <span class="hljs-keyword">if</span> (jobKeyOpt.isEmpty()) {
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">//获取任务开始时间，判断如果当前时间 + 1天 &lt; 任务开始时间，直接返回。</span>
        <span class="hljs-type">ConditionalWaylineJobKey</span> <span class="hljs-variable">jobKey</span> <span class="hljs-operator">=</span> jobKeyOpt.get();
        log.info(<span class="hljs-string">"Check the conditional tasks of the wayline. {}"</span>, jobKey.toString());
        <span class="hljs-comment">// format: {workspace_id}:{dock_sn}:{job_id}</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> waylineRedisService.getConditionalWaylineJobTime(jobKey);
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-comment">// prepare the task one day in advance.</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> <span class="hljs-number">86_400_000</span>;

        <span class="hljs-keyword">if</span> (now + offset &lt; time) {
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">//初始化失败任务对象，用于后续异常处理或Redis数据丢失时任务状态的更新</span>
        <span class="hljs-type">WaylineJobDTO</span> <span class="hljs-variable">job</span> <span class="hljs-operator">=</span> WaylineJobDTO.builder()
                .jobId(jobKey.getJobId())
                .status(WaylineJobStatusEnum.FAILED.getVal())
                .executeTime(LocalDateTime.now())
                .completedTime(LocalDateTime.now())
                .code(HttpStatus.SC_INTERNAL_SERVER_ERROR).build();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//获取任务详情</span>
            Optional&lt;WaylineJobDTO&gt; waylineJobOpt = waylineRedisService.getConditionalWaylineJob(jobKey.getJobId());
            <span class="hljs-keyword">if</span> (waylineJobOpt.isEmpty()) {
                job.setCode(CommonErrorEnum.REDIS_DATA_NOT_FOUND.getCode());
                waylineJobService.updateJob(job);
                waylineRedisService.removePrepareConditionalWaylineJob(jobKey);
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-type">WaylineJobDTO</span> <span class="hljs-variable">waylineJob</span> <span class="hljs-operator">=</span> waylineJobOpt.get();

            <span class="hljs-comment">//调用publishOneFlightTask()发布任务</span>
            <span class="hljs-type">HttpResultResponse</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.publishOneFlightTask(waylineJob);
            waylineRedisService.removePrepareConditionalWaylineJob(jobKey);

            <span class="hljs-keyword">if</span> (HttpResultResponse.CODE_SUCCESS == result.getCode()) {
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">//删除Redis中对应的条件任务</span>
            <span class="hljs-comment">// If the end time is exceeded, no more retries will be made.</span>
            waylineRedisService.delConditionalWaylineJob(jobKey.getJobId());
            
            <span class="hljs-comment">//判断任务是否已经过期，过期就直接返回，未过期就调用 retryPrepareJob()重试。</span>
            <span class="hljs-keyword">if</span> (waylineJob.getEndTime().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli() - RedisConst.WAYLINE_JOB_BLOCK_TIME * <span class="hljs-number">1000</span> &lt; now) {
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">// Retry if the end time has not been exceeded.</span>
            <span class="hljs-built_in">this</span>.retryPrepareJob(jobKey, waylineJob);

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.info(<span class="hljs-string">"Failed to prepare the conditional task."</span>);
            waylineJobService.updateJob(job);
        }

    }
</code></pre>
<ol start="11">
<li><strong>下发条件任务后，设备会定频检查下发任务 API 中的 ready_conditions 是否全部满足，若全部满足则会有任务就绪通知（flighttask_ready）事件通知。</strong></li>
<li>读取 flightId，判断任务是否被阻塞</li>
<li>调用 executeFlightTask() 执行飞行任务</li>
<li>判断执行结果：</li>
</ol>
<ul>
<li>成功：任务开始执行</li>
<li>失败但为阻塞错误：写入 blocked 状态</li>
<li>失败且可重试：创建子任务 → retryPrepareJob</li>
</ul>
<p><strong>[4]flighttaskReady (mqtt事件通知接收)</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> TopicEventsResponse&lt;MqttReply&gt; <span class="hljs-title function_">flighttaskReady</span><span class="hljs-params">(TopicEventsRequest&lt;FlighttaskReady&gt; response, MessageHeaders headers)</span> {
        List&lt;String&gt; flightIds = response.getData().getFlightIds();

        log.info(<span class="hljs-string">"ready task list：{}"</span>, Arrays.toString(flightIds.toArray()) );
        <span class="hljs-comment">// Check conditional task blocking status.</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">blockedId</span> <span class="hljs-operator">=</span> waylineRedisService.getBlockedWaylineJobId(response.getGateway());
        
        <span class="hljs-comment">//这段代码根据论坛回复来看，存在bug，详情见参考资料【3】</span>
        <span class="hljs-comment">//if (!StringUtils.hasText(blockedId)) {</span>
        <span class="hljs-comment">//    return null;</span>
        <span class="hljs-comment">//}</span>

        Optional&lt;DeviceDTO&gt; deviceOpt = deviceRedisService.getDeviceOnline(response.getGateway());
        <span class="hljs-keyword">if</span> (deviceOpt.isEmpty()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-type">DeviceDTO</span> <span class="hljs-variable">device</span> <span class="hljs-operator">=</span> deviceOpt.get();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">for</span> (String jobId : flightIds) {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">isExecute</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.executeFlightTask(device.getWorkspaceId(), jobId);
                <span class="hljs-keyword">if</span> (!isExecute) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
                }
                Optional&lt;WaylineJobDTO&gt; waylineJobOpt = waylineRedisService.getConditionalWaylineJob(jobId);
                <span class="hljs-keyword">if</span> (waylineJobOpt.isEmpty()) {
                    log.info(<span class="hljs-string">"The conditional job has expired and will no longer be executed."</span>);
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TopicEventsResponse</span>&lt;&gt;();
                }
                <span class="hljs-type">WaylineJobDTO</span> <span class="hljs-variable">waylineJob</span> <span class="hljs-operator">=</span> waylineJobOpt.get();
                <span class="hljs-built_in">this</span>.retryPrepareJob(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConditionalWaylineJobKey</span>(device.getWorkspaceId(), response.getGateway(), jobId), waylineJob);
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TopicEventsResponse</span>&lt;&gt;();
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Failed to execute conditional task."</span>);
            e.printStackTrace();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TopicEventsResponse</span>&lt;&gt;();
    }
    
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">retryPrepareJob</span><span class="hljs-params">(ConditionalWaylineJobKey jobKey, WaylineJobDTO waylineJob)</span> {
        Optional&lt;WaylineJobDTO&gt; childJobOpt = waylineJobService.createWaylineJobByParent(jobKey.getWorkspaceId(), jobKey.getJobId());
        <span class="hljs-keyword">if</span> (childJobOpt.isEmpty()) {
            log.error(<span class="hljs-string">"Failed to create wayline job."</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-type">WaylineJobDTO</span> <span class="hljs-variable">newJob</span> <span class="hljs-operator">=</span> childJobOpt.get();
        newJob.setBeginTime(LocalDateTime.now().plusSeconds(RedisConst.WAYLINE_JOB_BLOCK_TIME));
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isAdd</span> <span class="hljs-operator">=</span> waylineRedisService.addPrepareConditionalWaylineJob(newJob);
        <span class="hljs-keyword">if</span> (!isAdd) {
            log.error(<span class="hljs-string">"Failed to create wayline job. {}"</span>, newJob.getJobId());
            <span class="hljs-keyword">return</span>;
        }

        waylineJob.setJobId(newJob.getJobId());
        waylineRedisService.setConditionalWaylineJob(waylineJob);
    }

    

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">executeFlightTask</span><span class="hljs-params">(String workspaceId, String jobId)</span> {
        <span class="hljs-comment">// get job</span>
        Optional&lt;WaylineJobDTO&gt; waylineJob = waylineJobService.getJobByJobId(workspaceId, jobId);
        <span class="hljs-keyword">if</span> (waylineJob.isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Job doesn't exist."</span>);
        }

        <span class="hljs-type">boolean</span> <span class="hljs-variable">isOnline</span> <span class="hljs-operator">=</span> deviceRedisService.checkDeviceOnline(waylineJob.get().getDockSn());
        <span class="hljs-keyword">if</span> (!isOnline) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Dock is offline."</span>);
        }

        <span class="hljs-type">WaylineJobDTO</span> <span class="hljs-variable">job</span> <span class="hljs-operator">=</span> waylineJob.get();

        TopicServicesResponse&lt;ServicesReplyData&gt; serviceReply = abstractWaylineService.flighttaskExecute(
                SDKManager.getDeviceSDK(job.getDockSn()), <span class="hljs-keyword">new</span> <span class="hljs-title class_">FlighttaskExecuteRequest</span>().setFlightId(jobId));
        <span class="hljs-keyword">if</span> (!serviceReply.getData().getResult().isSuccess()) {
            log.info(<span class="hljs-string">"Execute job ====&gt; Error: {}"</span>, serviceReply.getData().getResult());
            waylineJobService.updateJob(WaylineJobDTO.builder()
                    .jobId(jobId)
                    .executeTime(LocalDateTime.now())
                    .status(WaylineJobStatusEnum.FAILED.getVal())
                    .completedTime(LocalDateTime.now())
                    .code(serviceReply.getData().getResult().getCode()).build());
            <span class="hljs-comment">// The conditional task fails and enters the blocking status.</span>
            <span class="hljs-keyword">if</span> (TaskTypeEnum.CONDITIONAL == job.getTaskType()
                    &amp;&amp; WaylineErrorCodeEnum.find(serviceReply.getData().getResult().getCode()).isBlock()) {
                waylineRedisService.setBlockedWaylineJob(job.getDockSn(), jobId);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        waylineJobService.updateJob(WaylineJobDTO.builder()
                .jobId(jobId)
                .executeTime(LocalDateTime.now())
                .status(WaylineJobStatusEnum.IN_PROGRESS.getVal())
                .build());
        waylineRedisService.setRunningWaylineJob(job.getDockSn(), EventsReceiver.&lt;FlighttaskProgress&gt;builder().bid(jobId).sn(job.getDockSn()).build());
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
</code></pre>
<p><strong>参考资料：</strong></p>
<p>上云API开源代码库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdji-sdk%2FDJI-Cloud-API-Demo" target="_blank" title="https://github.com/dji-sdk/DJI-Cloud-API-Demo" ref="nofollow noopener noreferrer">github.com/dji-sdk/DJI…</a></p>
<p>大疆上云API文档-机场功能集-航线管理：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.dji.com%2Fdoc%2Fcloud-api-tutorial%2Fcn%2Ffeature-set%2Fdock-feature-set%2Fdock-wayline-management.html" target="_blank" title="https://developer.dji.com/doc/cloud-api-tutorial/cn/feature-set/dock-feature-set/dock-wayline-management.html" ref="nofollow noopener noreferrer">developer.dji.com/doc/cloud-a…</a></p>
<p>大疆创新SDK技术支持论坛-下发条件任务成功，但满足条件后任务并不执行：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsdk-forum.dji.net%2Fhc%2Fzh-cn%2Fcommunity%2Fposts%2F38931172754329-%25E4%25B8%258B%25E5%258F%2591%25E6%259D%25A1%25E4%25BB%25B6%25E4%25BB%25BB%25E5%258A%25A1%25E6%2588%2590%25E5%258A%259F-%25E4%25BD%2586%25E6%25BB%25A1%25E8%25B6%25B3%25E6%259D%25A1%25E4%25BB%25B6%25E5%2590%258E%25E4%25BB%25BB%25E5%258A%25A1%25E5%25B9%25B6%25E4%25B8%258D%25E6%2589%25A7%25E8%25A1%258C" target="_blank" title="https://sdk-forum.dji.net/hc/zh-cn/community/posts/38931172754329-%E4%B8%8B%E5%8F%91%E6%9D%A1%E4%BB%B6%E4%BB%BB%E5%8A%A1%E6%88%90%E5%8A%9F-%E4%BD%86%E6%BB%A1%E8%B6%B3%E6%9D%A1%E4%BB%B6%E5%90%8E%E4%BB%BB%E5%8A%A1%E5%B9%B6%E4%B8%8D%E6%89%A7%E8%A1%8C" ref="nofollow noopener noreferrer">sdk-forum.dji.net/hc/zh-cn/co…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[没有 Mac，如何在 Windows 上架 iOS 应用？一套可落地的工程方案]]></title>    <link>https://juejin.cn/post/7582786655473106987</link>    <guid>https://juejin.cn/post/7582786655473106987</guid>    <pubDate>2025-12-12T10:00:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582786655473106987" data-draft-id="7582786655473090603" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="没有 Mac，如何在 Windows 上架 iOS 应用？一套可落地的工程方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-12T10:00:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bcbnb"/> <meta itemprop="url" content="https://juejin.cn/user/895474073078377"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            没有 Mac，如何在 Windows 上架 iOS 应用？一套可落地的工程方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895474073078377/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bcbnb
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T10:00:30.000Z" title="Fri Dec 12 2025 10:00:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在很多团队中，iOS 上架一直被认为是“只能在 Mac 上完成的事情”。但随着跨端开发的普及（uni-app、Flutter、H5 封装等），越来越多的项目成员长期使用 Windows 开发环境。当应用开发完成后，一个现实问题摆在面前：<strong>没有 Mac，iOS 应用还能不能上架？</strong></p>
<p>从工程角度来看，答案是肯定的。
关键在于区分清楚哪些步骤 <strong>必须依赖 macOS</strong>，哪些步骤 <strong>可以在 Windows 上完成</strong>，以及如何通过合适的工具把整个上架流程拆解并重新组合。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、先明确一个事实：iOS 上架 ≠ 全流程都要 Mac</strong></h2>
<p>很多人之所以认为“没有 Mac 就无法上架 iOS”，是因为混淆了几个不同的阶段。</p>
<p>实际上，iOS 上架流程可以拆解为：</p>
<ol>
<li>账号与应用身份准备</li>
<li>证书与描述文件管理</li>
<li>iOS 工程构建（生成 IPA）</li>
<li>IPA 校验与上传</li>
<li>审核与发布</li>
</ol>
<p>其中，<strong>真正强依赖 macOS 的只有“iOS 原生工程构建”这一步</strong>。
而在跨端项目中，这一步往往可以通过：</p>
<ul>
<li>云打包</li>
<li>CI 的 macOS Runner</li>
<li>外包或共享 Mac</li>
<li>第三方打包服务</li>
</ul>
<p>来完成。
其余步骤，理论上都可以在 Windows 环境中处理。</p>
<hr/>
<h2 data-id="heading-1"><strong>二、Windows 上准备上架的第一步：账号与 Bundle ID</strong></h2>
<p>无论使用什么开发方式，上架 iOS 应用都必须先完成应用身份的创建。</p>
<h3 data-id="heading-2"><strong>1. Apple 开发者账号</strong></h3>
<p>这是前置条件，本文不再展开。</p>
<h3 data-id="heading-3"><strong>2. Bundle ID 的创建与确认</strong></h3>
<p>Bundle ID 是应用在苹果体系中的唯一标识。
在团队协作中，常见问题包括：</p>
<ul>
<li>不清楚账号下已有多少 Bundle ID</li>
<li>重复创建导致冲突</li>
<li>命名混乱，后期难以维护</li>
</ul>
<p>在 Windows 环境下，我通常会使用：</p>
<ul>
<li><strong>Appuploader 的 Bundle ID 查看与管理功能</strong></li>
</ul>
<p>它可以直接列出当前账号中的应用 ID，帮助确认：</p>
<ul>
<li>是否已存在可用的 Bundle ID</li>
<li>是否需要新建</li>
<li>命名是否规范</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24b12c7cdb7442b89bb1df70651a52fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmNibmI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138429&amp;x-signature=hKpRXFxuQR6Br0JwMGboKC%2FkluU%3D" alt="bid" loading="lazy"/></p>
<p>这样可以避免在没有 Mac 的情况下盲目创建标识符。</p>
<hr/>
<h2 data-id="heading-4"><strong>三、在 Windows 上管理 iOS 证书：关键突破点</strong></h2>
<p>证书管理是“Windows 上架 iOS”的最大阻碍之一。
传统方式必须使用 macOS 钥匙串生成证书，这直接把 Windows 用户挡在门外。</p>
<h3 data-id="heading-5"><strong>1. 在 Windows 上创建 iOS 证书</strong></h3>
<p>在实际项目中，我会使用：</p>
<ul>
<li><strong>开心上架（Appuploader）创建 iOS 证书</strong></li>
</ul>
<p>其特点是：</p>
<ul>
<li>可在 Windows、Linux、macOS 上操作</li>
<li>不依赖钥匙串助手</li>
<li>只需填写证书名称、邮箱和密码</li>
<li>生成的证书文件（如 p12）可在多台电脑或 CI 中使用</li>
</ul>
<p>这一步的意义在于：<strong>证书不再被某一台 Mac 垄断，Windows 成员也能参与证书管理。</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e17e2bdac5c425d99a6d6bfc017d909~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmNibmI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138429&amp;x-signature=Wt2G8TpsrZi%2FS4GQ7P%2F0juBWY0A%3D" alt="证书创建" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-6"><strong>2. 描述文件（mobileprovision）的查看与校验</strong></h3>
<p>描述文件中包含：</p>
<ul>
<li>绑定的证书</li>
<li>Bundle ID</li>
<li>Team ID</li>
<li>能力权限</li>
</ul>
<p>在 Windows 环境下，如果无法查看这些信息，很容易出现“用错 profile”的问题。</p>
<p>通过 <strong>Appuploader 的 mobileprovision 查看功能</strong>，可以在 Windows 上直接确认：</p>
<ul>
<li>当前描述文件是否为发布类型</li>
<li>是否绑定了正确的证书</li>
<li>Bundle ID 是否匹配</li>
</ul>
<p>这一步可以在构建前就排除大量潜在错误。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4227e026c706411c855acad1b79069c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmNibmI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138429&amp;x-signature=haa6tztAdKb4gK8xAXVol0i9X%2F8%3D" alt="查看文件" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-7"><strong>四、iOS 工程构建：Windows 团队的常见解决方案</strong></h2>
<p>需要明确的是：
<strong>生成 IPA 的那一步，仍然需要 macOS。</strong></p>
<p>但这并不意味着每个成员都要有 Mac。常见做法包括：</p>
<h3 data-id="heading-8"><strong>1. 云打包 / 云构建</strong></h3>
<ul>
<li>HBuilderX 云打包（uni-app）</li>
<li>Codemagic</li>
<li>GitHub Actions（macOS Runner）</li>
</ul>
<h3 data-id="heading-9"><strong>2. CI 构建</strong></h3>
<ul>
<li>Jenkins + Mac Mini</li>
<li>GitLab CI + macOS 节点</li>
</ul>
<h3 data-id="heading-10"><strong>3. 共享或外包 Mac</strong></h3>
<p>只用于构建，不参与其他流程。</p>
<p>构建完成后，IPA 文件会被输出到服务器或共享目录，接下来就可以完全回到 Windows 环境。</p>
<hr/>
<h2 data-id="heading-11"><strong>五、IPA 文件检查：Windows 上非常关键的一步</strong></h2>
<p>很多 iOS 上架问题，并不是构建失败，而是 <strong>IPA 内部内容有误</strong>，例如：</p>
<ul>
<li>使用了开发证书</li>
<li>描述文件类型错误</li>
<li>Bundle ID 不一致</li>
<li>缺少 Assets.car</li>
<li>Info.plist 权限说明不完整</li>
</ul>
<p>在 Windows 上，我通常会在上传前检查 IPA 内容，例如：</p>
<ul>
<li><strong>使用 Appuploader 查看 IPA 内的 Info.plist</strong></li>
<li>检查 mobileprovision 是否为发布描述文件</li>
<li>确认 Bundle ID 与 App Store Connect 中一致</li>
</ul>
<p>提前发现问题，比上传失败后再返工效率高得多。</p>
<hr/>
<h2 data-id="heading-12"><strong>六、核心步骤：在 Windows 上上传 IPA 到 App Store</strong></h2>
<p>这是“Windows 上架 iOS”的关键一环。</p>
<p>传统工具（Xcode、Transporter）都依赖 macOS，因此在 Windows 环境下不可用。</p>
<p>在实际项目中，我会使用：</p>
<h3 data-id="heading-13"><strong>Appuploader CLI 在 Windows 上传 IPA</strong></h3>
<p>示例命令：</p>
<pre><code class="hljs language-bash" lang="bash">appuploader_cli -u appleid@example.com -p xxxx-xxxx-xxxx -c 1 -f app.ipa
</code></pre>
<p>这一步的优势在于：</p>
<ul>
<li><strong>完全支持 Windows</strong></li>
<li>不依赖 Xcode 或 Transporter</li>
<li>可集成到脚本或 CI</li>
<li>上传行为不携带 Mac 设备信息</li>
</ul>
<p>这意味着：<strong>只要拿到 IPA，Windows 环境就可以完成上架上传。</strong>
图形化界面：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/007a9737e7ba4663b98ddd1d276e0e6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmNibmI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138429&amp;x-signature=MyksM170eh%2FsrWuKv%2BzPBbgmF7o%3D" alt="ipa上传" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-14"><strong>七、审核与发布：Windows 环境同样可完成</strong></h2>
<p>IPA 上传完成后，后续操作包括：</p>
<ul>
<li>填写 App Store 信息</li>
<li>提交审核</li>
<li>查看审核结果</li>
<li>回复审核问题</li>
</ul>
<p>这些步骤本身就是 Web 操作，与操作系统无关，Windows 完全可以胜任。</p>
<hr/>
<h2 data-id="heading-15"><strong>八、一个完整的 Windows 上架 iOS 流程示例</strong></h2>
<p>综合上述步骤，一个可行流程如下：</p>
<ol>
<li>Windows 上确认 Bundle ID（Appuploader）</li>
<li>Windows 上创建证书并管理 profile（Appuploader）</li>
<li>macOS / 云端构建 IPA</li>
<li>Windows 上检查 IPA 内容（Appuploader）</li>
<li>Windows 上通过 Appuploader CLI 上传 IPA</li>
<li>Web 端提交审核并发布</li>
</ol>
<p>整个流程中，Mac 只作为“构建工具”，而不是流程中心。</p>
<hr/>
<p>“如何在 Windows 上架 iOS”并不是一个技巧问题，而是流程拆解与工具选择的问题。
当证书、Bundle ID、IPA 校验与上传这些环节都能在 Windows 上完成时，iOS 上架就不再是 Mac 独占的能力。</p>
<p>最终目标不是“绕开 Mac”，而是让上架流程 <strong>不再依赖某一台电脑或某一个人</strong>。</p>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.appuploader.net%2Ftutorial%2Fzh%2F1%2F1.html" target="_blank" title="https://www.appuploader.net/tutorial/zh/1/1.html" ref="nofollow noopener noreferrer">www.appuploader.net/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 企业级接口加密【通用、可配置、解耦的组件】「开闭原则+模板方法+拦截器/中间件模式」]]></title>    <link>https://juejin.cn/post/7582786292087324723</link>    <guid>https://juejin.cn/post/7582786292087324723</guid>    <pubDate>2025-12-12T09:42:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582786292087324723" data-draft-id="7582777037863518258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 企业级接口加密【通用、可配置、解耦的组件】「开闭原则+模板方法+拦截器/中间件模式」"/> <meta itemprop="keywords" content="后端,Java,安全"/> <meta itemprop="datePublished" content="2025-12-12T09:42:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈哈哈笑什么"/> <meta itemprop="url" content="https://juejin.cn/user/808832912075352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 企业级接口加密【通用、可配置、解耦的组件】「开闭原则+模板方法+拦截器/中间件模式」
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/808832912075352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈哈哈笑什么
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:42:56.000Z" title="Fri Dec 12 2025 09:42:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>将加解密逻辑封装成<strong>通用、可配置、解耦的组件</strong>，核心是遵循「开闭原则+模板方法+拦截器/中间件模式」，让业务代码无需嵌入加密逻辑，仅通过<strong>注解/配置</strong>指定需要加密的接口/字段即可。以下是落地方案，以Java Spring Boot（主流企业级框架）为例，同时兼容Go/Python等语言的核心思路。</p>
<h3 data-id="heading-0">一、通用组件设计核心原则</h3>
<ol>
<li><strong>完全解耦</strong>：加密逻辑与业务代码隔离，业务侧仅需「声明式配置」（注解/yml），无需写任何加密代码；</li>
<li><strong>可配置化</strong>：支持指定「哪些接口、哪些字段」加密/解密，支持切换算法（AES-GCM/ECC/RSA）、密钥来源（KMS/HSM/本地）；</li>
<li><strong>易扩展</strong>：新增加密算法/加密规则时，无需修改核心组件，仅需扩展接口；</li>
<li><strong>高性能</strong>：组件内部封装对象池、硬件加速、异步处理，对业务透明；</li>
<li><strong>可监控</strong>：内置加解密耗时、失败率监控，便于排查问题。</li>
</ol>
<h3 data-id="heading-1">二、通用组件分层架构（解耦核心）</h3>
<p>组件分为5层，每层职责单一，通过依赖注入解耦：</p>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────┐
│ 业务层（Controller/Service）                            │
│ （仅加注解/配置，无加密代码）                            │
└───────────────────┬─────────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────────┐
│ 接入层（拦截器/过滤器/Middleware）                       │
│ （拦截请求/响应，触发加解密，对业务透明）                │
└───────────────────┬─────────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────────┐
│ 核心服务层（CryptoTemplate）                             │
│ （封装通用加解密/签名验签流程，模板方法）                │
└───────────────────┬─────────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────────┐
│ 基础设施层（AlgorithmFactory + KeyManager）              │
│ （封装算法、密钥管理，屏蔽底层细节）                    │
└───────────────────┬─────────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────────┐
│ 配置/注解层（<span class="hljs-keyword">@Encrypt</span> + yml配置）                       │
│ （指定加密规则：接口、字段、算法、密钥）                │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-2">三、核心模块实现（Spring Boot版通用组件）</h3>
<p>以下是可直接落地的核心代码，聚焦「解耦+通用」，屏蔽复杂的算法细节，业务侧仅需简单配置。</p>
<h4 data-id="heading-3">1. 第一步：定义配置/注解（业务侧仅需接触这层）</h4>
<h5 data-id="heading-4">（1）自定义注解（标记需要加密的接口/字段）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 接口级注解：标记该接口需要加密入参、解密出参
 */</span>
<span class="hljs-meta">@Target({ElementType.METHOD})</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> ApiEncrypt {
    <span class="hljs-comment">// 加密算法（默认AES-GCM）</span>
    String <span class="hljs-title function_">algorithm</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"AES-GCM"</span>;
    <span class="hljs-comment">// 密钥标识（关联yml中的密钥配置）</span>
    String <span class="hljs-title function_">keyId</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"pay_default_key"</span>;
    <span class="hljs-comment">// 是否验签（默认开启）</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">verifySign</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-comment">/**
 * 字段级注解：标记DTO中的敏感字段，仅加密这些字段
 */</span>
<span class="hljs-meta">@Target({ElementType.FIELD})</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> SensitiveField {
    <span class="hljs-comment">// 字段描述（非必需，用于日志）</span>
    String <span class="hljs-title function_">desc</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;
}
</code></pre>
<h5 data-id="heading-5">（2）yml配置（算法、密钥、超时等）</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">crypto:</span>
  <span class="hljs-comment"># 全局配置</span>
  <span class="hljs-attr">global:</span>
    <span class="hljs-attr">algorithm:</span> <span class="hljs-string">AES-GCM</span>  <span class="hljs-comment"># 默认算法</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-string">1000ms</span>     <span class="hljs-comment"># 加解密超时</span>
    <span class="hljs-attr">enable-hardware-accel:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 开启硬件加速</span>
  <span class="hljs-comment"># 密钥配置（支持KMS/HSM，此处简化为本地配置，生产需替换为KMS）</span>
  <span class="hljs-attr">keys:</span>
    <span class="hljs-attr">pay_default_key:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">ECC</span>  <span class="hljs-comment"># 密钥类型（ECC/RSA/AES）</span>
      <span class="hljs-attr">public-key:</span> <span class="hljs-string">"xxx"</span>  <span class="hljs-comment"># 服务端公钥（客户端用）</span>
      <span class="hljs-attr">private-key:</span> <span class="hljs-string">"xxx"</span> <span class="hljs-comment"># 服务端私钥（服务端用）</span>
      <span class="hljs-attr">expire:</span> <span class="hljs-string">90d</span>        <span class="hljs-comment"># 密钥轮换周期</span>
  <span class="hljs-comment"># 忽略加密的字段（全局）</span>
  <span class="hljs-attr">ignore-fields:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"orderId"</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"merchantId"</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"timestamp"</span>
</code></pre>
<h4 data-id="heading-6">2. 第二步：基础设施层（封装算法+密钥，对业务透明）</h4>
<h5 data-id="heading-7">（1）算法工厂（统一封装算法，支持扩展）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 算法工厂：根据配置动态创建加解密器，屏蔽算法细节
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlgorithmFactory</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CryptoProperties cryptoProperties;

    <span class="hljs-comment">// 缓存加解密器对象，避免重复创建（性能优化）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, CryptoHandler&gt; handlerCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">/**
     * 获取指定算法的加解密器
     */</span>
    <span class="hljs-keyword">public</span> CryptoHandler <span class="hljs-title function_">getHandler</span><span class="hljs-params">(String algorithm, String keyId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> algorithm + <span class="hljs-string">"_"</span> + keyId;
        <span class="hljs-keyword">if</span> (handlerCache.containsKey(cacheKey)) {
            <span class="hljs-keyword">return</span> handlerCache.get(cacheKey);
        }
        <span class="hljs-comment">// 根据算法类型创建对应处理器（策略模式）</span>
        <span class="hljs-type">CryptoHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">switch</span> (algorithm) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"AES-GCM"</span> -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">AesGcmHandler</span>(cryptoProperties.getKeys().get(keyId));
            <span class="hljs-keyword">case</span> <span class="hljs-string">"ECC"</span> -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">EccHandler</span>(cryptoProperties.getKeys().get(keyId));
            <span class="hljs-keyword">case</span> <span class="hljs-string">"RSA"</span> -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">RsaHandler</span>(cryptoProperties.getKeys().get(keyId));
            <span class="hljs-keyword">default</span> -&gt; <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CryptoException</span>(<span class="hljs-string">"不支持的算法："</span> + algorithm);
        };
        handlerCache.put(cacheKey, handler);
        <span class="hljs-keyword">return</span> handler;
    }

    <span class="hljs-comment">// 加解密器接口（扩展新算法只需实现此接口）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CryptoHandler</span> {
        <span class="hljs-comment">// 加密数据</span>
        <span class="hljs-type">byte</span>[] encrypt(<span class="hljs-type">byte</span>[] data, String keyId);
        <span class="hljs-comment">// 解密数据</span>
        <span class="hljs-type">byte</span>[] decrypt(<span class="hljs-type">byte</span>[] data, String keyId);
        <span class="hljs-comment">// 签名</span>
        String <span class="hljs-title function_">sign</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data, String keyId)</span>;
        <span class="hljs-comment">// 验签</span>
        <span class="hljs-type">boolean</span> <span class="hljs-title function_">verifySign</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data, String sign, String keyId)</span>;
    }

    <span class="hljs-comment">// AES-GCM实现（示例，其余算法同理）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AesGcmHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CryptoHandler</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> KeyConfig keyConfig;
        <span class="hljs-comment">// 缓存Cipher对象（性能优化）</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectPool&lt;Cipher&gt; cipherPool;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">AesGcmHandler</span><span class="hljs-params">(KeyConfig keyConfig)</span> {
            <span class="hljs-built_in">this</span>.keyConfig = keyConfig;
            <span class="hljs-comment">// 初始化Cipher对象池</span>
            <span class="hljs-built_in">this</span>.cipherPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericObjectPool</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CipherPooledFactory</span>(<span class="hljs-string">"AES/GCM/NoPadding"</span>));
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] encrypt(<span class="hljs-type">byte</span>[] data, String keyId) {
            <span class="hljs-keyword">try</span> (PooledObject&lt;Cipher&gt; pooledCipher = cipherPool.borrowObject()) {
                <span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> pooledCipher.getObject();
                <span class="hljs-comment">// 省略AES-GCM加密逻辑（复用之前的代码）</span>
                <span class="hljs-keyword">return</span> cipher.doFinal(data);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CryptoException</span>(<span class="hljs-string">"AES加密失败"</span>, e);
            }
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] decrypt(<span class="hljs-type">byte</span>[] data, String keyId) {
            <span class="hljs-comment">// 同理，省略解密逻辑</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sign</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data, String keyId)</span> {
            <span class="hljs-comment">// 省略签名逻辑</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verifySign</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data, String sign, String keyId)</span> {
            <span class="hljs-comment">// 省略验签逻辑</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    }
}
</code></pre>
<h5 data-id="heading-8">（2）密钥管理器（统一管理密钥，支持KMS/HSM）</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 密钥管理器：统一获取密钥（本地/KMS/HSM），对上层透明
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KeyManager</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">CryptoProperties</span> cryptoProperties;
    <span class="hljs-comment">// 对接KMS的客户端（生产环境用）</span>
    <span class="hljs-meta">@Autowired</span>(required = <span class="hljs-literal">false</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">KmsClient</span> kmsClient;

    <span class="hljs-comment">/**
     * 获取密钥（优先从KMS获取，本地为兜底）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getKey</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> keyId</span>) {
        <span class="hljs-title class_">KeyConfig</span> keyConfig = cryptoProperties.<span class="hljs-title function_">getKeys</span>().<span class="hljs-title function_">get</span>(keyId);
        <span class="hljs-keyword">if</span> (keyConfig == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CryptoException</span>(<span class="hljs-string">"密钥配置不存在："</span> + keyId);
        }
        <span class="hljs-comment">// 生产环境：从KMS/HSM获取密钥</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"KMS"</span>.<span class="hljs-title function_">equals</span>(keyConfig.<span class="hljs-title function_">getType</span>())) {
            <span class="hljs-keyword">return</span> kmsClient.<span class="hljs-title function_">getSecret</span>(keyId);
        }
        <span class="hljs-comment">// 测试环境：本地配置（生产禁用）</span>
        <span class="hljs-keyword">return</span> keyConfig.<span class="hljs-title function_">getPrivateKey</span>();
    }
}
</code></pre>
<h4 data-id="heading-9">3. 第三步：核心服务层（模板方法封装通用流程）</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/**
 * 加解密模板：封装通用流程，拦截器直接调用，无需重复写逻辑
 */</span>
<span class="hljs-keyword">@Service</span>
public class CryptoTemplate {
    <span class="hljs-keyword">@Autowired</span>
    private AlgorithmFactory algorithmFactory;
    <span class="hljs-keyword">@Autowired</span>
    private KeyManager keyManager;

    <span class="hljs-comment">/**
     * 通用加密流程：加密敏感字段 + 签名
     */</span>
    public &lt;T&gt; T <span class="hljs-built_in">encrypt</span>(T data, String algorithm, String keyId) {
        try {
            <span class="hljs-comment">// 1. 获取算法处理器</span>
            AlgorithmFactory<span class="hljs-selector-class">.CryptoHandler</span> handler = algorithmFactory<span class="hljs-selector-class">.getHandler</span>(algorithm, keyId);
            <span class="hljs-comment">// 2. 反射获取@SensitiveField字段，仅加密这些字段</span>
            Field<span class="hljs-selector-attr">[]</span> fields = data<span class="hljs-selector-class">.getClass</span>()<span class="hljs-selector-class">.getDeclaredFields</span>();
            for (Field field : fields) {
                if (field.isAnnotationPresent(SensitiveField.class)) {
                    field<span class="hljs-selector-class">.setAccessible</span>(true);
                    <span class="hljs-selector-tag">Object</span> value = field<span class="hljs-selector-class">.get</span>(data);
                    if (value != null) {
                        <span class="hljs-comment">// 3. 加密敏感字段</span>
                        byte<span class="hljs-selector-attr">[]</span> encrypted = handler<span class="hljs-selector-class">.encrypt</span>(value.toString()<span class="hljs-selector-class">.getBytes</span>(), keyId);
                        field<span class="hljs-selector-class">.set</span>(data, Base64.getEncoder()<span class="hljs-selector-class">.encodeToString</span>(encrypted));
                    }
                }
            }
            <span class="hljs-comment">// 4. 签名（可选）</span>
            String sign = handler<span class="hljs-selector-class">.sign</span>(JsonUtil.toJsonBytes(data), keyId);
            <span class="hljs-comment">// 给DTO设置签名（假设DTO有sign字段）</span>
            Field signField = data<span class="hljs-selector-class">.getClass</span>()<span class="hljs-selector-class">.getDeclaredField</span>("sign");
            signField<span class="hljs-selector-class">.setAccessible</span>(true);
            signField<span class="hljs-selector-class">.set</span>(data, sign);
            return data;
        } catch (Exception e) {
            throw new <span class="hljs-built_in">CryptoException</span>("加密失败", e);
        }
    }

    <span class="hljs-comment">/**
     * 通用解密流程：验签 + 解密敏感字段
     */</span>
    public &lt;T&gt; T <span class="hljs-built_in">decrypt</span>(T data, String algorithm, String keyId) {
        try {
            AlgorithmFactory<span class="hljs-selector-class">.CryptoHandler</span> handler = algorithmFactory<span class="hljs-selector-class">.getHandler</span>(algorithm, keyId);
            <span class="hljs-comment">// 1. 验签</span>
            Field signField = data<span class="hljs-selector-class">.getClass</span>()<span class="hljs-selector-class">.getDeclaredField</span>("sign");
            signField<span class="hljs-selector-class">.setAccessible</span>(true);
            String sign = (String) signField<span class="hljs-selector-class">.get</span>(data);
            if (!handler.verifySign(JsonUtil.toJsonBytes(data), sign, keyId)) {
                throw new <span class="hljs-built_in">CryptoException</span>("验签失败");
            }
            <span class="hljs-comment">// 2. 解密敏感字段</span>
            Field<span class="hljs-selector-attr">[]</span> fields = data<span class="hljs-selector-class">.getClass</span>()<span class="hljs-selector-class">.getDeclaredFields</span>();
            for (Field field : fields) {
                if (field.isAnnotationPresent(SensitiveField.class)) {
                    field<span class="hljs-selector-class">.setAccessible</span>(true);
                    String encryptedValue = (String) field<span class="hljs-selector-class">.get</span>(data);
                    if (encryptedValue != null) {
                        byte<span class="hljs-selector-attr">[]</span> decrypted = handler<span class="hljs-selector-class">.decrypt</span>(Base64.getDecoder()<span class="hljs-selector-class">.decode</span>(encryptedValue), keyId);
                        field<span class="hljs-selector-class">.set</span>(data, new String(decrypted));
                    }
                }
            }
            return data;
        } catch (Exception e) {
            throw new <span class="hljs-built_in">CryptoException</span>("解密失败", e);
        }
    }
}
</code></pre>
<h4 data-id="heading-10">4. 第四步：接入层（拦截器，自动处理请求/响应）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 加解密拦截器：拦截<span class="hljs-doctag">@ApiEncrypt</span>注解的接口，自动处理加解密
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CryptoInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CryptoTemplate cryptoTemplate;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 判断是否是Controller方法，且有@ApiEncrypt注解</span>
        <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> HandlerMethod handlerMethod) {
            <span class="hljs-type">ApiEncrypt</span> <span class="hljs-variable">apiEncrypt</span> <span class="hljs-operator">=</span> handlerMethod.getMethodAnnotation(ApiEncrypt.class);
            <span class="hljs-keyword">if</span> (apiEncrypt != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// 2. 读取请求体</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">requestBody</span> <span class="hljs-operator">=</span> StreamUtils.copyToString(request.getInputStream(), StandardCharsets.UTF_8);
                <span class="hljs-comment">// 3. 反序列化为DTO（需获取方法入参类型）</span>
                Class&lt;?&gt; paramType = handlerMethod.getMethod().getParameterTypes()[<span class="hljs-number">0</span>];
                <span class="hljs-type">Object</span> <span class="hljs-variable">dto</span> <span class="hljs-operator">=</span> JsonUtil.fromJson(requestBody, paramType);
                <span class="hljs-comment">// 4. 解密DTO（自动处理敏感字段）</span>
                <span class="hljs-type">Object</span> <span class="hljs-variable">decryptedDto</span> <span class="hljs-operator">=</span> cryptoTemplate.decrypt(dto, apiEncrypt.algorithm(), apiEncrypt.keyId());
                <span class="hljs-comment">// 5. 替换请求体为解密后的数据（让Controller拿到明文）</span>
                request.setAttribute(<span class="hljs-string">"decryptedParam"</span>, decryptedDto);
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 判断是否有@ApiEncrypt注解</span>
        <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> HandlerMethod handlerMethod) {
            <span class="hljs-type">ApiEncrypt</span> <span class="hljs-variable">apiEncrypt</span> <span class="hljs-operator">=</span> handlerMethod.getMethodAnnotation(ApiEncrypt.class);
            <span class="hljs-keyword">if</span> (apiEncrypt != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// 2. 获取Controller返回的响应体（需结合ResponseBodyAdvice）</span>
                <span class="hljs-comment">// 此处简化，实际用ResponseBodyAdvice拦截响应更优雅</span>
                <span class="hljs-type">Object</span> <span class="hljs-variable">responseBody</span> <span class="hljs-operator">=</span> request.getAttribute(<span class="hljs-string">"responseBody"</span>);
                <span class="hljs-comment">// 3. 加密响应体（自动处理敏感字段）</span>
                <span class="hljs-type">Object</span> <span class="hljs-variable">encryptedBody</span> <span class="hljs-operator">=</span> cryptoTemplate.encrypt(responseBody, apiEncrypt.algorithm(), apiEncrypt.keyId());
                <span class="hljs-comment">// 4. 写入加密后的响应</span>
                response.getWriter().write(JsonUtil.toJson(encryptedBody));
            }
        }
    }
}

<span class="hljs-comment">// 注册拦截器</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CryptoInterceptor cryptoInterceptor;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> {
        registry.addInterceptor(cryptoInterceptor)
                .addPathPatterns(<span class="hljs-string">"/api/pay/**"</span>) <span class="hljs-comment">// 仅拦截支付相关接口</span>
                .excludePathPatterns(<span class="hljs-string">"/api/public/**"</span>); <span class="hljs-comment">// 排除公开接口</span>
    }
}
</code></pre>
<h4 data-id="heading-11">5. 第五步：业务侧使用（极简，无加密代码）</h4>
<h5 data-id="heading-12">（1）定义DTO（仅标记敏感字段）</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 支付请求DTO</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayRequestDTO</span> {
    <span class="hljs-comment">// 非敏感字段，无需加密</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> orderId;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> merchantId;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Long</span> timestamp;
    <span class="hljs-comment">// 签名字段（自动生成/验证）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> sign;

    <span class="hljs-comment">// 敏感字段，标记后自动加密/解密</span>
    <span class="hljs-meta">@SensitiveField</span>(desc = <span class="hljs-string">"银行卡号"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> cardNo;
    <span class="hljs-meta">@SensitiveField</span>(desc = <span class="hljs-string">"CVV码"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> cvv;
    <span class="hljs-meta">@SensitiveField</span>(desc = <span class="hljs-string">"支付金额"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> amount;

    <span class="hljs-comment">// getter/setter</span>
}
</code></pre>
<h5 data-id="heading-13">（2）Controller（仅加注解，无加密逻辑）</h5>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/api/pay"</span>)
public class PayController {
    <span class="hljs-variable">@Autowired</span>
    private PayService payService;

    <span class="hljs-comment">// 仅需加@ApiEncrypt注解，自动解密入参、加密出参</span>
    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/submit"</span>)
    <span class="hljs-variable">@ApiEncrypt</span>(algorithm = <span class="hljs-string">"AES-GCM"</span>, keyId = <span class="hljs-string">"pay_default_key"</span>)
    public PayResponseDTO <span class="hljs-built_in">submitPay</span>(<span class="hljs-variable">@RequestBody</span> PayRequestDTO request) {
        <span class="hljs-comment">// 业务逻辑：直接使用明文request，无需任何加密代码</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">payService</span><span class="hljs-selector-class">.submit</span>(request);
    }
}
</code></pre>
<h3 data-id="heading-14">四、通用组件的扩展与适配</h3>
<h4 data-id="heading-15">1. 适配其他框架/语言</h4>
<ul>
<li><strong>Go语言</strong>：将拦截器改为HTTP中间件（<code>http.HandlerFunc</code>），注解改为配置文件（如<code>crypto.yaml</code>指定接口规则），核心算法工厂/模板逻辑一致；</li>
<li><strong>Python</strong>：用Django/Flask的中间件（Middleware）替代拦截器，装饰器替代注解，核心逻辑封装为<code>crypto</code>模块；</li>
<li><strong>微服务场景</strong>：将组件封装为SDK，各服务引入SDK后仅需配置，无需重复开发。</li>
</ul>
<h4 data-id="heading-16">2. 扩展新算法</h4>
<p>只需实现<code>AlgorithmFactory.CryptoHandler</code>接口，无需修改核心代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 新增SM4算法（国密）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sm4Handler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AlgorithmFactory</span>.<span class="hljs-property">CryptoHandler</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> byte[] <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">byte[] data, <span class="hljs-built_in">String</span> keyId</span>) {
        <span class="hljs-comment">// SM4加密逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> byte[<span class="hljs-number">0</span>];
    }
    <span class="hljs-comment">// 实现其他方法...</span>
}
</code></pre>
<h4 data-id="heading-17">3. 性能优化（组件内置）</h4>
<ul>
<li><strong>对象池</strong>：缓存Cipher、Signature等重量级对象，避免频繁创建；</li>
<li><strong>异步处理</strong>：加解密耗时较长时，用CompletableFuture异步处理；</li>
<li><strong>硬件加速</strong>：在AlgorithmFactory中自动开启AES-NI/SHA指令集；</li>
<li><strong>批量处理</strong>：支持批量接口的加解密，减少多次调用开销。</li>
</ul>
<h3 data-id="heading-18">五、生产环境落地注意事项</h3>
<ol start="6">
<li><strong>密钥管理</strong>：生产环境禁止本地配置密钥，必须对接KMS/HSM，KeyManager中封装KMS调用逻辑；</li>
<li><strong>异常处理</strong>：组件内置统一的加密异常（<code>CryptoException</code>），全局异常处理器捕获后返回标准化错误码；</li>
<li><strong>监控告警</strong>：埋点加解密耗时、失败率，超过阈值（如1ms）告警；</li>
<li><strong>兼容性</strong>：支持部分接口不加密（通过注解/配置排除），兼容老接口平滑迁移；</li>
<li><strong>测试</strong>：组件单独写单元测试（覆盖所有算法、异常场景），业务侧仅需测试业务逻辑。</li>
</ol>
<h3 data-id="heading-19">总结</h3>
<p>通用加解密组件的核心是「<strong>拦截器+模板方法+配置驱动</strong>」：</p>
<ul>
<li>业务侧：仅需加注解/配置，完全脱离加密细节；</li>
<li>组件侧：封装所有加密逻辑，算法/密钥/规则可配置、可扩展；</li>
<li>性能：组件内部做对象池、硬件加速等优化，对业务透明。</li>
</ul>
<p>按此方案实现后，新增需要加密的接口时，仅需：</p>
<ol start="11">
<li>在DTO的敏感字段加<code>@SensitiveField</code>；</li>
<li>在Controller方法加<code>@ApiEncrypt</code>；</li>
<li>在yml中配置密钥（如需）。</li>
</ol>
<p>完全解耦业务与加密逻辑，符合企业级「高内聚、低耦合」的设计规范。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Code更新，新增异步子代理、即时压缩、自定义会话名和使用统计四大功能]]></title>    <link>https://juejin.cn/post/7582131164728737832</link>    <guid>https://juejin.cn/post/7582131164728737832</guid>    <pubDate>2025-12-11T04:13:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582131164728737832" data-draft-id="7582200865907441698" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code更新，新增异步子代理、即时压缩、自定义会话名和使用统计四大功能"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-12-11T04:13:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="子昕AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/3273679891602858"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code更新，新增异步子代理、即时压缩、自定义会话名和使用统计四大功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3273679891602858/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    子昕AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T04:13:20.000Z" title="Thu Dec 11 2025 04:13:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是子昕。</p>
<p>Claude Code昨天发了2.0.64版本，加了几个挺实用的功能。</p>
<p>我看完更新说明，第一反应是：这几个更新都挺懂使用痛点的。</p>
<h2 data-id="heading-0">核心要点</h2>
<ul>
<li><strong>异步子代理</strong>：subagent和bash命令能后台跑了，不用等一个任务完才能开下一个</li>
<li><strong>即时压缩</strong>：对话压缩从等半天变成秒压</li>
<li><strong>自定义会话名称</strong>：用<code>/rename</code>给会话起名字</li>
<li><strong>使用统计</strong>：<code>/stats</code>看你每天用了多少，哪个模型用得最多</li>
</ul>
<p>前两个改变最明显，后两个是体验补完。</p>
<h2 data-id="heading-1">异步子代理：可以在后台持续跑了</h2>
<p>这个更新的关键词是<code>异步</code>和<code>后台</code>。</p>
<p>以前subagent干活时，你得等它做完才能继续。现在可以让subagent在后台运行，更重要的是，<strong>它能持续运行，不受主任务影响</strong>。</p>
<p><strong>怎么用</strong>：在提示词里明确告诉Claude使用后台agent。比如官方示例：“Using a background agent can you poll this issue for comments every 10 seconds”，agent就会在后台每10秒检查一次。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99294f3324884de3bc5c181b72fea9a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5piVQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766031200&amp;x-signature=icfe1V7Fji%2BgF0983hkviIR3fqQ%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e7163d59ab0465991de25b7ea2dd8a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5piVQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766031200&amp;x-signature=cDMDf7Z9xZqusQAArGUvMMgnUuA%3D" alt="图片" loading="lazy"/></p>
<p><strong>适合的场景</strong>：</p>
<ul>
<li>让后台agent每隔一段时间监控错误日志，发现新错误立即通知</li>
<li>定期轮询某个API或文件的变化</li>
<li>监控测试运行状态，完成后汇报结果</li>
<li>长时间运行的任务（编译、部署）进度跟踪</li>
</ul>
<p>这个功能的价值在于：你可以继续做其他事，让agent在后台帮你盯着。不用人工反复检查。</p>
<p>关于subagent的更多用法和配置，可以看我之前写的文章。</p>
<h2 data-id="heading-2">即时压缩：终于不用干等了</h2>
<p>压缩功能之前就有，但体验很差，有时候要等2-5分钟。</p>
<p>这次更新后，几乎是秒完成。</p>
<p><strong>怎么用</strong>：还是老办法，输入<code>/compact</code>，但现在速度快得多。或者你什么都不做，系统也会在后台自动压缩摘要。</p>
<p><strong>适合的场景</strong>：</p>
<ul>
<li>长对话到100+轮时，定期压一下</li>
<li>感觉响应变慢了，可能是context太长了</li>
<li>一个项目持续好几天，中间想清理一下对话</li>
</ul>
<p>不过提醒一句：别过度依赖压缩。最好的做法是在上下文快用完之前，自己整理好文档和关键信息，重新开个会话。压缩只是辅助手段。</p>
<h2 data-id="heading-3">自定义会话名称：找对话方便了</h2>
<p>很简单的功能，但挺实用。</p>
<p>输入<code>/rename 你想要的名字</code>，当前会话就改名了。在/resume界面还加了快捷键：按R改名，按P预览。</p>
<p>以前会话名称可能是系统自动生成的，不太好辨识。现在可以自己改成有意义的名字，找起来方便多了。</p>
<h2 data-id="heading-4">使用统计：心里有个数</h2>
<p>输入<code>/stats</code>会显示一个可视化界面，告诉你：</p>
<ul>
<li>每天用了多少次Claude Code</li>
<li>总共开了多少会话</li>
<li>连续使用多少天</li>
<li>最常用的模型是哪个</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a0b9057ced14e89955d8ec3ca46c50c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5piVQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766031200&amp;x-signature=g7HgolWyCvHx0bhiWIS7LwJQgNs%3D" alt="Overview" loading="lazy"/></p>
<p>Overview</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa2533ef63e94ea68a41afcb1e590efb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5piVQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766031200&amp;x-signature=D%2BwdNIUsbbpeWEYrp7GC9BP8kPs%3D" alt="Models" loading="lazy"/></p>
<p>Models</p>
<p><strong>适合的场景</strong>：</p>
<ul>
<li>想知道自己用Claude Code的习惯</li>
<li>看看是不是过度依赖某个贵的模型</li>
<li>纯粹好奇自己的使用数据</li>
</ul>
<p>这个功能更多是“了解自己”，对日常开发影响不大，但看看数据挺有意思的。</p>
<h2 data-id="heading-5">简单说两句</h2>
<p>这几个更新都不算大功能，但都是在解决实际使用中的痛点：</p>
<p>异步让效率提升是实打实的，特别是需要多任务协作的场景。压缩速度提升也是，之前那个慢速度真的让人不想用。至于改名和统计，算是锦上添花，有比没有好。</p>
<p>如果你在用Claude Code，运行<code>claude update</code>就能更新到最新版。</p>
<p>更多内容，欢迎关注微信公众号「子昕AI编程」</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：创建 HTTP/HTTPS 服务器全解析]]></title>    <link>https://juejin.cn/post/7582149417769304114</link>    <guid>https://juejin.cn/post/7582149417769304114</guid>    <pubDate>2025-12-11T07:23:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582149417769304114" data-draft-id="7582182817108082714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 编程实战：创建 HTTP/HTTPS 服务器全解析"/> <meta itemprop="keywords" content="后端,Node.js,Trae"/> <meta itemprop="datePublished" content="2025-12-11T07:23:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 编程实战：创建 HTTP/HTTPS 服务器全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T07:23:07.000Z" title="Thu Dec 11 2025 07:23:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>Node.js 的核心能力之一就是快速创建高性能的服务器。通过内置的 <code>http</code> 和 <code>https</code> 模块，你可以在几行代码内搭建功能完善的 Web 服务。本文将系统讲解如何在 Node.js 中创建 HTTP 与 HTTPS 服务器，包括基础用法、请求处理、HTTPS 证书配置，以及性能与安全优化实践。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、Node.js HTTP 服务器基础</h2>
<p>Node.js 内置的 <code>http</code> 模块让创建 HTTP 服务器非常简单。</p>
<h3 data-id="heading-1">1. 基本示例</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">"http"</span>);

<span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">200</span>;
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/plain"</span>);
  res.<span class="hljs-title function_">end</span>(<span class="hljs-string">"Hello Node.js HTTP Server!"</span>);
});

server.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Server running at http://localhost:3000/"</span>);
});
</code></pre>
<p>说明：</p>
<ul>
<li><code>http.createServer</code> 返回一个服务器实例</li>
<li>回调函数 <code>(req, res)</code> 在每次请求到来时触发</li>
<li><code>req</code> 包含请求信息，<code>res</code> 用于发送响应</li>
<li><code>server.listen</code> 绑定端口并启动服务器</li>
</ul>
<hr/>
<h2 data-id="heading-2">二、处理请求与响应</h2>
<p>HTTP 请求包含方法、URL、头信息和请求体。响应也可以设置状态码、头信息及数据。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">"GET"</span> &amp;&amp; req.<span class="hljs-property">url</span> === <span class="hljs-string">"/"</span>) {
    res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/html"</span> });
    res.<span class="hljs-title function_">end</span>(<span class="hljs-string">"&lt;h1&gt;Welcome Home&lt;/h1&gt;"</span>);
  } <span class="hljs-keyword">else</span> {
    res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">404</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/plain"</span> });
    res.<span class="hljs-title function_">end</span>(<span class="hljs-string">"Page Not Found"</span>);
  }
});
</code></pre>
<p>技巧与建议：</p>
<ul>
<li>对请求进行路由判断，区分不同路径和方法</li>
<li>响应头要根据内容类型设置</li>
<li>大型项目可使用第三方框架如 Express 做路由和中间件管理</li>
</ul>
<hr/>
<h2 data-id="heading-3">三、Node.js HTTPS 服务器</h2>
<p>在实际生产环境中，HTTPS 已经是必须。Node.js 提供 <code>https</code> 模块支持加密传输。</p>
<h3 data-id="heading-4">1. 准备证书</h3>
<p>创建 HTTPS 服务器前，需要拥有：</p>
<ul>
<li><code>key.pem</code>：私钥文件</li>
<li><code>cert.pem</code>：证书文件（可以用自签名证书做测试）</li>
</ul>
<p>可以使用 OpenSSL 生成测试证书：</p>
<pre><code class="hljs language-bash" lang="bash">openssl req -nodes -new -x509 -keyout key.pem -out cert.pem
</code></pre>
<hr/>
<h3 data-id="heading-5">2. 创建 HTTPS 服务器</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> https = <span class="hljs-built_in">require</span>(<span class="hljs-string">"https"</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);

<span class="hljs-keyword">const</span> options = {
  <span class="hljs-attr">key</span>: fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">"key.pem"</span>),
  <span class="hljs-attr">cert</span>: fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">"cert.pem"</span>)
};

<span class="hljs-keyword">const</span> server = https.<span class="hljs-title function_">createServer</span>(options, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/plain"</span> });
  res.<span class="hljs-title function_">end</span>(<span class="hljs-string">"Hello Node.js HTTPS Server!"</span>);
});

server.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3443</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"HTTPS Server running at https://localhost:3443/"</span>);
});
</code></pre>
<p>注意事项：</p>
<ul>
<li>HTTPS 必须提供证书和私钥</li>
<li>在生产环境中，请使用由可信 CA 签发的证书</li>
<li>端口一般为 443（HTTP 默认端口为 80）</li>
</ul>
<hr/>
<h2 data-id="heading-6">四、性能优化建议</h2>
<p>虽然 Node.js 的 <code>http</code> 和 <code>https</code> 模块足够轻量，但在高并发场景下，仍然可以优化：</p>
<ol>
<li><strong>开启 Keep-Alive</strong>
保持 TCP 连接，减少握手开销：</li>
</ol>
<pre><code class="hljs language-js" lang="js">res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Connection"</span>, <span class="hljs-string">"keep-alive"</span>);
</code></pre>
<ol start="2">
<li><strong>使用 gzip 压缩</strong>
减少传输数据量，提高响应速度：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> zlib = <span class="hljs-built_in">require</span>(<span class="hljs-string">"zlib"</span>);
res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, { <span class="hljs-string">"Content-Encoding"</span>: <span class="hljs-string">"gzip"</span> });
res.<span class="hljs-title function_">end</span>(zlib.<span class="hljs-title function_">gzipSync</span>(<span class="hljs-string">"Hello World!"</span>));
</code></pre>
<ol start="3">
<li><strong>利用集群（cluster）提升 CPU 利用率</strong>
Node.js 单线程模型可以通过 cluster 模块启动多进程：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> cluster = <span class="hljs-built_in">require</span>(<span class="hljs-string">"cluster"</span>);
<span class="hljs-keyword">const</span> os = <span class="hljs-built_in">require</span>(<span class="hljs-string">"os"</span>);

<span class="hljs-keyword">if</span> (cluster.<span class="hljs-property">isMaster</span>) {
  <span class="hljs-keyword">const</span> cpuCount = os.<span class="hljs-title function_">cpus</span>().<span class="hljs-property">length</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; cpuCount; i++) {
    cluster.<span class="hljs-title function_">fork</span>();
  }
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// worker 进程启动 HTTP/HTTPS 服务器</span>
}
</code></pre>
<ol start="4">
<li><strong>使用缓存</strong>
对静态文件或接口数据使用内存缓存或 CDN，降低重复计算和 I/O 压力。</li>
</ol>
<hr/>
<h2 data-id="heading-7">五、常见应用场景</h2>
<ul>
<li>搭建静态文件服务器</li>
<li>提供 RESTful API 服务</li>
<li>接入 WebSocket 做实时通信</li>
<li>内网工具或微服务</li>
<li>HTTPS 接入支付、认证等安全场景</li>
</ul>
<p>Node.js 的 HTTP/HTTPS 服务器能力非常适合高并发和轻量服务场景。</p>
<hr/>
<h2 data-id="heading-8">六、总结</h2>
<p>通过本文，你应该掌握了：</p>
<ol>
<li>HTTP 服务器的创建与请求处理</li>
<li>HTTPS 服务器的证书配置和创建</li>
<li>异步请求处理与响应机制</li>
<li>高性能与安全优化策略</li>
</ol>
<p>Node.js 内置的 HTTP/HTTPS 模块简单高效，非常适合构建高性能微服务和 API。
理解这些基础，为使用 Express、Koa 等框架打下了坚实的底层基础。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C# Params Collections 详解：比 params T[] 更强大的新语法]]></title>    <link>https://juejin.cn/post/7582090790181879846</link>    <guid>https://juejin.cn/post/7582090790181879846</guid>    <pubDate>2025-12-11T00:10:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582090790181879846" data-draft-id="7582041304655413294" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C# Params Collections 详解：比 params T[] 更强大的新语法"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-12-11T00:10:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C# Params Collections 详解：比 params T[] 更强大的新语法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T00:10:11.000Z" title="Thu Dec 11 2025 00:10:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<p><code>Params Collections</code> 是 <code>C# 12</code> 中引入的新特性，它扩展了传统的 <code>params</code> 关键字功能，使其不仅支持数组，还能支持各种集合类型。这个特性使得方法能够接受可变数量的参数，并且这些参数可以自动转换为指定的集合类型。</p>
<p>关键特点：</p>
<ul>
<li>
<p>可变参数：调用者可以传递任意数量的参数（包括零个）。</p>
</li>
<li>
<p>类型安全：<code>params</code> 参数是强类型的，编译器确保参数类型匹配。</p>
</li>
<li>
<p>单一 <code>params</code> 参数：一个方法只能有一个 <code>params</code> 参数，且必须是最后一个参数。</p>
</li>
<li>
<p><code>C# 12</code> 扩展：支持非数组集合类型（如 <code>List</code>, <code>Span</code>），适合高性能或特定场景。</p>
</li>
</ul>
<h3 data-id="heading-1">核心特性</h3>
<h4 data-id="heading-2">支持任意集合类型</h4>
<ul>
<li>可指定 <code>List、Span、IReadOnlyCollection</code> 等作为参数类型</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LogEntries</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> List messages</span>)</span> { ... }
</code></pre>
<h4 data-id="heading-3">自动集合构造</h4>
<ul>
<li>编译器自动将离散参数转换为目标集合类型实例</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">AnalyzeNumbers(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>); 
<span class="hljs-comment">// 等效于：</span>
AnalyzeNumbers(<span class="hljs-keyword">new</span> List { <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span> });
</code></pre>
<h4 data-id="heading-4">与现有 params 兼容</h4>
<ul>
<li>
<p>传统 <code>params T[]</code> 仍然有效</p>
</li>
<li>
<p>新语法不会破坏已有代码</p>
</li>
</ul>
<h3 data-id="heading-5">传统 params 关键字</h3>
<p>在 <code>C# 12</code> 之前，<code>params</code> 关键字只能用于数组：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 传统的 params 数组用法</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessNumbers</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> <span class="hljs-built_in">int</span>[] numbers</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> number <span class="hljs-keyword">in</span> numbers)
    {
        Console.WriteLine(number);
    }
}

<span class="hljs-comment">// 调用方式</span>
ProcessNumbers(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);
</code></pre>
<h3 data-id="heading-6">Params Collections 的新特性</h3>
<p><code>C# 12</code> 扩展了 <code>params</code> 关键字，使其能够用于任何集合类型，只要该类型满足特定条件。</p>
<h4 data-id="heading-7">基本语法</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用 params 与集合类型</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessNumbers</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> List numbers</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> number <span class="hljs-keyword">in</span> numbers)
    {
        Console.WriteLine(number);
    }
}

<span class="hljs-comment">// 调用方式不变</span>
ProcessNumbers(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);
</code></pre>
<h3 data-id="heading-8">支持的条件</h3>
<p>要使集合类型能够与 <code>params</code> 关键字一起使用，必须满足以下条件之一：</p>
<ul>
<li>
<p>集合类型必须有一个无参数的构造函数</p>
</li>
<li>
<p>集合类型必须有一个 <code>Add</code> 方法，用于添加元素</p>
</li>
<li>
<p>集合类型必须实现 <code>IEnumerable</code></p>
</li>
</ul>
<h4 data-id="heading-9">自定义集合与 params</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 自定义集合类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NumberCollection</span> : <span class="hljs-title">IEnumerable</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> List _numbers = <span class="hljs-keyword">new</span>();
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Add</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> number</span>)</span> =&gt; _numbers.Add(number);
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerator <span class="hljs-title">GetEnumerator</span>()</span> =&gt; _numbers.GetEnumerator();
    
    IEnumerator IEnumerable.GetEnumerator() =&gt; GetEnumerator();
}

<span class="hljs-comment">// 使用自定义集合作为 params 参数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessNumbers</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> NumberCollection numbers</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> number <span class="hljs-keyword">in</span> numbers)
    {
        Console.WriteLine(number);
    }
}

<span class="hljs-comment">// 调用</span>
ProcessNumbers(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);
</code></pre>
<h3 data-id="heading-10">实际应用示例</h3>
<h4 data-id="heading-11">与 Span 和 ReadOnlySpan 结合使用</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用 Span 作为 params 参数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessData</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> Span data</span>)</span>
{
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; data.Length; i++)
    {
        data[i] *= <span class="hljs-number">2</span>;
    }
}

<span class="hljs-comment">// 调用</span>
<span class="hljs-built_in">int</span>[] array = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
ProcessData(array);
Console.WriteLine(<span class="hljs-built_in">string</span>.Join(&amp;<span class="hljs-meta">#34;, &amp;#34;, array)); // 输出: 2, 4, 6, 8, 10</span>
</code></pre>
<h4 data-id="heading-12">与 Immutable Collections 结合使用</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System.Collections.Immutable;

<span class="hljs-comment">// 使用不可变集合作为 params 参数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessItems</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> ImmutableArray items</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> items)
    {
        Console.WriteLine(item);
    }
}

<span class="hljs-comment">// 调用</span>
ProcessItems(&amp;<span class="hljs-meta">#34;apple&amp;#34;, &amp;#34;banana&amp;#34;, &amp;#34;cherry&amp;#34;);</span>
</code></pre>
<h3 data-id="heading-13">高级用法</h3>
<h4 data-id="heading-14">泛型方法与 params 集合</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 泛型方法中使用 params 集合</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessCollection</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> List collection</span>)
    <span class="hljs-keyword">where</span> T : <span class="hljs-keyword">notnull</span></span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> collection)
    {
        Console.WriteLine(item);
    }
}

<span class="hljs-comment">// 调用</span>
ProcessCollection(&amp;<span class="hljs-meta">#34;a&amp;#34;, &amp;#34;b&amp;#34;, &amp;#34;c&amp;#34;); // 字符串列表</span>
ProcessCollection(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);       <span class="hljs-comment">// 整数列表</span>
</code></pre>
<h4 data-id="heading-15">与模式匹配结合使用</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用模式匹配处理 params 集合</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">HandleValues</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> <span class="hljs-built_in">int</span>[] values</span>)</span>
{
    <span class="hljs-keyword">switch</span> (values)
    {
        <span class="hljs-keyword">case</span> [<span class="hljs-keyword">var</span> first, .. <span class="hljs-keyword">var</span> middle, <span class="hljs-keyword">var</span> last]:
            Console.WriteLine($&amp;<span class="hljs-meta">#34;首: {first}, 尾: {last}, 中间有 {middle.Length} 个元素&amp;#34;);</span>
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> [<span class="hljs-keyword">var</span> single]:
            Console.WriteLine($&amp;<span class="hljs-meta">#34;单个值: {single}&amp;#34;);</span>
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> []:
            Console.WriteLine(&amp;<span class="hljs-meta">#34;空集合&amp;#34;);</span>
            <span class="hljs-keyword">break</span>;
    }
}

<span class="hljs-comment">// 调用</span>
HandleValues(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>); <span class="hljs-comment">// 输出: 首: 1, 尾: 5, 中间有 3 个元素</span>
HandleValues(<span class="hljs-number">42</span>);            <span class="hljs-comment">// 输出: 单个值: 42</span>
HandleValues();              <span class="hljs-comment">// 输出: 空集合</span>
</code></pre>
<h4 data-id="heading-16">与接口结合使用</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用接口作为 params 参数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessEnumerables</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> IEnumerable[] collections</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> collection <span class="hljs-keyword">in</span> collections)
    {
        <span class="hljs-built_in">int</span> sum = collection.Sum();
        Console.WriteLine($&amp;<span class="hljs-meta">#34;集合总和: {sum}&amp;#34;);</span>
    }
}

<span class="hljs-comment">// 调用</span>
ProcessEnumerables(
    <span class="hljs-keyword">new</span> List { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span> },
    <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[] { <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span> },
    <span class="hljs-keyword">new</span> HashSet { <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span> }
);
</code></pre>
<h4 data-id="heading-17">高性能求和（使用 <code>Span</code>）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">decimal</span> <span class="hljs-title">Average</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> Span numbers</span>)</span>
{
    <span class="hljs-keyword">if</span> (numbers.Length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-built_in">decimal</span> sum = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> num <span class="hljs-keyword">in</span> numbers)
    {
        sum += num;
    }
    <span class="hljs-keyword">return</span> sum / numbers.Length;
}

Console.WriteLine(Average(<span class="hljs-number">1.5</span>m, <span class="hljs-number">2.5</span>m, <span class="hljs-number">3.5</span>m)); <span class="hljs-comment">// 输出: 2.5</span>
</code></pre>
<ul>
<li>
<p>使用 <code>Span</code> 避免数组分配，提高性能。</p>
</li>
<li>
<p>适合处理大量数值计算。</p>
</li>
</ul>
<h3 data-id="heading-18">适用场景</h3>
<ul>
<li>
<p>简化方法调用：允许调用者传递任意数量的参数，减少重载需求。</p>
</li>
<li>
<p>处理集合数据：适合处理列表、数组或序列，例如日志记录、字符串连接、数学计算。</p>
</li>
<li>
<p>高性能场景（<code>C# 12+</code>）：使用 <code>Span</code> 或 <code>ReadOnlySpan</code> 减少堆分配，优化性能。</p>
</li>
<li>
<p>与本机代码交互：<code>Span</code> 类型的 <code>params</code> 参数适合传递连续内存块。</p>
</li>
<li>
<p>灵活接口设计：为方法提供通用接口，支持不同数量的输入。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Compose 高级状态和附带效应]]></title>    <link>https://juejin.cn/post/7582231988146782259</link>    <guid>https://juejin.cn/post/7582231988146782259</guid>    <pubDate>2025-12-11T09:00:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582231988146782259" data-draft-id="7581648776302690313" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Compose 高级状态和附带效应"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-11T09:00:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Best_Jerry"/> <meta itemprop="url" content="https://juejin.cn/user/1099167360106999"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Compose 高级状态和附带效应
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167360106999/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Best_Jerry
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T09:00:47.000Z" title="Thu Dec 11 2025 09:00:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-advanced-state-side-effects%3Fhl%3Dzh-cn%26continue%3Dhttps%253A%252F%252Fdeveloper.android.com%252Fcourses%252Fpathways%252Fjetpack-compose-for-android-developers-3%253Fhl%253Dzh-cn%2523codelab-https%253A%252F%252Fdeveloper.android.com%252Fcodelabs%252Fjetpack-compose-advanced-state-side-effects%230" target="_blank" title="https://developer.android.com/codelabs/jetpack-compose-advanced-state-side-effects?hl=zh-cn&amp;continue=https%3A%2F%2Fdeveloper.android.com%2Fcourses%2Fpathways%2Fjetpack-compose-for-android-developers-3%3Fhl%3Dzh-cn%23codelab-https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-advanced-state-side-effects#0" ref="nofollow noopener noreferrer">Jetpack Compose 中的高级状态和附带效应</a></p>
<p>了解与 Jetpack Compose 中的状态和附带效应 API 相关的高级概念。了解如何为复杂的有状态可组合项创建状态容器、通过 Compose 代码创建协程和调用挂起函数，以及针对不同的用例触发附带效应。</p>
<h2 data-id="heading-0">1. 简介</h2>
<p>在此 Codelab 中，您将学习与 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose?hl=zh-cn" ref="nofollow noopener noreferrer">Jetpack Compose</a> 中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fstate%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/state?hl=zh-cn" ref="nofollow noopener noreferrer">状态</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fside-effects%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/side-effects?hl=zh-cn" ref="nofollow noopener noreferrer">附带效应</a> API 相关的高级概念。您将了解如何为逻辑并不简单的有状态可组合项创建状态容器，如何从 Compose 代码创建协程并调用挂起函数，以及如何触发附带效应以完成不同的用例。</p>
<h3 data-id="heading-1">学习内容</h3>
<ul>
<li>如何从 Compose 代码观察数据流以更新界面。</li>
<li>如何为有状态可组合项创建状态容器。</li>
<li>附带效应 API，如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23LaunchedEffect(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#LaunchedEffect(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>LaunchedEffect</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberUpdatedState(kotlin.Any)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#rememberUpdatedState(kotlin.Any)" ref="nofollow noopener noreferrer"><code>rememberUpdatedState</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23DisposableEffect(kotlin.Any%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#DisposableEffect(kotlin.Any,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>DisposableEffect</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23produceState(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#produceState(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>produceState</code></a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23derivedStateOf(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#derivedStateOf(kotlin.Function0)" ref="nofollow noopener noreferrer"><code>derivedStateOf</code></a>。</li>
<li>如何使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberCoroutineScope(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#rememberCoroutineScope(kotlin.Function0)" ref="nofollow noopener noreferrer"><code>rememberCoroutineScope</code></a> API 在可组合项中创建协程并调用挂起函数。</li>
</ul>
<h3 data-id="heading-2">构建内容</h3>
<p>在此 Codelab 中，您将从一个未完成的应用（即 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmaterial.io%2Fdesign%2Fmaterial-studies%2Fcrane.html" target="_blank" title="https://material.io/design/material-studies/crane.html" ref="nofollow noopener noreferrer">Crane 材料研究</a>应用）着手，并且将添加一些功能来改进该应用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/218536e9496a435fb0681a2146737071~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=kqIGHfyp0F6%2F%2F%2FJJ5fFJJuqCOMM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">2. 准备工作</h2>
<h3 data-id="heading-4">获取代码</h3>
<p>此 Codelab 的代码可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgooglecodelabs%2Fandroid-compose-codelabs" target="_blank" title="https://github.com/googlecodelabs/android-compose-codelabs" ref="nofollow noopener noreferrer">android-compose-codelabs GitHub 代码库</a>中找到。如需克隆该代码库，请运行以下命令：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$ </span><span class="bash">git <span class="hljs-built_in">clone</span> https://github.com/android/codelab-android-compose</span>
</code></pre>
<p>或者，您也能以 Zip 文件的形式下载该代码库：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcodelab-android-compose%2Farchive%2Fmain.zip" target="_blank" title="https://github.com/android/codelab-android-compose/archive/main.zip" ref="nofollow noopener noreferrer">file_download下载 ZIP 文件</a></p>
<h3 data-id="heading-5">查看示例应用</h3>
<p>您刚刚下载的代码包含提供的所有 Compose Codelab 的代码。为了完成此 Codelab，请在 Android Studio 中打开 <strong><code>AdvancedStateAndSideEffectsCodelab</code></strong> 项目。</p>
<blockquote>
<p>compose-codelabs 库包含开发者在线课程中所有 Codelab 的起始代码。</p>
<p>对于此 Codelab，请使用 <strong>AdvancedStateAndSideEffectsCodelab</strong> 项目。</p>
<ul>
<li><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6403907abaa41fab678e0688b3684a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=hEMriE4dN0WgBVdsYRGV959b%2FMs%3D" alt="android_studio_folder.png" loading="lazy"/> <strong>AdvancedStateAndSideEffectsCodelab</strong> - 该项目包含此 Codelab 的起始代码和完成后的代码。</li>
</ul>
<p>该项目在多个 git 分支中构建而成：</p>
<ul>
<li><strong>main</strong> - 该项目的起始代码；您将更改这些代码来完成此 Codelab。</li>
<li><strong>end</strong> - 包含此 Codelab 的解决方案。</li>
</ul>
</blockquote>
<p>我们建议您从 main 分支中的代码着手，按照自己的节奏逐步完成此 Codelab。</p>
<p>在本 Codelab 中，系统会为您显示需要添加到项目的代码段。在某些地方，您还需要移除在代码段的注释中明确提及的代码。</p>
<h3 data-id="heading-6">熟悉代码并运行示例应用</h3>
<p>先花点时间浏览一下项目结构，然后再运行应用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0938746571fd46028bd2fbae0acdd71d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=wajQEIjQPPLXYQhdH224t6h55Ks%3D" alt="162c42b19dafa701.png" loading="lazy"/></p>
<p>从 main 分支运行应用时，您会看到某些功能（如抽屉式导航栏或加载航班目的地的功能）不起作用！这就是您在此 Codelab 的后续步骤中要改进的地方。</p>
<h3 data-id="heading-7">界面测试</h3>
<p>系统会对应用执行 <code>androidTest</code> 文件夹中提供的非常基本的界面测试。对于 <code>main</code> 和 <code>end</code> 分支，始终都应通过这些测试。</p>
<h3 data-id="heading-8">[可选] 在详情屏幕上显示地图</h3>
<p>完全没有必要按照相关说明在详情屏幕上显示城市地图。不过，如果您想要看到地图，那么需要获取个人 API 密钥，如<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fmaps%2Fdocumentation%2Fandroid-sdk%2Fget-api-key%3Fhl%3Dzh-cn" target="_blank" title="https://developers.google.com/maps/documentation/android-sdk/get-api-key?hl=zh-cn" ref="nofollow noopener noreferrer">“地图”文档</a>中所述。按如下方式在 <code>local.properties</code> 文件中添加该密钥：</p>
<pre><code class="hljs language-ini" lang="ini">// local.properties file
<span class="hljs-attr">google.maps.key</span>={insert_your_api_key_here}
</code></pre>
<blockquote>
<p>在 Google 信息中心内设置凭据时，务必将 <code>androidx.compose.samples.crane</code> 用作软件包名称，并将 <code>A0:BD:B3:B6:F0:C4:BE:90:C6:9D:5F:4C:1D:F0:90:80:7F:D7:FE:1F</code> 用作 SHA-1 证书指纹。</p>
</blockquote>
<h3 data-id="heading-9">此 Codelab 的解决方案</h3>
<p>如需使用 git 获取 <code>end</code> 分支，请使用以下命令：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$ </span>git clone -b <span class="hljs-keyword">end</span> <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/android</span><span class="hljs-regexp">/codelab-android-compose
</span></code></pre>
<p>或者，您也可以在此处下载解决方案代码：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcodelab-android-compose%2Farchive%2Fend.zip" target="_blank" title="https://github.com/android/codelab-android-compose/archive/end.zip" ref="nofollow noopener noreferrer">file_download下载最终代码</a></p>
<h2 data-id="heading-10">3. 界面状态生成流水线</h2>
<p>您可能已经注意到，从 <code>main</code> 分支运行应用时，航班目的地列表为空！</p>
<p>如要解决此问题，您必须完成以下两个步骤：</p>
<ul>
<li>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftopic%2Flibraries%2Farchitecture%2Fviewmodel%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/topic/libraries/architecture/viewmodel?hl=zh-cn" ref="nofollow noopener noreferrer"><code>ViewModel</code></a> 中添加逻辑以生成<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftopic%2Farchitecture%2Fui-layer%2Fstateholders%3Fhl%3Dzh-cn%23elements-ui" target="_blank" title="https://developer.android.com/topic/architecture/ui-layer/stateholders?hl=zh-cn#elements-ui" ref="nofollow noopener noreferrer">界面状态</a>。在本示例中，即推荐目的地列表。</li>
<li>从界面取用该界面状态，这样就会在画面上显示界面。</li>
</ul>
<p>良好的应用架构会分层级，遵循基本的良好系统设计实践，例如关注点分离和可测试性。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftopic%2Farchitecture%2Fui-layer%2Fstate-production%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/topic/architecture/ui-layer/state-production?hl=zh-cn" ref="nofollow noopener noreferrer">界面状态生成</a>是指以下过程：应用访问数据层、应用业务规则（如果需要），以及公开要从界面取用的界面状态。</p>
<p>此应用中的数据层已实现。现在，您将生成状态（推荐目的地列表），以便界面可以取用该状态。</p>
<p>有几个 API 可用于生成界面状态。如要了解替代方案，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftopic%2Farchitecture%2Fui-layer%2Fstate-production%3Fhl%3Dzh-cn%23output-types" target="_blank" title="https://developer.android.com/topic/architecture/ui-layer/state-production?hl=zh-cn#output-types" ref="nofollow noopener noreferrer">状态生成流水线中的输出类型</a>文档。一般而言，最好使用 Kotlin 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fapi%2Fkotlinx.coroutines%2Fkotlinx-coroutines-core%2Fkotlinx.coroutines.flow%2F-state-flow%2F" target="_blank" title="https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-state-flow/" ref="nofollow noopener noreferrer"><code>StateFlow</code></a> 生成界面状态。</p>
<p>如要生成界面状态，请按以下步骤操作：</p>
<ol>
<li>打开 <code>home/MainViewModel.kt</code>。</li>
<li>定义一个类型为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fapi%2Fkotlinx.coroutines%2Fkotlinx-coroutines-core%2Fkotlinx.coroutines.flow%2F-mutable-state-flow%2F" target="_blank" title="https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-mutable-state-flow/" ref="nofollow noopener noreferrer"><code>MutableStateFlow</code></a> 的私有 <code>_suggestedDestinations</code> 变量，用于表示推荐目的地列表，并将空列表设置为起始值。</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _suggestedDestinations = MutableStateFlow&lt;List&lt;ExploreModel&gt;&gt;(emptyList())
</code></pre>
<ol start="3">
<li>定义第二个不可变变量 <code>suggestedDestinations</code>，类型为 <code>StateFlow</code>。这是可从界面取用的公开只读变量。建议您公开只读变量，并在内部使用可变变量。这样做可确保界面状态无法修改，除非通过 <code>ViewModel</code> 使其成为单一可信来源。扩展函数 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fapi%2Fkotlinx.coroutines%2Fkotlinx-coroutines-core%2Fkotlinx.coroutines.flow%2Fas-state-flow.html" target="_blank" title="https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/as-state-flow.html" ref="nofollow noopener noreferrer"><code>asStateFlow</code></a> 会将可变流转换为不可变流。</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _suggestedDestinations = MutableStateFlow&lt;List&lt;ExploreModel&gt;&gt;(emptyList())

<span class="hljs-keyword">val</span> suggestedDestinations: StateFlow&lt;List&lt;ExploreModel&gt;&gt; = _suggestedDestinations.asStateFlow()
</code></pre>
<ol start="4">
<li>在 <code>ViewModel</code> 的 init 块中，添加来自 <code>destinationsRepository</code> 的调用，以便从数据层获取目的地。</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _suggestedDestinations = MutableStateFlow&lt;List&lt;ExploreModel&gt;&gt;(emptyList())

<span class="hljs-keyword">val</span> suggestedDestinations: StateFlow&lt;List&lt;ExploreModel&gt;&gt; = _suggestedDestinations.asStateFlow()

<span class="hljs-keyword">init</span> {
    _suggestedDestinations.value = destinationsRepository.destinations
}
</code></pre>
<ol start="5">
<li>最后，取消注释在此类中找到的内部变量 <code>_suggestedDestinations</code> 使用情况，以便可通过来自界面的事件正确更新该变量。</li>
</ol>
<p>现在，<code>ViewModel</code> 能够生成界面状态。在下一步中，您将从界面取用此状态。</p>
<h2 data-id="heading-11">4. 从 ViewModel 安全地使用流</h2>
<p>航班目的地列表仍然为空。在上一步中，您在 <code>MainViewModel</code> 中生成了界面状态。现在，您将使用要在界面中显示并由 <code>MainViewModel</code> 公开的界面状态。</p>
<p>打开 <code>home/CraneHome.kt</code> 文件并查看 <code>CraneHomeContent</code> 可组合项。</p>
<p>被分配给一个记住的空列表的 <code>suggestedDestinations</code> 的定义上面有一条 TODO 注释。这就是屏幕上显示的内容：一个空列表！在此步骤中，您将解决该问题，并显示 <code>MainViewModel</code> 公开的推荐目的地。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fa34cb764894f04ba0583dc19732ebe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=C9umu%2BSd9r5UJA%2FzEi%2FkfXYu8z8%3D" alt="image.png" loading="lazy"/></p>
<p>打开 <code>home/MainViewModel.kt</code> 并查看 <code>suggestedDestinations</code> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fkotlin%2Fflow%2Fstateflow-and-sharedflow%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/kotlin/flow/stateflow-and-sharedflow?hl=zh-cn" ref="nofollow noopener noreferrer">StateFlow</a>，该 StateFlow 初始化为 <code>destinationsRepository.destinations</code>，并且会在调用 <code>updatePeople</code> 或 <code>toDestinationChanged</code> 函数时得到更新。</p>
<p>您希望每当有新项被发送到 <code>suggestedDestinations</code> 数据流时 <code>CraneHomeContent</code> 可组合项中的界面都会更新。您可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Flifecycle%2Fcompose%2Fpackage-summary%3Fhl%3Dzh-cn%23(kotlinx.coroutines.flow.Flow).collectAsStateWithLifecycle(kotlin.Any%2Candroidx.lifecycle.Lifecycle%2Candroidx.lifecycle.Lifecycle.State%2Ckotlin.coroutines.CoroutineContext)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/lifecycle/compose/package-summary?hl=zh-cn#(kotlinx.coroutines.flow.Flow).collectAsStateWithLifecycle(kotlin.Any,androidx.lifecycle.Lifecycle,androidx.lifecycle.Lifecycle.State,kotlin.coroutines.CoroutineContext)" ref="nofollow noopener noreferrer"><code>collectAsStateWithLifecycle()</code></a> 函数。<code>collectAsStateWithLifecycle()</code> 会以生命周期感知型方式从 <code>StateFlow</code> 收集值并通过 Compose 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2FState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/State?hl=zh-cn" ref="nofollow noopener noreferrer">State</a> API 表示最新值。这样会使读取该状态值的 Compose 代码在发出新项时重组。</p>
<p>如需开始使用 <code>collectAsStateWithLifecycle</code> API，请先在 <code>app/build.gradle</code> 中添加以下<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fandroidx%2Freleases%2Flifecycle%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/androidx/releases/lifecycle?hl=zh-cn" ref="nofollow noopener noreferrer">依赖项</a>。变量 <code>lifecycle_version</code> 已在项目中使用适当版本进行定义。</p>
<pre><code class="hljs language-bash" lang="bash">dependencies {
    implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-runtime-compose:<span class="hljs-variable">$lifecycle_version</span>"</span>
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：如需详细了解 <code>collectAsStateWithLifecycle()</code> API，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fandroiddevelopers%2Fconsuming-flows-safely-in-jetpack-compose-cde014d0d5a3" target="_blank" title="https://medium.com/androiddevelopers/consuming-flows-safely-in-jetpack-compose-cde014d0d5a3" ref="nofollow noopener noreferrer">在 Jetpack Compose 中安全地使用流</a>这篇博文。</p>
</blockquote>
<p>返回 <code>CraneHomeContent</code> 可组合项，并将分配 <code>suggestedDestinations</code> 的代码行替换为 <code>ViewModel</code> 的 <code>suggestedDestinations</code> 属性上的 <code>collectAsStateWithLifecycle</code> 调用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.lifecycle.compose.collectAsStateWithLifecycle

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CraneHomeContent</span><span class="hljs-params">(
    onExploreItemClicked: <span class="hljs-type">OnExploreItemClicked</span>,
    openDrawer: () -&gt; <span class="hljs-type">Unit</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    viewModel: <span class="hljs-type">MainViewModel</span> = viewModel()</span></span>,
) {
    <span class="hljs-keyword">val</span> suggestedDestinations <span class="hljs-keyword">by</span> viewModel.suggestedDestinations.collectAsStateWithLifecycle()
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>如果您运行应用，您会看到目的地列表已填充，并且每当您点按旅行人数时，目的地都会发生变化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/215aaf4ff0dd4b2192a1bfd293b9768c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=7hq7zWN3WNYFxtSo0dQktRTKMfs%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>Compose 还为最热门的基于数据流的 Android 解决方案提供了 API：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Flivedata%2Fpackage-summary%3Fhl%3Dzh-cn%23observeAsState(androidx.lifecycle.LiveData)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/livedata/package-summary?hl=zh-cn#observeAsState(androidx.lifecycle.LiveData)" ref="nofollow noopener noreferrer"><code>LiveData.observeAsState()</code></a> 包含在 <code>androidx.compose.runtime:runtime-livedata:$composeVersion</code> 工件中。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Frxjava2%2Fpackage-summary%3Fhl%3Dzh-cn%23subscribeAsState(io.reactivex.Observable%2Ckotlin.Any)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/rxjava2/package-summary?hl=zh-cn#subscribeAsState(io.reactivex.Observable,kotlin.Any)" ref="nofollow noopener noreferrer"><code>Observable.subscribeAsState()</code></a> 包含在 <code>androidx.compose.runtime:runtime-rxjava2:$composeVersion</code> 或 <code>androidx.compose.runtime:runtime-rxjava3:$composeVersion</code> 工件中。</li>
</ul>
<p>如需了解详情，请参阅“状态”文档中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fstate%3Fhl%3Dzh-cn%23use-other-types-of-state-in-jetpack-compose" target="_blank" title="https://developer.android.com/jetpack/compose/state?hl=zh-cn#use-other-types-of-state-in-jetpack-compose" ref="nofollow noopener noreferrer">其他受支持的状态类型</a>页面。</p>
</blockquote>
<h2 data-id="heading-12">5. LaunchedEffect 和 rememberUpdatedState</h2>
<p>在该项目中，有一个目前未使用的 <code>home/LandingScreen.kt</code> 文件。您想要向应用添加一个着陆屏幕，它有可能会用于在后台加载需要的所有数据。</p>
<p>着陆屏幕将占据整个屏幕，并在屏幕中间显示应用的徽标。理想情况下，您会显示该屏幕，在所有数据加载完毕之后，您会通知调用方可以使用 <code>onTimeout</code> 回调关闭着陆屏幕。</p>
<p>建议使用 Kotlin 协程在 Android 中执行异步操作。应用在启动时通常会使用协程在后台加载内容。Jetpack Compose 提供了可让您在界面层中安全使用协程的 API。由于此应用不与后端进行通信，因此您将使用协程的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlin.github.io%2Fkotlinx.coroutines%2Fkotlinx-coroutines-core%2Fkotlinx.coroutines%2Fdelay.html" target="_blank" title="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/delay.html" ref="nofollow noopener noreferrer"><code>delay</code></a> 函数来模拟在后台加载内容。</p>
<blockquote>
<p><strong>Compose 中的附带效应是指发生在可组合函数作用域之外的应用状态的变化。</strong> 例如，当用户点按一个按钮时打开一个新屏幕，或者在应用未连接到互联网时显示一条消息。</p>
</blockquote>
<p>Compose 中的附带效应是指发生在可组合函数作用域之外的应用状态的变化。将状态更改为显示/隐藏着陆屏幕的操作将发生在 <code>onTimeout</code> 回调中，由于在调用 <code>onTimeout</code> 之前您需要先使用协程加载内容，因此状态变化必须发生在协程的上下文中！</p>
<p>如需从可组合项内安全地调用挂起函数，请使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23LaunchedEffect(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#LaunchedEffect(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>LaunchedEffect</code></a> API，该 API 会在 Compose 中触发协程作用域限定的附带效应。</p>
<p>当 <code>LaunchedEffect</code> 进入组合时，它会启动一个协程，并将代码块作为参数传递。如果 <code>LaunchedEffect</code> 退出组合，协程将取消。</p>
<p>虽然接下来的代码不正确，但让我们看看如何使用此 API，并探讨为什么下面的代码是错误的。您将在此步骤的后面调用 <code>LandingScreen</code> 可组合项。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/LandingScreen.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.LaunchedEffect
<span class="hljs-keyword">import</span> kotlinx.coroutines.delay

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LandingScreen</span><span class="hljs-params">(onTimeout: () -&gt; <span class="hljs-type">Unit</span>, modifier: <span class="hljs-type">Modifier</span> = Modifier)</span></span> {
    Box(modifier = modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
        <span class="hljs-comment">// Start a side effect to load things in the background</span>
        <span class="hljs-comment">// and call onTimeout() when finished.</span>
        <span class="hljs-comment">// Passing onTimeout as a parameter to LaunchedEffect</span>
        <span class="hljs-comment">// is wrong! Don't do this. We'll improve this code in a sec.</span>
        LaunchedEffect(onTimeout) {
            delay(SplashWaitTime) <span class="hljs-comment">// Simulates loading things</span>
            onTimeout()
        }
        Image(painterResource(id = R.drawable.ic_crane_drawer), contentDescription = <span class="hljs-literal">null</span>)
    }
}
</code></pre>
<p>某些附带效应 API（如 <code>LaunchedEffect</code>）将可变数量的键作为形参，用于在其中一个键发生更改时<strong>重新开始</strong>执行效应。您发现错误了吗？我们不希望在此可组合函数的调用方传递不同的 <code>onTimeout</code> lambda 值时重启 <code>LaunchedEffect</code>。这会让 <code>delay</code> 再次启动，使得您无法满足相关要求。</p>
<p>接下来，让我们解决这个问题。如需在<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Flifecycle%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/lifecycle?hl=zh-cn" ref="nofollow noopener noreferrer">此可组合项的生命周期</a>内仅触发一次附带效应，请将常量用作键，例如 <code>LaunchedEffect(Unit) { ... }</code>。不过，现在又有一个问题。</p>
<p>如果 <code>onTimeout</code> 在附带效应正在进行时发生变化，效应结束时不一定会调用最后一个 <code>onTimeout</code>。如需保证调用最后一个 <code>onTimeout</code>，请使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberUpdatedState(kotlin.Any)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#rememberUpdatedState(kotlin.Any)" ref="nofollow noopener noreferrer"><code>rememberUpdatedState</code></a> API 记住 <code>onTimeout</code>。此 API 会捕获并更新最新值：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/LandingScreen.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.getValue
<span class="hljs-keyword">import</span> androidx.compose.runtime.rememberUpdatedState
<span class="hljs-keyword">import</span> kotlinx.coroutines.delay

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LandingScreen</span><span class="hljs-params">(onTimeout: () -&gt; <span class="hljs-type">Unit</span>, modifier: <span class="hljs-type">Modifier</span> = Modifier)</span></span> {
    Box(modifier = modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
        <span class="hljs-comment">// This will always refer to the latest onTimeout function that</span>
        <span class="hljs-comment">// LandingScreen was recomposed with</span>
        <span class="hljs-keyword">val</span> currentOnTimeout <span class="hljs-keyword">by</span> rememberUpdatedState(onTimeout)

        <span class="hljs-comment">// Create an effect that matches the lifecycle of LandingScreen.</span>
        <span class="hljs-comment">// If LandingScreen recomposes or onTimeout changes, </span>
        <span class="hljs-comment">// the delay shouldn't start again.</span>
        LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
            delay(SplashWaitTime)
            currentOnTimeout()
        }

        Image(painterResource(id = R.drawable.ic_crane_drawer), contentDescription = <span class="hljs-literal">null</span>)
    }
}
</code></pre>
<p>当长期存在的 lambda 或对象表达式引用在组合期间计算的参数或值时，您应使用 <code>rememberUpdatedState</code>，这在使用 <code>LaunchedEffect</code> 时可能很常见。</p>
<h3 data-id="heading-13">显示着陆屏幕</h3>
<p>现在，您需要在应用打开后显示着陆屏幕。打开 <code>home/MainActivity.kt</code> 文件，并查看首次调用的 <code>MainScreen</code> 可组合项。</p>
<p>在 <code>MainScreen</code> 可组合项中，您只需添加一种内部状态，用来跟踪是否应显示着陆屏幕：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/MainActivity.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.getValue
<span class="hljs-keyword">import</span> androidx.compose.runtime.mutableStateOf
<span class="hljs-keyword">import</span> androidx.compose.runtime.remember
<span class="hljs-keyword">import</span> androidx.compose.runtime.setValue

<span class="hljs-meta">@Composable</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MainScreen</span><span class="hljs-params">(onExploreItemClicked: <span class="hljs-type">OnExploreItemClicked</span>)</span></span> {
    Surface(color = MaterialTheme.colors.primary) {
        <span class="hljs-keyword">var</span> showLandingScreen <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">true</span>) }
        <span class="hljs-keyword">if</span> (showLandingScreen) {
            LandingScreen(onTimeout = { showLandingScreen = <span class="hljs-literal">false</span> })
        } <span class="hljs-keyword">else</span> {
            CraneHome(onExploreItemClicked = onExploreItemClicked)
        }
    }
}
</code></pre>
<p>如果您现在运行应用，您应该会看到 <code>LandingScreen</code> 出现并在 2 秒后消失。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9911e5fd229b4bcb8e972604a49eb90f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=DI%2Fgq2wjmkvxjnyBEqzMVFTaKKI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-14">6. rememberCoroutineScope</h2>
<p>在此步骤中，您将使抽屉式导航栏正常工作。目前，如果您尝试点按汉堡式菜单，什么都不会发生。</p>
<p>打开 <code>home/CraneHome.kt</code> 文件，并查看 <code>CraneHome</code> 可组合项，看看您需要在何处打开抽屉式导航栏：在 <code>openDrawer</code> 回调中！</p>
<p>在 <code>CraneHome</code> 中，有一个包含 <code>DrawerState</code> 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fmaterial%2FScaffoldState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/material/ScaffoldState?hl=zh-cn" ref="nofollow noopener noreferrer"><code>scaffoldState</code></a>。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fmaterial%2FDrawerState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/material/DrawerState?hl=zh-cn" ref="nofollow noopener noreferrer"><code>DrawerState</code></a> 具有以程序化方式打开和关闭抽屉式导航栏的方法。不过，如果您尝试在 <code>openDrawer</code> 回调中编写 <code>scaffoldState.drawerState.open()</code>，您会收到一条错误消息！这是因为，<code>open</code> 函数是一个<strong>挂起</strong>函数。我们再次进入协程的领域。</p>
<p>除了可让您从界面层安全调用协程的 API 之外，某些 Compose API 是挂起函数。用于打开抽屉式导航栏的 API 就是一个这样的例子。挂起函数除了能够运行异步代码之外，还可以帮助表示随着时间的推移出现的概念。打开抽屉式导航栏需要花些时间、进行移动，而且还有可能需要显示动画，这可以通过挂起函数完美地反映出来，挂起函数将在被调用的地方暂停协程的执行，直到它完成，然后再继续执行。</p>
<p>必须在协程中调用 <code>scaffoldState.drawerState.open()</code>。您可采取的行动 <code>openDrawer</code> 是一个简单的回调函数，因此：</p>
<ul>
<li>您不能简单地在其中调用挂起函数，因为 <code>openDrawer</code> 不在协程的上下文中执行。</li>
<li>您不能像之前一样使用 <code>LaunchedEffect</code>，因为不能在 <code>openDrawer</code> 中调用可组合项。我们不在组合中。</li>
</ul>
<p>您希望启动一个协程；应使用哪个作用域呢？理想情况下，您希望 <code>CoroutineScope</code> 能够遵循其调用点的生命周期。如果使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberCoroutineScope(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#rememberCoroutineScope(kotlin.Function0)" ref="nofollow noopener noreferrer"><code>rememberCoroutineScope</code></a> API，则会返回一个 <code>CoroutineScope</code>，该 CoroutineScope 会绑定到它在组合中的调用点。一旦退出组合，作用域将自动取消。有了这个作用域，即使您不在组合中（例如，在 <code>openDrawer</code> 回调中），也可以启动协程。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/CraneHome.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.rememberCoroutineScope
<span class="hljs-keyword">import</span> kotlinx.coroutines.launch

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CraneHome</span><span class="hljs-params">(
    onExploreItemClicked: <span class="hljs-type">OnExploreItemClicked</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
)</span></span> {
    <span class="hljs-keyword">val</span> scaffoldState = rememberScaffoldState()
    Scaffold(
        scaffoldState = scaffoldState,
        modifier = Modifier.statusBarsPadding(),
        drawerContent = {
            CraneDrawer()
        }
    ) {
        <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
        CraneHomeContent(
            modifier = modifier,
            onExploreItemClicked = onExploreItemClicked,
            openDrawer = {
                scope.launch {
                    scaffoldState.drawerState.<span class="hljs-keyword">open</span>()
                }
            }
        )
    }
}
</code></pre>
<p>如果您运行应用，您会看到当您点按汉堡式菜单图标时，系统会打开抽屉式导航栏。</p>
<h3 data-id="heading-15">LaunchedEffect 与 rememberCoroutineScope</h3>
<p>在这种情况下无法使用 <code>LaunchedEffect</code>，因为您需要触发调用以在组合之外的常规回调中创建协程。</p>
<p>回顾一下使用 <code>LaunchedEffect</code> 的着陆屏幕步骤，您可以使用 <code>rememberCoroutineScope</code> 并调用 <code>scope.launch { delay(); onTimeout(); }</code> 而不使用 <code>LaunchedEffect</code> 吗？</p>
<p>您本来可以这样做，而且似乎可行，但这样并不正确。如<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fmental-model%3Fhl%3Dzh-cn%23any-order" target="_blank" title="https://developer.android.com/jetpack/compose/mental-model?hl=zh-cn#any-order" ref="nofollow noopener noreferrer">“Compose 编程思想”文档</a>中所述，Compose 可以随时调用可组合项。<code>LaunchedEffect</code> 可以保证当对该可组合项的调用使其进入组合时将会执行附带效应。如果您在 <code>LandingScreen</code> 的主体中使用 <code>rememberCoroutineScope</code> 和 <code>scope.launch</code>，则每次 Compose 调用 <code>LandingScreen</code> 时都会执行协程，而不管该调用是否使其进入组合。因此，您会浪费资源，而且不会在受控环境中执行此附带效应。</p>
<h2 data-id="heading-16">7. 创建状态容器</h2>
<p>您注意到了吗？如果您点按“Choose Destination”，您可以修改该字段，并根据搜索输入过滤城市。此外，您或许还注意到了，每当您修改“Choose Destination”时，文本样式都会发生变化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d3b1750f3f840619a77730c387d81be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=HrS64TARh%2Fnkj691iSbShoTt6v8%3D" alt="image.png" loading="lazy"/></p>
<p>打开 <code>base/EditableUserInput.kt</code> 文件。<code>CraneEditableUserInput</code> 有状态可组合项接受一些参数，如 <code>hint</code> 和 <code>caption</code>，后者对应于图标旁边的可选文本。例如，当您搜索目的地时，会出现 <code>caption</code>“To”。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/EditableUserInput.kt file - code in the main branch</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CraneEditableUserInput</span><span class="hljs-params">(
    hint: <span class="hljs-type">String</span>,
    caption: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>,
    <span class="hljs-meta">@DrawableRes</span> vectorImageId: <span class="hljs-type">Int</span>? = <span class="hljs-literal">null</span>,
    onInputChanged: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    <span class="hljs-comment">// TODO Codelab: Encapsulate this state in a state holder</span>
    <span class="hljs-keyword">var</span> textState <span class="hljs-keyword">by</span> remember { mutableStateOf(hint) }
    <span class="hljs-keyword">val</span> isHint = { textState == hint }

    ...
}
</code></pre>
<h3 data-id="heading-17">原因</h3>
<p>用于更新 <code>textState</code> 以及确定显示的内容是否对应于提示的逻辑全部都在 <code>CraneEditableUserInput</code> 可组合项的主体中。这就带来了一些缺点：</p>
<ul>
<li><code>TextField</code> 的值未提升，因而无法从外部进行控制，这使得测试更加困难。</li>
<li>此可组合项的逻辑可能会变得更加复杂，并且内部状态可能会更容易不同步。</li>
</ul>
<p>通过创建负责此可组合项的内部状态的状态容器，您可以将所有状态变化集中在一个位置。这样，状态不同步就更难了，并且相关的逻辑全部归在一个类中。此外，此状态很容易向上提升，并且可以从此可组合项的调用方使用。</p>
<p>在这种情况下，提升状态是一种不错的做法，因为这是一个低级界面组件，可能会在应用的其他部分中重复使用。因此，它越灵活越可控，就越好。</p>
<h3 data-id="heading-18">创建状态容器</h3>
<p>由于 <code>CraneEditableUserInput</code> 是一个可重复使用的组件，您可以在同一文件中创建一个名为 <code>EditableUserInputState</code> 的常规类作为状态容器，如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/EditableUserInput.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.getValue
<span class="hljs-keyword">import</span> androidx.compose.runtime.mutableStateOf
<span class="hljs-keyword">import</span> androidx.compose.runtime.setValue

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EditableUserInputState</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> hint: String, initialText: String) {

    <span class="hljs-keyword">var</span> text <span class="hljs-keyword">by</span> mutableStateOf(initialText)
       <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateText</span><span class="hljs-params">(newText: <span class="hljs-type">String</span>)</span></span> {
       text = newText
    }

    <span class="hljs-keyword">val</span> isHint: <span class="hljs-built_in">Boolean</span>
        <span class="hljs-keyword">get</span>() = text == hint
}
</code></pre>
<p>该类应具有以下特征：</p>
<ul>
<li><code>text</code> 是 <code>String</code> 类型的可变状态，就像在 <code>CraneEditableUserInput</code> 中一样。请务必使用 <code>mutableStateOf</code>，以便 Compose 跟踪值的更改，并在发生更改时重组。</li>
<li><code>text</code> 是具有私有 <code>set</code> 的 <code>var</code>，因此无法直接从类外部改变它。您可以公开 <code>updateText</code> 事件来对此变量进行修改，从而将该类设为单一可信来源，而不是公开此变量。</li>
<li>该类将 <code>initialText</code> 作为用于初始化 <code>text</code> 的依赖项。</li>
<li>用于判断 <code>text</code> 是否为提示的逻辑在按需执行检查的 <code>isHint</code> 属性中。</li>
</ul>
<p>如果将来逻辑变得更加复杂，您只需要对一个类进行更改：<code>EditableUserInputState</code>。</p>
<h3 data-id="heading-19">记住状态容器</h3>
<p>始终需要记住状态容器，以使其留在组合中，而不是每次都创建一个新的。最好在同一文件中创建一个执行此操作的方法，以移除样板并避免可能发生的任何错误。在 <code>base/EditableUserInput.kt</code> 文件中，添加以下代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/EditableUserInput.kt file</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberEditableUserInputState</span><span class="hljs-params">(hint: <span class="hljs-type">String</span>)</span></span>: EditableUserInputState =
    remember(hint) {
        EditableUserInputState(hint, hint)
    }
</code></pre>
<p>如果您只是使用 <code>remember</code> 记住此状态，它在 activity 重新创建后不会继续留存。**为了解决此问题，您可以改用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberSaveable(kotlin.Array%2Candroidx.compose.runtime.saveable.Saver%2Ckotlin.String%2Ckotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#rememberSaveable(kotlin.Array,androidx.compose.runtime.saveable.Saver,kotlin.String,kotlin.Function0)" ref="nofollow noopener noreferrer"><strong><code>rememberSaveable</code></strong></a> API，它的行为方式与 <code>remember</code> 类似，但存储的值在 activity 和进程重新创建后会继续留存。在内部，它使用保存的实例状态机制。</p>
<p>对于可以存储在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fos%2FBundle%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/android/os/Bundle?hl=zh-cn" ref="nofollow noopener noreferrer"><code>Bundle</code></a> 内的对象，<code>rememberSaveable</code> 可以做所有这些工作，而无需任何额外的操作。对于您在项目中创建的 <code>EditableUserInputState</code> 类，却并非如此。因此，您需要告知 <code>rememberSaveable</code> 如何使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23Saver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#Saver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>Saver</code></a> 保存和恢复此类的实例。</p>
<h3 data-id="heading-20">创建自定义保存器</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23Saver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#Saver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>Saver</code></a> 描述了如何将对象转换为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2FSaver%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/Saver?hl=zh-cn" ref="nofollow noopener noreferrer"><code>Saveable</code></a>（可保存）的内容。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23Saver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#Saver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>Saver</code></a> 的实现需要替换两个函数：</p>
<ul>
<li><code>save</code> - 将原始值转换为可保存的值。</li>
<li><code>restore</code> - 将恢复的值转换为原始类的实例。</li>
</ul>
<p>在本例中，您可以使用一些现有的 Compose API，如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23listSaver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#listSaver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>listSaver</code></a> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23mapSaver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#mapSaver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>mapSaver</code></a>（用于存储要保存在 <code>List</code> 或 <code>Map</code> 中的值），以减少您需要编写的代码量，而不是为 <code>EditableUserInputState</code> 类创建 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23Saver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#Saver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>Saver</code></a> 的自定义实现。</p>
<p>最好将 <code>Saver</code> 定义放置在与其一起使用的类附近。由于需要被静态访问，因此请在 <code>companion object</code> 中为 <code>EditableUserInputState</code> 添加 <code>Saver</code>。在 <code>base/EditableUserInput.kt</code> 文件中，添加 <code>Saver</code> 的实现：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/EditableUserInput.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.saveable.Saver
<span class="hljs-keyword">import</span> androidx.compose.runtime.saveable.listSaver

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EditableUserInputState</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> hint: String, initialText: String) {
    <span class="hljs-keyword">var</span> text <span class="hljs-keyword">by</span> mutableStateOf(initialText)

    <span class="hljs-keyword">val</span> isHint: <span class="hljs-built_in">Boolean</span>
        <span class="hljs-keyword">get</span>() = text == hint

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">val</span> Saver: Saver&lt;EditableUserInputState, *&gt; = listSaver(
            save = { listOf(it.hint, it.text) },
            restore = {
                EditableUserInputState(
                    hint = it[<span class="hljs-number">0</span>],
                    initialText = it[<span class="hljs-number">1</span>],
                )
            }
        )
    }
}
</code></pre>
<p>在本例中，您将 <code>listSaver</code> 用作实现细节，在保存器中存储和恢复 <code>EditableUserInputState</code> 的实例。</p>
<p>现在，您可以在之前创建的 <code>rememberEditableUserInputState</code> 方法的 <code>rememberSaveable</code>（而不是 <code>remember</code>）中使用此保存器：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/EditableUserInput.kt file</span>
<span class="hljs-keyword">import</span> androidx.compose.runtime.saveable.rememberSaveable

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberEditableUserInputState</span><span class="hljs-params">(hint: <span class="hljs-type">String</span>)</span></span>: EditableUserInputState =
    rememberSaveable(hint, saver = EditableUserInputState.Saver) {
        EditableUserInputState(hint, hint)
    }
</code></pre>
<p>这样，<code>EditableUserInput</code> 记住的状态就会在进程和 activity 重新创建后继续留存。</p>
<h3 data-id="heading-21">使用状态容器</h3>
<p>您将要使用 <code>EditableUserInputState</code> 而不是 <code>text</code> 和 <code>isHint</code>，但您不希望只将其用作 <code>CraneEditableUserInput</code> 中的内部状态，因为调用方可组合项无法控制状态。相反，您希望提升 <code>EditableUserInputState</code>，以便调用方可以控制 <code>CraneEditableUserInput</code> 的状态。**如果您提升状态，那么可组合项就可以在预览中使用，并且更容易进行测试，因为您能够从调用方修改其状态。</p>
<p>为此，您需要更改可组合函数的形参，并在需要时为其提供默认值。由于您可能希望允许 <code>CraneEditableUserInput</code> 带有空提示，因此添加一个默认实参：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CraneEditableUserInput</span><span class="hljs-params">(
    state: <span class="hljs-type">EditableUserInputState</span> = rememberEditableUserInputState(<span class="hljs-string">""</span>)</span></span>,
    caption: String? = <span class="hljs-literal">null</span>,
    <span class="hljs-meta">@DrawableRes</span> vectorImageId: <span class="hljs-built_in">Int</span>? = <span class="hljs-literal">null</span>
) { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<p>您或许已经注意到，<code>onInputChanged</code> 形参不存在了！由于状态可以提升，因此如果调用方想要知道输入是否发生了更改，它们可以控制状态并将该状态传入此函数。</p>
<p>接下来，您需要调整函数主体，以使用提升的状态，而不是之前使用的内部状态。重构后，函数应如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CraneEditableUserInput</span><span class="hljs-params">(
    state: <span class="hljs-type">EditableUserInputState</span> = rememberEditableUserInputState(<span class="hljs-string">""</span>)</span></span>,
    caption: String? = <span class="hljs-literal">null</span>,
    <span class="hljs-meta">@DrawableRes</span> vectorImageId: <span class="hljs-built_in">Int</span>? = <span class="hljs-literal">null</span>
) {
    CraneBaseUserInput(
        caption = caption,
        tintIcon = { !state.isHint },
        showCaption = { !state.isHint },
        vectorImageId = vectorImageId
    ) {
        BasicTextField(
            value = state.text,
            onValueChange = { state.updateText(it) },
            textStyle = <span class="hljs-keyword">if</span> (state.isHint) {
                captionTextStyle.copy(color = LocalContentColor.current)
            } <span class="hljs-keyword">else</span> {
                MaterialTheme.typography.body1.copy(color = LocalContentColor.current)
            },
            cursorBrush = SolidColor(LocalContentColor.current)
        )
    }
}
</code></pre>
<h3 data-id="heading-22">状态容器调用方</h3>
<p>由于您更改了 <code>CraneEditableUserInput</code> 的 API，因此需要在调用它的所有位置进行检查，以确保传入适当的形参。</p>
<p>在项目中，您只在一个位置调用此 API，那就是在 <code>home/SearchUserInput.kt</code> 文件中。打开该文件并转到 <code>ToDestinationUserInput</code> 可组合函数；您应该会在该位置看到一个构建错误。由于提示现在是状态容器的一部分，并且您希望在组合中设置此 <code>CraneEditableUserInput</code> 实例的自定义提示，因此您需要记住 <code>ToDestinationUserInput</code> 级别的状态，并将其传入 <code>CraneEditableUserInput</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/SearchUserInput.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.samples.crane.base.rememberEditableUserInputState

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ToDestinationUserInput</span><span class="hljs-params">(onToDestinationChanged: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> editableUserInputState = rememberEditableUserInputState(hint = <span class="hljs-string">"Choose Destination"</span>)
    CraneEditableUserInput(
        state = editableUserInputState,
        caption = <span class="hljs-string">"To"</span>,
        vectorImageId = R.drawable.ic_plane
    )
}
</code></pre>
<h3 data-id="heading-23">snapshotFlow</h3>
<p>上面的代码缺少在输入更改时通知 <code>ToDestinationUserInput</code> 的调用方的功能。由于应用的结构，您不希望在层次结构中将 <code>EditableUserInputState</code> 提升到任何更高的级别。而且，您也不希望将其他可组合项（如 <code>FlySearchContent</code>）与此状态相结合。您如何从 <code>ToDestinationUserInput</code> 调用 <code>onToDestinationChanged</code> lambda 并且仍使此可组合项可重复使用呢？</p>
<p>您可以在每次输入更改时使用 <code>LaunchedEffect</code> 触发附带效应，并调用 <code>onToDestinationChanged</code> lambda：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/SearchUserInput.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.LaunchedEffect
<span class="hljs-keyword">import</span> androidx.compose.runtime.rememberUpdatedState
<span class="hljs-keyword">import</span> androidx.compose.runtime.snapshotFlow
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.collect
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.filter

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ToDestinationUserInput</span><span class="hljs-params">(onToDestinationChanged: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> editableUserInputState = rememberEditableUserInputState(hint = <span class="hljs-string">"Choose Destination"</span>)
    CraneEditableUserInput(
        state = editableUserInputState,
        caption = <span class="hljs-string">"To"</span>,
        vectorImageId = R.drawable.ic_plane
    )

    <span class="hljs-keyword">val</span> currentOnDestinationChanged <span class="hljs-keyword">by</span> rememberUpdatedState(onToDestinationChanged)
    LaunchedEffect(editableUserInputState) {
        snapshotFlow { editableUserInputState.text }
            .filter { !editableUserInputState.isHint }
            .collect {
                currentOnDestinationChanged(editableUserInputState.text)
            }
    }
}
</code></pre>
<p>您之前已经使用了 <code>LaunchedEffect</code> 和 <code>rememberUpdatedState</code>，但上面的代码还使用了一个新的 API！<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23snapshotFlow(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#snapshotFlow(kotlin.Function0)" ref="nofollow noopener noreferrer"><strong><code>snapshotFlow</code></strong></a> <strong>API</strong> 将 Compose <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2FState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/State?hl=zh-cn" ref="nofollow noopener noreferrer"><code>State&lt;T&gt;</code></a> 对象转换为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fkotlin%2Fflow%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/kotlin/flow?hl=zh-cn" ref="nofollow noopener noreferrer">Flow</a>。当在 <code>snapshotFlow</code> 内读取的状态发生变化时，Flow 会向收集器发出新值。在本例中，您将状态转换为 Flow，以使用 Flow 运算符的强大功能。这样，您就可以在 <code>text</code> 不是 <code>hint</code> 时使用 <code>filter</code> 进行过滤，并使用 <code>collect</code> 收集发出的项，以通知父项当前的目的地发生了变化。</p>
<h2 data-id="heading-24">8. DisposableEffect</h2>
<p>当您点按某个目的地时，系统会打开详情屏幕，您可以看到相应的城市在地图上的位置。该代码位于 <code>details/DetailsActivity.kt</code> 文件中。在 <code>CityMapView</code> 可组合项中，您调用了 <code>rememberMapViewWithLifecycle</code> 函数。如果您打开此函数（它位于 <code>details/MapViewUtils.kt</code> 文件中），您会看到它未关联到任何生命周期！它只是记住 <code>MapView</code> 并对其调用 <code>onCreate</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/MapViewUtils.kt file - code in the main branch</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberMapViewWithLifecycle</span><span class="hljs-params">()</span></span>: MapView {
    <span class="hljs-keyword">val</span> context = LocalContext.current
    <span class="hljs-comment">// TODO Codelab: DisposableEffect step. Make MapView follow the lifecycle</span>
    <span class="hljs-keyword">return</span> remember {
        MapView(context).apply {
            id = R.id.map
            onCreate(Bundle())
        }
    }
}
</code></pre>
<p>虽然应用运行良好，但这也是一个问题，因为 <code>MapView</code> 未遵循正确的生命周期。因此，它不知道应用何时转至后台、View 何时应暂停，等等。让我们来解决这一问题！</p>
<blockquote>
<p><strong>注意</strong>：如果您未看到地图，请查看“准备设置”步骤中的“[可选] 在详情屏幕上显示地图”部分。** **不过，对于本部分，没有必要在屏幕上看到地图。</p>
</blockquote>
<p>由于 <code>MapView</code> 是 View 而不是可组合项，因此您希望它遵循使用它的 Activity 的生命周期，以及组合的生命周期。这意味着，您需要创建一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroidx%2Flifecycle%2FLifecycleEventObserver%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/androidx/lifecycle/LifecycleEventObserver?hl=zh-cn" ref="nofollow noopener noreferrer"><code>LifecycleEventObserver</code></a> 来监听生命周期事件并在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fandroid%2Freference%2Fcom%2Fgoogle%2Fandroid%2Fgms%2Fmaps%2FMapView%3Fhl%3Dzh-cn" target="_blank" title="https://developers.google.com/android/reference/com/google/android/gms/maps/MapView?hl=zh-cn" ref="nofollow noopener noreferrer"><code>MapView</code></a> 上调用正确的方法。然后，您需要将此观察器添加到当前 activity 的生命周期。</p>
<p>首先创建一个函数，该函数返回 <code>LifecycleEventObserver</code>，在给定某个事件的情况下，它会在 <code>MapView</code> 中调用相应的方法：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/MapViewUtils.kt file</span>

<span class="hljs-keyword">import</span> androidx.lifecycle.Lifecycle
<span class="hljs-keyword">import</span> androidx.lifecycle.LifecycleEventObserver

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getMapLifecycleObserver</span><span class="hljs-params">(mapView: <span class="hljs-type">MapView</span>)</span></span>: LifecycleEventObserver =
    LifecycleEventObserver { _, event -&gt;
        <span class="hljs-keyword">when</span> (event) {
            Lifecycle.Event.ON_CREATE -&gt; mapView.onCreate(Bundle())
            Lifecycle.Event.ON_START -&gt; mapView.onStart()
            Lifecycle.Event.ON_RESUME -&gt; mapView.onResume()
            Lifecycle.Event.ON_PAUSE -&gt; mapView.onPause()
            Lifecycle.Event.ON_STOP -&gt; mapView.onStop()
            Lifecycle.Event.ON_DESTROY -&gt; mapView.onDestroy()
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-keyword">throw</span> IllegalStateException()
        }
    }
</code></pre>
<p>现在，您需要将此观察器添加到当前的生命周期，您可以使用当前的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroidx%2Flifecycle%2FLifecycleOwner%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/androidx/lifecycle/LifecycleOwner?hl=zh-cn" ref="nofollow noopener noreferrer"><code>LifecycleOwner</code></a> 与 <code>LocalLifecycleOwner</code> 组合局部函数来获取该生命周期。不过，仅仅添加观察器是不够的；您还需要能够将其移除！您需要一种附带效应，可以在效应退出组合时告知您，以便您可以执行一些清理代码。您寻找的附带效应 API 是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23DisposableEffect(kotlin.Any%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#DisposableEffect(kotlin.Any,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>DisposableEffect</code></a>。</p>
<p><code>DisposableEffect</code> 适用于在键发生变化或可组合项退出组合后需要清理的附带效应。最终的 <code>rememberMapViewWithLifecycle</code> 代码正好起到这种作用。在项目中实现以下代码行：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/MapViewUtils.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.DisposableEffect
<span class="hljs-keyword">import</span> androidx.compose.ui.platform.LocalLifecycleOwner

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberMapViewWithLifecycle</span><span class="hljs-params">()</span></span>: MapView {
    <span class="hljs-keyword">val</span> context = LocalContext.current
    <span class="hljs-keyword">val</span> mapView = remember {
        MapView(context).apply {
            id = R.id.map
        }
    }

    <span class="hljs-keyword">val</span> lifecycle = LocalLifecycleOwner.current.lifecycle
    DisposableEffect(key1 = lifecycle, key2 = mapView) {
        <span class="hljs-comment">// Make MapView follow the current lifecycle</span>
        <span class="hljs-keyword">val</span> lifecycleObserver = getMapLifecycleObserver(mapView)
        lifecycle.addObserver(lifecycleObserver)
        onDispose {
            lifecycle.removeObserver(lifecycleObserver)
        }
    }

    <span class="hljs-keyword">return</span> mapView
}
</code></pre>
<p>将观察器添加到了当前的 <code>lifecycle</code>，只要当前的生命周期发生变化或者此可组合项退出组合，就会将其移除。对于 <code>DisposableEffect</code> 中的 <code>key</code>，如果 <code>lifecycle</code> 或 <code>mapView</code> 发生变化，系统会移除观察器并再次将其添加到正确的 <code>lifecycle</code>。</p>
<p>通过您刚刚所做的更改，<code>MapView</code> 将始终遵循当前 <code>LifecycleOwner</code> 的 <code>lifecycle</code>，并且其行为就像在 View 环境中使用它时一样。</p>
<blockquote>
<p><strong>注意</strong>：此部分介绍了如何定义 <code>LifecycleEventObserver</code> 来响应 Compose 中的 <code>LifecycleOwner</code> 事件。您还学习了如何使用 <code>DisposableEffect</code> API 安全处置资源，以避免内存泄漏。相关示例使用了基于 View 的组件 <code>MapView</code>。在真实的 Compose 应用中，您可以使用新的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fmaps%2Fdocumentation%2Fandroid-sdk%2Fmaps-compose%3Fhl%3Dzh-cn" target="_blank" title="https://developers.google.com/maps/documentation/android-sdk/maps-compose?hl=zh-cn" ref="nofollow noopener noreferrer">Maps for Compose 库</a>，该库会为您处理生命周期事件。</p>
</blockquote>
<h2 data-id="heading-25">9. produceState</h2>
<p>在本部分中，您将改进详情屏幕的启动方式。<code>details/DetailsActivity.kt</code> 文件中的 <code>DetailsScreen</code> 可组合项会从 ViewModel 同步获取 <code>cityDetails</code>，并在结果成功时调用 <code>DetailsContent</code>。</p>
<p>不过，<code>cityDetails</code> 在界面线程上的加载成本可能会变得越来越高，它可以使用协程将数据的加载工作移至其他线程。您将改进此代码，以添加一个加载屏幕，并在数据准备就绪时显示 <code>DetailsContent</code>。</p>
<p>为屏幕状态建模的一种方法是使用以下类，它涵盖了所有的可能性：要在屏幕上显示的数据，以及加载和错误信号。将 <code>DetailsUiState</code> 类添加到 <code>DetailsActivity.kt</code> 文件：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/DetailsActivity.kt file</span>

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DetailsUiState</span>(
    <span class="hljs-keyword">val</span> cityDetails: ExploreModel? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">val</span> isLoading: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>,
    <span class="hljs-keyword">val</span> throwError: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>
)
</code></pre>
<p>您可以使用一个数据流（即 <code>DetailsUiState</code> 类型的 <code>StateFlow</code>）映射屏幕需要显示的内容和 ViewModel 层中的 <code>UiState</code>，ViewModel 会在信息准备就绪时更新该数据流，而 Compose 会使用您已了解的 <code>collectAsStateWithLifecycle()</code> API 收集该数据流。</p>
<p>不过，为了本练习，您将实现一种替代方案。如果您希望将 <code>uiState</code> 映射逻辑移至 Compose 环境，您可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23produceState(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#produceState(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>produceState</code></a> API。</p>
<p><code>produceState</code> 可让您将非 Compose 状态转换为 Compose <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2FState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/State?hl=zh-cn" ref="nofollow noopener noreferrer">状态</a>。它会启动一个作用域限定为组合的协程，该协程可使用 <code>value</code> 属性将值推送到返回的 <code>State</code>。与 <code>LaunchedEffect</code> 一样，<code>produceState</code> 也采用键来取消和重新开始计算。</p>
<p>对于您的用例，您可以使用 <code>produceState</code> 发出初始值为 <code>DetailsUiState(isLoading = true)</code> 的 <code>uiState</code> 更新，如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/DetailsActivity.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.produceState

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DetailsScreen</span><span class="hljs-params">(
    onErrorLoading: () -&gt; <span class="hljs-type">Unit</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    viewModel: <span class="hljs-type">DetailsViewModel</span> = viewModel()</span></span>
) {

    <span class="hljs-keyword">val</span> uiState <span class="hljs-keyword">by</span> produceState(initialValue = DetailsUiState(isLoading = <span class="hljs-literal">true</span>)) {
        <span class="hljs-comment">// In a coroutine, this can call suspend functions or move</span>
        <span class="hljs-comment">// the computation to different Dispatchers</span>
        <span class="hljs-keyword">val</span> cityDetailsResult = viewModel.cityDetails
        value = <span class="hljs-keyword">if</span> (cityDetailsResult <span class="hljs-keyword">is</span> Result.Success&lt;ExploreModel&gt;) {
            DetailsUiState(cityDetailsResult.<span class="hljs-keyword">data</span>)
        } <span class="hljs-keyword">else</span> {
            DetailsUiState(throwError = <span class="hljs-literal">true</span>)
        }
    }

    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> ... </span>
}
</code></pre>
<p>接下来，根据 <code>uiState</code>，您会显示数据、显示加载屏幕或报告错误。下面是 <code>DetailsScreen</code> 可组合项的完整代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/DetailsActivity.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.foundation.layout.Box
<span class="hljs-keyword">import</span> androidx.compose.material.CircularProgressIndicator

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DetailsScreen</span><span class="hljs-params">(
    onErrorLoading: () -&gt; <span class="hljs-type">Unit</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    viewModel: <span class="hljs-type">DetailsViewModel</span> = viewModel()</span></span>
) {
    <span class="hljs-keyword">val</span> uiState <span class="hljs-keyword">by</span> produceState(initialValue = DetailsUiState(isLoading = <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">val</span> cityDetailsResult = viewModel.cityDetails
        value = <span class="hljs-keyword">if</span> (cityDetailsResult <span class="hljs-keyword">is</span> Result.Success&lt;ExploreModel&gt;) {
            DetailsUiState(cityDetailsResult.<span class="hljs-keyword">data</span>)
        } <span class="hljs-keyword">else</span> {
            DetailsUiState(throwError = <span class="hljs-literal">true</span>)
        }
    }

    <span class="hljs-keyword">when</span> {
        uiState.cityDetails != <span class="hljs-literal">null</span> -&gt; {
            DetailsContent(uiState.cityDetails!!, modifier.fillMaxSize())
        }
        uiState.isLoading -&gt; {
            Box(modifier.fillMaxSize()) {
                CircularProgressIndicator(
                    color = MaterialTheme.colors.onSurface,
                    modifier = Modifier.align(Alignment.Center)
                )
            }
        }
        <span class="hljs-keyword">else</span> -&gt; { onErrorLoading() }
    }
}
</code></pre>
<p>如果您运行应用，您会看到在显示城市详情之前如何出现了指示“正在加载”的旋转图标。</p>
<blockquote>
<p><strong>注意</strong>：<code>collectAsStateWithLifecycle()</code> API 会在后台使用 <code>produceState()</code> API。</p>
</blockquote>
<h2 data-id="heading-26">10. derivedStateOf</h2>
<p>您要对 Crane 做的最后一项改进是，每当您在航班目的地列表中滚动时，经过屏幕的第一个元素之后，都会显示一个用于“滚动至顶部”的按钮。点按该按钮会使您前往列表中的第一个元素。</p>
<p>打开包含此代码的 <code>base/ExploreSection.kt</code> 文件。<code>ExploreSection</code> 可组合项对应于您在 Scaffold 的背景幕中看到的内容。</p>
<p>如需计算用户是否已经过第一项，请使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Flists%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/lists?hl=zh-cn" ref="nofollow noopener noreferrer"><code>LazyColumn</code></a> 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Ffoundation%2Flazy%2FLazyListState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/foundation/lazy/LazyListState?hl=zh-cn" ref="nofollow noopener noreferrer"><code>LazyListState</code></a> 并检查 <code>listState.firstVisibleItemIndex &gt; 0</code>。</p>
<p>简单实现如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// DO NOT DO THIS - It's executed on every recomposition</span>
<span class="hljs-keyword">val</span> showButton = listState.firstVisibleItemIndex &gt; <span class="hljs-number">0</span>
</code></pre>
<p>该解决方案的效率并不高，因为每当 <code>firstVisibleItemIndex</code> 发生变化时，读取 <code>showButton</code> 的可组合函数都会重组，这种情况经常会在滚动时发生。不过，您希望该函数仅在条件在 <code>true</code> 和 <code>false</code> 之间变化时重组。</p>
<p>有一个 API 可让您做到这一点，那就是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23derivedStateOf(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#derivedStateOf(kotlin.Function0)" ref="nofollow noopener noreferrer"><code>derivedStateOf</code></a> API。</p>
<p><code>listState</code> 是一个可观察的 Compose <code>State</code>。您的计算 <code>showButton</code> 也需要是一个 Compose <code>State</code>，因为您希望界面在其值发生变化时重组，并显示或隐藏按钮。</p>
<p>当您想要的某个 Compose <code>State</code> 衍生自另一个 <code>State</code> 时，请使用 <code>derivedStateOf</code>。每当内部状态发生变化时，系统都会执行 <code>derivedStateOf</code> 计算块，但只有当计算结果与上一项不同时，可组合函数才会重组。这样可以最大限度地减少读取 <code>showButton</code> 的函数的重组次数。</p>
<p>在这种情况下，使用 <code>derivedStateOf</code> API 是一种更好且更高效的替代方案。您还会使用 <code>remember</code> API 来封装调用，因此计算得出的值在重组后继续有效。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Show the button if the first visible item is past</span>
<span class="hljs-comment">// the first item. We use a remembered derived state to</span>
<span class="hljs-comment">// minimize unnecessary recompositions</span>
<span class="hljs-keyword">val</span> showButton <span class="hljs-keyword">by</span> remember {
    derivedStateOf {
        listState.firstVisibleItemIndex &gt; <span class="hljs-number">0</span>
    }
}
</code></pre>
<p>您应该已经熟悉 <code>ExploreSection</code> 可组合项的新代码。您使用 <code>Box</code> 将有条件地显示的 <code>Button</code> 放置在 <code>ExploreList</code> 的顶部。您会使用 <code>rememberCoroutineScope</code> 在 <code>Button</code> 的 <code>onClick</code> 回调内调用 <code>listState.scrollToItem</code> 挂起函数。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/ExploreSection.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.material.FloatingActionButton
<span class="hljs-keyword">import</span> androidx.compose.runtime.derivedStateOf
<span class="hljs-keyword">import</span> androidx.compose.runtime.getValue
<span class="hljs-keyword">import</span> androidx.compose.runtime.remember
<span class="hljs-keyword">import</span> androidx.compose.runtime.rememberCoroutineScope
<span class="hljs-keyword">import</span> androidx.compose.foundation.layout.navigationBarsPadding
<span class="hljs-keyword">import</span> kotlinx.coroutines.launch

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ExploreSection</span><span class="hljs-params">(
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    title: <span class="hljs-type">String</span>,
    exploreList: <span class="hljs-type">List</span>&lt;<span class="hljs-type">ExploreModel</span>&gt;,
    onItemClicked: <span class="hljs-type">OnExploreItemClicked</span>
)</span></span> {
    Surface(modifier = modifier.fillMaxSize(), color = Color.White, shape = BottomSheetShape) {
        Column(modifier = Modifier.padding(start = <span class="hljs-number">24.</span>dp, top = <span class="hljs-number">20.</span>dp, end = <span class="hljs-number">24.</span>dp)) {
            Text(
                text = title,
                style = MaterialTheme.typography.caption.copy(color = crane_caption)
            )
            Spacer(Modifier.height(<span class="hljs-number">8.</span>dp))
            Box(Modifier.weight(<span class="hljs-number">1f</span>)) {
                <span class="hljs-keyword">val</span> listState = rememberLazyListState()
                ExploreList(exploreList, onItemClicked, listState = listState)

                <span class="hljs-comment">// Show the button if the first visible item is past</span>
                <span class="hljs-comment">// the first item. We use a remembered derived state to</span>
                <span class="hljs-comment">// minimize unnecessary compositions</span>
                <span class="hljs-keyword">val</span> showButton <span class="hljs-keyword">by</span> remember {
                    derivedStateOf {
                        listState.firstVisibleItemIndex &gt; <span class="hljs-number">0</span>
                    }
                }
                <span class="hljs-keyword">if</span> (showButton) {
                    <span class="hljs-keyword">val</span> coroutineScope = rememberCoroutineScope()
                    FloatingActionButton(
                        backgroundColor = MaterialTheme.colors.primary,
                        modifier = Modifier
                            .align(Alignment.BottomEnd)
                            .navigationBarsPadding()
                            .padding(bottom = <span class="hljs-number">8.</span>dp),
                        onClick = {
                            coroutineScope.launch {
                                listState.scrollToItem(<span class="hljs-number">0</span>)
                            }
                        }
                    ) {
                        Text(<span class="hljs-string">"Up!"</span>)
                    }
                }
            }
        }
    }
}
</code></pre>
<p>如果您运行应用，您会看到一旦您滚动并经过屏幕的第一个元素，该按钮就会出现在底部。</p>
<blockquote>
<p><strong>注意</strong>：如需详细了解 <code>derivedStateOf()</code> API，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fandroiddevelopers%2Fjetpack-compose-when-should-i-use-derivedstateof-63ce7954c11b" target="_blank" title="https://medium.com/androiddevelopers/jetpack-compose-when-should-i-use-derivedstateof-63ce7954c11b" ref="nofollow noopener noreferrer">何时应使用 derivedStateOf？</a>这篇博文。</p>
</blockquote>
<h2 data-id="heading-27">11. 总结</h2>
<p>您学习了如何创建状态容器、附带效应 API（如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23LaunchedEffect(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#LaunchedEffect(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>LaunchedEffect</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberUpdatedState(kotlin.Any)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#rememberUpdatedState(kotlin.Any)" ref="nofollow noopener noreferrer"><code>rememberUpdatedState</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23DisposableEffect(kotlin.Any%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#DisposableEffect(kotlin.Any,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>DisposableEffect</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23produceState(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#produceState(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>produceState</code></a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23derivedStateOf(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#derivedStateOf(kotlin.Function0)" ref="nofollow noopener noreferrer"><code>derivedStateOf</code></a>），以及如何在 Jetpack Compose 中使用协程。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【AI 编程实战】第 3 篇：后端小白也能写 API：AI 带我 1 小时搭完 Next.js 服务]]></title>    <link>https://juejin.cn/post/7582808491583619108</link>    <guid>https://juejin.cn/post/7582808491583619108</guid>    <pubDate>2025-12-12T08:09:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582808491583619108" data-draft-id="7582808491583258660" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【AI 编程实战】第 3 篇：后端小白也能写 API：AI 带我 1 小时搭完 Next.js 服务"/> <meta itemprop="keywords" content="前端,后端,AI编程"/> <meta itemprop="datePublished" content="2025-12-12T08:09:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HashTang"/> <meta itemprop="url" content="https://juejin.cn/user/1117561754756488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【AI 编程实战】第 3 篇：后端小白也能写 API：AI 带我 1 小时搭完 Next.js 服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117561754756488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HashTang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:09:43.000Z" title="Fri Dec 12 2025 08:09:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><blockquote>
<p>后端 API 开发是很多前端开发者的"心理阴影"——数据库设计、ORM 操作、JWT 认证、错误处理……每一步都是坑。但有了 AI，这一切都变得简单起来。这是《<a href="https://juejin.cn/column/7579556047783624756" target="_blank" title="https://juejin.cn/column/7579556047783624756">AI 编程实战：TRAE SOLO 全栈开发指南</a>》专栏的第三篇文章，带你用 AI 快速搭建 Next.js 15 后端 API。</p>
</blockquote>
<h2 data-id="heading-0">一、开篇：前端开发者的后端焦虑</h2>
<h3 data-id="heading-1">1.1 后端开发的"噩梦"</h3>
<p>还记得小何吗？完成前端架构搭建后，他面临一个更大的挑战：<strong>后端 API 开发</strong>。</p>
<p>作为一个前端开发者，小何对后端并不陌生，但每次写后端代码时，总有一种"如履薄冰"的感觉：</p>
<pre><code class="hljs language-txt" lang="txt">数据库表怎么设计？字段类型怎么选？
ORM 怎么用？Prisma 和 TypeORM 有什么区别？
JWT 怎么生成？Token 过期怎么处理？
接口怎么设计才符合 RESTful 规范？
错误处理怎么统一？日志怎么记录？
</code></pre>
<p>传统方式下，小何需要：</p>









































<table><thead><tr><th>任务</th><th>预计时间</th></tr></thead><tbody><tr><td>学习 Next.js API</td><td>2 小时</td></tr><tr><td>数据库表设计</td><td>3 小时</td></tr><tr><td>Prisma 配置和学习</td><td>4 小时</td></tr><tr><td>JWT 认证实现</td><td>3 小时</td></tr><tr><td>登录注册 API</td><td>4 小时</td></tr><tr><td>响应格式统一</td><td>2 小时</td></tr><tr><td>错误处理和日志</td><td>2 小时</td></tr><tr><td><strong>总计</strong></td><td><strong>20 小时</strong></td></tr></tbody></table>
<p>实际上，因为各种问题，可能需要 <strong>3-4 天</strong>。</p>
<h3 data-id="heading-2">1.2 AI 辅助的后端开发</h3>
<p>有了 TRAE SOLO，小何的体验完全不同：</p>
<pre><code class="hljs language-txt" lang="txt">小何：帮我搭建 Next.js 15 后端 API，需要：
      1. MySQL 数据库，使用 Prisma ORM
      2. JWT 认证
      3. 微信小程序登录
      4. 统一的响应格式
      5. 日志记录

AI：好的，我来帮你搭建完整的后端架构：

    ✓ 分析项目结构，确定 Pages Router 模式
    ✓ 设计数据库表结构（用户、会员、账单等）
    ✓ 配置 Prisma ORM 连接 MySQL
    ✓ 实现 JWT 生成和验证
    ✓ 封装微信登录流程
    ✓ 统一响应格式（responseHelper）
    ✓ 配置 Winston 日志系统

    后端架构已生成，请查看...
</code></pre>
<p><strong>时间对比</strong>：</p>















































<table><thead><tr><th>任务</th><th>传统方式</th><th>AI 辅助</th><th>提升倍数</th></tr></thead><tbody><tr><td>数据库设计</td><td>3 小时</td><td>15 分钟</td><td><strong>12x</strong></td></tr><tr><td>Prisma 配置</td><td>4 小时</td><td>10 分钟</td><td><strong>24x</strong></td></tr><tr><td>JWT 认证</td><td>3 小时</td><td>10 分钟</td><td><strong>18x</strong></td></tr><tr><td>登录 API</td><td>4 小时</td><td>20 分钟</td><td><strong>12x</strong></td></tr><tr><td>响应格式统一</td><td>2 小时</td><td>5 分钟</td><td><strong>24x</strong></td></tr><tr><td><strong>总计</strong></td><td><strong>~20 小时</strong></td><td><strong>~1 小时</strong></td><td><strong>~20x</strong></td></tr></tbody></table>
<h2 data-id="heading-3">二、技术选型：为什么选择 Next.js 15 + Prisma</h2>
<h3 data-id="heading-4">2.1 Next.js 作为后端的优势</h3>
<pre><code class="hljs language-txt" lang="txt">小何：为什么后端要用 Next.js？不是应该用 Express 或 Koa 吗？

AI：Next.js 作为后端有独特优势：

    1. 全栈一体化
       - 前后端可以共享代码和类型
       - 部署更简单，一个服务搞定

    2. API Routes 开箱即用
       - 文件即路由，无需额外配置
       - 支持中间件、动态路由

    3. TypeScript 原生支持
       - 类型安全，减少运行时错误
       - 与 Prisma 完美配合

    4. 生态完善
       - 丰富的中间件和插件
       - 社区活跃，问题容易解决
</code></pre>
<h3 data-id="heading-5">2.2 Prisma vs TypeORM</h3>
<pre><code class="hljs language-txt" lang="txt">小何：Prisma 和 TypeORM 怎么选？

AI：（通过 MCP 查阅最新文档）

    ┌────────────────┬────────────────┬────────────────┐
    │     维度       │     Prisma     │    TypeORM     │
    ├────────────────┼────────────────┼────────────────┤
    │ 类型安全       │ ⭐⭐⭐⭐⭐     │ ⭐⭐⭐⭐       │
    │ 学习曲线       │ ⭐⭐⭐⭐⭐     │ ⭐⭐⭐         │
    │ 迁移管理       │ ⭐⭐⭐⭐⭐     │ ⭐⭐⭐⭐       │
    │ 查询直观性     │ ⭐⭐⭐⭐⭐     │ ⭐⭐⭐         │
    │ 性能           │ ⭐⭐⭐⭐       │ ⭐⭐⭐⭐       │
    │ 生态系统       │ ⭐⭐⭐⭐       │ ⭐⭐⭐⭐⭐     │
    └────────────────┴────────────────┴────────────────┘

    推荐：Prisma

    理由：
    1. Schema 定义直观，一目了然
    2. 自动生成类型，类型安全
    3. 迁移管理简单，prisma migrate 一键搞定
    4. 查询 API 简洁，链式调用友好
</code></pre>
<h3 data-id="heading-6">2.3 最终技术栈</h3>
<pre><code class="hljs language-txt" lang="txt">后端技术栈：
├── 框架：Next.js 15 (Pages Router)
├── 数据库：MySQL
├── ORM：Prisma 4.11
├── 认证：JWT (jsonwebtoken)
├── 加密：bcryptjs
├── 日志：Winston + daily-rotate-file
├── AI 集成：OpenAI SDK
├── 支付：微信支付 + 支付宝
├── 存储：腾讯云 COS
└── 类型共享：shared-types (workspace)
</code></pre>
<h2 data-id="heading-7">三、数据库设计：Prisma Schema</h2>
<h3 data-id="heading-8">3.1 用户表设计</h3>
<p>数据库设计是后端开发的第一步，也是最重要的一步。</p>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我设计用户表，需要支持：
1. 微信小程序登录（openid）
2. 手机号登录
3. 性别、年龄段等用户属性
4. 免费使用次数限制
5. 注册来源和渠道追踪
</code></pre>
<p><strong>AI 生成的 Prisma Schema</strong>：</p>
<pre><code class="hljs language-prisma" lang="prisma">// prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin", "darwin-arm64", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  user_id               String    @id @default(uuid())
  username              String
  email                 String?   @unique
  phone_number          String?
  openid                String?   // 微信 openid
  hashed_password       String
  email_verified        Boolean   @default(false)
  phone_verified        Boolean   @default(false)

  // 地理信息
  country               String?
  province              String?
  city                  String?
  isp                   String?

  // 用户属性
  verification_code     String?
  avatar                String?
  gender                Int?      // 1: 男, 2: 女
  age_group             Int?      // 1: 00后, 2: 05后, 3: 90后, 4: 80后, 5: 70后

  // 状态管理
  disabled_status       Int?      @default(0)
  disabled_time         DateTime?

  // 免费额度
  free_reply_total      Int       @default(3)
  free_reply_used       Int       @default(0)
  free_reply_reset_time DateTime?

  // 来源追踪
  register_source       Int       @default(1)  // 注册来源
  register_channel      Int       @default(1)  // 注册渠道
  latest_source         Int       @default(1)  // 最近来源
  latest_channel        Int       @default(1)  // 最近渠道

  // 时间戳
  code_send_time        DateTime?
  create_time           DateTime? @default(now())
  update_time           DateTime  @default(now()) @updatedAt
  operate_time          DateTime?

  // 索引
  @@unique([phone_number, deleted_status])
  @@index([register_source], name: "idx_users_register_source")
  @@index([latest_source], name: "idx_users_latest_source")
  @@map("users")
}
</code></pre>
<p><strong>设计要点解析</strong>：</p>
<ol>
<li><strong>UUID 主键</strong>：使用 <code>@default(uuid())</code> 而非自增 ID，分布式友好，自己玩的小项目推荐自增 ID</li>
<li><strong>软删除</strong>：<code>deleted_status</code> + <code>deleted_time</code>，数据可恢复</li>
<li><strong>来源追踪</strong>：<code>register_source/channel</code> 和 <code>latest_source/channel</code>，用于数据分析</li>
<li><strong>免费额度</strong>：<code>free_reply_total/used/reset_time</code>，实现每日免费次数限制</li>
</ol>
<h3 data-id="heading-9">3.2 会员表设计</h3>
<pre><code class="hljs language-prisma" lang="prisma">// 会员类型模型
model MembershipType {
  id              Int       @id @default(autoincrement())
  name            String    // 会员名称：月度会员、季度会员、年度会员
  price           Decimal   @db.Decimal(10, 2)
  duration_days   Int       // 会员时长（天）
  description     String?
  is_active       Boolean   @default(true)
  sort_order      Int       @default(0)
  create_time     DateTime  @default(now())
  update_time     DateTime  @default(now()) @updatedAt

  @@map("membership_types")
}

// 用户会员记录
model UserMembership {
  id              Int       @id @default(autoincrement())
  user_id         String
  membership_type Int       // 关联会员类型
  start_time      DateTime
  end_time        DateTime
  is_active       Boolean   @default(true)
  source          String    @default("purchase") // purchase/gift/invite
  order_id        String?   // 关联订单
  create_time     DateTime  @default(now())
  update_time     DateTime  @default(now()) @updatedAt

  @@index([user_id], name: "idx_user_membership_user_id")
  @@index([end_time], name: "idx_user_membership_end_time")
  @@map("user_memberships")
}
</code></pre>
<h3 data-id="heading-10">3.3 Prisma 初始化和迁移</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 Prisma</span>
pnpm --filter xingdong-server add prisma @prisma/client

<span class="hljs-comment"># 初始化 Prisma</span>
pnpm --filter xingdong-server prisma init

<span class="hljs-comment"># 生成 Prisma Client</span>
pnpm --filter xingdong-server prisma generate

<span class="hljs-comment"># 创建迁移</span>
pnpm --filter xingdong-server prisma migrate dev --name init

<span class="hljs-comment"># 查看数据库</span>
pnpm --filter xingdong-server prisma studio
</code></pre>
<h2 data-id="heading-11">四、项目结构：分层架构设计</h2>
<h3 data-id="heading-12">4.1 目录结构</h3>
<p>AI 帮小何设计了清晰的分层架构：</p>
<pre><code class="hljs language-txt" lang="txt">apps/xindong-server/
├── prisma/
│   └── schema.prisma           # 数据库模型定义
├── src/
│   ├── constants/              # 常量定义
│   │   └── index.ts
│   ├── db/                     # 数据访问层 (DAL)
│   │   ├── user.ts             # 用户数据操作
│   │   ├── chat.ts             # 聊天数据操作
│   │   ├── membership.ts       # 会员数据操作
│   │   └── ...
│   ├── helper/                 # 辅助工具
│   │   ├── logger.ts           # 日志工具
│   │   └── responseHelper.ts   # 响应格式化
│   ├── pages/
│   │   └── api/                # API 路由
│   │       ├── auth/           # 认证相关
│   │       │   ├── login.ts
│   │       │   ├── wx-login.ts
│   │       │   └── register.ts
│   │       ├── chat/           # 聊天相关
│   │       ├── membership/     # 会员相关
│   │       └── upload/         # 文件上传
│   ├── service/                # 业务逻辑层
│   │   ├── auth.ts             # 认证服务
│   │   ├── chatService.ts      # 聊天服务
│   │   ├── membershipService.ts
│   │   └── ...
│   ├── type/                   # 类型定义
│   └── utils/                  # 工具函数
│       ├── auth/
│       │   └── auth.ts         # JWT 工具
│       ├── prismaProxy.ts      # Prisma 代理
│       └── logRequest.ts       # 请求日志
├── .env                        # 环境变量
└── package.json
</code></pre>
<p><strong>分层职责</strong>：</p>
<ol>
<li><strong>pages/api</strong>：接收请求、参数验证、调用 Service</li>
<li><strong>service</strong>：业务逻辑处理、调用多个 DB 方法</li>
<li><strong>db</strong>：纯数据操作、Prisma 查询封装</li>
<li><strong>helper</strong>：通用辅助功能（日志、响应格式化）</li>
<li><strong>utils</strong>：工具函数（加密、JWT、请求处理）</li>
</ol>
<h3 data-id="heading-13">4.2 Prisma 代理封装</h3>
<p>AI 生成了一个 Prisma 代理，自动记录所有数据库操作日志：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/prismaProxy.ts</span>
<span class="hljs-keyword">import</span> logger <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper/logger'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@prisma/client'</span>;

<span class="hljs-keyword">const</span> prisma = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrismaClient</span>();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handlePrismaError</span>(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) {
  logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Prisma error: <span class="hljs-subst">${error.message}</span>`</span>, { error });
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">handler</span>: <span class="hljs-title class_">ProxyHandler</span>&lt;<span class="hljs-title class_">PrismaClient</span>&gt; = {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, propKey</span>) {
    <span class="hljs-keyword">const</span> origMethod = target[propKey <span class="hljs-keyword">as</span> keyof <span class="hljs-title class_">PrismaClient</span>];

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> origMethod === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable language_">this</span>: PrismaClient, ...args: <span class="hljs-built_in">unknown</span>[]</span>) {
        <span class="hljs-keyword">const</span> boundMethod = (origMethod <span class="hljs-keyword">as</span> <span class="hljs-title class_">Function</span>).<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>);
        <span class="hljs-keyword">try</span> {
          <span class="hljs-comment">// 记录请求日志</span>
          logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Prisma request: <span class="hljs-subst">${propKey.toString()}</span> with args: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(args)}</span>`</span>);

          <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">boundMethod</span>(...args);
          <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) {
            <span class="hljs-keyword">return</span> result
              .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
                <span class="hljs-comment">// 如果响应包含 count 属性，则记录所影响的行数</span>
                <span class="hljs-keyword">if</span> (res &amp;&amp; <span class="hljs-keyword">typeof</span> res.<span class="hljs-property">count</span> === <span class="hljs-string">'number'</span>) {
                  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Prisma response: <span class="hljs-subst">${propKey.toString()}</span> affected rows: <span class="hljs-subst">${res.count}</span>`</span>);
                }
                <span class="hljs-keyword">return</span> res;
              })
              .<span class="hljs-title function_">catch</span>(handlePrismaError);
          }
          <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">handlePrismaError</span>(error <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>);
        }
      };
    }

    <span class="hljs-keyword">return</span> target[propKey <span class="hljs-keyword">as</span> keyof <span class="hljs-title class_">PrismaClient</span>];
  },
};

<span class="hljs-keyword">const</span> prismaProxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(prisma, handler);
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> prismaProxy;
</code></pre>
<p><strong>使用方式</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 db 层使用代理后的 prisma</span>
<span class="hljs-keyword">import</span> prisma <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/prismaProxy'</span>;

<span class="hljs-comment">// 所有操作自动记录日志</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">findUnique</span>({
  <span class="hljs-attr">where</span>: { <span class="hljs-attr">user_id</span>: userId },
});
</code></pre>
<h2 data-id="heading-14">五、JWT 认证：从生成到验证</h2>
<h3 data-id="heading-15">5.1 JWT 工具封装</h3>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我封装 JWT 工具，需要：
1. 生成 Token（带过期时间）
2. 验证 Token
3. 密码哈希和验证
4. 使用 bcryptjs 加密
</code></pre>
<p><strong>AI 生成的代码</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/auth/auth.ts</span>
<span class="hljs-keyword">import</span> jwt <span class="hljs-keyword">from</span> <span class="hljs-string">'jsonwebtoken'</span>;
<span class="hljs-keyword">import</span> bcrypt <span class="hljs-keyword">from</span> <span class="hljs-string">'bcryptjs'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">TOKEN_EXPIRE_IN</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/constants'</span>;

<span class="hljs-comment">// 密码哈希</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> hashPassword = <span class="hljs-keyword">async</span> (<span class="hljs-attr">password</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; =&gt; {
  <span class="hljs-keyword">const</span> salt = <span class="hljs-keyword">await</span> bcrypt.<span class="hljs-title function_">genSalt</span>(<span class="hljs-number">10</span>);
  <span class="hljs-keyword">return</span> bcrypt.<span class="hljs-title function_">hash</span>(password, salt);
};

<span class="hljs-comment">// 密码验证</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> verifyPassword = <span class="hljs-keyword">async</span> (
  <span class="hljs-attr">password</span>: <span class="hljs-built_in">string</span>,
  <span class="hljs-attr">hashedPassword</span>: <span class="hljs-built_in">string</span>,
): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; =&gt; {
  <span class="hljs-keyword">return</span> bcrypt.<span class="hljs-title function_">compare</span>(password, hashedPassword);
};

<span class="hljs-comment">// 生成 JWT</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> generateJWT = (<span class="hljs-attr">userId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> jwt.<span class="hljs-title function_">sign</span>({ userId }, process.<span class="hljs-property">env</span>.<span class="hljs-property">JWT_SECRET</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, {
    <span class="hljs-attr">expiresIn</span>: <span class="hljs-variable constant_">TOKEN_EXPIRE_IN</span>, <span class="hljs-comment">// 例如 '7d'</span>
  });
};

<span class="hljs-comment">// 验证 JWT</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> verifyJWT = (<span class="hljs-attr">token</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt; =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    jwt.<span class="hljs-title function_">verify</span>(token, process.<span class="hljs-property">env</span>.<span class="hljs-property">JWT_SECRET</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, <span class="hljs-function">(<span class="hljs-params">err, decoded</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-title function_">reject</span>(err);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">resolve</span>(decoded);
      }
    });
  });
};
</code></pre>
<h3 data-id="heading-16">5.2 认证中间件</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/auth/authMiddleware.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextApiRequest</span>, <span class="hljs-title class_">NextApiResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>;
<span class="hljs-keyword">import</span> { verifyJWT } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth'</span>;
<span class="hljs-keyword">import</span> { sendUnauthorizedResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper/responseHelper'</span>;
<span class="hljs-keyword">import</span> { getUserById } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/db/user'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticatedRequest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NextApiRequest</span> {
  <span class="hljs-attr">userId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">user</span>: <span class="hljs-built_in">any</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">withAuth</span> = (<span class="hljs-params">
  handler: (req: AuthenticatedRequest, res: NextApiResponse) =&gt; <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;,
</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (<span class="hljs-attr">req</span>: <span class="hljs-title class_">NextApiRequest</span>, <span class="hljs-attr">res</span>: <span class="hljs-title class_">NextApiResponse</span>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 从 Header 获取 Token</span>
      <span class="hljs-keyword">const</span> authHeader = req.<span class="hljs-property">headers</span>.<span class="hljs-property">authorization</span>;
      <span class="hljs-keyword">if</span> (!authHeader || !authHeader.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'Bearer '</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendUnauthorizedResponse</span>(res, <span class="hljs-string">'请先登录'</span>);
      }

      <span class="hljs-keyword">const</span> token = authHeader.<span class="hljs-title function_">substring</span>(<span class="hljs-number">7</span>);

      <span class="hljs-comment">// 验证 Token</span>
      <span class="hljs-keyword">const</span> decoded = <span class="hljs-keyword">await</span> <span class="hljs-title function_">verifyJWT</span>(token);
      <span class="hljs-keyword">if</span> (!decoded || !decoded.<span class="hljs-property">userId</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendUnauthorizedResponse</span>(res, <span class="hljs-string">'Token 无效'</span>);
      }

      <span class="hljs-comment">// 获取用户信息</span>
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserById</span>(decoded.<span class="hljs-property">userId</span>);
      <span class="hljs-keyword">if</span> (!user) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendUnauthorizedResponse</span>(res, <span class="hljs-string">'用户不存在'</span>);
      }

      <span class="hljs-comment">// 注入用户信息</span>
      (req <span class="hljs-keyword">as</span> <span class="hljs-title class_">AuthenticatedRequest</span>).<span class="hljs-property">userId</span> = decoded.<span class="hljs-property">userId</span>;
      (req <span class="hljs-keyword">as</span> <span class="hljs-title class_">AuthenticatedRequest</span>).<span class="hljs-property">user</span> = user;

      <span class="hljs-comment">// 调用原始处理函数</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">handler</span>(req <span class="hljs-keyword">as</span> <span class="hljs-title class_">AuthenticatedRequest</span>, res);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendUnauthorizedResponse</span>(res, <span class="hljs-string">'认证失败，请重新登录'</span>);
    }
  };
};
</code></pre>
<p><strong>使用方式</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// pages/api/user/profile.ts</span>
<span class="hljs-keyword">import</span> { withAuth, <span class="hljs-title class_">AuthenticatedRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/auth/authMiddleware'</span>;
<span class="hljs-keyword">import</span> { sendSuccessResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper/responseHelper'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextApiResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">req: AuthenticatedRequest, res: NextApiResponse</span>) =&gt; {
  <span class="hljs-comment">// req.userId 和 req.user 已经可用</span>
  <span class="hljs-title function_">sendSuccessResponse</span>(res, <span class="hljs-string">'获取成功'</span>, {
    <span class="hljs-attr">user_id</span>: req.<span class="hljs-property">userId</span>,
    <span class="hljs-attr">username</span>: req.<span class="hljs-property">user</span>.<span class="hljs-property">username</span>,
  });
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">withAuth</span>(handler);
</code></pre>
<h2 data-id="heading-17">六、统一响应格式</h2>
<h3 data-id="heading-18">6.1 响应格式设计</h3>
<p>统一的响应格式是 API 开发的基本要求。AI 帮小何设计了清晰的响应结构：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/helper/responseHelper.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextApiResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>;
<span class="hljs-keyword">import</span> logger <span class="hljs-keyword">from</span> <span class="hljs-string">'./logger'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">UNAUTHORIZED_TIPS</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/constants'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">JsonResponse</span> {
  <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
  data?: <span class="hljs-built_in">any</span>;
}

<span class="hljs-comment">// 通用响应</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendResponse</span>(<span class="hljs-params">res: NextApiResponse, code: <span class="hljs-built_in">number</span>, message: <span class="hljs-built_in">string</span>, data: <span class="hljs-built_in">any</span> = <span class="hljs-literal">null</span></span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">jsonResponse</span>: <span class="hljs-title class_">JsonResponse</span> = {
    code,
    message,
    data,
  };
  res.<span class="hljs-title function_">status</span>(code).<span class="hljs-title function_">json</span>(jsonResponse);
}

<span class="hljs-comment">// 成功响应</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendSuccessResponse</span>(<span class="hljs-params">
  res: NextApiResponse,
  message: <span class="hljs-built_in">string</span> = <span class="hljs-string">'数据获取成功'</span>,
  data: <span class="hljs-built_in">any</span> = <span class="hljs-literal">null</span>,
</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">200</span>, message, data);
}

<span class="hljs-comment">// 错误响应（服务器错误）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendErrorResponse</span>(<span class="hljs-params">res: NextApiResponse, message: <span class="hljs-built_in">string</span>, data: <span class="hljs-built_in">any</span> = <span class="hljs-literal">null</span></span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">500</span>, message, data);
  logger.<span class="hljs-title function_">error</span>(message);
  logger.<span class="hljs-title function_">error</span>(data);
}

<span class="hljs-comment">// 警告响应（业务错误）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendWarnningResponse</span>(<span class="hljs-params">res: NextApiResponse, message: <span class="hljs-built_in">string</span>, data: <span class="hljs-built_in">any</span> = <span class="hljs-literal">null</span></span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">503</span>, message, data);
}

<span class="hljs-comment">// 未授权响应</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendUnauthorizedResponse</span>(<span class="hljs-params">
  res: NextApiResponse,
  message: <span class="hljs-built_in">string</span> = UNAUTHORIZED_TIPS,
</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">401</span>, message);
}

<span class="hljs-comment">// 方法不允许</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMethodNotAllowedResponse</span>(<span class="hljs-params">
  res: NextApiResponse,
  message: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Method Not Allowed'</span>,
</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">405</span>, message);
}
</code></pre>
<h3 data-id="heading-19">6.2 响应码设计</h3>



































<table><thead><tr><th>状态码</th><th>含义</th><th>使用场景</th></tr></thead><tbody><tr><td>200</td><td>成功</td><td>请求成功处理</td></tr><tr><td>401</td><td>未授权</td><td>Token 无效或过期</td></tr><tr><td>405</td><td>方法不允许</td><td>GET 接口收到 POST 请求</td></tr><tr><td>500</td><td>服务器错误</td><td>代码异常、数据库错误</td></tr><tr><td>503</td><td>业务警告</td><td>参数错误、业务规则不满足</td></tr></tbody></table>
<p><strong>前端统一处理</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 前端 HTTP 拦截器</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResponse</span> = (<span class="hljs-params">response: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> { code, message, data } = response;

  <span class="hljs-keyword">switch</span> (code) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">200</span>:
      <span class="hljs-keyword">return</span> data;
    <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:
      <span class="hljs-comment">// 跳转登录</span>
      uni.<span class="hljs-title function_">reLaunch</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/login/login'</span> });
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(message);
    <span class="hljs-keyword">case</span> <span class="hljs-number">503</span>:
      <span class="hljs-comment">// 业务警告，显示 Toast</span>
      uni.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: message, <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span> });
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(message);
    <span class="hljs-keyword">case</span> <span class="hljs-number">500</span>:
      <span class="hljs-comment">// 服务器错误</span>
      uni.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'服务器开小差了'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span> });
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(message);
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(message || <span class="hljs-string">'未知错误'</span>);
  }
};
</code></pre>
<h2 data-id="heading-20">七、微信小程序登录实现</h2>
<h3 data-id="heading-21">7.1 登录流程设计</h3>
<p>微信小程序登录是"心动恋聊"的核心功能。AI 帮小何设计了完整的登录流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as 小程序端
    participant Server as 后端服务
    participant WX as 微信服务器

    Client-&gt;&gt;Client: 1. wx.login()
    Client-&gt;&gt;Client: 2. 返回 code

    Client-&gt;&gt;Server: 3. POST /api/auth/wx-login
    Note right of Client: { code, gender, age_group }

    Server-&gt;&gt;WX: 4. jscode2session
    WX--&gt;&gt;Server: 5. 返回 openid

    Server-&gt;&gt;Server: 6. 查找/创建用户
    Server-&gt;&gt;Server: 7. 生成 JWT

    Server--&gt;&gt;Client: 8. 返回 token + userInfo
</code></pre>
<h3 data-id="heading-22">7.2 登录 API 实现</h3>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我实现微信小程序登录 API，需要：
1. 接收 wx.login 的 code
2. 调用微信服务器获取 openid
3. 新用户需要收集性别和年龄段
4. 老用户直接返回 token
5. 支持多来源（小程序、App）
6. 记录用户来源和渠道
</code></pre>
<p><strong>AI 生成的代码</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/pages/api/auth/wx-login.ts</span>
<span class="hljs-keyword">import</span> { sendErrorResponse, sendSuccessResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper/responseHelper'</span>;
<span class="hljs-keyword">import</span> { generateJWT } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/auth/auth'</span>;
<span class="hljs-keyword">import</span> { getUserByOpenid, createUserByOpenid } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/db/user'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextApiRequest</span>, <span class="hljs-title class_">NextApiResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">req: NextApiRequest, res: NextApiResponse</span>) =&gt; {
  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> !== <span class="hljs-string">'POST'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendErrorResponse</span>(res, <span class="hljs-string">'Method Not Allowed'</span>);
  }

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> { code, gender, age_group } = req.<span class="hljs-property">body</span>;

    <span class="hljs-comment">// 1. 调用微信服务器获取 openid</span>
    <span class="hljs-keyword">const</span> wxLoginUrl = <span class="hljs-string">`https://api.weixin.qq.com/sns/jscode2session?appid=<span class="hljs-subst">${process.env.WX_APPID}</span>&amp;secret=<span class="hljs-subst">${process.env.WX_SECRET}</span>&amp;js_code=<span class="hljs-subst">${code}</span>&amp;grant_type=authorization_code`</span>;
    <span class="hljs-keyword">const</span> wxRes = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(wxLoginUrl);
    <span class="hljs-keyword">const</span> { openid } = <span class="hljs-keyword">await</span> wxRes.<span class="hljs-title function_">json</span>();

    <span class="hljs-comment">// 2. 查找或创建用户</span>
    <span class="hljs-keyword">let</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserByOpenid</span>(openid);
    <span class="hljs-keyword">let</span> isNewUser = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (!user) {
      <span class="hljs-comment">// 新用户需要提供性别和年龄</span>
      <span class="hljs-keyword">if</span> (!gender || !age_group) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendSuccessResponse</span>(res, <span class="hljs-string">'需要完善信息'</span>, { <span class="hljs-attr">needsRegistration</span>: <span class="hljs-literal">true</span>, openid });
      }
      user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createUserByOpenid</span>(openid, gender, age_group);
      isNewUser = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">// 3. 生成 JWT Token</span>
    <span class="hljs-keyword">const</span> token = <span class="hljs-title function_">generateJWT</span>(user.<span class="hljs-property">user_id</span>);

    <span class="hljs-comment">// 4. 返回登录结果</span>
    <span class="hljs-title function_">sendSuccessResponse</span>(res, <span class="hljs-string">'登录成功'</span>, { token, ...user, isNewUser });
  } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>) {
    <span class="hljs-title function_">sendErrorResponse</span>(res, <span class="hljs-string">'登录失败'</span>, error.<span class="hljs-property">message</span>);
  }
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> handler;
</code></pre>
<h3 data-id="heading-23">7.3 登录服务层</h3>
<p>手机号登录的服务层封装，支持密码和验证码两种方式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/service/auth.ts</span>
<span class="hljs-keyword">import</span> { getUserByPhoneNumber } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/db/user'</span>;
<span class="hljs-keyword">import</span> { checkCodeValid } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/service/checkCodeValid'</span>;
<span class="hljs-keyword">import</span> { generateJWT, verifyPassword } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/auth/auth'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LoginCredentials</span>, <span class="hljs-title class_">LoginResult</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'shared-types'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthServiceError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Error</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    message: <span class="hljs-built_in">string</span>,
    <span class="hljs-keyword">public</span> code: <span class="hljs-built_in">string</span>,
  </span>) {
    <span class="hljs-variable language_">super</span>(message);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'AuthServiceError'</span>;
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loginUser</span>(<span class="hljs-params">credentials: LoginCredentials</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">LoginResult</span>&gt; {
  <span class="hljs-keyword">const</span> { phone_number, password, verification_code } = credentials;

  <span class="hljs-comment">// 从数据库获取用户</span>
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserByPhoneNumber</span>(phone_number!);
  <span class="hljs-keyword">if</span> (!user) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(<span class="hljs-string">'该用户不存在，请先注册'</span>, <span class="hljs-string">'USER_NOT_FOUND'</span>);
  }

  <span class="hljs-keyword">if</span> (password) {
    <span class="hljs-comment">// 密码登录</span>
    <span class="hljs-keyword">const</span> decodedPassword = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(password, <span class="hljs-string">'base64'</span>).<span class="hljs-title function_">toString</span>();
    <span class="hljs-keyword">const</span> isPasswordValid = <span class="hljs-keyword">await</span> <span class="hljs-title function_">verifyPassword</span>(decodedPassword, user.<span class="hljs-property">hashed_password</span>);
    <span class="hljs-keyword">if</span> (!isPasswordValid) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(<span class="hljs-string">'手机号或密码输入有误'</span>, <span class="hljs-string">'INVALID_CREDENTIALS'</span>);
    }

    <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">phone_verified</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(
        <span class="hljs-string">'手机号未验证通过，请先使用手机号+验证码的方式登录'</span>,
        <span class="hljs-string">'PHONE_UNVERIFIED'</span>,
      );
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 验证码登录</span>
    <span class="hljs-keyword">if</span> (!verification_code) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(<span class="hljs-string">'请输入验证码'</span>, <span class="hljs-string">'MISSING_VERIFICATION_CODE'</span>);
    }
    <span class="hljs-keyword">const</span> { valid, msg } = <span class="hljs-title function_">checkCodeValid</span>({ user, <span class="hljs-attr">code</span>: verification_code });
    <span class="hljs-keyword">if</span> (!valid) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(msg, <span class="hljs-string">'INVALID_VERIFICATION_CODE'</span>);
    }

    <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">phone_verified</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(<span class="hljs-string">'请先注册完成后再登录'</span>, <span class="hljs-string">'USER_NOT_REGISTERED'</span>);
    }
  }

  <span class="hljs-comment">// 生成 JWT</span>
  <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateJWT</span>(user.<span class="hljs-property">user_id</span>);

  <span class="hljs-keyword">return</span> {
    user,
    token,
  };
}
</code></pre>
<h2 data-id="heading-24">八、前后端类型共享：shared-types</h2>
<h3 data-id="heading-25">8.1 为什么需要类型共享</h3>
<p>前后端分离开发时，最常见的问题是<strong>接口对不上</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">后端：{ user_id: "xxx" }
前端：{ userId: "xxx" }  // 拿不到数据

后端：{ gender: 1 }
前端：{ gender: "男" }  // 类型不匹配
</code></pre>
<p>解决方案：<strong>shared-types 包</strong>。</p>
<h3 data-id="heading-26">8.2 类型定义</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/shared-types/enums.ts</span>

<span class="hljs-comment">/**
 * 性别枚举
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">GenderEnum</span> {
  <span class="hljs-variable constant_">MALE</span> = <span class="hljs-number">1</span>,
  <span class="hljs-variable constant_">FEMALE</span> = <span class="hljs-number">2</span>,
}

<span class="hljs-comment">/**
 * 年龄段枚举
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">AgeGroupEnum</span> {
  <span class="hljs-variable constant_">POST_00</span> = <span class="hljs-number">1</span>,  <span class="hljs-comment">// 00后</span>
  <span class="hljs-variable constant_">POST_05</span> = <span class="hljs-number">2</span>,  <span class="hljs-comment">// 05后</span>
  <span class="hljs-variable constant_">POST_90</span> = <span class="hljs-number">3</span>,  <span class="hljs-comment">// 90后</span>
  <span class="hljs-variable constant_">POST_80</span> = <span class="hljs-number">4</span>,  <span class="hljs-comment">// 80后</span>
  <span class="hljs-variable constant_">POST_70</span> = <span class="hljs-number">5</span>,  <span class="hljs-comment">// 70后</span>
}

<span class="hljs-comment">/**
 * 年龄段枚举映射（用于显示）
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AgeGroupMap</span> = {
  [<span class="hljs-title class_">AgeGroupEnum</span>.<span class="hljs-property">POST_00</span>]: <span class="hljs-string">'00后'</span>,
  [<span class="hljs-title class_">AgeGroupEnum</span>.<span class="hljs-property">POST_05</span>]: <span class="hljs-string">'05后'</span>,
  [<span class="hljs-title class_">AgeGroupEnum</span>.<span class="hljs-property">POST_90</span>]: <span class="hljs-string">'90后'</span>,
  [<span class="hljs-title class_">AgeGroupEnum</span>.<span class="hljs-property">POST_80</span>]: <span class="hljs-string">'80后'</span>,
  [<span class="hljs-title class_">AgeGroupEnum</span>.<span class="hljs-property">POST_70</span>]: <span class="hljs-string">'70后'</span>,
};

<span class="hljs-comment">/**
 * 客户端来源枚举
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ClientSourceEnum</span> {
  <span class="hljs-variable constant_">MP_WEIXIN</span> = <span class="hljs-number">1</span>,  <span class="hljs-comment">// 微信小程序</span>
  <span class="hljs-variable constant_">ANDROID</span> = <span class="hljs-number">2</span>,    <span class="hljs-comment">// 安卓 App</span>
  <span class="hljs-variable constant_">HARMONY</span> = <span class="hljs-number">3</span>,    <span class="hljs-comment">// 鸿蒙</span>
}
</code></pre>
<h3 data-id="heading-27">8.3 在项目中使用</h3>
<p><strong>后端使用</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// apps/xingdong-server/src/service/auth.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LoginCredentials</span>, <span class="hljs-title class_">LoginResult</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'shared-types'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loginUser</span>(<span class="hljs-params">credentials: LoginCredentials</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">LoginResult</span>&gt; {
  <span class="hljs-comment">// 类型自动推导，IDE 智能提示</span>
}
</code></pre>
<p><strong>前端使用</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// apps/unibest-mp/src/api/auth.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">WxLoginParams</span>, <span class="hljs-title class_">WxLoginResult</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'shared-types'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> apiWxLogin = (<span class="hljs-attr">params</span>: <span class="hljs-title class_">WxLoginParams</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">WxLoginResult</span>&gt; =&gt; {
  <span class="hljs-keyword">return</span> http.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/auth/wx-login'</span>, params);
};
</code></pre>
<p><strong>package.json 配置</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"shared-types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"workspace:*"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>Next.js 配置</strong>（重要！）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// next.config.js</span>
<span class="hljs-keyword">const</span> nextConfig = {
  <span class="hljs-attr">reactStrictMode</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">transpilePackages</span>: [<span class="hljs-string">'shared-types'</span>], <span class="hljs-comment">// 编译本地 TypeScript 包</span>
};
</code></pre>
<h2 data-id="heading-28">九、日志系统：Winston 配置</h2>
<h3 data-id="heading-29">9.1 日志配置</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/helper/logger.ts</span>
<span class="hljs-keyword">import</span> winston <span class="hljs-keyword">from</span> <span class="hljs-string">'winston'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">DailyRotateFile</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'winston-daily-rotate-file'</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;

<span class="hljs-comment">// 日志目录</span>
<span class="hljs-keyword">const</span> logDir = path.<span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'logs'</span>);

<span class="hljs-comment">// 日志格式</span>
<span class="hljs-keyword">const</span> logFormat = winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">combine</span>(
  winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">timestamp</span>({ <span class="hljs-attr">format</span>: <span class="hljs-string">'YYYY-MM-DD HH:mm:ss'</span> }),
  winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">errors</span>({ <span class="hljs-attr">stack</span>: <span class="hljs-literal">true</span> }),
  winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">{ timestamp, level, message, ...meta }</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> msg = <span class="hljs-string">`<span class="hljs-subst">${timestamp}</span> [<span class="hljs-subst">${level.toUpperCase()}</span>]: <span class="hljs-subst">${message}</span>`</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(meta).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      msg += <span class="hljs-string">` <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(meta)}</span>`</span>;
    }
    <span class="hljs-keyword">return</span> msg;
  }),
);

<span class="hljs-comment">// 创建 logger</span>
<span class="hljs-keyword">const</span> logger = winston.<span class="hljs-title function_">createLogger</span>({
  <span class="hljs-attr">level</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">LOG_LEVEL</span> || <span class="hljs-string">'info'</span>,
  <span class="hljs-attr">format</span>: logFormat,
  <span class="hljs-attr">transports</span>: [
    <span class="hljs-comment">// 控制台输出</span>
    <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">Console</span>({
      <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">combine</span>(winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">colorize</span>(), logFormat),
    }),
    <span class="hljs-comment">// 按日期滚动的文件日志</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">DailyRotateFile</span>({
      <span class="hljs-attr">dirname</span>: logDir,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'app-%DATE%.log'</span>,
      <span class="hljs-attr">datePattern</span>: <span class="hljs-string">'YYYY-MM-DD'</span>,
      <span class="hljs-attr">maxSize</span>: <span class="hljs-string">'20m'</span>,
      <span class="hljs-attr">maxFiles</span>: <span class="hljs-string">'14d'</span>,
    }),
    <span class="hljs-comment">// 错误日志单独存放</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">DailyRotateFile</span>({
      <span class="hljs-attr">dirname</span>: logDir,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'error-%DATE%.log'</span>,
      <span class="hljs-attr">datePattern</span>: <span class="hljs-string">'YYYY-MM-DD'</span>,
      <span class="hljs-attr">level</span>: <span class="hljs-string">'error'</span>,
      <span class="hljs-attr">maxSize</span>: <span class="hljs-string">'20m'</span>,
      <span class="hljs-attr">maxFiles</span>: <span class="hljs-string">'30d'</span>,
    }),
  ],
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> logger;
</code></pre>
<h3 data-id="heading-30">9.2 请求日志中间件</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/logRequest.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextApiRequest</span>, <span class="hljs-title class_">NextApiResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>;
<span class="hljs-keyword">import</span> logger <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper/logger'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">logRequest</span> = (<span class="hljs-params">req: NextApiRequest, res: NextApiResponse</span>) =&gt; {
  <span class="hljs-keyword">const</span> { method, url, body, query } = req;

  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`API Request: <span class="hljs-subst">${method}</span> <span class="hljs-subst">${url}</span>`</span>, {
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(body),
    <span class="hljs-attr">query</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(query),
    <span class="hljs-attr">ip</span>: req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-forwarded-for'</span>] || req.<span class="hljs-property">socket</span>.<span class="hljs-property">remoteAddress</span>,
    <span class="hljs-attr">userAgent</span>: req.<span class="hljs-property">headers</span>[<span class="hljs-string">'user-agent'</span>],
  });

  <span class="hljs-comment">// 记录响应时间</span>
  <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'finish'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime;
    logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`API Response: <span class="hljs-subst">${method}</span> <span class="hljs-subst">${url}</span> - <span class="hljs-subst">${res.statusCode}</span> (<span class="hljs-subst">${duration}</span>ms)`</span>);
  });
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> logRequest;
</code></pre>
<h2 data-id="heading-31">十、总结与下一步</h2>
<h3 data-id="heading-32">10.1 本篇完成的工作</h3>
<p>通过 AI 辅助，我们在 <strong>约 1 小时</strong> 内完成了：</p>





































<table><thead><tr><th>任务</th><th>完成情况</th></tr></thead><tbody><tr><td>✅ Prisma 数据库设计</td><td>用户、会员、账单等核心表</td></tr><tr><td>✅ 分层架构</td><td>API → Service → DB 清晰分离</td></tr><tr><td>✅ JWT 认证</td><td>生成、验证、中间件完整实现</td></tr><tr><td>✅ 微信登录</td><td>支持小程序、App 多端登录</td></tr><tr><td>✅ 统一响应格式</td><td>responseHelper 标准化</td></tr><tr><td>✅ 类型共享</td><td>shared-types 前后端类型一致</td></tr><tr><td>✅ 日志系统</td><td>Winston 按日期滚动、分级存储</td></tr></tbody></table>
<h3 data-id="heading-33">10.2 核心提示词模板</h3>
<p><strong>数据库设计</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我设计 [表名] 表，需要支持：
1. [功能点 1]
2. [功能点 2]
3. [功能点 3]
使用 Prisma Schema 语法
</code></pre>
<p><strong>API 开发</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我实现 [功能名称] API，需要：
1. [接口功能]
2. [参数要求]
3. [返回格式]
4. [错误处理]
</code></pre>
<p><strong>工具封装</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我封装 [工具名称]，需要：
1. [功能点 1]
2. [功能点 2]
示例用法：[使用场景]
</code></pre>
<h3 data-id="heading-34">10.3 下一篇预告</h3>
<p><strong>《【AI 编程实战】第 4 篇：用 AI 打造原子化 CSS 开发体系 - UnoCSS 实战》</strong></p>
<p>我们将学习：</p>
<ul>
<li>UnoCSS 高级配置</li>
<li>设计稿转代码技巧</li>
<li>主题定制和换肤</li>
<li>小程序端样式优化</li>
<li>响应式布局实践</li>
</ul>
<p><strong>关注我，不错过每一篇实战干货！</strong></p>
<hr/>
<blockquote>
<p>如果这篇文章对你有帮助，请点赞、收藏、转发，让更多人了解 AI 编程的强大！</p>
<p>有任何问题，欢迎在评论区留言，我们一起讨论。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一行代码实现智能异常检测：UModel PaaS API 架构设计与最佳实践]]></title>    <link>https://juejin.cn/post/7582156219059535935</link>    <guid>https://juejin.cn/post/7582156219059535935</guid>    <pubDate>2025-12-11T03:43:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582156219059535935" data-draft-id="7581995152190586922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一行代码实现智能异常检测：UModel PaaS API 架构设计与最佳实践"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-12-11T03:43:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一行代码实现智能异常检测：UModel PaaS API 架构设计与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T03:43:49.000Z" title="Thu Dec 11 2025 03:43:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：张鑫（千乘）</p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1jS2VBJEzE%2F" target="_blank" title="https://www.bilibili.com/video/BV1jS2VBJEzE/" ref="nofollow noopener noreferrer">此处</a>，查看视频演示！</p>
<p><strong>前文回顾：</strong></p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580386%26idx%3D1%26sn%3D60829abde772d4544cf2d66c1a7b81a7%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580386&amp;idx=1&amp;sn=60829abde772d4544cf2d66c1a7b81a7&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">基于 UModel 高效构建可观测场景统一实体搜索引擎</a>》</p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580174%26idx%3D1%26sn%3Ddf8ad313c69dd0157057a46b81c7ab40%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580174&amp;idx=1&amp;sn=df8ad313c69dd0157057a46b81c7ab40&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">构建数据资产“导航地图”：详解 UModel 数据发现与全链路分析能力</a>》</p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580441%26idx%3D1%26sn%3D28b760dfa51d9a5085abda9660519067%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580441&amp;idx=1&amp;sn=28b760dfa51d9a5085abda9660519067&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">打通可观测性的“任督二脉”：实体与关系的终极融合</a>》</p>
<h2 data-id="heading-0">背景</h2>
<p>基于 UModel 构建的可观测系统，访问可观测数据需要上层应用感知 EntitySet、DataSet、Storage、Filter 等多个概念，给 UI、算法、客户等使用方带来了较高的开发和维护成本。</p>
<h3 data-id="heading-1">典型场景：查询 APM 服务的请求量指标</h3>
<p>假设上层应用需要实现查询某个 APM 服务的请求量指标，开发者需要经历以下步骤：</p>
<h4 data-id="heading-2">开发者需要了解的知识</h4>
<ol>
<li><strong>实体关联：</strong> 服务实体关联哪个 MetricSet？</li>
<li><strong>存储路由：</strong> MetricSet 使用哪个 MetricStore？Region/Project/存储名称是什么？</li>
<li><strong>字段映射：</strong> Entity 的 <code>service_id</code> 对应存储的哪个字段（如 <code>acs_arms_service_id</code>）？</li>
<li><strong>查询语法：</strong> 如何编写 PromQL 表达式 <code>rate(arms_app_requests_count_raw{...}[1m])</code>？</li>
<li><strong>SPL 拼接：</strong> 如何组装成完整的查询语句？</li>
</ol>
<h4 data-id="heading-3">完整的开发步骤</h4>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">Step</span> <span class="hljs-number">1</span>: 查询 UModel 元数据
        ↓ 找到 service EntitySet 关联的 MetricSet
        ↓ 如果 DataLink 中包含 FilterByEntity，还需根据实体数据过滤
<span class="hljs-keyword">Step</span> <span class="hljs-number">2</span>: 解析 MetricSet 配置
        ↓ 根据 StorageLink 获取底层 MetricStore 连接信息
        ↓ 获取 Region/Project/MetricStore 名称
<span class="hljs-keyword">Step</span> <span class="hljs-number">3</span>: 查看字段映射
        ↓ 从 DataLink 中获取字段映射表
        ↓ 确认 service_id → acs_arms_service_id
<span class="hljs-keyword">Step</span> <span class="hljs-number">4</span>: 构造 PromQL 表达式
        ↓ 根据指标定义拼接查询表达式
        ↓ 处理聚合规则、时间窗口
<span class="hljs-keyword">Step</span> <span class="hljs-number">5</span>: 拼接并执行查询
        ↓ 使用正确的 label 和 MetricStore
        ↓ 拼接完整的 SPL 语句并执行
</code></pre>
<p><strong>最终查询语句示例：</strong></p>
<pre><code class="hljs language-ini" lang="ini">.metricstore with(<span class="hljs-attr">region</span>=<span class="hljs-string">'cn-hangzhou'</span>, project=<span class="hljs-string">'cms-xxx'</span>, metricstore=<span class="hljs-string">'metricstore-apm'</span>)
|prom-call promql_query_range('sum by (acs_arms_service_id) (rate(arms_app_requests_count_raw{<span class="hljs-attr">acs_arms_service_id</span>=&amp;<span class="hljs-comment">#34;xxx&amp;#34;}[1m]))','1m')</span>
</code></pre>
<h3 data-id="heading-4">痛点</h3>
<h4 data-id="heading-5">痛点 1：概念复杂，学习门槛高</h4>
<p><strong>问题描述：</strong></p>
<ul>
<li>开发者必须深入理解 UModel 架构：EntitySet、DataSet、DataLink、StorageLink、Filter 等多个概念</li>
<li>需要了解 DataSet 与 Storage 的关联关系、Filter 路由逻辑、字段映射规则</li>
<li>新人上手困难，老手也容易遗漏细节</li>
</ul>
<p><strong>影响：</strong> 开发效率低，维护成本高</p>
<h4 data-id="heading-6">痛点 2：复杂场景实现困难</h4>
<p><strong>问题描述：</strong></p>
<ul>
<li>存储路由查找：需要理解多个 MetricSet 之间的选择逻辑</li>
<li>字段映射处理：Entity 字段 → 存储字段的映射规则复杂</li>
<li>过滤条件筛选：FilterByEntity 规则匹配逻辑难以掌握</li>
<li>多次查询拼接：需要多次查询元数据，再构建数据查询</li>
</ul>
<p><strong>影响：</strong> 增加代码复杂度，出错概率高</p>
<h4 data-id="heading-7">痛点 3：底层存储语法逃不掉</h4>
<p><strong>问题描述：</strong></p>
<ul>
<li>MetricSet 可能由 MetricStore 或 LogStore 实现，查询方式完全不同（PromQL vs SPL）</li>
<li>不同存储提供商（ARMS MetricStore、Aliyun Prometheus）语法有差异</li>
<li>开发者仍需精通底层查询语言</li>
</ul>
<p><strong>影响：</strong> 同样的需求需要编写不同的代码，无法统一</p>
<h4 data-id="heading-8">痛点 4：多次查询交互，效率低</h4>
<p><strong>问题描述：</strong></p>
<ul>
<li>先查询 UModel Meta 获取配置 → 再根据 Meta 查询数据</li>
<li>需要自己处理数据拼接和关联</li>
<li>每个使用方都要实现类似逻辑，代码重复度高</li>
</ul>
<p><strong>影响：</strong> 集成成本高，查询延迟大，出错概率增加</p>
<h2 data-id="heading-9">目标与架构</h2>
<h3 data-id="heading-10">设计目标</h3>
<p>针对上述四大痛点，UModel PaaS API 的设计目标是屏蔽底层复杂性，统一访问接口，使上层应用更加专注业务逻辑实现：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9984af49c44c48b0afcc31e96cfd5319~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=XbhGfO0hwA05cH8CwyCpYyGGoCk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-11">核心设计原则</h4>
<ul>
<li><strong>自动化处理：</strong> 自动路由、字段映射、查询转换</li>
<li><strong>统一 SPL 语法：</strong> 所有数据类型使用一致接口</li>
<li><strong>面向对象编程：</strong> 实体方法调用、关系导航</li>
<li><strong>AI 友好：</strong> 反射能力，支持 AI Agent 自主探索</li>
</ul>
<h3 data-id="heading-12">设计理念：两层抽象</h3>
<p>访问 UModel 数据时，需要单独通过 SPL 去访问指标、日志、链路等各种数据，<strong>每种数据都有不同的访问方式，没有统一的抽象。</strong></p>
<p>UModel PaaS API 采用<strong>两层抽象</strong>的设计思路：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8522b6f41d74dcbb3ed0282b539cb6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=uGJOUpgd856GZZJcjGWoRfC6myk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-13">第一层抽象：Table 模式（表格化抽象）</h4>
<p>将所有数据——指标、日志、链路、性能剖析——统一抽象成<strong>表格结构</strong>，所有查询都是针对表格数据进行操作。</p>
<p><strong>价值：</strong> 统一了查询语言，开发者不需要关心底层是 PromQL 还是 SLS SPL，都用同一套 SPL 语法。</p>
<h4 data-id="heading-14">第二层抽象：Object 模式（对象级抽象）</h4>
<p>表格模式解决了数据访问的统一性，但还不够。我们还需要<strong>以实体为中心</strong>的抽象。</p>
<p>传统方式：查询一个服务的指标，需要知道这个服务关联哪个 MetricSet、字段如何映射、过滤条件怎么写…</p>
<p>Object 模式：只需要说“这个服务，给我它的指标”，系统自动处理字段映射、过滤条件、存储路由。</p>
<p><strong>价值：</strong> 面向对象的思想，把实体当成对象，把查询当成方法调用：<code>service.get_metric()</code>。</p>
<h4 data-id="heading-15">第三层能力：元数据查询（反射能力）</h4>
<p>提供动态能力发现、配置验证等高级功能，让 AI Agent 可以自主探索、自主决策。</p>
<p><strong>价值：</strong> AI Agent 能够通过反射能力动态发现实体的能力边界，实现真正的智能运维。</p>
<h3 data-id="heading-16">架构分层</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2ea6c34f60146fc9b4f7abe3d714181~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=TAw%2BSRBwdG9e%2F7h0v48s9gQB7tk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-17">1. 存储层统一：EntityStore/LogStore/MetricStore → SPL</h4>
<p>自动完成存储路由、字段映射（<code>service_id → acs_arms_service_id</code>）、过滤、查询语法的转换。上层应用对存储切换无感知。</p>
<h4 data-id="heading-18">2. 数据层统一：Table 模式</h4>
<p>直接访问 DataSet，声明式查询，支持完整 SPL Pipeline。</p>
<pre><code class="hljs language-ini" lang="ini">.metric_set with(<span class="hljs-attr">domain</span>=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'service.request'</span>, query=`service_id=<span class="hljs-string">'xxxx'</span>`) | stats avg(latency)
.log_set with(<span class="hljs-attr">domain</span>=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'service.error_log'</span> query=`service_id=<span class="hljs-string">'xxx'</span>`) | where level=&amp;<span class="hljs-comment">#34;ERROR&amp;#34;</span>
</code></pre>
<h4 data-id="heading-19">3. 对象层统一：Object 模式</h4>
<p>以实体为中心，自动处理底层细节，支持动态能力发现和配置检查。</p>
<pre><code class="hljs language-java" lang="java"># 数据访问
.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>, ids=[<span class="hljs-string">'404e5d6be468f6dfaeef37a014322423'</span>])</span> 
| entity-call <span class="hljs-title function_">get_metric</span><span class="hljs-params">(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>, <span class="hljs-string">''</span>, <span class="hljs-literal">false</span>)</span> 
# 能力发现（Agent 自主决策的关键）
.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'service'</span>)</span> | entity-call <span class="hljs-title function_">__list_method__</span><span class="hljs-params">()</span>
# 配置检查
.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'service'</span>)</span> | entity-call <span class="hljs-title function_">__inspect__</span><span class="hljs-params">()</span>
</code></pre>
<h2 data-id="heading-20">API 说明</h2>
<p>UModel PaaS API 提供三大核心能力，满足不同场景的查询需求：</p>
<ol>
<li><strong>Table 模式</strong> - 直接访问数据集，适合批量数据分析</li>
<li><strong>Object 模式</strong> - 以实体为中心，适合实体详情查询和关系分析</li>
<li><strong>元数据查询</strong> - 反射能力和配置验证，支持 AI Agent 和开发调试</li>
</ol>
<h3 data-id="heading-21">Table 模式</h3>
<p>Table 模式（Phase 1）提供直接访问 DataSet（MetricSet、LogSet、TraceSet 等）的能力，返回表格化的可观测数据，适用于不依赖实体关系的数据查询场景。</p>
<p>如：直接查询某个 MetricSet 中的指标数据，或查询某个 LogSet 中的日志，无需关联实体信息。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 读取 apm.metric.apm.service MetricSet对应的avg_request_latency_seconds的指标，</span>
<span class="hljs-comment"># 并对该指标进行异常检测</span>
.metric_set with(<span class="hljs-attr">domain</span>=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.metric.apm.service'</span>, metric=<span class="hljs-string">'avg_request_latency_seconds'</span>, source=<span class="hljs-string">'metrics'</span>)
| extend <span class="hljs-attr">r</span> = series_decompose_anomalies(__value__) 
| extend <span class="hljs-attr">anomaly_b</span> =r.anomalies_score_series , anomaly_type = r.anomalies_type_series , __anomaly_msg__ = r.error_msg  
| extend <span class="hljs-attr">x</span> = zip(anomaly_b, __ts__, anomaly_type, __value__) 
| extend <span class="hljs-attr">__anomaly_rst__</span> = filter(x, x-&gt; x.field0 &gt; <span class="hljs-number">0</span>) 
| project __entity_id__, __labels__, __anomaly_rst__, __anomaly_msg__
</code></pre>
<p><strong>核心特点：</strong></p>
<ul>
<li>直接访问：直达 DataSet，无需查询实体元数据</li>
<li>语法简洁：类似 SQL 的 SPL 语法，易于理解</li>
<li>全量数据：返回 DataSet 中符合条件的所有数据</li>
</ul>
<p><strong>语法：</strong> <code>. with(domain, name, ...) | </code>，更多参数说明请参考文档：Phase 1 Table 模式 <strong>[</strong> <strong>1]</strong> 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fb93a3641544b08be21948d29c9578c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=gZd8RqKCeDb%2FNt%2FGSoQCXR4TpdE%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-22">Object 模式</h3>
<p>Object 模式（Phase 2）提供<strong>以实体为中心的面向对象查询能力</strong>，自动处理实体与数据的关联关系、字段映射、关系查询等复杂逻辑，适用于需要实体上下文的业务场景。</p>
<p>如：查询某个具体服务的指标、日志、链路数据，或查询与该服务有调用关系的其他服务，系统自动完成字段映射和数据过滤。</p>
<pre><code class="hljs language-java" lang="java"># 查询特定服务的请求延迟指标，自动处理字段映射和 FilterByEntity
.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>, ids=[<span class="hljs-string">'21d5ed421ae93973d67a04af551b48b8'</span>])</span> 
| entity-call <span class="hljs-title function_">get_metric</span><span class="hljs-params">(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>, <span class="hljs-string">'30s'</span>, <span class="hljs-literal">false</span>)</span>
| project __entity_id__, __ts__, __value__, __labels__
</code></pre>
<p><strong>核心优势：</strong></p>
<ul>
<li>零配置过滤：自动处理 FilterByEntity，无需手动拼接过滤条件</li>
<li>字段映射透明：自动转换 <code>service_id → acs_arms_service_id</code> 等映射</li>
<li>面向对象语义：<code>entity.get_metric()</code>，符合开发者思维习惯</li>
</ul>
<p><strong>语法：</strong> <code>.entity_set with(domain, name, id, query) | entity-call &lt;方法&gt;(&lt;参数&gt;) | </code>，更多参数说明请参考文档：Phase 2 Object 模式 <strong>[</strong> <strong>2]</strong> 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83198ad240004e66bbe5dddcf6e03773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=ArBD9CBq0HgBRZgKIUtM9dmwx%2Fw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-23">元数据查询方法</h3>
<p>元数据查询方法提供动态发现和反射能力，用于查询实体的关联关系、数据集配置、支持的方法等元数据信息，既可以帮助开发者理解实体能力，也是实现 AI Agent 自主决策和配置验证的关键基础。</p>
<p>如：查询某个服务实体支持哪些方法（<code>__list_method__()</code>）、关联了哪些数据集（<code>list_data_set()</code>）、与哪些其他服务有调用关系（<code>list_related_entity_set()</code>）、配置是否正确（<code>__inspect__()</code>）。</p>
<pre><code class="hljs language-xml" lang="xml"># 动态发现实体支持的所有方法（反射能力）
.entity_set with(domain='apm', name='apm.service') 
| entity-call __list_method__()
# 返回：方法列表及参数定义
# [
#   {<span class="hljs-symbol">&amp;#34;</span>name<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>get_metric<span class="hljs-symbol">&amp;#34;</span>, <span class="hljs-symbol">&amp;#34;</span>params<span class="hljs-symbol">&amp;#34;</span>: [...], <span class="hljs-symbol">&amp;#34;</span>description<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>获取指标数据<span class="hljs-symbol">&amp;#34;</span>},
#   {<span class="hljs-symbol">&amp;#34;</span>name<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>list_related_entity_set<span class="hljs-symbol">&amp;#34;</span>, <span class="hljs-symbol">&amp;#34;</span>params<span class="hljs-symbol">&amp;#34;</span>: [...], <span class="hljs-symbol">&amp;#34;</span>description<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>查询关联实体<span class="hljs-symbol">&amp;#34;</span>},
#   ...
# ]
</code></pre>
<p><strong>核心价值：</strong></p>
<ul>
<li>反射能力：<code>__list_method__()</code> 让 AI Agent 能自主探索实体的能力边界</li>
<li>配置验证：<code>__inspect__()</code> 一键检查 DataSet、Link、字段映射等配置完整性</li>
<li>关系查询：<code>list_related_entity_set()</code> 快速获取拓扑关系，无需查询图数据库</li>
<li>能力发现：<code>list_data_set()</code> 了解实体关联的所有观测数据类型</li>
</ul>
<p><strong>语法：</strong> <code>.entity_set with(domain, name, id, query) | entity-call &lt;方法&gt;(&lt;参数&gt;)</code>，更多参数说明请参考文档：Phase 2 Object 模式。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e000ccd7c30345298f37a3475cf305a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=WY4FkW9Q00FxIFvlgF0ighH8Wqo%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-24">查询方式</h2>
<h3 data-id="heading-25">UI 方式</h3>
<p>登录云监控 2.0 控制台，点击实体探索 -&gt; SPL，输入 SPL，如下图所示：</p>
<p><code>.entity\_set with(domain='apm', name='apm.service', ids=['21d5ed421ae93973d67a04af551b48b8']) | entity-call get_metric('apm', 'apm.metric.apm.service', 'avg_request_latency_seconds', 'range', '', false)</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1db886c117b54ac090901b7124d42dea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=2R8tjeHaOoyHZ6OwIY1UZ9sGH1k%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-26">DryRun 模式</h4>
<p>DryRun 模式返回对应的 Query，不执行当前 Query，也支持手动设置运行模式。</p>
<pre><code class="hljs language-sql" lang="sql"># 开启dry_run模式
.<span class="hljs-keyword">set</span> umodel_paas_mode<span class="hljs-operator">=</span><span class="hljs-string">'dry_run'</span>;
.entity_set <span class="hljs-keyword">with</span>(domain<span class="hljs-operator">=</span><span class="hljs-string">'apm'</span>, name<span class="hljs-operator">=</span><span class="hljs-string">'apm.service'</span>) 
<span class="hljs-operator">|</span> entity<span class="hljs-operator">-</span><span class="hljs-keyword">call</span> get_metric(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>, <span class="hljs-string">''</span>, <span class="hljs-literal">false</span>) 
</code></pre>
<p>UI 开启 DryRun 模式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51e1724052c64023baefe3b68d746726~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=7ALJIVlQpqUnJfgVAISCSI6bN2A%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-27">SDK 方式</h3>
<p>通过阿里云 OpenAPI <strong>[</strong> <strong>3]</strong> 下载 SDK，代码如下：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main
<span class="hljs-keyword">import</span> (
&amp;#<span class="hljs-number">34</span>;fmt&amp;#<span class="hljs-number">34</span>;
	cms20240330 &amp;#<span class="hljs-number">34</span>;github.com/alibabacloud-<span class="hljs-keyword">go</span>/cms<span class="hljs-number">-20240330</span>/v3/client&amp;#<span class="hljs-number">34</span>;
	openapi &amp;#<span class="hljs-number">34</span>;github.com/alibabacloud-<span class="hljs-keyword">go</span>/darabonba-openapi/v2/client&amp;#<span class="hljs-number">34</span>;
&amp;#<span class="hljs-number">34</span>;github.com/alibabacloud-<span class="hljs-keyword">go</span>/tea/tea&amp;#<span class="hljs-number">34</span>;
	credential &amp;#<span class="hljs-number">34</span>;github.com/aliyun/credentials-<span class="hljs-keyword">go</span>/credentials&amp;#<span class="hljs-number">34</span>;
&amp;#<span class="hljs-number">34</span>;os&amp;#<span class="hljs-number">34</span>;
)
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateClient</span><span class="hljs-params">()</span></span> (_result *cms20240330.Client, _err <span class="hljs-type">error</span>) {
	credential, _err := credential.NewCredential(<span class="hljs-literal">nil</span>)
<span class="hljs-keyword">if</span> _err != <span class="hljs-literal">nil</span> {
<span class="hljs-keyword">return</span> _result, _err
	}
	config := &amp;openapi.Config{
		Credential: credential,
	}
	config.Endpoint = tea.String(&amp;#<span class="hljs-number">34</span>;cms.cn-hangzhou.aliyuncs.com&amp;#<span class="hljs-number">34</span>;)
	_result = &amp;cms20240330.Client{}
	_result, _err = cms20240330.NewClient(config)
<span class="hljs-keyword">return</span> _result, _err
}
<span class="hljs-function"><span class="hljs-keyword">func</span> _<span class="hljs-title">main</span><span class="hljs-params">(args [ ]*<span class="hljs-type">string</span>)</span></span> (_err <span class="hljs-type">error</span>) {
	client, _err := CreateClient()
<span class="hljs-keyword">if</span> _err != <span class="hljs-literal">nil</span> {
<span class="hljs-keyword">return</span> _err
	}
	getEntityStoreDataRequest := &amp;cms20240330.GetEntityStoreDataRequest{
		Query: tea.String(&amp;#<span class="hljs-number">34</span>;.entity_set with(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>, ids=[<span class="hljs-string">'21d5ed421ae93973d67a04af551b48b8'</span>]) | entity-call get_metric(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>) &amp;#<span class="hljs-number">34</span>;),
		From:  tea.Int32(<span class="hljs-number">1762244123</span>),
		To:    tea.Int32(<span class="hljs-number">1762244724</span>),
	}
<span class="hljs-keyword">if</span> result, err := client.GetEntityStoreData(tea.String(&amp;#<span class="hljs-number">34</span>;o11y-demo-cn-hangzhou&amp;#<span class="hljs-number">34</span>;), getEntityStoreDataRequest); err != <span class="hljs-literal">nil</span> {
<span class="hljs-keyword">return</span> err
	} <span class="hljs-keyword">else</span> {
		fmt.Printf(&amp;#<span class="hljs-number">34</span>;length: %d&amp;#<span class="hljs-number">34</span>;, <span class="hljs-built_in">len</span>(result.Body.Data))
<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	}
}
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	err := _main(tea.StringSlice(os.Args[<span class="hljs-number">1</span>:]))
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
<span class="hljs-built_in">panic</span>(err)
	}
}
</code></pre>
<p>参数说明：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d51de5612664ed49b17fff454ce33d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=%2FqQie1WvvWGaJ9O91K%2BqXGA46VU%3D" alt="图片" loading="lazy"/></p>
<p><strong>程序运行</strong></p>
<pre><code class="hljs language-ini" lang="ini">go build -o demo .
export <span class="hljs-attr">ALIBABA_CLOUD_ACCESS_KEY_SECRET</span>=
export <span class="hljs-attr">ALIBABA_CLOUD_ACCESS_KEY_ID</span>=
./demo
</code></pre>
<h2 data-id="heading-28">示例</h2>
<h3 data-id="heading-29">集成算子实现高阶能力：UModel 高阶查询  + 时序异常检测算子</h3>
<p>通过 UModel 高阶 API 集成 SLS 时序异常检测算子 <code>series_decompose_anomalies</code>，一行查询实现智能异常检测。</p>
<p>如：监控某个 APM 服务的请求延迟，当出现异常（突刺、趋势变化、平台变化）时触发告警。</p>
<pre><code class="hljs language-java" lang="java">.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>, ids=[<span class="hljs-string">'21d5ed421ae93973d67a04af551b48b8'</span>])</span> 
| entity-call <span class="hljs-title function_">get_metric</span><span class="hljs-params">(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>, <span class="hljs-string">'30s'</span>, <span class="hljs-literal">false</span>)</span> 
| <span class="hljs-type">extend</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> series_decompose_anomalies(__value__) 
| <span class="hljs-type">extend</span> <span class="hljs-variable">anomaly_b</span> <span class="hljs-operator">=</span>r.anomalies_score_series , anomaly_type = r.anomalies_type_series , __anomaly_msg__ = r.error_msg  
| <span class="hljs-type">extend</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> zip(anomaly_b, __ts__, anomaly_type, __value__) 
| <span class="hljs-type">extend</span> <span class="hljs-variable">__anomaly_rst__</span> <span class="hljs-operator">=</span> filter(x, x-&gt; x.field0 &gt; <span class="hljs-number">0</span>) 
| project __entity_id__, __labels__, __anomaly_rst__, __anomaly_msg__
</code></pre>
<p><strong>返回结果</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2de178290ed4df987dfe6746a9d4f04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=D3i7AxES%2FMbVo8kVoKF%2FbaNWDWI%3D" alt="图片" loading="lazy"/></p>
<p><strong>支持的异常类型：</strong></p>
<ul>
<li><code>SPIKE_UP / SPIKE_DOWN</code> - 向上/向下突刺</li>
<li><code>TREND_SHIFT_UP</code> / <code>TREND_SHIFT_DOWN</code> - 趋势上升/下降</li>
<li><code>LEVEL_SHIFT_UP</code> / <code>LEVEL_SHIFT_DOWN</code> - 平台上升/下降</li>
</ul>
<p>如下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f1c630c37914bcd9eb048e611252e69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=kpBUiMYsKPfl9O%2FH%2B1HS9SHlL3I%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-30">数据互联互通：关联自定义 LogStore</h3>
<p>在实际生产环境中，业务数据往往分散在多个存储中。例如：</p>
<ul>
<li>UModel 中存储了 APM 服务的拓扑关系、指标、链路、日志</li>
<li>业务系统的自定义日志存储在独立的 LogStore 中（如订单日志、支付日志、用户行为日志）</li>
</ul>
<p>通过 UModel 高阶 API + SPL join 能力，可以<strong>打通 UModel 实体数据与自定义业务数据</strong>，实现：</p>
<ol>
<li><strong>统一视角分析：</strong> 将应用性能问题与业务日志关联分析</li>
<li><strong>快速定位问题：</strong> 从服务异常快速定位到具体业务操作</li>
<li><strong>端到端追踪：</strong> 从业务请求到技术指标的全链路分析</li>
</ol>
<p><strong>典型场景：</strong></p>
<ul>
<li>某个 APM 服务出现延迟异常 → 关联业务订单日志 → 定位到具体慢查询的订单 ID</li>
<li>某个服务的错误日志激增 → 关联用户行为日志 → 分析是哪些用户操作触发了异常</li>
<li>分析服务调用链路 → 关联业务流程日志 → 追踪完整的业务流转路径</li>
</ul>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet"># 场景：关联自定义的logstore日志信息
# SPL: 
# <span class="hljs-number">1</span>. 从业务LogStore中找到失败的traceId以及msg
.<span class="hljs-keyword">let</span> failed_log = .logstore <span class="hljs-keyword">with</span>(project=‘xxx’, logstore=‘xxxx’, query=‘*<span class="hljs-comment">') </span>
                     | project trace_id, msg;
# <span class="hljs-number">2</span>. 查询服务的Trace数据
.<span class="hljs-keyword">let</span> service_traces = .entity_set <span class="hljs-keyword">with</span>(domain=<span class="hljs-comment">'apm', name='apm.service', ids=['xxxx']) </span>
                       | entity-<span class="hljs-keyword">call</span> get_trace(‘apm‘, ’apm.trace.common’);
$failed_log | <span class="hljs-keyword">join</span> $service_traces <span class="hljs-keyword">on</span> trace_id = $service_traces.traceId |  project msg
</code></pre>
<h3 data-id="heading-31">集成 AI Agent：通过反射能力实现自主决策</h3>
<p>将 UModel PaaS API 封装为 MCP Tools <strong>[</strong> <strong>4]</strong> ，通过反射能力（<code>__list_method__()</code>）让 AI Agent 具备自主探索和决策能力，实现智能运维分析。</p>
<p>如：用户问“为什么服务响应慢？”，Agent 通过动态发现可用方法，自主完成根因分析。</p>
<pre><code class="hljs language-less" lang="less"># <span class="hljs-selector-tag">Agent</span> 首先调用 <span class="hljs-selector-tag">__list_method__</span>() 动态发现实体支持的方法
<span class="hljs-selector-class">.entity_set</span> <span class="hljs-selector-tag">with</span>(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>) 
| <span class="hljs-selector-tag">entity-call</span> <span class="hljs-selector-tag">__list_method__</span>()
# 返回示例（<span class="hljs-selector-tag">Agent</span> 根据返回的方法列表自主决策下一步操作）:
# {
#   <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">methods</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-attr">[#     {&amp;#34;name&amp;#34;: &amp;#34;get_metric&amp;#34;, &amp;#34;params&amp;#34;: [...]</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">description</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;获取指标数据<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;},
#     {<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">name</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">get_log</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">params</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-attr">[...]</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">description</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;获取日志数据<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;},
#     {<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">name</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">get_trace</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">params</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-attr">[...]</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">description</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;获取链路数据<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;},
#     {<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">name</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">list_related_entity_set</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">params</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-attr">[...]</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">description</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;查询关联实体<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;}
#   ]
# }
</code></pre>
<p>演示 Demo：</p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fggm8MhyGXlRjpXNwxBUmJg" target="_blank" title="https://mp.weixin.qq.com/s/ggm8MhyGXlRjpXNwxBUmJg" ref="nofollow noopener noreferrer">此处</a>，查看Demo演示！</p>
<p><strong>相关链接：</strong></p>
<p>[1] Phase 1 Table 模式</p>
<p>[2] Phase 2 Object 模式</p>
<p>[3] 阿里云 OpenAPI</p>
<p>[4] MCP Tools</p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1jS2VBJEzE%2F" target="_blank" title="https://www.bilibili.com/video/BV1jS2VBJEzE/" ref="nofollow noopener noreferrer">此处</a>，查看视频演示！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VSCode CMake Tools 功能解析、流程与最佳实践介绍]]></title>    <link>https://juejin.cn/post/7582438809377472554</link>    <guid>https://juejin.cn/post/7582438809377472554</guid>    <pubDate>2025-12-11T11:17:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582438809377472554" data-draft-id="7582397035942690822" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VSCode CMake Tools 功能解析、流程与最佳实践介绍"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-11T11:17:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VSCode CMake Tools 功能解析、流程与最佳实践介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T11:17:39.000Z" title="Thu Dec 11 2025 11:17:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>CMake Tools 是由 Microsoft 开发的 VS Code 扩展，其核心定位是作为 CMake 与 IDE 界面之间的桥梁，通过自动化传统命令行开发中的多步骤操作（如配置、生成、构建流程）来提升开发效率。该工具不仅提供基础的项目管理功能，还包含详细的文档支持（如 FAQ 指南）以帮助用户解决使用过程中的疑问。</p>
<p>从用户需求适配角度，CMake Tools 实现了对不同技术水平开发者的覆盖：对于新手，其提供快速入门引导简化上手流程；对于专业开发者，则支持高级配置以满足复杂项目需求。这种双重支持体系使其成为跨场景 CMake 项目开发的高效工具。</p>
<p>获取该工具的标准流程需通过 VS Code 扩展面板完成。在扩展市场搜索 "cmake" 时，需注意选择 Microsoft 官方发布的 "CMake Tools"（描述为 "Extended CMake support..."），点击界面中的 "Install" 按钮即可完成安装。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/456ffdb5fe4e4d38aab82f00ebd21360~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766056659&amp;x-signature=JZPy9i2ChGZ3MpfhzP9UUaW8RTk%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>核心价值总结：通过 IDE 集成实现 CMake 工作流自动化，消除命令行操作复杂性；兼顾新手友好性与专业扩展性；与 VS Code 生态深度融合，提供一致的开发体验。</p>
</blockquote>
<h2 data-id="heading-0">核心功能模块解析</h2>
<h3 data-id="heading-1">配置模块：智能缓存生成与命令行简化</h3>
<p>配置模块是 VS Code CMake Tools 的核心组件，其核心功能在于自动化 CMake 缓存生成逻辑。传统命令行模式下，开发者需手动执行 <code>cmake -S . -B build</code> 指定源代码目录（<code>-S</code>）和构建目录（<code>-B</code>），而工具通过图形化界面将这一过程简化为三个步骤：选择工具链（如 GCC、Clang 或 MSVC）、配置构建类型（<code>CMAKE_BUILD_TYPE</code>）、设置自定义参数。缓存生成过程中，工具会自动检测项目根目录下的 <code>CMakeLists.txt</code>，并根据用户配置生成 <code>CMakeCache.txt</code>，避免了命令行输入错误导致的配置失效问题。</p>
<p>关键配置参数对项目构建结果具有直接影响，例如：</p>
<ul>
<li><code>CMAKE_BUILD_TYPE</code>：控制编译优化级别与调试信息生成，取值范围包括 Debug（无优化，含调试符号）、Release（最高优化，无调试信息）、RelWithDebInfo（优化+调试符号）和 MinSizeRel（最小体积优化）。在开发阶段选择 Debug 可显著提升调试效率，而发布版本需切换至 Release 以获得最佳性能。</li>
<li><code>CMAKE_CXX_STANDARD</code>：指定 C++ 标准版本（如 11、14、17 或 20），工具会自动校验编译器兼容性并生成相应编译参数。</li>
</ul>
<h3 data-id="heading-2">构建模块：灵活目标管理与性能优化</h3>
<p>构建模块通过「多生成器支持」和「目标选择机制」提升开发效率。工具默认集成 Ninja、Makefiles、Visual Studio 等多种生成器，其中 Ninja 生成器凭借并行编译能力成为性能优化的关键——其基于依赖关系图的任务调度可充分利用多核 CPU，较传统 Make 构建速度提升 30%~50%。开发者可通过命令面板（<code>Ctrl+Shift+P</code>）执行 <code>CMake: Build</code> 并选择特定目标（如可执行文件、静态库或自定义目标），避免全项目重新编译。</p>
<p>性能优化实践：在大型项目中，建议：</p>
<ul>
<li>启用增量构建（默认开启），仅重新编译修改过的源文件；</li>
<li>配置 <code>CMAKE_CXX_FLAGS</code> 添加编译器特定优化（如 GCC 的 <code>-O3</code> 或 Clang 的 <code>-march=native</code>）；</li>
<li>使用 <code>ctest</code> 集成测试目标，通过 <code>CMake: Run Tests</code> 一键执行单元测试。</li>
</ul>
<h3 data-id="heading-3">调试模块：双模式适配与精准参数配置</h3>
<p>调试模块支持「启动调试（Launch）」和「附加调试（Attach）」两种模式，覆盖不同开发场景：</p>
<ul>
<li><strong>Launch 模式</strong>：适用于从零启动程序，需在 <code>launch.json</code> 中配置 <code>program</code>（可执行文件路径）和 <code>args</code>（命令行参数）。例如，调试路径为 <code>${workspaceFolder}/build/app</code> 的程序并传入 <code>--config debug</code> 参数，配置示例如下：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Launch App"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cppdbg"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"program"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${workspaceFolder}/build/app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"--config"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"debug"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"stopAtEntry"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"cwd"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${workspaceFolder}"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong>Attach 模式</strong>：用于调试已运行进程，需指定进程 ID（PID）或进程名称，适用于服务端程序或后台进程调试。</li>
</ul>
<p>工具通过「变量替换机制」（如 <code>${workspaceFolder}</code>、<code>${buildType}</code>）动态适配不同构建配置，确保调试器始终关联最新编译产物。同时，集成 GDB、LLDB 等调试器提供断点管理、变量监视和调用栈分析功能，实现代码编辑与调试的无缝衔接。</p>
<hr/>
<h2 data-id="heading-4">项目开发全流程实践</h2>
<p>VSCode CMake Tools 提供了从项目创建到路径配置的完整开发闭环，以下按「创建-配置-构建-调试-路径设置」流程详解实操步骤。</p>
<h3 data-id="heading-5">创建环节：项目初始化与模板选择</h3>
<p>通过命令面板（<code>Ctrl+Shift+P</code>）调用 <code>CMake: Quick Start</code> 命令启动项目向导，根据开发需求选择模板类型：</p>
<ul>
<li><strong>Executable</strong>：适用于构建可执行程序，自动生成包含 <code>main.cpp</code> 的基础工程结构</li>
<li><strong>Library</strong>：用于创建静态/动态库，生成包含头文件和实现文件的库项目框架</li>
</ul>
<p>向导完成后将自动生成初始 <code>CMakeLists.txt</code>，包含项目名称、版本号及语言标准等基础配置。</p>
<h3 data-id="heading-6">配置环节：缓存生成与问题排查</h3>
<p>配置过程是将 <code>CMakeLists.txt</code> 转换为构建系统文件的核心步骤，操作流程如下：</p>
<ol>
<li>打开命令面板（<code>Ctrl+Shift+P</code>）输入并执行 <code>CMake: Configure</code> 命令</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5633515f8d144d279ed5ddd390988b12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766056659&amp;x-signature=lXINON7vngQAYjR8Iny4cCOS89w%3D" alt="image.png" loading="lazy"/></p>
<ol start="2">
<li>首次配置需选择编译器（如 GCC、Clang 或 MSVC），后续配置将自动沿用</li>
<li>配置结果可通过 Output 面板（<code>Ctrl+Shift+U</code> 切换）的 CMake/Build 通道查看详细日志</li>
</ol>
<p>配置失败排查指南：</p>
<ul>
<li><strong>依赖缺失</strong>：日志中出现 "Could NOT find XXX" 提示时，需通过包管理器安装对应依赖</li>
<li><strong>语法错误</strong>：<code>CMakeLists.txt</code> 存在语法问题会导致 "Parse error"，可通过 VS Code 内置 CMake 语法高亮定位错误行</li>
<li><strong>路径问题</strong>：包含非 ASCII 字符或空格的项目路径可能引发配置异常，建议使用纯英文路径</li>
</ul>
<p>配置成功后将在 <code>build</code> 目录生成缓存文件（如 <code>CMakeCache.txt</code>），修改 <code>CMakeLists.txt</code> 后需重新执行配置命令更新缓存。</p>
<h3 data-id="heading-7">构建环节：编译优化与多配置管理</h3>
<p>构建操作通过命令面板（<code>Ctrl+Shift+P</code>）调用 <code>CMake: Build</code> 命令触发，关键配置包括：</p>
<ul>
<li><strong>并行任务数设置</strong>：建议配置为 CPU 核心数的 1.5 倍（通过 <code>CMake: Set Build Parallel Level</code> 命令调整），平衡编译速度与系统负载</li>
<li><strong>多配置生成器使用</strong>：对支持多配置的生成器（如 Visual Studio、Xcode），可通过状态栏的构建类型下拉菜单（默认为 Debug）快速切换 Debug/Release/RelWithDebInfo 模式，无需重复配置</li>
</ul>
<h3 data-id="heading-8">调试环节：两种调试模式对比</h3>























<table><thead><tr><th>调试方式</th><th>适用场景</th><th>配置复杂度</th><th>参数传递方式</th></tr></thead><tbody><tr><td>快速调试</td><td>临时调试验证</td><td>低</td><td>不支持自定义参数</td></tr><tr><td>launch.json 配置</td><td>复杂调试场景</td><td>高</td><td>通过 args 字段定义</td></tr></tbody></table>
<p>args 参数传递示例（<code>launch.json</code>）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"configurations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(gdb) Launch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cppdbg"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"program"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${command:cmake.launchTargetPath}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"--input"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"data.txt"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"--verbose"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"stopAtEntry"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"cwd"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${workspaceFolder}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"environment"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"externalConsole"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"MIMode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gdb"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-9">Include 路径设置：自动同步与手动补充</h3>
<p>头文件路径管理采用双重机制确保 IntelliSense 正常工作：</p>
<ul>
<li><strong>自动同步</strong>：CMake 配置过程中会生成 <code>compile_commands.json</code>（需在 <code>CMakeLists.txt</code> 中设置 <code>set(CMAKE_EXPORT_COMPILE_COMMANDS ON)</code>），VS Code 会自动解析该文件同步 include 路径</li>
<li><strong>手动补充</strong>：当自动同步不完整时，可通过 <code>.vscode/c_cpp_properties.json</code> 手动添加路径：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"configurations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Linux"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"includePath"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"${workspaceFolder}/**"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"/usr/local/include"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"${workspaceFolder}/third_party/include"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"defines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"compilerPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/usr/bin/gcc"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"cStandard"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"c17"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"cppStandard"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"c++20"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>路径优先级规则：手动配置的 <code>includePath</code> 优先级高于 <code>compile_commands.json</code> 中的路径，存在冲突时以手动配置为准</p>
</blockquote>
<hr/>
<h2 data-id="heading-10">高级特性与定制化方案</h2>
<p>VSCode CMake Tools 的高级特性体系围绕「标准化-精准控制-场景切换」构建，通过三大核心组件解决传统配置模式下的环境一致性、工具链适配与多场景切换难题。</p>
<h3 data-id="heading-11">CMake Presets：层级化配置实现团队协作标准化</h3>
<p>其核心包含：</p>
<ul>
<li><code>configurePresets</code>：定义基础构建环境（如 CMake 版本、生成器类型）</li>
<li><code>buildPresets</code>：继承配置并添加编译参数（如并行任务数）</li>
<li><code>testPresets</code>：专注测试执行策略（如测试超时设置）</li>
</ul>
<p>这种结构化配置可通过版本控制系统共享，确保团队成员使用统一的构建环境，有效消除「在我机器上能运行」的协作障碍。</p>
<h3 data-id="heading-12">工具链管理（Kits）：双轨制适配方案</h3>
<ul>
<li><strong>自动发现模式</strong>：适用于标准开发环境（如桌面端 GCC/Clang），VSCode 会扫描系统路径并识别已安装编译器</li>
<li><strong>手动定义模式</strong>：针对嵌入式开发等特殊场景，支持通过 JSON 配置文件指定交叉编译工具链。例如为 ARM 嵌入式项目配置工具链时，可在 <code>kits.json</code> 中明确定义编译器路径与目标架构：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ARM GCC Embedded"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"compilers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"C"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"arm-none-eabi-gcc"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"CXX"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"arm-none-eabi-g++"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"cmakeSettings"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"CMAKE_SYSTEM_NAME"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Generic"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"CMAKE_SYSTEM_PROCESSOR"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"arm"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-13">Variants：YAML 配置实现构建场景动态切换</h3>
<p>核心依赖「filters」和「settings」字段的协同工作。以 Debug/Release 变体为例：</p>
<ul>
<li><code>filters</code> 字段通过正则表达式匹配特定构建类型</li>
<li><code>settings</code> 字段则动态调整对应参数：Debug 变体启用 <code>-O0</code> 优化和 <code>-g</code> 调试符号，Release 变体则采用 <code>-O3</code> 优化并禁用调试信息</li>
</ul>
<p>这种机制支持跨平台开发场景，如 Windows 环境自动关联 MSVC 工具链并启用 <code>/MD</code> 运行时库，Linux 环境则切换至 GCC 并配置 <code>-fPIC</code> 位置无关代码选项，实现同一套代码库在不同操作系统间的无缝构建过渡。</p>
<blockquote>
<p>关键价值：三大特性形成互补闭环——CMake Presets 解决配置标准化问题，Kits 实现工具链精准控制，Variants 则提供场景动态适配能力。在跨平台开发中，可通过组合使用实现「一次配置，多环境构建」，显著提升多平台项目的开发效率。</p>
</blockquote>
<hr/>
<h2 data-id="heading-14">最佳实践与效率优化</h2>
<h3 data-id="heading-15">配置管理：精准控制项目构建环境</h3>
<p>CMake 配置过程中，普通 Configure 操作会基于缓存文件 incremental 更新构建系统，而 Clean Configure 则会完全清除缓存并重新生成所有配置数据。当项目中发生 <code>CMakeLists.txt</code> 结构变更（如新增子目录、修改依赖关系、变更编译器设置）时，必须执行 Clean Configure 以避免缓存污染导致的构建异常。在 VS Code 中，可通过命令面板（<code>Ctrl+Shift+P</code>）运行 <code>CMake: Delete Cache and Reconfigure</code> 实现这一操作，确保配置变更被正确应用。</p>
<h3 data-id="heading-16">构建加速：从编译到链接的全流程优化</h3>
<p>构建效率优化需从工具链选择和并行策略两方面着手。Ninja 生成器相比传统 Make 工具具有更高效的依赖解析能力和任务调度机制，在多文件项目中可减少 30%-50% 的构建时间。配置方法是在 CMake 配置时指定生成器类型，通过 <code>settings.json</code> 设置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"cmake.generator"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Ninja"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>对于 C/C++ 项目，集成 <code>ccache</code> 编译器缓存工具可大幅减少重复编译时间。在 <code>CMakeLists.txt</code> 中添加以下配置启用 ccache：</p>
<pre><code class="hljs language-cmake" lang="cmake">find_program(CCACHE_FOUND ccache)
if(CCACHE_FOUND)
  set(CMAKE_C_COMPILER_LAUNCHER ${CCACHE_FOUND})
  set(CMAKE_CXX_COMPILER_LAUNCHER ${CCACHE_FOUND})
endif(CCACHE_FOUND)
</code></pre>
<p>并行构建配置需同时优化 CMake 和生成器层面的任务数。在 <code>settings.json</code> 中设置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"cmake.parallelJobs"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// CMake 配置阶段并行任务数</span>
  <span class="hljs-attr">"cmake.buildArgs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"-j8"</span><span class="hljs-punctuation">]</span>  <span class="hljs-comment">// 传递给 Ninja/Make 的并行构建参数</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>建议根据 CPU 核心数设置并行任务数（通常为核心数的 1-1.5 倍），避免过度并行导致的资源竞争。</p>
<h3 data-id="heading-17">调试验证：确保调试环境与构建目标一致性</h3>
<p>调试配置失败的常见原因为调试程序路径与 CMake 目标输出路径不匹配。验证方法：首先通过 <code>CMake: Build Target</code> 确认目标已成功构建，然后在 <code>launch.json</code> 中检查 <code>"program"</code> 字段是否指向正确的可执行文件路径。对于多配置项目（如 Windows 下的 Debug/Release），需使用变量引用确保路径动态适配：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"configurations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(gdb) Launch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cppdbg"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"program"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${command:cmake.launchTargetPath}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"stopAtEntry"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"cwd"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${workspaceFolder}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"environment"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"externalConsole"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"MIMode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gdb"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"setupCommands"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Enable pretty-printing for gdb"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"-enable-pretty-printing"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"ignoreFailures"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>其中 <code>${command:cmake.launchTargetPath}</code> 变量会自动解析当前激活目标的输出路径，避免手动维护路径的繁琐和错误。</p>
<h3 data-id="heading-18">IntelliSense 同步：保持代码分析与项目配置一致</h3>
<p>当 CMake 配置变更后（如新增头文件路径、修改宏定义），IntelliSense 可能因缓存未更新导致代码分析异常。手动同步方法：打开命令面板（<code>Ctrl+Shift+P</code>），运行 <code>CMake: Refresh IntelliSense</code> 命令，VS Code 会重新生成 <code>compile_commands.json</code> 并更新 C/C++ 扩展的配置。对于大型项目，可在 <code>settings.json</code> 中启用自动同步：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"cmake.autoRefreshIntelliSense"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-19">跨平台开发：实现多环境一致构建体验</h3>
<p>跨平台项目需通过「工具链文件」统一管理编译器特性、系统库路径等平台相关配置。在项目根目录创建 <code>toolchains</code> 文件夹，为不同平台编写专用工具链文件（如 <code>toolchains/linux-gcc.cmake</code>、<code>toolchains/windows-msvc.cmake</code>），然后在配置时通过命令指定：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"cmake.configureArgs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"-DCMAKE_TOOLCHAIN_FILE=toolchains/linux-gcc.cmake"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>同时，利用 VS Code 的「工作区信任机制」保护项目安全。首次打开项目时，在弹出的「工作区信任」对话框中选择「信任文件夹并启用所有功能」，确保 CMake Tools 能正常访问项目文件和执行构建命令。对于多人协作项目，可通过 <code>settings.json</code> 共享信任配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"security.workspace.trust.untrustedFiles"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"open"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>关键提示：跨平台开发中，避免在 <code>CMakeLists.txt</code> 中硬编码平台相关路径（如 <code>/usr/local/lib</code>），应使用 CMake 内置变量（如 <code>${CMAKE_INSTALL_LIBDIR}</code>）和工具链文件抽象平台差异，确保构建脚本的可移植性。</p>
</blockquote>
<hr/>
<h2 data-id="heading-20">常见问题与解决方案</h2>
<h3 data-id="heading-21">IntelliSense 异常</h3>
<ul>
<li><strong>问题现象</strong>：代码补全失效、语法高亮异常或头文件引用报错。</li>
<li><strong>根本原因</strong>：CMake 配置解析错误或构建缓存过时，导致 IntelliSense 无法正确识别项目结构。</li>
<li><strong>解决步骤</strong>：
<ol>
<li>查看 Output 日志：打开 VS Code 底部状态栏的 Output 面板，切换至 CMake/Build 频道，检查是否存在 <code>CMakeLists.txt</code> 语法错误或依赖缺失提示。</li>
<li>验证项目配置：在 CMAKE: PROJECT OUTLINE 树状视图中，确认源文件与 <code>CMakeLists.txt</code> 的关联是否正确，确保 <code>add_executable</code> 或 <code>target_link_libraries</code> 等指令配置无误。</li>
<li>重建缓存：按下 <code>Ctrl+Shift+P</code> 调出命令面板，执行 <code>CMake: Rebuild CMake Cache</code> 命令刷新配置。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-22">调试配置无效</h3>
<ul>
<li><strong>问题现象</strong>：启动调试后无反应或提示「程序路径不存在」。</li>
<li><strong>根本原因</strong>：<code>launch.json</code> 中 <code>program</code> 路径未正确关联构建产物，或缺少前置构建任务。</li>
<li><strong>解决步骤</strong>：
<ol>
<li>配置 <code>program</code> 路径：在 <code>launch.json</code> 中使用变量 <code>${command:cmake.launchTargetPath}</code> 自动定位当前激活目标的可执行文件路径，避免硬编码绝对路径。</li>
<li>设置 <code>preLaunchTask</code>：添加 <code>"preLaunchTask": "CMake: build"</code> 确保调试前自动构建项目，防止因产物缺失导致启动失败。</li>
<li>验证断点位置：确保断点位于可执行代码行（如 main 函数内），而非注释或空行。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-23">Include 路径错误</h3>
<ul>
<li><strong>问题现象</strong>：编译器提示 <code>fatal error: 'xxx.h' file not found</code>。</li>
<li><strong>根本原因</strong>：头文件搜索路径未被正确添加至 IntelliSense 配置。</li>
<li><strong>解决步骤</strong>：
<ul>
<li><strong>UI 配置法</strong>：打开命令面板，执行 <code>C/C++: Edit Configurations (UI)</code>，在 Include path 中添加头文件所在目录（如 <code>${workspaceFolder}/include</code>）。</li>
<li><strong>手动编辑法</strong>：直接修改 <code>.vscode/c_cpp_properties.json</code>，在 <code>configurations[0].includePath</code> 数组中添加路径，并设置 <code>"compilerPath"</code> 为实际使用的编译器路径（如 <code>C:/MinGW/bin/gcc.exe</code>）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-24">工具状态异常</h3>
<ul>
<li><strong>问题现象</strong>：CMake 扩展无响应或命令面板中 CMake 相关命令缺失。</li>
<li><strong>根本原因</strong>：扩展缓存损坏或安装文件完整性问题。</li>
<li><strong>解决步骤</strong>：
<ol>
<li>清理缓存：执行命令 <code>CMake: Clear CMake Cache</code> 清除构建缓存，路径通常为 <code>${workspaceFolder}/build/CMakeCache.txt</code>。</li>
<li>重装扩展：在 VS Code 扩展面板中卸载 CMake Tools，重启软件后重新安装最新版本，并确保依赖的 C/C++ Extension Pack 已同步更新。</li>
</ol>
</li>
</ul>
<blockquote>
<p>排查原则：所有问题均需优先检查 Output 日志与项目配置文件，避免盲目操作。对于路径相关错误，建议使用 <code>${workspaceFolder}</code> 等变量确保跨环境兼容性。</p>
</blockquote>
<hr/>
<h2 data-id="heading-25">总结与未来展望</h2>
<p>VSCode CMake Tools 作为连接 CMake 与 VS Code 生态的关键桥梁，通过配置管理、构建执行、调试集成等核心功能模块，有效简化了 C++ 项目的开发流程。其高级特性如 CMake Presets、Kits 和 Variants 支持高度定制化的开发需求，配合最佳实践与问题解决方案，进一步提升了开发效率与项目稳定性。</p>
<h3 data-id="heading-26">未来发展方向</h3>
<ul>
<li>跨平台扩展：增强 WebAssembly 等新兴平台支持</li>
<li>团队协作优化：开发配置共享与同步机制</li>
<li>智能辅助：引入 AI 驱动的 CMake 预设生成功能</li>
</ul>
<p>随着 CMake 标准的持续迭代和社区贡献的深入，VSCode CMake Tools 将继续深化其作为 C++ 开发基础设施的价值，为开发者提供更智能、更高效的集成开发体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kingfisher 深度指南：Swift 生态下的高性能图片处理艺术]]></title>    <link>https://juejin.cn/post/7582401182934810639</link>    <guid>https://juejin.cn/post/7582401182934810639</guid>    <pubDate>2025-12-11T15:22:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582401182934810639" data-draft-id="7582401182934794255" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kingfisher 深度指南：Swift 生态下的高性能图片处理艺术"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-11T15:22:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sweet丶"/> <meta itemprop="url" content="https://juejin.cn/user/3227821869921646"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kingfisher 深度指南：Swift 生态下的高性能图片处理艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821869921646/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sweet丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T15:22:21.000Z" title="Thu Dec 11 2025 15:22:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：为什么需要专门的图片加载库？</h2>
<p>在移动应用开发中，图片加载是影响用户体验的核心环节之一。一个优秀的图片加载库需要解决多个复杂问题：异步下载、内存缓存、磁盘缓存、图片解码、动画支持、列表优化等。在 Swift 生态中，Kingfisher 凭借其现代化的设计理念和卓越的性能表现，成为了 iOS/macOS 开发者的首选。</p>
<h2 data-id="heading-1">一、Kingfisher 架构设计：模块化的艺术</h2>
<h3 data-id="heading-2">核心架构分层</h3>
<p>Kingfisher 采用了清晰的分层架构设计，每个模块都有明确的职责：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────┐
│               使用层 (Usage Layer)           │
│  • UIImageView/NSImageView 扩展              │
│  • SwiftUI 的 KFImage                        │
│  • 丰富的选项配置系统                         │
└─────────────────────────────────────────────┘
                     │
┌─────────────────────────────────────────────┐
│             管理层 (Manager Layer)            │
│  • KingfisherManager：全局协调者              │
│  • ImageDownloader：下载管理                  │
│  • ImageCache：缓存管理                       │
└─────────────────────────────────────────────┘
                     │
┌─────────────────────────────────────────────┐
│             处理器层 (Processor Layer)        │
│  • ImageProcessor：图片处理流水线              │
│  • ImageModifier：图片修饰器                   │
│  • FormatIndicatedCacheSerializer：序列化器   │
└─────────────────────────────────────────────┘
                     │
┌─────────────────────────────────────────────┐
│             基础层 (Foundation Layer)         │
│  • 线程安全的数据结构                         │
│  • 高效的缓存算法实现                         │
│  • 低级别的图片解码操作                       │
└─────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-3">线程安全设计</h3>
<p>Kingfisher 在多线程设计上表现卓越：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// Kingfisher 内部使用 DispatchQueue 和锁保证线程安全</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeContainer</span>&lt;<span class="hljs-title class_">T</span>&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> storage: <span class="hljs-type">T</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> lock: <span class="hljs-type">DispatchQueue</span>
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">asyncExecute</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">block</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-keyword">inout</span> <span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Void</span>) {
        lock.async { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">self</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
            block(<span class="hljs-operator">&amp;</span><span class="hljs-keyword">self</span>.storage)
        }
    }
}
</code></pre>
<h2 data-id="heading-4">二、图片加载全流程深度解析</h2>
<h3 data-id="heading-5">2.1 加载流程详解</h3>
<p>Kingfisher 的图片加载遵循一个精心设计的流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant UI as UIImageView
    participant KM as KingfisherManager
    participant MC as MemoryCache
    participant DC as DiskCache
    participant DN as Downloader
    participant IP as ImageProcessor
    
    UI-&gt;&gt;KM: kf.setImage(with: url)
    KM-&gt;&gt;MC: 查询内存缓存
    alt 内存命中
        MC--&gt;&gt;KM: 返回缓存的ImageData
        KM--&gt;&gt;UI: 直接显示图片
    else 内存未命中
        KM-&gt;&gt;DC: 查询磁盘缓存
        alt 磁盘命中
            DC--&gt;&gt;KM: 返回磁盘数据
            KM-&gt;&gt;IP: 解码和处理图片
            IP--&gt;&gt;KM: 处理后的图片
            KM-&gt;&gt;MC: 存入内存缓存
            KM--&gt;&gt;UI: 显示图片
        else 磁盘未命中
            KM-&gt;&gt;DN: 发起网络请求
            DN--&gt;&gt;KM: 下载图片数据
            KM-&gt;&gt;IP: 解码和处理图片
            IP--&gt;&gt;KM: 处理后的图片
            KM-&gt;&gt;DC: 存入磁盘缓存
            KM-&gt;&gt;MC: 存入内存缓存
            KM--&gt;&gt;UI: 显示图片
        end
    end
</code></pre>
<h3 data-id="heading-6">2.2 渐进式下载优化</h3>
<p>Kingfisher 支持渐进式 JPEG 下载，提供流畅的用户体验：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> options: <span class="hljs-type">KingfisherOptionsInfo</span> <span class="hljs-operator">=</span> [
    .progressiveJPEG(<span class="hljs-type">ImageProgressive</span>(
        isBlur: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// 是否启用模糊效果</span>
        isFastestScan: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否使用最快扫描</span>
        scanInterval: <span class="hljs-number">0.1</span>   <span class="hljs-comment">// 扫描间隔</span>
    ))
]

imageView.kf.setImage(with: url, options: options)
</code></pre>
<h2 data-id="heading-7">三、缓存机制的卓越实现</h2>
<h3 data-id="heading-8">3.1 三级缓存策略</h3>
<p>Kingfisher 实现了高效的三级缓存策略：</p>
<ol>
<li><strong>处理器缓存（Processed Cache）</strong>：存储处理后的图片</li>
<li><strong>原始数据缓存（Original Cache）</strong>：存储原始下载数据</li>
<li><strong>内存缓存（Memory Cache）</strong>：使用 NSCache 实现</li>
</ol>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 自定义缓存配置示例</span>
<span class="hljs-keyword">let</span> cache <span class="hljs-operator">=</span> <span class="hljs-type">ImageCache</span>(name: <span class="hljs-string">"my_cache"</span>)

<span class="hljs-comment">// 配置内存缓存</span>
cache.memoryStorage.config.totalCostLimit <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> <span class="hljs-operator">*</span> <span class="hljs-number">1024</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span>  <span class="hljs-comment">// 100MB</span>
cache.memoryStorage.config.countLimit <span class="hljs-operator">=</span> <span class="hljs-number">100</span>
cache.memoryStorage.config.expiration <span class="hljs-operator">=</span> .seconds(<span class="hljs-number">600</span>)  <span class="hljs-comment">// 10分钟</span>

<span class="hljs-comment">// 配置磁盘缓存</span>
cache.diskStorage.config.sizeLimit <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> <span class="hljs-operator">*</span> <span class="hljs-number">1024</span> <span class="hljs-operator">*</span> <span class="hljs-number">500</span>  <span class="hljs-comment">// 500MB</span>
cache.diskStorage.config.expiration <span class="hljs-operator">=</span> .days(<span class="hljs-number">7</span>)  <span class="hljs-comment">// 7天</span>

<span class="hljs-comment">// 使用自定义缓存</span>
<span class="hljs-type">KingfisherManager</span>.shared.defaultOptions <span class="hljs-operator">=</span> [.targetCache(cache)]
</code></pre>
<h3 data-id="heading-9">3.2 智能缓存键生成</h3>
<p>Kingfisher 的缓存键生成策略非常智能：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 默认缓存键是 URL 的绝对字符串</span>
<span class="hljs-keyword">let</span> defaultCacheKey <span class="hljs-operator">=</span> url.cacheKey

<span class="hljs-comment">// 可以添加处理器标识</span>
<span class="hljs-keyword">let</span> processor <span class="hljs-operator">=</span> <span class="hljs-type">RoundCornerImageProcessor</span>(cornerRadius: <span class="hljs-number">20</span>)
<span class="hljs-keyword">let</span> processedCacheKey <span class="hljs-operator">=</span> url.cacheKey <span class="hljs-operator">+</span> processor.identifier

<span class="hljs-comment">// 自定义缓存键</span>
imageView.kf.setImage(
    with: url,
    options: [.cacheOriginalImage],
    completionHandler: { result <span class="hljs-keyword">in</span>
        <span class="hljs-comment">// 获取缓存键</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">case</span> .success(<span class="hljs-keyword">let</span> value) <span class="hljs-operator">=</span> result {
            <span class="hljs-keyword">let</span> cacheKey <span class="hljs-operator">=</span> value.cacheKey
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"缓存键: <span class="hljs-subst">\(cacheKey)</span>"</span>)
        }
    }
)
</code></pre>
<h2 data-id="heading-10">四、高级图片处理功能</h2>
<h3 data-id="heading-11">4.1 图片处理器链</h3>
<p>Kingfisher 支持处理器链，可以按顺序应用多个处理器：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> processor <span class="hljs-operator">=</span> <span class="hljs-type">DownsamplingImageProcessor</span>(size: <span class="hljs-type">CGSize</span>(width: <span class="hljs-number">300</span>, height: <span class="hljs-number">300</span>))
<span class="hljs-operator">|&gt;</span> <span class="hljs-type">RoundCornerImageProcessor</span>(cornerRadius: <span class="hljs-number">20</span>)
<span class="hljs-operator">|&gt;</span> <span class="hljs-type">BlurImageProcessor</span>(blurRadius: <span class="hljs-number">5</span>)
<span class="hljs-operator">|&gt;</span> <span class="hljs-type">TintImageProcessor</span>(tint: .red.withAlphaComponent(<span class="hljs-number">0.3</span>))

imageView.kf.setImage(
    with: url,
    options: [.processor(processor)]
)
</code></pre>
<h3 data-id="heading-12">4.2 自定义图片处理器</h3>
<p>创建自定义处理器非常灵活：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">WatermarkProcessor</span>: <span class="hljs-title class_">ImageProcessor</span> {
    <span class="hljs-keyword">let</span> identifier: <span class="hljs-type">String</span>
    <span class="hljs-keyword">let</span> watermark: <span class="hljs-type">UIImage</span>
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">watermark</span>: <span class="hljs-type">UIImage</span>) {
        <span class="hljs-keyword">self</span>.watermark <span class="hljs-operator">=</span> watermark
        <span class="hljs-keyword">self</span>.identifier <span class="hljs-operator">=</span> <span class="hljs-string">"com.myapp.watermark"</span>
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">process</span>(<span class="hljs-params">item</span>: <span class="hljs-type">ImageProcessItem</span>, <span class="hljs-params">options</span>: <span class="hljs-type">KingfisherParsedOptionsInfo</span>) -&gt; <span class="hljs-type">KFCrossPlatformImage</span>? {
        <span class="hljs-keyword">switch</span> item {
        <span class="hljs-keyword">case</span> .image(<span class="hljs-keyword">let</span> image):
            <span class="hljs-keyword">return</span> drawWatermark(on: image)
        <span class="hljs-keyword">case</span> .data:
            <span class="hljs-comment">// 如果是数据，先解码再处理</span>
            <span class="hljs-keyword">return</span> (<span class="hljs-type">DefaultImageProcessor</span>.default <span class="hljs-operator">|&gt;</span> <span class="hljs-keyword">self</span>).process(item: item, options: options)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">drawWatermark</span>(<span class="hljs-params">on</span> <span class="hljs-params">image</span>: <span class="hljs-type">KFCrossPlatformImage</span>) -&gt; <span class="hljs-type">KFCrossPlatformImage</span> {
        <span class="hljs-comment">// 绘制水印的实现</span>
        <span class="hljs-keyword">return</span> image
    }
}
</code></pre>
<h2 data-id="heading-13">五、SwiftUI 深度集成</h2>
<h3 data-id="heading-14">5.1 KFImage 的高级用法</h3>
<p>Kingfisher 为 SwiftUI 提供了原生的 KFImage 组件：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">AdvancedImageView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">let</span> url: <span class="hljs-type">URL</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">KFImage</span>(url)
            .setProcessor(
                <span class="hljs-type">DownsamplingImageProcessor</span>(size: <span class="hljs-type">CGSize</span>(width: <span class="hljs-number">200</span>, height: <span class="hljs-number">200</span>))
                <span class="hljs-operator">|&gt;</span> <span class="hljs-type">RoundCornerImageProcessor</span>(cornerRadius: <span class="hljs-number">10</span>)
            )
            .loadDiskFileSynchronously()  <span class="hljs-comment">// 同步加载磁盘缓存</span>
            .cacheMemoryOnly()  <span class="hljs-comment">// 仅缓存到内存</span>
            .fade(duration: <span class="hljs-number">0.25</span>)  <span class="hljs-comment">// 渐变动画</span>
            .onSuccess { result <span class="hljs-keyword">in</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"图片加载成功: <span class="hljs-subst">\(result.cacheType)</span>"</span>)
            }
            .onFailure { error <span class="hljs-keyword">in</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"图片加载失败: <span class="hljs-subst">\(error)</span>"</span>)
            }
            .placeholder { progress <span class="hljs-keyword">in</span>
                <span class="hljs-comment">// 自定义占位符，支持进度显示</span>
                <span class="hljs-type">ProgressView</span>(value: progress.fractionCompleted)
                    .progressViewStyle(<span class="hljs-type">CircularProgressViewStyle</span>())
            }
            .resizable()
            .aspectRatio(contentMode: .fit)
            .frame(width: <span class="hljs-number">200</span>, height: <span class="hljs-number">200</span>)
    }
}
</code></pre>
<h3 data-id="heading-15">5.2 动画与过渡效果</h3>
<p>Kingfisher 支持丰富的动画效果：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 配置全局动画选项</span>
<span class="hljs-type">KingfisherManager</span>.shared.defaultOptions <span class="hljs-operator">=</span> [
    .transition(.fade(<span class="hljs-number">0.3</span>)),  <span class="hljs-comment">// 300ms 淡入效果</span>
    .forceTransition  <span class="hljs-comment">// 即使从缓存加载也使用过渡效果</span>
]

<span class="hljs-comment">// 单个请求的特殊配置</span>
imageView.kf.setImage(
    with: url,
    options: [
        .transition(.flipFromLeft(<span class="hljs-number">0.5</span>)),
        .forceTransition
    ]
)
</code></pre>
<h2 data-id="heading-16">六、性能优化最佳实践</h2>
<h3 data-id="heading-17">6.1 列表性能优化</h3>
<p>在 UITableView 或 UICollectionView 中使用 Kingfisher 时，需要特别注意性能：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomTableViewCell</span>: <span class="hljs-title class_">UITableViewCell</span> {
    <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> customImageView: <span class="hljs-type">UIImageView</span>!
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">prepareForReuse</span>() {
        <span class="hljs-keyword">super</span>.prepareForReuse()
        <span class="hljs-comment">// 取消未完成的下载任务</span>
        customImageView.kf.cancelDownloadTask()
        <span class="hljs-comment">// 可选：设置占位图</span>
        customImageView.image <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">configure</span>(<span class="hljs-params">with</span> <span class="hljs-params">url</span>: <span class="hljs-type">URL</span>) {
        <span class="hljs-keyword">let</span> options: <span class="hljs-type">KingfisherOptionsInfo</span> <span class="hljs-operator">=</span> [
            .transition(.fade(<span class="hljs-number">0.2</span>)),
            .cacheOriginalImage,  <span class="hljs-comment">// 缓存原始图片</span>
            .backgroundDecode,    <span class="hljs-comment">// 后台解码</span>
            .scaleFactor(<span class="hljs-type">UIScreen</span>.main.scale),  <span class="hljs-comment">// 适配屏幕缩放</span>
            .keepCurrentImageWhileLoading  <span class="hljs-comment">// 加载时保持当前图片</span>
        ]
        
        customImageView.kf.setImage(
            with: url,
            placeholder: <span class="hljs-type">UIImage</span>(named: <span class="hljs-string">"placeholder"</span>),
            options: options
        )
    }
}

<span class="hljs-comment">// 在 tableView 中使用预加载</span>
<span class="hljs-keyword">let</span> prefetcher <span class="hljs-operator">=</span> <span class="hljs-type">ImagePrefetcher</span>(urls: imageURLs)
prefetcher.start()

<span class="hljs-comment">// 预加载单个图片</span>
<span class="hljs-type">ImagePrefetcher</span>(urls: [url]).start()
</code></pre>
<h3 data-id="heading-18">6.2 内存管理策略</h3>
<p>Kingfisher 提供了精细的内存控制：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 监听内存警告</span>
<span class="hljs-type">NotificationCenter</span>.default.addObserver(
    forName: <span class="hljs-type">UIApplication</span>.didReceiveMemoryWarningNotification,
    object: <span class="hljs-literal">nil</span>,
    queue: .main
) { <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span>
    <span class="hljs-comment">// 清除内存缓存</span>
    <span class="hljs-type">ImageCache</span>.default.clearMemoryCache()
    
    <span class="hljs-comment">// 或者只清除过期的缓存</span>
    <span class="hljs-type">ImageCache</span>.default.cleanExpiredMemoryCache()
}

<span class="hljs-comment">// 配置内存缓存行为</span>
<span class="hljs-type">ImageCache</span>.default.memoryStorage.config.cleanInterval <span class="hljs-operator">=</span> <span class="hljs-number">60</span>  <span class="hljs-comment">// 每60秒清理一次</span>
</code></pre>
<h3 data-id="heading-19">6.3 下载优先级控制</h3>
<p>在复杂场景中，可以控制下载优先级：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 设置下载优先级</span>
<span class="hljs-keyword">let</span> highPriorityOptions: <span class="hljs-type">KingfisherOptionsInfo</span> <span class="hljs-operator">=</span> [
    .downloadPriority(<span class="hljs-type">URLSessionTask</span>.highPriority)
]

<span class="hljs-keyword">let</span> lowPriorityOptions: <span class="hljs-type">KingfisherOptionsInfo</span> <span class="hljs-operator">=</span> [
    .downloadPriority(<span class="hljs-type">URLSessionTask</span>.lowPriority)
]

<span class="hljs-comment">// 关键图片使用高优先级</span>
importantImageView.kf.setImage(with: importantURL, options: highPriorityOptions)

<span class="hljs-comment">// 非关键图片使用低优先级</span>
thumbnailImageView.kf.setImage(with: thumbnailURL, options: lowPriorityOptions)
</code></pre>
<h2 data-id="heading-20">七、监控与调试</h2>
<h3 data-id="heading-21">7.1 性能监控</h3>
<p>Kingfisher 提供了丰富的监控点：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 启用调试日志</span>
<span class="hljs-type">Logging</span>.downloader <span class="hljs-operator">=</span> .debug

<span class="hljs-comment">// 自定义监控</span>
<span class="hljs-type">ImageDownloader</span>.default.delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">YourClass</span>: <span class="hljs-title class_">ImageDownloaderDelegate</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">imageDownloader</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">downloader</span>: <span class="hljs-type">ImageDownloader</span>, <span class="hljs-params">willDownloadImageForURL</span> <span class="hljs-params">url</span>: <span class="hljs-type">URL</span>, <span class="hljs-params">with</span> <span class="hljs-params">request</span>: <span class="hljs-type">URLRequest</span>?) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"即将下载: <span class="hljs-subst">\(url)</span>"</span>)
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">imageDownloader</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">downloader</span>: <span class="hljs-type">ImageDownloader</span>, <span class="hljs-params">didFinishDownloadingImageForURL</span> <span class="hljs-params">url</span>: <span class="hljs-type">URL</span>, <span class="hljs-params">with</span> <span class="hljs-params">response</span>: <span class="hljs-type">URLResponse</span>?, <span class="hljs-params">error</span>: <span class="hljs-type">Error</span>?) {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> error <span class="hljs-operator">=</span> error {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"下载失败: <span class="hljs-subst">\(error)</span>"</span>)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"下载成功: <span class="hljs-subst">\(url)</span>"</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-22">7.2 缓存状态检查</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 检查缓存状态</span>
<span class="hljs-keyword">let</span> cache <span class="hljs-operator">=</span> <span class="hljs-type">ImageCache</span>.default

<span class="hljs-comment">// 检查是否有缓存</span>
cache.isCached(forKey: <span class="hljs-string">"cache_key"</span>) { result <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">switch</span> result {
    <span class="hljs-keyword">case</span> .memory:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"存在内存缓存"</span>)
    <span class="hljs-keyword">case</span> .disk:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"存在磁盘缓存"</span>)
    <span class="hljs-keyword">case</span> .none:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"无缓存"</span>)
    }
}

<span class="hljs-comment">// 获取缓存大小</span>
cache.calculateDiskStorageSize { result <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">switch</span> result {
    <span class="hljs-keyword">case</span> .success(<span class="hljs-keyword">let</span> size):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"磁盘缓存大小: <span class="hljs-subst">\(Double(size) <span class="hljs-operator">/</span> <span class="hljs-number">1024</span> <span class="hljs-operator">/</span> <span class="hljs-number">1024</span>)</span> MB"</span>)
    <span class="hljs-keyword">case</span> .failure(<span class="hljs-keyword">let</span> error):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"计算缓存大小失败: <span class="hljs-subst">\(error)</span>"</span>)
    }
}
</code></pre>
<h2 data-id="heading-23">八、高级场景解决方案</h2>
<h3 data-id="heading-24">8.1 动图（GIF）支持</h3>
<p>Kingfisher 对动图提供了完整的支持：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 加载并播放 GIF</span>
imageView.kf.setImage(
    with: gifURL,
    options: [
        .processor(<span class="hljs-type">DefaultImageProcessor</span>.default),  <span class="hljs-comment">// 默认处理器支持 GIF</span>
        .cacheSerializer(<span class="hljs-type">FormatIndicatedCacheSerializer</span>.gif)  <span class="hljs-comment">// 指定 GIF 序列化器</span>
    ]
)

<span class="hljs-comment">// 控制 GIF 播放</span>
imageView.kf.setImage(with: gifURL) { result <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">case</span> .success(<span class="hljs-keyword">let</span> value) <span class="hljs-operator">=</span> result {
        <span class="hljs-comment">// 手动控制动画</span>
        value.image.kf.startAnimating()
        
        <span class="hljs-comment">// 或者停止动画</span>
        value.image.kf.stopAnimating()
    }
}

<span class="hljs-comment">// 限制 GIF 内存使用</span>
<span class="hljs-keyword">let</span> options: <span class="hljs-type">KingfisherOptionsInfo</span> <span class="hljs-operator">=</span> [
    .onlyLoadFirstFrame,  <span class="hljs-comment">// 只加载第一帧，减少内存占用</span>
    .preloadAllAnimationData  <span class="hljs-comment">// 预加载所有动画数据</span>
]
</code></pre>
<h3 data-id="heading-25">8.2 图片编辑与处理</h3>
<p>Kingfisher 支持图片的实时编辑：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 创建可编辑的图片视图</span>
<span class="hljs-keyword">let</span> imageEditor <span class="hljs-operator">=</span> <span class="hljs-type">ImageEditorView</span>()

<span class="hljs-comment">// 应用多个编辑操作</span>
imageEditor.applyFilter(.blur(radius: <span class="hljs-number">2</span>))
imageEditor.applyFilter(.contrast(<span class="hljs-number">1.2</span>))
imageEditor.applyFilter(.saturation(<span class="hljs-number">0.8</span>))

<span class="hljs-comment">// 获取编辑后的图片</span>
<span class="hljs-keyword">let</span> editedImage <span class="hljs-operator">=</span> imageEditor.outputImage

<span class="hljs-comment">// 保存编辑结果到缓存</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> editedImage <span class="hljs-operator">=</span> editedImage,
   <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> originalURL {
    <span class="hljs-type">ImageCache</span>.default.store(editedImage, forKey: url.cacheKey <span class="hljs-operator">+</span> <span class="hljs-string">"_edited"</span>)
}
</code></pre>
<h3 data-id="heading-26">8.3 自定义下载器</h3>
<p>对于特殊需求，可以自定义下载器：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 创建自定义下载器</span>
<span class="hljs-keyword">let</span> customDownloader <span class="hljs-operator">=</span> <span class="hljs-type">ImageDownloader</span>(name: <span class="hljs-string">"custom"</span>)
customDownloader.downloadTimeout <span class="hljs-operator">=</span> <span class="hljs-number">30</span>  <span class="hljs-comment">// 30秒超时</span>
customDownloader.sessionConfiguration.httpMaximumConnectionsPerHost <span class="hljs-operator">=</span> <span class="hljs-number">1</span>  <span class="hljs-comment">// 每个主机1个连接</span>

<span class="hljs-comment">// 使用自定义下载器</span>
imageView.kf.setImage(
    with: url,
    options: [.downloader(customDownloader)]
)

<span class="hljs-comment">// 添加自定义请求修改器</span>
<span class="hljs-keyword">let</span> modifier <span class="hljs-operator">=</span> <span class="hljs-type">AnyModifier</span> { request <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">var</span> r <span class="hljs-operator">=</span> request
    r.setValue(<span class="hljs-string">"Bearer token"</span>, forHTTPHeaderField: <span class="hljs-string">"Authorization"</span>)
    <span class="hljs-keyword">return</span> r
}

imageView.kf.setImage(
    with: url,
    options: [.requestModifier(modifier)]
)
</code></pre>
<h2 data-id="heading-27">九、扩展性与自定义</h2>
<h3 data-id="heading-28">9.1 插件系统</h3>
<p>Kingfisher 支持插件扩展：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 创建自定义插件</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">AnalyticsPlugin</span>: <span class="hljs-title class_">ImagePlugin</span> {
    <span class="hljs-keyword">var</span> identifier: <span class="hljs-type">String</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"com.myapp.analytics"</span>
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">willDownloadImage</span>(<span class="hljs-params">for</span> <span class="hljs-params">url</span>: <span class="hljs-type">URL</span>, <span class="hljs-params">options</span>: <span class="hljs-type">KingfisherParsedOptionsInfo</span>) {
        <span class="hljs-type">Analytics</span>.track(event: <span class="hljs-string">"image_will_download"</span>, properties: [<span class="hljs-string">"url"</span>: url.absoluteString])
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didDownloadImage</span>(<span class="hljs-params">for</span> <span class="hljs-params">url</span>: <span class="hljs-type">URL</span>, <span class="hljs-params">result</span>: <span class="hljs-type">Result</span>&lt;<span class="hljs-type">ImageLoadingResult</span>, <span class="hljs-type">KingfisherError</span>&gt;, <span class="hljs-params">options</span>: <span class="hljs-type">KingfisherParsedOptionsInfo</span>) {
        <span class="hljs-keyword">switch</span> result {
        <span class="hljs-keyword">case</span> .success:
            <span class="hljs-type">Analytics</span>.track(event: <span class="hljs-string">"image_download_success"</span>, properties: [<span class="hljs-string">"url"</span>: url.absoluteString])
        <span class="hljs-keyword">case</span> .failure(<span class="hljs-keyword">let</span> error):
            <span class="hljs-type">Analytics</span>.track(event: <span class="hljs-string">"image_download_failed"</span>, properties: [
                <span class="hljs-string">"url"</span>: url.absoluteString,
                <span class="hljs-string">"error"</span>: error.localizedDescription
            ])
        }
    }
}

<span class="hljs-comment">// 使用插件</span>
<span class="hljs-keyword">let</span> plugin <span class="hljs-operator">=</span> <span class="hljs-type">AnalyticsPlugin</span>()
imageView.kf.setImage(
    with: url,
    options: [.plugin(plugin)]
)
</code></pre>
<h3 data-id="heading-29">9.2 自定义缓存序列化器</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">EncryptedCacheSerializer</span>: <span class="hljs-title class_">CacheSerializer</span> {
    <span class="hljs-keyword">let</span> encryptionKey: <span class="hljs-type">String</span>
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">data</span>(<span class="hljs-params">with</span> <span class="hljs-params">image</span>: <span class="hljs-type">KFCrossPlatformImage</span>, <span class="hljs-params">original</span>: <span class="hljs-type">Data</span>?) -&gt; <span class="hljs-type">Data</span>? {
        <span class="hljs-comment">// 加密图片数据</span>
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> image.kf.data(format: .unknown) <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> }
        <span class="hljs-keyword">return</span> encrypt(data: data, key: encryptionKey)
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">image</span>(<span class="hljs-params">with</span> <span class="hljs-params">data</span>: <span class="hljs-type">Data</span>, <span class="hljs-params">options</span>: <span class="hljs-type">KingfisherParsedOptionsInfo</span>) -&gt; <span class="hljs-type">KFCrossPlatformImage</span>? {
        <span class="hljs-comment">// 解密图片数据</span>
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> decryptedData <span class="hljs-operator">=</span> decrypt(data: data, key: encryptionKey),
              <span class="hljs-keyword">let</span> image <span class="hljs-operator">=</span> <span class="hljs-type">KFCrossPlatformImage</span>(data: decryptedData) <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
        }
        <span class="hljs-keyword">return</span> image
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">data</span>: <span class="hljs-type">Data</span>, <span class="hljs-params">key</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Data</span>? {
        <span class="hljs-comment">// 实现加密逻辑</span>
        <span class="hljs-keyword">return</span> data
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">data</span>: <span class="hljs-type">Data</span>, <span class="hljs-params">key</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Data</span>? {
        <span class="hljs-comment">// 实现解密逻辑</span>
        <span class="hljs-keyword">return</span> data
    }
}

<span class="hljs-comment">// 使用自定义序列化器</span>
<span class="hljs-keyword">let</span> serializer <span class="hljs-operator">=</span> <span class="hljs-type">EncryptedCacheSerializer</span>(encryptionKey: <span class="hljs-string">"my_secret_key"</span>)
imageView.kf.setImage(
    with: url,
    options: [.cacheSerializer(serializer)]
)
</code></pre>
<h2 data-id="heading-30">十、总结</h2>
<p>Kingfisher 作为 Swift 生态中最优秀的图片加载库之一，其成功源于多个方面：</p>
<ol>
<li><strong>现代化的 Swift 设计</strong>：充分利用 Swift 语言特性，提供类型安全的 API</li>
<li><strong>卓越的性能表现</strong>：三级缓存策略、后台解码、智能预加载等优化</li>
<li><strong>完整的平台支持</strong>：iOS、macOS、watchOS、tvOS 全平台支持</li>
<li><strong>强大的扩展性</strong>：插件系统、自定义处理器、序列化器等</li>
<li><strong>优秀的社区生态</strong>：活跃的维护、丰富的文档、大量的第三方扩展</li>
</ol>
<p>在实际项目中，建议：</p>
<ul>
<li>根据应用场景合理配置缓存策略</li>
<li>在列表视图中使用 <code>prepareForReuse</code> 取消未完成的任务</li>
<li>利用预加载提升用户体验</li>
<li>监控缓存大小和性能指标</li>
<li>根据业务需求自定义处理器和插件</li>
</ul>
<p>Kingfisher 不仅是一个图片加载库，更是 Swift 最佳实践的体现。通过深入理解其设计理念和实现细节，开发者可以构建出高性能、高可靠性的图片处理解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第1章 世界静默，键盘独鸣]]></title>    <link>https://juejin.cn/post/7582601349579620352</link>    <guid>https://juejin.cn/post/7582601349579620352</guid>    <pubDate>2025-12-12T08:15:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582601349579620352" data-draft-id="7582769411993337908" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 第1章 世界静默，键盘独鸣"/> <meta itemprop="keywords" content="Redis"/> <meta itemprop="datePublished" content="2025-12-12T08:15:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端一课"/> <meta itemprop="url" content="https://juejin.cn/user/1169536102963917"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             第1章 世界静默，键盘独鸣
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1169536102963917/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端一课
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:15:39.000Z" title="Fri Dec 12 2025 08:15:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第1章 世界静默，键盘独鸣</h2>
<p>褚云帆是被一阵刺耳的警报声吵醒的。</p>
<p>那声音像是用生锈的锯子切割金属，尖锐得能刺穿耳膜。他猛地从工位上抬起头，后颈传来一阵僵硬的酸痛——昨晚又通宵了。</p>
<p>眼前的世界模糊了几秒。</p>
<p>他习惯性地伸手去摸眼镜，手指触到冰凉的镜架。戴上。</p>
<p>视野清晰起来。</p>
<p>然后他愣住了。</p>
<p>深蓝科技开放式办公区的景象，和他记忆中任何一次加班后的清晨都不同。</p>
<p>太吵了。</p>
<p>不是键盘敲击声——那种清脆规律的“咔嗒咔嗒”早就消失了。取而代之的是一片混乱的、毫无节奏的敲打声，像是幼儿园小朋友在胡乱拍打玩具琴。</p>
<p>褚云帆揉了揉酸涩的眼睛。</p>
<p>他看见左侧工位的李工。</p>
<p>李工是公司十年的老程序员，秃顶，脾气暴躁，但代码写得极稳。此刻他正对着屏幕，双手悬在键盘上方，手指微微颤抖。他的嘴唇在动，好像在默念什么咒语。</p>
<p>然后他按下一个键。</p>
<p>“a”。</p>
<p>屏幕上跳出一个字母。</p>
<p>李工盯着那个“a”，额头渗出细密的汗珠。他深吸一口气，又按下一个键。</p>
<p>“s”。</p>
<p>“d”。</p>
<p>“f”。</p>
<p>他像是在玩打字游戏，但打出来的字母毫无意义。asdfasdfasdf——一行行重复的字符在屏幕上滚动。</p>
<p>“不对……”李工喃喃自语，“循环……for循环该怎么写来着？”</p>
<p>他的手指悬在键盘上，迟迟落不下去。</p>
<p>好像有什么东西卡住了。</p>
<p>褚云帆转过头。</p>
<p>整个办公区两百多个工位，所有人都在做同样的事——对着键盘发呆，然后敲出乱七八糟的字符。有人试图写注释，打出来的却是“#￥%……&amp;*（）”。有人想定义变量，屏幕上出现的是“int a = ;;;;;;;;;”。</p>
<p>分号。</p>
<p>无数个分号。</p>
<p>像是某种集体癔症。</p>
<p>“谁能写个循环？！”</p>
<p>一声咆哮从过道传来。</p>
<p>主管老王站在走廊中央，四十多岁的中年男人，此刻脸涨得通红。他手里举着一台平板电脑，屏幕上是半截代码——看起来像是某个脚本的开头，但语法完全错了。</p>
<p>“就一个简单的for循环！”老王的声音在发抖，“迭代数组！打印数字！这他妈是实习生第一天就该会的东西！”</p>
<p>没人回应。</p>
<p>只有键盘的胡乱敲击声。</p>
<p>老王走到最近的一个工位，抢过员工的键盘。他深吸一口气，手指放在键盘上。</p>
<p>然后僵住了。</p>
<p>他的嘴唇在动，好像在回忆什么。几秒钟后，他开始敲击。</p>
<p>for (i = 0; i &lt; 10; i++)</p>
<p>打到“i++”时，他停住了。</p>
<p>“加加……”老王盯着屏幕，“是i++还是++i？前置和后置有什么区别来着？”</p>
<p>他想了五秒钟。</p>
<p>然后删掉了整行。</p>
<p>重新打。</p>
<p>for (int i = 0; i &lt; 10; i = i + 1)</p>
<p>这次语法对了。</p>
<p>但老王盯着那行代码，眼神空洞。他好像不记得接下来该写什么了。大括号？语句块？打印函数？</p>
<p>他的手在颤抖。</p>
<p>最终，他敲下一个分号，结束了这行代码。</p>
<p>for (int i = 0; i &lt; 10; i = i + 1);</p>
<p>一个空循环。</p>
<p>毫无意义。</p>
<p>老王把键盘扔回桌上，发出“砰”的一声。他环顾四周，眼神里第一次出现了褚云帆从未见过的情绪。</p>
<p>恐惧。</p>
<p>“你们……”老王的声音低了下来，“你们都忘了吗？”</p>
<p>没人回答。</p>
<p>褚云帆低下头，看向自己的屏幕。</p>
<p>他的终端还开着。昨晚通宵重构的那个模块，代码还停留在编辑器中。三百多行，结构清晰，注释完整，是他花了六个小时精心打磨的。</p>
<p>他下意识地滚动鼠标。</p>
<p>代码正常显示。</p>
<p>没有乱码。</p>
<p>他愣了一下。</p>
<p>然后，几乎是出于本能——程序员的本能，那种写完代码总要测试一下的本能——他新建了一个文件。</p>
<p>手指放在键盘上。</p>
<p>肌肉记忆开始工作。</p>
<p>他甚至没有思考，指尖就动了起来。敲击声清脆、连贯、有节奏，和周围那片混乱的噪音形成鲜明对比。</p>
<p>print('Hello World')</p>
<p>回车。</p>
<p>屏幕下方，终端窗口弹出。</p>
<p>清晰的白色字体显示在黑色背景上：</p>
<p>Hello World</p>
<p>成功了。</p>
<p>褚云帆盯着那行字，看了三秒钟。</p>
<p>然后他猛地抬起头。</p>
<p>办公室里突然安静了。</p>
<p>不知道从什么时候开始，所有人都停下了手里的动作。键盘声消失了。说话声消失了。连呼吸声都好像变轻了。</p>
<p>两百多双眼睛，齐刷刷地看向他。</p>
<p>那些眼神很复杂。</p>
<p>有困惑。</p>
<p>有茫然。</p>
<p>但更多的是……一种褚云帆无法理解的东西。像是原始人看到同部落的人突然徒手生起了火。像是中世纪农民看到邻居念出了恶魔的文字。</p>
<p>怪物。</p>
<p>他们在看一个怪物。</p>
<p>褚云帆的后背瞬间被冷汗浸湿。</p>
<p>他几乎是条件反射地按下Ctrl+A，然后Delete。屏幕上的代码消失了。终端窗口关闭了。他抬起头，脸上挤出一个和周围人同样困惑的表情。</p>
<p>“怎么了？”他问，声音有点干涩，“你们……都看着我干嘛？”</p>
<p>没人说话。</p>
<p>李工张了张嘴，好像想说什么，但最终只是摇了摇头，转回了自己的屏幕。</p>
<p>老王盯着褚云帆看了几秒，眼神里的恐惧慢慢变成了怀疑。但他也没说什么，只是转身走回了自己的办公室，重重关上了门。</p>
<p>警报声还在响。</p>
<p>但已经没人管了。</p>
<p>褚云帆坐在工位上，心脏狂跳。他强迫自己深呼吸，一次，两次。手指在桌子下面微微颤抖。</p>
<p>不对劲。</p>
<p>太不对劲了。</p>
<p>他打开浏览器，点开新闻网站。</p>
<p>首页全是乱码。</p>
<p>不，不是乱码——是各种语法的碎片。中文里夹杂着英文单词，英文句子里混着编程语言的符号。像是整个网站的渲染引擎崩了。</p>
<p>他刷新。</p>
<p>还是这样。</p>
<p>他换了个网站。</p>
<p>同样的情况。</p>
<p>最终，他在一个极简的纯文本论坛上，看到了一条还能勉强阅读的消息：</p>
<p>【紧急通知：全球范围内出现未知技术故障。编程语言理解能力普遍异常。建议所有技术人员停止操作，等待进一步通知。】</p>
<p>下面跟了几百条回复。</p>
<p>“我连Hello World都写不出来了……”</p>
<p>“变量是什么？函数是什么？我好像做了个梦，梦里我会写代码，但醒来全忘了。”</p>
<p>“不是忘了！是脑子转不动！我看到for这个单词，知道它是循环，但就是想不起来该怎么用！”</p>
<p>“全球性的？不只是我们公司？”</p>
<p>“不只是我们国家。我刚问了国外的朋友，一样。”</p>
<p>褚云帆一条条往下翻。</p>
<p>手指越来越冷。</p>
<p>中午十二点，公司强制断网。</p>
<p>广播里传来行政总监的声音，听起来很疲惫：“全体同事请注意，接上级通知，即刻起停止所有技术相关工作。请大家……保持冷静。等待进一步安排。”</p>
<p>办公区一片死寂。</p>
<p>没人动。</p>
<p>大家就坐在工位上，盯着黑屏的显示器，或者盯着自己的手。好像只要多看一会儿，那些丢失的技能就会回来。</p>
<p>褚云帆站起来，走向茶水间。</p>
<p>路过李工工位时，他瞥了一眼屏幕。</p>
<p>李工在写文档。</p>
<p>用中文。</p>
<p>“如何打开终端：第一步，找到屏幕左下角的开始菜单。第二步，点击。第三步，在搜索框里输入‘cmd’。第四步……”</p>
<p>他写得很慢。</p>
<p>每一个字都要想很久。</p>
<p>好像这不是常识，而是某种需要详细记录的秘密知识。</p>
<p>茶水间里，几个同事在低声说话。</p>
<p>“你还能记得多少？”</p>
<p>“我……我记得if是判断。else是否则。但具体怎么写，我脑子里一片空白。”</p>
<p>“我也是。就好像有人把我大脑里关于编程的那部分，整个挖掉了。”</p>
<p>“不是挖掉。”另一个声音说，“是蒙上了一层雾。你知道雾后面有东西，但就是看不清。”</p>
<p>褚云帆接了一杯水。</p>
<p>水温很正常。</p>
<p>但他喝下去的时候，感觉喉咙发干。</p>
<p>下午两点，公司宣布提前下班。</p>
<p>“基础设施不稳定，”老王在群里发消息，“交通系统可能受影响，大家早点回家。”</p>
<p>没人欢呼。</p>
<p>大家沉默地收拾东西，沉默地离开工位。动作都很慢，好像还在消化今天发生的一切。</p>
<p>褚云帆背起包，走进电梯。</p>
<p>电梯里有六个人。</p>
<p>没人说话。</p>
<p>大家盯着楼层数字，眼神空洞。</p>
<p>电梯下到一楼，“叮”的一声开门。</p>
<p>褚云帆走出去，然后停住了脚步。</p>
<p>大厦外的景象，比他想象的更糟。</p>
<hr/>
<p>街道上，红绿灯在胡乱闪烁。</p>
<p>不是故障的那种闪烁——是毫无规律。红灯亮0.5秒，绿灯亮2秒，黄灯亮0.1秒，然后又跳回红灯。三个灯有时候会同时亮起，发出刺眼的光。</p>
<p>十字路口堵成了一团。</p>
<p>自动驾驶汽车停在路中间，有的在缓慢地原地转圈，有的在前后轻微挪动，像是失去了方向的昆虫。一辆公交车的电子屏上滚动着乱码，司机试图手动操作，但方向盘好像锁死了。</p>
<p>人行道上，人们拿着手机，脸上都是茫然。</p>
<p>“地图用不了了……”</p>
<p>“叫车软件显示服务器错误。”</p>
<p>“连扫码支付都不行了！刚才买瓶水，扫了五分钟都没反应！”</p>
<p>褚云帆站在大厦门口，看着这一切。</p>
<p>阳光很好。</p>
<p>天空很蓝。</p>
<p>但世界好像突然变成了一个劣质的、漏洞百出的程序。每一个模块都在报错，每一个函数都在崩溃。</p>
<p>他抬起左手，看了一眼手腕上的表。</p>
<p>那是一块老旧的电子表，表盘不是数字，而是一行不断跳动的代码。</p>
<p>是他自己改装的。</p>
<p>表盘上显示着：</p>
<p><code>while (true) { display_time(); sleep(1000); }</code></p>
<p>一个无限循环，每秒刷新一次时间。</p>
<p>此刻，代码正常滚动。</p>
<p>时间正常显示。</p>
<p>14:37:05。</p>
<p>褚云帆盯着那行代码，看了很久。</p>
<p>然后他抬起头，看向街道对面。</p>
<p>那里有一家咖啡馆，橱窗上贴着二维码，旁边写着“扫码点单，享受优惠”。一个年轻人正拿着手机对着二维码，反复调整角度，表情越来越烦躁。</p>
<p>“怎么扫不出来啊……”年轻人嘟囔。</p>
<p>褚云帆知道为什么。</p>
<p>扫码程序底层依赖图像识别库，识别库依赖算法，算法依赖代码。</p>
<p>代码写不出来了。</p>
<p>所以识别库无法更新，算法无法优化，程序最终会随着设备老化而逐渐失效。</p>
<p>就像现在。</p>
<p>就像整个世界。</p>
<p>他深吸一口气，把袖子拉下来，盖住手表。</p>
<p>然后迈开脚步，走进混乱的街道。</p>
<p>回家的路原本只需要二十分钟。</p>
<p>今天他走了一个小时。</p>
<p>因为要避开所有依赖智能调度的路口，要绕开那些在原地打转的自动驾驶汽车，要小心突然乱闪的交通信号灯。</p>
<p>路上，他看到了更多细节。</p>
<p>一家银行的ATM机，屏幕蓝屏，显示着一串错误代码。几个人围在旁边，试图理解那些代码的意思，但显然失败了。</p>
<p>一个外卖机器人卡在路边绿化带里，轮子空转，扬声器里反复播放：“路径规划错误，请稍候……路径规划错误，请稍候……”</p>
<p>便利店门口，电子广告牌上本该播放促销视频的区域，现在显示着一行行调试信息：</p>
<p><code>Segmentation fault (core dumped)</code></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[10GB vs 600MB：我们弃用 GitLab，选择了这个轻量级神器]]></title>    <link>https://juejin.cn/post/7582637280217858102</link>    <guid>https://juejin.cn/post/7582637280217858102</guid>    <pubDate>2025-12-12T08:17:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582637280217858102" data-draft-id="7582535649276821545" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="10GB vs 600MB：我们弃用 GitLab，选择了这个轻量级神器"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-12T08:17:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="勇哥Java实战"/> <meta itemprop="url" content="https://juejin.cn/user/3693987061329080"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            10GB vs 600MB：我们弃用 GitLab，选择了这个轻量级神器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3693987061329080/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    勇哥Java实战
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:17:45.000Z" title="Fri Dec 12 2025 08:17:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在开发一个类似魔搭（ModelScope）的AI 模型托管平台，需要为每个项目提供独立的仓库服务。</p>
<p>最初的方案选择了业界熟知的 GitLab ，但很快就遇到了瓶颈：仅仅是基础的代码托管功能，GitLab全套服务（主进程、PostgreSQL 和 Redis ）在运行一段时间后，内存占用一度逼近 10GB。这对于我们的轻量级项目需求而言，无疑是一个难以承受的“资源黑洞”。</p>
<p><strong>最后我们选择了 Gitea 这个轻量级的自托管 Git 解决方案——它不仅将内存占用从10GB降低到 600MB左右，更重要的是提供了完整的API接口，让我们可以深度集成到自己的 AI 平台中。</strong></p>
<p>本文将带你快速使用 <strong>Docker 部署 Gitea</strong>，并演示如何创建仓库，以及如何通过 Gitea <strong>REST API</strong> 实现业务定制 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfec6295f82444c39f92a2fbe5eab738~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=mGJNmP47KuVhKFKq6m%2F098dSi88%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">1 部署前置准备</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3afac8ccd99b4d1383d7e4257f4999f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=3wLGgxxqjVcjibWBrJh2GHlduWY%3D" alt="" loading="lazy"/></p>

























<table><thead><tr><th>组件</th><th>是否必须</th><th>用途说明</th></tr></thead><tbody><tr><td><strong>数据库（MySQL / PostgreSQL / SQLite）</strong></td><td>✅ 必须</td><td>存储核心业务数据：用户、仓库、Issue、PR、权限、LFS 元信息等</td></tr><tr><td><strong>S3 / MinIO（对象存储）</strong></td><td>➖ 可选</td><td>用于存储仓库附件、LFS 大文件；没有时使用本地磁盘</td></tr><tr><td><strong>Redis</strong></td><td>➖ 可选</td><td>用作缓存、Session、队列后台，提升性能</td></tr></tbody></table>
<p>gitea 支持 sqlite 、mysql8 、pg12 ，因为 sqlite 只支持单进程/线程写，性能极差。</p>
<p>因为笔者使用 MySQL 最多也最熟悉，所以我们选择前置安装 MySQL 8 。安装完 MySQL 后 ，在数据库中新建数据库 gitea （此时，gitea 数据库并没有任何表）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c709f0fd8e104b86bec5492677c38dd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=nAlJuvPLI%2BzIZkXtRzal3s1%2F3mU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">2 Docker 安装 Gitea</h2>
<p>接下来，运行如下命令，使用 Docker 安装 Gitea 。</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d --name gitea \
-p 3000:3000 -p 222:22 \
-v /Users/zhangyong/docker/gitea/data:/data \
-v /etc/localtime:/etc/localtime:ro \
-v /etc/timezone:/etc/timezone:ro \
-e USER_UID=1000 \
-e USER_GID=1000 \
--restart always \
gitea/gitea:latest
</code></pre>
<p>安装完后第一次访问页面 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000" target="_blank" title="http://localhost:3000" ref="nofollow noopener noreferrer">http://localhost:3000</a> :</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/466b6ec6e6724cfdb2e20666e49ab49e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=0krxtc0OhgZn53EUdjmRSOvb6Rk%3D" alt="" loading="lazy"/></p>
<p>如图，我们配置了 数据库 Gitea ，然后点击立即安装 。</p>
<blockquote>
<p>配置选项将写入以下位置: /data/gitea/conf/app.ini</p>
</blockquote>
<p>安装完成之后，界面如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eea9a20d8f07490e9f9a402b38c50208~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=kZcSoRRJK4JeJjJ4lsOVsDufaVM%3D" alt="" loading="lazy"/></p>
<p>注册完 root 账号后，进入首页：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27619bddd35c47e6bd84e6a9c699460c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=CnVDxOI8fttr3NDZvIZS0VvWHWs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">3 新建仓库</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70af6a7b9ec24426a192fc5289bc170f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=11sdf08WbvvzNUQQC977rUqWZNY%3D" alt="" loading="lazy"/></p>
<p>如图，创建仓库的界面和 Github 类似，输入仓库名，即可创建成功：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c5045d4b9654b33bd8f1adfcff1fe0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=6M6ypGZh0dKcTJ3kwo33g20EPyQ%3D" alt="" loading="lazy"/></p>
<p>当我们想克隆 或者 推送仓库时，需要创建用户的 pat （ Access Token ）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cd25975bd8b4a2e9575a12c8996ee0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=X3YNR68eZJezjSYSILpjeFNpVac%3D" alt="" loading="lazy"/></p>
<p>创建成功后，界面如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e09cc254670b4c859d49f04aa2a4770c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=0WOSJS9CGLii2MBr338zRpLUpVA%3D" alt="" loading="lazy"/></p>
<p>我们将令牌保存好，在克隆仓库时，或者 push 仓库时，需要使用该令牌。</p>
<h2 data-id="heading-3">4 调用 API</h2>
<p>如图，当我们访问：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000%2Fapi%2Fswagger%23%2Frepository" target="_blank" title="http://localhost:3000/api/swagger#/repository" ref="nofollow noopener noreferrer">http://localhost:3000/api/swagger#/repository</a> , 可以查看所有的 Gitea 开发 API 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a942402ba7b54d9fad44bb24aaa56422~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=aHaNzvEVNB1f24p3gNK9wgU9tdA%3D" alt="" loading="lazy"/></p>
<p>如图，我们可以将所有的 Gitea API 封装成如下的 Java 服务：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29db174249ce4d3dba8292f8b0c7f604~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=KbRkA7gNh5Y4aho0cHmdMkx1FVY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">5 总结</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63cc142b758947578080af8fd3e2e6b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=IMQ023ID0EcudPdN69KIBnjwj%2B4%3D" alt="" loading="lazy"/></p>
<p>上图是笔者调研 Gitea 和 GItlab 的对比图，相比之下 ，Gitea 真是轻量级神器 ，能够完美适配公司业务的需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从JS云函数到MCP：打造跨平台AI Agent工具的工程实践]]></title>    <link>https://juejin.cn/post/7582599972950982683</link>    <guid>https://juejin.cn/post/7582599972950982683</guid>    <pubDate>2025-12-12T08:43:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582599972950982683" data-draft-id="7582422818311372851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从JS云函数到MCP：打造跨平台AI Agent工具的工程实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-12T08:43:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哔哩哔哩技术"/> <meta itemprop="url" content="https://juejin.cn/user/3030701626893405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从JS云函数到MCP：打造跨平台AI Agent工具的工程实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3030701626893405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哔哩哔哩技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:43:39.000Z" title="Fri Dec 12 2025 08:43:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>构建 AI 工具生态这件事上，过去一年我们做了不少尝试。</p>
<p>回头看，会觉得这条路径像是在搭建一条越来越清晰的“能力生产线”：</p>
<blockquote>
<p>从写 JS → Agent Tool 工具 → 成为 MCP 工具 → 成为跨平台 Agent 能力。</p>
</blockquote>
<p>这篇文章我们就按这条演进路线，把底层逻辑、踩坑经验和最终的工程方案完整讲清楚。</p>
<h2 data-id="heading-0"><strong>一、先做简单介绍</strong></h2>
<p>我们做了一个“在线 JS 云函数平台”，它的本质是：把写一个 JS 函数，变成给 AI 赋予一个 Tool 新能力。</p>
<p>这套系统经历了三个阶段：</p>
<p><strong>1.  第一版：</strong> 只是 Flowise 里的一个 LangChain StructuredTool 扩展，能在工作流里被 Agent 调用。</p>
<blockquote>
<p><strong>Flowise</strong>（<em><a href="https://link.juejin.cn?target=https%3A%2F%2Fflowiseai.com%2F" target="_blank" title="https://flowiseai.com/" ref="nofollow noopener noreferrer">flowiseai.com/</a></em> ） 是一款开源、可视化的 AI 工作流工具，通过拖拽节点即可构建 LLM 应用或 Agent。它底层基于 LangChain 的 TypeScript 版本，因此天然具备模型调用、工具调用、链式处理、记忆与向量检索等能力。</p>
<p>当时我们在技术选型时使用 Flowise 做AI工作流平台有两个原因：</p>
<p>一是它基于 LangChain 的 TypeScript 版本——在早期 AI 框架还不成熟时，这是少数原生支持 TS 的方案；二是它提供了可拖拽的可视化工作流，能让我们快速搭建和验证 AI 原型。</p>
</blockquote>
<p><strong>2.  第二版：</strong> 演进为一个浏览器里的 云函数 IDE：在线写代码、调试、沙箱运行时、连内网 gRPC/HTTP/MySQL。</p>
<p><strong>3.  现在：</strong> 接上 MCP 协议，变成一个可以被「任何支持 MCP 的 Agent / Studio」跨平台调用的独立工具平台，并支持 SSE + Streamable HTTP 两种流式协议。</p>
<h2 data-id="heading-1"><strong>二、为什么我们需要“AI 工具能力层”？</strong></h2>
<p>在我们内部构建 AI 应用（客服、直播运营助手等）时，遇到几个非常典型的痛点。</p>
<h3 data-id="heading-2"><strong>1. 工具很多，但每接一次 AI，都要重写一遍工具</strong></h3>
<ul>
<li>想让 AI 查开播状态、查卡顿、查稿件、给用户发通知……</li>
<li>后端能力其实都有，但每接一个新智能体，就要：</li>
</ul>

<ul>
<li>在某个项目里再写一遍调用代码</li>
<li>手动写结构化参数 / 返回值</li>
<li>校验、鉴权</li>
</ul>

<ul>
<li>每个团队都重新写一遍</li>
</ul>
<h3 data-id="heading-3"><strong>2. AI 需要的是“能力”，而不是“接口”</strong></h3>
<p>业务接口往往是这样的：</p>
<pre><code class="hljs language-ini" lang="ini">GET /room/info?<span class="hljs-attr">roomid</span>=<span class="hljs-number">123</span>
</code></pre>
<p>但是用户却会说：“查一下imzerooo开播状态”</p>
<p>这中间的自然语言 → 参数的语义映射，很难靠简单规则完成。</p>
<p>如果让开发者直接暴露接口，AI 是很难用好的。</p>
<h3 data-id="heading-4"><strong>3. JSON 不是 AI 友好的输入格式</strong></h3>
<p>内网接口通常返回一大坨 JSON。LLM 解析 JSON 没问题，但：</p>
<ul>
<li>
<p>字段多、嵌套深 → 容易丢字段</p>
</li>
<li>
<p>字段名杂乱 → 模型记不住</p>
</li>
<li>
<p>文本内容多 → 容易产生幻觉</p>
</li>
</ul>
<p>AI 友好的格式是：</p>
<ul>
<li>Markdown 表格</li>
<li>简洁的自然语言</li>
<li>提炼过的信息</li>
</ul>
<p>而不是整包 JSON。</p>
<h3 data-id="heading-5"><strong>4. 工具没有做成“资产层”</strong></h3>
<p>以前的工具要么：</p>
<ul>
<li>绑死在某个 AI 工作流上</li>
<li>埋在某个项目里</li>
<li>放在某个业务脚本中</li>
</ul>
<p>无法像资产一样复用。</p>
<p>所以一切问题的核心其实是：</p>
<blockquote>
<p>缺少一个可以写工具、管理工具、发布工具、复用工具的统一能力层。</p>
</blockquote>
<p>而我们做的，就是让这件事：<strong>只需写一段 JS 函数</strong>。</p>
<h2 data-id="heading-6"><strong>三、第一版：StructuredTool——</strong> <strong>工具能力的萌芽</strong></h2>
<p>最初我们是在 Flowise 里写 StructuredTool 组件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72ced04a48494603918827c4122ede20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=XtYbdQtaGdZM%2FUDGapbs6%2FslHaY%3D" alt="图片" loading="lazy"/></p>
<p>Flowise 底层基于 LangChain，所以我们写了很多 StructuredTool：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c02f6d395f04297a837fc8d5cc1a732~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=QEbEADudVWccw550Eu1boTTu7bo%3D" alt="截屏2025-12-12 15.43.12.png" loading="lazy"/></p>
<p>这一版有几个优点：</p>
<ul>
<li>
<p>工具能被 Agent 调用</p>
</li>
<li>
<p>参数有 schema</p>
</li>
<li>
<p>有一定的模块化</p>
</li>
</ul>
<p>但有几个局限：</p>
<ul>
<li>
<p>工具生命周期跟 Flowise 项目绑死</p>
</li>
<li>
<p>要写 TS、写 Node 项目，对效率很不友好</p>
</li>
<li>
<p>无法跨平台使用</p>
</li>
<li>
<p>JSON 处理还是要自己写</p>
</li>
<li>
<p>无法注入通用能力（如内网 SDK）</p>
</li>
</ul>
<p>于是我们开始考虑平台化。</p>
<h2 data-id="heading-7"><strong>四、第二版：在线 JS 云函数平台（NodeVM 运行时）</strong></h2>
<p>我们打造了一套全新的平台：在线 JS 云函数平台。</p>
<p>开发者不需要知道 Flowise、LangChain，也不用开Node 项目。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/222439794fe443fdae66e2b1fe4dc93d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=m9boE%2FVLT8PyKrzwBwNFjhVuAg4%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-8"><strong>4.1 NodeVM：一个安全可控的 JS 执行沙箱</strong></h3>
<p>我们基于 vm2（NodeVM）做了一个“可控的 JS 执行环境”。</p>
<ul>
<li>
<p>运行时基于 StructureTool</p>
</li>
<li>
<p>NodeVM 作为安全隔离的执行环境</p>
</li>
<li>
<p>自动注入企业内部能力（统一上下文能力层）</p>
</li>
</ul>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/** 
 * 核心思路抽象版 
 */</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeVM</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vm2'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StructuredTool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/tools'</span>
<span class="hljs-comment">//...</span>

classDynamicToolextendsStructuredTool { 
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ name, description, schema, code }</span>) { 
    <span class="hljs-variable language_">super</span>({ name, description, schema }) 
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">code</span> = code <span class="hljs-comment">// 用户在在线编辑器里写的 JS 代码 </span>
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">_call</span>(<span class="hljs-params">args, runManager, flowContext</span>) {
    <span class="hljs-comment">// 1. 构建沙箱（所有注入能力都放在这里） </span>
    <span class="hljs-keyword">const</span> sandbox = { 
      <span class="hljs-comment">// 用户传入的参数转成 $xxx</span>
      ...<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(args).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">[k, v]</span>) =&gt;</span> [<span class="hljs-string">`$<span class="hljs-subst">${k}</span>`</span>, v])),
      
      <span class="hljs-comment">// 内部上下文（cookie/env/session） </span>
      <span class="hljs-attr">$flow</span>: flowContext,  
      <span class="hljs-attr">$cookie</span>: flowContext.<span class="hljs-property">cookie</span>,
      
      <span class="hljs-comment">// 内网能力封装（gRPC/HTTP） </span>
      <span class="hljs-attr">$yuumi</span>: yuumi,
      
      <span class="hljs-comment">// 结果转换工具（用于把 JSON 转成更 AI 友好的 Markdown 表格）  </span>
      <span class="hljs-attr">$json2MarkdownTable</span>: json2MarkdownTable,
      
      <span class="hljs-comment">// 内部 AI 模型     </span>
      <span class="hljs-attr">$biliLLM</span>: biliLLMClient  
    }
    
    <span class="hljs-comment">// 2. 构建 NodeVM 沙箱 </span>
    <span class="hljs-keyword">const</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NodeVM</span>({ 
      sandbox,   
      <span class="hljs-attr">console</span>: <span class="hljs-string">"inherit"</span>,    
      <span class="hljs-attr">require</span>: {      
        <span class="hljs-attr">builtin</span>: allowedBuiltinDeps,    
        <span class="hljs-attr">external</span>: allowedExternalDeps  
      }
    })
    
    <span class="hljs-comment">// 3. 执行开发者写的云函数代码 </span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> vm.<span class="hljs-title function_">run</span>(   
      <span class="hljs-string">`module.exports = async () =&gt; { <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.code}</span> }()`</span>,   
      __dirname   
    ) 
  }
}
</code></pre>
<p>它既能隔离风险，又能注入能力：</p>
<ul>
<li>
<p>禁止访问文件系统</p>
</li>
<li>
<p>禁止随意 require</p>
</li>
<li>
<p>只开放白名单依赖</p>
</li>
<li>
<p>内置 $yuumi（内网 gRPC/HTTP 调用）</p>
</li>
<li>
<p>内置 $json2MarkdownTable</p>
</li>
<li>
<p>内置 $cookie</p>
</li>
<li>
<p>内置 $flow（上下文）</p>
</li>
<li>
<p>内置 内部 AI 能力</p>
</li>
</ul>
<p>于是开发者传入的业务代码类似这样：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ed89f9e732048ab8bf56270f1d81638~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=pdpqv7yiItuQv7bBXc%2FJTPLjNaw%3D" alt="截屏2025-12-12 16.15.57.png" loading="lazy"/></p>
<h3 data-id="heading-9"><strong>4.2 在线调试：monaco-editor+ Mock</strong> <strong>+ 沙箱日志</strong></h3>
<p>编辑器底层用的是 microsoft/monaco-editor，好处是：</p>
<ul>
<li>
<p>TypeScript / JS 语法高亮</p>
</li>
<li>
<p>可以做一些简单的智能提示</p>
</li>
<li>
<p>UI 很像 VSCode，大家上手成本低</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f3e93016c954b8480957446f806fd1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=TrJO7at%2FgD5xeQNthjhUgHARBpU%3D" alt="图片" loading="lazy"/></p>
<p>调试方面：</p>
<ul>
<li>
<p>提供了一个 参数 Mock 面板：可以填入调用时的 JSON</p>
</li>
<li>
<p>点击「运行」，平台会在沙箱里跑一遍你的函数，把：日志打印（console.log）、返回字符串、可能的异常，全都展示出来</p>
</li>
</ul>
<p>每次保存，我们都会生成一个版本：</p>
<ul>
<li>
<p>当前编辑的是“草稿”</p>
</li>
<li>
<p>发布的时候会把某个版本标记为发布</p>
</li>
<li>
<p>出现问题可以一键回滚到上一版</p>
</li>
</ul>
<p>最后，开发者只需要在编辑器里写一个 “普通 JS 函数”，但：</p>
<ul>
<li>
<p>安全隔离由 NodeVM 负责</p>
</li>
<li>
<p>内网调用靠 $yuumi</p>
</li>
<li>
<p>会话靠 $cookie</p>
</li>
<li>
<p>AI 友好的结果格式靠 $json2MarkdownTable</p>
</li>
</ul>
<h3 data-id="heading-10"><strong>4.3 Tool Arguments：为 AI 帮开发者“定义接口”</strong></h3>
<p>传统开发写接口参数：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">roomid:</span> <span class="hljs-type">string</span>
</code></pre>
<p>为此，我们提供了转为 Tool Arguments 的可视化配置：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b050b1bb0b048d1beff5ef23aa51a69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=wrqLT12vzLcwNyoGAqCWoZMoPjc%3D" alt="图片" loading="lazy"/></p>
<p>它会统一生成：</p>
<ul>
<li>MCP Tool 的 JSON Schema</li>
<li>StructuredTool 的 Zod Schema</li>
<li>NodeVM 内 $roomid 变量</li>
</ul>
<p>一次配置，全平台复用。</p>
<h3 data-id="heading-11"><strong>4.4 工具市场：企业内部的 Agent 工具仓库</strong></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48e9a510bb8e4c23854d4c95e491e9c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=YhlDZS1wc%2Ba51GW36m25sPM4K1c%3D" alt="图片" loading="lazy"/></p>
<p>我们提供了工具市场：</p>
<ul>
<li>各部门把工具上架</li>
<li>其他部门直接复用</li>
<li>工具行为一致，调用方式一致</li>
<li>避免重复开发</li>
</ul>
<p>工具从“项目资产”变成“企业能力”。</p>
<h2 data-id="heading-12"><strong>五、第三版：接入 MCP</strong> <strong>——让工具跨平台、跨模型、跨框架</strong></h2>
<p>做到第二版时，工具已经变得很好用了。但还缺一块：</p>
<blockquote>
<p>同一份工具定义，既能在 Flowise 里当 LangChain StructuredTool 用，又能在 MCP 里变成跨平台 ToolCall。</p>
</blockquote>
<h3 data-id="heading-13"><strong>5.1 MCP 是什么？以及一个常见误区</strong></h3>
<p>MCP 全称 Model Context Protocol，可以简单理解为：</p>
<blockquote>
<p>给“大模型 + 工具调用”定义了一个“统一插线板”</p>
</blockquote>
<p>它解决的是：</p>
<ul>
<li>
<p>大模型想调用一个外部工具</p>
</li>
<li>
<p>这个工具可能跑在本机、另一台服务器、甚至另一个团队的系统里</p>
</li>
<li>
<p>我们希望“调用方式”是统一、可描述、可流式的。</p>
</li>
</ul>
<h3 data-id="heading-14"><strong>5.2 一个常见误区：把旧接口一包就行了？</strong></h3>
<p>很多人第一反应是：</p>
<blockquote>
<p>那我把现在的业务 HTTP 接口包成一个 MCP 工具，不就行了吗？</p>
</blockquote>
<p>理论上可以，实践里有两个坑：</p>
<p><strong>1.  自然语言 ≠ 接口参数</strong></p>
<p>用户会说：“查一下未完成的任务”。但你的接口长这样：/tasks?status=1&amp;owner_id=xxx。中间这层 “自然语言 → status=1” 的映射，需要：</p>
<ul>
<li>prompt / few-shot</li>
<li>枚举表 / 映射关系</li>
<li>甚至分类模型。</li>
</ul>
<p>所以我们在 Tool Arguments 设置时一定要尽量贴近自然语言，比如 status 描述写成“任务的进度状态（未开始/进行中/已完成）”，而不是“1/2/3”。</p>
<p><strong>2.  JSON 返回 ≠ AI 可读</strong></p>
<p>很多内部接口返回一大坨嵌套 JSON，LLM 虽然能解析，但：</p>
<ul>
<li>容易“漏看”字段；</li>
<li>回答会很啰嗦或不稳定。</li>
<li>所以我们在云函数层统一规定：</li>
</ul>
<p><strong>返回给 AI 的一定是“人类可读”的文本/Markdown，</strong> JSON 只是中间态。</p>
<p>这就是前面 $json2MarkdownTable 那段代码存在的原因。</p>
<h3 data-id="heading-15"><strong>5.3 StructuredTool → MCP：我们是怎么做“代理层”的？</strong></h3>
<p>前面说了两件事：</p>
<ul>
<li>
<p>工具在平台内部用 LangChain StructuredTool + NodeVM 来执行</p>
</li>
<li>
<p>我们希望同一份工具定义，既能在 Flowise 里用，也能被任意支持 MCP 的 Agent / Studio 调用</p>
</li>
</ul>
<p><strong>createMCPServer：Express 里的一层 MCP 网关</strong></p>
<p>在服务端，我们做了一层很薄的 MCP 网关，挂在 Express 应用上：</p>
<pre><code class="hljs language-ruby" lang="ruby">export function createMCPServer({ app, <span class="hljs-title class_">AppDataSource</span> }: <span class="hljs-title class_">App</span>){
  <span class="hljs-regexp">//</span> 单个云函数 → <span class="hljs-variable constant_">MCP</span>-<span class="hljs-title class_">Streamable</span>HTTP  
  app.post(<span class="hljs-string">'/api/mcp/function-tool/:toolId'</span>, singleToolCreateStreamableHTTPServer)  
  /<span class="hljs-regexp">/ 多个云函数组合 → MCP-StreamableHTTP  app.post('/api</span><span class="hljs-regexp">/mcp/</span><span class="hljs-symbol">:mcpId<span class="hljs-string">', multipleToolCreateStreamableHTTPServer)
  
  // 会话后续请求复用
  app.get('</span>/api/mcp/function-tool/</span><span class="hljs-symbol">:id<span class="hljs-string">', handleSessionRequest) 
  app.delete('</span>/api/mcp/function-tool/</span><span class="hljs-symbol">:id<span class="hljs-string">', handleSessionRequest)  
  app.get('</span>/api/mcp/</span><span class="hljs-symbol">:mcpId<span class="hljs-string">', handleSessionRequest)
  app.delete('</span>/api/mcp/</span><span class="hljs-symbol">:mcpId<span class="hljs-string">', handleSessionRequest)
  
  const transports = { 
    streamable: {} as Record&lt;string, StreamableHTTPServerTransport&gt;  
  }
  
  // ... 省略 SSE 相关 ...
}
</span></span></code></pre>
<ul>
<li>对外就是几条 HTTP 路由；</li>
<li>对内维护一个 streamable 的 transport 池，用 sessionId 作为 key。</li>
</ul>
<p>这样，不同 AI Studio / Agent 只要知道某个 URL，就可以把它当 MCP 端点来用。</p>
<p><strong>Streamable HTTP：用 session 管住一条“长连接”</strong></p>
<p>StreamableHTTPServerTransport 是 MCP 官方 SDK 提供的一个传输实现，用来做 Streamable HTTP 模式。我们做的事情有两种情况：</p>
<ol>
<li>
<p>客户端第一次初始化（没有 sessionId）；</p>
</li>
<li>
<p>之后所有请求都带上 mcp-session-id 头，复用之前的 session。</p>
</li>
</ol>
<p>核心代码大概是这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createStreamableHTTP</span>(<span class="hljs-params">config: CreateMcpServerConfig</span>){  
  <span class="hljs-keyword">const</span> { req, res, username } = config
  <span class="hljs-keyword">const</span> sessionId = req.<span class="hljs-property">headers</span>[<span class="hljs-string">'mcp-session-id'</span>] <span class="hljs-keyword">as</span> string | <span class="hljs-literal">undefined</span> 
  <span class="hljs-keyword">let</span> <span class="hljs-attr">transport</span>: <span class="hljs-title class_">StreamableHTTPServerTransport</span>
  
  <span class="hljs-keyword">if</span> (sessionId &amp;&amp; transports.<span class="hljs-property">streamable</span>[sessionId]) {   
    <span class="hljs-comment">// ① 有 sessionId，复用之前的 transport   </span>
    transport = transports.<span class="hljs-property">streamable</span>[sessionId]  
  } elseif (!sessionId &amp;&amp; <span class="hljs-title function_">isInitializeRequest</span>(req.<span class="hljs-property">body</span>)) {  
    <span class="hljs-comment">// ② 首次初始化，请求体符合 MCP 初始化格式   </span>
    transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamableHTTPServerTransport</span>({  
      <span class="hljs-attr">sessionIdGenerator</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">randomUUID</span>(),  
      <span class="hljs-attr">onsessioninitialized</span>: <span class="hljs-function">(<span class="hljs-params">sessionId</span>) =&gt;</span> {   
        transports.<span class="hljs-property">streamable</span>[sessionId] = transport    
      }
   })
    
   <span class="hljs-comment">// 连接关闭时清理掉这个 session </span>
   transport.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> {    
     <span class="hljs-keyword">if</span> (transport.<span class="hljs-property">sessionId</span>) {  
       <span class="hljs-keyword">delete</span> transports.<span class="hljs-property">streamable</span>[transport.<span class="hljs-property">sessionId</span>] 
       opsLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`[Streamable] 删除sessionId: username=<span class="hljs-subst">${username}</span> sessionId=<span class="hljs-subst">${transport.sessionId}</span>`</span>)    
     }
   }
   
   <span class="hljs-keyword">const</span> server = <span class="hljs-title function_">buildMcpServer</span>({  
     ...config,   
     <span class="hljs-attr">transport</span>: <span class="hljs-string">'streamable-http'</span>   
   })
   
   <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">connect</span>(transport) 
 } <span class="hljs-keyword">else</span> { 
   <span class="hljs-comment">// 既不是初始化，又没有合法 sessionId：直接返回错误   </span>
   res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>({  
     <span class="hljs-attr">jsonrpc</span>: <span class="hljs-string">'2.0'</span>,   
     <span class="hljs-attr">error</span>: {   
       <span class="hljs-attr">code</span>: -<span class="hljs-number">32000</span>,  
       <span class="hljs-attr">message</span>: <span class="hljs-string">'Bad Request: No valid session ID provided'</span>    
     },
     <span class="hljs-attr">id</span>: <span class="hljs-literal">null</span>  
   })   
   <span class="hljs-keyword">return</span>  
  }
  
  <span class="hljs-keyword">await</span> transport.<span class="hljs-title function_">handleRequest</span>(req, res, req.<span class="hljs-property">body</span>)
}
</code></pre>
<p>配合一个统一的会话请求入口：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">handleSessionRequest</span>(<span class="hljs-params">req: Request, res: Response</span>)</span>{  
  <span class="hljs-keyword">const</span> sessionId = req.headers[<span class="hljs-string">'mcp-session-id'</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span> | <span class="hljs-function">undefined  
  <span class="hljs-title">if</span> (<span class="hljs-params">!sessionId || !transports.streamable[sessionId]</span>)</span> { 
    res.status(<span class="hljs-number">400</span>).send(<span class="hljs-string">'Invalid or missing session ID'</span>)   
    <span class="hljs-keyword">return</span> 
  }
  
  <span class="hljs-keyword">const</span> transport = transports.streamable[sessionId]  
  <span class="hljs-keyword">await</span> transport.handleRequest(req, res)}
</code></pre>
<p>这样实现的好处是：客户端只需要记住一个 mcp-session-id，之后所有请求都可以复用同一条 Streamable HTTP 会话。</p>
<p><strong>buildMcpServer：真正把“工具注册到 MCP 协议”</strong></p>
<p>首先，用户可以将云函数平台创建的智能体工具代理到MCP协议上，一个MCP可以关联多个工具</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd6378fecd66456ab1223de01e0bfd3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=zwA6XxmY7bHCl9wLE6pJI17L0wg%3D" alt="图片" loading="lazy"/></p>
<p>接下来是最关键的一步：用官方 McpServer 把 Tool Registry 里的工具挂成 MCP Tool。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildMcpServer</span>(<span class="hljs-params">config: BuildMcpServerConfig</span>): <span class="hljs-title class_">McpServer</span> {
  <span class="hljs-keyword">const</span> { name, tools, cookie, env, id, <span class="hljs-keyword">type</span>, username, transport } = config
  
  <span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">McpServer</span>({  
    name, 
    <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span> 
  })
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> tool <span class="hljs-keyword">of</span> tools) { 
    <span class="hljs-comment">// 1）把数据库里的元信息，转成 DynamicStructuredTool 入参</span>
    <span class="hljs-keyword">const</span> obj = {      
      <span class="hljs-attr">name</span>: tool.<span class="hljs-property">name</span>,
      <span class="hljs-attr">description</span>: tool.<span class="hljs-property">description</span>,  
      <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>(<span class="hljs-title function_">convertSchemaToZod</span>(tool.<span class="hljs-property">schema</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span> | <span class="hljs-built_in">object</span>)),      
      <span class="hljs-attr">code</span>: tool.<span class="hljs-property">func</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>  
    }
    
    <span class="hljs-comment">// DynamicStructuredTool 内部就是一个“动态 StructuredTool” + NodeVM 沙箱</span>
    <span class="hljs-keyword">const</span> dynamicStructuredTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>(obj)
    
    <span class="hljs-comment">// Flow 信息：cookie + env（来自 MCP URL 上的 sign / 其它query)</span>
    dynamicStructuredTool.<span class="hljs-title function_">setFlowObject</span>({ 
      cookie,  
      <span class="hljs-attr">env</span>: <span class="hljs-keyword">typeof</span> env === <span class="hljs-string">'object'</span> &amp;&amp; <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(env).<span class="hljs-property">length</span> ? env : {}   
    })
    
    <span class="hljs-comment">// 2）把我们在 UI 里配置的 Tool Arguments schema，转成 MCP 需要的 zod 参数定义 </span>
    <span class="hljs-keyword">const</span> schemaParser = (tool.<span class="hljs-property">schema</span> ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(tool.<span class="hljs-property">schema</span>) : []) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Schema</span>[]
    
    <span class="hljs-keyword">const</span> paramsSchema = schemaParser.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">res, cur</span>) =&gt;</span> {  
      <span class="hljs-keyword">if</span> (cur.<span class="hljs-property">required</span>) { 
        res[cur.<span class="hljs-property">property</span>] = z[cur.<span class="hljs-property">type</span>]({ <span class="hljs-attr">required_error</span>: <span class="hljs-string">`<span class="hljs-subst">${cur.property}</span> required`</span> })   
          .<span class="hljs-title function_">describe</span>(cur.<span class="hljs-property">description</span>) <span class="hljs-keyword">as</span> z.<span class="hljs-property">ZodTypeAny</span>   
      } <span class="hljs-keyword">else</span> {   
        res[cur.<span class="hljs-property">property</span>] = z[cur.<span class="hljs-property">type</span>]()   
          .<span class="hljs-title function_">describe</span>(cur.<span class="hljs-property">description</span>)     
          .<span class="hljs-title function_">optional</span>() <span class="hljs-keyword">as</span> z.<span class="hljs-property">ZodTypeAny</span>    
      }
      <span class="hljs-keyword">return</span> res   
    }, {} <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)
    
    <span class="hljs-comment">// 3）用官方 server.tool() 方法注册 MCP Tool </span>
    server.<span class="hljs-title function_">tool</span>(tool.<span class="hljs-property">name</span>, tool.<span class="hljs-property">description</span>, paramsSchema, <span class="hljs-keyword">async</span> (args, _extra) =&gt; {   
      <span class="hljs-comment">// 注意：这里的 call() 对应的就是 LangChain StructuredTool._call()  </span>
      <span class="hljs-keyword">const</span> runnerResult = <span class="hljs-keyword">await</span> dynamicStructuredTool.<span class="hljs-title function_">call</span>({  
        ...args
      })
      
      <span class="hljs-comment">// 线上环境做一层使用上报（方便统计谁在用哪个 MCP）</span>
      <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">DEPLOY_ENV</span> === <span class="hljs-string">'prod'</span>) {   
        <span class="hljs-title function_">reportMcpUse</span>({   
          id,  
          <span class="hljs-keyword">type</span>,   
          name,   
          username,  
          transport  
        })   
       }
       
       <span class="hljs-comment">// MCP 协议统一的返回格式：content[] 数组  </span>
       <span class="hljs-keyword">return</span> {    
         <span class="hljs-attr">content</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attr">text</span>: runnerResult }]  
       }
     })
   }
   
   <span class="hljs-keyword">return</span> server
 }
</code></pre>
<p>把Tool Registry 里的：</p>
<ul>
<li>
<p>name</p>
</li>
<li>
<p>description</p>
</li>
<li>
<p>schema（以数组 JSON 形式存）</p>
</li>
<li>
<p>func（在线编辑器里的 JS 代码）</p>
</li>
</ul>
<p>按 MCP 需要的格式做了一层映射：</p>
<ul>
<li>
<p>输入 → paramsSchema（zod 校验）</p>
</li>
<li>
<p>执行 → dynamicStructuredTool.call()</p>
</li>
<li>
<p>输出 → MCP 标准的 content[{ type: 'text', text: ... }]</p>
</li>
</ul>
<p>StructuredTool 内部：从 MCP 入参到 NodeVM 执行的最后一步</p>
<p>DynamicStructuredTool.call() 里面最终会走到 _call()，这一步就是前面介绍的 NodeVM 沙箱执行：</p>
<ul>
<li>
<p>把 MCP 传进来的参数变成 $xxx 变量</p>
</li>
<li>
<p>把 cookie / env、以及会话信息塞进 $flow</p>
</li>
<li>
<p>注入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mi>u</mi><mi>u</mi><mi>m</mi><mi>i</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">yuumi、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">uu</span><span class="mord mathnormal">mi</span><span class="mord cjk_fallback">、</span></span></span></span></span>json2MarkdownTable、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>i</mi><mi>l</mi><mi>i</mi><mi>I</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>x</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">biliIndex、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord cjk_fallback">、</span></span></span></span></span>deepseek、$chatgpt 等能力</p>
</li>
<li>
<p>在受限依赖白名单下创建 NodeVM</p>
</li>
<li>
<p>以 module.exports = async function() { ${this.code} }() 的形式执行开发者写的 JS</p>
</li>
</ul>
<p>对于上层 MCP 调用方来说：</p>
<blockquote>
<p>调用了一个名字叫 QueryLiveRoomInfo 的 MCP 工具，传了一些参数，收到了一个文本/Markdown 结果</p>
</blockquote>
<p>而对于我们平台来说，这中间其实已经执行了一整套：</p>
<blockquote>
<p>MCP → McpServer.tool → DynamicStructuredTool → NodeVM → 内网服务的完整链路。</p>
</blockquote>
<p><strong>可复用可共享的MCP市场</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ed971fdf5df4a2ab0be5684d57c01e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=Txis9r1N0n1kXq8%2F5QLbV1L1T%2Bs%3D" alt="图片" loading="lazy"/></p>
<p>对于 MCP 新手，我们在平台上还提供了“MCP 市场” 的入口，里面还提供了一键调试：</p>
<ul>
<li>
<p>不需要真的连上一个大模型</p>
</li>
<li>
<p>直接在浏览器里模拟一次 MCP ToolCall</p>
</li>
<li>
<p>看看云函数有没有跑对、返回是不是 AI 友好的格式</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dce174203064e108bcdb39c92288af8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=%2FV0T98v4oJyRcUTStOEOPSyN3tE%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-16"><strong>六、身份鉴权：MCP 是独立服务，安全必须先想清楚</strong></h2>
<p>MCP 本质上是一个“跨平台的服务访问入口”，如果不做鉴权，很容易变成无法管理。我们的做法大致是这样：</p>
<ol>
<li> 注册阶段就要带 sign：</li>
</ol>
<ul>
<li>每个 MCP 工具的注册地址必须带一个 sign 参数</li>
<li>sign 是基于内网规范签出的签名</li>
<li>没有合法签名，工具不会被注册成功</li>
</ul>
<ol start="2">
<li> 调用阶段统一 Proxy：</li>
</ol>
<ul>
<li>外部 Agent 调用 MCP Server</li>
<li>MCP Server 把调用转发给云函数平台的 Proxy 层</li>
<li>Proxy 层会：</li>
</ul>

<ul>
<li>校验 sign</li>
<li>注入对应的 $cookie / 会话</li>
<li>再去调真正的内网业务接口</li>
</ul>
<ol start="3">
<li> 业务侧拿到的是“处理后的内网协议”：</li>
</ol>
<ul>
<li>
<p>Proxy 会把 sign 解密、校验后，以内部统一格式透传给业务</p>
</li>
<li>
<p>避免在业务里掺杂各种外部协议细节</p>
</li>
</ul>
<p>这样，MCP 既可以对外暴露统一的工具接口，又仍然受控在内网的安全体系内</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e5f2ebf9d4142d4bc94d958b15b1ddc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=l%2F1ltMpqyWMkMgGXyElyZedDkM4%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-17"><strong>七、结语：把“接 AI”变成“写一个云函数”</strong></h2>
<p>从 AI工作流 → StructuredTool → 云函数平台 → MCP 的这条路径，我们最终得到了：</p>
<ul>
<li>
<p>一个统一的工具定义方式：元信息</p>
</li>
<li>
<p>一个统一的执行方式：NodeVM</p>
</li>
<li>
<p>一个统一的调用协议：MCP</p>
</li>
<li>
<p>一个统一的共享方式：工具市场</p>
</li>
<li>
<p>一个统一的安全体系：sign + cookie</p>
</li>
</ul>
<p>也让我们真正做到了：</p>
<p>让业务同学不再关心“怎么接 AI”，而是只需要关心“我能给 AI 提供什么能力”。</p>
<p>把写一个 JS 函数，变成给 AI 加一个新能力。</p>
<p>未来我们还会继续提升运行时性能、正确性评估观测、深度研究等方向，把工具能力建设得更现代、更企业级。</p>
<p>-End-</p>
<p>作者丨Zerooo、Gengar</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么按 Ctrl+D 会退出终端？—— 从电传打字机到现代 macOS 的完整旅程]]></title>    <link>https://juejin.cn/post/7582786655472795691</link>    <guid>https://juejin.cn/post/7582786655472795691</guid>    <pubDate>2025-12-12T08:47:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582786655472795691" data-draft-id="7582637280218021942" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么按 Ctrl+D 会退出终端？—— 从电传打字机到现代 macOS 的完整旅程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-12T08:47:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="shengjk1"/> <meta itemprop="url" content="https://juejin.cn/user/2647279732524957"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么按 Ctrl+D 会退出终端？—— 从电传打字机到现代 macOS 的完整旅程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2647279732524957/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    shengjk1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:47:40.000Z" title="Fri Dec 12 2025 08:47:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="gruvbox-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#282828}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#ebdbb2}.hljs-deletion,.hljs-formula,.hljs-keyword,.hljs-link,.hljs-selector-tag{color:#fb4934}.hljs-built_in,.hljs-emphasis,.hljs-name,.hljs-quote,.hljs-strong,.hljs-title,.hljs-variable{color:#83a598}.hljs-attr,.hljs-params,.hljs-template-tag,.hljs-type{color:#fabd2f}.hljs-builtin-name,.hljs-doctag,.hljs-literal,.hljs-number{color:#8f3f71}.hljs-code,.hljs-meta,.hljs-regexp,.hljs-selector-id,.hljs-template-variable{color:#fe8019}.hljs-addition,.hljs-meta-string,.hljs-section,.hljs-selector-attr,.hljs-selector-class,.hljs-string,.hljs-symbol{color:#b8bb26}.hljs-attribute,.hljs-bullet,.hljs-class,.hljs-function,.hljs-function .hljs-keyword,.hljs-meta-keyword,.hljs-selector-pseudo,.hljs-tag{color:#8ec07c}.hljs-comment{color:#928374}.hljs-link_label,.hljs-literal,.hljs-number{color:#d3869b}.hljs-comment,.hljs-emphasis{font-style:italic}.hljs-section,.hljs-strong,.hljs-tag{font-weight:700}</style><p>你好，我是 shengjk1，多年大厂经验，努力构建 通俗易懂的、好玩的编程语言教程。 欢迎关注！你会有如下收益：</p>
<ol>
<li>了解大厂经验</li>
<li>拥有和大厂相匹配的技术等</li>
</ol>
<p>希望看什么，评论或者私信告诉我！</p>
<p>你有没有想过：</p>
<blockquote>
<p><strong>为什么在终端里按 <code>Ctrl+D</code>，程序就会收到“文件结束”（EOF）信号并退出？</strong></p>
</blockquote>
<p>这看似简单的行为，背后却隐藏着一段跨越 <strong>60 年的操作系统演进史</strong>。从纸带打字机到 macOS 的 Terminal，从物理串口到内核中的 TTY 子系统，<code>Ctrl+D</code> 的故事，正是 Unix “一切皆文件”哲学的缩影。</p>
<p>本文将带你一步步揭开这个谜题。</p>
<hr/>
<h2 data-id="heading-0">一、起源：电传打字机与 ASCII 控制字符</h2>
<p>时间回到 1960 年代。那时没有显示器，程序员通过 <strong>电传打字机（Teletypewriter, 简称 TTY）</strong> 与计算机交互：</p>
<ul>
<li>有键盘用于输入</li>
<li>有打印头在纸上输出结果</li>
<li>通过串行线连接主机</li>
</ul>
<p>这些设备使用 <strong>ASCII 编码</strong>通信。其中，前 32 个字符是<strong>控制字符</strong>，不表示可见文字，而是用于控制设备行为。</p>
<p>其中第 4 个字符是：</p>
<blockquote>
<p><strong>EOT（End of Transmission）</strong>，ASCII 码为 <code>0x04</code></p>
</blockquote>
<p>在电报和早期通信协议中，EOT 表示“本次传输结束”。而在键盘上，如何输入 ASCII 4？<br/>
答案是：<strong><code>Ctrl + D</code></strong><br/>
（因为 <code>D</code> 是字母表第 4 个字母，<code>Ctrl + 字母</code> = 该字母序号对应的控制码）</p>
<p>于是，<code>Ctrl+D</code> 与 “结束” 建立了最初的联系。</p>
<hr/>
<h2 data-id="heading-1">二、原理：EOF 不是一个字符，而是一种行为</h2>
<p>很多人误以为 <code>Ctrl+D</code> 发送了一个叫 “EOF 字符” 的东西。<br/>
<strong>这是错的。</strong></p>
<p>真相是：</p>
<blockquote>
<p><strong><code>Ctrl+D</code> 是一个控制信号，它触发终端驱动（TTY）执行特定行为：</strong></p>
<ul>
<li>如果当前输入缓冲区<strong>非空</strong> → 立即将已有内容提交给程序（即使没按回车）</li>
<li>如果缓冲区<strong>为空</strong> → 向程序返回 <code>read()</code> = 0，表示 EOF</li>
</ul>
</blockquote>
<p>在 Java、Python、C 等语言中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> reader.readLine(); <span class="hljs-comment">// 若用户直接按 Ctrl+D，line == null</span>
</code></pre>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">ssize_t</span> n = read(<span class="hljs-number">0</span>, buf, size); <span class="hljs-comment">// n == 0 表示 EOF</span>
</code></pre>
<p>所以，<strong>EOF 是 I/O 接口的语义，不是数据流中的一个字节</strong>。</p>
<hr/>
<h2 data-id="heading-2">三、图形时代：伪终端（PTY）登场</h2>
<p>进入 1980 年代后，图形界面兴起。我们不再使用物理 TTY，而是打开 <strong>Terminal Emulator</strong>（如 iTerm2、GNOME Terminal）。</p>
<p>问题来了：</p>
<blockquote>
<p><strong>如何让一个图形程序，模拟出传统 TTY 的行为？</strong></p>
</blockquote>
<p>答案是：<strong>伪终端（Pseudo-TTY, PTY）</strong></p>
<h3 data-id="heading-3">PTY 的结构</h3>
<p>内核提供一对虚拟设备：</p>
<ul>
<li><strong>Slave 端</strong>（如 <code>/dev/ttys003</code>）：给 shell 或你的程序使用，<strong>完全兼容传统 TTY</strong></li>
<li><strong>Master 端</strong>：给 Terminal Emulator 使用，用于收发原始字节流</li>
</ul>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------+       +------------------+</span>
| Terminal         |       | Your Program     |
| Emulator         |       | (e.g., bash)     |
| (User Space)     |       | (User Space)     |
+<span class="hljs-comment">--------+---------+       +--------+---------+</span>
         |                            |
         | <span class="hljs-built_in">write</span>(master)              | <span class="hljs-built_in">read</span>(slave)
         ↓                            ↑
+<span class="hljs-comment">--------+----------------------------+---------+</span>
|            Kernel TTY Subsystem               |
|        +<span class="hljs-comment">--------------------------+           |</span>
|        | PTY Driver               |           |
|        | - Master <span class="hljs-keyword">end</span>             |           |
|        | - Slave <span class="hljs-keyword">end</span> (/dev/ttys003)|           |
|        +<span class="hljs-comment">--------------------------+           |</span>
+<span class="hljs-comment">------------------------------------------------+</span>
</code></pre>
<p>当你在 Terminal 中按 <code>Ctrl+D</code>：</p>
<ol>
<li>Terminal Emulator 将字节 <code>0x04</code> 写入 PTY master</li>
<li>内核 TTY 驱动收到后，<strong>在 slave 端触发 EOF 行为</strong></li>
<li>你的程序调用 <code>read()</code> 返回 0，<code>BufferedReader.readLine()</code> 返回 <code>null</code></li>
<li>程序退出循环，REPL 结束</li>
</ol>
<blockquote>
<p>✅ 整个过程对程序透明——它以为自己连着一台 VT100！</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">四、一条 <code>Ctrl+D</code> 的旅程</h2>
<p>让我们完整走一遍 <code>Ctrl+D</code> 的生命周期：</p>
<ol>
<li><strong>你按下 <code>Ctrl+D</code></strong> → 键盘生成 ASCII <code>0x04</code>（EOT）</li>
<li><strong>Terminal Emulator</strong>（如 iTerm2）将 <code>0x04</code> 写入 PTY master 端</li>
<li><strong>内核 TTY 子系统</strong> 收到后，检查 slave 端输入缓冲区
<ul>
<li>若为空 → 标记下一次 <code>read()</code> 返回 0</li>
</ul>
</li>
<li><strong>你的程序</strong>（如 Java REPL）调用 <code>readLine()</code>
<ul>
<li>底层 <code>read()</code> 返回 0</li>
<li><code>readLine()</code> 返回 <code>null</code></li>
</ul>
</li>
<li><strong>程序判断 <code>line == null</code>，退出循环</strong></li>
<li><strong>REPL 结束，回到 shell</strong></li>
</ol>
<p>整个过程跨越了：</p>
<ul>
<li>用户空间（GUI）</li>
<li>系统调用（<code>write</code>, <code>read</code>）</li>
<li>内核 TTY 驱动</li>
<li>POSIX I/O 语义</li>
</ul>
<p>而这一切，始于一台会咔嗒作响的纸带打字机。</p>
<hr/>
<h2 data-id="heading-5">五、结语</h2>
<p><code>Ctrl+D</code> 看似微不足道，却是 Unix 设计哲学的完美体现：</p>
<blockquote>
<p><strong>用简单的抽象，解决复杂的兼容性问题，并经受住半个世纪的考验。</strong></p>
</blockquote>
<p>下次当你按下 <code>Ctrl+D</code> 退出 Python REPL 时，不妨想一想：<br/>
你正在与 1971 年的 Ken Thompson 握手。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[App HTTPS 抓包实战解析，从代理调试到真实网络流量观察的完整抓包思路]]></title>    <link>https://juejin.cn/post/7582785032851324991</link>    <guid>https://juejin.cn/post/7582785032851324991</guid>    <pubDate>2025-12-12T08:55:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582785032851324991" data-draft-id="7582561515817615423" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="App HTTPS 抓包实战解析，从代理调试到真实网络流量观察的完整抓包思路"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-12T08:55:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心猴爷"/> <meta itemprop="url" content="https://juejin.cn/user/2179705232165364"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            App HTTPS 抓包实战解析，从代理调试到真实网络流量观察的完整抓包思路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179705232165364/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心猴爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:55:41.000Z" title="Fri Dec 12 2025 08:55:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动应用开发、接口联调、线上问题排查以及网络性能分析中，<strong>App HTTPS 抓包</strong> 几乎是每个开发者都会遇到的需求。但真正上手之后，很多人会发现：
同样是 HTTPS，请求在浏览器里很好抓，到了 App 里却“消失”了。</p>
<p>常见现象包括：</p>
<ul>
<li>代理工具没有任何请求</li>
<li>只能看到 CONNECT，看不到内容</li>
<li>某些接口能抓，某些完全抓不到</li>
<li>WebView 和原生接口表现不一致</li>
<li>iOS / Android 行为差异明显</li>
<li>网络正常，但抓包工具毫无反应</li>
</ul>
<p>这并不是配置问题，而是 <strong>App HTTPS 抓包本身就比 Web 抓包复杂得多</strong>。本文将从工程角度系统拆解 App HTTPS 抓包的常见场景、失败原因和解决路径</p>
<hr/>
<h2 data-id="heading-0">一、为什么 App HTTPS 抓包比 Web 抓包难？</h2>
<hr/>
<h3 data-id="heading-1"><strong>App 并不一定走系统代理</strong></h3>
<p>很多 App：</p>
<ul>
<li>使用独立网络库</li>
<li>在启动时读取代理配置后自行处理</li>
<li>或直接忽略系统代理</li>
</ul>
<p>结果就是：
浏览器能被 Charles / Fiddler 抓到，而 App 完全无流量。</p>
<hr/>
<h3 data-id="heading-2"><strong>HTTPS 加密 + 安全策略更严格</strong></h3>
<p>相比浏览器，App 更常见：</p>
<ul>
<li>证书校验更严格</li>
<li>禁止自签证书</li>
<li>使用证书 Pinning</li>
</ul>
<p>这会导致代理抓包工具直接失效。</p>
<hr/>
<h3 data-id="heading-3"><strong>App 中的 WebView 行为不统一</strong></h3>
<ul>
<li>有的 WebView 走系统代理</li>
<li>有的使用独立网络栈</li>
<li>有的 SDK 内部完全接管请求</li>
</ul>
<p>这也是“同一个 App，不同页面抓包表现不同”的原因。</p>
<hr/>
<h3 data-id="heading-4"><strong>HTTP/3（QUIC）在 App 中越来越普遍</strong></h3>
<p>QUIC 使用 UDP 443：</p>
<ul>
<li>绕过 TCP 代理</li>
<li>Charles / Fiddler 无法处理</li>
<li>抓包表现为“什么都没有”</li>
</ul>
<hr/>
<h2 data-id="heading-5">二、常见 App HTTPS 抓包工具及其边界</h2>
<hr/>
<h3 data-id="heading-6"><strong>① 代理抓包工具（应用层）</strong></h3>
<p>代表工具：</p>
<ul>
<li>Charles</li>
<li>Fiddler</li>
<li>Proxyman</li>
</ul>
<p>适合：</p>
<ul>
<li>常规 API 调试</li>
<li>请求参数分析</li>
<li>响应内容查看</li>
</ul>
<p>局限：</p>
<ul>
<li>无法处理 Pinning</li>
<li>无法处理 QUIC</li>
<li>无法覆盖不走代理的 App</li>
</ul>
<hr/>
<h3 data-id="heading-7"><strong>② 协议分析工具（网络层）</strong></h3>
<p>工具：</p>
<ul>
<li>Wireshark</li>
<li>tcpdump</li>
</ul>
<p>能力：</p>
<ul>
<li>查看 TLS 握手</li>
<li>判断 TCP/UDP 行为</li>
<li>分析丢包、重传</li>
</ul>
<p>不足：</p>
<ul>
<li>噪音极多</li>
<li>难以按 App 过滤</li>
<li>不适合日常调试</li>
</ul>
<hr/>
<h3 data-id="heading-8"><strong>③ 底层数据流捕获工具（补抓层）</strong></h3>
<p>当代理完全抓不到 App HTTPS 请求时，就必须使用底层捕获工具。</p>
<p>这正是 <strong>抓包大师（Sniffmaster）</strong> 所在的工具层。</p>
<hr/>
<h2 data-id="heading-9">三、Sniffmaster 在 App HTTPS 抓包中的技术定位</h2>
<p>Sniffmaster 并不是代理工具，它提供的是 <strong>真实网络数据流捕获能力</strong>，用于弥补代理抓包的盲区。</p>
<h3 data-id="heading-10"><strong>核心能力概览</strong></h3>
<ul>
<li>捕获 HTTPS / HTTP</li>
<li>捕获 TCP / UDP</li>
<li>支持 QUIC / HTTP3 流量识别</li>
<li>支持 WebSocket、自定义协议</li>
<li>按 App 过滤流量，减少系统噪音</li>
<li>多格式查看（文本 / HEX / 二进制）</li>
<li>支持 JavaScript 拦截器（非 pinning 场景）</li>
<li>支持导出 pcap，用于 Wireshark 深度分析</li>
<li>跨平台支持 macOS / Windows / iOS</li>
</ul>
<p>在 App HTTPS 抓包中，它承担的是 <strong>“是否真的发出了请求”</strong> 和 <strong>“请求在网络层发生了什么”</strong> 的确认角色。</p>
<hr/>
<h2 data-id="heading-11">四、App HTTPS 抓包失败的典型场景与应对方式</h2>
<hr/>
<h3 data-id="heading-12"><strong>场景 1：代理工具完全抓不到包</strong></h3>
<p>可能原因：</p>
<ul>
<li>App 不走系统代理</li>
<li>使用私有网络栈</li>
<li>被 VPN 或安全组件接管</li>
</ul>
<p>应对方式：</p>
<ul>
<li>使用 Sniffmaster 捕获底层流量</li>
<li>按 App 名称过滤请求</li>
</ul>
<hr/>
<h3 data-id="heading-13"><strong>场景 2：只能看到 CONNECT，看不到 HTTPS 内容</strong></h3>
<p>可能原因：</p>
<ul>
<li>证书未完全信任</li>
<li>App 校验了证书链</li>
</ul>
<p>解决思路：</p>
<ul>
<li>若是证书问题，修正证书信任</li>
<li>若是 Pinning，只能分析 TLS 握手与流量行为</li>
</ul>
<hr/>
<h3 data-id="heading-14"><strong>场景 3：部分接口抓不到</strong></h3>
<p>常见原因：</p>
<ul>
<li>某些请求走 QUIC</li>
<li>某些走 TCP</li>
</ul>
<p>Sniffmaster 可帮助确认：</p>
<ul>
<li>是否存在 UDP 443</li>
<li>是否启用了 HTTP/3</li>
</ul>
<hr/>
<h3 data-id="heading-15"><strong>场景 4：WebView 请求消失</strong></h3>
<p>说明：</p>
<ul>
<li>WebView 没有走系统代理</li>
</ul>
<p>Sniffmaster 仍可捕获 WebView 产生的真实网络流量。</p>
<hr/>
<h3 data-id="heading-16"><strong>场景 5：返回异常，但后端无日志</strong></h3>
<p>通过底层抓包可以判断：</p>
<ul>
<li>请求是否真的发出</li>
<li>是否在网络层被重置</li>
<li>TLS 是否在握手阶段失败</li>
</ul>
<hr/>
<h2 data-id="heading-17">五、推荐的 App HTTPS 抓包完整流程（工程实践）</h2>
<hr/>
<h3 data-id="heading-18"><strong>Step 1：优先使用代理抓包</strong></h3>
<p>用于日常接口调试。</p>
<hr/>
<h3 data-id="heading-19"><strong>Step 2：代理抓不到时，不要反复折腾配置</strong></h3>
<p>直接判断：</p>
<ul>
<li>是否 Pinning</li>
<li>是否 QUIC</li>
<li>是否不走代理</li>
</ul>
<hr/>
<h3 data-id="heading-20"><strong>Step 3：使用 Sniffmaster 抓底层流量</strong></h3>
<p>操作思路：</p>
<ol>
<li>选择目标 App</li>
<li>开启数据流捕获</li>
<li>查看是否有 TCP / UDP 请求</li>
<li>识别 HTTPS / QUIC 行为</li>
<li>必要时导出 pcap</li>
</ol>
<hr/>
<h3 data-id="heading-21"><strong>Step 4：结合 Wireshark 做协议级分析</strong></h3>
<p>用于：</p>
<ul>
<li>TLS alert 判断</li>
<li>TCP 重传分析</li>
<li>QUIC 握手确认</li>
</ul>
<hr/>
<h2 data-id="heading-22">App HTTPS 抓包的合理工具组合</h2>

























<table><thead><tr><th>层级</th><th>工具</th><th>作用</th></tr></thead><tbody><tr><td>代理层</td><td>Charles / Fiddler</td><td>明文 HTTPS 调试</td></tr><tr><td>协议层</td><td>Wireshark</td><td>TLS / TCP / QUIC 分析</td></tr><tr><td>底层补抓层</td><td>抓包大师（Sniffmaster**）**</td><td>捕获真实 App 网络流量</td></tr></tbody></table>
<p>这是当前最稳妥的 App HTTPS 抓包体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTML + CSS 终极面试全攻略（八股文 + 场景题 + 工程落地）]]></title>    <link>https://juejin.cn/post/7582777037863223346</link>    <guid>https://juejin.cn/post/7582777037863223346</guid>    <pubDate>2025-12-12T08:59:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582777037863223346" data-draft-id="7582763878674120731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTML + CSS 终极面试全攻略（八股文 + 场景题 + 工程落地）"/> <meta itemprop="keywords" content="前端,面试,JavaScript"/> <meta itemprop="datePublished" content="2025-12-12T08:59:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="豆苗学前端"/> <meta itemprop="url" content="https://juejin.cn/user/1935598759719400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTML + CSS 终极面试全攻略（八股文 + 场景题 + 工程落地）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1935598759719400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    豆苗学前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:59:45.000Z" title="Fri Dec 12 2025 08:59:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>定位：不仅能回答“是什么”，还能讲清楚“为什么、怎么落地、踩过哪些坑”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">目录</h2>
<ul>
<li><a href="#1-html-%E7%AF%87" title="#1-html-%E7%AF%87">1. HTML 篇</a>
<ul>
<li><a href="#11-%E8%AF%AD%E4%B9%89%E5%8C%96semantic-html" title="#11-%E8%AF%AD%E4%B9%89%E5%8C%96semantic-html">1.1 语义化（Semantic HTML）</a></li>
<li><a href="#12-%E5%9D%97%E7%BA%A7%E8%A1%8C%E5%86%85%E8%A1%8C%E5%86%85%E5%9D%97" title="#12-%E5%9D%97%E7%BA%A7%E8%A1%8C%E5%86%85%E8%A1%8C%E5%86%85%E5%9D%97">1.2 块级/行内/行内块</a></li>
<li><a href="#13-script-%E7%9A%84-async--defer-%E5%8C%BA%E5%88%AB" title="#13-script-%E7%9A%84-async--defer-%E5%8C%BA%E5%88%AB">1.3 <code>script</code> 的 <code>async</code> / <code>defer</code> 区别</a></li>
<li><a href="#14-meta-viewport" title="#14-meta-viewport">1.4 <code>meta viewport</code></a></li>
<li><a href="#15-img-%E7%9A%84-alt%E6%87%92%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%9B%BE%E7%89%87%E6%80%A7%E8%83%BD" title="#15-img-%E7%9A%84-alt%E6%87%92%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%9B%BE%E7%89%87%E6%80%A7%E8%83%BD">1.5 <code>img</code> 的 <code>alt</code>、懒加载与图片性能</a></li>
<li><a href="#16-%E8%A1%A8%E5%8D%95%E4%B8%8E%E5%8F%AF%E8%AE%BF%E9%97%AE%E6%80%A7a11y" title="#16-%E8%A1%A8%E5%8D%95%E4%B8%8E%E5%8F%AF%E8%AE%BF%E9%97%AE%E6%80%A7a11y">1.6 表单与可访问性（A11y）</a></li>
</ul>
</li>
<li><a href="#2-css-%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%8E%9F%E7%90%86%E7%AF%87" title="#2-css-%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%8E%9F%E7%90%86%E7%AF%87">2. CSS 基础与原理篇</a>
<ul>
<li><a href="#21-%E9%80%89%E6%8B%A9%E5%99%A8%E4%BC%98%E5%85%88%E7%BA%A7specificity" title="#21-%E9%80%89%E6%8B%A9%E5%99%A8%E4%BC%98%E5%85%88%E7%BA%A7specificity">2.1 选择器优先级（Specificity）</a></li>
<li><a href="#22-%E7%9B%92%E6%A8%A1%E5%9E%8B%E4%B8%8E-box-sizing" title="#22-%E7%9B%92%E6%A8%A1%E5%9E%8B%E4%B8%8E-box-sizing">2.2 盒模型与 <code>box-sizing</code></a></li>
<li><a href="#23-bfc%E5%9D%97%E7%BA%A7%E6%A0%BC%E5%BC%8F%E5%8C%96%E4%B8%8A%E4%B8%8B%E6%96%87" title="#23-bfc%E5%9D%97%E7%BA%A7%E6%A0%BC%E5%BC%8F%E5%8C%96%E4%B8%8A%E4%B8%8B%E6%96%87">2.3 BFC（块级格式化上下文）</a></li>
<li><a href="#24-%E6%B5%AE%E5%8A%A8%E4%B8%8E%E6%B8%85%E9%99%A4%E6%B5%AE%E5%8A%A8" title="#24-%E6%B5%AE%E5%8A%A8%E4%B8%8E%E6%B8%85%E9%99%A4%E6%B5%AE%E5%8A%A8">2.4 浮动与清除浮动</a></li>
<li><a href="#25-positionrelativeabsolutefixedsticky" title="#25-positionrelativeabsolutefixedsticky">2.5 <code>position</code>：relative/absolute/fixed/sticky</a></li>
<li><a href="#26-flexflex-1%E5%8E%8B%E7%BC%A9%E6%BA%A2%E5%87%BA%E4%B8%8E-min-width-0" title="#26-flexflex-1%E5%8E%8B%E7%BC%A9%E6%BA%A2%E5%87%BA%E4%B8%8E-min-width-0">2.6 Flex：<code>flex: 1</code>、压缩、溢出与 <code>min-width: 0</code></a></li>
<li><a href="#27-grid%E4%BA%8C%E7%BB%B4%E5%B8%83%E5%B1%80%E5%8A%A0%E5%88%86%E9%A1%B9" title="#27-grid%E4%BA%8C%E7%BB%B4%E5%B8%83%E5%B1%80%E5%8A%A0%E5%88%86%E9%A1%B9">2.7 Grid：二维布局加分项</a></li>
<li><a href="#28-%E5%B8%B8%E8%A7%81%E5%B1%85%E4%B8%AD%E6%96%B9%E6%A1%88" title="#28-%E5%B8%B8%E8%A7%81%E5%B1%85%E4%B8%AD%E6%96%B9%E6%A1%88">2.8 常见居中方案</a></li>
<li><a href="#29-z-index-%E4%B8%8E%E5%B1%82%E5%8F%A0%E4%B8%8A%E4%B8%8B%E6%96%87stacking-context" title="#29-z-index-%E4%B8%8E%E5%B1%82%E5%8F%A0%E4%B8%8A%E4%B8%8B%E6%96%87stacking-context">2.9 <code>z-index</code> 与层叠上下文（Stacking Context）</a></li>
<li><a href="#210-%E7%BB%A7%E6%89%BF%E5%B1%82%E5%8F%A0%E8%AE%A1%E7%AE%97%E5%80%BCcss-%E4%B8%89%E6%9D%BF%E6%96%A7" title="#210-%E7%BB%A7%E6%89%BF%E5%B1%82%E5%8F%A0%E8%AE%A1%E7%AE%97%E5%80%BCcss-%E4%B8%89%E6%9D%BF%E6%96%A7">2.10 继承、层叠、计算值（CSS 三板斧）</a></li>
<li><a href="#211-%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8D%95%E4%BD%8D%E4%B8%8E%E5%AA%92%E4%BD%93%E6%9F%A5%E8%AF%A2" title="#211-%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8D%95%E4%BD%8D%E4%B8%8E%E5%AA%92%E4%BD%93%E6%9F%A5%E8%AF%A2">2.11 响应式单位与媒体查询</a></li>
<li><a href="#212-transition-vs-animation-%E4%B8%8E%E6%80%A7%E8%83%BD%E8%A6%81%E7%82%B9" title="#212-transition-vs-animation-%E4%B8%8E%E6%80%A7%E8%83%BD%E8%A6%81%E7%82%B9">2.12 <code>transition</code> vs <code>animation</code> 与性能要点</a></li>
</ul>
</li>
<li><a href="#3-%E5%B7%A5%E7%A8%8B%E5%8C%96%E4%B8%8E%E8%90%BD%E5%9C%B0%E5%85%AC%E5%8F%B8%E6%9C%80%E5%B8%B8%E7%94%A8" title="#3-%E5%B7%A5%E7%A8%8B%E5%8C%96%E4%B8%8E%E8%90%BD%E5%9C%B0%E5%85%AC%E5%8F%B8%E6%9C%80%E5%B8%B8%E7%94%A8">3. 工程化与落地（公司最常用）</a>
<ul>
<li><a href="#31-%E7%A7%BB%E5%8A%A8%E7%AB%AF%E9%80%82%E9%85%8D%E9%80%89%E5%9E%8Brem--vw--rpx--scale" title="#31-%E7%A7%BB%E5%8A%A8%E7%AB%AF%E9%80%82%E9%85%8D%E9%80%89%E5%9E%8Brem--vw--rpx--scale">3.1 移动端适配选型：<code>rem</code> / <code>vw</code> / <code>rpx</code> / <code>scale</code></a></li>
<li><a href="#32-h5vuereact-%E6%96%B9%E6%A1%88postcss-%E8%87%AA%E5%8A%A8%E8%BD%AC%E6%8D%A2%E6%8E%A8%E8%8D%90%E5%86%99-px" title="#32-h5vuereact-%E6%96%B9%E6%A1%88postcss-%E8%87%AA%E5%8A%A8%E8%BD%AC%E6%8D%A2%E6%8E%A8%E8%8D%90%E5%86%99-px">3.2 H5（Vue/React）方案：PostCSS 自动转换（推荐写 <code>px</code>）</a></li>
<li><a href="#33-uni-app--%E5%B0%8F%E7%A8%8B%E5%BA%8Frpx-%E4%B8%8E%E5%AE%89%E5%85%A8%E5%8C%BA" title="#33-uni-app--%E5%B0%8F%E7%A8%8B%E5%BA%8Frpx-%E4%B8%8E%E5%AE%89%E5%85%A8%E5%8C%BA">3.3 uni-app / 小程序：<code>rpx</code> 与安全区</a></li>
<li><a href="#34-pc-%E5%93%8D%E5%BA%94%E5%BC%8Fb-%E7%AB%AF%E5%AE%98%E7%BD%91%E7%89%88%E5%BF%83--%E6%96%AD%E7%82%B9--flexgrid" title="#34-pc-%E5%93%8D%E5%BA%94%E5%BC%8Fb-%E7%AB%AF%E5%AE%98%E7%BD%91%E7%89%88%E5%BF%83--%E6%96%AD%E7%82%B9--flexgrid">3.4 PC 响应式（B 端/官网）：版心 + 断点 + Flex/Grid</a></li>
<li><a href="#35-%E5%A4%A7%E5%B1%8F%E5%8F%AF%E8%A7%86%E5%8C%96%E5%AE%B9%E5%99%A8%E7%AD%89%E6%AF%94%E7%BC%A9%E6%94%BEtransform-scale" title="#35-%E5%A4%A7%E5%B1%8F%E5%8F%AF%E8%A7%86%E5%8C%96%E5%AE%B9%E5%99%A8%E7%AD%89%E6%AF%94%E7%BC%A9%E6%94%BEtransform-scale">3.5 大屏可视化：容器等比缩放（<code>transform: scale</code>）</a></li>
<li><a href="#36-%E7%A7%BB%E5%8A%A8%E7%AB%AF-1px-%E9%97%AE%E9%A2%98retina" title="#36-%E7%A7%BB%E5%8A%A8%E7%AB%AF-1px-%E9%97%AE%E9%A2%98retina">3.6 移动端 1px 问题（Retina）</a></li>
<li><a href="#37-%E9%9A%90%E8%97%8F%E5%85%83%E7%B4%A0displaynone--visibilityhidden--opacity0" title="#37-%E9%9A%90%E8%97%8F%E5%85%83%E7%B4%A0displaynone--visibilityhidden--opacity0">3.7 隐藏元素：<code>display:none</code> / <code>visibility:hidden</code> / <code>opacity:0</code></a></li>
<li><a href="#38-%E5%93%8D%E5%BA%94%E5%BC%8F%E5%B8%83%E5%B1%80-sop%E6%AD%A5%E9%AA%A4--%E4%B8%8D%E5%90%8C%E5%9C%BA%E6%99%AF%E6%96%B9%E6%A1%88" title="#38-%E5%93%8D%E5%BA%94%E5%BC%8F%E5%B8%83%E5%B1%80-sop%E6%AD%A5%E9%AA%A4--%E4%B8%8D%E5%90%8C%E5%9C%BA%E6%99%AF%E6%96%B9%E6%A1%88">3.8 响应式布局 SOP（步骤 + 不同场景方案）</a></li>
</ul>
</li>
<li><a href="#4-%E9%AB%98%E9%A2%91%E5%9C%BA%E6%99%AF%E9%A2%98%E9%9D%A2%E8%AF%95%E7%9B%B4%E6%8E%A5%E7%94%A8" title="#4-%E9%AB%98%E9%A2%91%E5%9C%BA%E6%99%AF%E9%A2%98%E9%9D%A2%E8%AF%95%E7%9B%B4%E6%8E%A5%E7%94%A8">4. 高频场景题（面试直接用）</a></li>
</ul>
<hr/>
<h2 data-id="heading-1">1. HTML 篇</h2>
<h3 data-id="heading-2">1.1 语义化（Semantic HTML）</h3>
<ul>
<li><strong>是什么</strong>
<ul>
<li>使用符合内容含义的标签（<code>header/nav/main/article/section/aside/footer</code>、<code>h1-h6</code>、<code>p</code>、<code>ul/li</code>、<code>figure/figcaption</code> 等）描述结构，而不是全用 <code>div/span</code>。</li>
</ul>
</li>
<li><strong>为什么（收益）</strong>
<ul>
<li><strong>SEO</strong>：搜索引擎更容易理解页面结构与权重。</li>
<li><strong>可访问性（A11y）</strong>：读屏软件更好解析；键盘导航更顺。</li>
<li><strong>可维护性</strong>：结构清晰，样式/脚本更容易定位。</li>
<li><strong>默认行为</strong>：例如 <code>button</code> 天然可聚焦、可键盘触发。</li>
</ul>
</li>
<li><strong>常见追问</strong>
<ul>
<li><strong><code>section</code> vs <code>div</code></strong>：<code>section</code> 表示主题分区（通常应该有标题），<code>div</code> 是无语义容器。</li>
<li><strong><code>em/strong</code> vs <code>i/b</code></strong>：前者强调语义，后者偏展示。</li>
</ul>
</li>
<li><strong>常见坑</strong>
<ul>
<li><code>div</code> 冒充按钮但缺少 <code>role="button"</code>、<code>tabindex="0"</code>、键盘事件。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-3">1.2 块级/行内/行内块</h3>
<ul>
<li><strong>块级（block）</strong>：独占一行；可设置 <code>width/height/margin/padding</code>。</li>
<li><strong>行内（inline）</strong>：不独占一行；<code>width/height</code> 通常不生效；<code>margin-top/bottom</code> 通常不生效。</li>
<li><strong>行内块（inline-block）</strong>：不独占一行，但可设置 <code>width/height</code>。</li>
<li><strong>追问：<code>inline-block</code> 空白间隙怎么解决</strong>
<ul>
<li>删除标签间空白/换行；父元素 <code>font-size:0</code>；或者直接改用 <code>flex/grid</code>。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-4">1.3 <code>script</code> 的 <code>async</code> / <code>defer</code> 区别</h3>
<ul>
<li><strong>无 <code>async/defer</code></strong>：下载+执行会阻塞 HTML 解析。</li>
<li><strong><code>defer</code></strong>：并行下载；等 DOM 解析完成后按顺序执行；适合业务脚本。</li>
<li><strong><code>async</code></strong>：并行下载；下载完立刻执行（可能打断解析）；顺序不保证；适合统计/埋点。</li>
<li><strong>追问</strong>
<ul>
<li><code>type="module"</code>：模块脚本默认行为更接近 <code>defer</code>（并行下载，解析后执行）。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-5">1.4 <code>meta viewport</code></h3>
<p>常用写法：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
</code></pre>
<ul>
<li><strong>作用</strong>：控制移动端布局视口宽度与缩放，避免页面被缩小。</li>
<li><strong>工程提醒</strong>
<ul>
<li>不建议为了“防缩放”随意加 <code>user-scalable=no</code>（可访问性风险）。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-6">1.5 <code>img</code> 的 <code>alt</code>、懒加载与图片性能</h3>
<ul>
<li><strong><code>alt</code></strong>：图片加载失败的替代文本；对 SEO/读屏重要。</li>
<li><strong>懒加载</strong>
<ul>
<li>原生：<code>loading="lazy"</code></li>
<li>更强控制：IntersectionObserver</li>
</ul>
</li>
<li><strong>响应式图片</strong>：<code>srcset/sizes</code>（按容器加载不同分辨率）。</li>
</ul>
<hr/>
<h3 data-id="heading-7">1.6 表单与可访问性（A11y）</h3>
<ul>
<li><strong><code>label</code> 与 <code>input</code> 绑定</strong>
<ul>
<li><code>label for="id"</code> + <code>input id="id"</code>，或 <code>label</code> 包裹 <code>input</code>。</li>
</ul>
</li>
<li><strong><code>button</code> 默认类型</strong>
<ul>
<li><code>form</code> 内默认 <code>type="submit"</code>，非提交按钮要显式写 <code>type="button"</code>。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-8">2. CSS 基础与原理篇</h2>
<h3 data-id="heading-9">2.1 选择器优先级（Specificity）</h3>
<ul>
<li><strong>常见优先级从高到低</strong>
<ul>
<li><code>!important</code> &gt; 行内样式 &gt; <code>#id</code> &gt; <code>.class/[attr]/:pseudo-class</code> &gt; <code>tag/::pseudo-element</code> &gt; 通配 <code>*</code>/继承</li>
</ul>
</li>
<li><strong>同级规则</strong>
<ul>
<li>优先级相同：后写覆盖先写。</li>
</ul>
</li>
<li><strong>坑</strong>
<ul>
<li><code>:not()</code> 本身不加权重，但括号里的选择器会增加权重。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-10">2.2 盒模型与 <code>box-sizing</code></h3>
<ul>
<li><strong>标准盒模型</strong>：<code>width/height</code> 只包含 <code>content</code>。</li>
<li><strong>工程推荐</strong>：全局 <code>box-sizing: border-box;</code>，布局更符合“视觉宽度”。</li>
</ul>
<hr/>
<h3 data-id="heading-11">2.3 BFC（块级格式化上下文）</h3>
<ul>
<li><strong>人话解释</strong>：BFC 是一个独立的渲染区域/布局“结界”，内部布局不会在某些方面影响外部。</li>
<li><strong>常见触发方式</strong>
<ul>
<li><code>overflow</code> 非 <code>visible</code></li>
<li><code>display: flow-root</code>（推荐）/<code>flex</code>/<code>grid</code>/<code>inline-block</code></li>
<li><code>position: absolute/fixed</code></li>
</ul>
</li>
<li><strong>经典用途</strong>
<ul>
<li>清除浮动造成的父元素高度塌陷</li>
<li>避免 margin 合并</li>
<li>两栏布局：让右侧自适应不被浮动覆盖</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-12">2.4 浮动与清除浮动</h3>
<ul>
<li><strong>塌陷原因</strong>：浮动元素脱离普通流，不撑开父元素高度。</li>
<li><strong>清除方式</strong>
<ul>
<li>伪元素 clearfix</li>
<li>触发 BFC：<code>overflow: hidden</code> 或 <code>display: flow-root</code></li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-13">2.5 <code>position</code>：relative/absolute/fixed/sticky</h3>
<ul>
<li><code>relative</code>：不脱离文档流；偏移相对自身原位置。</li>
<li><code>absolute</code>：脱离文档流；相对最近定位祖先。</li>
<li><code>fixed</code>：相对视口；注意某些场景会受祖先 <code>transform</code> 影响。</li>
<li><code>sticky</code>：滚动到阈值后吸顶；必须指定 <code>top/left/...</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-14">2.6 Flex：<code>flex: 1</code>、压缩、溢出与 <code>min-width: 0</code></h3>
<ul>
<li><strong><code>flex: 1</code> 常见解释</strong>：<code>flex: 1 1 0%</code>，用于均分剩余空间。</li>
<li><strong>高频坑：长文本把布局撑爆</strong>
<ul>
<li>Flex 子项默认 <code>min-width: auto</code>，内容过长会撑开。</li>
<li><strong>工程解法</strong>：在需要截断/可滚动的子项上加 <code>min-width: 0</code>。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-15">2.7 Grid：二维布局加分项</h3>
<ul>
<li>更适合二维栅格布局；常用 <code>repeat()</code>、<code>minmax()</code>、<code>fr</code>、<code>gap</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-16">2.8 常见居中方案</h3>
<ul>
<li>Flex：</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> { <span class="hljs-attribute">display</span>: flex; <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-attribute">align-items</span>: center; }
</code></pre>
<ul>
<li>Grid：</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> { <span class="hljs-attribute">display</span>: grid; place-items: center; }
</code></pre>
<ul>
<li>绝对定位 + transform：</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.child</span> { <span class="hljs-attribute">position</span>: absolute; <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>; <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>; <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>); }
</code></pre>
<hr/>
<h3 data-id="heading-17">2.9 <code>z-index</code> 与层叠上下文（Stacking Context）</h3>
<ul>
<li><strong>结论</strong>：<code>z-index</code> 只在同一层叠上下文里比较。</li>
<li><strong>常见创建层叠上下文</strong>
<ul>
<li><code>position</code> 非 static + <code>z-index</code> 非 auto</li>
<li><code>transform</code> 非 none、<code>opacity &lt; 1</code> 等</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-18">2.10 继承、层叠、计算值（CSS 三板斧）</h3>
<ul>
<li><strong>继承</strong>：如 <code>color</code>、<code>font-*</code> 常继承；<code>margin/padding/border</code> 不继承。</li>
<li><strong>层叠</strong>：来源 + 权重 + 顺序共同决定。</li>
</ul>
<hr/>
<h3 data-id="heading-19">2.11 响应式单位与媒体查询</h3>
<ul>
<li>单位：<code>%/rem/em/vw/vh</code> 各有场景。</li>
<li>断点：<code>@media (max-width: 768px) { ... }</code> 等。</li>
</ul>
<hr/>
<h3 data-id="heading-20">2.12 <code>transition</code> vs <code>animation</code> 与性能要点</h3>
<ul>
<li><code>transition</code>：状态变化触发。</li>
<li><code>animation</code>：<code>@keyframes</code> 更复杂时间线。</li>
<li><strong>性能建议</strong>：优先动画 <code>transform/opacity</code>，避免高频动画 <code>top/left/width/height</code>。</li>
</ul>
<hr/>
<h2 data-id="heading-21">3. 工程化与落地（公司最常用）</h2>
<h3 data-id="heading-22">3.1 移动端适配选型：<code>rem</code> / <code>vw</code> / <code>rpx</code> / <code>scale</code></h3>
<ul>
<li><strong>核心结论</strong>
<ul>
<li>你不应该让开发“手写 rem/vw”，而是：<strong>代码里写 <code>px</code>，构建阶段自动转换</strong>。</li>
<li>场景选型：
<ul>
<li><strong>新 H5 项目</strong>：更偏向 <code>vw</code>（PostCSS 转换）</li>
<li><strong>老项目/兼容性要求极高</strong>：<code>rem</code>（动态 root + PostCSS 转换）</li>
<li><strong>uni-app/小程序</strong>：<code>rpx</code></li>
<li><strong>大屏可视化</strong>：容器等比缩放 <code>transform: scale()</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-23">3.2 H5（Vue/React）方案：PostCSS 自动转换（推荐写 <code>px</code>）</h3>
<h4 data-id="heading-24">方案 A：<code>vw</code>（推荐）+ <code>postcss-px-to-viewport</code></h4>
<ul>
<li><strong>典型配置（<code>postcss.config.js</code>）</strong></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: {
    <span class="hljs-string">'postcss-px-to-viewport'</span>: {
      <span class="hljs-attr">viewportWidth</span>: <span class="hljs-number">375</span>,
      <span class="hljs-attr">unitPrecision</span>: <span class="hljs-number">5</span>,
      <span class="hljs-attr">viewportUnit</span>: <span class="hljs-string">'vw'</span>,
      <span class="hljs-attr">selectorBlackList</span>: [<span class="hljs-string">'.ignore'</span>, <span class="hljs-string">'.hairlines'</span>],
      <span class="hljs-attr">minPixelValue</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">mediaQuery</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">exclude</span>: [<span class="hljs-regexp">/node_modules/</span>],
    },
  },
}
</code></pre>
<ul>
<li><strong>公司里最常见的坑</strong>
<ul>
<li>UI 库（如 Vant）设计基准可能与业务设计稿不同（375 vs 750），不做隔离会导致 UI 库整体缩小/放大。</li>
<li>常见处理：<code>exclude</code> UI 库，或者使用支持动态 <code>viewportWidth</code> 的插件版本按路径区分。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-25">方案 B：<code>rem</code>（经典）+ <code>amfe-flexible</code> + <code>postcss-pxtorem</code></h4>
<ul>
<li><strong>核心点</strong>：动态设置 <code>html</code> 的 <code>font-size</code>，并在构建阶段将 <code>px</code> 转 <code>rem</code>。</li>
<li><strong>典型配置要点（按 UI 库/业务代码区分 rootValue）</strong></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: {
    <span class="hljs-string">'postcss-pxtorem'</span>: {
      <span class="hljs-title function_">rootValue</span>(<span class="hljs-params">{ file }</span>) {
        <span class="hljs-keyword">return</span> file.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'vant'</span>) !== -<span class="hljs-number">1</span> ? <span class="hljs-number">37.5</span> : <span class="hljs-number">75</span>
      },
      <span class="hljs-attr">propList</span>: [<span class="hljs-string">'*'</span>],
      <span class="hljs-attr">selectorBlackList</span>: [<span class="hljs-string">'.norem'</span>],
    },
  },
}
</code></pre>
<hr/>
<h3 data-id="heading-26">3.3 uni-app / 小程序：<code>rpx</code> 与安全区</h3>
<ul>
<li><strong>单位</strong>：优先 <code>rpx</code>，常配合 750 设计稿心智最一致。</li>
<li><strong>布局</strong>：以 <code>flex</code> 为主，少用硬编码高度。</li>
<li><strong>安全区（底部 Home 指示条）</strong></li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.page</span> {
  <span class="hljs-attribute">padding-bottom</span>: <span class="hljs-built_in">env</span>(safe-area-inset-bottom);
}
</code></pre>
<hr/>
<h3 data-id="heading-27">3.4 PC 响应式（B 端/官网）：版心 + 断点 + Flex/Grid</h3>
<ul>
<li><strong>不要</strong>在 PC 全站做 rem/vw 等比缩放（屏幕跨度太大，体验不可控）。</li>
<li><strong>常见落地组合</strong>
<ul>
<li>版心：<code>max-width: 1200px/1440px; margin: 0 auto;</code></li>
<li>布局：Flex/Grid</li>
<li>断点：对关键布局重排</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">992px</span>) {
  <span class="hljs-selector-class">.sidebar</span> { <span class="hljs-attribute">display</span>: none; }
}
</code></pre>
<hr/>
<h3 data-id="heading-28">3.5 大屏可视化：容器等比缩放（<code>transform: scale</code>）</h3>
<ul>
<li><strong>适用</strong>：强视觉还原、固定画布（如 1920x1080）。</li>
<li><strong>核心代码（监听 resize 计算 scale）</strong></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fitScreen</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> designW = <span class="hljs-number">1920</span>
  <span class="hljs-keyword">const</span> designH = <span class="hljs-number">1080</span>
  <span class="hljs-keyword">const</span> scaleX = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / designW
  <span class="hljs-keyword">const</span> scaleY = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span> / designH
  <span class="hljs-keyword">const</span> scale = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(scaleX, scaleY)
  <span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'screen'</span>)
  el.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`scale(<span class="hljs-subst">${scale}</span>)`</span>
  el.<span class="hljs-property">style</span>.<span class="hljs-property">transformOrigin</span> = <span class="hljs-string">'left top'</span>
}

<span class="hljs-title function_">fitScreen</span>()
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, fitScreen)
</code></pre>
<ul>
<li><strong>注意</strong>：如果涉及点击/拖拽坐标，需要按 <code>scale</code> 反算。</li>
</ul>
<hr/>
<h3 data-id="heading-29">3.6 移动端 1px 问题（Retina）</h3>
<ul>
<li><strong>现象</strong>：高 DPR 屏上 <code>1px</code> 视觉上变粗。</li>
<li><strong>常见落地</strong>：伪元素 + 缩放</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.border-1px</span> {
  <span class="hljs-attribute">position</span>: relative;
}

<span class="hljs-selector-class">.border-1px</span><span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">1px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#ccc</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scaleY</span>(<span class="hljs-number">0.5</span>);
  <span class="hljs-attribute">transform-origin</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-30">3.7 隐藏元素：<code>display:none</code> / <code>visibility:hidden</code> / <code>opacity:0</code></h3>
<ul>
<li><code>display: none</code>：不占位；触发 reflow；不可点击。</li>
<li><code>visibility: hidden</code>：占位；触发 repaint；不可点击。</li>
<li><code>opacity: 0</code>：占位；通常 repaint；仍可点击（除非配合 <code>pointer-events: none</code>）。</li>
</ul>
<hr/>
<h3 data-id="heading-31">3.8 响应式布局 SOP（步骤 + 不同场景方案）</h3>
<blockquote>
<p>你可以把这一节当成：面试回答模板 + 项目落地 SOP（标准操作流程）。</p>
</blockquote>
<h4 data-id="heading-32">3.8.1 先给结论：响应式不是一个技术点，是“策略组合”</h4>
<ul>
<li><strong>A. 等比缩放</strong>：页面整体按比例放大缩小
<ul>
<li>常见：大屏看板、强还原活动页</li>
</ul>
</li>
<li><strong>B. 响应式重排</strong>：不同宽度下布局结构变化
<ul>
<li>常见：PC 官网 / B 端</li>
</ul>
</li>
<li><strong>C. 流式自适应</strong>：布局不大改，但局部宽高、字体、间距自适应
<ul>
<li>常见：移动端业务 H5</li>
</ul>
</li>
</ul>
<h4 data-id="heading-33">3.8.2 落地步骤（SOP：从需求到上线）</h4>
<ul>
<li>
<p><strong>Step 1：明确输入条件（必须问清）</strong></p>
<ul>
<li>设计基准：设计稿宽度（<code>375</code> / <code>750</code> / <code>1200</code> / <code>1920x1080</code>）</li>
<li>目标设备：移动端 H5（WebView/浏览器）/ PC / 小程序（含 uni-app）/ 大屏</li>
<li>是否允许重排：是否能接受某些屏幕变成单列、某些模块折行</li>
<li>兼容性要求：最低 iOS/Android/浏览器版本</li>
<li>关键体验约束：固定底栏/弹窗、长列表、图表/Canvas 等</li>
</ul>
</li>
<li>
<p><strong>Step 2：先选布局骨架（优先级：Grid &gt; Flex &gt; 传统）</strong></p>
<ul>
<li>二维区域布局/栅格：优先 <code>grid</code></li>
<li>一维布局（横排/竖排）：优先 <code>flex</code></li>
<li>避免用 <code>float</code> 作为布局系统（除非老项目维护）</li>
</ul>
</li>
<li>
<p><strong>Step 3：确定“尺寸体系”（决定 rem/vw/px/clamp 的组合）</strong></p>
<ul>
<li>移动端 H5：推荐“写 <code>px</code> + PostCSS 自动转换为 <code>vw</code>/<code>rem</code>”</li>
<li>PC：以 <code>px</code> 为主 + 版心 + 断点（必要时少量 <code>%/fr</code>）</li>
<li>大屏：内部按设计稿 <code>px</code>，外层容器 <code>transform: scale()</code></li>
</ul>
</li>
<li>
<p><strong>Step 4：断点策略（不是越多越好）</strong></p>
<ul>
<li>移动端：通常少断点，更多靠流式布局；必要时单独考虑 Pad（<code>&gt;=768</code>）</li>
<li>PC：常用 3-5 个断点（如 <code>1200/992/768/576</code>）就够用</li>
<li>大屏：优先等比缩放，不建议靠大量断点救火</li>
</ul>
</li>
<li>
<p><strong>Step 5：上线前兜底（公司里最容易翻车的地方）</strong></p>
<ul>
<li>文本溢出：单行/多行省略号，Flex 子项记得 <code>min-width: 0</code></li>
<li>图片：<code>max-width: 100%</code>、必要时 <code>object-fit: cover</code></li>
<li>安全区：<code>env(safe-area-inset-bottom)</code></li>
<li>性能：动画只动 <code>transform/opacity</code>；长列表考虑虚拟列表</li>
</ul>
</li>
</ul>
<h4 data-id="heading-34">3.8.3 不同场景的“对口方案”（可直接落地）</h4>
<ul>
<li>
<p><strong>移动端 H5（业务页/内嵌页）</strong></p>
<ul>
<li>目标：流式自适应为主，不追求像素级完全一致</li>
<li>推荐：<code>flex/grid</code> + PostCSS（<code>px -&gt; vw</code>）+ <code>clamp()</code> 做上下限 + 安全区/1px/弹窗兜底</li>
</ul>
</li>
<li>
<p><strong>PC 官网 / B 端后台</strong></p>
<ul>
<li>目标：断点重排 + 版心控制阅读宽度</li>
<li>推荐：Grid 做栅格区域 + Flex 做组件内部；<code>max-width</code> 版心；关键断点重排（侧边栏折叠等）</li>
</ul>
</li>
<li>
<p><strong>uni-app / 小程序</strong></p>
<ul>
<li>目标：利用平台原生适配能力</li>
<li>推荐：<code>rpx + flex</code>；优先使用生态组件库，减少引入写死 <code>px</code> 的第三方 H5 样式</li>
</ul>
</li>
<li>
<p><strong>大屏可视化（DataV/看板）</strong></p>
<ul>
<li>目标：严格保真，不换行、不乱跑位</li>
<li>推荐：内部按设计稿 <code>px</code> 写，外层 <code>transform: scale()</code>，交互坐标按 scale 反算</li>
</ul>
</li>
</ul>
<h4 data-id="heading-35">3.8.4 面试一句话收尾（背下来）</h4>
<blockquote>
<p>“响应式我会先明确目标是等比缩放还是断点重排。移动端业务页用 Flex/Grid + PostCSS 的 vw（必要时 clamp）保证流式自适应；PC 端用版心 + 断点做结构重排；小程序用 rpx；大屏用容器 scale 保真。最后统一补齐文本溢出、安全区、1px、弹窗与性能兜底。”</p>
</blockquote>
<hr/>
<h2 data-id="heading-36">4. 高频场景题（面试直接用）</h2>
<h3 data-id="heading-37">4.1 三栏布局：两侧固定，中间自适应</h3>
<ul>
<li>
<p><strong>可背诵答案（30 秒版）</strong></p>
<ul>
<li>“我会优先用 flex：左右两栏固定宽度，中间一栏 <code>flex: 1</code> 占满剩余空间。中间为了防止长文本把布局撑爆，会显式加 <code>min-width: 0</code>，再配合 <code>overflow: hidden; text-overflow: ellipsis;</code> 或内部滚动。”</li>
</ul>
</li>
<li>
<p><strong>推荐实现（Flex）</strong></p>
</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layout"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"left"</span>&gt;</span>left<span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mid"</span>&gt;</span>middle middle middle ...<span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"right"</span>&gt;</span>right<span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.layout</span> {
  <span class="hljs-attribute">display</span>: flex;
}

<span class="hljs-selector-class">.left</span>,
<span class="hljs-selector-class">.right</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">200px</span>;
}

<span class="hljs-selector-class">.mid</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">min-width</span>: <span class="hljs-number">0</span>; <span class="hljs-comment">/* 关键：允许在 flex 容器内缩小，避免长内容撑爆 */</span>
}
</code></pre>
<ul>
<li><strong>高频追问</strong>
<ul>
<li>为什么要 <code>min-width: 0</code>：Flex 子项默认 <code>min-width: auto</code>，内容过长会让它不愿意缩小。</li>
<li>不用 flex 你还有方案吗：Grid（更适合二维），以及老方案（float + BFC/定位）但现代不推荐。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-38">4.2 弹窗 <code>z-index: 9999</code> 仍被遮住</h3>
<ul>
<li>
<p><strong>可背诵答案（30 秒版）</strong></p>
<ul>
<li>“<code>z-index</code> 只在同一个层叠上下文里比较。如果弹窗的祖先元素创建了层叠上下文（比如 <code>transform</code>、<code>opacity&lt;1</code>、<code>position+z-index</code>），那弹窗的 <code>z-index</code> 再大也只能在这个上下文里排队，盖不住别的上下文。工程上我通常把弹窗挂到 <code>body</code>（React Portal / Vue Teleport），从根层级统一管理。”</li>
</ul>
</li>
<li>
<p><strong>如何快速定位（排查路径）</strong></p>
<ul>
<li>检查弹窗及其祖先是否存在：
<ul>
<li><code>transform: translateZ(0)</code> / <code>transform: ...</code></li>
<li><code>opacity &lt; 1</code></li>
<li><code>position</code> 非 static 且 <code>z-index</code> 非 auto</li>
<li><code>filter</code>、<code>will-change</code> 等</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>工程落地建议</strong></p>
<ul>
<li><strong>组件库/业务统一方案</strong>：全站只有一个 <code>#modal-root</code>，所有弹窗都挂载到这里。</li>
<li><strong>管理策略</strong>：用“弹窗栈”管理层级（比如每开一个弹窗，z-index 递增）。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-39">4.3 <code>position: sticky</code> 不生效</h3>
<ul>
<li>
<p><strong>可背诵答案（30 秒版）</strong></p>
<ul>
<li>“<code>sticky</code> 需要一个滚动容器，并且必须指定 <code>top/left/right/bottom</code> 其中一个阈值。常见失效原因是祖先设置了 <code>overflow: hidden/auto/scroll</code> 改变了滚动容器，或者容器高度不足导致根本触发不了吸附。”</li>
</ul>
</li>
<li>
<p><strong>常见失效清单（面试官最爱挖坑）</strong></p>
<ul>
<li>没写 <code>top</code>（最常见）</li>
<li>父级/祖先 <code>overflow</code> 非 <code>visible</code>（尤其 <code>overflow: hidden</code>）</li>
<li>滚动发生在另一个容器（不是你以为的 window）</li>
<li>sticky 元素所在容器高度不够（滚动距离不足）</li>
</ul>
</li>
<li>
<p><strong>参考代码</strong></p>
</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.sticky</span> {
  <span class="hljs-attribute">position</span>: sticky;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">10</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-40">4.4 回流（reflow）/重绘（repaint）与优化</h3>
<ul>
<li>
<p><strong>可背诵答案（60 秒版）</strong></p>
<ul>
<li>“回流是布局计算阶段（尺寸/位置变化导致 Layout 重新算），重绘是像素绘制阶段（颜色/阴影变化触发 Paint）。回流一定会引起重绘，重绘不一定回流。优化上：尽量减少触发布局的属性变化，把动画放到 <code>transform/opacity</code>，批量读写 DOM，避免强制同步布局（比如频繁读 <code>offsetHeight</code>）。长列表用虚拟列表，图片用懒加载。”</li>
</ul>
</li>
<li>
<p><strong>常见触发回流的操作（会被追问）</strong></p>
<ul>
<li>改几何属性：<code>width/height/padding/margin/top/left/border</code>（部分）</li>
<li>插入/删除 DOM 节点，改变字体大小</li>
<li>读取布局信息会触发“强制同步布局”：<code>offsetHeight/getBoundingClientRect</code>（在你前面有写操作时）</li>
</ul>
</li>
<li>
<p><strong>工程级优化清单</strong></p>
<ul>
<li>动画：只动 <code>transform/opacity</code>（必要时 <code>will-change</code>，但别滥用）</li>
<li>DOM：合并操作（改 class 而不是逐条改 style），读写分离</li>
<li>长列表：虚拟列表/分页渲染</li>
<li>新特性加分：<code>content-visibility: auto;</code>（对长页面有帮助）</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-41">4.5 两栏布局：左固定右自适应（最常用）</h3>
<ul>
<li><strong>Flex 推荐写法</strong></li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.wrap</span> { <span class="hljs-attribute">display</span>: flex; }
<span class="hljs-selector-class">.left</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">240px</span>; <span class="hljs-attribute">flex</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">240px</span>; }
<span class="hljs-selector-class">.right</span> { <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>; <span class="hljs-attribute">min-width</span>: <span class="hljs-number">0</span>; }
</code></pre>
<ul>
<li><strong>追问点</strong>
<ul>
<li>右侧内容长导致撑开：同样用 <code>min-width: 0</code>。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-42">4.6 文本溢出省略号：单行/多行</h3>
<ul>
<li><strong>单行省略号</strong></li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.ellipsis</span> {
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">text-overflow</span>: ellipsis;
  <span class="hljs-attribute">white-space</span>: nowrap;
}
</code></pre>
<ul>
<li><strong>多行省略号（常问，含兼容性）</strong></li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.clamp</span> {
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">display</span>: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: <span class="hljs-number">3</span>;
}
</code></pre>
<ul>
<li><strong>追问点</strong>
<ul>
<li>多行省略号是非标准方案（WebKit 私有），复杂场景可能要用 JS 计算。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-43">4.7 图片底部为什么会有“缝隙”？怎么解决</h3>
<ul>
<li><strong>原因（面试点）</strong>
<ul>
<li><code>img</code> 默认是 inline 元素，会按基线对齐，基线下方留空给“下行字母”（descender）空间。</li>
</ul>
</li>
<li><strong>解决方案</strong>
<ul>
<li><code>img { display: block; }</code></li>
<li>或者父元素 <code>line-height: 0</code>（不推荐，影响可读性）</li>
<li>或 <code>vertical-align: middle/bottom;</code></li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-44">4.8 移动端底部安全区（iPhone 刘海屏/小白条）</h3>
<ul>
<li><strong>CSS 落地</strong></li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.footer</span> {
  <span class="hljs-attribute">padding-bottom</span>: <span class="hljs-built_in">env</span>(safe-area-inset-bottom);
}
</code></pre>
<ul>
<li><strong>追问点</strong>
<ul>
<li>除了 padding，还要做“固定底栏 + 占位”，避免内容被遮挡。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-45">4.9 滚动穿透（弹窗打开后背景还能滚）怎么处理</h3>
<ul>
<li><strong>典型场景</strong>
<ul>
<li>移动端弹窗（mask）出现后，背景页面仍能滚动。</li>
</ul>
</li>
<li><strong>工程思路</strong>
<ul>
<li>Web：打开弹窗时锁住 body 滚动（记录滚动位置，关闭后恢复）。</li>
<li>iOS 上对 <code>position: fixed</code>/滚动容器要特别小心。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-46">4.10 清除浮动有哪些方式？为什么现在更推荐 Flex/Grid</h3>
<ul>
<li>
<p><strong>可背诵答案（60 秒版）</strong></p>
<ul>
<li>“清除浮动本质是解决 <code>float</code> 脱离普通文档流导致的父元素高度塌陷。常见方案有三类：
<ol>
<li>经典 <code>clearfix</code> 伪元素清除；</li>
<li>让父容器触发 BFC（比如 <code>overflow: hidden</code>）；</li>
<li>更现代语义化的 <code>display: flow-root</code>。
但在新业务里我更倾向用 Flex/Grid 直接做布局，原因是 float 本身是为文字环绕设计的，不适合作为布局系统；Flex/Grid 更语义、更稳定、响应式更好，后期维护也不会出现各种清除浮动/塌陷的历史问题。”</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>先把原理说清楚：为什么会“高度塌陷”</strong></p>
<ul>
<li>浮动元素会脱离普通流，父元素计算高度时只看普通流子元素，导致：
<ul>
<li>父容器高度变成 0（或只等于非浮动子元素高度）</li>
<li>后续兄弟元素上移/覆盖</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>方案 A：<code>clearfix</code>（经典方案，兼容性强）</strong></p>
</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.clearfix</span><span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
  <span class="hljs-attribute">display</span>: block;
  <span class="hljs-attribute">clear</span>: both;
}
</code></pre>
<ul>
<li>
<p><strong>优点</strong></p>
<ul>
<li>兼容性极好；不依赖布局上下文；老项目常见。</li>
</ul>
</li>
<li>
<p><strong>缺点</strong></p>
<ul>
<li>属于“历史包袱式”的补丁写法：你得记得给父容器加类名；结构不够语义化。</li>
</ul>
</li>
<li>
<p><strong>追问点</strong></p>
<ul>
<li>为什么 <code>clear: both</code> 有效：它会让伪元素排在浮动元素下方，从而撑开父容器高度。</li>
</ul>
</li>
<li>
<p><strong>方案 B：触发 BFC（常用但要注意副作用）</strong></p>
</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.bfc</span> {
  <span class="hljs-attribute">overflow</span>: hidden; <span class="hljs-comment">/* 或 auto/scroll，非 visible */</span>
}
</code></pre>
<ul>
<li>
<p><strong>优点</strong></p>
<ul>
<li>一行代码解决塌陷；顺便能隔离 margin 合并等问题。</li>
</ul>
</li>
<li>
<p><strong>缺点 / 风险</strong></p>
<ul>
<li>可能裁剪溢出内容（比如阴影、下拉菜单、绝对定位的浮层）。</li>
<li>如果你用 <code>auto/scroll</code> 可能引入滚动条。</li>
</ul>
</li>
<li>
<p><strong>方案 C：<code>display: flow-root</code>（推荐写法：语义明确、无裁剪副作用）</strong></p>
</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.flow-root</span> {
  <span class="hljs-attribute">display</span>: flow-root;
}
</code></pre>
<ul>
<li>
<p><strong>优点</strong></p>
<ul>
<li>直接创建新的 BFC，且不像 <code>overflow:hidden</code> 那样裁剪内容。</li>
<li>可读性强：看代码就知道“这是个独立的块级格式化上下文”。</li>
</ul>
</li>
<li>
<p><strong>缺点</strong></p>
<ul>
<li>老旧浏览器兼容性不如 clearfix（现代项目通常没问题）。</li>
</ul>
</li>
<li>
<p><strong>为什么现代更推荐 Flex/Grid（工程化理由）</strong></p>
<ul>
<li><strong>语义与目的匹配</strong>
<ul>
<li><code>float</code> 设计初衷是“文字环绕图片”，不是布局系统；拿 float 做布局会不断触发补丁需求。</li>
</ul>
</li>
<li><strong>更少的隐式规则/坑</strong>
<ul>
<li>float 布局经常伴随：清除浮动、塌陷、浮动覆盖、margin 合并等问题。</li>
<li>Flex/Grid 天然是布局模型，容器与子项职责清晰。</li>
</ul>
</li>
<li><strong>响应式更自然</strong>
<ul>
<li>Flex 的自适应、换行、对齐；Grid 的二维栅格与区域布局，做响应式更直观。</li>
</ul>
</li>
<li><strong>可维护性更好</strong>
<ul>
<li>代码更短、更一致；团队新人不需要背一堆历史兼容技巧。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>加分回答：什么时候仍然会用 float？</strong></p>
<ul>
<li>文字环绕图片（比如富文本内容）</li>
<li>老项目维护（不大动结构的情况下，用 clearfix/BFC 快速止血）</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[✨TRAE SOLO + Holopix AI | 复刻 GBA 游戏-"🐛口袋妖怪"]]></title>    <link>https://juejin.cn/post/7582755817671442442</link>    <guid>https://juejin.cn/post/7582755817671442442</guid>    <pubDate>2025-12-12T09:01:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582755817671442442" data-draft-id="7582763878674497563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="✨TRAE SOLO + Holopix AI | 复刻 GBA 游戏-&quot;🐛口袋妖怪&quot;"/> <meta itemprop="keywords" content="Trae,AI编程,VibeCoding"/> <meta itemprop="datePublished" content="2025-12-12T09:01:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="coder_pig"/> <meta itemprop="url" content="https://juejin.cn/user/4142615541321928"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ✨TRAE SOLO + Holopix AI | 复刻 GBA 游戏-"🐛口袋妖怪"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4142615541321928/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    coder_pig
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:01:55.000Z" title="Fri Dec 12 2025 09:01:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">1. 引言</h2>
<p>😄 不知不觉，今年已经用「<strong>AI编程工具</strong> + <strong>Holopix AI</strong> 」复刻了好几款游戏：<strong>塔防</strong>、<strong>转刀</strong>、<strong>射击</strong>、<strong>自走棋</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be82c5a809614f01b5003228b44b250a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=ijoInBbGsEeXfZ7m1wy4ZFrJehI%3D" alt="" loading="lazy"/></p>
<p>😶 但，都不是我喜欢的，我更怀念读书时的 "<strong>白月光</strong>" —— <strong>GBA《口袋妖怪(绿宝石)》</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f5c82d9fe5d4e2b8a2c1cef98fa8574~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=Mw6kQmRh6AQDCSpWEWnKkGNcisU%3D" alt="" loading="lazy"/></p>
<p>读初中那会，同学买了 <strong>GBA</strong>，软磨硬泡，才愿意晚上借我回家玩。🤡 有 "<strong>网瘾史</strong>"，父母不给玩游戏，等他们 "<strong>查房</strong>" 完，透过门缝看外面的灯关了，确认没动静后，才敢偷偷拿出来玩，有时没注意时间，一玩就是一个通宵，🤣 记得有次理发，钓🐟钓着钓着睡过去了。</p>
<p>唉，年轻真好啊，通宵几天都吃得消，现在不行了，晚上一两点睡，第二天起来浑身难受...</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10d96d9fc7964e92ba6344c1546f458a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=euC1F53J%2BI%2B03Pifdp8ELAZoowM%3D" alt="" loading="lazy"/></p>
<hr/>
<p><strong>AI</strong> 发展迅猛，今年的尾声，借助【<strong>TRAE SOLO + Holopix AI</strong>】来复刻这款游戏，试着找回当年那个 "<strong>无忧无虑</strong>" 的自己👶～</p>
<h2 data-id="heading-1">2. SOLO Time</h2>
<p>上节重构两项目用的 <strong>Agent</strong> 是 <strong>SOLO Coder</strong>，这节是 "<strong>创意快速落地</strong>"，所以用 <strong>SOLO Builder</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/878884a76ea44902a55f17113ab60a18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=y4sLGP6vCesarzsQ4vzIkB7TG1I%3D" alt="" loading="lazy"/></p>
<p><strong>Vibe Coding</strong> 关键是 "<strong>文档先行</strong>" ❗️ 开发过程的每一步都要围绕 "<strong>文档</strong>" 进行，先让 <strong>AI</strong> 出 <strong>Plan</strong> 文档，你 <strong>审阅校对编辑</strong> 没问题后，才让 <strong>AI</strong> 照着文档开始干活。</p>
<p>这样做 "<strong>把控性</strong>" 更强，你能清楚知道 <strong>AI</strong> 要怎么做，而不是 "<strong>抽卡</strong>"，全靠 <strong>AI</strong> 自己发挥。产品开发的起点是 <strong>PRD</strong> (产品需求文档)，游戏则是 <strong>GDD</strong> (游戏设计文档)，先写 <strong>Prompt</strong> 让 <strong>Trae</strong> 对 "<strong>原始需求</strong>" 进行细化。</p>
<p><strong>SOLO Builder</strong> 模式没有 <strong>Plan</strong> 开关，需要在 <strong>Prompt</strong> 中写明生成 <strong>GDD</strong> 文档，不然它有时会直接开始 "<strong>堆代码</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cae3e828ad24d25925d28ce32c2ff91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=rA51eH2QsYj%2BbCiUtHAOCstbpR4%3D" alt="" loading="lazy"/></p>
<p>生成结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74485bbfeac74ab486132d1226c70074~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=4phjNO%2F2Sp0XF75BDErHI5eltGM%3D" alt="" loading="lazy"/></p>
<p>让我们确认几个 "<strong>立项目标</strong>"-复刻程度、技术栈选择、美术与资源，简单做下 "<strong>填空题</strong>"，<strong>Prompt</strong> 后面同样要加上 "<strong>先不要写代码，理解完需求，更新GDD文档</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0977a1861f2346d3a4b5b2f77342302d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=cMO7RHp7L9eego863IJkOGsuV7Y%3D" alt="" loading="lazy"/></p>
<p>再次确认文档是否有误，比如：技术栈是否对味~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1907142ca98143c8a6039822e5c19ad0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=npJqUDHKS4BJHlGTjrKEPBn%2FMOI%3D" alt="" loading="lazy"/></p>
<p>🤔 接着，直接让 <strong>Trae</strong> 按照这个 <strong>GDD</strong> 文档来干活吗？可以，但我倾向于再 "<strong>拆</strong>"，先做 "<strong>可行性的快速验证</strong>"，而不是直接一股脑干到头，这样省 <strong>Token</strong>，<strong>效率更佳</strong>，有不对的可以 <strong>快速调整</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd2dbd50b7b34c9c8ea2679145b207c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=c67OBzFIXO9AnbmI9ITm5tN1HU8%3D" alt="" loading="lazy"/></p>
<p>😏 不够，我还要玩更 "<strong>骚"</strong> 的 "<strong>多Agent并行</strong>"，把 <strong>Trae</strong> 的效率拉爆，写 <strong>Prompt</strong> 把 <strong>大任务</strong> 拆成多个 "<strong>可并行执行的小任务</strong>"，然后还是得生成 "<strong>文档</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54bff0ec365644d0845376588aaa7057~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=7FacCzGrxj4gNzMCKAqC8UvaJ4U%3D" alt="" loading="lazy"/></p>
<hr/>
<p><strong>Trae</strong> 拆解成了 <strong>4</strong> 个小的 <strong>Task</strong>，并告知了我 "<strong>建议执行顺序</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0e7c6b3513a401a8feaaaaa8de22a16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=QW0Xe9gkDJHRNOaI4o6CuMDMBPI%3D" alt="" loading="lazy"/></p>
<p>结构目录不是很好 (没分层)，让它调整一下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e57c6a3c13e74c749a2b43ce9c9e1c00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=AeBiUL94ceZ7ZVlEiMOZPbJwk0Q%3D" alt="" loading="lazy"/></p>
<p>接着就是点击左上角的 " <strong>+ 新任务</strong>"，然后在每个 <strong>Agent</strong> 里写不同的 <strong>Prompt</strong>："执行xxx.md"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b43683262bb4c44816f14ffeba9d9c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=pHPcOmEzod%2F338BTZU4ZlWTGoZg%3D" alt="" loading="lazy"/></p>
<p>🤣 三架马车，并驾齐驱，何其壮观，<strong>泰裤辣</strong>！2333，就是 <strong>Token</strong> 烧得有点快...</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26e25d7371e04bc0ad7805709dd66af4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=%2BAIjBI3jjtbXSPQxmPmYVrPv9gc%3D" alt="" loading="lazy"/></p>
<p>😄 "<strong>简陋</strong>" 游戏雏形有了，接着，可以让 <strong>Trae</strong> 自检任务完成情况：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e15d39f04084b6eb641d1cc77880a33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=6TzK1EL3RU0GYpv%2BHMKzJHUAkW8%3D" alt="" loading="lazy"/></p>
<p>也可以让它基于 <strong>GDD</strong> 生成下一步的 <strong>Plan</strong>，然后就是重复上面的 "<strong>套路</strong>" 拆解任务分步执行，
💁‍♂️人靠衣裳马靠鞍，同时请出我们的老朋友「<a href="https://link.juejin.cn?target=https%3A%2F%2Fholopix.cn%3FinviteCode%3D563333" target="_blank" title="https://holopix.cn?inviteCode=563333" ref="nofollow noopener noreferrer"><strong>Holopix AI</strong></a>」来生成 <strong>UI素材</strong>，对游戏进行 "<strong>美化</strong>"~</p>
<h2 data-id="heading-2">3. Holopix AI 生成素材</h2>
<h3 data-id="heading-3">3.1. 定制一个 "GBA像素风" 模型</h3>
<p>😀 既然是想 "<strong>复刻</strong>"，那 "<strong>美术风格</strong>" 妥妥得搞成 "<strong>GBA像素风</strong>"，<strong>Holopix AI</strong> 提供了大量不同风格的 "<strong>预设模型</strong>"，随手搜了下 "<strong>像素</strong>"，都有 <strong>20+</strong> 种：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94f2cdbf9a1d44fa803362aab248a29f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=pIoNzleE%2FKXzw6Cf%2FfHJjxvIi8c%3D" alt="" loading="lazy"/></p>
<p>😃 不过，杰哥想更加 "<strong>原汁原味</strong>"，<a href="https://link.juejin.cn?target=https%3A%2F%2Fholopix.cn%2FlandingV2%3FinviteCode%3D563333" target="_blank" title="https://holopix.cn/landingV2?inviteCode=563333" ref="nofollow noopener noreferrer"><strong>Holopix AI</strong></a> ****是支持 "<strong>模型定制</strong>" 的，还记得上节 "<strong>坤坤自走棋</strong>"，我们用网上搜罗到的 "<strong>ikun小黄鸡</strong>" 图片作为素材，训练了一个专用用来生成小黄鸡的 "<strong>ikun</strong>" 模型吗？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18caa5dcc6ee46459f3eb38bdf517046~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=lBGWq7p1agj8ZohYIIofbly7qT8%3D" alt="" loading="lazy"/></p>
<p>😄 这里我们 <strong>照葫芦画瓢</strong>，训练一个 "<strong>GBA像素风</strong>" 的模型，搜了下 "<strong>口袋妖怪素材</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ac11bbbb6cb4ee68bf2ad2af30a3c78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=%2BmnQZTl3dzZKS0mlhPqDU62BCuY%3D" alt="" loading="lazy"/></p>
<p>发现都是这样的 "<strong>精灵表</strong>" (纹理图集)，这是 2D<strong>游戏开发</strong> 的标准做法，为的是 "<strong>性能与效率</strong>"：</p>
<blockquote>
<p>GBA的图形芯片 (PPU) 没有 "加载图片" 的概念，它只能读取连续的显存块。开发者把所有角色动画帧拼成一张图，通过修改 <strong>UV坐标</strong> (读取位置) 来切换帧。切换动画帧只需改变内存偏移量，不消耗CPU，而且一张512x512的图集仅占256KB，而100张独立图片会因内存对齐浪费30%空间。</p>
</blockquote>
<p>即使今天硬件强大，"<strong>图集</strong>" 仍是最佳实践，表现在：</p>
<ul>
<li><strong>减少Draw Call</strong>：渲染100个独立图片=100次Draw Call；渲染1张图集=1次Draw Call。GPU批量渲染，帧率提升5-10倍。</li>
<li><strong>动画管理</strong>：动画软件能直接输出图集+坐标数据，游戏引擎可自动识别，无需手动切割和配置。</li>
<li><strong>动态合批</strong>：游戏引擎会将零散小图在运行时合并成图集 (VRAM)，提供预制图集可跳过这一步，启动更快。</li>
<li><strong>像素完美</strong>：独立图片导入时可能因压缩产生1像素透明边，图集一次导出，所有帧共用统一调色板，杜绝色差。</li>
</ul>
<p>😁 扯得有点远了，接着写 <strong>Prompt</strong> 让 <strong>TRAE</strong> 用 <strong>哈基米3</strong> 写脚本切下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a41b500cde6f48e9b7db02b128c6ad46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=VvCfzgp6AFrjGyEGcDjtnElzV9I%3D" alt="" loading="lazy"/></p>
<p>有点切歪了，问题不大，截图发它重新切，顺手 <strong>去掉蓝色背景</strong> + <strong>调整图片分辨率</strong> 为 <strong>256x256</strong>，这是 <strong>训练模型</strong> 用到素材图片的 "<strong>最小分辨率</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6710488945bd4cd397eebcfa51493773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=okPs5Mf371Hm4%2F5Pny0jpEfThgE%3D" alt="" loading="lazy"/></p>
<p>打开 <strong>Holopix AI</strong> 官网，点击左侧 "<strong>模型定制</strong>" → "<strong>开始模型训练</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6897acfcc624440b7ee074b1cf0fbfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=gRW9nrqVd3yZ8aiC%2B8yfTDjNcsU%3D" alt="" loading="lazy"/></p>
<p>训练类型选 "<strong>icon道具</strong>"，训练强度选 "<strong>低</strong>"，然后点击 <strong>上传图片</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd460c21c5834b50b0c9a6490335e944~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=LBIHsEc08QXiS5Pa8QhVmtDp%2BdU%3D" alt="" loading="lazy"/></p>
<p>选中我们的宝可梦素材 (最多200张)：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f21b35fc751c47b9853fecf046adbda8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=nty6%2F2CH1tykewb%2BBwZJ%2BQwU%2F2w%3D" alt="" loading="lazy"/></p>
<p>提交后，等模型训练完，会有消息通知，一般要 <strong>2-10h</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2f2e7f77ef849e697da59043ab75d9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=fefd8p3ZcIcTFU1ct1YQWSz8aVA%3D" alt="" loading="lazy"/></p>
<p>收到成功通知后，可到 "<strong>模型定制</strong>" → "<strong>我的模型</strong>" 找到训练好的模型，点击 <strong>开始创作</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/526b694491cb4c818dbbd8381e326bcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=JaqIjCtLMzAPLaoZD6S8XU%2FjREk%3D" alt="" loading="lazy"/></p>
<p>随便输几个描述词看看效果：皮卡丘、绿毛龟、绿色喷火龙，水箭龟：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0a747114f4e436691de75f08076d7b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=JYItyTtoZuq%2FGBbEj8dbCFx%2BxhY%3D" alt="" loading="lazy"/></p>
<p>😳 卧槽，"<strong>DNA</strong>" 动了！然后，现在这个模型只有 "<strong>自己可见</strong>"，好东西肯定要分享的，接着发布一下模型：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86a0070e0edc4a11868d5831982e9159~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=ndt%2BYc9RnohohzfNIFJREdgOY2Q%3D" alt="" loading="lazy"/></p>
<p>做下填空，然后 <strong>示例图</strong> 直接选 "<strong>从创作记录导入</strong>"，选几张还凑合的，点击发布，然后别人就能搜到你的模型了：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2a5256cacf94dfa83ef10fc7f8469a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=b1SXEr3aqfUuJN%2BSvvVSy1LYn1s%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">3.2. 宝可梦 &amp; 道具 &amp; 角色</h3>
<p>😆 接着用我们上面训练的模型来生成 "<strong>宝可梦</strong>" 和 "<strong>道具</strong>"，生图 <strong>Prompt</strong> 可以让 <strong>Trae</strong> 生成一个素材清单：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/398d7e95c59d437aa52919a75cc506d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=9jnV5g20meCsskqtprf4qk1cmZc%3D" alt="" loading="lazy"/></p>
<p>不过这种批量生成 <strong>Prompt</strong> 的一般都比较 "<strong>简陋</strong>"，可以用 <strong>Holopix AI</strong> 提供的 "<strong>智能优化</strong>" 进行润色：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6704abb4122844f3847fba9bdd41a910~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=SXo1CcdDR6eb8Ya80LsEsLI04q8%3D" alt="" loading="lazy"/></p>
<p>接着就是重复 "<strong>抽卡</strong>"，选择中意的素材了，部分生成素材：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15e913b7004a49fbba65c99d578f40f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=y5jgPs5AhKeDcfqmQmGH4ueV26k%3D" alt="" loading="lazy"/></p>
<p>接着让 <strong>Trae</strong> 应用看下效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9523eaaec356470ca4ec94c49105717d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=HLufc3h3baqayQb9YRrwzDGP2tE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">3.3. 建筑</h3>
<p>🤔 起始城镇 "<strong>主角的家</strong>" 和 "<strong>博士研究所</strong>" 分别占据 <strong>3x3</strong> 和 <strong>5x3</strong> 的格子，没法用像素块拼接...直接找个像素模型，这里用的「<strong>等距像素化建筑模型 | HOLO-V1</strong>」：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee4195845b42403abaa963374c41aed3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=TDLtwLQOSyUhUrm%2BDxsFQhCqCSo%3D" alt="" loading="lazy"/></p>
<p><strong>Prompt</strong> 直接输入 <strong>3x3的房子</strong>，让 <strong>Holopix AI</strong> 进行智能优化，接着翻译为英文，接着微调下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ab1dce044024e70ab7d1f27bf0525c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=4V7%2FC13Q0kki7tEOLJE%2BkvaFkmw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">4. 最终效果</h2>
<p>把 <strong>Holopix AI</strong> 生成的素材全部应用上，加上反复跟 <strong>Trae Vibe</strong> 的最终效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9f4dba9ba6845ebbd38e439e76a4eeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=b1N7%2B9yirpcgo0ufjDDaGdcr6Gc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef735d3af989433eada39aa1da7d1db9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=4FuXorImC7HFUm54Do2TeonX3yQ%3D" alt="" loading="lazy"/></p>
<p>💁‍♂️ 捣鼓了一早上，就复刻了 "<strong>口袋妖怪</strong>" 的 "<strong>基本玩法</strong>" (虽然有点简陋，还有各种BUG🤣)，归功于：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fholopix.cn%3FinviteCode%3D563333" target="_blank" title="https://holopix.cn?inviteCode=563333" ref="nofollow noopener noreferrer"><strong>Holopix AI</strong></a>：依旧保持稳定快速，高质量的游戏素材输出。</li>
<li><strong>Gemini 3 Pro</strong>：当之无愧编程能力最强的 "<strong>前端之王LLM</strong>"。</li>
<li><strong>TRAE SOLO</strong>：同时驱使 <strong>多 Agent</strong> 并行干活太爽了，😆 就是 <strong>Token</strong> 烧得飞快...</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c89f188b8d9415cbb5fdd8f8405829f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=n79q5IHVkVfvR%2FkSJ8hyTc9pI4I%3D" alt="" loading="lazy"/></p>
<p>😏 <strong>AI</strong> 时代，人人都是 "<strong>创造家</strong>"，你有创意你就来，赶紧动手试试吧~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙技术干货9：deviceInfo 设备信息获取与位置提醒 APP 整合]]></title>    <link>https://juejin.cn/post/7582528397866401819</link>    <guid>https://juejin.cn/post/7582528397866401819</guid>    <pubDate>2025-12-12T07:44:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582528397866401819" data-draft-id="7582763878673907739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙技术干货9：deviceInfo 设备信息获取与位置提醒 APP 整合"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-12T07:44:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="赵浩生"/> <meta itemprop="url" content="https://juejin.cn/user/4185170523982995"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙技术干货9：deviceInfo 设备信息获取与位置提醒 APP 整合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4185170523982995/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    赵浩生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:44:01.000Z" title="Fri Dec 12 2025 07:44:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p> 前两篇咱们分别搞定了通知服务（发送提醒）和地理位置服务（获取位置），这篇咱们先学习设备信息（deviceInfo）的核心用法，适配不同设备的硬件和系统特性，再将三大服务整合，完成 “位置提醒 APP” 的完整开发。让咱们从设备适配到功能闭环，一步步实现可直接复用的实战项目！</p>
<h2 data-id="heading-0">一、设备信息服务核心认知</h2>
<h3 data-id="heading-1">1. 设备信息的应用价值</h3>
<ul>
<li>设备适配：根据屏幕尺寸调整 UI 布局、根据系统版本适配 API；</li>
<li>功能优化：根据设备型号调整定位策略（如高端机支持高精度 GNSS）；</li>
<li>问题排查：记录设备信息用于日志分析，快速定位兼容性问题；</li>
<li>个性化服务：根据设备特性提供定制化功能（如平板端显示更多操作入口）。</li>
</ul>
<h3 data-id="heading-2">2. 核心 API 与可获取信息</h3>
<ul>
<li>
<p>核心模块：<code>@ohos.deviceInfo</code>（设备信息）、<code>@ohos.screen</code>（屏幕信息）</p>
</li>
<li>
<p>关键信息：</p>
<ul>
<li>设备基础信息：型号、厂商、设备 ID；</li>
<li>系统信息：系统版本、API 版本、设备类型；</li>
<li>屏幕信息：屏幕尺寸、分辨率、像素密度。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-3">二、设备信息获取实战</h2>
<h3 data-id="heading-4">1. 获取设备基础信息</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> deviceInfo <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.deviceInfo'</span>;

<span class="hljs-comment">/**
 * 获取设备基础信息
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getDeviceBaseInfo</span>(<span class="hljs-params"/>): {
  <span class="hljs-attr">deviceModel</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 设备型号</span>
  <span class="hljs-attr">manufacturer</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 设备厂商</span>
  <span class="hljs-attr">osVersion</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 系统版本</span>
  <span class="hljs-attr">apiVersion</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// API版本</span>
  <span class="hljs-attr">deviceType</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 设备类型（phone/tablet/watch等）</span>
} {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">deviceModel</span>: deviceInfo.<span class="hljs-property">deviceModel</span>, <span class="hljs-comment">// 如：Mate 60 Pro</span>
    <span class="hljs-attr">manufacturer</span>: deviceInfo.<span class="hljs-property">manufacturer</span>, <span class="hljs-comment">// 如：Huawei</span>
    <span class="hljs-attr">osVersion</span>: deviceInfo.<span class="hljs-property">osVersion</span>, <span class="hljs-comment">// 如：4.0.0.188</span>
    <span class="hljs-attr">apiVersion</span>: deviceInfo.<span class="hljs-property">apiVersion</span>, <span class="hljs-comment">// 如：10</span>
    <span class="hljs-attr">deviceType</span>: deviceInfo.<span class="hljs-property">deviceType</span> <span class="hljs-comment">// 如：phone</span>
  };
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-5">2. 获取屏幕信息（适配 UI 布局）</h3>
<pre><code class="hljs language-ini" lang="ini">import screen from '@ohos.screen'<span class="hljs-comment">;</span>

/**
 * 获取屏幕信息
 */
export function getScreenInfo(): {
  screenWidth: number<span class="hljs-comment">; // 屏幕宽度（像素）</span>
  screenHeight: number<span class="hljs-comment">; // 屏幕高度（像素）</span>
  density: number<span class="hljs-comment">; // 像素密度</span>
  dpi: number<span class="hljs-comment">; // 屏幕DPI</span>
} {
  const <span class="hljs-attr">mainScreen</span> = screen.getDefaultScreen()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">screenRect</span> = mainScreen.getRect()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">density</span> = mainScreen.getDensity()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">dpi</span> = mainScreen.getDpi()<span class="hljs-comment">;</span>
  
  return {
    screenWidth: screenRect.width,
    screenHeight: screenRect.height,
    density: density,
    dpi: dpi
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-6">3. 设备适配实战（根据设备类型调整功能）</h3>
<pre><code class="hljs language-ini" lang="ini">/**
 * 根据设备类型调整定位配置
 * 手机：高精度模式，平板：平衡模式，手表：低功耗模式
 */
export function getLocationConfigByDeviceType(): geoLocationManager.LocationRequest {
  const <span class="hljs-attr">deviceInfo</span> = getDeviceBaseInfo()<span class="hljs-comment">;</span>
  let priority: geoLocationManager.LocationRequestPriority<span class="hljs-comment">;</span>
  
  switch (deviceInfo.deviceType) {
    case 'phone':
      <span class="hljs-attr">priority</span> = geoLocationManager.LocationRequestPriority.HIGH_ACCURACY<span class="hljs-comment">;</span>
      break<span class="hljs-comment">;</span>
    case 'tablet':
      <span class="hljs-attr">priority</span> = geoLocationManager.LocationRequestPriority.BALANCED<span class="hljs-comment">;</span>
      break<span class="hljs-comment">;</span>
    case 'watch':
      <span class="hljs-attr">priority</span> = geoLocationManager.LocationRequestPriority.LOW_POWER<span class="hljs-comment">;</span>
      break<span class="hljs-comment">;</span>
    default:
      <span class="hljs-attr">priority</span> = geoLocationManager.LocationRequestPriority.BALANCED<span class="hljs-comment">;</span>
  }
  
  return {
    priority: priority,
    interval: <span class="hljs-attr">deviceInfo.deviceType</span> === <span class="hljs-string">'watch'</span> ? <span class="hljs-number">10000</span> : <span class="hljs-number">5000</span>, // 手表定位间隔 longer
    distance: 10,
    scenario: geoLocationManager.LocationScenario.NAVIGATION
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-7">三、整合三大服务：位置提醒 APP 完整实现</h2>
<h3 data-id="heading-8">1. 项目核心流程</h3>
<ol>
<li>应用启动：获取设备信息，适配 UI 布局和定位策略；</li>
<li>权限申请：批量申请通知权限和定位权限；</li>
<li>设置目标：用户输入或选择目标位置（经纬度）；</li>
<li>定位监听：启动持续定位，实时计算与目标位置的距离；</li>
<li>提醒触发：到达目标区域，发送通知并停止定位；</li>
<li>点击跳转：用户点击通知，进入应用查看详情。</li>
</ol>
<h3 data-id="heading-9">2. 完整代码实现</h3>
<h4 data-id="heading-10">（1）全局工具类整合（utils/SystemServiceUtil.ets）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 整合前两篇的通知、定位工具方法，加上设备信息方法</span>
<span class="hljs-keyword">import</span> abilityAccessCtrl <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.abilityAccessCtrl'</span>;
<span class="hljs-keyword">import</span> notification <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.notification'</span>;
<span class="hljs-keyword">import</span> wantAgent <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.wantAgent'</span>;
<span class="hljs-keyword">import</span> geoLocationManager <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.geolocation'</span>;
<span class="hljs-keyword">import</span> deviceInfo <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.deviceInfo'</span>;
<span class="hljs-keyword">import</span> screen <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.screen'</span>;
<span class="hljs-keyword">import</span> common <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.app.ability.common'</span>;

<span class="hljs-comment">// 权限申请：批量申请通知和定位权限</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">requestAllPermissions</span>(<span class="hljs-params">context: common.UIAbilityContext</span>): <span class="hljs-title class_">Promise</span>&lt;boolean&gt; {
  <span class="hljs-keyword">const</span> permissions = [
    <span class="hljs-string">'ohos.permission.NOTIFICATION_CONTROLLER'</span>,
    <span class="hljs-string">'ohos.permission.APPROXIMATELY_LOCATION'</span>,
    <span class="hljs-string">'ohos.permission.LOCATION'</span>
  ];
  
  <span class="hljs-keyword">const</span> atManager = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> authResults = <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">checkAccessToken</span>(
      abilityAccessCtrl.<span class="hljs-title function_">createTokenID</span>(),
      permissions
    );
    
    <span class="hljs-keyword">const</span> needReqPerms = permissions.<span class="hljs-title function_">filter</span>(
      <span class="hljs-function">(<span class="hljs-params">perm, index</span>) =&gt;</span> authResults[index] !== abilityAccessCtrl.<span class="hljs-property">GrantStatus</span>.<span class="hljs-property">PERMISSION_GRANTED</span>
    );
    
    <span class="hljs-keyword">if</span> (needReqPerms.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    
    <span class="hljs-keyword">const</span> reqResult = <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">requestPermissionsFromUser</span>(context, needReqPerms);
    <span class="hljs-keyword">return</span> reqResult.<span class="hljs-property">authResults</span>.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">status</span> =&gt;</span> status === <span class="hljs-number">0</span>);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`批量权限申请失败：<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
}

<span class="hljs-comment">// 设备信息方法（同上篇）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getDeviceBaseInfo</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 省略，复用前文代码 */</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getScreenInfo</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 省略，复用前文代码 */</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getLocationConfigByDeviceType</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 省略，复用前文代码 */</span> }

<span class="hljs-comment">// 通知方法（同上篇）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createLocationReminderNotification</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 省略，复用前文代码 */</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendNotification</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 省略，复用前文代码 */</span> }

<span class="hljs-comment">// 定位方法（同上篇）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startContinuousLocation</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 省略，复用前文代码 */</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">stopContinuousLocation</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 省略，复用前文代码 */</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isReachTargetArea</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 省略，复用前文代码 */</span> }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-11">（2）主页面实现（pages/LocationReminderPage.ets）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> common <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.app.ability.common'</span>;
<span class="hljs-keyword">import</span> {
  requestAllPermissions,
  getDeviceBaseInfo,
  getScreenInfo,
  getLocationConfigByDeviceType,
  createLocationReminderNotification,
  sendNotification,
  startContinuousLocation,
  stopContinuousLocation,
  isReachTargetArea
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/SystemServiceUtil'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">LocationReminderPage</span> {
  <span class="hljs-keyword">private</span> context = <span class="hljs-title function_">getContext</span>(<span class="hljs-variable language_">this</span>) <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;
  <span class="hljs-meta">@State</span> <span class="hljs-attr">deviceInfoStr</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;
  <span class="hljs-meta">@State</span> <span class="hljs-attr">currentLocation</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'未获取位置'</span>;
  <span class="hljs-meta">@State</span> <span class="hljs-attr">targetLat</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'39.9042'</span>; <span class="hljs-comment">// 目标纬度默认值</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">targetLng</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'116.4074'</span>; <span class="hljs-comment">// 目标经度默认值</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">reminderRadius</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">100</span>; <span class="hljs-comment">// 提醒半径（米）</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">isTracking</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;

  <span class="hljs-comment">// 页面加载时获取设备信息</span>
  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadDeviceInfo</span>();
  }

  <span class="hljs-comment">// 加载设备信息</span>
  <span class="hljs-title function_">loadDeviceInfo</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> deviceInfo = <span class="hljs-title function_">getDeviceBaseInfo</span>();
    <span class="hljs-keyword">const</span> screenInfo = <span class="hljs-title function_">getScreenInfo</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deviceInfoStr</span> = <span class="hljs-string">`设备：<span class="hljs-subst">${deviceInfo.manufacturer}</span> <span class="hljs-subst">${deviceInfo.deviceModel}</span> | 系统：<span class="hljs-subst">${deviceInfo.osVersion}</span> | 屏幕：<span class="hljs-subst">${screenInfo.screenWidth}</span>x<span class="hljs-subst">${screenInfo.screenHeight}</span>`</span>;
  }

  <span class="hljs-comment">// 启动位置提醒</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">startReminder</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 检查权限</span>
    <span class="hljs-keyword">const</span> allGranted = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestAllPermissions</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);
    <span class="hljs-keyword">if</span> (!allGranted) {
      <span class="hljs-title class_">Toast</span>.<span class="hljs-title function_">show</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'部分权限未授予，无法启动提醒'</span> });
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 2. 验证目标位置</span>
    <span class="hljs-keyword">const</span> targetLoc = {
      <span class="hljs-attr">latitude</span>: <span class="hljs-built_in">parseFloat</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">targetLat</span>),
      <span class="hljs-attr">longitude</span>: <span class="hljs-built_in">parseFloat</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">targetLng</span>)
    };
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(targetLoc.<span class="hljs-property">latitude</span>) || <span class="hljs-built_in">isNaN</span>(targetLoc.<span class="hljs-property">longitude</span>)) {
      <span class="hljs-title class_">Toast</span>.<span class="hljs-title function_">show</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'目标位置格式错误'</span> });
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 3. 启动持续定位（根据设备类型适配配置）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isTracking</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-title class_">Toast</span>.<span class="hljs-title function_">show</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'位置提醒已启动，正在跟踪您的位置'</span> });
    
    <span class="hljs-title function_">startContinuousLocation</span>(<span class="hljs-function">(<span class="hljs-params">currentLoc</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentLocation</span> = <span class="hljs-string">`当前：纬度<span class="hljs-subst">${currentLoc.latitude.toFixed(<span class="hljs-number">6</span>)}</span>，经度<span class="hljs-subst">${currentLoc.longitude.toFixed(<span class="hljs-number">6</span>)}</span>`</span>;
      
      <span class="hljs-comment">// 4. 判断是否到达目标区域</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isReachTargetArea</span>(currentLoc, targetLoc, <span class="hljs-variable language_">this</span>.<span class="hljs-property">reminderRadius</span>)) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendReminderNotification</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stopReminder</span>();
      }
    }, <span class="hljs-title function_">getLocationConfigByDeviceType</span>());
  }

  <span class="hljs-comment">// 发送提醒通知</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">sendReminderNotification</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> notification = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createLocationReminderNotification</span>(
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>,
      <span class="hljs-string">'位置提醒'</span>,
      <span class="hljs-string">`您已到达目标区域（半径<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.reminderRadius}</span>米），点击查看详情`</span>
    );
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">sendNotification</span>(notification);
  }

  <span class="hljs-comment">// 停止位置提醒</span>
  <span class="hljs-title function_">stopReminder</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">stopContinuousLocation</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isTracking</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-title class_">Toast</span>.<span class="hljs-title function_">show</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'位置提醒已停止'</span> });
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">25</span> })
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">padding</span>(<span class="hljs-number">30</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-params"><span class="hljs-string">'#f5f5f5'</span></span>) {
      
      <span class="hljs-comment">// 标题区域</span>
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'位置提醒APP'</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">36</span>)
        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
        .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      
      <span class="hljs-comment">// 设备信息区域</span>
      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">deviceInfoStr</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)
        .<span class="hljs-title function_">color</span>(<span class="hljs-string">'#666'</span>)
        .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_">lineHeight</span>(<span class="hljs-number">24</span>)
      
      <span class="hljs-comment">// 目标位置输入区域</span>
      <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">15</span> })
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_">padding</span>(<span class="hljs-number">20</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ffffff'</span>)
        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-params"><span class="hljs-number">12</span></span>) {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'目标位置设置'</span>)
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Medium</span>)
        
        <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> })
          .<span class="hljs-title function_">width</span>(<span class="hljs-params"><span class="hljs-string">'100%'</span></span>) {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'纬度：'</span>)
            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'20%'</span>)
          <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetLat</span> })
            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)
            .<span class="hljs-title function_">height</span>(<span class="hljs-number">45</span>)
            .<span class="hljs-title function_">padding</span>(<span class="hljs-number">10</span>)
            .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#eee'</span> })
            .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)
            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
            .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetLat</span> = value)
        }
        
        <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> })
          .<span class="hljs-title function_">width</span>(<span class="hljs-params"><span class="hljs-string">'100%'</span></span>) {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'经度：'</span>)
            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'20%'</span>)
          <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetLng</span> })
            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)
            .<span class="hljs-title function_">height</span>(<span class="hljs-number">45</span>)
            .<span class="hljs-title function_">padding</span>(<span class="hljs-number">10</span>)
            .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#eee'</span> })
            .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)
            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
            .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetLng</span> = value)
        }
        
        <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> })
          .<span class="hljs-title function_">width</span>(<span class="hljs-params"><span class="hljs-string">'100%'</span></span>) {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'提醒半径：'</span>)
            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'30%'</span>)
          <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">reminderRadius</span>.<span class="hljs-title function_">toString</span>() })
            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'70%'</span>)
            .<span class="hljs-title function_">height</span>(<span class="hljs-number">45</span>)
            .<span class="hljs-title function_">padding</span>(<span class="hljs-number">10</span>)
            .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#eee'</span> })
            .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)
            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
            .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">reminderRadius</span> = <span class="hljs-built_in">parseInt</span>(value) || <span class="hljs-number">100</span>)
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'米'</span>)
            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
            .<span class="hljs-title function_">marginLeft</span>(<span class="hljs-number">10</span>)
        }
      }
      
      <span class="hljs-comment">// 当前位置显示</span>
      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentLocation</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">padding</span>(<span class="hljs-number">15</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ffffff'</span>)
        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">12</span>)
      
      <span class="hljs-comment">// 操作按钮区域</span>
      <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">30</span> })
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-params">FlexAlign.Center</span>) {
        <span class="hljs-title class_">Button</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isTracking</span> ? <span class="hljs-string">'停止提醒'</span> : <span class="hljs-string">'启动提醒'</span>)
          .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)
          .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)
          .<span class="hljs-title function_">height</span>(<span class="hljs-number">60</span>)
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isTracking</span> ? <span class="hljs-string">'#ff4d4f'</span> : <span class="hljs-string">'#2f54eb'</span>)
          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isTracking</span>) {
              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stopReminder</span>();
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startReminder</span>();
            }
          })
      }
    }
  }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-12">（3）配置文件完善（module.json5）</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"package"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"com.example.locationreminder"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"LocationReminder"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"mainAbility"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MainAbility"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"requestPermissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.NOTIFICATION_CONTROLLER"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用于发送位置到达提醒通知"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"usedScene"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"MainAbility"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"when"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"always"</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.APPROXIMATELY_LOCATION"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用于获取大致位置，提供位置提醒服务"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"usedScene"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"MainAbility"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"when"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"inuse"</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.LOCATION"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用于获取精准位置，提升提醒准确性"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"usedScene"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"MainAbility"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"when"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"inuse"</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">".MainAbility"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"page"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"visible"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"skills"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"entities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"entity.system.home"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"actions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"action.system.home"</span><span class="hljs-punctuation">]</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-13">四、APP 核心功能说明</h2>
<h3 data-id="heading-14">1. 设备适配能力</h3>
<ul>
<li>自动识别设备类型（手机 / 平板 / 手表），调整定位策略；</li>
<li>根据屏幕尺寸自适应 UI 布局，在不同设备上显示正常；</li>
<li>适配不同 API 版本，避免因系统版本差异导致功能异常。</li>
</ul>
<h3 data-id="heading-15">2. 合规性保障</h3>
<ul>
<li>批量申请权限，明确告知用户权限用途；</li>
<li>定位和通知功能可手动启停，用户可控；</li>
<li>到达目标后自动停止定位，降低功耗，符合系统规范。</li>
</ul>
<h3 data-id="heading-16">3. 用户体验优化</h3>
<ul>
<li>实时显示当前位置和设备信息，状态透明；</li>
<li>支持自定义目标位置和提醒半径，灵活适配不同场景；</li>
<li>通知点击跳转应用，形成功能闭环。</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F46b54a56c7e54e74973e0af43c077bff%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" title="https://developer.huawei.com/consumer/cn/training/classDetail/46b54a56c7e54e74973e0af43c077bff?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" target="_blank" ref="nofollow noopener noreferrer">加入班级，学习鸿蒙开发</a></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在高并发分布式SpringCloud系统中，什么时候时候并行查询，提高查询接口效率，从10s到100ms]]></title>    <link>https://juejin.cn/post/7582755817670361098</link>    <guid>https://juejin.cn/post/7582755817670361098</guid>    <pubDate>2025-12-12T06:50:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582755817670361098" data-draft-id="7582755817670344714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在高并发分布式SpringCloud系统中，什么时候时候并行查询，提高查询接口效率，从10s到100ms"/> <meta itemprop="keywords" content="分布式,Java,后端"/> <meta itemprop="datePublished" content="2025-12-12T06:50:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈哈哈笑什么"/> <meta itemprop="url" content="https://juejin.cn/user/808832912075352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在高并发分布式SpringCloud系统中，什么时候时候并行查询，提高查询接口效率，从10s到100ms
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/808832912075352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈哈哈笑什么
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:50:46.000Z" title="Fri Dec 12 2025 06:50:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    17
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为Java后端（Spring Cloud）开发，针对“查询接口是否适合并行查询并归整”，核心判断标准是 <strong>“任务独立性”“并行收益成本比”“数据一致性要求”</strong> 。以下是「适用场景」「绝对不适用场景」的详细拆解，结合实际业务场景和技术实现建议，确保可直接落地：</p>
<h2 data-id="heading-0">一、适合并行查询并归整的场景（满足任意1条核心条件+收益&gt;成本）</h2>
<h3 data-id="heading-1">核心前提（必满足）</h3>
<ol>
<li>多个查询任务 <strong>无依赖关系</strong>（不需要前一个查询的结果作为后一个的入参）；</li>
<li>单个查询是 <strong>纯读操作</strong>（无写逻辑，不会修改数据，无状态）；</li>
<li>并行的 <strong>总耗时 &lt; 串行总耗时</strong>（避免“小任务并行”导致线程切换开销大于收益）。</li>
</ol>
<h3 data-id="heading-2">具体场景（附业务例子+技术实现）</h3>
<h4 data-id="heading-3">1. 多维度数据聚合查询（无依赖）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：一个接口需要返回“多维度独立数据”，每个维度的查询互不依赖，串行查询会导致总耗时=各接口耗时之和，并行可将总耗时降至“最长单个接口耗时”。</p>
</li>
<li>
<p><strong>业务例子</strong>：</p>
<ul>
<li>订单详情页：需查询「订单基本信息」「订单商品列表」「用户收货地址」「支付记录」「优惠券使用记录」，5个查询无依赖（入参都是订单ID/用户ID，无需互相等待）；</li>
<li>首页数据聚合：查询「热门商品列表」「用户个性化推荐」「公告信息」「购物车数量」，4个查询独立。</li>
</ul>
</li>
<li>
<p><strong>判断标准</strong>：</p>
<ul>
<li>每个子查询的入参相同（或可提前确定，无需前序结果）；</li>
<li>单个子查询耗时≥50ms（如果单个查询仅10ms，并行的线程切换开销可能超过收益）。</li>
</ul>
</li>
<li>
<p><strong>技术实现（Spring Cloud环境）</strong> ：</p>
<ul>
<li>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 用CompletableFuture实现异步并行（推荐IO密集型查询）</span>
<span class="hljs-keyword">@Service</span>
public class OrderDetailService {
    <span class="hljs-keyword">@Autowired</span>
    private OrderMapper orderMapper;
    <span class="hljs-keyword">@Autowired</span>
    private OrderItemFeignClient orderItemFeign; <span class="hljs-comment">// 跨服务Feign接口</span>
    <span class="hljs-keyword">@Autowired</span>
    private UserAddressFeignClient addressFeign;
    <span class="hljs-keyword">@Autowired</span>
    private ExecutorService asyncQueryExecutor; <span class="hljs-comment">// 自定义线程池（避免用默认线程池）</span>

    public OrderDetailVO <span class="hljs-built_in">getOrderDetail</span>(Long orderId, Long userId) {
        <span class="hljs-comment">// 1. 并行发起多个查询（无依赖）</span>
        CompletableFuture&lt;OrderPO&gt; orderFuture = CompletableFuture<span class="hljs-selector-class">.supplyAsync</span>(
            () -&gt; orderMapper<span class="hljs-selector-class">.selectById</span>(orderId),
            asyncQueryExecutor
        );
        CompletableFuture&lt;List&lt;OrderItemVO&gt;&gt; itemFuture = CompletableFuture<span class="hljs-selector-class">.supplyAsync</span>(
            () -&gt; orderItemFeign<span class="hljs-selector-class">.listByOrderId</span>(orderId),
            asyncQueryExecutor
        );
        CompletableFuture&lt;AddressVO&gt; addressFuture = CompletableFuture<span class="hljs-selector-class">.supplyAsync</span>(
            () -&gt; addressFeign<span class="hljs-selector-class">.getByUserId</span>(userId),
            asyncQueryExecutor
        );

        <span class="hljs-comment">// 2. 等待所有查询完成，归整结果（异常统一捕获）</span>
        try {
            CompletableFuture<span class="hljs-selector-class">.allOf</span>(orderFuture, itemFuture, addressFuture)<span class="hljs-selector-class">.join</span>();
            return OrderDetailVO<span class="hljs-selector-class">.builder</span>()
                <span class="hljs-selector-class">.order</span>(orderFuture.get())
                <span class="hljs-selector-class">.items</span>(itemFuture.get())
                <span class="hljs-selector-class">.address</span>(addressFuture.get())
                <span class="hljs-selector-class">.build</span>();
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("并行查询订单详情失败", e);
            throw new <span class="hljs-built_in">BusinessException</span>("查询订单详情失败");
        }
    }
}
</code></pre>
</li>
<li>注意：线程池需自定义（核心线程数=CPU核心数×2+1，最大线程数=CPU核心数×4，队列容量适中），避免用<code>ForkJoinPool.commonPool()</code>（易被其他任务占满）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">2. 跨服务无依赖接口查询（微服务场景）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：Spring Cloud微服务架构中，一个服务需要调用多个其他服务的查询接口，且这些接口无依赖（如调用用户服务、商品服务、库存服务的查询接口）。</p>
</li>
<li>
<p><strong>业务例子</strong>：</p>
<ul>
<li>商品详情页：调用「商品服务（商品基本信息）」「库存服务（当前库存）」「评价服务（好评率）」「促销服务（当前活动）」，4个跨服务查询独立。</li>
</ul>
</li>
<li>
<p><strong>判断标准</strong>：</p>
<ul>
<li>跨服务接口是幂等的（多次调用结果一致，无副作用）；</li>
<li>单个跨服务接口耗时≥100ms（跨网络IO耗时较长，并行收益明显）。</li>
</ul>
</li>
<li>
<p><strong>技术实现</strong>：Feign异步调用（配合CompletableFuture），或使用Resilience4j的异步熔断降级（避免单个服务超时导致整体阻塞）。</p>
</li>
</ul>
<h4 data-id="heading-5">3. 批量数据拆分查询（大数据量场景）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：查询条件可拆分为多个独立子条件，每个子条件查询部分数据，最后合并结果（如按ID分片、按时间分片）。</p>
</li>
<li>
<p><strong>业务例子</strong>：</p>
<ul>
<li>查询“近3个月的订单统计”，拆分为“1月订单”“2月订单”“3月订单”3个独立查询，并行执行后汇总统计结果；</li>
<li>批量查询100个用户的信息，拆分为10个批次（每批10个用户ID），并行查询后合并列表。</li>
</ul>
</li>
<li>
<p><strong>判断标准</strong>：</p>
<ul>
<li>拆分后的子查询无重叠数据（避免重复统计）；</li>
<li>单条查询数据量较大（如10万+），拆分后可减少单条SQL的执行压力。</li>
</ul>
</li>
<li>
<p><strong>技术实现</strong>：用<code>ListUtils.partition()</code>拆分入参，配合CompletableFuture并行执行，最后用<code>Stream.concat()</code>合并结果。</p>
</li>
</ul>
<h4 data-id="heading-6">4. 冷热数据分离查询（优化响应速度）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：查询结果包含“热数据”（高频访问，如缓存中的用户信息）和“冷数据”（低频访问，如数据库中的历史记录），冷数据查询耗时较长，可并行查询冷热数据。</p>
</li>
<li>
<p><strong>业务例子</strong>：</p>
<ul>
<li>用户个人中心：查询「缓存中的用户基本信息（热数据，10ms）」和「数据库中的用户历史订单统计（冷数据，500ms）」，并行查询后合并。</li>
</ul>
</li>
<li>
<p><strong>判断标准</strong>：冷数据查询耗时明显高于热数据（如冷数据耗时是热数据的5倍以上）。</p>
</li>
</ul>
<h2 data-id="heading-7">二、绝对不能并行查询的场景（强行并行必出问题）</h2>
<h3 data-id="heading-8">核心原因（满足任意1条即禁止）</h3>
<ol start="4">
<li>查询任务 <strong>有依赖关系</strong>（后一个查询需要前一个的结果作为入参）；</li>
<li>查询涉及 <strong>状态修改</strong>（非纯读操作，如查询时触发数据更新、计数累加）；</li>
<li>要求 <strong>强一致性</strong>（并行可能导致数据不一致、重复或遗漏）；</li>
<li>查询是 <strong>非幂等</strong> 的（多次调用结果不同，有副作用）。</li>
</ol>
<h3 data-id="heading-9">具体场景（附风险点+正确做法）</h3>
<h4 data-id="heading-10">1. 有依赖关系的查询（串行是唯一选择）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：后一个查询的入参必须是前一个查询的结果（如“先查用户ID，再查该用户的订单；先查订单ID，再查该订单的商品”）。</p>
</li>
<li>
<p><strong>业务例子</strong>：</p>
<ul>
<li>流程：查询“用户的最新订单” → 用该订单ID查询“订单商品” → 用商品ID查询“商品库存”，3个查询有严格依赖。</li>
</ul>
</li>
<li>
<p><strong>风险点</strong>：并行查询会导致后一个查询“拿不到入参”或“拿到错误入参”，直接报错或返回无效数据。</p>
</li>
<li>
<p><strong>正确做法</strong>：串行执行，或通过SQL关联查询（如<code>JOIN</code>）减少查询次数，而非并行。</p>
</li>
</ul>
<h4 data-id="heading-11">2. 涉及数据修改的“查询”（非纯读操作）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：看似是查询接口，但内部包含写逻辑（如“查询用户积分”时，触发“积分过期扣除”；“查询订单列表”时，触发“订单状态自动更新”）。</p>
</li>
<li>
<p><strong>风险点</strong>：并行执行会导致 <strong>并发修改问题</strong>（如同一用户的积分被多个线程同时扣除，导致数据不一致）、 <strong>锁竞争加剧</strong>（如并行查询都需要获取数据库行锁，导致死锁或超时）。</p>
</li>
<li>
<p><strong>正确做法</strong>：</p>
<ul>
<li>拆分接口：将“写逻辑”单独抽为写接口，查询接口仅做纯读；</li>
<li>若无法拆分，必须串行执行，且加分布式锁（如Redisson锁）保证原子性。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-12">3. 强一致性要求的关联查询（并行会破坏一致性）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：查询结果需要满足“原子性”，即所有关联数据必须是同一时间点的快照（如“查询订单金额+该订单的支付金额”，要求两者一致，不能出现“订单金额已更新，支付金额还是旧值”）。</p>
</li>
<li>
<p><strong>业务例子</strong>：</p>
<ul>
<li>财务对账接口：查询“订单表的总金额”和“支付表的总金额”，要求两者严格相等（同一时间点的数据）。</li>
</ul>
</li>
<li>
<p><strong>风险点</strong>：并行查询可能访问不同的数据库分片/副本，或在查询过程中数据被修改，导致两者数据不一致（如订单表查询完后，支付表数据被更新，支付表查询结果是新值）。</p>
</li>
<li>
<p><strong>正确做法</strong>：</p>
<ul>
<li>用分布式事务（如Seata TCC）或数据库事务（同一库内用<code>@Transactional</code>）保证一致性；</li>
<li>单条SQL关联查询（如<code>SELECT o.amount, p.amount FROM order o JOIN payment p ON o.id = p.order_id</code>），而非拆分并行。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-13">4. 非幂等的查询接口（并行会产生副作用）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：查询接口的结果依赖于“调用次数”或“调用顺序”（如“查询用户的下一个序列号”“查询当前队列的下一个任务”），多次调用结果不同。</p>
</li>
<li>
<p><strong>业务例子</strong>：</p>
<ul>
<li>接口<code>getNextSequence()</code>：每次调用返回递增的序列号（内部用<code>SELECT MAX(id)+1</code>实现），并行调用会导致多个线程返回相同的序列号（并发问题）。</li>
</ul>
</li>
<li>
<p><strong>风险点</strong>：并行调用会导致数据重复、序号冲突、逻辑错乱（如多个订单拿到相同的序列号）。</p>
</li>
<li>
<p><strong>正确做法</strong>：</p>
<ul>
<li>接口改为幂等设计（如用分布式ID生成器替代<code>MAX(id)+1</code>）；</li>
<li>若无法修改，必须串行执行，且加分布式锁保证唯一性。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-14">5. 高并发下的数据库行锁竞争查询（并行会导致性能雪崩）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：查询接口需要获取数据库行锁（如<code>SELECT ... FOR UPDATE</code>，悲观锁），且查询的是同一行数据（如高频查询“商品库存”并加锁，防止超卖）。</p>
</li>
<li>
<p><strong>风险点</strong>：并行查询会导致大量线程阻塞在锁竞争上，CPU利用率飙升，接口响应时间从毫秒级变为秒级，最终引发性能雪崩。</p>
</li>
<li>
<p><strong>正确做法</strong>：</p>
<ul>
<li>用乐观锁替代悲观锁（如<code>WHERE id=? AND version=?</code>）；</li>
<li>若必须用悲观锁，限制并发数（如用Redisson限流），且串行执行核心查询逻辑。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-15">6. 分页查询/滚动查询（并行会导致数据重复/遗漏）</h4>
<ul>
<li><strong>场景描述</strong>：需要按顺序分页查询数据（如“查询第1页订单→第2页订单→第3页订单”），或按游标滚动查询（如<code>WHERE id &gt; ? LIMIT 100</code>）。</li>
<li><strong>风险点</strong>：并行查询会导致分页顺序错乱（如第2页查询先执行，拿到第1页的数据），或数据重复（多个线程查询同一页）、数据遗漏（部分页面未查询）。</li>
<li><strong>正确做法</strong>：串行执行分页/滚动查询，或通过分片键（如按用户ID哈希分片）并行查询不同分片的数据（无重复无遗漏）。</li>
</ul>
<h2 data-id="heading-16">三、核心判断原则（快速决策表）</h2>








































<table><thead><tr><th>判断维度</th><th>适合并行</th><th>不适合并行</th></tr></thead><tbody><tr><td>任务依赖</td><td>无依赖（入参提前确定）</td><td>有依赖（后一个需前一个结果）</td></tr><tr><td>操作类型</td><td>纯读操作（无写逻辑）</td><td>含写逻辑（如更新、计数）</td></tr><tr><td>一致性要求</td><td>最终一致性（允许短暂不一致）</td><td>强一致性（需同一时间点快照）</td></tr><tr><td>幂等性</td><td>幂等（多次调用结果一致）</td><td>非幂等（多次调用结果不同）</td></tr><tr><td>耗时收益</td><td>单个查询≥50ms，并行总耗时更短</td><td>单个查询&lt;50ms，线程切换开销占比高</td></tr><tr><td>锁竞争</td><td>无锁或弱锁（如读锁）</td><td>强锁竞争（如写锁、行锁）</td></tr></tbody></table>
<h2 data-id="heading-17">四、Spring Cloud环境下的并行查询最佳实践</h2>
<ol start="8">
<li><strong>线程池配置</strong>：自定义IO密集型线程池（核心线程数=CPU核心数×2+1），避免使用默认线程池（如<code>CompletableFuture.supplyAsync()</code>无自定义线程池时，使用<code>ForkJoinPool.commonPool()</code>，易被耗尽）。</li>
<li><strong>超时控制</strong>：给每个并行任务设置超时时间（如<code>CompletableFuture.get(3, TimeUnit.SECONDS)</code>），避免单个任务超时导致整体阻塞。</li>
<li><strong>熔断降级</strong>：用Resilience4j/CircuitBreaker对跨服务并行查询做熔断（如某个服务超时率达50%，则熔断该服务，返回默认数据），保证整体可用性。</li>
<li><strong>异常处理</strong>：用<code>CompletableFuture.exceptionally()</code>或<code>handle()</code>统一捕获单个任务的异常，避免一个任务失败导致整个并行流程失败（如“商品库存查询失败，可返回默认库存为0，而非整个商品详情页查询失败”）。</li>
<li><strong>结果归整</strong>：用<code>CompletableFuture.allOf()</code>等待所有任务完成，再统一归整结果（避免多次<code>join()</code>导致阻塞），或用<code>CompletableFuture.anyOf()</code>获取最快返回的结果（适用于“多个数据源查询同一数据，取最快的一个”场景）。</li>
</ol>
<h2 data-id="heading-18">总结</h2>
<ul>
<li><strong>适合并行</strong>：核心是“无依赖、纯读、幂等、并行收益&gt;开销”，典型场景是多维度数据聚合、跨服务无依赖查询、批量拆分查询。</li>
<li><strong>绝对不能并行</strong>：核心是“有依赖、有写逻辑、强一致性、非幂等”，典型场景是依赖查询、含写操作的查询、强一致性对账、非幂等查询。</li>
</ul>
<p>实际开发中，先通过“核心判断原则”快速决策，再用Spring Cloud+CompletableFuture/自定义线程池实现并行，同时做好超时、熔断、异常处理，避免踩坑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app开发路上的坑]]></title>    <link>https://juejin.cn/post/7582755817670115338</link>    <guid>https://juejin.cn/post/7582755817670115338</guid>    <pubDate>2025-12-12T06:21:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582755817670115338" data-draft-id="7581691182004502538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app开发路上的坑"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-12T06:21:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="InkHeart"/> <meta itemprop="url" content="https://juejin.cn/user/2928754708457783"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app开发路上的坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2928754708457783/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    InkHeart
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:21:47.000Z" title="Fri Dec 12 2025 06:21:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#5f6368;background-image:linear-gradient(90deg,rgba(240,191,213,.1) 3%,transparent 0),linear-gradient(1turn,rgba(240,191,213,.1) 3%,transparent 0);background-size:20px 20px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-left:50px;padding-bottom:5px;color:#5f6368}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:0;display:block;content:""}.markdown-body h1{font-size:32px;margin-bottom:5px}.markdown-body h1:before{top:0;content:"🦄";font-size:32px}.markdown-body h2{padding-bottom:24px;border-bottom:1px solid #ececec}.markdown-body h2:before{top:0;left:8px;content:"🐳";font-size:24px}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{top:-2px;left:8px;content:"🐄";font-size:20px}.markdown-body h4{font-size:16px}.markdown-body h4:before{top:-2px;left:8px;content:"🦥";font-size:18px}.markdown-body h5{font-size:14px}.markdown-body h5:before{top:-2px;left:9px;content:"🦩";font-size:16px}.markdown-body h6{font-size:12px;margin-top:5px}.markdown-body h6:before{top:-1px;left:10px;content:"🐧";font-size:14px}.markdown-body p{line-height:1.9;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid rgba(253,121,168,.5);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#a6accd;background:#292d3e;border-radius:8px}.markdown-body a{text-decoration:none;color:#fd79a8;border-bottom:1px solid #fd79a8;padding:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(253,121,168,.1);color:#ee69a9}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body th{color:#fd79a8}.markdown-body th,.markdown-body tr:hover{background:rgba(253,121,168,.1)}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;color:#666;padding:23px;margin:22px 0;border-left:4px solid #ee69a9;background-color:rgba(253,121,168,.1)}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;display:block;font-size:27px;color:#fd79a8;opacity:.8}.markdown-body blockquote:before{left:10px;top:0;content:"❝"}.markdown-body blockquote:after{right:10px;bottom:0;content:"❞"}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body strong{position:relative;color:#fd79a8}.markdown-body strong:before{content:"· "}.markdown-body strong:after{content:" ·"}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#fd79a8}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ee69a9}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前情提要</h2>
<p>记录一下使用uni-app + Vue3开发项目过程中遇到问题、以及解决方法。</p>
<h2 data-id="heading-1">map组件使用问题</h2>
<h3 data-id="heading-2">skew属性</h3>
<p>配置skew属性后个别手机（vivo iqoo neo11）中心点或者缩放异常（设置了坐标在广东，打开地图却定位在北京，或者定位对了但是缩放错误），未找到确切原因，为保证应用正常使用，删除了skew配置。</p>
<h3 data-id="heading-3">触摸事件穿透</h3>
<p>设置了元素定位在地图上方时，滑动元素，底部地图会跟随移动，常见于苹果手机，通过设置以下代码即可：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">view</span> @<span class="hljs-attr">touchmove.stop.prevent</span>=<span class="hljs-string">"stopTouchMove"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">stopTouchMove</span> = (<span class="hljs-params"/>) =&gt; {}
</code></pre>
<h2 data-id="heading-4">Wot UI FloatingPanel浮动面板交互优化</h2>
<p>当FloatingPanel包含滚动列表时，在内容区向上滑动，不会触发面板展开，只会滚动列表，不符合使用的习惯，应该改为：内容区向上滑动，判断面板是否完全展开，是则列表滚动，否则展开面板</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 父组件 传入子组件浮动面板的高度、展开高度 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">wd-floating-panel</span> <span class="hljs-attr">v-model:height</span>=<span class="hljs-string">"height"</span> <span class="hljs-attr">:anchors</span>=<span class="hljs-string">"anchors"</span> <span class="hljs-attr">:safeAreaInsetBottom</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">:showScrollbar</span>=<span class="hljs-string">"false"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">PromotionList</span> <span class="hljs-attr">:panelHeight</span>=<span class="hljs-string">"height"</span> <span class="hljs-attr">:panelMaxHeight</span>=<span class="hljs-string">"panelMaxHeight"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">wd-floating-panel</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 子组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">scroll-view</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height: 100%;"</span> <span class="hljs-attr">:scroll-y</span>=<span class="hljs-string">"scrollY"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">scroll-view</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 子组件，设置计算属性scrollY，判断浮动面板高度达到最大高度则允许垂直方向的滚动，否则禁用</span>
<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
    <span class="hljs-comment">// 浮动面板高度</span>
    <span class="hljs-attr">panelHeight</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>
    },
    <span class="hljs-comment">// 浮动面板最大高度</span>
    <span class="hljs-attr">panelMaxHeight</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>
    }
})

<span class="hljs-keyword">const</span> scrollY = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> props.<span class="hljs-property">panelHeight</span> === props.<span class="hljs-property">panelMaxHeight</span>
})
</code></pre>
<h2 data-id="heading-5">启用分享功能</h2>
<p>通过混入(mixin)方式设置指定页面启用分享功能</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// shareMixin.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">share</span>: {
        <span class="hljs-attr">title</span>: <span class="hljs-string">"标题"</span>,
        <span class="hljs-attr">path</span>: <span class="hljs-string">"页面路由"</span>,
      },
    };
  },
  <span class="hljs-comment">// 分享到微信好友功能</span>
  <span class="hljs-title function_">onShareAppMessage</span>(<span class="hljs-params">res</span>) {
    <span class="hljs-comment">// 获取当前页面标题</span>
    <span class="hljs-keyword">const</span> pages = <span class="hljs-title function_">getCurrentPages</span>();
    <span class="hljs-keyword">const</span> data = pages[pages.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]?.<span class="hljs-property">$page</span>;
    <span class="hljs-keyword">const</span> { title, path } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">share</span>;
    <span class="hljs-keyword">return</span> {
      title,
      <span class="hljs-attr">path</span>: data?.<span class="hljs-property">fullPath</span> || path,
      <span class="hljs-title function_">success</span>(<span class="hljs-params">res</span>) {
        uni.<span class="hljs-title function_">showToast</span>({
          <span class="hljs-attr">title</span>: <span class="hljs-string">"分享成功"</span>,
        });
      },
      <span class="hljs-title function_">fail</span>(<span class="hljs-params">res</span>) {
        uni.<span class="hljs-title function_">showToast</span>({
          <span class="hljs-attr">title</span>: <span class="hljs-string">"分享失败"</span>,
          <span class="hljs-attr">icon</span>: <span class="hljs-string">"none"</span>,
        });
      },
    };
  },
  <span class="hljs-comment">// 分享到朋友圈功能</span>
  <span class="hljs-title function_">onShareTimeline</span>(<span class="hljs-params">res</span>) {
    <span class="hljs-keyword">const</span> pages = <span class="hljs-title function_">getCurrentPages</span>();
    <span class="hljs-keyword">const</span> data = pages[pages.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]?.<span class="hljs-property">$page</span>;
    <span class="hljs-keyword">const</span> { title, path } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">share</span>;
    <span class="hljs-keyword">return</span> {
      title,
      <span class="hljs-attr">path</span>: data?.<span class="hljs-property">fullPath</span> || path,
      <span class="hljs-title function_">success</span>(<span class="hljs-params">res</span>) {
        uni.<span class="hljs-title function_">showToast</span>({
          <span class="hljs-attr">title</span>: <span class="hljs-string">"分享成功"</span>,
        });
      },
      <span class="hljs-title function_">fail</span>(<span class="hljs-params">res</span>) {
        uni.<span class="hljs-title function_">showToast</span>({
          <span class="hljs-attr">title</span>: <span class="hljs-string">"分享失败"</span>,
          <span class="hljs-attr">icon</span>: <span class="hljs-string">"none"</span>,
        });
      },
    };
  },
};

</code></pre>
<h2 data-id="heading-6">富文本内容格式化</h2>
<p>富文本字符串包含的图片可能设置了固定宽度，影响预览效果，通过正则进行处理</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">formatRichImg</span>(<span class="hljs-params">content</span>) {
  <span class="hljs-keyword">if</span> (!content) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
  <span class="hljs-keyword">return</span> content
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(&lt;img\b[^&gt;]*?)\s+style=(["'])[\s\S]*?\2([^&gt;]*&gt;)/gi</span>, <span class="hljs-string">"$1$3"</span>)
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&lt;img/gi</span>, <span class="hljs-string">'&lt;img style="max-width:100%; height:auto;"'</span>);
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在前端开发中高效运用AI：从提效到避坑]]></title>    <link>https://juejin.cn/post/7582528397865811995</link>    <guid>https://juejin.cn/post/7582528397865811995</guid>    <pubDate>2025-12-12T06:20:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582528397865811995" data-draft-id="7582553782398582830" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在前端开发中高效运用AI：从提效到避坑"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-12T06:20:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是天龙_绍"/> <meta itemprop="url" content="https://juejin.cn/user/1831109918994644"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在前端开发中高效运用AI：从提效到避坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1831109918994644/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是天龙_绍
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:20:39.000Z" title="Fri Dec 12 2025 06:20:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>在日常前端开发中，如何合理、高效地运用AI工具，已成为衡量开发者工具链成熟度的重要维度。AI并非取代思考的“黑箱”，而是提升效率、辅助决策的“副驾驶”。本文将结合实践，系统介绍我在不同场景下使用AI工具的方法与原则。</p>
<hr/>
<h3 data-id="heading-0">一、代码补全与辅助开发：让编码更流畅</h3>
<p>在编码阶段，我会根据上下文选择合适的AI插件。例如，在VS Code中，<strong>TabNine</strong>擅长结合项目内的代码模式，对业务逻辑、类型定义进行智能补全，尤其适合TypeScript项目。而<strong>GitHub Copilot</strong>则更侧重于框架语法的联想与生成——当我在编写React Hooks或Vue 3 Composition API时，只需写出函数名或初步结构，它就能快速补全完整的逻辑片段，显著减少重复性输入。</p>
<blockquote>
<p>实践中，Copilot对于快速生成如<code>useEffect</code>依赖数组、表单校验函数等重复模式代码尤为高效，但需注意其生成的代码仍需人工审查逻辑正确性。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">二、组件生成与逻辑实现：从描述到代码</h3>
<p>对于常见或稍复杂的UI组件，我会借助<strong>Cursor</strong>这类具备代码库理解能力的工具。例如，在Vue项目中，通过自然语言描述“需要一个带分页的表格组件，支持排序和筛选”，Cursor可以生成包含模板、脚本与样式的完整<code>.vue</code>文件，并附有基础的性能提示（如<code>v-for</code>加<code>key</code>）。</p>
<p>在业务逻辑开发中，我常先用AI梳理步骤。例如，面对“实现一个多步骤表单，每一步需验证并缓存数据”的需求，我会先让AI输出实现流程图与关键节点，再基于此生成具体代码结构。这既避免了直接生成代码可能出现的结构混乱，也锻炼了自身拆解需求的能力。</p>
<hr/>
<h3 data-id="heading-2">三、问题排查与技术学习：成为“智能调试助手”</h3>
<p>工程问题是前端开发中的高频场景。遇到如<strong>打包体积异常增长</strong>、<strong>iOS与安卓样式兼容</strong>、或某个神秘的控制台错误时，我会将错误信息、相关配置截图或代码片段输入到<strong>ChatGPT</strong>或<strong>通义灵码</strong>中，请求其分析可能原因并提供排查方向。AI往往能给出常见的解决路径或相关文档链接，大幅缩短“盲目搜索”的时间。</p>
<p>在学习新技术时，AI同样能加速理解。例如，当我需要快速上手<code>Svelte</code>时，我会让AI生成一个包含状态管理、事件处理的最小可运行示例，并对比其与React的差异。这种“即学即用”的方式，比纯读文档更易于建立直观认知。</p>
<hr/>
<h3 data-id="heading-3">四、文档与注释生成：减轻“写作负担”</h3>
<p>良好的文档与注释是团队协作的基石。我会利用<strong>Copilot</strong>为复杂函数自动生成符合JSDoc规范的注释，涵盖参数说明、返回值与示例。对于API文档，则可使用<strong>Notion AI</strong>或类似工具，基于后端提供的OpenAPI规范JSON，快速生成结构清晰的Swagger文档草稿，后续只需稍作调整与补充。</p>
<hr/>
<h3 data-id="heading-4">五、核心原则：AI是助手，而非替代</h3>
<p>尽管AI能显著提效，但我始终坚持以下原则：</p>
<ol>
<li><strong>校验与理解</strong>：所有AI生成的代码都必须经过逻辑审查、性能评估与兼容性测试，并确保自己理解其背后的实现原理。</li>
<li><strong>避免依赖</strong>：不将AI作为决策主体，尤其在架构设计、关键算法等核心环节，保持自主思考与判断。</li>
<li><strong>持续学习</strong>：将AI作为“学习伙伴”，通过追问与迭代，深化对技术原理的理解，而非仅仅获取答案。</li>
</ol>
<hr/>
<h3 data-id="heading-5">结语</h3>
<p>在前端开发中，AI工具已逐渐成为开发者工作流中不可或缺的一环。关键在于<strong>有选择、有判断地使用</strong>——让AI处理重复、琐碎或模式化的任务，而开发者则聚焦于架构设计、逻辑抽象与创造性解决问题。如此，人与AI方能形成高效协作，共同推动开发体验与产品质量的提升。</p>
<blockquote>
<p>工具在变，但工程师的核心价值不变：批判性思维、系统化设计与持续学习的能力，始终是我们驾驭任何新技术工具的根基。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3中v-bind:class与v-bind:style如何实现条件样式、组件样式合并与深层响应式管理？]]></title>    <link>https://juejin.cn/post/7582553782398664750</link>    <guid>https://juejin.cn/post/7582553782398664750</guid>    <pubDate>2025-12-12T06:29:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582553782398664750" data-draft-id="7582561515816337471" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Vue3中v-bind:class与v-bind:style如何实现条件样式、组件样式合并与深层响应式管理？    "/> <meta itemprop="keywords" content="前端,AI编程,Trae"/> <meta itemprop="datePublished" content="2025-12-12T06:29:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kknone"/> <meta itemprop="url" content="https://juejin.cn/user/1366025597879930"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Vue3中v-bind:class与v-bind:style如何实现条件样式、组件样式合并与深层响应式管理？    
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1366025597879930/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kknone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:29:39.000Z" title="Fri Dec 12 2025 06:29:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发中，动态控制元素样式是高频需求——小到按钮点击后的高亮状态，大到根据数据状态切换组件的整体外观。Vue3 提供的 <code>v-bind:class</code>（简写 <code>:class</code>）和 <code>v-bind:style</code>（简写 <code>:style</code>）指令，让我们能以<strong>声明式</strong>的方式轻松实现这些需求。今天我们就深入学习它们的基础概念、语法逻辑，以及 Vue3 带来的响应式优化。</p>
<h2 data-id="heading-0">一、<code>v-bind:class</code>——动态切换类名</h2>
<p><code>v-bind:class</code> 的核心是<strong>根据条件添加/移除 CSS 类名</strong>，支持<strong>字符串、对象、数组</strong>三种语法，覆盖了几乎所有动态类名的场景。</p>
<h3 data-id="heading-1">1. 基础语法：从简单到复杂</h3>
<h4 data-id="heading-2">（1）字符串语法：单一动态类名</h4>
<p>适合类名完全由变量控制的场景（无需条件判断）。比如：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 根据currentType切换类名：info/warning/error --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"alert"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"currentType"</span>&gt;</span>
    {{ message }}
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 响应式变量：控制警示框类型</span>
<span class="hljs-keyword">const</span> currentType = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'info'</span>) 
<span class="hljs-keyword">const</span> message = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'这是一条提示信息'</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.alert</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>; <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>; <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span> <span class="hljs-number">0</span>; }
<span class="hljs-selector-class">.info</span> { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#d3eafd</span>; <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#90caf9</span>; }
<span class="hljs-selector-class">.warning</span> { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff3cd</span>; <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ffeeba</span>; }
<span class="hljs-selector-class">.error</span> { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f8d7da</span>; <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#f5c6cb</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>当 <code>currentType</code> 从 <code>info</code> 改为 <code>warning</code> 时，元素会自动切换到 <code>warning</code> 类对应的样式——<strong>无需手动操作 DOM</strong>。</p>
<h4 data-id="heading-3">（2）对象语法：条件控制类名（最常用）</h4>
<p>对象语法的核心是**「类名: 布尔值」**的键值对：当布尔值为 <code>true</code> 时，类名被添加；为 <code>false</code> 时移除。比如实现一个「点击切换激活状态」的按钮：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
    <span class="hljs-attr">class</span>=<span class="hljs-string">"btn"</span>
    <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ active: isActive, disabled: isDisabled }"</span>
    @<span class="hljs-attr">click</span>=<span class="hljs-string">"toggleActive"</span>
  &gt;</span>
    {{ isActive ? '已激活' : '未激活' }}
  <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 响应式状态：控制激活/禁用</span>
<span class="hljs-keyword">const</span> isActive = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> isDisabled = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)

<span class="hljs-comment">// 点击事件：切换状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleActive</span> = (<span class="hljs-params"/>) =&gt; {
  isActive.<span class="hljs-property">value</span> = !isActive.<span class="hljs-property">value</span>
  isDisabled.<span class="hljs-property">value</span> = isActive.<span class="hljs-property">value</span> <span class="hljs-comment">// 激活时禁用按钮</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.btn</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>; <span class="hljs-attribute">border</span>: none; <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>; <span class="hljs-attribute">cursor</span>: pointer; }
<span class="hljs-selector-class">.active</span> { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#42b983</span>; <span class="hljs-attribute">color</span>: white; }
<span class="hljs-selector-class">.disabled</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.6</span>; <span class="hljs-attribute">cursor</span>: not-allowed; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>这段代码的逻辑很清晰：</p>
<ul>
<li><code>isActive</code> 为 <code>true</code> 时，添加 <code>active</code> 类（绿色背景）；</li>
<li><code>isDisabled</code> 为 <code>true</code> 时，添加 <code>disabled</code> 类（半透明+禁止指针）；</li>
<li>点击按钮会翻转 <code>isActive</code> 的值，从而动态修改类名。</li>
</ul>
<h4 data-id="heading-4">（3）数组语法：组合多个动态类名</h4>
<p>当需要<strong>同时控制多个动态类名</strong>时，用数组语法。比如一个组件需要同时添加「主题类」和「大小类」：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"[themeClass, sizeClass]"</span>&gt;</span>
    组合动态类名
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 主题类：light/dark</span>
<span class="hljs-keyword">const</span> themeClass = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'light'</span>)
<span class="hljs-comment">// 大小类：small/medium/large</span>
<span class="hljs-keyword">const</span> sizeClass = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'medium'</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.card</span> { <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#eee</span>; <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>; }
<span class="hljs-selector-class">.light</span> { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>; <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>; }
<span class="hljs-selector-class">.dark</span> { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#333</span>; <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>; }
<span class="hljs-selector-class">.small</span> { <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>; }
<span class="hljs-selector-class">.medium</span> { <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>; }
<span class="hljs-selector-class">.large</span> { <span class="hljs-attribute">font-size</span>: <span class="hljs-number">20px</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>数组中的每个元素都可以是<strong>字符串变量</strong>或<strong>对象语法</strong>（混合条件判断）。比如：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 混合对象语法：条件添加active类 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"[themeClass, { active: isActive }]"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">2. 组件中的 <code>v-bind:class</code>：类名合并</h3>
<p>当你在<strong>子组件</strong>上使用 <code>:class</code> 时，Vue 会自动将父组件的类名<strong>合并</strong>到子组件的根元素上。比如：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 子组件：MyButton.vue --&gt;
&lt;template&gt;
  &lt;!-- 子组件自身的类名：btn --&gt;
  &lt;button class="btn"&gt;{{ label }}&lt;/button&gt;
&lt;/template&gt;

&lt;style&gt;
.btn { padding: 8px 16px; border: none; border-radius: 4px; }
&lt;/style&gt;
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 父组件使用 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 父组件添加的类名：primary --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ primary: isPrimary }"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"主要按钮"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MyButton</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./MyButton.vue'</span>
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> isPrimary = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.primary</span> { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#2196f3</span>; <span class="hljs-attribute">color</span>: white; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>最终子组件的按钮会有 <strong><code>btn primary</code></strong> 两个类名——父组件的类名不会覆盖子组件的类名，而是<strong>合并</strong>。</p>
<h2 data-id="heading-6">二、<code>v-bind:style</code>——动态内联样式</h2>
<p><code>v-bind:style</code> 用于<strong>直接设置元素的内联样式</strong>，语法与 <code>:class</code> 类似，但更贴近 CSS 的原生写法。</p>
<h3 data-id="heading-7">1. 对象语法：直接绑定样式对象</h3>
<p>最常用的方式——键是 <strong>CSS 属性名</strong>（驼峰式或短横线式），值是<strong>动态变量</strong>。比如实现一个「可调整字体大小」的文本：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
    <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ 
      color: textColor, 
      fontSize: `${fontSize}px`, 
      'background-color': bgColor 
    }"</span>
  &gt;</span>
    动态内联样式示例
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"increaseFontSize"</span>&gt;</span>放大字体<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 响应式变量：控制样式</span>
<span class="hljs-keyword">const</span> textColor = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'#333'</span>)   <span class="hljs-comment">// 文字颜色</span>
<span class="hljs-keyword">const</span> fontSize = <span class="hljs-title function_">ref</span>(<span class="hljs-number">16</span>)        <span class="hljs-comment">// 字体大小（带单位）</span>
<span class="hljs-keyword">const</span> bgColor = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'#f0f0f0'</span>)  <span class="hljs-comment">// 背景色（短横线式属性）</span>

<span class="hljs-comment">// 点击事件：字体放大2px</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">increaseFontSize</span> = (<span class="hljs-params"/>) =&gt; {
  fontSize.<span class="hljs-property">value</span> += <span class="hljs-number">2</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>注意事项：</p>
<ul>
<li>CSS 属性名可以用<strong>驼峰式</strong>（如 <code>fontSize</code> 对应 <code>font-size</code>）或<strong>短横线式</strong>（如 <code>'background-color'</code>，需要引号包裹）；</li>
<li>数值类属性（如 <code>fontSize</code>）需要手动加单位（如 <code>px</code>），否则会无效。</li>
</ul>
<h3 data-id="heading-8">2. 数组语法：组合多个样式对象</h3>
<p>当需要<strong>合并多个样式对象</strong>时，用数组语法。比如一个组件需要同时应用「基础样式」和「主题样式」：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"[baseStyle, themeStyle]"</span>&gt;</span>组合样式示例<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 基础样式：固定属性</span>
<span class="hljs-keyword">const</span> baseStyle = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">padding</span>: <span class="hljs-string">'16px'</span>,
  <span class="hljs-attr">border</span>: <span class="hljs-string">'1px solid #eee'</span>,
  border-<span class="hljs-attr">radius</span>: <span class="hljs-string">'8px'</span>
})
<span class="hljs-comment">// 主题样式：动态属性</span>
<span class="hljs-keyword">const</span> themeStyle = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#d3eafd'</span>,
  <span class="hljs-attr">color</span>: <span class="hljs-string">'#2196f3'</span>
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-9">三、Vue2 到 Vue3：语法延续与响应式优化</h2>
<p>Vue3 的 <code>:class</code> 和 <code>:style</code> 语法<strong>几乎完全继承 Vue2</strong>，但响应式系统的升级让样式更新更高效。</p>
<h3 data-id="heading-10">1. 语法延续性：无缝迁移</h3>
<p>Vue2 中的代码几乎可以直接复制到 Vue3 中使用，只是<strong>响应式数据的定义方式</strong>变了：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue2：data() 中的响应式数据</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">isActive</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>
    }
  }
}

<span class="hljs-comment">// Vue3：用 ref/reactive 定义响应式数据</span>
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> isActive = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> fontSize = <span class="hljs-title function_">ref</span>(<span class="hljs-number">16</span>)
</code></pre>
<h3 data-id="heading-11">2. Vue3 的响应式优化：更聪明的更新</h3>
<p>Vue3 用 <strong>Proxy</strong> 代替了 Vue2 的 <code>Object.defineProperty</code>，带来两个关键提升：</p>
<ul>
<li><strong>深层响应式</strong>：修改对象的深层属性（如 <code>obj.user.info.age</code>）会自动触发更新，无需 <code>Vue.set</code>；</li>
<li><strong>数组直接修改</strong>：直接修改数组元素（如 <code>arr[0] = 'new value'</code>）或长度（如 <code>arr.length = 0</code>）会触发更新，无需 <code>splice</code>。</li>
</ul>
<details>
<summary>往期文章归档</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc85e1fe16a7ae45e965b4e2df4d9d2f4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c85e1fe16a7ae45e965b4e2df4d9d2f4/" ref="nofollow noopener noreferrer">Vue浅响应式如何解决深层响应式的性能问题？适用场景有哪些？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc85e1fe16a7ae45e965b4e2df4d9d2f4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c85e1fe16a7ae45e965b4e2df4d9d2f4/" ref="nofollow noopener noreferrer">Vue浅响应式如何解决深层响应式的性能问题？适用场景有哪些？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc85e1fe16a7ae45e965b4e2df4d9d2f4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c85e1fe16a7ae45e965b4e2df4d9d2f4/" ref="nofollow noopener noreferrer">Vue浅响应式如何解决深层响应式的性能问题？适用场景有哪些？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa0af08dd60a37b9a890a9957f2cbfc9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a0af08dd60a37b9a890a9957f2cbfc9f/" ref="nofollow noopener noreferrer">Vue3响应式系统中，对象新增属性、数组改索引、原始值代理的问题如何解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbc287e1e36287afd90750fd907eca85e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bc287e1e36287afd90750fd907eca85e/" ref="nofollow noopener noreferrer">Vue 3中watch侦听器的正确使用姿势你掌握了吗？深度监听、与watchEffect的差异及常见报错解析 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc405a8d9950af5b7c63b56c348ac36b6%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c405a8d9950af5b7c63b56c348ac36b6/" ref="nofollow noopener noreferrer">为什么Vue 3需要ref函数？它的响应式原理与正确用法是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa7e9abb9691a81e4404d9facabe0f7c3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a7e9abb9691a81e4404d9facabe0f7c3/" ref="nofollow noopener noreferrer">Vue 3中reactive函数如何通过Proxy实现响应式？使用时要避开哪些误区？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbd995ea45161727597fb85b62566c43d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bd995ea45161727597fb85b62566c43d/" ref="nofollow noopener noreferrer">Vue3响应式系统的底层原理与实践要点你真的懂吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F53e3f270a80675df662c6857a3332c0f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/53e3f270a80675df662c6857a3332c0f/" ref="nofollow noopener noreferrer">Vue 3模板如何通过编译三阶段实现从声明式语法到高效渲染的跨越 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fddbce4f2a23aa72c96b1c0473900321e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ddbce4f2a23aa72c96b1c0473900321e/" ref="nofollow noopener noreferrer">快速入门Vue模板引用：从收DOM“快递”到调子组件方法，你玩明白了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F23a2d5a334e15575277814c16e45df50%2F" target="_blank" title="https://blog.cmdragon.cn/posts/23a2d5a334e15575277814c16e45df50/" ref="nofollow noopener noreferrer">快速入门Vue模板里的JS表达式有啥不能碰？计算属性为啥比方法更能打？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6be38de6382e31d282659b689c5b17f0%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6be38de6382e31d282659b689c5b17f0/" ref="nofollow noopener noreferrer">快速入门Vue的v-model表单绑定：语法糖、动态值、修饰符的小技巧你都掌握了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F60ce517684f4a418f453d66aa805606c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/60ce517684f4a418f453d66aa805606c/" ref="nofollow noopener noreferrer">快速入门Vue3事件处理的挑战题：v-on、修饰符、自定义事件你能通关吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe4ae7d5e4a9205bb11b2baccb230c637%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e4ae7d5e4a9205bb11b2baccb230c637/" ref="nofollow noopener noreferrer">快速入门Vue3的v-指令：数据和DOM的“翻译官”到底有多少本事？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F999ce4fb32259ff4fbf4bf7bcb851654%2F" target="_blank" title="https://blog.cmdragon.cn/posts/999ce4fb32259ff4fbf4bf7bcb851654/" ref="nofollow noopener noreferrer">快速入门Vue3，插值、动态绑定和避坑技巧你都搞懂了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa6997d81b49cd232b87e1cf603888ad1%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a6997d81b49cd232b87e1cf603888ad1/" ref="nofollow noopener noreferrer">想让PostgreSQL快到飞起？先找健康密码还是先换引擎？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1fee7afbb9abd4540b8aa9c141d6845d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1fee7afbb9abd4540b8aa9c141d6845d/" ref="nofollow noopener noreferrer">想让PostgreSQL查询快到飞起？分区表、物化视图、并行查询这三招灵不灵？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F79c590fbd87ece535b11a71c9667884f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/79c590fbd87ece535b11a71c9667884f/" ref="nofollow noopener noreferrer">子查询总拖慢查询？把它变成连接就能解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F748cdac2536008199abf8a8a2cd0ec85%2F" target="_blank" title="https://blog.cmdragon.cn/posts/748cdac2536008199abf8a8a2cd0ec85/" ref="nofollow noopener noreferrer">PostgreSQL全表扫描慢到崩溃？建索引+改查询+更统计信息三招能破？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F32ca943703226d317d4276a8fb53b0dd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/32ca943703226d317d4276a8fb53b0dd/" ref="nofollow noopener noreferrer">复杂查询总拖后腿？PostgreSQL多列索引+覆盖索引的神仙技巧你get没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fca93f1d53aa910e7ba5ffd8df611c12b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ca93f1d53aa910e7ba5ffd8df611c12b/" ref="nofollow noopener noreferrer">只给表子集建索引？用函数结果建索引？PostgreSQL这俩操作凭啥能省空间又加速？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ff507856ebfddd592448813c510a53669%2F" target="_blank" title="https://blog.cmdragon.cn/posts/f507856ebfddd592448813c510a53669/" ref="nofollow noopener noreferrer">B-tree索引像字典查词一样工作？那哪些数据库查询它能加速，哪些不能？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb2213bfcb5b88a862f2138404c03d596%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b2213bfcb5b88a862f2138404c03d596/" ref="nofollow noopener noreferrer">想抓PostgreSQL里的慢SQL？pg_stat_statements基础黑匣子和pg_stat_monitor时间窗，谁能帮你更准揪出性能小偷？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F26614eb7da6c476dde41d367ad888d2f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/26614eb7da6c476dde41d367ad888d2f/" ref="nofollow noopener noreferrer">PostgreSQL的“时光机”MVCC和锁机制是怎么搞定高并发的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F69f99bc6972a860d559c74aad7280da4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/69f99bc6972a860d559c74aad7280da4/" ref="nofollow noopener noreferrer">PostgreSQL性能暴涨的关键？内存IO并发参数居然要这么设置？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F7b7053f392147a8b3b1a16bebeb08d0a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/7b7053f392147a8b3b1a16bebeb08d0a/" ref="nofollow noopener noreferrer">大表查询慢到翻遍整个书架？PostgreSQL分区表教你怎么“分类”才高效</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc856e3cb073822349f3bf2d29995dcfc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c856e3cb073822349f3bf2d29995dcfc/" ref="nofollow noopener noreferrer">PostgreSQL 查询慢？是不是忘了优化 GROUP BY、ORDER BY 和窗口函数？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc096347d18e67b7431faacd2c4757093%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c096347d18e67b7431faacd2c4757093/" ref="nofollow noopener noreferrer">PostgreSQL里的子查询和CTE居然在性能上“掐架”？到底该站哪边？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F2eca89463454fd4250d7b66243b9fe5a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/2eca89463454fd4250d7b66243b9fe5a/" ref="nofollow noopener noreferrer">PostgreSQL选Join策略有啥小九九？Nested Loop/Merge/Hash谁是它的菜？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F068ecb772a87d7df20a8c9fb4b233f8e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/068ecb772a87d7df20a8c9fb4b233f8e/" ref="nofollow noopener noreferrer">PostgreSQL新手SQL总翻车？这7个性能陷阱你踩过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd498f63cd0a2d5a77e445c688a8b88db%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d498f63cd0a2d5a77e445c688a8b88db/" ref="nofollow noopener noreferrer">PostgreSQL索引选B-Tree还是GiST？“瑞士军刀”和“多面手”的差别你居然还不知道？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F9101b75bdec6faea9b35d54f14e37f36%2F" target="_blank" title="https://blog.cmdragon.cn/posts/9101b75bdec6faea9b35d54f14e37f36/" ref="nofollow noopener noreferrer">想知道数据库怎么给查询“算成本选路线”？EXPLAIN能帮你看明白？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd527f8ebb6e3dae2c7dfe4c8d8979444%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d527f8ebb6e3dae2c7dfe4c8d8979444/" ref="nofollow noopener noreferrer">PostgreSQL处理SQL居然像做蛋糕？解析到执行的4步里藏着多少查询优化的小心机？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6bfdae84f313cf7ad0bb7045c4392347%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6bfdae84f313cf7ad0bb7045c4392347/" ref="nofollow noopener noreferrer">PostgreSQL备份不是复制文件？物理vs逻辑咋选？误删还能精准恢复到1分钟前？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fde3672803de34dbad244d0a8d48b0eb5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/de3672803de34dbad244d0a8d48b0eb5/" ref="nofollow noopener noreferrer">转账不翻车、并发不干扰，PostgreSQL的ACID特性到底有啥魔法？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe463e8a2668abdf00a228c9b79324ded%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e463e8a2668abdf00a228c9b79324ded/" ref="nofollow noopener noreferrer">银行转账不白扣钱、电商下单不超卖，PostgreSQL事务的诀窍是啥？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F5c967e595058c4a1fc4474a68e64031d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/5c967e595058c4a1fc4474a68e64031d/" ref="nofollow noopener noreferrer">PostgreSQL里的PL/pgSQL到底是啥？能让SQL从“说目标”变“讲步骤”？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F325047855e3e23b5ef82f7d2db134fbd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/325047855e3e23b5ef82f7d2db134fbd/" ref="nofollow noopener noreferrer">PostgreSQL视图不存数据？那它怎么简化查询还能递归生成序列和控制权限？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd2dba50bb6e4df7b27e735245a06a2a2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d2dba50bb6e4df7b27e735245a06a2a2/" ref="nofollow noopener noreferrer">PostgreSQL索引这么玩，才能让你的查询真的“飞”起来？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F849ae5bab0f8c66e94c2f6ad1bb798e3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/849ae5bab0f8c66e94c2f6ad1bb798e3/" ref="nofollow noopener noreferrer">PostgreSQL的表关系和约束，咋帮你搞定用户订单不混乱、学生选课不重复？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fef4800975ffa84f1ca51976a70a1585b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ef4800975ffa84f1ca51976a70a1585b/" ref="nofollow noopener noreferrer">PostgreSQL查询的筛子、排序、聚合、分组？你会用它们搞定数据吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbf54711525c507c5eacfa7b0151c39d2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bf54711525c507c5eacfa7b0151c39d2/" ref="nofollow noopener noreferrer">PostgreSQL数据类型怎么选才高效不踩坑？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F887809b3e0375f5956873cd442f516d8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/887809b3e0375f5956873cd442f516d8/" ref="nofollow noopener noreferrer">想解锁PostgreSQL查询从基础到进阶的核心知识点？你都get了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F934be1203725e8be9d6f6e9104e5abcc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/934be1203725e8be9d6f6e9104e5abcc/" ref="nofollow noopener noreferrer">PostgreSQL DELETE居然有这些操作？返回数据、连表删你试过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0f0622e9b7402b599e618150d0596ffe%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0f0622e9b7402b599e618150d0596ffe/" ref="nofollow noopener noreferrer">PostgreSQL UPDATE语句怎么玩？从改邮箱到批量更新的避坑技巧你都会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0e3bf7efc030b024ea67ee855a00f2de%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0e3bf7efc030b024ea67ee855a00f2de/" ref="nofollow noopener noreferrer">PostgreSQL插入数据还在逐条敲？批量、冲突处理、返回自增ID的技巧你会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb6cd3c86da6aac26ed829e472d34078e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b6cd3c86da6aac26ed829e472d34078e/" ref="nofollow noopener noreferrer">PostgreSQL的“仓库-房间-货架”游戏，你能建出电商数据库和表吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fba1f545a3410144552fbdbfcf31b5265%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ba1f545a3410144552fbdbfcf31b5265/" ref="nofollow noopener noreferrer">PostgreSQL 17安装总翻车？Windows/macOS/Linux避坑指南帮你搞定？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb5474d1480509c5072085abc80b3dd9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b5474d1480509c5072085abc80b3dd9f/" ref="nofollow noopener noreferrer">能当关系型数据库还能玩对象特性，能拆复杂查询还能自动管库存，PostgreSQL凭什么这么香？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fcc098d8836e787baa8a4d92e4d56d5c5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/cc098d8836e787baa8a4d92e4d56d5c5/" ref="nofollow noopener noreferrer">给接口加新字段又不搞崩老客户端？FastAPI的多版本API靠哪三招实现？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F46d05151c5bd31cf37a7bcf0b8f5b0b8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/46d05151c5bd31cf37a7bcf0b8f5b0b8/" ref="nofollow noopener noreferrer">流量突增要搞崩FastAPI？熔断测试是怎么防系统雪崩的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F65ce343cc5df9faf3a8e2eeaab42ae45%2F" target="_blank" title="https://blog.cmdragon.cn/posts/65ce343cc5df9faf3a8e2eeaab42ae45/" ref="nofollow noopener noreferrer">FastAPI秒杀库存总变负数？Redis分布式锁能帮你守住底线吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Feed6cd8985d9be0a4b092a7da38b3e0c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/eed6cd8985d9be0a4b092a7da38b3e0c/" ref="nofollow noopener noreferrer">FastAPI的CI流水线怎么自动测端点，还能让Allure报告美到犯规？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6157d87338ce894d18c013c3c4777abb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6157d87338ce894d18c013c3c4777abb/" ref="nofollow noopener noreferrer">如何用GitHub Actions为FastAPI项目打造自动化测试流水线？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ffc4ef84559e04693a620d0714cb30787%2F" target="_blank" title="https://blog.cmdragon.cn/posts/fc4ef84559e04693a620d0714cb30787/" ref="nofollow noopener noreferrer">如何用Git Hook和CI流水线为FastAPI项目保驾护航？ - cmdragon's Blog</a></li>
</ul>
</details>
<details>
<summary>免费好用的热门在线工具</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fraid-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/raid-calculator" ref="nofollow noopener noreferrer">RAID 计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fphotoshop-online" target="_blank" title="https://tools.cmdragon.cn/zh/apps/photoshop-online" ref="nofollow noopener noreferrer">在线PS - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmermaid-live-editor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/mermaid-live-editor" ref="nofollow noopener noreferrer">Mermaid 在线编辑器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmath-solver-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/math-solver-calculator" ref="nofollow noopener noreferrer">数学求解计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsmart-teleprompter" target="_blank" title="https://tools.cmdragon.cn/zh/apps/smart-teleprompter" ref="nofollow noopener noreferrer">智能提词器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmagic-resume" target="_blank" title="https://tools.cmdragon.cn/zh/apps/magic-resume" ref="nofollow noopener noreferrer">魔法简历 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-puzzle-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-puzzle-tool" ref="nofollow noopener noreferrer">Image Puzzle Tool - 图片拼图工具 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsubtitle-downloader" target="_blank" title="https://tools.cmdragon.cn/zh/apps/subtitle-downloader" ref="nofollow noopener noreferrer">字幕下载工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flyrics-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lyrics-generator" ref="nofollow noopener noreferrer">歌词生成工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcloud-drive-search" target="_blank" title="https://tools.cmdragon.cn/zh/apps/cloud-drive-search" ref="nofollow noopener noreferrer">网盘资源聚合搜索 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fascii-art-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ascii-art-generator" ref="nofollow noopener noreferrer">ASCII字符画生成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fjwt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/jwt-tool" ref="nofollow noopener noreferrer">JSON Web Tokens 工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbcrypt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/bcrypt-tool" ref="nofollow noopener noreferrer">Bcrypt 密码工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-composer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-composer" ref="nofollow noopener noreferrer">GIF 合成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-decomposer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-decomposer" ref="nofollow noopener noreferrer">GIF 分解器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-steganography" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-steganography" ref="nofollow noopener noreferrer">文本隐写术 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh" target="_blank" title="https://tools.cmdragon.cn/zh" ref="nofollow noopener noreferrer">CMDragon 在线工具 - 高级AI工具箱与开发者套件 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%3Fcategory%3Dtrending" target="_blank" title="https://tools.cmdragon.cn/zh/apps?category=trending" ref="nofollow noopener noreferrer">应用商店 - 发现1000+提升效率与开发的AI工具和实用程序 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fchangelog" target="_blank" title="https://tools.cmdragon.cn/zh/changelog" ref="nofollow noopener noreferrer">CMDragon 更新日志 - 最新更新、功能与改进 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fsponsor" target="_blank" title="https://tools.cmdragon.cn/zh/sponsor" ref="nofollow noopener noreferrer">支持我们 - 成为赞助者 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-image-ai" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-image-ai" ref="nofollow noopener noreferrer">AI文本生成图像 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftemp-email" target="_blank" title="https://tools.cmdragon.cn/zh/apps/temp-email" ref="nofollow noopener noreferrer">临时邮箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fqrcode-parser" target="_blank" title="https://tools.cmdragon.cn/zh/apps/qrcode-parser" ref="nofollow noopener noreferrer">二维码解析器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-mindmap" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-mindmap" ref="nofollow noopener noreferrer">文本转思维导图 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fregex-visualizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/regex-visualizer" ref="nofollow noopener noreferrer">正则表达式可视化工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsteganography-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/steganography-tool" ref="nofollow noopener noreferrer">文件隐写工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fiptv-explorer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/iptv-explorer" ref="nofollow noopener noreferrer">IPTV 频道探索器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsnapdrop" target="_blank" title="https://tools.cmdragon.cn/zh/apps/snapdrop" ref="nofollow noopener noreferrer">快传 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flucky-draw" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lucky-draw" ref="nofollow noopener noreferrer">随机抽奖工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fanime-scene-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/anime-scene-finder" ref="nofollow noopener noreferrer">动漫场景查找器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftime-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/time-toolkit" ref="nofollow noopener noreferrer">时间工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fspeed-test" target="_blank" title="https://tools.cmdragon.cn/zh/apps/speed-test" ref="nofollow noopener noreferrer">网速测试 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-remover" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-remover" ref="nofollow noopener noreferrer">AI 智能抠图工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-replacer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-replacer" ref="nofollow noopener noreferrer">背景替换工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fartistic-qrcode" target="_blank" title="https://tools.cmdragon.cn/zh/apps/artistic-qrcode" ref="nofollow noopener noreferrer">艺术二维码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fopen-graph-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/open-graph-generator" ref="nofollow noopener noreferrer">Open Graph 元标签生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-comparison" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-comparison" ref="nofollow noopener noreferrer">图像对比工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-compressor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-compressor" ref="nofollow noopener noreferrer">图片压缩专业版 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fpassword-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/password-generator" ref="nofollow noopener noreferrer">密码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsvg-optimizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/svg-optimizer" ref="nofollow noopener noreferrer">SVG优化器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcolor-palette" target="_blank" title="https://tools.cmdragon.cn/zh/apps/color-palette" ref="nofollow noopener noreferrer">调色板生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fonline-metronome" target="_blank" title="https://tools.cmdragon.cn/zh/apps/online-metronome" ref="nofollow noopener noreferrer">在线节拍器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcss-grid-layout" target="_blank" title="https://tools.cmdragon.cn/zh/apps/css-grid-layout" ref="nofollow noopener noreferrer">CSS网格布局生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Femail-validator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/email-validator" ref="nofollow noopener noreferrer">邮箱验证工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcalligraphy-practice" target="_blank" title="https://tools.cmdragon.cn/zh/apps/calligraphy-practice" ref="nofollow noopener noreferrer">书法练习字帖 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffinance-calculator-suite" target="_blank" title="https://tools.cmdragon.cn/zh/apps/finance-calculator-suite" ref="nofollow noopener noreferrer">金融计算器套件 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fchinese-kinship-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/chinese-kinship-calculator" ref="nofollow noopener noreferrer">中国亲戚关系计算器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fprotobuf-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/protobuf-toolkit" ref="nofollow noopener noreferrer">Protocol Buffer 工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-upscaler" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-upscaler" ref="nofollow noopener noreferrer">图片无损放大 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-compare" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-compare" ref="nofollow noopener noreferrer">文本比较工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-batch-lookup" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-batch-lookup" ref="nofollow noopener noreferrer">IP批量查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdomain-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/domain-finder" ref="nofollow noopener noreferrer">域名查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdns-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/dns-toolkit" ref="nofollow noopener noreferrer">DNS工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffavicon-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/favicon-generator" ref="nofollow noopener noreferrer">网站图标生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fsitemap_index.xml" target="_blank" title="https://tools.cmdragon.cn/sitemap_index.xml" ref="nofollow noopener noreferrer">XML Sitemap</a></li>
</ul>
</details>
<p>比如修改深层样式对象：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"boxStyle"</span>&gt;</span>动态深层样式<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeBgColor"</span>&gt;</span>切换背景<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 用 reactive 定义深层响应式对象</span>
<span class="hljs-keyword">const</span> boxStyle = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">container</span>: {
    <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#f0f0f0'</span>,
    <span class="hljs-attr">padding</span>: <span class="hljs-string">'20px'</span>,
    <span class="hljs-attr">border</span>: <span class="hljs-string">'1px solid #eee'</span>
  }
})

<span class="hljs-comment">// 直接修改深层属性，触发更新</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">changeBgColor</span> = (<span class="hljs-params"/>) =&gt; {
  boxStyle.<span class="hljs-property">container</span>.<span class="hljs-property">backgroundColor</span> = 
    boxStyle.<span class="hljs-property">container</span>.<span class="hljs-property">backgroundColor</span> === <span class="hljs-string">'#f0f0f0'</span> 
    ? <span class="hljs-string">'#d3eafd'</span> 
    : <span class="hljs-string">'#f0f0f0'</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>在 Vue2 中，修改 <code>boxStyle.container.backgroundColor</code> 不会触发更新（需要 <code>Vue.set</code>），但 Vue3 用 Proxy 直接拦截了属性修改，<strong>无需额外操作</strong>。</p>
<h2 data-id="heading-12">四、课后 Quiz：巩固你的理解</h2>
<h3 data-id="heading-13">问题1</h3>
<p>如何用 <code>v-bind:class</code> 同时添加<strong>静态类名</strong>和<strong>条件类名</strong>？请写出示例代码。</p>
<h3 data-id="heading-14">问题2</h3>
<p><code>v-bind:style</code> 的对象语法中，CSS 属性名可以用哪些形式？请举例说明。</p>
<h3 data-id="heading-15">答案解析</h3>
<h4 data-id="heading-16">问题1：混合静态与条件类名</h4>
<p>用<strong>数组语法</strong>或<strong>对象语法</strong>都可以。比如：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 数组语法：静态类名 + 条件类名 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"[ 'shadow', { active: isActive } ]"</span>&gt;</span>
    静态+条件类名
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> isActive = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.card</span> { <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#eee</span>; <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>; }
<span class="hljs-selector-class">.shadow</span> { <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>); }
<span class="hljs-selector-class">.active</span> { <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#2196f3</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h4 data-id="heading-17">问题2：CSS 属性名的两种形式</h4>
<ul>
<li><strong>驼峰式</strong>：对应 CSS 的短横线命名（如 <code>fontSize</code> → <code>font-size</code>，<code>backgroundColor</code> → <code>background-color</code>）；</li>
<li><strong>短横线式</strong>：需要用引号包裹（如 <code>'font-size'</code>，<code>'background-color'</code>）。</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ 
  fontSize: '16px',        // 驼峰式
  'background-color': '#f0f0f0' // 短横线式（需引号）
}"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h2 data-id="heading-18">五、常见报错解决方案</h2>
<h3 data-id="heading-19">1. 报错：<code>[Vue warn]: Property "isActive" was accessed during render but is not defined on instance.</code></h3>
<ul>
<li><strong>原因</strong>：绑定的变量（如 <code>isActive</code>）未在组件中声明，Vue 找不到该变量；</li>
<li><strong>解决</strong>：用 <code>ref</code> 或 <code>reactive</code> 声明响应式变量：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> isActive = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>) <span class="hljs-comment">// 必须声明！</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-20">2. 问题：修改变量后样式不更新</h3>
<ul>
<li><strong>原因</strong>：变量不是<strong>响应式</strong>的（用 <code>let</code> 声明的普通变量，不是 <code>ref</code>/<code>reactive</code>）；</li>
<li><strong>解决</strong>：用 Vue3 的响应式 API 包裹变量：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误：let fontSize = 16;</span>
<span class="hljs-comment">// 正确：</span>
<span class="hljs-keyword">const</span> fontSize = <span class="hljs-title function_">ref</span>(<span class="hljs-number">16</span>)
</code></pre>
</li>
</ul>
<h3 data-id="heading-21">3. 报错：<code>[Vue warn]: Invalid value for dynamic directive argument (expected string or null): undefined</code></h3>
<ul>
<li><strong>原因</strong>：绑定的类名/样式属性名是 <code>undefined</code>（如 <code>{ [className]: isActive }</code> 中 <code>className</code> 未定义）；</li>
<li><strong>解决</strong>：给变量设置初始值，或用<strong>可选链</strong>处理：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> className = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'active'</span>) <span class="hljs-comment">// 初始值</span>
<span class="hljs-comment">// 或用可选链</span>
:<span class="hljs-keyword">class</span>=<span class="hljs-string">"{ [className || '']: isActive }"</span>
</code></pre>
</li>
</ul>
<h2 data-id="heading-22">参考链接</h2>
<ul>
<li>Vue3 官方文档：Class and Style Binding <a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Fclass-and-style.html" target="_blank" title="https://vuejs.org/guide/essentials/class-and-style.html" ref="nofollow noopener noreferrer">vuejs.org/guide/essen…</a></li>
<li>Vue3 官方文档：响应式基础 <a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Freactivity-fundamentals.html" target="_blank" title="https://vuejs.org/guide/essentials/reactivity-fundamentals.html" ref="nofollow noopener noreferrer">vuejs.org/guide/essen…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin密封类的主要用途]]></title>    <link>https://juejin.cn/post/7582755817670426634</link>    <guid>https://juejin.cn/post/7582755817670426634</guid>    <pubDate>2025-12-12T06:57:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582755817670426634" data-draft-id="7582553782398976046" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin密封类的主要用途"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-12T06:57:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南雨北斗"/> <meta itemprop="url" content="https://juejin.cn/user/4059818590476286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin密封类的主要用途
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4059818590476286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南雨北斗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:57:57.000Z" title="Fri Dec 12 2025 06:57:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Kotlin 中<strong>密封类（Sealed Class）的主要用途之一是实现“穷尽性检查”（Exhaustiveness Checking）</strong> 。这是它区别于普通抽象类或接口的关键优势。下面我们详细解释：</p>
<hr/>
<h2 data-id="heading-0">🔍 什么是“穷尽性检查”？</h2>
<p><strong>穷尽性检查</strong>是指：</p>
<blockquote>
<p>编译器能够静态地验证你在处理一个封闭类型（如密封类）时，是否已经覆盖了<strong>所有可能的子类型</strong>。</p>
</blockquote>
<p>如果遗漏了某个子类型，<strong>编译器会报错</strong>，从而避免运行时逻辑错误。</p>
<hr/>
<h2 data-id="heading-1">🧩 为什么需要穷尽性检查？</h2>
<p>考虑一个常见的场景：<strong>处理操作结果</strong>（成功、失败、加载中……）。如果你用普通父类：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin">1open <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>
2<span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: String) : Result()
3<span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> msg: String) : Result()
</code></pre>
<p>然后用 <code>when</code> 处理：</p>
<pre><code class="hljs language-scss" lang="scss">Kotlin
编辑
<span class="hljs-number">1</span>fun <span class="hljs-built_in">handle</span>(result: Result) = when (result) {
<span class="hljs-number">2</span>    is Success -&gt; <span class="hljs-built_in">println</span>("OK")
<span class="hljs-number">3</span>    <span class="hljs-comment">// 忘记处理 Error！</span>
<span class="hljs-number">4</span>}
</code></pre>
<p>✅ <strong>这段代码能编译通过！</strong><br/>
但运行时如果传入 <code>Error</code>，就会抛出 <code>kotlin.NoWhenBranchMatchedException</code> —— <strong>这是一个运行时错误</strong>！</p>
<p>而使用<strong>密封类</strong>，就能在<strong>编译期</strong>发现这个问题。</p>
<hr/>
<h2 data-id="heading-2">✅ 密封类如何实现穷尽性检查？</h2>
<h3 data-id="heading-3">示例：用密封类定义结果</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">Kotlin
编辑
1sealed <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span> {
<span class="hljs-number">2</span>    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: String) : Result()
<span class="hljs-number">3</span>    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> msg: String) : Result()
<span class="hljs-number">4</span>    <span class="hljs-keyword">object</span> Loading : Result()
<span class="hljs-number">5</span>}
</code></pre>
<h3 data-id="heading-4">使用 <code>when</code> 处理（不带 <code>else</code>）</h3>
<pre><code class="hljs language-rust" lang="rust">Kotlin
编辑
<span class="hljs-number">1</span>fun <span class="hljs-title function_ invoke__">handle</span>(result: <span class="hljs-type">Result</span>): <span class="hljs-type">String</span> = <span class="hljs-title function_ invoke__">when</span> (result) {
<span class="hljs-number">2</span>    is <span class="hljs-type">Result</span>.Success <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"成功: ${result.data}"</span>
<span class="hljs-number">3</span>    is <span class="hljs-type">Result</span>.Error <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"失败: ${result.msg}"</span>
<span class="hljs-number">4</span>    <span class="hljs-type">Result</span>.Loading <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"加载中"</span>
<span class="hljs-number">5</span>    <span class="hljs-comment">// 所有分支都覆盖了 → 编译通过 ✅</span>
<span class="hljs-number">6</span>}
</code></pre>
<p>现在，<strong>如果你删除任意一个分支</strong>，比如注释掉 <code>Loading</code>：</p>
<pre><code class="hljs language-rust" lang="rust">Kotlin
编辑
<span class="hljs-number">1</span>fun <span class="hljs-title function_ invoke__">handle</span>(result: <span class="hljs-type">Result</span>): <span class="hljs-type">String</span> = <span class="hljs-title function_ invoke__">when</span> (result) {
<span class="hljs-number">2</span>    is <span class="hljs-type">Result</span>.Success <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"成功"</span>
<span class="hljs-number">3</span>    is <span class="hljs-type">Result</span>.Error <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"失败"</span>
<span class="hljs-number">4</span>    <span class="hljs-comment">// ❌ 缺少 Loading 分支！</span>
<span class="hljs-number">5</span>}
</code></pre>
<p>👉 <strong>编译器会报错</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp">Text
编辑
<span class="hljs-number">1'</span><span class="hljs-keyword">when</span><span class="hljs-string">' expression must be exhaustive, add necessary '</span>Result.Loading<span class="hljs-string">' branch or '</span><span class="hljs-keyword">else</span><span class="hljs-string">' branch instead
</span></code></pre>
<blockquote>
<p>💡 这就是<strong>穷尽性检查</strong>：编译器知道 <code>Result</code> 只有这三种子类型，并强制你处理全部。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">🛑 如果加了 <code>else</code> 会怎样？</h2>
<pre><code class="hljs language-rust" lang="rust">Kotlin
编辑
<span class="hljs-number">1</span>fun <span class="hljs-title function_ invoke__">handle</span>(result: <span class="hljs-type">Result</span>): <span class="hljs-type">String</span> = <span class="hljs-title function_ invoke__">when</span> (result) {
<span class="hljs-number">2</span>    is <span class="hljs-type">Result</span>.Success <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"成功"</span>
<span class="hljs-number">3</span>    <span class="hljs-keyword">else</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"其他情况"</span>
<span class="hljs-number">4</span>}
</code></pre>
<p>✅ 这样也能编译通过，因为 <code>else</code> 被视为“兜底”。</p>
<p>但<strong>失去了类型安全的优势</strong>！</p>
<ul>
<li>如果以后新增一个子类（比如 <code>Retry</code>），你的 <code>else</code> 会默默吞掉它，可能引发逻辑 bug。</li>
<li>而如果不写 <code>else</code>，新增子类后<strong>所有未更新的 <code>when</code> 都会编译失败</strong>，迫使你显式处理新情况。</li>
</ul>
<blockquote>
<p>✅ <strong>最佳实践：尽量不写 <code>else</code>，让编译器帮你检查完整性。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-6">📌 穷尽性检查的前提条件</h2>
<ol>
<li>
<p><strong><code>when</code> 作为表达式使用</strong>（即有返回值或赋值给变量）</p>
<pre><code class="hljs language-csharp" lang="csharp">Kotlin
编辑
<span class="hljs-number">1</span>val message = <span class="hljs-keyword">when</span> (result) { ... } <span class="hljs-comment">// ✅ 会触发穷尽性检查</span>
</code></pre>
<p>如果只是语句（无返回值），且所有分支都有 <code>return</code>/<code>throw</code>，也会检查；否则可能不检查。</p>
</li>
<li>
<p><strong>类型必须是密封类或其子类型</strong><br/>
普通类、接口、开放类（<code>open class</code>）<strong>不会触发</strong>穷尽性检查。</p>
</li>
<li>
<p><strong>所有直接子类必须在编译期可知</strong><br/>
密封类的子类必须在同一文件（或同一模块内），这样编译器才能“看到全部可能性”。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-7">🎯 实际价值：重构安全 + 逻辑可靠</h2>
<p>假设你后期给 <code>Result</code> 新增一个状态：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin">
编辑
1sealed <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span> {
<span class="hljs-number">2</span>    <span class="hljs-comment">// ... 原有</span>
<span class="hljs-number">3</span>    <span class="hljs-keyword">object</span> Retry : Result() <span class="hljs-comment">// 新增</span>
<span class="hljs-number">4</span>}
</code></pre>
<p>那么<strong>所有使用 <code>when (result)</code> 的地方都会编译失败</strong>，除非你显式处理 <code>Retry</code>。<br/>
这让你在<strong>扩展功能时不会遗漏任何调用点</strong>，极大提升代码健壮性。</p>
<hr/>
<h2 data-id="heading-8">✅ 总结：穷尽性检查的核心意义</h2>






























<table><thead><tr><th>特性</th><th>普通类/接口</th><th>密封类</th></tr></thead><tbody><tr><td>子类型数量</td><td>开放（可无限扩展）</td><td>封闭（编译期已知）</td></tr><tr><td><code>when</code> 是否强制覆盖所有子类</td><td>❌ 否</td><td>✅ 是（作为表达式时）</td></tr><tr><td>新增子类是否影响现有代码</td><td>❌ 不会报错（可能出 bug）</td><td>✅ 编译失败（强制修复）</td></tr><tr><td>适合场景</td><td>开放扩展</td><td>封闭状态机、结果封装等</td></tr></tbody></table>
<blockquote>
<p>🔑 <strong>密封类 + <code>when</code> 表达式 = 编译期保证逻辑完整性</strong></p>
</blockquote>
<p>这就是为什么 Kotlin 官方推荐：<strong>当你有一组固定的、相关的类型时，优先使用密封类而不是普通继承</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[open-AutoGLM部署]]></title>    <link>https://juejin.cn/post/7582502441993863211</link>    <guid>https://juejin.cn/post/7582502441993863211</guid>    <pubDate>2025-12-12T06:19:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582502441993863211" data-draft-id="7582808491582799908" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="open-AutoGLM部署"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-12-12T06:19:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员Soldier"/> <meta itemprop="url" content="https://juejin.cn/user/935056027688039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            open-AutoGLM部署
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/935056027688039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员Soldier
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:19:56.000Z" title="Fri Dec 12 2025 06:19:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>AutoGLM-Phone</strong> 是智谱 AI 推出的端侧智能体模型，具备通过自然语言指令直接操作手机 GUI（图形用户界面）的能力。它可以模拟人类操作，自动执行如“点外卖”、“查价格”、“发朋友圈”等跨应用任务。</p>
<p>本指南将带你完成从 <strong>算力</strong> <strong>云服务器</strong> <strong>搭建</strong>、<strong>Docker 环境配置</strong>、<strong>vLLM 模型加速部署</strong> 到 <strong>本地</strong> <strong>ADB</strong> <strong>联调</strong> 的全流程。通过本教程，你将构建一套属于自己的 AI 手机操作助手。</p>
<p>open-AutoGLM GitHub地址 ：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzai-org%2FOpen-AutoGLM" target="_blank" title="https://github.com/zai-org/Open-AutoGLM" ref="nofollow noopener noreferrer">github.com/zai-org/Ope…</a></p>
<p>视频教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1dWmjBoEom%3Fvd_source%3Ddb21a1f1ccfda362b15d4e02eb5dcc0a" target="_blank" title="https://www.bilibili.com/video/BV1dWmjBoEom?vd_source=db21a1f1ccfda362b15d4e02eb5dcc0a" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1dW…</a></p>
<h2 data-id="heading-0">一、注册算力云服务器账号</h2>
<h3 data-id="heading-1">1.注册</h3>
<p><strong>注册账号</strong>：访问下方链接注册，可获取专属算力优惠券：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgpu.ai-galaxy.cn%2Flogin%3Fpage%3Dregister%26salesCode%3D59FEA3" target="_blank" title="https://gpu.ai-galaxy.cn/login?page=register&amp;salesCode=59FEA3" ref="nofollow noopener noreferrer">注册链接（含优惠券）</a></li>
</ul>
<h3 data-id="heading-2">2.选购</h3>
<h4 data-id="heading-3">2.1 显卡选择</h4>
<p>建议选择显存 <strong>40G</strong> 左右的显卡（如 A40, A100-40G, 或 4090），以确保模型加载和推理的稳定性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d24d4865ed46494b9f3ea058348c463e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYU29sZGllcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125756&amp;x-signature=rj8gw%2FW3OwbA7Sj2xwOQ9Ila7r0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">2.2 计费模式</h4>
<p>推荐选择“按小时租用”，灵活划算。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e02ba7d92f434e05899c049b83f33285~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYU29sZGllcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125756&amp;x-signature=2of%2BbcpFHF59dhFk7A%2FO1npE3xU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5">2.3 带宽配置</h4>
<ul>
<li>强烈建议将带宽<strong>拉满</strong>（最大值）。</li>
<li><em>原因</em>：模型文件和 Docker 镜像体积巨大，低带宽会导致下载耗时极长。</li>
<li><em>注意</em>：部分区域带宽速率一天仅允许修改一次，请谨慎操作。</li>
<li>预算有限也可选择 32Mbps（免费）下载速率在4M。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac3e07f4bcf5410d88d57d89b8549993~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYU29sZGllcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125756&amp;x-signature=V8OHMEdIgqHecORtUOquD9wMQp8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-6">2.4 镜像选择</h4>
<p>直接选择ubuntu22.04系统</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/778acbdce26443fb8facfee752139d5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYU29sZGllcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125756&amp;x-signature=3R9wt20kjcCPTYMSaHO6dXtvdrs%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">2.5 端口映射</h4>
<p>创建实例后，请务必查看控制台提供的<strong>外网</strong> <strong>端口</strong>与<strong>容器内端口</strong>的对应关系。后续启动服务时，需根据此映射关系设置 <code>-p</code> 参数。</p>
<h2 data-id="heading-8">二、服务器环境配置 (Docker)</h2>
<p>连接上服务器（SSH）后，首先需要配置 Docker 环境。</p>
<p>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.docker.com%2Fengine%2Finstall%2Fubuntu%2F" target="_blank" title="https://docs.docker.com/engine/install/ubuntu/" ref="nofollow noopener noreferrer">docs.docker.com/engine/inst…</a></p>
<h3 data-id="heading-9">1. 清理旧版本</h3>
<p>如果系统自带了旧版 Docker，建议先卸载以避免冲突：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">for</span> pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; <span class="hljs-keyword">do</span> sudo apt-get remove $pkg; done
</code></pre>
<h3 data-id="heading-10">2. 安装 Docker Engine</h3>
<p>按照以下步骤安装最新版 Docker：</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># 1. 更新索引并安装依赖</span>
<span class="hljs-comment"># Add Docker's official GPG key:</span>
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo <span class="hljs-built_in">chmod</span> a+r /etc/apt/keyrings/docker.asc

<span class="hljs-comment"># Add the repository to Apt sources:</span>
<span class="hljs-built_in">echo</span> \
  <span class="hljs-string">"deb [arch=<span class="hljs-subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  <span class="hljs-subst">$(. /etc/os-release &amp;&amp; echo <span class="hljs-string">"<span class="hljs-variable">$VERSION_CODENAME</span>"</span>)</span> stable"</span> | \
sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null
sudo apt-get update

<span class="hljs-comment"># 2. 安装 Docker</span>
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

<span class="hljs-comment"># 3. 验证安装</span>
docker --version
</code></pre>
<h3 data-id="heading-11">3. 配置国内镜像加速（推荐）</h3>
<p>为了提升拉取镜像的速度，建议配置国内加速源。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑配置文件</span>
sudo vim /etc/docker/daemon.json
</code></pre>
<p>在文件中按 <code>i</code> 键进入编辑模式，粘贴以下内容：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"registry-mirrors"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"https://docker.m.daocloud.io"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"https://noohub.ru"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"https://huecker.io"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"https://dockerhub.timeweb.cloud"</span>
    <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>保存退出（按 <code>Esc</code> 输入 <code>:wq</code> 回车），然后重启服务：</p>
<pre><code class="hljs language-perl" lang="perl">sudo service docker restart
<span class="hljs-comment"># 验证配置是否生效</span>
sudo docker info | <span class="hljs-keyword">grep</span> Mirrors -A <span class="hljs-number">4</span>
</code></pre>
<h2 data-id="heading-12">三、模型下载</h2>
<p>我们需要将 <strong>ZhipuAI/AutoGLM-Phone-9B</strong> 模型下载到服务器的 <code>/opt/model</code> 目录。推荐使用 ModelScope（魔搭社区）进行下载。</p>
<h3 data-id="heading-13">1. 使用 ModelScope 下载（推荐）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装下载工具</span>
pip install modelscope

<span class="hljs-comment"># 2. 创建目录并下载</span>
<span class="hljs-built_in">mkdir</span> -p /opt/model
modelscope download --model <span class="hljs-string">'ZhipuAI/AutoGLM-Phone-9B'</span> --local_dir <span class="hljs-string">'/opt/model'</span>
</code></pre>
<h3 data-id="heading-14">2. 使用 Git LFS 下载</h3>
<pre><code class="hljs language-bash" lang="bash">git lfs install
<span class="hljs-built_in">cd</span> /opt/model
git <span class="hljs-built_in">clone</span> https://www.modelscope.cn/ZhipuAI/AutoGLM-Phone-9B.git
</code></pre>
<h3 data-id="heading-15">3. 使用 Python SDK 下载</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">#模型下载</span>
from modelscope import snapshot_download
<span class="hljs-attr">model_dir</span> = snapshot_download(<span class="hljs-string">'ZhipuAI/AutoGLM-Phone-9B'</span>)
</code></pre>
<h2 data-id="heading-16">四、部署 vLLM 推理服务</h2>
<p>我们将使用 <code>vLLM</code> 框架来加速模型的推理。</p>
<h3 data-id="heading-17">1. 准备 NVIDIA Container Toolkit</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 检查宿主机驱动（应显示显卡信息表）</span>
<span class="hljs-comment">#报错或找不到命令：说明你宿主机还没装显卡驱动，请先安装 NVIDIA 驱动。可根据教程自行下载。https://blog.csdn.net/a772304419/article/details/146601092</span>
nvidia-smi 


<span class="hljs-comment"># 2. 配置 NVIDIA 容器库</span>
curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \
&amp;&amp; curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
  sed <span class="hljs-string">'s#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g'</span> | \
  sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/nvidia-container-toolkit.list

<span class="hljs-comment"># 3. 安装工具包并配置 Docker</span>
sudo apt-get update
sudo apt-get install -y nvidia-container-toolkit
<span class="hljs-comment"># 4. 生成配置文件</span>
sudo nvidia-ctk runtime configure --runtime=docker
<span class="hljs-comment"># 5. 重启</span>
sudo systemctl restart docker
</code></pre>
<h3 data-id="heading-18">2. 启动vLLM 容器</h3>
<p>下载并运行 vLLM 镜像，将模型路径映射到容器内部。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 拉取镜像</span>
docker pull vllm/vllm-openai:v0.12.0

<span class="hljs-comment"># 启动容器</span>
<span class="hljs-comment"># 注意：-p 8800:8000 表示将宿主机的8800端口映射到容器的8000端口</span>
<span class="hljs-comment"># 请根据你在“第一部分”中查看的实际外网端口情况修改 8800</span>
docker run -it \
 --entrypoint /bin/bash \
 --gpus all \
 -p 8800:8000 \
 --ipc=host \
 -v /opt/model:/app/model \
 --name autoglm \
 vllm/vllm-openai:v0.12.0
</code></pre>
<h3 data-id="heading-19">3. 在容器内启动服务</h3>
<p>进入容器终端后，执行以下命令：</p>
<pre><code class="hljs language-css" lang="css"># <span class="hljs-number">1</span>. 安装依赖 (忽略冲突警告)
pip install -U transformers <span class="hljs-attr">--pre</span> 

# <span class="hljs-number">2</span>. 启动 API Server (严格复制以下命令)
python3 -m vllm<span class="hljs-selector-class">.entrypoints</span><span class="hljs-selector-class">.openai</span><span class="hljs-selector-class">.api_server</span> \
 <span class="hljs-attr">--served-model-name</span> autoglm-phone-<span class="hljs-number">9</span>b \
 <span class="hljs-attr">--allowed-local-media-path</span> /   \
 <span class="hljs-attr">--mm-encoder-tp-mode</span> data \
 <span class="hljs-attr">--mm_processor_cache_type</span> shm \
 <span class="hljs-attr">--mm_processor_kwargs</span> "{"max_pixels":<span class="hljs-number">5000000</span>}" \
 <span class="hljs-attr">--max-model-len</span> <span class="hljs-number">25480</span>  \
 <span class="hljs-attr">--chat-template-content-format</span> string \
 <span class="hljs-attr">--limit-mm-per-prompt</span> "{"image":<span class="hljs-number">10</span>}" \
 <span class="hljs-attr">--model</span> /app/model \
 <span class="hljs-attr">--port</span> <span class="hljs-number">8000</span>
</code></pre>
<p>注：<code>--model</code> 参数需指向容器内挂载的路径 <code>/app/model</code> 或者具体的子文件夹名。</p>
<h3 data-id="heading-20">4. 验证服务</h3>
<p>模型服务启动后，可以使用检查脚本验证部署是否成功：</p>
<pre><code class="hljs language-bash" lang="bash">python scripts/check_deployment_cn.py --base-url http://你的IP:你的端口/v1 --model 模型名称
</code></pre>
<p>脚本将发送测试请求并展示模型的推理结果，你可以根据输出判断模型部署是否正常工作。</p>
<p>基于给定的任务, 预期输出如下。如果思维链长度很短, 或者出现了乱码, 很可能是模型部署失败, 请仔细检查文档要求的配置和依赖。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">think</span>&gt;</span></span>用户想要比较这个洗发水在京东和淘宝上的价格，然后选择最便宜的平台下单。当前在小红书app上，显示的是一个关于LUMMI MOOD洗发水的帖子。

我需要：
<span class="hljs-bullet">1.</span> 先启动京东app，搜索这个洗发水
<span class="hljs-bullet">2.</span> 查看京东的价格
<span class="hljs-bullet">3.</span> 再启动淘宝app，搜索这个洗发水
<span class="hljs-bullet">4.</span> 查看淘宝的价格
<span class="hljs-bullet">5.</span> 比较价格后，选择最便宜的京东或淘宝下单

首先，我需要从当前的小红书界面退出，然后启动京东app。<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">think</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">answer</span>&gt;</span></span>do(action="Launch", app="京东")
</code></pre>
<p>参数说明：</p>
<ul>
<li><code>--base-url</code>: 模型服务地址（根据实际部署地址修改）</li>
<li><code>--model</code>: 模型名称</li>
<li><code>--messages-file</code>: 可选，指定自定义测试消息文件（默认使用 <code>scripts/sample_messages.json</code>）</li>
</ul>
<h2 data-id="heading-21">五、客户端与真机连接 (本地电脑)</h2>
<p>服务端准备就绪后，我们需要在本地电脑配置控制端，通过 ADB 控制安卓手机，并调用云端的 AI 模型。</p>
<ol>
<li>
<h3 data-id="heading-22">硬件与环境准备</h3>
</li>
</ol>
<ul>
<li>
<p><strong>操作系统</strong>：Windows / macOS</p>
</li>
<li>
<p><strong>Python</strong>：建议 Python 3.10+</p>
</li>
<li>
<p><strong>安卓设备</strong>：Android 7.0+ 手机或模拟器。</p>
</li>
<li>
<p><strong>ADB</strong> <strong>工具</strong>：</p>
<ul>
<li>
<p>下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftools%2Freleases%2Fplatform-tools%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/tools/releases/platform-tools?hl=zh-cn" ref="nofollow noopener noreferrer">Android Platform Tools</a></p>
</li>
<li>
<p><strong>配置</strong> <strong>环境变量</strong>（以 Windows 为例）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.feishu.cn%2Fwiki%2FGSBEwwnu5izWZ6kTC9tcznJNnwg%3Ffrom%3Dfrom_copylink" target="_blank" title="https://ai.feishu.cn/wiki/GSBEwwnu5izWZ6kTC9tcznJNnwg?from=from_copylink" ref="nofollow noopener noreferrer">点击查看教程</a></p>
<ul>
<li>解压下载的包。</li>
<li><code>Win + R</code> 输入 <code>sysdm.cpl</code> -&gt; 高级 -&gt; 环境变量。</li>
<li>在 <code>System Path</code> 中添加 ADB 解压路径。</li>
<li>命令行输入 <code>adb version</code> 验证。</li>
</ul>
</li>
<li>
<p><strong>MacOS</strong> <strong>配置方法</strong>：在 <code>Terminal</code> 或者任何命令行工具里</p>
</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 假设解压后的目录为 ~/Downlaods/platform-tools。如果不是请自行调整命令。</span>
export <span class="hljs-variable constant_">PATH</span>=<span class="hljs-variable">${</span><span class="hljs-variable constant_">PATH</span>}<span class="hljs-symbol">:~/Downloads/platform-tools</span>
</code></pre>
<p>2.  ## 手机端设置</p>

<ol>
<li>
<p><strong>开启开发者模式</strong>：设置 -&gt; 关于手机 -&gt; 连续点击“版本号”直至提示已开启。</p>
</li>
<li>
<p><strong>开启</strong> <strong>USB</strong> <strong>调试</strong>：设置 -&gt; 开发者选项 -&gt; 勾选“USB 调试”。</p>
</li>
<li>
<p><strong>安装</strong> <strong>ADB</strong> <strong>Keyboard</strong>：</p>
<ol>
<li>下载并安装<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsenzhk%2FADBKeyBoard%2Fblob%2Fmaster%2FADBKeyboard.apk" target="_blank" title="https://github.com/senzhk/ADBKeyBoard/blob/master/ADBKeyboard.apk" ref="nofollow noopener noreferrer"> ADB Keyboard apk</a>。</li>
<li>在手机“语言与输入法”设置中，将默认输入法切换为 ADB Keyboard。</li>
</ol>
</li>
</ol>

<ol start="3">
<li>
<h3 data-id="heading-23">部署控制端代码 (Open-AutoGLM)</h3>
</li>
</ol>
<p>在本地电脑上下载控制代码：</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># 1. 克隆仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/zai-org/Open-AutoGLM
<span class="hljs-built_in">cd</span> Open-AutoGLM

<span class="hljs-comment"># 2. 安装依赖</span>
pip install -r requirements.txt 
pip install -e .
</code></pre>
<ol start="4">
<li>
<h3 data-id="heading-24">连接设备</h3>
</li>
</ol>
<p>确保手机通过 USB 连接电脑，或处于同一 WiFi 下。</p>
<ul>
<li><strong>USB</strong> <strong>方式</strong>：</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">adb devices
<span class="hljs-comment"># 输出应包含 device ID</span>
</code></pre>
<ul>
<li><strong>WiFi 远程方式：</strong></li>
</ul>

<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 需先用 USB 连接开启 tcpip</span>
adb tcpip <span class="hljs-number">5555</span>
<span class="hljs-comment"># 断开 USB，连接手机 IP</span>
adb <span class="hljs-keyword">connect</span> <span class="hljs-number">192.168</span>.x.x:<span class="hljs-number">5555</span>
</code></pre>
<h2 data-id="heading-25">六、启动 AI 代理</h2>
<p>一切准备就绪，现在让 AI 接管手机。</p>
<ol>
<li>
<h3 data-id="heading-26">命令行运行</h3>
</li>
</ol>
<p>在本地 <code>Open-AutoGLM</code> 目录下运行：</p>
<pre><code class="hljs language-csharp" lang="csharp">python main.py \
  --device-id &lt;你的设备ID或IP:<span class="hljs-number">5555</span>&gt; \
  --<span class="hljs-keyword">base</span>-url http:<span class="hljs-comment">//&lt;云服务器IP&gt;:&lt;映射端口&gt;/v1 \</span>
  --model <span class="hljs-string">"autoglm-phone-9b"</span> \
  <span class="hljs-string">"打开抖音搜索抖音号为：dycwo11nt61d 的博主并关注他！"</span>
</code></pre>
<ul>
<li><strong>--device-id</strong>: 通过 <code>adb devices</code> 获取的 ID。</li>
<li><strong>--base-url</strong>: 替换为你云服务器的公网 IP 和映射出的端口（例如 8800）。</li>
<li><strong>最后的字符串</strong>: 就是你给 AI 下达的自然语言指令。</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-27">python API 远程连接</h3>
</li>
</ol>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> phone_agent.adb <span class="hljs-keyword">import</span> ADBConnection, list_devices

<span class="hljs-comment"># 创建连接管理器</span>
conn = ADBConnection()

<span class="hljs-comment"># 连接远程设备</span>
success, message = conn.connect(<span class="hljs-string">"192.168.1.100:5555"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"连接状态: <span class="hljs-subst">{message}</span>"</span>)

<span class="hljs-comment"># 列出已连接设备</span>
devices = list_devices()
<span class="hljs-keyword">for</span> device <span class="hljs-keyword">in</span> devices:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{device.device_id}</span> - <span class="hljs-subst">{device.connection_type.value}</span>"</span>)

<span class="hljs-comment"># 在 USB 设备上启用 TCP/IP</span>
success, message = conn.enable_tcpip(<span class="hljs-number">5555</span>)
ip = conn.get_device_ip()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"设备 IP: <span class="hljs-subst">{ip}</span>"</span>)

<span class="hljs-comment"># 断开连接</span>
conn.disconnect(<span class="hljs-string">"192.168.1.100:5555"</span>)
</code></pre>
<p>3.  ## 常见问题排查</p>
<ul>
<li><strong>连接被拒绝</strong>：检查云服务器防火墙是否放行了对应端口。</li>
<li><strong>ADB</strong> <strong>掉线</strong>：WiFi 连接不稳定，尝试使用 USB 线连接。</li>
<li><strong>模型乱码/无响应</strong>：检查 vLLM 启动参数是否完全一致，尤其是显存和 max-model-len 设置。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[终于还是吃上了react-i18next的细糠]]></title>    <link>https://juejin.cn/post/7582533464245305378</link>    <guid>https://juejin.cn/post/7582533464245305378</guid>    <pubDate>2025-12-12T07:09:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582533464245305378" data-draft-id="7574045294612037667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="终于还是吃上了react-i18next的细糠"/> <meta itemprop="keywords" content="前端,前端框架"/> <meta itemprop="datePublished" content="2025-12-12T07:09:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿呜的边城"/> <meta itemprop="url" content="https://juejin.cn/user/2620868693599405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            终于还是吃上了react-i18next的细糠
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2620868693599405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿呜的边城
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:09:37.000Z" title="Fri Dec 12 2025 07:09:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>除了经常访问我网站的朋友，几乎就没人知道，我其实一直在做 ElasticSearch 文档的中文翻译，虽然不知道到底能帮助多少人，但既然已经坚持四年了，从 7.11 版本翻译到现在 9.x 版本，我就准备继续坚持下去。</p>
<p>在文档翻译过程中，我最开始的做法，是复制内容到百度翻译一类的网站上进行翻译，然后自己校对，调整格式，保存文档，发布到网站上。</p>
<p>后来，我找到一款比较好用的翻译工具 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpot-app%2Fpot-desktop" target="_blank" title="https://github.com/pot-app/pot-desktop" ref="nofollow noopener noreferrer"><code>pot</code></a>。这款工具很好用，适当减轻了一些工作量，但也只是让我不用去翻译网站上操作。</p>
<p>我翻译文档最大困难，在于翻译过程中，不能保留原网页的格式，我只能一段段翻译，再自己整理为 Markdown 格式，非常浪费时间。</p>
<p>在之前的文章<a href="https://juejin.cn/post/7456898384352477210" target="_blank" title="https://juejin.cn/post/7456898384352477210">《一种Tauri+NextJS国际化方案》</a>中，我提到我们在开发一款 AI 应用。虽然它胎死腹中，但还是多少给互联网留下了一些电子垃圾。🤣</p>
<p>在文章中我还提到，我自己吃不来 <code>react-i18next</code> 的细糠，所以只能先撸了一个国际化方案来应急解决国际化问题。</p>
<p>我就想复用之前的开发经验，开发一款可以直接将网页翻译为指定 Markdown 格式文档的 AI 工具，这样我复制出翻译结果，就能直接保存为 <code>Docusaurus</code> 能解析的文档，效率倍增!</p>
<p>这次开发同样采用了 <code>Tauri</code> + <code>Next.JS</code> 架构，国际化也先复用了之前的文章中的经验。但应用初步开发出来后，我发现切换页面时，页面会出现闪动，会闪现未翻译的原始 key，非常难看。</p>
<p><code>AI help AI！</code></p>
<p>于是，我再次寻求 AI 帮助。可能得益于 AI 模型的升级，这次 DeepSeek 在“调教”下给出了一个基于 <code>next-i18next</code> 的可用方案，真是让我等对前端不熟悉的人觉得香死了。以下记录方案实施方法。</p>
<h2 data-id="heading-1">解决方案</h2>
<h3 data-id="heading-2">1. 目标</h3>
<ul>
<li><code>Tauri</code> 应用中前端页面实现国际化切换功能</li>
</ul>
<h3 data-id="heading-3">2. 场景</h3>
<ul>
<li>纯客户端的场景（<code>Tauri</code> 中无法使用 <code>Nextjs</code> 的 <code>SSR</code>）。</li>
<li><code>Nextjs</code>（<code>AppRouter</code> 模式）</li>
</ul>
<p>已基于 <code>Tauri</code> 和 <code>Nextjs</code> 开发了可运行的应用。</p>
<h3 data-id="heading-4">3. 安装依赖</h3>
<pre><code class="hljs language-bash" lang="bash">npm install i18next react-i18next i18next-browser-languagedetector
</code></pre>
<h3 data-id="heading-5">4. 目录结构示例</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ead5bae8f3734f6792d9ee17ccf4a40a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5ZGc55qE6L655Z-O:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766128176&amp;x-signature=LLsZscQGz8Kh93AG3zIlDYqxlGk%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><code>i18n.ts</code> 国际化配置文件</li>
<li><code>locales</code> 国际化翻译 json 文件</li>
<li><code>layout.tsx</code> 动态加载 i18n 对象</li>
</ul>
<h3 data-id="heading-6">5. 关键文件示例</h3>
<h4 data-id="heading-7">i18n.ts</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> i18n <span class="hljs-keyword">from</span> <span class="hljs-string">"i18next"</span>;
<span class="hljs-keyword">import</span> { initReactI18next } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-i18next"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">LanguageDetector</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"i18next-browser-languagedetector"</span>;

<span class="hljs-keyword">import</span> en <span class="hljs-keyword">from</span> <span class="hljs-string">"../../locales/en.json"</span>;
<span class="hljs-keyword">import</span> zh <span class="hljs-keyword">from</span> <span class="hljs-string">"../../locales/zh.json"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TauriAdapter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../utils/utils"</span>;

<span class="hljs-keyword">const</span> adapter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TauriAdapter</span>();

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initI18n</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 从配置文件读取语言设置</span>
  <span class="hljs-keyword">const</span> config = <span class="hljs-keyword">await</span> adapter.<span class="hljs-title function_">readAppData</span>();
  <span class="hljs-keyword">const</span> locale = config.<span class="hljs-property">locale</span> || <span class="hljs-string">"zh"</span>;

  i18n
    .<span class="hljs-title function_">use</span>(<span class="hljs-title class_">LanguageDetector</span>)
    .<span class="hljs-title function_">use</span>(initReactI18next)
    .<span class="hljs-title function_">init</span>({
      <span class="hljs-attr">resources</span>: {
        <span class="hljs-attr">en</span>: { <span class="hljs-attr">translation</span>: en },
        <span class="hljs-attr">zh</span>: { <span class="hljs-attr">translation</span>: zh },
      },
      <span class="hljs-attr">lng</span>: locale,
      <span class="hljs-attr">fallbackLng</span>: <span class="hljs-string">"zh"</span>,
      <span class="hljs-attr">interpolation</span>: {
        <span class="hljs-attr">escapeValue</span>: <span class="hljs-literal">false</span>,
      },
    });

  <span class="hljs-keyword">return</span> i18n;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> i18n;
</code></pre>
<p><code>const config = await adapter.readAppData();</code> 是我自己实现的从配置文件读取当前语言的方法，如果你是其他方式读取语言，需要换成你自己的实现。</p>
<p>同时在以上配置项 <code>resources</code> 里需要把支持的语言都列出。</p>
<h4 data-id="heading-8">zh.json</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"locales"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"zh"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"中文"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"en"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"English"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>json 格式的翻译文字。</p>
<h4 data-id="heading-9">layout.tsx</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">"use client"</span>;
<span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { I18nextProvider } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-i18next"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./globals.css"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./lib/i18n"</span>; <span class="hljs-comment">// 导入 i18n 配置</span>
<span class="hljs-keyword">import</span> { initI18n } <span class="hljs-keyword">from</span> <span class="hljs-string">"./lib/i18n"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params">{
  children,
}: Readonly&lt;{
  children: React.ReactNode;
}&gt;</span>) {
  <span class="hljs-keyword">const</span> [i18nInstance, setI18nInstance] = useState&lt;<span class="hljs-built_in">any</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">initializeApp</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> i18n = <span class="hljs-keyword">await</span> <span class="hljs-title function_">initI18n</span>();
        <span class="hljs-title function_">setI18nInstance</span>(i18n);
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Failed to initialize i18n:"</span>, error);
      }
    };

    <span class="hljs-title function_">initializeApp</span>();
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">antialiased</span>`}&gt;</span>
        {i18nInstance ? (
          <span class="hljs-tag">&lt;<span class="hljs-name">I18nextProvider</span> <span class="hljs-attr">i18n</span>=<span class="hljs-string">{i18nInstance}</span>&gt;</span>
            {children}
          <span class="hljs-tag">&lt;/<span class="hljs-name">I18nextProvider</span>&gt;</span>
        ) : (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
            <span class="hljs-attr">data-tauri-drag-region</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">"flex flex-col justify-center items-center h-screen"</span>
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"loading loading-dots loading-xl text-primary h-[156px]"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        )}
      <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>
  );
}
</code></pre>
<p>在 <code>layout.tsx</code> 中使用国际化的 Provider，并动态加载 i18n 对象。</p>
<h4 data-id="heading-10">在文件中使用</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> { t } = <span class="hljs-title function_">useTranslation</span>();
....

&lt;h1 className=<span class="hljs-string">"text-[clamp(2rem,5vw,3rem)] font-bold text-gray-800 mb-4 text-center"</span>&gt;
            {<span class="hljs-title function_">t</span>(<span class="hljs-string">"app_name"</span>)}
&lt;/h1&gt;
</code></pre>
<h4 data-id="heading-11">语言切换</h4>
<p>在我们自己实现的语言切换选择器中，当选中新语言后，使用以下逻辑进行语言变更：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> { i18n, t } = <span class="hljs-title function_">useTranslation</span>();
......
i18n.<span class="hljs-title function_">changeLanguage</span>(newLang);
</code></pre>
<p>而语言变更后的国际化，就需要自己处理了。比如在 Tauri 中，目前我是将语言存储在配置文件中。</p>
<h3 data-id="heading-12">6.扩展</h3>
<p>在以上实现中，我们知道页面上的国际化其实是依赖于全局 <code>layout.tsx</code> 中的国际化 Provider 支持的。但比如在 Tauri 中，还存在独立页面，比如独立的系统托盘菜单。</p>
<p>这种页面是没法依赖 <code>Provider</code> 来使用 <code>t("app_name")</code> 来实现国际化的，但可以通过引入 <code>i18n</code> 对象来实现。如下：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> i18n <span class="hljs-keyword">from</span> <span class="hljs-string">"./lib/i18n"</span>;
......
i18n.<span class="hljs-title function_">t</span>(<span class="hljs-string">"translation.clipboard.conflict"</span>)
</code></pre>
<h2 data-id="heading-13">小记</h2>
<p>作为非专业的前端，在 AI 帮助下解决了国际化的问题，我觉得值得记下此方案，以备日后复用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring AI Alibaba + Crawl4ai + Docker 搭建一个具有联网搜索能力的Agent]]></title>    <link>https://juejin.cn/post/7582599972950179867</link>    <guid>https://juejin.cn/post/7582599972950179867</guid>    <pubDate>2025-12-12T06:47:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582599972950179867" data-draft-id="7582528397865369627" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring AI Alibaba + Crawl4ai + Docker 搭建一个具有联网搜索能力的Agent"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-12T06:47:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="左Python右Java从从容容游刃有余"/> <meta itemprop="url" content="https://juejin.cn/user/4107431173952525"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring AI Alibaba + Crawl4ai + Docker 搭建一个具有联网搜索能力的Agent
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4107431173952525/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    左Python右Java从从容容游刃有余
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:47:38.000Z" title="Fri Dec 12 2025 06:47:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    30
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring AI Alibaba + Crawl4ai + Docker 搭建一个具有联网搜索能力的Agent</h2>
<h3 data-id="heading-1">前置要求</h3>
<p>1、本地启动ollma</p>
<p>2、docker 拉取 unclecode/crawl4ai:0.7.7 并启动</p>
<p>docker pull unclecode/crawl4ai:0.7.7</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment">## 1、拉取镜像</span>
docker pull swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/unclecode/crawl4ai:0.7.7

<span class="hljs-comment">## 2、镜像打tag</span>
docker tag  swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/unclecode/crawl4ai:0.7.7  docker.io/unclecode/crawl4ai:0.7.7

<span class="hljs-comment">## 3、启动服务crawl4ai</span>
docker run -d \
 -p 11235:11235 \
 --name crawl4ai \
 --shm-size=3g \
 unclecode/crawl4ai:0.7.7

</code></pre>
<h3 data-id="heading-2">1、maven 依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>oak-spring-ai-alibaba-crawl4ai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>


    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">graalvm.polyglot.version</span>&gt;</span>24.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">graalvm.polyglot.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">spring.ai.version</span>&gt;</span>1.1.0-M4<span class="hljs-tag">&lt;/<span class="hljs-name">spring.ai.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">spring.boot.version</span>&gt;</span>3.4.3<span class="hljs-tag">&lt;/<span class="hljs-name">spring.boot.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">spring.ai.alibaba.version</span>&gt;</span>1.1.0.0-M5.1<span class="hljs-tag">&lt;/<span class="hljs-name">spring.ai.alibaba.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">hutool.version</span>&gt;</span>5.8.20<span class="hljs-tag">&lt;/<span class="hljs-name">hutool.version</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>


    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0-M4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-alibaba-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0.0-M5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>


    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-alibaba-agent-framework<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-model-ollama<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-alibaba-studio<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-alibaba-dashscope<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${hutool.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>


    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.11.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>spring-milestones<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Spring Milestones<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>spring-snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central-portal-snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Central Portal Snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://central.sonatype.com/repository/maven-snapshots/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>


<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>

</code></pre>
<h3 data-id="heading-3">2、主要代码</h3>
<p>Crawl4aiApiImpl 调用 Docker 本地 启动crawl4ai服务提供md接口</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.service.impl;

<span class="hljs-keyword">import</span> cn.hutool.http.HttpRequest;
<span class="hljs-keyword">import</span> cn.hutool.http.HttpResponse;
<span class="hljs-keyword">import</span> cn.hutool.json.JSONUtil;
<span class="hljs-keyword">import</span> com.example.config.ConfigProperties;
<span class="hljs-keyword">import</span> com.example.http.response.CrawlTaskResponse;
<span class="hljs-keyword">import</span> com.example.service.Crawl4aiApi;
<span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;
<span class="hljs-keyword">import</span> org.springframework.ai.tool.annotation.Tool;
<span class="hljs-keyword">import</span> org.springframework.ai.tool.annotation.ToolParam;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.io.UnsupportedEncodingException;
<span class="hljs-keyword">import</span> java.net.URLEncoder;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.Objects;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Crawl4aiApiImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Crawl4aiApi</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ConfigProperties configProperties;

    <span class="hljs-keyword">private</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(Crawl4aiApiImpl.class);

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Tool(description = "Get the crawl result by the given taskId")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">task</span><span class="hljs-params">(String taskId)</span> {
        logger.debug(<span class="hljs-string">"taskId: {}"</span>, taskId);
        <span class="hljs-type">HttpRequest</span> <span class="hljs-variable">httpRequest</span> <span class="hljs-operator">=</span> HttpRequest.get(configProperties.getBaseUrl() + <span class="hljs-string">"/task/"</span> + taskId)
                .bearerAuth(configProperties.getApiToken());
        <span class="hljs-type">HttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> httpRequest.execute();
        logger.debug(response.body());
        <span class="hljs-type">CrawlTaskResponse</span> <span class="hljs-variable">rsp</span> <span class="hljs-operator">=</span> JSONUtil.toBean(response.body(), CrawlTaskResponse.class);
        <span class="hljs-keyword">return</span> JSONUtil.toJsonStr(rsp);
    }

    <span class="hljs-comment">/**
     * 必应搜索方法
     * <span class="hljs-doctag">@param</span> q 用户输入
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Tool(description = "Call crawl4ai API to crawl a URL")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">bingSearchToolMd</span><span class="hljs-params">(<span class="hljs-meta">@ToolParam(description = "the user input content")</span> String q )</span> {
        <span class="hljs-keyword">if</span>(StringUtils.isBlank(q)){
            <span class="hljs-keyword">return</span> <span class="hljs-string">"The parameter can not be blank, Please input the parameter q and retry call crawl_tool again."</span>;
        }
<span class="hljs-comment">//        url 编码处理</span>
        <span class="hljs-keyword">try</span> {
            q = URLEncoder.encode(q , <span class="hljs-string">"utf-8"</span>);
        } <span class="hljs-keyword">catch</span> (UnsupportedEncodingException e) {
            e.printStackTrace();
        }
        Map&lt;String, Object&gt; params= <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        params.put(<span class="hljs-string">"url"</span> , <span class="hljs-string">"https://cn.bing.com/search?q="</span> + q);
        params.put(<span class="hljs-string">"f"</span> , <span class="hljs-string">"fit"</span>);
        params.put(<span class="hljs-string">"q"</span> , <span class="hljs-literal">null</span>);
        params.put(<span class="hljs-string">"c"</span> , <span class="hljs-string">"0"</span>);
        logger.debug(JSONUtil.toJsonStr(params));

        <span class="hljs-comment">//craw4ai 提供 输出 markdown 的接口</span>
        <span class="hljs-type">HttpRequest</span> <span class="hljs-variable">httpRequest</span> <span class="hljs-operator">=</span> HttpRequest.post(configProperties.getBaseUrl() + <span class="hljs-string">"/md"</span>)
                .header(<span class="hljs-string">"Content-Type"</span> , <span class="hljs-string">"application/json"</span>)
                .bearerAuth(configProperties.getApiToken()).body(JSONUtil.toJsonStr(params));

        <span class="hljs-type">HttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> httpRequest.execute();
        logger.debug(response.body());
        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> JSONUtil.toBean(response.body(), Map.class);
        <span class="hljs-comment">//输出 markdown 格式内容</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">markdown</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">"markdown"</span>);
        <span class="hljs-keyword">return</span> Objects.isNull(markdown) ? <span class="hljs-string">""</span> : markdown.toString();
    }
}
</code></pre>
<p>ReactAgentConfig 配置一下ReactAgent</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">package</span> com.example.config;

<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.agent.ReactAgent;
<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.agent.hook.modelcalllimit.ModelCallLimitHook;
<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.checkpoint.savers.MemorySaver;
<span class="hljs-keyword">import</span> com.example.http.request.CrawlRequest;
<span class="hljs-keyword">import</span> com.example.tools.CrawlTool;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.model.ChatModel;
<span class="hljs-keyword">import</span> org.springframework.ai.tool.ToolCallback;
<span class="hljs-keyword">import</span> org.springframework.ai.tool.function.FunctionToolCallback;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Primary;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactAgentConfig</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">INSTRUCTION</span> <span class="hljs-operator">=</span> <span class="hljs-string">"""
            You are a helpful assistant named research_agent.
            You can use the crawl_tool  search content from internet for user.
            You have access to tools that can search content from Internet.
            Use these tools to assist users with their tasks.
            """</span>;


    <span class="hljs-comment">// </span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> AgentStaticLoader <span class="hljs-title function_">agentStaticLoader</span><span class="hljs-params">(ReactAgent reactAgent)</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AgentStaticLoader</span>(reactAgent);
    }


    <span class="hljs-meta">@Bean("research_agent")</span>
    <span class="hljs-meta">@Primary</span>
    <span class="hljs-keyword">public</span> ReactAgent <span class="hljs-title function_">researchAgent</span><span class="hljs-params">(ChatModel chatModel, <span class="hljs-meta">@Qualifier("crawlToolCallback")</span> ToolCallback crawlToolCallback)</span> {

        <span class="hljs-keyword">return</span> ReactAgent.
                builder()
                .name(<span class="hljs-string">"research_agent"</span>)
                .model(chatModel)
                .instruction(
                        INSTRUCTION
                )
                .saver(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MemorySaver</span>())
                .tools(crawlToolCallback)
                .hooks(ModelCallLimitHook.builder().runLimit(<span class="hljs-number">5</span>).build())  <span class="hljs-comment">// 限制模型调用次数为5次</span>
                .build();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ToolCallback <span class="hljs-title function_">crawlToolCallback</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier("crawlTool")</span> CrawlTool crawlTool)</span> {
        <span class="hljs-keyword">return</span> FunctionToolCallback.builder(<span class="hljs-string">"crawl_tool"</span>, crawlTool)
                .description(
                        <span class="hljs-string">"""
                                   When you need search content from Internet for user, you can use crawl_tool.
                                    Usage:
                                    - The q parameter is a string, representative user input content.
                                    - When you use crawl_tool , the parameter just like below content:
                                     {
                                       "q":"user input content"
                                     }
                                """</span>
                )

                .inputType(CrawlRequest.class)
                .build();
    }

}
</code></pre>
<h3 data-id="heading-4">3、主要配置</h3>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">ollama:</span>
      <span class="hljs-comment"># 本地ollama 地址</span>
      <span class="hljs-attr">base-url:</span> <span class="hljs-string">http://localhost:11434</span>
      <span class="hljs-comment"># 聊天模型</span>
      <span class="hljs-attr">chat:</span>
        <span class="hljs-attr">model:</span> <span class="hljs-string">llama3.2</span>
<span class="hljs-comment"># 去掉Springboot banner</span>
  <span class="hljs-attr">main:</span>
    <span class="hljs-attr">banner-mode:</span> <span class="hljs-string">off</span>

<span class="hljs-comment"># crawl4ai Settings - update your URL and token below</span>
<span class="hljs-attr">crawl4ai:</span>
  <span class="hljs-comment"># 本地 docker 启动  crawl4ai 提供的 url</span>
  <span class="hljs-attr">base-url:</span> <span class="hljs-string">http://localhost:11235</span>
  <span class="hljs-comment"># 如果 docker 启动 crawl4ai 时有token，则配置</span>
  <span class="hljs-attr">api-token:</span>

<span class="hljs-attr">logging:</span>
    <span class="hljs-attr">level:</span>
        <span class="hljs-attr">com:</span>
          <span class="hljs-attr">example:</span> <span class="hljs-string">DEBUG</span>
        <span class="hljs-attr">org:</span>
          <span class="hljs-attr">springframework:</span>
            <span class="hljs-attr">web:</span> <span class="hljs-string">INFO</span>
    <span class="hljs-attr">file:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">./logs/crawl4ai.log</span>
</code></pre>
<p>CrawlTool 提供给Agent使用的tool</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">package</span> com.example.tools;

<span class="hljs-keyword">import</span> com.example.http.request.CrawlRequest;
<span class="hljs-keyword">import</span> com.example.service.Crawl4aiApi;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.model.ToolContext;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.function.BiFunction;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CrawlTool</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BiFunction</span>&lt;CrawlRequest, ToolContext , String&gt; {

    Crawl4aiApi crawl4aiApi;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CrawlTool</span><span class="hljs-params">(Crawl4aiApi crawl4aiApi)</span> {
        <span class="hljs-built_in">this</span>.crawl4aiApi = crawl4aiApi;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">apply</span><span class="hljs-params">(CrawlRequest query, ToolContext toolContext)</span> {
        <span class="hljs-keyword">return</span> crawl4aiApi.bingSearchToolMd(query.getQ());
    }
}

</code></pre>
<h3 data-id="heading-5">4、运行效果</h3>
<p>打开网址：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fchatui%2Findex.html" target="_blank" title="http://localhost:8080/chatui/index.html" ref="nofollow noopener noreferrer">http://localhost:8080/chatui/index.html</a></p>
<p>在聊天框输入:Spring AI Alibaba 入门教程 ，ReactAgent 会判断，调用crawl_tool 查询信息
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b30566bb7e044d5b80dcf28a1a9a693c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bemUHl0aG9u5Y-zSmF2YeS7juS7juWuueWuuea4uOWIg-acieS9mQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766130836&amp;x-signature=1bf0W79TCu%2BcV%2BSAZPWBjIItNjU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">5、代码链接</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftree_boss%2Foak-spring-ai-alibaba-crawl4ai.git" target="_blank" title="https://gitee.com/tree_boss/oak-spring-ai-alibaba-crawl4ai.git" ref="nofollow noopener noreferrer">gitee.com/tree_boss/o…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在 Kuscia 中使用自定义镜像仓库]]></title>    <link>https://juejin.cn/post/7582529173829189666</link>    <guid>https://juejin.cn/post/7582529173829189666</guid>    <pubDate>2025-12-12T06:26:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582529173829189666" data-draft-id="7582517824498450466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在 Kuscia 中使用自定义镜像仓库"/> <meta itemprop="keywords" content="开源,资讯"/> <meta itemprop="datePublished" content="2025-12-12T06:26:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="隐语SecretFlow"/> <meta itemprop="url" content="https://juejin.cn/user/3224235748628536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在 Kuscia 中使用自定义镜像仓库
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3224235748628536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    隐语SecretFlow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:26:56.000Z" title="Fri Dec 12 2025 06:26:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>打开链接即可点亮社区Star，照亮技术的前进之路。</p>
<p>Github 地址：<em><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsecretflow%2Fkuscia" target="_blank" title="https://github.com/secretflow/kuscia" ref="nofollow noopener noreferrer">github.com/secretflow/…</a></em></p>
<p>Kuscia支持自动拉取远程的应用镜像（比如：SecretFlow 等），这样可以不用手动导入镜像到容器中。可以在 <a href="https://link.juejin.cn?target=..%2Fdeployment%2Fkuscia_config_cn.md" target="_blank" title="../deployment/kuscia_config_cn.md" ref="nofollow noopener noreferrer">Kuscia 配置文件</a>中配置私有（or 公开）镜像仓库地址。</p>
<h2 data-id="heading-0">如何配置使用自定义镜像仓库</h2>
<p>配置文件中的 <code>image</code> 字段用来配置自定义仓库。相关含义参考 <a href="https://link.juejin.cn?target=..%2Fdeployment%2Fkuscia_config_cn.md" target="_blank" title="../deployment/kuscia_config_cn.md" ref="nofollow noopener noreferrer">Kuscia 配置文件说明</a></p>
<h3 data-id="heading-1">私有镜像仓库</h3>
<p>如果有一个私有镜像仓库（示例：<code>private.registry.com</code>），对应的配置如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">defaultRegistry:</span> <span class="hljs-string">private</span> <span class="hljs-comment"># It doesn't matter, as long as it corresponds to &lt;image.registries[0].name&gt;</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">registries:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">private</span>
      <span class="hljs-attr">endpoint:</span> <span class="hljs-string">private.registry.com/test</span>
      <span class="hljs-attr">username:</span> <span class="hljs-string">testname</span>
      <span class="hljs-attr">password:</span> <span class="hljs-string">testpass</span>
</code></pre>
<h3 data-id="heading-2">公开镜像仓库</h3>
<p>如果使用公开的镜像仓库（示例：<code>secretflow-registry.cn-hangzhou.cr.aliyuncs.com</code>），对应的配置如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">defaultRegistry:</span> <span class="hljs-string">aliyun</span> <span class="hljs-comment"># It doesn't matter, as long as it corresponds to &lt;image.registries[0].name&gt;</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">registries:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">aliyun</span>
      <span class="hljs-attr">endpoint:</span> <span class="hljs-string">secretflow-registry.cn-hangzhou.cr.aliyuncs.com/secretflow</span>
</code></pre>
<h2 data-id="heading-3">关于镜像仓库和AppImage的搭配使用</h2>
<p>配置文件中有<code>image</code>字段，<code>AppImage</code> 中也存在image相关的配置，他们的搭配关系示例如下：</p>



























































<table><thead><tr><th>配置文件</th><th>AppImage配置</th><th>实际镜像地址</th><th>备注</th></tr></thead><tbody><tr><td>无配置</td><td>secretflow/app:v1</td><td>docker.io/secretflow/app:v1</td><td/></tr><tr><td>无配置</td><td>private.registry.com/secretflow/app:v1</td><td>private.registry.com/secretflow/app:v1</td><td/></tr><tr><td>private.registry.com</td><td>secretflow/app:v1</td><td>private.registry.com/app:v1</td><td/></tr><tr><td>private.registry.com/secretflow</td><td>app:v1</td><td>private.registry.com/secretflow/app:v1</td><td>推荐配置</td></tr><tr><td>private.registry.com/secretflow</td><td>secretflow/app:v1</td><td>private.registry.com/secretflow/app:v1</td><td/></tr><tr><td>private.registry.com/secretflow</td><td>test/app:v1</td><td>private.registry.com/secretflow/app:v1</td><td/></tr><tr><td>private.registry.com/secretflow</td><td>private.registry.com/secretflow/app:v1</td><td>private.registry.com/secretflow/app:v1</td><td/></tr><tr><td>private.registry.com/secretflow</td><td>public.aliyun.com/secretflow/app:v1</td><td>public.aliyun.com/secretflow/app:v1</td><td>强烈不推荐配置，未来可能会禁止这种配置</td></tr></tbody></table>
<p>注：Kuscia推荐在 <code>AppImage</code> 中只配置镜像名（不带镜像仓库地址），否则切换仓库的时候，需要批量修改<code>AppImage</code>，所以不建议如此配置。</p>
<h2 data-id="heading-4">镜像拉取失败</h2>
<p>当发现镜像拉取失败时，请确认 配置文件中仓库地址，以及账密相关配置是否正确， 以及参考上文，确保 AppImage 的镜像地址配置正确.</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-<span class="hljs-number">06</span> <span class="hljs-number">13</span>:<span class="hljs-number">33</span>:<span class="hljs-number">00.534</span> <span class="hljs-keyword">ERROR</span> framework/pod_workers.go:<span class="hljs-number">978</span> <span class="hljs-keyword">Error</span> syncing pod <span class="hljs-string">"ant-test-0_ant(7fd5285b-2a5c-4a75-930a-2908e98c8799)"</span>, skipping: failed <span class="hljs-keyword">to</span> <span class="hljs-string">"StartContainer"</span> <span class="hljs-keyword">for</span> <span class="hljs-string">"test"</span> <span class="hljs-keyword">with</span> ErrImagePull: <span class="hljs-string">"faile to pull image \"</span>registry.xxxx.com/secretflow/nginx:v1\<span class="hljs-string">" with credentials, detail-&gt; rpc error: code = Unknown desc = failed to pull and unpack image \"</span>registry.xxxx.com/secretflow/nginx:v1\<span class="hljs-string">": failed to resolve reference \"</span>registry.xxxx.com/secretflow/nginx:v1\<span class="hljs-string">": unexpected status from HEAD request to https://registry.xxxx.com/v2/secretflow/nginx/manifests/v1: 401 Unauthorized"</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[相同方法不同状态下在ts和rust的写法(是我们一直追求的编译阶段)]]></title>    <link>https://juejin.cn/post/7582539701147107369</link>    <guid>https://juejin.cn/post/7582539701147107369</guid>    <pubDate>2025-12-12T06:59:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582539701147107369" data-draft-id="7582553782398910510" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="相同方法不同状态下在ts和rust的写法(是我们一直追求的编译阶段)"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-12T06:59:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="沐森"/> <meta itemprop="url" content="https://juejin.cn/user/4455643804079608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            相同方法不同状态下在ts和rust的写法(是我们一直追求的编译阶段)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4455643804079608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    沐森
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:59:52.000Z" title="Fri Dec 12 2025 06:59:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>先写个ts，代码让我明白逻辑，然后写rust通过枚举写出和ts一样的运行时代码，然后再写rust泛型的编译判断</p>
<p>我们将模拟同一个业务场景：<strong>订单系统</strong>。 流程：<code>新建 (New)</code> -&gt; <code>支付 (pay)</code> -&gt; <code>已支付 (Paid)</code> -&gt; <code>发货 (ship)</code> -&gt; <code>已发货 (Shipped)</code>。</p>
<hr/>
<h3 data-id="heading-0">1. TypeScript 写法 (经典 OOP，运行时检查)</h3>
<p>这是大多数程序员最熟悉的写法。状态是一个字符串或枚举值，逻辑全靠 <code>if</code> 判断。</p>
<p>TypeScript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义状态类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">OrderStatus</span> = <span class="hljs-string">'New'</span> | <span class="hljs-string">'Paid'</span> | <span class="hljs-string">'Shipped'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">status</span>: <span class="hljs-title class_">OrderStatus</span>; <span class="hljs-comment">// 状态只是一个数据字段</span>

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'New'</span>; <span class="hljs-comment">// 默认为 New</span>
    }

    <span class="hljs-comment">// 支付方法</span>
    <span class="hljs-title function_">pay</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 【痛点】：必须在运行时写代码检查当前状态</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> !== <span class="hljs-string">'New'</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`错误：订单 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.id}</span> 状态是 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.status}</span>，不能支付！`</span>);
        }

        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`订单 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.id}</span> 支付成功`</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'Paid'</span>; <span class="hljs-comment">// 修改内部状态</span>
    }

    <span class="hljs-comment">// 发货方法</span>
    <span class="hljs-title function_">ship</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 【痛点】：如果你忘了写这个 check，或者写错了，编译时不会报错，运行时会炸</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> !== <span class="hljs-string">'Paid'</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`错误：订单 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.id}</span> 没支付，不能发货！`</span>);
        }

        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`订单 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.id}</span> 发货成功`</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'Shipped'</span>;
    }
}

<span class="hljs-comment">// --- 测试 ---</span>
<span class="hljs-keyword">const</span> order = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>(<span class="hljs-number">1</span>);

<span class="hljs-comment">// 1. 正常流程</span>
order.<span class="hljs-title function_">pay</span>();
order.<span class="hljs-title function_">ship</span>();

<span class="hljs-comment">// 2. 错误流程 (编译器拦不住，运行才会报错)</span>
<span class="hljs-comment">// order.ship(); // 抛出 Error: 错误：订单 1 状态是 Shipped，不能发货！</span>
</code></pre>
<hr/>
<h3 data-id="heading-1">2. Rust 枚举写法 (模拟 TS 逻辑，运行时检查)</h3>
<p>这是 Rust 中处理动态状态的标准写法。逻辑和 TS 几乎一样，只是用 <code>match</code> 替代了 <code>if</code>，用 <code>Result</code> 替代了 <code>throw Error</code>。</p>
<p><strong>特点：</strong>  代码写在同一个 <code>impl</code> 里，<strong>可以</strong>编译通过非法调用的代码（比如连续调用两次 pay），必须运行起来才知道错没错。</p>
<p>Rust</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Debug, PartialEq)]</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">Status</span> {
    New,
    Paid,
    Shipped,
}

<span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Order</span> {
    id: <span class="hljs-type">u64</span>,
    status: Status, <span class="hljs-comment">// 状态是结构体的一个字段</span>
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(id: <span class="hljs-type">u64</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> {
            id,
            status: Status::New,
        }
    }

    <span class="hljs-comment">// 必须返回 Result，因为运行时可能会失败</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">pay</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), <span class="hljs-type">String</span>&gt; {
        <span class="hljs-comment">// 【运行时检查】：和 TS 一样，必须手动判断状态</span>
        <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.status {
            Status::New =&gt; {
                <span class="hljs-built_in">println!</span>(<span class="hljs-string">"订单 {} 支付成功"</span>, <span class="hljs-keyword">self</span>.id);
                <span class="hljs-keyword">self</span>.status = Status::Paid; <span class="hljs-comment">// 修改自身字段</span>
                <span class="hljs-title function_ invoke__">Ok</span>(())
            }
            _ =&gt; <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-string">"只有新订单才能支付"</span>.<span class="hljs-title function_ invoke__">to_string</span>()),
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">ship</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), <span class="hljs-type">String</span>&gt; {
        <span class="hljs-comment">// 【运行时检查】</span>
        <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.status {
            Status::Paid =&gt; {
                <span class="hljs-built_in">println!</span>(<span class="hljs-string">"订单 {} 发货成功"</span>, <span class="hljs-keyword">self</span>.id);
                <span class="hljs-keyword">self</span>.status = Status::Shipped;
                <span class="hljs-title function_ invoke__">Ok</span>(())
            }
            _ =&gt; <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-string">"只有已支付的订单才能发货"</span>.<span class="hljs-title function_ invoke__">to_string</span>()),
        }
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">order</span> = Order::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">1001</span>);

    <span class="hljs-comment">// 1. 正常流程 (需要处理 Result)</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(_) = order.<span class="hljs-title function_ invoke__">pay</span>() {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = order.<span class="hljs-title function_ invoke__">ship</span>();
    }

    <span class="hljs-comment">// 2. 错误流程</span>
    <span class="hljs-comment">// 编译器完全允许你写这行代码，只有跑起来通过 Err 告诉你错了</span>
    <span class="hljs-comment">// let _ = order.ship(); // 运行时返回 Err</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-2">3. Rust 泛型 + PhantomData (Type State，编译时检查)</h3>
<p>这是 Rust 的“完全体”。状态不再是字段里的<strong>值</strong>，而是依附在结构体上的<strong>类型</strong>。</p>
<p><strong>特点：</strong>  方法被拆分到不同的 <code>impl</code> 块。<strong>非法调用的代码连编译都过不去</strong>。</p>
<p>Rust</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::marker::PhantomData;

<span class="hljs-comment">// --- 1. 定义状态 (空结构体，只做类型标签) ---</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">New</span>;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Paid</span>;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Shipped</span>;

<span class="hljs-comment">// --- 2. 定义核心结构体 (带有泛型 State) ---</span>
<span class="hljs-comment">// 注意：这里没有 `status` 字段了！状态由 State 类型本身决定</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Order</span>&lt;State&gt; {
    id: <span class="hljs-type">u64</span>,
    <span class="hljs-comment">// 这是一个 0 大小的字段，只为了告诉编译器 State 是啥</span>
    _marker: PhantomData&lt;State&gt;, 
}

<span class="hljs-comment">// --- 3. 针对不同状态实现不同的方法 ---</span>

<span class="hljs-comment">// 只有 &lt;New&gt; 状态才有 pay 方法</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Order</span>&lt;New&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(id: <span class="hljs-type">u64</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> { id, _marker: PhantomData }
    }

    <span class="hljs-comment">// 动作：New -&gt; Paid</span>
    <span class="hljs-comment">// 注意：输入是 self (消耗掉旧订单)，输出是 Order&lt;Paid&gt; (返回新订单)</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">pay</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> Order&lt;Paid&gt; {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"订单 {} 支付成功"</span>, <span class="hljs-keyword">self</span>.id);
        Order { 
            id: <span class="hljs-keyword">self</span>.id, 
            _marker: PhantomData 
        }
    }
}

<span class="hljs-comment">// 只有 &lt;Paid&gt; 状态才有 ship 方法</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Order</span>&lt;Paid&gt; {
    <span class="hljs-comment">// 动作：Paid -&gt; Shipped</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">ship</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> Order&lt;Shipped&gt; {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"订单 {} 发货成功"</span>, <span class="hljs-keyword">self</span>.id);
        Order { 
            id: <span class="hljs-keyword">self</span>.id, 
            _marker: PhantomData 
        }
    }
}

<span class="hljs-comment">// 只有 &lt;Shipped&gt; 状态才有 finish 方法</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Order</span>&lt;Shipped&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">finish</span>(<span class="hljs-keyword">self</span>) {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"订单 {} 流程结束"</span>, <span class="hljs-keyword">self</span>.id);
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// --- 1. 正常流程 ---</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">order_new</span> = Order::&lt;New&gt;::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">1001</span>); <span class="hljs-comment">// 类型: Order&lt;New&gt;</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">order_paid</span> = order_new.<span class="hljs-title function_ invoke__">pay</span>();        <span class="hljs-comment">// 类型: Order&lt;Paid&gt;</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">order_shipped</span> = order_paid.<span class="hljs-title function_ invoke__">ship</span>();   <span class="hljs-comment">// 类型: Order&lt;Shipped&gt;</span>
    order_shipped.<span class="hljs-title function_ invoke__">finish</span>();

    <span class="hljs-comment">// --- 2. 错误流程 (高能预警) ---</span>
    
    <span class="hljs-comment">// 如果你试图把上面的流程打乱，比如直接对 New 状态发货：</span>
    <span class="hljs-comment">/* let order = Order::&lt;New&gt;::new(1002);
       order.ship(); 
    */</span>
    
    <span class="hljs-comment">// 💥 编译器直接报错：</span>
    <span class="hljs-comment">// error[E0599]: no method named `ship` found for struct `Order&lt;New&gt;`</span>
    <span class="hljs-comment">// 意思：兄弟，Order&lt;New&gt; 这个类型根本就没有 ship 这个函数，你想啥呢？</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-3">终极对比总结</h3>



































<table><thead><tr><th>维度</th><th>TS / Rust Enum 写法</th><th>Rust 泛型 (Type State) 写法</th></tr></thead><tbody><tr><td><strong>状态本质</strong></td><td><strong>数据 (Data)</strong> 存储在内存的一个变量里 (<code>"New"</code>, <code>0</code>)</td><td><strong>类型 (Type)</strong> 写在代码签名里 (<code>&lt;New&gt;</code>, <code>&lt;Paid&gt;</code>)</td></tr><tr><td><strong>逻辑位置</strong></td><td><strong>集中在一起</strong> 所有方法都在一个 class/impl 里，内部用 if/match 分流</td><td><strong>分散隔离</strong> <code>pay</code> 只存在于 <code>New</code> 的实现块里 <code>ship</code> 只存在于 <code>Paid</code> 的实现块里</td></tr><tr><td><strong>错误发现</strong></td><td><strong>运行时 (Runtime)</strong> 跑起来抛异常或返回 Err</td><td><strong>编译时 (Compile Time)</strong> 代码还没跑，编译器就标红了</td></tr><tr><td><strong>IDE 体验</strong></td><td><strong>全显示</strong> 敲 <code>order.</code> 会看到 <code>pay</code> 和 <code>ship</code>，容易误点</td><td><strong>智能筛选</strong> 如果是新订单，敲 <code>order.</code> 根本看不到 <code>ship</code></td></tr><tr><td><strong>所有权</strong></td><td><strong>状态可变</strong> 对象一直是那个对象，只是改了个字段值</td><td><strong>旧状态销毁</strong> 调用 <code>pay()</code> 后，旧的 <code>order</code> 变量直接失效 (Move)，防止你再用旧订单搞事情</td></tr></tbody></table>
<p>Export to Sheets</p>
<p>通过这三段代码，你应该能明显感觉到：Rust 的泛型写法虽然定义起来稍微啰嗦（要写好几个 struct 和 impl），但在<strong>使用时</strong>是多么的安全和省心。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TiDB详解与应用实战：分布式数据库的核心原理与最佳实践]]></title>    <link>https://juejin.cn/post/7582561515816763455</link>    <guid>https://juejin.cn/post/7582561515816763455</guid>    <pubDate>2025-12-12T07:00:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582561515816763455" data-draft-id="7582502441993977899" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TiDB详解与应用实战：分布式数据库的核心原理与最佳实践"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-12-12T07:00:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TiDB详解与应用实战：分布式数据库的核心原理与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:00:23.000Z" title="Fri Dec 12 2025 07:00:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1 TiDB架构设计与核心原理</h2>
<p>TiDB是PingCAP公司开发的开源分布式关系型数据库，采用计算存储分离的架构设计，完美结合了传统关系型数据库的ACID特性与NoSQL数据库的水平扩展能力。作为新一代的<strong>云原生数据库</strong>，TiDB完全兼容MySQL协议，使得现有MySQL应用可以几乎无缝迁移到TiDB平台，同时获得分布式架构带来的诸多优势。</p>
<h3 data-id="heading-1">1.1 核心架构组件与协作机制</h3>
<p>TiDB采用分层架构设计，包含三个核心组件：TiDB Server（计算层）、TiKV（存储层）和PD（调度层）。这种<strong>组件分离架构</strong>使得每个层级可以独立扩展和优化，提供了极大的灵活性。</p>
<ul>
<li><strong>TiDB Server（计算层）</strong> ：作为无状态SQL层，负责SQL解析、优化和执行。它兼容MySQL协议和大多数MySQL语法，应用程序可以像使用MySQL一样连接TiDB。TiDB Server将SQL请求转换为对TiKV的Key-Value操作，并汇总存储层返回的结果。</li>
<li><strong>TiKV（存储层）</strong> ：分布式键值存储引擎，基于Raft共识算法保证数据强一致性和高可用性。TiKV将数据划分为Region（默认96MB-256MB），每个Region通过Multi-Raft协议维护多个副本，确保数据安全和高可用。</li>
<li><strong>PD（Placement Driver）</strong> ：集群的"大脑"，负责元数据管理、全局时间戳分配、负载均衡和自动故障恢复。PD通过持续监控集群状态，自动调度Region副本，优化数据分布和负载均衡。</li>
</ul>
<h3 data-id="heading-2">1.2 数据分布与Region管理</h3>
<p>TiDB采用基于Range的数据分片策略，将整个Key-Value空间分成多个连续的段，每个段称为一个Region。当Region大小达到阈值（默认256MiB）时，会自动分裂为两个子Region；当Region因大量删除变得太小时，会将相邻小Region合并。这种<strong>自动分片机制</strong>确保了数据分布的动态平衡，避免了传统分库分表需要手动维护的复杂性。</p>
<p>PD组件通过多种调度器实现智能调度：</p>
<ul>
<li><strong>balance-leader-scheduler</strong>：保持不同节点的Leader均衡</li>
<li><strong>balance-region-scheduler</strong>：保持不同节点的Peer均衡</li>
<li><strong>hot-region-scheduler</strong>：保持不同节点的读写热点Region均衡</li>
</ul>
<h3 data-id="heading-3">1.3 分布式事务与一致性机制</h3>
<p>TiDB实现了完整的分布式事务机制，采用优化的两阶段提交（2PC）协议，并基于Percolator事务模型处理分布式事务。关键机制包括：</p>
<ul>
<li><strong>全局时间戳分配</strong>：PD作为全局时间戳分配器（TSO），为每个事务分配全局唯一且递增的时间戳，用于实现MVCC和全局快照隔离。</li>
<li><strong>异步提交优化</strong>：TiDB 4.0引入的Async Commit特性，对于小事务达到类似1PC的效果，减少网络往返次数，显著提升短事务性能。</li>
<li><strong>多版本并发控制（MVCC）</strong> ：TiKV实现多版本并发控制，每个数据修改都会生成新的版本，由时间戳区分版本，实现读写不阻塞的快照隔离。</li>
</ul>
<h2 data-id="heading-4">2 TiDB关键技术深度解析</h2>
<h3 data-id="heading-5">2.1 HTAP混合负载支持</h3>
<p>TiDB通过TiFlash组件实现HTAP能力，同时支持OLTP和OLAP工作负载。TiFlash是列式存储引擎，通过Multi-Raft Learner协议实时从TiKV复制数据，确保与TiKV之间的数据强一致性。</p>
<p><strong>行列混合架构</strong>的优势在于：</p>
<ul>
<li><strong>实时分析</strong>：TiFlash以低消耗不阻塞TiKV写入的方式实时复制数据，同步延迟控制在秒级，实现真正的实时分析。</li>
<li><strong>智能选择</strong>：TiDB优化器会根据查询特征和统计信息智能选择TiKV（行存）或TiFlash（列存），甚至在同一查询内混合使用两种存储。</li>
<li><strong>资源隔离</strong>：OLTP负载运行在TiKV上，OLAP复杂查询运行在TiFlash上，避免分析查询对事务处理的干扰。</li>
</ul>
<p>实际操作中，可以通过以下方式使用TiFlash：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 设置TiFlash副本</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> orders <span class="hljs-keyword">SET</span> TIFLASH REPLICA <span class="hljs-number">2</span>;

<span class="hljs-comment">-- 强制查询走TiFlash（TPC-H Query6优化）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-comment">/*+ read_from_storage(tiflash[lineitem]) */</span> 
       <span class="hljs-built_in">sum</span>(l_extendedprice <span class="hljs-operator">*</span> l_discount) <span class="hljs-keyword">as</span> revenue
<span class="hljs-keyword">FROM</span> lineitem
<span class="hljs-keyword">WHERE</span> l_shipdate <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'1994-01-01'</span>
  <span class="hljs-keyword">AND</span> l_shipdate <span class="hljs-operator">&lt;</span> date_add(<span class="hljs-string">'1994-01-01'</span>, <span class="hljs-type">interval</span> <span class="hljs-string">'1'</span> <span class="hljs-keyword">year</span>)
  <span class="hljs-keyword">AND</span> l_discount <span class="hljs-keyword">between</span> <span class="hljs-number">0.06</span> <span class="hljs-operator">-</span> <span class="hljs-number">0.01</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">0.06</span> <span class="hljs-operator">+</span> <span class="hljs-number">0.01</span>
  <span class="hljs-keyword">AND</span> l_quantity <span class="hljs-operator">&lt;</span> <span class="hljs-number">24</span>;
</code></pre>
<p>此示例展示了如何利用TiFlash加速分析型查询，<code>READ_FROM_STORAGE</code>提示符强制优化器使用列式存储。</p>
<h3 data-id="heading-6">2.2 弹性扩展与自动运维</h3>
<p>TiDB支持<strong>在线弹性扩展</strong>，可在不影响业务的情况下动态增减节点。计算层（TiDB Server）和存储层（TiKV）可以独立扩展，根据业务需求灵活调整。</p>
<p><strong>自动故障恢复</strong>机制基于Raft协议实现。当少数节点故障时，系统会自动选举新Leader，并在其他节点上恢复副本数据，实现金融级100%数据强一致性保证。故障转移过程对应用透明，客户端只需实现重试逻辑即可。</p>
<p>扩缩容操作可通过TiUP工具简单完成：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 水平扩展TiDB Server</span>
tiup cluster scale-<span class="hljs-keyword">out</span> &lt;cluster-name&gt; tidb.yaml

<span class="hljs-meta"># 垂直扩展TiKV节点配置</span>
tiup cluster edit-config &lt;cluster-name&gt;
</code></pre>
<p>这种<strong>无感扩容能力</strong>使TiDB特别适合业务快速增长或流量波动大的场景。</p>
<h3 data-id="heading-7">2.3 数据迁移与生态集成</h3>
<p>TiDB拥有丰富的工具链生态，提供完整的数据管理解决方案。主要工具包括：</p>
<ul>
<li><strong>DM（Data Migration）</strong> ：从MySQL到TiDB的数据迁移工具，支持全量和增量同步。</li>
<li><strong>BR（Backup &amp; Restore）</strong> ：集群级数据备份与恢复工具，支持分布式备份。</li>
<li><strong>TiCDC</strong>：变更数据捕获与同步工具，可将数据同步到MySQL、Kafka等下游系统。</li>
</ul>
<p>与MySQL的高度兼容性是TiDB的一大优势，支持大多数MySQL语法、存储过程、函数和触发器，使得现有MySQL应用可以平滑迁移。此外，TiDB数据可以方便地导入Kafka，接入Flink，乃至Hive、HDFS、Amazon S3、Spark等大数据生态组件，避免了技术锁定风险。</p>
<h2 data-id="heading-8">3 TiDB应用实战与性能优化</h2>
<h3 data-id="heading-9">3.1 应用场景分析</h3>
<p>TiDB特别适用于以下场景：</p>
<ul>
<li><strong>高并发OLTP应用</strong>：电商、金融、游戏等需要处理大量并发事务的场景</li>
<li><strong>实时分析系统</strong>：需要同时处理事务和分析查询的HTAP场景</li>
<li><strong>大数据量存储</strong>：单表数据量达数十亿甚至上百亿的记录存储和查询需求</li>
<li><strong>MySQL迁移升级</strong>：从MySQL迁移到分布式架构的平滑升级路径</li>
</ul>
<p>某金融企业案例显示，通过部署TiDB私有云解决方案，实现了数据的实时分析和高效处理，成功应对了数据量激增和业务复杂度提升的挑战。某电信个人账单系统从MyCAT迁移到TiDB后，单表数据量从80亿扩展到100亿，数据存储周期由半年延长至3-5年，QPS和延迟都有显著改善。</p>
<h3 data-id="heading-10">3.2 SQL优化最佳实践</h3>
<p>在TiDB中，SQL性能优化至关重要。以下是一些核心优化建议：</p>
<ul>
<li><strong>避免全表扫描</strong>：通过创建合适的索引避免全表扫描。使用EXPLAIN分析查询计划，确保查询有效利用索引。</li>
<li><strong>控制事务大小</strong>：将每个事务的记录数控制在200条以内，单条记录的数据大小小于100KB。大事务会增加延迟，容易引发冲突和内存压力。</li>
<li><strong>索引优化</strong>：一张表的索引数量建议不超过7个。使用覆盖索引避免回表操作，对字符串列考虑使用前缀索引节省空间。</li>
</ul>
<p>查询优化示例：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 不好的写法：使用OR导致全表扫描</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'alice'</span> <span class="hljs-keyword">OR</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">'123456'</span>;

<span class="hljs-comment">-- 优化写法：使用UNION替代OR</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'alice'</span> 
<span class="hljs-keyword">UNION</span> 
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">'123456'</span>;

<span class="hljs-comment">-- 创建覆盖索引优化查询</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_name_age <span class="hljs-keyword">ON</span> users(name, age);
<span class="hljs-keyword">SELECT</span> name, age <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'alice'</span>; <span class="hljs-comment">-- 无需回表</span>
</code></pre>
<h3 data-id="heading-11">3.3 分布式事务优化</h3>
<p>TiDB通过以下机制优化分布式事务性能：</p>
<ul>
<li><strong>异步提交（Async Commit）</strong> ：TiDB 5.0的Async Commit特性在事务提交的第二阶段实现异步提交，对于小事务达到类似1PC的效果，减少网络往返。</li>
<li><strong>悲观事务模式</strong>：高冲突场景下使用悲观事务模式，减少事务重试开销。</li>
<li><strong>批量操作</strong>：使用批量插入代替单条插入，显著提升吞吐量。</li>
</ul>
<p>Java应用中使用悲观事务的示例：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Java应用使用悲观事务</span>
try (Connection conn = ds.getConnection()) {
    conn<span class="hljs-selector-class">.setAutoCommit</span>(false);
    <span class="hljs-comment">// 开启悲观事务模式</span>
    conn<span class="hljs-selector-class">.createStatement</span>()<span class="hljs-selector-class">.execute</span>("SET tidb_txn_mode = 'pessimistic'");
    
    <span class="hljs-comment">// 先查询后更新（带锁）</span>
    ResultSet rs = conn<span class="hljs-selector-class">.createStatement</span>()<span class="hljs-selector-class">.executeQuery</span>(
        "SELECT balance FROM accounts WHERE id = <span class="hljs-number">1001</span> FOR UPDATE");
    
    <span class="hljs-comment">// 业务逻辑处理</span>
    BigDecimal newBalance = rs<span class="hljs-selector-class">.getBigDecimal</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.subtract</span>(amount);
    PreparedStatement ps = conn<span class="hljs-selector-class">.prepareStatement</span>(
        "UPDATE accounts SET balance = ? WHERE id = <span class="hljs-number">1001</span>");
    ps<span class="hljs-selector-class">.setBigDecimal</span>(<span class="hljs-number">1</span>, newBalance);
    ps<span class="hljs-selector-class">.executeUpdate</span>();
    conn<span class="hljs-selector-class">.commit</span>();
}
</code></pre>
<p>此示例展示了如何使用悲观事务避免高并发下的数据竞争问题。</p>
<h3 data-id="heading-12">3.4 热点问题处理与资源管理</h3>
<p>TiDB通过多种机制处理热点问题：</p>
<ul>
<li><strong>AUTO_RANDOM</strong>：使用AUTO_RANDOM代替AUTO_INCREMENT来分配主键，避免单调递增主键导致的写热点。</li>
<li><strong>SHARD_ROW_ID_BITS</strong>：通过行号分片分散热点。</li>
<li><strong>缓存策略</strong>：对频繁访问的小表数据使用TiDB内置缓存或应用层缓存（如Redis）。</li>
</ul>
<p>资源隔离配置示例：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># tidb-server资源控制配置</span>
<span class="hljs-attr">resource-control:</span>
  <span class="hljs-attr">request-unit:</span>
    <span class="hljs-comment"># 限制OLTP负载</span>
    <span class="hljs-attr">oltp:</span>
      <span class="hljs-attr">max-tasks:</span> <span class="hljs-number">500</span>
      <span class="hljs-attr">cpu-time-per-sec:</span> <span class="hljs-number">0.8</span>
    <span class="hljs-comment"># 保障OLAP资源</span>
    <span class="hljs-attr">olap:</span>
      <span class="hljs-attr">min-tasks:</span> <span class="hljs-number">200</span>
      <span class="hljs-attr">cpu-time-per-sec:</span> <span class="hljs-number">1.2</span>
</code></pre>
<p>此配置确保OLAP查询不会影响OLTP事务的性能。</p>
<h2 data-id="heading-13">4 部署架构与运维实践</h2>
<h3 data-id="heading-14">4.1 高可用架构设计</h3>
<p>TiDB提供金融级高可用保障，通过以下机制实现：</p>
<ul>
<li><strong>多副本机制</strong>：数据默认保存3副本，分布在不同的故障域。</li>
<li><strong>自动故障转移</strong>：少数节点故障时自动切换，无需人工干预。</li>
<li><strong>跨数据中心部署</strong>：支持同城三中心、两地三中心等部署模式，保证业务连续性。</li>
</ul>
<p>跨数据中心部署示例：</p>
<pre><code class="hljs language-scss" lang="scss">RegionA (主中心)         <span class="hljs-built_in">RegionB</span>(灾备中心)
├── <span class="hljs-number">3</span> PD节点（多数派）    ├── <span class="hljs-number">2</span> PD Learner
├── <span class="hljs-number">10</span> TiKV节点（标签zone=<span class="hljs-selector-tag">a</span>） ├── <span class="hljs-number">5</span> TiKV节点（标签zone=<span class="hljs-selector-tag">b</span>）
└── <span class="hljs-number">2</span> TiDB节点          └── <span class="hljs-number">1</span> TiDB节点
</code></pre>
<p>此拓扑确保单个数据中心故障时服务仍然可用。</p>
<h3 data-id="heading-15">4.2 监控与告警体系</h3>
<p>TiDB集成了Prometheus和Grafana构建完整的监控体系，关键监控指标包括：</p>
<ul>
<li><strong>集群概览</strong>：QPS、延迟、连接数等核心指标</li>
<li><strong>TiDB性能</strong>：查询耗时、执行时间、慢查询分析</li>
<li><strong>TiKV状态</strong>：CPU、IO负载、Region健康状态、调度操作</li>
<li><strong>PD调度</strong>：Balance操作、热点分布、调度队列</li>
</ul>
<p>通过设置合理的告警阈值，可以及时发现并处理潜在问题。例如，当出现"server is busy"或"channel full"错误时，通常意味着系统已达瓶颈，需要扩容或优化。</p>
<h3 data-id="heading-16">4.3 备份与恢复策略</h3>
<p>TiDB提供多种数据保护机制：</p>
<ul>
<li><strong>自动备份</strong>：支持全量和增量备份，可将数据备份到对象存储。</li>
<li><strong>时间点恢复（PITR）</strong> ：支持精确到秒级的数据恢复。</li>
<li><strong>异地容灾</strong>：通过TiCDC将数据同步到异地集群，实现容灾。</li>
</ul>
<p>备份策略示例：</p>
<pre><code class="hljs language-sql" lang="sql"># 使用BR进行全量备份
br backup <span class="hljs-keyword">full</span> \
    <span class="hljs-comment">--pd "&lt;pd-addresses&gt;" \</span>
    <span class="hljs-comment">--storage "s3://backup-data/backup-2023" \</span>
    <span class="hljs-comment">--ratelimit 128</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 应用保护工具怎么选？从攻击面拆解到工具职责划分的全链路实战指南]]></title>    <link>https://juejin.cn/post/7582519152566714383</link>    <guid>https://juejin.cn/post/7582519152566714383</guid>    <pubDate>2025-12-12T07:00:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582519152566714383" data-draft-id="7582519152566697999" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 应用保护工具怎么选？从攻击面拆解到工具职责划分的全链路实战指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-12T07:00:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂的程序猴"/> <meta itemprop="url" content="https://juejin.cn/user/2760245749234147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 应用保护工具怎么选？从攻击面拆解到工具职责划分的全链路实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760245749234147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂的程序猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:00:24.000Z" title="Fri Dec 12 2025 07:00:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动安全领域，“iOS 应用保护”听起来像是一个单一任务，但真正落地时你会发现——它并不是靠某个软件就能一劳永逸的。</p>
<p>保护 iOS 应用的过程更像是在维护一套复杂的工程系统，需要多个类型的工具协同，覆盖多个攻击入口，包括：</p>
<ul>
<li>符号泄露</li>
<li>JS / JSON / 配置文件明文</li>
<li>资源可替换</li>
<li>IPA 可重签名</li>
<li>运行时 Hook</li>
<li>越狱环境绕过</li>
<li>动态调试</li>
<li>逆向分析</li>
</ul>
<p>因此，“iOS 应用保护工具”并不是比谁强，而是比谁能覆盖更多环节、配合得更顺、工程化更容易。</p>
<p>本文将从攻击面拆解开始，再到工具矩阵与职责划分，最后给出一套完整的自动化工程方案，适合 Swift、ObjC、Flutter、React Native、Hybrid 等各类项目使用。</p>
<hr/>
<h2 data-id="heading-0">一、先看攻击者能突破哪些点（攻击面拆解）</h2>
<p>攻击路径是固定的，因此保护工具往往也是对这些入口进行阻断。</p>
<hr/>
<h2 data-id="heading-1"><strong>① 获取 IPA（通过 App Store / 企业包 / 重签包 / 网络泄露）</strong></h2>
<p>这意味着：
你的完整可执行文件和所有资源都暴露在攻击者手中。</p>
<hr/>
<h2 data-id="heading-2"><strong>② 静态逆向分析</strong></h2>
<p>攻击者会使用：</p>

























<table><thead><tr><th>工具</th><th>作用</th></tr></thead><tbody><tr><td>class-dump</td><td>导出 ObjC 符号</td></tr><tr><td>swift-dump</td><td>导出 Swift 符号</td></tr><tr><td>Hopper / IDA</td><td>反编译代码</td></tr><tr><td>MobSF</td><td>识别安全风险</td></tr></tbody></table>
<p>只要符号可读，逆向门槛就很低。</p>
<hr/>
<h2 data-id="heading-3"><strong>③ 修改资源与 JS/H5 逻辑</strong></h2>
<p>攻击者会直接替换：</p>
<ul>
<li>JSON 配置</li>
<li>JS 文件（Hybrid、RN、小游戏、WebView）</li>
<li>图片和 UI</li>
<li>信息表 / 配置表</li>
</ul>
<p>这是最常见的破解入口。</p>
<hr/>
<h2 data-id="heading-4"><strong>④ 修改二进制进行逻辑绕过</strong></h2>
<p>常见行为：</p>
<ul>
<li>Patch 校验</li>
<li>绕过会员 / 支付判断</li>
<li>移除广告</li>
<li>修改游戏数值</li>
</ul>
<hr/>
<h2 data-id="heading-5"><strong>⑤ 重签 IPA 并重新发布</strong></h2>
<p>工具如 kxsign 可轻松重签。</p>
<p>如果 App 没有完整性保护，破解者即可完成整个链路。</p>
<hr/>
<h2 data-id="heading-6">二、iOS 应用保护工具的分类与职责划分</h2>
<p>不合理的选型会造成工具重复、保护缺失、工程难维护。</p>
<p>合理的工具体系应该如下：</p>
<hr/>
<h2 data-id="heading-7">第一类：源码级保护工具（有源码时可选）</h2>
<p>适用 Swift / ObjC 工程。</p>
<h3 data-id="heading-8"><strong>Swift Shield</strong></h3>
<ul>
<li>混淆 Swift 方法、类名</li>
<li>修改可见性</li>
<li>降低结构可读性</li>
</ul>
<h3 data-id="heading-9"><strong>obfuscator-llvm</strong></h3>
<ul>
<li>深度混淆（控制流、字符串加密）</li>
<li>编译链级别，强度高但成本高</li>
</ul>
<p>这类工具的特点：</p>
<ul>
<li>覆盖源码，但无法保护生成的 IPA 中的资源文件</li>
<li>必须有源码才能用</li>
</ul>
<hr/>
<h2 data-id="heading-10">第二类：IPA 层保护工具（最通用且最重要）</h2>
<p>适用：</p>
<ul>
<li>Swift/ObjC 工程</li>
<li>Flutter</li>
<li>React Native</li>
<li>H5 / Hybrid</li>
<li>无源码工程</li>
<li>外包产物</li>
<li>第三方 SDK</li>
</ul>
<p>代表工具：</p>
<hr/>
<h2 data-id="heading-11"><strong>Ipa Guard（支持命令行）</strong></h2>
<p>IPA 层工具通常具备以下能力：</p>
<h3 data-id="heading-12"><strong>1）无需源码即可混淆符号</strong></h3>
<ul>
<li>Swift 名称</li>
<li>ObjC selector</li>
<li>方法名、变量名、类名</li>
</ul>
<h3 data-id="heading-13"><strong>2）资源混淆与防替换保护</strong></h3>
<ul>
<li>修改资源文件名称</li>
<li>扰动资源路径</li>
<li>修改 MD5 防止用同名资源替换</li>
<li>混淆 js（适合 H5 / RN / Hybrid）</li>
</ul>
<p>这点对保护 Flutter/RN 应用尤其关键。</p>
<h3 data-id="heading-14"><strong>3）IPA 重构，让二次打包难度增大</strong></h3>
<h3 data-id="heading-15"><strong>4）支持命令行，可接入 CI/CD</strong></h3>
<p>示例：</p>
<pre><code class="hljs language-bash" lang="bash">ipaguard_cli parse app.ipa -o sym.json
ipaguard_cli protect app.ipa -c sym.json --image --js -o protected.ipa
</code></pre>
<p>这是 iOS 加固中最常见、覆盖面最广的一类工具。</p>
<hr/>
<h2 data-id="heading-16">第三类：签名与安装验证工具</h2>
<p>用于验证加固后的 IPA 是否正常运行。</p>
<h3 data-id="heading-17"><strong>kxsign</strong></h3>
<ul>
<li>重签 IPA</li>
<li>安装到真机</li>
<li>用于准备审核包或测试包</li>
</ul>
<p>它不是加固工具，但在加固流程中不可缺失。</p>
<hr/>
<h2 data-id="heading-18">第四类：运行时防护工具（代码层实现）</h2>
<p>通过自研代码或安全 SDK 提供：</p>
<ul>
<li>防调试</li>
<li>防越狱</li>
<li>完整性校验</li>
<li>动态反 Hook</li>
<li>检查可疑注入</li>
</ul>
<p>这类通常需要工程师配合业务逻辑设计。</p>
<hr/>
<h2 data-id="heading-19">三、将多个工具组合成可真正落地的防护体系</h2>
<p>单一工具解决不了整体安全问题，必须构建多层体系。</p>
<p>以下是成熟移动团队常用的结构：</p>
<hr/>
<h2 data-id="heading-20"><strong>Layer 1：符号保护层（结构隐藏）</strong></h2>
<p>目标：
让逆向者无法轻易读懂系统结构。</p>
<p>工具组合：</p>
<ul>
<li>Swift Shield（如有源码）</li>
<li>Ipa Guard（IPA 层符号混淆）</li>
</ul>
<p>混淆后的类名可能如下：</p>
<pre><code class="hljs">_A3F9Controller
_B12FModel
_C7AFunction
</code></pre>
<p>逆向难度显著提升。</p>
<hr/>
<h2 data-id="heading-21"><strong>Layer 2：资源保护层（防篡改）</strong></h2>
<p>目标：
让攻击者无法通过替换资源来重写应用行为。</p>
<p>工具：
<strong>Ipa Guard CLI</strong></p>
<p>能力：</p>
<ul>
<li>修改 PNG / JSON / JS / HTML 名称</li>
<li>扰动路径</li>
<li>修改 MD5（替换资源即崩溃）</li>
</ul>
<p>这是破解链路中最关键的阻断点。</p>
<hr/>
<h2 data-id="heading-22"><strong>Layer 3：运行时保护层</strong></h2>
<p>工程内实现：</p>
<ul>
<li>完整性校验</li>
<li>Hook 检测</li>
<li>越狱检测</li>
<li>环境检测（模拟器 / 越狱插件）</li>
</ul>
<p>配合资源保护效果更好。</p>
<hr/>
<h2 data-id="heading-23"><strong>Layer 4：IPA 层结构保护与验证</strong></h2>
<p>工具组合：</p>
<ul>
<li>Ipa Guard（结构扰动）</li>
<li>kxsign（重签、验证、真机安装）</li>
</ul>
<p>流程示例：</p>
<pre><code class="hljs language-arduino" lang="arduino">kxsign sign <span class="hljs-keyword">protected</span>.ipa -c cert.p12 -p pass -m dev.mobileprovision -z <span class="hljs-type">signed</span>.ipa -i
</code></pre>
<hr/>
<h2 data-id="heading-24">四、场景化案例：不同类型 App 使用哪些工具组合？</h2>
<hr/>
<h2 data-id="heading-25"><strong>① Swift 原生项目</strong></h2>
<p>推荐组合：</p>
<ul>
<li>Swift Shield（源码层）</li>
<li>Ipa Guard（IPA 层）</li>
<li>自研完整性校验</li>
<li>Frida 反调试逻辑</li>
</ul>
<hr/>
<h2 data-id="heading-26"><strong>② Flutter 项目</strong></h2>
<p>Flutter 的资源全部明文，因此保护重点要放在 IPA 层。</p>
<p>推荐组合：</p>
<ul>
<li>Ipa Guard（flutter_assets 资源保护 + MD5）</li>
<li>JS 混淆（如使用 Hybrid）</li>
<li>kxsign 安装测试</li>
</ul>
<hr/>
<h2 data-id="heading-27"><strong>③ React Native 项目</strong></h2>
<p>RN 的 jsbundle 是最大风险点。</p>
<p>推荐组合：</p>
<ul>
<li>javascript-obfuscator（前端混淆）</li>
<li>Ipa Guard（bundle 路径扰动 + MD5 防替换）</li>
<li>Native 层符号混淆</li>
</ul>
<hr/>
<h2 data-id="heading-28"><strong>④ H5 / Hybrid 应用</strong></h2>
<p>需保护：</p>
<ul>
<li>js</li>
<li>html</li>
<li>img</li>
<li>config.json</li>
</ul>
<p>推荐组合：</p>
<ul>
<li>JS 混淆工具</li>
<li>Ipa Guard（资源路径混淆 + MD5 + JS 混淆）</li>
</ul>
<hr/>
<h2 data-id="heading-29"><strong>⑤ 无源码的历史工程或外部 SDK 集成 App</strong></h2>
<p>推荐组合：</p>
<ul>
<li><strong>Ipa Guard（主力工具，无需源码）</strong></li>
<li>kxsign（重签与安装验证）</li>
</ul>
<p>IPA 层保护基本能覆盖 80% 安全需求。</p>
<hr/>
<h2 data-id="heading-30">iOS 应用保护工具不是「用哪个」，而是「组合哪些」</h2>
<p>最终推荐的多层工具体系如下：</p>
<h2 data-id="heading-31"><strong>符号保护工具：</strong></h2>
<p>Swift Shield
obfuscator-llvm
<strong>Ipa Guard CLI（核心、IPA 层）</strong></p>
<h2 data-id="heading-32"><strong>资源保护与防替换工具：</strong></h2>
<p>JS 混淆工具
<strong>Ipa Guard CLI（路径扰动 + MD5 修改）</strong></p>
<h2 data-id="heading-33"><strong>签名与验证工具：</strong></h2>
<p>kxsign
Jenkins / GitHub Actions（自动化）</p>
<h2 data-id="heading-34"><strong>逆向验证工具：</strong></h2>
<p>Hopper
MobSF
Frida</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring 框架中 RequestContextHolder 深度解析]]></title>    <link>https://juejin.cn/post/7582808491583406116</link>    <guid>https://juejin.cn/post/7582808491583406116</guid>    <pubDate>2025-12-12T07:25:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582808491583406116" data-draft-id="7582808491582242852" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring 框架中 RequestContextHolder 深度解析"/> <meta itemprop="keywords" content="Java,架构"/> <meta itemprop="datePublished" content="2025-12-12T07:25:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李拾叁的摸鱼日常"/> <meta itemprop="url" content="https://juejin.cn/user/4443539294129722"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring 框架中 RequestContextHolder 深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4443539294129722/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李拾叁的摸鱼日常
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:25:03.000Z" title="Fri Dec 12 2025 07:25:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>RequestContextHolder 是 Spring 框架中<strong>核心的请求上下文管理工具类</strong>，本质是通过 <code>ThreadLocal</code> 将 HTTP 请求上下文（<code>HttpServletRequest</code>/<code>HttpServletResponse</code>/<code>Session</code> 等）绑定到当前线程，解决了非 Web 层（如 Service、Util、异步线程）无法直接获取请求上下文的问题，是 Spring MVC 实现全链路上下文传递的基石。</p>
<p>本文从<strong>核心作用、内部实现、方法详解、实战场景、避坑指南</strong>五个维度全面解析，覆盖开发全场景需求。</p>
<h2 data-id="heading-0">一、RequestContextHolder 核心定位与价值</h2>
<p>在 Spring MVC 中，<code>HttpServletRequest</code>/<code>HttpServletResponse</code> 等对象默认仅能在 Controller、Filter、Interceptor 等 Web 层通过方法参数获取，而 Service、Util 等非 Web 层无法直接访问。RequestContextHolder 解决了这一痛点：</p>
<h3 data-id="heading-1">核心价值</h3>
<ol>
<li><strong>解耦上下文获取</strong>：无需通过方法参数传递 <code>request</code>，降低代码耦合（如 Service 层无需接收 <code>request</code> 参数即可获取）；</li>
<li><strong>线程隔离</strong>：基于 <code>ThreadLocal</code> 实现，保证多线程环境下请求上下文不串用；</li>
<li><strong>子线程继承</strong>：支持 <code>InheritableThreadLocal</code>，满足异步/多线程场景的上下文传递；</li>
<li><strong>支撑框架核心功能</strong>：Spring MVC 的 <code>RequestMappingHandlerAdapter</code>、<code>SessionAttributesHandler</code>、<code>@RequestParam</code> 解析器等核心组件均依赖它获取上下文；</li>
<li><strong>兼容非 Web 场景</strong>：提供非空判断机制，避免定时任务、消息队列等非 Web 场景的空指针异常。</li>
</ol>
<h2 data-id="heading-2">二、RequestContextHolder 内部实现原理</h2>
<h3 data-id="heading-3">1. 底层存储：ThreadLocal 双容器设计</h3>
<p>RequestContextHolder 内部维护两个静态 <code>ThreadLocal</code> 容器，用于存储请求上下文的封装对象 <code>RequestAttributes</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 普通ThreadLocal：仅当前线程可见，子线程无法继承</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;RequestAttributes&gt; requestAttributesHolder = 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">NamedThreadLocal</span>&lt;&gt;(<span class="hljs-string">"Request attributes"</span>);

<span class="hljs-comment">// 可继承ThreadLocal：子线程创建时自动继承父线程的上下文</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;RequestAttributes&gt; inheritableRequestAttributesHolder = 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">NamedInheritableThreadLocal</span>&lt;&gt;(<span class="hljs-string">"Request context"</span>);
</code></pre>
<ul>
<li><code>NamedThreadLocal</code>/<code>NamedInheritableThreadLocal</code>：是 Spring 对 <code>ThreadLocal</code> 的扩展，仅增加了“线程名称”属性，便于调试（如打印 ThreadLocal 名称定位问题）；</li>
<li>双容器设计：区分“是否允许子线程继承”，满足不同场景的上下文传递需求。</li>
</ul>
<h3 data-id="heading-4">2. 核心封装：RequestAttributes 接口</h3>
<p>RequestContextHolder 不直接存储 <code>HttpServletRequest</code>，而是存储 <code>RequestAttributes</code> 接口的实现类（核心是 <code>ServletRequestAttributes</code>），这是 Spring 对 Servlet 上下文的抽象，解耦了具体的 Servlet API，便于扩展（如适配非 Servlet 环境）。</p>
<h4 data-id="heading-5">RequestAttributes 核心能力（接口方法）</h4>

































<table><thead><tr><th>方法/常量</th><th>作用</th></tr></thead><tbody><tr><td><code>SCOPE_REQUEST</code></td><td>请求级作用域（对应 <code>request.setAttribute</code>）</td></tr><tr><td><code>SCOPE_SESSION</code></td><td>会话级作用域（对应 <code>session.setAttribute</code>）</td></tr><tr><td><code>getAttribute(String name, int scope)</code></td><td>获取指定作用域的属性值</td></tr><tr><td><code>setAttribute(String name, Object value, int scope)</code></td><td>设置指定作用域的属性值</td></tr><tr><td><code>removeAttribute(String name, int scope)</code></td><td>移除指定作用域的属性值</td></tr><tr><td><code>resolveReference(String key)</code></td><td>解析 Servlet 原生对象（如 <code>REQUEST</code>/<code>RESPONSE</code>/<code>SESSION</code>）</td></tr></tbody></table>
<h4 data-id="heading-6">ServletRequestAttributes（核心实现类）</h4>
<p>封装了 <code>HttpServletRequest</code>/<code>HttpServletResponse</code>/<code>HttpSession</code>，提供以下关键方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取原生HttpServletRequest</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> HttpServletRequest <span class="hljs-title function_">getRequest</span><span class="hljs-params">()</span> { ... }
<span class="hljs-comment">// 获取原生HttpServletResponse</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> HttpServletResponse <span class="hljs-title function_">getResponse</span><span class="hljs-params">()</span> { ... }
<span class="hljs-comment">// 获取HttpSession（不存在则创建）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> HttpSession <span class="hljs-title function_">getSession</span><span class="hljs-params">()</span> { ... }
<span class="hljs-comment">// 获取请求完成时间（用于清理上下文）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestCompleted</span><span class="hljs-params">()</span> { ... }
</code></pre>
<h3 data-id="heading-7">3. 上下文绑定/解绑流程（Spring MVC 核心）</h3>
<p>RequestContextHolder 的上下文并非自动绑定，而是由 Spring MVC 的核心入口 <code>DispatcherServlet</code> 完成，流程如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb16aa2d178b4d7b87535c289023bdce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5ou-5Y-B55qE5pG46bG85pel5bi4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766129103&amp;x-signature=W7tfj2y47So%2BHF9aJmr2i5kNtvI%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>绑定时机：<code>DispatcherServlet#doDispatch</code> 方法开头；</li>
<li>解绑时机：<code>doDispatch</code> 方法的 <code>finally</code> 块（必须解绑，避免 ThreadLocal 内存泄漏）；</li>
<li>继承性控制：由 <code>spring.mvc.async.request-attributes-inheritable</code> 配置（默认 false），决定是否绑定到可继承的 ThreadLocal。</li>
<li>核心类/方法：<code>org.springframework.web.servlet.FrameworkServlet#processRequest</code>、<code>org.springframework.web.servlet.FrameworkServlet#initContextHolders</code>、<code>org.springframework.web.servlet.FrameworkServlet#resetContextHolders</code></li>
</ul>
<h2 data-id="heading-8">三、RequestContextHolder 所有方法详解</h2>
<p>RequestContextHolder 提供的方法均为 <strong>public static</strong>（除保护方法外），按功能分类解析：</p>
<h3 data-id="heading-9">1. 上下文获取方法（核心）</h3>
<h4 data-id="heading-10">(1) <code>getRequestAttributes()</code></h4>
<ul>
<li><strong>方法签名</strong>：<code>public static RequestAttributes getRequestAttributes()</code></li>
<li><strong>核心作用</strong>：获取当前线程绑定的 <code>RequestAttributes</code>，无绑定则返回 <code>null</code>；</li>
<li><strong>底层逻辑</strong>：先从 <code>requestAttributesHolder</code>（普通 ThreadLocal）获取，若为 null 则从 <code>inheritableRequestAttributesHolder</code> 获取；</li>
<li><strong>使用场景</strong>：非强制依赖上下文的场景（如日志记录，无上下文则跳过）；</li>
<li><strong>示例</strong>：
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getRequestIp</span><span class="hljs-params">()</span> {
    <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.getRequestAttributes();
    <span class="hljs-keyword">if</span> (attributes == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"未知IP（非Web请求）"</span>;
    }
    <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) attributes).getRequest();
    <span class="hljs-keyword">return</span> request.getRemoteAddr();
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-11">(2) <code>currentRequestAttributes()</code></h4>
<ul>
<li><strong>方法签名</strong>：<code>public static RequestAttributes currentRequestAttributes() throws IllegalStateException</code></li>
<li><strong>核心作用</strong>：强制获取上下文，无绑定则抛出 <code>IllegalStateException</code>（异常信息：<code>No thread-bound request found</code>）；</li>
<li><strong>底层逻辑</strong>：调用 <code>getRequestAttributes()</code>，返回 null 则抛异常；</li>
<li><strong>使用场景</strong>：必须依赖上下文的场景（如权限校验、租户隔离），无上下文则终止流程；</li>
<li><strong>示例</strong>：
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCurrentTenantId</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 无上下文直接抛异常，避免空指针</span>
    <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.currentRequestAttributes();
    <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) attributes).getRequest();
    <span class="hljs-type">String</span> <span class="hljs-variable">tenantId</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"Tenant-ID"</span>);
    <span class="hljs-keyword">if</span> (tenantId == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"租户ID缺失"</span>);
    }
    <span class="hljs-keyword">return</span> tenantId;
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-12">2. 上下文绑定方法</h3>
<h4 data-id="heading-13">(1) <code>setRequestAttributes(RequestAttributes attributes)</code></h4>
<ul>
<li><strong>方法签名</strong>：<code>public static void setRequestAttributes(RequestAttributes attributes)</code></li>
<li><strong>核心作用</strong>：将上下文绑定到当前线程的 <strong>普通 ThreadLocal</strong>（子线程无法继承）；</li>
<li><strong>底层逻辑</strong>：调用 <code>setRequestAttributes(attributes, false)</code>；</li>
<li><strong>使用场景</strong>：自定义 Servlet/Filter 时手动绑定上下文（无需子线程继承）；</li>
<li><strong>示例</strong>：
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义Filter中手动绑定</span>
<span class="hljs-meta">@WebFilter(urlPatterns = "/*")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException {
        <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletRequestAttributes</span>((HttpServletRequest) request, (HttpServletResponse) response);
        RequestContextHolder.setRequestAttributes(attributes); <span class="hljs-comment">// 绑定到普通ThreadLocal</span>
        <span class="hljs-keyword">try</span> {
            chain.doFilter(request, response);
        } <span class="hljs-keyword">finally</span> {
            RequestContextHolder.resetRequestAttributes(); <span class="hljs-comment">// 必须解绑</span>
        }
    }
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-14">(2) <code>setRequestAttributes(RequestAttributes attributes, boolean inheritable)</code></h4>
<ul>
<li><strong>方法签名</strong>：<code>public static void setRequestAttributes(RequestAttributes attributes, boolean inheritable)</code></li>
<li><strong>核心作用</strong>：绑定上下文，指定是否允许子线程继承；
<ul>
<li><code>inheritable=true</code>：绑定到 <code>inheritableRequestAttributesHolder</code>（可继承 ThreadLocal）；</li>
<li><code>inheritable=false</code>：绑定到 <code>requestAttributesHolder</code>（普通 ThreadLocal）；</li>
</ul>
</li>
<li><strong>使用场景</strong>：异步/多线程场景（如子线程需要获取父线程的请求上下文）；</li>
<li><strong>示例</strong>：
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 父线程绑定上下文并允许子线程继承</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parentThread</span><span class="hljs-params">()</span> {
    <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ...; <span class="hljs-comment">// 假设已获取request</span>
    <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletRequestAttributes</span>(request);
    RequestContextHolder.setRequestAttributes(attributes, <span class="hljs-literal">true</span>); <span class="hljs-comment">// 允许继承</span>
    
    <span class="hljs-comment">// 子线程创建时自动继承上下文</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attr</span> <span class="hljs-operator">=</span> RequestContextHolder.getRequestAttributes();
        System.out.println(attr != <span class="hljs-literal">null</span>); <span class="hljs-comment">// true</span>
    }).start();
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-15">3. 上下文重置/清理方法</h3>
<h4 data-id="heading-16"><code>resetRequestAttributes()</code></h4>
<ul>
<li><strong>方法签名</strong>：<code>public static void resetRequestAttributes()</code></li>
<li><strong>核心作用</strong>：清空当前线程的两个 ThreadLocal 容器（移除上下文）；</li>
<li><strong>底层逻辑</strong>：调用 <code>requestAttributesHolder.remove()</code> + <code>inheritableRequestAttributesHolder.remove()</code>；</li>
<li><strong>使用场景</strong>：自定义绑定上下文的场景（如 Filter、异步线程），必须在 <code>finally</code> 块调用，避免 ThreadLocal 内存泄漏；</li>
<li><strong>强制要求</strong>：Spring MVC 自动调用，但自定义场景（如手动绑定）必须手动调用！</li>
</ul>
<h3 data-id="heading-17">4. 保护方法（框架内部使用，开发极少用）</h3>
<h4 data-id="heading-18">(1) <code>getRequestAttributesHolder()</code></h4>
<ul>
<li><strong>方法签名</strong>：<code>protected static ThreadLocal&lt;RequestAttributes&gt; getRequestAttributesHolder()</code></li>
<li><strong>作用</strong>：返回普通 ThreadLocal 容器，供子类扩展（如自定义 RequestContextHolder）；</li>
</ul>
<h4 data-id="heading-19">(2) <code>getInheritableRequestAttributesHolder()</code></h4>
<ul>
<li><strong>方法签名</strong>：<code>protected static ThreadLocal&lt;RequestAttributes&gt; getInheritableRequestAttributesHolder()</code></li>
<li><strong>作用</strong>：返回可继承的 ThreadLocal 容器，框架内部扩展使用。</li>
</ul>
<h2 data-id="heading-20">四、RequestContextHolder 实战应用场景（详细）</h2>
<h3 data-id="heading-21">场景1：非 Web 层（Service/Util）获取请求上下文</h3>
<p>这是最常用的场景，解决 Service、工具类中获取 <code>request</code>/<code>response</code> 的需求，典型场景：</p>
<ul>
<li>记录操作日志：获取请求 IP、URL、请求参数、用户 Token；</li>
<li>业务逻辑：根据请求头（如 <code>Accept-Language</code>）返回多语言内容；</li>
<li>权限校验：在 Service 层校验请求头中的 Token 有效性。</li>
</ul>
<h4 data-id="heading-22">示例：全局操作日志工具类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperateLogUtil</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OperateLogMapper logMapper;

    <span class="hljs-comment">/**
     * 记录操作日志（自动填充请求上下文）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveLog</span><span class="hljs-params">(String operateType, String content)</span> {
        <span class="hljs-type">OperateLog</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OperateLog</span>();
        log.setOperateType(operateType);
        log.setContent(content);
        log.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());

        <span class="hljs-comment">// 获取请求上下文（非Web场景兼容）</span>
        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.getRequestAttributes();
        <span class="hljs-keyword">if</span> (attributes != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">servletAttr</span> <span class="hljs-operator">=</span> (ServletRequestAttributes) attributes;
            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> servletAttr.getRequest();
            <span class="hljs-comment">// 填充请求信息</span>
            log.setRequestIp(request.getRemoteAddr());
            log.setRequestUrl(request.getRequestURI());
            log.setRequestMethod(request.getMethod());
            log.setUserAgent(request.getHeader(<span class="hljs-string">"User-Agent"</span>));
            <span class="hljs-comment">// 从Token解析用户ID</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"Authorization"</span>);
            <span class="hljs-keyword">if</span> (token != <span class="hljs-literal">null</span>) {
                log.setOperateUserId(JwtUtil.parseUserId(token));
            }
        }

        logMapper.insert(log);
    }
}

<span class="hljs-comment">// Service中调用（无需传递request参数）</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OperateLogUtil logUtil;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(UserDTO dto)</span> {
        <span class="hljs-comment">// 业务逻辑</span>
        userMapper.updateById(dto);
        <span class="hljs-comment">// 记录日志（自动获取请求上下文）</span>
        logUtil.saveLog(<span class="hljs-string">"修改用户"</span>, <span class="hljs-string">"用户ID："</span> + dto.getId() + <span class="hljs-string">"，姓名："</span> + dto.getName());
    }
}
</code></pre>
<h3 data-id="heading-23">场景2：统一异常处理中补充请求信息</h3>
<p>全局异常处理器（<code>@RestControllerAdvice</code>）中，通过 RequestContextHolder 获取请求上下文，让异常日志包含请求信息，便于排查问题。</p>
<h4 data-id="heading-24">示例：全局异常处理器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(GlobalExceptionHandler.class);

    <span class="hljs-meta">@ExceptionHandler(BusinessException.class)</span>
    <span class="hljs-keyword">public</span> Result&lt;?&gt; handleBusinessException(BusinessException e) {
        <span class="hljs-comment">// 构建请求上下文信息</span>
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">requestInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.getRequestAttributes();
        <span class="hljs-keyword">if</span> (attributes != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) attributes).getRequest();
            requestInfo.append(<span class="hljs-string">"请求URL："</span>).append(request.getRequestURI())
                       .append(<span class="hljs-string">" | 请求方法："</span>).append(request.getMethod())
                       .append(<span class="hljs-string">" | IP："</span>).append(request.getRemoteAddr())
                       .append(<span class="hljs-string">" | 参数："</span>).append(JSON.toJSONString(request.getParameterMap()));
        } <span class="hljs-keyword">else</span> {
            requestInfo.append(<span class="hljs-string">"非Web请求"</span>);
        }

        <span class="hljs-comment">// 记录异常日志（含请求信息）</span>
        log.error(<span class="hljs-string">"业务异常：{} | 请求信息：{}"</span>, e.getMessage(), requestInfo, e);
        <span class="hljs-comment">// 返回统一响应</span>
        <span class="hljs-keyword">return</span> Result.fail(e.getCode(), e.getMessage());
    }
}
</code></pre>
<h3 data-id="heading-25">场景3：异步/多线程场景传递上下文</h3>
<p>Spring 的 <code>@Async</code> 异步方法、线程池任务默认无法继承父线程的 RequestContextHolder 上下文，需手动处理，否则子线程获取的上下文为 null。</p>
<h4 data-id="heading-26">方案1：手动绑定（零散异步场景）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTaskService</span> {
    <span class="hljs-comment">/**
     * 异步处理订单（手动传递上下文）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">asyncProcessOrder</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-comment">// 1. 父线程获取上下文</span>
        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">parentAttr</span> <span class="hljs-operator">=</span> RequestContextHolder.getRequestAttributes();
        
        <span class="hljs-comment">// 2. 异步任务中手动绑定</span>
        CompletableFuture.runAsync(() -&gt; {
            <span class="hljs-comment">// 绑定到当前异步线程</span>
            RequestContextHolder.setRequestAttributes(parentAttr, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 异步线程中获取请求信息</span>
                <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
                log.info(<span class="hljs-string">"异步处理订单{}，请求IP：{}"</span>, orderId, request.getRemoteAddr());
                <span class="hljs-comment">// 业务逻辑：处理订单</span>
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// 必须清理，避免线程池复用导致内存泄漏</span>
                RequestContextHolder.resetRequestAttributes();
            }
        });
    }
}
</code></pre>
<h4 data-id="heading-27">方案2：全局配置（@Async 全局生效）</h4>
<p>自定义 <code>TaskDecorator</code>，让所有异步线程自动继承父线程上下文：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAsync</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AsyncConfigurer</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">getAsyncExecutor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
        executor.setCorePoolSize(<span class="hljs-number">5</span>);
        executor.setMaxPoolSize(<span class="hljs-number">10</span>);
        executor.setQueueCapacity(<span class="hljs-number">20</span>);
        executor.setThreadNamePrefix(<span class="hljs-string">"async-"</span>);
        
        <span class="hljs-comment">// 核心：自定义TaskDecorator传递上下文</span>
        executor.setTaskDecorator(runnable -&gt; {
            <span class="hljs-comment">// 父线程上下文</span>
            <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">parentAttr</span> <span class="hljs-operator">=</span> RequestContextHolder.getRequestAttributes();
            <span class="hljs-keyword">return</span> () -&gt; {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 子线程绑定上下文</span>
                    RequestContextHolder.setRequestAttributes(parentAttr, <span class="hljs-literal">true</span>);
                    runnable.run();
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-comment">// 清理上下文</span>
                    RequestContextHolder.resetRequestAttributes();
                }
            };
        });
        
        executor.initialize();
        <span class="hljs-keyword">return</span> executor;
    }
}

<span class="hljs-comment">// 使用@Async时自动传递上下文</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-meta">@Async</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">asyncUpdateUser</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-comment">// 直接获取上下文，无需手动绑定</span>
        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.getRequestAttributes();
        <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) attributes).getRequest().getRemoteAddr();
        log.info(<span class="hljs-string">"异步更新用户{}，IP：{}"</span>, userId, ip);
    }
}
</code></pre>
<h3 data-id="heading-28">场景4：自定义请求级上下文扩展</h3>
<p>基于 RequestAttributes 的 <code>setAttribute</code>/<code>getAttribute</code>，实现请求级别的数据传递，无需通过方法参数传递临时数据。</p>
<h4 data-id="heading-29">示例：请求级临时数据传递</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义上下文工具类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestDataContext</span> {
    <span class="hljs-comment">// 自定义属性KEY（避免冲突）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_TEMP_DATA</span> <span class="hljs-operator">=</span> <span class="hljs-string">"REQUEST_TEMP_DATA"</span>;

    <span class="hljs-comment">/**
     * 设置请求级临时数据
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTempData</span><span class="hljs-params">(Object data)</span> {
        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.currentRequestAttributes();
        attributes.setAttribute(KEY_TEMP_DATA, data, RequestAttributes.SCOPE_REQUEST);
    }

    <span class="hljs-comment">/**
     * 获取请求级临时数据
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getTempData</span><span class="hljs-params">()</span> {
        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.currentRequestAttributes();
        <span class="hljs-keyword">return</span> (T) attributes.getAttribute(KEY_TEMP_DATA, RequestAttributes.SCOPE_REQUEST);
    }
}

<span class="hljs-comment">// Controller中设置</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/order")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {
    <span class="hljs-meta">@PostMapping("/create")</span>
    <span class="hljs-keyword">public</span> Result&lt;?&gt; createOrder(<span class="hljs-meta">@RequestBody</span> OrderDTO dto) {
        <span class="hljs-comment">// 设置请求级临时数据（无需传递给Service）</span>
        RequestDataContext.setTempData(dto.getOrderNo());
        orderService.createOrder(dto);
        <span class="hljs-keyword">return</span> Result.success();
    }
}

<span class="hljs-comment">// Service中获取</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderDTO dto)</span> {
        <span class="hljs-comment">// 获取请求级临时数据（无需方法参数）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> RequestDataContext.getTempData();
        log.info(<span class="hljs-string">"创建订单：{}"</span>, orderNo);
        <span class="hljs-comment">// 业务逻辑</span>
        orderMapper.insert(dto);
    }
}
</code></pre>
<h3 data-id="heading-30">场景5：框架扩展（自定义 MVC 组件）</h3>
<p>自定义 Spring MVC 组件（如参数解析器、拦截器）时，通过 RequestContextHolder 获取上下文，兼容非 MVC 场景。</p>
<h4 data-id="heading-31">示例：自定义当前用户参数解析器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义注解：标记当前登录用户</span>
<span class="hljs-meta">@Target(ElementType.PARAMETER)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> CurrentUser {
}

<span class="hljs-comment">// 参数解析器：自动解析当前登录用户</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CurrentUserArgumentResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerMethodArgumentResolver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supportsParameter</span><span class="hljs-params">(MethodParameter parameter)</span> {
        <span class="hljs-keyword">return</span> parameter.hasParameterAnnotation(CurrentUser.class);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">resolveArgument</span><span class="hljs-params">(MethodParameter parameter, ModelAndViewContainer mavContainer,
                                  NativeWebRequest webRequest, WebDataBinderFactory binderFactory)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 方式1：从webRequest获取（MVC场景推荐）</span>
        <span class="hljs-comment">// HttpServletRequest request = (HttpServletRequest) webRequest.getNativeRequest();</span>
        
        <span class="hljs-comment">// 方式2：从RequestContextHolder获取（兼容非MVC场景）</span>
        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.currentRequestAttributes();
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) attributes).getRequest();
        
        <span class="hljs-comment">// 从Token解析用户信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"Authorization"</span>);
        <span class="hljs-keyword">return</span> JwtUtil.parseUserInfo(token);
    }
}

<span class="hljs-comment">// 配置参数解析器</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CurrentUserArgumentResolver currentUserArgumentResolver;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addArgumentResolvers</span><span class="hljs-params">(List&lt;HandlerMethodArgumentResolver&gt; resolvers)</span> {
        resolvers.add(currentUserArgumentResolver);
    }
}

<span class="hljs-comment">// Controller中使用</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@GetMapping("/info")</span>
    <span class="hljs-keyword">public</span> Result&lt;UserInfo&gt; <span class="hljs-title function_">getUserInfo</span><span class="hljs-params">(<span class="hljs-meta">@CurrentUser</span> UserInfo userInfo)</span> {
        <span class="hljs-keyword">return</span> Result.success(userInfo);
    }
}
</code></pre>
<h2 data-id="heading-32">五、使用 RequestContextHolder 的注意事项（避坑指南）</h2>
<h3 data-id="heading-33">1. 避免 ThreadLocal 内存泄漏</h3>
<ul>
<li><strong>原因</strong>：线程池复用线程时，未清理的上下文会长期占用内存，最终导致内存泄漏；</li>
<li><strong>解决方案</strong>：
<ul>
<li>自定义绑定场景（如 Filter、异步线程），必须在 <code>finally</code> 块调用 <code>resetRequestAttributes()</code>；</li>
<li>避免在单例 Bean（如 Service）中持有 <code>RequestAttributes</code> 引用（会导致上下文串用）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-34">2. 异步/线程池场景的上下文传递</h3>
<ul>
<li><strong>问题</strong>：<code>InheritableThreadLocal</code> 仅在子线程<strong>创建时</strong>继承上下文，线程池复用线程时无效；</li>
<li><strong>解决方案</strong>：
<ul>
<li>零散异步场景：手动绑定+清理（方案1）；</li>
<li>全局异步场景：自定义 <code>TaskDecorator</code>（方案2）；</li>
<li>禁止依赖 <code>InheritableThreadLocal</code> 实现线程池上下文传递。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-35">3. 非 Web 场景的空指针问题</h3>
<ul>
<li><strong>问题</strong>：定时任务、消息队列消费、单元测试等非 Web 场景，<code>currentRequestAttributes()</code> 会抛异常；</li>
<li><strong>解决方案</strong>：
<ul>
<li>优先使用 <code>getRequestAttributes()</code>（返回 null），而非 <code>currentRequestAttributes()</code>；</li>
<li>增加非空判断，兼容非 Web 场景（如日志记录时跳过请求信息）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-36">4. 微服务跨服务调用的上下文传递</h3>
<ul>
<li><strong>问题</strong>：RequestContextHolder 仅在当前服务线程有效，无法直接传递到下游服务；</li>
<li><strong>解决方案</strong>：
<ul>
<li>手动将核心上下文（如 Token、Tenant-ID）放入 HTTP 请求头，下游服务从请求头获取；</li>
<li>使用 Spring Cloud 的 <code>RequestContextInterceptor</code> 自动传递请求头；</li>
<li>下游服务接收请求后，手动绑定上下文到 RequestContextHolder。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-37">5. 性能优化</h3>
<ul>
<li><strong>问题</strong>：频繁调用 <code>getRequestAttributes()</code> 会触发 ThreadLocal.get()，有轻微性能损耗；</li>
<li><strong>解决方案</strong>：
<ul>
<li>单次方法调用中，仅获取一次上下文，复用对象；</li>
<li>Controller 层优先通过方法参数获取 <code>request</code>，无需通过 RequestContextHolder；</li>
<li>非必要场景，避免使用（如仅需获取请求参数，可通过 <code>@RequestParam</code> 直接接收）。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-38">六、总结</h2>
<p>RequestContextHolder 是 Spring MVC 上下文管理的核心工具，核心逻辑是<strong>基于 ThreadLocal 实现请求上下文的线程绑定与全链路获取</strong>，其价值在于解耦 Web 层与非 Web 层的上下文依赖。</p>
<h3 data-id="heading-39">核心要点</h3>
<ol>
<li>底层存储：双 ThreadLocal（普通 + 可继承），存储 <code>RequestAttributes</code>（核心实现 <code>ServletRequestAttributes</code>）；</li>
<li>核心方法：获取（<code>getRequestAttributes</code>/<code>currentRequestAttributes</code>）、绑定（<code>setRequestAttributes</code>）、重置（<code>resetRequestAttributes</code>）；</li>
<li>典型场景：非 Web 层获取 request、统一异常处理、异步上下文传递、自定义 MVC 组件、请求级数据传递；</li>
<li>避坑关键：及时清理上下文、兼容非 Web 场景、异步线程手动传递上下文。</li>
</ol>
<p>合理使用 RequestContextHolder 可大幅降低代码耦合，但需遵循“按需使用、及时清理”的原则，避免引入内存泄漏、上下文串用等问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>