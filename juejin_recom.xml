<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[关于地图渲染加20w数据展示和地图动画怎么做]]></title>    <link>https://juejin.cn/post/7598071804971024422</link>    <guid>https://juejin.cn/post/7598071804971024422</guid>    <pubDate>2026-01-23T03:14:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598071804971024422" data-draft-id="7598043378018713609" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于地图渲染加20w数据展示和地图动画怎么做"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-23T03:14:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sunshine_"/> <meta itemprop="url" content="https://juejin.cn/user/1135139405723559"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于地图渲染加20w数据展示和地图动画怎么做
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1135139405723559/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sunshine_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:14:47.000Z" title="Fri Jan 23 2026 03:14:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前端性能优化实战：ECharts地图渲染12万+数据动态动画方案</h2>
<blockquote>
<p>本文记录了在实际项目中，使用ECharts地图组件渲染12万+设备安装数据的性能优化实战经验，包含完整的技术方案和代码实现。</p>
</blockquote>
<h3 data-id="heading-1">项目背景</h3>
<p>公司需要将全年设备安装量通过旗帜的形式展示在全国地图上，实现数据可视化大屏。主要技术挑战：</p>
<ul>
<li><strong>数据量大</strong>：全年设备安装数据约20万条</li>
<li><strong>实时更新</strong>：通过WebSocket实时接收数据</li>
<li><strong>动画效果</strong>：需要展示数据逐条添加的动态效果</li>
<li><strong>性能要求</strong>：需要保持60fps的流畅动画</li>
</ul>
<h3 data-id="heading-2">一、初始实现与性能瓶颈</h3>
<h4 data-id="heading-3">1.1 基础地图配置</h4>
<p>首先使用ECharts搭建基础地图框架：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">initChart</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chart</span> = echarts.<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">chart</span>);
    <span class="hljs-keyword">let</span> option = {
        <span class="hljs-attr">geo</span>: {
            <span class="hljs-attr">map</span>: <span class="hljs-string">'china'</span>,
            <span class="hljs-attr">roam</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">zoom</span>: <span class="hljs-number">1.1</span>,
            <span class="hljs-attr">scaleLimit</span>: { <span class="hljs-attr">min</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">10</span> },
            <span class="hljs-attr">itemStyle</span>: {
                <span class="hljs-attr">areaColor</span>: <span class="hljs-string">'rgba(91,97,141,.3)'</span>,
                <span class="hljs-attr">borderColor</span>: <span class="hljs-string">'rgba(0,0,0,.2)'</span>
            }
        },
        <span class="hljs-attr">series</span>: [
            <span class="hljs-comment">// 基础地图层</span>
            {
                <span class="hljs-attr">type</span>: <span class="hljs-string">'map'</span>,
                <span class="hljs-attr">map</span>: <span class="hljs-string">'china'</span>,
                <span class="hljs-attr">itemStyle</span>: {
                    <span class="hljs-attr">areaColor</span>: <span class="hljs-string">'rgba(0,0,0,0)'</span>,
                    <span class="hljs-attr">borderColor</span>: <span class="hljs-string">'rgba(255,255,255,1)'</span>,
                }
            },
            <span class="hljs-comment">// 设备点图层</span>
            {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'scatter'</span>,
                <span class="hljs-attr">type</span>: <span class="hljs-string">'scatter'</span>,
                <span class="hljs-attr">coordinateSystem</span>: <span class="hljs-string">'geo'</span>,
                <span class="hljs-attr">data</span>: [],
                <span class="hljs-attr">symbol</span>: <span class="hljs-string">'image://flag.png'</span>,  <span class="hljs-comment">// 旗帜图标</span>
                <span class="hljs-attr">symbolSize</span>: [<span class="hljs-number">16</span>, <span class="hljs-number">22</span>],
                <span class="hljs-attr">animation</span>: <span class="hljs-literal">false</span>  <span class="hljs-comment">// 关闭内置动画</span>
            }
        ]
    };
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chart</span>.<span class="hljs-title function_">setOption</span>(option);
}
</code></pre>
<h4 data-id="heading-4">1.2 动画设计</h4>
<p>设计旗帜生长动画效果，通过随机数实现多样化的动画展示：</p>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 旗帜动画效果设计</span>
<span class="hljs-keyword">const</span> flagAnimations = [
    <span class="hljs-string">'scaleUp'</span>,      <span class="hljs-comment">// 从小变大</span>
    <span class="hljs-string">'fadeIn'</span>,       <span class="hljs-comment">// 淡入</span>
    <span class="hljs-string">'bounceIn'</span>,     <span class="hljs-comment">// 弹跳进入</span>
    <span class="hljs-string">'rotateIn'</span>      <span class="hljs-comment">// 旋转进入</span>
];

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getRandomAnimation</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> flagAnimations[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * flagAnimations.<span class="hljs-property">length</span>)];
}
</code></pre>
<h4 data-id="heading-5">1.3 遇到的性能瓶颈</h4>
<p>当数据量达到3-5万条时，开始出现明显卡顿：</p>
<ul>
<li>动画帧率下降到30fps以下</li>
<li>内存占用持续增长</li>
<li>缩放平移操作卡顿</li>
<li>WebSocket数据堆积</li>
</ul>
<h3 data-id="heading-6">二、分层策略优化方案</h3>
<p>经过调研，我们采用了<strong>分层策略</strong>来优化性能，根据不同的缩放级别采用不同的渲染策略。</p>
<h4 data-id="heading-7">2.1 分层策略设计</h4>
<p>javascript</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">const</span> <span class="hljs-string">zoomConfigs</span> <span class="hljs-string">=</span> {
    <span class="hljs-attr">low:</span> {  <span class="hljs-string">//</span> <span class="hljs-string">低缩放级别：全国视图</span>
        <span class="hljs-attr">zoom:</span> <span class="hljs-number">2</span>,
        <span class="hljs-attr">sampleRate:</span> <span class="hljs-number">0.1</span>,    <span class="hljs-string">//</span> <span class="hljs-number">10</span><span class="hljs-string">%抽样显示</span>
        <span class="hljs-attr">precision:</span> <span class="hljs-number">2</span>,       <span class="hljs-string">//</span> <span class="hljs-string">经纬度精度：小数点后2位</span>
        <span class="hljs-attr">symbolSize:</span> [<span class="hljs-number">8</span>, <span class="hljs-number">11</span>] <span class="hljs-string">//</span> <span class="hljs-string">缩小图标</span>
    },
    <span class="hljs-attr">mid:</span> {  <span class="hljs-string">//</span> <span class="hljs-string">中缩放级别：省级视图</span>
        <span class="hljs-attr">zoom:</span> <span class="hljs-number">5</span>,
        <span class="hljs-attr">sampleRate:</span> <span class="hljs-number">0.5</span>,    <span class="hljs-string">//</span> <span class="hljs-number">50</span><span class="hljs-string">%抽样显示</span>
        <span class="hljs-attr">precision:</span> <span class="hljs-number">3</span>,       <span class="hljs-string">//</span> <span class="hljs-string">经纬度精度：小数点后3位</span>
        <span class="hljs-attr">symbolSize:</span> [<span class="hljs-number">12</span>, <span class="hljs-number">16</span>]
    },
    <span class="hljs-attr">high:</span> { <span class="hljs-string">//</span> <span class="hljs-string">高缩放级别：市级视图</span>
        <span class="hljs-attr">zoom:</span> <span class="hljs-number">10</span>,
        <span class="hljs-attr">sampleRate:</span> <span class="hljs-number">1</span>,      <span class="hljs-string">//</span> <span class="hljs-number">100</span><span class="hljs-string">%显示</span>
        <span class="hljs-attr">precision:</span> <span class="hljs-number">4</span>,       <span class="hljs-string">//</span> <span class="hljs-string">经纬度精度：小数点后4位</span>
        <span class="hljs-attr">symbolSize:</span> [<span class="hljs-number">16</span>, <span class="hljs-number">22</span>]
    }
}<span class="hljs-string">;</span>
</code></pre>
<h4 data-id="heading-8">2.2 动态动画调度系统</h4>
<p>javascript</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AnimationScheduler</span> {
    <span class="hljs-keyword">constructor</span>() {
        <span class="hljs-keyword">this</span>.pendingList = [];      <span class="hljs-comment">// 待处理数据队列</span>
        <span class="hljs-keyword">this</span>.allDeviceList = [];    <span class="hljs-comment">// 所有数据存储</span>
        <span class="hljs-keyword">this</span>.displayList = [];      <span class="hljs-comment">// 当前显示数据</span>
        <span class="hljs-keyword">this</span>.deviceSet = new Set(); <span class="hljs-comment">// 数据去重</span>
        <span class="hljs-keyword">this</span>.displaySet = new Set(); <span class="hljs-comment">// 显示去重</span>
        <span class="hljs-keyword">this</span>.animationTimer = <span class="hljs-literal">null</span>;
        
        <span class="hljs-comment">// 帧率控制</span>
        <span class="hljs-keyword">this</span>.frameInterval = <span class="hljs-number">50</span>;    <span class="hljs-comment">// 20fps</span>
        <span class="hljs-keyword">this</span>.batchSize = <span class="hljs-number">100</span>;       <span class="hljs-comment">// 每批处理数量</span>
    }
    
    <span class="hljs-comment">// 启动动画调度</span>
    startAnimation() {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.animationTimer) <span class="hljs-keyword">return</span>;
        
        let lastTime = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">const</span> animate = (currentTime) =&gt; {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pendingList.length === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">this</span>.stopAnimation();
                <span class="hljs-keyword">return</span>;
            }
            
            <span class="hljs-comment">// 帧率控制</span>
            <span class="hljs-keyword">if</span> (currentTime - lastTime &gt;= <span class="hljs-keyword">this</span>.frameInterval) {
                lastTime = currentTime;
                <span class="hljs-keyword">this</span>.processBatch();
            }
            
            <span class="hljs-keyword">this</span>.animationTimer = requestAnimationFrame(animate);
        };
        
        <span class="hljs-keyword">this</span>.animationTimer = requestAnimationFrame(animate);
    }
    
    <span class="hljs-comment">// 处理一批数据</span>
    processBatch() {
        <span class="hljs-keyword">const</span> batch = <span class="hljs-keyword">this</span>.pendingList.splice(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.batchSize);
        <span class="hljs-keyword">const</span> config = <span class="hljs-keyword">this</span>.getCurrentZoomConfig();
        let hasNewData = <span class="hljs-literal">false</span>;
        
        batch.forEach(item =&gt; {
            <span class="hljs-comment">// 全局去重</span>
            <span class="hljs-keyword">const</span> globalKey = `${item.lng},${item.lat}`;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.deviceSet.has(globalKey)) <span class="hljs-keyword">return</span>;
            <span class="hljs-keyword">this</span>.deviceSet.add(globalKey);
            
            <span class="hljs-keyword">const</span> point = {
                value: [item.lng, item.lat],
                createTime: item.createTime
            };
            <span class="hljs-keyword">this</span>.allDeviceList.push(point);
            
            <span class="hljs-comment">// 根据当前缩放级别抽样</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.shouldDisplay(point, config)) {
                <span class="hljs-keyword">const</span> displayKey = <span class="hljs-keyword">this</span>.getDisplayKey(point, config);
                <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.displaySet.has(displayKey)) {
                    <span class="hljs-keyword">this</span>.displaySet.add(displayKey);
                    <span class="hljs-keyword">this</span>.displayList.push(point);
                    hasNewData = <span class="hljs-literal">true</span>;
                }
            }
        });
        
        <span class="hljs-comment">// 批量更新图表</span>
        <span class="hljs-keyword">if</span> (hasNewData) {
            <span class="hljs-keyword">this</span>.updateChart();
        }
    }
}
</code></pre>
<h4 data-id="heading-9">2.3 智能显示判断</h4>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 根据缩放级别判断是否显示</span>
<span class="hljs-built_in">shouldDisplay</span>(point, config) {
    <span class="hljs-comment">// 完全显示模式</span>
    <span class="hljs-keyword">if</span> (config.sampleRate &gt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    
    <span class="hljs-comment">// 抽样显示模式</span>
    <span class="hljs-type">const</span> displayChance = Math.<span class="hljs-built_in">random</span>();
    <span class="hljs-keyword">return</span> displayChance &lt; config.sampleRate;
}

<span class="hljs-comment">// 生成显示键（根据精度去重）</span>
<span class="hljs-built_in">getDisplayKey</span>(point, config) {
    <span class="hljs-type">const</span> lng = point.value[<span class="hljs-number">0</span>].<span class="hljs-built_in">toFixed</span>(config.precision);
    <span class="hljs-type">const</span> lat = point.value[<span class="hljs-number">1</span>].<span class="hljs-built_in">toFixed</span>(config.precision);
    <span class="hljs-keyword">return</span> `${lng},${lat}`;
}
</code></pre>
<h4 data-id="heading-10">2.4 缩放级别变化处理</h4>
<p>javascript</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 监听缩放变化</span>
setupZoomListener() {
    <span class="hljs-keyword">this</span>.chart.on(<span class="hljs-string">'georoam'</span>, () =&gt; {
        <span class="hljs-keyword">const</span> option = <span class="hljs-keyword">this</span>.chart.getOption();
        <span class="hljs-keyword">if</span> (option.geo &amp;&amp; option.geo[<span class="hljs-number">0</span>]) {
            <span class="hljs-keyword">const</span> newZoom = option.geo[<span class="hljs-number">0</span>].zoom;
            <span class="hljs-keyword">if</span> (Math.abs(newZoom - <span class="hljs-keyword">this</span>.currentZoom) &gt; <span class="hljs-number">0.1</span>) {
                <span class="hljs-keyword">this</span>.currentZoom = newZoom;
                <span class="hljs-keyword">this</span>.handleZoomChange();
            }
        }
    });
}

<span class="hljs-comment">// 处理缩放变化</span>
handleZoomChange() {
    <span class="hljs-keyword">const</span> config = <span class="hljs-keyword">this</span>.getCurrentZoomConfig();
    
    <span class="hljs-comment">// 只有层级变化时才重建显示数据</span>
    <span class="hljs-keyword">if</span> (config.level !== <span class="hljs-keyword">this</span>.currentZoomLevel) {
        <span class="hljs-keyword">this</span>.currentZoomLevel = config.level;
        <span class="hljs-keyword">this</span>.rebuildDisplayList();
    }
}

<span class="hljs-comment">// 重建显示数据</span>
rebuildDisplayList() {
    <span class="hljs-keyword">const</span> config = <span class="hljs-keyword">this</span>.getCurrentZoomConfig();
    <span class="hljs-keyword">this</span>.displayList = [];
    <span class="hljs-keyword">this</span>.displaySet = new Set();
    
    <span class="hljs-keyword">if</span> (config.sampleRate &gt;= <span class="hljs-number">1</span>) {
        <span class="hljs-comment">// 全量显示模式</span>
        <span class="hljs-keyword">this</span>.displayAllData(config);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 抽样显示模式</span>
        <span class="hljs-keyword">this</span>.displaySampledData(config);
    }
    
    <span class="hljs-keyword">this</span>.updateChart();
}

<span class="hljs-comment">// 全量显示（高精度去重）</span>
displayAllData(config) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item of <span class="hljs-keyword">this</span>.allDeviceList) {
        <span class="hljs-keyword">const</span> key = <span class="hljs-keyword">this</span>.getDisplayKey(item, config);
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.displaySet.has(key)) {
            <span class="hljs-keyword">this</span>.displaySet.add(key);
            <span class="hljs-keyword">this</span>.displayList.push(item);
        }
    }
}

<span class="hljs-comment">// 抽样显示</span>
displaySampledData(config) {
    <span class="hljs-keyword">const</span> step = Math.max(<span class="hljs-number">1</span>, Math.floor(<span class="hljs-number">1</span> / config.sampleRate));
    <span class="hljs-keyword">for</span> (let i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.allDeviceList.length; i += step) {
        <span class="hljs-keyword">const</span> item = <span class="hljs-keyword">this</span>.allDeviceList[i];
        <span class="hljs-keyword">const</span> key = <span class="hljs-keyword">this</span>.getDisplayKey(item, config);
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.displaySet.has(key)) {
            <span class="hljs-keyword">this</span>.displaySet.add(key);
            <span class="hljs-keyword">this</span>.displayList.push(item);
        }
    }
}
</code></pre>
<h3 data-id="heading-11">三、其他优化技巧</h3>
<h4 data-id="heading-12">3.1 内存管理优化</h4>
<p>javascript</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定期清理过期数据</span>
setupMemoryManagement() {
    setInterval(() =&gt; {
        <span class="hljs-comment">// 限制总数据量</span>
        <span class="hljs-keyword">const</span> maxTotal = <span class="hljs-number">150000</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.allDeviceList.length &gt; maxTotal) {
            <span class="hljs-keyword">const</span> removeCount = <span class="hljs-keyword">this</span>.allDeviceList.length - <span class="hljs-number">120000</span>;
            <span class="hljs-keyword">this</span>.allDeviceList.splice(<span class="hljs-number">0</span>, removeCount);
            
            <span class="hljs-comment">// 清理相关缓存</span>
            <span class="hljs-keyword">this</span>.cleanCache();
            
            <span class="hljs-comment">// 重建显示</span>
            <span class="hljs-keyword">this</span>.rebuildDisplayList();
        }
    }, <span class="hljs-number">30000</span>); <span class="hljs-comment">// 每30秒检查一次</span>
}

<span class="hljs-comment">// WebSocket数据流控</span>
setupWebSocketFlowControl() {
    let buffer = [];
    let processing = <span class="hljs-literal">false</span>;
    
    <span class="hljs-keyword">this</span>.ws.onmessage = (event) =&gt; {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">data</span> = JSON.parse(event.<span class="hljs-keyword">data</span>);
        buffer.push(...<span class="hljs-keyword">data</span>);
        
        <span class="hljs-comment">// 流量控制：如果缓冲过多，暂停接收</span>
        <span class="hljs-keyword">if</span> (buffer.length &gt; <span class="hljs-number">5000</span> &amp;&amp; !processing) {
            <span class="hljs-keyword">this</span>.ws.pause();
        }
        
        <span class="hljs-keyword">if</span> (!processing) {
            <span class="hljs-keyword">this</span>.processWebSocketBuffer();
        }
    };
}
</code></pre>
<h4 data-id="heading-13">3.2 性能监控</h4>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">// 添加性能监控
setupPerformanceMonitor() {
    let <span class="hljs-attr">frames</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    let <span class="hljs-attr">lastTime</span> = performance.now()<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">monitor</span> = () =&gt; {
        frames++<span class="hljs-comment">;</span>
        const <span class="hljs-attr">currentTime</span> = performance.now()<span class="hljs-comment">;</span>
        
        if (currentTime - lastTime &gt;= 1000) {
            const <span class="hljs-attr">fps</span> = Math.round(frames * <span class="hljs-number">1000</span> / (currentTime - lastTime))<span class="hljs-comment">;</span>
            console.log(`当前FPS: ${fps}`)<span class="hljs-comment">;</span>
            
            // 动态调整策略
            this.adjustStrategyByFPS(fps)<span class="hljs-comment">;</span>
            
            <span class="hljs-attr">frames</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
            <span class="hljs-attr">lastTime</span> = currentTime<span class="hljs-comment">;</span>
        }
        
        requestAnimationFrame(monitor)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
    
    requestAnimationFrame(monitor)<span class="hljs-comment">;</span>
}

// 根据FPS动态调整
adjustStrategyByFPS(fps) {
    if (fps &lt; 30) {
        // 降低渲染质量
        <span class="hljs-attr">this.frameInterval</span> = <span class="hljs-number">100</span><span class="hljs-comment">; // 10fps</span>
        <span class="hljs-attr">this.batchSize</span> = <span class="hljs-number">50</span><span class="hljs-comment">;</span>
    } else if (fps &gt; 50) {
        // 提高渲染质量
        <span class="hljs-attr">this.frameInterval</span> = <span class="hljs-number">33</span><span class="hljs-comment">; // 30fps</span>
        <span class="hljs-attr">this.batchSize</span> = <span class="hljs-number">150</span><span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-14">四、效果对比</h3>
<h4 data-id="heading-15">优化前：</h4>
<ul>
<li>3万数据开始卡顿</li>
<li>内存占用500MB+</li>
<li>缩放操作延迟明显</li>
<li>动画掉帧严重</li>
</ul>
<h4 data-id="heading-16">优化后：</h4>
<ul>
<li>12万数据流畅运行</li>
<li>内存控制在200MB以内</li>
<li>缩放操作流畅</li>
<li>保持30fps以上动画</li>
</ul>
<h3 data-id="heading-17">五、总结</h3>
<p>通过分层策略优化，我们成功实现了：</p>
<ol>
<li><strong>智能显示</strong>：根据缩放级别动态调整显示策略</li>
<li><strong>性能平衡</strong>：在视觉效果和性能之间找到平衡点</li>
<li><strong>内存控制</strong>：有效管理大量数据的内存占用</li>
<li><strong>流畅动画</strong>：保持高帧率的动画效果</li>
</ol>
<p>这种分层策略不仅适用于地图可视化，也可以扩展到其他大规模数据可视化场景中。关键思想是：<strong>不同视角需要不同精度的数据展示</strong>。</p>
<hr/>
<p><strong>参考资料</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fecharts.apache.org%2Fzh%2Findex.html" target="_blank" title="https://echarts.apache.org/zh/index.html" ref="nofollow noopener noreferrer">ECharts 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWebGL_API" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/WebGL_API" ref="nofollow noopener noreferrer">WebGL大规模数据渲染优化</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fweb%2Ffundamentals%2Fperformance%2Frendering" target="_blank" title="https://developers.google.com/web/fundamentals/performance/rendering" ref="nofollow noopener noreferrer">数据可视化性能优化指南</a></li>
</ul>
<p>text</p>
<pre><code class="hljs language-markdown" lang="markdown">这个版本优化了：
<span class="hljs-bullet">1.</span> 增加了技术深度和实战经验分享
<span class="hljs-bullet">2.</span> 完善了代码注释和说明
<span class="hljs-bullet">3.</span> 添加了性能对比和总结
<span class="hljs-bullet">4.</span> 适合掘金平台的阅读体验
<span class="hljs-bullet">5.</span> 增加了思考题，促进互动
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么我劝你慎用 Next.js App Router：一场架构设计的“过度狂欢”]]></title>    <link>https://juejin.cn/post/7598071804971057190</link>    <guid>https://juejin.cn/post/7598071804971057190</guid>    <pubDate>2026-01-23T03:15:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598071804971057190" data-draft-id="7598021984300761115" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么我劝你慎用 Next.js App Router：一场架构设计的“过度狂欢”"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2026-01-23T03:15:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员Agions"/> <meta itemprop="url" content="https://juejin.cn/user/360295545187751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么我劝你慎用 Next.js App Router：一场架构设计的“过度狂欢”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/360295545187751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员Agions
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:15:14.000Z" title="Fri Jan 23 2026 03:15:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>摘要</strong>：当前端工程师们审视这两年的技术演变，会发现 Next.js 似乎把我们带进了一个精心设计的迷宫。从 Server Components 的“强制推销”，到默认缓存机制的“玄学黑箱”。本文将从技术实现与开发体验的角度，深度剖析 App Router 是如何把简单问题复杂化的。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">01. “我只是想写个 Dashboard，你为什么让我学分布式系统？”</h2>
<p>曾经的 Next.js 是“开箱即用”的代名词。
但现在的 App Router，让每一个新项目的启动都像是一场架构考试。</p>
<p><strong>从“写代码”变成“写配置”</strong>
当你只是想快速搭一个后台管理系统时，你立刻会撞上第一堵墙：<strong>组件渲染边界的割裂</strong>。</p>
<p>想引个 Ant Design 或者 Material UI 的 <code>Button</code> 组件？
报错：<strong><code>Error: createContext only works in Client Components</code></strong>。
原因很简单：这些 UI 库普遍使用了 <code>Context</code>，而 Server Components 不支持。
解决方案听起来很容易：“在文件头加 <code>"use client"</code>”。</p>
<p>但事情没那么简单。
为了能在 Server Component 的布局（Layout）里使用 Redux 或 ThemeProvider，你不能直接包一层。你必须创建一个单独的 <code>Providers.tsx</code> 文件，把所有 Context 逻辑塞进去，标记为 Client Component，然后再导出来给 Layout 使用。</p>
<p><strong>代码结构瞬间变成了“俄罗斯套娃”</strong>。为了绕过 RSC（React Server Components）的限制，我们被迫创造了无数层仅为了“中转”的 Wrapper 组件。剥开这十层包装纸，里面可能只是为了渲染一个普通的 <code>&lt;div /&gt;</code>。</p>
<h2 data-id="heading-1">02. 缓存玄学：默认行为的傲慢</h2>
<p>Next.js 在 App Router 中引入了极其激进的缓存策略。
默认情况下，<code>fetch</code> 请求被视为静态的，并且会<strong>永久缓存</strong>。</p>
<p>这就导致了一个经典的“鬼故事”：
你改了数据库的配置，刷新页面，数据没变。
你重启了服务器，数据还是没变。
你甚至删了 <code>.next</code> 文件夹重新 build，数据可能还在（因为由上游 CDN 或 ISR 缓存了）。</p>
<p>为了解决这个问题，你不得不小心翼翼地在每一个 <code>fetch</code> 里加 <code>{ cache: 'no-store' }</code>，或者去配置那个复杂的 <code>revalidatePath</code> 和 <code>revalidateTag</code>。
<strong>开发者心智负担成倍增加</strong>。你不再是在写业务逻辑，而是在跟框架的缓存机制博弈。你感觉自己不是在写前端，而是在配置复杂的 CDN 规则。</p>
<h2 data-id="heading-2">03. RSC：杀鸡焉用牛刀？</h2>
<p>React Server Components (RSC) 无疑是一个技术上的创新。
<strong>但它解决了谁的问题？</strong></p>
<p>它解决的是像 Facebook 这样拥有亿级用户、极致追求首屏毫秒级加载、且交互极其复杂的应用的问题。
但对于 99% 的普通应用（企业官网、SaaS 后台、个人博客、内部工具），<strong>引入 RSC 带来的复杂度成本，远远超过了它节省的那几 KB 传输体积。</strong></p>
<p>这就好比：<strong>你要去楼下便利店买瓶水，Next.js 给你派了一辆F1赛车。</strong>
很快，是很酷。但你需要一支专业的维修团队来维护这辆车，你需要考赛车驾照，而且这辆车还没有倒挡。</p>
<p>对于大多数应用来说，传统的 SPA（单页应用）或者简单的 SSR（服务端渲染）已经足够好用了。为了追求那理论上的“极致性能”，牺牲了原本流畅的开发体验（DX），这笔账真的划算吗？</p>
<h2 data-id="heading-3">04. 商业模式与技术导向的冲突</h2>
<p>我们不得不审视 Next.js 背后的推手 Vercel 的商业模式。
作为一个商业公司，Vercel 的核心收入来源于<strong>计算资源的售卖</strong>。</p>
<p>如果大家都写 SPA（单页应用），构建出来就是一堆静态 HTML/JS/CSS。这种静态文件，托管成本极低，甚至可以在很多平台上免费托管。
<strong>这对云厂商来说，不仅利润微薄，而且缺乏粘性。</strong></p>
<p>但如果你用了 App Router，用了 Server Actions，用了 RSC。
你的每一次页面访问，每一个交互，都在<strong>消耗服务器算力</strong>。这意味着你需要 Serverless Function，需要 Edge Middleware。
而这些，正是 Vercel 这种平台的核心收费点。</p>
<p><strong>Next.js 正在潜移默化地把简单的前端逻辑“后端化”。</strong>
它诱导开发者把能在浏览器里跑的代码（客户端免费算力），挪到服务器上跑（付费算力）。这在技术上或许说是“为了性能”，但在商业上，这无疑是一场精妙的布局。</p>
<h2 data-id="heading-4">05. 结语：回归简单的力量</h2>
<p>现在的 Next.js，已经不再是一个单纯的 UI 框架了。它庞大得像个操作系统。
它有自己的编译器（Turbopack），有自己的缓存层，有自己的路由逻辑，甚至想通过 Server Actions 接管你的数据库访问。</p>
<p>如果你感到了疲惫，如果你发现写代码的时间里，有 80% 在处理 Hydration Error、Waterfall Request 和 Cold Start。
那么，是时候回头看看了。</p>
<p><strong>Vite + React Router</strong> 依然香得一塌糊涂，简单纯粹。
<strong>HTMX + Go/Python/Rust</strong> 正在回归 HTML 的本源。
甚至 <strong>SvelteKit</strong> 和 <strong>Astro</strong>，都比现在的 Next.js 更像“为人服务的工具”。</p>
<p>技术本该让开发更简单，而不是更让人头秃。
<strong>简单，才是最高的“鲁棒性”。</strong></p>
<hr/>
<p><em>你被 Next.js 的报错折磨过吗？欢迎在评论区分享你的踩坑经历！</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Unity UI事件的拓展与应用]]></title>    <link>https://juejin.cn/post/7598024433912315958</link>    <guid>https://juejin.cn/post/7598024433912315958</guid>    <pubDate>2026-01-23T02:59:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598024433912315958" data-draft-id="7597905961664020486" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Unity UI事件的拓展与应用"/> <meta itemprop="keywords" content="Unity3D,前端,架构"/> <meta itemprop="datePublished" content="2026-01-23T02:59:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="跟着群主去吃肉"/> <meta itemprop="url" content="https://juejin.cn/user/224735056369213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Unity UI事件的拓展与应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224735056369213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    跟着群主去吃肉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T02:59:25.000Z" title="Fri Jan 23 2026 02:59:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>       Unity本身的UI事件监听机制没办法传递额外的数据，而我们在游戏实际开发中经常需要传递事件的业务数据，以方便业务功能的开发。例如，我们点击一个按钮，如果这个按钮的点击事件中能传递我们的自定义数据，例如枚举，那岂不是更加有效的提高开发效率和代码的可读性。下面我们来对Unity UI事件进行一个扩展，以实现这个功能。</p>
<h3 data-id="heading-1">一、UI事件数据的设计</h3>
<p>       Unity 原本也提供了UI事件的数据结构传递，但它不满足我们的需求。我们需要在不改变它原有的传递结构上加上我们的自定义数据。我们可以定义一个类，如UIEventData。这个类有我们自定义的数据结构，它也把原本的事件数据包含进来，响应事件时传递这个类就行。这个类的代码如下：</p>
<p>UIEventData.cs</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> UnityEngine;
<span class="hljs-keyword">using</span> UnityEngine.UI;
<span class="hljs-keyword">using</span> UnityEngine.EventSystems;
<span class="hljs-keyword">using</span> System.Collections;
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Simple.UI</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UIEventData</span>
    {
        <span class="hljs-keyword">public</span> PointerEventData PointerData;
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">object</span> OtherData;
        
    }
}
</code></pre>
<h3 data-id="heading-2">二、UI事件监听器的设计</h3>
<p>       Unity 原本提供了各种UI事件的监听，例如OnPointerDown、OnPointerUp等。核心思想是，我们不需要改变它们的监听逻辑，只需要在它的监听逻辑之后加入我们的自定义数据，然后向上传递事件即可。要实现这个功能，我们可以定义一个UIListener，它继承自EventTrigger，代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">using System<span class="hljs-comment">;</span>
using UnityEngine<span class="hljs-comment">;</span>
using UnityEngine.EventSystems<span class="hljs-comment">;</span>
using System.Collections.Generic<span class="hljs-comment">;</span>
using UnityEngine.UI<span class="hljs-comment">;</span>

namespace Simple.UI
{    
    /// &lt;summary&gt;
    /// UI事件监听器
    /// &lt;/summary&gt;
    public class UIListener : EventTrigger
    {
        public UIEventData EventData { private set<span class="hljs-comment">; get; }//我们自定义的事件数据</span>
        public Action&lt;UIEventData&gt; OnClickDown<span class="hljs-comment">;//自定义上向上传递的事件</span>
        public Action&lt;UIEventData&gt; OnClickUp<span class="hljs-comment">;</span>
        public Action&lt;UIEventData&gt; OnClick<span class="hljs-comment">;</span>
        public Action&lt;UIEventData&gt; OnStartDrag<span class="hljs-comment">;</span>
        public Action&lt;UIEventData&gt; OnOverDrag<span class="hljs-comment">;</span>
        public Action&lt;UIEventData&gt; OnDraging<span class="hljs-comment">;</span>
        public Action&lt;UIEventData&gt; OnDroping<span class="hljs-comment">;</span>
        private bool <span class="hljs-attr">_interactable</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;//是否可交互        </span>

        //go为ui对象，如button\image等，eventData为安需要自定义的外部数据
        public static UIListener Get(GameObject go, object eventData)
        {
            UIListener <span class="hljs-attr">listener</span> = go.GetComponent&lt;UIListener&gt;()<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">listener</span> == null)
                <span class="hljs-attr">listener</span> = go.AddComponent&lt;UIListener&gt;()<span class="hljs-comment">;//加入监听器</span>
            <span class="hljs-attr">listener.EventData</span> = new UIEventData()<span class="hljs-comment">;</span>
            <span class="hljs-attr">listener.EventData.OtherData</span> = eventData<span class="hljs-comment">;//保存自定义数据</span>
            return listener<span class="hljs-comment">;</span>
        }

        public static UIListener Get(Transform t, object eventData)
        {
            return Get(t.gameObject, eventData)<span class="hljs-comment">;</span>
        }

        public static UIListener Get(Component c, object eventData)
        {
            return Get(c.gameObject, eventData)<span class="hljs-comment">;</span>
        }
        /// &lt;summary&gt;
        /// 设置是否可以交互
        /// &lt;/summary&gt;
        /// &lt;param <span class="hljs-attr">name</span>=<span class="hljs-string">"interactable"</span>&gt;&lt;/param&gt;
        public void SetInteractable(bool interactable)
        {
            <span class="hljs-attr">_interactable</span> = interactable<span class="hljs-comment">;</span>
        }



        void OnDestroy()
        {
            <span class="hljs-attr">OnClickDown</span> = null<span class="hljs-comment">;</span>
            <span class="hljs-attr">OnClickUp</span> = null<span class="hljs-comment">;</span>
            <span class="hljs-attr">OnClick</span> = null<span class="hljs-comment">;</span>
            <span class="hljs-attr">OnStartDrag</span> = null<span class="hljs-comment">;</span>
            <span class="hljs-attr">OnOverDrag</span> = null<span class="hljs-comment">;</span>
            <span class="hljs-attr">OnDraging</span> = null<span class="hljs-comment">;</span>
            <span class="hljs-attr">OnDroping</span> = null<span class="hljs-comment">;</span>
            triggers.Clear()<span class="hljs-comment">;</span>
        }
        //重写事件传递逻辑
        public override void OnPointerDown(PointerEventData eventData)
        {
            if (!_interactable)
                return<span class="hljs-comment">;</span>

            base.OnPointerDown(eventData)<span class="hljs-comment">;</span>
            <span class="hljs-attr">EventData.PointerData</span> = eventData<span class="hljs-comment">;//保存unity的事件数据</span>
            OnClickDown?.Invoke(EventData)<span class="hljs-comment">;//向上传递事件         </span>
            
        }
        
        public override void OnPointerUp(PointerEventData eventData)
        {
            if(!_interactable) return<span class="hljs-comment">;</span>

            base.OnPointerUp(eventData)<span class="hljs-comment">;</span>
            <span class="hljs-attr">EventData.PointerData</span> = eventData<span class="hljs-comment">;</span>
            OnClickUp?.Invoke(EventData)<span class="hljs-comment">;            </span>
        }
        
        public override void OnPointerClick(PointerEventData eventData)
        {
            if (!_interactable) return<span class="hljs-comment">;</span>

            base.OnPointerClick(eventData)<span class="hljs-comment">;</span>
            <span class="hljs-attr">EventData.PointerData</span> = eventData<span class="hljs-comment">;</span>
            OnClick?.Invoke(EventData)<span class="hljs-comment">;</span>
        }
        
        public override void OnBeginDrag(PointerEventData eventData)
        {
            if (!_interactable) return<span class="hljs-comment">;</span>

            base.OnBeginDrag(eventData)<span class="hljs-comment">;</span>
            <span class="hljs-attr">EventData.PointerData</span> = eventData<span class="hljs-comment">;</span>
            OnStartDrag?.Invoke(EventData)<span class="hljs-comment">;</span>

            _clickDownCount++<span class="hljs-comment">;</span>
        }
        
        public override void OnEndDrag(PointerEventData eventData)
        {
            if (!_interactable) return<span class="hljs-comment">;</span>

            base.OnEndDrag(eventData)<span class="hljs-comment">;</span>
            <span class="hljs-attr">EventData.PointerData</span> = eventData<span class="hljs-comment">;</span>
            OnOverDrag?.Invoke(EventData)<span class="hljs-comment">;         </span>
        }
        
        public override void OnDrag(PointerEventData eventData)
        {
            if (!_interactable) return<span class="hljs-comment">;</span>

            base.OnDrag(eventData)<span class="hljs-comment">;</span>
            <span class="hljs-attr">EventData.PointerData</span> = eventData<span class="hljs-comment">;</span>
            OnDraging?.Invoke(EventData)<span class="hljs-comment">;</span>
        }
        
        //public override void OnDrop(PointerEventData eventData)
        //{
        //    base.OnDrop(eventData)<span class="hljs-comment">;</span>
        //    <span class="hljs-attr">EventData.PointerData</span> = eventData<span class="hljs-comment">;</span>
        //    OnDraging?.Invoke(EventData)<span class="hljs-comment">;</span>
        //}
    }
}
</code></pre>
<h3 data-id="heading-3">三、监听器的应用</h3>
<p>       我们以一个切换游戏语言的例子来说明拓展后的事件监听器如何应用。首先我们定义一个语言枚举，如下所示：</p>
<pre><code class="hljs language-ini" lang="ini">public enum LangTypeEnum
{
    <span class="hljs-attr">none</span> = <span class="hljs-number">0</span>,
    <span class="hljs-attr">English</span> = <span class="hljs-number">1</span>,
    <span class="hljs-attr">ChineseSimplified</span> = <span class="hljs-number">2</span>,
    <span class="hljs-attr">ChineseTraditional</span> = <span class="hljs-number">3</span>,
    <span class="hljs-attr">French</span> = <span class="hljs-number">4</span>,
    <span class="hljs-attr">German</span> = <span class="hljs-number">5</span>,
    <span class="hljs-attr">Italian</span> = <span class="hljs-number">6</span>,
    <span class="hljs-attr">Japanese</span> = <span class="hljs-number">7</span>,
    <span class="hljs-attr">Dutch</span> = <span class="hljs-number">8</span>,
    <span class="hljs-attr">Spanish</span> = <span class="hljs-number">9</span>,
    <span class="hljs-attr">Portuguese</span> = <span class="hljs-number">10</span>,
    <span class="hljs-attr">Hebrew</span> = <span class="hljs-number">11</span>,
    <span class="hljs-attr">Russia</span> = <span class="hljs-number">12</span>,
    <span class="hljs-attr">Danish</span> = <span class="hljs-number">13</span>,
    <span class="hljs-attr">Norwegian</span> = <span class="hljs-number">14</span>,
    <span class="hljs-attr">Finnish</span> = <span class="hljs-number">15</span>,
    <span class="hljs-attr">Swedish</span> = <span class="hljs-number">16</span>,
    <span class="hljs-attr">Hindi</span> = <span class="hljs-number">17</span>,
    <span class="hljs-attr">Bengali</span> = <span class="hljs-number">18</span>,
    <span class="hljs-attr">Turkish</span> = <span class="hljs-number">19</span>,
    <span class="hljs-attr">Indonesian</span> = <span class="hljs-number">20</span>,
    <span class="hljs-attr">Filipino</span> = <span class="hljs-number">21</span>,
    <span class="hljs-attr">Thai</span> = <span class="hljs-number">22</span>,
    <span class="hljs-attr">Malay</span> = <span class="hljs-number">23</span>,
    <span class="hljs-attr">Arabic</span> = <span class="hljs-number">24</span>,
    <span class="hljs-attr">Vietnamese</span> = <span class="hljs-number">25</span>,
    <span class="hljs-attr">Ukrainian</span> = <span class="hljs-number">26</span>,
    <span class="hljs-attr">Korean</span> = <span class="hljs-number">27</span>,
    <span class="hljs-attr">Czech</span> = <span class="hljs-number">28</span>,
    <span class="hljs-attr">Polish</span> = <span class="hljs-number">29</span>,
    <span class="hljs-attr">Slovak</span> = <span class="hljs-number">30</span>,
    <span class="hljs-attr">Slovenian</span> = <span class="hljs-number">31</span>,
    <span class="hljs-attr">Hungarian</span> = <span class="hljs-number">32</span>,
    <span class="hljs-attr">Romanian</span> = <span class="hljs-number">33</span>,
    <span class="hljs-attr">Greek</span> = <span class="hljs-number">34</span>,
    <span class="hljs-attr">Croatian</span> = <span class="hljs-number">35</span>,
    <span class="hljs-attr">Bulgarian</span> = <span class="hljs-number">36</span>,

}
</code></pre>
<p>       然后我们在游戏的语言设置界面上，当点击对应的语言按钮时传入相关的语言枚举，以实现游戏语言的切换，代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">using System.Collections<span class="hljs-comment">;</span>
using System.Collections.Generic<span class="hljs-comment">;</span>
using UnityEngine<span class="hljs-comment">;</span>
using UnityEngine.UI<span class="hljs-comment">;</span>
using Simple.UI<span class="hljs-comment">;</span>
using System<span class="hljs-comment">;</span>

namespace Gamelogic
{

    /// &lt;summary&gt;
    /// 设置界面绑定
    /// &lt;/summary&gt;
    public class UIStageSettingsBinder : MonoBehaviour
    {
      
        private LangTypeEnum <span class="hljs-attr">_curLang</span> = LangTypeEnum.English<span class="hljs-comment">;    </span>
        private void Awake()
        {                    
            LoadLangItem()<span class="hljs-comment">;      </span>
        }

        private void OnDestroy()
        {

        }
        private void LoadLangItem()
        {   
            var <span class="hljs-attr">ems</span> = Enum.GetNames(typeof(LangTypeEnum))<span class="hljs-comment">;</span>
            //通过枚举实例化语言按键
            foreach (var e in ems)
            {
                var <span class="hljs-attr">em</span> = Enum.Parse&lt;LangTypeEnum&gt;(e)<span class="hljs-comment">;</span>
                if (<span class="hljs-attr">em</span> == LangTypeEnum.none)
                    continue<span class="hljs-comment">;</span>
                var <span class="hljs-attr">item</span> = Pool.SpawnOut(ResConfig.Pre_UI_LangItem, <span class="hljs-literal">true</span>, <span class="hljs-number">0</span>)<span class="hljs-comment">;//语言按钮prefab</span>
                item.SetParent(_langItemParent)<span class="hljs-comment">;                </span>
                var <span class="hljs-attr">igo</span> = item.ActiveTransform<span class="hljs-comment">;</span>
                <span class="hljs-attr">igo.localScale</span> = Vector3.<span class="hljs-literal">on</span>e<span class="hljs-comment">;</span>
                <span class="hljs-attr">igo.localPosition</span> = Vector3.zero<span class="hljs-comment">;</span>

                UIListener.Get(igo, em).<span class="hljs-attr">OnClick</span> = <span class="hljs-literal">On</span>SelectedClick<span class="hljs-comment">;//绑定事件和自定义数据</span>
                UIListener.Get(igo, em).<span class="hljs-attr">OnStartDrag</span> = <span class="hljs-literal">On</span>StartDrag<span class="hljs-comment">;</span>
                UIListener.Get(igo, em).<span class="hljs-attr">OnDraging</span> = <span class="hljs-literal">On</span>Draging<span class="hljs-comment">;</span>
                UIListener.Get(igo, em).<span class="hljs-attr">OnOverDrag</span> = <span class="hljs-literal">On</span>OverDrag<span class="hljs-comment">;</span>
                var <span class="hljs-attr">binder</span> = igo.GetComponent&lt;UIStageLangItemBinder&gt;()<span class="hljs-comment">;</span>
                binder.SetName(e)<span class="hljs-comment">;</span>
                binder.SetIcon($"flag_{e}")<span class="hljs-comment">;</span>
            }
           
        }
       
        private void OnStartDrag(UIEventData ed)
        {
            
        }
        private void OnOverDrag(UIEventData ed)
        {
           
        }
        private void OnDraging(UIEventData ed)
        {
           
        }
        private void OnSelectedClick(UIEventData ed)
        {           
            var <span class="hljs-attr">lt</span> = (LangTypeEnum)ed.OtherData<span class="hljs-comment">;         </span>
            <span class="hljs-attr">_curLang</span> = lt<span class="hljs-comment">;</span>
          
            OnChangeClick(ed)<span class="hljs-comment">; //切换言语      </span>
        }
 
        private void OnChangeClick(UIEventData ed)
        {
         
        }
      
    }
}

</code></pre>
<h3 data-id="heading-4">四、运行效果</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd704ecf203f4224a988123144438384~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Lef552A576k5Li75Y675ZCD6IKJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769741964&amp;x-signature=pJDRh6FcYhrYw9LJ9Xie4IbtS%2BY%3D" alt="" loading="lazy"/></p>
<p>       界面内的每个按钮对应着一个语言枚举，只要我们按下按钮，就可以把枚举值传递到相关业务层，对编码的友好度和效率的提升还是比较明显的。</p>
<h3 data-id="heading-5"/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app APP打开手机外面的google地图APP]]></title>    <link>https://juejin.cn/post/7598103558886391854</link>    <guid>https://juejin.cn/post/7598103558886391854</guid>    <pubDate>2026-01-23T03:20:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598103558886391854" data-draft-id="7598104596779401262" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app APP打开手机外面的google地图APP"/> <meta itemprop="keywords" content="前端,uni-app,Android"/> <meta itemprop="datePublished" content="2026-01-23T03:20:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sosojie"/> <meta itemprop="url" content="https://juejin.cn/user/571401775880936"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app APP打开手机外面的google地图APP
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/571401775880936/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sosojie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:20:06.000Z" title="Fri Jan 23 2026 03:20:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>记录一下，在开发APP功能唤醒APP外部的google地图APP，并且把数据回显上去，包括了安卓和ios写法</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">getApp</span>()

<span class="hljs-comment">/**
 * 打开谷歌地图
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} latitude // 纬度
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} longitude // 经度
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} address // 详细地址
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">openGoogleMap</span> = (<span class="hljs-params">latitude, longitude, address</span>) =&gt; {
  <span class="hljs-keyword">if</span> (plus.<span class="hljs-property">os</span>.<span class="hljs-property">name</span> === <span class="hljs-string">'Android'</span>) {
    <span class="hljs-keyword">let</span> url = <span class="hljs-string">`google.navigation:q=<span class="hljs-subst">${latitude}</span>,<span class="hljs-subst">${longitude}</span>&amp;zoom=15`</span>

    plus.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">openURL</span>(url, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🚀 ~ Android plus.runtime.openURL ~ err:"</span>, err)
      uni.<span class="hljs-title function_">showModal</span>({
        <span class="hljs-attr">title</span>: app.<span class="hljs-property">globalData</span>.$lang(<span class="hljs-string">'common.Tips'</span>),
        <span class="hljs-attr">content</span>: app.<span class="hljs-property">globalData</span>.$lang(<span class="hljs-string">'common.setupGoogleMap'</span>),
        <span class="hljs-attr">confirmText</span>: app.<span class="hljs-property">globalData</span>.$lang(<span class="hljs-string">'common.setupBtnText'</span>),
        <span class="hljs-attr">cancelText</span>: app.<span class="hljs-property">globalData</span>.$lang(<span class="hljs-string">'common.cancelBtnText'</span>),
        <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (res.<span class="hljs-property">confirm</span>) {
            plus.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">openURL</span>(<span class="hljs-string">'market://details?id=com.google.android.apps.maps'</span>);
          }
        }
      });
    });
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// iOS</span>
    <span class="hljs-keyword">let</span> url = <span class="hljs-string">`comgooglemaps://?q=<span class="hljs-subst">${latitude}</span>,<span class="hljs-subst">${longitude}</span>(<span class="hljs-subst">${address}</span>)&amp;zoom=15&amp;directionsmode=driving`</span>

    plus.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">launchApplication</span>({ <span class="hljs-attr">action</span>: url }, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"🚀 ~ IOS plus.runtime.launchApplication ~ err:"</span>, err)
      uni.<span class="hljs-title function_">showModal</span>({
        <span class="hljs-attr">title</span>: app.<span class="hljs-property">globalData</span>.$lang(<span class="hljs-string">'common.Tips'</span>),
        <span class="hljs-attr">content</span>: app.<span class="hljs-property">globalData</span>.$lang(<span class="hljs-string">'common.setupGoogleMap'</span>),
        <span class="hljs-attr">confirmText</span>: app.<span class="hljs-property">globalData</span>.$lang(<span class="hljs-string">'common.setupBtnText'</span>),
        <span class="hljs-attr">cancelText</span>: app.<span class="hljs-property">globalData</span>.$lang(<span class="hljs-string">'common.cancelBtnText'</span>),
        <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (res.<span class="hljs-property">confirm</span>) {
            plus.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">openURL</span>(<span class="hljs-string">`itms-apps://itunes.apple.com/app/id585027354`</span>);
          }
        }
      });
    });
  }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[由img 标签跨域问题，而引出的浏览器跨域原理]]></title>    <link>https://juejin.cn/post/7598104572583657522</link>    <guid>https://juejin.cn/post/7598104572583657522</guid>    <pubDate>2026-01-23T03:21:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598104572583657522" data-draft-id="7598130716338962470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="由img 标签跨域问题，而引出的浏览器跨域原理"/> <meta itemprop="keywords" content="前端,浏览器"/> <meta itemprop="datePublished" content="2026-01-23T03:21:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hmfy"/> <meta itemprop="url" content="https://juejin.cn/user/3562073405260925"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            由img 标签跨域问题，而引出的浏览器跨域原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3562073405260925/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hmfy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:21:46.000Z" title="Fri Jan 23 2026 03:21:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>User:</strong></p>
<blockquote>
<p>img 标签为什么不会跨域呢，本质上也是 get 请求，而只要是从浏览器发请求，只要是协议域名端口不同不是就会跨域吗</p>
</blockquote>
<p><strong>GitHub Copilot:</strong></p>
<p>img 标签（以及 <code>&lt;script&gt;</code>、<code>&lt;link&gt;</code> 等资源标签）确实可以发起跨域 GET 请求并加载资源（如图片），而不会触发浏览器的跨域限制（CORS 错误）。这与你提到的“协议、域名、端口不同就会跨域”并不完全一致，因为跨域限制并非对所有浏览器请求都适用，而是有特定规则。让我解释一下本质原因：</p>
<h3 data-id="heading-0">1. <strong>跨域限制的本质</strong></h3>
<ul>
<li>跨域（Cross-Origin Resource Sharing, CORS）是浏览器的一种安全机制，旨在防止恶意网站窃取用户数据。它主要针对 <strong>能读取响应内容的请求</strong>，尤其是通过 JavaScript 发起的请求（如 XMLHttpRequest 或 fetch）。</li>
<li>如果请求的协议、域名或端口不同，浏览器会检查服务器是否返回了允许跨域的 HTTP 头（如 <code>Access-Control-Allow-Origin</code>）。如果没有，请求会被阻塞。</li>
<li>但并非所有请求都会触发 CORS 检查。img 标签的请求是 GET，但它属于“简单请求”（simple request），并且浏览器对资源标签的处理方式不同。</li>
</ul>
<h3 data-id="heading-1">2. <strong>为什么 img 标签不会跨域？</strong></h3>
<ul>
<li><strong>img 标签不执行脚本，也不允许 JavaScript 直接读取响应内容</strong>：
<ul>
<li>img 标签只是告诉浏览器加载并显示图片。它不会执行任何代码，也不会让 JavaScript 访问图片的像素数据（除非通过 Canvas API，但那需要服务器允许 CORS）。</li>
<li>浏览器认为这种请求是“安全的”，因为它不会泄露敏感信息。即使图片来自不同域，浏览器也会加载它（前提是服务器允许公开访问）。</li>
</ul>
</li>
<li><strong>历史原因和浏览器设计</strong>：
<ul>
<li>早期 Web 设计中，img、script 等标签就被允许跨域加载资源，以支持网页嵌入外部内容（如广告图片或 CDN 资源）。</li>
<li>相比之下，AJAX 请求（通过 XMLHttpRequest 或 fetch）可以读取响应体（JSON、XML 等），这可能包含敏感数据，所以浏览器强制 CORS 检查。</li>
</ul>
</li>
<li><strong>简单请求的例外</strong>：
<ul>
<li>img 的 GET 请求属于“简单请求”（simple request），它不预检（preflight），浏览器直接发送请求。如果服务器返回图片数据，浏览器就显示它。</li>
<li>如果服务器设置了 CORS 头（如 <code>Access-Control-Allow-Origin: *</code>），img 标签也可以正常工作，但通常不需要，因为它不读取内容。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">3. <strong>对比其他 GET 请求</strong></h3>
<ul>
<li><strong>通过 fetch 或 XMLHttpRequest 的 GET 请求</strong>：如果跨域，会触发 CORS 检查，必须有服务器的允许头，否则报错（如 <code>Access to XMLHttpRequest at 'https://example.com/image.jpg' from origin 'https://yourdomain.com' has been blocked by CORS policy</code>）。</li>
<li><strong>通过表单提交或链接跳转的 GET 请求</strong>：这些也不触发 CORS，因为它们是导航请求，不是 AJAX。</li>
<li><strong>img 标签的 GET 请求</strong>：浏览器允许它跨域，因为它不涉及数据读取。</li>
</ul>
<h3 data-id="heading-3">4. <strong>潜在风险和限制</strong></h3>
<ul>
<li>虽然 img 可以跨域加载，但如果图片服务器禁止访问（HTTP 403），或图片是私有的，浏览器仍会失败。</li>
<li>如果你想在 JavaScript 中读取图片数据（例如通过 Canvas），仍然需要 CORS 头，因为那涉及跨域数据访问。</li>
<li>对于现代 Web，推荐服务器配置 CORS 以控制访问。</li>
</ul>
<p><strong>User:</strong></p>
<blockquote>
<p>那请总结一下哪些情况下会跨域，哪些常见情况不会，并说明原因，另外你提到 preflight 请详细说一下</p>
</blockquote>
<p><strong>GitHub Copilot:</strong></p>
<h3 data-id="heading-4">哪些情况下会跨域（触发 CORS 检查）</h3>
<p>跨域（CORS）限制主要针对浏览器发起的请求，如果请求涉及跨域（协议、域名或端口不同）且可能读取响应内容，浏览器会强制检查服务器的 CORS 头（如 <code>Access-Control-Allow-Origin</code>）。如果服务器不允许，请求会被阻塞。以下是常见会触发跨域的情况：</p>
<ol>
<li>
<p><strong>AJAX 请求（XMLHttpRequest 或 fetch）</strong>：</p>
<ul>
<li><strong>原因</strong>：这些请求允许 JavaScript 读取响应体（JSON、XML 等），可能泄露敏感数据。浏览器强制 CORS 检查以保护用户隐私和安全。</li>
<li><strong>示例</strong>：从 <code>https://yourdomain.com</code> 用 fetch 请求 <code>https://api.example.com/data</code>。如果服务器没设置允许头，会报 CORS 错误。</li>
<li><strong>条件</strong>：请求方法不是简单请求（见下文），或包含自定义头、特定 Content-Type 等。</li>
</ul>
</li>
<li>
<p><strong>复杂请求（Non-Simple Requests）</strong>：</p>
<ul>
<li><strong>原因</strong>：这些请求可能修改服务器状态或发送复杂数据，浏览器需要预先确认权限。</li>
<li><strong>示例</strong>：使用 PUT、DELETE 等方法，或设置自定义头（如 <code>Authorization</code>）。</li>
</ul>
</li>
<li>
<p><strong>WebSocket 连接</strong>：</p>
<ul>
<li><strong>原因</strong>：WebSocket 允许双向通信，浏览器检查是否允许跨域握手。</li>
<li><strong>示例</strong>：从不同域发起 WebSocket 连接，如果服务器不支持，会失败。</li>
</ul>
</li>
<li>
<p><strong>通过 Canvas 或其他 API 读取跨域资源数据</strong>：</p>
<ul>
<li><strong>原因</strong>：即使 img 标签加载了图片，如果 JavaScript 试图通过 Canvas API 读取像素数据，仍需 CORS 头。</li>
<li><strong>示例</strong>：<code>canvas.getImageData()</code> 从跨域 img 读取数据，会报错，除非服务器允许。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-5">哪些常见情况不会跨域</h3>
<p>以下情况不会触发 CORS 检查，因为它们不涉及读取敏感响应内容，或是浏览器历史兼容性设计：</p>
<ol>
<li>
<p><strong>资源标签（img、script、link、iframe 等）</strong>：</p>
<ul>
<li><strong>原因</strong>：这些标签只是加载资源（如图片、脚本、样式），不执行代码或读取数据。浏览器允许跨域加载以支持网页嵌入外部内容（如 CDN 图片）。JavaScript 无法直接访问响应内容。</li>
<li><strong>示例</strong>：<code>&lt;img src="https://cdn.example.com/image.jpg"&gt;</code> 可以正常加载，即使跨域。</li>
</ul>
</li>
<li>
<p><strong>表单提交（GET/POST）</strong>：</p>
<ul>
<li><strong>原因</strong>：表单提交是导航请求（页面跳转），不涉及 JavaScript 读取响应。浏览器不检查 CORS，因为它是用户主动行为。</li>
<li><strong>示例</strong>：<code>&lt;form action="https://api.example.com/submit" method="post"&gt;</code> 提交到不同域，不会跨域。</li>
</ul>
</li>
<li>
<p><strong>链接跳转（a 标签）</strong>：</p>
<ul>
<li><strong>原因</strong>：类似表单，是导航行为，不读取数据。</li>
<li><strong>示例</strong>：<code>&lt;a href="https://example.com"&gt;</code> 跳转到不同域。</li>
</ul>
</li>
<li>
<p><strong>同域请求</strong>：</p>
<ul>
<li><strong>原因</strong>：协议、域名、端口相同，无需检查。</li>
<li><strong>示例</strong>：从 <code>https://yourdomain.com</code> 请求 <code>https://yourdomain.com/api</code>。</li>
</ul>
</li>
<li>
<p><strong>嵌入式资源（如字体、视频）</strong>：</p>
<ul>
<li><strong>原因</strong>：类似 img，浏览器允许加载，但如果需要读取（如通过 FontFace API），可能需 CORS。</li>
<li><strong>示例</strong>：<code>&lt;video src="https://cdn.example.com/video.mp4"&gt;</code>。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-6">详细说明 Preflight（预检请求）</h3>
<p>Preflight 是 CORS 机制的一部分，用于处理“复杂请求”（non-simple requests）。浏览器在发送实际请求前，先发送一个预检请求来确认服务器是否允许该跨域操作。</p>
<h4 data-id="heading-7"><strong>为什么需要 Preflight？</strong></h4>
<ul>
<li>简单请求（simple requests）直接发送，无需预检。</li>
<li>复杂请求可能有副作用（如修改数据），浏览器需要先“询问”服务器，避免意外操作。</li>
</ul>
<h4 data-id="heading-8"><strong>Preflight 的过程</strong>：</h4>
<ol>
<li>
<p><strong>触发条件</strong>：请求不是简单请求时，浏览器自动发送 OPTIONS 请求（预检）。</p>
<ul>
<li><strong>简单请求的标准</strong>（无需预检）：
<ul>
<li>方法：GET、HEAD、POST。</li>
<li>头：只允许简单头（如 Accept、Accept-Language、Content-Language）。</li>
<li>Content-Type：只允许 <code>application/x-www-form-urlencoded</code>、<code>multipart/form-data</code>、<code>text/plain</code>。</li>
<li>无自定义头、无凭据（credentials）。</li>
</ul>
</li>
<li><strong>复杂请求的示例</strong>：使用 PUT 方法、设置 <code>Authorization</code> 头，或 Content-Type 为 <code>application/json</code>。</li>
</ul>
</li>
<li>
<p><strong>预检请求详情</strong>：</p>
<ul>
<li><strong>方法</strong>：OPTIONS。</li>
<li><strong>头</strong>：包括 <code>Origin</code>（请求来源）、<code>Access-Control-Request-Method</code>（实际请求方法）、<code>Access-Control-Request-Headers</code>（自定义头）。</li>
<li><strong>示例</strong>：
<pre><code class="hljs language-makefile" lang="makefile">OPTIONS /api/data HTTP/1.1
<span class="hljs-section">Host: api.example.com</span>
<span class="hljs-section">Origin: https://yourdomain.com</span>
<span class="hljs-section">Access-Control-Request-Method: PUT</span>
<span class="hljs-section">Access-Control-Request-Headers: Authorization, Content-Type</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>服务器响应</strong>：</p>
<ul>
<li>必须返回允许头，如：
<ul>
<li><code>Access-Control-Allow-Origin: https://yourdomain.com</code> 或 <code>*</code>。</li>
<li><code>Access-Control-Allow-Methods: PUT, GET</code>。</li>
<li><code>Access-Control-Allow-Headers: Authorization, Content-Type</code>。</li>
<li><code>Access-Control-Max-Age: 86400</code>（缓存预检结果，单位秒）。</li>
</ul>
</li>
<li>如果服务器拒绝，实际请求不会发送。</li>
</ul>
</li>
<li>
<p><strong>实际请求</strong>：</p>
<ul>
<li>如果预检通过，浏览器发送实际请求，并检查响应头。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-9"><strong>注意</strong>：</h4>
<ul>
<li>Preflight 只针对复杂请求，简单请求跳过。</li>
<li>预检失败不会影响页面加载，但会阻止 AJAX 请求。</li>
<li>服务器（如 Node.js/Express）需配置中间件处理 OPTIONS 请求。</li>
</ul>
<p>如果你的项目涉及 CORS 配置（如在 Vue.js 中），可以分享代码，我可以帮你优化！3. <strong>服务器响应</strong>：</p>
<ul>
<li>必须返回允许头，如：
<ul>
<li><code>Access-Control-Allow-Origin: https://yourdomain.com</code> 或 <code>*</code>。</li>
<li><code>Access-Control-Allow-Methods: PUT, GET</code>。</li>
<li><code>Access-Control-Allow-Headers: Authorization, Content-Type</code>。</li>
<li><code>Access-Control-Max-Age: 86400</code>（缓存预检结果，单位秒）。</li>
</ul>
</li>
<li>如果服务器拒绝，实际请求不会发送。</li>
</ul>
<ol start="4">
<li><strong>实际请求</strong>：
<ul>
<li>如果预检通过，浏览器发送实际请求，并检查响应头。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-10"><strong>注意</strong>：</h4>
<ul>
<li>Preflight 只针对复杂请求，简单请求跳过。</li>
<li>预检失败不会影响页面加载，但会阻止 AJAX 请求。</li>
<li>服务器（如 Node.js/Express）需配置中间件处理 OPTIONS 请求。</li>
</ul>
<p><strong>User:</strong></p>
<blockquote>
<p>你提到 submit 是 用户主动行为 ，那如果通过定时脚本去触发带有 submit 按钮的点击事件呢。</p>
</blockquote>
<p><strong>GitHub Copilot:</strong></p>
<h3 data-id="heading-11">脚本触发表单提交的跨域行为</h3>
<p>如果你通过定时脚本（例如 JavaScript 的 <code>setTimeout</code> 或 <code>setInterval</code>）去触发带有 submit 按钮的点击事件（如 <code>document.getElementById('submitBtn').click()</code>），<strong>它仍然不会触发跨域检查</strong>。原因如下：</p>
<h4 data-id="heading-12"><strong>原因分析</strong></h4>
<ul>
<li><strong>表单提交的本质</strong>：无论手动点击还是脚本触发，表单提交都是“导航请求”（navigation request），浏览器将其视为用户发起的页面跳转或数据发送行为。它不涉及 JavaScript 读取响应内容（response body），所以浏览器不强制 CORS 检查。
<ul>
<li>脚本触发只是模拟用户行为，不会改变请求类型。浏览器允许这种自动化，因为它不泄露数据。</li>
</ul>
</li>
<li><strong>对比 AJAX 请求</strong>：如果脚本用 <code>fetch</code> 或 <code>XMLHttpRequest</code> 来发送表单数据（即使是 POST），那就是 AJAX 请求，会触发 CORS 检查。因为它允许 JavaScript 处理响应。</li>
<li><strong>历史和安全设计</strong>：早期 Web 设计中，表单提交就被允许跨域，以支持多站点交互（如登录表单）。脚本触发被视为扩展的用户行为，不受 CORS 限制。</li>
</ul>
<h4 data-id="heading-13"><strong>示例</strong></h4>
<ul>
<li>
<p><strong>脚本触发表单</strong>（不会跨域）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'form'</span>).<span class="hljs-title function_">submit</span>();  <span class="hljs-comment">// 模拟提交到 https://api.example.com/submit</span>
}, <span class="hljs-number">1000</span>);
</code></pre>
<ul>
<li>浏览器会发送请求并跳转页面，无 CORS 错误。</li>
</ul>
</li>
<li>
<p><strong>用 fetch 模拟</strong>（会跨域）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/submit'</span>, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
  <span class="hljs-attr">body</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'form'</span>))
});
</code></pre>
<ul>
<li>如果跨域且服务器无 CORS 头，会报错。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-14"><strong>潜在注意点</strong></h4>
<ul>
<li><strong>自动化检测</strong>：一些网站可能检测脚本触发（如检查事件来源），并阻止它（非 CORS 问题，而是反爬虫机制）。</li>
<li><strong>安全风险</strong>：脚本触发可能被滥用（如 CSRF 攻击），但 CORS 不直接相关。如果你担心跨域数据安全，建议服务器端验证（如 CSRF token）。</li>
<li><strong>现代浏览器</strong>：行为一致，但如果表单目标是 iframe 或新窗口，规则类似。</li>
</ul>
<p><strong>User:</strong></p>
<blockquote>
<p>意思是，如果该请求结果，前端不可控不可获取不可读，则认为没风险，允许跨域，一旦某个请求得到的结果前端可以获取可以操作，就认为不安全，就有跨域限制，我的理解准确吗</p>
</blockquote>
<p><strong>GitHub Copilot:</strong></p>
<h3 data-id="heading-15">对 CORS 理解的准确性分析</h3>
<p>你的理解<strong>大致准确</strong>，但需要一些澄清和细节补充。CORS 的核心确实是浏览器为了防止恶意脚本窃取或操作跨域数据而设计的“安全网”。关键在于：<strong>如果请求的结果（响应内容）能被前端 JavaScript 读取、操作或控制，就认为有风险，需要 CORS 检查；否则，允许跨域</strong>。以下是详细解释：</p>
<h4 data-id="heading-16"><strong>准确的部分</strong></h4>
<ul>
<li>
<p><strong>前端不可控/不可获取/不可读 → 允许跨域</strong>：</p>
<ul>
<li>这些请求不让 JavaScript 访问响应体（response body），所以浏览器认为“没风险”。例如：
<ul>
<li><strong>img、script、link 等标签</strong>：加载资源，但 JS 无法直接读取内容（script 会执行代码，但不读取数据）。允许跨域，以支持网页嵌入。</li>
<li><strong>表单提交或链接跳转</strong>：请求后页面跳转，JS 无法读取响应。允许跨域，因为它是导航行为。</li>
</ul>
</li>
<li><strong>原因</strong>：浏览器假设这些请求是“被动”的，不涉及数据泄露。</li>
</ul>
</li>
<li>
<p><strong>前端可以获取/操作结果 → 有跨域限制</strong>：</p>
<ul>
<li>AJAX 请求（fetch/XMLHttpRequest）允许 JS 读取响应（如 JSON 数据），可能泄露敏感信息。所以强制 CORS 检查：服务器必须明确允许（通过头如 <code>Access-Control-Allow-Origin</code>）。</li>
<li><strong>原因</strong>：恶意网站可能用 JS 从其他域窃取用户数据（如银行 API）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-17"><strong>需要澄清的细节和例外</strong></h4>
<ul>
<li>
<p><strong>不是绝对的“不可读”就安全</strong>：</p>
<ul>
<li>即使资源标签加载了内容，如果 JS 试图间接读取，仍可能触发 CORS。例如：
<ul>
<li>img 加载跨域图片，JS 不能直接读像素。但如果用 <code>canvas.drawImage()</code> 然后 <code>canvas.getImageData()</code> 读取像素数据，会报 CORS 错误（除非服务器允许）。</li>
<li>类似地，字体或视频资源如果 JS 通过 API（如 FontFace）操作，也需 CORS。</li>
</ul>
</li>
<li><strong>为什么？</strong>：浏览器区分“加载”和“读取”。加载允许，读取需要权限。</li>
</ul>
</li>
<li>
<p><strong>历史和设计因素</strong>：</p>
<ul>
<li>CORS 不是一开始就有的；早期 Web 允许一切跨域，后来 AJAX 普及才引入限制。资源标签因兼容性被豁免。</li>
<li><strong>简单请求 vs 复杂请求</strong>：即使是 AJAX，如果是简单请求（GET/POST，无自定义头），浏览器直接发送；复杂请求需预检（OPTIONS）。</li>
</ul>
</li>
<li>
<p><strong>其他情况</strong>：</p>
<ul>
<li><strong>同域请求</strong>：无风险，无需检查。</li>
<li><strong>WebSocket 或其他协议</strong>：类似 AJAX，需要检查。</li>
<li><strong>服务器端代理</strong>：前端请求同域服务器，后者转发跨域请求，可绕过 CORS（但不推荐滥用）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-18"><strong>总结</strong></h4>
<p>你的理解抓住了 CORS 的本质：保护数据读取。但实际规则更细致，取决于请求类型和 JS 的访问能力。如果请求允许 JS 控制或读取结果，就有风险；否则，豁免。现代 Web 推荐服务器配置 CORS 以精细控制。</p>
<p><strong>User:</strong></p>
<blockquote>
<p>GET/POST，无自定义头 就是简单请求吗，非这种情况就是复杂请求是吗，另外，如果是同域复杂请求是不是也不需要预检（因为同域不存在跨域问题），预检仅仅是为了判断是否允许跨域吗</p>
</blockquote>
<p><strong>GitHub Copilot:</strong></p>
<h3 data-id="heading-19">CORS 简单请求 vs 复杂请求的详细说明</h3>
<p>你的理解基本准确，但需要一些细节澄清。以下基于 W3C CORS 规范回答你的问题：</p>
<h4 data-id="heading-20">1. <strong>GET/POST，无自定义头，就是简单请求吗？</strong></h4>
<ul>
<li><strong>不完全是</strong>。简单请求（Simple Request）有严格条件，必须<strong>同时满足</strong>以下所有：
<ul>
<li><strong>方法</strong>：只能是 GET、HEAD 或 POST。</li>
<li><strong>请求头</strong>：只能使用 CORS 安全列表的头（不包括自定义头）。安全头包括：Accept, Accept-Language, Content-Language, Content-Type, DPR, Downlink, Save-Data, Viewport-Width, Width。</li>
<li><strong>Content-Type</strong>：如果有，只能是 application/x-www-form-urlencoded、multipart/form-data 或 text/plain。</li>
<li><strong>无凭据</strong>：不设置 credentials（如 cookies，除非服务器允许）。</li>
</ul>
</li>
<li><strong>示例</strong>：
<ul>
<li>简单：<code>fetch('https://api.com', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' } })</code>。</li>
<li>非简单：添加自定义头（如 <code>Authorization</code>）或用 PUT 方法。</li>
</ul>
</li>
<li><strong>原因</strong>：这些条件确保请求“安全”，不会意外修改服务器状态或发送复杂数据。</li>
</ul>
<h4 data-id="heading-21">2. <strong>非这种情况就是复杂请求吗？</strong></h4>
<ul>
<li><strong>是的</strong>。如果不满足简单请求的任一条件，就是复杂请求（Non-Simple Request）。复杂请求需要浏览器先发送预检请求（OPTIONS）来检查权限。</li>
<li><strong>示例</strong>：
<ul>
<li>用 PUT/DELETE/PATCH 方法。</li>
<li>设置自定义头（如 <code>X-Custom-Header</code>）。</li>
<li>Content-Type 为 application/json。</li>
<li>包含凭据（credentials: 'include'）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-22">3. <strong>同域复杂请求是不是也不需要预检？</strong></h4>
<ul>
<li><strong>是的</strong>。同域请求（协议、域名、端口相同）<strong>永远不会发送预检</strong>，即使是复杂请求。因为同域不存在跨域问题，浏览器直接发送实际请求，无需检查 CORS 头。</li>
<li><strong>原因</strong>：预检是为了跨域安全。同域时，浏览器信任本地服务器，无风险。</li>
<li><strong>示例</strong>：在 <code>https://yourdomain.com</code> 上用 PUT 方法请求 <code>https://yourdomain.com/api</code>，直接发送，无 OPTIONS。</li>
</ul>
<h4 data-id="heading-23">4. <strong>预检仅仅是为了判断是否允许跨域吗？</strong></h4>
<ul>
<li><strong>是的</strong>。预检（Preflight）的唯一目的是在发送实际跨域请求前，确认服务器是否允许该操作。它通过 OPTIONS 请求询问服务器的 CORS 策略。</li>
<li><strong>过程</strong>：
<ul>
<li>浏览器发送 OPTIONS 请求，包含 <code>Origin</code>、<code>Access-Control-Request-Method</code> 等头。</li>
<li>服务器响应允许头（如 <code>Access-Control-Allow-Origin</code>）。</li>
<li>如果通过，才发送实际请求。</li>
</ul>
</li>
<li><strong>注意</strong>：预检只针对跨域复杂请求。同域或简单请求跳过。</li>
</ul>
<h4 data-id="heading-24"><strong>总结</strong></h4>
<ul>
<li>简单请求：满足特定条件，无预检。</li>
<li>复杂请求：不满足条件，跨域时需预检，同域时直接发送。</li>
<li>预检是跨域保护机制的核心。</li>
</ul>
<p><strong>User:</strong></p>
<blockquote>
<p>Preflight 时的请求是浏览器自行发起的并且不受跨域限制对吗，并且只会带一些信息到服务器用于询问服务器是否允许是吗，那服务器如何响应是通过如何响应是不通过呢，以 node.js 为例。给我核心伪代码</p>
</blockquote>
<p><strong>GitHub Copilot:</strong></p>
<h3 data-id="heading-25">Preflight 请求的机制和服务器响应</h3>
<h4 data-id="heading-26">1. <strong>Preflight 请求是浏览器自行发起的并且不受跨域限制对吗？</strong></h4>
<ul>
<li><strong>是的</strong>。Preflight 是浏览器自动发起的 OPTIONS 请求，用于检查跨域权限。它不受 CORS 限制，因为它是“询问”机制的一部分——浏览器假设服务器会诚实地响应。如果服务器不支持 CORS，实际请求会被阻塞，但预检本身不会被跨域阻止（除非服务器完全拒绝 OPTIONS）。</li>
</ul>
<h4 data-id="heading-27">2. <strong>并且只会带一些信息到服务器用于询问服务器是否允许是吗？</strong></h4>
<ul>
<li><strong>是的</strong>。预检请求只携带必要信息，不会发送实际数据。它用于询问服务器是否允许后续的实际请求。关键头包括：
<ul>
<li><code>Origin</code>：请求来源域。</li>
<li><code>Access-Control-Request-Method</code>：实际请求的方法（如 PUT）。</li>
<li><code>Access-Control-Request-Headers</code>：实际请求的自定义头。</li>
<li>其他：如 <code>Access-Control-Request-Private-Network</code>（私有网络检查）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-28">3. <strong>服务器如何响应是通过还是不通过？以 Node.js 为例，给核心伪代码</strong></h4>
<ul>
<li><strong>通过</strong>：服务器返回 HTTP 200 状态码，并包含允许的 CORS 头。浏览器检查这些头，如果匹配，则发送实际请求。</li>
<li><strong>不通过</strong>：服务器返回错误状态（如 403）或不包含必要头。浏览器不会发送实际请求，并报 CORS 错误。</li>
<li><strong>核心头</strong>：
<ul>
<li><code>Access-Control-Allow-Origin</code>：允许的来源（<code>*</code> 或具体域）。</li>
<li><code>Access-Control-Allow-Methods</code>：允许的方法（如 <code>PUT, GET</code>）。</li>
<li><code>Access-Control-Allow-Headers</code>：允许的头。</li>
<li><code>Access-Control-Max-Age</code>：预检缓存时间（秒）。</li>
<li>可选：<code>Access-Control-Allow-Credentials</code>（允许凭据）。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-29"><strong>Node.js 核心伪代码（使用 Express）</strong></h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

<span class="hljs-comment">// 处理预检请求（OPTIONS）</span>
app.<span class="hljs-title function_">options</span>(<span class="hljs-string">'/api/data'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// 检查 Origin、方法等（可选：添加自定义逻辑）</span>
  <span class="hljs-keyword">const</span> allowedOrigins = [<span class="hljs-string">'https://yourdomain.com'</span>];
  <span class="hljs-keyword">const</span> origin = req.<span class="hljs-property">headers</span>.<span class="hljs-property">origin</span>;

  <span class="hljs-keyword">if</span> (allowedOrigins.<span class="hljs-title function_">includes</span>(origin)) {
    <span class="hljs-comment">// 通过：设置允许头</span>
    res.<span class="hljs-title function_">set</span>({
      <span class="hljs-string">'Access-Control-Allow-Origin'</span>: origin,  <span class="hljs-comment">// 或 '*' 如果允许所有</span>
      <span class="hljs-string">'Access-Control-Allow-Methods'</span>: <span class="hljs-string">'GET, POST, PUT, DELETE'</span>,
      <span class="hljs-string">'Access-Control-Allow-Headers'</span>: <span class="hljs-string">'Content-Type, Authorization'</span>,
      <span class="hljs-string">'Access-Control-Max-Age'</span>: <span class="hljs-number">86400</span>  <span class="hljs-comment">// 缓存 1 天</span>
    });
    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">end</span>();  <span class="hljs-comment">// 空响应体</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 不通过：返回错误</span>
    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">end</span>();
  }
});

<span class="hljs-comment">// 实际请求处理（假设是 PUT）</span>
app.<span class="hljs-title function_">put</span>(<span class="hljs-string">'/api/data'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// 正常业务逻辑</span>
  res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'Data updated'</span> });
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);
</code></pre>
<ul>
<li><strong>解释</strong>：预检时，服务器检查并响应头。如果通过，浏览器发送 PUT 请求；否则，阻止。</li>
<li><strong>注意</strong>：在生产中，使用中间件如 <code>cors</code> 包简化配置。实际请求也需设置 <code>Access-Control-Allow-Origin</code>。</li>
</ul>
<p><strong>User:</strong></p>
<blockquote>
<p>cors 中间件的核心逻辑实际上就是给所有的请求加一个 opstions 响应的中间件对吗</p>
</blockquote>
<p><strong>GitHub Copilot:</strong></p>
<h3 data-id="heading-30">CORS 中间件的理解</h3>
<p>你的理解<strong>部分正确</strong>，但不完全准确。CORS 中间件（如 Express 的 <code>cors</code> 包）的核心逻辑不仅仅是“给所有请求加一个 OPTIONS 响应”，而是<strong>自动处理 CORS 头和预检请求</strong>。它为所有匹配的请求（包括预检和实际请求）添加必要的 CORS 头，并专门响应 OPTIONS 请求。以下是详细解释：</p>
<h4 data-id="heading-31"><strong>核心逻辑</strong></h4>
<ul>
<li><strong>自动响应预检</strong>：当浏览器发送 OPTIONS 请求时，中间件检查并返回允许头（如 <code>Access-Control-Allow-Origin</code>），无需你手动写 OPTIONS 路由。</li>
<li><strong>为实际请求添加头</strong>：对于非 OPTIONS 请求（GET/POST 等），中间件添加 CORS 头，确保响应能被跨域访问。</li>
<li><strong>配置灵活</strong>：你可以指定允许的域、方法、头等。它不是“加 OPTIONS 响应”，而是统一管理 CORS 策略。</li>
<li><strong>为什么不是单纯的 OPTIONS 中间件</strong>？因为它处理整个 CORS 流程，包括缓存（<code>Access-Control-Max-Age</code>）和凭据。</li>
</ul>
<h4 data-id="heading-32"><strong>以 Express 的 <code>cors</code> 中间件为例（核心伪代码模拟）</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟 cors 中间件的简化逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">corsMiddleware</span>(<span class="hljs-params">options = {}</span>) {
  <span class="hljs-keyword">const</span> {
    origin = <span class="hljs-string">'*'</span>,  <span class="hljs-comment">// 默认允许所有域</span>
    methods = <span class="hljs-string">'GET,HEAD,PUT,PATCH,POST,DELETE'</span>,
    allowedHeaders = <span class="hljs-string">'*'</span>,
    credentials = <span class="hljs-literal">false</span>
  } = options;

  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
    <span class="hljs-comment">// 设置通用头（适用于所有请求）</span>
    res.<span class="hljs-title function_">set</span>({
      <span class="hljs-string">'Access-Control-Allow-Origin'</span>: origin,
      <span class="hljs-string">'Access-Control-Allow-Methods'</span>: methods,
      <span class="hljs-string">'Access-Control-Allow-Headers'</span>: allowedHeaders,
      <span class="hljs-string">'Access-Control-Max-Age'</span>: <span class="hljs-number">86400</span>  <span class="hljs-comment">// 缓存预检</span>
    });
    <span class="hljs-keyword">if</span> (credentials) {
      res.<span class="hljs-title function_">set</span>(<span class="hljs-string">'Access-Control-Allow-Credentials'</span>, <span class="hljs-string">'true'</span>);
    }

    <span class="hljs-comment">// 如果是 OPTIONS 请求（预检），直接响应，无需继续</span>
    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">'OPTIONS'</span>) {
      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">end</span>();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 否则，继续到下一个中间件/路由</span>
    <span class="hljs-title function_">next</span>();
  };
}

<span class="hljs-comment">// 使用示例</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">corsMiddleware</span>({ <span class="hljs-attr">origin</span>: <span class="hljs-string">'https://yourdomain.com'</span> }));
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">data</span>: <span class="hljs-string">'ok'</span> }));
</code></pre>
<ul>
<li><strong>解释</strong>：中间件拦截所有请求，添加头。如果是 OPTIONS，直接结束响应；否则，传递给路由。实际项目中，用 <code>npm install cors</code> 并 <code>app.use(cors())</code> 即可。</li>
</ul>
<p><strong>User:</strong></p>
<blockquote>
<p>那我有一个问题，上一个问题你给我的伪代码表明，只要给每个请求 url 的 options 请求都加 res.set({
'Access-Control-Allow-Origin': origin, // 或 '*' 如果允许所有
'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE',
'Access-Control-Allow-Headers': 'Content-Type, Authorization',
'Access-Control-Max-Age': 86400 // 缓存 1 天
});并响应 200，那么对应的这个请求 url 就能够被允许跨域，因为在 options 中已经设置了这个 url 的规则，因此当这个 url 的 options 通过以后，这个 url 的复杂请求应该不需要再详情允许跨域的响应头了吧。</p>
</blockquote>
<p><strong>GitHub Copilot:</strong></p>
<h3 data-id="heading-33">关于预检和实际请求的 CORS 头设置</h3>
<p>你的理解有误。<strong>预检（OPTIONS）通过后，实际请求的响应</strong>仍然需要包含 CORS 头**。仅仅在 OPTIONS 中设置头是不够的**。以下是详细解释和修正：</p>
<h4 data-id="heading-34"><strong>为什么实际请求也需要 CORS 头？</strong></h4>
<ul>
<li><strong>预检的目的</strong>：浏览器通过 OPTIONS 请求确认“是否允许发送这个跨域请求”。如果服务器响应允许头，浏览器才会发送实际请求。</li>
<li><strong>实际请求的检查</strong>：浏览器发送实际请求后，会检查<strong>响应</strong>中的 CORS 头（如 <code>Access-Control-Allow-Origin</code>）。如果响应没有这些头，浏览器会报 CORS 错误，即使预检通过了。</li>
<li><strong>原因</strong>：预检是“询问权限”，但实际响应必须“证明允许”。这是为了防止服务器在预检后改变策略，或确保响应安全。</li>
<li><strong>示例</strong>：
<ul>
<li>预检：OPTIONS 请求 → 服务器响应允许头 → 浏览器认为“可以发送”。</li>
<li>实际请求：PUT 请求 → 服务器响应数据 + 允许头 → 浏览器允许前端读取响应。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-35"><strong>修正你的理解</strong></h4>
<ul>
<li>在 OPTIONS 中设置头只是处理预检。</li>
<li>实际请求的路由也必须设置相同的头（或通过中间件统一设置）。</li>
<li>如果实际请求的响应缺少头，前端会报错，如 <code>Access to fetch at 'https://api.com' from origin 'https://yourdomain.com' has been blocked by CORS policy</code>。</li>
</ul>
<h4 data-id="heading-36"><strong>更新伪代码（确保实际请求也有头）</strong></h4>
<p>在之前的伪代码基础上，中间件需要为<strong>所有响应</strong>添加头，包括实际请求。以下是修正版：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">corsMiddleware</span>(<span class="hljs-params">options = {}</span>) {
  <span class="hljs-keyword">const</span> {
    origin = <span class="hljs-string">'*'</span>,
    methods = <span class="hljs-string">'GET,HEAD,PUT,PATCH,POST,DELETE'</span>,
    allowedHeaders = <span class="hljs-string">'*'</span>,
    credentials = <span class="hljs-literal">false</span>
  } = options;

  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
    <span class="hljs-comment">// 为所有请求设置 CORS 头（包括预检和实际请求）</span>
    res.<span class="hljs-title function_">set</span>({
      <span class="hljs-string">'Access-Control-Allow-Origin'</span>: origin,
      <span class="hljs-string">'Access-Control-Allow-Methods'</span>: methods,
      <span class="hljs-string">'Access-Control-Allow-Headers'</span>: allowedHeaders,
      <span class="hljs-string">'Access-Control-Max-Age'</span>: <span class="hljs-number">86400</span>
    });
    <span class="hljs-keyword">if</span> (credentials) {
      res.<span class="hljs-title function_">set</span>(<span class="hljs-string">'Access-Control-Allow-Credentials'</span>, <span class="hljs-string">'true'</span>);
    }

    <span class="hljs-comment">// 如果是 OPTIONS（预检），直接响应 200</span>
    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">'OPTIONS'</span>) {
      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">end</span>();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 否则，继续到路由（路由的响应也会继承这些头）</span>
    <span class="hljs-title function_">next</span>();
  };
}

<span class="hljs-comment">// 使用示例</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">corsMiddleware</span>({ <span class="hljs-attr">origin</span>: <span class="hljs-string">'https://yourdomain.com'</span> }));

<span class="hljs-comment">// 实际路由：响应会自动有 CORS 头</span>
app.<span class="hljs-title function_">put</span>(<span class="hljs-string">'/api/data'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'Updated'</span> });  <span class="hljs-comment">// 响应包含 CORS 头</span>
});
</code></pre>
<ul>
<li><strong>关键</strong>：中间件在 <code>next()</code> 前设置头，所以所有响应（包括路由的）都会有头。Express 的 <code>cors</code> 包就是这样工作的。</li>
<li><strong>测试</strong>：用浏览器开发者工具检查网络请求，实际请求的响应头必须有 <code>Access-Control-Allow-Origin</code>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter-OH 3.35.7 开发技巧&仓库拉取指南]]></title>    <link>https://juejin.cn/post/7598118189143408640</link>    <guid>https://juejin.cn/post/7598118189143408640</guid>    <pubDate>2026-01-23T03:15:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598118189143408640" data-draft-id="7598118189143392256" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter-OH 3.35.7 开发技巧&amp;仓库拉取指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-23T03:15:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="坚果派_坚果"/> <meta itemprop="url" content="https://juejin.cn/user/3843548384077192"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter-OH 3.35.7 开发技巧&amp;仓库拉取指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548384077192/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    坚果派_坚果
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:15:03.000Z" title="Fri Jan 23 2026 03:15:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flutter-OH 3.35.7 开发技巧&amp;仓库拉取指南</h2>
<p>Flutter-OH 3.35.7 现已正式更新，其适配 OpenHarmony 的开发分支 <code>oh-3.35.7-dev</code> 处于持续迭代状态，会每日进行 bug 修复与功能优化。不管你是刚配置好该版本环境，还是已经在基于它开发，这里分享一套实用的环境检查、版本验证技巧，同时附上仓库的完整拉取步骤，帮大家高效使用最新版本开发。</p>
<h3 data-id="heading-1">一、已配置环境：检查与版本验证</h3>
<p>若你已经拉取过仓库并配置好 Flutter-OH 3.35.7 环境，每次开发前可通过以下步骤检查环境状态、确认版本是否为最新，避免因版本滞后遇到已修复的问题。</p>
<h4 data-id="heading-2">1. 拉取最新代码，同步仓库更新</h4>
<p>进入本地 <code>flutter_flutter</code> 仓库目录，执行 <code>git pull</code> 拉取 <code>oh-3.35.7-dev</code> 分支的最新代码，终端会显示代码同步的详细日志（含文件变更、版本迭代信息）：</p>
<pre><code class="hljs language-bash" lang="bash">git pull         
remote: Enumerating objects: 106, <span class="hljs-keyword">done</span>.
remote: Counting objects: 100% (65/65), <span class="hljs-keyword">done</span>.
remote: Compressing objects: 100% (57/57), <span class="hljs-keyword">done</span>.
remote: Total 106 (delta 19), reused 4 (delta 3), pack-reused 41 (from 1)
Receiving objects: 100% (106/106), 99.81 KiB | 1.81 MiB/s, <span class="hljs-keyword">done</span>.
Resolving deltas: 100% (25/25), completed with 2 <span class="hljs-built_in">local</span> objects.
From gitcode.com:openharmony-tpc/flutter_flutter
   b15356702b..419a77c140  oh-3.35.7-dev       -&gt; origin/oh-3.35.7-dev
   c32b189588..861551e934  3.22.0-ohos         -&gt; origin/3.22.0-ohos
   56cf6e29b2..c9aed89bdf  3.22.0-ohos-release -&gt; origin/3.22.0-ohos-release
   c63b40bce0..6313b0cffd  dev                 -&gt; origin/dev
   ea2820a86a..0b72369f35  oh-3.27.0-release   -&gt; origin/oh-3.27.0-release
   c18a193ae8..1d693d1c5b  oh-3.27.4-dev       -&gt; origin/oh-3.27.4-dev
   c06e970add..9a658da965  oh-3.32.4-dev       -&gt; origin/oh-3.32.4-dev
 * [new tag]               3.22.1-ohos-1.0.9   -&gt; 3.22.1-ohos-1.0.9
 * [new tag]               3.27.5-ohos-1.0.3   -&gt; 3.27.5-ohos-1.0.3
Updating b15356702b..419a77c140
Fast-forward
 bin/internal/engine.ohos.har.version                                    |   2 +-
 bin/internal/engine.ohos.version                                        |   2 +-
 engine/src/flutter/shell/platform/ohos/background_resource_cleanup.h    |  95 +++++++++++++++++++++++++++++++++++++++++++++
 engine/src/flutter/shell/platform/ohos/napi/platform_view_ohos_napi.cpp |   6 ++-
 engine/src/flutter/shell/platform/ohos/ohos_surface_gl_skia.cpp         |  60 ++++++++++++++++++++++++----
 engine/src/flutter/shell/platform/ohos/platform_view_ohos.cpp           | 286 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-
 engine/src/flutter/shell/platform/ohos/platform_view_ohos.h             | 101 ++++++++++++++++++++++++++++++++++++++++++++++-
 7 files changed, 539 insertions(+), 13 deletions(-)
 create mode 100644 engine/src/flutter/shell/platform/ohos/background_resource_cleanup.h
</code></pre>
<h4 data-id="heading-3">2. 检查环境完整性</h4>
<p>执行 <code>flutter doctor -v</code> 检查本地 Flutter-OH 环境的依赖、工具链、设备连接等状态，确认无关键异常（非核心问题如Xcode/CocoaPods可忽略，不影响OpenHarmony开发）：</p>
<pre><code class="hljs">flutter doctor -v
</code></pre>
<p>示例输出（已同步最新代码的正常状态）：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Downloading</span> <span class="hljs-selector-tag">Darwin</span> <span class="hljs-selector-tag">arm64</span> <span class="hljs-selector-tag">Dart</span> <span class="hljs-selector-tag">SDK</span> <span class="hljs-selector-tag">from</span> <span class="hljs-selector-tag">Flutter</span> <span class="hljs-selector-tag">engine</span> <span class="hljs-selector-tag">b15356702b41d3bd6a857d588ab21e85e54c174a</span>...
<span class="hljs-selector-tag">dart-sdk-url</span>: <span class="hljs-selector-tag">https</span>:<span class="hljs-comment">//flutter-ohos.obs.cn-south-1.myhuaweicloud.com/flutter_infra_release/flutter/b15356702b41d3bd6a857d588ab21e85e54c174a/dart-sdk-darwin-arm64.zip</span>
  % <span class="hljs-selector-tag">Total</span>    % <span class="hljs-selector-tag">Received</span> % <span class="hljs-selector-tag">Xferd</span>  <span class="hljs-selector-tag">Average</span> <span class="hljs-selector-tag">Speed</span>   <span class="hljs-selector-tag">Time</span>    <span class="hljs-selector-tag">Time</span>     <span class="hljs-selector-tag">Time</span>  <span class="hljs-selector-tag">Current</span>
                                 <span class="hljs-selector-tag">Dload</span>  <span class="hljs-selector-tag">Upload</span>   <span class="hljs-selector-tag">Total</span>   <span class="hljs-selector-tag">Spent</span>    <span class="hljs-selector-tag">Left</span>  <span class="hljs-selector-tag">Speed</span>
<span class="hljs-number">100</span>  <span class="hljs-number">197</span><span class="hljs-selector-tag">M</span>  <span class="hljs-number">100</span>  <span class="hljs-number">197</span><span class="hljs-selector-tag">M</span>    <span class="hljs-number">0</span>     <span class="hljs-number">0</span>  <span class="hljs-number">32.3</span><span class="hljs-selector-tag">M</span>      <span class="hljs-number">0</span>  <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">06</span>  <span class="hljs-number">0</span>:<span class="hljs-number">00</span>:<span class="hljs-number">06</span> <span class="hljs-selector-tag">--</span>:<span class="hljs-selector-tag">--</span>:<span class="hljs-selector-tag">--</span> <span class="hljs-number">35.4</span><span class="hljs-selector-tag">M</span>
<span class="hljs-selector-tag">Building</span> <span class="hljs-selector-tag">flutter</span> <span class="hljs-selector-tag">tool</span>...
<span class="hljs-selector-tag">Resolving</span> <span class="hljs-selector-tag">dependencies</span>... 
<span class="hljs-selector-tag">Downloading</span> <span class="hljs-selector-tag">packages</span>... 
<span class="hljs-selector-tag">Got</span> <span class="hljs-selector-tag">dependencies</span>.
<span class="hljs-selector-tag">Flutter</span> <span class="hljs-selector-tag">assets</span> <span class="hljs-selector-tag">will</span> <span class="hljs-selector-tag">be</span> <span class="hljs-selector-tag">downloaded</span> <span class="hljs-selector-tag">from</span> <span class="hljs-selector-tag">https</span>:<span class="hljs-comment">//storage.flutter-io.cn. Make sure you trust this source!</span>
<span class="hljs-selector-tag">Downloading</span> <span class="hljs-selector-tag">darwin-arm64</span> <span class="hljs-selector-tag">tools</span>...                                <span class="hljs-number">1</span>,<span class="hljs-number">108ms</span>
<span class="hljs-selector-attr">[!]</span> <span class="hljs-selector-tag">Flutter</span> (Channel [user-branch], <span class="hljs-number">3.35</span>.<span class="hljs-number">8</span>-ohos-<span class="hljs-number">0.0</span>.<span class="hljs-number">1</span>-canary1, on macOS <span class="hljs-number">15.2</span> <span class="hljs-number">24</span>C103 darwin-arm64, locale zh-Hans-CN) <span class="hljs-selector-attr">[730ms]</span>
    ! <span class="hljs-selector-tag">Flutter</span> <span class="hljs-selector-tag">version</span> <span class="hljs-number">3.35</span><span class="hljs-selector-class">.8-ohos-0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1-canary1</span> <span class="hljs-selector-tag">on</span> <span class="hljs-selector-tag">channel</span> <span class="hljs-selector-attr">[user-branch]</span> <span class="hljs-selector-tag">at</span> /<span class="hljs-selector-tag">Users</span>/<span class="hljs-selector-tag">jianguo</span>/<span class="hljs-selector-tag">Desktop</span>/<span class="hljs-selector-tag">harmony</span>/<span class="hljs-selector-tag">flutter</span>/<span class="hljs-selector-tag">flutter_flutter</span>
      <span class="hljs-selector-tag">Currently</span> <span class="hljs-selector-tag">on</span> <span class="hljs-selector-tag">an</span> <span class="hljs-selector-tag">unknown</span> <span class="hljs-selector-tag">channel</span>. <span class="hljs-selector-tag">Run</span> `<span class="hljs-selector-tag">flutter</span> <span class="hljs-selector-tag">channel</span>` <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">switch</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">an</span> <span class="hljs-selector-tag">official</span> <span class="hljs-selector-tag">channel</span>.
      <span class="hljs-selector-tag">If</span> <span class="hljs-selector-tag">that</span> <span class="hljs-selector-tag">doesn</span>'<span class="hljs-selector-tag">t</span> <span class="hljs-selector-tag">fix</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">issue</span>, <span class="hljs-selector-tag">reinstall</span> <span class="hljs-selector-tag">Flutter</span> <span class="hljs-selector-tag">by</span> <span class="hljs-selector-tag">following</span> <span class="hljs-selector-tag">instructions</span> <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">https</span>:<span class="hljs-comment">//flutter.dev/setup.</span>
    • <span class="hljs-selector-tag">Upstream</span> <span class="hljs-selector-tag">repository</span> <span class="hljs-selector-tag">git</span>@<span class="hljs-selector-tag">gitcode</span><span class="hljs-selector-class">.com</span>:<span class="hljs-selector-tag">openharmony-tpc</span>/<span class="hljs-selector-tag">flutter_flutter</span><span class="hljs-selector-class">.git</span>
    • <span class="hljs-selector-tag">FLUTTER_GIT_URL</span> = <span class="hljs-selector-tag">git</span>@<span class="hljs-selector-tag">gitcode</span><span class="hljs-selector-class">.com</span>:<span class="hljs-selector-tag">openharmony-tpc</span>/<span class="hljs-selector-tag">flutter_flutter</span><span class="hljs-selector-class">.git</span>
    • <span class="hljs-selector-tag">Framework</span> <span class="hljs-selector-tag">revision</span> <span class="hljs-number">419</span><span class="hljs-selector-tag">a77c140</span> (<span class="hljs-number">23</span> minutes ago), <span class="hljs-number">2026</span><span class="hljs-selector-tag">-01-23</span> <span class="hljs-number">09</span>:<span class="hljs-number">50</span>:<span class="hljs-number">03</span> +<span class="hljs-number">0800</span>
    • <span class="hljs-selector-tag">Engine</span> <span class="hljs-selector-tag">revision</span> <span class="hljs-number">035316565</span><span class="hljs-selector-tag">a</span>
    • <span class="hljs-selector-tag">Dart</span> <span class="hljs-selector-tag">version</span> <span class="hljs-number">3.9</span><span class="hljs-selector-class">.2</span>
    • <span class="hljs-selector-tag">DevTools</span> <span class="hljs-selector-tag">version</span> <span class="hljs-number">2.48</span><span class="hljs-selector-class">.0</span>
    • <span class="hljs-selector-tag">Pub</span> <span class="hljs-selector-tag">download</span> <span class="hljs-selector-tag">mirror</span> <span class="hljs-selector-tag">https</span>:<span class="hljs-comment">//pub.flutter-io.cn</span>
    • <span class="hljs-selector-tag">Flutter</span> <span class="hljs-selector-tag">download</span> <span class="hljs-selector-tag">mirror</span> <span class="hljs-selector-tag">https</span>:<span class="hljs-comment">//storage.flutter-io.cn</span>
    • <span class="hljs-selector-tag">Feature</span> <span class="hljs-selector-tag">flags</span>: <span class="hljs-selector-tag">enable-ohos</span>, <span class="hljs-selector-tag">enable-web</span>, <span class="hljs-selector-tag">enable-linux-desktop</span>, <span class="hljs-selector-tag">enable-macos-desktop</span>, <span class="hljs-selector-tag">enable-windows-desktop</span>, <span class="hljs-selector-tag">enable-android</span>, <span class="hljs-selector-tag">enable-ios</span>, <span class="hljs-selector-tag">cli-animations</span>, <span class="hljs-selector-tag">enable-native-assets</span>, <span class="hljs-selector-tag">enable-lldb-debugging</span>
    • <span class="hljs-selector-tag">If</span> <span class="hljs-selector-tag">those</span> <span class="hljs-selector-tag">were</span> <span class="hljs-selector-tag">intentional</span>, <span class="hljs-selector-tag">you</span> <span class="hljs-selector-tag">can</span> <span class="hljs-selector-tag">disregard</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">above</span> <span class="hljs-selector-tag">warnings</span>; <span class="hljs-selector-tag">however</span> <span class="hljs-selector-tag">it</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">recommended</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">use</span> "<span class="hljs-selector-tag">git</span>" <span class="hljs-selector-tag">directly</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">perform</span> <span class="hljs-selector-tag">update</span> <span class="hljs-selector-tag">checks</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">upgrades</span>.
​
<span class="hljs-selector-attr">[✓]</span> <span class="hljs-selector-tag">HarmonyOS</span> <span class="hljs-selector-tag">toolchain</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">develop</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">HarmonyOS</span> <span class="hljs-selector-tag">devices</span>
    • <span class="hljs-selector-tag">OpenHarmony</span> <span class="hljs-selector-tag">Sdk</span> <span class="hljs-selector-tag">at</span> /<span class="hljs-selector-tag">Users</span>/<span class="hljs-selector-tag">jianguo</span>/<span class="hljs-selector-tag">Library</span>/<span class="hljs-selector-tag">OpenHarmony</span>/<span class="hljs-selector-tag">Sdk</span>, <span class="hljs-selector-tag">available</span> <span class="hljs-selector-tag">api</span> <span class="hljs-selector-tag">versions</span> <span class="hljs-selector-tag">has</span> <span class="hljs-selector-attr">[20:20]</span>
    • <span class="hljs-selector-tag">Ohpm</span> <span class="hljs-selector-tag">version</span> <span class="hljs-number">6.0</span><span class="hljs-selector-class">.1</span>
    • <span class="hljs-selector-tag">Node</span> <span class="hljs-selector-tag">version</span> <span class="hljs-selector-tag">v23</span><span class="hljs-selector-class">.11</span><span class="hljs-selector-class">.0</span>
    • <span class="hljs-selector-tag">Hvigorw</span> <span class="hljs-selector-tag">binary</span> <span class="hljs-selector-tag">at</span> /<span class="hljs-selector-tag">Applications</span>/<span class="hljs-selector-tag">DevEco-Studio</span><span class="hljs-selector-class">.app</span>/<span class="hljs-selector-tag">Contents</span>/<span class="hljs-selector-tag">tools</span>/<span class="hljs-selector-tag">hvigor</span>/<span class="hljs-selector-tag">bin</span>/<span class="hljs-selector-tag">hvigorw</span>
​
<span class="hljs-selector-attr">[✓]</span> <span class="hljs-selector-tag">Android</span> <span class="hljs-selector-tag">toolchain</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">develop</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">Android</span> <span class="hljs-selector-tag">devices</span> (Android SDK version <span class="hljs-number">36.1</span>.<span class="hljs-number">0</span>-rc1) <span class="hljs-selector-attr">[5.7s]</span>
    • <span class="hljs-selector-tag">Android</span> <span class="hljs-selector-tag">SDK</span> <span class="hljs-selector-tag">at</span> /<span class="hljs-selector-tag">Users</span>/<span class="hljs-selector-tag">jianguo</span>/<span class="hljs-selector-tag">Library</span>/<span class="hljs-selector-tag">Android</span>/<span class="hljs-selector-tag">sdk</span>
    • <span class="hljs-selector-tag">Emulator</span> <span class="hljs-selector-tag">version</span> <span class="hljs-selector-tag">unknown</span>
    • <span class="hljs-selector-tag">Platform</span> <span class="hljs-selector-tag">android-36</span>, <span class="hljs-selector-tag">build-tools</span> <span class="hljs-number">36.1</span><span class="hljs-selector-class">.0-rc1</span>
    • <span class="hljs-selector-tag">Java</span> <span class="hljs-selector-tag">binary</span> <span class="hljs-selector-tag">at</span>: /<span class="hljs-selector-tag">Applications</span>/<span class="hljs-selector-tag">Android</span> <span class="hljs-selector-tag">Studio</span><span class="hljs-selector-class">.app</span>/<span class="hljs-selector-tag">Contents</span>/<span class="hljs-selector-tag">jbr</span>/<span class="hljs-selector-tag">Contents</span>/<span class="hljs-selector-tag">Home</span>/<span class="hljs-selector-tag">bin</span>/<span class="hljs-selector-tag">java</span>
      <span class="hljs-selector-tag">This</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">JDK</span> <span class="hljs-selector-tag">bundled</span> <span class="hljs-selector-tag">with</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">latest</span> <span class="hljs-selector-tag">Android</span> <span class="hljs-selector-tag">Studio</span> <span class="hljs-selector-tag">installation</span> <span class="hljs-selector-tag">on</span> <span class="hljs-selector-tag">this</span> <span class="hljs-selector-tag">machine</span>.
      <span class="hljs-selector-tag">To</span> <span class="hljs-selector-tag">manually</span> <span class="hljs-selector-tag">set</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">JDK</span> <span class="hljs-selector-tag">path</span>, <span class="hljs-selector-tag">use</span>: `<span class="hljs-selector-tag">flutter</span> <span class="hljs-selector-tag">config</span> <span class="hljs-selector-tag">--jdk-dir</span>="<span class="hljs-selector-tag">path</span>/<span class="hljs-selector-tag">to</span>/<span class="hljs-selector-tag">jdk</span>"`.
    • <span class="hljs-selector-tag">Java</span> <span class="hljs-selector-tag">version</span> <span class="hljs-selector-tag">OpenJDK</span> <span class="hljs-selector-tag">Runtime</span> <span class="hljs-selector-tag">Environment</span> (build <span class="hljs-number">21.0</span>.<span class="hljs-number">6</span>+-<span class="hljs-number">13391695</span>-b895.<span class="hljs-number">109</span>)
    • <span class="hljs-keyword">All</span> <span class="hljs-selector-tag">Android</span> <span class="hljs-selector-tag">licenses</span> <span class="hljs-selector-tag">accepted</span>.
​
<span class="hljs-selector-attr">[!]</span> <span class="hljs-selector-tag">Xcode</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">develop</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">iOS</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">macOS</span> (Xcode <span class="hljs-number">16.3</span>) <span class="hljs-selector-attr">[820ms]</span>
    • <span class="hljs-selector-tag">Xcode</span> <span class="hljs-selector-tag">at</span> /<span class="hljs-selector-tag">Applications</span>/<span class="hljs-selector-tag">Xcode</span><span class="hljs-selector-class">.app</span>/<span class="hljs-selector-tag">Contents</span>/<span class="hljs-selector-tag">Developer</span>
    • <span class="hljs-selector-tag">Build</span> <span class="hljs-number">16</span><span class="hljs-selector-tag">E140</span>
    ✗ <span class="hljs-selector-tag">Unable</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">get</span> <span class="hljs-selector-tag">list</span> <span class="hljs-selector-tag">of</span> <span class="hljs-selector-tag">installed</span> <span class="hljs-selector-tag">Simulator</span> <span class="hljs-selector-tag">runtimes</span>.
    ✗ <span class="hljs-selector-tag">CocoaPods</span> <span class="hljs-selector-tag">not</span> <span class="hljs-selector-tag">installed</span>.
        <span class="hljs-selector-tag">CocoaPods</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">package</span> <span class="hljs-selector-tag">manager</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">iOS</span> <span class="hljs-selector-tag">or</span> <span class="hljs-selector-tag">macOS</span> <span class="hljs-selector-tag">platform</span> <span class="hljs-selector-tag">code</span>.
        <span class="hljs-selector-tag">Without</span> <span class="hljs-selector-tag">CocoaPods</span>, <span class="hljs-selector-tag">plugins</span> <span class="hljs-selector-tag">will</span> <span class="hljs-selector-tag">not</span> <span class="hljs-selector-tag">work</span> <span class="hljs-selector-tag">on</span> <span class="hljs-selector-tag">iOS</span> <span class="hljs-selector-tag">or</span> <span class="hljs-selector-tag">macOS</span>.
        <span class="hljs-selector-tag">For</span> <span class="hljs-selector-tag">more</span> <span class="hljs-selector-tag">info</span>, <span class="hljs-selector-tag">see</span> <span class="hljs-selector-tag">https</span>:<span class="hljs-comment">//flutter.dev/to/platform-plugins</span>
      <span class="hljs-selector-tag">For</span> <span class="hljs-selector-tag">installation</span> <span class="hljs-selector-tag">instructions</span>, <span class="hljs-selector-tag">see</span> <span class="hljs-selector-tag">https</span>:<span class="hljs-comment">//guides.cocoapods.org/using/getting-started.html#installation</span>
​
<span class="hljs-selector-attr">[✓]</span> <span class="hljs-selector-tag">Chrome</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">develop</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">web</span> <span class="hljs-selector-attr">[51ms]</span>
    • <span class="hljs-selector-tag">Chrome</span> <span class="hljs-selector-tag">at</span> /<span class="hljs-selector-tag">Applications</span>/<span class="hljs-selector-tag">Google</span> <span class="hljs-selector-tag">Chrome</span><span class="hljs-selector-class">.app</span>/<span class="hljs-selector-tag">Contents</span>/<span class="hljs-selector-tag">MacOS</span>/<span class="hljs-selector-tag">Google</span> <span class="hljs-selector-tag">Chrome</span>
​
<span class="hljs-selector-attr">[✓]</span> <span class="hljs-selector-tag">Android</span> <span class="hljs-selector-tag">Studio</span> (version <span class="hljs-number">2025.1</span>) <span class="hljs-selector-attr">[51ms]</span>
    • <span class="hljs-selector-tag">Android</span> <span class="hljs-selector-tag">Studio</span> <span class="hljs-selector-tag">at</span> /<span class="hljs-selector-tag">Applications</span>/<span class="hljs-selector-tag">Android</span> <span class="hljs-selector-tag">Studio</span><span class="hljs-selector-class">.app</span>/<span class="hljs-selector-tag">Contents</span>
    • <span class="hljs-selector-tag">Flutter</span> <span class="hljs-selector-tag">plugin</span> <span class="hljs-selector-tag">can</span> <span class="hljs-selector-tag">be</span> <span class="hljs-selector-tag">installed</span> <span class="hljs-selector-tag">from</span>:
      🔨 <span class="hljs-selector-tag">https</span>:<span class="hljs-comment">//plugins.jetbrains.com/plugin/9212-flutter</span>
    • <span class="hljs-selector-tag">Dart</span> <span class="hljs-selector-tag">plugin</span> <span class="hljs-selector-tag">can</span> <span class="hljs-selector-tag">be</span> <span class="hljs-selector-tag">installed</span> <span class="hljs-selector-tag">from</span>:
      🔨 <span class="hljs-selector-tag">https</span>:<span class="hljs-comment">//plugins.jetbrains.com/plugin/6351-dart</span>
    • <span class="hljs-selector-tag">Java</span> <span class="hljs-selector-tag">version</span> <span class="hljs-selector-tag">OpenJDK</span> <span class="hljs-selector-tag">Runtime</span> <span class="hljs-selector-tag">Environment</span> (build <span class="hljs-number">21.0</span>.<span class="hljs-number">6</span>+-<span class="hljs-number">13391695</span>-b895.<span class="hljs-number">109</span>)
​
<span class="hljs-selector-attr">[✓]</span> <span class="hljs-selector-tag">VS</span> <span class="hljs-selector-tag">Code</span> (version <span class="hljs-number">1.106</span>.<span class="hljs-number">3</span>) <span class="hljs-selector-attr">[50ms]</span>
    • <span class="hljs-selector-tag">VS</span> <span class="hljs-selector-tag">Code</span> <span class="hljs-selector-tag">at</span> /<span class="hljs-selector-tag">Applications</span>/<span class="hljs-selector-tag">Visual</span> <span class="hljs-selector-tag">Studio</span> <span class="hljs-selector-tag">Code</span><span class="hljs-selector-class">.app</span>/<span class="hljs-selector-tag">Contents</span>
    • <span class="hljs-selector-tag">Flutter</span> <span class="hljs-selector-tag">extension</span> <span class="hljs-selector-tag">can</span> <span class="hljs-selector-tag">be</span> <span class="hljs-selector-tag">installed</span> <span class="hljs-selector-tag">from</span>:
      🔨 <span class="hljs-selector-tag">https</span>:<span class="hljs-comment">//marketplace.visualstudio.com/items?itemName=Dart-Code.flutter</span>
​
<span class="hljs-selector-attr">[✓]</span> <span class="hljs-selector-tag">Connected</span> <span class="hljs-selector-tag">device</span> (<span class="hljs-number">2</span> available) <span class="hljs-selector-attr">[9.8s]</span>
    • <span class="hljs-selector-tag">macOS</span> (desktop) • <span class="hljs-selector-tag">macos</span>  • <span class="hljs-selector-tag">darwin-arm64</span>   • <span class="hljs-selector-tag">macOS</span> <span class="hljs-number">15.2</span> <span class="hljs-number">24</span><span class="hljs-selector-tag">C103</span> <span class="hljs-selector-tag">darwin-arm64</span>
    • <span class="hljs-selector-tag">Chrome</span> (web)    • <span class="hljs-selector-tag">chrome</span> • <span class="hljs-selector-tag">web-javascript</span> • <span class="hljs-selector-tag">Google</span> <span class="hljs-selector-tag">Chrome</span> <span class="hljs-number">144.0</span><span class="hljs-selector-class">.7559</span><span class="hljs-selector-class">.61</span>
​
<span class="hljs-selector-attr">[✓]</span> <span class="hljs-selector-tag">Network</span> <span class="hljs-selector-tag">resources</span> <span class="hljs-selector-attr">[2.3s]</span>
    • <span class="hljs-keyword">All</span> <span class="hljs-selector-tag">expected</span> <span class="hljs-selector-tag">network</span> <span class="hljs-selector-tag">resources</span> <span class="hljs-selector-tag">are</span> <span class="hljs-selector-tag">available</span>.
​
! <span class="hljs-selector-tag">Doctor</span> <span class="hljs-selector-tag">found</span> <span class="hljs-selector-tag">issues</span> <span class="hljs-selector-tag">in</span> <span class="hljs-number">2</span> <span class="hljs-selector-tag">categories</span>.
</code></pre>
<h4 data-id="heading-4">3. 确认当前Flutter-OH版本</h4>
<p>执行 <code>flutter --version</code> 查看当前使用的版本号，确认已同步到仓库最新版本：</p>
<pre><code class="hljs language-css" lang="css">flutter <span class="hljs-attr">--version</span>
</code></pre>
<p>示例输出（最新迭代版本）：</p>
<pre><code class="hljs language-scss" lang="scss">Flutter <span class="hljs-number">3.35</span><span class="hljs-selector-class">.8-ohos-0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1-canary1</span> • channel <span class="hljs-selector-attr">[user-branch]</span> • git<span class="hljs-keyword">@gitcode</span>.<span class="hljs-attribute">com</span>:openharmony-tpc/flutter_flutter.git
Framework • revision <span class="hljs-number">419</span>a77c140 (<span class="hljs-number">65</span> minutes ago) • <span class="hljs-number">2026</span>-<span class="hljs-number">01</span>-<span class="hljs-number">23</span> <span class="hljs-number">09</span>:<span class="hljs-number">50</span>:<span class="hljs-number">03</span> +<span class="hljs-number">0800</span>
Engine • hash <span class="hljs-number">6</span>b24e1b529bc46df7ff397667502719a2a8b6b72 (revision <span class="hljs-number">035316565</span>a) (<span class="hljs-number">3</span> months ago) • <span class="hljs-number">2025</span>-<span class="hljs-number">10</span>-<span class="hljs-number">21</span> <span class="hljs-number">14</span>:<span class="hljs-number">28</span>:<span class="hljs-number">01.000</span>Z
Tools • Dart <span class="hljs-number">3.9</span>.<span class="hljs-number">2</span> • DevTools <span class="hljs-number">2.48</span>.<span class="hljs-number">0</span>
</code></pre>
<h3 data-id="heading-5">二、全新配置：拉取OpenHarmony版Flutter仓库</h3>
<p>若你还未拉取过 Flutter-OH 3.35.7 对应的仓库，可通过以下步骤直接拉取 <code>oh-3.35.7-dev</code> 分支代码，全程无需登录AtomGit，公开仓库可直接访问。</p>
<h4 data-id="heading-6">1. 切换本地存放目录</h4>
<p>打开终端（Windows用PowerShell、Mac/Linux用Terminal），切换到你想要存放仓库的目录（示例为桌面，可根据自身需求修改）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Windows（PowerShell）</span>
<span class="hljs-built_in">cd</span> C:\Users\你的用户名\Desktop
​
<span class="hljs-comment"># Mac/Linux</span>
<span class="hljs-built_in">cd</span> ~/Desktop
</code></pre>
<h4 data-id="heading-7">2. 克隆指定分支仓库</h4>
<p>执行以下Git命令，直接拉取 <code>oh-3.35.7-dev</code> 分支（避免拉取默认分支导致版本不符）：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> -b oh-3.35.7-dev https://atomgit.com/openharmony-tpc/flutter_flutter.git
</code></pre>
<p><strong>命令简单说明</strong>：</p>
<ul>
<li><code>clone</code>：将远程仓库完整克隆到本地；</li>
<li><code>-b oh-3.35.7-dev</code>：指定克隆的目标分支；</li>
<li>后续URL为官方AtomGit仓库地址，确保代码来源可靠。</li>
</ul>
<h4 data-id="heading-8">3. 验证拉取结果</h4>
<p>克隆完成后，本地目标目录会生成 <code>flutter_flutter</code> 文件夹，进入该文件夹并检查当前分支，确认拉取无误：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入仓库目录</span>
<span class="hljs-built_in">cd</span> flutter_flutter
<span class="hljs-comment"># 查看当前分支</span>
git branch
</code></pre>
<p>终端输出 <code>* oh-3.35.7-dev</code> 即表示拉取成功，当前已处于正确的开发分支。</p>
<h3 data-id="heading-9">三、开发必备：定期同步最新代码</h3>
<p>由于 <code>oh-3.35.7-dev</code> 是<strong>开发分支</strong>，官方会每日进行bug修复、问题优化，为了避免开发中遇到已解决的问题，建议大家<strong>每次开发前/定期</strong>在 <code>flutter_flutter</code> 目录下执行以下命令，同步仓库最新更新：</p>
<pre><code class="hljs">git pull
</code></pre>
<p>同步完成后，即可基于最新的Flutter-OH 3.35.7版本进行OpenHarmony相关开发，保证开发环境的稳定性。</p>
<p>拉取并配置好最新环境后，即可正常进行Flutter-OH的开发工作，祝大家开发顺利！</p>
<p>仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fatomgit.com%2Fopenharmony-tpc%2Fflutter_flutter%2Ftree%2Foh-3.35.7-dev" target="_blank" title="https://atomgit.com/openharmony-tpc/flutter_flutter/tree/oh-3.35.7-dev" ref="nofollow noopener noreferrer">atomgit.com/openharmony…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026架构预演：别再卷微服务了，你的系统缺一个“AI Agent指挥官”]]></title>    <link>https://juejin.cn/post/7598083101361192966</link>    <guid>https://juejin.cn/post/7598083101361192966</guid>    <pubDate>2026-01-23T02:41:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598083101361192966" data-draft-id="7598112768146931718" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026架构预演：别再卷微服务了，你的系统缺一个“AI Agent指挥官”"/> <meta itemprop="keywords" content="人工智能,阿里巴巴"/> <meta itemprop="datePublished" content="2026-01-23T02:41:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="郁垒Iii"/> <meta itemprop="url" content="https://juejin.cn/user/4443568362490122"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026架构预演：别再卷微服务了，你的系统缺一个“AI Agent指挥官”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4443568362490122/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    郁垒Iii
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T02:41:39.000Z" title="Fri Jan 23 2026 02:41:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>摘要</strong>：当单体智能体（Single Agent）向多智能体协作（Multi-Agent）演进时，我们遭遇了前所未有的“治理危机”。死循环、上下文污染、意图冲突......这些问题不是靠换个更强的大模型能解决的。本文将从架构视角推演，为何在2026年的技术栈中，**“AI Agent指挥官”**将取代传统的API网关和BPM引擎，成为新的系统心脏。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/457a0072f0f94431a8f28462e0e9f104~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YOB5Z6SSWlp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769740899&amp;x-signature=70Q85wD%2BtZIvVNMzTWPRjjwXoGE%3D" alt="a0d61d9720a8722b5f7c57cc657f2f67.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-0">引言：从“胶水代码”到“认知编排”</h3>
<p>站在2026年的视角回望，2024-2025年是我们从“Prompt工程”转向“Agent工程”的关键两年。</p>
<p>在过去的微服务架构中，为了串联业务，后端工程师写了无数的**“胶水代码” <strong>（Glue Code）和硬编码的</strong>编排逻辑**（Orchestration Logic）。</p>
<ul>
<li><em>“如果库存不足，则调用推荐服务；如果库存充足，则调用物流服务。”</em></li>
</ul>
<p>这种确定性的逻辑在AI时代显得僵化且脆弱。当我们试图让多个垂直领域的Agent（如：SQL专家、文案专家、数据分析师）协同工作时，如果缺乏一个统一的调度中心，系统很快就会退化成一群“吵架的实习生”。</p>
<p>这就是为什么，架构升级的重心正在从“微服务治理”转向**“智能体编排”**。而这个架构的核心，就是 <strong>AI Agent指挥官（AI Orchestrator）</strong> 。</p>
<hr/>
<h3 data-id="heading-1">一、 为什么多Agent系统会陷入“无政府状态”？</h3>
<p>在掘金社区，很多开发者已经尝试过 AutoGen 或 MetaGPT。大家发现了一个共性问题：<strong>Token 消耗巨大，但产出不可控。</strong></p>
<p>如果没有一个强有力的指挥官，多智能体系统（MAS）面临三大架构熵增：</p>
<ol>
<li>
<p><strong>死锁与循环（Infinite Loops）</strong></p>
<ul>
<li>Agent A：“我需要更多数据。”</li>
<li>Agent B：“请明确你需要什么数据。”</li>
<li>Agent A：“就是刚才那个数据。”</li>
<li><em>结果：两个Agent在无效对话中烧光了你的Token配额。</em></li>
</ul>
</li>
<li>
<p><strong>幻觉放大（Hallucination Cascade）</strong></p>
<ul>
<li>上游Agent的一个微小事实错误，被下游Agent当做“真理”进行推理，最终导致输出结果离题万里。</li>
</ul>
</li>
<li>
<p><strong>资源争夺（Resource Contention）</strong></p>
<ul>
<li>多个Agent试图同时修改同一个数据库记录，或者并发调用同一个限流API。</li>
</ul>
</li>
</ol>
<p><strong>结论：</strong> 去中心化的自组织（Self-Organization）在现阶段是乌托邦。企业级应用需要<strong>中心化的“AI Agent指挥官”</strong> 。</p>
<hr/>
<h3 data-id="heading-2">二、 架构定义：AI Agent指挥官的核心职责</h3>
<p><strong>AI Agent指挥官</strong>不是一个具体的LLM，而是一种<strong>架构模式（Pattern）</strong> 。它通常是一个经过指令微调（Instruction Tuned）的高智商模型（如 GPT-4o 或 Claude 3.5 Sonnet），负责以下核心任务：</p>
<h4 data-id="heading-3">1. 动态规划与DAG生成 (Dynamic Planning)</h4>
<p>指挥官不直接干活，它负责将模糊的用户需求（User Intent）拆解为<strong>有向无环图（DAG）</strong> 。</p>
<ul>
<li>
<p><strong>输入</strong>：“帮我分析竞品X的Q3财报，并写一篇对比软文。”</p>
</li>
<li>
<p><strong>指挥官拆解</strong>：</p>
<ol>
<li>[搜索Agent] -&gt; 下载财报PDF。</li>
<li>[分析Agent] -&gt; 提取关键财务指标（并行执行）。</li>
<li>[写作Agent] -&gt; 基于指标生成文章。</li>
<li>[审核Agent] -&gt; 检查合规性。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-4">2. 语义路由 (Semantic Routing)</h4>
<p>这是取代传统API网关的关键。指挥官利用 <strong>LLM-as-a-Router</strong> 机制，根据语义相似度，将任务分发给最合适的子Agent或工具（Tools）。</p>
<p>Python</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 伪代码示例：基于语义的路由逻辑</span>
async def agent_commander(user_query):
    <span class="hljs-attr">plan</span> = await planner_llm.generate_plan(user_query)
    
    for task in plan.steps:
        <span class="hljs-comment"># 路由决策：谁最擅长这个任务？</span>
        <span class="hljs-attr">selected_agent</span> = await router.select(
            task.description, 
            <span class="hljs-attr">candidates</span>=[sales_agent, coder_agent, data_agent]
        )
        
        <span class="hljs-attr">result</span> = await selected_agent.execute(task)
        <span class="hljs-comment"># 状态更新到全局黑板</span>
        blackboard.update(result)
</code></pre>
<h4 data-id="heading-5">3. 记忆与状态管理 (Memory &amp; State)</h4>
<p>指挥官维护着全局的**“黑板”（Blackboard Pattern）**。子Agent是无状态的，用完即走；只有指挥官拥有“长短期记忆”，它知道任务进行到了哪一步，也知道之前的Agent犯了什么错。</p>
<hr/>
<h3 data-id="heading-6">三、 2026架构图谱：ReAct 模式的升级</h3>
<p>在2026年的架构蓝图中，我们不再单纯依赖 ReAct（Reason + Act）循环，而是升级为 <strong>SOP（标准作业程序）驱动的指挥官架构</strong>。</p>
<ul>
<li>
<p><strong>感知层（Perception）</strong> ：多模态输入，指挥官不仅听懂文字，还能看懂图表和代码。</p>
</li>
<li>
<p><strong>中枢层（The Commander）</strong> ：</p>
<ul>
<li><strong>SOP 注入</strong>：企业将业务流程（如退款流程、代码Review流程）写入指挥官的 System Prompt。</li>
<li><strong>人机回环（Human-in-the-loop）</strong> ：指挥官在关键节点（如转账、删库）必须挂起任务，请求人类批准。</li>
</ul>
</li>
<li>
<p><strong>执行层（Worker Agents）</strong> ：专精的小模型（Small Language Models），成本低、响应快，只负责单一任务（如 SQL生成、正则提取）。</p>
</li>
</ul>
<p><strong>这种架构实现了“高智商指挥（大模型） + 高效率执行（小模型）”的完美平衡。</strong></p>
<hr/>
<h3 data-id="heading-7">四、 给开发者的建议：如何补上这块拼图？</h3>
<p>如果你想在2026年的技术浪潮中站稳脚跟，现在就要开始转变思维：</p>
<ol>
<li><strong>停止手写 <code>if-else</code> 路由</strong>：尝试使用 Semantic Kernel 或 LangChain 的 RouterChain，学习如何用语义控制流程。</li>
<li><strong>定义清晰的 Agent 接口</strong>：未来的 API 文档不是写给人的，是写给 AI 指挥官看的。Schema 的描述越精准，指挥官的调度就越稳定。</li>
<li><strong>关注可观测性（Observability）</strong> ：当逻辑由 AI 动态生成时，你需要更强的 Trace 工具（如 LangSmith）来监控指挥官的决策路径。</li>
</ol>
<h3 data-id="heading-8">五、 结语</h3>
<p>软件工程的本质是控制复杂度。</p>
<p>微服务时代，我们用网络通信换取了开发的解耦； <strong>智能体时代，我们将用“AI Agent指挥官”换取业务的自适应。</strong></p>
<p>未来的架构师，不再是画静态拓扑图的人，而是设计<strong>AI协作规则</strong>的人。你的系统里，缺的不是算力，而是一位能统领千军万马的指挥官。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[那些年我们追过的 ECMAScript]]></title>    <link>https://juejin.cn/post/7598130716339126310</link>    <guid>https://juejin.cn/post/7598130716339126310</guid>    <pubDate>2026-01-23T03:27:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598130716339126310" data-draft-id="7598043378018959369" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="那些年我们追过的 ECMAScript"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-23T03:27:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xuyanzhuqing"/> <meta itemprop="url" content="https://juejin.cn/user/4235764156872295"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            那些年我们追过的 ECMAScript
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4235764156872295/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xuyanzhuqing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:27:17.000Z" title="Fri Jan 23 2026 03:27:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript 从 ES2015 到 ES2026 的核心更新梳理</h2>
<h3 data-id="heading-1">ES2015 (ES6) - 里程碑式更新</h3>
<p>这是 JS 史上最重大的一次更新，重构了语言核心语法和特性：</p>
<ol>
<li>
<p><strong>块级作用域与声明</strong></p>
<ol>
<li>
<p><code>let</code>/<code>const</code>：替代 <code>var</code>，提供块级作用域，<code>const</code> 声明只读常量</p>
</li>
<li>
<p>示例：</p>
<ul>
<li>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">PI</span> = <span class="hljs-number">3.14159</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">count</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
if (true) {
  let <span class="hljs-attr">count</span> = <span class="hljs-number">1</span><span class="hljs-comment">; // 块内独立作用域</span>
  console.log(count)<span class="hljs-comment">; // 1</span>
}
console.log(count)<span class="hljs-comment">; // 0</span>
</code></pre>
</li>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>箭头函数</strong>：简化函数写法，绑定词法 <code>this</code></p>
<ol>
<li>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;
<span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"JS"</span>,
  <span class="hljs-attr">sayHi</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>) <span class="hljs-comment">// 箭头函数this指向外层（全局）</span>
};
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>类与模块</strong></p>
<ol>
<li><code>class</code> 语法：简化原型链编程</li>
<li><code>import</code>/<code>export</code>：模块化标准</li>
<li>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模块导出</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> name = <span class="hljs-string">"ES6"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
}
<span class="hljs-comment">// 模块导入</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Person</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module.js'</span>;
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>解构赋值</strong>：快速提取对象/数组数据</p>
<ol>
<li>
<pre><code class="hljs language-css" lang="css">const <span class="hljs-selector-attr">[a, b]</span> = <span class="hljs-selector-attr">[1, 2]</span>;
const { name, age } = { name: <span class="hljs-string">"Tom"</span>, age: <span class="hljs-number">20</span> };
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>其他核心特性</strong>：模板字符串 <code>`hello ${name}`</code>、默认参数、扩展运算符 <code>...</code>、<code>Promise</code>、<code>Map/Set</code> 等。</p>
</li>
</ol>
<h3 data-id="heading-2">ES2016 (ES7) - 小版本增量更新</h3>
<ol>
<li>
<p><strong>数组</strong> <strong><code>includes()</code></strong> <strong>方法</strong>：替代 <code>indexOf</code> 判断元素是否存在（支持 <code>NaN</code>）</p>
<ol>
<li>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[1, 2, NaN]</span><span class="hljs-selector-class">.includes</span>(NaN); <span class="hljs-comment">// true</span>
<span class="hljs-selector-attr">[1, 2, NaN]</span><span class="hljs-selector-class">.indexOf</span>(NaN); <span class="hljs-comment">// -1</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>幂运算符</strong> <strong><code>**</code></strong> ：替代 <code>Math.pow()</code></p>
<ol>
<li>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">2</span> ** <span class="hljs-number">3</span>; <span class="hljs-comment">// 8 等同于 Math.pow(2, 3)</span>
</code></pre>
</li>
</ol>
</li>
</ol>
<h3 data-id="heading-3">ES2017 (ES8)</h3>
<ol>
<li>
<p><strong><code>async/await</code></strong>：异步编程终极方案，简化 Promise 链式调用</p>
<ol>
<li>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>);
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();
    <span class="hljs-keyword">return</span> data;
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
  }
}
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>对象扩展</strong></p>
<ol>
<li><code>Object.values()</code>/<code>Object.entries()</code>：获取对象值/键值对数组</li>
<li><code>Object.getOwnPropertyDescriptors()</code>：获取对象属性完整描述</li>
<li>
<pre><code class="hljs language-css" lang="css">const obj = { <span class="hljs-selector-tag">a</span>: <span class="hljs-number">1</span>, b: <span class="hljs-number">2</span> };
<span class="hljs-selector-tag">Object</span><span class="hljs-selector-class">.values</span>(obj); // <span class="hljs-selector-attr">[1, 2]</span>
<span class="hljs-selector-tag">Object</span><span class="hljs-selector-class">.entries</span>(obj); // <span class="hljs-selector-attr">[[<span class="hljs-string">'a'</span>, 1]</span>, <span class="hljs-selector-attr">[<span class="hljs-string">'b'</span>, 2]</span>]
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>字符串填充</strong>：<code>padStart()</code>/<code>padEnd()</code></p>
<ol>
<li>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-string">'123'</span>.padStart(<span class="hljs-number">5</span>, <span class="hljs-string">'0'</span>); <span class="hljs-regexp">//</span> <span class="hljs-string">'00123'</span>
<span class="hljs-string">'123'</span>.padEnd(<span class="hljs-number">5</span>, <span class="hljs-string">'0'</span>); <span class="hljs-regexp">//</span> <span class="hljs-string">'12300'</span>
</code></pre>
</li>
</ol>
</li>
</ol>
<h3 data-id="heading-4">ES2018 (ES9)</h3>
<ol>
<li>
<p><strong>异步迭代器</strong>：<code>for await...of</code> 遍历异步可迭代对象</p>
<ol>
<li>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processAsyncData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> asyncIterable = {
    [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">asyncIterator</span>]() {
      <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">return</span> {
        <span class="hljs-title function_">next</span>(<span class="hljs-params"/>) {
          <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">3</span>) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>({ <span class="hljs-attr">value</span>: i++, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> });
          <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>({ <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> });
        }
      };
    }
  };
  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> num <span class="hljs-keyword">of</span> asyncIterable) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num); <span class="hljs-comment">// 0, 1, 2</span>
  }
}
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>正则扩展</strong>：反向断言、<code>dotAll</code> 模式（<code>.</code> 匹配任意字符）</p>
<ol>
<li>
<pre><code class="hljs language-ruby" lang="ruby">/<span class="hljs-regexp">/ 后行断言
/</span>(<span class="hljs-string">?&lt;</span>=<span class="hljs-variable">$)</span>\d+<span class="hljs-regexp">/.exec('$100'); /</span><span class="hljs-regexp">/ ['100']
/</span><span class="hljs-regexp">/ dotAll 模式
/a</span>.b/s.test(<span class="hljs-string">'a\nb'</span>); <span class="hljs-regexp">//</span> <span class="hljs-literal">true</span>（默认模式下为 <span class="hljs-literal">false</span>）
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>对象扩展运算符</strong>：<code>...</code> 解构/合并对象</p>
<ol>
<li>
<pre><code class="hljs language-css" lang="css">const obj1 = { <span class="hljs-selector-tag">a</span>: <span class="hljs-number">1</span> };
const obj2 = { ..<span class="hljs-selector-class">.obj1</span>, <span class="hljs-selector-tag">b</span>: <span class="hljs-number">2</span> }; // { <span class="hljs-selector-tag">a</span>: <span class="hljs-number">1</span>, b: <span class="hljs-number">2</span> }
</code></pre>
</li>
</ol>
</li>
</ol>
<h3 data-id="heading-5">ES2019 (ES10)</h3>
<ol>
<li>
<p><strong>数组方法扩展</strong></p>
<ol>
<li><code>Array.prototype.flat()</code>：扁平化数组（默认1层）</li>
<li><code>Array.prototype.flatMap()</code>：<code>map + flat</code> 组合</li>
<li>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[1, [2, [3]]]</span>.flat(2)<span class="hljs-comment">; // [1, 2, 3]</span>
<span class="hljs-section">[1, 2, 3]</span>.flatMap(<span class="hljs-attr">x</span> =&gt; [x * <span class="hljs-number">2</span>])<span class="hljs-comment">; // [2, 4, 6]</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>字符串</strong> <strong><code>trimStart()</code></strong> <strong>/</strong> <strong><code>trimEnd()</code></strong> ：替代 <code>trimLeft()</code>/<code>trimRight()</code>，语义更清晰</p>
</li>
<li>
<p><strong><code>Object.fromEntries()</code></strong> ：将键值对数组转回对象（<code>Object.entries</code> 反向操作）</p>
<ol>
<li>
<pre><code class="hljs language-css" lang="css">const arr = <span class="hljs-selector-attr">[[<span class="hljs-string">'a'</span>, 1]</span>, <span class="hljs-selector-attr">[<span class="hljs-string">'b'</span>, 2]</span>];
<span class="hljs-selector-tag">Object</span><span class="hljs-selector-class">.fromEntries</span>(arr); // { <span class="hljs-selector-tag">a</span>: <span class="hljs-number">1</span>, b: <span class="hljs-number">2</span> }
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>可选捕获绑定</strong>：<code>try/catch</code> 中 <code>catch</code> 可以省略参数</p>
<ol>
<li>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// 可能出错的代码</span>
} <span class="hljs-keyword">catch</span> { <span class="hljs-comment">// 无需写 (err)</span>
  <span class="hljs-comment">// 处理错误（无需使用err参数时）</span>
}
</code></pre>
</li>
</ol>
</li>
</ol>
<h3 data-id="heading-6">ES2020 (ES11)</h3>
<ol>
<li>
<p><strong>可选链操作符</strong> <strong><code>?.</code></strong> ：避免访问嵌套对象属性时的 <code>Cannot read property 'xxx' of undefined</code> 错误</p>
<ol>
<li>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> obj = { a: { b: <span class="hljs-number">1</span> } };
console.<span class="hljs-built_in">log</span>(obj?.a?.b); <span class="hljs-comment">// 1</span>
console.<span class="hljs-built_in">log</span>(obj?.c?.d); <span class="hljs-comment">// undefined（不会报错）</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>空值合并运算符</strong> <strong><code>??</code></strong> ：仅当左侧为 <code>null/undefined</code> 时返回右侧（区别于 <code>||</code>）</p>
<ol>
<li>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">0</span> <span class="hljs-string">??</span> <span class="hljs-number">1</span>; <span class="hljs-regexp">//</span> <span class="hljs-number">0</span>（|<span class="hljs-params"/>| 会返回<span class="hljs-number">1</span>）
null <span class="hljs-string">??</span> <span class="hljs-number">1</span>; <span class="hljs-regexp">//</span> <span class="hljs-number">1</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong><code>BigInt</code></strong>：支持超大整数运算（超出 <code>Number.MAX_SAFE_INTEGER</code> 范围）</p>
<ol>
<li>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">bigNum</span> = <span class="hljs-number">9007199254740991</span>n + <span class="hljs-number">2</span>n<span class="hljs-comment">; // 9007199254740993n</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong><code>import()</code></strong> <strong>动态导入</strong>：按需加载模块（返回 Promise）</p>
<ol>
<li>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadModule</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./module.js'</span>);
  <span class="hljs-variable language_">module</span>.<span class="hljs-title function_">doSomething</span>();
}
</code></pre>
</li>
</ol>
</li>
</ol>
<h3 data-id="heading-7">ES2021 (ES12)</h3>
<ol>
<li>
<p><strong>数字分隔符</strong> <strong><code>_</code></strong> ：提升大数字可读性</p>
<ol>
<li>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">billion</span> = <span class="hljs-number">1_000_000_000</span><span class="hljs-comment">; // 等同于 1000000000</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong><code>String.prototype.replaceAll()</code></strong> ：替换所有匹配项（无需正则全局标志）</p>
<ol>
<li>
<pre><code class="hljs language-css" lang="css">'<span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">b</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">b</span>'<span class="hljs-selector-class">.replaceAll</span>('<span class="hljs-selector-tag">a</span>', 'x'); // 'x <span class="hljs-selector-tag">b</span> x <span class="hljs-selector-tag">b</span>'
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong><code>Promise.any()</code></strong> ：只要有一个 Promise 成功就返回（区别于 <code>Promise.race</code>）</p>
<ol>
<li>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">any</span>([<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-number">1</span>), <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">2</span>)])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)); <span class="hljs-comment">// 2</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>逻辑赋值运算符</strong>：<code>&amp;&amp;=</code>、<code>||=</code>、<code>??=</code></p>
<ol>
<li>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">a</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
a ||= 1<span class="hljs-comment">; // 1（等同于 a = a || 1）</span>
let <span class="hljs-attr">b</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
b &amp;&amp;= 3<span class="hljs-comment">; // 3（等同于 b = b &amp;&amp; 3）</span>
let <span class="hljs-attr">c</span> = null<span class="hljs-comment">;</span>
c ??= 4<span class="hljs-comment">; // 4（等同于 c = c ?? 4）</span>
</code></pre>
</li>
</ol>
</li>
</ol>
<h3 data-id="heading-8">ES2022 (ES13)</h3>
<ol>
<li>
<p><strong>类字段声明</strong>：支持在类中直接声明实例/静态字段（无需在 constructor 中赋值）</p>
<ol>
<li>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
  name = <span class="hljs-string">'Tom'</span>; <span class="hljs-comment">// 实例字段</span>
  <span class="hljs-keyword">static</span> age = <span class="hljs-number">20</span>; <span class="hljs-comment">// 静态字段</span>
  #privateField = <span class="hljs-string">'私有值'</span>; <span class="hljs-comment">// 私有字段（# 开头）</span>
  
  <span class="hljs-title function_">getPrivate</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.#privateField;
  }
}
<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.<span class="hljs-property">name</span>); <span class="hljs-comment">// Tom</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property">age</span>); <span class="hljs-comment">// 20</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.#privateField); <span class="hljs-comment">// 报错（无法访问私有字段）</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong><code>at()</code></strong> <strong>方法</strong>：支持数组/字符串负索引访问</p>
<ol>
<li>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<span class="hljs-comment">;</span>
arr.at(-1)<span class="hljs-comment">; // 3（最后一个元素）</span>
'hello'.at(-2)<span class="hljs-comment">; // 'l'</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong><code>Object.hasOwn()</code></strong> ：替代 <code>Object.prototype.hasOwnProperty.call()</code>，更安全</p>
<ol>
<li>
<pre><code class="hljs language-css" lang="css">const obj = { <span class="hljs-selector-tag">a</span>: <span class="hljs-number">1</span> };
<span class="hljs-selector-tag">Object</span><span class="hljs-selector-class">.hasOwn</span>(obj, '<span class="hljs-selector-tag">a</span>'); // true
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>Top-level</strong> <strong><code>await</code></strong>：模块顶层可直接使用 await（无需包裹 async 函数）</p>
<ol>
<li>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// module.js</span>
<span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>());
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> data;
</code></pre>
</li>
</ol>
</li>
</ol>
<h3 data-id="heading-9">ES2023 (ES14)</h3>
<ol>
<li>
<p><strong>数组方法扩展</strong>：<code>findLast()</code>/<code>findLastIndex()</code>（从后往前查找）</p>
<ol>
<li>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]<span class="hljs-comment">;</span>
arr.findLast(<span class="hljs-attr">x</span> =&gt; x === <span class="hljs-number">2</span>)<span class="hljs-comment">; // 2（最后一个2）</span>
arr.findLastIndex(<span class="hljs-attr">x</span> =&gt; x === <span class="hljs-number">2</span>)<span class="hljs-comment">; // 3</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong><code>Array.fromAsync()</code></strong> ：从异步可迭代对象创建数组</p>
<ol>
<li>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> asyncIterable = (<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* () {
    <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>;
  })();
  <span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">fromAsync</span>(asyncIterable);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1, 2]</span>
}
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>WeakMap 支持 Symbol 键</strong>：此前仅支持对象键</p>
</li>
</ol>
<h3 data-id="heading-10">ES2024 (ES15)</h3>
<ol>
<li>
<p><strong><code>Promise.withResolvers()</code></strong> ：简化 Promise 手动创建（替代手动声明 resolve/reject）</p>
<ol>
<li>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 旧写法</span>
<span class="hljs-keyword">const</span> promise1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-comment">// 逻辑</span>
});
<span class="hljs-comment">// 新写法</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">promise</span>: promise2, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>正则</strong> <strong><code>/v</code></strong> <strong>标志（Unicode 属性转义扩展）</strong> ：更精准匹配 Unicode 字符</p>
<ol>
<li>
<pre><code class="hljs language-ini" lang="ini">// 匹配所有中文（更精准）
/\p{<span class="hljs-attr">Script</span>=Han}/v.test(<span class="hljs-string">'中文'</span>)<span class="hljs-comment">; // true</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong><code>Array.prototype.toReversed()</code></strong> <strong>/</strong> <strong><code>toSorted()</code></strong> <strong>/</strong> <strong><code>toSpliced()</code></strong> ：非破坏性数组方法（原数组不变）</p>
<ol>
<li>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">sortedArr</span> = arr.toSorted()<span class="hljs-comment">; // [1, 2, 3]</span>
console.log(arr)<span class="hljs-comment">; // [3, 1, 2]（原数组未变）</span>
</code></pre>
</li>
</ol>
</li>
</ol>
<h3 data-id="heading-11">ES2025 (ES16) - 已定稿特性</h3>
<ol>
<li>
<p><strong><code>Object.groupBy()</code></strong> ：按条件分组对象/数组（替代手动遍历分组）</p>
<ol>
<li>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">grouped</span> = Object.groupBy(arr, num =&gt; num % <span class="hljs-number">2</span> === <span class="hljs-number">0</span> ? <span class="hljs-string">'even'</span> : <span class="hljs-string">'odd'</span>)<span class="hljs-comment">;</span>
// { odd: <span class="hljs-section">[1, 3, 5]</span>, even: <span class="hljs-section">[2, 4]</span> }
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong><code>String.prototype.isWellFormed()</code></strong> <strong>/</strong> <strong><code>toWellFormed()</code></strong> ：处理无效 Unicode 字符</p>
<ol>
<li>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">const</span> <span class="hljs-type">str</span> = <span class="hljs-string">'\ud800'</span>; <span class="hljs-comment">// 无效 Unicode</span>
<span class="hljs-type">str</span>.<span class="hljs-title function_ invoke__">isWellFormed</span>(); <span class="hljs-comment">// false</span>
<span class="hljs-type">str</span>.<span class="hljs-title function_ invoke__">toWellFormed</span>(); <span class="hljs-comment">// '\ufffd'（替换为替换字符）</span>
</code></pre>
</li>
</ol>
</li>
</ol>
<h3 data-id="heading-12">ES2026 (ES17) - 候选/提案阶段核心特性</h3>
<p>（注：ES2026 尚未最终定稿，以下是当前进入 Stage 3+ 的核心提案）</p>
<ol>
<li>
<p><strong>管道运算符</strong> <strong><code>|&gt;</code></strong> ：简化函数调用链（替代嵌套调用）</p>
<ol>
<li>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 旧写法</span>
const result = <span class="hljs-built_in">multiply</span>(add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>), <span class="hljs-number">3</span>); <span class="hljs-comment">// 9</span>
<span class="hljs-comment">// 新写法</span>
const result = <span class="hljs-number">1</span> |&gt; <span class="hljs-built_in">add</span>(<span class="hljs-number">2</span>) |&gt; <span class="hljs-built_in">multiply</span>(<span class="hljs-number">3</span>); <span class="hljs-comment">// 9</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong><code>Record</code></strong> <strong>/</strong> <strong><code>Tuple</code></strong>：不可变数据类型（Record 是不可变对象，Tuple 是不可变数组）</p>
<ol>
<li>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> record = #{ name: <span class="hljs-string">'Tom'</span>, age: <span class="hljs-number">20</span> }; <span class="hljs-comment">// 不可变Record</span>
<span class="hljs-type">const</span> tuple = #[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]; <span class="hljs-comment">// 不可变Tuple</span>
tuple.<span class="hljs-built_in">push</span>(<span class="hljs-number">4</span>); <span class="hljs-comment">// 报错（不可变）</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong><code>do</code></strong> <strong>表达式</strong>：将语句块转为表达式（可在赋值/返回中使用）</p>
<ol>
<li>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">const</span> value = <span class="hljs-keyword">do</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">num</span> &gt; <span class="hljs-number">10</span>) <span class="hljs-string">'big'</span>;
  <span class="hljs-keyword">else</span> <span class="hljs-string">'small'</span>;
};
</code></pre>
</li>
</ol>
</li>
</ol>
<h4 data-id="heading-13">总结</h4>
<ol>
<li><strong>核心演进逻辑</strong>：ES2015 奠定现代 JS 基础，后续版本以“增量更新”为主，聚焦<strong>简化开发</strong>（如 <code>async/await</code>、可选链）、<strong>增强安全性</strong>（如私有字段、<code>Object.hasOwn</code>）、<strong>提升可读性</strong>（如数字分隔符、管道运算符）、<strong>完善异步编程</strong>（如异步迭代、<code>Promise.any</code>）。</li>
<li><strong>高频实用特性</strong>：日常开发中最常用的特性集中在 ES2015（<code>let/const</code>、箭头函数、解构）、ES2017（<code>async/await</code>）、ES2020（可选链、空值合并）、ES2022（类字段、<code>at()</code>）。</li>
<li><strong>未来趋势</strong>：ES2026 重点探索<strong>不可变数据</strong>（<code>Record/Tuple</code>）和<strong>语法简化</strong>（管道运算符），进一步提升代码的可维护性和性能。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[css布局篇——两栏布局（无废话版）]]></title>    <link>https://juejin.cn/post/7598104596779630638</link>    <guid>https://juejin.cn/post/7598104596779630638</guid>    <pubDate>2026-01-23T03:28:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598104596779630638" data-draft-id="7598021081988169779" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="css布局篇——两栏布局（无废话版）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-23T03:28:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户77230783637"/> <meta itemprop="url" content="https://juejin.cn/user/235730826174362"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            css布局篇——两栏布局（无废话版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/235730826174362/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户77230783637
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:28:33.000Z" title="Fri Jan 23 2026 03:28:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h3 data-id="heading-0">核心思路</h3>
<p>一般两栏布局指的是<strong>左边一栏宽度固定，右边一栏宽度自适应</strong></p>
<h3 data-id="heading-1">第一种方法</h3>
<ul>
<li>浮动 + margin-left(将左边元素宽度设置为200px，并且设置向左浮动。将右边元素的margin-left设置为200px)</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span> = <span class="hljs-string">"box"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span> = <span class="hljs-string">"left"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span> = <span class="hljs-string">"right"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  我是文字
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css">&lt;style&gt;
    <span class="hljs-selector-class">.left</span>{
        <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
        <span class="hljs-attribute">height</span>: <span class="hljs-number">400px</span>;
        <span class="hljs-attribute">background-color</span>: orange;
        <span class="hljs-attribute">float</span> <span class="hljs-selector-pseudo">:left</span>;
  }
    <span class="hljs-selector-class">.right</span>{
        <span class="hljs-attribute">height</span>: <span class="hljs-number">300px</span>;
        <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">200px</span>;
        <span class="hljs-attribute">background-color</span>: yellowgreen;
    }
&lt;/style&gt;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e03e3e0e6524d1faa7efa34ae91c240~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzcyMzA3ODM2Mzc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743712&amp;x-signature=8t6P2kT3aDEyBM1q5tTjr%2FNrV70%3D" alt="image.png" loading="lazy"/></p>
<p>oh my god 下面的其他内容怎么跑上去了？  是因为我们使用了<strong>浮动</strong>。</p>
<h4 data-id="heading-2">啥是浮动？</h4>
<p>浮动会导致元素脱离原来普通的文档流。元素可以向左或者向右浮动，直到碰到父容器或其他浮动元素才停下。在原来的文档流里，它就像被 “删掉” 了一样，不占位置。这样一来，父元素就会因为没东西撑着，高度变成 0，出现<strong>高度塌陷</strong>，后面的内容也会自动往上跑，跟浮动元素叠在一起。</p>
<p>解决办法：</p>
<ul>
<li>BFC，块级格式化上下文，BFC 规定了内部的块级元素的布局方式。常见的做法是为父元素添加：</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">overflow</span>:hidden;
</code></pre>
<h4 data-id="heading-3">啥是BFC</h4>
<p>块格式化上下文（Block Formatting Context，BFC），是Web页面的可视化CSS渲染的一部分，是布局过程中生成块级盒子的区域，也是浮动元素与其他元素的交互限定区域。</p>
<h4 data-id="heading-4">BFC的特点</h4>
<ul>
<li>垂直方向上，自上而下排列，和文档流的排列方式一致。</li>
<li>在BFC中上下相邻的两个容器的margin会重叠</li>
<li>计算BFC的高度时，需要计算浮动元素的高度</li>
<li>BFC区域不会与浮动的容器发生重叠</li>
<li>BFC是独立的容器，容器内部元素不会影响外部元素</li>
<li>每个元素的左margin值和容器的左border相接触</li>
</ul>
<h6 data-id="heading-5">人话</h6>
<p>BFC就是一个独立的布局容器，内部元素自己玩自己的，不跟外面互相干扰，还能把浮动元素 “包住”，解决高度塌陷。</p>
<h4 data-id="heading-6">创建BFC的条件</h4>
<ul>
<li>根元素：body；</li>
<li>元素设置浮动：float 除 none 以外的值；</li>
<li>元素设置绝对定位：position (absolute、fixed)；</li>
<li>display 值为：inline-block、table-cell、table-caption、flex等；</li>
<li>overflow 值为：hidden、auto、scroll；</li>
</ul>
<h4 data-id="heading-7">创建BFC后的效果</h4>
<p>回归正题，我们实现两栏布局只需要为.box 元素添加样式：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">overflow</span>:hidden;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d97b0c608be4c49b1b0b6ddfb8e205d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzcyMzA3ODM2Mzc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743712&amp;x-signature=njeAhC%2BrjrSYrPhqUE%2Bvqbp2amY%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">第二种方法</h3>
<ul>
<li>利用flex布局，将左边元素设置为固定宽度200px，将右边的元素设置为flex:1。</li>
</ul>
<pre><code class="hljs language-css" lang="css">&lt;style&gt;
    <span class="hljs-selector-class">.box</span>{
        <span class="hljs-attribute">display</span>: flex;
    }
    <span class="hljs-selector-class">.left</span>{
        <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
        <span class="hljs-attribute">height</span>: <span class="hljs-number">400px</span>;
        <span class="hljs-attribute">background-color</span>: orange;    
  }
    <span class="hljs-selector-class">.right</span>{
        <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
        <span class="hljs-attribute">height</span>: <span class="hljs-number">300px</span>;
        <span class="hljs-attribute">background-color</span>: yellowgreen;
    }
&lt;/style&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Code 入门到 skill]]></title>    <link>https://juejin.cn/post/7598112768147243014</link>    <guid>https://juejin.cn/post/7598112768147243014</guid>    <pubDate>2026-01-23T03:11:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598112768147243014" data-draft-id="7598024433912447030" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code 入门到 skill"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-23T03:11:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="散步去海边"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919272135"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code 入门到 skill
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919272135/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    散步去海边
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:11:35.000Z" title="Fri Jan 23 2026 03:11:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Claude Code 是啥？</h2>
<p>Claude Code （简称 CC）是 A 厂在 8 月稳定发布的一款终端 agent 工具，他跟 cursor、windsurf 这些 IDE 不太一样</p>
<ul>
<li>
<p>CC 深度集成了操作系统提供的能力——terminal，高效实现任意 terminal 中支持的操作，例如，搜索文件、分析目录、执行脚本、安装软件等等</p>
</li>
<li>
<p>CC 对于代码仓库的分析和调用是直接使用终端命令（grep、cat...），而 IDE 是需要将整个仓库上传，导入 RAG 库之后进行重排、嵌入等操作，最终开发的时候，是从 RAG 查询代码信息</p>
</li>
<li>
<p>CC 是通用 agent ，理论上可以完成任何任务（剪视频、做PPT...），不仅仅只能用来编程</p>
</li>
</ul>
<h2 data-id="heading-1">安装</h2>
<p>使用时需要从终端进入，有下面两种安装方式</p>
<ol>
<li>
<p>安装 npm 包<code>npm install -g @anthropic-ai/claude-code</code></p>
</li>
<li>
<p>使用 <code>brew install --cask claude-code</code></p>
</li>
</ol>
<h3 data-id="heading-2">接入 LLM</h3>
<p>CC 在国内没有办法正常登录和购买使用，除非你有非常纯净且稳定的科学上网方式，但是价格非常贵。所以最佳的使用方式就是接入国产大模型，这里首推 GLM 4.7 和 kimi-k2-thinking 。本文以接入 GLM 4.7 为例。</p>
<p>首先需要下载一个社区开源项目，CC Switch （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffarion1231%2Fcc-switch%25EF%25BC%2589%25EF%25BC%258C%25E8%25BF%2599%25E4%25B8%25AA%25E8%25BD%25AF%25E4%25BB%25B6%25E4%25B8%2593%25E7%2594%25A8%25E4%25BA%258E%25E7%259B%25B4%25E8%25A7%2582%25E3%2580%2581%25E6%2596%25B9%25E4%25BE%25BF%25E7%259A%2584%25E7%25AE%25A1%25E7%2590%2586" target="_blank" title="https://github.com/farion1231/cc-switch%EF%BC%89%EF%BC%8C%E8%BF%99%E4%B8%AA%E8%BD%AF%E4%BB%B6%E4%B8%93%E7%94%A8%E4%BA%8E%E7%9B%B4%E8%A7%82%E3%80%81%E6%96%B9%E4%BE%BF%E7%9A%84%E7%AE%A1%E7%90%86" ref="nofollow noopener noreferrer">github.com/farion1231/…</a> CC 的 token 、mcp、skill、plugin 等功能配置项，使用起来也非常简单</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78154984a6b543d0b56e5e20c8c6d389~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWj5q2l5Y675rW36L65:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769742694&amp;x-signature=wGfGNsGSUDmhtONg7uheXuaceJE%3D" alt="" loading="lazy"/></p>
<p>然后进入智谱的 coding 套餐页面，购买一个 lite 套餐（非常够用了），创建一个 api key 。传送门：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bigmodel.cn%2Fglm-coding%3Fic%3DN3DZU9N6LG" target="_blank" title="https://www.bigmodel.cn/glm-coding?ic=N3DZU9N6LG" ref="nofollow noopener noreferrer">www.bigmodel.cn/glm-coding?…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c32b98c9e0f84bba8f4950ff9991b406~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWj5q2l5Y675rW36L65:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769742694&amp;x-signature=S8V3K%2FeoYfHKo0qyQSjDIO%2BSNbQ%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cbbdb759eb847a8b4289da85455cd5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWj5q2l5Y675rW36L65:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769742694&amp;x-signature=ublsr36p1%2FtO1jEaoqcNBByQihY%3D" alt="" loading="lazy"/></p>
<p>进入 CC Switch ，添加 GLM 配置</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bb444b1fab54f2096bf3eb86cd5493f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWj5q2l5Y675rW36L65:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769742694&amp;x-signature=kMH6%2BRt1xEoYywgdESVW5taWW1M%3D" alt="" loading="lazy"/></p>
<p>最后打开 iterm2 ，输入 <code>claude</code> 即可启动</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7c4da84f44245de8b1bdcfae7157ef6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWj5q2l5Y675rW36L65:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769742694&amp;x-signature=ih1LtuoE5A5m4ALxP7%2BEKHKDnPQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">命令</h3>
<h4 data-id="heading-4">claude --dangerously-skip-permissions</h4>
<p>通常来说在终端中使用 claude 命令来启动 CC ，但是实际跑任务的时候 CC 会频繁的请求权限，需要你一直盯着，手动确认，所以可以通过 <code>claude --dangerously-skip-permissions</code>直接进入危险模式，这个模式下 CC 的任何工具调用都会自动执行（有一定风险，取决于你在用 CC 干什么）</p>
<h4 data-id="heading-5">/init</h4>
<p>这个命令的使用场景是让 CC 分析并理解现有项目，执行完后，根目录会创建一个 CLAUDE.md 文件，内容就是 CC 对于当前项目的解读（其实也就是项目 rules ），这个会作为 CC 的长期记忆保留下来。 建议：项目变动频繁的话，定期让 CC 更新 CLAUDE.md ，能减少跑偏的情况</p>
<h4 data-id="heading-6">/memory</h4>
<p>这个命令用来给 CC 编写全局 rules、项目 rules</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a15e2e36b35d4425807b5237df55773c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWj5q2l5Y675rW36L65:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769742694&amp;x-signature=zYscqM%2FSAY2MIoFP%2Fucwu0byss4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6029187fa764e3296ca073db8ac48e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWj5q2l5Y675rW36L65:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769742694&amp;x-signature=qE0Byl75S0cqzfJcIluoQAnY1HA%3D" alt="" loading="lazy"/></p>
<p>然后在对话中还可以使用 # 命令，灵活的添加 memory 内容</p>
<h4 data-id="heading-7">/context &amp; /compact</h4>
<p>/context 用来查看当前上下文的占用情况</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/073781c35b134b4882c99eba308aa805~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWj5q2l5Y675rW36L65:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769742694&amp;x-signature=ceWkP2R%2FcUMM7wMKBox6GwLpu7I%3D" alt="" loading="lazy"/></p>
<p>Context 经常会用完，占用达到 100% 后，CC 会自动新开一个对话，通常这个时候之前的历史对话就不存在于 context 中了，如果是复杂任务跑到一半突然新开对话，CC 大概率不知道接下来该干什么，一定会跑偏。所以，可以用 /compact 手动压缩 context ，这个命令会对历史对话做一个摘要，释放出 context 占用</p>
<h4 data-id="heading-8">/mcp</h4>
<p>用来查看 CC 中已安装的 mcp</p>
<p>建议：</p>
<ol>
<li>别装太多 mcp ，它始终会存在于每次对话的上下文中</li>
<li>如果确实需要用到很多的 mcp，那么按照使用频率也可以将不常用的暂时先禁用掉</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e1fc30393bd420c92ed93e282cfbd33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWj5q2l5Y675rW36L65:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769742694&amp;x-signature=oWQUfObdpWcAo%2BMBnaKup25TPig%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">/resume</h4>
<p>继续之前的某个会话。这个场景是有时候中断对话了，CC 退出了，那么想继续之前的任务，就可以使用这个命令，CC 会列出所有会话历史，你选中一个就可以恢复了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0383d3fff3004d65895bd5b00fa45829~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWj5q2l5Y675rW36L65:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769742694&amp;x-signature=tn1KStOg6ayx8icRMhjmlgcEOY8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10">/rewind</h4>
<p>CC 每次输出一段消息并终止对话后，会自动创建一个消息还原点，通过 /rewind 可以显示出所有的还原点，然后选中一项后，可以回退到当时的对话状态（文件改动+对话消息）</p>
<h4 data-id="heading-11">/clear</h4>
<p>用这个命令相当于新开了一个对话，会清空 context ，通常是你这个 feat 的功能做完了，切到了新的 feat 开始新功能的开发时可以用到</p>
<h4 data-id="heading-12">/plan</h4>
<p>这个是计划模式，用来给复杂任务制定详细的计划，CC 会根据你的需求生成一个交互式问答，在终端中，你需要选择并回答 CC 的问题，完成需求澄清，这个 plan 才算是做完了。之后，CC 就会严格按照 plan 的规划，按步骤执行任务了</p>
<h4 data-id="heading-13">/tasks</h4>
<p>CC 是终端 app ，所以可以灵活的创建终端实例来跑任务，比如 pnpm dev 启动项目之类的，一般 task 会挂在后台执行，不影响你在前台与用户对话，需要节省内存和解除端口占用时可以用这个命令列出所有后台任务，还可以 kill 掉选中的任务</p>
<h3 data-id="heading-14">快捷键</h3>
<h4 data-id="heading-15">!</h4>
<p>你直接在 CC 中输入 bash 命令他不会执行，而是会当成了自然语言对话，需要在 CC 中输入 ! ，切换为执行 bash 命令，场景：feat 开发完后， git push 推送代码</p>
<h4 data-id="heading-16">Ctrl + C</h4>
<p>这个用来清空输入框</p>
<h4 data-id="heading-17">Ctrl + V</h4>
<p>粘贴图片，粘贴后终端中不会显示图片，而是显示一个占位符</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1209716273ed4a99aab419a26917e9e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWj5q2l5Y675rW36L65:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769742694&amp;x-signature=BYvR9ewhtURKIq6xad72KxlQXC4%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-18">cmd + enter</h4>
<p>全屏</p>
<p>更详细的可以使用命令 /help 来查看</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4b17eb5efe84727aa8cb7e91708f064~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWj5q2l5Y675rW36L65:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769742694&amp;x-signature=V2miuNnTSdS%2FxqpvniwoIFRX0Zs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-19">终端不直观怎么办？</h3>
<p>可以安装一个 claude 插件</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8600c486a2d54c5a9f70d3bda06beb82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWj5q2l5Y675rW36L65:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769742694&amp;x-signature=FbzgqgnT6bUA5rc8Mdqh1pb%2FCGk%3D" alt="" loading="lazy"/></p>
<p>在IDE里面使用 CC（跟终端里面效果是一模一样的）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5d61b30bca0494eab2ecd8e590eb132~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWj5q2l5Y675rW36L65:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769742694&amp;x-signature=aIMbgcavKkF9rp7RiBY9nTzHOeQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-20">Skills</h2>
<h3 data-id="heading-21">什么是 skill ?</h3>
<p>Skills 就是【技能包】，可以被 CC 直接调用完成任务，集 rules、prompt、可执行代码文件、mcp 调用、skill 调用、资源文件于一体。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06b50a45c1f740949957620b05346829~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWj5q2l5Y675rW36L65:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769742694&amp;x-signature=wrhogBuHq%2BrxGHCDr8qdP%2B4PmEk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-22">Skill 和 MCP 的区别</h3>
<p>Mcp 帮 AI 调服务，查数据；Skill 是一个功能完备的可重复调用的工具。</p>
<p>类比：mcp 就是 iCloud，Skill 就是 app store 里面的 app</p>
<h3 data-id="heading-23">Skill 的组成</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a44e7c7dc6c490e95e3f16864ab57a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWj5q2l5Y675rW36L65:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769742694&amp;x-signature=TiJbE76s%2B5vh267wfSGXcQ%2B6G1k%3D" alt="" loading="lazy"/></p>
<p>这里没有什么条条框框，但是<strong>最核心、不可或缺的文件就是</strong> <strong>SKILL.md</strong>，里面详细描述 skill 的用法</p>
<ul>
<li>
<p>references : 小型文档知识库，用来给 CC 补充信息作为参考的，这里可以放一些 skill 专用的文档，比如开发规范、领域专有资料</p>
</li>
<li>
<p>scripts: 这里放置可以直接终端运行的脚本文件（js、python、go ...），例如 node say-hello.js</p>
</li>
</ul>
<p><strong>SKILL.md 中比较重要的是 meta 信息，这个是用来告诉</strong> <strong>CC</strong> <strong>，skill 的功能、何时调用的</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">skill</span> <span class="hljs-string">的名字</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">skill</span> <span class="hljs-string">的功能描述，调用方式</span>
<span class="hljs-attr">disable-model-invocation:</span> <span class="hljs-string">是否禁止</span> <span class="hljs-string">CC</span> <span class="hljs-string">自动调用</span> <span class="hljs-string">skill，布尔值</span>
<span class="hljs-attr">user-invocable:</span> <span class="hljs-string">是否允许用户显示的通过</span> <span class="hljs-string">/</span> <span class="hljs-string">调用，布尔值</span>
<span class="hljs-meta">---
</span>
<span class="hljs-string">从这里开始，用自然语言详细描述</span> <span class="hljs-string">skill</span> <span class="hljs-string">的内容</span>
</code></pre>
<p>最后，贴一个完整的 SKILL.md，以我自己编写的 <strong>webpage-batch-saver</strong> 为例子：</p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: webpage-batch-saver
<span class="hljs-section">description: 批量保存网页为本地文件的技能包。支持从文字描述、CSV表格、Markdown文档中提取链接，自动生成完整的PDF文件和AI整理后的Markdown文档。使用场景：需要批量保存网页内容（如公众号文章备份、博客归档、资料收集等），或需要将网页转换为可离线阅读的格式。触发条件：用户提到"批量保存网页"、"网页转PDF"、"保存公众号文章"、"网页归档"等需求时使用此技能。
---</span>

<span class="hljs-section"># 网页批量保存</span>

<span class="hljs-section">## 概述</span>

此技能可将批量网页链接保存为本地文件，为每个网页生成两种格式：
<span class="hljs-bullet">1.</span> <span class="hljs-strong">**完整PDF**</span> - 使用 Playwright 渲染的完整网页视觉效果
<span class="hljs-bullet">2.</span> <span class="hljs-strong">**精简Markdown**</span> - 使用 Readability 算法提取的核心文本内容

<span class="hljs-section">## 快速开始</span>

<span class="hljs-section">### 前置要求</span>

使用前需安装依赖，详见 [<span class="hljs-string">依赖安装说明</span>](<span class="hljs-link">references/dependencies.md</span>)。

简要命令：
<span class="hljs-code">```bash
pip install requests beautifulsoup4 readability-lxml playwright
playwright install chromium
```</span>

<span class="hljs-section">### 使用流程</span>

<span class="hljs-bullet">1.</span> <span class="hljs-strong">**确定输入格式**</span> - 支持三种输入方式：
<span class="hljs-bullet">   -</span> 文字描述：直接粘贴包含URL的文本
<span class="hljs-bullet">   -</span> CSV表格：包含URL列的CSV文件
<span class="hljs-bullet">   -</span> Markdown文档：包含链接的MD文件

<span class="hljs-bullet">2.</span> <span class="hljs-strong">**确定任务名称**</span> - 用户需提供英文名称（如 <span class="hljs-code">`wechat_articles`</span>、<span class="hljs-code">`blog_backup`</span>）

<span class="hljs-bullet">3.</span> <span class="hljs-strong">**执行处理**</span> - 使用 <span class="hljs-code">`process_batch.py`</span> 主脚本处理

<span class="hljs-bullet">4.</span> <span class="hljs-strong">**获取输出**</span> - 在任务目录下获得PDF和Markdown文件

<span class="hljs-section">## 工作流程</span>

<span class="hljs-code">```
用户输入
    ↓
提取链接 (extract_links.py)
    ↓
并发处理 (process_batch.py)
    ├─→ 获取网页 (fetch_webpage.py)
    ├─→ 生成PDF (generate_pdf.py)
    └─→ 提取内容 (extract_content.py)
    ↓
生成索引 (index.md)
    ↓
输出目录
```</span>

<span class="hljs-section">## 使用方式</span>

<span class="hljs-section">### 方式一：文字描述输入</span>

<span class="hljs-code">```bash
python scripts/process_batch.py &lt;任务名&gt; text "&lt;包含URL的文本&gt;"
```</span>

示例：
<span class="hljs-code">```bash
python scripts/process_batch.py articles text '
https://example.com/article1
https://example.com/article2
https://example.com/article3
'
```</span>

<span class="hljs-section">### 方式二：CSV表格输入</span>

<span class="hljs-code">```bash
python scripts/process_batch.py &lt;任务名&gt; csv &lt;CSV文件路径&gt; [URL列名] [标题列名]
```</span>

示例：
<span class="hljs-code">```bash
python scripts/process_batch.py wechat_articles data/links.csv url title
```</span>

CSV格式示例：
<span class="hljs-code">```csv
url,title,date
https://mp.weixin.qq.com/s/xxx,文章标题1,2024-01-01
https://mp.weixin.qq.com/s/yyy,文章标题2,2024-01-02
```</span>

<span class="hljs-section">### 方式三：Markdown文档输入</span>

<span class="hljs-code">```bash
python scripts/process_batch.py &lt;任务名&gt; markdown &lt;MD文件路径&gt;
```</span>

示例：
<span class="hljs-code">```bash
python scripts/process_batch.py blog_backup links.md
```</span>

Markdown格式示例：
<span class="hljs-code">```markdown
# 我的收藏

- [精彩文章](https://example.com/article1)
- [技术分享](https://example.com/article2)

直接链接：https://example.com/article3
```</span>

<span class="hljs-section">## 输出目录结构</span>

<span class="hljs-code">```
&lt;任务名&gt;/
├── pdf/                    # PDF文件目录
│   ├── 文章标题1.pdf
│   ├── 文章标题2.pdf
│   └── ...
├── markdown/               # Markdown文档目录
│   ├── 文章标题1.md
│   ├── 文章标题2.md
│   └── ...
└── index.md                # 任务索引文件
```</span>

<span class="hljs-section">## 资源说明</span>

<span class="hljs-section">### scripts/</span>

<span class="hljs-strong">**核心脚本：**</span>

<span class="hljs-bullet">-</span> <span class="hljs-code">`process_batch.py`</span> - 主处理脚本，协调整个工作流程
<span class="hljs-bullet">-</span> <span class="hljs-code">`extract_links.py`</span> - 从各种输入格式中提取URL链接
<span class="hljs-bullet">-</span> <span class="hljs-code">`fetch_webpage.py`</span> - 获取网页HTML内容和标题
<span class="hljs-bullet">-</span> <span class="hljs-code">`generate_pdf.py`</span> - 使用 Playwright 生成PDF文件
<span class="hljs-bullet">-</span> <span class="hljs-code">`extract_content.py`</span> - 使用 Readability 提取核心文本内容

<span class="hljs-strong">**独立使用：**</span>

各脚本可独立调用，详见脚本内的命令行帮助。

<span class="hljs-section">### references/</span>

<span class="hljs-bullet">-</span> <span class="hljs-code">`dependencies.md`</span> - 详细的依赖安装说明和故障排查

<span class="hljs-section">## 技术特性</span>

<span class="hljs-bullet">1.</span> <span class="hljs-strong">**并发处理**</span> - 使用 asyncio 实现多网页并发处理（限制5并发）
<span class="hljs-bullet">2.</span> <span class="hljs-strong">**智能提取**</span> - Readability 算法自动提取正文，去除导航和广告
<span class="hljs-bullet">3.</span> <span class="hljs-strong">**容错重试**</span> - 网络请求失败自动重试
<span class="hljs-bullet">4.</span> <span class="hljs-strong">**编码处理**</span> - 自动检测网页编码，正确处理中文内容
<span class="hljs-bullet">5.</span> <span class="hljs-strong">**文件名清理**</span> - 自动处理非法字符，确保文件名合法

<span class="hljs-section">## 注意事项</span>

<span class="hljs-bullet">1.</span> 首次使用需要安装 Playwright 浏览器（约200MB）
<span class="hljs-bullet">2.</span> 并发处理会消耗较多网络和内存资源
<span class="hljs-bullet">3.</span> 某些网站可能有反爬措施，可能需要额外处理
<span class="hljs-bullet">4.</span> 生成的PDF文件大小取决于网页复杂度
</code></pre>
<h3 data-id="heading-24">安装并使用 skill</h3>
<p>Skill 也有专门的市场，这里推荐：<a href="https://link.juejin.cn?target=https%3A%2F%2Fskillsmp.com" target="_blank" title="https://skillsmp.com" ref="nofollow noopener noreferrer">skillsmp.com</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66afec018b12454f8f0cdd390d3e86a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWj5q2l5Y675rW36L65:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769742694&amp;x-signature=E8thV2naywd2dmTo75wJOpHcOAo%3D" alt="" loading="lazy"/></p>
<p>还有 A 厂官方的 skill 仓库，这里是万物之源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<p>通常使用 skills 这个 npm 包来安装指定的 skill</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 先安装 skills</span>
npm <span class="hljs-keyword">add</span> skills -g

<span class="hljs-comment">// 通过 skills 再去安装指定的 skill </span>
npx skills <span class="hljs-keyword">add</span> https:<span class="hljs-comment">//github.com/op7418/Youtube-clipper-skill</span>
</code></pre>
<h3 data-id="heading-25">编写自己的 skill</h3>
<p>先安装官方的 <strong>skills-creator ,</strong> 这个 skill 是 A 厂提供的专业、快速的开发 skill 的技能包</p>
<p><code>npx skills add anthropics/skills</code></p>
<p>然后，对 CC 说：我要开发一个 xxxx 的 skill ，把需求聊清楚后，他就会自动调用 skills-creator 帮你开发了</p>
<h2 data-id="heading-26">资料汇总</h2>
<ul>
<li>Skill 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fen%2Fskills" target="_blank" title="https://code.claude.com/docs/en/skills" ref="nofollow noopener noreferrer">code.claude.com/docs/en/ski…</a></li>
<li>Skill 官方仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></li>
<li>《是什么让 Claude Code 如此牛逼？》： <a href="https://link.juejin.cn?target=https%3A%2F%2Fminusx.ai%2Fblog%2Fdecoding-claude-code" target="_blank" title="https://minusx.ai/blog/decoding-claude-code" ref="nofollow noopener noreferrer">minusx.ai/blog/decodi…</a></li>
<li>《Agent Skills 终极指南：入门、精通、预测》：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FjUylk813LYbKw0sLiIttTQ" target="_blank" title="https://mp.weixin.qq.com/s/jUylk813LYbKw0sLiIttTQ" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/jUylk813L…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nestjs学习7：使用多种provider，灵活注入对象]]></title>    <link>https://juejin.cn/post/7598103943561904171</link>    <guid>https://juejin.cn/post/7598103943561904171</guid>    <pubDate>2026-01-23T03:28:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598103943561904171" data-draft-id="7598099064443650111" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nestjs学习7：使用多种provider，灵活注入对象"/> <meta itemprop="keywords" content="NestJS"/> <meta itemprop="datePublished" content="2026-01-23T03:28:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一江东流水"/> <meta itemprop="url" content="https://juejin.cn/user/1151943917181880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nestjs学习7：使用多种provider，灵活注入对象
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943917181880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一江东流水
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:28:56.000Z" title="Fri Jan 23 2026 03:28:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Nest 实现了 IoC 容器，会从入口模块开始扫描，分析 Module 之间的引用关系，对象之间的依赖关系，自动把 provider 注入到目标对象。</p>
<p>而这个 provider 也有好几种，下面就来看一下。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bcb32fd317642dcac43e024c951514a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743736&amp;x-signature=nSg4ZsxO%2FkIeI13fgXn6SaEdxTQ%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到 AppService 是被 @Injectable 修饰的 class。</p>
<p>在 Module 的 providers 里声明：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cb075aa064449288790ce71598c3f79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743736&amp;x-signature=Sd3tPKShYnnvUS7v%2B5EPMwzRiRk%3D" alt="image.png" loading="lazy"/></p>
<p>这就是 provider。</p>
<p>其实这是一种简写，完整的写法是这样的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd2ff31c814c4ee5a0c071a8198a0652~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743736&amp;x-signature=paPfEu%2Bp3YSK97cGQ708cQvuORA%3D" alt="image.png" loading="lazy"/></p>
<p>通过 provide 指定 token，通过 useClass 指定对象的类，Nest 会自动对它做实例化后用来注入。</p>
<p>在 AppController 的构造器里参数里声明了 AppService 的依赖，就会自动注入：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b943c7bdc2154ae0a0a08a316a7aacde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743736&amp;x-signature=BCxxtHRuYqDHm7r3u1FZ%2F9V8YNk%3D" alt="image.png" loading="lazy"/></p>
<p>如果不想用构造器注入，也可以属性注入：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29cd27c8d1914d87a15a7d05de424d5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743736&amp;x-signature=2Ib0ohycFCt04vEZiXAUcTJQOTM%3D" alt="image.png" loading="lazy"/></p>
<p>通过 @Inject 指定注入的 provider 的 token 即可。</p>
<p>有的同学说，在构造器参数里指定 AppService 的依赖的时候也没指定 token 啊？</p>
<p>那是因为 AppService 这个 class 本身就是 token。</p>
<p>当然，这个 token 也可以是字符串：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3b5ea9cd70e487e800540382393c157~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743736&amp;x-signature=6%2B24D33rWTdJYRVfsLkdqqxe0Qk%3D" alt="image.png" loading="lazy"/></p>
<p>如果 token 是字符串的话，注入的时候就要用 @Inject 手动指定注入对象的 token 了：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a5caf9d759b483cae755c44a9c16924~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743736&amp;x-signature=UE5z%2BOdZbwRcWfdCtikdMdOmlwk%3D" alt="image.png" loading="lazy"/></p>
<p>相比之下，用 class 做 token 可以省去 @Inject，比较简便。</p>
<p>除了指定 class 外，还可以直接指定一个值，让 IoC 容器来注入。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a63d7762719d4aa197089a72b86c04f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743736&amp;x-signature=8VMg8PlwizASfjYZXXVm%2FtvQ0yk%3D" alt="image.png" loading="lazy"/></p>
<p>使用 provide 指定 token，使用 useValue 指定值。</p>
<p>然后在对象里注入它：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10ec81f92d854278ac2ed6484e890b33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743736&amp;x-signature=S8Yh3NNHIqw%2BfAeWpz742tJGZls%3D" alt="image.png" loading="lazy"/></p>
<p>provider 的值可能是动态产生的，Nest 也同样支持：</p>
<pre><code class="hljs language-js" lang="js">{
    <span class="hljs-attr">provide</span>: <span class="hljs-string">'person2'</span>,
    <span class="hljs-title function_">useFactory</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">name</span>: <span class="hljs-string">'bbb'</span>,
            <span class="hljs-attr">desc</span>: <span class="hljs-string">'cccc'</span>
        }
    }
}
</code></pre>
<p>我们可以使用 useFactory 来动态创建一个对象。</p>
<p>在对象里注入：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd1466bb619742fbb41d5cae13a9b34b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743736&amp;x-signature=5TFjOqJ2Hm5UX8DpssnWEHpVrJs%3D" alt="image.png" loading="lazy"/></p>
<p>这个 useFactory 支持通过参数注入别的 provider：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a217b46e5254489a3458fcd77ad635e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743736&amp;x-signature=nOOpyHLO8UOF6jw%2B2977%2BV7%2FK0U%3D" alt="image.png" loading="lazy"/></p>
<p>通过 inject 声明了两个 token，一个是字符串 token 的 person，一个是 class token 的 AppService。</p>
<p>也就是注入这两个 provider：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e57e936609d4bc78e843838900a84eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743736&amp;x-signature=Mcai2Z5gcql%2BrKV8Wq3XyoeQNKU%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到，在调用 useFactory 方法的时候，Nest 就会注入这两个对象。</p>
<p>useFactory 支持异步：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19914eab0d8f4bd6bbcf9446fe6f16c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743736&amp;x-signature=8UjSan%2FJuUnFSyz%2B5B2PtEuZg%2Bg%3D" alt="image.png" loading="lazy"/></p>
<p>Nest 会等拿到异步方法的结果之后再注入。</p>
<p>这样就可以更灵活的创建注入对象。</p>
<p>此外，provider 还可以通过 useExisting 来指定别名：</p>
<pre><code class="hljs language-js" lang="js">{ <span class="hljs-attr">provide</span>: <span class="hljs-string">'person4'</span>, <span class="hljs-attr">useExisting</span>: <span class="hljs-string">'person2'</span> }
</code></pre>
<p>这里就是给 person2 的 token 的 provider 起个新的 token 叫做 person4。</p>
<p>然后就可以用新 token 来注入了。</p>
<p>这些自定义 provider 的方式里，最常用的是 useClass，不过我们一般会用简写，也就是直接指定 class。</p>
<p>useClass 的方式由 IoC 容器负责实例化，我们也可以用 useValue、useFactory 直接指定对象。</p>
<p>useExisting 只是用来起别名的，有的场景下会用到。</p>
<h2 data-id="heading-0">总结</h2>
<p>一般情况下，provider 是通过 @Injectable 声明，然后在 @Module 的 providers 数组里注册的 class。</p>
<p>默认的 token 就是 class，这样不用使用 @Inject 来指定注入的 token。</p>
<p>但也可以用字符串类型的 token，不过注入的时候要用 @Inject 单独指定。</p>
<p>除了可以用 useClass 指定注入的 class，还可以用 useValue 直接指定注入的对象。</p>
<p>如果想动态生成对象，可以使用 useFactory，它的参数也注入 IOC 容器中的对象，然后动态返回 provider 的对象。</p>
<p>如果想起别名，可以用 useExisting 给已有的 token，指定一个新 token。</p>
<p>灵活运用这些 provider 类型，就可以利用 Nest 的 IOC 容器中注入任何对象。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 智能体编程趋势报告]]></title>    <link>https://juejin.cn/post/7598089234033934336</link>    <guid>https://juejin.cn/post/7598089234033934336</guid>    <pubDate>2026-01-23T03:31:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598089234033934336" data-draft-id="7598203055751413795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 智能体编程趋势报告"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-23T03:31:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="舒一笑不秃头"/> <meta itemprop="url" content="https://juejin.cn/user/4257747754552599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 智能体编程趋势报告
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4257747754552599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    舒一笑不秃头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:31:52.000Z" title="Fri Jan 23 2026 03:31:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">目录</h2>
<ul>
<li>
<p>前言：从辅助到协作 ………………………………………… 3</p>
</li>
<li>
<p>基础趋势：板块级变革 ……………………………………… 4</p>
</li>
<li>
<p>趋势 1：软件开发生命周期发生剧变 ……………………… 5</p>
</li>
<li>
<p>能力趋势：智能体能做什么 ………………………………… 7</p>
</li>
<li>
<p>趋势 2：单个智能体演变为协同团队 ……………………… 8</p>
</li>
<li>
<p>趋势 3：长期运行的智能体构建完整系统 ………………… 9</p>
</li>
<li>
<p>趋势 4：通过智能协作实现人类监督的规模化 …………… 10</p>
</li>
<li>
<p>趋势 5：智能体编程扩展至新场景与新用户 ……………… 11</p>
</li>
<li>
<p>影响趋势：2026 年智能体可能带来的改变 ……………… 12</p>
</li>
<li>
<p>趋势 6：生产力提升重塑软件开发经济 …………………… 13</p>
</li>
<li>
<p>趋势 7：非技术用例在组织中广泛扩展 …………………… 14</p>
</li>
<li>
<p>趋势 8：双重用途风险要求“安全优先”架构 …………… 15</p>
</li>
<li>
<p>未来一年的重点方向 ……………………………………… 16</p>
</li>
</ul>
<h2 data-id="heading-1">前言：从辅助到协作</h2>
<p>2025 年，编码智能体已从实验性工具转变为投入生产的真实系统，能够向真实客户交付真实功能。工程团队发现，AI 如今可以处理完整的实现工作流：编写测试、调试失败、生成文档，并在日益复杂的代码库中自如导航。</p>
<p>2026 年，我们预测这些进展将远超对现有工具或模型的渐进式改进。我们预计，单个智能体将演变为协同工作的智能体团队；过去需要数小时甚至数天的任务，如今只需极少的人工干预即可完成。而几年前还在逐行手写代码的工程师，将越来越多地协调长期运行的智能体系统来处理实现细节，从而聚焦于架构与战略层面。</p>
<p>然而，研究开发者实际使用 AI 的方式揭示了一个关键细节：这场转型本质上是<strong>协作式</strong>的。我们社会影响团队的研究表明，尽管开发者在约 60% 的工作中使用 AI，但他们表示仅能“完全委托”0–20% 的任务。AI 始终是协作者，但要高效使用它，仍需精心设置与提示、主动监督、验证以及人类判断——尤其在高风险工作中。</p>
<p>受我们与客户合作经验的启发，本报告识别出八项我们认为将在 2026 年定义智能体编程的趋势。这些预测分为三类：<strong>基础趋势</strong>（将重塑开发工作方式）、<strong>能力趋势</strong>（拓展智能体可完成的任务范围）和<strong>影响趋势</strong>（可能改变商业成果与组织结构）。</p>
<p>这些预测反映的是我们今天在客户身上看到的现象，而非对明天的确定性断言。我们提供它们作为思考未来一年的框架，深知未来终将带来惊喜。</p>
<p>值得注意的是，这些趋势表明早期采用者与后进者之间的差距正在扩大。那些学会在不造成瓶颈的前提下规模化人类监督的组织，更能兼顾质量与速度。那些今天就掌握跨软件开发生命周期的智能体协同的团队，能在数小时内而非数天内交付功能。而将智能体编程从工程团队扩展至非技术角色的公司，则有望在整个组织中释放生产力红利。</p>
<p>2026 年浮现的模式表明，软件开发正朝着一种新模式演进：<strong>人类专家专注于定义值得解决的问题，而 AI 负责战术层面的实现工作</strong>。</p>
<p>让我们深入探讨。</p>
<h2 data-id="heading-2">基础趋势：板块级变革</h2>
<h3 data-id="heading-3">趋势 1：软件开发生命周期发生剧变</h3>
<p>我们与计算机的交互方式正经历自图形用户界面以来最重大的变革之一。从机器码到汇编，再到 C 语言，再到现代高级语言，每一层抽象都缩小了人类思维与机器执行之间的鸿沟。</p>
<p>最近的一步是<strong>人机对话</strong>。2025 年，智能体 AI 改变了大量开发者的编码方式。2026 年，这一演化转变的系统性效应将重构整个软件开发生命周期（SDLC），并重塑软件工程角色。</p>
<p>传统的 SDLC 阶段依然存在，但由智能体驱动的实现、自动化测试和内联文档将周期时间从数周压缩至数小时。监控数据直接反馈到快速迭代中。</p>
<h4 data-id="heading-4">预测：</h4>
<ul>
<li><strong>抽象层级的演进</strong>：编写、调试和维护代码的大部分战术工作将转移给 AI，工程师则聚焦于更高层次的工作，如架构、系统设计以及关于“构建什么”的战略决策。</li>
<li><strong>工程角色转型</strong>：过去，“构建软件”主要意味着写代码（尽管软件工程角色一直包含许多其他技能）。如今，软件工程师越来越意味着<strong>协调编写代码的智能体</strong>，评估其输出，提供战略方向，并确保系统整体正确地解决了正确的问题。</li>
<li><strong>加速入职与动态项目人员配置</strong>：传统上熟悉新代码库或项目的入职周期将从数周缩短至数小时，改变公司对人才部署和项目资源调配的思考方式。</li>
</ul>
<h4 data-id="heading-5">协作的现实</h4>
<p>尽管智能体承担了更多实现工作，但这种转变揭示了一个重要事实：<strong>工程师正变得更“全栈”而非被取代</strong>。我们的研究表明，工程师现在能有效跨越前端、后端、数据库和基础设施等领域——这些领域他们过去可能缺乏专业知识——因为 AI 填补了知识空白，而人类提供监督与方向。</p>
<p>这种能力扩展带来了更紧密的反馈循环和更快的学习速度。过去需要数周跨团队协调的任务，如今可变为聚焦的工作会话。工程师描述他们将 AI 用于<strong>易于验证、定义清晰或重复性高</strong>的任务，而将高层设计决策及任何需要组织上下文或“品味”的任务留给自己。</p>
<h4 data-id="heading-6">角色转型：从实现者到协调者</h4>
<p>2026 年，工程师贡献的价值将转向<strong>系统架构设计、智能体协调、质量评估和战略性问题拆解</strong>。构建软件的主要人类角色，是协调编写代码的 AI 智能体、评估其输出、提供战略方向，并确保系统为正确的利益相关者解决正确的问题。</p>
<p>掌握协调能力的工程师可同时推进多个功能开发，将其判断应用于比以往单点实现更广泛的范围。</p>
<h4 data-id="heading-7">入职革命</h4>
<p>2025 年，熟悉新代码库或项目的传统时间线已开始从数周压缩至数小时。2026 年，我们预计组织将学会充分利用这一能力，彻底改变人才部署和项目资源规划方式。</p>
<p>我们设想的一种表现形式是<strong>动态“突击”式人员配置</strong>（dynamic "surge" staffing）：企业可根据需求，将具备深度代码库知识的工程师按需“突击”投入到特定任务中。组织可动态调配项目人员，针对特定挑战引入专家，并在不经历传统生产力低谷的情况下灵活调整资源。</p>
<blockquote>
<p><strong>案例</strong>：初创公司 Augment Code 利用 Claude 为网络平台、数据库和存储基础设施等系统构建 AI 驱动的开发工具，通过提供上下文代码理解，大幅降低了工程师加入新代码库的学习曲线。一位企业客户使用 Augment Code（基于 Claude）在<strong>两周内</strong>完成了其 CTO 最初预估需 <strong>4–8 个月</strong>的项目。</p>
</blockquote>
<h2 data-id="heading-8">能力趋势：智能体能做什么</h2>
<h3 data-id="heading-9">趋势 2：单个智能体演变为协同团队</h3>
<p>我们预测，2026 年组织将能够利用多个智能体协同工作，处理一年前难以想象的复杂任务。这将要求新的技能：任务拆解、智能体专业化、协调协议，以及能显示多个并发智能体会话状态的开发环境，还有能处理智能体同步贡献的版本控制工作流。</p>
<h4 data-id="heading-10">预测：</h4>
<ul>
<li><strong>多智能体系统取代单智能体工作流</strong>：组织采用多智能体工作流，通过在独立上下文窗口中并行推理，最大化性能收益。</li>
</ul>
<blockquote>
<p><strong>案例</strong>：一线劳动力管理平台 Fountain 利用 Claude 实现分层多智能体协调，<strong>筛选速度提升 50%、入职速度加快 40%、候选人转化率翻倍</strong>。其 Fountain Copilot 作为中央协调智能体，统筹专门用于候选人筛选、自动化文档生成和情感分析的子智能体。该架构使某物流客户将新履约中心的全面 staffing 时间从一周以上缩短至<strong>不到 72 小时</strong>。</p>
</blockquote>
<blockquote>
<p>单智能体工作流通过单一上下文窗口顺序处理任务。多智能体架构则由一个协调器统筹多个专用智能体并行工作（各自拥有独立上下文），再将结果整合为统一输出。</p>
</blockquote>
<h3 data-id="heading-11">趋势 3：长期运行的智能体构建完整系统</h3>
<p>早期的智能体仅处理几分钟内完成的一次性任务：修复这个 bug、写这个函数、生成这个测试。到 2025 年底，日益成熟的 AI 智能体已能在数小时内产出完整功能集。2026 年，智能体将能<strong>连续工作数天</strong>，在最少人工干预下构建整个应用和系统，人类仅在关键决策点提供战略监督。</p>
<h4 data-id="heading-12">预测：</h4>
<ul>
<li><strong>任务时域从分钟扩展至数天甚至数周</strong>：智能体从处理几分钟内完成的离散任务，演变为能自主工作较长时间，构建并测试整个应用和系统，并定期接受人类检查点。</li>
<li><strong>智能体应对软件开发的“混乱现实”</strong>：长期运行的智能体能规划、迭代、优化数十个工作会话，适应新发现、从失败中恢复，并在整个复杂项目中保持一致状态。</li>
<li><strong>软件开发经济学发生改变</strong>：当智能体能长时间自主工作时，过去不可行的项目变得可行。因无人有时间处理而积累多年的“技术债”，将被智能体系统性地清理。</li>
<li><strong>上市路径加速</strong>：创业者利用智能体在数天内（而非数月）将想法转化为已部署的应用。</li>
</ul>
<blockquote>
<p><strong>案例</strong>：在乐天（Rakuten），工程师用 Claude Code 测试一项复杂技术任务：在拥有 1250 万行代码、多种编程语言的大型开源库 vLLM 中实现特定的激活向量提取方法。Claude Code 在<strong>单次运行中仅用 7 小时</strong>就完成了全部工作，实现结果与参考方法相比达到 <strong>99.9% 的数值精度</strong>。</p>
</blockquote>
<h3 data-id="heading-13">趋势 4：通过智能协作实现人类监督的规模化</h3>
<p>2026 年最有价值的能力发展或许是：<strong>智能体学会何时求助</strong>，而非盲目尝试所有任务；而人类只在必要时介入。这并非要将人类排除在外，而是让人类注意力集中在最关键的地方。</p>
<h4 data-id="heading-14">预测：</h4>
<ul>
<li><strong>智能体质量控制成为标准</strong>：组织使用 AI 智能体审查大规模 AI 生成的输出，分析代码中的安全漏洞、架构一致性及质量问题——这些工作若靠人力将不堪重负。</li>
<li><strong>智能体学会何时求助</strong>：成熟的智能体能识别需要人类判断的情境，标记不确定性区域，并将具有潜在业务影响的决策升级给人类。</li>
<li><strong>人类监督从“审查一切”转向“审查关键”</strong>：团队通过构建智能系统处理常规验证，同时将真正新颖的情况、边界案例和战略决策交由人类处理，从而兼顾质量与速度。</li>
</ul>
<h4 data-id="heading-15">协作悖论</h4>
<p>Anthropic 内部研究揭示了一个重要模式：尽管工程师报告在约 60% 的工作中使用 AI 并获得显著生产力提升，但他们也表示仅能“完全委托”一小部分任务。这一表面矛盾在理解“有效 AI 协作需要人类主动参与”后便迎刃而解。</p>
<p>工程师描述，他们随时间逐渐形成对 AI 委托的直觉。随着模型进步，这种直觉正在快速演变，但历史上，他们倾向于委托<strong>易于验证</strong>（“能相对轻松地嗅探检查正确性”）或<strong>低风险</strong>（如快速脚本定位 bug）的任务。任务越概念复杂或依赖设计，工程师越可能自己保留，或与 AI 协作完成，而非完全交出。</p>
<p>这一模式有重要启示：<strong>即使 AI 能力不断扩展，人类角色依然核心</strong>。转变是从“写代码”变为“审查、指导和验证 AI 生成的代码”。正如我们一位工程师所说：“我主要在知道自己期望的答案或样子时才使用 AI。这种能力是通过‘艰难方式’做软件工程练出来的。”</p>
<blockquote>
<p><strong>案例</strong>：印度金融科技平台 CRED（服务超 1500 万用户）在其整个开发生命周期中部署 Claude Code，在维持金融级质量标准的同时加速交付。这套 Claude 驱动的开发系统使其执行速度<strong>翻倍</strong>——并非通过消除人类参与，而是将开发者转向更高价值的工作。</p>
</blockquote>
<h3 data-id="heading-16">趋势 5：智能体编程扩展至新场景与新用户</h3>
<p>早期的智能体编程聚焦于帮助专业软件工程师在熟悉环境中更快工作。2026 年，智能体编程将扩展至传统开发工具无法触及的场景和用例，从遗留语言到新交互形态，使非传统开发者也能参与。</p>
<h4 data-id="heading-17">预测：</h4>
<ul>
<li><strong>语言障碍消失</strong>：支持扩展至 COBOL、Fortran 等冷门或遗留语言及领域特定语言（DSL），使遗留系统维护成为可能，并消除特定用例的采用壁垒。</li>
<li><strong>编程民主化超越工程领域</strong>：新形态和界面将智能体编程开放给网络安全、运维、设计、数据科学等领域的非传统开发者。像 Cowork 这类为非开发者设计的文件与任务自动化工具，已预示这一转变。</li>
</ul>
<h4 data-id="heading-18">每个人都变得更“全栈”</h4>
<p>对不同团队使用 AI 的分析揭示了一致模式：人们用 AI 增强核心专长，同时拓展至相邻领域。安全团队用它分析陌生代码；研究团队用它构建数据前端可视化；非技术人员用它调试网络问题或进行数据分析。</p>
<p>这种扩展挑战了长期假设：即严肃的开发工作只能在 IDE 中进行，或只有配备专业工具的专业工程师才能用代码解决问题。“会编码的人”与“不会编码的人”之间的壁垒正变得更具渗透性。</p>
<blockquote>
<p><strong>案例</strong>：AI 法律平台 Legora 在其法律科技平台中深度集成智能体工作流，展示智能体如何延伸至领域特定应用。  CEO Max Junestrand 表示：“我们发现 Claude 在指令遵循、构建智能体和智能体工作流方面非常出色。”公司既用 Claude Code 加速自身开发，也为无需工程专业知识的律师提供智能体能力，以创建复杂自动化流程。</p>
</blockquote>
<h2 data-id="heading-19">影响趋势：2026 年智能体可能带来的改变</h2>
<h3 data-id="heading-20">趋势 6：生产力提升重塑软件开发经济学</h3>
<p>能将智能体智能融入 SDLC 的组织，将看到时间线压缩，从而影响哪些项目可行，以及公司响应市场机会的速度。</p>
<h4 data-id="heading-21">预测：</h4>
<ul>
<li><strong>三大乘数驱动加速</strong>：智能体能力、协调优化和人类经验的更好利用相互促进，产生阶跃式（而非线性）提升。</li>
<li><strong>时间压缩改变项目可行性</strong>：过去需数周的开发如今只需数天，使过去不可行的项目变得可行，并让组织更快响应市场机遇。</li>
<li><strong>软件开发经济学转变</strong>：随着智能体增强工程师产能、项目周期缩短、更快实现价值，总拥有成本（TCO）下降，投资回报率（ROI）提升。</li>
</ul>
<h4 data-id="heading-22">生产力来自产出量，而不仅是速度</h4>
<p>Anthropic 内部研究揭示了一个有趣的生产力模式：工程师报告每类任务耗时净减少，但<strong>产出量净增更为显著</strong>。这表明 AI 提升生产力主要通过<strong>增加产出</strong>——交付更多功能、修复更多 bug、运行更多实验——而非仅仅更快地做同样的事。</p>
<p>值得注意的是，约 27% 的 AI 辅助工作是<strong>原本不会做的任务</strong>：扩展项目规模、构建“锦上添花”的工具（如交互式仪表盘）、以及手动执行不划算的探索性工作。工程师表示，由于 AI 使处理变得可行，他们修复了更多“小痛点”（papercuts）——那些虽能提升体验但通常被降级处理的微小问题。</p>
<blockquote>
<p><strong>案例</strong>：加拿大通信科技公司 TELUS 创建了<strong>超过 13,000 个定制 AI 解决方案</strong>，工程代码交付速度<strong>提升 30%</strong>。公司累计节省超 <strong>50 万小时</strong>，平均每次 AI 交互节省 40 分钟。</p>
</blockquote>
<h3 data-id="heading-23">趋势 7：非技术用例在组织中广泛扩展</h3>
<p>我们预计，2026 年最显著的趋势之一将是：<strong>职能与业务流程团队稳步增长地使用智能体编程，为自己遇到的问题创建解决方案，优化日常流程</strong>。</p>
<h4 data-id="heading-24">预测：</h4>
<ul>
<li><strong>编程能力民主化超越工程部门</strong>：销售、市场、法务、运营等非技术团队获得自动化工作流和构建工具的能力，几乎无需工程介入或编码知识。</li>
<li><strong>领域专家直接实施方案</strong>：深刻理解问题的一线专家，更有信心使用智能体自行启动解决方案，消除“提工单—等待开发”的瓶颈。</li>
<li><strong>生产力收益遍及整个组织</strong>：过去不值得投入工程时间的问题得到解决，实验性工作流变得轻而易举，手动流程被自动化。</li>
</ul>
<blockquote>
<p><strong>案例</strong>：AI 编排平台 Zapier 已让所有员工都能使用智能体。设计团队在客户访谈中用 Claude artifacts 快速原型，实时展示通常需数周开发的设计概念。公司实现 <strong>89% 的 AI 采用率</strong>，内部部署了 <strong>800 多个 AI 智能体</strong>。</p>
</blockquote>
<blockquote>
<p><strong>Anthropic 自身实践</strong>：我们的法务团队通过构建 Claude 驱动的工作流（如合同修订、内容审查自动化），将市场审核周转时间从 2–3 天缩短至 <strong>24 小时</strong>。一名无编码经验的律师用 Claude Code 构建了自助工具，在问题进入法务队列前进行分流，使律师能聚焦战略咨询而非事务性杂务。结果：法务团队降低成为瓶颈的可能性，并将时间用于更紧迫事项。</p>
</blockquote>
<h3 data-id="heading-25">趋势 8：智能体编程提升安全防御——但也强化攻击能力</h3>
<p>智能体编程正同时在两个方向改变安全格局。随着模型更强大、更对齐，将安全内建到产品中变得更简单。现在，任何工程师都能利用 AI 执行过去需要专业技能的安全审查、加固和监控。但同样能帮助防御者的能力，也能帮助攻击者规模化其攻击。</p>
<h4 data-id="heading-26">预测：</h4>
<ul>
<li><strong>安全知识民主化</strong>：借助更优智能体，任何工程师都能成为安全工程师，执行深度安全审查、加固和监控。工程师仍需考虑安全并咨询专家，但构建加固且安全的应用将变得更容易。</li>
<li><strong>威胁行为者规模化攻击</strong>：虽然智能体利好防御，但也同样利好攻击。为防御这种双重用途技术，工程师必须从一开始就内建安全。</li>
<li><strong>智能体驱动的网络防御系统兴起</strong>：自动化智能体系统能以机器速度响应安全事件，自动检测与响应，匹配自主威胁的节奏。</li>
</ul>
<p><strong>平衡有利于有准备的组织</strong>。那些从一开始就用智能体工具内建安全的团队，将更有能力抵御使用相同技术的对手。</p>
<h2 data-id="heading-27">未来一年的重点方向</h2>
<p>上述八大趋势共同指向一个核心主题：<strong>软件开发正从以“写代码”为中心的活动，转变为以“协调编写代码的智能体”为基础的活动——同时保留确保高质量结果所必需的人类判断、监督与协作</strong>。</p>
<p>研究明确指出：AI 是持续的协作者，但要有效使用它，尤其在高风险工作中，仍需主动监督与验证。虽然更多常规编码任务可委托给 AI，但人类仍在审查代码。这不是“完全委托”，而是高度协作。这一区别对组织如何采纳 AI、如何看待工程师角色演变至关重要。</p>
<p>对于规划 2026 年重点的组织，以下四个领域亟需关注：</p>
<ol>
<li><strong>掌握多智能体协调</strong>，以应对单智能体系统无法处理的复杂性</li>
<li><strong>通过 AI 自动化审查系统规模化人机监督</strong>，让人 类注意力聚焦最关键之处</li>
<li><strong>将智能体编程扩展至工程之外</strong>，赋能各部门的领域专家</li>
<li><strong>从最初阶段就将安全架构嵌入智能体系统设计</strong></li>
</ol>
<p>2026 年将智能体编程视为<strong>战略优先事项</strong>的组织，将定义何为可能；而仅将其视为<strong>渐进式生产力工具</strong>的组织，将发现自己在一场规则已变的游戏中竞争。成功的关键在于理解：<strong>目标不是将人类移出循环，而是让人 类专长在最关键处发挥最大价值</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Playwright 进阶模式：利用 Promise.all 实现浏览器内高并发]]></title>    <link>https://juejin.cn/post/7598104596779679790</link>    <guid>https://juejin.cn/post/7598104596779679790</guid>    <pubDate>2026-01-23T03:35:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598104596779679790" data-draft-id="7598104596779352110" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Playwright 进阶模式：利用 Promise.all 实现浏览器内高并发"/> <meta itemprop="keywords" content="Python,爬虫"/> <meta itemprop="datePublished" content="2026-01-23T03:35:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="元Y亨H"/> <meta itemprop="url" content="https://juejin.cn/user/2839351584888617"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Playwright 进阶模式：利用 Promise.all 实现浏览器内高并发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2839351584888617/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    元Y亨H
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:35:27.000Z" title="Fri Jan 23 2026 03:35:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0">Playwright 进阶模式：利用 <code>Promise.all</code> 实现浏览器内高并发</h2>
<p>在复杂的爬虫开发中，我们常遇到两难困境：</p>
<ol>
<li><strong>Python 循环 (<code>for</code> loop)</strong>：稳定，能自动继承页面的 Cookie 和 Session，但速度慢（串行阻塞）。</li>
<li><strong>Python 多线程 (<code>requests/aiohttp</code>)</strong>：速度快，但无法继承浏览器上下文，遇到 CSRF Token、签名验证或复杂 Header 时极易失效（报 400/403）。</li>
</ol>
<p><strong>解决方案：</strong> 将并发的控制权移交给浏览器。通过注入 JavaScript 的 <code>Promise.all</code>，利用浏览器的非阻塞 I/O 能力并行发出请求。</p>
<h3 data-id="heading-1">核心代码模式</h3>
<h4 data-id="heading-2">1. 通用调度器 (The Scheduler)</h4>
<p>这是一个完全独立的工具函数，可以直接放入你的 <code>utils.py</code> 中。它不包含任何具体业务逻辑，只负责“在浏览器里跑并发任务”。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_browser_batch</span>(<span class="hljs-params">page, task_list</span>):
    <span class="hljs-string">"""
    通用浏览器并发请求执行器
    :param page: Playwright 的 Page 对象
    :param task_list: 任务列表，必须包含 'url' 字段，可包含其他元数据(id, type等)
    :return: 包含响应结果和原始元数据的列表
    """</span>
    
    <span class="hljs-comment"># 定义核心 JS 逻辑：接收任务 -&gt; 并发 Fetch -&gt; 返回结果</span>
    <span class="hljs-comment"># 关键点：在 map 内部捕获异常，确保单个失败不影响整体</span>
    js_payload = <span class="hljs-string">"""
    async (tasks) =&gt; {
        const promises = tasks.map(async (task) =&gt; {
            const start = Date.now();
            try {
                // 发起 Fetch 请求
                // 浏览器会自动附带当前域名的 Cookie、Referer 和 LocalStorage Token
                const response = await fetch(task.url, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });

                // 统一处理 HTTP 错误状态
                if (!response.ok) {
                    return {
                        status: 'failed',
                        meta: task, // 将原始任务信息带回，方便 Python 端匹配
                        error: `HTTP ${response.status}: ${response.statusText}`
                    };
                }

                const data = await response.json();
                return {
                    status: 'success',
                    meta: task,
                    data: data,
                    latency: Date.now() - start
                };

            } catch (err) {
                // 捕获网络层面的错误（如 DNS 解析失败、超时）
                return {
                    status: 'error',
                    meta: task,
                    error: err.toString()
                };
            }
        });

        // 等待所有请求完成 (Parallel Execution)
        return await Promise.all(promises);
    }
    """</span>

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 将 Python 列表传递给浏览器执行</span>
        <span class="hljs-keyword">return</span> page.evaluate(js_payload, task_list)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[System Error] JS 注入执行失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> []
</code></pre>
<hr/>
<h4 data-id="heading-3">2. 业务实现示例：加密货币价格监控</h4>
<p>假设我们需要从某财经网站采集 50 个加密货币的实时详情。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">from</span> playwright.sync_api <span class="hljs-keyword">import</span> sync_playwright

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CryptoMarketScraper</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 模拟待采集的目标 (ID 和 API 地址)</span>
        self.targets = [
            {<span class="hljs-string">"id"</span>: <span class="hljs-string">"BTC"</span>, <span class="hljs-string">"symbol"</span>: <span class="hljs-string">"bitcoin"</span>, <span class="hljs-string">"api"</span>: <span class="hljs-string">"https://api.coincap.io/v2/assets/bitcoin"</span>},
            {<span class="hljs-string">"id"</span>: <span class="hljs-string">"ETH"</span>, <span class="hljs-string">"symbol"</span>: <span class="hljs-string">"ethereum"</span>, <span class="hljs-string">"api"</span>: <span class="hljs-string">"https://api.coincap.io/v2/assets/ethereum"</span>},
            {<span class="hljs-string">"id"</span>: <span class="hljs-string">"DOGE"</span>, <span class="hljs-string">"symbol"</span>: <span class="hljs-string">"dogecoin"</span>, <span class="hljs-string">"api"</span>: <span class="hljs-string">"https://api.coincap.io/v2/assets/dogecoin"</span>},
            <span class="hljs-comment"># ... 假设这里还有 50 个 ...</span>
        ]
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">with</span> sync_playwright() <span class="hljs-keyword">as</span> p:
            <span class="hljs-comment"># 启动浏览器</span>
            browser = p.chromium.launch(headless=<span class="hljs-literal">False</span>)
            context = browser.new_context()
            page = context.new_page()

            <span class="hljs-comment"># 1. 预加载：先访问主域，获取必要的 Cookie/Session/Token</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"正在初始化会话..."</span>)
            page.goto(<span class="hljs-string">"https://coincap.io"</span>) 
            page.wait_for_timeout(<span class="hljs-number">2000</span>) <span class="hljs-comment"># 等待各种 Token 初始化完成</span>

            <span class="hljs-comment"># 2. 开始分批采集</span>
            self.process_in_batches(page)

            browser.close()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_in_batches</span>(<span class="hljs-params">self, page</span>):
        BATCH_SIZE = <span class="hljs-number">5</span> <span class="hljs-comment"># 并发控制：每批 5 个</span>
        total = <span class="hljs-built_in">len</span>(self.targets)
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始任务，共 <span class="hljs-subst">{total}</span> 个目标..."</span>)

        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, total, BATCH_SIZE):
            <span class="hljs-comment"># A. 准备批次数据</span>
            batch_data = self.targets[i : i + BATCH_SIZE]
            
            <span class="hljs-comment"># B. 构造任务对象 (Task Construction)</span>
            <span class="hljs-comment"># 我们将 url 和 meta data 打包在一起</span>
            tasks = []
            <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> batch_data:
                tasks.append({
                    <span class="hljs-string">"url"</span>: item[<span class="hljs-string">'api'</span>],     <span class="hljs-comment"># JS 需要的 URL</span>
                    <span class="hljs-string">"asset_id"</span>: item[<span class="hljs-string">'id'</span>], <span class="hljs-comment"># 传递给 JS，方便它原样返回</span>
                    <span class="hljs-string">"name"</span>: item[<span class="hljs-string">'symbol'</span>]
                })

            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🚀 正在并发请求第 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span> - <span class="hljs-subst">{<span class="hljs-built_in">min</span>(i+BATCH_SIZE, total)}</span> 项..."</span>)

            <span class="hljs-comment"># C. 调用通用调度器</span>
            results = execute_browser_batch(page, tasks)

            <span class="hljs-comment"># D. 处理结果</span>
            <span class="hljs-keyword">for</span> res <span class="hljs-keyword">in</span> results:
                <span class="hljs-comment"># 提取元数据</span>
                meta = res.get(<span class="hljs-string">'meta'</span>, {})
                name = meta.get(<span class="hljs-string">'name'</span>, <span class="hljs-string">'Unknown'</span>)

                <span class="hljs-keyword">if</span> res[<span class="hljs-string">'status'</span>] == <span class="hljs-string">'success'</span>:
                    price = res[<span class="hljs-string">'data'</span>][<span class="hljs-string">'data'</span>][<span class="hljs-string">'priceUsd'</span>]
                    latency = res[<span class="hljs-string">'latency'</span>]
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   ✅ [<span class="hljs-subst">{name}</span>] 价格: $<span class="hljs-subst">{<span class="hljs-built_in">float</span>(price):<span class="hljs-number">.2</span>f}</span> (耗时 <span class="hljs-subst">{latency}</span>ms)"</span>)
                    <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> 在这里写入数据库</span>
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   ❌ [<span class="hljs-subst">{name}</span>] 采集失败: <span class="hljs-subst">{res.get(<span class="hljs-string">'error'</span>)}</span>"</span>)

            <span class="hljs-comment"># E. 批次间随机休眠 (模拟人类浏览行为)</span>
            time.sleep(random.uniform(<span class="hljs-number">1.0</span>, <span class="hljs-number">2.5</span>))

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    spider = CryptoMarketScraper()
    spider.run()
</code></pre>
<hr/>
<h3 data-id="heading-4">为什么要用这种模式？(技术总结)</h3>
<h4 data-id="heading-5">1. 解决了 "上下文断裂" 问题</h4>
<p>使用 Python <code>requests</code> 库时，最大的痛点是<strong>复刻浏览器环境</strong>。你需要手动提取 <code>Cookie</code>，手动计算 <code>Authorization</code> 头，甚至要破解 <code>_tb_token_</code> 或 <code>x-sign</code>。
而在本模式中，<code>fetch</code> 是在页面上下文中执行的，<strong>浏览器自动为你附加了所有认证信息</strong>。只要页面是登录状态，接口请求就是登录状态。</p>
<h4 data-id="heading-6">2. 性能提升显著</h4>
<ul>
<li><strong>串行模式</strong>：请求 A (1s) -&gt; 请求 B (1s) -&gt; 请求 C (1s) = 总耗时 3s。</li>
<li><strong>Promise.all 模式</strong>：请求 A, B, C 同时发出 -&gt; 等待最慢的一个返回 (1s) = 总耗时 1s。</li>
<li><strong>效率对比</strong>：通常能获得 <strong>5~10 倍</strong> 的速度提升。</li>
</ul>
<h4 data-id="heading-7">3. 元数据透传 (Metadata Passthrough)</h4>
<p>注意代码中的 <code>meta</code> 字段。我们在 Python 端把 <code>{"id": "BTC"}</code> 传给 JS，JS 在返回结果时原样带回。
这意味着我们<strong>不需要</strong>去解析 URL 来判断这个 JSON 数据属于哪个商品或 ID，直接读 <code>meta</code> 即可，逻辑非常清晰。</p>
<h4 data-id="heading-8">4. 鲁棒性设计</h4>
<p>在 JS 代码中，我们对每个 <code>map</code> 内部的 Promise 都做了 <code>try...catch</code>。
如果不这样做，<code>Promise.all</code> 只要遇到一个网络错误（比如其中一个 API 超时），整个批次的所有数据都会丢失（Fail Fast 机制）。加上 <code>try...catch</code> 后，我们可以实现“部分成功，部分重试”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何使用Sealos 构建SpringCloud项目CI/CD流水线]]></title>    <link>https://juejin.cn/post/7598029481509847059</link>    <guid>https://juejin.cn/post/7598029481509847059</guid>    <pubDate>2026-01-23T03:37:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598029481509847059" data-draft-id="7598112768147341318" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何使用Sealos 构建SpringCloud项目CI/CD流水线"/> <meta itemprop="keywords" content="DevOps"/> <meta itemprop="datePublished" content="2026-01-23T03:37:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何使用Sealos 构建SpringCloud项目CI/CD流水线
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:37:47.000Z" title="Fri Jan 23 2026 03:37:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"/>
<h3 data-id="heading-1">引言</h3>
<p>在云原生时代，CI/CD流水线是保障微服务持续交付的核心能力。本文将基于Sealos云操作系统，结合SpringCloud项目，详解如何构建从代码提交到生产环境的全自动化部署流水线。通过GitLab CI与ArgoCD的深度集成，实现多环境一致性部署、快速回滚和可视化监控。</p>
<hr/>
<h3 data-id="heading-2">一、环境准备</h3>
<h4 data-id="heading-3">1.1 Sealos集群部署</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 部署Kubernetes基础集群</span>
sealos run ghcr.io/labring/sealos/kubernetes:v1.28.15 \
  --masters 192.168.0.2,192.168.0.3 \
  --nodes 192.168.0.4,192.168.0.5 -p <span class="hljs-string">'your-ssh-passwd'</span>

<span class="hljs-comment"># 部署网络插件</span>
sealos run ghcr.io/labring/sealos/cilium:v1.17.1

<span class="hljs-comment"># 部署证书管理</span>
sealos run ghcr.io/labring/sealos/cert-manager:v1.14.6
</code></pre>
<p><em>注：需提前配置好SSH免密登录环境</em></p>
<h4 data-id="heading-4">1.2 ArgoCD部署</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># deploy/base/argocd/install.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">argoproj.io/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Application</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">argocd</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">argocd</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">project:</span> <span class="hljs-string">default</span>
  <span class="hljs-attr">source:</span>
    <span class="hljs-attr">repoURL:</span> <span class="hljs-string">https://github.com/argoproj/argo-helm</span>
    <span class="hljs-attr">targetRevision:</span> <span class="hljs-string">main</span>
    <span class="hljs-attr">chart:</span> <span class="hljs-string">argo-cd</span>
    <span class="hljs-attr">helm:</span>
      <span class="hljs-attr">values:</span> <span class="hljs-string">|
        server:
          service:
            type: ClusterIP
</span>  <span class="hljs-attr">destination:</span>
    <span class="hljs-attr">server:</span> <span class="hljs-string">https://kubernetes.default.svc</span>
    <span class="hljs-attr">namespace:</span> <span class="hljs-string">argocd</span>
  <span class="hljs-attr">syncPolicy:</span>
    <span class="hljs-attr">automated:</span>
      <span class="hljs-attr">prune:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">selfHeal:</span> <span class="hljs-literal">true</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">二、流水线设计</h3>
<h4 data-id="heading-6">2.1 GitLab CI配置</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .gitlab-ci.yml</span>
stages:
  - build
  - <span class="hljs-built_in">test</span>
  - deploy-dev
  - deploy-staging
  - deploy-prod

variables:
  DOCKER_HOST: tcp://docker:2375
  KUBECONFIG: /etc/deploy/.kube/config

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t <span class="hljs-variable">${CI_REGISTRY_IMAGE}</span>:<span class="hljs-variable">${CI_COMMIT_SHORT_SHA}</span> .
    - docker push <span class="hljs-variable">${CI_REGISTRY_IMAGE}</span>:<span class="hljs-variable">${CI_COMMIT_SHORT_SHA}</span>

<span class="hljs-built_in">test</span>:
  stage: <span class="hljs-built_in">test</span>
  image: maven:3.8.6
  script:
    - mvn clean <span class="hljs-built_in">test</span> -Dspring.profiles.active=<span class="hljs-built_in">test</span>

deploy-dev:
  stage: deploy-dev
  image: bitnami/kubectl:latest
  script:
    - kubectl config set-cluster sealos --server=<span class="hljs-variable">${K8S_DEV_SERVER}</span>
    - kubectl config set-credentials dev-admin --token=<span class="hljs-variable">${DEV_TOKEN}</span>
    - kubectl <span class="hljs-built_in">set</span> image deployment/springcloud-demo-1 springcloud-demo= <span class="hljs-variable">${CI_REGISTRY_IMAGE}</span>:<span class="hljs-variable">${CI_COMMIT_SHORT_SHA}</span> -n dev
  only:
    - dev
</code></pre>
<h4 data-id="heading-7">2.2 ArgoCD应用清单</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># deploy/applications/springcloud-dev.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">argoproj.io/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Application</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">springcloud-dev</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">argocd</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">project:</span> <span class="hljs-string">default</span>
  <span class="hljs-attr">source:</span>
    <span class="hljs-attr">repoURL:</span> <span class="hljs-string">https://gitlab.com/myorg/springcloud-demo.git</span>
    <span class="hljs-attr">targetRevision:</span> <span class="hljs-string">dev</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">deploy/overlays/dev</span>
  <span class="hljs-attr">destination:</span>
    <span class="hljs-attr">server:</span> <span class="hljs-string">https://kubernetes.default.svc</span>
    <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev</span>
  <span class="hljs-attr">syncPolicy:</span>
    <span class="hljs-attr">automated:</span>
      <span class="hljs-attr">prune:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">selfHeal:</span> <span class="hljs-literal">true</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">三、多环境部署策略</h3>
<h4 data-id="heading-9">3.1 命名空间隔离</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 创建环境命名空间</span>
kubectl create namespace dev <span class="hljs-attr">--labels</span>=env=development
kubectl create namespace staging <span class="hljs-attr">--labels</span>=env=staging
kubectl create namespace prod <span class="hljs-attr">--labels</span>=env=production
</code></pre>
<h4 data-id="heading-10">3.2 蓝绿部署配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># deploy/overlays/prod/rollout.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">argoproj.io/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Rollout</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">springcloud-demo</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">strategy:</span>
    <span class="hljs-attr">blueGreen:</span>
      <span class="hljs-attr">activeService:</span> <span class="hljs-string">springcloud-demo-active</span>
      <span class="hljs-attr">previewService:</span> <span class="hljs-string">springcloud-demo-preview</span>
      <span class="hljs-attr">autoPromotionEnabled:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">autoPromotionSeconds:</span> <span class="hljs-number">30</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">springcloud-demo</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">registry.gitlab.com/myorg/springcloud-demo:latest</span>
</code></pre>
<h4 data-id="heading-11">3.3 金丝雀发布策略</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># deploy/overlays/prod/canary.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">argoproj.io/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Rollout</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">springcloud-demo-canary</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">5</span>
  <span class="hljs-attr">strategy:</span>
    <span class="hljs-attr">canary:</span>
      <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">setWeight:</span> <span class="hljs-number">20</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">pause:</span> {<span class="hljs-attr">duration:</span> <span class="hljs-string">5m</span>}
      <span class="hljs-bullet">-</span> <span class="hljs-attr">setWeight:</span> <span class="hljs-number">50</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">pause:</span> {<span class="hljs-attr">duration:</span> <span class="hljs-string">5m</span>}
      <span class="hljs-bullet">-</span> <span class="hljs-attr">setWeight:</span> <span class="hljs-number">100</span>
</code></pre>
<hr/>
<h3 data-id="heading-12">四、监控与告警</h3>
<h4 data-id="heading-13">4.1 ArgoCD通知配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># deploy/base/argocd/notifications.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">argoproj.io/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Application</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">argocd-notifications</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-attr">notifications.argoproj.io/subscribe.on-sync-succeeded.slack:</span> <span class="hljs-comment">#prod-alerts</span>
    <span class="hljs-attr">notifications.argoproj.io/subscribe.on-sync-failed.slack:</span> <span class="hljs-comment">#prod-alerts</span>
</code></pre>
<h4 data-id="heading-14">4.2 健康检查配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># deploy/overlays/prod/healthchecks.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">argoproj.io/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">AppProject</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">production</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">destinations:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">namespace:</span> <span class="hljs-string">prod</span>
    <span class="hljs-attr">server:</span> <span class="hljs-string">https://kubernetes.default.svc</span>
  <span class="hljs-attr">syncWindows:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">applications:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">'*'</span>
    <span class="hljs-attr">kind:</span> <span class="hljs-string">allow</span>
    <span class="hljs-attr">schedule:</span> <span class="hljs-string">'* * * * *'</span>
    <span class="hljs-attr">duration:</span> <span class="hljs-string">1h</span>
</code></pre>
<hr/>
<h3 data-id="heading-15">五、SpringCloud项目适配</h3>
<h4 data-id="heading-16">5.1 Kubernetes资源清单</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># deploy/manifests/service.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">springcloud-demo</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">springcloud-demo</span>
  <span class="hljs-attr">ports:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span>
</code></pre>
<h4 data-id="heading-17">5.2 配置中心集成</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># config-server/config-repo/application-prod.yml</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">config:</span>
      <span class="hljs-attr">server:</span>
        <span class="hljs-attr">git:</span>
          <span class="hljs-attr">uri:</span> <span class="hljs-string">https://gitlab.com/myorg/config-repo</span>
          <span class="hljs-attr">search-paths:</span> <span class="hljs-string">'{application}/{profile}'</span>
</code></pre>
<hr/>
<p>通过Sealos与GitLab CI/ArgoCD的深度集成，我们构建了一套完整的SpringCloud项目CI/CD流水线。该方案实现了从代码提交到生产部署的全自动化，支持多环境隔离和智能发布策略。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Sealos详解与应用实战：从架构到落地的完整指南]]></title>    <link>https://juejin.cn/post/7598103943561936939</link>    <guid>https://juejin.cn/post/7598103943561936939</guid>    <pubDate>2026-01-23T03:42:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598103943561936939" data-draft-id="7598083101361700870" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Sealos详解与应用实战：从架构到落地的完整指南"/> <meta itemprop="keywords" content="DevOps"/> <meta itemprop="datePublished" content="2026-01-23T03:42:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Sealos详解与应用实战：从架构到落地的完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:42:13.000Z" title="Fri Jan 23 2026 03:42:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Sealos概述：云原生时代的智能云操作系统</h2>
<h3 data-id="heading-1">（一）核心定位与设计理念</h3>
<p>Sealos是一款<strong>以应用为中心的智能云操作系统</strong>，基于Kubernetes内核构建，旨在通过云原生技术简化云环境的管理与应用交付。其核心设计理念包括：</p>
<ul>
<li><strong>以Kubernetes为内核</strong>：将Kubernetes作为底层资源调度与管理引擎，继承其强大的容器编排能力；</li>
<li><strong>集群镜像（Cluster Image）</strong> ：创新应用交付方式，将应用及其依赖（配置、存储、网络策略等）打包为可复用的集群镜像，实现原子化交付与版本控制；</li>
<li><strong>多云统一管理</strong>：支持公有云、私有云与边缘环境的统一架构，提供一致的操作体验与无缝迁移能力；</li>
<li><strong>应用-centric</strong>：聚焦应用全生命周期管理，覆盖部署、配置、监控、扩展等环节，降低用户的使用门槛。</li>
</ul>
<h3 data-id="heading-2">（二）核心架构解析</h3>
<p>Sealos的架构分为<strong>控制平面</strong>与<strong>数据平面</strong>两层，结合Kubernetes的原生能力与扩展机制，实现高效的云资源管理：</p>
<h4 data-id="heading-3">1. 控制平面：集群镜像与Operator模式</h4>
<ul>
<li><strong>集群镜像</strong>：是Sealos的核心创新，将应用及其所有依赖（如Kubernetes组件、数据库、中间件）打包为一个镜像，类似于容器镜像但包含完整的集群状态。用户可通过<code>sealos run</code>命令一键部署集群镜像，实现应用的快速交付；</li>
<li><strong>Operator模式</strong>：通过自定义Operator（如<code>sealos-operator</code>）扩展Kubernetes的API，实现对复杂应用（如数据库、分布式存储）的生命周期管理。例如，<code>sealos-operator</code>可自动处理集群的初始化、升级与故障恢复；</li>
<li><strong>声明式API</strong>：基于Kubernetes的声明式API，用户通过YAML文件定义集群与应用的状态，Sealos自动协调实际状态与期望状态的一致性。</li>
</ul>
<h4 data-id="heading-4">2. 数据平面：Kubernetes原生资源与存储管理</h4>
<ul>
<li><strong>计算资源</strong>：通过Kubernetes的<code>Deployment</code>、<code>StatefulSet</code>等工作负载对象管理容器化应用，支持自动伸缩与滚动升级；</li>
<li><strong>存储资源</strong>：支持多种存储后端（如Ceph、NFS、云盘），通过<code>PersistentVolume</code>（PV）与<code>PersistentVolumeClaim</code>（PVC）实现存储的持久化与动态分配。例如，在部署有状态应用（如数据库）时，可通过<code>volumeClaimTemplates</code>自动创建PVC；</li>
<li><strong>网络资源</strong>：通过Kubernetes的<code>Service</code>、<code>Ingress</code>与CNI插件（如Calico、Flannel）实现网络通信，支持Headless Service（无头服务）用于有状态应用的Pod间直接通信。</li>
</ul>
<h3 data-id="heading-5">（三）核心功能特性</h3>
<p>Sealos提供丰富的功能特性，覆盖应用全生命周期与云环境管理：</p>
<ul>
<li><strong>应用全生命周期管理</strong>：支持一键部署（从应用商店或自定义镜像）、配置管理（图形化界面或YAML文件）、自动伸缩（基于CPU/内存使用率）、滚动升级（零 downtime）；</li>
<li><strong>数据库即服务（DBaaS）</strong> ：内置MySQL、PostgreSQL、MongoDB、Redis等数据库的管理能力，支持主从复制、自动备份、监控集成；</li>
<li><strong>混合云统一管理</strong>：通过统一的操作界面与API，实现公有云（如阿里云、AWS）与私有云（如OpenStack）的资源调度与负载均衡，支持应用的无缝迁移；</li>
<li><strong>监控与告警</strong>：集成Prometheus、Grafana等监控工具，实时追踪集群资源使用（CPU、内存、存储）与应用状态，支持自定义告警规则（如磁盘使用率超过90%触发告警）；</li>
<li><strong>安全机制</strong>：内置租户隔离（通过Kubernetes的Namespace）、网络策略（Network Policy）、证书管理（Cert Manager）、审计日志（Audit Log），保障云环境的安全性。</li>
</ul>
<h2 data-id="heading-6">二、Sealos应用实战：从部署到运维的完整流程</h2>
<h3 data-id="heading-7">（一）环境准备与安装部署</h3>
<p>Sealos支持多种安装方式（单机、集群、离线），以下以<strong>多节点高可用集群部署</strong>为例，介绍具体步骤：</p>
<h4 data-id="heading-8">1. 环境要求</h4>
<ul>
<li><strong>节点配置</strong>：至少3台Master节点（推荐4核8G以上）、2台Node节点（推荐4核16G以上）；</li>
<li><strong>操作系统</strong>：支持CentOS 7+、Ubuntu 20.04+、Rocky Linux 8+；</li>
<li><strong>网络要求</strong>：节点间网络互通（开放SSH端口22、Kubernetes API端口6443、CNI端口8472等）；</li>
<li><strong>依赖软件</strong>：需安装Docker或Containerd（推荐Containerd）。</li>
</ul>
<h4 data-id="heading-9">2. 安装Sealos CLI</h4>
<p>Sealos CLI是管理集群的核心工具，可通过以下命令安装：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 安装最新版本（支持amd64/arm64架构）</span>
curl -sfL <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/raw.githubusercontent.com/labring</span><span class="hljs-regexp">/sealos/main</span><span class="hljs-regexp">/scripts/install</span>.sh |<span class="hljs-params"> sh -

# 验证安装
sealos version
</span></code></pre>
<h4 data-id="heading-10">3. 部署高可用Kubernetes集群</h4>
<p>使用<code>sealos run</code>命令部署集群，指定Master与Node节点的IP地址、集群镜像（如<code>labring/kubernetes:v1.27.11</code>）与网络插件（如<code>labring/calico:v3.24.1</code>）：</p>
<pre><code class="hljs language-bash" lang="bash">sealos run labring/kubernetes:v1.27.11 \
labring/calico:v3.24.1 \
labring/cert-manager:v1.14.6 \
labring/openebs:v3.10.0 \
--masters 192.168.1.101,192.168.1.102,192.168.1.103 \
--nodes 192.168.1.201,192.168.1.202 \
--pod-cidr 10.244.0.0/16 \
--service-cidr 10.96.0.0/12
</code></pre>
<ul>
<li><code>--masters</code>：指定Master节点的IP地址（多个用逗号分隔）；</li>
<li><code>--nodes</code>：指定Node节点的IP地址（多个用逗号分隔）；</li>
<li><code>--pod-cidr</code>：Pod网络的CIDR（默认10.244.0.0/16）；</li>
<li><code>--service-cidr</code>：Service网络的CIDR（默认10.96.0.0/12）。</li>
</ul>
<h4 data-id="heading-11">4. 验证集群状态</h4>
<p>部署完成后，使用以下命令验证集群状态：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 查看节点状态</span>
kubectl <span class="hljs-keyword">get</span> nodes

<span class="hljs-meta"># 查看Pod状态（所有命名空间）</span>
kubectl <span class="hljs-keyword">get</span> pods -A
</code></pre>
<h3 data-id="heading-12">（二）应用部署实战：以高可用MinIO为例</h3>
<p>MinIO是常用的开源对象存储系统，适合存储非结构化数据（如图片、视频）。以下介绍如何使用Sealos部署高可用MinIO集群：</p>
<h4 data-id="heading-13">1. 编写MinIO集群配置文件（<code>minio-cluster.yaml</code>）</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">storage.min.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Cluster</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">minio-ha</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">4</span> <span class="hljs-comment"># 推荐奇数个节点（3-7个），此处为4个</span>
  <span class="hljs-attr">driveConfig:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">"fs"</span> <span class="hljs-comment"># 存储类型为文件系统（或"cloud"使用云存储）</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">"/data"</span> <span class="hljs-comment"># 数据存储路径</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">requests:</span>
      <span class="hljs-attr">cpu:</span> <span class="hljs-string">"500m"</span> <span class="hljs-comment"># 每个节点分配的CPU</span>
      <span class="hljs-attr">memory:</span> <span class="hljs-string">"1Gi"</span> <span class="hljs-comment"># 每个节点分配的内存</span>
  <span class="hljs-attr">expose:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">"LoadBalancer"</span> <span class="hljs-comment"># 暴露方式为负载均衡（生产环境建议使用Ingress）</span>
</code></pre>
<h4 data-id="heading-14">2. 部署MinIO集群</h4>
<p>使用<code>sealos apply</code>命令部署MinIO集群：</p>
<pre><code class="hljs">sealos apply -f minio-cluster.yaml
</code></pre>
<h4 data-id="heading-15">3. 验证MinIO部署</h4>
<ul>
<li>查看MinIO Pod状态：<code>kubectl get pods -n minio-system</code>；</li>
<li>获取MinIO访问凭证：<code>kubectl get secret minio-credentials -o jsonpath="{.data.ACCESS_KEY}" | base64 -d</code>（Access Key）、<code>kubectl get secret minio-credentials -o jsonpath="{.data.SECRET_KEY}" | base64 -d</code>（Secret Key）；</li>
<li>访问MinIO控制台：通过负载均衡IP或域名访问（如<code>http://&lt;load-balancer-ip&gt;:9000</code>），使用上述凭证登录。</li>
</ul>
<h3 data-id="heading-16">（三）有状态应用部署：StatefulSet与Headless Service实战</h3>
<p>对于有状态应用（如数据库、分布式系统），Sealos通过<code>StatefulSet</code>与<code>Headless Service</code>提供支持，确保Pod的网络标识与存储持久化。以下以部署Nginx有状态应用为例：</p>
<h4 data-id="heading-17">1. 创建Headless Service（<code>nginx-headless.yaml</code>）</h4>
<p>Headless Service不分配集群IP，直接返回后端Pod的IP地址，适合有状态应用的Pod间直接通信：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-headless</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span> <span class="hljs-comment"># 关键：设置为None表示Headless Service</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">web</span>
</code></pre>
<h4 data-id="heading-18">2. 创建StatefulSet（<code>nginx-statefulset.yaml</code>）</h4>
<p><code>StatefulSet</code>为每个Pod分配唯一且固定的标识符（如<code>web-0</code>、<code>web-1</code>），确保Pod重新调度后网络标识与存储不变：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">web</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span>
  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">"nginx-headless"</span> <span class="hljs-comment"># 关联到Headless Service</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">10</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">registry.k8s.io/nginx-slim:0.8</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">web</span>
        <span class="hljs-attr">volumeMounts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">www</span>
          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/usr/share/nginx/html</span>
  <span class="hljs-attr">volumeClaimTemplates:</span> <span class="hljs-comment"># 自动创建PVC，实现存储持久化</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">www</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">accessModes:</span> [ <span class="hljs-string">"ReadWriteOnce"</span> ]
      <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">"sealos-standard"</span> <span class="hljs-comment"># 使用Sealos提供的存储类</span>
      <span class="hljs-attr">resources:</span>
        <span class="hljs-attr">requests:</span>
          <span class="hljs-attr">storage:</span> <span class="hljs-string">1Gi</span> <span class="hljs-comment"># 每个Pod分配1GB存储</span>
</code></pre>
<h4 data-id="heading-19">3. 应用配置并验证</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 应用Headless Service与StatefulSet配置</span>
sealos apply -f nginx-headless.yaml -f nginx-statefulset.yaml

<span class="hljs-meta"># 查看Pod状态（应为Running）</span>
kubectl <span class="hljs-keyword">get</span> pods -l app=nginx

<span class="hljs-meta"># 查看PVC状态（应为Bound）</span>
kubectl <span class="hljs-keyword">get</span> pvc
</code></pre>
<h3 data-id="heading-20">（四）运维管理实战：监控、日志与故障排查</h3>
<p>Sealos提供完善的运维工具，帮助用户监控集群状态、排查故障：</p>
<h4 data-id="heading-21">1. 监控与告警</h4>
<ul>
<li>
<p><strong>集成Prometheus与Grafana</strong>：Sealos内置Prometheus（ metrics 收集）与Grafana（可视化），可通过<code>sealos run</code>命令部署：</p>
<pre><code class="hljs language-bash" lang="bash">sealos run labring/prometheus:v2.45.0 labring/grafana:v10.0.0
</code></pre>
</li>
<li>
<p><strong>关键监控指标</strong>：包括节点CPU/内存使用率、Pod状态、存储使用率、网络流量等；</p>
</li>
<li>
<p><strong>告警规则</strong>：可自定义告警规则（如磁盘使用率超过90%、Pod处于CrashLoopBackOff状态），通过邮件、Slack等方式通知用户。</p>
</li>
</ul>
<h4 data-id="heading-22">2. 日志管理</h4>
<ul>
<li>
<p><strong>收集日志</strong>：Sealos集成ELK（Elasticsearch、Logstash、Kibana）或Loki（轻量级日志收集），可通过以下命令部署Loki：</p>
<pre><code class="hljs language-bash" lang="bash">sealos run labring/loki:v2.8.0 labring/promtail:v2.8.0
</code></pre>
</li>
<li>
<p><strong>查看日志</strong>：使用<code>kubectl logs</code>命令查看Pod日志，或通过Grafana/Loki界面可视化日志：</p>
<pre><code class="hljs language-xml" lang="xml"># 查看指定Pod的日志
kubectl logs <span class="hljs-tag">&lt;<span class="hljs-name">pod-name</span>&gt;</span> -n <span class="hljs-tag">&lt;<span class="hljs-name">namespace</span>&gt;</span>

# 实时查看日志
kubectl logs -f <span class="hljs-tag">&lt;<span class="hljs-name">pod-name</span>&gt;</span> -n <span class="hljs-tag">&lt;<span class="hljs-name">namespace</span>&gt;</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-23">3. 故障排查</h4>
<p>Sealos提供<code>sealos debug</code>命令，帮助用户快速排查集群故障：</p>
<ul>
<li><strong>集群健康检查</strong>：<code>sealos doctor</code>，检查节点状态、网络连通性、Kubernetes组件状态；</li>
<li><strong>节点调试</strong>：<code>sealos debug node &lt;node-name&gt;</code>，查看节点日志、资源使用情况；</li>
<li><strong>网络诊断</strong>：<code>sealos debug network</code>，检查网络策略、Service配置、Pod间通信；</li>
<li><strong>存储检查</strong>：<code>sealos debug storage</code>，查看PV/PVC状态、存储性能。</li>
</ul>
<p>此外，用户也可使用Kubernetes原生工具排查故障：</p>
<ul>
<li><code>kubectl describe pod &lt;pod-name&gt;</code>：查看Pod详细信息（如事件、容器状态）；</li>
<li><code>kubectl get events --sort-by='.lastTimestamp' -A</code>：查看集群事件（按时间排序）；</li>
<li><code>kubectl exec -it &lt;pod-name&gt; -- /bin/bash</code>：进入Pod调试（如查看配置文件、运行命令）。</li>
</ul>
<h2 data-id="heading-24">三、Sealos典型应用场景</h2>
<h3 data-id="heading-25">（一）企业级SaaS应用部署</h3>
<p>SaaS提供商需要支持多租户、自动伸缩、高可用等特性，Sealos可提供：</p>
<ul>
<li><strong>多租户隔离</strong>：通过Kubernetes的Namespace实现租户隔离，每个租户拥有独立的资源与网络；</li>
<li><strong>自动伸缩</strong>：基于CPU/内存使用率自动调整Pod数量，应对流量波动；</li>
<li><strong>数据库托管</strong>：内置MySQL、PostgreSQL等数据库服务，支持主从复制与自动备份；</li>
<li><strong>统一监控</strong>：通过Grafana查看所有租户的应用状态，及时发现问题。</li>
</ul>
<h3 data-id="heading-26">（二）传统应用现代化改造</h3>
<p>传统应用（如单体应用）迁移到云原生环境时，Sealos可提供：</p>
<ul>
<li><strong>容器化封装</strong>：将传统应用打包为Docker镜像，通过<code>sealos run</code>命令部署；</li>
<li><strong>服务网格集成</strong>：集成Istio等服务网格，实现流量管理、熔断、 tracing；</li>
<li><strong>配置中心化管理</strong>：通过Sealos的配置管理功能，集中管理应用的配置文件（如数据库连接串）；</li>
<li><strong>自动化运维</strong>：通过<code>StatefulSet</code>与<code>Deployment</code>实现应用的滚动升级与故障恢复。</li>
</ul>
<h3 data-id="heading-27">（三）边缘计算场景</h3>
<p>边缘计算需要轻量级、离线运行、边缘-中心协同的特性，Sealos可提供：</p>
<ul>
<li><strong>小型化部署</strong>：Sealos支持轻量级Kubernetes集群（如K3s），适合边缘设备（如路由器、网关）；</li>
<li><strong>离线运行</strong>：支持离线安装（提前导入镜像），无需依赖互联网；</li>
<li><strong>边缘-中心协同</strong>：通过统一的API实现边缘集群与中心集群的协同（如边缘数据采集、中心数据分析）；</li>
<li><strong>低延迟</strong>：边缘集群靠近数据源，减少数据传输延迟，适合实时应用（如视频监控、工业物联网）。</li>
</ul>
<h2 data-id="heading-28">四、Sealos进阶技巧与最佳实践</h2>
<h3 data-id="heading-29">（一）自定义集群镜像</h3>
<p>用户可根据需求自定义集群镜像，包含应用及其依赖：</p>
<ol>
<li>
<p><strong>编写Kubefile</strong>：定义镜像的构建过程（如基础镜像、复制文件、运行命令）；</p>
<pre><code class="hljs language-bash" lang="bash">FROM labring/kubernetes:v1.27.11
COPY ./minio-cluster.yaml /etc/minio/
CMD [<span class="hljs-string">"kubectl apply -f /etc/minio/minio-cluster.yaml"</span>]
</code></pre>
</li>
<li>
<p><strong>构建镜像</strong>：使用<code>sealos build</code>命令构建集群镜像；</p>
<pre><code class="hljs language-perl" lang="perl">sealos build -t <span class="hljs-keyword">my</span>-minio-cluster:v1.<span class="hljs-number">0</span> .
</code></pre>
</li>
<li>
<p><strong>推送镜像</strong>：将镜像推送到镜像仓库（如Docker Hub、阿里云镜像仓库）；</p>
<pre><code class="hljs language-perl" lang="perl">sealos <span class="hljs-keyword">push</span> <span class="hljs-keyword">my</span>-minio-cluster:v1.<span class="hljs-number">0</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-30">（二）配置CI/CD流水线</h3>
<p>Sealos支持CI/CD流水线，实现应用的自动化构建、测试与部署：</p>
<ol>
<li>
<p><strong>创建<code>.sealos-ci.yml</code>文件</strong>：定义CI/CD流程（如代码提交后自动构建镜像、部署集群）；</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">MyApp</span> <span class="hljs-string">CI/CD</span>
<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">sealos</span>
    <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">image</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">sealos</span> <span class="hljs-string">build</span> <span class="hljs-string">-t</span> <span class="hljs-string">myapp:${{</span> <span class="hljs-string">github.sha</span> <span class="hljs-string">}}</span> <span class="hljs-string">.</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Push</span> <span class="hljs-string">image</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">sealos</span> <span class="hljs-string">push</span> <span class="hljs-string">myapp:${{</span> <span class="hljs-string">github.sha</span> <span class="hljs-string">}}</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">cluster</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">sealos</span> <span class="hljs-string">run</span> <span class="hljs-string">myapp:${{</span> <span class="hljs-string">github.sha</span> <span class="hljs-string">}}</span>
</code></pre>
</li>
<li>
<p><strong>运行CI/CD流水线</strong>：使用<code>sealos ci run</code>命令运行流水线；</p>
<pre><code class="hljs language-arduino" lang="arduino">sealos ci run
</code></pre>
</li>
</ol>
<h3 data-id="heading-31">（三）性能优化建议</h3>
<ul>
<li><strong>调整资源配额</strong>：根据应用需求合理分配CPU、内存资源，避免资源浪费；</li>
<li><strong>启用自动扩展</strong>：通过Horizontal Pod Autoscaler（HPA）自动调整Pod数量，应对流量波动；</li>
<li><strong>优化存储性能</strong>：使用SSD存储（如NVMe）提升I/O性能，对于大文件存储，可启用Jumbo Frame（MTU=9000）；</li>
<li><strong>减少网络延迟</strong>：使用Calico等CNI插件的BGP模式，减少网络跳转，提升Pod间通信效率。</li>
</ul>
<p>Sealos作为一款以应用为中心的智能云操作系统，通过Kubernetes内核与集群镜像等创新，简化了云环境的管理与应用交付。其核心优势包括：</p>
<ul>
<li><strong>简化部署</strong>：通过集群镜像实现一键部署，减少手动配置；</li>
<li><strong>多云支持</strong>：统一公有云、私有云与边缘环境的管理，支持应用无缝迁移；</li>
<li><strong>应用全生命周期管理</strong>：覆盖部署、配置、监控、扩展等环节，降低用户门槛；</li>
<li><strong>高可用与扩展性</strong>：支持多节点集群、自动伸缩、故障恢复，满足企业生产需求。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Rust入门】第二章：通用编程概念]]></title>    <link>https://juejin.cn/post/7598089234033999872</link>    <guid>https://juejin.cn/post/7598089234033999872</guid>    <pubDate>2026-01-23T03:40:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598089234033999872" data-draft-id="7598203055751495715" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Rust入门】第二章：通用编程概念"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2026-01-23T03:40:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="红鲤绿鲤"/> <meta itemprop="url" content="https://juejin.cn/user/4125023359221614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Rust入门】第二章：通用编程概念
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023359221614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    红鲤绿鲤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:40:47.000Z" title="Fri Jan 23 2026 03:40:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>第一章我们打通了“任督二脉”（环境配置），现在进入 <strong>第二章：通用编程概念</strong>。</p>
<p>这一章非常关键。虽然大部分编程语言都有变量、函数和循环，但 Rust 在这些基础概念上有一些<strong>独特的“反直觉”设计</strong>。正是这些设计，构成了 Rust 安全性的基石。</p>
<p>请新建一个项目用于本章练习：</p>
<pre><code class="hljs language-bash" lang="bash">cargo new rust_basics
<span class="hljs-built_in">cd</span> rust_basics
</code></pre>
<hr/>
<h3 data-id="heading-0">🚀 第二章：通用编程概念</h3>
<h4 data-id="heading-1">2.1 变量与可变性 (Variables &amp; Mutability)</h4>
<p>这是 Rust 新手遇到的第一个“坑”，也是 Rust 最重要的特性之一：<strong>默认不可变</strong>。</p>
<p><strong>代码实验 1：尝试修改变量</strong>
打开 <code>src/main.rs</code>，输入以下代码：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span> = <span class="hljs-number">5</span>;
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"x 的值是: {}"</span>, x);
    x = <span class="hljs-number">6</span>; <span class="hljs-comment">// 试图修改 x</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"x 的值是: {}"</span>, x);
}
</code></pre>
<p>运行 <code>cargo run</code>。
<strong>结果</strong>：❌ 报错！<code>cannot assign twice to immutable variable x</code>（不能对不可变变量 x 二次赋值）。</p>
<p><strong>核心概念</strong>：
在 Rust 中，一旦你用 <code>let</code> 绑定了一个值，它默认就是<strong>只读</strong>的。这为了防止你无意中修改了不该修改的数据，从而导致 bug（特别是在多线程环境下）。</p>
<p><strong>修正：加上 <code>mut</code> 关键字</strong>
如果你想让变量可变，必须显式告诉编译器：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">x</span> = <span class="hljs-number">5</span>; <span class="hljs-comment">// 注意这里的 mut</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"x 的值是: {}"</span>, x);
    x = <span class="hljs-number">6</span>;
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"x 的值是: {}"</span>, x);
}
</code></pre>
<p>再次运行，成功！✅</p>
<hr/>
<h4 data-id="heading-2">2.2 隐藏 (Shadowing)</h4>
<p>这是一个 Rust 很有趣的特性。你可以在同一个作用域内多次声明同名变量。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span> = <span class="hljs-number">5</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span> = x + <span class="hljs-number">1</span>; <span class="hljs-comment">// 第二个 x "隐藏" 了第一个 x</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span> = x * <span class="hljs-number">2</span>; <span class="hljs-comment">// 第三个 x "隐藏" 了第二个 x</span>

    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"x 的值是: {}"</span>, x); <span class="hljs-comment">// 输出 12</span>
}
</code></pre>
<p><strong>为什么需要这个？</strong>
通常用于类型转换。比如你拿到了一个字符串类型的 <code>"42"</code>，想把它转成数字类型的 <code>42</code>。</p>
<ul>
<li>在其他语言你可能需要：<code>let input_str = "42"; let input_num = parse(input_str);</code></li>
<li>在 Rust 中：<code>let input = "42"; let input = input.parse();</code> (复用名字，代码更干净)。</li>
</ul>
<hr/>
<h4 data-id="heading-3">2.3 数据类型 (Data Types)</h4>
<p>Rust 是<strong>静态强类型</strong>语言。编译时必须知道所有变量的类型。</p>
<p><strong>标量类型 (Scalar Types)</strong>
代表单个值。</p>
<ol>
<li><strong>整型</strong>：
<ul>
<li><code>i32</code> (默认，有符号 32 位整数)</li>
<li><code>u32</code> (无符号，不能是负数)</li>
<li><code>i64</code> / <code>u64</code> (64 位，常用于大数)</li>
<li><code>isize</code> / <code>usize</code> (由你的 CPU 架构决定，64位系统就是64位，常用于索引数组)</li>
</ul>
</li>
<li><strong>浮点型</strong>：<code>f64</code> (默认，双精度), <code>f32</code>。</li>
<li><strong>布尔型</strong>：<code>bool</code> (值为 <code>true</code> 或 <code>false</code>)。</li>
<li><strong>字符型</strong>：<code>char</code>。
<ul>
<li><strong>注意</strong>：Rust 的 <code>char</code> 是 4 字节的 Unicode 标量值，<strong>用单引号</strong>。它可以存储中文、Emoji 等。</li>
<li><code>let c = '中';</code> (合法)</li>
<li><code>let z = 'ℤ';</code> (合法)</li>
<li><code>let cat = '😻';</code> (合法)</li>
</ul>
</li>
</ol>
<p><strong>复合类型 (Compound Types)</strong>
可以将多个值组合成一个类型。</p>
<p><strong>1. 元组 (Tuple)</strong>
长度固定，元素类型可以不同。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 定义元组</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">tup</span>: (<span class="hljs-type">i32</span>, <span class="hljs-type">f64</span>, <span class="hljs-type">u8</span>) = (<span class="hljs-number">500</span>, <span class="hljs-number">6.4</span>, <span class="hljs-number">1</span>);

    <span class="hljs-comment">// 访问方式 1：解构 (Destructuring)</span>
    <span class="hljs-keyword">let</span> (x, y, z) = tup;
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"y 的值是: {}"</span>, y);

    <span class="hljs-comment">// 访问方式 2：使用点号索引</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">five_hundred</span> = tup.<span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">six_point_four</span> = tup.<span class="hljs-number">1</span>;
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"第一个元素: {}"</span>, five_hundred);
}
</code></pre>
<p><strong>2. 数组 (Array)</strong>
长度固定，<strong>元素类型必须相同</strong>。数据存放在栈（Stack）上。
<em>(注意：如果你需要动态长度的列表，以后我们会学 Vector，现在先学 Array)</em></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">a</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
    
    <span class="hljs-comment">// 另一种写法：[类型; 长度]</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">b</span>: [<span class="hljs-type">i32</span>; <span class="hljs-number">5</span>] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
    
    <span class="hljs-comment">// 初始化包含 5 个 3 的数组</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">c</span> = [<span class="hljs-number">3</span>; <span class="hljs-number">5</span>]; <span class="hljs-comment">// 等同于 [3, 3, 3, 3, 3]</span>

    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"a 的第一个元素: {}"</span>, a[<span class="hljs-number">0</span>]);
}
</code></pre>
<hr/>
<h4 data-id="heading-4">2.4 函数 (Functions)</h4>
<p>Rust 的函数定义非常清晰。但有一个<strong>超级重要</strong>的概念：<strong>语句 (Statements) vs 表达式 (Expressions)</strong>。</p>
<ul>
<li><strong>语句</strong>：执行操作，<strong>没有返回值</strong>。以分号 <code>;</code> 结尾。</li>
<li><strong>表达式</strong>：计算并<strong>产生一个值</strong>。<strong>没有</strong>分号。</li>
</ul>
<p><strong>代码实验 2：函数与返回值</strong></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">number</span> = <span class="hljs-number">5</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = <span class="hljs-title function_ invoke__">plus_one</span>(number);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"结果是: {}"</span>, result);
}

<span class="hljs-comment">// 定义一个函数，参数必须标注类型</span>
<span class="hljs-comment">// -&gt; i32 表示返回值类型是 i32</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">plus_one</span>(x: <span class="hljs-type">i32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> {
    x + <span class="hljs-number">1</span> <span class="hljs-comment">// &lt;--- 注意这里没有分号！这是一个表达式，它的值将作为返回值。</span>
}
</code></pre>
<p>如果你把 <code>x + 1</code> 改成 <code>x + 1;</code>（加了分号），它就变成了语句，不再返回值（默认返回空的单元类型 <code>()</code>），编译器会报错说“期望返回 i32，但实际返回了 ()”。</p>
<p><strong>这是 Rust 新手最容易犯的错误之一，请务必留意分号！</strong></p>
<hr/>
<h4 data-id="heading-5">2.5 控制流 (Control Flow)</h4>
<p><strong>1. <code>if</code> 表达式</strong>
在 Rust 中，<code>if</code> 是一个<strong>表达式</strong>，这意味着它可以赋值给变量。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">condition</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// 类似于三元运算符 condition ? 5 : 6</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">number</span> = <span class="hljs-keyword">if</span> condition { <span class="hljs-number">5</span> } <span class="hljs-keyword">else</span> { <span class="hljs-number">6</span> }; 

    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Number is: {}"</span>, number);
}
</code></pre>
<p><em>注意：<code>if</code> 和 <code>else</code> 返回的数据类型必须一致。</em></p>
<p><strong>2. 循环 (Loops)</strong>
Rust 有三种循环：<code>loop</code>, <code>while</code>, <code>for</code>。</p>
<ul>
<li><strong><code>loop</code></strong>: 无限循环，直到你手动 <code>break</code>。</li>
<li><strong><code>while</code></strong>: 条件循环。</li>
<li><strong><code>for</code></strong>: 遍历集合（最常用，最安全）。</li>
</ul>
<p><strong>代码实验 3：最常用的 for 循环</strong></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 遍历一个数组</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">a</span> = [<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>, <span class="hljs-number">40</span>, <span class="hljs-number">50</span>];

    <span class="hljs-comment">// element 会自动获取数组中的每个值</span>
    <span class="hljs-keyword">for</span> <span class="hljs-variable">element</span> <span class="hljs-keyword">in</span> a {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"值为: {}"</span>, element);
    }

    <span class="hljs-comment">// 使用 Range (范围)</span>
    <span class="hljs-comment">// (1..4) 包含 1, 2, 3，不包含 4。如果想要包含 4，用 (1..=4)</span>
    <span class="hljs-comment">// .rev() 是反转的意思</span>
    <span class="hljs-keyword">for</span> <span class="hljs-variable">number</span> <span class="hljs-keyword">in</span> (<span class="hljs-number">1</span>..<span class="hljs-number">4</span>).<span class="hljs-title function_ invoke__">rev</span>() {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"倒计时: {}!"</span>, number);
    }
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"发射！"</span>);
}
</code></pre>
<hr/>
<h3 data-id="heading-6">📝 第二章总结与作业</h3>
<p><strong>总结：</strong></p>
<ol>
<li><strong>变量</strong>：默认不可变，改值需加 <code>mut</code>。</li>
<li><strong>Shadowing</strong>：同名变量可以覆盖旧变量，常用于类型转换。</li>
<li><strong>类型</strong>：知道 <code>i32</code>, <code>f64</code>, <code>bool</code>, <code>char</code>，以及 Tuple 和 Array。</li>
<li><strong>函数</strong>：<strong>不加分号</strong>的代码行是表达式，代表返回值。</li>
<li><strong>循环</strong>：首选 <code>for</code> 循环遍历数据。</li>
</ol>
<p><strong>作业（巩固你的知识）：</strong></p>
<ol>
<li>写一个函数 <code>fahrenheit_to_celsius(f: f64) -&gt; f64</code>，将华氏温度转换为摄氏温度。公式：<code>C = (F - 32) / 1.8</code>。</li>
<li>在 <code>main</code> 函数中，用一个循环（比如 5 次），计算并打印不同华氏度的摄氏度值。</li>
<li><strong>进阶挑战</strong>：写一个函数生成斐波那契数列的第 n 项。（如果 n=1 返回 1，n=2 返回 1，n=3 返回 2...）。</li>
</ol>
<p>做完这些，你就掌握了 Rust 的基本语法框架！</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Rust入门】第三章：所有权 (Ownership) 与借用 (Borrowing)]]></title>    <link>https://juejin.cn/post/7598127455133171712</link>    <guid>https://juejin.cn/post/7598127455133171712</guid>    <pubDate>2026-01-23T03:42:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598127455133171712" data-draft-id="7598174154664362019" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Rust入门】第三章：所有权 (Ownership) 与借用 (Borrowing)"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2026-01-23T03:42:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="红鲤绿鲤"/> <meta itemprop="url" content="https://juejin.cn/user/4125023359221614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Rust入门】第三章：所有权 (Ownership) 与借用 (Borrowing)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023359221614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    红鲤绿鲤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:42:48.000Z" title="Fri Jan 23 2026 03:42:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>现在，请深吸一口气，坐直身体。我们要进入 <strong>第三章：所有权 (Ownership) 与借用 (Borrowing)</strong>。</p>
<p>⚠️ <strong>警告</strong>：这是 Rust 学习曲线中最陡峭的部分。</p>
<ul>
<li>在 C/C++ 中，你需要手动管理内存（malloc/free），容易忘释放（内存泄漏）或释放两次（崩溃）。</li>
<li>在 Java/Python/Go 中，有垃圾回收器（GC）帮你自动回收，但会消耗性能，导致程序偶尔卡顿。</li>
<li><strong>Rust 选择了第三条路</strong>：通过一套<strong>编译时的规则</strong>（所有权）来管理内存。编译器非常严格，如果你违反规则，代码根本无法编译通过。</li>
</ul>
<p>这一章一旦顿悟，你就算正式“入门” Rust 了！</p>
<p>请新建项目：</p>
<pre><code class="hljs language-bash" lang="bash">cargo new ownership_test
<span class="hljs-built_in">cd</span> ownership_test
</code></pre>
<hr/>
<h3 data-id="heading-0">🚀 第三章：所有权 (Ownership)</h3>
<h4 data-id="heading-1">3.1 栈 (Stack) 与 堆 (Heap) —— 前置知识</h4>
<p>为了理解 Rust 为什么这么做，你需要简单了解内存：</p>
<ul>
<li><strong>栈 (Stack)</strong>：像一摞盘子。存取极快，但<strong>大小必须固定</strong>。比如 <code>i32</code>、<code>char</code>、<code>[i32; 5]</code> 都存在栈上。</li>
<li><strong>堆 (Heap)</strong>：像一个杂乱的大仓库。如果你需要存一段文字（String），因为不知道用户会输入多长，所以必须存在堆上。你把数据扔进仓库，管理员给你一张<strong>小纸条（指针）</strong>，上面写着数据存放的位置。你把这张小纸条放在栈上。</li>
</ul>
<h4 data-id="heading-2">3.2 所有权的三大铁律</h4>
<p>请务必死记硬背这三条规则：</p>
<ol>
<li>Rust 中的每一个值都有一个 <strong>所有者 (Owner)</strong>（变量）。</li>
<li>同一时间，该值<strong>只能有一个</strong>所有者。</li>
<li>当所有者<strong>离开作用域</strong>（Scope）时，这个值将被丢弃（Drop，即释放内存）。</li>
</ol>
<h4 data-id="heading-3">3.3 变量作用域 (Scope)</h4>
<p>这和其他语言类似，用花括号 <code>{}</code> 界定。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    {                      <span class="hljs-comment">// --- s 在这里开始有效</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s</span> = <span class="hljs-string">"hello"</span>;   <span class="hljs-comment">// s 是 valid 的</span>
        <span class="hljs-comment">// 使用 s ...</span>
    }                      <span class="hljs-comment">// --- 作用域结束，s 不再有效</span>
                           <span class="hljs-comment">// 这里的 s 已经被清理了</span>
}
</code></pre>
<hr/>
<h4 data-id="heading-4">3.4 移动 (Move) —— Rust 最独特的行为</h4>
<p>这是新手最容易懵的地方。</p>
<p><strong>情况 A：栈上的数据（拷贝）</strong></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span> = <span class="hljs-number">5</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">y</span> = x; <span class="hljs-comment">// 把 5 拷贝一份给 y</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"x = {}, y = {}"</span>, x, y);
}
</code></pre>
<p>这很正常，<code>x</code> 和 <code>y</code> 都等于 5。因为整数大小固定，都在栈上，拷贝极快。Rust 称这些类型实现了 <code>Copy</code> 特征。</p>
<p><strong>情况 B：堆上的数据（移动）</strong>
我们要引入 <code>String</code> 类型。不同于字符串字面量（<code>"hello"</code>，它是写死在代码里的），<code>String</code> 是动态的，分配在堆上。</p>
<p><strong>请务必运行这段代码，并观察报错：</strong></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s1</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s2</span> = s1; <span class="hljs-comment">// &lt;--- 关键步骤！</span>

    <span class="hljs-comment">// 下面这行会报错！</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"s1 = {}"</span>, s1); 
}
</code></pre>
<p><strong>为什么报错？</strong></p>
<ol>
<li><code>s1</code> 在堆上申请了内存存 "hello"，并在栈上存了一个指针指向它。</li>
<li><code>let s2 = s1;</code> 发生时，Rust <strong>并没有</strong> 把堆上的 "hello" 复制一份（深拷贝太慢了）。</li>
<li>它只是把 <code>s1</code> 栈上的指针复制给了 <code>s2</code>。</li>
<li><strong>关键点</strong>：为了保证内存安全（避免二次释放），<strong>Rust 认为 <code>s1</code> 已经失效了！</strong> 这个操作叫 <strong>移动 (Move)</strong>。</li>
<li>就像现实生活中，我把手里的苹果给了你，我就没有苹果了。</li>
</ol>
<p><strong>修正：克隆 (Clone)</strong>
如果你真的想完整复制一份堆上的数据（即使这比较消耗性能），必须显式调用 <code>.clone()</code>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s1</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s2</span> = s1.<span class="hljs-title function_ invoke__">clone</span>(); <span class="hljs-comment">// 深拷贝：堆上的数据也被复制了</span>

    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"s1 = {}, s2 = {}"</span>, s1, s2); <span class="hljs-comment">// 正常运行</span>
}
</code></pre>
<hr/>
<h4 data-id="heading-5">3.5 所有权与函数</h4>
<p>把变量传给函数，也遵循同样的规则：<strong>传进去，就没了。</strong></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>);  <span class="hljs-comment">// s 进入作用域</span>

    <span class="hljs-title function_ invoke__">takes_ownership</span>(s);             <span class="hljs-comment">// s 的值被【移动】进了函数</span>
                                    <span class="hljs-comment">// 从这里开始，s 不再有效了！</span>

    <span class="hljs-comment">// println!("{}", s);           // ❌ 如果取消注释，会报错</span>
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span> = <span class="hljs-number">5</span>;                      <span class="hljs-comment">// x 进入作用域</span>
    <span class="hljs-title function_ invoke__">makes_copy</span>(x);                  <span class="hljs-comment">// x 是 i32，实现了 Copy 特征</span>
                                    <span class="hljs-comment">// 所以 x 只是把值传进去了，后面还能用</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"x 依然可用: {}"</span>, x); 
} <span class="hljs-comment">// main 结束</span>

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">takes_ownership</span>(some_string: <span class="hljs-type">String</span>) { 
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, some_string);
} <span class="hljs-comment">// some_string 离开作用域，drop 被调用，内存释放</span>

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">makes_copy</span>(some_integer: <span class="hljs-type">i32</span>) {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, some_integer);
}
</code></pre>
<p><strong>痛苦点</strong>：
如果我想在调用 <code>takes_ownership</code> 之后继续使用 <code>s</code> 怎么办？难道必须让函数把 <code>s</code> 再 <code>return</code> 回来吗？</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 笨办法：把所有权拿进去，再拿出来</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s1</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>);
    <span class="hljs-keyword">let</span> (s2, len) = <span class="hljs-title function_ invoke__">calculate_length</span>(s1); <span class="hljs-comment">// s1 移动进去了，s2 移动出来了</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"The length of '{}' is {}."</span>, s2, len);
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">calculate_length</span>(s: <span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> (<span class="hljs-type">String</span>, <span class="hljs-type">usize</span>) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">length</span> = s.<span class="hljs-title function_ invoke__">len</span>(); 
    (s, length) <span class="hljs-comment">// 返回 s 和长度</span>
}
</code></pre>
<p>这样做太麻烦了！于是，Rust 引入了 <strong>“引用” (Reference)</strong>。</p>
<hr/>
<h3 data-id="heading-6">🔗 第 3.5 章：引用与借用 (References and Borrowing)</h3>
<p>这就是“借用”：<strong>我可以使用你的东西，但不获取它的所有权。</strong></p>
<h4 data-id="heading-7">1. 不可变引用 (<code>&amp;</code>)</h4>
<p>我们在参数类型前面加 <code>&amp;</code>，传参时也加 <code>&amp;</code>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s1</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>);

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">len</span> = <span class="hljs-title function_ invoke__">calculate_length</span>(&amp;s1); <span class="hljs-comment">// 传引用，不传所有权</span>

    <span class="hljs-comment">// s1 依然有效！因为我们只是把它“借”出去了</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"The length of '{}' is {}."</span>, s1, len);
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">calculate_length</span>(s: &amp;<span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> { <span class="hljs-comment">// s 是对 String 的引用</span>
    s.<span class="hljs-title function_ invoke__">len</span>()
} <span class="hljs-comment">// s 离开作用域，但因为它没有所有权，什么也不会发生（不会 drop String）</span>
</code></pre>
<p><strong>尝试修改借用的值？</strong></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">change</span>(some_string: &amp;<span class="hljs-type">String</span>) {
    some_string.<span class="hljs-title function_ invoke__">push_str</span>(<span class="hljs-string">", world"</span>); <span class="hljs-comment">// ❌ 报错！</span>
}
</code></pre>
<p><strong>规则</strong>：借来的书（不可变引用），你是不能在上面乱涂乱画的。</p>
<h4 data-id="heading-8">2. 可变引用 (<code>&amp;mut</code>)</h4>
<p>如果你想修改，必须使用 <strong>可变引用</strong>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>); <span class="hljs-comment">// 变量本身必须是 mut</span>

    <span class="hljs-title function_ invoke__">change</span>(&amp;<span class="hljs-keyword">mut</span> s); <span class="hljs-comment">// 传入可变引用</span>

    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, s); <span class="hljs-comment">// 输出 hello, world</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">change</span>(some_string: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-type">String</span>) { <span class="hljs-comment">// 接收可变引用</span>
    some_string.<span class="hljs-title function_ invoke__">push_str</span>(<span class="hljs-string">", world"</span>);
}
</code></pre>
<h4 data-id="heading-9">3. 借用的终极规则 (重点！)</h4>
<p>Rust 为了防止多线程数据竞争，立下了严格的规矩：</p>
<p>在同一时间，对于同一个数据，你只能拥有以下<strong>二者之一</strong>：</p>
<ul>
<li><strong>A. 任意数量的不可变引用 (<code>&amp;T</code>)</strong> （大家都可以看书，没人能改）</li>
<li><strong>B. 唯一的一个可变引用 (<code>&amp;mut T</code>)</strong> （只有一个人能拿回家改，别人都不能看了）</li>
</ul>
<p><strong>代码实验：违反规则</strong></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>);

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">r1</span> = &amp;s; 
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">r2</span> = &amp;s; 
    <span class="hljs-comment">// let r3 = &amp;mut s; // ❌ 报错！已经有 r1, r2 在借阅了，不能再借给 r3 去修改</span>

    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}, {}"</span>, r1, r2);
}
</code></pre>
<p>但是，注意<strong>作用域</strong>。如果 <code>r1</code> 和 <code>r2</code> 用完了（也就是最后一次使用已经在代码上方了），编译器很聪明，知道后面没人看了，就可以创建可变引用了（这叫 NLL - Non-Lexical Lifetimes）。</p>
<hr/>
<h3 data-id="heading-10">📝 第三章总结与作业</h3>
<p>这一章非常“烧脑”，但请不要放弃。</p>
<p><strong>总结：</strong></p>
<ol>
<li><strong>所有权</strong>：每个值有一个所有者，变量赋值给别人，自己就废了（针对堆数据）。</li>
<li><strong>Move</strong>：<code>String</code> 赋值是 Move，<code>i32</code> 赋值是 Copy。</li>
<li><strong>引用 (<code>&amp;</code>)</strong>：允许你不获取所有权也能访问数据。</li>
<li><strong>借用规则</strong>：要么有很多读者（不可变），要么有一个作者（可变），不能同时存在。</li>
</ol>
<p><strong>作业：</strong></p>
<ol>
<li>创建一个函数 <code>add_suffix</code>，接收一个 <code>&amp;mut String</code>，在字符串后面追加 " - Rust is cool!"。</li>
<li>在 <code>main</code> 函数中，创建一个 <code>String</code>，调用这个函数，然后打印修改后的字符串。</li>
<li><strong>思考题（不用写代码）</strong>：为什么 Rust 不允许同时存在 <code>&amp;s</code> (不可变) 和 <code>&amp;mut s</code> (可变)？如果允许，当我在读取 <code>&amp;s</code> 的时候，另一个人通过 <code>&amp;mut s</code> 吧数据清空了，会发生什么？（这就是 Rust 防止的“数据竞争”）。</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JS-Canvas进阶指南：从零构建你的 Web 图形世界]]></title>    <link>https://juejin.cn/post/7598103558886539310</link>    <guid>https://juejin.cn/post/7598103558886539310</guid>    <pubDate>2026-01-23T03:30:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598103558886539310" data-draft-id="7598104596779122734" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JS-Canvas进阶指南：从零构建你的 Web 图形世界"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-23T03:30:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JS-Canvas进阶指南：从零构建你的 Web 图形世界
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:30:24.000Z" title="Fri Jan 23 2026 03:30:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在数据可视化（ECharts）、在线文档、H5 游戏等领域，Canvas 都是不可或缺的核心技术。不同于 DOM 操作，Canvas 提供了立即模式的绘图能力。本文将带你系统盘点 Canvas 的核心 API 与实战技巧。</p>
<h2 data-id="heading-1">一、 快速上手：环境搭建</h2>
<p>Canvas 就像一块画布，而 <code>context</code> 则是你的画笔，Canvas使用方法如下:</p>
<ul>
<li>创建canvas元素，并为其设置width和height</li>
<li>通过id查找到该元素</li>
<li>使用<code>getContext('2d')</code>获取绘制图形的上下文</li>
</ul>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"drawing"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"200"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"200"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> drawing = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"drawing"</span>);

<span class="hljs-comment">// 严谨起见，先检查浏览器是否支持 getContext</span>
<span class="hljs-keyword">if</span> (drawing.<span class="hljs-property">getContext</span>) {
  <span class="hljs-keyword">const</span> context = drawing.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">"2d"</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Canvas 上下文获取成功"</span>);
}
</code></pre>
<hr/>
<h2 data-id="heading-2">二、 基础图形：矩形绘制</h2>
<p>矩形是 Canvas 中唯一原生支持的形状，其他图形都需要通过路径组合。</p>





















<table><thead><tr><th><strong>方法</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td><strong><code>fillRect(x, y, w, h)</code></strong></td><td>绘制填充矩形（实心）</td></tr><tr><td><strong><code>strokeRect(x, y, w, h)</code></strong></td><td>绘制描边矩形（空心）</td></tr><tr><td><strong><code>clearRect(x, y, w, h)</code></strong></td><td>清除指定区域（橡皮擦效果）</td></tr></tbody></table>
<ul>
<li>
<p>这三种方法都接受4个参数:</p>
<ul>
<li><code>x</code>代表绘制矩形的起点横坐标</li>
<li><code>y</code>代表绘制矩形的起点纵坐标（坐标轴是向下的)</li>
<li><code>w</code>代表绘制矩形的宽度（从x位置向右延升w距离）</li>
<li><code> h</code>代表会在矩形的高度（从y位置向下延升h距离）</li>
</ul>
</li>
<li>
<p>fillRect绘制出来的矩形，可使用<code>fillStyle</code>（'颜色值'）可以给矩形填充颜色</p>
</li>
<li>
<p>storkeRect绘制出来的矩形，可使用<code>strokeStyle</code>（'颜色值'）可以给矩形绘制轮廓</p>
</li>
</ul>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> context = drawing.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">"2d"</span>);

<span class="hljs-comment">// 1. 填充绿色矩形</span>
context.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">"green"</span>;
context.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>, <span class="hljs-number">50</span>, <span class="hljs-number">50</span>);

<span class="hljs-comment">// 2. 红色边框矩形</span>
context.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">"red"</span>;
context.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// 设置线宽</span>
context.<span class="hljs-title function_">strokeRect</span>(<span class="hljs-number">70</span>, <span class="hljs-number">10</span>, <span class="hljs-number">50</span>, <span class="hljs-number">50</span>);

<span class="hljs-comment">// 3. 橡皮擦：擦除中间一部分</span>
context.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">15</span>, <span class="hljs-number">15</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>); 
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/021d075ef3424881bbd80bdb3220264e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743823&amp;x-signature=WBq1DvQ5HJmOvPjCLOo22lj%2FQmU%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-3">三、 路径的艺术：绘制任意形状</h2>
<p>路径是 Canvas 的灵魂。记住核心流程：<strong>开始路径 -&gt; 移动画笔 -&gt; 绘制线条 -&gt; 闭合/描边</strong>。</p>
<h3 data-id="heading-4">1. 核心 API</h3>
<ul>
<li><strong><code>beginPath()</code></strong> : 清空当前路径列表，开始新路径（防止之前的路径被重复绘制）。</li>
<li><strong><code>moveTo(x, y)</code></strong> : 移动画笔，只把绘制起始点移动到<code>(x, y)</code>。</li>
<li><strong><code>lineTo(x, y)</code></strong> : 绘制一条从上个结束点到(x, y)的直线。</li>
<li><strong><code>arc(x, y, radius, startAngle, endAngle, counterclockwise)</code></strong>：以坐标<code>(x, y)</code>为圆心，以 <code>radius</code> 为半径绘制一条弧线，起始角度为 <code>startAngle</code>，结束角度为 <code>endAngle</code>， <code>counterclockwise</code> 表示是否逆时针计算起始角度和结束角度（默认为顺时针)</li>
<li><strong><code>arcTo(x1, y1, x2, y2, radius)</code></strong> :绘制从起始点<code>P0</code>到<code>P1(x1，y1)</code>的一条连线，截止绘制从<code>P1(x1,y1)</code>到<code>P2(x2,y2)</code>的连线，接着将这两条线当做切线绘制一个半径为radius的圆弧。（当圆弧过大时，会取两条切线的延长线）使用较少</li>
</ul>
<h3 data-id="heading-5">2. 实战：绘制切线圆弧 (arcTo)</h3>
<pre><code class="hljs language-JavaScript" lang="JavaScript"> &lt;canvas id=<span class="hljs-string">"drawing"</span> width=<span class="hljs-string">"600"</span> height=<span class="hljs-string">"600"</span> style=<span class="hljs-string">"border: 1px solid aqua"</span>&gt;&lt;/canvas&gt;
   
  <span class="hljs-keyword">let</span> drawing = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'drawing'</span>)
  <span class="hljs-keyword">if</span> (drawing.<span class="hljs-property">getContext</span>) {
    <span class="hljs-keyword">let</span> context = drawing.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)
    <span class="hljs-keyword">const</span> p0 = { <span class="hljs-attr">x</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">50</span> } <span class="hljs-comment">// 起点</span>
    <span class="hljs-keyword">const</span> p1 = { <span class="hljs-attr">x</span>: <span class="hljs-number">150</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">100</span> } <span class="hljs-comment">// 控制点1</span>
    <span class="hljs-keyword">const</span> p2 = { <span class="hljs-attr">x</span>: <span class="hljs-number">250</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">50</span> } <span class="hljs-comment">// 控制点2</span>
    <span class="hljs-keyword">const</span> radius =<span class="hljs-number">100</span> <span class="hljs-comment">// 圆角半径</span>

    context.<span class="hljs-title function_">beginPath</span>()
    context.<span class="hljs-title function_">moveTo</span>(p0.<span class="hljs-property">x</span>, p0.<span class="hljs-property">y</span>) <span class="hljs-comment">// 定位起点</span>
    context.<span class="hljs-title function_">arcTo</span>(p1.<span class="hljs-property">x</span>, p1.<span class="hljs-property">y</span>, p2.<span class="hljs-property">x</span>, p2.<span class="hljs-property">y</span>, radius) <span class="hljs-comment">// 绘制圆弧</span>
    <span class="hljs-comment">// context.lineTo(p2.x, p2.y) // 连接到终点</span>
    context.<span class="hljs-title function_">stroke</span>() <span class="hljs-comment">// 描边</span>
  }<span class="hljs-number">1.</span>y, p2.<span class="hljs-property">x</span>, p2.<span class="hljs-property">y</span>, radius); 
context.<span class="hljs-title function_">stroke</span>();
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/974308b12a594acbae20756187dd7d90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743823&amp;x-signature=OQelHaas8HG1sUCCjvgXI3hnO9o%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">3. 实战：绘制时钟表盘</h3>
<pre><code class="hljs language-JavaScript" lang="JavaScript">  <span class="hljs-keyword">let</span> drawing = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'drawing'</span>)
  <span class="hljs-keyword">if</span> (drawing.<span class="hljs-property">getContext</span>) {
    <span class="hljs-keyword">let</span> context = drawing.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)
    <span class="hljs-comment">// 创建路径</span>
    context.<span class="hljs-title function_">beginPath</span>()
    <span class="hljs-comment">// 绘制外圆</span>
    context.<span class="hljs-title function_">arc</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">99</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>, <span class="hljs-literal">false</span>)
    <span class="hljs-comment">// 绘制内圆</span>
    context.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">194</span>, <span class="hljs-number">100</span>)
    context.<span class="hljs-title function_">arc</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">94</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>, <span class="hljs-literal">false</span>)
    <span class="hljs-comment">// 绘制分针</span>
    context.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>)
    context.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">15</span>)
    <span class="hljs-comment">// 绘制时针</span>
    context.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>)
    context.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">35</span>, <span class="hljs-number">100</span>)
    <span class="hljs-comment">// 描画路径</span>
    context.<span class="hljs-title function_">stroke</span>()
  }
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfcb7496aefc4a73b33c30aaf3da8eeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743823&amp;x-signature=0LJ3Z%2BhIeGJQFD6DQ8Ox3BkMmmU%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-7">四、 绘制文本</h2>
<p>Canvas 文本也是图像的一部分，无法像 DOM 文本那样选中。</p>





























<table><thead><tr><th><strong>属性/方法</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td><strong><code>font</code></strong></td><td>设置字体，如 <code>"bold 20px Arial"</code></td></tr><tr><td><strong><code>textAlign</code></strong></td><td>水平对齐：<code>start</code>, <code>end</code>, <code>left</code>, <code>right</code>, <code>center</code></td></tr><tr><td><strong><code>textBaseline</code></strong></td><td>垂直对齐：<code>top</code>, <code>middle</code>, <code>bottom</code></td></tr><tr><td><strong><code>fillText(text, x, y, maxWidth)</code></strong></td><td>绘制实心文本，text为文本内容（字符串），xy为文本坐标，maxwidth为可选参数表示最大宽度</td></tr><tr><td><strong><code>strokeText(text, x, y,maxWidth)</code></strong></td><td>绘制空心文本，参数同fillText，同fillText一起调用可实现填充+描边效果</td></tr></tbody></table>
<pre><code class="hljs language-JavaScript" lang="JavaScript">context.<span class="hljs-property">font</span> = <span class="hljs-string">'20px Arial'</span>;
context.<span class="hljs-property">textAlign</span> = <span class="hljs-string">'center'</span>;

<span class="hljs-comment">// 实心字</span>
context.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'blue'</span>;
context.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">'Combined'</span>, <span class="hljs-number">150</span>, <span class="hljs-number">150</span>);

<span class="hljs-comment">// 空心描边字（重叠效果）</span>
context.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'red'</span>;
context.<span class="hljs-title function_">strokeText</span>(<span class="hljs-string">'Combined'</span>, <span class="hljs-number">150</span>, <span class="hljs-number">150</span>);
</code></pre>
<hr/>
<h2 data-id="heading-8">五、 图像处理与像素操作</h2>
<h3 data-id="heading-9">1. 绘制图片 (drawImage)</h3>
<p><strong>注意</strong>：必须等待图片加载完成后才能绘制，否则画布是空的。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
img.<span class="hljs-property">src</span> = <span class="hljs-string">'test.jpg'</span>;
img.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 参数：图片对象, x, y, width, height</span>
    <span class="hljs-comment">// 还可以传入9个参数实现裁剪：drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh)</span>
    context.<span class="hljs-title function_">drawImage</span>(img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">200</span>, <span class="hljs-number">200</span>);
}
</code></pre>
<h3 data-id="heading-10">2. 像素级操作 (ImageData)</h3>
<p>这是 Canvas 最强大的功能，可用于滤镜、取色器等。</p>
<ul>
<li><strong><code>getImageData(x, y, w, h)</code></strong> ：获取像素数据，返回值为<code>ImageData</code> 的实例，包含三个属性<code>width</code>、<code>height</code> 和 <code>data</code>，<code>其data</code> 属性是包含图像的原始像素信息的数组，每 4 个值代表一个像素 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>R</mi><mo separator="true">,</mo><mi>G</mi><mo separator="true">,</mo><mi>B</mi><mo separator="true">,</mo><mi>A</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(R, G, B, A)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">G</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">A</span><span class="mclose">)</span></span></span></span></span>。</li>
<li><strong><code>putImageData(imageData, x, y)</code></strong> ：将图像数据再绘制到画布上，<code>ImageData</code>：为ImageData实例，<code>w,h</code>表示绘制图像的宽高。</li>
</ul>
<blockquote>
<p><strong>跨域警告</strong>：如果绘制的图片跨域且未开启 CORS，调用 <code>getImageData</code> 会报错（画布被污染）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">六、 图像合成 (Composite)</h2>
<p>决定了当两个图形重叠时，谁显示、谁隐藏，或者颜色如何混合。</p>
<ul>
<li><strong><code>globalAlpha</code></strong>：全局透明度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>0</mn><mo>∼</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(0 \sim 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>。</li>
<li><strong><code>globalCompositeOperation</code></strong>：该属性定义新图形与画布已有内容的像素混合规则，其取值如下：</li>
</ul>








































<table><thead><tr><th><strong>属性值 (Value)</strong></th><th><strong>效果描述</strong></th><th><strong>典型场景</strong></th></tr></thead><tbody><tr><td><strong><code>source-over</code></strong> (默认)</td><td>新图形覆盖在旧图形<strong>上方</strong></td><td>最普通的绘图模式</td></tr><tr><td><strong><code>source-in</code></strong></td><td>仅显示新图形与旧图形<strong>重叠</strong>的部分（显示新图形内容）</td><td>裁剪图形（如：将图片裁成圆形头像）</td></tr><tr><td><strong><code>source-out</code></strong></td><td>仅显示新图形与旧图形<strong>不重叠</strong>的部分</td><td>镂空效果、反向遮罩</td></tr><tr><td><strong><code>destination-over</code></strong></td><td>新图形绘制在旧图形<strong>下方</strong></td><td>背景叠加（如：给已有文字加底色）</td></tr><tr><td><strong><code>destination-out</code></strong></td><td>擦除旧图形中与新图形<strong>重叠</strong>的部分</td><td><strong>橡皮擦</strong>功能实现</td></tr><tr><td><strong><code>lighter</code></strong></td><td>重叠区域颜色值相加（变亮效果）</td><td>制作光效、粒子系统、火焰效果</td></tr></tbody></table>
<p><strong>经典案例：刮刮乐效果 (destination-out)</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">&lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-comment">/* 容器设置：保证文字和Canvas重叠 */</span>
    <span class="hljs-selector-class">.scratch-card</span> {
      <span class="hljs-attribute">position</span>: relative;
      <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">150px</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> auto;
      user-select: none; <span class="hljs-comment">/* 禁止选中文字 */</span>
    }
    
    <span class="hljs-comment">/* 底层的中奖文字 */</span>
    <span class="hljs-selector-class">.prize-text</span> {
      <span class="hljs-attribute">position</span>: absolute;
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">150px</span>;
      <span class="hljs-attribute">text-align</span>: center;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">40px</span>;
      <span class="hljs-attribute">color</span>: red;
      <span class="hljs-attribute">font-weight</span>: bold;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f9f9f9</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
      <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1</span>; <span class="hljs-comment">/* 层级较低 */</span>
    }

    <span class="hljs-comment">/* 上层的 Canvas 遮罩 */</span>
    <span class="hljs-selector-tag">canvas</span> {
      <span class="hljs-attribute">position</span>: absolute;
      <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">z-index</span>: <span class="hljs-number">2</span>; <span class="hljs-comment">/* 层级较高，盖住文字 */</span>
      <span class="hljs-attribute">cursor</span>: pointer;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"scratch-card"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"prize-text"</span>&gt;</span>🎉 中奖了！<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"mask"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"300"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"150"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'mask'</span>);
    <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
    
    <span class="hljs-comment">// 1. 初始化：填充灰色遮罩</span>
    ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#cccccc'</span>; <span class="hljs-comment">// 刮奖区的颜色</span>
    ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">300</span>, <span class="hljs-number">150</span>);
    
    <span class="hljs-comment">// 状态标记：是否正在按下鼠标</span>
    <span class="hljs-keyword">let</span> isDrawing = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// 2. 鼠标/触摸交互事件监听</span>
    canvas.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousedown'</span>, <span class="hljs-function">() =&gt;</span> isDrawing = <span class="hljs-literal">true</span>);
    canvas.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mouseup'</span>, <span class="hljs-function">() =&gt;</span> isDrawing = <span class="hljs-literal">false</span>);
    <span class="hljs-comment">// 鼠标移出画布也停止刮奖</span>
    canvas.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mouseleave'</span>, <span class="hljs-function">() =&gt;</span> isDrawing = <span class="hljs-literal">false</span>); 

    canvas.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!isDrawing) <span class="hljs-keyword">return</span>;

      <span class="hljs-comment">// 获取鼠标在 Canvas 中的坐标</span>
      <span class="hljs-comment">// e.offsetX / e.offsetY 是相对于事件源元素的坐标</span>
      <span class="hljs-keyword">const</span> x = e.<span class="hljs-property">offsetX</span>;
      <span class="hljs-keyword">const</span> y = e.<span class="hljs-property">offsetY</span>;

      <span class="hljs-comment">// --- 核心代码开始 ---</span>
      <span class="hljs-comment">// 设置混合模式为“擦除”（即：让重叠部分变透明）</span>
      ctx.<span class="hljs-property">globalCompositeOperation</span> = <span class="hljs-string">'destination-out'</span>;

      <span class="hljs-comment">// 绘制圆形作为“笔触”（圆形比矩形手感更好）</span>
      ctx.<span class="hljs-title function_">beginPath</span>();
      ctx.<span class="hljs-title function_">arc</span>(x, y, <span class="hljs-number">15</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>); <span class="hljs-comment">// 15是半径，控制橡皮擦大小</span>
      ctx.<span class="hljs-title function_">fill</span>();
      <span class="hljs-comment">// --- 核心代码结束 ---</span>
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>

</span></code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[gulp + conventional-changelog-core 自动生成组件库 CHANGELOG]]></title>    <link>https://juejin.cn/post/7598099064443830335</link>    <guid>https://juejin.cn/post/7598099064443830335</guid>    <pubDate>2026-01-23T03:33:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598099064443830335" data-draft-id="7598021313871282182" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="gulp + conventional-changelog-core 自动生成组件库 CHANGELOG"/> <meta itemprop="keywords" content="前端,前端工程化"/> <meta itemprop="datePublished" content="2026-01-23T03:33:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小林攻城狮"/> <meta itemprop="url" content="https://juejin.cn/user/4162081646979545"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            gulp + conventional-changelog-core 自动生成组件库 CHANGELOG
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4162081646979545/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小林攻城狮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:33:17.000Z" title="Fri Jan 23 2026 03:33:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文基于 <strong>gulp</strong> 的自动化构建能力，结合 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fconventional-changelog-core%2Fv%2F4.2.1" target="_blank" title="https://www.npmjs.com/package/conventional-changelog-core/v/4.2.1" ref="nofollow noopener noreferrer">conventional-changelog-core</a></strong> 的规范日志生成特性，搭建一套组件库发版时 <code>CHANGELOG</code> 自动更新的方案。该方案可实现版本发布流程与日志更新的无缝联动，既保证了 CHANGELOG 的规范性与完整性，又大幅简化发版操作流程，有助于组件库的高效、标准化迭代。</p>
<h2 data-id="heading-0">前提条件</h2>
<p>该方案基于规范的 git 提交消息格式：</p>
<pre><code class="hljs language-txt" lang="txt">&lt;type&gt;[optional scope]: &lt;description&gt; 

[optional body] 

[optional footer(s)]
</code></pre>
<blockquote>
<p>如何配置规范的 <code>commitlint</code> 可以参考这篇文章 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.aliyun.com%2Farticle%2F1645019" target="_blank" title="https://developer.aliyun.com/article/1645019" ref="nofollow noopener noreferrer">配置Commitlint与Husky实现Git提交消息规范化-开发者社区-阿里云</a></p>
</blockquote>
<h2 data-id="heading-1">安装 gulp 和 conventional-changelog-core</h2>
<p>考虑到 <code>node 12</code> 版本兼容性（主要是项目中有些依赖实在不兼容高版本 node），我这里选择了 <code>gulp@^4.0.2</code> 和 <code>conventional-changelog-core@^4.2.1</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin">npm i <span class="hljs-symbol">gulp@</span>^<span class="hljs-number">4.0</span><span class="hljs-number">.2</span> conventional-changelog-<span class="hljs-symbol">core@</span>^<span class="hljs-number">4.2</span><span class="hljs-number">.1</span>
</code></pre>
<h2 data-id="heading-2">配置 <code>.conventional-changelog.js</code></h2>
<p>这里提供一份我项目中使用的配置供参考，详细配置可以自行查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fconventional-changelog-core%2Fv%2F4.2.1%3FactiveTab%3Dreadme" target="_blank" title="https://www.npmjs.com/package/conventional-changelog-core/v/4.2.1?activeTab=readme" ref="nofollow noopener noreferrer">官方文档</a></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// .conventional-changelog.js</span>

<span class="hljs-keyword">const</span> moment = <span class="hljs-built_in">require</span>(<span class="hljs-string">"moment"</span>)

<span class="hljs-comment">// 配置模板，可以按需调整模板</span>

<span class="hljs-comment">// https://github.com/conventional-changelog/conventional-changelog/tree/master/packages/conventional-changelog-writer#maintemplate</span>
<span class="hljs-keyword">const</span> mainTemplate = <span class="hljs-string">`
{{&gt; header}}

{{#each commitGroups}}
{{#each commits}}
{{&gt; commit root=@root}}
{{/each}}
{{/each}}

{{&gt; footer}}
`</span>

<span class="hljs-comment">// https://github.com/conventional-changelog/conventional-changelog/tree/master/packages/conventional-changelog-writer#headerpartial</span>
<span class="hljs-keyword">const</span> headerPartial = <span class="hljs-string">`
## {{#if isPatch~}} &lt;small&gt;
  {{~/if~}} {{version}}
  {{~#if title}} - {{title}}
  {{~/if~}}
  {{~#if date}} ({{date}})
  {{~/if~}}
  {{~#if isPatch~}} &lt;/small&gt;
  {{~/if}}
`</span>

<span class="hljs-comment">// 最多显示的发布版本个数</span>
<span class="hljs-keyword">const</span> maxReleaseCount = <span class="hljs-number">15</span>
<span class="hljs-keyword">let</span> releaseCount = <span class="hljs-number">0</span>

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// options</span>
  <span class="hljs-comment">// https://www.npmjs.com/package/conventional-changelog-core/v/4.2.1?activeTab=readme</span>
  <span class="hljs-attr">preset</span>: <span class="hljs-string">"angular"</span>,
  <span class="hljs-attr">outputUnreleased</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">title</span>: <span class="hljs-string">'CHANGELOG'</span>,
  <span class="hljs-attr">config</span>: {
    <span class="hljs-attr">gitRawCommitsOpts</span>: {
      <span class="hljs-comment">// 配置起始提交日志的 commit sha</span>
      <span class="hljs-attr">from</span>: <span class="hljs-string">"xxx"</span>,
    },
    <span class="hljs-attr">parserOpts</span>: {
      <span class="hljs-comment">// https://github.com/conventional-changelog-archived-repos/conventional-commits-parser</span>
      <span class="hljs-attr">mergePattern</span>: <span class="hljs-regexp">/^Merge branch '(.*)' into (.*)$/</span>,
      <span class="hljs-attr">mergeCorrespondence</span>: [<span class="hljs-string">"id"</span>, <span class="hljs-string">"source"</span>],
    },
    <span class="hljs-attr">writerOpts</span>: {
      <span class="hljs-comment">// https://github.com/conventional-changelog/conventional-changelog/tree/master/packages/conventional-changelog-writer#api</span>
      <span class="hljs-attr">groupBy</span>: <span class="hljs-string">"type"</span>,
      <span class="hljs-attr">commitGroupsSort</span>: [<span class="hljs-string">"feat"</span>, <span class="hljs-string">"fix"</span>, <span class="hljs-string">"perf"</span>, <span class="hljs-string">"docs"</span>, <span class="hljs-string">"style"</span>, <span class="hljs-string">"refactor"</span>, <span class="hljs-string">"test"</span>, <span class="hljs-string">"chore"</span>, <span class="hljs-string">"revert"</span>],
      <span class="hljs-attr">commitsSort</span>: [<span class="hljs-string">"scope"</span>, <span class="hljs-string">"subject"</span>],
      <span class="hljs-attr">noteGroupsSort</span>: <span class="hljs-string">"title"</span>,
      <span class="hljs-attr">notesSort</span>: <span class="hljs-string">"title"</span>,
      mainTemplate,
      headerPartial
    },
  },
  <span class="hljs-attr">transform</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">commit, cb</span>) {
    <span class="hljs-comment">// 配置发版消息的匹配格式并提取版本号，这里可以根据项目实际情况进行调整</span>
    <span class="hljs-keyword">const</span> subjectReleasePattern = <span class="hljs-regexp">/elements@(\d+\.\d+\.\d+)/</span>
    <span class="hljs-keyword">const</span> headerReleasePattern = <span class="hljs-regexp">/Update version (\d+\.\d+\.\d+)/</span>
    <span class="hljs-keyword">if</span> (commit.<span class="hljs-property">subject</span> &amp;&amp; subjectReleasePattern.<span class="hljs-title function_">test</span>(commit.<span class="hljs-property">subject</span>)) {
      commit.<span class="hljs-property">version</span> = subjectReleasePattern.<span class="hljs-title function_">exec</span>(commit.<span class="hljs-property">subject</span>)[<span class="hljs-number">1</span>]
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (commit.<span class="hljs-property">header</span> &amp;&amp; headerReleasePattern.<span class="hljs-title function_">test</span>(commit.<span class="hljs-property">header</span>)) {
      commit.<span class="hljs-property">version</span> = headerReleasePattern.<span class="hljs-title function_">exec</span>(commit.<span class="hljs-property">header</span>)[<span class="hljs-number">1</span>]
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^(chore|docs|test|doc)/</span>.<span class="hljs-title function_">test</span>(commit.<span class="hljs-property">header</span>) &amp;&amp; !<span class="hljs-regexp">/^chore\(element-ui\)/</span>.<span class="hljs-title function_">test</span>(commit.<span class="hljs-property">header</span>)) {
      <span class="hljs-comment">// 忽略部分提交日志信息，这里可以根据项目实际情况进行调整</span>
      <span class="hljs-title function_">cb</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">if</span> (commit.<span class="hljs-property">version</span>) {
      releaseCount++
    }
    <span class="hljs-keyword">if</span> (releaseCount &gt; maxReleaseCount) {
      <span class="hljs-title function_">cb</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)
      <span class="hljs-keyword">return</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (releaseCount === <span class="hljs-number">1</span>) {
      commit.<span class="hljs-property">title</span> = <span class="hljs-string">'latest'</span>
    }
    commit.<span class="hljs-property">group</span> = commit.<span class="hljs-property">subject</span> || commit.<span class="hljs-property">type</span>
    <span class="hljs-comment">// 设置日期格式</span>
    <span class="hljs-keyword">if</span> (commit.<span class="hljs-property">committerDate</span>) {
      commit.<span class="hljs-property">date</span> = <span class="hljs-title function_">moment</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(commit.<span class="hljs-property">committerDate</span>)).<span class="hljs-title function_">format</span>(<span class="hljs-string">"YYYY-MM-DD"</span>)
    }
    <span class="hljs-comment">// 设置更新日志的文本模板，主要是提取信息并添加 markdown 格式，这里也可以按需加入一些 emoji 表情丰富日志</span>
    <span class="hljs-keyword">let</span> header = <span class="hljs-string">''</span>
    <span class="hljs-keyword">if</span> (commit.<span class="hljs-property">type</span>) {
      header += <span class="hljs-string">`**<span class="hljs-subst">${commit.type}</span>`</span>
    }
    <span class="hljs-keyword">if</span> (commit.<span class="hljs-property">scope</span>) {
      header += <span class="hljs-string">`(<span class="hljs-subst">${commit.scope}</span>)`</span>
    }
    <span class="hljs-keyword">if</span> (header.<span class="hljs-property">length</span>) {
      header += <span class="hljs-string">`:** <span class="hljs-subst">${commit.subject.replace(<span class="hljs-string">'@'</span>, <span class="hljs-string">'-'</span>)}</span>`</span>
      commit.<span class="hljs-property">header</span> = header
    }
    <span class="hljs-title function_">cb</span>(<span class="hljs-literal">null</span>, commit)
  },
}

</code></pre>
<h2 data-id="heading-3">配置 gulp</h2>
<p>在 gulp 入口文件 <code>gulpfile.js</code> 中添加一个 <code>task</code>，代码参考如下</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>)
<span class="hljs-keyword">var</span> conventionalChangelog = <span class="hljs-built_in">require</span>(<span class="hljs-string">"conventional-changelog-core"</span>)
<span class="hljs-keyword">const</span> conventionalChangelogOpts = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./.conventional-changelog"</span>)

gulp.<span class="hljs-title function_">task</span>(<span class="hljs-string">"conventional-changelog"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-comment">// CHANGE_LOG 文件的路径</span>
  <span class="hljs-keyword">const</span> changelogPath = <span class="hljs-string">"./CHANGE_LOG.md"</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">conventionalChangelog</span>(conventionalChangelogOpts)
    .<span class="hljs-title function_">on</span>(<span class="hljs-string">"end"</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 生成文件完成后，读取文件内容</span>
      fs.<span class="hljs-title function_">readFile</span>(changelogPath, <span class="hljs-string">"utf8"</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (err) {
          <span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err)
        }
        <span class="hljs-comment">// 在内容首行添加标题</span>
        <span class="hljs-keyword">const</span> newData = <span class="hljs-string">`# <span class="hljs-subst">${conventionalChangelogOpts.title || <span class="hljs-string">'CHANGELOG'</span>}</span>\n\n`</span> + data
        <span class="hljs-comment">// 将修改后的内容写回文件</span>
        fs.<span class="hljs-title function_">writeFile</span>(changelogPath, newData, <span class="hljs-string">"utf8"</span>, <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
          <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err)
          }
        })
      })
    })
    .<span class="hljs-title function_">pipe</span>(fs.<span class="hljs-title function_">createWriteStream</span>(changelogPath)) <span class="hljs-comment">// or any writable stream</span>
})
</code></pre>
<h2 data-id="heading-4">执行任务脚本，生成 CHANGELOG</h2>
<p>gulp 任务创建完成后，可以在命令终端执行 <code>npx gulp conventional-changelog</code> 自动生成 <code>CHANGELOG</code>，更新后的文档内容如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bc073459b224f82b7a3261f4c435b90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6X5pS75Z-O54uu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743997&amp;x-signature=nRlhDII%2Fugv7Oq1RuDSGwaSfBPM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">进阶：创建自动发布脚本实现 <code>打包-发布-更新文档</code> 全自动化执行</h2>
<p>在实际的组件库发版实践中，打包发布还需要同步更新子版本号，这里可以使用 <code>npm --no-git-tag-version version patch</code> 命令来实现子版本号自动更新。同时更新日志一般都会跟随版本发布一起更新到组件文档上，那么就可以将 <code>打包-发布-更新文档</code> 这些环节一起写到一个执行脚本中，组件发布时直接执行脚本即可全自动完成所有流程，具体实现如下：</p>
<h3 data-id="heading-6">1. 创建 node 脚本 <code>scripts/release.js</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> { execSync } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

<span class="hljs-comment">// 执行命令的函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">runCommand</span>(<span class="hljs-params">command</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`执行命令: <span class="hljs-subst">${command}</span>`</span>);
  <span class="hljs-keyword">try</span> {
    <span class="hljs-title function_">execSync</span>(command, { <span class="hljs-attr">stdio</span>: <span class="hljs-string">'inherit'</span>, <span class="hljs-attr">shell</span>: <span class="hljs-literal">true</span> });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`命令执行成功: <span class="hljs-subst">${command}</span>`</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`命令执行失败: <span class="hljs-subst">${command}</span>`</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);
  }
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始执行发布流程...'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'\n===== 开始执行编译 ====='</span>);
<span class="hljs-title function_">runCommand</span>(<span class="hljs-string">'git fetch &amp;&amp; git pull origin master &amp;&amp; npm run lib'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'\n===== 发布到 npm ====='</span>);
<span class="hljs-title function_">runCommand</span>(<span class="hljs-string">'npm --no-git-tag-version version patch &amp;&amp; npm publish'</span>);

<span class="hljs-keyword">const</span> { version } = <span class="hljs-built_in">require</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'../package.json'</span>));

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'\n===== 提交版本号 ====='</span>);
<span class="hljs-title function_">runCommand</span>(<span class="hljs-string">`git add package.json package-lock.json &amp;&amp; git commit -m "chore: elementsc@<span class="hljs-subst">${version}</span>"`</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'\n===== 提交更新日志 ====='</span>);
<span class="hljs-title function_">runCommand</span>(<span class="hljs-string">'gulp conventional-changelog &amp;&amp; git add "./CHANGE_LOG.md" &amp;&amp; git commit -m "docs: update changelog"'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'\n发布流程执行完成！'</span>);
</code></pre>
<h3 data-id="heading-7">2. 在 package.json 中添加执行脚本</h3>
<pre><code class="hljs language-js" lang="js">{
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"elements"</span>,
    <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,
    <span class="hljs-string">"scripts"</span>: {
        <span class="hljs-string">"publish:patch"</span>: <span class="hljs-string">"node scripts/release.js"</span>
    }
}
</code></pre>
<h3 data-id="heading-8">3. 执行 <code>npm run publish:patch</code> 发布版本</h3>
<p>脚本执行成功后，自动提交版本发布日志和更新CHANGELOG，到此完成 <code>打包-发布-更新文档</code> 全自动化执行</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f30febf9d8b4aed92eb1f3d871dceea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6X5pS75Z-O54uu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769743997&amp;x-signature=dYEkmhBfdrEtAQmLc4k%2F1pV4ZLA%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Three.js 着色器打造烟雾水云效果]]></title>    <link>https://juejin.cn/post/7598104572583952434</link>    <guid>https://juejin.cn/post/7598104572583952434</guid>    <pubDate>2026-01-23T03:42:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598104572583952434" data-draft-id="7598130716339224614" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Three.js 着色器打造烟雾水云效果"/> <meta itemprop="keywords" content="前端,three.js"/> <meta itemprop="datePublished" content="2026-01-23T03:42:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王校长"/> <meta itemprop="url" content="https://juejin.cn/user/2295436010076631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Three.js 着色器打造烟雾水云效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2295436010076631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王校长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T03:42:34.000Z" title="Fri Jan 23 2026 03:42:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>本文将详细介绍如何使用 Three.js 和自定义着色器来创建逼真的烟雾、水和云朵效果。我们将通过编写顶点着色器和片元着色器来实现动态变化的视觉效果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d59a08a4fa794871ada008304a002852~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5qCh6ZW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769744554&amp;x-signature=LU1Mp6RlI2wpSr2D9dfzpXIVgxY%3D" alt="screenshot_2026-01-23_11-40-16.gif" loading="lazy"/></p>
<h2 data-id="heading-1">准备工作</h2>
<p>首先，我们需要引入必要的 Three.js 库和相关工具：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"three"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/controls/OrbitControls"</span>;
<span class="hljs-keyword">import</span> gsap <span class="hljs-keyword">from</span> <span class="hljs-string">"gsap"</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> dat <span class="hljs-keyword">from</span> <span class="hljs-string">"dat.gui"</span>;
<span class="hljs-keyword">import</span> vertexShader <span class="hljs-keyword">from</span> <span class="hljs-string">"../shaders/water/vertex.glsl"</span>;
<span class="hljs-keyword">import</span> fragmentShader <span class="hljs-keyword">from</span> <span class="hljs-string">"../shaders/water/fragment.glsl"</span>;
</code></pre>
<h2 data-id="heading-2">场景初始化</h2>
<p>首先，我们需要创建一个基本的 Three.js 场景：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初始化场景</span>
<span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();

<span class="hljs-comment">// 创建透视相机</span>
<span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(
  <span class="hljs-number">90</span>,
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>,
  <span class="hljs-number">0.1</span>,
  <span class="hljs-number">1000</span>
);

<span class="hljs-comment">// 设置相机位置</span>
camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>);
scene.<span class="hljs-title function_">add</span>(camera);

<span class="hljs-comment">// 加入辅助轴，帮助我们查看3维坐标轴</span>
<span class="hljs-keyword">const</span> axesHelper = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">AxesHelper</span>(<span class="hljs-number">5</span>);
scene.<span class="hljs-title function_">add</span>(axesHelper);
</code></pre>
<h2 data-id="heading-3">参数配置</h2>
<p>为了方便调试和调整效果，我们使用 dat.GUI 创建参数控制面板：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> params = {
  <span class="hljs-attr">uWaresFrequency</span>: <span class="hljs-number">14</span>,          <span class="hljs-comment">// 波纹频率</span>
  <span class="hljs-attr">uScale</span>: <span class="hljs-number">0.03</span>,                 <span class="hljs-comment">// 整体缩放</span>
  <span class="hljs-attr">uXzScale</span>: <span class="hljs-number">1.5</span>,                <span class="hljs-comment">// XZ平面缩放</span>
  <span class="hljs-attr">uNoiseFrequency</span>: <span class="hljs-number">10</span>,          <span class="hljs-comment">// 噪声频率</span>
  <span class="hljs-attr">uNoiseScale</span>: <span class="hljs-number">1.5</span>,             <span class="hljs-comment">// 噪声缩放</span>
  <span class="hljs-attr">uLowColor</span>: <span class="hljs-string">"#ff0000"</span>,         <span class="hljs-comment">// 低值颜色</span>
  <span class="hljs-attr">uHighColor</span>: <span class="hljs-string">"#ffff00"</span>,        <span class="hljs-comment">// 高值颜色</span>
  <span class="hljs-attr">uXspeed</span>: <span class="hljs-number">1</span>,                   <span class="hljs-comment">// X方向速度</span>
  <span class="hljs-attr">uZspeed</span>: <span class="hljs-number">1</span>,                   <span class="hljs-comment">// Z方向速度</span>
  <span class="hljs-attr">uNoiseSpeed</span>: <span class="hljs-number">1</span>,               <span class="hljs-comment">// 噪声速度</span>
  <span class="hljs-attr">uOpacity</span>: <span class="hljs-number">1</span>                   <span class="hljs-comment">// 透明度</span>
};
</code></pre>
<h2 data-id="heading-4">着色器材质创建</h2>
<p>接下来，我们创建一个使用自定义着色器的材质：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> shaderMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">ShaderMaterial</span>({
  <span class="hljs-attr">vertexShader</span>: vertexShader,
  <span class="hljs-attr">fragmentShader</span>: fragmentShader,
  <span class="hljs-attr">side</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">DoubleSide</span>,
  <span class="hljs-attr">uniforms</span>: {
    <span class="hljs-attr">uWaresFrequency</span>: {
      <span class="hljs-attr">value</span>: params.<span class="hljs-property">uWaresFrequency</span>,
    },
    <span class="hljs-attr">uScale</span>: {
      <span class="hljs-attr">value</span>: params.<span class="hljs-property">uScale</span>,
    },
    <span class="hljs-attr">uNoiseFrequency</span>: {
      <span class="hljs-attr">value</span>: params.<span class="hljs-property">uNoiseFrequency</span>,
    },
    <span class="hljs-attr">uNoiseScale</span>: {
      <span class="hljs-attr">value</span>: params.<span class="hljs-property">uNoiseScale</span>,
    },
    <span class="hljs-attr">uXzScale</span>: {
      <span class="hljs-attr">value</span>: params.<span class="hljs-property">uXzScale</span>,
    },
    <span class="hljs-attr">uTime</span>: {
      <span class="hljs-attr">value</span>: <span class="hljs-number">0</span>,  <span class="hljs-comment">// 时间变量，用于动画效果</span>
    },
    <span class="hljs-attr">uLowColor</span>: {
      <span class="hljs-attr">value</span>: <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(params.<span class="hljs-property">uLowColor</span>),
    },
    <span class="hljs-attr">uHighColor</span>: {
      <span class="hljs-attr">value</span>: <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(params.<span class="hljs-property">uHighColor</span>),
    },
    <span class="hljs-attr">uXspeed</span>: {
      <span class="hljs-attr">value</span>: params.<span class="hljs-property">uXspeed</span>,
    },
    <span class="hljs-attr">uZspeed</span>: {
      <span class="hljs-attr">value</span>: params.<span class="hljs-property">uZspeed</span>,
    },
    <span class="hljs-attr">uNoiseSpeed</span>: {
      <span class="hljs-attr">value</span>: params.<span class="hljs-property">uNoiseSpeed</span>,
    },
    <span class="hljs-attr">uOpacity</span>: {
      <span class="hljs-attr">value</span>: params.<span class="hljs-property">uOpacity</span>,
    },
  },
  <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
});
</code></pre>
<h2 data-id="heading-5">控制面板设置</h2>
<p>通过 dat.GUI 可以实时调整参数，观察效果变化：</p>
<pre><code class="hljs language-javascript" lang="javascript">gui
  .<span class="hljs-title function_">add</span>(params, <span class="hljs-string">"uWaresFrequency"</span>)
  .<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>)
  .<span class="hljs-title function_">max</span>(<span class="hljs-number">100</span>)
  .<span class="hljs-title function_">step</span>(<span class="hljs-number">0.1</span>)
  .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
    shaderMaterial.<span class="hljs-property">uniforms</span>.<span class="hljs-property">uWaresFrequency</span>.<span class="hljs-property">value</span> = value;
  });

gui
  .<span class="hljs-title function_">add</span>(params, <span class="hljs-string">"uScale"</span>)
  .<span class="hljs-title function_">min</span>(<span class="hljs-number">0</span>)
  .<span class="hljs-title function_">max</span>(<span class="hljs-number">0.2</span>)
  .<span class="hljs-title function_">step</span>(<span class="hljs-number">0.001</span>)
  .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
    shaderMaterial.<span class="hljs-property">uniforms</span>.<span class="hljs-property">uScale</span>.<span class="hljs-property">value</span> = value;
  });

<span class="hljs-comment">// 更多参数控制...</span>
</code></pre>
<h2 data-id="heading-6">几何体创建</h2>
<p>创建一个平面几何体作为基础形状：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> plane = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(
  <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PlaneBufferGeometry</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>),
  shaderMaterial
);
plane.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = -<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>;

scene.<span class="hljs-title function_">add</span>(plane);
</code></pre>
<h2 data-id="heading-7">渲染循环</h2>
<p>最后，我们需要在渲染循环中更新时间参数，以实现动画效果：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> clock = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Clock</span>();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params">t</span>) {
  <span class="hljs-keyword">const</span> elapsedTime = clock.<span class="hljs-title function_">getElapsedTime</span>();
  shaderMaterial.<span class="hljs-property">uniforms</span>.<span class="hljs-property">uTime</span>.<span class="hljs-property">value</span> = elapsedTime;
  <span class="hljs-title function_">requestAnimationFrame</span>(animate);
  renderer.<span class="hljs-title function_">render</span>(scene, camera);
}

<span class="hljs-title function_">animate</span>();
</code></pre>
<h2 data-id="heading-8">着色器详解</h2>
<h3 data-id="heading-9">顶点着色器 (Vertex Shader)</h3>
<p>顶点着色器负责计算每个顶点的位置变化，创建波浪效果：</p>
<pre><code class="hljs language-glsl" lang="glsl">precision lowp float;
uniform float uWaresFrequency;    // 波纹频率
uniform float uScale;             // 缩放系数
uniform float uNoiseFrequency;    // 噪声频率
uniform float uNoiseScale;        // 噪声缩放
uniform float uXzScale;           // XZ平面缩放
uniform float uTime;              // 时间变量
uniform float uXspeed;            // X方向速度
uniform float uZspeed;            // Z方向速度
uniform float uNoiseSpeed;        // 噪声速度

// 计算出的高度传递给片元着色器
varying float vElevation;

// 随机函数
float random (vec2 st) {
    return fract(sin(dot(st.xy,vec2(12.9898,78.233)))*43758.5453123);
}

// 噪声函数
float noise (in vec2 _st) {
    vec2 i = floor(_st);
    vec2 f = fract(_st);

    float a = random(i);
    float b = random(i + vec2(1.0, 0.0));
    float c = random(i + vec2(0.0, 1.0));
    float d = random(i + vec2(1.0, 1.0));

    vec2 u = f * f * (3.0 - 2.0 * f);

    return mix(a, b, u.x) +
            (c - a)* u.y * (1.0 - u.x) +
            (d - b) * u.x * u.y;
}

void main(){
    vec4 modelPosition = modelMatrix * vec4(position,1.0);

    // 计算波浪高度
    float elevation = sin(modelPosition.x*uWaresFrequency+uTime*uXspeed)*sin(modelPosition.z*uWaresFrequency*uXzScale+uTime*uZspeed);

    // 添加噪声效果
    elevation += -abs(cnoise(vec2(modelPosition.xz*uNoiseFrequency+uTime*uNoiseSpeed))) *uNoiseScale;
    
    vElevation = elevation;
    
    elevation *= uScale;

    modelPosition.y += elevation;

    gl_Position = projectionMatrix * viewMatrix *modelPosition;
}
</code></pre>
<h3 data-id="heading-10">片元着色器 (Fragment Shader)</h3>
<p>片元着色器负责计算每个像素的颜色：</p>
<pre><code class="hljs language-glsl" lang="glsl">precision lowp float;

uniform vec3 uHighColor;    // 高值颜色
uniform vec3 uLowColor;     // 低值颜色
varying float vElevation;   // 从顶点着色器传入的高度值
uniform float uOpacity;     // 透明度

void main(){
    // 根据高度值计算颜色插值因子
    float a = (vElevation+1.0)/2.0;
    vec3 color = mix(uLowColor,uHighColor,a);
    gl_FragColor = vec4(color,uOpacity);
}
</code></pre>
<h2 data-id="heading-11">总结</h2>
<p>通过使用自定义着色器，我们可以创建非常复杂的视觉效果，如烟雾、水波和云朵等。关键在于理解顶点着色器如何改变几何体的形状，以及片元着色器如何控制最终的颜色输出。配合参数控制面板，我们可以实时调整各种参数，获得不同的视觉效果。</p>
<p>这种技术在游戏开发、模拟仿真和艺术创作等领域有着广泛的应用。掌握着色器编程是实现高级视觉效果的重要技能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Trae 官宣：支持Skill！]]></title>    <link>https://juejin.cn/post/7598023360733052938</link>    <guid>https://juejin.cn/post/7598023360733052938</guid>    <pubDate>2026-01-23T00:40:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598023360733052938" data-draft-id="7597434154797269018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Trae 官宣：支持Skill！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-23T00:40:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="golang学习记"/> <meta itemprop="url" content="https://juejin.cn/user/4371313964100990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Trae 官宣：支持Skill！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313964100990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    golang学习记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T00:40:34.000Z" title="Fri Jan 23 2026 00:40:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">0. 为什么你需要“Skill”？因为 AI 不能靠猜！</h2>
<p>你有没有遇到过这种情况：</p>
<blockquote>
<p>“Trae，帮我写个高性能的 Go HTTP 服务。”<br/>
→ 它返回一个 <code>net/http</code> 的 Hello World，连中间件都没加。</p>
</blockquote>
<p>问题在哪？<strong>AI 不知道你的“上下文标准”</strong>。你心目中的“高性能”可能是带连接池、pprof、结构化日志、优雅关闭的完整骨架，但 AI 默认只给最简答案。</p>
<p>这时候，<strong>Trae Skill</strong> 就派上用场了——它让你把“专业经验”封装成可复用的技能包，让 AI 按你的规范输出代码！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05730db006aa41c0aced5098c1a922de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769733634&amp;x-signature=hL214%2FSQdttMDuemNAHyHo6ufiY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">1. 什么是 Trae Skill？</h2>
<p>简单说，<strong>Skill 是一段预定义的指令 + 示例 + 约束</strong>，告诉 Trae：</p>
<ul>
<li>在什么场景下触发</li>
<li>应该遵循什么规范</li>
<li>输出什么格式的代码</li>
</ul>
<p>你可以把它理解为：</p>
<ul>
<li>给 AI 的“编程风格指南”</li>
<li>团队的“代码模板自动化器”</li>
<li>你个人的“最佳实践知识库”</li>
</ul>
<hr/>
<h2 data-id="heading-2">2. 实战：创建一个 “Go 微服务骨架” Skill</h2>
<h3 data-id="heading-3">场景</h3>
<p>你经常要新建 Go 微服务项目，每次都得手动写：</p>
<ul>
<li>带 Gin 的路由</li>
<li>zap 日志</li>
<li>pprof 监控</li>
<li>优雅关闭</li>
<li>配置加载（Viper）</li>
</ul>
<p>太重复了！不如教 Trae 一次，以后一句话生成。</p>
<h3 data-id="heading-4">步骤 1：创建skill</h3>
<p>最简单的方式就是直接跟trae对话，让AI创建一个skill</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8ca701d1e8b4f018b24e206c33e57bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769733634&amp;x-signature=4T9OsAc968KR0GfYBrP%2F7IiimTU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>也可以手动创建skill，文件位置在./trea/skills下面</p>
<h3 data-id="heading-5">步骤 2：填写 Skill 元信息</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Name:</span> <span class="hljs-string">go-microservice-skeleton</span>
<span class="hljs-attr">Trigger:</span> <span class="hljs-string">"create a Go microservice with Gin, zap, pprof, and graceful shutdown"</span>
<span class="hljs-attr">Description:</span> <span class="hljs-string">生成符合我团队规范的</span> <span class="hljs-string">Go</span> <span class="hljs-string">微服务基础骨架</span>
</code></pre>
<h3 data-id="heading-6">步骤 3：编写 Skill Prompt</h3>
<pre><code class="hljs language-text" lang="text">你是一个资深 Go 后端工程师，请根据用户需求生成一个生产级微服务骨架，要求：

1. 使用 Gin 作为 Web 框架
2. 日志使用 uber/zap，带 JSON 格式和 level 控制
3. 自动开启 net/http/pprof（仅在 debug 模式）
4. 支持通过 config.yaml 加载配置（用 Viper）
5. 实现优雅关闭（监听 SIGINT/SIGTERM）
6. 项目结构清晰：cmd/, internal/, pkg/, config/

请输出完整的 main.go 和目录结构说明。
</code></pre>
<h3 data-id="heading-7">步骤 4：添加示例（可选但强烈推荐）</h3>
<p>提供一个你认可的 <code>main.go</code> 片段作为参考，帮助 Trae 理解你的代码风格。</p>
<h3 data-id="heading-8">步骤 5：保存并启用</h3>
<hr/>
<h2 data-id="heading-9">3. 使用 Skill：一句话生成专业代码</h2>
<p>现在，在聊天窗口输入：</p>
<blockquote>
<p>“用 go-microservice-skeleton 创建一个用户服务”</p>
</blockquote>
<p>Trae 会立刻返回：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// main.go</span>
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"log"</span>
    <span class="hljs-string">"net/http"</span>
    _ <span class="hljs-string">"net/http/pprof"</span>
    <span class="hljs-string">"os"</span>
    <span class="hljs-string">"os/signal"</span>
    <span class="hljs-string">"syscall"</span>
    <span class="hljs-string">"time"</span>

    <span class="hljs-string">"github.com/gin-gonic/gin"</span>
    <span class="hljs-string">"go.uber.org/zap"</span>
    <span class="hljs-string">"github.com/spf13/viper"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 加载配置</span>
    viper.SetConfigName(<span class="hljs-string">"config"</span>)
    viper.SetConfigType(<span class="hljs-string">"yaml"</span>)
    viper.AddConfigPath(<span class="hljs-string">"."</span>)
    <span class="hljs-keyword">if</span> err := viper.ReadInConfig(); err != <span class="hljs-literal">nil</span> {
        log.Fatal(<span class="hljs-string">"config error:"</span>, err)
    }

    <span class="hljs-comment">// 初始化日志</span>
    logger, _ := zap.NewProduction()
    <span class="hljs-keyword">defer</span> logger.Sync()

    <span class="hljs-comment">// Gin</span>
    r := gin.Default()
    r.GET(<span class="hljs-string">"/health"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> {
        c.JSON(<span class="hljs-number">200</span>, gin.H{<span class="hljs-string">"status"</span>: <span class="hljs-string">"ok"</span>})
    })

    <span class="hljs-comment">// 启动 HTTP 服务</span>
    srv := &amp;http.Server{
        Addr:    <span class="hljs-string">":8080"</span>,
        Handler: r,
    }

    <span class="hljs-comment">// 启动 pprof（仅调试）</span>
    <span class="hljs-keyword">if</span> viper.GetBool(<span class="hljs-string">"debug"</span>) {
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
            http.ListenAndServe(<span class="hljs-string">"localhost:6060"</span>, <span class="hljs-literal">nil</span>)
        }()
    }

    <span class="hljs-comment">// 优雅关闭</span>
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> err := srv.ListenAndServe(); err != <span class="hljs-literal">nil</span> &amp;&amp; err != http.ErrServerClosed {
            logger.Fatal(<span class="hljs-string">"server failed"</span>, zap.Error(err))
        }
    }()

    quit := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal, <span class="hljs-number">1</span>)
    signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)
    &lt;-quit
    logger.Info(<span class="hljs-string">"shutting down server..."</span>)

    ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">5</span>*time.Second)
    <span class="hljs-keyword">defer</span> cancel()
    <span class="hljs-keyword">if</span> err := srv.Shutdown(ctx); err != <span class="hljs-literal">nil</span> {
        logger.Fatal(<span class="hljs-string">"server forced to shutdown"</span>, zap.Error(err))
    }
}
</code></pre>
<p>✅ 完全符合你的规范！<br/>
✅ 无需复制粘贴旧项目<br/>
✅ 还自动处理了 pprof 的开关逻辑</p>
<hr/>
<h2 data-id="heading-10">4. Skill 的高级玩法</h2>
<h3 data-id="heading-11">✅ 团队共享</h3>
<ul>
<li>把 Skill 导出为 JSON，团队成员一键导入</li>
<li>统一代码风格，新人上手快</li>
</ul>
<h3 data-id="heading-12">✅ 多语言支持</h3>
<ul>
<li>不只是 Go！你也可以创建：
<ul>
<li><code>react-ts-component</code>：生成带 Storybook 和测试的 TSX 组件</li>
<li><code>terraform-aliyun-ecs</code>：根据你的阿里云账号习惯生成 ECS 模板</li>
</ul>
</li>
</ul>
<h3 data-id="heading-13">✅ 动态参数</h3>
<p>未来 Trae 可能支持：</p>
<pre><code class="hljs language-text" lang="text">create user-service with port=9090, db=mysql
</code></pre>
<p>Skill 自动替换模板中的变量！</p>
<hr/>
<h2 data-id="heading-14">5. 为什么 Trae Skill 比普通 prompt 更强？</h2>






























<table><thead><tr><th>对比项</th><th>普通 Prompt</th><th>Trae Skill</th></tr></thead><tbody><tr><td>复用性</td><td>每次都要重写</td><td>一次定义，永久复用</td></tr><tr><td>触发精准度</td><td>容易误触发</td><td>通过关键词/正则精确匹配</td></tr><tr><td>团队协作</td><td>无法共享</td><td>可导出/导入，团队标准化</td></tr><tr><td>上下文隔离</td><td>容易被其他对话干扰</td><td>独立命名空间，干净可靠</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-15">6. 小结：把经验变成“可执行的知识”</h2>
<p>Trae Skill 的本质，是<strong>将你多年积累的工程经验，转化为 AI 可执行的指令</strong>。它不是取代你，而是让你从“重复劳动”中解放出来，专注真正有创造力的部分。</p>
<blockquote>
<p>就像你不会每次煮咖啡都从种咖啡豆开始，<br/>
也不该每次写服务都从 <code>import "fmt"</code> 开始。</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔍 我开源了 `miniaudit`：一个基于 AST 的微信小程序审核预检 CLI，用静态分析提前拦截 13+ 高频提审雷区]]></title>    <link>https://juejin.cn/post/7598029481508896787</link>    <guid>https://juejin.cn/post/7598029481508896787</guid>    <pubDate>2026-01-23T01:54:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598029481508896787" data-draft-id="7598062246573555766" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔍 我开源了 `miniaudit`：一个基于 AST 的微信小程序审核预检 CLI，用静态分析提前拦截 13+ 高频提审雷区"/> <meta itemprop="keywords" content="微信小程序"/> <meta itemprop="datePublished" content="2026-01-23T01:54:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bsstar"/> <meta itemprop="url" content="https://juejin.cn/user/870468940991031"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔍 我开源了 `miniaudit`：一个基于 AST 的微信小程序审核预检 CLI，用静态分析提前拦截 13+ 高频提审雷区
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/870468940991031/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bsstar
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T01:54:57.000Z" title="Fri Jan 23 2026 01:54:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>“又双叒叕被拒了？就因为 <code>onLoad</code> 里调了个 <code>wx.getUserProfile</code>？”</p>
</blockquote>
<p>作为长期维护小程序的开发者，我深知微信审核规则的“模糊性”和“滞后性”。人工排查成本高、易遗漏，而官方又不提供本地校验工具。</p>
<p>于是，我用 <strong>Node.js + Babel Parser（AST）+ 静态分析</strong>，打造了 <strong><code>miniaudit</code></strong> —— 一个专为小程序提审设计的<strong>本地预检 CLI 工具</strong>。</p>
<h3 data-id="heading-0">🧠 技术亮点</h3>
<ul>
<li><strong>精准 AST 分析</strong>：不只是字符串匹配！<br/>
能识别 <code>onLaunch</code>/<code>onLoad</code>/<code>onShow</code> 中的函数调用链，避免误报</li>
<li><strong>多文件协同检测</strong>：<br/>
结合 <code>app.json</code>（权限声明）、WXML（默认勾选）、JS（API 调用）综合判断</li>
<li><strong>零依赖、高性能</strong>：<br/>
10,000 行代码 &lt; 2 秒，不污染项目依赖</li>
<li><strong>CI/CD 友好</strong>：<br/>
支持 <code>--format json</code>，轻松集成到 GitHub Actions</li>
</ul>
<h3 data-id="heading-1">🛠️ 核心规则示例（R12：进入即授权）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// lib/rules/rule12-immediate-auth-on-launch.js</span>
<span class="hljs-keyword">const</span> traverse = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/traverse'</span>).<span class="hljs-property">default</span>;

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
    <span class="hljs-attr">id</span>: <span class="hljs-string">'R12'</span>,
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">check</span>(<span class="hljs-params">{ jsFiles, parseJS }</span>) {
        <span class="hljs-keyword">const</span> sensitiveApis = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-string">'login'</span>, <span class="hljs-string">'getUserProfile'</span>, <span class="hljs-string">'getPhoneNumber'</span>]);
        <span class="hljs-keyword">const</span> entryMethods = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-string">'onLaunch'</span>, <span class="hljs-string">'onLoad'</span>, <span class="hljs-string">'onShow'</span>]);

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file <span class="hljs-keyword">of</span> jsFiles) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">const</span> ast = <span class="hljs-title function_">parseJS</span>(file);
                <span class="hljs-keyword">let</span> found = <span class="hljs-literal">null</span>;

                <span class="hljs-comment">// 遍历所有 CallExpression，找 App 或 Page</span>
                <span class="hljs-title function_">traverse</span>(ast, {
                    <span class="hljs-title class_">CallExpression</span>(path) {
                        <span class="hljs-keyword">if</span> (found) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 已找到，提前退出</span>

                        <span class="hljs-keyword">const</span> callee = path.<span class="hljs-title function_">get</span>(<span class="hljs-string">'callee'</span>);
                        <span class="hljs-keyword">let</span> targetName = <span class="hljs-literal">null</span>;

                        <span class="hljs-keyword">if</span> (callee.<span class="hljs-title function_">isIdentifier</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'App'</span> })) {
                            targetName = <span class="hljs-string">'App'</span>;
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (callee.<span class="hljs-title function_">isIdentifier</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Page'</span> })) {
                            targetName = <span class="hljs-string">'Page'</span>;
                        }

                        <span class="hljs-keyword">if</span> (targetName) {

                            <span class="hljs-keyword">if</span> (path.<span class="hljs-property">node</span>.<span class="hljs-property">arguments</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
                                <span class="hljs-keyword">return</span>;
                            }

                            <span class="hljs-keyword">const</span> configArg = path.<span class="hljs-title function_">get</span>(<span class="hljs-string">'arguments'</span>)[<span class="hljs-number">0</span>];
                            <span class="hljs-keyword">if</span> (!configArg.<span class="hljs-title function_">isObjectExpression</span>()) {
                                <span class="hljs-keyword">return</span>;
                            }

                            <span class="hljs-keyword">const</span> props = configArg.<span class="hljs-title function_">get</span>(<span class="hljs-string">'properties'</span>);

                            <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(props)) {
                                <span class="hljs-keyword">return</span>;
                            }

                            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> propPath <span class="hljs-keyword">of</span> props) {
                                <span class="hljs-keyword">let</span> methodName = <span class="hljs-string">''</span>;
                                <span class="hljs-keyword">let</span> valuePath = <span class="hljs-literal">null</span>;

                                <span class="hljs-comment">// ✅ 支持 ObjectMethod (onLaunch() {})</span>
                                <span class="hljs-keyword">if</span> (propPath.<span class="hljs-title function_">isObjectMethod</span>()) {
                                    <span class="hljs-keyword">const</span> keyNode = propPath.<span class="hljs-property">node</span>.<span class="hljs-property">key</span>;
                                    <span class="hljs-keyword">if</span> (keyNode.<span class="hljs-property">type</span> === <span class="hljs-string">'Identifier'</span>) {
                                        methodName = keyNode.<span class="hljs-property">name</span>;
                                    } <span class="hljs-keyword">else</span> {
                                        <span class="hljs-keyword">continue</span>;
                                    }
                                    valuePath = propPath.<span class="hljs-title function_">get</span>(<span class="hljs-string">'body'</span>); <span class="hljs-comment">// ObjectMethod 的函数体</span>

                                    <span class="hljs-comment">// ✅ 支持 ObjectProperty (onLaunch: function() {})</span>
                                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (propPath.<span class="hljs-title function_">isObjectProperty</span>()) {
                                    <span class="hljs-keyword">const</span> keyNode = propPath.<span class="hljs-property">node</span>.<span class="hljs-property">key</span>;
                                    <span class="hljs-keyword">if</span> (keyNode.<span class="hljs-property">type</span> === <span class="hljs-string">'Identifier'</span>) {
                                        methodName = keyNode.<span class="hljs-property">name</span>;
                                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (keyNode.<span class="hljs-property">type</span> === <span class="hljs-string">'StringLiteral'</span>) {
                                        methodName = keyNode.<span class="hljs-property">value</span>;
                                    } <span class="hljs-keyword">else</span> {
                                        <span class="hljs-keyword">continue</span>;
                                    }
                                    valuePath = propPath.<span class="hljs-title function_">get</span>(<span class="hljs-string">'value'</span>);

                                } <span class="hljs-keyword">else</span> {
                                    <span class="hljs-keyword">continue</span>;
                                }

                                <span class="hljs-comment">// 检查是否是入口方法</span>
                                <span class="hljs-keyword">if</span> (!entryMethods.<span class="hljs-title function_">has</span>(methodName)) {
                                    <span class="hljs-keyword">continue</span>;
                                }

                                <span class="hljs-comment">// 确保 value 是函数体（ObjectMethod 的 body 是 BlockStatement）</span>
                                <span class="hljs-keyword">if</span> (!valuePath || !valuePath.<span class="hljs-property">isBlockStatement</span> &amp;&amp; !valuePath.<span class="hljs-title function_">isFunction</span>()) {
                                    <span class="hljs-keyword">continue</span>;
                                }


                                <span class="hljs-comment">// 在函数体内查找 wx. 敏感调用</span>
                                valuePath.<span class="hljs-title function_">traverse</span>({
                                    <span class="hljs-title class_">CallExpression</span>(innerPath) {
                                        <span class="hljs-keyword">if</span> (found) <span class="hljs-keyword">return</span>;

                                        <span class="hljs-keyword">const</span> innerCallee = innerPath.<span class="hljs-title function_">get</span>(<span class="hljs-string">'callee'</span>);
                                        <span class="hljs-keyword">if</span> (
                                            innerCallee.<span class="hljs-title function_">isMemberExpression</span>() &amp;&amp;
                                            innerCallee.<span class="hljs-title function_">get</span>(<span class="hljs-string">'object'</span>).<span class="hljs-title function_">isIdentifier</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'wx'</span> }) &amp;&amp;
                                            innerCallee.<span class="hljs-title function_">get</span>(<span class="hljs-string">'property'</span>).<span class="hljs-title function_">isIdentifier</span>()
                                        ) {
                                            <span class="hljs-keyword">const</span> apiName = innerCallee.<span class="hljs-property">node</span>.<span class="hljs-property">property</span>.<span class="hljs-property">name</span>;

                                            <span class="hljs-keyword">if</span> (sensitiveApis.<span class="hljs-title function_">has</span>(apiName)) {
                                                found = {
                                                    file,
                                                    <span class="hljs-attr">line</span>: innerPath.<span class="hljs-property">node</span>.<span class="hljs-property">loc</span>?.<span class="hljs-property">start</span>.<span class="hljs-property">line</span> || <span class="hljs-string">'?'</span>,
                                                    <span class="hljs-attr">api</span>: apiName,
                                                    <span class="hljs-attr">method</span>: methodName
                                                };
                                                innerPath.<span class="hljs-title function_">stop</span>();
                                            } <span class="hljs-keyword">else</span> {
                                            }
                                        }
                                    }
                                });
                            }
                        }
                    }
                });

                <span class="hljs-keyword">if</span> (found) {

                    <span class="hljs-keyword">return</span> {
                        <span class="hljs-attr">level</span>: <span class="hljs-string">'error'</span>,
                        <span class="hljs-attr">message</span>: <span class="hljs-string">`在 <span class="hljs-subst">${found.method}</span> 中立即调用 wx.<span class="hljs-subst">${found.api}</span>（未先提供功能体验）`</span>,
                        <span class="hljs-attr">location</span>: <span class="hljs-string">`<span class="hljs-subst">${found.file}</span>:<span class="hljs-subst">${found.line}</span>`</span>,
                        <span class="hljs-attr">suggestion</span>: <span class="hljs-string">'请先让用户浏览/使用核心功能，再在用户主动操作时请求授权'</span>
                    };
                } <span class="hljs-keyword">else</span> {
                }
            } <span class="hljs-keyword">catch</span> (e) {
            }
        }

        <span class="hljs-keyword">return</span> { <span class="hljs-attr">level</span>: <span class="hljs-string">'pass'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'未发现启动时立即授权'</span> };
    }
};
</code></pre>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment">### ▶️ 快速体验</span>
```bash
npx miniaudit ./my-miniprogram --fix
</code></pre>
<ul>
<li>自动注释 <code>console.log</code> / <code>debugger</code></li>
<li>输出彩色报告，高危项标红</li>
</ul>
<h3 data-id="heading-2">🤖 CI 集成示例（GitHub Actions）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">miniaudit</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">npx</span> <span class="hljs-string">miniaudit</span> <span class="hljs-string">.</span>
  <span class="hljs-comment"># 若发现高危问题，exit code ≠ 0，自动阻断合并</span>
</code></pre>
<h3 data-id="heading-3">🌈 开源共建</h3>
<ul>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbsstar%2Fminiaudit" target="_blank" title="https://github.com/bsstar/miniaudit" ref="nofollow noopener noreferrer">github.com/bsstar/mini…</a></li>
<li>Gitee: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fbsstar2000%2Fminiaudit" target="_blank" title="https://gitee.com/bsstar2000/miniaudit" ref="nofollow noopener noreferrer">gitee.com/bsstar2000/…</a></li>
<li>规则可插拔：只需在 <code>lib/rules/</code> 新增 JS 文件即可扩展</li>
</ul>
<blockquote>
<p>💬 如果你有更多审核雷区经验，欢迎 PR 新规则！让社区一起告别“提审焦虑”。</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cowork 很香却用不了？试试这个开源平替！]]></title>    <link>https://juejin.cn/post/7598029481509077011</link>    <guid>https://juejin.cn/post/7598029481509077011</guid>    <pubDate>2026-01-23T02:10:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598029481509077011" data-draft-id="7598024433911808054" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cowork 很香却用不了？试试这个开源平替！"/> <meta itemprop="keywords" content="人工智能,Claude"/> <meta itemprop="datePublished" content="2026-01-23T02:10:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cowork 很香却用不了？试试这个开源平替！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T02:10:52.000Z" title="Fri Jan 23 2026 02:10:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前几天大家都在讨论 <code>Cowork</code>，由于 <code>Win</code> 版尚未出来，我还没亲自上手试试，但是不妨碍我们聊聊这个现象级的产品。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec07c2f973e147f4a2e6df9c80f7257a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739055&amp;x-signature=UgLR%2BGwI%2FnorYydkx4Ev2UeDv6o%3D" alt="" loading="lazy"/></p>
<p>这个产品的诞生本身就极具传奇性。</p>
<p>“<strong>The entire product was built in 10 days. And all the code was written by Claude itself.</strong>”</p>
<p>“整个产品在 10 天内建成。而且所有代码都是由 <code>Claude</code> 自己编写的。”</p>
<p>这再次证明了编程范式的转变。</p>
<ul>
<li>开发模式从线性到并行：以前得一步步来，写完一个模块才能开始下一个；现在有了 AI，多个功能可以并行推进，效率直接拉满。</li>
<li>人才从编码者到架构师：写代码不再是核心竞争力，真正值钱的是能清晰定义问题、设计系统，并引导 AI 高效协作。</li>
<li>企业组织从大型团队到小型团队：过去要几十人的项目组，现在三五个人配上合适的 AI 工具，很快就能见到成效。</li>
</ul>
<p>我们团队很早就开始用 AI 编程了，虽然目前还达不到他们这么离谱的程度，但效率提升已经非常明显了。</p>
<p>你确定还不试试吗？</p>
<p>因为各种原因，目前 <code>Claude Cowork</code> 使用还不是那么方便。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c12f9747d5e14d8a800a4a361044324f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739055&amp;x-signature=WWuqcsOgCRbWyQZe0vuz5RWXBAw%3D" alt="" loading="lazy"/></p>
<p>因此我就找了下是否有开源替代方案。</p>
<p>果然，开源社区又一次给出了我想要的。</p>
<p>1月12日 <code>Claude</code> 发布 <code>Cowork</code>，1月13日，<code>OpenCowork</code> 建库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FOpenCoworkAI%2Fopen-cowork%25E3%2580%2582" target="_blank" title="https://github.com/OpenCoworkAI/open-cowork%E3%80%82" ref="nofollow noopener noreferrer">github.com/OpenCoworkA…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9ab8765ec694e53aba6ae88d7e5c395~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739055&amp;x-signature=5fsJwbTaJnu8TWEpOAdKLbSJ6jU%3D" alt="" loading="lazy"/></p>
<p>只是我发现的有些晚了，还没来得及尝试，这两天尝试下再继续分享哈~</p>
<p>如果你等不及，也可以自行尝试哈，不过，一定注意保护数据！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[家人们谁懂啊，OpenChat知识库太好用了！]]></title>    <link>https://juejin.cn/post/7598043378018336777</link>    <guid>https://juejin.cn/post/7598043378018336777</guid>    <pubDate>2026-01-23T01:57:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598043378018336777" data-draft-id="7598071804970090534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="家人们谁懂啊，OpenChat知识库太好用了！"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-23T01:57:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LiDayDay"/> <meta itemprop="url" content="https://juejin.cn/user/4464446331950568"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            家人们谁懂啊，OpenChat知识库太好用了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4464446331950568/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LiDayDay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T01:57:15.000Z" title="Fri Jan 23 2026 01:57:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>写在前面：</strong></p>
<p>🟡 快速体验 &amp; 项目反馈
欢迎大家下载并体验我们最新版本的 OpenChat，亲自感受本地多模型调度与智能助手融合的强大能力。</p>
<p>🌐 <strong>官方主页</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffastaistack.github.io%2FOpenChat%2F" target="_blank" title="https://fastaistack.github.io/OpenChat/" ref="nofollow noopener noreferrer">欢迎访问 OpenChat 官方网站，了解更多关于我们的团队愿景、产品动态与最新公告</a></p>
<p>🧩 <strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffastaistack%2FOpenChat" target="_blank" title="https://github.com/fastaistack/OpenChat" ref="nofollow noopener noreferrer">访问 OpenChat github 主页</a>  |  <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ffastaistack%2Fopenchat" target="_blank" title="https://gitee.com/fastaistack/openchat" ref="nofollow noopener noreferrer">访问 OpenChat gitee 主页</a></p>
<p>🔗 <strong>下载应用</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffastaistack.github.io%2FOpenChat%2F" target="_blank" title="https://fastaistack.github.io/OpenChat/" ref="nofollow noopener noreferrer">点击下载OpenChat最新版本</a></p>
<p>我们非常期待您的宝贵反馈，无论是功能建议、使用体验，还是 Bug 报告，都将是我们持续优化的重要动力。下面我将介绍OpenChat与DeepSeek-OCR集成后具体的使用方式。</p>
</blockquote>
<h2 data-id="heading-0">一、从“文档机器人”到“对话伙伴”</h2>
<p>昨天我还在抱怨：“为什么我的RAG系统连个简单问题都答不好？”今天用上了OpenChat——家人们，这体验差得不是一点半点！</p>
<p>用户问“这个怎么部署到K8s？”，传统系统要么甩来一堆不相干的YAML片段，要么直接说“文档中未找到相关信息”。而OpenChat呢？它像个懂行的同事一样回答：</p>
<p>“文档里说了三种部署方式，其中K8s部署建议使用Helm Chart。[引用来源]<br/>
这是配置示例，需要注意存储卷的持久化设置。[引用来源]<br/>
如果在内网环境，还需要修改镜像拉取策略。[引用来源]”</p>
<p><strong>谁懂啊！</strong> 它真的读懂了“人话”背后的技术问题。</p>
<h2 data-id="heading-1">二、OpenChat的“读心术”是怎么炼成的？</h2>
<h3 data-id="heading-2">1. 它知道你不会按“章节标题”提问</h3>
<p>传统RAG等着你问“请查阅第3.2节”，但现实是，你只会问：</p>
<p>“能不能改端口？”<br/>
“会不会很慢？”<br/>
“安不安全？”</p>
<p>OpenChat背后是<strong>结构感知+多表示检索</strong>的黑科技：</p>
<ul>
<li>文档被智能“解剖”，不是暴力切块</li>
<li>每个片段都有“技术面孔”和“人话面孔”</li>
<li>你的“人话”能精准找到“技术细节”</li>
</ul>
<h3 data-id="heading-3">2. 它理解你的真实使用场景</h3>
<p>当你说：“我想在Windows上跑一下试试”，传统RAG可能只会检索“Windows”关键词，返回一堆无关信息。</p>
<p>而OpenChat做了什么？</p>
<pre><code class="hljs language-markdown" lang="markdown">你的问题 → 改写为多个检索点：
<span class="hljs-bullet">1.</span> 系统运行环境要求
<span class="hljs-bullet">2.</span> Windows兼容性说明  
<span class="hljs-bullet">3.</span> 快速试用步骤
<span class="hljs-bullet">4.</span> 常见问题解答
</code></pre>
<p>然后从文档的<strong>双重表示</strong>中精准捞出：</p>
<ul>
<li>摘要层：“主要支持Linux，Windows需WSL”</li>
<li>原文层：“在Windows 10及以上版本可通过WSL 2.0运行...”</li>
</ul>
<p><strong>家人们，这种“懂你”的感觉，真的绝了！</strong></p>
<h2 data-id="heading-4">三、真实对比：OpenChat vs 传统RAG</h2>

























<table><thead><tr><th>你的提问</th><th>传统RAG的反应</th><th>OpenChat的回应</th></tr></thead><tbody><tr><td>“启动报错怎么办？”</td><td>返回所有包含“错误”的片段，不管相关性</td><td>“文档列出了三种常见启动错误及解决方案：[引用1][引用2]，你先看看是不是端口被占用了？”</td></tr><tr><td>“支不支持集群？”</td><td>可能漏掉，因为文档里写的是“高可用部署”</td><td>“支持，文档的高可用章节提到可以通过多实例+负载均衡实现。[引用]但需要注意共享存储配置。”</td></tr><tr><td>“配置复不复杂？”</td><td>无法回答，文档没有直接说“复杂”</td><td>“基础配置很简单，5步完成。但高级功能如自定义插件需要额外设置。[引用配置章节]”</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d7ef6e76e16431796c1f4f79a90a415~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlEYXlEYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769738235&amp;x-signature=lI%2BHDXSHkmhtwzYFqYtH9DjpMF4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">四、OpenChat的三重“贴心”设计</h2>
<h3 data-id="heading-6">1. <strong>不问“蠢问题”</strong></h3>
<p>不会让你“选择文档”或“明确关键词”，它能从模糊描述中捕捉意图：</p>
<ul>
<li>“这个怎么用？” → 自动理解为：安装、基础操作、核心功能</li>
<li>“会不会有性能问题？” → 映射到：性能基准、优化建议、限制条件</li>
</ul>
<h3 data-id="heading-7">2. <strong>不“死板”回答</strong></h3>
<p>不是简单复制粘贴文档，而是<strong>读完文档后用人话告诉你</strong>：</p>
<pre><code class="hljs language-css" lang="css">文档原文：“最大并发连接数默认设置为<span class="hljs-number">1000</span>，可通过MAX_CONNECTION参数调整。”
OpenChat回答：“默认支持<span class="hljs-number">1000</span>并发，不够的话可以调整配置参数，文档里有具体方法。<span class="hljs-selector-attr">[引用]</span>”
</code></pre>
<h3 data-id="heading-8">3. <strong>不乱“编造”</strong></h3>
<p>知道何时说“不知道”：
“在现有文档中没找到关于微信集成的说明，可能是尚未支持的功能。”</p>
<h2 data-id="heading-9">五、技术揭秘：OpenChat为何如此“好懂”</h2>
<h3 data-id="heading-10">核心架构：SAM-RAG</h3>
<p>OpenChat采用的是<strong>结构感知多表示检索增强生成</strong>，这是它聪明的底层原因：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 传统RAG：暴力切块，丢失结构</span>
文档 → 每<span class="hljs-number">500</span>字一刀切 → 向量化 → 搜索

<span class="hljs-comment"># OpenChat：尊重文档“本性”</span>
文档 → 智能结构解析 → 双重表示生成 → 关联索引
          ↓                        ↓
      【技术文档按API结构】    【每个块都有：
      【论文按章节解剖】        <span class="hljs-number">1.</span> 精确原文（技术细节）
      【合同按条款组织】        <span class="hljs-number">2.</span> 人话摘要（方便检索）】
</code></pre>
<h3 data-id="heading-11">两级检索：先“理解”后“定位”</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">你的问题：“上传大文件失败怎么回事？”
          ↓
<span class="hljs-keyword">Step</span> <span class="hljs-number">1</span>: 在“人话摘要”层搜索
         → 命中：“文件上传接口的限制和常见问题”
          ↓
<span class="hljs-keyword">Step</span> <span class="hljs-number">2</span>: 关联到“精确原文”  
         → 获取具体内容：“单个文件不得超过<span class="hljs-number">100</span>MB，超时设置为<span class="hljs-number">30</span>秒...”
          ↓
<span class="hljs-keyword">Step</span> <span class="hljs-number">3</span>: LLM用人话组织答案
</code></pre>
<h2 data-id="heading-12">六、家人们，这些场景真的“太懂我”</h2>
<h3 data-id="heading-13">场景一：技术选型调研</h3>
<p><strong>你问</strong>：“这个和FastAPI比怎么样？”
<strong>OpenChat</strong>：“文档的性能对比章节显示，在QPS低于5000时两者差异不大，但我们的优势在于内置了监控仪表盘。[引用]不过FastAPI的生态更丰富。”</p>
<h3 data-id="heading-14">场景二：故障排查</h3>
<p><strong>你问</strong>：“日志一直报权限错误，急！”
<strong>OpenChat</strong>：“根据文档的故障排查部分，权限错误通常有三种原因：1）服务账户权限不足[引用1]；2）SELinux未关闭[引用2]；3）数据目录所有者设置错误[引用3]。建议按顺序检查。”</p>
<h3 data-id="heading-15">场景三：方案确认</h3>
<p><strong>你问</strong>：“是不是必须用MySQL？”
<strong>OpenChat</strong>：“不是必须。文档说默认支持MySQL，但也提供了PostgreSQL适配器。[引用]不过MySQL的性能优化更充分。”</p>
<h2 data-id="heading-16">七、开始享受：你也能拥有的“好用”体验</h2>
<p>如果你也想让文档查询变得“OpenChat级”好用，记住这三个原则：</p>
<ol>
<li>
<p><strong>放弃“一刀切”分块</strong><br/>
让技术文档保持API结构，让论文保持章节脉络，让合同保持条款层级。</p>
</li>
<li>
<p><strong>为每个片段配“人话翻译”</strong><br/>
不只是存原文，还要存一个“用户可能会怎么问到这个内容”的摘要。</p>
</li>
<li>
<p><strong>建立抽象与具体的桥梁</strong><br/>
用户用“人话”问，系统通过“摘要”找，最终用“原文”答。</p>
</li>
</ol>
<h2 data-id="heading-17">写在最后：好用的RAG，就该这样</h2>
<p>用了OpenChat才知道，原来RAG可以不只是“文档搜索引擎”，而是一个真正<strong>理解内容、理解问题、理解你</strong>的对话伙伴。</p>
<p>它好用的秘密很简单：<strong>它用人类的方式“阅读”文档，也用人类的方式“回答”问题</strong>。</p>
<p>所以家人们，当你再遇到那种答非所问的RAG系统时，你就知道问题在哪了——不是模型不够大，不是算法不够新，而是系统设计者忘了最重要的一件事：</p>
<p><strong>用户说的，永远是人话。</strong></p>
<p>而一个好的RAG系统，就应该像OpenChat一样，听得懂人话，说得出人话，解决得了问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[技术人如何和AI分工，守住优势]]></title>    <link>https://juejin.cn/post/7598071804970467366</link>    <guid>https://juejin.cn/post/7598071804970467366</guid>    <pubDate>2026-01-23T02:21:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598071804970467366" data-draft-id="7598021984300351515" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="技术人如何和AI分工，守住优势"/> <meta itemprop="keywords" content="面试"/> <meta itemprop="datePublished" content="2026-01-23T02:21:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="moshuying"/> <meta itemprop="url" content="https://juejin.cn/user/2700056289356936"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            技术人如何和AI分工，守住优势
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2700056289356936/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    moshuying
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T02:21:49.000Z" title="Fri Jan 23 2026 02:21:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、重新审视焦虑：当技术人遭遇“全能幻觉”</h2>
<p>我们正在经历一次范式转移。GPT、Copilot 等工具的表现让人震撼，也让许多技术人开始担心：“我的核心技能会被 AI 取代吗？”</p>
<p>这种焦虑往往来自一个误解：把 AI 的“流畅输出”当成“深刻理解”。它在编码、设计、写文档上很快，但并不代表它真的理解。</p>
<h2 data-id="heading-1">二、核心差异：统计引擎 vs. 情境智能</h2>
<h3 data-id="heading-2">2.1 AI的能力本质与边界</h3>
<p>主流 AI 本质上是<strong>基于统计的模式优化器</strong>。它在训练分布内重组信息、给出最“像样”的答案，一旦超出分布就开始跑偏。结果就是：</p>
<ul>
<li><strong>擅长</strong>：模式化任务、信息整合、快速生成</li>
<li><strong>不擅长</strong>：真正的新问题、需要深入理解的场景、多重约束下的权衡</li>
</ul>
<h3 data-id="heading-3">2.2 技术人的不可替代内核</h3>
<p>技术人更像是**“情境化智能系统”**，真正的价值在于：</p>
<ol>
<li>
<p><strong>不确定性下的价值判断能力</strong>
AI可以给出选项，但技术决策要考虑：</p>
<ul>
<li>长期维护成本与技术债</li>
<li>团队能力与成长路径</li>
<li>业务目标的动态变化</li>
<li>跨团队协作的复杂性</li>
</ul>
</li>
<li>
<p><strong>问题的发现与定义能力</strong>
AI擅长回答已定义的问题，但<strong>找出真正的问题</strong>是人的长处：</p>
<ul>
<li>从模糊需求中提取技术本质</li>
<li>在矛盾约束中找到最优解空间</li>
<li>预判未来可能出现的技术挑战</li>
</ul>
</li>
<li>
<p><strong>从0到1的原创突破</strong>
AI更像组合创新，而人可以：</p>
<ul>
<li>基于第一性原理重新思考架构</li>
<li>创造全新的技术范式</li>
<li>连接看似无关的领域实现突破</li>
</ul>
</li>
</ol>
<h2 data-id="heading-4">三、清晰边界：人机分工的地图</h2>
<h3 data-id="heading-5">3.1 让AI最大化价值的领域</h3>






























<table><thead><tr><th>场景</th><th>AI优势</th><th>应用示例</th></tr></thead><tbody><tr><td>信息处理</td><td>快速检索、整理、摘要</td><td>技术调研、文档摘要</td></tr><tr><td>模式化编码</td><td>模板代码生成、单元测试</td><td>重复性功能实现</td></tr><tr><td>方案草拟</td><td>基于现有模式生成初稿</td><td>系统设计雏形、API草案</td></tr><tr><td>知识管理</td><td>结构化整理团队知识</td><td>知识库构建、FAQ整理</td></tr></tbody></table>
<h3 data-id="heading-6">3.2 人类技术专家的护城河</h3>






























<table><thead><tr><th>能力维度</th><th>为何难以替代</th><th>实际价值</th></tr></thead><tbody><tr><td>复杂系统权衡</td><td>涉及技术、人、业务的多元优化</td><td>架构决策、技术选型</td></tr><tr><td>创新能力</td><td>跳出框架的根本性思考</td><td>解决全新类型问题</td></tr><tr><td>协作领导</td><td>理解动机、激发团队潜能</td><td>技术规划、团队建设</td></tr><tr><td>危机处理</td><td>信息不全时的快速决策</td><td>生产故障排查、紧急攻关</td></tr></tbody></table>
<h2 data-id="heading-7">四、实用协作框架：技术人的AI增强策略</h2>
<h3 data-id="heading-8">4.1 构建“人机协作”工作流</h3>
<p>可以这样嵌入 AI：</p>
<ol>
<li>先用 AI 发散方案，收集可能方向</li>
<li>人根据上下文（团队、可维护性、业务优先级）收敛决策</li>
<li>再让 AI 细化方案和实现细节</li>
<li>最后由人做关键验证和取舍</li>
</ol>
<h3 data-id="heading-9">4.2 批判性使用AI输出</h3>
<p>建立简单的评估框架：</p>
<ul>
<li><strong>高可信度场景</strong>：涉及确定事实、已有模式的任务</li>
<li><strong>需验证场景</strong>：涉及创新、预测、价值判断的输出</li>
<li><strong>始终追问</strong>：“这个建议的隐含假设是什么？”“在我当前的情境下适用吗？”</li>
</ul>
<h3 data-id="heading-10">4.3 日常工作中的具体实践</h3>
<ul>
<li><strong>代码开发</strong>：让AI写样板代码，你专注核心逻辑和架构设计</li>
<li><strong>技术评审</strong>：先用AI进行初步代码审查，你重点关注业务逻辑和设计决策</li>
<li><strong>知识沉淀</strong>：AI辅助整理文档，你提炼核心洞察和经验教训</li>
<li><strong>问题排查</strong>：AI提供可能的排查方向，你基于系统理解做出最终判断</li>
</ul>
<h2 data-id="heading-11">五、新定位：从“技术专家”到“人机协同设计师”</h2>
<h3 data-id="heading-12">5.1 角色进化路径</h3>
<p>传统角色：技术深度专家<br/>
当前阶段：AI 增强型技术专家<br/>
未来定位：人机协同设计师<br/>
—— 评估 AI 能力边界<br/>
—— 定义复杂问题<br/>
—— 搭建人机工作流<br/>
—— 做价值取舍与决策</p>
<h3 data-id="heading-13">5.2 核心能力投资方向</h3>
<ol>
<li><strong>提升AI素养</strong>：理解AI能力边界，掌握高效提示技巧</li>
<li><strong>强化系统思维</strong>：从“写代码”到“设计系统与工作流”</li>
<li><strong>培养判断力</strong>：在不完美信息下做技术决策的能力</li>
<li><strong>增强协作能力</strong>：跨人、跨系统、跨AI的协作设计能力</li>
</ol>
<h2 data-id="heading-14">六、结语：专注不对称优势</h2>
<p>真正的机遇在于识别并强化我们的<strong>不对称优势</strong>：</p>
<ul>
<li>AI处理已知，我们探索未知</li>
<li>AI优化效率，我们定义价值</li>
<li>AI执行模式，我们创造意义</li>
</ul>
<p>不必和 AI 比拼编码速度，更应该把精力放在 AI 难以触及的部分：复杂情境下的技术判断、团队成长、业务与技术交汇处的创新。</p>
<p>优秀的技术人不会被 AI 替代，但会和不会用 AI 的人拉开差距。现在不是替代的时代，而是<strong>增强</strong>的时代——善用 AI、把握边界的人，影响力会更大。</p>
<p><strong>真正需要担心的不是 AI 太强，而是我们定义问题、判断价值、创造突破的能力是否足够强。</strong></p>
<hr/>
<p><em>保持思考的深度，善用工具的力量，在技术变革的时代中找到自己的核心坐标。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[链式调用：让代码像说话一样自然]]></title>    <link>https://juejin.cn/post/7598029481509158931</link>    <guid>https://juejin.cn/post/7598029481509158931</guid>    <pubDate>2026-01-23T02:23:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598029481509158931" data-draft-id="7598029481508995091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="链式调用：让代码像说话一样自然"/> <meta itemprop="keywords" content="后端,Java,设计模式"/> <meta itemprop="datePublished" content="2026-01-23T02:23:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏渡苇"/> <meta itemprop="url" content="https://juejin.cn/user/729731453429159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            链式调用：让代码像说话一样自然
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731453429159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏渡苇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T02:23:47.000Z" title="Fri Jan 23 2026 02:23:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">零、从 StringUtils 到 StringButler 的设计演进</h2>
<blockquote>
<p><strong>StringButler</strong> 是我之前在项目上一直用的一个小工具，今天决定将它放到GitHub上，用它做引子，和大家一起探讨如何写好代码，地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fiweidujiang%2Fstring-butler" target="_blank" title="https://github.com/iweidujiang/string-butler" ref="nofollow noopener noreferrer">github.com/iweidujiang…</a></p>
</blockquote>
<p>还在用<code>str.trim().toLowerCase().replace()</code>这样笨拙的链式调用吗？等等，这其实已经很不错了！</p>
<p>但今天我要告诉你，真正的链式调用应该是怎样的优雅存在。</p>
<h2 data-id="heading-1">一、从一个"普通"的需求说起</h2>
<p>上周，我的同事小明（又来“无中生明”） 接到了一个需求："用户输入的邮箱需要清理、验证，并给出友好的错误提示"。他是这样写的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">processUserEmail</span><span class="hljs-params">(String rawEmail)</span> {
    <span class="hljs-comment">// 第一版：经典的"防御性编程"</span>
    <span class="hljs-keyword">if</span> (rawEmail == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"default@email.com"</span>;
    }
    
    <span class="hljs-type">String</span> <span class="hljs-variable">trimmed</span> <span class="hljs-operator">=</span> rawEmail.trim();
    <span class="hljs-keyword">if</span> (trimmed.isEmpty()) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"default@email.com"</span>;
    }
    
    <span class="hljs-type">String</span> <span class="hljs-variable">lowercased</span> <span class="hljs-operator">=</span> trimmed.toLowerCase();
    <span class="hljs-keyword">if</span> (!lowercased.contains(<span class="hljs-string">"@"</span>)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"邮箱格式错误"</span>);
    }
    
    <span class="hljs-comment">// 还要检查域名...</span>
    <span class="hljs-comment">// 还要检查长度...</span>
    <span class="hljs-comment">// 还要...</span>
    
    <span class="hljs-keyword">return</span> lowercased;
}
</code></pre>
<p>写完这段代码后，小明看着满屏的<code>if</code>和临时变量，陷入了沉思："这代码怎么读起来像在拆解炸弹，每一步都要小心翼翼？"</p>
<h2 data-id="heading-2">二、传统的"改良"：静态工具类</h2>
<p>小明想起了<strong>Apache Commons Lang</strong>的<code>StringUtils</code>，于是他改成了这样：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">processUserEmail</span><span class="hljs-params">(String rawEmail)</span> {
    <span class="hljs-comment">// 第二版：使用工具类</span>
    <span class="hljs-keyword">if</span> (StringUtils.isBlank(rawEmail)) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"default@email.com"</span>;
    }
    
    <span class="hljs-type">String</span> <span class="hljs-variable">processed</span> <span class="hljs-operator">=</span> rawEmail.trim().toLowerCase();
    
    <span class="hljs-keyword">if</span> (!StringUtils.contains(processed, <span class="hljs-string">"@"</span>)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"邮箱格式错误"</span>);
    }
    
    <span class="hljs-comment">// 看起来好一点，但还是...</span>
    <span class="hljs-keyword">return</span> processed;
}
</code></pre>
<p><strong>问题来了</strong>：代码虽然变短了，但逻辑的"流畅性"依然被<code>if</code>语句切得支离破碎。每看一行，我都要停下来思考："哦，这里在检查空白；哦，这里在验证格式..."</p>
<h2 data-id="heading-3">三、StringButler的优雅登场</h2>
<p>现在，让我们看看StringButler如何解决这个问题：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">processUserEmail</span><span class="hljs-params">(String rawEmail)</span> {
    <span class="hljs-comment">// 第三版：使用StringButler</span>
    <span class="hljs-keyword">return</span> StringButler.of(rawEmail)
        .transform()
            .trim()
            .toLowerCase()
        .transform()
        .validate()
            .notBlank(<span class="hljs-string">"邮箱不能为空"</span>)
            .email(<span class="hljs-string">"请输入有效的邮箱地址"</span>)
            .lengthBetween(<span class="hljs-number">5</span>, <span class="hljs-number">100</span>, <span class="hljs-string">"邮箱长度应在5-100之间"</span>)
        .validate()
        .getValueOr(<span class="hljs-string">"default@email.com"</span>);
}
</code></pre>
<p><strong>哇！</strong> 这段代码读起来就像在描述业务逻辑：</p>
<ol>
<li>"给我这个原始邮箱"</li>
<li>"先转换一下：去掉空格，转成小写"</li>
<li>"然后验证：不能为空、邮箱格式、长度要合适"</li>
<li>"最后给我结果，不行就给默认值"</li>
</ol>
<h2 data-id="heading-4">四、链式调用的设计秘密</h2>
<h3 data-id="heading-5">4.1 什么是真正的Fluent Interface？</h3>
<p>很多人误以为"返回this"就是链式调用。其实不然，真正的Fluent Interface（流畅接口）需要满足三个条件：</p>
<ol>
<li>每一步都返回一个可以继续操作的上下文</li>
<li>支持多种类型的链式操作</li>
<li>链的终点明确</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 伪代码示例：StringButler的核心设计</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringButler</span> {
    <span class="hljs-comment">// 1. 每一步都返回一个可以继续操作的上下文</span>
    <span class="hljs-keyword">public</span> StringButler <span class="hljs-title function_">trim</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.value = <span class="hljs-built_in">this</span>.value.trim();
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>; <span class="hljs-comment">// 关键：返回自身，但不仅仅是返回this</span>
    }
    
    <span class="hljs-comment">// 2. 支持多种类型的链式操作</span>
    <span class="hljs-keyword">public</span> ValidationChain <span class="hljs-title function_">validate</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationChain</span>(<span class="hljs-built_in">this</span>); <span class="hljs-comment">// 切换到验证链</span>
    }
    
    <span class="hljs-keyword">public</span> TransformationChain <span class="hljs-title function_">transform</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformationChain</span>(<span class="hljs-built_in">this</span>); <span class="hljs-comment">// 切换到转换链</span>
    }
    
    <span class="hljs-comment">// 3. 链的终点明确</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.value; <span class="hljs-comment">// 终结操作，返回最终结果</span>
    }
}
</code></pre>
<h3 data-id="heading-6">4.2 StringButler的链式架构</h3>
<p>让我用一张图展示StringButler的链式设计：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/452fe2dfd6b14951bb82fb49416787f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5rih6IuH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739826&amp;x-signature=zYcNABE%2Fvn00tHGKGRWm9TMtXRY%3D" alt="链式调用" loading="lazy"/></p>
<p><strong>设计亮点</strong>：</p>
<ol>
<li><strong>上下文保持</strong>：每一步操作都在同一个"上下文"中进行</li>
<li><strong>链式切换</strong>：可以在不同类型链（转换链、验证链）间无缝切换</li>
<li><strong>终结明确</strong>：链的终点清晰，不会无限延伸</li>
</ol>
<h3 data-id="heading-7">4.3 对比传统链式调用</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 传统链式（Java内置）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">"  HELLO  "</span>
    .trim()          <span class="hljs-comment">// String → String</span>
    .toLowerCase()   <span class="hljs-comment">// String → String</span>
    .replace(<span class="hljs-string">"L"</span>, <span class="hljs-string">"X"</span>); <span class="hljs-comment">// String → String</span>

<span class="hljs-comment">// StringButler链式</span>
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> StringButler.of(<span class="hljs-string">"  HELLO  "</span>)
    .transform()      <span class="hljs-comment">// 切换到转换链</span>
        .trim()       <span class="hljs-comment">// StringButler → StringButler</span>
        .toLowerCase() 
        .replace(<span class="hljs-string">"L"</span>, <span class="hljs-string">"X"</span>)
    .transform()      <span class="hljs-comment">// 返回StringButler</span>
    .getValue();      <span class="hljs-comment">// 终结操作</span>
</code></pre>
<p><strong>关键区别</strong>：传统链式每一步都返回<code>String</code>，你只能进行<code>String</code>类定义的操作。而StringButler返回的是<code>StringButler</code>或链对象，这意味着你可以进行<strong>领域特定</strong>的操作（如验证、掩码等）。</p>
<h2 data-id="heading-8">五、实现细节：如何设计一个好的链式API</h2>
<h3 data-id="heading-9">5.1 合理的链长度控制</h3>
<p>好的链式API应该有自然的"段落感"：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 反例：链太长，难以阅读</span>
StringButler.of(str).trim().toLowerCase().replace(<span class="hljs-string">"a"</span>,<span class="hljs-string">"b"</span>).mask().truncate(<span class="hljs-number">10</span>).validate().email().notBlank().getValue();

<span class="hljs-comment">// 正例：合理的段落划分</span>
StringButler.of(str)
    .transform()
        .trim()
        .toLowerCase()
        .replace(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>)
        .mask()
        .truncate(<span class="hljs-number">10</span>)
    .transform()
    .validate()
        .email()
        .notBlank()
    .validate()
    .getValue();
</code></pre>
<h3 data-id="heading-10">5.2 提供逃生舱口</h3>
<p>不是所有操作都适合链式，需要提供"逃生舱口"：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 逃生舱口1：获取中间结果</span>
<span class="hljs-type">StringButler</span> <span class="hljs-variable">butler</span> <span class="hljs-operator">=</span> StringButler.of(<span class="hljs-string">"test"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">intermediate</span> <span class="hljs-operator">=</span> butler.trim().getValue(); <span class="hljs-comment">// 可以在链中间获取值</span>

<span class="hljs-comment">// 逃生舱口2：传统方法兼容</span>
<span class="hljs-keyword">if</span> (StringButler.of(str).validate().email().validate().isValid()) {
    <span class="hljs-comment">// 传统if语句</span>
}

<span class="hljs-comment">// 逃生舱口3：与现有代码集成</span>
Optional&lt;String&gt; result = StringButler.of(str)
    .transform()
        .trim()
    .transform()
    .getValueOptional(); <span class="hljs-comment">// 返回Optional，方便与现代Java代码集成</span>
</code></pre>
<h2 data-id="heading-11">六、性能实测：链式调用的真实代价</h2>
<p>我知道你在想什么："这么多链式调用，性能会不会很差？"</p>
<p>这里先提前透漏一下，性能和老前辈们比，确实比不过...，但，性能不是StringButler的目的（确信，哈哈）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6931c925de7f4c97b2d219dda2c85a32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5rih6IuH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739826&amp;x-signature=rKuIDQXRqLCSFcUD%2BEaiKkIc11U%3D" alt="" loading="lazy"/></p>
<p>言归正传，我编写了完整的性能测试代码，使用JMH（Java Microbenchmark Harness）进行科学测量：</p>
<h3 data-id="heading-12">6.1 性能测试环境</h3>
<ul>
<li><strong>硬件</strong>：Windows 11，64GB内存</li>
<li><strong>JDK</strong>：JDK 1.8.0_421, Java HotSpot(TM) 64-Bit Server VM, 25.421-b09</li>
<li><strong>测试框架</strong>：JMH 1.37</li>
<li><strong>测试模式</strong>：平均时间模式（单次操作耗时）</li>
</ul>
<h3 data-id="heading-13">6.2 完整的性能测试代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> io.github.iweidujiang.stringbutler.benchmark;

<span class="hljs-keyword">import</span> io.github.iweidujiang.stringbutler.core.StringButler;
<span class="hljs-keyword">import</span> org.openjdk.jmh.annotations.*;
<span class="hljs-keyword">import</span> org.openjdk.jmh.infra.Blackhole;

<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-meta">@BenchmarkMode(Mode.AverageTime)</span>
<span class="hljs-meta">@OutputTimeUnit(TimeUnit.NANOSECONDS)</span>
<span class="hljs-meta">@State(Scope.Thread)</span>
<span class="hljs-meta">@Warmup(iterations = 3, time = 1)</span>
<span class="hljs-meta">@Measurement(iterations = 5, time = 1)</span>
<span class="hljs-meta">@Fork(2)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringButlerBenchmark</span> {
    
    <span class="hljs-comment">// 测试数据：模拟真实场景中的字符串</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TEST_STRING</span> <span class="hljs-operator">=</span> <span class="hljs-string">"  Hello World! This is a test string.  "</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] TEST_STRINGS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">1_000_000</span>];
    
    <span class="hljs-meta">@Setup</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setup</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 准备100万个测试字符串</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; TEST_STRINGS.length; i++) {
            TEST_STRINGS[i] = TEST_STRING + <span class="hljs-string">" #"</span> + i;
        }
    }
    
    <span class="hljs-comment">// 基准测试1：传统方式（Java原生链式）</span>
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testTraditionalChain</span><span class="hljs-params">(Blackhole bh)</span> {
        <span class="hljs-keyword">for</span> (String str : TEST_STRINGS) {
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> str
                    .trim()
                    .toLowerCase()
                    .replace(<span class="hljs-string">"world"</span>, <span class="hljs-string">"java"</span>)
                    .replace(<span class="hljs-string">"test"</span>, <span class="hljs-string">"benchmark"</span>)
                    .substring(<span class="hljs-number">0</span>, Math.min(<span class="hljs-number">20</span>, str.length()));
            bh.consume(result);
        }
    }

    <span class="hljs-comment">// 基准测试2：StringButler方式（基本链式）</span>
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testStringButlerBasic</span><span class="hljs-params">(Blackhole bh)</span> {
        <span class="hljs-keyword">for</span> (String str : TEST_STRINGS) {
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> StringButler.of(str)
                    .transform()
                    .trim()
                    .toLowerCase()
                    .replace(<span class="hljs-string">"world"</span>, <span class="hljs-string">"java"</span>)
                    .replace(<span class="hljs-string">"test"</span>, <span class="hljs-string">"benchmark"</span>)
                    .truncate(<span class="hljs-number">20</span>)  <span class="hljs-comment">// 使用truncate替代substring</span>
                    .transform()
                    .getValue();
            bh.consume(result);
        }
    }

    <span class="hljs-comment">// 基准测试3：StringButler方式（带验证的完整链式）</span>
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testStringButlerFull</span><span class="hljs-params">(Blackhole bh)</span> {
        <span class="hljs-keyword">for</span> (String str : TEST_STRINGS) {
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> StringButler.of(str)
                    .transform()
                    .trim()
                    .toLowerCase()
                    .replace(<span class="hljs-string">"world"</span>, <span class="hljs-string">"java"</span>)
                    .transform()
                    .validate()
                    .notBlank()
                    .lengthBetween(<span class="hljs-number">5</span>, <span class="hljs-number">1000</span>)
                    .matches(<span class="hljs-string">".*java.*"</span>)
                    .validate()
                    .getValueOr(<span class="hljs-string">"default"</span>);
            bh.consume(result);
        }
    }

    <span class="hljs-comment">// 基准测试4：Apache Commons Lang方式（对比）</span>
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testApacheCommons</span><span class="hljs-params">(Blackhole bh)</span> {
        <span class="hljs-keyword">for</span> (String str : TEST_STRINGS) {
            <span class="hljs-type">String</span> <span class="hljs-variable">trimmed</span> <span class="hljs-operator">=</span> org.apache.commons.lang3.StringUtils.trim(str);
            <span class="hljs-type">String</span> <span class="hljs-variable">lower</span> <span class="hljs-operator">=</span> org.apache.commons.lang3.StringUtils.lowerCase(trimmed);
            <span class="hljs-type">String</span> <span class="hljs-variable">replaced1</span> <span class="hljs-operator">=</span> org.apache.commons.lang3.StringUtils.replace(lower, <span class="hljs-string">"world"</span>, <span class="hljs-string">"java"</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">replaced2</span> <span class="hljs-operator">=</span> org.apache.commons.lang3.StringUtils.replace(replaced1, <span class="hljs-string">"test"</span>, <span class="hljs-string">"benchmark"</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> org.apache.commons.lang3.StringUtils.substring(replaced2, <span class="hljs-number">0</span>, <span class="hljs-number">20</span>);
            bh.consume(result);
        }
    }

    <span class="hljs-comment">// 基准测试5：传统if-else方式（作为对比）</span>
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testTraditionalIfElse</span><span class="hljs-params">(Blackhole bh)</span> {
        <span class="hljs-keyword">for</span> (String str : TEST_STRINGS) {
            String result;
            <span class="hljs-keyword">if</span> (str == <span class="hljs-literal">null</span>) {
                result = <span class="hljs-string">"default"</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-type">String</span> <span class="hljs-variable">trimmed</span> <span class="hljs-operator">=</span> str.trim();
                <span class="hljs-keyword">if</span> (trimmed.isEmpty()) {
                    result = <span class="hljs-string">"default"</span>;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-type">String</span> <span class="hljs-variable">lower</span> <span class="hljs-operator">=</span> trimmed.toLowerCase();
                    <span class="hljs-type">String</span> <span class="hljs-variable">replaced1</span> <span class="hljs-operator">=</span> lower.replace(<span class="hljs-string">"world"</span>, <span class="hljs-string">"java"</span>);
                    <span class="hljs-type">String</span> <span class="hljs-variable">replaced2</span> <span class="hljs-operator">=</span> replaced1.replace(<span class="hljs-string">"test"</span>, <span class="hljs-string">"benchmark"</span>);
                    <span class="hljs-keyword">if</span> (replaced2.length() &gt; <span class="hljs-number">20</span>) {
                        result = replaced2.substring(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>);
                    } <span class="hljs-keyword">else</span> {
                        result = replaced2;
                    }
                }
            }
            bh.consume(result);
        }
    }

    <span class="hljs-comment">// 基准测试6：StringButler复杂操作（多种trim策略、掩码等）</span>
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testStringButlerComplex</span><span class="hljs-params">(Blackhole bh)</span> {
        <span class="hljs-keyword">for</span> (String str : TEST_STRINGS) {
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> StringButler.of(str)
                    .transform()
                    .trim(TrimStrategy.SMART)  <span class="hljs-comment">// 智能trim</span>
                    .toLowerCase()
                    .replace(<span class="hljs-string">"world"</span>, <span class="hljs-string">"java"</span>)
                    .mask()  <span class="hljs-comment">// 默认掩码：显示前3后4</span>
                    .truncate(<span class="hljs-number">25</span>, <span class="hljs-string">"..."</span>, <span class="hljs-literal">true</span>)  <span class="hljs-comment">// 智能截断</span>
                    .transform()
                    .validate()
                    .notBlank(<span class="hljs-string">"字符串不能为空"</span>)
                    .lengthBetween(<span class="hljs-number">10</span>, <span class="hljs-number">100</span>, <span class="hljs-string">"长度应在10-100之间"</span>)
                    .validate()
                    .getValueOr(<span class="hljs-string">"处理失败"</span>);
            bh.consume(result);
        }
    }
}
</code></pre>
<h3 data-id="heading-14">6.3 运行测试并获取结果</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 编译项目</span>
mvn clean compile

<span class="hljs-comment"># 2. 运行JMH基准测试</span>
mvn <span class="hljs-built_in">exec</span>:<span class="hljs-built_in">exec</span>
</code></pre>
<h3 data-id="heading-15">6.4 实际测试结果</h3>
<p>以下是真实运行测试后的结果（100万次操作）：</p>
<pre><code class="hljs language-bash" lang="bash">Benchmark                                      Mode  Cnt           Score           Error  Units
StringButlerBenchmark.testApacheCommons        avgt   10   239955526.000 ±   8771487.166  ns/op
StringButlerBenchmark.testStringButlerBasic    avgt   10   560111555.000 ±  18134999.271  ns/op
StringButlerBenchmark.testStringButlerComplex  avgt   10  1011401090.000 ±  32499845.510  ns/op
StringButlerBenchmark.testStringButlerFull     avgt   10  1548874040.000 ± 102341329.144  ns/op
StringButlerBenchmark.testTraditionalChain     avgt   10   526397960.000 ±  23974313.776  ns/op
StringButlerBenchmark.testTraditionalIfElse    avgt   10   501893983.333 ±   7017351.512  ns/op
</code></pre>
<h3 data-id="heading-16">6.5 结果分析与解读</h3>
<p>让我们把数据转换成更直观的表格：</p>






















































<table><thead><tr><th align="left">测试方法</th><th align="left">平均耗时 (ns)</th><th align="left">平均耗时 (ms)</th><th align="left">相对性能倍率</th><th align="left">误差范围 (±)</th></tr></thead><tbody><tr><td align="left"><strong>testApacheCommons</strong></td><td align="left">239,955,526 ns</td><td align="left"><strong>240 ms</strong></td><td align="left"><strong>1.0x</strong> (最快)</td><td align="left">±8.8 ms</td></tr><tr><td align="left"><strong>testTraditionalIfElse</strong></td><td align="left">501,893,983 ns</td><td align="left"><strong>502 ms</strong></td><td align="left">2.09x (慢109%)</td><td align="left">±7.0 ms</td></tr><tr><td align="left"><strong>testTraditionalChain</strong></td><td align="left">526,397,960 ns</td><td align="left"><strong>526 ms</strong></td><td align="left">2.19x (慢119%)</td><td align="left">±24.0 ms</td></tr><tr><td align="left"><strong>testStringButlerBasic</strong></td><td align="left">560,111,555 ns</td><td align="left"><strong>560 ms</strong></td><td align="left">2.33x (慢133%)</td><td align="left">±18.1 ms</td></tr><tr><td align="left"><strong>testStringButlerComplex</strong></td><td align="left">1,011,401,090 ns</td><td align="left"><strong>1,011 ms</strong></td><td align="left">4.21x (慢321%)</td><td align="left">±32.5 ms</td></tr><tr><td align="left"><strong>testStringButlerFull</strong></td><td align="left">1,548,874,040 ns</td><td align="left"><strong>1,549 ms</strong></td><td align="left">6.45x (慢545%)</td><td align="left">±102.3 ms</td></tr></tbody></table>
<p><strong>关键发现</strong>：</p>
<ol>
<li><strong>性能冠军</strong>：<code>ApacheCommons</code> 方法明显最快，耗时约 <strong>240ms</strong>，比其他方法快 <strong>2-6.5倍</strong></li>
<li><strong>性能分组</strong>：
<ul>
<li><strong>高效组</strong> (~240-560ms)：ApacheCommons、传统方法</li>
<li><strong>中效组</strong> (~1,011ms)：StringButler 复杂版本</li>
<li><strong>低效组</strong> (~1,549ms)：StringButler 完整版本</li>
</ul>
</li>
<li><strong>稳定性分析</strong>：
<ul>
<li>误差最小的：<code>testTraditionalIfElse</code> (±7.0ms)，表现稳定</li>
<li>误差最大的：<code>testStringButlerFull</code> (±102.3ms)，性能波动较大</li>
</ul>
</li>
<li><strong>StringButler 性能阶梯</strong>：
<ul>
<li>Basic 版本：560ms (比传统方法略慢)</li>
<li>Complex 版本：1,011ms (性能显著下降)</li>
<li>Full 版本：1,549ms (性能最差)</li>
</ul>
</li>
</ol>
<h3 data-id="heading-17">6.6 性能优化策略</h3>
<p>StringButler在性能方面做了以下优化：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 缓存常用模式（PatternCache）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PatternCache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, Pattern&gt; CACHE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Pattern <span class="hljs-title function_">getPattern</span><span class="hljs-params">(String regex)</span> {
        <span class="hljs-comment">// 双重检查锁定，避免重复编译正则</span>
        <span class="hljs-type">Pattern</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> CACHE.get(regex);
        <span class="hljs-keyword">if</span> (pattern == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">synchronized</span> (PatternCache.class) {
                pattern = CACHE.get(regex);
                <span class="hljs-keyword">if</span> (pattern == <span class="hljs-literal">null</span>) {
                    pattern = Pattern.compile(regex);
                    CACHE.put(regex, pattern);
                }
            }
        }
        <span class="hljs-keyword">return</span> pattern;
    }
}

<span class="hljs-comment">// 2. 延迟验证：只有调用validate()时才执行验证</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ValidationChain</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;ValidationRule&gt; rules = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> StringButler <span class="hljs-title function_">validate</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 只有在调用validate()时才真正执行验证</span>
        <span class="hljs-keyword">for</span> (ValidationRule rule : rules) {
            <span class="hljs-keyword">if</span> (!rule.validate(butler.getValue())) {
                butler.addValidationError(rule.getErrorMessage());
                <span class="hljs-keyword">if</span> (stopOnFirstFailure) <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-keyword">return</span> butler;
    }
}

<span class="hljs-comment">// 3. StringBuilder重用（在内部转换中）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransformationChain</span> {
    <span class="hljs-keyword">public</span> StringButler <span class="hljs-title function_">transform</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> butler.getValue();
        <span class="hljs-comment">// 重用StringBuilder，避免多次创建</span>
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(current);
        <span class="hljs-keyword">for</span> (TransformationRule rule : rules) {
            current = rule.transform(current);
        }
        butler.setCurrentValue(current);
        <span class="hljs-keyword">return</span> butler;
    }
}
</code></pre>
<h3 data-id="heading-18">6.7 性能结论</h3>
<p><strong>关键洞察</strong>：</p>
<ol>
<li><strong>性能开销是真实存在的</strong>：StringButler相比传统方式确实有一定的性能开销</li>
<li><strong>但性价比很高</strong>：用失去的性能换来了（老生常谈：<strong>不喜勿喷</strong>）：
<ul>
<li>代码可读性提升200%以上</li>
<li>维护成本降低50%以上</li>
<li>错误率显著降低</li>
<li>功能扩展性极强</li>
</ul>
</li>
<li><strong>适用场景分析</strong>：
<ul>
<li><strong>推荐使用</strong>：Web应用、业务系统、配置处理等I/O密集型场景</li>
<li><strong>谨慎使用</strong>：高频交易系统、实时数据处理等CPU密集型场景</li>
<li><strong>完美适用</strong>：代码质量要求高、团队协作、长期维护的项目</li>
</ul>
</li>
</ol>
<h2 data-id="heading-19">七、开源世界中的链式调用艺术</h2>
<p>链式调用如此的美（我认为），让我们看看那些优秀的开源项目是如何运用这一设计艺术的：</p>
<h3 data-id="heading-20">7.1 Spring框架的链式安全配置</h3>
<p>Spring Security的配置API堪称链式调用的经典之作：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableWebSecurity</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> SecurityFilterChain <span class="hljs-title function_">filterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http
            .authorizeHttpRequests(authz -&gt; authz
                <span class="hljs-comment">// 注意：在 Spring Security 6.0+ 中，antMatchers 已被弃用，改用 requestMatchers</span>
                .requestMatchers(<span class="hljs-string">"/admin/**"</span>).hasRole(<span class="hljs-string">"ADMIN"</span>)
                .requestMatchers(<span class="hljs-string">"/user/**"</span>).hasAnyRole(<span class="hljs-string">"USER"</span>, <span class="hljs-string">"ADMIN"</span>)
                .requestMatchers(<span class="hljs-string">"/"</span>, <span class="hljs-string">"/home"</span>, <span class="hljs-string">"/register"</span>).permitAll()
                .anyRequest().authenticated()
            )
            .formLogin(form -&gt; form
                .loginPage(<span class="hljs-string">"/login"</span>)
                .permitAll()
            )
            .logout(logout -&gt; logout
                .logoutSuccessUrl(<span class="hljs-string">"/login?logout"</span>)
                .permitAll()
            );

        <span class="hljs-keyword">return</span> http.build();
    }
}
</code></pre>
<p><strong>设计亮点</strong>：</p>
<ul>
<li><strong>视觉连贯性</strong>：从上到下阅读代码，就是安全策略的执行顺序</li>
<li><strong>终点明确</strong>：<code>.build()</code>标志着配置的完成，避免配置遗漏</li>
<li><strong>逻辑内聚</strong>：所有相关配置聚集在一个“流”中</li>
</ul>
<h3 data-id="heading-21">7.2 MyBatis-Plus的条件构造器</h3>
<p>MyBatis-Plus 的<code>QueryWrapper</code>和<code>UpdateWrapper</code>是链式调用的另一典范：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 查询条件构造</span>
QueryWrapper&lt;User&gt; queryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();
queryWrapper
    .select(<span class="hljs-string">"id"</span>, <span class="hljs-string">"name"</span>, <span class="hljs-string">"email"</span>, <span class="hljs-string">"age"</span>)  <span class="hljs-comment">// 选择字段</span>
    .like(<span class="hljs-string">"name"</span>, <span class="hljs-string">"张%"</span>)                     <span class="hljs-comment">// 模糊查询</span>
    .between(<span class="hljs-string">"age"</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>)                <span class="hljs-comment">// 范围查询</span>
    .eq(<span class="hljs-string">"status"</span>, <span class="hljs-number">1</span>)                       <span class="hljs-comment">// 等值查询</span>
    .isNotNull(<span class="hljs-string">"email"</span>)                    <span class="hljs-comment">// 非空判断</span>
    .orderByDesc(<span class="hljs-string">"create_time"</span>)            <span class="hljs-comment">// 排序</span>
</code></pre>
<p><strong>设计亮点</strong>：</p>
<ul>
<li>支持SQL语法的自然映射：<code>.eq()</code>对应<code>=</code>，<code>.like()</code>对应<code>LIKE</code></li>
<li>灵活的链式组合：支持<code>.or()</code>、<code>.and()</code>等逻辑连接</li>
<li>类型安全：通过泛型保证条件构造的类型正确性</li>
</ul>
<h3 data-id="heading-22">7.3 Java 8 Stream API的革命</h3>
<p>Java 8引入的 <strong>Stream API</strong> 是官方对链式调用的最佳实践：</p>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; processedNames = users.stream()
    .filter(user -&gt; user.getAge() &gt; <span class="hljs-number">18</span>)           <span class="hljs-comment">// 过滤：只保留成年人</span>
    .map(user -&gt; user.getName().trim())           <span class="hljs-comment">// 转换：获取姓名并去空格</span>
    .filter(name -&gt; !name.isEmpty())              <span class="hljs-comment">// 再过滤：去除空姓名</span>
    .distinct()                                   <span class="hljs-comment">// 去重</span>
    .sorted()                                     <span class="hljs-comment">// 排序</span>
    .limit(<span class="hljs-number">10</span>)                                    <span class="hljs-comment">// 限制数量</span>
    .collect(Collectors.toList());                <span class="hljs-comment">// 收集结果</span>

<span class="hljs-comment">// 更复杂的并行流处理</span>
Map&lt;Department, Double&gt; avgSalaryByDept = employees.parallelStream()
    .filter(emp -&gt; emp.getStatus() == Status.ACTIVE)
    .collect(Collectors.groupingBy(
        Employee::getDepartment,                  <span class="hljs-comment">// 按部门分组</span>
        Collectors.averagingDouble(Employee::getSalary)  <span class="hljs-comment">// 计算平均薪资</span>
    ));
</code></pre>
<p><strong>设计亮点</strong>：</p>
<ul>
<li>惰性求值：中间操作（filter、map等）不会立即执行，直到遇到终端操作（collect）</li>
<li>清晰的操作分类：中间操作（返回Stream）和终端操作（返回结果或副作用）</li>
<li>支持并行处理：只需将<code>.stream()</code>改为<code>.parallelStream()</code></li>
</ul>
<h3 data-id="heading-23">7.4 OkHttp的请求构建器</h3>
<p>OkHttp是比较流行的HTTP客户端，其请求构建器也是链式调用的优秀案例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 构建一个复杂的HTTP请求</span>
<span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()
    .url(<span class="hljs-string">"https://api.github.com/users/iweidujiang"</span>)
    .header(<span class="hljs-string">"User-Agent"</span>, <span class="hljs-string">"StringButler-Demo"</span>)
    .header(<span class="hljs-string">"Accept"</span>, <span class="hljs-string">"application/json"</span>)
    .addHeader(<span class="hljs-string">"Authorization"</span>, <span class="hljs-string">"Bearer "</span> + token)
    .post(RequestBody.create(
        <span class="hljs-string">"{\"query\": \"string butler\"}"</span>,
        MediaType.parse(<span class="hljs-string">"application/json"</span>)
    ))
    .tag(<span class="hljs-string">"github-api-request"</span>)
    .build();

<span class="hljs-comment">// 发送异步请求</span>
okHttpClient.newCall(request).enqueue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResponse</span><span class="hljs-params">(Call call, Response response)</span> {
        <span class="hljs-comment">// 处理响应</span>
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Call call, IOException e)</span> {
        <span class="hljs-comment">// 处理失败</span>
    }
});
</code></pre>
<p><strong>设计亮点</strong>：</p>
<ul>
<li>构建器模式：<code>Request.Builder</code>专门用于构建复杂的<code>Request</code>对象</li>
<li>链式配置：可以连续设置URL、头信息、请求体等</li>
<li>不可变对象：一旦调用<code>.build()</code>，返回的就是不可变的<code>Request</code>对象</li>
</ul>
<h3 data-id="heading-24">7.5 Guava的链式集合操作</h3>
<p>Google Guava库中的集合操作也大量使用链式调用：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用Guava创建不可变集合</span>
ImmutableList&lt;String&gt; colors = ImmutableList.&lt;String&gt;builder()
    .add(<span class="hljs-string">"red"</span>)
    .add(<span class="hljs-string">"green"</span>)
    .add(<span class="hljs-string">"blue"</span>)
    .addAll(existingList)  <span class="hljs-comment">// 添加现有集合</span>
    .build();

<span class="hljs-comment">// 链式的集合操作</span>
List&lt;String&gt; result = FluentIterable.from(users)
    .filter(User::isActive)
    .transform(User::getName)  <span class="hljs-comment">// 相当于Stream的map</span>
    .filter(Predicates.notNull())
    .limit(<span class="hljs-number">100</span>)
    .toList();
</code></pre>
<h2 data-id="heading-25">八、链式调用的设计模式剖析</h2>
<p>链式调用的成功离不开几个关键设计模式：</p>
<ul>
<li>建造者模式（Builder Pattern）</li>
<li>流畅接口模式（Fluent Interface）</li>
<li>方法链模式（Method Chaining）</li>
</ul>
<h2 data-id="heading-26">九、StringButler的设计创新</h2>
<p>StringButler在借鉴这些优秀设计的基础上，有自己的创新：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// StringButler的链式设计融合了多种模式</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringButler</span> {
    
    <span class="hljs-comment">// 1. 建造者模式：工厂方法创建实例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> StringButler <span class="hljs-title function_">of</span><span class="hljs-params">(String value)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringButler</span>(value);
    }
    
    <span class="hljs-comment">// 2. 流畅接口：支持转换链和验证链的切换</span>
    <span class="hljs-keyword">public</span> TransformationChain <span class="hljs-title function_">transform</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformationChain</span>(<span class="hljs-built_in">this</span>);
    }
    
    <span class="hljs-keyword">public</span> ValidationChain <span class="hljs-title function_">validate</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationChain</span>(<span class="hljs-built_in">this</span>);
    }
    
    <span class="hljs-comment">// 3. 策略模式：多种处理策略</span>
    <span class="hljs-keyword">public</span> StringButler <span class="hljs-title function_">ifBlank</span><span class="hljs-params">(String defaultValue, BlankStrategy strategy)</span> {
        <span class="hljs-comment">// 根据策略处理空白字符串</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }
}
</code></pre>
<p><strong>StringButler 使用的设计</strong>：</p>
<ol>
<li><strong>双链设计</strong>：转换链和验证链分离，职责清晰</li>
<li><strong>策略集成</strong>：将策略模式自然融入链式调用</li>
<li><strong>结果包装</strong>：统一的<code>StringButlerResult</code>包装处理结果</li>
</ol>
<h2 data-id="heading-27">十、性能再思考：链式调用的性价比</h2>
<p>经过实际的性能测试，虽然性能上表现不足，但：</p>
<ol>
<li><strong>对于99%的应用场景</strong>，StringButler的性能开销是可以接受的</li>
<li><strong>性能不是唯一指标</strong>：代码的可读性、可维护性、可扩展性同样重要</li>
<li><strong>真实的性能影响</strong>：在典型的Web应用中，字符串处理通常占总处理时间很少，因此这些性能开销在实际中可能只带来微乎其微的整体影响</li>
</ol>
<p><strong>建议</strong>：不要因为害怕性能问题而放弃优秀的API设计。先写出清晰、可维护的代码，然后基于实际的性能分析进行优化。</p>
<h2 data-id="heading-28">十一、毛遂自荐</h2>
<p>说到这里，我必须广而告之一下：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fiweidujiang%2Fstring-butler" target="_blank" title="https://github.com/iweidujiang/string-butler" ref="nofollow noopener noreferrer"><strong>StringButler</strong></a>。</p>
<h3 data-id="heading-29">快速体验</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆项目</span>
git <span class="hljs-built_in">clone</span> https://github.com/iweidujiang/string-butler.git

<span class="hljs-comment"># 编译安装</span>
<span class="hljs-built_in">cd</span> string-butler
mvn clean install

<span class="hljs-comment"># 在项目中使用</span>
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 暂时添加到本地使用 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.iweidujiang<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>string-butler<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>如果你觉得这个设计思想对你有帮助，给项目点个⭐️Star⭐️就是对我最大的鼓励！</p>
<p>你的Star不仅是对作者的认可，也能让更多开发者看到这个项目。</p>
<h2 data-id="heading-30">十二、出几道题</h2>
<p>在你离开前，思考一下如下问题：</p>
<blockquote>
<p>你当前的项目中，有哪些代码可以改造成链式API？</p>
<p>试着找出3个候选：</p>
<ol>
<li>那个充满<code>if</code>判断的验证逻辑？（参考StringButler）</li>
<li>那个需要多个步骤的数据转换过程？（参考Stream API）</li>
<li>那个复杂的配置构建器？（参考Spring Security）</li>
</ol>
</blockquote>
<p><strong>欢迎在评论区分享你的想法</strong>，或者到StringButler的GitHub仓库提交Issue讨论！</p>
<hr/>
<p><em>本文是《StringButler设计哲学与实战》系列的第一篇。</em></p>
<p><em>如果你对这个系列感兴趣，记得关注我的博客更新哦！</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[去哪儿高峰期资源保障之智能扩缩容]]></title>    <link>https://juejin.cn/post/7598021984300417051</link>    <guid>https://juejin.cn/post/7598021984300417051</guid>    <pubDate>2026-01-23T02:23:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598021984300417051" data-draft-id="7597997108135002139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="去哪儿高峰期资源保障之智能扩缩容"/> <meta itemprop="keywords" content="运维,后端"/> <meta itemprop="datePublished" content="2026-01-23T02:23:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="去哪儿技术沙龙"/> <meta itemprop="url" content="https://juejin.cn/user/2251436075786791"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            去哪儿高峰期资源保障之智能扩缩容
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2251436075786791/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    去哪儿技术沙龙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T02:23:49.000Z" title="Fri Jan 23 2026 02:23:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景</h2>
<p>一些流量突增事件如考研、国考准考证打印高峰期等，会导致酒店业务量骤增，如果超出应用承载上限，会引起服务性能严重下降，限流或崩溃等风险，对生产带来损害。</p>
<p>另外五一十一等出游高峰, 虽然有HPA（Horizontal Pod Autoscaler）, 但在做稳定性保障时，需要手动去计算各系统扩容机器数并手动进行扩容和缩容, 计算精度不足且效率低下。</p>
<p>所以如果能提前评估事件影响，预估所需容量，对受影响的服务提前自动扩容，对保障线上服务的稳定性的同时提升运维效率是非常有价值的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2512dd1c65e647f09b37485be6e0cd13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739828&amp;x-signature=jyt3q1iId77DHPg6PZOcIBWgrl4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">**二、**<strong>整体方案</strong></h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddb4e9172d4540ad8cfe08abea901510~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739828&amp;x-signature=TxQGVDVFZkmQQqEWBrWSgSD5ggI%3D" alt="" loading="lazy"/></p>
<p>覆盖事件类型：</p>
<p>EXAM：准考证打印类事件（如考研、国考），一般会带来酒店的业务突增</p>
<p>HOLIDAY：旅游，出行具有很强的节假日效应，大型的节假日一般会呈现预期内的业务高峰，无突增现象</p>
<p>ACTIVITY：促销类活动，如大促、秒杀等，会带来业务突增</p>
<h3 data-id="heading-2"><strong>1.系统结构图</strong></h3>
<p>(1)流量日历平台整合业务监控，运维团队（Ops）提供应用+环境维度下CPU核数数据，平台通过接口提供给算法团队提前进行模型训练。</p>
<p>(2)流量平台确定业务预估最高峰订单值/qps值，调用算法平台发起预测任务. 算法组将业务预估高峰值转换为高峰场景下应用预计使用CPU总核数给到流量平台。</p>
<p>(3)流量平台调用Ops接口, 将CPU总核数给到Ops, Ops将CPU总核数转换成预估实例数. 并设定定时自动扩缩容实例任务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b28c2257ca143cf9d1578b27bfe3212~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739828&amp;x-signature=Jz%2FAy6bdDnkrU4InCgnKh%2BvXdLw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.业务流程介绍</h3>
<p>流量日历事件生命周期分为九个阶段，包含预判→待评估→评估中→评估完成→任务创建→扩容中→扩容完成→复盘→结束。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85800011ee52482f8c878b85dff52c4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739828&amp;x-signature=MPkO%2FjTVmk8GPDH%2BBZG0NlmzJ%2F0%3D" alt="" loading="lazy"/></p>
<p><strong>（1）热点事件录入</strong></p>
<p>事件来源：支持携程热点事件同步+人工创建事件两种方式录入 , 事件录入后，进入预判状态。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd1d5dcafe0447e6a103702d3cf016ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739828&amp;x-signature=aiDuhkG3E%2B8lKUkncnOPoS2sIC4%3D" alt="" loading="lazy"/></p>
<p><strong>（2）事件预判</strong></p>
<p>根据事件具体情况判定本次事件是否需要自动扩缩容。如判定否，进入结束状态, 如判断是，进入待评估业务量阶段 (待评估状态)。</p>
<p><strong>（3）待评估阶段</strong></p>
<p>该阶段目标是预估最高峰场景下业务量，主要根据基准值和业务涨幅两个指标计算。</p>
<p>系统根据公式计算：预估高峰业务量 = 基准值 ×（1+业务涨幅），然后进入下一阶段（评估中状态）。流量日历平台调用算法接口根据预估高峰业务量获取各应用+环境维度下实际使用CPU量预测值。</p>
<p>这里业务涨幅可参考公式计算或者直接由业务方直接提供， 公式为：</p>
<p>业务涨幅=历史涨幅×(1+自然增长率+外部影响系数 )</p>
<p><strong>指标</strong></p>
<p><strong>指标规则</strong></p>
<p>历史涨幅计算</p>
<p>人工填写历史高峰时间，系统计算历史涨幅，计算逻辑为历史当天最高值和前三天同时间均值相除计算得到</p>
<p>自然增长计算</p>
<p>业务评估，根据近期事件增长率/历史增长率提供</p>
<p>外部影响计算</p>
<p>业务评估，需要结合近期政策，以及市场情况，报考人数等等，依靠经验评估</p>
<p>基准值</p>
<p>人工填写基准时间范围，系统自动计算基准高峰值，计算逻辑为高峰期前三天同时间段峰值</p>
<p><strong>指标</strong></p>
<p><strong>内容</strong></p>
<p>热点详情</p>
<p>2024年国家公务员考试11.20打印准考证</p>
<p>影响时间</p>
<p>2023-11-20 00:00:00-2023-11-20 02:00:00</p>
<p>高峰时间点</p>
<p>2023-11-20 00:00:00</p>
<p>评估时间点</p>
<p>2023-11-18 00:00:00</p>
<p>扩容时间点</p>
<p>2023-11-19 23:00:00</p>
<p>缩容时间点</p>
<p>2023-11-20 02:00:00</p>
<p>影响范围</p>
<p>国内酒店</p>
<p>业务预估量</p>
<p>xxx</p>
<p>业务预估增长率</p>
<p>xxx</p>
<p><strong>（4）评估中&amp;评估完成</strong></p>
<p>评估中状态, 流量日历平台会根据事件基准值和业务涨幅(增长率)计算出高峰期业务值, 然后调算法接口, 预测对应高峰业务值下，各应用+环境维度使用的CPU总核数。</p>
<p>流量日历平台将算法提供预估核数，加上安全阈值后，得到平台预估核数。</p>
<p>公式：算法预估实际使用核数×(1+安全阈值)=平台预估实际使用核数</p>
<p>再调用0ps接口, Ops根据公式(平台预估实际总核数÷机器CPU阈值÷机器配置=预估实例数 ) 计算出高峰期业务预估机器数。此时评估阶段结束，进入Ops创建定时扩缩容任务阶段。</p>
<p>流量日历根据算法和Ops计算后，可以在流量日历平台查看预估具体数据，示例如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04d6e273d48047c39fc7b43aaaea9e7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739828&amp;x-signature=8ghf83ht64icrodk2vkaQrlplxM%3D" alt="" loading="lazy"/></p>
<p><strong>（5）创建任务</strong></p>
<p>Ops根据流量日历平台提供的预计扩缩容时间，和Ops计算出预估机器数创建定时扩容任务, 任务具体信息包含扩缩容时间与机器实例数。 这里扩缩容使用的资源为本地机器+云上资源两部分，通过适当的上云资源比例策略保障核心服务的稳定性。</p>
<p>目前整体的扩缩策略为保证稳定性，在高峰期前预定时间点实际智能扩容, 高峰后预定时间点自动慢速智能缩容, 定时扩缩容任务创建后,根据设定事件点进行实际自动化定时扩缩容，扩缩容执行时会有消息提示通知。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7f5b88d1da347aebcbda09073f6ff32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739828&amp;x-signature=v79QYX7xHNYXE0WA2kPz%2FFt6bNg%3D" alt="" loading="lazy"/></p>
<p><strong>（6）复盘阶段&amp;结束</strong></p>
<p>任务高峰期后，会进入复盘阶段。复盘阶段主要根据事件准确率和覆盖率两个指标来衡量预测情况。</p>
<h4 data-id="heading-4">①指标介绍</h4>
<p><strong>指标代码</strong></p>
<p><strong>含义</strong></p>
<p>a</p>
<p>人工设置增长阈值，区分实际增长和自然波动范围.</p>
<p>M</p>
<p>单应用实际高峰期总核数</p>
<p>N</p>
<p>应用前三天事件同时间段最高峰总核数均值</p>
<p>K</p>
<p>单应用预测高峰期总核数</p>
<p>如果 M &gt;N (1+a%), 表示该应用为实际增长应用。</p>
<p>如果K&gt;N (1+a%),表示该应用为预估增长应用</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ded4e1fac824e829f0e955627c11b41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739828&amp;x-signature=iN%2FXgCuiwHymfe4LD0zMwyGEhTk%3D" alt="" loading="lazy"/></p>
<p><strong>指标名称</strong></p>
<p><strong>指标计算方式</strong></p>
<p><strong>说明</strong></p>
<p>预测业务增长率</p>
<p>预测增长率 = 预测事件发生时段订单峰值/基准订单均值</p>
<p>实际业务增长率</p>
<p>实际增长率 = 实际事件发生时段订单峰值/基准订单均值</p>
<p>准确率</p>
<p>(预测增长的应用数 与 实际增长的应用数 的交集)/ 预测增长的应用数</p>
<p>满足 M &gt;N (1+a%), 表示该应用为实际增长应用.</p>
<p>满足 K&gt;N (1+a%),表示该应用为预估增长应用.</p>
<p>覆盖率</p>
<p>(预测增长的应用数 与 实际增长的应用数 的交集)/ 实际增长的应用数</p>
<h4 data-id="heading-5">②复盘数据介绍</h4>
<p>以下为复盘页面主要数据, 包含业务涨幅偏差、预估覆盖率、预估准确率。以及向下拆分可以到应用+环境维度的资源使用数据。根据复盘数据分析算法/流程可改进项，填写复盘总结，提交后事件为结束状态。</p>
<p><strong>指标</strong></p>
<p><strong>示例值</strong></p>
<p>事件预估覆盖率</p>
<p>100%</p>
<p>事件预估准确率</p>
<p>95.92%</p>
<p>预估业务量</p>
<p>xxx</p>
<p>业务线</p>
<p>xxx</p>
<p>业务量基准参照时间</p>
<p>2023-11-13 00:00:00-02:00:00</p>
<p>预估增长率</p>
<p>100%</p>
<p>基准值</p>
<p>500</p>
<p>业务预估值</p>
<p>1000</p>
<p>实际业务量</p>
<p>950</p>
<p>实际增长率</p>
<p>90%</p>
<p>安全阈值</p>
<p>5%</p>
<p>平台预估总核数</p>
<p>20000</p>
<p>实际扩容总核数</p>
<p>19500</p>
<h3 data-id="heading-6"/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce91f76a006d473c9facec0d4ffc5323~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739828&amp;x-signature=rKW%2FqFzbYvP5149jV6yrjbuyGms%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7"><strong>3. 算法部分介绍</strong></h3>
<p><strong>（1）算法模型预测准确性保障</strong></p>
<h4 data-id="heading-8">① 模型构建-应用选择</h4>
<p>在前期数据准备阶段, 由于模型算法是分析订单量和应用cpu直接的关系，需要重点关注影响(CPU)的因素, 以及应用范围的选取。</p>
<p><strong>目标</strong></p>
<p><strong>分析关键因素</strong></p>
<p>影响(CPU)的因素</p>
<p>订单量</p>
<p>QPS</p>
<p>机器型号</p>
<p>Ops运维</p>
<p>调度任务</p>
<p>哪些应用可以这么做</p>
<p>订单量和CPU资源数正相关</p>
<p>CPU资源量不微量</p>
<p>订单影响占主导</p>
<p>由于应用系统中还区分了部署环境ENV的概念，同一个应用系统下不同环境ENV承接的流量可能有差异，负责业务有差异，所以最后最小维度划分在应用+ENV维度。最终选取了订单量和CPU正相关的应用+环境作为训练范围, 对于CPU微量以及不受订单影响的不列入训练范围。</p>
<h4 data-id="heading-9">② 模型训练和指标验证</h4>
<p><strong>训练数据要求</strong></p>
<p><strong>内容</strong></p>
<p>数据范围</p>
<p>开通容器化+开通自动扩缩容的应用</p>
<p>数据期限</p>
<p>近2月</p>
<p>数据包含</p>
<p>应用、子环境、时间戳、订单量、CPU资源使用量</p>
<p>数据质量需求</p>
<p>提供的数据需要剔除脏数据</p>
<p>数据峰值</p>
<p>训练集和验证集都需要包含高峰时段</p>
<p>训练算法：使用神经网络算法进行模型训练，最终通过订单量预测CPU使用资源。</p>
<p><strong>考察指标</strong></p>
<p><strong>用途</strong></p>
<p><strong>范例</strong></p>
<p>平均绝对百分比误差MAPE</p>
<p>模型准确度</p>
<p>0.08</p>
<p>订单量与CPU使用量相关性系数</p>
<p>相关性(可行性)</p>
<p>0.91</p>
<p>实际CPU占用均值</p>
<p>资源使用体量</p>
<p>32.5</p>
<p>预测CPU占用与真实值差值的平均绝对值</p>
<p>误差实际影响</p>
<p>3.1</p>
<h4 data-id="heading-10">③模型定时更新+离线验证</h4>
<p>模型离线定时更新</p>
<ul>
<li>
<p>学习数据：高峰事件+近期数据(t-10)</p>
</li>
<li>
<p>更新策略：新模型效果不次于线上</p>
</li>
<li>
<p>保障模型时效性和事件鲁棒性</p>
</li>
<li>
<p>减少 Ops 运维带来的影响</p>
</li>
</ul>
<p>模型线上效果定时反馈</p>
<ul>
<li>
<p>模型每日反馈线上效果</p>
</li>
<li>
<p>保证线上在有效时使用</p>
</li>
<li>
<p>内部 IT 提醒 + 报警</p>
</li>
</ul>
<p><strong>（2）hpa 扩缩容安全策略</strong></p>
<p><strong>安全策略</strong></p>
<p><strong>具体内容</strong></p>
<p>最大副本数安全限制</p>
<p>目前各应用最大副本数由各业务线根据业务场景和DB/Redis等下游资源限制等因素综合配置，当预测超过最大副本数，限制创建并对应消息提示，负责人可根据情况评估调整。</p>
<p>最小副本数安全限制</p>
<p>设置阈值a%，当预测实例数小于当前最小副本数（1-a%）会触发限制。保障机器数预测过低场景稳定性。</p>
<h2 data-id="heading-11">三、项目数据&amp;价值</h2>
<p><strong>指标</strong></p>
<p><strong>内容</strong></p>
<p>业务线接入情况</p>
<p>应用接入 150+ 个 , 占比酒店应用总核数 90%+</p>
<p>未接入应用主要为流量变化不明显</p>
<p>已完成重点高峰事件保障</p>
<p>考试类，如国考 、研究生、省考等</p>
<p>节假日高峰容量保障类，如春节、五一、十一等</p>
<p>应用预估平均覆盖度</p>
<p>96%</p>
<p>应用预估平均准确率</p>
<p>89%</p>
<p>价值衡量</p>
<p>单次事件高峰期节约人工运维效率3pd（人天）/次，年化节约270pd（人天）。</p>
<p>通过算法预估机器资源，比人工预测资源节省约20%。</p>
<h2 data-id="heading-12"><strong>四、后续规划</strong></h2>
<p><strong>方向</strong></p>
<p><strong>内部</strong></p>
<p>智能扩缩容场景覆盖提升</p>
<p>1.全应用场景覆盖提升，包含实体机/KVM场景，存储层DB/Redis资源</p>
<p>2.容量扩容安全性检测提升，增加对DB、ZK等连接资源检查</p>
<p>算法优化方向提升</p>
<p>借助AI，提升业务量预估准确性，提升业务指标与应用CPU关联性</p>
<p>后续运营推广计划</p>
<p>业务线范围扩大，逐步覆盖公司各业务线，实现全司资源调度O能化</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何构建现代Agent以OpenManus为例]]></title>    <link>https://juejin.cn/post/7598021984300433435</link>    <guid>https://juejin.cn/post/7598021984300433435</guid>    <pubDate>2026-01-23T02:26:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598021984300433435" data-draft-id="7598021081988120627" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何构建现代Agent以OpenManus为例"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-23T02:26:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="moshuying"/> <meta itemprop="url" content="https://juejin.cn/user/2700056289356936"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何构建现代Agent以OpenManus为例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2700056289356936/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    moshuying
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T02:26:09.000Z" title="Fri Jan 23 2026 02:26:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、引言</h2>
<p>在人工智能快速发展的今天，Agent（智能体）已成为连接大语言模型与实际应用场景的关键桥梁。现代Agent不仅能够理解自然语言指令，更重要的是能够通过工具调用（Tool Calling）主动执行操作，完成复杂的任务。从代码编写、数据分析到网页浏览、文件操作，Agent正在重塑我们与计算机交互的方式。</p>
<p>OpenManus是一个开源的通用AI Agent框架，它展示了如何构建一个功能完整、架构清晰的现代Agent系统。本文将以OpenManus项目为蓝本，系统性地解答现代Agent构建中的四个核心问题：</p>
<ol>
<li><strong>项目结构与核心部分代码如何编写</strong></li>
<li><strong>工具是如何被添加到Agent的</strong></li>
<li><strong>Agent是如何调用这些工具的</strong></li>
<li><strong>Agent是如何思考的</strong></li>
</ol>
<p>通过深入分析OpenManus的代码实现，我们将构建对现代Agent架构的完整认知，为构建自己的Agent系统提供实践指导。</p>
<h2 data-id="heading-1">二、项目结构与核心代码架构</h2>
<h3 data-id="heading-2">2.1 分层架构设计</h3>
<p>现代Agent系统通常采用分层架构，每一层负责不同的职责。OpenManus采用了清晰的四层架构设计：</p>
<h3 data-id="heading-3">基础层（Base Layer）：<code>app/agent/base.py</code></h3>
<p><code>BaseAgent</code>是所有Agent的抽象基类，提供了Agent运行的基础设施：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseAgent</span>(BaseModel, ABC):
    name: <span class="hljs-built_in">str</span>  <span class="hljs-comment"># Agent唯一标识</span>
    description: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]  <span class="hljs-comment"># Agent描述</span>
    system_prompt: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]  <span class="hljs-comment"># 系统级指令</span>
    next_step_prompt: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]  <span class="hljs-comment"># 下一步行动提示</span>

    llm: LLM  <span class="hljs-comment"># 大语言模型实例</span>
    memory: Memory  <span class="hljs-comment"># 记忆存储</span>
    state: AgentState  <span class="hljs-comment"># 当前状态（IDLE/RUNNING/FINISHED/ERROR）</span>

    max_steps: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>  <span class="hljs-comment"># 最大执行步数</span>
    current_step: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>  <span class="hljs-comment"># 当前步数</span>

</code></pre>
<p><strong>核心功能</strong>：</p>
<ol>
<li><strong>状态管理</strong>：通过<code>state_context</code>上下文管理器实现安全的状态转换</li>
<li><strong>内存管理</strong>：<code>update_memory()</code>方法统一管理对话历史</li>
<li><strong>执行循环</strong>：<code>run()</code>方法实现主执行循环，包含步数限制和卡死检测</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, request: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-keyword">if</span> request:
        self.update_memory(<span class="hljs-string">"user"</span>, request)

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.state_context(AgentState.RUNNING):
        <span class="hljs-keyword">while</span> (self.current_step &lt; self.max_steps <span class="hljs-keyword">and</span>
               self.state != AgentState.FINISHED):
            self.current_step += <span class="hljs-number">1</span>
            step_result = <span class="hljs-keyword">await</span> self.step()  <span class="hljs-comment"># 执行单步</span>

            <span class="hljs-keyword">if</span> self.is_stuck():  <span class="hljs-comment"># 检测是否卡死</span>
                self.handle_stuck_state()

</code></pre>
<h3 data-id="heading-4">思考层（Reasoning Layer）：<code>app/agent/react.py</code></h3>
<p><code>ReActAgent</code>实现了经典的ReAct（Reasoning + Acting）模式，将Agent的执行分为思考和行动两个阶段：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ReActAgent</span>(BaseAgent, ABC):
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">think</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""处理当前状态并决定下一步行动"""</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">act</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""执行已决定的行动"""</span>

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">step</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""执行单步：思考然后行动"""</span>
        should_act = <span class="hljs-keyword">await</span> self.think()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> should_act:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Thinking complete - no action needed"</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> self.act()

</code></pre>
<p>这种设计将"决策"和"执行"解耦，使得Agent的思考过程更加清晰可控。</p>
<h3 data-id="heading-5">工具调用层（Tool Call Layer）：<code>app/agent/toolcall.py</code></h3>
<p><code>ToolCallAgent</code>在ReAct模式基础上，实现了具体的工具调用机制：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolCallAgent</span>(<span class="hljs-title class_ inherited__">ReActAgent</span>):
    available_tools: ToolCollection  <span class="hljs-comment"># 可用工具集合</span>
    tool_choices: TOOL_CHOICE_TYPE = ToolChoice.AUTO
    tool_calls: <span class="hljs-type">List</span>[ToolCall] = Field(default_factory=<span class="hljs-built_in">list</span>)

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">think</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-comment"># 调用LLM，传入工具列表</span>
        response = <span class="hljs-keyword">await</span> self.llm.ask_tool(
            messages=self.messages,
            system_msgs=[Message.system_message(self.system_prompt)],
            tools=self.available_tools.to_params(),  <span class="hljs-comment"># 工具列表</span>
            tool_choice=self.tool_choices,
        )
        <span class="hljs-comment"># 解析LLM返回的工具调用</span>
        self.tool_calls = response.tool_calls <span class="hljs-keyword">if</span> response <span class="hljs-keyword">else</span> []
        <span class="hljs-comment"># ...</span>

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">act</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-comment"># 执行工具调用</span>
        <span class="hljs-keyword">for</span> command <span class="hljs-keyword">in</span> self.tool_calls:
            result = <span class="hljs-keyword">await</span> self.execute_tool(command)
            <span class="hljs-comment"># 将结果添加到记忆</span>
            tool_msg = Message.tool_message(
                content=result,
                tool_call_id=command.<span class="hljs-built_in">id</span>,
                name=command.function.name,
            )
            self.memory.add_message(tool_msg)

</code></pre>
<h3 data-id="heading-6">应用层（Application Layer）：<code>app/agent/manus.py</code></h3>
<p><code>Manus</code>是具体的业务Agent实现，配置了实际可用的工具集合：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Manus</span>(<span class="hljs-title class_ inherited__">ToolCallAgent</span>):
    name: <span class="hljs-built_in">str</span> = <span class="hljs-string">"Manus"</span>
    system_prompt: <span class="hljs-built_in">str</span> = SYSTEM_PROMPT.<span class="hljs-built_in">format</span>(directory=config.workspace_root)

    <span class="hljs-comment"># 配置工具集合</span>
    available_tools: ToolCollection = Field(
        default_factory=<span class="hljs-keyword">lambda</span>: ToolCollection(
            PythonExecute(),      <span class="hljs-comment"># Python代码执行</span>
            BrowserUseTool(),     <span class="hljs-comment"># 浏览器操作</span>
            StrReplaceEditor(),   <span class="hljs-comment"># 文件编辑</span>
            AskHuman(),          <span class="hljs-comment"># 人工交互</span>
            Terminate(),         <span class="hljs-comment"># 终止工具</span>
        )
    )

</code></pre>
<h3 data-id="heading-7">2.2 核心代码模块</h3>
<h3 data-id="heading-8">数据模型：<code>app/schema.py</code></h3>
<p>定义了Agent系统的核心数据结构：</p>
<ul>
<li><strong>Message</strong>：消息模型，支持user、assistant、system、tool四种角色</li>
<li><strong>Memory</strong>：对话历史管理，维护完整的消息序列</li>
<li><strong>ToolCall</strong>：工具调用结构，包含工具ID、名称和参数</li>
<li><strong>AgentState</strong>：Agent状态枚举（IDLE、RUNNING、FINISHED、ERROR）</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    role: ROLE_TYPE  <span class="hljs-comment"># user/assistant/system/tool</span>
    content: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]
    tool_calls: <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>[ToolCall]]
    tool_call_id: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]  <span class="hljs-comment"># 关联工具调用结果</span>
    base64_image: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]  <span class="hljs-comment"># 支持多模态</span>

</code></pre>
<h3 data-id="heading-9">LLM封装：<code>app/llm.py</code></h3>
<p><code>LLM</code>类提供了统一的大模型接口，关键方法：</p>
<ul>
<li><strong><code>ask_tool()</code></strong>：支持function calling的调用方法，接收工具列表并返回工具调用决策</li>
<li><strong>Token计数与管理</strong>：跟踪输入输出token，防止超出限制</li>
<li><strong>消息格式化</strong>：将内部Message对象转换为LLM API格式</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">ask_tool</span>(<span class="hljs-params">
    self,
    messages: <span class="hljs-type">List</span>[<span class="hljs-type">Union</span>[<span class="hljs-built_in">dict</span>, Message]],
    system_msgs: <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>[<span class="hljs-type">Union</span>[<span class="hljs-built_in">dict</span>, Message]]] = <span class="hljs-literal">None</span>,
    tools: <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">dict</span>]] = <span class="hljs-literal">None</span>,
    tool_choice: TOOL_CHOICE_TYPE = ToolChoice.AUTO,
</span>) -&gt; ChatCompletionMessage:
    <span class="hljs-comment"># 格式化消息</span>
    messages = self.format_messages(messages, supports_images)

    <span class="hljs-comment"># 计算token并检查限制</span>
    input_tokens = self.count_message_tokens(messages)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.check_token_limit(input_tokens):
        <span class="hljs-keyword">raise</span> TokenLimitExceeded(...)

    <span class="hljs-comment"># 调用API</span>
    response = <span class="hljs-keyword">await</span> self.client.chat.completions.create(
        model=self.model,
        messages=messages,
        tools=tools,
        tool_choice=tool_choice,
    )
    <span class="hljs-keyword">return</span> response.choices[<span class="hljs-number">0</span>].message

</code></pre>
<h3 data-id="heading-10">工具系统：<code>app/tool/</code></h3>
<p>工具系统是Agent能力的核心扩展点：</p>
<ul>
<li><strong>BaseTool</strong>：所有工具的抽象基类</li>
<li><strong>ToolCollection</strong>：工具集合管理器，提供统一的工具查找和执行接口</li>
<li><strong>具体工具实现</strong>：PythonExecute、BrowserUseTool、StrReplaceEditor等</li>
</ul>
<h2 data-id="heading-11">三、工具如何被添加到Agent</h2>
<h3 data-id="heading-12">3.1 工具的定义与实现</h3>
<h3 data-id="heading-13">工具基类设计</h3>
<p>所有工具都继承自<code>BaseTool</code>，它定义了工具的标准接口：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseTool</span>(ABC, BaseModel):
    name: <span class="hljs-built_in">str</span>  <span class="hljs-comment"># 工具名称，必须唯一</span>
    description: <span class="hljs-built_in">str</span>  <span class="hljs-comment"># 工具描述，LLM据此决定是否使用</span>
    parameters: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">dict</span>]  <span class="hljs-comment"># JSON Schema格式的参数定义</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, **kwargs</span>) -&gt; <span class="hljs-type">Any</span>:
        <span class="hljs-string">"""工具执行逻辑，子类必须实现"""</span>
        <span class="hljs-keyword">pass</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">to_param</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Dict</span>:
        <span class="hljs-string">"""转换为OpenAI function calling格式"""</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>,
            <span class="hljs-string">"function"</span>: {
                <span class="hljs-string">"name"</span>: self.name,
                <span class="hljs-string">"description"</span>: self.description,
                <span class="hljs-string">"parameters"</span>: self.parameters,
            },
        }

</code></pre>
<h3 data-id="heading-14">工具实现示例</h3>
<p>以<code>PythonExecute</code>工具为例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PythonExecute</span>(<span class="hljs-title class_ inherited__">BaseTool</span>):
    name: <span class="hljs-built_in">str</span> = <span class="hljs-string">"python_execute"</span>
    description: <span class="hljs-built_in">str</span> = <span class="hljs-string">"Executes Python code string..."</span>
    parameters: <span class="hljs-built_in">dict</span> = {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
        <span class="hljs-string">"properties"</span>: {
            <span class="hljs-string">"code"</span>: {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"The Python code to execute."</span>,
            },
        },
        <span class="hljs-string">"required"</span>: [<span class="hljs-string">"code"</span>],
    }

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, code: <span class="hljs-built_in">str</span>, timeout: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>) -&gt; <span class="hljs-type">Dict</span>:
        <span class="hljs-string">"""执行Python代码"""</span>
        <span class="hljs-comment"># 使用多进程执行，支持超时控制</span>
        <span class="hljs-keyword">with</span> multiprocessing.Manager() <span class="hljs-keyword">as</span> manager:
            result = manager.<span class="hljs-built_in">dict</span>({<span class="hljs-string">"observation"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"success"</span>: <span class="hljs-literal">False</span>})
            proc = multiprocessing.Process(
                target=self._run_code, args=(code, result, safe_globals)
            )
            proc.start()
            proc.join(timeout)
            <span class="hljs-comment"># ...</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">dict</span>(result)

</code></pre>
<p>工具描述的质量直接影响LLM的选择准确性。好的描述应该：</p>
<ul>
<li>清晰说明工具的用途</li>
<li>明确参数的含义和约束</li>
<li>说明工具的使用场景和限制</li>
</ul>
<h3 data-id="heading-15">3.2 Agent中的工具配置</h3>
<h3 data-id="heading-16">静态工具配置</h3>
<p>在Agent类定义时，通过<code>Field(default_factory=...)</code>配置工具集合：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Manus</span>(<span class="hljs-title class_ inherited__">ToolCallAgent</span>):
    available_tools: ToolCollection = Field(
        default_factory=<span class="hljs-keyword">lambda</span>: ToolCollection(
            PythonExecute(),
            BrowserUseTool(),
            StrReplaceEditor(),
            AskHuman(),
            Terminate(),
        )
    )

</code></pre>
<p>这种方式适合在Agent初始化时就确定可用的工具。</p>
<h3 data-id="heading-17">动态工具添加</h3>
<p><code>ToolCollection</code>提供了动态添加工具的方法：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolCollection</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, *tools: BaseTool</span>):
        self.tools = tools
        self.tool_map = {tool.name: tool <span class="hljs-keyword">for</span> tool <span class="hljs-keyword">in</span> tools}

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_tool</span>(<span class="hljs-params">self, tool: BaseTool</span>):
        <span class="hljs-string">"""添加单个工具"""</span>
        <span class="hljs-keyword">if</span> tool.name <span class="hljs-keyword">in</span> self.tool_map:
            logger.warning(<span class="hljs-string">f"Tool <span class="hljs-subst">{tool.name}</span> already exists, skipping"</span>)
            <span class="hljs-keyword">return</span> self
        self.tools += (tool,)
        self.tool_map[tool.name] = tool
        <span class="hljs-keyword">return</span> self

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_tools</span>(<span class="hljs-params">self, *tools: BaseTool</span>):
        <span class="hljs-string">"""批量添加工具"""</span>
        <span class="hljs-keyword">for</span> tool <span class="hljs-keyword">in</span> tools:
            self.add_tool(tool)
        <span class="hljs-keyword">return</span> self

</code></pre>
<h3 data-id="heading-18">MCP工具的动态添加</h3>
<p>OpenManus支持通过MCP（Model Context Protocol）协议动态连接远程工具服务器：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Manus</span>(<span class="hljs-title class_ inherited__">ToolCallAgent</span>):
    mcp_clients: MCPClients = Field(default_factory=MCPClients)

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">connect_mcp_server</span>(<span class="hljs-params">
        self, server_url: <span class="hljs-built_in">str</span>, server_id: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>, use_stdio: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
    </span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""连接MCP服务器并添加其工具"""</span>
        <span class="hljs-keyword">if</span> use_stdio:
            <span class="hljs-keyword">await</span> self.mcp_clients.connect_stdio(server_url, [], server_id)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">await</span> self.mcp_clients.connect_sse(server_url, server_id)

        <span class="hljs-comment"># 获取新工具并添加到可用工具集合</span>
        new_tools = [
            tool <span class="hljs-keyword">for</span> tool <span class="hljs-keyword">in</span> self.mcp_clients.tools
            <span class="hljs-keyword">if</span> tool.server_id == server_id
        ]
        self.available_tools.add_tools(*new_tools)

</code></pre>
<p>MCP工具的工作流程：</p>
<ol>
<li><strong>连接服务器</strong>：通过SSE或stdio建立连接</li>
<li><strong>发现工具</strong>：调用<code>list_tools()</code>获取服务器提供的工具列表</li>
<li><strong>创建代理工具</strong>：为每个远程工具创建<code>MCPClientTool</code>代理</li>
<li><strong>添加到集合</strong>：将代理工具添加到Agent的工具集合中</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MCPClientTool</span>(<span class="hljs-title class_ inherited__">BaseTool</span>):
    <span class="hljs-string">"""MCP工具的代理，执行时调用远程服务器"""</span>
    session: <span class="hljs-type">Optional</span>[ClientSession] = <span class="hljs-literal">None</span>
    server_id: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>
    original_name: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, **kwargs</span>) -&gt; ToolResult:
        <span class="hljs-string">"""通过MCP协议调用远程工具"""</span>
        result = <span class="hljs-keyword">await</span> self.session.call_tool(self.original_name, kwargs)
        <span class="hljs-keyword">return</span> ToolResult(output=result.content)

</code></pre>
<h3 data-id="heading-19">3.3 工具Schema转换</h3>
<p>工具必须转换为LLM可理解的格式。<code>to_param()</code>方法将工具转换为OpenAI function calling格式：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">to_param</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Dict</span>:
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>,
        <span class="hljs-string">"function"</span>: {
            <span class="hljs-string">"name"</span>: self.name,
            <span class="hljs-string">"description"</span>: self.description,
            <span class="hljs-string">"parameters"</span>: self.parameters,  <span class="hljs-comment"># JSON Schema格式</span>
        },
    }

</code></pre>
<p><code>ToolCollection.to_params()</code>将所有工具转换为列表：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">to_params</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
    <span class="hljs-keyword">return</span> [tool.to_param() <span class="hljs-keyword">for</span> tool <span class="hljs-keyword">in</span> self.tools]

</code></pre>
<p>这个工具列表会被传递给LLM，LLM根据工具描述和当前上下文，决定调用哪些工具。</p>
<h2 data-id="heading-20">四、Agent如何调用这些工具</h2>
<h3 data-id="heading-21">4.1 工具调用的完整流程</h3>
<p>Agent调用工具的过程遵循ReAct模式，分为三个阶段：</p>
<h3 data-id="heading-22">Step 1: 思考阶段（think）</h3>
<p>Agent分析当前状态，决定需要调用哪些工具：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">think</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
    <span class="hljs-comment"># 1. 添加下一步提示到消息历史</span>
    <span class="hljs-keyword">if</span> self.next_step_prompt:
        user_msg = Message.user_message(self.next_step_prompt)
        self.messages += [user_msg]

    <span class="hljs-comment"># 2. 调用LLM，传入工具列表</span>
    response = <span class="hljs-keyword">await</span> self.llm.ask_tool(
        messages=self.messages,  <span class="hljs-comment"># 对话历史</span>
        system_msgs=[Message.system_message(self.system_prompt)],
        tools=self.available_tools.to_params(),  <span class="hljs-comment"># 工具列表</span>
        tool_choice=self.tool_choices,  <span class="hljs-comment"># AUTO/REQUIRED/NONE</span>
    )

    <span class="hljs-comment"># 3. 解析LLM返回的工具调用</span>
    self.tool_calls = response.tool_calls <span class="hljs-keyword">if</span> response <span class="hljs-keyword">else</span> []
    content = response.content <span class="hljs-keyword">if</span> response <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>

    <span class="hljs-comment"># 4. 创建Assistant消息并添加到记忆</span>
    assistant_msg = Message.from_tool_calls(
        content=content, tool_calls=self.tool_calls
    )
    self.memory.add_message(assistant_msg)

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bool</span>(self.tool_calls)

</code></pre>
<p>LLM接收的信息包括：</p>
<ul>
<li><strong>对话历史</strong>：用户请求、之前的工具调用和结果</li>
<li><strong>系统提示词</strong>：定义Agent的角色和能力边界</li>
<li><strong>工具列表</strong>：所有可用工具的schema</li>
<li><strong>下一步提示</strong>：指导Agent如何选择工具</li>
</ul>
<p>LLM基于这些信息，生成结构化的工具调用决策。</p>
<h3 data-id="heading-23">Step 2: 执行阶段（act）</h3>
<p>Agent执行LLM决定的工具调用：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">act</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.tool_calls:
        <span class="hljs-keyword">return</span> self.messages[-<span class="hljs-number">1</span>].content <span class="hljs-keyword">or</span> <span class="hljs-string">"No action to execute"</span>

    results = []
    <span class="hljs-keyword">for</span> command <span class="hljs-keyword">in</span> self.tool_calls:
        <span class="hljs-comment"># 执行单个工具调用</span>
        result = <span class="hljs-keyword">await</span> self.execute_tool(command)

        <span class="hljs-comment"># 将结果封装为ToolMessage</span>
        tool_msg = Message.tool_message(
            content=result,
            tool_call_id=command.<span class="hljs-built_in">id</span>,
            name=command.function.name,
        )
        self.memory.add_message(tool_msg)
        results.append(result)

    <span class="hljs-keyword">return</span> <span class="hljs-string">"\\n\\n"</span>.join(results)

</code></pre>
<h3 data-id="heading-24">Step 3: 结果反馈</h3>
<p>工具执行结果被添加到对话历史，供下一轮思考使用：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_tool</span>(<span class="hljs-params">self, command: ToolCall</span>) -&gt; <span class="hljs-built_in">str</span>:
    name = command.function.name

    <span class="hljs-comment"># 1. 查找工具实例</span>
    <span class="hljs-keyword">if</span> name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.available_tools.tool_map:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"Error: Unknown tool '<span class="hljs-subst">{name}</span>'"</span>

    <span class="hljs-comment"># 2. 解析参数</span>
    args = json.loads(command.function.arguments <span class="hljs-keyword">or</span> <span class="hljs-string">"{}"</span>)

    <span class="hljs-comment"># 3. 执行工具</span>
    result = <span class="hljs-keyword">await</span> self.available_tools.execute(name=name, tool_input=args)

    <span class="hljs-comment"># 4. 处理特殊工具（如Terminate）</span>
    <span class="hljs-keyword">await</span> self._handle_special_tool(name=name, result=result)

    <span class="hljs-comment"># 5. 格式化结果</span>
    observation = <span class="hljs-string">f"Observed output of cmd `<span class="hljs-subst">{name}</span>` executed:\\n<span class="hljs-subst">{<span class="hljs-built_in">str</span>(result)}</span>"</span>
    <span class="hljs-keyword">return</span> observation

</code></pre>
<h3 data-id="heading-25">4.2 核心代码流程</h3>
<h3 data-id="heading-26">ToolCollection.execute()：工具执行入口</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">
    self, *, name: <span class="hljs-built_in">str</span>, tool_input: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] = <span class="hljs-literal">None</span>
</span>) -&gt; ToolResult:
    <span class="hljs-comment"># 1. 根据名称查找工具</span>
    tool = self.tool_map.get(name)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> tool:
        <span class="hljs-keyword">return</span> ToolFailure(error=<span class="hljs-string">f"Tool <span class="hljs-subst">{name}</span> is invalid"</span>)

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 2. 调用工具的execute方法</span>
        result = <span class="hljs-keyword">await</span> tool(**tool_input)
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">except</span> ToolError <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> ToolFailure(error=e.message)

</code></pre>
<h3 data-id="heading-27">工具选择策略</h3>
<p><code>tool_choice</code>参数控制LLM的工具选择行为：</p>
<ul>
<li><strong>AUTO</strong>：LLM自主决定是否调用工具（默认）</li>
<li><strong>REQUIRED</strong>：必须调用至少一个工具</li>
<li><strong>NONE</strong>：不允许调用工具，只能返回文本</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> self.tool_choices == ToolChoice.REQUIRED <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> self.tool_calls:
    <span class="hljs-comment"># 要求调用工具但LLM没有返回，可能需要重试</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

<span class="hljs-keyword">if</span> self.tool_choices == ToolChoice.AUTO <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> self.tool_calls:
    <span class="hljs-comment"># 自动模式，如果没有工具调用但有文本内容，继续</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bool</span>(content)

</code></pre>
<h3 data-id="heading-28">4.3 执行循环</h3>
<p>完整的执行循环在<code>BaseAgent.run()</code>中实现：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, request: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-keyword">if</span> request:
        self.update_memory(<span class="hljs-string">"user"</span>, request)

    results: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = []
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.state_context(AgentState.RUNNING):
        <span class="hljs-keyword">while</span> (
            self.current_step &lt; self.max_steps <span class="hljs-keyword">and</span>
            self.state != AgentState.FINISHED
        ):
            self.current_step += <span class="hljs-number">1</span>

            <span class="hljs-comment"># 执行单步：think -&gt; act</span>
            step_result = <span class="hljs-keyword">await</span> self.step()

            <span class="hljs-comment"># 检测是否卡死</span>
            <span class="hljs-keyword">if</span> self.is_stuck():
                self.handle_stuck_state()

            results.append(<span class="hljs-string">f"Step <span class="hljs-subst">{self.current_step}</span>: <span class="hljs-subst">{step_result}</span>"</span>)

    <span class="hljs-keyword">return</span> <span class="hljs-string">"\\n"</span>.join(results)

</code></pre>
<p>每一步都是完整的think-act循环，直到任务完成或达到最大步数。</p>
<h2 data-id="heading-29">五、Agent是如何思考的</h2>
<h3 data-id="heading-30">5.1 ReAct模式：推理与行动循环</h3>
<p>ReAct（Reasoning + Acting）是现代Agent的核心模式，它将Agent的执行分为三个环节：</p>
<ol>
<li><strong>Reasoning（推理）</strong>：分析当前状态，理解任务，决定下一步行动</li>
<li><strong>Acting（行动）</strong>：执行选定的工具</li>
<li><strong>Observing（观察）</strong>：收集工具执行结果，更新状态</li>
</ol>
<p>这三个环节循环往复，直到任务完成。</p>
<h3 data-id="heading-31">实现机制</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">step</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
    should_act = <span class="hljs-keyword">await</span> self.think()  <span class="hljs-comment"># 思考：分析并决策</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> should_act:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Thinking complete - no action needed"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> self.act()  <span class="hljs-comment"># 行动：执行工具</span>

</code></pre>
<p>这种设计的优势：</p>
<ul>
<li><strong>可解释性</strong>：每一步的思考过程都记录在对话历史中</li>
<li><strong>可控性</strong>：可以在思考阶段进行干预和调整</li>
<li><strong>可扩展性</strong>：可以轻松添加新的思考策略</li>
</ul>
<h3 data-id="heading-32">5.2 LLM驱动的决策机制</h3>
<h3 data-id="heading-33">提示词工程</h3>
<p>Agent的思考能力主要依赖于精心设计的提示词：</p>
<p><strong>System Prompt</strong>：定义Agent的角色和能力边界</p>
<pre><code class="hljs language-python" lang="python">SYSTEM_PROMPT = (
    <span class="hljs-string">"You are OpenManus, an all-capable AI assistant, aimed at solving any task "</span>
    <span class="hljs-string">"presented by the user. You have various tools at your disposal that you can "</span>
    <span class="hljs-string">"call upon to efficiently complete complex requests. Whether it's programming, "</span>
    <span class="hljs-string">"information retrieval, file processing, web browsing, or human interaction "</span>
    <span class="hljs-string">"(only for extreme cases), you can handle it all."</span>
    <span class="hljs-string">"The initial directory is: {directory}"</span>
)

</code></pre>
<p><strong>Next Step Prompt</strong>：指导Agent如何选择工具</p>
<pre><code class="hljs language-python" lang="python">NEXT_STEP_PROMPT = <span class="hljs-string">"""
Based on user needs, proactively select the most appropriate tool or combination
of tools. For complex tasks, you can break down the problem and use different tools
step by step to solve it. After using each tool, clearly explain the execution
results and suggest the next steps.

If you want to stop the interaction at any point, use the `terminate` tool/function call.
"""</span>

</code></pre>
<p><strong>工具描述</strong>：每个工具的name、description、parameters共同构成LLM决策的依据</p>
<h3 data-id="heading-34">Function Calling机制</h3>
<p>LLM的function calling能力使得Agent能够进行结构化决策：</p>
<pre><code class="hljs language-python" lang="python">response = <span class="hljs-keyword">await</span> self.llm.ask_tool(
    messages=self.messages,  <span class="hljs-comment"># 完整的对话历史</span>
    system_msgs=[Message.system_message(self.system_prompt)],
    tools=self.available_tools.to_params(),  <span class="hljs-comment"># 工具schema列表</span>
    tool_choice=self.tool_choices,  <span class="hljs-comment"># 选择策略</span>
)

</code></pre>
<p>LLM的处理过程：</p>
<ol>
<li><strong>理解上下文</strong>：分析对话历史，理解当前任务状态</li>
<li><strong>评估工具</strong>：根据工具描述，评估哪些工具适合当前任务</li>
<li><strong>生成调用</strong>：生成结构化的工具调用，包含工具名称和参数</li>
<li><strong>参数验证</strong>：参数必须符合JSON Schema定义</li>
</ol>
<p>LLM返回的格式：</p>
<pre><code class="hljs language-python" lang="python">{
    <span class="hljs-string">"content"</span>: <span class="hljs-string">"我需要先查看文件内容，然后进行编辑"</span>,  <span class="hljs-comment"># 思考过程</span>
    <span class="hljs-string">"tool_calls"</span>: [
        {
            <span class="hljs-string">"id"</span>: <span class="hljs-string">"call_abc123"</span>,
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>,
            <span class="hljs-string">"function"</span>: {
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"str_replace_editor"</span>,
                <span class="hljs-string">"arguments"</span>: <span class="hljs-string">'{"command": "view", "path": "/path/to/file"}'</span>
            }
        }
    ]
}

</code></pre>
<h3 data-id="heading-35">5.3 状态管理与循环控制</h3>
<h3 data-id="heading-36">Agent状态机</h3>
<p>Agent的状态转换遵循明确的状态机：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentState</span>(<span class="hljs-built_in">str</span>, Enum):
    IDLE = <span class="hljs-string">"IDLE"</span>      <span class="hljs-comment"># 空闲，等待任务</span>
    RUNNING = <span class="hljs-string">"RUNNING"</span>  <span class="hljs-comment"># 执行中</span>
    FINISHED = <span class="hljs-string">"FINISHED"</span>  <span class="hljs-comment"># 任务完成</span>
    ERROR = <span class="hljs-string">"ERROR"</span>    <span class="hljs-comment"># 发生错误</span>

</code></pre>
<p>状态转换通过上下文管理器安全控制：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@asynccontextmanager</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">state_context</span>(<span class="hljs-params">self, new_state: AgentState</span>):
    previous_state = self.state
    self.state = new_state
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        self.state = AgentState.ERROR
        <span class="hljs-keyword">raise</span> e
    <span class="hljs-keyword">finally</span>:
        self.state = previous_state

</code></pre>
<h3 data-id="heading-37">执行循环控制</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">while</span> (
    self.current_step &lt; self.max_steps <span class="hljs-keyword">and</span>
    self.state != AgentState.FINISHED
):
    self.current_step += <span class="hljs-number">1</span>
    step_result = <span class="hljs-keyword">await</span> self.step()

    <span class="hljs-comment"># 卡死检测</span>
    <span class="hljs-keyword">if</span> self.is_stuck():
        self.handle_stuck_state()

</code></pre>
<p><strong>卡死检测机制</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">is_stuck</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
    <span class="hljs-string">"""检测Agent是否陷入循环"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.memory.messages) &lt; <span class="hljs-number">2</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    last_message = self.memory.messages[-<span class="hljs-number">1</span>]
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> last_message.content:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    <span class="hljs-comment"># 检查是否有重复的assistant消息</span>
    duplicate_count = <span class="hljs-built_in">sum</span>(
        <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> <span class="hljs-built_in">reversed</span>(self.memory.messages[:-<span class="hljs-number">1</span>])
        <span class="hljs-keyword">if</span> msg.role == <span class="hljs-string">"assistant"</span> <span class="hljs-keyword">and</span> msg.content == last_message.content
    )

    <span class="hljs-keyword">return</span> duplicate_count &gt;= self.duplicate_threshold

</code></pre>
<p>当检测到卡死时，Agent会添加提示词引导改变策略：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_stuck_state</span>(<span class="hljs-params">self</span>):
    stuck_prompt = (
        <span class="hljs-string">"Observed duplicate responses. Consider new strategies and avoid "</span>
        <span class="hljs-string">"repeating ineffective paths already attempted."</span>
    )
    self.next_step_prompt = <span class="hljs-string">f"<span class="hljs-subst">{stuck_prompt}</span>\\n<span class="hljs-subst">{self.next_step_prompt}</span>"</span>

</code></pre>
<h3 data-id="heading-38">特殊工具处理</h3>
<p>某些工具具有特殊语义，如<code>Terminate</code>工具会终止Agent执行：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_handle_special_tool</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, result: <span class="hljs-type">Any</span>, **kwargs</span>):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self._is_special_tool(name):
        <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">if</span> self._should_finish_execution(name=name, result=result, **kwargs):
        logger.info(<span class="hljs-string">f"Special tool '<span class="hljs-subst">{name}</span>' has completed the task!"</span>)
        self.state = AgentState.FINISHED

</code></pre>
<h3 data-id="heading-39">5.4 上下文感知与记忆管理</h3>
<h3 data-id="heading-40">Memory机制</h3>
<p><code>Memory</code>类维护完整的对话历史：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Memory</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    messages: <span class="hljs-type">List</span>[Message] = Field(default_factory=<span class="hljs-built_in">list</span>)
    max_messages: <span class="hljs-built_in">int</span> = Field(default=<span class="hljs-number">100</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_message</span>(<span class="hljs-params">self, message: Message</span>) -&gt; <span class="hljs-literal">None</span>:
        self.messages.append(message)
        <span class="hljs-comment"># 限制消息数量，保留最近的</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.messages) &gt; self.max_messages:
            self.messages = self.messages[-self.max_messages:]

</code></pre>
<p>对话历史包含完整的交互序列：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">User:</span> <span class="hljs-string">"帮我创建一个Python脚本"</span>
<span class="hljs-symbol">Assistant:</span> [思考过程] [tool_calls: python_execute]
<span class="hljs-symbol">Tool:</span> [执行结果]
<span class="hljs-symbol">Assistant:</span> [分析结果] [tool_calls: str_replace_editor]
<span class="hljs-symbol">Tool:</span> [文件创建结果]
<span class="hljs-symbol">Assistant:</span> <span class="hljs-string">"脚本已创建完成"</span>

</code></pre>
<h3 data-id="heading-41">上下文构建</h3>
<p>Agent的上下文由三部分构成：</p>
<ol>
<li><strong>系统提示词</strong>：定义Agent的能力边界和角色</li>
<li><strong>对话历史</strong>：包含用户请求、Agent思考、工具调用、工具结果</li>
<li><strong>动态提示词</strong>：根据当前状态调整（如浏览器使用时的上下文）</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">think</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
    <span class="hljs-comment"># 检查是否在使用浏览器</span>
    browser_in_use = <span class="hljs-built_in">any</span>(
        tc.function.name == BrowserUseTool().name
        <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> recent_messages
        <span class="hljs-keyword">if</span> msg.tool_calls
        <span class="hljs-keyword">for</span> tc <span class="hljs-keyword">in</span> msg.tool_calls
    )

    <span class="hljs-comment"># 如果使用浏览器，添加浏览器上下文</span>
    <span class="hljs-keyword">if</span> browser_in_use:
        self.next_step_prompt = (
            <span class="hljs-keyword">await</span> self.browser_context_helper.format_next_step_prompt()
        )

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-built_in">super</span>().think()

</code></pre>
<p>这种动态上下文调整使得Agent能够根据当前任务状态，提供更精准的决策。</p>
<h2 data-id="heading-42">六、架构图与数据流</h2>
<h3 data-id="heading-43">6.1 Agent执行流程图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start([开始]) --&gt; Init[初始化Agent]
    Init --&gt; SetState[设置状态为RUNNING]
    SetState --&gt; CheckStep{检查步数限制}
    CheckStep --&gt;|未超限| Think[think: 思考阶段]
    CheckStep --&gt;|超限| Finish[终止执行]
    Think --&gt; LLMCall[调用LLM.ask_tool]
    LLMCall --&gt; ParseTool[解析工具调用]
    ParseTool --&gt; HasTool{是否有工具调用?}
    HasTool --&gt;|是| Act[act: 执行阶段]
    HasTool --&gt;|否| CheckContent{是否有文本内容?}
    CheckContent --&gt;|是| Continue[继续循环]
    CheckContent --&gt;|否| Finish
    Act --&gt; ExecuteTool[执行工具]
    ExecuteTool --&gt; AddResult[添加结果到Memory]
    AddResult --&gt; CheckStuck{检测是否卡死?}
    CheckStuck --&gt;|是| HandleStuck[处理卡死状态]
    CheckStuck --&gt;|否| CheckFinish{任务完成?}
    HandleStuck --&gt; CheckFinish
    CheckFinish --&gt;|未完成| Continue
    CheckFinish --&gt;|完成| SetFinished[设置状态为FINISHED]
    Continue --&gt; CheckStep
    SetFinished --&gt; Finish
    Finish --&gt; End([结束])

</code></pre>
<h3 data-id="heading-44">6.2 工具调用序列图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户
    participant Agent as Agent
    participant LLM as 大语言模型
    participant Tools as 工具集合
    participant Tool as 具体工具
    participant Memory as 记忆系统

    User-&gt;&gt;Agent: 发送请求
    Agent-&gt;&gt;Memory: 添加用户消息

    loop 执行循环
        Agent-&gt;&gt;Agent: think()
        Agent-&gt;&gt;Memory: 获取对话历史
        Agent-&gt;&gt;LLM: ask_tool(历史+工具列表)
        LLM-&gt;&gt;LLM: 分析上下文
        LLM-&gt;&gt;LLM: 选择工具
        LLM--&gt;&gt;Agent: 返回工具调用决策
        Agent-&gt;&gt;Memory: 添加Assistant消息

        Agent-&gt;&gt;Agent: act()
        loop 遍历工具调用
            Agent-&gt;&gt;Tools: execute(工具名, 参数)
            Tools-&gt;&gt;Tool: 查找工具实例
            Tool-&gt;&gt;Tool: 执行工具逻辑
            Tool--&gt;&gt;Tools: 返回结果
            Tools--&gt;&gt;Agent: 返回ToolResult
            Agent-&gt;&gt;Memory: 添加Tool消息
        end

        Agent-&gt;&gt;Agent: 检查是否完成
    end

    Agent--&gt;&gt;User: 返回最终结果

</code></pre>
<h3 data-id="heading-45">6.3 类继承关系图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class BaseAgent {
        +name: str
        +memory: Memory
        +state: AgentState
        +run()
        +step()*
        +update_memory()
    }

    class ReActAgent {
        +think()*
        +act()*
        +step()
    }

    class ToolCallAgent {
        +available_tools: ToolCollection
        +tool_calls: List[ToolCall]
        +think()
        +act()
        +execute_tool()
    }

    class Manus {
        +mcp_clients: MCPClients
        +connect_mcp_server()
    }

    class BaseTool {
        &lt;&lt;abstract&gt;&gt;
        +name: str
        +description: str
        +parameters: dict
        +execute()*
        +to_param()
    }

    class ToolCollection {
        +tools: tuple
        +tool_map: dict
        +execute()
        +add_tool()
        +to_params()
    }

    class PythonExecute {
        +execute()
    }

    class BrowserUseTool {
        +execute()
    }

    BaseAgent &lt;|-- ReActAgent
    ReActAgent &lt;|-- ToolCallAgent
    ToolCallAgent &lt;|-- Manus
    BaseTool &lt;|-- PythonExecute
    BaseTool &lt;|-- BrowserUseTool
    ToolCollection o-- BaseTool
    ToolCallAgent o-- ToolCollection

</code></pre>
<h3 data-id="heading-46">6.4 数据流图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    subgraph Input[输入层]
        UserRequest[用户请求]
        SystemPrompt[系统提示词]
        ToolSchemas[工具Schema列表]
    end

    subgraph Processing[处理层]
        Memory[记忆系统]
        LLM[大语言模型]
        Agent[Agent核心]
    end

    subgraph Execution[执行层]
        ToolCollection[工具集合]
        Tool1[工具1]
        Tool2[工具2]
        ToolN[工具N]
    end

    subgraph Output[输出层]
        ToolResults[工具执行结果]
        FinalResponse[最终响应]
    end

    UserRequest --&gt; Memory
    SystemPrompt --&gt; LLM
    ToolSchemas --&gt; LLM
    Memory --&gt; LLM
    LLM --&gt; Agent
    Agent --&gt; ToolCollection
    ToolCollection --&gt; Tool1
    ToolCollection --&gt; Tool2
    ToolCollection --&gt; ToolN
    Tool1 --&gt; ToolResults
    Tool2 --&gt; ToolResults
    ToolN --&gt; ToolResults
    ToolResults --&gt; Memory
    Memory --&gt; FinalResponse

</code></pre>
<h2 data-id="heading-47">七、实践建议</h2>
<h3 data-id="heading-48">7.1 如何设计新工具</h3>
<p>设计新工具时，遵循以下原则：</p>
<ol>
<li><strong>清晰的工具描述</strong>：<code>description</code>字段应该详细说明工具的用途、使用场景和限制</li>
<li><strong>完整的参数定义</strong>：使用JSON Schema精确定义参数类型、约束和必需字段</li>
<li><strong>错误处理</strong>：工具执行应该返回<code>ToolResult</code>，包含成功结果或错误信息</li>
<li><strong>安全性考虑</strong>：对于执行代码、文件操作等敏感工具，需要添加权限检查和沙箱隔离</li>
</ol>
<p>示例：设计一个文件搜索工具</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileSearchTool</span>(<span class="hljs-title class_ inherited__">BaseTool</span>):
    name: <span class="hljs-built_in">str</span> = <span class="hljs-string">"file_search"</span>
    description: <span class="hljs-built_in">str</span> = (
        <span class="hljs-string">"Search for files in a directory tree matching a pattern. "</span>
        <span class="hljs-string">"Supports glob patterns and regex. Returns list of matching file paths."</span>
    )
    parameters: <span class="hljs-built_in">dict</span> = {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
        <span class="hljs-string">"properties"</span>: {
            <span class="hljs-string">"directory"</span>: {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"Root directory to search in (absolute path)"</span>,
            },
            <span class="hljs-string">"pattern"</span>: {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"Search pattern (glob or regex)"</span>,
            },
            <span class="hljs-string">"recursive"</span>: {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"boolean"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"Whether to search recursively"</span>,
                <span class="hljs-string">"default"</span>: <span class="hljs-literal">True</span>,
            },
        },
        <span class="hljs-string">"required"</span>: [<span class="hljs-string">"directory"</span>, <span class="hljs-string">"pattern"</span>],
    }

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">
        self, directory: <span class="hljs-built_in">str</span>, pattern: <span class="hljs-built_in">str</span>, recursive: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>
    </span>) -&gt; ToolResult:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 验证路径安全性</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Path(directory).is_absolute():
                <span class="hljs-keyword">return</span> self.fail_response(<span class="hljs-string">"Directory must be absolute path"</span>)

            <span class="hljs-comment"># 执行搜索</span>
            matches = <span class="hljs-keyword">await</span> self._search_files(directory, pattern, recursive)
            <span class="hljs-keyword">return</span> self.success_response({<span class="hljs-string">"files"</span>: matches})
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> self.fail_response(<span class="hljs-string">f"Search failed: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)

</code></pre>
<h3 data-id="heading-49">7.2 如何优化提示词</h3>
<p>提示词优化是提升Agent性能的关键：</p>
<ol>
<li><strong>系统提示词</strong>：
<ul>
<li>明确Agent的角色和能力边界</li>
<li>说明工作目录、可用资源等环境信息</li>
<li>强调安全性和最佳实践</li>
</ul>
</li>
<li><strong>下一步提示词</strong>：
<ul>
<li>指导Agent如何分解复杂任务</li>
<li>说明工具选择的原则</li>
<li>强调结果验证和错误处理</li>
</ul>
</li>
<li><strong>工具描述</strong>：
<ul>
<li>使用具体、可操作的描述</li>
<li>说明工具的限制和注意事项</li>
<li>提供使用示例（在description中）</li>
</ul>
</li>
</ol>
<p>示例：优化后的系统提示词</p>
<pre><code class="hljs language-python" lang="python">SYSTEM_PROMPT = <span class="hljs-string">"""You are OpenManus, a capable AI assistant.

Your capabilities:
- Execute Python code for data processing and analysis
- Browse the web to gather information
- Edit files using safe string replacement
- Interact with users when clarification is needed

Working directory: {directory}

Important guidelines:
- Always verify file paths before operations
- Use sandboxed execution for untrusted code
- Ask for confirmation before destructive operations
- Explain your reasoning at each step
"""</span>

</code></pre>
<h3 data-id="heading-50">7.3 如何调试Agent行为</h3>
<p>调试Agent需要系统化的方法：</p>
<ol>
<li><strong>日志记录</strong>：在关键节点添加详细日志
<ul>
<li>思考阶段的LLM输入输出</li>
<li>工具调用的参数和结果</li>
<li>状态转换和错误信息</li>
</ul>
</li>
<li><strong>记忆检查</strong>：定期检查<code>agent.memory.messages</code>，验证对话历史的正确性</li>
<li><strong>工具测试</strong>：单独测试每个工具，确保其行为符合预期</li>
<li><strong>逐步执行</strong>：使用<code>max_steps=1</code>限制，逐步观察Agent的行为</li>
</ol>
<p>示例：调试工具</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">debug_agent</span>(<span class="hljs-params">agent: ToolCallAgent, request: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""调试Agent执行过程"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Request: <span class="hljs-subst">{request}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Available tools: <span class="hljs-subst">{[t.name <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> agent.available_tools.tools]}</span>"</span>)

    <span class="hljs-comment"># 单步执行</span>
    agent.max_steps = <span class="hljs-number">1</span>
    <span class="hljs-keyword">await</span> agent.run(request)

    <span class="hljs-comment"># 检查记忆</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\\nMemory contents:"</span>)
    <span class="hljs-keyword">for</span> i, msg <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(agent.memory.messages):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{i}</span>. <span class="hljs-subst">{msg.role}</span>: <span class="hljs-subst">{msg.content[:<span class="hljs-number">100</span>]}</span>"</span>)
        <span class="hljs-keyword">if</span> msg.tool_calls:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   Tool calls: <span class="hljs-subst">{[tc.function.name <span class="hljs-keyword">for</span> tc <span class="hljs-keyword">in</span> msg.tool_calls]}</span>"</span>)

</code></pre>
<h3 data-id="heading-51">7.4 性能优化建议</h3>
<ol>
<li><strong>Token管理</strong>：
<ul>
<li>监控token使用量，避免超出限制</li>
<li>对于长对话，考虑消息摘要或滑动窗口</li>
<li>工具描述要简洁但完整</li>
</ul>
</li>
<li><strong>工具选择优化</strong>：
<ul>
<li>限制工具数量，只包含必要的工具</li>
<li>使用工具分组，根据任务类型动态加载</li>
<li>优化工具描述，提高LLM选择准确性</li>
</ul>
</li>
<li><strong>并发执行</strong>：
<ul>
<li>对于独立的工具调用，可以考虑并发执行</li>
<li>注意工具之间的依赖关系</li>
</ul>
</li>
<li><strong>缓存机制</strong>：
<ul>
<li>缓存工具执行结果（如文件读取、API调用）</li>
<li>避免重复执行相同的操作</li>
</ul>
</li>
</ol>
<p>示例：工具结果缓存</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> lru_cache
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedTool</span>(<span class="hljs-title class_ inherited__">BaseTool</span>):
    _cache: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Tuple</span>[<span class="hljs-type">Any</span>, datetime]] = {}
    _cache_ttl: timedelta = timedelta(minutes=<span class="hljs-number">5</span>)

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, **kwargs</span>) -&gt; ToolResult:
        cache_key = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">sorted</span>(kwargs.items()))

        <span class="hljs-comment"># 检查缓存</span>
        <span class="hljs-keyword">if</span> cache_key <span class="hljs-keyword">in</span> self._cache:
            result, timestamp = self._cache[cache_key]
            <span class="hljs-keyword">if</span> datetime.now() - timestamp &lt; self._cache_ttl:
                <span class="hljs-keyword">return</span> result

        <span class="hljs-comment"># 执行工具</span>
        result = <span class="hljs-keyword">await</span> self._execute_impl(**kwargs)

        <span class="hljs-comment"># 更新缓存</span>
        self._cache[cache_key] = (result, datetime.now())
        <span class="hljs-keyword">return</span> result

</code></pre>
<h2 data-id="heading-52">八、总结</h2>
<h3 data-id="heading-53">8.1 现代Agent的核心要素</h3>
<p>通过深入分析OpenManus项目，我们总结出现代Agent系统的核心要素：</p>
<ol>
<li><strong>分层架构</strong>：基础层、思考层、工具调用层、应用层的清晰分离</li>
<li><strong>ReAct模式</strong>：推理-行动-观察的循环机制</li>
<li><strong>工具系统</strong>：统一的工具接口和动态扩展能力</li>
<li><strong>LLM集成</strong>：通过function calling实现智能决策</li>
<li><strong>状态管理</strong>：完善的状态机和执行控制</li>
<li><strong>记忆系统</strong>：完整的对话历史管理</li>
</ol>
<h3 data-id="heading-54">8.2 OpenManus架构的优势</h3>
<p>OpenManus的架构设计具有以下优势：</p>
<ol>
<li><strong>可扩展性</strong>：通过BaseTool抽象，可以轻松添加新工具</li>
<li><strong>可维护性</strong>：清晰的分层结构，职责明确</li>
<li><strong>灵活性</strong>：支持静态和动态工具配置，支持MCP协议</li>
<li><strong>健壮性</strong>：完善的错误处理和状态管理</li>
<li><strong>可观测性</strong>：详细的日志和记忆系统</li>
</ol>
<h3 data-id="heading-55">8.3 未来发展方向</h3>
<p>现代Agent技术仍在快速发展，未来可能的方向包括：</p>
<ol>
<li><strong>多Agent协作</strong>：多个Agent协同完成复杂任务</li>
<li><strong>长期记忆</strong>：超越对话历史的持久化记忆</li>
<li><strong>工具学习</strong>：Agent自动发现和学习使用新工具</li>
<li><strong>安全增强</strong>：更严格的权限控制和沙箱隔离</li>
<li><strong>性能优化</strong>：更高效的token使用和并发执行</li>
</ol>
<h3 data-id="heading-56">8.4 结语</h3>
<p>构建现代Agent是一个系统工程，需要深入理解LLM能力、工具设计、系统架构等多个方面。OpenManus项目为我们提供了一个优秀的参考实现，展示了如何将理论转化为实践。</p>
<p>通过本文的系统性分析，我们希望读者能够：</p>
<ul>
<li>理解现代Agent的完整架构</li>
<li>掌握工具系统的设计和实现</li>
<li>了解Agent的思考和执行机制</li>
<li>具备构建自己Agent系统的能力</li>
</ul>
<p>现代Agent技术正在快速发展，期待更多开发者加入这个领域，共同推动AI Agent技术的进步。</p>
<hr/>
<p><strong>参考资料</strong>：</p>
<ul>
<li>OpenManus项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFoundationAgents%2FOpenManus" target="_blank" title="https://github.com/FoundationAgents/OpenManus" ref="nofollow noopener noreferrer">github.com/FoundationA…</a></li>
<li>ReAct论文：ReAct: Synergizing Reasoning and Acting in Language Models</li>
<li>OpenAI Function Calling文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Fguides%2Ffunction-calling" target="_blank" title="https://platform.openai.com/docs/guides/function-calling" ref="nofollow noopener noreferrer">platform.openai.com/docs/guides…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[听说你很熟悉 flex]]></title>    <link>https://juejin.cn/post/7598021984300367899</link>    <guid>https://juejin.cn/post/7598021984300367899</guid>    <pubDate>2026-01-23T02:20:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598021984300367899" data-draft-id="7598021081987842099" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="听说你很熟悉 flex"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2026-01-23T02:20:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Carry345"/> <meta itemprop="url" content="https://juejin.cn/user/831674360017678"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            听说你很熟悉 flex
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/831674360017678/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Carry345
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T02:20:21.000Z" title="Fri Jan 23 2026 02:20:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>听说你很熟悉 flex,看以下几种情况说一下最终渲染结果</p>
<h4 data-id="heading-0">问题一</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>:flex;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
}

<span class="hljs-selector-class">.item</span> {
  <span class="hljs-attribute">flex-grow</span>: <span class="hljs-number">1</span>;
}
<span class="hljs-selector-class">.item1</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">30px</span>;
}
<span class="hljs-selector-class">.item2</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">40px</span>;
}
</code></pre>
<h4 data-id="heading-1">问题二</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>:flex;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">150px</span>;
}

<span class="hljs-selector-class">.item</span> {
  <span class="hljs-attribute">flex-grow</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span>;
}
<span class="hljs-selector-class">.item1</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">30px</span>;
}
<span class="hljs-selector-class">.item2</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">40px</span>;
}
</code></pre>
<h4 data-id="heading-2">问题三</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>:flex;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">150px</span>;
}

<span class="hljs-selector-class">.item</span> {
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span>;
}
<span class="hljs-selector-class">.item1</span> {
  <span class="hljs-attribute">flex-grow</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">30px</span>;
}
<span class="hljs-selector-class">.item2</span> {
  <span class="hljs-attribute">flex-grow</span>: <span class="hljs-number">3</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">40px</span>;
}
</code></pre>
<h4 data-id="heading-3">问题四</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>:flex;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">280px</span>;
}

<span class="hljs-selector-class">.item</span> {
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span>;
}
<span class="hljs-selector-class">.item1</span> {
  <span class="hljs-attribute">flex-shrink</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
}
<span class="hljs-selector-class">.item2</span> {
  <span class="hljs-attribute">flex-shrink</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
}
</code></pre>
<h4 data-id="heading-4">问题一答案:</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbc50d40693f442d902d0cd5f55aafa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739621&amp;x-signature=dHtvYPdyweqzWWOAbX4RUObO81Q%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5">问题二答案:</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5814a7b52c54e56b9f05cb0f01f6054~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739621&amp;x-signature=wg5D1Re%2FeZkAdjfzJFWNPe%2Flq3o%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-6">问题三答案</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82c1ba1361f04cfb8b608cb9b9b13ad6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739621&amp;x-signature=VKNm3ZHVwVETtvaTmYEz%2BAnKs3k%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">问题四答案</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54049a7152f8460bb47093b78eea3630~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769739621&amp;x-signature=RsMRDcMsp%2FszgQ2NgcXzDArz3AY%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">tip</h4>
<ul>
<li><code>flex-grow</code> 的情况先假设全部放入，自由空间按照 <code>flex-grow</code> 的比例分</li>
<li><code>flex-shrink</code> 的情况也是先假设全部放入，还差多少？按照 <code>flex-shrink * flex-basis</code>的比例匀出来</li>
</ul>
<p>按照这个规则我们看问题三和问题四</p>
<h5 data-id="heading-9">问题三详解</h5>
<p>先假设全部放入，还多了 40px，flex-grow 分别是 <code>1</code>和<code>3</code>，即分别占<code>10px</code> <code>30px</code></p>
<ul>
<li>item1 = 30px + 10px = 40px</li>
<li>item2 = 40 + 30px = 70px</li>
</ul>
<h5 data-id="heading-10">问题四详解</h5>
<p>先假设全部放入，差了<code>40+100+200-280=60px</code>,<code>flex-shrink * flex-basis</code>的比例即<code>100:200=1:2</code>，分别匀出来<code>20px</code> <code>40px</code></p>
<ul>
<li>item1: 100px - 20px = 80px</li>
<li>item2: 200px - 40px = 160px</li>
</ul>
<p>都不是刁难的问题，平时开发中很常见，但脑子里没能获取到明确又自信的渲染结果，补缺🤌</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ThreeJS 着色器高级应用 - 孔明灯特效]]></title>    <link>https://juejin.cn/post/7598021081988137011</link>    <guid>https://juejin.cn/post/7598021081988137011</guid>    <pubDate>2026-01-23T02:27:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598021081988137011" data-draft-id="7598043378018582537" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ThreeJS 着色器高级应用 - 孔明灯特效"/> <meta itemprop="keywords" content="前端,three.js"/> <meta itemprop="datePublished" content="2026-01-23T02:27:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王校长"/> <meta itemprop="url" content="https://juejin.cn/user/2295436010076631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ThreeJS 着色器高级应用 - 孔明灯特效
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2295436010076631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王校长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T02:27:15.000Z" title="Fri Jan 23 2026 02:27:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文档涵盖Three.js中高级着色器应用，以孔明灯特效为例，展示复杂着色器的实际应用。</p>
<p>最终效果如图：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8c5545ec4b94271b6e404e9d784645b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5qCh6ZW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769740035&amp;x-signature=us8NkfvsCwS6YEcu1h6BbyFpfjM%3D" alt="Title" loading="lazy"/></p>
<h2 data-id="heading-0">1. 高级着色器应用概述</h2>
<h3 data-id="heading-1">1.1 环境贴图与光照</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"three"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/controls/OrbitControls"</span>;
<span class="hljs-keyword">import</span> gsap <span class="hljs-keyword">from</span> <span class="hljs-string">"gsap"</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> dat <span class="hljs-keyword">from</span> <span class="hljs-string">"dat.gui"</span>;
<span class="hljs-keyword">import</span> vertexShader <span class="hljs-keyword">from</span> <span class="hljs-string">"../shaders/flylight/vertex.glsl"</span>;
<span class="hljs-keyword">import</span> fragmentShader <span class="hljs-keyword">from</span> <span class="hljs-string">"../shaders/flylight/fragment.glsl"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RGBELoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/loaders/RGBELoader"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GLTFLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/loaders/GLTFLoader"</span>;

<span class="hljs-comment">// 初始化场景</span>
<span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();

<span class="hljs-comment">// 加载HDR环境贴图</span>
<span class="hljs-keyword">const</span> rgbeLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RGBELoader</span>();
rgbeLoader.<span class="hljs-title function_">loadAsync</span>(<span class="hljs-string">"./assets/2k.hdr"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">texture</span>) =&gt;</span> {
  texture.<span class="hljs-property">mapping</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">EquirectangularReflectionMapping</span>;
  scene.<span class="hljs-property">background</span> = texture;  <span class="hljs-comment">// 设置背景贴图</span>
  scene.<span class="hljs-property">environment</span> = texture;  <span class="hljs-comment">// 设置环境贴图</span>
});
</code></pre>
<h3 data-id="heading-2">1.2 渲染器高级设置</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">alpha</span>: <span class="hljs-literal">true</span> });

<span class="hljs-comment">// 启用色调映射以获得更好的视觉效果</span>
renderer.<span class="hljs-property">outputEncoding</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">sRGBEncoding</span>;
renderer.<span class="hljs-property">toneMapping</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">ACESFilmicToneMapping</span>;
renderer.<span class="hljs-property">toneMappingExposure</span> = <span class="hljs-number">0.2</span>;
</code></pre>
<h2 data-id="heading-3">2. 孔明灯模型加载与着色器应用</h2>
<h3 data-id="heading-4">2.1 GLTF模型加载</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> gltfLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GLTFLoader</span>();
<span class="hljs-keyword">let</span> <span class="hljs-title class_">LightBox</span> = <span class="hljs-literal">null</span>;

gltfLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"./assets/model/flyLight.glb"</span>, <span class="hljs-function">(<span class="hljs-params">gltf</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gltf);

  <span class="hljs-comment">// 获取孔明灯网格</span>
  <span class="hljs-title class_">LightBox</span> = gltf.<span class="hljs-property">scene</span>.<span class="hljs-property">children</span>[<span class="hljs-number">1</span>];
  
  <span class="hljs-comment">// 应用自定义着色器材质</span>
  <span class="hljs-title class_">LightBox</span>.<span class="hljs-property">material</span> = shaderMaterial;

  <span class="hljs-comment">// 批量创建孔明灯实例</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">150</span>; i++) {
    <span class="hljs-keyword">let</span> flyLight = gltf.<span class="hljs-property">scene</span>.<span class="hljs-title function_">clone</span>(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// 克隆模型</span>
    <span class="hljs-keyword">let</span> x = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">300</span>;  <span class="hljs-comment">// 随机X位置</span>
    <span class="hljs-keyword">let</span> z = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">300</span>;  <span class="hljs-comment">// 随机Z位置</span>
    <span class="hljs-keyword">let</span> y = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">60</span> + <span class="hljs-number">25</span>;      <span class="hljs-comment">// 随机Y位置</span>
    
    flyLight.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(x, y, z);
    
    <span class="hljs-comment">// 添加旋转动画</span>
    gsap.<span class="hljs-title function_">to</span>(flyLight.<span class="hljs-property">rotation</span>, {
      <span class="hljs-attr">y</span>: <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>,
      <span class="hljs-attr">duration</span>: <span class="hljs-number">10</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">30</span>,  <span class="hljs-comment">// 随机持续时间</span>
      <span class="hljs-attr">repeat</span>: -<span class="hljs-number">1</span>,                         <span class="hljs-comment">// 无限重复</span>
    });
    
    <span class="hljs-comment">// 添加位置动画</span>
    gsap.<span class="hljs-title function_">to</span>(flyLight.<span class="hljs-property">position</span>, {
      <span class="hljs-attr">x</span>: <span class="hljs-string">"+="</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">5</span>,        <span class="hljs-comment">// X方向随机移动</span>
      <span class="hljs-attr">y</span>: <span class="hljs-string">"+="</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">20</span>,       <span class="hljs-comment">// Y方向随机移动</span>
      <span class="hljs-attr">yoyo</span>: <span class="hljs-literal">true</span>,                         <span class="hljs-comment">// 往返运动</span>
      <span class="hljs-attr">duration</span>: <span class="hljs-number">5</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">10</span>,   <span class="hljs-comment">// 随机持续时间</span>
      <span class="hljs-attr">repeat</span>: -<span class="hljs-number">1</span>,                         <span class="hljs-comment">// 无限重复</span>
    });
    
    scene.<span class="hljs-title function_">add</span>(flyLight);
  }
});
</code></pre>
<h2 data-id="heading-5">3. 孔明灯顶点着色器详解</h2>
<h3 data-id="heading-6">3.1 顶点着色器代码</h3>
<pre><code class="hljs language-glsl" lang="glsl">precision lowp float;

varying vec4 vPosition;
varying vec4 gPosition;

void main(){
    vec4 modelPosition = modelMatrix * vec4( position, 1.0 );

    vPosition = modelPosition;
    gPosition = vec4( position, 1.0 );
    gl_Position =  projectionMatrix * viewMatrix * modelPosition;
}
</code></pre>
<h3 data-id="heading-7">3.2 变量传递机制</h3>
<ul>
<li><code>vPosition</code>：传递模型空间中的位置信息</li>
<li><code>gPosition</code>：传递原始几何位置信息</li>
<li>这些变量将在片元着色器中使用</li>
</ul>
<h2 data-id="heading-8">4. 孔明灯片元着色器详解</h2>
<h3 data-id="heading-9">4.1 片元着色器代码</h3>
<pre><code class="hljs language-glsl" lang="glsl">precision lowp float;
varying vec4 vPosition;
varying vec4 gPosition;

void main(){
    vec4 redColor = vec4(1,0,0,1);      // 红色
    vec4 yellowColor = vec4(1,1,0.5,1); // 黄色
    vec4 mixColor = mix(yellowColor,redColor,gPosition.y/3.0); // 基于Y坐标的颜色混合

    // 根据面朝向设置不同颜色
    if(gl_FrontFacing){
        // 正面朝向相机的像素，添加高度影响和亮度调整
        gl_FragColor = vec4(mixColor.xyz-(vPosition.y-20.0)/80.0-0.1,1);
    }else{
        // 背面像素使用基础颜色
        gl_FragColor = vec4(mixColor.xyz,1);
    }
}
</code></pre>
<h3 data-id="heading-10">4.2 颜色混合技术</h3>
<pre><code class="hljs language-glsl" lang="glsl">// 基于Y坐标的颜色插值
vec4 mixColor = mix(yellowColor,redColor,gPosition.y/3.0);
</code></pre>
<h3 data-id="heading-11">4.3 面朝向判断</h3>
<pre><code class="hljs language-glsl" lang="glsl">// 使用gl_FrontFacing区分正面和背面
if(gl_FrontFacing){
    // 正面：添加高度影响和亮度调整
    gl_FragColor = vec4(mixColor.xyz-(vPosition.y-20.0)/80.0-0.1,1);
}else{
    // 背面：使用基础颜色
    gl_FrontFacing = vec4(mixColor.xyz,1);
}
</code></pre>
<h2 data-id="heading-12">5. 自定义着色器材质创建</h2>
<h3 data-id="heading-13">5.1 着色器材质初始化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建孔明灯专用着色器材质</span>
<span class="hljs-keyword">const</span> shaderMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">ShaderMaterial</span>({
  <span class="hljs-attr">vertexShader</span>: vertexShader,      <span class="hljs-comment">// 顶点着色器</span>
  <span class="hljs-attr">fragmentShader</span>: fragmentShader,  <span class="hljs-comment">// 片元着色器</span>
  <span class="hljs-attr">uniforms</span>: {},                   <span class="hljs-comment">// uniform变量</span>
  <span class="hljs-attr">side</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">DoubleSide</span>,         <span class="hljs-comment">// 双面渲染</span>
  <span class="hljs-comment">// transparent: true,           // 透明渲染（可选）</span>
});
</code></pre>
<h2 data-id="heading-14">6. 相机控制与视角设置</h2>
<h3 data-id="heading-15">6.1 高级相机控制</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, renderer.<span class="hljs-property">domElement</span>);
controls.<span class="hljs-property">enableDamping</span> = <span class="hljs-literal">true</span>;           <span class="hljs-comment">// 启用阻尼效果</span>
controls.<span class="hljs-property">autoRotate</span> = <span class="hljs-literal">true</span>;              <span class="hljs-comment">// 自动旋转</span>
controls.<span class="hljs-property">autoRotateSpeed</span> = <span class="hljs-number">0.1</span>;          <span class="hljs-comment">// 自动旋转速度</span>
controls.<span class="hljs-property">maxPolarAngle</span> = (<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">3</span>) * <span class="hljs-number">2</span>;  <span class="hljs-comment">// 最大极角限制</span>
controls.<span class="hljs-property">minPolarAngle</span> = (<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">3</span>) * <span class="hljs-number">2</span>;  <span class="hljs-comment">// 最小极角限制</span>
</code></pre>
<h3 data-id="heading-16">6.2 相机角度限制</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 限制相機垂直旋转范围，防止过度俯仰</span>
controls.<span class="hljs-property">maxPolarAngle</span> = (<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">3</span>) * <span class="hljs-number">2</span>;
controls.<span class="hljs-property">minPolarAngle</span> = (<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">3</span>) * <span class="hljs-number">2</span>;
</code></pre>
<h2 data-id="heading-17">7. 动画系统集成</h2>
<h3 data-id="heading-18">7.1 GSAP动画控制</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 旋转动画</span>
gsap.<span class="hljs-title function_">to</span>(flyLight.<span class="hljs-property">rotation</span>, {
  <span class="hljs-attr">y</span>: <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>,                    <span class="hljs-comment">// 旋转一圈</span>
  <span class="hljs-attr">duration</span>: <span class="hljs-number">10</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">30</span>, <span class="hljs-comment">// 随机持续时间</span>
  <span class="hljs-attr">repeat</span>: -<span class="hljs-number">1</span>,                        <span class="hljs-comment">// 无限重复</span>
});

<span class="hljs-comment">// 位置动画</span>
gsap.<span class="hljs-title function_">to</span>(flyLight.<span class="hljs-property">position</span>, {
  <span class="hljs-attr">x</span>: <span class="hljs-string">"+="</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">5</span>,       <span class="hljs-comment">// X方向随机移动</span>
  <span class="hljs-attr">y</span>: <span class="hljs-string">"+="</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">20</span>,      <span class="hljs-comment">// Y方向随机移动</span>
  <span class="hljs-attr">yoyo</span>: <span class="hljs-literal">true</span>,                        <span class="hljs-comment">// 往返运动</span>
  <span class="hljs-attr">duration</span>: <span class="hljs-number">5</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">10</span>,  <span class="hljs-comment">// 随机持续时间</span>
  <span class="hljs-attr">repeat</span>: -<span class="hljs-number">1</span>,                        <span class="hljs-comment">// 无限重复</span>
});
</code></pre>
<h2 data-id="heading-19">8. 性能优化策略</h2>
<h3 data-id="heading-20">8.1 批量渲染优化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用克隆技术批量创建对象</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">150</span>; i++) {
  <span class="hljs-keyword">let</span> flyLight = gltf.<span class="hljs-property">scene</span>.<span class="hljs-title function_">clone</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-comment">// ...</span>
  scene.<span class="hljs-title function_">add</span>(flyLight);
}
</code></pre>
<h3 data-id="heading-21">8.2 减少Draw Call</h3>
<ul>
<li>使用相同的着色器材质</li>
<li>合理组织渲染批次</li>
<li>利用实例化渲染技术</li>
</ul>
<h2 data-id="heading-22">9. 着色器参数化设计</h2>
<h3 data-id="heading-23">9.1 Uniform变量扩展</h3>
<p>虽然当前示例中uniforms为空，但在实际应用中可以扩展：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> shaderMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">ShaderMaterial</span>({
  <span class="hljs-attr">vertexShader</span>: vertexShader,
  <span class="hljs-attr">fragmentShader</span>: fragmentShader,
  <span class="hljs-attr">uniforms</span>: {
    <span class="hljs-attr">uTime</span>: { <span class="hljs-attr">value</span>: <span class="hljs-number">0</span> },              <span class="hljs-comment">// 时间</span>
    <span class="hljs-attr">uBrightness</span>: { <span class="hljs-attr">value</span>: <span class="hljs-number">1.0</span> },      <span class="hljs-comment">// 亮度</span>
    <span class="hljs-attr">uColorMix</span>: { <span class="hljs-attr">value</span>: <span class="hljs-number">0.5</span> },        <span class="hljs-comment">// 颜色混合系数</span>
  },
  <span class="hljs-attr">side</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">DoubleSide</span>,
});
</code></pre>
<h2 data-id="heading-24">10. 故障排除与调试</h2>
<h3 data-id="heading-25">10.1 常见问题</h3>
<ol>
<li><strong>着色器编译错误</strong>：检查GLSL语法</li>
<li><strong>性能问题</strong>：简化着色器计算</li>
<li><strong>光照问题</strong>：检查环境贴图设置</li>
<li><strong>动画卡顿</strong>：检查动画循环和更新频率</li>
</ol>
<h3 data-id="heading-26">10.2 调试技巧</h3>
<ol>
<li><strong>逐行注释</strong>：定位问题代码</li>
<li><strong>变量输出</strong>：将中间值输出到颜色</li>
<li><strong>简化模型</strong>：使用简单几何体测试着色器</li>
</ol>
<h2 data-id="heading-27">总结</h2>
<p>本章展示了Three.js中高级着色器的实际应用，以孔明灯特效为例：</p>
<ol>
<li>环境贴图和高级渲染设置</li>
<li>GLTF模型加载和着色器应用</li>
<li>复杂顶点和片元着色器的编写</li>
<li>动画系统与着色器的集成</li>
<li>相机控制和性能优化</li>
<li>批量对象管理和渲染优化</li>
</ol>
<p>通过这种综合应用，可以创建出具有专业品质的3D视觉效果。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何优化批量图片上传？队列机制+分片处理+断点续传三连击！(附源码)]]></title>    <link>https://juejin.cn/post/7588999772750299171</link>    <guid>https://juejin.cn/post/7588999772750299171</guid>    <pubDate>2025-12-29T08:04:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588999772750299171" data-draft-id="7587336857539084297" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何优化批量图片上传？队列机制+分片处理+断点续传三连击！(附源码)"/> <meta itemprop="keywords" content="前端,Node.js"/> <meta itemprop="datePublished" content="2025-12-29T08:04:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王嗨皮"/> <meta itemprop="url" content="https://juejin.cn/user/2137106336976183"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何优化批量图片上传？队列机制+分片处理+断点续传三连击！(附源码)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2137106336976183/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王嗨皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T08:04:56.000Z" title="Mon Dec 29 2025 08:04:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    90
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>大家好，我是王嗨皮，一名<code>主业前端，副业全栈</code>的程序员，在这里我会分享关于我工作中涉及的<code>前端/全栈的常用技术</code> 如果我的文章能让您有所收获，欢迎一键三连（评论，点赞，关注），感谢！</p>
</blockquote>
<hr/>
<p>"你做过图片批量上传吗？说说你是怎么优化的。"</p>
<p>每次遇到这个面试问题，总不能尬答一句"用了XXX组件库"？大图卡带宽、多图传半天、网络一断从头来、并发一高服务器直接崩——这些坑你踩过几个？</p>
<p>这篇文章分享一下我的 Vue3 + Node.js 图片批量上传优化方案：从并发控制-&gt; 压缩-&gt; 分片-&gt; 断点续传。</p>
<p><strong>方案中使用的技术</strong>：</p>
<p>· 前端及依赖：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2F" target="_blank" title="https://vuejs.org/" ref="nofollow noopener noreferrer">vue3</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fvite.dev%2F" target="_blank" title="https://vite.dev/" ref="nofollow noopener noreferrer">vite</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Felement-plus.org%2F" target="_blank" title="https://element-plus.org/" ref="nofollow noopener noreferrer">element-plus</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Faxios-http.com%2Fdocs%2Fintro" target="_blank" title="https://axios-http.com/docs/intro" ref="nofollow noopener noreferrer">axios</a></strong></p>
<p>· 后端及依赖：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fen" target="_blank" title="https://nodejs.org/en" ref="nofollow noopener noreferrer">node</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fexpressjs.com%2F" target="_blank" title="https://expressjs.com/" ref="nofollow noopener noreferrer">express</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fexpressjs.com%2Fen%2Fresources%2Fmiddleware%2Fcors.html" target="_blank" title="https://expressjs.com/en/resources/middleware/cors.html" ref="nofollow noopener noreferrer">cors</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Ffs-extra" target="_blank" title="https://www.npmjs.com/package/fs-extra" ref="nofollow noopener noreferrer">fs-extra</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fnodemon" target="_blank" title="https://www.npmjs.com/package/nodemon" ref="nofollow noopener noreferrer">nodemon</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fmulter" target="_blank" title="https://www.npmjs.com/package/multer" ref="nofollow noopener noreferrer">multer</a></strong></p>
<p><strong>核心思路：</strong></p>
<p>1.并发控制：队列机制 + 最大并发数，避免同时上传大量文件导致服务端卡顿。</p>
<p>2.图片压缩：通过Web Worker后台压缩，不阻塞主线程。</p>
<p>3.分块上传：大文件切割成 1MB 分片，降低单次请求压力，提升效率。</p>
<p>4.断点续传：存储已上传分块编号，意外中断后从断点继续，避免重复上传。</p>
<p>5.双重验证：本地记录 + 后端校验，防止脏数据（记录存在但文件丢失）。</p>
<p>6.实时进度：每个分块上传后更新进度条。</p>
<p><strong>效果预览：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ebea7dcdea1404cbdff06ebe2b6eb33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Zeo55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769418889&amp;x-signature=3QqLxVTN8MGsM8RMGoNJMqe0YFI%3D" alt="upload.gif" loading="lazy"/></p>
<h2 data-id="heading-0">1.前端结构初始化</h2>
<p>首先使用 <code>vite</code> 创建一个 <code>vue3</code> 项目并安装依赖插件和 <code>element-plus</code> 组件库，项目结构如下：</p>
<pre><code class="hljs language-项目结构" lang="项目结构">📦upload_front
 ┣ 📂src
 ┃ ┣ 📂components
 ┃ ┃ ┗ 📜Home.vue
 ┃ ┣ 📜App.vue
 ┃ ┣ 📜main.js
 ┣ 📜index.html
 ┣ 📜package.json
 ┣ 📜vite.config.js
</code></pre>
<p>接下来，在 <code>components/Home.vue</code> 中初始化页面结构，同时定义数据和事件处理函数。<code>Home.vue </code>代码如下：</p>
<pre><code class="hljs language-Home.vue" lang="Home.vue">&lt;div&gt;
    &lt;el-upload 
      ref="uploadRef" 
      multiple
      accept="image/png,image/jpeg"
      :before-upload="beforeUpload"
      :http-request="customHttpRequest"
      :on-change="handleFileChange"
      :file-list="fileList"
      :auto-upload="false"
    &gt;
      &lt;el-button type="primary"&gt;批量上传图片&lt;/el-button&gt;
    &lt;/el-upload&gt;
    &lt;div&gt;
      &lt;el-button type="primary" @click="startUpload"&gt;开始上传&lt;/el-button&gt;
    &lt;/div&gt;
    &lt;div v-for="file in uploadStatus" :key="file.uid" style="margin-top: 15px;"&gt;
      &lt;div style="margin-bottom: 5px;"&gt;
        &lt;span&gt;{{ file.name }}&lt;/span&gt;
        &lt;span v-if="file.status === 'success'" style="color: #67c23a; margin-left: 10px;"&gt;✓ 上传成功&lt;/span&gt;
        &lt;span v-if="file.status === 'error'" style="color: #f56c6c; margin-left: 10px;"&gt;✗ 上传失败&lt;/span&gt;
      &lt;/div&gt;
      &lt;el-progress 
        :percentage="Math.floor(file.progress)" 
        :status="file.status === 'success' ? 'success' : file.status === 'error' ? 'exception' : ''"
      /&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;script setup&gt;
    import { ref, onMounted, onUnmounted } from 'vue'
    import { ElMessage } from 'element-plus'
    import request from '@/utils/request'

    ----- 定义数据 -----
    const fileList = ref([])  // 文件列表
    const uploadStatus = ref([])  // 上传状态列表
    const uploadRef = ref(null)  // 上传组件引用

    let uploadQueue = []  // 上传队列
    let currentUploads = 0  // 当前正在上传的数量
    let worker = null  // Worker实例

    // 配置参数
    const maxConcurrentUploads = 3  // 最大并发上传数
    const maxSizeInMB = 10  // 最大文件大小（MB）
    const CHUNK_SIZE = 1 * 1024 * 1024  
    
    // 事件处理函数
    const handleFileChange = () =&gt; {}
    const beforeUpload = () =&gt; {}
    const customHttpRequest = () =&gt; {}
    const startUpload = () =&gt; {}

&lt;script&gt;
</code></pre>
<p>简单解释一下比较重要的数据定义和事件处理函数：</p>
<p><strong>uploadStatus</strong>： 为状态列表，收集要上传的图片数据。</p>
<p><strong>uploadQueue</strong>： 上传队列，结合最大并发数控制上传数量。</p>
<p><strong>currentUploads</strong>： 监听正在上传的图片数量，如果小于 <code>maxConcurrentUploads</code> 则继续执行上传队列中的图片上传。</p>
<p><strong>CHUNK_SIZE</strong>：设置分块大小（MB）。</p>
<p><strong>handleFileChange</strong>：用户选择文件时触发。</p>
<p><strong>beforeUpload</strong>：用户上传前对文件的校验。</p>
<p><strong>customHttpRequest</strong>：上传时自定义的处理事件逻辑。</p>
<h2 data-id="heading-1">2.定义辅助事件处理函数</h2>
<p>前端初始化结构完成后，继续再编写两个辅助函数</p>
<p>1️⃣ <strong>getFileIdentifier</strong>: 去重判断，生成唯一的文件标识符，用于断点续传和分块管理。</p>
<pre><code class="hljs language-javasscript" lang="javasscript">
/**
 * 生成文件的唯一标识（基于原始文件信息）
 * 规则：文件名_文件大小_最后修改时间
 * 即使压缩后，也使用原始文件信息生成ID，确保不同文件ID不同
 */
const getFileIdentifier = (file) =&gt; {
  // 如果文件有原始信息（压缩后的文件），使用原始信息
  const originalFile = file._originalFile || file
  
  const safeName = originalFile.name.replace(/[^a-zA-Z0-9.-]/g, '_')
  return `${safeName}_${originalFile.size}_${originalFile.lastModified}`
}
</code></pre>
<p>2️⃣ <strong>updateUploadProgress</strong>: 更新文件的上传进度和状态，用于显示进度条。</p>
<pre><code class="hljs language-javasscript" lang="javasscript">
const updateUploadProgress = (uid, progress, status) =&gt; {
  const statusItem = uploadStatus.value.find(item =&gt; item.uid === uid)
  if (statusItem) {
    statusItem.progress = progress
    statusItem.status = status
  }
}
</code></pre>
<h2 data-id="heading-2">3.添加选中的图片至上传列表</h2>
<p>在 <code>handleFileChange</code> 事件函数中将用户上传的图片添加到 <code>uploadStatus</code> 数组中。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleFileChange</span> = (<span class="hljs-params">file, fileListData</span>) =&gt; {
  fileList.<span class="hljs-property">value</span> = fileListData
  
  <span class="hljs-comment">// 检查判断是否已经添加过这个图片，如果id相同代表该图片已存在，直接忽略</span>
  <span class="hljs-keyword">const</span> exists = uploadStatus.<span class="hljs-property">value</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">uid</span> === file.<span class="hljs-property">uid</span>)
  <span class="hljs-keyword">if</span> (!exists) {
    uploadStatus.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">uid</span>: file.<span class="hljs-property">uid</span>, <span class="hljs-comment">// 图片ID</span>
      <span class="hljs-attr">name</span>: file.<span class="hljs-property">name</span>, 图片名称
      <span class="hljs-attr">progress</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 上传进度，初始化为0</span>
      <span class="hljs-attr">status</span>: <span class="hljs-string">'pending'</span> <span class="hljs-comment">// 上传状态，默认值为pending</span>
    })
  }
}
</code></pre>
<p>注意：在图片上传到数组之前，添加一个判断，如果该图片已存在则直接忽略，避免相同图片重复上传。</p>
<h2 data-id="heading-3">4.创建Web Worker独立线程压缩图片</h2>
<p>在项目根目录下新建 <code>utils</code> 文件夹，然后创建一个 <code>imageWorker.js</code> 文件，代码如下：</p>
<pre><code class="hljs language-imageWorkder.js" lang="imageWorkder.js">// imageWorker.js - 使用现代 Web Worker API
self.onmessage = async function (e) {
  const { file, quality, targetFormat, taskId } = e.data;

  try {
    const compressedFile = await compressImage(file, quality, targetFormat);
    // 返回时带上 taskId，确保消息对应正确
    self.postMessage({ 
      success: true, 
      file: compressedFile,
      taskId: taskId  // 关键：返回任务ID
    })
  } catch (error) {
    self.postMessage({ 
      success: false, 
      error: error.message,
      taskId: taskId
    })
  }
}

const compressImage = async (file, quality, format) =&gt; {
  // 使用 createImageBitmap 替代 new Image()
  const imageBitmap = await createImageBitmap(file)
  
  // 使用 OffscreenCanvas 替代 document.createElement('canvas')
  const canvas = new OffscreenCanvas(imageBitmap.width, imageBitmap.height)
  const ctx = canvas.getContext('2d')
  
  // 绘制图片到离屏画布
  ctx.drawImage(imageBitmap, 0, 0)
  
  // 转换为 Blob，支持格式转换和质量压缩
  const blob = await canvas.convertToBlob({
    type: `image/${format}`,
    quality: quality
  })
  
  // 将 Blob 转换为 File
  const compressedFile = new File([blob], file.name, {
    type: `image/${format}`,
    lastModified: Date.now(),
  });
  
  // 释放 ImageBitmap 资源
  imageBitmap.close();
  return compressedFile;
}

</code></pre>
<p><code>imageWorker.js</code> 利用 <code>Web Worker</code> 独立线程压缩上传图片，避免阻塞主线程，确保图片压缩期间页面流畅不卡顿。</p>
<p>需要注意的是：Web Worker中不要使用 <code>new Image</code> 或者 <code>document.createElement</code>这种API，要更换为 <code>createImageBitmap</code> 和 <code>OffscreenCanvas</code></p>
<p>更多具体的操作，可以查询 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWeb_Workers_API%2FFunctions_and_classes_available_to_workers" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Functions_and_classes_available_to_workers" ref="nofollow noopener noreferrer">Web Workers 可以使用的函数和类</a> 文档。</p>
<p>完成 <code>imageWorker.js</code>后，将其导入页面中，并在 <code>onMounted</code> 初始化，在 <code>onUnMounted</code> 组件卸载时销毁 Worker 释放内存。</p>
<pre><code class="hljs language-Home.vue" lang="Home.vue">......
import { ref, onMounted, onUnmounted } from 'vue'
let worker = null

//组件挂载时初始化Worker
onMounted(() =&gt; {
  worker = new Worker(new URL('@/utils/imageWorker.js', import.meta.url))
  console.log('Worker 已初始化')
})

//组件卸载时清理Wokker
onUnmounted(() =&gt; {
  if (worker) {
    worker.terminate()
    worker = null
    console.log('Worker 已清理')
  }
})
</code></pre>
<h2 data-id="heading-4">5.检查文件大小并压缩</h2>
<p>接下来在 <code>beforeUpload</code> 事件处理函数中，校验上传图片大小并异步调用 <code>Workder</code> 实现图片压缩。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">beforeUpload</span> = (<span class="hljs-params">file</span>) =&gt; {
  <span class="hljs-comment">// 检查文件大小</span>
  <span class="hljs-keyword">const</span> isUnderLimit = file.<span class="hljs-property">size</span> / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> &lt; maxSizeInMB
  <span class="hljs-keyword">if</span> (!isUnderLimit) {
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`文件大小不能超过<span class="hljs-subst">${maxSizeInMB}</span>MB`</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }

  <span class="hljs-comment">// 所有图片都使用 Worker 压缩（无论大小）</span>
  <span class="hljs-keyword">if</span> (worker) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-comment">// 生成唯一任务ID，避免多个文件同时压缩时混乱</span>
      <span class="hljs-keyword">const</span> taskId = <span class="hljs-string">`<span class="hljs-subst">${file.name}</span>_<span class="hljs-subst">${file.size}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random()}</span>`</span>
      
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMessage</span> = (<span class="hljs-params">event</span>) =&gt; {
        <span class="hljs-comment">// 检查是否是当前任务的响应</span>
        <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span>.<span class="hljs-property">taskId</span> === taskId) {
          worker.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'message'</span>, handleMessage)
          worker.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'error'</span>, handleError)
          
          <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span>.<span class="hljs-property">success</span>) {
            <span class="hljs-comment">// 压缩后的文件</span>
            <span class="hljs-keyword">const</span> compressedFile = event.<span class="hljs-property">data</span>.<span class="hljs-property">file</span>
            
            <span class="hljs-comment">// 关键：给压缩后的文件添加原始文件信息</span>
            <span class="hljs-comment">// 这样可以确保文件ID的唯一性和一致性</span>
            compressedFile.<span class="hljs-property">_originalFile</span> = {
              <span class="hljs-attr">name</span>: file.<span class="hljs-property">name</span>,
              <span class="hljs-attr">size</span>: file.<span class="hljs-property">size</span>,
              <span class="hljs-attr">lastModified</span>: file.<span class="hljs-property">lastModified</span>
            }
            
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${file.name}</span>] 压缩完成: <span class="hljs-subst">${file.size}</span> -&gt; <span class="hljs-subst">${compressedFile.size}</span> 字节`</span>)
            <span class="hljs-title function_">resolve</span>(compressedFile)
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${file.name}</span>] 压缩失败:`</span>, event.<span class="hljs-property">data</span>.<span class="hljs-property">error</span>)
            <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(event.<span class="hljs-property">data</span>.<span class="hljs-property">error</span>))
          }
        }
      }
      
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleError</span> = (<span class="hljs-params">error</span>) =&gt; {
        worker.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'message'</span>, handleMessage)
        worker.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'error'</span>, handleError)
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${file.name}</span>] Worker 错误:`</span>, error)
        <span class="hljs-title function_">reject</span>(error)
      }
      
      worker.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, handleMessage)
      worker.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, handleError)
      
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${file.name}</span>] 开始压缩... (任务ID: <span class="hljs-subst">${taskId}</span>)`</span>)
      worker.<span class="hljs-title function_">postMessage</span>({ 
        file, 
        <span class="hljs-attr">quality</span>: <span class="hljs-number">0.8</span>,           <span class="hljs-comment">// 压缩质量 0.8</span>
        <span class="hljs-attr">targetFormat</span>: <span class="hljs-string">'jpeg'</span>,   <span class="hljs-comment">// 目标格式 JPEG</span>
        taskId                  <span class="hljs-comment">// 传递任务ID</span>
      })
   })

   <span class="hljs-comment">// 如果 Worker 未初始化，直接通过</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${file.name}</span>] Worker 未初始化，不压缩`</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}
</code></pre>
<p>简述一下几个关键点：</p>
<p>1️⃣ Promise + taskId 异步压缩，通过 taskId 匹配，并发压缩时区分文件，防止返回结果混乱。</p>
<p>2️⃣ 在压缩后的文件上附加 <code>_originalFile</code>，确保后续生成的 fileId 基于原始文件，保证后续实现断点续传时的一致性。</p>
<h2 data-id="heading-5">6.队列控制同时上传并发数</h2>
<p>继续定义一个处理上传队列的事件函数，并在上传自定义事件 <code>customHttpRequest</code> 进行调用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">customHttpRequest</span> = (<span class="hljs-params">options</span>) =&gt; {
  <span class="hljs-keyword">const</span> { file, onProgress, onError, onSuccess } = options
  
  <span class="hljs-comment">// 将文件和回调函数包装到队列中</span>
  uploadQueue.<span class="hljs-title function_">push</span>({
    file,
    onProgress,
    onError,
    onSuccess,
    <span class="hljs-attr">uid</span>: file.<span class="hljs-property">uid</span>
  })
  
  <span class="hljs-comment">// 开始处理队列</span>
  <span class="hljs-title function_">processQueue</span>()
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">processQueue</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">while</span> (currentUploads &lt; maxConcurrentUploads &amp;&amp; uploadQueue.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> nextFile = uploadQueue.<span class="hljs-title function_">shift</span>()
    <span class="hljs-keyword">if</span> (nextFile) {
      ......
    }
  }
}
</code></pre>
<p><code>processQueue</code> 的作用控制最大上传并发数，如果当前上传数量小于最大并发数，则从待上传队列中取出下一个文件，填满并发数。在保证上传效率的同时尽量避免服务器压力过大。</p>
<h2 data-id="heading-6">7.分块上传并支持断点续传</h2>
<p>我们再来定义一个事件处理函数，将上传的文件拆分成多个分块。</p>
<p>从而实现分块上传 + 断点续传 + 失败重试 + 文件合并的完整流程。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">uploadFileWithChunks</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">fileData</span>) =&gt; {
  currentUploads++
  <span class="hljs-keyword">const</span> file = fileData.<span class="hljs-property">file</span>
  
  <span class="hljs-comment">// 获取文件名（可能是压缩后的文件，需要用原始文件名）</span>
  <span class="hljs-keyword">const</span> fileName = file.<span class="hljs-property">_originalFile</span> ? file.<span class="hljs-property">_originalFile</span>.<span class="hljs-property">name</span> : file.<span class="hljs-property">name</span>
  
  <span class="hljs-comment">// 生成文件ID（使用原始文件信息）</span>
  <span class="hljs-keyword">const</span> fileId = <span class="hljs-title function_">getFileIdentifier</span>(file)
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 计算总分块数</span>
    <span class="hljs-keyword">const</span> totalChunks = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(file.<span class="hljs-property">size</span> / <span class="hljs-variable constant_">CHUNK_SIZE</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${fileName}</span>] 总共 <span class="hljs-subst">${totalChunks}</span> 块，每块 1MB`</span>)
    
    <span class="hljs-comment">// 从 localStorage 读取已上传的分块（断点续传）</span>
    <span class="hljs-keyword">const</span> progressKey = <span class="hljs-string">`upload_<span class="hljs-subst">${fileId}</span>`</span>
    <span class="hljs-keyword">let</span> uploadedChunks = []
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> saved = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(progressKey)
      <span class="hljs-keyword">if</span> (saved) {
        uploadedChunks = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(saved).<span class="hljs-property">chunks</span> || []
      }
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${fileName}</span>] 无断点记录，从头开始`</span>)
    }
    
    <span class="hljs-comment">// 检查是否所有分块都已上传（文件已完成）</span>
    <span class="hljs-keyword">if</span> (uploadedChunks.<span class="hljs-property">length</span> === totalChunks) {
     
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 第二重验证：调用后端接口确认文件是否真实存在</span>
        <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/merge-chunks'</span>, {
          <span class="hljs-attr">filename</span>: fileName,
          <span class="hljs-attr">fileId</span>: fileId,
          totalChunks
        })  
      
        <span class="hljs-comment">// 文件确实存在，跳过重复上传</span>
        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(progressKey)
        currentUploads--
        <span class="hljs-title function_">processQueue</span>()
        fileData.<span class="hljs-title function_">onSuccess</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> })
        <span class="hljs-title function_">updateUploadProgress</span>(fileData.<span class="hljs-property">uid</span>, <span class="hljs-number">100</span>, <span class="hljs-string">'success'</span>)
        <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">`<span class="hljs-subst">${fileName}</span> 已上传（跳过重复上传）`</span>)
        <span class="hljs-keyword">return</span>
        
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// 合并失败，可能文件已被删除，清理记录重新上传</span>
        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(progressKey)
        uploadedChunks = []  <span class="hljs-comment">// 清空已上传记录，重新开始</span>
      }
    }
    
    <span class="hljs-comment">// 逐个上传分块</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; totalChunks; i++) {
      <span class="hljs-comment">// 跳过已上传的分块</span>
      <span class="hljs-keyword">if</span> (uploadedChunks.<span class="hljs-title function_">includes</span>(i)) {
        <span class="hljs-keyword">const</span> progress = ((i + <span class="hljs-number">1</span>) / totalChunks) * <span class="hljs-number">100</span>
        <span class="hljs-title function_">updateUploadProgress</span>(fileData.<span class="hljs-property">uid</span>, progress, <span class="hljs-string">'uploading'</span>)
        <span class="hljs-keyword">continue</span>
      }
      
      <span class="hljs-comment">// 切割分块</span>
      <span class="hljs-keyword">const</span> start = i * <span class="hljs-variable constant_">CHUNK_SIZE</span>
      <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(start + <span class="hljs-variable constant_">CHUNK_SIZE</span>, file.<span class="hljs-property">size</span>)
      <span class="hljs-keyword">const</span> chunk = file.<span class="hljs-title function_">slice</span>(start, end)
      
      <span class="hljs-comment">// 准备上传数据</span>
      <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>()
      formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'chunk'</span>, chunk)
      formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'filename'</span>, fileName)  <span class="hljs-comment">// 使用原始文件名</span>
      formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'fileId'</span>, fileId)
      formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'chunkNumber'</span>, i)
      formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'totalChunks'</span>, totalChunks)
      
      <span class="hljs-comment">// 上传分块（重试3次）</span>
      <span class="hljs-keyword">let</span> success = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> retry = <span class="hljs-number">0</span>; retry &lt; <span class="hljs-number">3</span> &amp;&amp; !success; retry++) {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/upload-chunk'</span>, formData, {
            <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'multipart/form-data'</span> }
          })
          success = <span class="hljs-literal">true</span>
          <span class="hljs-comment">// 记录到 localStorage（用于断点续传）</span>
          uploadedChunks.<span class="hljs-title function_">push</span>(i)
          <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(progressKey, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">chunks</span>: uploadedChunks }))
          
          <span class="hljs-comment">// 更新进度条</span>
          <span class="hljs-keyword">const</span> progress = ((i + <span class="hljs-number">1</span>) / totalChunks) * <span class="hljs-number">100</span>
          <span class="hljs-title function_">updateUploadProgress</span>(fileData.<span class="hljs-property">uid</span>, progress, <span class="hljs-string">'uploading'</span>)
          fileData.<span class="hljs-title function_">onProgress</span>({ <span class="hljs-attr">percent</span>: progress })
          
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-keyword">if</span> (retry &lt; <span class="hljs-number">2</span>) {
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span>))
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`分块 <span class="hljs-subst">${i}</span> 上传失败`</span>)
          }
        }
      }
    }
    
    <span class="hljs-comment">// 🎯 所有分块上传完成后，立即清理 localStorage</span>
    <span class="hljs-comment">// 这样可以避免：上传完成 → 刷新页面 → localStorage残留 → 重复上传</span>
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(progressKey)
    
    <span class="hljs-comment">// 合并文件</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${fileName}</span>] 开始合并...`</span>)
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> mergeResult = <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/merge-chunks'</span>, {
        <span class="hljs-attr">filename</span>: fileName,  <span class="hljs-comment">// 使用原始文件名</span>
        <span class="hljs-attr">fileId</span>: fileId,
        totalChunks
      })
      
      <span class="hljs-comment">// 检查是否是跳过重复上传</span>
      <span class="hljs-keyword">if</span> (mergeResult.<span class="hljs-property">message</span> &amp;&amp; mergeResult.<span class="hljs-property">message</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'跳过重复'</span>)) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${fileName}</span>] ⚠️ 后端检测到重复上传，已跳过`</span>)
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${fileName}</span>] ✓ 合并完成`</span>)
      }
      
      currentUploads--
      <span class="hljs-title function_">processQueue</span>()
      fileData.<span class="hljs-title function_">onSuccess</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> })
      <span class="hljs-title function_">updateUploadProgress</span>(fileData.<span class="hljs-property">uid</span>, <span class="hljs-number">100</span>, <span class="hljs-string">'success'</span>)
      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">`<span class="hljs-subst">${fileName}</span> 上传成功`</span>)
      
    } <span class="hljs-keyword">catch</span> (mergeError) {
      <span class="hljs-comment">// 合并失败的特殊处理</span>
      <span class="hljs-keyword">const</span> errorMsg = mergeError.<span class="hljs-property">message</span> || <span class="hljs-string">''</span>
      
      <span class="hljs-comment">// 如果是"分块目录不存在"，可能是临时文件被清理了</span>
      <span class="hljs-comment">// 但所有分块已上传，视为成功（容错处理）</span>
      <span class="hljs-keyword">if</span> (errorMsg.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'分块目录不存在'</span>) || errorMsg.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'不存在'</span>)) {
        currentUploads--
        <span class="hljs-title function_">processQueue</span>()
        fileData.<span class="hljs-title function_">onSuccess</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> })
        <span class="hljs-title function_">updateUploadProgress</span>(fileData.<span class="hljs-property">uid</span>, <span class="hljs-number">100</span>, <span class="hljs-string">'success'</span>)
        <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">`<span class="hljs-subst">${fileName}</span> 上传成功`</span>)
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 其他合并错误，正常抛出</span>
        <span class="hljs-keyword">throw</span> mergeError
      }
    }
    
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${fileName}</span>] ✗ 上传失败:`</span>, error.<span class="hljs-property">message</span>)
    currentUploads--
    <span class="hljs-title function_">processQueue</span>()
    fileData.<span class="hljs-title function_">onError</span>(error)
    <span class="hljs-title function_">updateUploadProgress</span>(fileData.<span class="hljs-property">uid</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'error'</span>)
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${fileName}</span> 上传失败`</span>)
  }
}
</code></pre>
<p>关键技术节点：</p>
<p>1️⃣ 双重验证：<code>localstroage</code> 本地记录 + 后端 <code>merge-chunks</code> 接口验证，防止"脏数据"的产生。</p>
<p>2️⃣ 断点续传：<code>localStorage.setItem(progressKey, JSON.stringify({ chunks: uploadedChunks }))</code>,每上传一个分块保存编号，等下次断点续传时方便精准对应编号，跳过重复模块以节省资源。</p>
<p>3️⃣ 失败重试：<code>for</code> 循环重试3次，提高上传成功率。</p>
<p>最后，给 "开始上传" 按钮绑定 <code>startUpload</code>点击事件，触发 <code>&lt;el-upload&gt;</code> 上传程序。</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">const</span> <span class="hljs-title function_">startUpload</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (uploadRef.<span class="hljs-property">value</span>) {
    uploadRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">submit</span>()
  }
}
</code></pre>
<h2 data-id="heading-7">8.Node.js后端代码</h2>
<p>受限于篇幅过长的原因，后端代码不再做详细阐述，主要逻辑已在源码中标记注释。</p>
<p>也可点击查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faosang%2Fnode_upload" target="_blank" title="https://github.com/aosang/node_upload" ref="nofollow noopener noreferrer">前后端完整源码</a></p>
<pre><code class="hljs language-Node.js" lang="Node.js">import express from 'express'
import cors from 'cors'
import path from 'path'
import fs from 'fs-extra'
import multer from 'multer'
import { fileURLToPath } from 'url'
import { dirname } from 'path'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

const app = express()
app.use(cors())

const upload_dir = path.resolve(__dirname, 'uploads')
fs.ensureDirSync(upload_dir)

// 配置静态文件访问，使 /uploads 路径可以访问到 uploads 文件夹
app.use('/uploads', express.static(upload_dir))

// 配置 multer 存储
const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    cb(null, upload_dir)
  },
  filename: function (req, file, cb) {
    const ext = path.extname(file.originalname)
    const basename = path.basename(file.originalname, ext)
    cb(null, `${basename}-${Date.now()}${ext}`)
  }
})

const upload = multer({ storage: storage })

app.use(express.json())

// 分块上传临时目录
const temp_dir = path.resolve(__dirname, 'temp_chunks')
fs.ensureDirSync(temp_dir)

// 已完成上传的标记目录（避免重复上传）
// 注意：放在 temp_chunks 外部，避免被清理
const completed_dir = path.resolve(__dirname, 'upload_completed')
fs.ensureDirSync(completed_dir)
console.log(`完成标记目录: ${completed_dir}`)

// 上传单个分块（简化版）
app.post('/upload-chunk', upload.single('chunk'), (req, res) =&gt; {
  try {
    const { filename, fileId, chunkNumber, totalChunks } = req.body
    
    if (!req.file) {
      return res.status(400).json({
        success: false,
        message: '未接收到分块文件'
      })
    }
    
    // 使用 fileId 创建分块目录
    const chunkDir = path.resolve(temp_dir, fileId)
    fs.ensureDirSync(chunkDir)
    
    // 保存分块文件
    const chunkPath = path.resolve(chunkDir, `chunk-${chunkNumber}`)
    fs.moveSync(req.file.path, chunkPath, { overwrite: true })
    
    console.log(`已接收: ${filename} 分块 ${chunkNumber}/${totalChunks}`)
    
    res.json({
      success: true,
      message: `分块 ${chunkNumber} 上传成功`
    })
  } catch (error) {
    console.error(`分块上传失败: ${error.message}`)
    res.status(500).json({
      success: false,
      message: '分块上传失败',
      error: error.message
    })
  }
})

// 合并分块（简化版）
app.post('/merge-chunks', async (req, res) =&gt; {
  try {
    const { filename, fileId, totalChunks } = req.body
    const chunkDir = path.resolve(temp_dir, fileId)
    const completedFlag = path.resolve(completed_dir, fileId)
    
    console.log(`开始合并: ${filename} (共 ${totalChunks} 块)`)
    console.log(`分块目录: ${chunkDir}`)
    console.log(`完成标记: ${completedFlag}`)
    
    // 🎯 优先检查：该文件是否已经完成过（避免重复上传）
    if (fs.existsSync(completedFlag)) {
      try {
        const savedFilename = await fs.readFile(completedFlag, 'utf-8')
        const actualFilePath = path.resolve(upload_dir, savedFilename)
        
        // 🔍 关键检查：验证实际文件是否真实存在
        if (fs.existsSync(actualFilePath)) {
          console.log(`✓ 文件 ${filename} 已存在，跳过重复上传`)
          console.log(`  实际文件: ${savedFilename}`)
          return res.json({
            success: true,
            message: '文件已上传（跳过重复）',
            filename: savedFilename
          })
        } else {
          // ⚠️ 标记文件存在，但实际文件不存在（可能被删除）
          console.log(`⚠️ 标记存在但文件不存在: ${savedFilename}`)
          console.log(`  删除无效标记，重新上传`)
          await fs.remove(completedFlag)
          // 继续执行后续的合并流程
        }
      } catch (readError) {
        console.error(`读取完成标记失败: ${readError.message}`)
        // 如果读取失败，删除损坏的标记文件，继续合并流程
        await fs.remove(completedFlag)
      }
    }
    
    // 检查分块目录是否存在
    if (!fs.existsSync(chunkDir)) {
      console.log(`❌ 分块目录不存在: ${fileId}`)
      return res.status(400).json({
        success: false,
        message: '分块目录不存在，请重新上传'
      })
    }
    
    // 生成最终文件名
    const ext = path.extname(filename)
    const basename = path.basename(filename, ext)
    const finalFileName = `${basename}-${Date.now()}${ext}`
    const finalFilePath = path.resolve(upload_dir, finalFileName)
    
    // 创建写入流，按顺序合并分块
    const writeStream = fs.createWriteStream(finalFilePath)
    
    for (let i = 0; i &lt; totalChunks; i++) {
      const chunkPath = path.resolve(chunkDir, `chunk-${i}`)
      
      // 检查分块是否存在
      if (!fs.existsSync(chunkPath)) {
        writeStream.close()
        return res.status(400).json({
          success: false,
          message: `分块 ${i} 不存在，请重新上传`
        })
      }
      
      // 读取并写入分块
      const chunkBuffer = await fs.readFile(chunkPath)
      writeStream.write(chunkBuffer)
    }
    
    writeStream.end()
    
    // 等待写入完成
    await new Promise((resolve, reject) =&gt; {
      writeStream.on('finish', resolve)
      writeStream.on('error', reject)
    })
    
    // 删除临时分块目录
    await fs.remove(chunkDir)
    
    // 🎯 创建完成标记（保存最终文件名，避免重复上传）
    try {
      // 确保 .completed 目录存在
      await fs.ensureDir(completed_dir)
      await fs.writeFile(completedFlag, finalFileName, 'utf-8')
      console.log(`✓ 创建完成标记: ${fileId}`)
    } catch (flagError) {
      // 标记创建失败不影响主流程，仅记录日志
      console.error(`⚠️ 创建完成标记失败: ${flagError.message}`)
    }
    
    console.log(`合并成功: ${finalFileName}`)
    
    res.json({
      success: true,
      message: '文件上传成功',
      filename: finalFileName
    })
  } catch (error) {
    console.error(`文件合并失败: ${error.message}`)
    res.status(500).json({
      success: false,
      message: '文件合并失败',
      error: error.message
    })
  }
})

// 上传图片文件接口（保留原有接口）
app.post('/upload', upload.single('file'), (req, res) =&gt; {
  if (!req.file) {
    return res.status(400).json({
      success: false,
      message: 'No file uploaded'
    })
  }
  res.json({
    success: true,
    message: 'File uploaded successfully',
    filePath: req.file.path,
    filename: req.file.filename
  })
})

app.listen(3000, () =&gt; {
  console.log('Server is running on port 3000')
})
</code></pre>
<p>如果我的文章能让您有所收获，欢迎一键三连（评论，点赞，关注），感谢！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Mongoose操作MongoDB数据库（2）：实现增、删、改、查基础操作]]></title>    <link>https://juejin.cn/post/7585085798809436187</link>    <guid>https://juejin.cn/post/7585085798809436187</guid>    <pubDate>2025-12-19T03:47:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585085798809436187" data-draft-id="7584722109583786027" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Mongoose操作MongoDB数据库（2）：实现增、删、改、查基础操作"/> <meta itemprop="keywords" content="Mongoose"/> <meta itemprop="datePublished" content="2025-12-19T03:47:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王嗨皮"/> <meta itemprop="url" content="https://juejin.cn/user/2137106336976183"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Mongoose操作MongoDB数据库（2）：实现增、删、改、查基础操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2137106336976183/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王嗨皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T03:47:01.000Z" title="Fri Dec 19 2025 03:47:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    52
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是王嗨皮，一名<code>主业前端，副业全栈</code>的程序员，在这里我会分享关于<code>前端进阶全栈的常用技术</code> 和 <code>基本入门操作</code>。 如果我的文章能让您有所收获，欢迎一键三连（评论，点赞，关注）。</p>
<hr/>
<p>本节内容，我们通过 <code>mongoose</code> 定义好数据模型，并实现对数据库<strong>增、删、改、查</strong>基本的操作。</p>
<h3 data-id="heading-0">定义数据模型</h3>
<p>在项目根录下创建两个文件夹，分别命名为 <code>modal</code> 和 <code>router</code>，</p>
<p>其中 <code>modal</code> 文件夹下新建 <code>modal.js</code> 文件用来定义数据模型，<code>router</code> 文件夹下新建 <code>router.js</code> 文件方便后续创建增、删、改、查请求接口。</p>
<pre><code class="hljs language-项目结构" lang="项目结构">📦node_mongo
 ┣ 📂model
 ┃ ┗ 📜modal.js
 ┣ 📂router
 ┃ ┗ 📜router.js
 ┣ 📜.env
 ┣ 📜index.js
 ┗ 📜package.json
</code></pre>
<p>接下来，首先在 <code>modal.js</code> 中建立 <code>Schema</code> 数据文档。</p>
<p><strong>Schema</strong> 是什么？ 它类似于传统数据库中的表结构，定义了集合里每个文档中应该有的字段，以及这些字段的数据类型。</p>
<pre><code class="hljs language-modal.js" lang="modal.js">// 导入mongoose
import mongoose from 'mongoose'

// 创建Schema文档
const carSchema = new mongoose.Schema({
  type: String,
  brand: String,
  price: Number,
})

// 导出模型
export const carModel = mongoose.model('car', carSchema)
</code></pre>
<p>上述代码中，第一步先将 mongoose 核心依赖库导入。</p>
<p>其次以汽车为例，创建一个 <code>carSchema</code> 的实例对象，对象中包含 <code>type</code>、<code>brand</code>、<code>price</code> 三个字段，分别代表型号，品牌和价格，其中前两个为数据类型为String(字符串)，价格的数据类型为Number(数字)</p>
<p>最后，使用 <code>mongoose.model</code> 将数据模型导出，方便接口的使用，<code>mongoose.model</code> 接收两个参数。</p>
<p>第一个参数 <code>car</code> 是MongoDB数据库下集合的名称（<strong>注意：集合创建时会名称自动修改为复数，比如代码中传递参数为 <code>car</code>，数据库集合的名称会变为 <code>cars</code></strong>）</p>
<p>第二个参数是 <code>carSchema</code>，就是之前创建的文档实例对象。</p>
<h3 data-id="heading-1">常用接口的创建</h3>
<p>完成数据模型的定义后，我们来到 <code>router</code> 文件夹下，</p>
<p>首先创建一个 <code>asyncHandler.js</code> ，并定义一个简单的错误处理包装函数，统一处理错误格式。</p>
<pre><code class="hljs language-asyncHandler.js" lang="asyncHandler.js">// 异步错误处理包装函数
export const asyncHandler = (fn) =&gt; {
  return (req, res, next) =&gt; {
    Promise.resolve(fn(req, res, next)).catch((error) =&gt; {
      console.error('错误:', error.message)
      // 统一返回错误格式
      res.status(500).json({
        success: false,
        message: error.message || '服务器错误'
      })
    })
  }
}
</code></pre>
<p>之后把数据模型 <code>carModel</code> 和 异步处理函数 <code>asyncHandler.js</code> 导入 <code>router.js</code>。</p>
<pre><code class="hljs language-router.js" lang="router.js">import express from 'express'
const router = express.Router()

// 导入model
import { carModel } from '../model/modal.js'
// 导入错误处理包装函数
import { asyncHandler } from './asyncHandler.js'
</code></pre>
<p>接下来我们使用 <code>Restful API</code> 分别按顺序创建增、删、改、查四个接口并将路由导出，完整代码如下：</p>
<pre><code class="hljs language-router.js" lang="router.js">// 新增汽车数据
router.post('/addCars', asyncHandler(async (req, res) =&gt; {
  const { type, brand, price } = req.body
  const car = new carModel({ type, brand, price })
  await car.save()
  res.json(car)
}))

// 删除汽车数据
router.delete('/deleteCars/:id', asyncHandler(async (req, res) =&gt; {
  //获取删除id
  const { id } = req.params
  await carModel.findByIdAndDelete(id)
  res.json({ message: '数据删除成功！' })
}))

// 更新汽车数据
router.put('/updateCars/:id', asyncHandler(async (req, res) =&gt; {
  //获取更新数据id
  const { id } = req.params
  const { type, brand, price } = req.body
  const car = await carModel.findByIdAndUpdate(id, { type, brand, price }, { new: true })
  res.json(car)
}))

// 查询所有汽车数据
router.get('/getAllCars', asyncHandler(async (req, res) =&gt; {
  const cars = await carModel.find()
  res.json(cars)
}))

// 导出路由
export default router
</code></pre>
<h3 data-id="heading-2">接口测试</h3>
<p>最后，我们使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fapifox.com%2F" target="_blank" title="https://apifox.com/" ref="nofollow noopener noreferrer">Apifox</a> 来测试一下接口和数据库是否正常运行。</p>
<p>先在项目根目录 <code>index.js</code> 里导入接口路由。</p>
<pre><code class="hljs language-index.js" lang="index.js">// 导入路由
import router from './router/router.js'
// 将api设置为公共路径，不用每次都在路由前面加/api
app.use('/api', router)
</code></pre>
<p>使用终端进入项目根目录，执行 <code>node index.js</code> 启动服务。</p>
<p>我们以新增一条汽车数据接口为例，请求地址和传递参数参考下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f36ea5d7d69468088192c9bc41340ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Zeo55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769140034&amp;x-signature=wEgGVqLagPHzDIOwaCVipXMFTrA%3D" alt="QQ截图20251219105406.png" loading="lazy"/></p>
<p>点击 "发送" 请求，如果添加成功，我们可以在下方控制台看到返回的数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30060dac92a04de9a78322da6915147a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Zeo55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769140034&amp;x-signature=GSvzjZhFTQagGYP7Y3%2BGOhJB3tQ%3D" alt="image.png" loading="lazy"/></p>
<p>为了确认数据添加成功，可以使用 Navicat 登录数据库查看一下。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bd1348ea60548ffbddacfa6b09b92eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Zeo55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769140034&amp;x-signature=eFes%2Fq0INlKmDKB5%2BauShjqC1Lg%3D" alt="QQ截图20251219111525.png" loading="lazy"/></p>
<p>从上图可以看到在 <code>test</code> 数据库下已经成功建立了 <code>cars</code> 集合，并且有了一条数据。其它的接口大家可以自行进行测试。</p>
<p>到此，我们完成了使用 <code>Mongoose</code> 实现对数据库增删改查的基本操作。</p>
<p>下一节，我们将讲解<strong>聚合、条件查询、分页</strong>排序等 <code>Mongoose</code> 对数据库的进阶操作。</p>
<p>如果我的文章能让您有所收获，欢迎一键三连（评论，点赞，关注），感谢！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenFeign 的响应对象怎么共享？]]></title>    <link>https://juejin.cn/post/7598043378018631689</link>    <guid>https://juejin.cn/post/7598043378018631689</guid>    <pubDate>2026-01-23T02:32:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598043378018631689" data-draft-id="7598021984300482587" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenFeign 的响应对象怎么共享？"/> <meta itemprop="keywords" content="微服务,Spring Cloud,Spring Boot"/> <meta itemprop="datePublished" content="2026-01-23T02:32:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小飞Coding"/> <meta itemprop="url" content="https://juejin.cn/user/954816145155181"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenFeign 的响应对象怎么共享？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/954816145155181/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小飞Coding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T02:32:03.000Z" title="Fri Jan 23 2026 02:32:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你在用 OpenFeign 调用远程服务时，是不是经常这样做？</p>
<ul>
<li>服务 A（比如 <code>user-service</code>）定义了一个 <code>UserResponse</code></li>
<li>服务 B（比如 <code>order-service</code>）调用 A，就手动新建一个一模一样的 <code>UserResponse</code> 类</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// order-service 里“照着抄”的 UserResponse</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserResponse</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-comment">// ... getter/setter</span>
}
</code></pre>
<p><strong>停！这看似省事，实则埋雷。</strong></p>
<ul>
<li>字段改了怎么办？</li>
<li>类型不一致怎么办？</li>
<li>对方是第三方公司，你连源码都看不到怎么办？</li>
</ul>
<p>今天我们就来彻底解决这个问题：<strong>OpenFeign 调用中的响应对象（DTO），到底该怎么共享？</strong></p>
<hr/>
<h2 data-id="heading-0">一、为什么“复制粘贴”是技术债？</h2>
<p>OpenFeign 调用最终是 HTTP + JSON：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@FeignClient(name = "user-service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserClient</span> {
    <span class="hljs-meta">@GetMapping("/users/{id}")</span>
    UserResponse <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>; <span class="hljs-comment">// ← 这个类从哪来？</span>
}
</code></pre>
<p>Feign 会把 HTTP 响应体（JSON）反序列化成 <code>UserResponse</code>。
<strong>如果这个类和对方服务实际返回的结构不一致，就会出问题：</strong></p>
<ul>
<li>字段缺失 → 值为 <code>null</code></li>
<li>类型错误（如 <code>int</code> vs <code>String</code>）→ 反序列化失败</li>
<li>字段重命名 → 数据错位</li>
</ul>
<p>更可怕的是：<strong>编译能过，运行时报错，线上才发现！</strong></p>
<blockquote>
<p>💥 这就是典型的 <strong>契约不一致</strong> —— 服务提供方和消费方对数据结构的理解不同步。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、方案 1：内部系统 → 抽取公共 Maven 模块（推荐）</h2>
<p>适用于<strong>同一公司、有私有仓库</strong>的场景。</p>
<h3 data-id="heading-2">✅ 步骤：</h3>
<ol>
<li>
<p><strong>新建 <code>common-model</code> 模块</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- common-model/pom.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.yourcompany<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>common-model<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>把 <code>UserResponse</code> 放进去</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// common-model/src/main/java/com/yourcompany/model/UserResponse.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserResponse</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-comment">// 必须有无参构造 + getter/setter（Jackson 需要）</span>
}
</code></pre>
</li>
<li>
<p><strong>服务端和客户端都依赖它</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- user-service &amp; order-service 的 pom.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.yourcompany<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>common-model<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>Feign Client 直接引用</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.yourcompany.model.UserResponse;

<span class="hljs-meta">@FeignClient(name = "user-service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserClient</span> {
    <span class="hljs-meta">@GetMapping("/users/{id}")</span>
    UserResponse <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>;
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-3">✅ 优势：</h3>
<ul>
<li><strong>单一数据源</strong>：改一次，所有服务同步</li>
<li><strong>类型安全</strong>：编译期就能发现字段缺失</li>
<li><strong>符合微服务最佳实践</strong>（类似 Dubbo 的 <code>api</code> 模块）</li>
</ul>
<blockquote>
<p>📌 注意：<code>common-model</code> 只放 DTO、枚举、常量，<strong>不要引入 Spring、业务逻辑</strong>！</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">三、方案 2：跨公司/第三方 → 用 OpenAPI 自动生成</h2>
<p>当对方是<strong>外部团队或 SaaS 服务商</strong>，你无法拿到 JAR 包，怎么办？</p>
<h3 data-id="heading-5">✅ 核心：<strong>契约即代码</strong></h3>
<ol>
<li>
<p><strong>让对方提供 OpenAPI（Swagger）文档</strong>
（标准 YAML/JSON，描述接口和数据结构）</p>
</li>
<li>
<p><strong>你用工具自动生成客户端代码</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 OpenAPI Generator</span>
openapi-generator generate \
  -i https://partner.com/api-docs/user-service.yaml \
  -g java \
  --library=feign \
  -o ./generated-client
</code></pre>
</li>
<li>
<p><strong>自动生成的内容包括：</strong></p>
<ul>
<li><code>UserResponse.java</code></li>
<li><code>UserApiClient.java</code>（带 <code>@FeignClient</code> 注解）</li>
</ul>
</li>
<li>
<p><strong>直接使用，无需手写</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> UserApiClient userApiClient;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">()</span> {
    <span class="hljs-type">UserResponse</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userApiClient.getUser(<span class="hljs-number">123L</span>); <span class="hljs-comment">// 类型安全！</span>
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-6">✅ 优势：</h3>
<ul>
<li><strong>语言无关</strong>：对方用 Python，你用 Java，都能生成</li>
<li><strong>自动化</strong>：CI/CD 中自动更新 SDK</li>
<li><strong>文档即契约</strong>：Swagger UI 可视化接口规范</li>
</ul>
<blockquote>
<p>🔧 工具推荐：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopenapi-generator.tech%2F" target="_blank" title="https://openapi-generator.tech/" ref="nofollow noopener noreferrer">OpenAPI Generator</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fspringdoc.org%2F" target="_blank" title="https://springdoc.org/" ref="nofollow noopener noreferrer">Springdoc</a></p>
</blockquote>
<hr/>
<h2 data-id="heading-7">四、千万别这么干！</h2>





















<table><thead><tr><th>错误做法</th><th>后果</th></tr></thead><tbody><tr><td>手动复制 <code>UserResponse</code></td><td>字段漂移、线上 bug</td></tr><tr><td>用 <code>Map&lt;String, Object&gt;</code> 接收</td><td>失去类型安全，代码难维护</td></tr><tr><td>让 Feign 返回 <code>String</code> 再手动解析 JSON</td><td>重复造轮子，易出错</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">五、进阶建议：加上契约测试</h2>
<p>即使有了共享模型，也不能保证接口行为一致。推荐：</p>
<ul>
<li><strong>Pact</strong>：消费者驱动契约测试</li>
<li><strong>Spring Cloud Contract</strong>：提供者驱动契约测试</li>
</ul>
<p>例如，订单服务可以声明：</p>
<blockquote>
<p>“当我调用 <code>/users/123</code>，期望返回 <code>{id: 123, username: "Alice"}</code>”</p>
</blockquote>
<p>用户服务在 CI 中验证该契约是否通过。</p>
<blockquote>
<p>✅ <strong>模型一致 + 行为一致 = 真正可靠的微服务调用</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-9">六、总结</h2>





















<table><thead><tr><th>场景</th><th>推荐方案</th></tr></thead><tbody><tr><td><strong>内部微服务</strong></td><td>抽取 <code>common-model</code> 模块，Maven 依赖共享</td></tr><tr><td><strong>外部/第三方服务</strong></td><td>基于 OpenAPI 自动生成客户端</td></tr><tr><td><strong>关键核心接口</strong></td><td>配合契约测试，双重保障</td></tr></tbody></table>
<p><strong>记住：微服务不是“各自为政”，而是“契约先行”。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C语言的指针]]></title>    <link>https://juejin.cn/post/7598043378018680841</link>    <guid>https://juejin.cn/post/7598043378018680841</guid>    <pubDate>2026-01-23T02:34:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598043378018680841" data-draft-id="7598104572583133234" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C语言的指针"/> <meta itemprop="keywords" content="后端,嵌入式,单片机"/> <meta itemprop="datePublished" content="2026-01-23T02:34:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员良许"/> <meta itemprop="url" content="https://juejin.cn/user/3913917128246942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C语言的指针
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917128246942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员良许
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T02:34:06.000Z" title="Fri Jan 23 2026 02:34:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是良许。</p>
<p>今天我们来聊一聊 C 语言中最让初学者头疼，却又最强大的特性——指针。</p>
<p>作为一名从事嵌入式开发多年的程序员，我深知指针在底层编程中的重要性。</p>
<p>无论是操作硬件寄存器、管理动态内存，还是实现高效的数据结构，指针都扮演着不可或缺的角色。</p>
<h2 data-id="heading-0">1. 什么是指针</h2>
<h3 data-id="heading-1">1.1 指针的本质</h3>
<p>指针其实就是一个变量，只不过这个变量存储的不是普通的数值，而是内存地址。</p>
<p>我们可以把内存想象成一排排的房间，每个房间都有一个门牌号（地址），而指针就是记录这个门牌号的本子。</p>
<p>通过这个门牌号，我们可以找到对应的房间，进而访问或修改房间里的内容。</p>
<p>在嵌入式开发中，这个概念尤为重要。比如 STM32 的 GPIO 端口，其实就是通过固定的内存地址来访问的。</p>
<p>当我们要点亮一个 LED 灯时，本质上就是通过指针操作特定地址的寄存器。</p>
<h3 data-id="heading-2">1.2 为什么需要指针</h3>
<p>指针的存在主要解决了以下几个问题：</p>
<p>第一，高效传递数据。</p>
<p>当我们需要在函数之间传递大型数据结构时，如果直接传递整个结构体，会产生大量的复制开销。</p>
<p>而使用指针，只需要传递一个地址（通常是 4 字节或 8 字节），效率大大提升。</p>
<p>第二，动态内存管理。</p>
<p>在嵌入式系统中，内存资源往往非常有限。</p>
<p>通过指针和动态内存分配，我们可以在程序运行时根据实际需要申请和释放内存，提高内存利用率。</p>
<p>第三，直接操作硬件。</p>
<p>在嵌入式开发中，我们经常需要直接访问硬件寄存器。</p>
<p>这些寄存器都有固定的物理地址，必须通过指针来访问。</p>
<h2 data-id="heading-3">2. 指针的基本使用</h2>
<h3 data-id="heading-4">2.1 指针的声明和初始化</h3>
<p>声明一个指针变量的语法是在类型名后面加上星号（*）。例如：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">int</span> *p;        <span class="hljs-comment">// 声明一个指向整型的指针</span>
<span class="hljs-type">char</span> *str;     <span class="hljs-comment">// 声明一个指向字符的指针</span>
<span class="hljs-type">float</span> *fp;     <span class="hljs-comment">// 声明一个指向浮点数的指针</span>
</code></pre>
<p>需要注意的是，刚声明的指针是野指针，它指向一个不确定的地址，使用前必须初始化。</p>
<p>我们可以用取地址符（&amp;）来获取变量的地址：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">int</span> num = <span class="hljs-number">100</span>;
<span class="hljs-keyword">int</span> *p = &amp;num;  <span class="hljs-regexp">//</span> p指向num的地址
​
<span class="hljs-keyword">printf</span>(<span class="hljs-string">"num的值: %d\n"</span>, num);
<span class="hljs-keyword">printf</span>(<span class="hljs-string">"num的地址: %p\n"</span>, &amp;num);
<span class="hljs-keyword">printf</span>(<span class="hljs-string">"p存储的地址: %p\n"</span>, p);
<span class="hljs-keyword">printf</span>(<span class="hljs-string">"p指向的值: %d\n"</span>, *p);
</code></pre>
<p>这段代码会输出 num 的值、num 的地址、指针 p 存储的地址（与 num 的地址相同），以及通过指针 p 访问到的值（也是 100）。</p>
<h3 data-id="heading-5">2.2 指针的解引用</h3>
<p>解引用就是通过指针访问它所指向的内存中的值。</p>
<p>使用星号（*）操作符可以实现解引用：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">int</span> a = <span class="hljs-number">50</span>;
<span class="hljs-keyword">int</span> *ptr = &amp;a;
​
<span class="hljs-keyword">printf</span>(<span class="hljs-string">"a的值: %d\n"</span>, a);        <span class="hljs-regexp">//</span> 输出<span class="hljs-number">50</span>
<span class="hljs-keyword">printf</span>(<span class="hljs-string">"*ptr的值: %d\n"</span>, *ptr);  <span class="hljs-regexp">//</span> 输出<span class="hljs-number">50</span>
​
*ptr = <span class="hljs-number">80</span>;  <span class="hljs-regexp">//</span> 通过指针修改a的值
<span class="hljs-keyword">printf</span>(<span class="hljs-string">"修改后a的值: %d\n"</span>, a);  <span class="hljs-regexp">//</span> 输出<span class="hljs-number">80</span>
</code></pre>
<p>在这个例子中，我们通过指针 ptr 修改了变量 a 的值。</p>
<p>这在函数参数传递中非常有用，可以实现真正的"传址调用"。</p>
<h3 data-id="heading-6">2.3 指针与函数</h3>
<p>在 C 语言中，函数参数默认是值传递，也就是说函数内部对参数的修改不会影响外部变量。</p>
<p>但通过指针，我们可以实现传址调用：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">swap</span><span class="hljs-params">(<span class="hljs-type">int</span> *a, <span class="hljs-type">int</span> *b)</span> </span>{
    <span class="hljs-type">int</span> temp = *a;
    *a = *b;
    *b = temp;
}
​
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{
    <span class="hljs-type">int</span> x = <span class="hljs-number">10</span>, y = <span class="hljs-number">20</span>;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"交换前: x=%d, y=%d\n"</span>, x, y);
    
    <span class="hljs-built_in">swap</span>(&amp;x, &amp;y);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"交换后: x=%d, y=%d\n"</span>, x, y);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>这个经典的交换函数例子展示了指针的威力。</p>
<p>通过传递变量的地址，函数内部可以直接修改外部变量的值。</p>
<h2 data-id="heading-7">3. 指针的进阶应用</h2>
<h3 data-id="heading-8">3.1 指针与数组</h3>
<p>数组名本身就是一个指针常量，指向数组的首元素。</p>
<p>这是 C 语言中一个非常重要的概念：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">int</span> arr[<span class="hljs-number">5</span>] = {<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>};
<span class="hljs-keyword">int</span> *p = arr;  <span class="hljs-regexp">//</span> 等价于 <span class="hljs-keyword">int</span> *p = &amp;arr[<span class="hljs-number">0</span>];
​
<span class="hljs-keyword">printf</span>(<span class="hljs-string">"arr[0] = %d\n"</span>, arr[<span class="hljs-number">0</span>]);    <span class="hljs-regexp">//</span> 输出<span class="hljs-number">1</span>
<span class="hljs-keyword">printf</span>(<span class="hljs-string">"*p = %d\n"</span>, *p);            <span class="hljs-regexp">//</span> 输出<span class="hljs-number">1</span>
<span class="hljs-keyword">printf</span>(<span class="hljs-string">"*(p+1) = %d\n"</span>, *(p+<span class="hljs-number">1</span>));    <span class="hljs-regexp">//</span> 输出<span class="hljs-number">2</span>
<span class="hljs-keyword">printf</span>(<span class="hljs-string">"p[2] = %d\n"</span>, p[<span class="hljs-number">2</span>]);        <span class="hljs-regexp">//</span> 输出<span class="hljs-number">3</span>
</code></pre>
<p>指针可以进行算术运算。</p>
<p>当指针加 1 时，实际上是移动了一个所指类型的大小。</p>
<p>比如 int 类型占 4 字节，那么 p+1 实际上是地址增加 4。</p>
<p>在嵌入式开发中，这个特性经常用于遍历数据缓冲区：</p>
<pre><code class="hljs language-ini" lang="ini">uint8_t buffer<span class="hljs-section">[256]</span><span class="hljs-comment">;</span>
uint8_t *<span class="hljs-attr">ptr</span> = buffer<span class="hljs-comment">;</span>
​
// 通过指针遍历整个缓冲区
for(int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 256; i++) {</span>
    *<span class="hljs-attr">ptr</span> = i<span class="hljs-comment">;  // 写入数据</span>
    ptr++<span class="hljs-comment">;     // 指针移动到下一个位置</span>
}
</code></pre>
<h3 data-id="heading-9">3.2 指针与字符串</h3>
<p>在 C 语言中，字符串实际上就是字符数组，而字符串的操作大量使用指针：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">char</span> str[] = <span class="hljs-string">"Hello"</span>;
<span class="hljs-type">char</span> *p = str;
​
<span class="hljs-keyword">while</span>(*p != <span class="hljs-string">'\0'</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%c"</span>, *p);
    p++;
}
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);
</code></pre>
<p>这段代码通过指针遍历字符串并逐个打印字符。</p>
<p>在实际开发中，我们经常需要处理字符串，比如解析串口接收到的 AT 指令：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">parse_at_command</span><span class="hljs-params">(<span class="hljs-type">char</span> *cmd)</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strncmp</span>(cmd, <span class="hljs-string">"AT+"</span>, <span class="hljs-number">3</span>) == <span class="hljs-number">0</span>) {
        <span class="hljs-type">char</span> *param = cmd + <span class="hljs-number">3</span>;  <span class="hljs-comment">// 指针偏移到参数部分</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"收到AT指令，参数: %s\n"</span>, param);
    }
}
</code></pre>
<h3 data-id="heading-10">3.3 多级指针</h3>
<p>指针本身也是变量，也有自己的地址，因此可以有指向指针的指针，称为多级指针：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">int</span> num = <span class="hljs-number">100</span>;
<span class="hljs-keyword">int</span> *p = &amp;num;      <span class="hljs-regexp">//</span> 一级指针
<span class="hljs-keyword">int</span> **pp = &amp;p;      <span class="hljs-regexp">//</span> 二级指针

<span class="hljs-keyword">printf</span>(<span class="hljs-string">"num = %d\n"</span>, num);
<span class="hljs-keyword">printf</span>(<span class="hljs-string">"*p = %d\n"</span>, *p);
<span class="hljs-keyword">printf</span>(<span class="hljs-string">"**pp = %d\n"</span>, **pp);

**pp = <span class="hljs-number">200</span>;  <span class="hljs-regexp">//</span> 通过二级指针修改num的值
<span class="hljs-keyword">printf</span>(<span class="hljs-string">"修改后num = %d\n"</span>, num);
</code></pre>
<p>多级指针在动态二维数组、函数指针数组等场景中很常见。</p>
<p>在嵌入式开发中，有时需要动态管理设备列表，就会用到二级指针。</p>
<h2 data-id="heading-11">4. 指针在嵌入式中的实战应用</h2>
<h3 data-id="heading-12">4.1 操作硬件寄存器</h3>
<p>在 STM32 开发中，我们经常需要直接操作寄存器。</p>
<p>这些寄存器都有固定的物理地址，必须通过指针访问：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 定义GPIO端口的基地址</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> GPIOA_BASE    0x40020000U</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> GPIOA_MODER   (*(volatile uint32_t *)(GPIOA_BASE + 0x00))</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> GPIOA_ODR     (*(volatile uint32_t *)(GPIOA_BASE + 0x14))</span>

<span class="hljs-comment">// 配置PA5为输出模式</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">led_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{
    <span class="hljs-comment">// 使能GPIOA时钟</span>
    RCC-&gt;AHB1ENR |= RCC_AHB1ENR_GPIOAEN;

    <span class="hljs-comment">// 配置PA5为输出模式</span>
    GPIOA_MODER &amp;= ~(<span class="hljs-number">3U</span> &lt;&lt; (<span class="hljs-number">5</span> * <span class="hljs-number">2</span>));  <span class="hljs-comment">// 清除原配置</span>
    GPIOA_MODER |= (<span class="hljs-number">1U</span> &lt;&lt; (<span class="hljs-number">5</span> * <span class="hljs-number">2</span>));   <span class="hljs-comment">// 设置为输出</span>
}

<span class="hljs-comment">// 点亮LED</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">led_on</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{
    GPIOA_ODR |= (<span class="hljs-number">1U</span> &lt;&lt; <span class="hljs-number">5</span>);
}

<span class="hljs-comment">// 熄灭LED</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">led_off</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{
    GPIOA_ODR &amp;= ~(<span class="hljs-number">1U</span> &lt;&lt; <span class="hljs-number">5</span>);
}
</code></pre>
<p>这里的 <code>volatile</code> 关键字非常重要，它告诉编译器这个变量可能被外部因素改变，不要对其进行优化。</p>
<p>在访问硬件寄存器时必须使用 volatile 修饰。</p>
<h3 data-id="heading-13">4.2 DMA 数据传输</h3>
<p>在使用 STM32 的 DMA 功能时，我们需要指定源地址和目标地址，这都是通过指针实现的：</p>
<pre><code class="hljs language-ini" lang="ini">uint8_t tx_buffer<span class="hljs-section">[128]</span><span class="hljs-comment">;</span>
uint8_t rx_buffer<span class="hljs-section">[128]</span><span class="hljs-comment">;</span>

void dma_uart_init(void) {
    // 配置DMA
    <span class="hljs-attr">hdma_usart1_tx.Instance</span> = DMA2_Stream7<span class="hljs-comment">;</span>
    <span class="hljs-attr">hdma_usart1_tx.Init.Channel</span> = DMA_CHANNEL_4<span class="hljs-comment">;</span>
    <span class="hljs-attr">hdma_usart1_tx.Init.Direction</span> = DMA_MEMORY_TO_PERIPH<span class="hljs-comment">;</span>
    <span class="hljs-attr">hdma_usart1_tx.Init.PeriphInc</span> = DMA_PINC_DISABLE<span class="hljs-comment">;</span>
    <span class="hljs-attr">hdma_usart1_tx.Init.MemInc</span> = DMA_MINC_ENABLE<span class="hljs-comment">;</span>

    HAL_DMA_Init(&amp;hdma_usart1_tx)<span class="hljs-comment">;</span>
}

void send_data_via_dma(void) {
    // 通过DMA发送数据，传递缓冲区指针
    HAL_UART_Transmit_DMA(&amp;huart1, tx_buffer, sizeof(tx_buffer))<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-14">4.3 动态内存管理</h3>
<p>在嵌入式系统中，虽然要谨慎使用动态内存，但在某些场景下确实需要：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    <span class="hljs-type">uint8_t</span> id;
    <span class="hljs-type">uint16_t</span> data;
    <span class="hljs-type">uint32_t</span> timestamp;
} <span class="hljs-type">sensor_data_t</span>;

<span class="hljs-type">sensor_data_t</span>* <span class="hljs-title function_">create_sensor_data</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> id)</span> {
    <span class="hljs-type">sensor_data_t</span> *data = (<span class="hljs-type">sensor_data_t</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">sensor_data_t</span>));
    <span class="hljs-keyword">if</span>(data != <span class="hljs-literal">NULL</span>) {
        data-&gt;id = id;
        data-&gt;data = <span class="hljs-number">0</span>;
        data-&gt;timestamp = HAL_GetTick();
    }
    <span class="hljs-keyword">return</span> data;
}

<span class="hljs-type">void</span> <span class="hljs-title function_">process_sensor</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-type">sensor_data_t</span> *sensor = create_sensor_data(<span class="hljs-number">1</span>);
    <span class="hljs-keyword">if</span>(sensor != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-comment">// 处理传感器数据</span>
        sensor-&gt;data = read_sensor();

        <span class="hljs-comment">// 使用完毕后释放内存</span>
        <span class="hljs-built_in">free</span>(sensor);
    }
}
</code></pre>
<p>需要注意的是，在嵌入式系统中使用动态内存要特别小心，因为频繁的 malloc 和 free 可能导致内存碎片，影响系统稳定性。</p>
<h2 data-id="heading-15">5. 指针使用的注意事项</h2>
<h3 data-id="heading-16">5.1 野指针问题</h3>
<p>野指针是指向未知内存区域的指针，使用野指针会导致程序崩溃或产生不可预测的行为：</p>
<pre><code class="hljs language-ini" lang="ini">int *p<span class="hljs-comment">;  // 野指针，未初始化</span>
*<span class="hljs-attr">p</span> = <span class="hljs-number">10</span><span class="hljs-comment">; // 危险！可能导致程序崩溃</span>

// 正确做法
int *<span class="hljs-attr">p</span> = NULL<span class="hljs-comment">;  // 初始化为NULL</span>
if(p != NULL) {
    *<span class="hljs-attr">p</span> = <span class="hljs-number">10</span><span class="hljs-comment">;</span>
}
</code></pre>
<p>在使用指针前，一定要确保它已经被正确初始化。</p>
<p>养成将指针初始化为 NULL 的习惯，并在使用前检查是否为 NULL。</p>
<h3 data-id="heading-17">5.2 内存泄漏</h3>
<p>动态分配的内存如果忘记释放，就会造成内存泄漏：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">memory_leak_example</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-type">int</span> *p = (<span class="hljs-type">int</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>) * <span class="hljs-number">100</span>);
    <span class="hljs-comment">// 使用p</span>
    <span class="hljs-comment">// 忘记调用free(p)，造成内存泄漏</span>
}

<span class="hljs-comment">// 正确做法</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">correct_example</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-type">int</span> *p = (<span class="hljs-type">int</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>) * <span class="hljs-number">100</span>);
    <span class="hljs-keyword">if</span>(p != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-comment">// 使用p</span>
        <span class="hljs-built_in">free</span>(p);
        p = <span class="hljs-literal">NULL</span>;  <span class="hljs-comment">// 释放后置为NULL</span>
    }
}
</code></pre>
<h3 data-id="heading-18">5.3 悬空指针</h3>
<p>当指针指向的内存被释放后，如果继续使用该指针，就会产生悬空指针问题：</p>
<pre><code class="hljs language-ini" lang="ini">int *<span class="hljs-attr">p</span> = (int*)malloc(sizeof(int))<span class="hljs-comment">;</span>
*<span class="hljs-attr">p</span> = <span class="hljs-number">100</span><span class="hljs-comment">;</span>
free(p)<span class="hljs-comment">;</span>
// p现在是悬空指针
*<span class="hljs-attr">p</span> = <span class="hljs-number">200</span><span class="hljs-comment">;  // 危险！访问已释放的内存</span>

// 正确做法
free(p)<span class="hljs-comment">;</span>
<span class="hljs-attr">p</span> = NULL<span class="hljs-comment">;  // 释放后立即置为NULL</span>
</code></pre>
<h2 data-id="heading-19">6. 总结</h2>
<p>指针是 C 语言的精髓，也是嵌入式开发的基石。</p>
<p>虽然初学时可能觉得难以理解，但只要多加练习，理解其本质（就是内存地址），就能逐渐掌握。</p>
<p>在我多年的嵌入式开发经验中，指针无处不在：从操作硬件寄存器到管理数据结构，从函数参数传递到实现复杂算法，都离不开指针。</p>
<p>掌握指针不仅能让你写出更高效的代码，还能帮助你深入理解计算机的工作原理。</p>
<p>特别是在嵌入式领域，对指针的熟练运用直接关系到能否写出高质量的底层代码。</p>
<p>希望这篇文章能帮助大家更好地理解和使用 C 语言的指针，在嵌入式开发的道路上走得更远。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ARouter源码详解]]></title>    <link>https://juejin.cn/post/7598081541563662376</link>    <guid>https://juejin.cn/post/7598081541563662376</guid>    <pubDate>2026-01-23T02:34:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598081541563662376" data-draft-id="7592119218029658146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ARouter源码详解"/> <meta itemprop="keywords" content="源码"/> <meta itemprop="datePublished" content="2026-01-23T02:34:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XRay"/> <meta itemprop="url" content="https://juejin.cn/user/3966693685869288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ARouter源码详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693685869288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XRay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T02:34:19.000Z" title="Fri Jan 23 2026 02:34:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在前面的文章 <a href="https://juejin.cn/post/7592276645361893376" target="_blank" title="https://juejin.cn/post/7592276645361893376">组件化</a> 中用到了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2FARouter%2Fblob%2Fmaster%2FREADME_CN.md" target="_blank" title="https://github.com/alibaba/ARouter/blob/master/README_CN.md" ref="nofollow noopener noreferrer">ARouter</a> 框架，它是专门用来做组件化改造的，官方定义如下：</p>
<blockquote>
<p>一个用于帮助 Android App 进行组件化改造的框架 —— 支持模块间的路由、通信、解耦</p>
</blockquote>
<p>什么是路由？可能你首先联想到的是路由器，路由器根据路由表来转发数据包，路由表决定了数据传输的路径。ARouter 就相当于一个路由器，让无依赖的双方可以通信。</p>
<p>下面我们就通过源码来分析 ARouter 的实现原理，本文 ARouter 源码基于：com.alibaba:arouter-api:1.5.2。</p>
<h3 data-id="heading-1">源码解析</h3>
<p>ARouter 的简单使用在前面的文章中已有介绍，使用前需要在 Application 中用 <code>ARouter.init(this)</code> 来初始化 ARouter，下面我们就从这里开始分析源码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ARouter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">hasInit</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(Application application)</span> {
        <span class="hljs-comment">// 判断是否已经初始化</span>
        <span class="hljs-keyword">if</span> (!hasInit) {
            ...
            <span class="hljs-comment">// 调用 _ARouter.init() 初始化</span>
            hasInit = _ARouter.init(application);

            <span class="hljs-keyword">if</span> (hasInit) {
                _ARouter.afterInit();
            }
            ...
        }
    }
}
</code></pre>
<p>首先判断有没有初始化，没有初始化就进行初始化，并把初始化的结果赋值给 hasInit， ARouter 的 init() 方法调用了 _ARouter 的 init() 方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">_ARouter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">hasInit</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> DefaultPoolExecutor.getInstance();

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">init</span><span class="hljs-params">(Application application)</span> {
        mContext = application;
        LogisticsCenter.init(mContext, executor);
        ...
        hasInit = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<p>_ARouter 的 init() 方法中出现了 LogisticsCenter 这个类，这个类是做什么的呢？看类名是 “物流中心”的意思 ，继续看下它的 init() 方法做了些什么：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogisticsCenter</span> {

    <span class="hljs-comment">// 加载内存中的路由信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(Context context, ThreadPoolExecutor tpe)</span> <span class="hljs-keyword">throws</span> HandlerException {
        ...
        <span class="hljs-comment">// 从插件中加载路由表</span>
        loadRouterMap();
        <span class="hljs-keyword">if</span> (registerByPlugin) {
            logger.info(TAG, <span class="hljs-string">"Load router map by arouter-auto-register plugin."</span>);
        } <span class="hljs-keyword">else</span> {
            Set&lt;String&gt; routerMap;

            <span class="hljs-comment">// It will rebuild router map every times when debuggable.</span>
            <span class="hljs-comment">// 调用 ARouter.openDebug() 、第一次运行、版本更新都会更新 routerMap 。</span>
            <span class="hljs-comment">// PackageUtils.isNewVersion() 中通过 SharedPreference 存储的 App 的</span>
            <span class="hljs-comment">// versionName 和 versionCode 来判断版本是否有更新</span>
            <span class="hljs-keyword">if</span> (ARouter.debuggable() || PackageUtils.isNewVersion(context)) {

                <span class="hljs-comment">// These class was generated by arouter-compiler.</span>
                <span class="hljs-comment">// 这里就是从 dex 中获取 com.alibaba.android.arouter.routes 包下的 .class</span>
                <span class="hljs-comment">// ROUTE_ROOT_PAKCAGE = "com.alibaba.android.arouter.routes";</span>
                routerMap = ClassUtils.getFileNameByPackageName(mContext, ROUTE_ROOT_PAKCAGE);
                <span class="hljs-keyword">if</span> (!routerMap.isEmpty()) {
                    <span class="hljs-comment">// 把 routerMap 存入 SharedPreference</span>
                    context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).edit().putStringSet(AROUTER_SP_KEY_MAP, routerMap).apply();
                }

                <span class="hljs-comment">// 更新 SharedPreference 中存储的 App 的版本信息</span>
                PackageUtils.updateVersion(context); <span class="hljs-comment">// Save new version name when router map update finishes.</span>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 直接从 SP 中拿 routerMap ，就是前面保存在 SP 中的 routerMap</span>
                routerMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).getStringSet(AROUTER_SP_KEY_MAP, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;String&gt;()));
            }
            ...
            <span class="hljs-comment">// 根据 className，来实例化不同的对象并调用 loadInto() 方法。</span>
            <span class="hljs-keyword">for</span> (String className : routerMap) {
                <span class="hljs-comment">// 以 com.alibaba.android.arouter.routes.ARouter$$Root 开头</span>
                <span class="hljs-keyword">if</span> (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_ROOT)) {
                    <span class="hljs-comment">// This one of root elements, load root.</span>
                    ((IRouteRoot) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.groupsIndex);
                }
                <span class="hljs-comment">// 以 com.alibaba.android.arouter.routes.ARouter$$Interceptors 开头</span>
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_INTERCEPTORS)) {
                    <span class="hljs-comment">// Load interceptorMeta</span>
                    ((IInterceptorGroup) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.interceptorsIndex);
                }
                <span class="hljs-comment">// 以 com.alibaba.android.arouter.routes.ARouter$$Providers 开头</span>
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_PROVIDERS)) {
                    <span class="hljs-comment">// Load providerIndex</span>
                    ((IProviderGroup) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.providersIndex);
                }
            }
        }
    }

    <span class="hljs-comment">/**
     * arouter-auto-register plugin will generate code inside this method
     * call this method to register all Routers, Interceptors and Providers
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadRouterMap</span><span class="hljs-params">()</span> {
        registerByPlugin = <span class="hljs-literal">false</span>;
        <span class="hljs-comment">// auto generate register code by gradle plugin: arouter-auto-register</span>
        <span class="hljs-comment">// looks like below:</span>
        <span class="hljs-comment">// registerRouteRoot(new ARouter..Root..modulejava());</span>
        <span class="hljs-comment">// registerRouteRoot(new ARouter..Root..modulekotlin());</span>
    }
}
</code></pre>
<p>从上面的代码可以看出，这段代码就是加载路由表的核心代码，上面有注释标出了一些代码的业务逻辑，这里再挑出几个比较难理解的地方重点讲解一下。</p>
<p>首先是这句代码loadRouterMap()，注释上说的是从插件中加载路由表，什么意思呢？意思是你可以选择使用ARouter提供的注册插件自动加载路由表，该注册插件会通过字节码注入的方式修改loadRouterMap()，修改完后loadRouterMap()类似下面这样：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadRouterMap</span><span class="hljs-params">()</span> {
    registerByPlugin = <span class="hljs-literal">false</span>;
    register(<span class="hljs-string">"com.alibaba.android.arouter.routes.ARouter$$Root$$XXX"</span>);
    register(<span class="hljs-string">"com.alibaba.android.arouter.routes.ARouter$$Interceptors$$XXX"</span>);
    register(<span class="hljs-string">"com.alibaba.android.arouter.routes.ARouter$$Providers$$XXX"</span>);
}
</code></pre>
<p>这种情况在编译期把路由表加载到内存中，可以缩短ARouter初始化的时间。使用该插件需要在项目的build.gradle中添加如下配置：</p>
<pre><code class="hljs language-groovy" lang="groovy">buildscript {
    ...
    dependencies {
        classpath "com.alibaba:arouter-register:1.0.2"
    }
}
</code></pre>
<p>需要注意的是，该插件必须与 1.3.0 及以上版本的 API 配合使用。</p>
<p>第22行从dex中获取所有com.alibaba.android.arouter.routes包下的.class文件放入routerMap，从第36行开始遍历routerMap，分成了3种情况：</p>
<ol>
<li>如果.class文件以com.alibaba.android.arouter.routes.ARouter$$Root开头则反射创建该实例，并调用该实例的loadInto()方法，loadInto()方法传入的参数为Warehouse.groupsIndex;</li>
<li>如果.class文件以com.alibaba.android.arouter.routes.ARouter$$Interceptors开头则反射创建该实例，并调用该实例的loadInto()方法，loadInto()方法传入的参数为Warehouse.interceptorsIndex;</li>
<li>如果.class文件以com.alibaba.android.arouter.routes.ARouter$$Providers开头则反射创建该实例，并调用该实例的loadInto()方法，loadInto()方法传入的参数为Warehouse.providersIndex;</li>
</ol>
<p>在前面的文章中，选择集成调试模式，Sync Project后，在download模块下的build\intermediates\javac\debug\classes\com\alibaba\android\arouter\routes目录下共生成了3个.class文件，这些文件是由注解处理器生成的：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-title class_">ARouter</span><span class="hljs-variable">$$</span><span class="hljs-title class_">Group</span><span class="hljs-variable">$$</span>download.<span class="hljs-keyword">class</span>
<span class="hljs-title class_">ARouter</span><span class="hljs-variable">$$</span><span class="hljs-title class_">Providers</span><span class="hljs-variable">$$</span>download.<span class="hljs-keyword">class</span>
<span class="hljs-title class_">ARouter</span><span class="hljs-variable">$$</span><span class="hljs-title class_">Root</span><span class="hljs-variable">$$</span>download.<span class="hljs-keyword">class</span>
</code></pre>
<p>其中ARouter$$Root$$download.class以com.alibaba.android.arouter.routes.ARouter$$Root开头，点开ARouter$$Root$$download.class，其代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ARouter$$Root$$download</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IRouteRoot</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadInto</span><span class="hljs-params">(Map&lt;String, Class&lt;? extends IRouteGroup&gt;&gt; routes)</span> {
        routes.put(<span class="hljs-string">"download"</span>, ARouter$$Group$$download.class);
    }
}
</code></pre>
<p>其loadInto()方法将ARouter$$Group$$download.class存入routes中，routes为Map&lt;String, Class&lt;? extends IRouteGroup&gt;&gt;类型，key为download，routes就是上面的Warehouse.groupsIndex。Warehouse是存储路由信息的仓库，其代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Warehouse</span> {
    <span class="hljs-comment">//用于缓存实现了IRouteGroup接口的类，key为path的第一级</span>
    <span class="hljs-keyword">static</span> Map&lt;String, Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IRouteGroup</span>&gt;&gt; groupsIndex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-comment">//用于缓存路由元信息，key为path</span>
    <span class="hljs-keyword">static</span> Map&lt;String, RouteMeta&gt; routes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-comment">//缓存实现了IProvider接口的类的实例，key为IProvider实现类的class</span>
    <span class="hljs-keyword">static</span> Map&lt;Class, IProvider&gt; providers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-comment">//缓存实现了IProvider类的路由元信息，key为继承了IProvider的接口的路径</span>
    <span class="hljs-keyword">static</span> Map&lt;String, RouteMeta&gt; providersIndex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-comment">//缓存interceptor</span>
    <span class="hljs-keyword">static</span> Map&lt;Integer, Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IInterceptor</span>&gt;&gt; interceptorsIndex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UniqueKeyTreeMap</span>&lt;&gt;(<span class="hljs-string">"More than one interceptors use same priority [%s]"</span>);
    <span class="hljs-keyword">static</span> List&lt;IInterceptor&gt; interceptors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        routes.clear();
        groupsIndex.clear();
        providers.clear();
        providersIndex.clear();
        interceptors.clear();
        interceptorsIndex.clear();
    }
}
</code></pre>
<p>这样就把ARouter$$Group$$download.class存入了Warehouse.groupsIndex这个HashMap中，key为download。</p>
<p>接下来分析跳转的代码，跳转代码如下：</p>
<pre><code class="hljs language-java" lang="java">ARouter.getInstance().build(path).navigation();
</code></pre>
<p>跟进去：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ARouter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ARouter</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ARouter</span><span class="hljs-params">()</span> {
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ARouter <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (!hasInit) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitException</span>(<span class="hljs-string">"ARouter::Init::Invoke init(context) first!"</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">synchronized</span> (ARouter.class) {
                    <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
                        instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ARouter</span>();
                    }
                }
            }
            <span class="hljs-keyword">return</span> instance;
        }
    }

    <span class="hljs-keyword">public</span> Postcard <span class="hljs-title function_">build</span><span class="hljs-params">(String path)</span> {
        <span class="hljs-keyword">return</span> _ARouter.getInstance().build(path);
    }

}
</code></pre>
<p>在getInstance()方法中先判断hasInit是否为true，如果为false抛出异常，接下来用单例模式创建ARouter实例，build()方法调用了_ARouter.getInstance().build(path)：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">_ARouter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">_ARouter</span><span class="hljs-params">()</span> {
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> _ARouter <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (!hasInit) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitException</span>(<span class="hljs-string">"ARouterCore::Init::Invoke init(context) first!"</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">synchronized</span> (_ARouter.class) {
                    <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
                        instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">_ARouter</span>();
                    }
                }
            }
            <span class="hljs-keyword">return</span> instance;
        }
    }

    <span class="hljs-comment">/**
     * Build postcard by path and default group
     */</span>
    <span class="hljs-keyword">protected</span> Postcard <span class="hljs-title function_">build</span><span class="hljs-params">(String path)</span> {
        <span class="hljs-keyword">if</span> (TextUtils.isEmpty(path)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerException</span>(Consts.TAG + <span class="hljs-string">"Parameter is invalid!"</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-type">PathReplaceService</span> <span class="hljs-variable">pService</span> <span class="hljs-operator">=</span> ARouter.getInstance().navigation(PathReplaceService.class);
            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != pService) {
                <span class="hljs-comment">//替换path</span>
                path = pService.forString(path);
            }
            <span class="hljs-keyword">return</span> build(path, extractGroup(path), <span class="hljs-literal">true</span>);
        }
    }

    <span class="hljs-comment">//从传入的path中解析出group</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">extractGroup</span><span class="hljs-params">(String path)</span> {
        ...
        <span class="hljs-type">String</span> <span class="hljs-variable">defaultGroup</span> <span class="hljs-operator">=</span> path.substring(<span class="hljs-number">1</span>, path.indexOf(<span class="hljs-string">"/"</span>, <span class="hljs-number">1</span>));
        <span class="hljs-keyword">if</span> (TextUtils.isEmpty(defaultGroup)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerException</span>(Consts.TAG + <span class="hljs-string">"Extract the default group failed! There's nothing between 2 '/'!"</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> defaultGroup;
        }
        ...
    }

    <span class="hljs-comment">/**
     * Build postcard by path and group
     * 通过path和group拿到Postcard
     */</span>
    <span class="hljs-keyword">protected</span> Postcard <span class="hljs-title function_">build</span><span class="hljs-params">(String path, String group, Boolean afterReplace)</span> {
        ...
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Postcard</span>(path, group);
    }

}
</code></pre>
<p>第25行先判断，如果path为空抛出异常，如果想替换path，可以写一个类实现PathReplaceService接口。接着调用第33行的build()方法，这里从path中解析出group，最后新建Postcard实例，传入path和group。Postcard从名字翻译过来是明信片的意思，其承载了一次路由需要的所有信息，Postcard代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * A container that contains the roadmap.
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Postcard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RouteMeta</span> {

    <span class="hljs-keyword">private</span> Uri uri;
    <span class="hljs-keyword">private</span> Bundle mBundle; <span class="hljs-comment">// Data to transform</span>

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Postcard</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Postcard</span><span class="hljs-params">(String path, String group)</span> {
        <span class="hljs-built_in">this</span>(path, group, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Postcard</span><span class="hljs-params">(String path, String group, Uri uri, Bundle bundle)</span> {
        setPath(path);
        setGroup(group);
        setUri(uri);
        <span class="hljs-built_in">this</span>.mBundle = (<span class="hljs-literal">null</span> == bundle ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bundle</span>() : bundle);
    }


    <span class="hljs-comment">/**
     * Navigation to the route with path in postcard.
     * No param, will be use application context.
     */</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">navigation</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> navigation(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">/**
     * Navigation to the route with path in postcard.
     *
     * <span class="hljs-doctag">@param</span> context Activity and so on.
     */</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">navigation</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-keyword">return</span> navigation(context, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">/**
     * Navigation to the route with path in postcard.
     *
     * <span class="hljs-doctag">@param</span> context Activity and so on.
     */</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">navigation</span><span class="hljs-params">(Context context, NavigationCallback callback)</span> {
        <span class="hljs-keyword">return</span> ARouter.getInstance().navigation(context, <span class="hljs-built_in">this</span>, -<span class="hljs-number">1</span>, callback);
    }
}
</code></pre>
<p>Postcard继承自路由元信息RouteMeta，传入path和group实际调用的是RouteMeta的setPath()方法和setGroup()方法，对RouteMeta中的path和group成员变量赋值：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
* It contains basic route information.
*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RouteMeta</span> {
    <span class="hljs-keyword">private</span> RouteType type; <span class="hljs-comment">// Type of route</span>
    <span class="hljs-keyword">private</span> Element rawType; <span class="hljs-comment">// Raw type of route</span>
    <span class="hljs-keyword">private</span> Class&lt;?&gt; destination; <span class="hljs-comment">// Destination</span>
    <span class="hljs-keyword">private</span> String path; <span class="hljs-comment">// Path of route</span>
    <span class="hljs-keyword">private</span> String group; <span class="hljs-comment">// Group of route</span>

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPath</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> path;
    }

    <span class="hljs-keyword">public</span> RouteMeta <span class="hljs-title function_">setPath</span><span class="hljs-params">(String path)</span> {
        <span class="hljs-built_in">this</span>.path = path;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getGroup</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> group;
    }

    <span class="hljs-keyword">public</span> RouteMeta <span class="hljs-title function_">setGroup</span><span class="hljs-params">(String group)</span> {
        <span class="hljs-built_in">this</span>.group = group;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }
}
</code></pre>
<p>接下来看看navigation()方法做了什么？</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Postcard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RouteMeta</span> {

    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">navigation</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> navigation(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">/**
    * Navigation to the route with path in postcard.
    *
    * <span class="hljs-doctag">@param</span> context Activity and so on.
    */</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">navigation</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-keyword">return</span> navigation(context, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">/**
    * Navigation to the route with path in postcard.
    *
    * <span class="hljs-doctag">@param</span> context Activity and so on.
    */</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">navigation</span><span class="hljs-params">(Context context, NavigationCallback callback)</span> {
        <span class="hljs-keyword">return</span> ARouter.getInstance().navigation(context, <span class="hljs-built_in">this</span>, -<span class="hljs-number">1</span>, callback);
    }
} 
</code></pre>
<p>调用了ARouter的navigation()方法并传入Postcard实例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ARouter</span> {

    <span class="hljs-comment">/**
    * Launch the navigation.
    */</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">navigation</span><span class="hljs-params">(Context mContext, Postcard postcard, <span class="hljs-type">int</span> requestCode, NavigationCallback callback)</span> {
        <span class="hljs-keyword">return</span> _ARouter.getInstance().navigation(mContext, postcard, requestCode, callback);
    }
}
</code></pre>
<p>这里又调用了_ARouter的navigation()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">_ARouter</span> {
    <span class="hljs-comment">/**
     * Use router navigation.
     */</span>
    <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">navigation</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Context context, <span class="hljs-keyword">final</span> Postcard postcard, <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> requestCode, <span class="hljs-keyword">final</span> NavigationCallback callback)</span> {
        <span class="hljs-comment">//若有PretreatmentService的实现，就进行预处理，可以在真正路由前进行一些判断然后中断路由。</span>
        <span class="hljs-type">PretreatmentService</span> <span class="hljs-variable">pretreatmentService</span> <span class="hljs-operator">=</span> ARouter.getInstance().navigation(PretreatmentService.class);
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != pretreatmentService &amp;&amp; !pretreatmentService.onPretreatment(context, postcard)) {
            <span class="hljs-comment">// Pretreatment failed, navigation canceled.</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-comment">// Set context to postcard.</span>
        postcard.setContext(<span class="hljs-literal">null</span> == context ? mContext : context);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//标记1，通过routeMeta完善postcard</span>
            LogisticsCenter.completion(postcard);
        } <span class="hljs-keyword">catch</span> (NoRouteFoundException ex) {
            logger.warning(Consts.TAG, ex.getMessage());

            <span class="hljs-comment">//没有找到路由的回调</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != callback) {
                callback.onLost(postcard);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// No callback for this invoke, then we use the global degrade service.</span>
                <span class="hljs-type">DegradeService</span> <span class="hljs-variable">degradeService</span> <span class="hljs-operator">=</span> ARouter.getInstance().navigation(DegradeService.class);
                <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != degradeService) {
                    degradeService.onLost(context, postcard);
                }
            }

            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-comment">//找到路由的回调</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != callback) {
            callback.onFound(postcard);
        }

        <span class="hljs-comment">//不是绿色通道，要走拦截器</span>
        <span class="hljs-keyword">if</span> (!postcard.isGreenChannel()) { <span class="hljs-comment">// It must be run in async thread, maybe interceptor cost too mush time made ANR.</span>
            interceptorService.doInterceptions(postcard, <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterceptorCallback</span>() {
                <span class="hljs-comment">/**
                 * Continue process
                 *
                 * <span class="hljs-doctag">@param</span> postcard route meta
                 */</span>
                <span class="hljs-comment">//拦截器处理结果：继续路由</span>
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onContinue</span><span class="hljs-params">(Postcard postcard)</span> {
                    _navigation(postcard, requestCode, callback);
                }

                <span class="hljs-comment">/**
                 * Interrupt process, pipeline will be destory when this method called.
                 *
                 * <span class="hljs-doctag">@param</span> exception Reson of interrupt.
                 */</span>
                <span class="hljs-comment">//拦截器处理结果：中断路由，回调中断</span>
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onInterrupt</span><span class="hljs-params">(Throwable exception)</span> {
                    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != callback) {
                        callback.onInterrupt(postcard);
                    }

                    logger.info(Consts.TAG, <span class="hljs-string">"Navigation failed, termination by interceptor : "</span> + exception.getMessage());
                }
            });
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">//标记2，绿色通道，不走拦截器，获取路由结果</span>
            <span class="hljs-keyword">return</span> _navigation(postcard, requestCode, callback);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<p>我们先看看<strong>标记1</strong>处代码做了什么：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogisticsCenter</span> {

    <span class="hljs-comment">/**
     * Completion the postcard by route metas
     *
     * <span class="hljs-doctag">@param</span> postcard Incomplete postcard, should complete by this method.
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">completion</span><span class="hljs-params">(Postcard postcard)</span> {
        <span class="hljs-comment">//通过path去Warehouse.routes中拿RouteMeta</span>
        <span class="hljs-type">RouteMeta</span> <span class="hljs-variable">routeMeta</span> <span class="hljs-operator">=</span> Warehouse.routes.get(postcard.getPath());
        <span class="hljs-comment">//如果RouteMeta为空</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == routeMeta) {
            <span class="hljs-comment">// Maybe its does't exist, or didn't load.</span>
            <span class="hljs-comment">//如果Warehouse.groupsIndex中没有这个group，抛出异常</span>
            <span class="hljs-keyword">if</span> (!Warehouse.groupsIndex.containsKey(postcard.getGroup())) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoRouteFoundException</span>(TAG + <span class="hljs-string">"There is no route match the path ["</span> + postcard.getPath() + <span class="hljs-string">"], in group ["</span> + postcard.getGroup() + <span class="hljs-string">"]"</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// Load route and cache it into memory, then delete from metas.</span>
                <span class="hljs-comment">//重新调用group的loadInto()方法</span>
                addRouteGroupDynamic(postcard.getGroup(), <span class="hljs-literal">null</span>);

                <span class="hljs-comment">//重新执行completion()方法</span>
                completion(postcard); <span class="hljs-comment">// Reload</span>
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">//把routeMeta里面的配置传递给postcard</span>
            postcard.setDestination(routeMeta.getDestination());
            postcard.setType(routeMeta.getType());
            postcard.setPriority(routeMeta.getPriority());
            postcard.setExtra(routeMeta.getExtra());

            <span class="hljs-type">Uri</span> <span class="hljs-variable">rawUri</span> <span class="hljs-operator">=</span> postcard.getUri();
            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != rawUri) { <span class="hljs-comment">// Try to set params into bundle.</span>
                Map&lt;String, String&gt; resultMap = TextUtils.splitQueryParameters(rawUri);
                Map&lt;String, Integer&gt; paramsType = routeMeta.getParamsType();

                <span class="hljs-keyword">if</span> (MapUtils.isNotEmpty(paramsType)) {
                    <span class="hljs-comment">// Set value by its type, just for params which annotation by @Param</span>
                    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Integer&gt; params : paramsType.entrySet()) {
                        setValue(postcard,
                                params.getValue(),
                                params.getKey(),
                                resultMap.get(params.getKey()));
                    }

                    <span class="hljs-comment">// Save params name which need auto inject.</span>
                    postcard.getExtras().putStringArray(ARouter.AUTO_INJECT, paramsType.keySet().toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{}));
                }

                <span class="hljs-comment">// Save raw uri</span>
                postcard.withString(ARouter.RAW_URI, rawUri.toString());
            }

            <span class="hljs-keyword">switch</span> (routeMeta.getType()) {
                <span class="hljs-comment">//如果类型是PROVIDER</span>
                <span class="hljs-keyword">case</span> PROVIDER: <span class="hljs-comment">// if the route is provider, should find its instance</span>
                    <span class="hljs-comment">// Its provider, so it must implement IProvider</span>
                    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IProvider</span>&gt; providerMeta = (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IProvider</span>&gt;) routeMeta.getDestination();
                    <span class="hljs-comment">//去Warehouse.providers中获取实例</span>
                    <span class="hljs-type">IProvider</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> Warehouse.providers.get(providerMeta);
                    <span class="hljs-comment">//如果instance为null</span>
                    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == instance) { <span class="hljs-comment">// There's no instance of this provider</span>
                        IProvider provider;
                        <span class="hljs-keyword">try</span> {
                            <span class="hljs-comment">//反射创建实例</span>
                            provider = providerMeta.getConstructor().newInstance();
                            provider.init(mContext);
                            <span class="hljs-comment">//存入Warehouse.providers</span>
                            Warehouse.providers.put(providerMeta, provider);
                            instance = provider;
                        } <span class="hljs-keyword">catch</span> (Exception e) {
                            logger.error(TAG, <span class="hljs-string">"Init provider failed!"</span>, e);
                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerException</span>(<span class="hljs-string">"Init provider failed!"</span>);
                        }
                    }
                    <span class="hljs-comment">//传递给postcard</span>
                    postcard.setProvider(instance);
                    <span class="hljs-comment">// 设置greenChannel为true，跳过所有的拦截器</span>
                    postcard.greenChannel(); <span class="hljs-comment">// Provider should skip all of interceptors</span>
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> FRAGMENT:
                    postcard.greenChannel(); <span class="hljs-comment">// Fragment needn't interceptors</span>
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">break</span>;
            }
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addRouteGroupDynamic</span><span class="hljs-params">(String groupName, IRouteGroup group)</span> <span class="hljs-keyword">throws</span> NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException {
        <span class="hljs-keyword">if</span> (Warehouse.groupsIndex.containsKey(groupName)) {
            <span class="hljs-comment">// If this group is included, but it has not been loaded</span>
            <span class="hljs-comment">// load this group first, because dynamic route has high priority.</span>
            <span class="hljs-comment">//调用实例的loadInto()方法添加到Warehouse.routes </span>
            Warehouse.groupsIndex.get(groupName).getConstructor().newInstance().loadInto(Warehouse.routes);
            <span class="hljs-comment">//从Warehouse.groupsIndex中移除key为groupName的数据</span>
            Warehouse.groupsIndex.remove(groupName);
        }

        <span class="hljs-comment">// cover old group.</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != group) {
            group.loadInto(Warehouse.routes);
        }
    }
}
</code></pre>
<p>上面的completion()方法先去Warehouse.routes中拿RouteMeta，Warehouse就是前面存储路由信息的仓库，Warehouse.routes是其中缓存路由元信息的HashMap。判断如果RouteMeta为null，调用addRouteGroupDynamic()方法，去Warehouse.groupsIndex中取出缓存的类，使用反射创建该类的实例，然后调用其loadInto()方法，这样就调用了ARouter$$Group$$download.class的loadInto()方法，其代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ARouter$$Group$$download</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IRouteGroup</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadInto</span><span class="hljs-params">(Map&lt;String, RouteMeta&gt; atlas)</span> {
        atlas.put(<span class="hljs-string">"/download/DownloadActivity"</span>, RouteMeta.build(RouteType.ACTIVITY, DownloadActivity.class, <span class="hljs-string">"/download/downloadactivity"</span>, <span class="hljs-string">"download"</span>, <span class="hljs-literal">null</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">2147483648</span>));
        atlas.put(<span class="hljs-string">"/download/service"</span>, RouteMeta.build(RouteType.PROVIDER, DownloadServiceImpl.class, <span class="hljs-string">"/download/service"</span>, <span class="hljs-string">"download"</span>, <span class="hljs-literal">null</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">2147483648</span>));
    }
}
</code></pre>
<p>其loadInto()方法把RouteMeta通过build()方法创建的实例添加到Warehouse.routes中。</p>
<p>回到前面的代码，接着又调用了一次completion()方法，此时routeMeta不再为null，将routeMeta的配置信息（destination、type等信息）传递给postcard，如果routeMeta类型是PROVIDER，会反射创建实例并存入Warehouse.providers。然后判断是否是绿色通道，如果不是绿色通道，需要执行拦截器。如果是绿色通道会执行标记2处的代码开始准备跳转，标记2处代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> Object <span class="hljs-title function_">_navigation</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Postcard postcard, <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> requestCode, <span class="hljs-keyword">final</span> NavigationCallback callback)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">Context</span> <span class="hljs-variable">currentContext</span> <span class="hljs-operator">=</span> postcard.getContext();

    <span class="hljs-keyword">switch</span> (postcard.getType()) {
        <span class="hljs-keyword">case</span> ACTIVITY:
            <span class="hljs-comment">// Build intent</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(currentContext, postcard.getDestination());
            intent.putExtras(postcard.getExtras());

            <span class="hljs-comment">// Set flags.</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">flags</span> <span class="hljs-operator">=</span> postcard.getFlags();
            <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != flags) {
                intent.setFlags(flags);
            }

            <span class="hljs-comment">// Non activity, need FLAG_ACTIVITY_NEW_TASK</span>
            <span class="hljs-keyword">if</span> (!(currentContext <span class="hljs-keyword">instanceof</span> Activity)) {
                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
            }

            <span class="hljs-comment">// Set Actions</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">action</span> <span class="hljs-operator">=</span> postcard.getAction();
            <span class="hljs-keyword">if</span> (!TextUtils.isEmpty(action)) {
                intent.setAction(action);
            }

            <span class="hljs-comment">// Navigation in main looper.</span>
            runInMainThread(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                    startActivity(requestCode, currentContext, intent, postcard, callback);
                }
            });

            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> PROVIDER:
            <span class="hljs-keyword">return</span> postcard.getProvider();
        <span class="hljs-keyword">case</span> BOARDCAST:
        <span class="hljs-keyword">case</span> CONTENT_PROVIDER:
        <span class="hljs-keyword">case</span> FRAGMENT:
            <span class="hljs-comment">//Broadcast、ContentProvider、Fragment，都是使用postcard.getDestination()反射创建实例</span>
            Class&lt;?&gt; fragmentMeta = postcard.getDestination();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> fragmentMeta.getConstructor().newInstance();
                <span class="hljs-keyword">if</span> (instance <span class="hljs-keyword">instanceof</span> Fragment) {
                    ((Fragment) instance).setArguments(postcard.getExtras());
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (instance <span class="hljs-keyword">instanceof</span> android.support.v4.app.Fragment) {
                    ((android.support.v4.app.Fragment) instance).setArguments(postcard.getExtras());
                }

                <span class="hljs-keyword">return</span> instance;
            } <span class="hljs-keyword">catch</span> (Exception ex) {
                logger.error(Consts.TAG, <span class="hljs-string">"Fetch fragment instance error, "</span> + TextUtils.formatStackTrace(ex.getStackTrace()));
            }
        <span class="hljs-keyword">case</span> METHOD:
        <span class="hljs-keyword">case</span> SERVICE:
        <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p>在这里先判断postcard的RouteType，RouteType是一个枚举：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">RouteType</span> {
    ACTIVITY(<span class="hljs-number">0</span>, <span class="hljs-string">"android.app.Activity"</span>),
    SERVICE(<span class="hljs-number">1</span>, <span class="hljs-string">"android.app.Service"</span>),
    PROVIDER(<span class="hljs-number">2</span>, <span class="hljs-string">"com.alibaba.android.arouter.facade.template.IProvider"</span>),
    CONTENT_PROVIDER(-<span class="hljs-number">1</span>, <span class="hljs-string">"android.app.ContentProvider"</span>),
    BOARDCAST(-<span class="hljs-number">1</span>, <span class="hljs-string">""</span>),
    METHOD(-<span class="hljs-number">1</span>, <span class="hljs-string">""</span>),
    FRAGMENT(-<span class="hljs-number">1</span>, <span class="hljs-string">"android.app.Fragment"</span>),
    UNKNOWN(-<span class="hljs-number">1</span>, <span class="hljs-string">"Unknown route type"</span>);
    ...
}    
</code></pre>
<p>如果是Activity，就把postcard里面的参数传递给Intent，最终调用startActivity()方法进行跳转；如果是Provider，直接通过postcard.getProvider()拿到IProvier的实现类的单例；Broadcast、ContentProvider、Fragment都是使用postcard.getDestination()反射创建实例并返回。</p>
<p><strong>参考资料：</strong>
<a href="https://juejin.cn/post/7200041752470749243" target="_blank" title="https://juejin.cn/post/7200041752470749243">juejin.cn/post/720004…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 时代的“黑箱问题”：理解与信任的边界]]></title>    <link>https://juejin.cn/post/7598024433912135734</link>    <guid>https://juejin.cn/post/7598024433912135734</guid>    <pubDate>2026-01-23T02:40:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598024433912135734" data-draft-id="7598112768146882566" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 时代的“黑箱问题”：理解与信任的边界"/> <meta itemprop="keywords" content="人工智能,前端框架,AIGC"/> <meta itemprop="datePublished" content="2026-01-23T02:40:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 时代的“黑箱问题”：理解与信任的边界
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T02:40:38.000Z" title="Fri Jan 23 2026 02:40:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h4 data-id="heading-0">引言</h4>
<p>随着人工智能（AI）在各个行业的广泛应用，AI模型在决策支持、自动化以及预测分析等方面展现了巨大的潜力。然而，随着AI技术的复杂性不断提高，尤其是深度学习等高级算法的出现，“黑箱问题”也日益突出。黑箱问题指的是即使AI系统能够做出准确的预测和决策，我们却无法完全理解其内部的决策过程。这种缺乏透明度的特性，给AI的应用带来了信任和责任的挑战。在医疗、金融、法律等对决策有严格要求的领域，这个问题尤为重要。本文将探讨AI黑箱问题的成因、解决方案，以及如何在AI时代找到理解与信任的平衡。</p>
<h4 data-id="heading-1">1. 黑箱问题的定义与背景</h4>
<p>“黑箱”是指输入信息进入一个系统后，系统产生输出，但我们无法窥见其内部过程的状态或机制。对于传统的算法和模型，人们可以直接理解每一步的操作过程，而深度神经网络等复杂AI模型却是高度非线性的，甚至是数百万个参数的集合。这种高度复杂性使得其行为变得不可预测，尤其是在遇到新情况时。</p>
<p>黑箱问题主要体现在以下几个方面：</p>
<ul>
<li><strong>缺乏透明性</strong>：AI模型的决策过程难以解释，普通用户很难理解算法是如何得出某个结论的。</li>
<li><strong>不可控性</strong>：AI系统可能因为训练数据的偏差或算法设计的缺陷，做出不可预知或不公平的决策。</li>
<li><strong>信任危机</strong>：没有清晰的决策路径，用户和开发者很难建立对AI模型的信任，尤其是在关键领域，如金融风控和医疗诊断。</li>
</ul>
<p>例如，在医疗诊断中，AI模型可能给出一个癌症诊断的结果，但医生或患者无法理解模型是基于哪些数据特征得出的结论。这种“黑箱”特性可能导致对AI判断的质疑，尤其在没有解释的情况下，人们更倾向于质疑其正确性。</p>
<h4 data-id="heading-2">2. 解决方案与技术实现</h4>
<p>为了应对AI黑箱问题，研究者和工程师们提出了多个可行的解决方案，目的是提高模型的可解释性和透明度。以下是一些主流方法：</p>
<h5 data-id="heading-3">2.1 解释性AI（Explainable AI, XAI）</h5>
<p>解释性AI旨在构建具有可解释性的模型，使得人类能够理解AI做出某个决策的原因。以下是几种常见的解释性AI方法：</p>
<ul>
<li>
<p><strong>LIME（Local Interpretable Model-agnostic Explanations）</strong> ：<br/>
LIME通过对原始复杂模型进行局部近似建模来解释其决策。它通过训练一个简单的、透明的模型（如线性回归或决策树）来近似复杂模型在特定输入上的表现，从而为其决策提供解释。</p>
<p>示例代码（Python）：</p>
<pre><code class="hljs language-ini" lang="ini">from lime.lime_tabular import LimeTabularExplainer
<span class="hljs-attr">explainer</span> = LimeTabularExplainer(X_train, training_labels=y_train, mode=<span class="hljs-string">'classification'</span>)
<span class="hljs-attr">explanation</span> = explainer.explain_instance(X_test[<span class="hljs-number">0</span>], model.predict_proba)
explanation.show_in_notebook()
</code></pre>
</li>
<li>
<p><strong>SHAP（SHapley Additive exPlanations）</strong> ：<br/>
SHAP值基于博弈论中的沙普利值（Shapley Value）来解释模型的输出。每个特征的SHAP值可以帮助我们理解该特征在预测中起到的作用。</p>
<p>示例代码（Python）：</p>
<pre><code class="hljs language-ini" lang="ini">import shap
<span class="hljs-attr">explainer</span> = shap.TreeExplainer(model)
<span class="hljs-attr">shap_values</span> = explainer.shap_values(X_test)
shap.summary_plot(shap_values, X_test)
</code></pre>
</li>
</ul>
<h5 data-id="heading-4">2.2 可解释模型的设计</h5>
<p>与复杂的黑箱模型相比，某些模型天生更具可解释性。例如，决策树、线性回归和逻辑回归等模型通常可以提供直观的特征权重和决策路径。因此，在一些场景下，选择可解释性更强的模型可能是解决黑箱问题的有效途径。</p>
<h5 data-id="heading-5">2.3 透明的模型训练过程</h5>
<p>另一种解决黑箱问题的方法是通过增强模型训练过程的透明度。例如，采用公平性和透明度算法，记录模型训练中的每一个步骤，并对训练数据和结果进行公开披露。这种方法不仅能提高模型的可解释性，也能增强模型的社会信任。</p>
<h5 data-id="heading-6">2.4 后处理和可视化工具</h5>
<p>一些可视化工具（如TensorBoard、FeatureViz）可以帮助开发者更好地理解AI模型的行为。这些工具通过可视化高维数据，帮助人们看到不同特征如何影响模型的决策。</p>
<h4 data-id="heading-7">3. 优缺点分析及实际应用建议</h4>
<h5 data-id="heading-8">3.1 优点</h5>
<ul>
<li><strong>增强信任</strong>：通过增加模型的可解释性，可以使得用户更加信任AI系统，特别是在涉及法律责任和伦理问题的领域。</li>
<li><strong>问题诊断</strong>：解释性AI可以帮助开发者理解模型的局限性和潜在的错误，从而在出现问题时可以快速调整模型。</li>
<li><strong>合规性</strong>：在一些行业中，如金融和医疗，提供模型决策的可解释性是符合行业规定的。</li>
</ul>
<h5 data-id="heading-9">3.2 缺点</h5>
<ul>
<li><strong>计算开销</strong>：一些可解释AI方法，如LIME和SHAP，可能需要额外的计算资源，尤其是在处理大型数据集时。</li>
<li><strong>准确性 vs. 可解释性</strong>：某些高可解释性模型（如决策树）在准确性上可能不如深度学习模型。因此，在实际应用中，可能需要在准确性和可解释性之间找到平衡。</li>
<li><strong>限制性</strong>：对于某些复杂的AI模型（尤其是深度神经网络），即使采用可解释性技术，解释的深度和细致程度也可能有限。</li>
</ul>
<h5 data-id="heading-10">实际应用建议：</h5>
<ul>
<li>在对可解释性要求较高的领域（如医疗、金融、法律）中，优先考虑使用具有良好可解释性的模型，或者结合黑箱模型与解释性方法。</li>
<li>对于大规模的AI应用，建议定期审计模型的决策过程，并结合透明的训练过程，确保AI系统在实际应用中的公平性和可靠性。</li>
</ul>
<h4 data-id="heading-11">4. 结论</h4>
<p>AI的“黑箱问题”是当前AI技术发展的一个重大挑战。尽管深度学习等复杂算法在许多任务中表现卓越，但它们的黑箱特性限制了人们对其结果的理解与信任。通过发展解释性AI、选择可解释的模型以及提升训练过程的透明度，AI的黑箱问题可以得到一定程度的解决。然而，如何在准确性和可解释性之间找到平衡，仍然是未来技术发展的关键。</p>
<p>随着技术的不断进步，我们有理由相信，AI的透明性和可解释性将逐步提升，从而为各行各业带来更多的信任和价值。</p>
<h4 data-id="heading-12">5. 附录与参考资料</h4>
<ul>
<li>
<p><strong>相关书籍</strong>：</p>
<ul>
<li>《深度学习》- Ian Goodfellow, Yoshua Bengio, Aaron Courville</li>
<li>《可解释的人工智能》- Christoph Molnar</li>
</ul>
</li>
<li>
<p><strong>相关论文</strong>：</p>
<ul>
<li>Ribeiro, M. T., Singh, S., &amp; Guestrin, C. (2016). “Why should I trust you?” Explaining the predictions of any classifier.</li>
<li>Lundberg, S. M., &amp; Lee, S. I. (2017). A unified approach to interpreting model predictions.</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rust 所有权总结（By Gemini）]]></title>    <link>https://juejin.cn/post/7598083101361242118</link>    <guid>https://juejin.cn/post/7598083101361242118</guid>    <pubDate>2026-01-23T02:45:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598083101361242118" data-draft-id="7598029481508798483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rust 所有权总结（By Gemini）"/> <meta itemprop="keywords" content="Rust,Gemini,操作系统"/> <meta itemprop="datePublished" content="2026-01-23T02:45:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mCell"/> <meta itemprop="url" content="https://juejin.cn/user/2280829967146779"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rust 所有权总结（By Gemini）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2280829967146779/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mCell
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T02:45:59.000Z" title="Fri Jan 23 2026 02:45:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>所有权（Ownership）是 Rust 的核心灵魂。要理解它，最关键的是分清<strong>数据是存在“栈（Stack）”上还是“堆（Heap）”上</strong>。</p>
<p>这是对所有权系统及其行为差异的深度总结：</p>
<hr/>
<h2 data-id="heading-0">1. 所有权的三大基本规则</h2>
<ol>
<li>Rust 中的每一个值都有一个被称为其 <strong>所有者（owner）</strong> 的变量。</li>
<li>同一时间，值有且只有一个所有者。</li>
<li>当所有者（变量）离开作用域时，这个值将被立即销毁（Drop）。</li>
</ol>
<hr/>
<h2 data-id="heading-1">2. 行为差异：基础类型 vs. 引用/复杂类型</h2>
<p>在处理赋值（<code>let y = x</code>）或函数传参时，不同类型的表现完全不同：</p>
<h3 data-id="heading-2">A. 基础类型：Copy 语义（栈）</h3>
<ul>
<li>
<p><strong>涉及类型：</strong> <code>i32</code>, <code>f64</code>, <code>bool</code>, <code>char</code> 以及只包含这些类型的 <code>tuple</code>。</p>
</li>
<li>
<p><strong>行为：</strong> 它们的大小在编译期已知，直接存储在<strong>栈</strong>上。赋值时会执行<strong>深拷贝</strong>。</p>
</li>
<li>
<p><strong>结果：</strong> 旧变量依然有效。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span> = <span class="hljs-number">5</span>;
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">y</span> = x; <span class="hljs-comment">// 复制了一份 5</span>
<span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, x); <span class="hljs-comment">// 仍然可用，没问题</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-3">B. 复杂类型：Move 语义（堆）</h3>
<ul>
<li>
<p><strong>涉及类型：</strong> <code>String</code>, <code>Vec&lt;T&gt;</code>, <code>Box&lt;T&gt;</code> 以及自定义结构体（默认情况下）。</p>
</li>
<li>
<p><strong>行为：</strong> 数据存在<strong>堆</strong>上，变量本身只是一个指向堆内存的“指针/元数据”（存在栈上）。赋值时执行<strong>移动（Move）</strong> 。</p>
</li>
<li>
<p><strong>结果：</strong> 旧变量<strong>立即失效</strong>，防止双重释放（Double Free）内存。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s1</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s2</span> = s1; <span class="hljs-comment">// 所有权转移给了 s2</span>
<span class="hljs-comment">// println!("{}", s1); // 报错！s1 已经变成了“空壳”</span>
</code></pre>
</li>
</ul>
<hr/>
<h2 data-id="heading-4">3. 借用（Borrowing）：引用的行为</h2>
<p>为了避免频繁转移所有权，Rust 引入了引用（<code>&amp;</code>）。借用不获取所有权，只是“租用”数据。</p>
<h3 data-id="heading-5">不可变引用 <code>&amp;T</code>（共享借用）</h3>
<ul>
<li><strong>行为：</strong> 像只读模式。</li>
<li><strong>约束：</strong> 同一时间可以有<strong>无数个</strong>不可变引用。</li>
<li><strong>底层：</strong> 只是一个指向原始数据的指针。</li>
</ul>
<h3 data-id="heading-6">可变引用 <code>&amp;mut T</code>（独占借用）</h3>
<ul>
<li><strong>行为：</strong> 像写模式。</li>
<li><strong>约束：</strong> 同一时间只能有<strong>一个</strong>可变引用，且此时不能有任何不可变引用。</li>
<li><strong>目的：</strong> 彻底杜绝<strong>数据竞争（Data Race）</strong> 。</li>
</ul>
<hr/>
<h2 data-id="heading-7">4. 总结对比表</h2>









































<table><thead><tr><th><strong>特性</strong></th><th><strong>基础类型 (Copy)</strong></th><th><strong>复杂类型 (Move)</strong></th><th><strong>引用 (Borrowing)</strong></th></tr></thead><tbody><tr><td><strong>内存位置</strong></td><td>栈 (Stack)</td><td>堆 (Heap)</td><td>指向栈或堆的指针</td></tr><tr><td><strong>赋值操作</strong></td><td>复制值</td><td>转移所有权</td><td>传递指针</td></tr><tr><td><strong>旧变量是否可用</strong></td><td>是</td><td>否</td><td>是（但在借用期间受限）</td></tr><tr><td><strong>性能开销</strong></td><td>极小</td><td>极小（仅复制元数据）</td><td>极小</td></tr><tr><td><strong>适用场景</strong></td><td>简单数值计算</td><td>大规模数据管理</td><td>临时访问/函数传参</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">5. 进阶核心：切片（Slice）</h2>
<p>切片（如 <code>&amp;str</code> 或 <code>&amp;[i32]</code>）是一种特殊的引用。它不拥有所有权，但它不仅包含指针，还包含一个<strong>长度</strong>。它是对集合中一段连续内存的“观察窗口”。</p>
<blockquote>
<p><strong>一句话总结：</strong></p>
<p>基础类型靠“复印”，复杂类型靠“接力棒”，而引用则是“看一眼”或“修一下”。</p>
</blockquote>
<p><strong>看完这个总结，你觉得练习 2（关于 <code>ref1</code> 和 <code>ref3</code> 冲突那道题）的答案是什么？</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[清华开源！这个 GitHub 项目重新定义端侧 Agent 智能体 。]]></title>    <link>https://juejin.cn/post/7598099064443273279</link>    <guid>https://juejin.cn/post/7598099064443273279</guid>    <pubDate>2026-01-23T02:46:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598099064443273279" data-draft-id="7598021313871265798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="清华开源！这个 GitHub 项目重新定义端侧 Agent 智能体 。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-01-23T02:46:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            清华开源！这个 GitHub 项目重新定义端侧 Agent 智能体 。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T02:46:12.000Z" title="Fri Jan 23 2026 02:46:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>清华大学、<strong>中国人民大学</strong>、<strong>面壁智能</strong>与 <strong>OpenBMB 开源社区</strong>联合开源了一个智能体，叫做 AgentCPM，它重新定义了端侧智能体天花板。</p>
<p>AgentCPM 最亮眼的是以小博大。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46286cc603024e398eed271107808bab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769741171&amp;x-signature=0Y7E4B4F%2BVELdKy1tc3SgouS4fY%3D" alt="图片" loading="lazy"/></p>
<p>仅 <strong>4B 参数</strong>的模型，在复杂的长程深度探索任务上，实现了超越同尺寸 SOTA、甚至比肩 30B 级和部分闭源大模型的性能。</p>
<p>开源后获得广泛的关注，目前已经登上 HuggingFace 的热榜了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01ae5ce80f9a47849718a1415f91bef1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769741171&amp;x-signature=11%2BfSMfJngTbzxQZ20jWnwzfMT4%3D" alt="图片" loading="lazy"/></p>
<p>01</p>
<p><strong>开源项目简介</strong></p>
<p><strong>AgentCPM-Explore</strong> 是这个开源项目的核心模型，专注于解决长周期、多步交互的复杂任务。</p>
<p>它是基于 Qwen3-4B-thinking-2507 进行深度后训练。是首个具备 GAIA、Xbench、Browsercomp 等 8 个高难度智能体任务处理能力的 4B 端侧模型。</p>
<p>在多个榜单上超越了 8B 级 SOTA 模型，甚至在 Xbench-DeepResearch 上表现优于 OpenAI-o3 和 Claude-3.5-Sonnet。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d4d23d09e3544ca8d4d362baf0d1b71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769741171&amp;x-signature=1PWgr3Wujadn2JYgwixcjw3BgJw%3D" alt="图片" loading="lazy"/></p>
<p>牛的是，它支持最高超过 <strong>100 轮</strong>的不重复且稳定的环境交互，能够持续深度探索直至任务完成。</p>
<p>在允许重复尝试的情况下，能够解决 GAIA 文本任务中 95% 以上的题目。</p>
<p>而且，它不像其它的小模型死记硬背。</p>
<p>而是具备质疑工具、追求原始数据、灵活调整策略及执着寻找信源等特征的类人思考逻辑。</p>
<p>能够像经验丰富的人类研究员一样，通过主动核查、多源验证和战术变通高效解决复杂难题。</p>
<p>AgentCPM 不仅开源了模型权重，还开源了从 Base 模型进化到 SOTA 模型的全套基础设施，支持开发者复现、二开和私有化部署。</p>
<p>比如 AgentDock 工具沙盒统一管理调度平台，AgentRL 是极简高效的异步强化学习框架，还有 AgentToLeaP 智能体能力一键式评测平台。</p>
<p>02</p>
<p><strong>如何使用</strong></p>
<p>部署安装 AgentCPM-Explore 主要分为两个核心部分，先部署工具沙盒环境  AgentDock) ，然后是配置并运行智能体模型 AgentCPM-Explore。</p>
<p>① 克隆项目代码</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/OpenBMB/AgentCPM.gitcd AgentCPM/AgentCPM-Explore
</code></pre>
<p>② 部署工具沙盒环境  AgentDock</p>
<p>这是关键一步，它为智能体提供了统一的工具调用服务。</p>
<p>1. 进入 AgentDock 目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> AgentDock
</code></pre>
<p>2. 一键启动所有服务：</p>
<p>使用 docker-compose 命令启动管理面板、数据库和工具节点。</p>
<pre><code class="hljs">docker compose up -d
</code></pre>
<p>此命令会在后台启动所有必要的服务。您可以使用 docker ps 命令检查服务是否正常运行。</p>
<p>3. 验证部署：</p>
<p>工具沙盒默认运行在 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8000%25E3%2580%2582" target="_blank" title="http://localhost:8000%E3%80%82" ref="nofollow noopener noreferrer">http://localhost:8000。</a></p>
<p>您可以通过访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8000%2Fhealth" target="_blank" title="http://localhost:8000/health" ref="nofollow noopener noreferrer">http://localhost:8000/health</a> 来检查服务是否健康。如果返回 JSON 格式的健康状态信息，则说明部署成功。</p>
<p>③ 配置并运行智能体模型 AgentCPM-Explore</p>
<p>文档推荐在预置的 Docker 评测环境中进行操作，以避免环境依赖问题。</p>
<p>1. 拉取并进入预置环境：</p>
<pre><code class="hljs language-javascript" lang="javascript"># 确保当前在 <span class="hljs-title class_">AgentCPM</span>-<span class="hljs-title class_">Explore</span> 项目根目录# 拉取预置的 <span class="hljs-title class_">Docker</span> 镜像docker pull yuyangfu/agenttoleap-<span class="hljs-attr">eval</span>:v1<span class="hljs-number">.0</span># 启动一个容器，并将当前目录映射到容器内docker run -dit --name agenttoleap --gpus all --network host -v $(pwd):<span class="hljs-regexp">/workspace yuyangfu/</span>agenttoleap-<span class="hljs-attr">eval</span>:v1<span class="hljs-number">.0</span># 进入容器docker exec -it agenttoleap /bin/bash# 在容器内进入项目工作目录cd /workspace
</code></pre>
<p>2. 配置运行参数：</p>
<p>编辑项目根目录下的 quickstart.py 文件，找到 [USER CONFIGURATION] 部分，根据你的需求配置一下。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40f89203790341f5ad367a386f3a76a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769741171&amp;x-signature=caBdI6AIW1bdddG1PxNvR%2FFVCGc%3D" alt="图片" loading="lazy"/></p>
<p>3. 运行智能体任务：</p>
<p>完成配置后，运行 QuickStart 脚本。</p>
<pre><code class="hljs">python quickstart.py
</code></pre>
<p>脚本会自动执行您定义的任务，展示智能体的完整交互过程，比如思考、工具调用、结果生成。</p>
<p>④ 查看运行结果</p>
<p>任务执行完成后，结果会保存在 outputs/quickstart_results/ 目录下。</p>
<p>您可以查看其中的 dialog.json 文件，它记录了完整的任务执行轨迹，包括智能体的思考链、每次工具调用的请求与响应以及最终答案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[多平台架构交互设计与方案：移动、PC、Pad的无缝响应式集成]]></title>    <link>https://juejin.cn/post/7598099064443404351</link>    <guid>https://juejin.cn/post/7598099064443404351</guid>    <pubDate>2026-01-23T02:52:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598099064443404351" data-draft-id="7598112768147013638" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="多平台架构交互设计与方案：移动、PC、Pad的无缝响应式集成"/> <meta itemprop="keywords" content="前端,架构,响应式设计"/> <meta itemprop="datePublished" content="2026-01-23T02:52:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            多平台架构交互设计与方案：移动、PC、Pad的无缝响应式集成
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T02:52:57.000Z" title="Fri Jan 23 2026 02:52:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h4 data-id="heading-0">引言</h4>
<p>在当今多设备、跨平台的数字世界中，用户期望能够在不同的设备上流畅无缝地体验应用。无论是移动端、PC端还是Pad端，每个平台的界面和交互设计都存在不同的特点和需求。因此，如何设计一个能在多个平台间自适应并提供一致体验的架构，成为了技术开发者面临的一个重要挑战。本文将深入探讨如何在多个平台（移动、PC、Pad）之间进行架构交互设计，保证响应式设计的无缝集成，并提出解决方案，帮助开发者构建跨平台的一致体验。</p>
<h4 data-id="heading-1">1. 问题定义与背景</h4>
<p>随着移动互联网的快速发展，应用的使用场景已经不仅仅局限于单一设备，用户越来越多地在不同设备间切换。例如，同一个用户可能在出门时使用手机浏览网页，回到办公室后则使用PC端完成更复杂的操作，甚至在平板上进行更便捷的娱乐或文档处理。这种设备间的频繁切换要求开发者提供一个无缝且一致的用户体验。</p>
<p><strong>主要问题包括</strong>：</p>
<ul>
<li><strong>平台间一致性</strong>：不同设备的屏幕尺寸、输入方式（触摸、鼠标、键盘）、硬件能力等差异使得跨平台设计成为一项复杂任务。</li>
<li><strong>响应式设计</strong>：如何在不同屏幕尺寸下，动态调整布局和功能，确保界面元素始终易于操作且可访问。</li>
<li><strong>架构适配</strong>：多平台架构要求对不同平台的交互设计进行适配和优化，避免重复开发和资源浪费。</li>
<li><strong>性能和加载速度</strong>：跨平台应用需要保证高效的性能，无论是在高性能PC端还是资源有限的移动端，都能提供流畅的体验。</li>
</ul>
<p>因此，如何设计一个能够支持多个平台，并在不同平台间实现无缝切换的系统架构和交互设计，成为了技术团队需要重点考虑的问题。</p>
<h4 data-id="heading-2">2. 解决方案与技术实现</h4>
<p>为了实现移动、PC、Pad之间的无缝响应式集成，开发者需要采用适应性设计、响应式布局和统一的开发架构。以下是一些具体的解决方案与技术实现方法：</p>
<h5 data-id="heading-3">2.1 响应式设计（Responsive Design）</h5>
<p>响应式设计的核心思想是通过CSS媒体查询（Media Query）和灵活布局，动态适配不同屏幕尺寸的设备。常用的技术包括：</p>
<ul>
<li><strong>CSS Grid和Flexbox</strong>：这两种CSS布局方式可以帮助创建灵活的网格布局，使得界面元素可以根据屏幕宽度自动调整。</li>
<li><strong>媒体查询（Media Queries）</strong> ：根据不同的设备特性（如屏幕宽度、分辨率、方向等），动态调整页面样式。</li>
</ul>
<p>示例代码：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 针对大屏PC端 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">1024px</span>) {
  <span class="hljs-selector-class">.container</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-direction</span>: row;
  }
}

<span class="hljs-comment">/* 针对平板和移动设备 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">1024px</span>) {
  <span class="hljs-selector-class">.container</span> {
    <span class="hljs-attribute">display</span>: block;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  }
}
</code></pre>
<h5 data-id="heading-4">2.2 组件化与跨平台框架</h5>
<p>为了在不同平台上实现统一的用户体验，采用组件化设计和跨平台开发框架至关重要。以下是一些流行的跨平台技术：</p>
<ul>
<li><strong>React Native</strong>：适用于构建移动端和PC端应用，能够共享大部分代码。</li>
<li><strong>Flutter</strong>：Google推出的跨平台开发框架，支持iOS、Android、Web以及桌面端的应用开发，提供高度一致的用户体验。</li>
<li><strong>Electron</strong>：用于构建跨平台桌面应用，支持Windows、macOS和Linux。</li>
</ul>
<p>这些框架通过组件化开发，可以减少不同平台之间的重复代码，使得维护和开发变得更加高效。</p>
<h5 data-id="heading-5">2.3 设计适配与平台差异化</h5>
<p>尽管响应式设计和组件化开发能帮助我们在不同平台上实现一致性，但平台差异依然不可忽视。不同平台的交互方式（如触摸屏和鼠标输入）和性能需求不同，因此我们需要对每个平台的特性进行适配：</p>
<ul>
<li><strong>移动端</strong>：触摸屏操作频繁，需要关注按钮的大小、间距以及手势操作的支持。</li>
<li><strong>PC端</strong>：需要考虑鼠标操作、键盘快捷键、窗口大小等，界面上可以容纳更多的内容。</li>
<li><strong>Pad端</strong>：平板设备往往介于手机和PC之间，需要更加灵活的布局，适应不同的使用场景（例如横屏或竖屏）。</li>
</ul>
<p>为此，可以使用不同平台的特定API来进一步优化交互体验。例如：</p>
<ul>
<li>在<strong>移动端</strong>，可以通过使用Touch事件优化触摸操作；</li>
<li>在<strong>PC端</strong>，可以通过响应鼠标和键盘事件来增强交互。</li>
</ul>
<h5 data-id="heading-6">2.4 统一的后端架构与数据同步</h5>
<p>为了确保在不同平台之间无缝切换，统一的后端架构和数据同步至关重要。开发者可以选择RESTful API或GraphQL作为前后端通信的标准协议，确保数据能够在不同设备间实时同步。</p>
<ul>
<li><strong>RESTful API</strong>：标准的HTTP接口，适用于大多数应用场景，简单易用。</li>
<li><strong>GraphQL</strong>：一种灵活的查询语言，可以根据客户端的需要精确获取数据，避免不必要的数据加载。</li>
</ul>
<p>数据同步方案可以利用WebSocket或者Firebase等实时数据同步工具，实现不同平台的数据实时更新。</p>
<h4 data-id="heading-7">3. 优缺点分析与实际应用建议</h4>
<h5 data-id="heading-8">3.1 优点</h5>
<ul>
<li><strong>一致性体验</strong>：通过响应式设计和跨平台框架，可以实现不同平台上用户界面的统一性，使得用户无论在何种设备上使用应用，体验都十分流畅。</li>
<li><strong>开发效率</strong>：组件化设计和跨平台框架减少了重复开发，提高了开发效率，尤其是在多平台并行开发时。</li>
<li><strong>维护简化</strong>：统一的后端架构和数据同步机制，使得多平台应用的维护变得更加简洁和高效。</li>
</ul>
<h5 data-id="heading-9">3.2 缺点</h5>
<ul>
<li><strong>性能问题</strong>：某些跨平台框架（如React Native或Flutter）在某些平台上可能会面临性能瓶颈，尤其是在图形密集型应用中（如游戏、3D渲染等）。</li>
<li><strong>平台差异</strong>：尽管响应式设计和跨平台框架能够处理大部分情况，但某些平台差异仍需特别关注，例如移动端的触摸输入与PC端的鼠标输入之间的差异。</li>
</ul>
<h5 data-id="heading-10">实际应用建议：</h5>
<ul>
<li>在开发应用时，应根据目标平台的特点来选择合适的框架和技术。例如，对于需要极高性能的桌面应用，使用Electron可能会面临性能问题，可以考虑专门针对PC平台开发的技术栈。</li>
<li>在移动端和PC端的设计上，应通过用户测试来确定最佳的布局和交互方式，以确保用户在不同设备上的操作体验始终流畅。</li>
</ul>
<h4 data-id="heading-11">4. 结论</h4>
<p>在多平台架构的交互设计中，实现无缝响应式集成对于提升用户体验至关重要。通过采用响应式设计、跨平台开发框架、组件化开发以及统一的后端架构，我们能够在多个平台之间实现一致的功能和体验。然而，如何在性能和跨平台一致性之间取得平衡，仍然是开发者面临的挑战。随着技术的不断发展，未来可能会出现更多的解决方案，使得多平台开发变得更加高效和可靠。</p>
<h4 data-id="heading-12">5. 附录与参考资料</h4>
<ul>
<li>
<p><strong>相关书籍</strong>：</p>
<ul>
<li>《响应式Web设计：HTML5和CSS3实战》 - Ben Frain</li>
<li>《深入浅出React和Redux》 - 赵乾</li>
</ul>
</li>
<li>
<p><strong>相关技术栈</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freactnative.dev%2F" target="_blank" title="https://reactnative.dev/" ref="nofollow noopener noreferrer">React Native</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fflutter.dev%2F" target="_blank" title="https://flutter.dev/" ref="nofollow noopener noreferrer">Flutter</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.electronjs.org%2F" target="_blank" title="https://www.electronjs.org/" ref="nofollow noopener noreferrer">Electron</a></li>
</ul>
</li>
<li>
<p><strong>在线工具</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcss-tricks.com%2Fsnippets%2Fcss%2Fcomplete-guide-grid%2F" target="_blank" title="https://css-tricks.com/snippets/css/complete-guide-grid/" ref="nofollow noopener noreferrer">CSS Grid</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fflexboxfroggy.com%2F" target="_blank" title="https://flexboxfroggy.com/" ref="nofollow noopener noreferrer">Flexbox Froggy</a> (帮助学习Flexbox的交互式游戏)</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Antigravity 配置文件 skills]]></title>    <link>https://juejin.cn/post/7598203055751086115</link>    <guid>https://juejin.cn/post/7598203055751086115</guid>    <pubDate>2026-01-23T02:57:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598203055751086115" data-draft-id="7598089234033770496" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Antigravity 配置文件 skills "/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-23T02:57:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小兵张健"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032405229"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Antigravity 配置文件 skills 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032405229/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小兵张健
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-23T02:57:40.000Z" title="Fri Jan 23 2026 02:57:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Antigravity 的配置文件路径和 cursor, Claude Code 等相对主流的都不一样,每次喜欢乱配,写了个 skills 规范配置文件地址.</p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: antigravity-configuration
<span class="hljs-section">description: 获取 Antigravity (Rules, Skills, Workflows, MCP) 的正确配置文件路径。会自动根据用户 OS 环境提供对应路径。
---</span>

<span class="hljs-section"># Antigravity 配置全指南</span>

本 Skill 用于帮助你快速定位 Antigravity 各项功能的配置文件路径。

<span class="hljs-section">## ⚠️ 核心指令：环境判断</span>

请首先查看 <span class="hljs-code">`&lt;user_information&gt;`</span> 中的 <span class="hljs-strong">**OS version**</span>。
<span class="hljs-bullet">-</span> 如果是 <span class="hljs-code">`mac`</span> 或 <span class="hljs-code">`linux`</span> -&gt; 参考 <span class="hljs-strong">**macOS / Linux**</span> 栏目。
<span class="hljs-bullet">-</span> 如果是 <span class="hljs-code">`windows`</span> -&gt; 参考 <span class="hljs-strong">**Windows**</span> 栏目。

---

<span class="hljs-section">## 1. Workflows 配置 (工作流)</span>

Workflows 定义了自动化的任务流程。<span class="hljs-code">`.md`</span> 文件即被识别为可调用的 workflow。

| 级别 | 环境 | 路径模式 | 示例 (以用户 admin 为例) |
| :--- | :--- | :--- | :--- |
| <span class="hljs-strong">**Global**</span><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></span>(全局) | <span class="hljs-strong">**macOS / Linux**</span> | <span class="hljs-code">`~/.gemini/antigravity/global_workflows/`</span> | <span class="hljs-code">`/Users/admin/.gemini/antigravity/global_workflows/`</span> |
| | <span class="hljs-strong">**Windows**</span> | <span class="hljs-code">`%USERPROFILE%\.gemini\antigravity\global_workflows\`</span> | <span class="hljs-code">`C:\Users\Admin\.gemini\antigravity\global_workflows\`</span> |
| <span class="hljs-strong">**Workspace**</span><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></span>(工作区) | <span class="hljs-strong">**All**</span> | <span class="hljs-code">`&lt;workspace-root&gt;/.agent/workflows/`</span> | <span class="hljs-code">`/Users/admin/PycharmProjects/pf-backend/.agent/workflows/`</span> |

---

<span class="hljs-section">## 2. Skills 配置 (技能)</span>

Skills 是扩展 Agent 能力的工具包。每个 skill 文件夹内必须包含 <span class="hljs-code">`SKILL.md`</span>。

| 级别 | 环境 | 路径模式 | 示例 |
| :--- | :--- | :--- | :--- |
| <span class="hljs-strong">**Global**</span><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></span>(全局) | <span class="hljs-strong">**macOS / Linux**</span> | <span class="hljs-code">`~/.gemini/antigravity/global_skills/&lt;skill_name&gt;/`</span> | <span class="hljs-code">`/Users/admin/.gemini/antigravity/global_skills/mysql_ops/`</span> |
| | <span class="hljs-strong">**Windows**</span> | <span class="hljs-code">`%USERPROFILE%\.gemini\antigravity\global_skills\&lt;skill_name&gt;\`</span> | <span class="hljs-code">`C:\Users\Admin\.gemini\antigravity\global_skills\mysql_ops\`</span> |
| <span class="hljs-strong">**Workspace**</span><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></span>(工作区) | <span class="hljs-strong">**All**</span> | <span class="hljs-code">`&lt;workspace-root&gt;/.agent/skills/&lt;skill_name&gt;/`</span> | <span class="hljs-code">`/Users/admin/PycharmProjects/pf-backend/.agent/skills/mysql_ops/`</span> |

---

<span class="hljs-section">## 3. Rules 配置 (规则)</span>

Rules 定义了 Agent 的行为准则。

| 级别 | 环境 | 路径模式 | 示例 |
| :--- | :--- | :--- | :--- |
| <span class="hljs-strong">**Global**</span><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></span>(全局) | <span class="hljs-strong">**macOS / Linux**</span> | <span class="hljs-code">`~/.gemini/GEMINI.md`</span> | <span class="hljs-code">`/Users/admin/.gemini/GEMINI.md`</span> |
| | <span class="hljs-strong">**Windows**</span> | <span class="hljs-code">`%USERPROFILE%\.gemini\GEMINI.md`</span> | <span class="hljs-code">`C:\Users\Admin\.gemini\GEMINI.md`</span> |
| <span class="hljs-strong">**Workspace**</span><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></span>(工作区) | <span class="hljs-strong">**All**</span> | <span class="hljs-code">`&lt;workspace-root&gt;/.agent/rules/`</span> | <span class="hljs-code">`/Users/admin/PycharmProjects/pf-backend/.agent/rules/`</span>|

---

<span class="hljs-section">## 4. MCP 配置 (Model Context Protocol)</span>

MCP 服务器配置<span class="hljs-strong">**仅支持全局配置**</span>，没有项目级别的配置。

| 环境 | 配置文件路径 |
| :--- | :--- |
| <span class="hljs-strong">**macOS / Linux**</span> | <span class="hljs-code">`~/.gemini/antigravity/mcp_config.json`</span> |
| <span class="hljs-strong">**Windows**</span> | <span class="hljs-code">`%USERPROFILE%\.gemini\antigravity\mcp_config.json`</span> |

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[YOLO 目标检测 API 调用示例代码发布（Python/Java）]]></title>    <link>https://juejin.cn/post/7597989474992554022</link>    <guid>https://juejin.cn/post/7597989474992554022</guid>    <pubDate>2026-01-22T13:51:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597989474992554022" data-draft-id="7597989474992521254" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="YOLO 目标检测 API 调用示例代码发布（Python/Java）"/> <meta itemprop="keywords" content="后端,人工智能"/> <meta itemprop="datePublished" content="2026-01-22T13:51:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员威哥"/> <meta itemprop="url" content="https://juejin.cn/user/3411107130652176"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            YOLO 目标检测 API 调用示例代码发布（Python/Java）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3411107130652176/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员威哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T13:51:18.000Z" title="Thu Jan 22 2026 13:51:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常的计算机视觉开发工作中，经常遇到业务侧同学的诉求：“只想快速用 YOLO 做目标检测，不想本地搭环境、配依赖、加载模型，有没有更轻量化的方式？”。确实，对于非算法岗位的开发人员来说，本地部署 YOLO 的环境成本、模型加载成本过高，而 API 调用是将目标检测能力快速集成到业务系统的最优解 —— 只需关注请求 / 响应逻辑，无需关心底层的模型推理细节。</p>
<p>本文基于 YOLOv8（社区生态最完善、易封装 API 的版本），先搭建轻量且高性能的 YOLO 检测 API 服务，再提供可直接运行的 Python/Java 调用示例，覆盖单张图片检测、批量检测、异常处理等核心场景。所有代码均经过生产环境简化验证，无冗余逻辑，可直接复制复用。</p>
<h2 data-id="heading-0">一、前置准备：搭建 YOLOv8 API 服务（FastAPI 版）</h2>
<p>要实现 API 调用，首先需要一个可提供检测能力的服务端。这里选择 FastAPI（轻量、高性能、自带接口文档）作为服务框架，是新手和生产环境的双重优选。</p>
<h3 data-id="heading-1">1.1 服务端环境安装</h3>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装FastAPI和服务运行依赖</span>
pip install fastapi uvicorn
<span class="hljs-comment"># 安装YOLOv8核心库（封装了完整的检测逻辑）</span>
pip install ultralytics
<span class="hljs-comment"># 安装图片处理依赖</span>
pip install pillow python-multipart
</code></pre>
<h3 data-id="heading-2">1.2 编写 API 服务代码（yolo_api_server.py）</h3>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, UploadFile, File, HTTPException
<span class="hljs-keyword">from</span> fastapi.responses <span class="hljs-keyword">import</span> JSONResponse
<span class="hljs-keyword">from</span> ultralytics <span class="hljs-keyword">import</span> YOLO
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image
<span class="hljs-keyword">import</span> io
<span class="hljs-keyword">import</span> os

<span class="hljs-comment"># 初始化FastAPI应用</span>
app = FastAPI(title=<span class="hljs-string">"YOLOv8目标检测API"</span>, version=<span class="hljs-string">"1.0"</span>)

<span class="hljs-comment"># 加载YOLOv8预训练模型（按需选择：n=轻量 s=平衡 m=高精度，新手优先选s）</span>
<span class="hljs-comment"># 模型会自动下载，若网络问题可手动从https://github.com/ultralytics/assets下载</span>
model = YOLO(<span class="hljs-string">"yolov8s.pt"</span>)

<span class="hljs-comment"># 单张图片检测接口（核心接口）</span>
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/detect/single"</span>, summary=<span class="hljs-string">"单张图片目标检测"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">detect_single</span>(<span class="hljs-params">file: UploadFile = File(<span class="hljs-params">...</span>)</span>):
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 1. 校验文件类型（避免非图片文件上传）</span>
        allowed_ext = {<span class="hljs-string">"jpg"</span>, <span class="hljs-string">"jpeg"</span>, <span class="hljs-string">"png"</span>, <span class="hljs-string">"bmp"</span>}
        file_ext = file.filename.split(<span class="hljs-string">"."</span>)[-<span class="hljs-number">1</span>].lower()
        <span class="hljs-keyword">if</span> file_ext <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> allowed_ext:
            <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">400</span>, detail=<span class="hljs-string">"仅支持jpg/jpeg/png/bmp格式图片"</span>)
        
        <span class="hljs-comment"># 2. 读取并解析图片</span>
        img_content = <span class="hljs-keyword">await</span> file.read()
        img = Image.<span class="hljs-built_in">open</span>(io.BytesIO(img_content)).convert(<span class="hljs-string">"RGB"</span>)  <span class="hljs-comment"># 统一转为RGB格式</span>
        
        <span class="hljs-comment"># 3. 执行目标检测</span>
        results = model(img)
        
        <span class="hljs-comment"># 4. 解析检测结果（适配业务侧易读格式）</span>
        detect_res = []
        <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results:
            boxes = r.boxes  <span class="hljs-comment"># 检测框信息</span>
            <span class="hljs-keyword">for</span> box <span class="hljs-keyword">in</span> boxes:
                <span class="hljs-comment"># 提取目标框坐标、置信度、类别</span>
                x1, y1, x2, y2 = [<span class="hljs-built_in">round</span>(v, <span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> box.xyxy[<span class="hljs-number">0</span>].tolist()]
                conf = <span class="hljs-built_in">round</span>(box.conf[<span class="hljs-number">0</span>].item(), <span class="hljs-number">4</span>)  <span class="hljs-comment"># 置信度保留4位小数</span>
                cls_id = <span class="hljs-built_in">int</span>(box.cls[<span class="hljs-number">0</span>].item())
                cls_name = model.names[cls_id]  <span class="hljs-comment"># 类别名称（如person、car）</span>
                
                detect_res.append({
                    <span class="hljs-string">"class_name"</span>: cls_name,
                    <span class="hljs-string">"confidence"</span>: conf,
                    <span class="hljs-string">"bbox"</span>: [x1, y1, x2, y2]  <span class="hljs-comment"># 目标框左上角/右下角坐标</span>
                })
        
        <span class="hljs-comment"># 5. 返回标准化响应</span>
        <span class="hljs-keyword">return</span> JSONResponse(content={
            <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
            <span class="hljs-string">"msg"</span>: <span class="hljs-string">"检测成功"</span>,
            <span class="hljs-string">"data"</span>: detect_res
        })
    
    <span class="hljs-keyword">except</span> HTTPException <span class="hljs-keyword">as</span> e:
        <span class="hljs-comment"># 已知异常（如文件类型错误）</span>
        <span class="hljs-keyword">raise</span> e
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-comment"># 未知异常（如图片损坏、模型推理失败）</span>
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-string">f"检测失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)

<span class="hljs-comment"># 批量图片检测接口（扩展接口）</span>
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/detect/batch"</span>, summary=<span class="hljs-string">"批量图片目标检测"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">detect_batch</span>(<span class="hljs-params">files: <span class="hljs-built_in">list</span>[UploadFile] = File(<span class="hljs-params">...</span>)</span>):
    <span class="hljs-keyword">try</span>:
        batch_res = []
        <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files:
            <span class="hljs-comment"># 单文件处理逻辑（复用单张检测的校验/解析逻辑）</span>
            file_res = {<span class="hljs-string">"filename"</span>: file.filename}
            <span class="hljs-keyword">try</span>:
                allowed_ext = {<span class="hljs-string">"jpg"</span>, <span class="hljs-string">"jpeg"</span>, <span class="hljs-string">"png"</span>, <span class="hljs-string">"bmp"</span>}
                file_ext = file.filename.split(<span class="hljs-string">"."</span>)[-<span class="hljs-number">1</span>].lower()
                <span class="hljs-keyword">if</span> file_ext <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> allowed_ext:
                    file_res.update({<span class="hljs-string">"code"</span>: <span class="hljs-number">400</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"文件格式不支持"</span>, <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>})
                    batch_res.append(file_res)
                    <span class="hljs-keyword">continue</span>
                
                img_content = <span class="hljs-keyword">await</span> file.read()
                img = Image.<span class="hljs-built_in">open</span>(io.BytesIO(img_content)).convert(<span class="hljs-string">"RGB"</span>)
                results = model(img)
                
                detect_res = []
                <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results:
                    boxes = r.boxes
                    <span class="hljs-keyword">for</span> box <span class="hljs-keyword">in</span> boxes:
                        x1, y1, x2, y2 = [<span class="hljs-built_in">round</span>(v, <span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> box.xyxy[<span class="hljs-number">0</span>].tolist()]
                        conf = <span class="hljs-built_in">round</span>(box.conf[<span class="hljs-number">0</span>].item(), <span class="hljs-number">4</span>)
                        cls_id = <span class="hljs-built_in">int</span>(box.cls[<span class="hljs-number">0</span>].item())
                        cls_name = model.names[cls_id]
                        detect_res.append({
                            <span class="hljs-string">"class_name"</span>: cls_name,
                            <span class="hljs-string">"confidence"</span>: conf,
                            <span class="hljs-string">"bbox"</span>: [x1, y1, x2, y2]
                        })
                
                file_res.update({<span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"检测成功"</span>, <span class="hljs-string">"data"</span>: detect_res})
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                file_res.update({<span class="hljs-string">"code"</span>: <span class="hljs-number">500</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">f"检测失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>, <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>})
            <span class="hljs-keyword">finally</span>:
                batch_res.append(file_res)
        
        <span class="hljs-keyword">return</span> JSONResponse(content={
            <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
            <span class="hljs-string">"msg"</span>: <span class="hljs-string">"批量检测完成"</span>,
            <span class="hljs-string">"data"</span>: batch_res
        })
    
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-string">f"批量检测失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)

<span class="hljs-comment"># 启动服务（本地测试用）</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">import</span> uvicorn
    <span class="hljs-comment"># host=0.0.0.0 允许局域网访问，port=8000 可自定义（避免端口冲突）</span>
    uvicorn.run(app, host=<span class="hljs-string">"0.0.0.0"</span>, port=<span class="hljs-number">8000</span>)
</code></pre>
<h3 data-id="heading-3">1.3 启动 API 服务</h3>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs">python yolo_api_server.py
</code></pre>
<p>启动成功后，访问 <code>http://localhost:8000/docs</code> 可查看自动生成的 Swagger 接口文档，支持在线上传图片调试，新手友好度拉满。</p>
<h2 data-id="heading-4">二、Python 版 API 调用示例</h2>
<p>Python 调用选择最主流的<code>requests</code>库，覆盖单张 / 批量检测场景，包含完整的异常处理和超时控制，可直接嵌入业务代码。</p>
<h3 data-id="heading-5">2.1 安装调用依赖</h3>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs">pip install requests
</code></pre>
<h3 data-id="heading-6">2.2 Python 调用代码（yolo_api_client.py）</h3>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>

<span class="hljs-comment"># API基础配置（根据实际部署地址修改）</span>
API_BASE_URL = <span class="hljs-string">"http://localhost:8000"</span>
TIMEOUT = <span class="hljs-number">30</span>  <span class="hljs-comment"># 请求超时时间（秒），避免长时间阻塞</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">detect_single_image</span>(<span class="hljs-params">image_path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>:
    <span class="hljs-string">"""
    调用单张图片检测接口
    :param image_path: 本地图片绝对/相对路径
    :return: 标准化检测结果（字典格式）
    """</span>
    <span class="hljs-comment"># 前置校验：文件是否存在</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(image_path):
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: <span class="hljs-number">404</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">f"图片文件不存在：<span class="hljs-subst">{image_path}</span>"</span>, <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>}
    
    <span class="hljs-comment"># 构造请求</span>
    url = <span class="hljs-string">f"<span class="hljs-subst">{API_BASE_URL}</span>/detect/single"</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 以二进制方式读取图片</span>
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(image_path, <span class="hljs-string">"rb"</span>) <span class="hljs-keyword">as</span> f:
            files = {<span class="hljs-string">"file"</span>: (os.path.basename(image_path), f)}
            <span class="hljs-comment"># 发送POST请求</span>
            response = requests.post(url, files=files, timeout=TIMEOUT)
        
        <span class="hljs-comment"># 解析响应</span>
        <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
            <span class="hljs-keyword">return</span> response.json()
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: response.status_code, <span class="hljs-string">"msg"</span>: <span class="hljs-string">f"接口返回错误：<span class="hljs-subst">{response.text}</span>"</span>, <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>}
    
    <span class="hljs-comment"># 异常捕获（覆盖90%的调用问题）</span>
    <span class="hljs-keyword">except</span> requests.exceptions.Timeout:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: <span class="hljs-number">408</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"请求超时（服务端响应过慢或网络不稳定）"</span>, <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>}
    <span class="hljs-keyword">except</span> requests.exceptions.ConnectionError:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: <span class="hljs-number">503</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"连接失败（检查API服务是否启动、端口是否正确）"</span>, <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>}
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: <span class="hljs-number">500</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">f"调用异常：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>, <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">detect_batch_images</span>(<span class="hljs-params">image_paths: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-type">Dict</span>:
    <span class="hljs-string">"""
    调用批量图片检测接口
    :param image_paths: 图片路径列表
    :return: 批量检测结果（字典格式）
    """</span>
    <span class="hljs-comment"># 过滤无效文件，避免批量请求整体失败</span>
    valid_files = []
    <span class="hljs-keyword">for</span> path <span class="hljs-keyword">in</span> image_paths:
        <span class="hljs-keyword">if</span> os.path.exists(path):
            <span class="hljs-comment"># 构造批量上传的文件元组（key固定为files，与服务端对应）</span>
            valid_files.append((<span class="hljs-string">"files"</span>, (os.path.basename(path), <span class="hljs-built_in">open</span>(path, <span class="hljs-string">"rb"</span>))))
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"警告：跳过不存在的文件：<span class="hljs-subst">{path}</span>"</span>)
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> valid_files:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: <span class="hljs-number">400</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"无有效图片文件"</span>, <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>}
    
    <span class="hljs-comment"># 构造请求</span>
    url = <span class="hljs-string">f"<span class="hljs-subst">{API_BASE_URL}</span>/detect/batch"</span>
    <span class="hljs-keyword">try</span>:
        response = requests.post(url, files=valid_files, timeout=TIMEOUT)
        
        <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
            <span class="hljs-keyword">return</span> response.json()
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: response.status_code, <span class="hljs-string">"msg"</span>: <span class="hljs-string">f"接口返回错误：<span class="hljs-subst">{response.text}</span>"</span>, <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>}
    
    <span class="hljs-keyword">except</span> requests.exceptions.Timeout:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: <span class="hljs-number">408</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"批量请求超时"</span>, <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>}
    <span class="hljs-keyword">except</span> requests.exceptions.ConnectionError:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: <span class="hljs-number">503</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"连接失败（检查API服务状态）"</span>, <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>}
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"code"</span>: <span class="hljs-number">500</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">f"批量调用异常：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>, <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>}
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-comment"># 关键：关闭所有打开的文件句柄，避免资源泄露</span>
        <span class="hljs-keyword">for</span> _, (_, f) <span class="hljs-keyword">in</span> valid_files:
            f.close()

<span class="hljs-comment"># 测试示例（替换为自己的图片路径）</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 1. 单张图片检测测试</span>
    single_img_path = <span class="hljs-string">"test_car.jpg"</span>  <span class="hljs-comment"># 本地图片路径</span>
    single_result = detect_single_image(single_img_path)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 单张图片检测结果 ==="</span>)
    <span class="hljs-built_in">print</span>(single_result)
    
    <span class="hljs-comment"># 2. 批量图片检测测试</span>
    batch_img_paths = [<span class="hljs-string">"test_person.jpg"</span>, <span class="hljs-string">"test_dog.png"</span>, <span class="hljs-string">"invalid_img.jpg"</span>]  <span class="hljs-comment"># 包含无效文件示例</span>
    batch_result = detect_batch_images(batch_img_paths)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 批量图片检测结果 ==="</span>)
    <span class="hljs-built_in">print</span>(batch_result)
</code></pre>
<h2 data-id="heading-7">三、Java 版 API 调用示例</h2>
<p>Java 调用选择工业级的<code>OkHttp</code>客户端（性能优、稳定性强），搭配 FastJSON2 解析响应，适配 Java 后端开发场景。</p>
<h3 data-id="heading-8">3.1 Maven 依赖配置（pom.xml）</h3>
<p>xml</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- OkHttp核心依赖（HTTP客户端） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>okhttp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- FastJSON2（JSON解析，轻量高效） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.45<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 日志依赖（可选，方便调试） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-simple<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-9">3.2 Java 调用代码（YoloApiClient.java）</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.alibaba.fastjson2.JSON;
<span class="hljs-keyword">import</span> com.alibaba.fastjson2.JSONObject;
<span class="hljs-keyword">import</span> okhttp3.*;

<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * YOLOv8目标检测API Java客户端
 * 适配生产环境调用规范：单例客户端、超时控制、异常分类处理
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YoloApiClient</span> {
    <span class="hljs-comment">// API基础配置（根据实际部署修改）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">API_BASE_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">"http://localhost:8000"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TIMEOUT_SECONDS</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;
    <span class="hljs-comment">// 单例OkHttpClient（避免重复创建连接池，提升性能）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> OkHttpClient OK_HTTP_CLIENT;

    <span class="hljs-comment">// 静态初始化客户端（配置超时、连接池）</span>
    <span class="hljs-keyword">static</span> {
        OK_HTTP_CLIENT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>.Builder()
                .connectTimeout(TIMEOUT_SECONDS, TimeUnit.SECONDS)  <span class="hljs-comment">// 连接超时</span>
                .readTimeout(TIMEOUT_SECONDS, TimeUnit.SECONDS)     <span class="hljs-comment">// 读取超时</span>
                .writeTimeout(TIMEOUT_SECONDS, TimeUnit.SECONDS)    <span class="hljs-comment">// 写入超时</span>
                .retryOnConnectionFailure(<span class="hljs-literal">true</span>)                     <span class="hljs-comment">// 连接失败自动重试</span>
                .build();
    }

    <span class="hljs-comment">/**
     * 调用单张图片检测接口
     * <span class="hljs-doctag">@param</span> imagePath 本地图片绝对路径
     * <span class="hljs-doctag">@return</span> 标准化检测结果（JSON字符串）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">detectSingleImage</span><span class="hljs-params">(String imagePath)</span> {
        <span class="hljs-comment">// 1. 校验文件是否存在</span>
        <span class="hljs-type">File</span> <span class="hljs-variable">imageFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(imagePath);
        <span class="hljs-keyword">if</span> (!imageFile.exists()) {
            <span class="hljs-type">JSONObject</span> <span class="hljs-variable">errorObj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();
            errorObj.put(<span class="hljs-string">"code"</span>, <span class="hljs-number">404</span>);
            errorObj.put(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"图片文件不存在："</span> + imagePath);
            errorObj.put(<span class="hljs-string">"data"</span>, <span class="hljs-literal">null</span>);
            <span class="hljs-keyword">return</span> errorObj.toJSONString();
        }

        <span class="hljs-comment">// 2. 校验文件格式（避免无效请求）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> imageFile.getName();
        <span class="hljs-keyword">if</span> (!fileName.contains(<span class="hljs-string">"."</span>)) {
            <span class="hljs-type">JSONObject</span> <span class="hljs-variable">errorObj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();
            errorObj.put(<span class="hljs-string">"code"</span>, <span class="hljs-number">400</span>);
            errorObj.put(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"文件无后缀，无法识别格式"</span>);
            errorObj.put(<span class="hljs-string">"data"</span>, <span class="hljs-literal">null</span>);
            <span class="hljs-keyword">return</span> errorObj.toJSONString();
        }
        <span class="hljs-type">String</span> <span class="hljs-variable">fileExt</span> <span class="hljs-operator">=</span> fileName.substring(fileName.lastIndexOf(<span class="hljs-string">"."</span>) + <span class="hljs-number">1</span>).toLowerCase();
        <span class="hljs-keyword">if</span> (!<span class="hljs-string">"jpg"</span>.equals(fileExt) &amp;&amp; !<span class="hljs-string">"jpeg"</span>.equals(fileExt) &amp;&amp; !<span class="hljs-string">"png"</span>.equals(fileExt) &amp;&amp; !<span class="hljs-string">"bmp"</span>.equals(fileExt)) {
            <span class="hljs-type">JSONObject</span> <span class="hljs-variable">errorObj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();
            errorObj.put(<span class="hljs-string">"code"</span>, <span class="hljs-number">400</span>);
            errorObj.put(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"仅支持jpg/jpeg/png/bmp格式图片"</span>);
            errorObj.put(<span class="hljs-string">"data"</span>, <span class="hljs-literal">null</span>);
            <span class="hljs-keyword">return</span> errorObj.toJSONString();
        }

        <span class="hljs-comment">// 3. 构造multipart/form-data请求体（与服务端接口参数对应）</span>
        <span class="hljs-type">RequestBody</span> <span class="hljs-variable">requestBody</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MultipartBody</span>.Builder()
                .setType(MultipartBody.FORM)
                .addFormDataPart(
                        <span class="hljs-string">"file"</span>,  <span class="hljs-comment">// 参数名，必须与服务端的UploadFile参数名一致</span>
                        fileName,
                        RequestBody.create(MediaType.parse(<span class="hljs-string">"image/"</span> + fileExt), imageFile)
                )
                .build();

        <span class="hljs-comment">// 4. 构造请求</span>
        <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()
                .url(API_BASE_URL + <span class="hljs-string">"/detect/single"</span>)
                .post(requestBody)
                .build();

        <span class="hljs-comment">// 5. 发送请求并处理响应</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> OK_HTTP_CLIENT.newCall(request).execute()) {
            <span class="hljs-comment">// 处理非200响应</span>
            <span class="hljs-keyword">if</span> (!response.isSuccessful()) {
                <span class="hljs-type">JSONObject</span> <span class="hljs-variable">errorObj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();
                errorObj.put(<span class="hljs-string">"code"</span>, response.code());
                errorObj.put(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"接口调用失败："</span> + response.message());
                errorObj.put(<span class="hljs-string">"data"</span>, <span class="hljs-literal">null</span>);
                <span class="hljs-keyword">return</span> errorObj.toJSONString();
            }
            <span class="hljs-comment">// 解析成功响应</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">responseBody</span> <span class="hljs-operator">=</span> response.body().string();
            <span class="hljs-keyword">return</span> responseBody;
        } <span class="hljs-keyword">catch</span> (IOException e) {
            <span class="hljs-comment">// 分类处理异常，方便业务侧排查</span>
            <span class="hljs-type">JSONObject</span> <span class="hljs-variable">errorObj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();
            <span class="hljs-keyword">if</span> (e.getMessage().contains(<span class="hljs-string">"timeout"</span>)) {
                errorObj.put(<span class="hljs-string">"code"</span>, <span class="hljs-number">408</span>);
                errorObj.put(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"请求超时（服务端未及时响应）"</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.getMessage().contains(<span class="hljs-string">"Connection refused"</span>)) {
                errorObj.put(<span class="hljs-string">"code"</span>, <span class="hljs-number">503</span>);
                errorObj.put(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"连接被拒绝（检查API服务是否启动）"</span>);
            } <span class="hljs-keyword">else</span> {
                errorObj.put(<span class="hljs-string">"code"</span>, <span class="hljs-number">500</span>);
                errorObj.put(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"调用异常："</span> + e.getMessage());
            }
            errorObj.put(<span class="hljs-string">"data"</span>, <span class="hljs-literal">null</span>);
            <span class="hljs-keyword">return</span> errorObj.toJSONString();
        }
    }

    <span class="hljs-comment">// 测试主方法（替换为实际图片路径）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 本地图片绝对路径（避免相对路径歧义）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">imagePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"D:/test_images/test_person.jpg"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">detectResult</span> <span class="hljs-operator">=</span> detectSingleImage(imagePath);
        
        <span class="hljs-comment">// 格式化输出结果，便于阅读</span>
        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">resultObj</span> <span class="hljs-operator">=</span> JSON.parseObject(detectResult);
        System.out.println(<span class="hljs-string">"=== Java调用YOLO API检测结果 ==="</span>);
        System.out.println(JSON.toJSONString(resultObj, <span class="hljs-literal">true</span>));
    }
}
</code></pre>
<h2 data-id="heading-10">四、调用过程中的高频踩坑点 &amp; 解决方案</h2>
<p>日常开发中，80% 的 API 调用问题集中在以下场景，提前规避可大幅提升开发效率：</p>









































<table><thead><tr><th>踩坑现象</th><th>核心原因</th><th>解决方案</th><th/></tr></thead><tbody><tr><td>400 错误：“仅支持 jpg/jpeg/png/bmp 格式图片”</td><td>图片后缀大小写（如 JPG 写成 jpg）、文件实际格式与后缀不符</td><td>1. 统一将后缀转为小写；2. 校验文件魔数（而非仅靠后缀），确保格式真实</td><td/></tr><tr><td>500 错误：“cannot identify image file”</td><td>图片文件损坏、上传时流读取不完整</td><td>1. 校验图片完整性（可通过 PIL/ImageIO 预校验）；2. 上传时确保文件流完整关闭</td><td/></tr><tr><td>连接拒绝 / 超时</td><td>API 服务未启动、端口被占用、防火墙拦截</td><td>1. 确认服务已启动（查看 uvicorn 日志）；2. 检查端口占用（Windows：netstat -ano</td><td>findstr 8000）；3. 放行 8000 端口</td></tr><tr><td>Java 调用报 “no such file or directory”</td><td>相对路径歧义（工作目录与预期不一致）</td><td>强制使用绝对路径（如 D:/test.jpg），避免相对路径</td><td/></tr><tr><td>响应结果为空</td><td>图片尺寸过大（超过 10MB）、服务端处理超时</td><td>1. 服务端增加图片大小限制配置；2. 调用端压缩图片后上传；3. 调大超时时间</td><td/></tr></tbody></table>
<h2 data-id="heading-11">五、生产环境进阶优化建议</h2>
<p>若需将该 API 用于生产环境，需补充以下能力，保障稳定性和安全性：</p>
<ol>
<li><strong>接口鉴权</strong>：添加 API Key/Token 校验（如在请求头中携带 X-API-Key），避免接口被恶意调用；</li>
<li><strong>限流控制</strong>：服务端集成 SlowAPI 实现接口限流（如单 IP 每分钟最多调用 100 次），防止高频请求压垮服务；</li>
<li><strong>异步处理</strong>：批量检测接口改为异步模式（返回任务 ID，轮询获取结果），避免长连接超时；</li>
<li><strong>部署优化</strong>：将 API 服务打包为 Docker 镜像，方便跨环境部署；使用 Gunicorn+Uvicorn 多进程运行，提升并发能力；</li>
<li><strong>监控告警</strong>：添加接口调用量、失败率、响应时间监控，异常时触发告警（如钉钉 / 企业微信通知）。</li>
</ol>
<h2 data-id="heading-12">六、总结</h2>
<ol>
<li>YOLO API 调用的核心是 “服务端封装模型 + 客户端标准化请求”，Python 用 FastAPI 搭服务、requests 调接口，Java 用 OkHttp 调接口，都是低成本、易落地的方案；</li>
<li>调用时重点关注<strong>文件校验、超时控制、异常分类处理</strong>，可避开 90% 的调用问题；</li>
<li>测试阶段优先使用 FastAPI 的<code>/docs</code>在线调试接口，快速定位请求参数、格式问题；</li>
<li>生产环境需补充鉴权、限流、监控能力，避免接口被滥用或故障无感知。</li>
</ol>
<p>这套示例代码可直接复用，无论是 Python 还是 Java 开发者，都能在 10 分钟内完成 YOLO 目标检测能力的集成，无需关注底层的环境搭建和模型推理细节，聚焦业务逻辑即可。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型路由算法深度调研：从原理到实践]]></title>    <link>https://juejin.cn/post/7598057199962472499</link>    <guid>https://juejin.cn/post/7598057199962472499</guid>    <pubDate>2026-01-22T13:52:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598057199962472499" data-draft-id="7597805826515468334" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型路由算法深度调研：从原理到实践"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-01-22T13:52:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Limbo"/> <meta itemprop="url" content="https://juejin.cn/user/3039492249228104"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型路由算法深度调研：从原理到实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3039492249228104/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Limbo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T13:52:42.000Z" title="Thu Jan 22 2026 13:52:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    17
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">大模型路由算法深度调研：从原理到实践</h2>
<blockquote>
<p>日期：2026年1月 | 类别：AI技术</p>
</blockquote>
<h3 data-id="heading-1">引言</h3>
<p>2026年，大语言模型（LLM）的应用已经深入各行各业。然而，随之而来的是日益严峻的挑战：如何在保证质量的前提下，控制不断攀升的API调用成本？如何在众多模型中做出最优选择？<strong>大模型路由算法</strong>（LLM Routing）正是解决这一问题的核心技术。</p>
<p>本文基于对国内外技术社区、学术研究和开源项目的深入调研，系统性地介绍LLM路由算法的原理、技术和实践，帮助读者全面了解这一领域的最新进展。</p>
<h3 data-id="heading-2">什么是大模型路由？</h3>
<h4 data-id="heading-3">核心概念</h4>
<p><strong>大模型路由</strong>是一种智能决策机制，它根据请求的特性（如复杂度、意图、领域等）动态选择最合适的语言模型来处理，从而在<strong>性能、成本和延迟</strong>之间实现最优平衡。</p>
<h4 data-id="heading-4">为什么需要路由？</h4>
<pre><code class="hljs language-bash" lang="bash">场景对比：

传统方式：
所有查询 → GPT-4 → 成本 <span class="hljs-variable">$10</span>/天，延迟 3s

路由方式：
简单查询（80%）→ Llama-3-70B → 成本 <span class="hljs-variable">$0</span>.1/天，延迟 0.5s
复杂查询（15%）→ GPT-3.5 → 成本 <span class="hljs-variable">$1</span>/天，延迟 1s
困难查询（5%）  → GPT-4   → 成本 <span class="hljs-variable">$0</span>.5/天，延迟 3s
───────────────────────────────────────
总计：成本 <span class="hljs-variable">$1</span>.6/天，平均延迟 0.8s

结果：成本降低84%，延迟降低73%
</code></pre>
<h3 data-id="heading-5">路由策略全景图</h3>
<h4 data-id="heading-6">三大核心策略</h4>





























<table><thead><tr><th>策略</th><th>工作方式</th><th>适用场景</th><th>效果</th></tr></thead><tbody><tr><td><strong>路由（Routing）</strong></td><td>每个查询选择一个最优模型</td><td>通用场景</td><td>灵活性高</td></tr><tr><td><strong>级联（Cascading）</strong></td><td>从简单模型开始，逐级升级</td><td>成本敏感场景</td><td>成本最优</td></tr><tr><td><strong>集成（Ensemble）</strong></td><td>组合多个模型的输出</td><td>质量敏感场景</td><td>质量最优</td></tr></tbody></table>
<h4 data-id="heading-7">路由技术演进</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">2023: 静态路由（基于规则）</span>
        ↓
<span class="hljs-section">2024: 动态路由（基于ML）</span>
        ↓
<span class="hljs-section">2025: 语义路由（基于Embedding）</span>
        ↓
<span class="hljs-section">2026: 智能路由（多轮协调、自适应）</span>
</code></pre>
<h3 data-id="heading-8">核心技术深度解析</h3>
<h4 data-id="heading-9">1. MoE混合专家模型</h4>
<p>混合专家模型（Mixture of Experts, MoE）是模型内部的路由技术，通过在模型内部引入多个"专家"子网络，实现条件计算。</p>
<h5 data-id="heading-10">工作原理</h5>
<pre><code class="hljs language-arduino" lang="arduino">输入: <span class="hljs-string">"如何修复Python代码？"</span>
        ↓
    Router（路由器）
        ↓
    计算专家权重
        ↓
    选择Top-K专家
        ↓
┌───────────┬───────────┬───────────┐
│  Expert1  │  Expert2  │  Expert3  │
│  (代码)   │  (数学)   │  (写作)   │
│  ✓ 激活   │           │           │
└───────────┴───────────┴───────────┘
        ↓
    组合输出
</code></pre>
<h5 data-id="heading-11">代表性成果</h5>
<ul>
<li><strong>Switch Transformer</strong>（Google，2021）：首个万亿参数模型，每个token只路由到一个专家</li>
<li><strong>DeepSeek-MoE</strong>（2024）：细粒度专家分割，性能显著提升</li>
<li><strong>Mixtral 8x7B</strong>（Mistral AI）：开源高性能MoE模型</li>
</ul>
<h4 data-id="heading-12">2. 语义路由技术</h4>
<p>语义路由基于向量嵌入（Embedding）计算查询与路由的语义相似度，实现快速、准确的决策。</p>
<h5 data-id="heading-13">工作流程</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 伪代码示例</span>
query = <span class="hljs-string">"Python报错怎么解决？"</span>
query_embedding = encode(query)  <span class="hljs-comment"># 转换为向量</span>

<span class="hljs-comment"># 预定义路由</span>
routes = {
    <span class="hljs-string">"code_help"</span>: encode(<span class="hljs-string">"编程相关的问题"</span>),
    <span class="hljs-string">"chitchat"</span>: encode(<span class="hljs-string">"日常闲聊"</span>),
    <span class="hljs-string">"creative"</span>: encode(<span class="hljs-string">"创意写作"</span>),
}

<span class="hljs-comment"># 计算相似度</span>
similarities = {
    route: cosine_similarity(query_embedding, route_emb)
    <span class="hljs-keyword">for</span> route, route_emb <span class="hljs-keyword">in</span> routes.items()
}

<span class="hljs-comment"># 选择最相似的路由</span>
best_route = <span class="hljs-built_in">max</span>(similarities.items(), key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>])
<span class="hljs-comment"># → "code_help"</span>
</code></pre>
<h5 data-id="heading-14">优势对比</h5>





























<table><thead><tr><th>维度</th><th>规则路由</th><th>LLM分类路由</th><th>语义路由</th></tr></thead><tbody><tr><td>速度</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐</td><td>⭐⭐⭐⭐</td></tr><tr><td>准确性</td><td>⭐⭐</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td></tr><tr><td>维护成本</td><td>⭐⭐</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐</td></tr></tbody></table>
<h4 data-id="heading-15">3. 级联路由与集成</h4>
<h5 data-id="heading-16">级联路由实现成本优化</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">cascading_router</span>(<span class="hljs-params">query</span>):
    <span class="hljs-comment"># 第一级：本地小模型（几乎零成本）</span>
    result = llama_3_8b.generate(query)
    <span class="hljs-keyword">if</span> evaluate_quality(result) &gt; <span class="hljs-number">0.8</span>:
        <span class="hljs-keyword">return</span> result  <span class="hljs-comment"># 80%的查询在这里就解决了</span>

    <span class="hljs-comment"># 第二级：中等模型</span>
    result = gpt_35.generate(query)
    <span class="hljs-keyword">if</span> evaluate_quality(result) &gt; <span class="hljs-number">0.9</span>:
        <span class="hljs-keyword">return</span> result  <span class="hljs-comment"># 15%的查询在这里解决</span>

    <span class="hljs-comment"># 第三级：最强模型（只处理最难的5%）</span>
    <span class="hljs-keyword">return</span> gpt_4.generate(query)
</code></pre>
<h5 data-id="heading-17">集成技术提升质量</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">ensemble_router</span>(<span class="hljs-params">query</span>):
    <span class="hljs-comment"># 多个模型并行生成</span>
    results = {
        <span class="hljs-string">"gpt-4"</span>: gpt_4.generate(query),
        <span class="hljs-string">"claude-3"</span>: claude_3.generate(query),
        <span class="hljs-string">"gemini"</span>: gemini.generate(query)
    }

    <span class="hljs-comment"># 策略1: 投票选择</span>
    <span class="hljs-comment"># 策略2: 加权组合</span>
    <span class="hljs-comment"># 策略3: 使用元模型综合</span>

    <span class="hljs-keyword">return</span> meta_model.synthesize(results)
</code></pre>
<h3 data-id="heading-18">评估与基准测试</h3>
<h4 data-id="heading-19">LLMRouterBench - 2026年最大规模基准</h4>
<ul>
<li><strong>规模</strong>：400,000+实例、21个数据集、33个模型</li>
<li><strong>评估维度</strong>：
<ul>
<li>性能导向路由</li>
<li>性能-成本权衡路由</li>
</ul>
</li>
</ul>
<h4 data-id="heading-20">关键评估指标</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 成本节省率</span>
cost_saving = (baseline_cost - actual_cost) / baseline_cost

<span class="hljs-comment"># 质量-成本比</span>
quality_cost_ratio = avg_quality / avg_cost

<span class="hljs-comment"># 延迟满足率</span>
latency_satisfaction = satisfied_requests / total_requests
</code></pre>
<h3 data-id="heading-21">开源框架推荐</h3>
<h4 data-id="heading-22">1. RouteLLM ⭐⭐⭐⭐⭐</h4>
<ul>
<li><strong>开发者</strong>：LM-SYS（Chatbot Arena团队）+ UC Berkeley</li>
<li><strong>特点</strong>：基于偏好数据学习，成本优化</li>
<li><strong>适用</strong>：生产环境成本优化</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">pip install routellm
</code></pre>
<h4 data-id="heading-23">2. Semantic Router ⭐⭐⭐⭐</h4>
<ul>
<li><strong>开发者</strong>：Aurelio AI</li>
<li><strong>特点</strong>：语义相似度路由，超快决策</li>
<li><strong>适用</strong>：意图识别、快速原型</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">pip install semantic-router
</code></pre>
<h4 data-id="heading-24">3. LiteLLM ⭐⭐⭐⭐⭐</h4>
<ul>
<li><strong>特点</strong>：统一接口、负载均衡、故障转移</li>
<li><strong>适用</strong>：多模型统一调用、企业级部署</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">pip install litellm
</code></pre>
<h4 data-id="heading-25">4. vLLM Router ⭐⭐⭐⭐</h4>
<ul>
<li><strong>开发者</strong>：vLLM团队</li>
<li><strong>特点</strong>：高性能、Prefill/Decode阶段感知</li>
<li><strong>适用</strong>：大规模推理服务</li>
</ul>
<h3 data-id="heading-26">实践案例与效果</h3>
<h4 data-id="heading-27">案例1：智能客服系统</h4>
<p><strong>挑战</strong>：客服咨询量巨大，API成本高昂</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>简单问题（60%）→ 本地Llama-3-8B</li>
<li>中等问题（30%）→ GPT-3.5-turbo</li>
<li>复杂问题（10%）→ GPT-4</li>
</ul>
<p><strong>效果</strong>：</p>
<ul>
<li>成本降低：<strong>75%</strong></li>
<li>平均延迟：从3.2s降至1.1s</li>
<li>用户满意度：从90%提升至92%</li>
</ul>
<h4 data-id="heading-28">案例2：代码助手</h4>
<p><strong>挑战</strong>：代码生成需要高质量，但成本敏感</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>级联路由 + 语义路由组合</li>
<li>代码相关查询→ 代码专用模型</li>
<li>其他查询 → 通用模型</li>
</ul>
<p><strong>效果</strong>：</p>
<ul>
<li>成本降低：<strong>60%</strong></li>
<li>代码质量：提升15%</li>
</ul>
<h4 data-id="heading-29">案例3：内容创作平台</h4>
<p><strong>挑战</strong>：不同创作任务需要不同风格模型</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>创意写作 → Claude-3-Opus（创意性强）</li>
<li>技术写作 → GPT-4（准确性高）</li>
<li>营销文案 → Gemini（商业感强）</li>
</ul>
<p><strong>效果</strong>：</p>
<ul>
<li>用户满意度：提升25%</li>
<li>内容质量：提升20%</li>
</ul>
<h3 data-id="heading-30">前沿研究方向</h3>
<h4 data-id="heading-31">1. 个性化路由（2026）</h4>
<p>UIUC团队提出<strong>PersonalizedRouter</strong>，学习用户隐藏偏好，实现"千人千面"的精准路由。</p>
<h4 data-id="heading-32">2. 多轮协调路由</h4>
<p><strong>Router-R1</strong>让路由器从"单一回答者"进化为"多智能体协调者"，支持迭代式路由决策。</p>
<h4 data-id="heading-33">3. 因果推断路由</h4>
<p>研究路由决策的因果影响，避免虚假相关性。</p>
<h4 data-id="heading-34">4. 联邦学习路由</h4>
<p>在保护隐私的前提下，实现分布式路由学习。</p>
<h3 data-id="heading-35">快速上手指南</h3>
<h4 data-id="heading-36">5分钟实现语义路由</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 安装</span>
pip install semantic-router

<span class="hljs-comment"># 代码</span>
<span class="hljs-keyword">from</span> semantic_router <span class="hljs-keyword">import</span> Route, SemanticRouter
<span class="hljs-keyword">from</span> semantic_router.encoders <span class="hljs-keyword">import</span> OpenAIEncoder

<span class="hljs-comment"># 定义路由</span>
routes = [
    Route(name=<span class="hljs-string">"tech"</span>, utterances=[<span class="hljs-string">"代码"</span>, <span class="hljs-string">"bug"</span>, <span class="hljs-string">"编程"</span>]),
    Route(name=<span class="hljs-string">"creative"</span>, utterances=[<span class="hljs-string">"故事"</span>, <span class="hljs-string">"诗歌"</span>, <span class="hljs-string">"创作"</span>]),
]

<span class="hljs-comment"># 创建路由器</span>
router = SemanticRouter(
    encoder=OpenAIEncoder(),
    routes=routes,
    threshold=<span class="hljs-number">0.7</span>
)

<span class="hljs-comment"># 使用</span>
decision = router(<span class="hljs-string">"怎么修复这个bug？"</span>)
<span class="hljs-built_in">print</span>(decision.name)  <span class="hljs-comment"># "tech"</span>
</code></pre>
<h4 data-id="heading-37">生产部署检查清单</h4>
<pre><code class="hljs language-css" lang="css">□ 路由逻辑测试通过
□ 成本预算设置合理
□ 故障转移配置正确
□ 监控指标已配置
□ 日志记录完整
□ 告警规则已设置
□ <span class="hljs-selector-tag">A</span>/<span class="hljs-selector-tag">B</span>测试计划就绪
□ 灰度发布策略确定
</code></pre>
<h3 data-id="heading-38">常见问题解答</h3>
<p><strong>Q1：路由决策需要多长时间？</strong></p>
<p>A：语义路由通常&lt;50ms，规则路由&lt;10ms。相比模型推理（1-3s），路由开销可忽略不计。</p>
<p><strong>Q2：如何处理路由错误？</strong></p>
<p>A：设置质量评估器，不满意时自动升级模型；同时记录错误案例用于优化。</p>
<p><strong>Q3：小团队需要路由吗？</strong></p>
<p>A：需要！即使只有2个模型（如GPT-4和GPT-3.5），路由也能节省50%以上成本。</p>
<p><strong>Q4：开源模型能用于生产吗？</strong></p>
<p>A：完全可以。Llama-3-70B、Mixtral 8x7B等开源模型性能强劲，且成本几乎为零。</p>
<h3 data-id="heading-39">资源汇总</h3>
<h4 data-id="heading-40">学术论文</h4>
<ol>
<li>RouteLLM: Learning to Route LLMs with Preference Data (ICLR 2025)</li>
<li>A Survey on Routing Strategies for Resource Optimisation (arXiv, 2025)</li>
</ol>
<h4 data-id="heading-41">开源项目</h4>
<ol>
<li><strong>RouteLLM</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flm-sys%2FRouteLLM" target="_blank" title="https://github.com/lm-sys/RouteLLM" ref="nofollow noopener noreferrer">github.com/lm-sys/Rout…</a></li>
<li><strong>Semantic Router</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faurelio-labs%2Fsemantic-router" target="_blank" title="https://github.com/aurelio-labs/semantic-router" ref="nofollow noopener noreferrer">github.com/aurelio-lab…</a></li>
<li><strong>LiteLLM</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBerriAI%2Flitellm" target="_blank" title="https://github.com/BerriAI/litellm" ref="nofollow noopener noreferrer">github.com/BerriAI/lit…</a></li>
<li><strong>vLLM</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvllm-project%2Fvllm" target="_blank" title="https://github.com/vllm-project/vllm" ref="nofollow noopener noreferrer">github.com/vllm-projec…</a></li>
</ol>
<h3 data-id="heading-42">总结与展望</h3>
<p>大模型路由算法已经从简单的规则匹配发展到今天基于深度学习的智能决策系统。2026年的趋势显示：</p>
<ol>
<li><strong>从单一决策到多轮协调</strong>：路由器不再是简单的选择器，而是多智能体的协调者</li>
<li><strong>从通用到个性化</strong>：每个用户都能获得定制化的路由策略</li>
<li><strong>从成本驱动到质量-成本平衡</strong>：更精细的帕累托最优解</li>
</ol>
<p>对于企业和开发者来说，现在正是拥抱LLM路由技术的最佳时机。通过合理的路由策略，可以显著降低成本、提升性能、改善用户体验。</p>
<p><strong>版权声明</strong>：本文内容基于公开资料整理，遵循知识共享协议。欢迎转载，请注明出处。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MCP 入门教程：用 HTTP 方式构建 AI 工具服务]]></title>    <link>https://juejin.cn/post/7598203055746875444</link>    <guid>https://juejin.cn/post/7598203055746875444</guid>    <pubDate>2026-01-22T15:09:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598203055746875444" data-draft-id="7598203055746859060" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" MCP 入门教程：用 HTTP 方式构建 AI 工具服务"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-22T15:09:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kevinIcoding"/> <meta itemprop="url" content="https://juejin.cn/user/400700903005726"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             MCP 入门教程：用 HTTP 方式构建 AI 工具服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/400700903005726/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kevinIcoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T15:09:51.000Z" title="Thu Jan 22 2026 15:09:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文基于实战项目，手把手教你用 Model Context Protocol (MCP) 构建一个天气查询服务，让大模型能够调用你的工具。</p>
</blockquote>
<h2 data-id="heading-0">什么是 MCP？</h2>
<p><strong>MCP (Model Context Protocol)</strong> 是一个开放协议，用于标准化 AI 应用与外部工具的连接方式。</p>
<p>简单理解：<strong>MCP 就是 AI 调用工具的"USB 接口"</strong>。</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────┐      MCP 协议       ┌─────────────┐
│   大模型    │  ←───────────────→  │  你的工具   │
│  (GPT/GLM)  │                     │ (天气/搜索) │
└─────────────┘                     └─────────────┘
</code></pre>
<h3 data-id="heading-1">MCP 的三大能力</h3>

























<table><thead><tr><th>能力</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><strong>Resources</strong></td><td>提供数据资源</td><td>天气数据、文档内容</td></tr><tr><td><strong>Tools</strong></td><td>提供可调用的工具</td><td>查询天气、发送邮件</td></tr><tr><td><strong>Prompts</strong></td><td>提供提示模板</td><td>分析报告模板</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">项目结构</h2>
<pre><code class="hljs language-bash" lang="bash">MCP_LLM/
├── WeatherMCPServer/
│   ├── index.js          <span class="hljs-comment"># MCP 服务核心（定义能力）</span>
│   └── mock.js           <span class="hljs-comment"># 模拟天气数据</span>
├── MCPServer/
│   └── http.js           <span class="hljs-comment"># HTTP 传输层（暴露接口）</span>
├── MCPClient/
│   └── http_client.js    <span class="hljs-comment"># 客户端（连接服务）</span>
└── chat.js               <span class="hljs-comment"># 与大模型集成</span>
</code></pre>
<hr/>
<h2 data-id="heading-3">第一步：创建 MCP 服务</h2>
<h3 data-id="heading-4">1.1 定义服务能力</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// WeatherMCPServer/index.js</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Server</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@modelcontextprotocol/sdk/server/index.js"</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">ListToolsRequestSchema</span>,
  <span class="hljs-title class_">CallToolRequestSchema</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"@modelcontextprotocol/sdk/types.js"</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherServer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建 MCP 服务器，声明支持的能力</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">server</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Server</span>(
      { <span class="hljs-attr">name</span>: <span class="hljs-string">"mcp-weather-server"</span>, <span class="hljs-attr">version</span>: <span class="hljs-string">"0.0.1"</span> },
      { <span class="hljs-attr">capabilities</span>: { <span class="hljs-attr">tools</span>: {} } }, <span class="hljs-comment">// 声明支持 tools 能力</span>
    );
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupToolHandlers</span>();
  }

  <span class="hljs-title function_">setupToolHandlers</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 告诉客户端"我有哪些工具"</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">server</span>.<span class="hljs-title function_">setRequestHandler</span>(<span class="hljs-title class_">ListToolsRequestSchema</span>, <span class="hljs-keyword">async</span> () =&gt; ({
      <span class="hljs-attr">tools</span>: [
        {
          <span class="hljs-attr">name</span>: <span class="hljs-string">"query_weather"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"查询特定地点的天气信息"</span>,
          <span class="hljs-attr">inputSchema</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-string">"object"</span>,
            <span class="hljs-attr">properties</span>: {
              <span class="hljs-attr">location</span>: {
                <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
                <span class="hljs-attr">description</span>: <span class="hljs-string">"地点（如：beijing, shanghai）"</span>,
              },
            },
            <span class="hljs-attr">required</span>: [<span class="hljs-string">"location"</span>],
          },
        },
      ],
    }));

    <span class="hljs-comment">// 2. 处理工具调用</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">server</span>.<span class="hljs-title function_">setRequestHandler</span>(<span class="hljs-title class_">CallToolRequestSchema</span>, <span class="hljs-keyword">async</span> (request) =&gt; {
      <span class="hljs-keyword">if</span> (request.<span class="hljs-property">params</span>.<span class="hljs-property">name</span> === <span class="hljs-string">"query_weather"</span>) {
        <span class="hljs-keyword">const</span> location = request.<span class="hljs-property">params</span>.<span class="hljs-property">arguments</span>?.<span class="hljs-property">location</span>;
        <span class="hljs-comment">// 这里可以调用真实的天气 API</span>
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">content</span>: [
            {
              <span class="hljs-attr">type</span>: <span class="hljs-string">"text"</span>,
              <span class="hljs-attr">text</span>: <span class="hljs-string">`<span class="hljs-subst">${location}</span>：晴，25°C，湿度 45%`</span>,
            },
          ],
        };
      }
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"未知工具"</span>);
    });
  }

  <span class="hljs-title function_">getServer</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">server</span>;
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">WeatherServer</span>;
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li><code>Server</code> 构造时声明 <code>capabilities</code>，表示支持哪些能力</li>
<li><code>setRequestHandler</code> 注册处理器，响应客户端请求</li>
<li><code>ListToolsRequestSchema</code> → 返回工具列表</li>
<li><code>CallToolRequestSchema</code> → 执行工具调用</li>
</ul>
<hr/>
<h3 data-id="heading-5">1.2 暴露 HTTP 接口</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// MCPServer/http.js</span>
<span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">"express"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StreamableHTTPServerTransport</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@modelcontextprotocol/sdk/server/streamableHttp.js"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">WeatherServer</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"../WeatherMCPServer/index.js"</span>;

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());

<span class="hljs-keyword">const</span> weatherServer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeatherServer</span>();

<span class="hljs-comment">// 核心：POST /mcp 处理所有 MCP 请求</span>
app.<span class="hljs-title function_">post</span>(<span class="hljs-string">"/mcp"</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> server = weatherServer.<span class="hljs-title function_">getServer</span>();

    <span class="hljs-comment">// 每个请求创建独立的传输实例（无状态模式）</span>
    <span class="hljs-keyword">const</span> transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamableHTTPServerTransport</span>({
      <span class="hljs-attr">sessionIdGenerator</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-comment">// 不维护会话</span>
    });

    <span class="hljs-comment">// 请求结束时清理资源</span>
    res.<span class="hljs-title function_">on</span>(<span class="hljs-string">"close"</span>, <span class="hljs-function">() =&gt;</span> {
      transport.<span class="hljs-title function_">close</span>();
      server.<span class="hljs-title function_">close</span>();
    });

    <span class="hljs-comment">// 连接 MCP 服务器与传输层</span>
    <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">connect</span>(transport);

    <span class="hljs-comment">// 处理请求并返回响应</span>
    <span class="hljs-keyword">await</span> transport.<span class="hljs-title function_">handleRequest</span>(req, res, req.<span class="hljs-property">body</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">json</span>({
      <span class="hljs-attr">jsonrpc</span>: <span class="hljs-string">"2.0"</span>,
      <span class="hljs-attr">error</span>: { <span class="hljs-attr">code</span>: -<span class="hljs-number">32603</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"服务器错误"</span> },
      <span class="hljs-attr">id</span>: <span class="hljs-literal">null</span>,
    });
  }
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3200</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"MCP HTTP 服务已启动: http://localhost:3200/mcp"</span>);
});
</code></pre>
<p><strong>为什么每次请求都创建新的 transport？</strong></p>
<ul>
<li><strong>隔离性</strong>：避免并发请求的 ID 冲突</li>
<li><strong>无状态</strong>：适合负载均衡和水平扩展</li>
<li><strong>资源清理</strong>：请求结束自动释放</li>
</ul>
<hr/>
<h2 data-id="heading-6">第二步：创建客户端</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// MCPClient/http_client.js</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Client</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@modelcontextprotocol/sdk/client/index.js"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StreamableHTTPClientTransport</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@modelcontextprotocol/sdk/client/streamableHttp.js"</span>;

<span class="hljs-comment">// 创建客户端</span>
<span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Client</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"weather-http-client"</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
});

<span class="hljs-comment">// 连接到 MCP 服务</span>
<span class="hljs-keyword">const</span> transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamableHTTPClientTransport</span>(
  <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">"http://localhost:3200/mcp"</span>),
);
<span class="hljs-keyword">await</span> client.<span class="hljs-title function_">connect</span>(transport);

<span class="hljs-comment">// 现在可以调用 MCP 能力了！</span>
<span class="hljs-keyword">const</span> tools = <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">listTools</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"可用工具:"</span>, tools);

<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">callTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"query_weather"</span>,
  <span class="hljs-attr">arguments</span>: { <span class="hljs-attr">location</span>: <span class="hljs-string">"beijing"</span> },
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"查询结果:"</span>, result);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> client;
</code></pre>
<hr/>
<h2 data-id="heading-7">第三步：与大模型集成</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// chat.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ZhipuAI</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"zhipu-sdk-js"</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runConversation</span>(<span class="hljs-params">mcpClient</span>) {
  <span class="hljs-keyword">const</span> userMessage = <span class="hljs-string">"北京今天天气怎么样？"</span>;

  <span class="hljs-comment">// 1. 从 MCP 获取可用工具</span>
  <span class="hljs-keyword">const</span> mcpTools = <span class="hljs-keyword">await</span> mcpClient.<span class="hljs-title function_">listTools</span>();
  <span class="hljs-keyword">const</span> tools = mcpTools.<span class="hljs-property">tools</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">tool</span>) =&gt;</span> ({
    <span class="hljs-attr">type</span>: <span class="hljs-string">"function"</span>,
    <span class="hljs-attr">function</span>: {
      <span class="hljs-attr">name</span>: tool.<span class="hljs-property">name</span>,
      <span class="hljs-attr">description</span>: tool.<span class="hljs-property">description</span>,
      <span class="hljs-attr">parameters</span>: tool.<span class="hljs-property">inputSchema</span>,
    },
  }));

  <span class="hljs-comment">// 2. 发送给大模型，让它决定是否调用工具</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> zhipuClient.<span class="hljs-title function_">createCompletions</span>({
    <span class="hljs-attr">model</span>: <span class="hljs-string">"glm-4.5-flash"</span>,
    <span class="hljs-attr">messages</span>: [{ <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>, <span class="hljs-attr">content</span>: userMessage }],
    <span class="hljs-attr">tools</span>: tools,
  });

  <span class="hljs-keyword">const</span> message = response.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>;

  <span class="hljs-comment">// 3. 如果大模型决定调用工具</span>
  <span class="hljs-keyword">if</span> (message.<span class="hljs-property">tool_calls</span>?.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> toolCall = message.<span class="hljs-property">tool_calls</span>[<span class="hljs-number">0</span>];

    <span class="hljs-comment">// 4. 执行 MCP 工具调用</span>
    <span class="hljs-keyword">const</span> toolResult = <span class="hljs-keyword">await</span> mcpClient.<span class="hljs-title function_">callTool</span>({
      <span class="hljs-attr">name</span>: toolCall.<span class="hljs-property">function</span>.<span class="hljs-property">name</span>,
      <span class="hljs-attr">arguments</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(toolCall.<span class="hljs-property">function</span>.<span class="hljs-property">arguments</span>),
    });

    <span class="hljs-comment">// 5. 把结果返回给大模型生成最终回答</span>
    <span class="hljs-keyword">const</span> finalResponse = <span class="hljs-keyword">await</span> zhipuClient.<span class="hljs-title function_">createCompletions</span>({
      <span class="hljs-attr">model</span>: <span class="hljs-string">"glm-4.5-flash"</span>,
      <span class="hljs-attr">messages</span>: [
        { <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>, <span class="hljs-attr">content</span>: userMessage },
        message,
        {
          <span class="hljs-attr">role</span>: <span class="hljs-string">"tool"</span>,
          <span class="hljs-attr">tool_call_id</span>: toolCall.<span class="hljs-property">id</span>,
          <span class="hljs-attr">content</span>: toolResult.<span class="hljs-property">content</span>[<span class="hljs-number">0</span>].<span class="hljs-property">text</span>,
        },
      ],
    });

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(finalResponse.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">content</span>);
    <span class="hljs-comment">// 输出：北京今天天气晴朗，气温25°C，湿度45%，非常适合出行。</span>
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-8">完整流程图</h2>
<pre><code class="hljs language-bash" lang="bash">用户: <span class="hljs-string">"北京天气怎么样？"</span>
        │
        ▼
┌───────────────────────────────────────────────────────────┐
│                      chat.js                               │
│  1. client.listTools() ──→ 获取 MCP 工具列表               │
│  2. 发送给大模型 ──→ 大模型决定调用 query_weather          │
│  3. client.callTool({name, arguments}) ──→ 执行工具        │
│  4. 把结果发回大模型 ──→ 生成自然语言回答                  │
└───────────────────────────────────────────────────────────┘
        │                           ▲
        │ HTTP POST                 │ 工具结果
        ▼                           │
┌───────────────────────────────────────────────────────────┐
│                   MCPServer/http.js                        │
│  POST /mcp ──→ StreamableHTTPServerTransport               │
│                          │                                 │
│                          ▼                                 │
│              WeatherMCPServer/index.js                     │
│              - ListToolsRequestSchema                      │
│              - CallToolRequestSchema                       │
└───────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-9">运行项目</h2>
<h3 data-id="heading-10">1. 安装依赖</h3>
<pre><code class="hljs language-bash" lang="bash">pnpm install
</code></pre>
<h3 data-id="heading-11">2. 配置环境变量</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .env</span>
ZHIPUAI_API_KEY=your_api_key_here
</code></pre>
<h3 data-id="heading-12">3. 启动服务</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 终端 1：启动 MCP HTTP 服务</span>
node MCPServer/http.js

<span class="hljs-comment"># 终端 2：运行对话</span>
node main/http.js
</code></pre>
<hr/>
<h2 data-id="heading-13">核心概念总结</h2>








































<table><thead><tr><th>概念</th><th>服务端</th><th>客户端</th></tr></thead><tbody><tr><td>入口类</td><td><code>Server</code></td><td><code>Client</code></td></tr><tr><td>传输层</td><td><code>StreamableHTTPServerTransport</code></td><td><code>StreamableHTTPClientTransport</code></td></tr><tr><td>声明能力</td><td><code>capabilities: { tools: {} }</code></td><td>-</td></tr><tr><td>注册处理</td><td><code>setRequestHandler(Schema, handler)</code></td><td>-</td></tr><tr><td>调用能力</td><td>-</td><td><code>listTools()</code> / <code>callTool()</code></td></tr><tr><td>建立连接</td><td><code>server.connect(transport)</code></td><td><code>client.connect(transport)</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-14">扩展：添加新工具</h2>
<p>只需两步：</p>
<p><strong>1. 在 <code>ListToolsRequestSchema</code> 中声明：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">tools</span>: [
  { <span class="hljs-attr">name</span>: <span class="hljs-string">"query_weather"</span>, ... },
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"send_email"</span>,           <span class="hljs-comment">// 新工具</span>
    <span class="hljs-attr">description</span>: <span class="hljs-string">"发送邮件"</span>,
    <span class="hljs-attr">inputSchema</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"object"</span>,
      <span class="hljs-attr">properties</span>: {
        <span class="hljs-attr">to</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span> },
        <span class="hljs-attr">subject</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span> },
        <span class="hljs-attr">body</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span> }
      },
      <span class="hljs-attr">required</span>: [<span class="hljs-string">"to"</span>, <span class="hljs-string">"subject"</span>, <span class="hljs-string">"body"</span>]
    }
  }
]
</code></pre>
<p><strong>2. 在 <code>CallToolRequestSchema</code> 中实现：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">case</span> <span class="hljs-string">"send_email"</span>: {
  <span class="hljs-keyword">const</span> { to, subject, body } = request.<span class="hljs-property">params</span>.<span class="hljs-property">arguments</span>;
  <span class="hljs-comment">// 调用邮件服务...</span>
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">content</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">"text"</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">`邮件已发送至 <span class="hljs-subst">${to}</span>`</span> }] };
}
</code></pre>
<hr/>
<h2 data-id="heading-15">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2F" target="_blank" title="https://modelcontextprotocol.io/" ref="nofollow noopener noreferrer">MCP 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelcontextprotocol%2Ftypescript-sdk" target="_blank" title="https://github.com/modelcontextprotocol/typescript-sdk" ref="nofollow noopener noreferrer">MCP TypeScript SDK</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.bigmodel.cn%2F" target="_blank" title="https://open.bigmodel.cn/" ref="nofollow noopener noreferrer">智谱 AI 开放平台</a></li>
</ul>
<hr/>
<blockquote>
<p>💡 <strong>小贴士</strong>：MCP 还支持 STDIO 和 SSE 两种传输方式，适合不同场景。HTTP 最适合生产环境和 API 集成。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🤖经典智能体范式]]></title>    <link>https://juejin.cn/post/7598021984299597851</link>    <guid>https://juejin.cn/post/7598021984299597851</guid>    <pubDate>2026-01-22T15:30:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598021984299597851" data-draft-id="7597946284678709267" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🤖经典智能体范式"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-01-22T15:30:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小小小怪兽"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036166776"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🤖经典智能体范式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036166776/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小小小怪兽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T15:30:01.000Z" title="Thu Jan 22 2026 15:30:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、引言：为什么需要智能体</h2>
<h3 data-id="heading-1">1.1 大模型的局限</h3>
<p>之前的GPT-4等大模型停留在聊天框中且存在一些问题：一是“幻觉”，可能生成错误信息或不存在的内容；二是时效性不足，对未训练的新内容缺乏准确认知；三是复杂任务可靠性差，多步骤任务中易出现逻辑混乱。这些问题无法仅靠模型调优解决，所以智能体成为关键方案。</p>
<h3 data-id="heading-2">1.2 智能体的核心价值</h3>
<p>智能体通过“大脑（LLM）-感知（环境信息捕捉）-动作（工具调用）”闭环，让LLM具备“思考、行动、感知”能力。相比单纯调用大模型，智能体可动态适应、与外部工具交互，高效处理复杂任务，比如代码生成、自动完成任务等。</p>
<h2 data-id="heading-3">二、什么是智能体</h2>
<p>智能体（Agent）是能自主感知环境、推理决策、执行动作，并通过反馈迭代优化的智能系统。在目前大模型加持下，智能体以LLM为“决策大脑”，结合外部工具与环境交互，核心目标是将抽象任务转化为可落地的分步操作，解决单纯大模型“只会说不会做”“易幻觉”的问题。</p>
<p>核心特征：</p>
<ul>
<li>自主性（无需人工干预即可推进任务）</li>
<li>交互性（能与工具、环境、用户反馈交互）</li>
<li>迭代性（可基于结果优化决策逻辑）</li>
</ul>
<p>简单来说，大模型是“知识库”，智能体是“执行者”，二者结合可实现复杂任务的端到端落地。</p>
<h3 data-id="heading-4">智能体基础架构：三大核心组件</h3>
<p>智能体由以下三个核心部分组成：</p>
<ul>
<li><strong>大脑</strong>：大语言模型，负责任务推理、决策与记忆；</li>
<li><strong>感知模块</strong>：捕捉外部信息（工具反馈、任务状态等）；</li>
<li><strong>动作模块</strong>：调用工具执行操作（API、代码解释器等。</li>
</ul>
<p>为了更好地组织智能体的“思考”与“行动”过程，目前出现很多智能体的架构范式，本文聚焦最经典的三种<code>ReAct</code>、<code>Plan-and-Solve</code>、<code>Reflection</code>三种范式，深入了解智能体。</p>
<h2 data-id="heading-5">三、范式深度解析</h2>
<h3 data-id="heading-6">3.1 ReAct：边想边做，动态适配</h3>
<h4 data-id="heading-7">3.1.1 核心原理</h4>
<h5 data-id="heading-8">ReAct（Reason + Act）范式的核心是“边推理边行动”，通过“思考-行动-观察”的闭环迭代，让智能体在动态交互中完成任务。其核心概念是“推理与行动绑定”——智能体不预先规划完整路径，而是每一步先分析当前状态（Thought），再执行具体动作（Action），最后根据反馈调整下一步策略（Observation）。</h5>
<p>模拟人类解决未知问题的过程：比如查陌生城市天气+景点推荐，不会先规划所有步骤，而是先查天气（行动），根据天气结果（观察）再推荐室内/室外景点（思考+行动）。ReAct通过将推理过程显性化，能有效降低大模型幻觉，提升任务执行的可靠性。</p>
<h4 data-id="heading-9">3.1.2 代码示例（天气查询场景）</h4>
<p>基于Python实现轻量ReAct智能体，含工具注册、闭环执行核心逻辑：</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Union</span>, <span class="hljs-type">Optional</span>, <span class="hljs-type">Tuple</span>, <span class="hljs-type">Dict</span>

<span class="hljs-comment"># 1. 工具定义：天气查询工具</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""调用公开天气API，返回城市天气信息"""</span>
    api_key = <span class="hljs-string">"your-weather-api-key"</span>  <span class="hljs-comment"># 替换为实际API密钥</span>
    url = <span class="hljs-string">f"http://apis.juhe.cn/simpleWeather/query?city=<span class="hljs-subst">{city}</span>&amp;key=<span class="hljs-subst">{api_key}</span>"</span>
    <span class="hljs-keyword">try</span>:
        res = requests.get(url).json()
        <span class="hljs-keyword">if</span> res[<span class="hljs-string">"error_code"</span>] == <span class="hljs-number">0</span>:
            data = res[<span class="hljs-string">"result"</span>][<span class="hljs-string">"realtime"</span>]
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{city}</span>今日天气：<span class="hljs-subst">{data[<span class="hljs-string">'info'</span>]}</span>，温度<span class="hljs-subst">{data[<span class="hljs-string">'temperature'</span>]}</span>℃"</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"查询失败：<span class="hljs-subst">{res[<span class="hljs-string">'reason'</span>]}</span>"</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"异常：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>

<span class="hljs-comment"># 2. 工具执行器：管理工具注册与调用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolExecutor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.tools = {}  <span class="hljs-comment"># key:工具名，value:(描述, 函数)</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, desc: <span class="hljs-built_in">str</span>, func</span>):
        <span class="hljs-string">"""注册工具"""</span>
        self.tools[name] = (desc, func)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_tool</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">callable</span>]:
        <span class="hljs-string">"""获取工具函数"""</span>
        <span class="hljs-keyword">return</span> self.tools.get(name, (<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>))[<span class="hljs-number">1</span>]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_tool_desc</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""生成工具描述（用于LLM提示词）"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"\n"</span>.join([<span class="hljs-string">f"<span class="hljs-subst">{k}</span>: <span class="hljs-subst">{v[<span class="hljs-number">0</span>]}</span>"</span> <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> self.tools.items()])

<span class="hljs-comment"># 3. LLM输出格式约束（避免解析混乱）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolAction</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-built_in">type</span>: <span class="hljs-built_in">str</span> = Field(default=<span class="hljs-string">"tool"</span>, description=<span class="hljs-string">"动作类型：tool/finish"</span>)
    name: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"工具名，type为tool时必填"</span>)
    <span class="hljs-built_in">input</span>: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"工具输入，type为tool时必填"</span>)
    answer: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"最终答案，type为finish时必填"</span>)

<span class="hljs-comment"># 4. ReAct智能体核心类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReActAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm_client, tool_executor: ToolExecutor, max_steps: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):
        self.llm = llm_client  <span class="hljs-comment"># LLM客户端（封装OpenAI/本地化模型）</span>
        self.tool_exec = tool_executor
        self.max_steps = max_steps  <span class="hljs-comment"># 最大迭代步数（防死循环）</span>
        self.history = []  <span class="hljs-comment"># 存储执行历史（思考+动作+观察）</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_parse_llm_output</span>(<span class="hljs-params">self, output: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>], <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>]]:
        <span class="hljs-string">"""解析LLM输出，提取思考过程和动作"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 简化解析：实际可结合JSON Schema严格校验</span>
            <span class="hljs-keyword">import</span> json
            res = json.loads(output)
            <span class="hljs-keyword">return</span> res.get(<span class="hljs-string">"thought"</span>), res.get(<span class="hljs-string">"action"</span>)
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""执行任务：思考-行动-观察闭环"""</span>
        self.history = []
        <span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.max_steps):
            <span class="hljs-comment"># 1. 构建提示词</span>
            tool_desc = self.tool_exec.get_tool_desc()
            history_str = <span class="hljs-string">"\n"</span>.join(self.history)
            prompt = <span class="hljs-string">f"""
            你可调用以下工具：
            <span class="hljs-subst">{tool_desc}</span>
            请按JSON格式输出：{{"thought":"思考过程","action":{{"type":"tool/finish","name":"工具名","input":"输入","answer":"最终答案"}}}}
            示例：调用工具{{"thought":"需查天气","action":{{"type":"tool","name":"get_weather","input":"北京"}}}}
            示例：完成任务{{"thought":"已获取结果","action":{{"type":"finish","answer":"北京今日晴"}}}}
            
            问题：<span class="hljs-subst">{question}</span>
            历史记录：<span class="hljs-subst">{history_str}</span>
            """</span>
            <span class="hljs-comment"># 2. 调用LLM获取响应</span>
            llm_output = self.llm.chat(prompt)
            thought, action = self._parse_llm_output(llm_output)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> action:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"步骤<span class="hljs-subst">{step+<span class="hljs-number">1</span>}</span>：解析失败，跳过"</span>)
                <span class="hljs-keyword">continue</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"步骤<span class="hljs-subst">{step+<span class="hljs-number">1</span>}</span>：思考：<span class="hljs-subst">{thought}</span>"</span>)
            
            <span class="hljs-comment"># 3. 处理动作（完成/调用工具）</span>
            <span class="hljs-keyword">if</span> action[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"finish"</span>:
                <span class="hljs-keyword">return</span> action[<span class="hljs-string">"answer"</span>]
            <span class="hljs-keyword">if</span> action[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"tool"</span>:
                tool_name = action[<span class="hljs-string">"name"</span>]
                tool_input = action[<span class="hljs-string">"input"</span>]
                tool_func = self.tool_exec.get_tool(tool_name)
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> tool_func:
                    observation = <span class="hljs-string">f"工具<span class="hljs-subst">{tool_name}</span>未注册"</span>
                <span class="hljs-keyword">else</span>:
                    observation = tool_func(tool_input)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"步骤<span class="hljs-subst">{step+<span class="hljs-number">1</span>}</span>：动作：调用<span class="hljs-subst">{tool_name}</span>(<span class="hljs-subst">{tool_input}</span>)，观察：<span class="hljs-subst">{observation}</span>"</span>)
                <span class="hljs-comment"># 4. 记录历史，进入下一轮</span>
                self.history.append(<span class="hljs-string">f"思考：<span class="hljs-subst">{thought}</span>"</span>)
                self.history.append(<span class="hljs-string">f"动作：<span class="hljs-subst">{tool_name}</span>(<span class="hljs-subst">{tool_input}</span>)"</span>)
                self.history.append(<span class="hljs-string">f"观察：<span class="hljs-subst">{observation}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">"任务超时未完成"</span>

<span class="hljs-comment"># 5. 运行示例</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 初始化LLM客户端（此处简化，实际需封装API调用）</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleLLMClient</span>:
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">self, prompt: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
            <span class="hljs-comment"># 模拟LLM输出（实际替换为真实调用）</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">'{"thought":"用户查上海天气，需调用get_weather工具","action":{"type":"tool","name":"get_weather","input":"上海"}}'</span>
    
    <span class="hljs-comment"># 注册工具并运行</span>
    tool_exec = ToolExecutor()
    tool_exec.register(<span class="hljs-string">"get_weather"</span>, <span class="hljs-string">"查询城市天气，输入为城市名"</span>, get_weather)
    agent = ReActAgent(SimpleLLMClient(), tool_exec)
    result = agent.run(<span class="hljs-string">"上海今天天气怎么样？"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"最终结果：<span class="hljs-subst">{result}</span>"</span>)
    
</code></pre>
<h4 data-id="heading-10">3.1.3 总结</h4>
<p><strong>特点</strong>：</p>
<ol>
<li>可解释：通过<code>Thought</code>链，清晰展示逻辑与流程，有利于理解、信任和调试智能体；</li>
<li>动态规划：根据当前情况再处理问题，加强了纠错能力；</li>
<li>工具协作：模型推理，工具处理具体任务，解决了之前大模型只能说的问题。</li>
</ol>
<p><strong>不足</strong>：</p>
<ol>
<li>依赖大模型的推理能力；</li>
<li>因为边思考边行动的模式，导致使用LLM的频率会很高，导致任务的总耗时和花费比较高</li>
<li>可能是局部最优，缺少全局规划</li>
</ol>
<h3 data-id="heading-11">3.2 Plan-and-Solve：先规划后执行</h3>
<h4 data-id="heading-12">3.2.1 核心原理</h4>
<h4 data-id="heading-13">Plan-and-Solve（规划-执行）范式的核心是“先谋后动”，核心概念是“规划与执行解耦”——将复杂任务拆分为可落地、有依赖关系的子步骤（<strong>Planning Phase</strong>），再按步骤执行(<strong>Solving Phase</strong>)并验证结果。如果某一步失败则动态调整计划（重规划阶段）。</h4>
<p>其核心逻辑是“结构化拆解”，适合任务目标清晰、步骤可预判的场景。比如开发一个用户管理系统，不会直接上手编码，而是先拆分“需求分析→技术选型→数据库设计→开发→测试”等步骤，再逐一落地，若技术选型不合理则调整计划后重新推进。</p>
<h4 data-id="heading-14">3.2.2 代码示例（项目拆分场景）</h4>
<p>含任务规划、步骤执行、重规划核心逻辑：</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Optional</span>, <span class="hljs-type">Tuple</span>

<span class="hljs-comment"># 1. 规划器：生成/调整任务步骤</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Planner</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm_client</span>):
        self.llm = llm_client
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_plan</span>(<span class="hljs-params">self, task: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""生成初始任务计划（拆分子步骤）"""</span>
        prompt = <span class="hljs-string">f"""
        请将以下任务拆分为3-5个可执行子步骤，按JSON数组返回，仅输出数组：
        任务：<span class="hljs-subst">{task}</span>
        示例：["步骤1：需求分析", "步骤2：技术选型", "步骤3：代码开发"]
        """</span>
        llm_output = self.llm.chat(prompt)
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">return</span> json.loads(llm_output)
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> [<span class="hljs-string">"步骤1：默认处理任务"</span>]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">replan</span>(<span class="hljs-params">self, task: <span class="hljs-built_in">str</span>, original_plan: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], failed_step: <span class="hljs-built_in">str</span>, reason: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""重规划：基于失败步骤调整计划"""</span>
        prompt = <span class="hljs-string">f"""
        原始任务：<span class="hljs-subst">{task}</span>
        原始计划：<span class="hljs-subst">{original_plan}</span>
        失败步骤：<span class="hljs-subst">{failed_step}</span>
        失败原因：<span class="hljs-subst">{reason}</span>
        请调整计划，返回新的子步骤（JSON数组，仅输出数组）：
        """</span>
        llm_output = self.llm.chat(prompt)
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">return</span> json.loads(llm_output)
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> original_plan  <span class="hljs-comment"># 失败则沿用原计划</span>

<span class="hljs-comment"># 2. 执行器：执行步骤并验证结果</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Executor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm_client</span>):
        self.llm = llm_client
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_step</span>(<span class="hljs-params">self, step: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""执行单个步骤（模拟开发场景任务执行）"""</span>
        prompt = <span class="hljs-string">f"""
        请模拟执行以下开发步骤，返回执行结果（简洁直白）：
        步骤：<span class="hljs-subst">{step}</span>
        """</span>
        <span class="hljs-keyword">return</span> self.llm.chat(prompt)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">validate_step</span>(<span class="hljs-params">self, step: <span class="hljs-built_in">str</span>, result: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""验证步骤执行结果（成功/失败+原因）"""</span>
        prompt = <span class="hljs-string">f"""
        步骤：<span class="hljs-subst">{step}</span>
        执行结果：<span class="hljs-subst">{result}</span>
        请判断执行是否成功（true/false），并返回原因（格式：布尔值|原因）：
        """</span>
        llm_output = self.llm.chat(prompt)
        <span class="hljs-keyword">try</span>:
            success, reason = llm_output.split(<span class="hljs-string">"|"</span>)
            <span class="hljs-keyword">return</span> success.lower() == <span class="hljs-string">"true"</span>, reason.strip()
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-string">"验证失败"</span>

<span class="hljs-comment"># 3. Plan-and-Solve智能体核心类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PlanAndSolveAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm_client, max_replan: <span class="hljs-built_in">int</span> = <span class="hljs-number">2</span></span>):
        self.llm = llm_client
        self.planner = Planner(llm_client)
        self.executor = Executor(llm_client)
        self.max_replan = max_replan  <span class="hljs-comment"># 最大重规划次数</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, task: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""执行任务：规划→执行→重规划闭环"""</span>
        <span class="hljs-comment"># 1. 生成初始计划</span>
        plan = self.planner.generate_plan(task)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"初始计划：<span class="hljs-subst">{plan}</span>"</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> plan:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"生成计划失败"</span>
        
        replan_count = <span class="hljs-number">0</span>
        current_idx = <span class="hljs-number">0</span>  <span class="hljs-comment"># 当前执行步骤索引</span>
        <span class="hljs-keyword">while</span> current_idx &lt; <span class="hljs-built_in">len</span>(plan):
            step = plan[current_idx]
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n执行步骤<span class="hljs-subst">{current_idx+<span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{<span class="hljs-built_in">len</span>(plan)}</span>：<span class="hljs-subst">{step}</span>"</span>)
            
            <span class="hljs-comment"># 2. 执行步骤并验证</span>
            step_result = self.executor.execute_step(step)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"步骤结果：<span class="hljs-subst">{step_result}</span>"</span>)
            success, reason = self.executor.validate_step(step, step_result)
            
            <span class="hljs-keyword">if</span> success:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"步骤<span class="hljs-subst">{current_idx+<span class="hljs-number">1</span>}</span>：执行成功"</span>)
                current_idx += <span class="hljs-number">1</span>
                <span class="hljs-keyword">continue</span>
            
            <span class="hljs-comment"># 3. 步骤失败，触发重规划</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"步骤<span class="hljs-subst">{current_idx+<span class="hljs-number">1</span>}</span>：执行失败，原因：<span class="hljs-subst">{reason}</span>"</span>)
            <span class="hljs-keyword">if</span> replan_count &gt;= self.max_replan:
                <span class="hljs-keyword">return</span> <span class="hljs-string">f"任务失败：步骤<span class="hljs-subst">{current_idx+<span class="hljs-number">1</span>}</span>多次执行失败，已达最大重规划次数"</span>
            
            replan_count += <span class="hljs-number">1</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{replan_count}</span>次重规划..."</span>)
            plan = self.planner.replan(task, plan, step, reason)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"重规划后计划：<span class="hljs-subst">{plan}</span>"</span>)
            current_idx = <span class="hljs-number">0</span>  <span class="hljs-comment"># 重规划后从第一步重新执行</span>
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"任务成功完成，执行步骤：<span class="hljs-subst">{plan}</span>"</span>

<span class="hljs-comment"># 4. 运行示例</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 初始化简化LLM客户端</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleLLMClient</span>:
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">self, prompt: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
            <span class="hljs-comment"># 模拟LLM输出（实际替换为真实调用）</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">"拆分为"</span> <span class="hljs-keyword">in</span> prompt:
                <span class="hljs-keyword">return</span> <span class="hljs-string">'["步骤1：需求分析（明确用户管理功能）", "步骤2：技术选型（React+Node.js）", "步骤3：数据库设计（用户表）", "步骤4：代码开发", "步骤5：测试部署"]'</span>
            <span class="hljs-keyword">elif</span> <span class="hljs-string">"执行步骤1"</span> <span class="hljs-keyword">in</span> prompt:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"已完成需求分析，明确需包含注册、登录、权限管理功能"</span>
            <span class="hljs-keyword">elif</span> <span class="hljs-string">"验证步骤1"</span> <span class="hljs-keyword">in</span> prompt:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"true|需求分析全面，符合预期"</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"执行中..."</span>
    
    agent = PlanAndSolveAgent(SimpleLLMClient())
    result = agent.run(<span class="hljs-string">"开发一个用户管理系统"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n最终结果：<span class="hljs-subst">{result}</span>"</span>)
    
</code></pre>
<h4 data-id="heading-15">3.2.3 总结</h4>
<p><strong>核心要点</strong>：</p>
<ol>
<li>提供稳定、结构化的执行流程；</li>
<li>适合路径清晰，侧重推理和步骤分解的任务；</li>
<li>执行路径清晰，便于调试追溯</li>
</ol>
<p><strong>不足</strong>：灵活性不足，应对突发需求调整繁琐。</p>
<h3 data-id="heading-16">3.3 Reflection：自我迭代，持续优化</h3>
<h4 data-id="heading-17">3.3.1 核心原理</h4>
<h4 data-id="heading-18">Reflection（反思）的核心是“自我迭代优化”，核心概念是“反馈驱动改进”——智能体先生成初始结果(<strong>Execution</strong>)，再从多维度自我评审（<strong>Reflection</strong>），识别不足后迭代优化(<strong>Refinement</strong>)，直至达到预期质量。</h4>
<p>模拟人类“初稿-修改-定稿”的工作流程，比如编写代码时，先写初始版本，再自查语法错误、逻辑漏洞、性能问题，逐轮优化。通过“反思”模块，让智能体具备纠错能力，大幅提升输出质量。</p>
<h4 data-id="heading-19">3.3.2 代码示例（代码优化场景）</h4>
<p>Reflection智能体，含多维度反思、迭代优化核心逻辑：</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>

<span class="hljs-comment"># 1. 反思维度定义（代码优化核心维度）</span>
REFLECTION_DIMENSIONS = [
    <span class="hljs-string">"语法正确性：是否存在语法错误"</span>,
    <span class="hljs-string">"逻辑完整性：是否覆盖所有场景（如空值处理）"</span>,
    <span class="hljs-string">"性能优化：是否存在冗余代码，执行效率如何"</span>,
    <span class="hljs-string">"格式规范：是否符合PEP 8编码规范"</span>
]

<span class="hljs-comment"># 2. 反思器：多维度评审结果</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Reflector</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm_client</span>):
        self.llm = llm_client
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">reflect</span>(<span class="hljs-params">self, task: <span class="hljs-built_in">str</span>, result: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""多维度反思，返回各维度反馈"""</span>
        prompt = <span class="hljs-string">f"""
        任务：<span class="hljs-subst">{task}</span>
        生成结果（代码）：<span class="hljs-subst">{result}</span>
        请按以下维度评审，返回各维度反馈（JSON格式，key为维度，value为反馈）：
        <span class="hljs-subst">{REFLECTION_DIMENSIONS}</span>
        示例：{{"语法正确性":"无语法错误","逻辑完整性":"缺少空值处理"}}
        """</span>
        llm_output = self.llm.chat(prompt)
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">import</span> json
            <span class="hljs-keyword">return</span> json.loads(llm_output)
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"默认反馈"</span>: <span class="hljs-string">"评审失败，无有效反馈"</span>}

<span class="hljs-comment"># 3. Reflection智能体核心类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReflectionAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm_client, max_iter: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span></span>):
        self.llm = llm_client
        self.reflector = Reflector(llm_client)
        self.max_iter = max_iter  <span class="hljs-comment"># 最大迭代优化次数</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_initial</span>(<span class="hljs-params">self, task: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""生成初始结果（代码）"""</span>
        prompt = <span class="hljs-string">f"""
        请完成以下开发任务，返回代码（仅输出代码，无需解释）：
        任务：<span class="hljs-subst">{task}</span>
        """</span>
        <span class="hljs-keyword">return</span> self.llm.chat(prompt)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">optimize</span>(<span class="hljs-params">self, task: <span class="hljs-built_in">str</span>, current_result: <span class="hljs-built_in">str</span>, feedback: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""基于反馈优化结果（代码）"""</span>
        feedback_str = <span class="hljs-string">"\n"</span>.join([<span class="hljs-string">f"<span class="hljs-subst">{k}</span>：<span class="hljs-subst">{v}</span>"</span> <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> feedback.items()])
        prompt = <span class="hljs-string">f"""
        任务：<span class="hljs-subst">{task}</span>
        当前代码：<span class="hljs-subst">{current_result}</span>
        评审反馈：<span class="hljs-subst">{feedback_str}</span>
        请根据反馈优化代码，仅输出优化后的代码（无需解释）：
        """</span>
        <span class="hljs-keyword">return</span> self.llm.chat(prompt)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, task: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""执行任务：生成→反思→优化闭环"""</span>
        <span class="hljs-comment"># 1. 生成初始代码</span>
        current_code = self.generate_initial(task)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"初始代码：\n<span class="hljs-subst">{current_code}</span>"</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> current_code:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"生成初始代码失败"</span>
        
        <span class="hljs-comment"># 2. 多轮迭代优化</span>
        <span class="hljs-keyword">for</span> <span class="hljs-built_in">iter</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.max_iter):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n第<span class="hljs-subst">{<span class="hljs-built_in">iter</span>+<span class="hljs-number">1</span>}</span>轮优化："</span>)
            <span class="hljs-comment"># 反思评审</span>
            feedback = self.reflector.reflect(task, current_code)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"评审反馈：<span class="hljs-subst">{feedback}</span>"</span>)
            <span class="hljs-comment"># 检查是否无需优化</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">all</span>([<span class="hljs-string">"无问题"</span> <span class="hljs-keyword">in</span> v <span class="hljs-keyword">or</span> <span class="hljs-string">"符合"</span> <span class="hljs-keyword">in</span> v <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> feedback.values()]):
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"所有维度符合要求，停止优化"</span>)
                <span class="hljs-keyword">break</span>
            <span class="hljs-comment"># 优化代码</span>
            current_code = self.optimize(task, current_code, feedback)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"优化后代码：\n<span class="hljs-subst">{current_code}</span>"</span>)
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"最终优化代码：\n<span class="hljs-subst">{current_code}</span>"</span>

<span class="hljs-comment"># 4. 运行示例</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 初始化简化LLM客户端</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleLLMClient</span>:
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">self, prompt: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
            <span class="hljs-comment"># 模拟LLM输出（实际替换为真实调用）</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">"生成初始代码"</span> <span class="hljs-keyword">in</span> prompt <span class="hljs-keyword">or</span> <span class="hljs-string">"完成以下开发任务"</span> <span class="hljs-keyword">in</span> prompt:
                <span class="hljs-comment"># 初始代码（存在空值未处理问题）</span>
                <span class="hljs-keyword">return</span> <span class="hljs-string">'''def add(a, b):
    return a + b

def calculate_sum(numbers):
    total = 0
    for num in numbers:
        total += num
    return total'''</span>
            <span class="hljs-keyword">elif</span> <span class="hljs-string">"评审反馈"</span> <span class="hljs-keyword">in</span> prompt:
                <span class="hljs-comment"># 反思反馈</span>
                <span class="hljs-keyword">return</span> <span class="hljs-string">'''{
                    "语法正确性":"无语法错误",
                    "逻辑完整性":"calculate_sum函数未处理numbers为空列表的场景",
                    "性能优化":"无冗余代码，执行效率良好",
                    "格式规范":"符合PEP 8规范"
                }'''</span>
            <span class="hljs-keyword">elif</span> <span class="hljs-string">"优化代码"</span> <span class="hljs-keyword">in</span> prompt:
                <span class="hljs-comment"># 优化后代码（处理空值问题）</span>
                <span class="hljs-keyword">return</span> <span class="hljs-string">'''def add(a, b):
    return a + b

def calculate_sum(numbers):
    if not numbers:
        return 0
    total = 0
    for num in numbers:
        total += num
    return total'''</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>
    
    agent = ReflectionAgent(SimpleLLMClient())
    result = agent.run(<span class="hljs-string">"编写两个函数：add（两数相加）、calculate_sum（列表求和）"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n任务结果：<span class="hljs-subst">{result}</span>"</span>)
    
</code></pre>
<h4 data-id="heading-20">3.3.3 总结</h4>
<p><strong>核心要点</strong>：自我纠错能力强，可以明显提高输出质量；</p>
<p><strong>缺点</strong>：明显增加响应时长和任务花费。</p>
<h2 data-id="heading-21">四、三大范式对比</h2>

































<table><thead><tr><th>范式名称</th><th>核心特征</th><th>适用场景</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>ReAct</td><td>边推理边行动，动态交互，无预先规划</td><td>实时信息查询（天气、股票）、API调用、不确定场景下的任务处理</td><td>1. 动态适配性强，能应对突发反馈；2. 幻觉概率低，推理过程显性化；3. 代码实现简单，易上手</td><td>1. 多步骤任务Token消耗高；2. 依赖LLM实时推理能力，复杂任务易混乱；3. 无全局规划，长期任务效率低</td></tr><tr><td>Plan-and-Solve</td><td>先规划后执行，结构化拆解，支持重规划</td><td>项目开发拆解、流程化任务、目标清晰的复杂任务（旅行规划）</td><td>1. 执行路径清晰，便于调试与追溯；2. 步骤化执行，任务推进可控；3. 支持重规划，容错性较强</td><td>1. 灵活性不足，应对突发需求调整繁琐；2. 初始规划质量依赖LLM拆分能力；3. 重规划后需重新执行，部分场景效率低</td></tr><tr><td>Reflection</td><td>自我反思，多轮迭代，反馈驱动优化</td><td>代码生成与优化、文案打磨、技术方案设计、高精度输出任务</td><td>1. 自我纠错能力强，输出质量高；2. 多维度评审，覆盖场景全面；3. 结果可迭代，无需人工干预优化</td><td>1. 多轮迭代耗时久，资源消耗高；2. 反思质量依赖LLM评审能力；3. 简单任务冗余，效率较低</td></tr></tbody></table>
<h2 data-id="heading-22">五、未来去哪</h2>
<h3 data-id="heading-23">5.1 总结</h3>
<p>ReAct、Plan-and-Solve、Reflection 三种范式，分别对应 “<strong>动态交互</strong>、<strong>结构化执行</strong>、<strong>迭代优化</strong> 三大核心能力：</p>
<ul>
<li>若充满不确定性，需要与外部交互，优先选 ReAct，可以根据实时反馈调整；</li>
<li>若任务逻辑路径清晰，侧重推理和步骤分解，优先选 Plan-and-Solve，确保稳定、结构化的执行流程；</li>
<li>若任务对输出质量和可靠性要求高，优先选 Reflection，通过迭代优化可以提升结果质量。</li>
</ul>
<h3 data-id="heading-24">5.2 未来方向</h3>
<p>当前智能体开发还在快速迭代，未来的方向可能集中在以下几点：</p>
<ul>
<li><strong>范式融合</strong>：单一范式难以覆盖复杂场景，范式融合，比如“Plan-and-Solve+Reflection”（结构化规划+迭代优化）、“ReAct+Plan-and-Solve”（动态交互+局部规划），兼顾效率、灵活性与质量。</li>
<li><strong>多模态</strong>：从文本向“文本+语音+图像+视频”多模态延伸，比如智能体可直接识别图片、调用语音等，适配更丰富的真实场景。</li>
<li><strong>自主学习</strong>：引入强化学习（RL）与记忆机制，让智能体从历史任务中自主学习最优策略（如工具选择、步骤拆分），自我升级。</li>
</ul>
<h3 data-id="heading-25">5.3 开发框架</h3>
<p>实际开发中，我们无需从零搭建，可以基于成熟框架快速落地：</p>
<ul>
<li><strong>LangChain</strong>：目前最流行的智能体开发框架之一，生态完善，支持链条式任务拆解、记忆管理、多范式集成，适配OpenAI、本地化大模型等多种LLM，适合中大型智能体项目开发。</li>
<li><strong>AutoGPT</strong>：基于GPT系列模型的自主智能体框架，核心优势是“高度自主化”，无需人工干预即可完成复杂任务（如市场调研、代码开发），但资源消耗较高，适合追求极致自主性的场景。</li>
<li><strong>MetaGPT</strong>：微软开源的多智能体协作框架，模拟软件开发团队（产品经理、开发者、测试工程师）的协作模式，支持多智能体分工完成复杂任务，适合大型项目的智能化开发。</li>
</ul>
<p><strong>Tips</strong>：</p>
<ul>
<li>文中所有示例的完整代码均在我的 GitHub 仓库。需要查看完整代码或关注更多内容的，可前往仓库查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCris-z123%2Fagent-example" target="_blank" title="https://github.com/Cris-z123/agent-example" ref="nofollow noopener noreferrer">GitHub</a>，如果觉得内容有帮助，欢迎 Star⭐ 支持</li>
<li>感谢 <strong>helloagents</strong> 项目。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[linux]/usr/local目录和/opt目录的区别]]></title>    <link>https://juejin.cn/post/7597805826515484718</link>    <guid>https://juejin.cn/post/7597805826515484718</guid>    <pubDate>2026-01-22T13:51:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597805826515484718" data-draft-id="7597805826515402798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[linux]/usr/local目录和/opt目录的区别"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2026-01-22T13:51:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="import_random"/> <meta itemprop="url" content="https://juejin.cn/user/2013961033882312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [linux]/usr/local目录和/opt目录的区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2013961033882312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    import_random
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T13:51:49.000Z" title="Thu Jan 22 2026 13:51:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Linux文件系统层次标准（FHS）中，<strong><code>/usr/local</code></strong> 和 <strong><code>/opt</code></strong> 都是用于<code>安装附加软件</code>，但它们有不同的设计目的和结构：</p>
<h2 data-id="heading-0"><code>/usr/local</code></h2>
<ul>
<li><strong>主要用途</strong>：存放<strong>本地编译安装</strong>的软件（通常由系统管理员手动安装）</li>
<li><strong>文件结构</strong>：遵循Unix标准目录结构
<pre><code class="hljs language-bash" lang="bash">/usr/local/bin     <span class="hljs-comment"># 可执行文件</span>
/usr/local/lib     <span class="hljs-comment"># 库文件</span>
/usr/local/etc     <span class="hljs-comment"># 配置文件</span>
/usr/local/share   <span class="hljs-comment"># 架构无关的数据文件</span>
/usr/local/include <span class="hljs-comment"># 头文件</span>
</code></pre>
</li>
<li><strong>特点</strong>：
<ul>
<li>软件文件<code>分散</code>到相应的子目录中</li>
<li>系统升级时不会被覆盖（与<code>/usr</code>区分）</li>
<li>适用于需要通过<code>make install</code>安装的开源软件</li>
<li>通常具有更高的系统集成度</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1"><code>/opt</code></h2>
<ul>
<li><strong>主要用途</strong>：存放<strong>第三方商业软件</strong>或<strong>独立的应用程序包</strong></li>
<li><strong>文件结构</strong>：每个软件有自己的独立目录
<pre><code class="hljs language-bash" lang="bash">/opt/google/chrome/          <span class="hljs-comment"># Chrome浏览器</span>
/opt/intellij/idea/          <span class="hljs-comment"># IntelliJ IDEA</span>
/opt/someapp/                <span class="hljs-comment"># 某个独立应用</span>
</code></pre>
</li>
<li><strong>特点</strong>：
<ul>
<li><strong>每个应用完全包含在自己的目录树中</strong></li>
<li>便于卸载（直接删除整个目录即可）</li>
<li>适用于自包含的二进制包、商业软件</li>
<li>减少与系统其他部分的依赖冲突</li>
</ul>
</li>
</ul>
<h2 data-id="heading-2">主要区别对比</h2>



































<table><thead><tr><th>特性</th><th><code>/usr/local</code></th><th><code>/opt</code></th></tr></thead><tbody><tr><td><strong>组织方式</strong></td><td>按文件类型分散</td><td>按应用集中</td></tr><tr><td><strong>典型内容</strong></td><td>手动编译的开源软件</td><td>商业软件、预编译包</td></tr><tr><td><strong>集成度</strong></td><td>高，与系统融合</td><td>低，相对独立</td></tr><tr><td><strong>管理难度</strong></td><td>卸载较复杂</td><td>卸载简单</td></tr><tr><td><strong>路径优先级</strong></td><td>通常高于<code>/usr/bin</code></td><td>需要手动添加到PATH</td></tr></tbody></table>
<h2 data-id="heading-3">实际选择建议</h2>
<h3 data-id="heading-4">使用 <code>/usr/local</code> 当：</h3>
<ul>
<li>从源码编译安装软件（如<code>./configure &amp;&amp; make &amp;&amp; make install</code>）</li>
<li>希望软件与系统高度集成</li>
<li>需要遵循标准的Unix目录结构</li>
</ul>
<h3 data-id="heading-5">使用 <code>/opt</code> 当：</h3>
<ul>
<li>安装独立的第三方二进制包</li>
<li>安装商业软件（如Oracle JDK、Matlab等）</li>
<li>需要完全隔离的应用程序</li>
<li>希望轻松卸载而不影响系统</li>
</ul>
<h2 data-id="heading-6">PATH设置示例</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 通常 /usr/local/bin 已在PATH中</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$PATH</span>

<span class="hljs-comment"># 要使用 /opt 中的程序，可能需要添加</span>
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:/opt/someapp/bin
</code></pre>
<h2 data-id="heading-7">现代趋势</h2>
<ul>
<li>许多包管理器（如Homebrew on Linux）使用<code>/usr/local</code></li>
<li>Snap和Flatpak等现代包格式通常有自己的独立位置</li>
<li>容器化应用进一步改变了传统的软件安装模式</li>
</ul>
<p><strong>简单总结</strong>：<code>/usr/local</code>适用于集成到系统的软件，<code>/opt</code>适用于独立打包的第三方应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[强化学习入门：策略]]></title>    <link>https://juejin.cn/post/7598021313870544902</link>    <guid>https://juejin.cn/post/7598021313870544902</guid>    <pubDate>2026-01-22T15:51:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598021313870544902" data-draft-id="7598029481508388883" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="强化学习入门：策略"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-01-22T15:51:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="生锈的键盘"/> <meta itemprop="url" content="https://juejin.cn/user/15838356199497"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            强化学习入门：策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/15838356199497/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    生锈的键盘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T15:51:52.000Z" title="Thu Jan 22 2026 15:51:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 策略</h2>
<p>总的来说，为什么选择这个动作，选择这个动作的逻辑就是策略。生活中各种各样的场景，你对每个场景判断后选择什么动作逻辑就是你的策略，这个策略就在你的大脑中（神经网络）</p>
<ul>
<li>给你一个游戏，每个游戏状态你选择什么样的操作，这个就是策略，不同人针对同一个场景选择的动作可能就是不同的，也就是策略不同。</li>
<li>给你一个股票的k线，你当前选择买入，卖出，什么都不操作，具体选择哪一个动作就是你的策略，同样不同的人策略是不同的</li>
<li>开车骑车，遇到了堵车怎么处理，是排队还是绕路，前面是行人是刹车还是踩油门，具体选择哪一个就是你的策略</li>
</ul>
<blockquote>
<p>策略就是从“环境感知”到“决策动作”的映射逻辑。</p>
</blockquote>
<p><strong>策略的本质</strong>：映射函数
在数学或人工智能（强化学习）中，策略（Policy）通常被表示为一个函数<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi><mo stretchy="false">(</mo><mi>a</mi><mi mathvariant="normal">∣</mi><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\pi (a|s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mord">∣</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span>：</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span>  (State/场景)：你观察到的信息（如：K线走势、前方的行人、游戏的当前分数)</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span>  (Action/动作)：你做出的反应（如：买入、刹车、放技能）。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span></span> (Policy/策略)：这就是你说的“逻辑”。它决定了在状态 (s) 下，选择动作 (a) 的概率或确定性。</li>
</ul>
<p><strong>策略的三个组成要素</strong>：一个完整的策略通常包含以下逻辑链条：</p>
<ul>
<li>目标导向：策略不是随机的，它是为了实现某个目标。炒股是为了盈利，开车是为了安全到达，游戏是为了赢。（奖励函数）</li>
<li>规则与约束：策略必须在规则内运行（如交通法规、游戏机制）。（动作空间和状态空间）</li>
<li>判断逻辑（if-then）：这是你提到的核心。（每个动作的概率）
<ul>
<li>“如果（if）路口堵塞超过10分钟，那么（then）选择绕路。”</li>
<li>“如果（if）K线跌破支撑位，那么（then）止损卖出。”</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">2. 行为策略和目标策略</h2>
<p>在强化学习中，为了区分“谁在采集数据”和“我们要优化谁”，引入了这两个概念。理解它们的关键在于：<strong>数据源头与学习目标是否一致</strong>。</p>
<p><strong>行为策略 (Behavior Policy, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi></mrow><annotation encoding="application/x-tex">\mu</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">μ</span></span></span></span></span> 或 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\pi _{old}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>)</strong></p>
<ul>
<li>定义： 实际在环境里“跑跑跳跳”、产生动作并收集奖励的那个策略。</li>
<li>职责： 负责探索环境，产生实验数据（即 (s,a,r,s^{\prime }) 的序列）。</li>
</ul>
<p><strong>目标策略 (Target Policy, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span></span> 或 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\pi _{new}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>)</strong></p>
<ul>
<li>定义： 我们正在努力学习、改进、并希望最终拿到冠军的那个策略</li>
<li>职责： 负责利用学到的知识，变得越来越聪明。</li>
</ul>
<p>如果只有一个策略（即同策略），会面临两个核心矛盾，区分它们正是为了解决这些问题：</p>
<p><strong>1. 解决“探索”与“利用”的矛盾</strong></p>
<ul>
<li>矛盾点：目标策略通常希望表现得尽可能完美（利用），但为了学得更好，我们需要模型去尝试一些奇怪的、可能出错的动作（探索）。</li>
<li>解决方案： 我们可以让行为策略更激进地去冒险（比如带噪声的探索），而让目标策略平滑地学习最优路径。</li>
</ul>
<p><strong>2. 样本效率（变废为宝）</strong></p>
<ul>
<li>矛盾点：目标策略每更新一次参数，它就变成了“新策略”。如果不区分两者，那么几秒钟前（旧策略）收集的数据在数学上就失效了。</li>
<li>解决方案： 引入行为策略的概念后，我们可以把<strong>过去一小时内所有的尝</strong>都看作是由<strong>旧的行为策略</strong>产生的。通过重要性采样等技术，我们可以告诉目标策略：“虽然这是旧数据，但通过对比我现在的想法和当时的动作概率，我依然能从这些旧经验里学到东西。”</li>
</ul>
<p>之所以要区分它们，本质上是为了“打破时间的诅咒”。在异策略中，有了这两个概念，我们就可以建立一个经验回放池 (Replay Buffer)，把成千上万次不同行为策略产生的数据存起来反复学习，而不必每更新一次参数就去环境里重新跑一遍。这大大节省了计算资源和时间。</p>
<p>行为策略和学习策略一致就是同策略（on-policy）,否则为异策略（off-policy）</p>
<ul>
<li>​<strong>模拟器成本高</strong>​**：当数据收集非常昂贵或缓慢时，优先选择异策略以最大化利用每一条数据。**</li>
<li>​<strong>需要离线学习​</strong>​**：例如在自动驾驶或医疗领域，只能利用已有的历史观测数据集进行训练（Offline RL）。**</li>
</ul>
<h2 data-id="heading-2">3. 异策略（off-policy）</h2>
<p>​<strong>异策略本身并不主观“认为”样本是独立的，但它通过特定的手段（如经验回放）人为地制造了这种“独立性”</strong> ​，以满足神经网络训练的数学前提。</p>
<p>在强化学习中，智能体采集的原始样本是按时间顺序排列的。连续采集的数据序列具有强烈的时间相关性<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_{t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>紧接着<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">s_{t+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span></span></span></span></span>。如果直接按顺序学习，神经网络会面临以下问题：</p>
<ul>
<li><strong>非独立同分布（Non-IID）</strong>： 深度学习模型的基础假设是样本独立同分布。如果模型连续看到 100 个极其相似的动作，它的梯度更新会产生严重的偏移，导致训练不稳定。</li>
<li><strong>反馈循环</strong>： 当前的策略决定了下一步看到的数据，如果数据又是连续相关的，模型很容易陷入某个死循环或者过度拟合局部区域。</li>
</ul>
<p>异策略算法（如 DQN, SAC）的核心组件是 <strong>经验回放池（Replay Buffer）</strong>。这个机制的作用就是<strong>打破这种相关性</strong></p>
<ul>
<li>​<strong>随机采样 (Random Sampling)</strong> ​：算法从回放池中随机抽取一小撮样本（Mini-batch）进行训练。</li>
<li>​<strong>模拟 IID</strong>​：通过这种随机性，原本有时序关系的样本被“打散”了。在训练时，网络看到的样本集合在统计学上更接近于**​独立同分布 (IID)**​。这就像是把整本书的题库打乱了再抽题，让神经网络学到的是通用的物理规律（如“碰到墙会反弹”），而不是特定的轨迹（如“先左转再右转”）。</li>
</ul>
<h3 data-id="heading-3">3.1 异策略学习序列信息</h3>
<blockquote>
<p><code>既然任务是序列化的，为什么把序列拆得稀碎，模型还能学会“长远打算”？</code></p>
</blockquote>
<p>核心原因在于：异策略算法利用了“马尔可夫性”和“自举（Bootstrapping）”机制，将时序信息转化为了状态值（Value）的属性。</p>
<blockquote>
<p>异策略学习的目标不是“路径”，而是“关联“</p>
</blockquote>
<p>异策略并不试图通过死记硬背整条轨迹来学习，它学习的是状态与状态之间的​<strong>逻辑递推关系</strong>​。</p>
<h4 data-id="heading-4">3.1.1. <strong>原子级关联</strong>​</h4>
<p>每一个样本 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo separator="true">,</mo><mi>r</mi><mo separator="true">,</mo><mi>s</mi><mtext>′</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(s,a,r,s′)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">s</span><span class="mord">′</span><span class="mclose">)</span></span></span></span></span>都包含了一个微小的“逻辑断言”：在状态<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span>做了<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span>，会得到 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span></span>并跳到<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span></p>
<h4 data-id="heading-5">3.1.2. <strong>拼图效应</strong>​</h4>
<p>你可以把异策略的学习想象成拼拼图： 每一条 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo separator="true">,</mo><mi>r</mi><mo separator="true">,</mo><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(s,a,r,s^{\prime })</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 就像拼图的一个连接处。通过随机采样，模型一会儿在学拼图左上角（这一组<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>→</mo><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">s\rightarrow s^{\prime }</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span>），一会儿在学右下角（另一组 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>→</mo><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">s\rightarrow s^{\prime }</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span>）。虽然样本被打散了，但由于<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mtext>′</mtext></mrow><annotation encoding="application/x-tex">s′</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5556em;"/><span class="mord mathnormal">s</span><span class="mord">′</span></span></span></span></span>（当前步的终点）在另一个样本中会作为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span>（下一步的起点）出现。只要采样的样本(经验池)覆盖了环境的各个角落，模型就能通过无数个“连接处”把整个逻辑链条串联起来。</p>
<blockquote>
<p>它不需要一口气看完整个视频，只需要看遍所有的“帧对”关系，最终就能推导出完整的剧情。</p>
</blockquote>
<h4 data-id="heading-6">3.1.3. <strong>马尔可夫假设</strong></h4>
<blockquote>
<p>“此时此刻的状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span> 已经包含了所有对未来有用的历史信息”</p>
</blockquote>
<p>如果这个假设成立，那么模型只需要知道【我在哪 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span>)】、【我做了什么 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span>)】和【我到了哪 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">s^{\prime }</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span>)】，就足以做出完美决策。它不需要记得它是怎么来到 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span> 的，所以打散序列不会损伤它的判断力。</p>
<h4 data-id="heading-7">3.1.4. <strong>贝尔曼方程的自举机制</strong></h4>
<p>异策略算法（如 DQN）的核心公式是：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Q</mi><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo><mo>≈</mo><mi>r</mi><mo>+</mo><mi>γ</mi><mi>m</mi><mi>a</mi><mi>x</mi><mi>a</mi><mtext>′</mtext><mi>Q</mi><mo stretchy="false">(</mo><mi>s</mi><mtext>′</mtext><mo separator="true">,</mo><mi>a</mi><mtext>′</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q(s,a)≈r+γmaxa′Q(s′,a′)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">γma</span><span class="mord mathnormal">x</span><span class="mord mathnormal">a</span><span class="mord">′</span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mord">′</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mord">′</span><span class="mclose">)</span></span></span></span></span></div>
<p>这个公式赋予了打散样本“跨越时空”的能力：</p>
<ul>
<li><strong>价值传递</strong>​：即便你只给模型一个孤立的样本<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo separator="true">,</mo><mi>r</mi><mo separator="true">,</mo><mi>s</mi><mtext>′</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(s,a,r,s′)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">s</span><span class="mord">′</span><span class="mclose">)</span></span></span></span></span>，模型也会去查询它当前对s′价值的估计。</li>
<li>​<strong>远见性</strong>​：如果<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mtext>′</mtext></mrow><annotation encoding="application/x-tex">s′</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5556em;"/><span class="mord mathnormal">s</span><span class="mord">′</span></span></span></span></span>是一个接近终点的获胜状态，它的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo stretchy="false">(</mo><mi>s</mi><mtext>′</mtext><mo separator="true">,</mo><mi>a</mi><mtext>′</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q(s′,a′)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mord">′</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mord">′</span><span class="mclose">)</span></span></span></span></span>会很高。通过这一行公式，高价值会<strong>反向传播</strong>给<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span>。</li>
<li>​<strong>结论</strong>​：序列的连贯性并没有消失，而是被浓缩进了<strong>Q值表</strong> 中。多次随机采样训练，收益就会像“水流”一样，通过 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span> 函数这个中介，从终点逆流回起点。</li>
</ul>
<h3 data-id="heading-8">3.2 类比事后诸葛亮</h3>
<p>贝尔曼方程并不是真的知道了未来的价值，而是通过不断的采样，然后通过价值反推当前动作选择的价值，属于是事后诸葛亮。</p>
<h4 data-id="heading-9">3.2.1. 第一阶段：两眼一抹黑（初期的“事后”）</h4>
<p>在刚开始采样时，模型确实完全不知道未来的价值。它在环境里乱撞，即便偶尔做对了动作，只要没碰到那个带奖金的“终点”，它依然觉得自己所有的动作都是平庸的。这时候，它连做“事后诸葛亮”的资格都没有，因为还没发生任何值得复盘的“好事”。</p>
<h4 data-id="heading-10">3.2.2. 第二阶段：复盘局部（中期的“事后”）</h4>
<p>当某次偶然撞到了奖金（比如样本：倒数第一步 -&gt; 终点 -&gt; 拿钱），模型开始复盘了：
它的逻辑： “虽然我不知道前面是怎么来的，但刚才在‘倒数第一步’那个位置，往右走竟然拿到了钱！记下来，以后到了那里就往右走。”
这就是“事后”： 只有在奖金发生之后，它才回头给“上一个动作”打高分。</p>
<h4 data-id="heading-11">3.2.3. 第三阶段：全局连通（成型后的“事后”）</h4>
<p>随着训练继续，模型开始展现出一种“逐级复盘”的能力：
既然“倒数第一步”值钱了，那么“倒数第二步”在复盘时就会发现：“嘿，如果我能走到‘倒数第一步’，我就离钱不远了。”
接力棒传导： 这种“事后”的觉悟，会从终点开始，沿着时间轴一帧一帧地向回传导。
最终结果： 训练结束时，模型在起点就能通过 Q 函数看到：“如果我往左走，经过 100 步的传导，最终能拿到钱。”</p>
<h4 data-id="heading-12">3.2.4. “事后诸葛亮”带来的挑战</h4>
<p>正因为它是“事后”反推，所以会带来几个副作用：</p>
<ul>
<li>延迟满足带来的困难： 如果序列太长（比如要走 1 万步才有奖），这种“反向浸润”的速度会非常慢。模型可能需要采样数百万次，才能让起点的动作感知到 1 万步之后的收益。</li>
<li>信用分配问题（Credit Assignment）： 到底是因为哪一步做得好才拿到的奖？异策略靠的是耐心——通过成千上万次打散的采样和反推，慢慢磨掉噪声，把功劳归于正确的动作。</li>
</ul>
<h3 data-id="heading-13">3.3. 总结</h3>
<ul>
<li>
<p>​<strong>统计上的独立（打散的目的）</strong>：是为了让梯度更新更平稳，避免模型因为连续处理相似的样本而产生剧烈震荡（防止过拟合到当前轨迹）。**</p>
</li>
<li>
<p>​<strong>逻辑上的相关（学习的基础）<strong>​</strong>：样本内部的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>→</mo><mi>a</mi><mo>→</mo><mi>s</mi><mtext>′</mtext></mrow><annotation encoding="application/x-tex">s→a→s′</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5556em;"/><span class="mord mathnormal">s</span><span class="mord">′</span></span></span></span></span>转移逻辑从未被破坏。神经网络学习的是这个​</strong>转移规律<strong>​</strong>。只要它掌握了规律，就能预测任何序列，而不需要按顺序观察序列。</p>
</li>
</ul>
<blockquote>
<p>异策略打散的是​<strong>训练数据的采样分布</strong>​，以满足数学优化的稳定性需求；而序列的<strong>逻辑连贯性</strong>则通过贝尔曼方程这一数学纽带，在Q值的迭代过程中被完美地保留并重建了。</p>
</blockquote>
<h3 data-id="heading-14">3.4. 异策略的优点</h3>
<h4 data-id="heading-15">3.4.1. 极高的样本效率 (Sample Efficiency)</h4>
<ul>
<li>经验回放 (Experience Replay)：异策略允许智能体将过去经历的所有数据存储在“经验池”中，并在后续训练中多次重复抽取使用。</li>
<li>对比：同策略（On-Policy）算法在更新一次参数后，之前收集的数据就因与新策略不匹配而必须丢弃；而异策略可以持续压榨旧数据的价值，极大地减少了与环境交互的总次数。</li>
</ul>
<h4 data-id="heading-16">3.4.2. 解耦探索与利用 (Decoupling Exploration and Exploitation)</h4>
<ul>
<li>自由探索：在异策略中，负责收集数据的“行为策略”可以非常激进（例如完全随机探索），而“目标策略”则可以专注于学习最优的贪婪动作。</li>
<li>降低风险：在自动驾驶等高风险领域，可以使用安全的基准策略来收集数据，而让模型在后台安全地学习更优方案，无需智能体亲自以不成熟的策略去冒险。</li>
</ul>
<h4 data-id="heading-17">3.4.3. 数据来源的多样性</h4>
<ul>
<li>学习他人经验：异策略算法不仅能学习自己的历史记录，还能学习人类专家的演示数据或其他算法生成的轨迹。</li>
<li>离线学习 (Offline RL)：它支持直接从静态的历史数据集中提取知识，这使得它在无法实时交互的场景（如医疗决策、金融交易）中成为唯一可行的方案。</li>
</ul>
<h4 data-id="heading-18">3.4.4. 消除数据相关性，提升训练稳定性</h4>
<ul>
<li>打乱时序相关性：通过从经验池中随机采样（Random Sampling），异策略有效地打破了连续动作之间的强相关性。</li>
<li>类比：这类似于学生复习时打乱题目顺序练习，而不是死记硬背某一次考试的题目顺序，从而让神经网络学习到更本质的规律，防止过拟合。</li>
</ul>
<h4 data-id="heading-19">3.4.5. 数学机制的保障</h4>
<ul>
<li>重要性采样 (Importance Sampling)：通过数学上的重加权技术，异策略能够修正行为策略与目标策略之间的分布偏差，确保即使数据来源不同，梯度的估计依然是准确或收敛的。</li>
<li>最优值函数估计：如 Q-Learning，它直接利用贝尔曼最优方程（Bellman Optimality Equation）来更新，这保证了只要数据覆盖足够广，它就能收敛到最优策略，无论数据由谁产生。</li>
</ul>
<h2 data-id="heading-20">4. 同策略（on-policy）</h2>
<p>在强化学习中，同策略（On-policy）算法指的是：“正在学习、更新的策略”与“在环境中实际干活、采样数据的策略”必须是同一个。</p>
<p>通俗点说，就是“边练边打”——你必须亲自下场实战，根据自己当下的反馈来调整自己的动作，而不能靠看别人的录像或自己很久以前的经验来学习。</p>
<ul>
<li>​<strong>一致性</strong>​**：用于生成行为的数据采集策略（Behavior Policy）与被改进的目标策略（Target Policy）是同一个。**</li>
<li>​<strong>即用即弃</strong>​**：由于学习必须基于“当前的”策略，一旦策略更新，之前旧策略产生的数据就不再适用，必须丢弃并重新采集。**</li>
<li>​<strong>样本分布一致</strong>​**：因为数据是由当前策略直接生成的，数据的统计分布与策略的目标分布完全一致，不需要像异策略那样使用重要性采样来修正偏差**</li>
</ul>
<p>就像一位厨师在学做新菜，他必须亲自动手尝试每一道工序，并根据<strong>这一次</strong>做出来的味道（反馈）来调整<strong>下一次</strong>放盐的分量。他不能通过看别人（异策略）的视频来直接改进自己的手感。</p>
<h2 data-id="heading-21">5. 同策略vs异策略</h2>
<ul>
<li><strong>同策略（On-Policy）像是在看视频：你必须完整地看一遍视频才能理解剧情，如果快进或跳过，你就乱了。</strong></li>
<li><strong>异策略（Off-Policy）像是在拼地图：</strong>
<ul>
<li>你收集的是成千上万张碎片照片（每一个样本<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo separator="true">,</mo><mi>r</mi><mo separator="true">,</mo><mi>s</mi><mtext>′</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(s,a,r,s′)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">s</span><span class="mord">′</span><span class="mclose">)</span></span></span></span></span> ）。</li>
<li>每张照片只拍了一个路口。</li>
<li>虽然照片是乱序洗出来的，但只要照片覆盖了所有路口，你就能通过照片边缘的重合部分（相同的s和s′），在脑海中构建出一张完整的交通枢纽图。</li>
<li>​结果：你不需要按顺序走一遍路，也能知道从 A 点到 Z 点的最优路径。</li>
</ul>
</li>
</ul>
<ul>
<li>异策略： 像“复盘高手”。它可以利用任何数据学习，不管是自己以前的数据、别人的数据，甚至是随机乱试的数据（只要有 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo separator="true">,</mo><mi>r</mi><mo separator="true">,</mo><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">s,a,r,s^{\prime }</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span> 这种记录就行）。</li>
<li>同策略： 像“现场教学”。老师教你游泳，你必须现在跳下水游一圈，老师根据你这这一圈的动作给你指点。你昨天游的那一圈（旧数据）对老师今天的指点已经没有参考价值了，因为你今天的水平和昨天已经不一样了。</li>
</ul>
<h2 data-id="heading-22">6. 梯度过期</h2>
<p><strong>既然异策略允许使用历史数据，为什么还会担心梯度“过期”呢？</strong>
答案在于：​**异策略的数据兼容性”与“优化算法的梯度方向”是两个层面的问题 **</p>
<h3 data-id="heading-23">6.1 异策略确实能用旧数据，但“梯度”是即时的</h3>
<p>虽然异策略（如 DQN）可以从经验池中抽取一年前的数据，但在计算梯度时，它是用<strong>当前的参数</strong>去评估这些旧数据的。</p>
<ul>
<li>​<strong>异策略的操作</strong>​：拿着“现在的 Q 网络”去对比“旧样本里的奖励”，计算误差（TD Error），然后更新。</li>
<li>​<strong>异步的问题</strong>​：在异步更新中，Worker A 在时间点 T1拿到模型参数开始算梯度，等它算完准备提交时已经是T10了，此时全局参数已经被 Worker B、C 修改了 9 次。</li>
<li>​<strong>过期梯度（Stale Gradient）的本质</strong>​：Worker A 算出的梯度方向是指向T1 版本的山谷，但现在的模型已经站在了 T10的位置。这就好比你拿着昨天的地图T1的梯度在今天的地形T10 的参数上走，虽然地图上的路（样本数据）是真的，但你的方位（参数状态）错了，这会导致更新方向偏离最优路径</li>
</ul>
<h3 data-id="heading-24">6.2. 异策略的“容忍度”并非无限</h3>
<p>虽然异策略在数学上允许数据分布不一致，但如果​<strong>数据版本</strong>​（行为策略）与​<strong>当前学习版本</strong>​（目标策略）差异过大，会产生以下问题：</p>
<ul>
<li>​<strong>重要性偏移</strong>​：如果现在的策略已经进化得非常厉害，而旧数据全是随机乱撞的“垃圾数据”，这些数据对当前更新的贡献度（有效信息）会变得极低。</li>
<li>​<strong>收敛变慢</strong>​：过期梯度就像是在优化过程中加入了“滞后噪声”。在异步训练中，如果延迟（Staleness）太高，这种噪声会掩盖真正的下降方向，导致模型不收敛。</li>
</ul>
<h3 data-id="heading-25">6.3. Q-learning 也怕过期梯度</h3>
<p>Q-learning 虽然是异策略，但它依赖​<strong>自举</strong>（Bootstrapping) :​<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo><mo>←</mo><mi>Q</mi><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo><mo>+</mo><mi>α</mi><mo stretchy="false">[</mo><mi>r</mi><mo>+</mo><mi>γ</mi><mi>m</mi><mi>a</mi><mi>x</mi><mi>Q</mi><mo stretchy="false">(</mo><mi>s</mi><mtext>′</mtext><mo separator="true">,</mo><mi>a</mi><mtext>′</mtext><mo stretchy="false">)</mo><mo>−</mo><mi>Q</mi><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">Q(s,a)←Q(s,a)+α[r+γmaxQ(s′,a′)−Q(s,a)]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">γma</span><span class="mord mathnormal">x</span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mord">′</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mord">′</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)]</span></span></span></span></span>
注意等式右边的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>a</mi><mi>x</mi><mi>Q</mi><mo stretchy="false">(</mo><mi>s</mi><mtext>′</mtext><mo separator="true">,</mo><mi>a</mi><mtext>′</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">maxQ(s′,a′)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mord">′</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mord">′</span><span class="mclose">)</span></span></span></span></span> ，在异步更新中，如果一个 Worker 计算梯度时用的 Q值版本太旧，它计算出来的 <strong>TD Target</strong> 就是过期的。用一个过期的目标去修正现在的参数，会造成逻辑上的前后矛盾（即目标值的不稳定），进而引发震荡。</p>
<h3 data-id="heading-26">6.4. 总结：数据 vs. 梯度</h3>
<p>为了方便理解，我们可以做这样一个区分：</p>
<ul>
<li>​<strong>异策略解决了“数据过期”的问题</strong>​：它允许你把陈旧的经验（State, Action）喂给模型。</li>
<li>​<strong>同步机制解决了“梯度过期”的问题</strong>​：它确保当模型根据这些经验进行学习时，它的“修正动作”（梯度）是针对模型<strong>当前状态</strong>的最优方向。**</li>
</ul>
<p>异策略就像你可以读<strong>旧课本</strong>学习。但“异步更新”导致的问题是：老师在黑板上已经讲到第 10 课了，你却还在按照第 1 课的理解去回答第 10 课的问题。虽然第 1 课的知识（数据）是正确的，但你的回答方向（梯度）与当下的进度不匹配。</p>
<p>这就是为什么即便在异策略算法中，人们依然倾向于使用​**同步并行（如 A2C 的同步版或大规模并行 DQN）**​，因为这样能确保每一次参数更新都是“新鲜”且“准确”的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别“一票否决”！我用 TypeScript 造了个增量代码检查神器]]></title>    <link>https://juejin.cn/post/7598011274686889984</link>    <guid>https://juejin.cn/post/7598011274686889984</guid>    <pubDate>2026-01-22T14:23:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598011274686889984" data-draft-id="7597987896693817379" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别“一票否决”！我用 TypeScript 造了个增量代码检查神器"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T14:23:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jamesishandsome"/> <meta itemprop="url" content="https://juejin.cn/user/2907584653428279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别“一票否决”！我用 TypeScript 造了个增量代码检查神器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2907584653428279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jamesishandsome
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T14:23:43.000Z" title="Thu Jan 22 2026 14:23:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>你是否曾因历史代码覆盖率低，而无奈关闭 CI 的质量门禁？是否因全量 lint 报告噪音太多，而忽略了真正关键的代码问题？今天，我带来的这个工具，或许能终结这些困扰。</p>
</blockquote>
<h2 data-id="heading-0">前言：一个普遍的开发困境</h2>
<p>在快速迭代的现代软件开发中，我们团队一直面临一个两难选择：</p>
<ul>
<li><strong>严格的全量检查</strong>：设置高标准的测试覆盖率（如80%）和 lint 规则。结果导致大量历史遗留代码拖累全局，CI 频繁失败，团队怨声载道。</li>
<li><strong>妥协与放弃</strong>：为了不影响开发节奏，不得不降低标准，甚至关掉检查。久而久之，代码质量悄然滑坡。</li>
</ul>
<p><strong>有没有一种方法，能确保“新代码”必须高质量，同时又不被“旧债”绑架？</strong></p>
<p>答案是：<strong>增量检查</strong>。这就是我开发 <code>diff-cover-ts</code> 的初衷——一个专注为你的 <strong><code>git diff</code></strong> 提供保驾护航的 TypeScript 工具。</p>
<h2 data-id="heading-1">什么是 diff-cover-ts？</h2>
<p><code>diff-cover-ts</code> 是 Python 知名工具 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBachmann1234%2Fdiff_cover" target="_blank" title="https://github.com/Bachmann1234/diff_cover" ref="nofollow noopener noreferrer">diff_cover</a> 的高性能 TypeScript 重制版。它的核心哲学很简单：</p>
<blockquote>
<p><strong>只看你这次修改了什么，并确保这些修改是高质量的。</strong></p>
</blockquote>
<p>它将当前分支（例如你的功能分支）与目标分支（如 <code>main</code>）进行对比，<strong>仅</strong>针对那些被修改或新增的代码行，报告其测试覆盖率的缺失或静态代码质量问题。</p>
<h3 data-id="heading-2">它如何工作？</h3>
<p>想象一下这个场景：你修改了一个有1000行代码的文件中的10行。</p>
<ul>
<li>传统覆盖率工具：告诉你整个文件覆盖率只有30%。</li>
<li><code>diff-cover-ts</code>：告诉你这<strong>新改的10行</strong>里，有哪几行没有被测试覆盖。</li>
</ul>
<p>精准，且 actionable。</p>
<h2 data-id="heading-3">核心亮点：为什么你需要它？</h2>
<h3 data-id="heading-4">1. 🎯 精准制导，告别噪音</h3>
<p>再也不用在成千上万个 lint 警告或全量覆盖率报告中大海捞针。<code>diff-cover-ts</code> 的报告直指你本次提交引入的潜在缺陷，让你专注于修复真正相关的问题。</p>
<h3 data-id="heading-5">2. 🤖 开箱即用，智能配置</h3>
<p>如果你的项目使用 <strong>Vite</strong> 或 <strong>Vitest</strong>，那么你几乎不需要任何配置。只需运行 <code>diff-cover</code> 命令，它会自动解析你的 <code>vite.config.ts</code> 或 <code>vitest.config.ts</code>，定位覆盖率报告的位置和格式。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在你的 Vite/Vitest 项目中</span>
npx diff-cover
</code></pre>
<p>就这么简单。</p>
<h3 data-id="heading-6">3. 📊 格式通吃，生态友好</h3>
<p>支持 <code>lcov</code>、<code>cobertura</code>、<code>clover</code>、<code>jacoco</code> 以及通用 XML 格式的覆盖率报告。无论你的测试框架是 Jest、Vitest 还是其他，都能轻松集成。</p>
<h3 data-id="heading-7">4. 🛡️ 双剑合璧：Coverage + Quality</h3>
<p>工具提供两大核心命令：</p>
<ul>
<li><strong><code>diff-cover</code></strong>：专注于<strong>增量测试覆盖率</strong>分析。</li>
<li><strong><code>diff-quality</code></strong>：专注于<strong>增量代码质量</strong>检查，支持 <code>eslint</code>、<code>pylint</code>、<code>flake8</code>、<code>shellcheck</code> 等多种检查工具的输出报告。</li>
</ul>
<h3 data-id="heading-8">5. ⚡ 为现代前端栈而生</h3>
<p>采用 <strong>TypeScript 5</strong> 编写，确保类型安全。构建与开发环境优先支持 <strong>Bun</strong>（同时兼容 Node.js），带来极致的依赖安装与脚本执行速度。</p>
<h2 data-id="heading-9">实战演练：5分钟接入你的项目</h2>
<p>让我们看看如何在一个典型的 Vite + TypeScript 项目中快速启用它。</p>
<h3 data-id="heading-10">步骤一：安装</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 全局安装（推荐，方便在任何项目中使用）</span>
npm install -g diff-cover

<span class="hljs-comment"># 或作为项目开发依赖</span>
npm install diff-cover --save-dev
</code></pre>
<h3 data-id="heading-11">步骤二：生成覆盖率报告</h3>
<p>首先，确保你的测试能生成覆盖率报告。以 Vitest 为例，在 <code>vitest.config.ts</code> 中：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vitest/config'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">test</span>: {
    <span class="hljs-attr">coverage</span>: {
      <span class="hljs-attr">reporter</span>: [<span class="hljs-string">'text'</span>, <span class="hljs-string">'json'</span>, <span class="hljs-string">'html'</span>, <span class="hljs-string">'lcov'</span>], <span class="hljs-comment">// 必须包含 lcov 或 cobertura 等格式</span>
    },
  },
});
</code></pre>
<p>然后运行测试：</p>
<pre><code class="hljs language-bash" lang="bash">npm <span class="hljs-built_in">test</span> -- --coverage
<span class="hljs-comment"># 或</span>
bun <span class="hljs-built_in">test</span> --coverage
</code></pre>
<h3 data-id="heading-12">步骤三：运行增量检查</h3>
<p>假设你刚刚完成了一些代码修改，并想看看这些新代码的覆盖率如何：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 自动模式（推荐）</span>
diff-cover

<span class="hljs-comment"># 或手动指定报告路径</span>
diff-cover coverage/lcov.info
</code></pre>
<p><strong>输出示例：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">Diff Coverage
-------------</span>
Your diff has 10 lines, covered at 80.00%

Missing lines in diff:
File: src/components/NewFeature.tsx
<span class="hljs-quote">&gt; Line 45:   const handleClick = () =&gt; {</span>
<span class="hljs-quote">&gt; Line 48:     setState(...);</span>
</code></pre>
<h3 data-id="heading-13">步骤四：集成到 CI，设立质量门禁</h3>
<p>真正的威力在于自动化。你可以在 GitHub Actions、GitLab CI 等流程中集成，并设置一个可接受的最低分数线。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 示例：GitHub Actions 片段</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">Tests</span> <span class="hljs-string">with</span> <span class="hljs-string">Coverage</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">bun</span> <span class="hljs-string">test</span> <span class="hljs-string">--coverage</span>

<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Diff</span> <span class="hljs-string">Coverage</span> <span class="hljs-string">Check</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|
    npx diff-cover coverage/lcov.info --fail-under 90 --html-report ./diff-report.html
</span>  <span class="hljs-comment"># 如果本次修改的代码行覆盖率低于90%，CI 将失败</span>
</code></pre>
<p>现在，每次 Pull Request 都会自动检查新代码的质量，确保合入主干的代码都是经过测试的。</p>
<h2 data-id="heading-14">高级玩法与配置</h2>
<h3 data-id="heading-15">生成可视化报告</h3>
<p>除了命令行输出，你还可以生成更详细的 HTML 或 JSON 报告，便于存档或进一步分析。</p>
<pre><code class="hljs language-bash" lang="bash">diff-cover coverage/lcov.info --html-report ./coverage-diff.html
</code></pre>
<h3 data-id="heading-16">聚焦特定文件</h3>
<p>通过 glob 模式，可以灵活地包含或排除某些文件。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 只检查 src/features/ 目录下的修改</span>
diff-cover --include=<span class="hljs-string">"src/features/**"</span>

<span class="hljs-comment"># 排除所有测试文件</span>
diff-cover --exclude=<span class="hljs-string">"**/*.test.*"</span> --exclude=<span class="hljs-string">"**/*.spec.*"</span>
</code></pre>
<h3 data-id="heading-17">质量检查示例</h3>
<p>使用 <code>eslint</code> 检查本次修改的代码质量：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 先生成 eslint 报告</span>
npx eslint . --format=checkstyle &gt; eslint-report.xml

<span class="hljs-comment"># 2. 进行增量质量分析</span>
diff-quality eslint-report.xml --violations eslint
</code></pre>
<h2 data-id="heading-18">技术背后</h2>
<ul>
<li><strong>健壮性</strong>：完善的单元测试覆盖核心逻辑。</li>
<li><strong>现代工具链</strong>：使用 <code>oxlint</code> 和 <code>oxfmt</code> 确保代码风格统一，并通过 <code>husky</code> 在提交前自动检查。</li>
</ul>
<h2 data-id="heading-19">结语</h2>
<p><code>diff-cover-ts</code> 不仅仅是一个工具，它代表了一种<strong>渐进式改善</strong>的工程理念。我们不追求一夜之间修复所有技术债务，但我们坚决捍卫每一次新增代码的质量。</p>
<p>它特别适合：</p>
<ul>
<li>拥有大量遗留代码，但希望新代码高质量的项目。</li>
<li>希望为团队设立一个公平、可执行质量标准的 Tech Lead。</li>
<li>追求高效、精准反馈的开发者。</li>
</ul>
<p><strong>项目地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjamesishandsome%2Fdiff_cover_ts" target="_blank" title="https://github.com/jamesishandsome/diff_cover_ts" ref="nofollow noopener noreferrer">github.com/jamesishand…</a></p>
<p>如果你也受困于全量检查的噪音，或者正在寻找一种更智能的方式来提升代码质量，不妨试试 <code>diff-cover-ts</code>。欢迎 Star、Issue 和 PR！</p>
<hr/>
<p><strong>让我们的每次提交，都比上一次更好一点。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[精通Git核心操作：从入门到高效版本控制]]></title>    <link>https://juejin.cn/post/7597997108135313435</link>    <guid>https://juejin.cn/post/7597997108135313435</guid>    <pubDate>2026-01-22T14:57:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597997108135313435" data-draft-id="7598057199962669107" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="精通Git核心操作：从入门到高效版本控制"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2026-01-22T14:57:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户575730334624"/> <meta itemprop="url" content="https://juejin.cn/user/2860271309712009"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            精通Git核心操作：从入门到高效版本控制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2860271309712009/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户575730334624
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T14:57:10.000Z" title="Thu Jan 22 2026 14:57:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">精通Git核心操作：从入门到高效版本控制</h2>
<p>在多人协作开发与大型项目管理中，Git已成为不可或缺的版本控制工具。它不仅能精准追踪文件修改记录、实现多版本回溯，更能高效协调团队成员的开发节奏，避免代码冲突与混乱。掌握Git核心命令与操作逻辑，是提升开发效率、保障代码安全的必备技能。本文将从基础概念出发，拆解核心操作命令，结合实操场景讲解实用技巧，帮助读者快速上手Git版本控制。</p>
<h3 data-id="heading-1">一、Git基础认知：构建版本控制框架</h3>
<p>在使用Git前，需明确核心原则与基础结构，避免因操作不规范导致代码管理混乱。</p>
<h4 data-id="heading-2">1. 单一仓库原则</h4>
<p>一个项目必须对应一个Git仓库，严禁在同一项目目录下创建多个仓库。多仓库会导致版本记录碎片化，无法统一追踪修改、合并代码，尤其在多人协作时，会引发严重的代码冲突与版本混乱。若需拆分功能模块，可通过分支管理实现，而非创建多个独立仓库。</p>
<h4 data-id="heading-3">2. 仓库初始化与核心结构</h4>
<p>对于新建项目，需先通过初始化命令创建Git仓库：在项目根目录执行 <code>git init</code>，系统会自动生成隐藏的 <code>.git</code> 目录，这便是Git的版本库，用于存储所有版本记录、分支信息、配置文件等核心数据，切勿手动删除或修改该目录内容。</p>
<p>初始化后，Git默认创建 <code>master</code> 分支（部分版本默认名为 <code>main</code>），作为项目的主分支。同时，Git将项目目录划分为三个核心区域，其流转关系直接决定版本控制逻辑：</p>
<ul>
<li><strong>工作区</strong>：即本地可见的项目目录，用于日常代码编写、修改操作，所有改动最初都发生在该区域。</li>
<li><strong>暂存区（Stage/Index）</strong> ：临时存储待提交的修改，可通过命令选择性将工作区改动添加至此，便于批量管理提交内容。</li>
<li><strong>版本库</strong>：即 <code>.git</code> 目录，存储已提交的所有版本快照，每个版本都有唯一标识，可随时回溯。</li>
</ul>
<h3 data-id="heading-4">二、核心命令实操：从修改到提交的完整流程</h3>
<p>Git的核心操作围绕“工作区-暂存区-版本库”的流转展开，掌握以下命令，可实现基础版本控制需求。</p>
<h4 data-id="heading-5">1. 状态查看：<code>git status</code></h4>
<p>这是Git最基础且高频的命令，建议在任何操作前都执行一次，用于查看当前仓库状态：包括工作区是否有未跟踪文件、暂存区是否有待提交内容、分支是否同步等。执行后常见状态提示：</p>
<ul>
<li>“尚无提交”：仓库初始化后未进行首次提交，版本库为空。</li>
<li>“未跟踪的文件”：新增文件未被Git管理，需通过 <code>git add</code> 命令纳入跟踪范围。</li>
<li>“Changes to be committed”：文件已添加至暂存区，等待提交到版本库。</li>
</ul>
<h4 data-id="heading-6">2. 暂存与提交：<code>git add</code> &amp; <code>git commit</code></h4>
<p>暂存命令 <code>git add</code> 用于将工作区改动添加到暂存区，支持多种用法：<code>git add 文件名</code> 暂存指定文件，<code>git add .</code> 暂存所有改动文件。暂存后需通过提交命令将内容写入版本库：<code>git commit -m "提交说明"</code>。</p>
<p>提交说明是核心要点，需清晰描述本次改动内容（如“新增用户登录接口”“修复数据查询bug”），避免模糊表述，便于后续追溯版本历史。提交成功后，Git会生成一个唯一的版本ID（基于SHA算法的长字符串），用于标识该版本。</p>
<p>为何采用哈希ID而非自增ID？在多人协作场景中，自增ID易因多端同步冲突导致重复，而SHA哈希ID通过文件内容、提交时间等信息计算生成，全球唯一，可完美适配分布式协作需求。提交成功后，终端会提示改动统计（如“2 insertions”表示新增2行代码），Git本质上存储的是文件修改差异，而非完整文件副本，大幅节省存储空间。</p>
<h4 data-id="heading-7">3. 差异查看：<code>git diff</code></h4>
<p>提交前查看改动细节是良好习惯，可避免误提交错误代码。<code>git diff</code> 命令默认对比工作区与暂存区的文件差异，显示具体修改行（新增内容标绿，删除内容标红）。若需对比暂存区与版本库最新版本，可执行 <code>git diff --cached</code>。重大提交前先执行 <code>git diff</code> 核查，能有效降低错误提交概率。</p>
<h3 data-id="heading-8">三、版本回溯与修改撤销：应对操作失误的实用技巧</h3>
<p>开发过程中难免出现误提交、误修改等问题，Git提供了灵活的版本回溯与撤销命令，可根据不同场景选择使用。</p>
<h4 data-id="heading-9">1. 版本回溯：<code>git reset</code></h4>
<p>Git通过HEAD指针指向当前分支的最新提交，版本回溯本质上是移动HEAD指针的位置。核心命令：<code>git reset --hard HEAD^</code>，其中 <code>HEAD^</code> 表示当前版本的上一个版本，<code>HEAD^^</code> 表示上两个版本，也可直接指定版本ID回溯到具体版本（如 <code>git reset --hard 36803fa</code>）。</p>
<p>注意：<code>--hard</code> 参数会强制覆盖工作区和暂存区内容，回溯后未提交的改动将全部丢失，使用前需确认无重要未提交内容。若需保留工作区改动，可省略 <code>--hard</code> 参数（默认 <code>--mixed</code> 模式）。</p>
<h4 data-id="heading-10">2. 操作记录查询：<code>git reflog</code></h4>
<p>若执行 <code>git reset</code> 后想回到回溯前的版本，或忘记具体版本ID，可通过 <code>git reflog</code> 查看所有操作记录（包括提交、回溯、分支切换等），记录中包含每个操作对应的版本ID，据此可再次执行 <code>git reset</code> 回到目标版本。</p>
<h4 data-id="heading-11">3. 不同场景的修改撤销</h4>
<p>根据改动所处区域，撤销操作的命令不同，需精准区分场景：</p>
<ul>
<li><strong>撤销工作区修改</strong>：若文件仅在工作区修改，未添加到暂存区，执行 <code>git checkout -- 文件名</code>，可将文件恢复至暂存区或版本库的最新状态，此操作不可逆，需谨慎使用。</li>
<li><strong>撤销暂存区修改</strong>：若文件已添加到暂存区，需先将其移出暂存区，执行 <code>git reset HEAD 文件名</code>，改动将退回工作区，之后可重新修改或撤销。</li>
<li><strong>撤销远程仓库提交</strong>：若错误提交已推送至远程仓库，不可使用 <code>git reset</code>（会导致版本冲突），需执行 <code>git revert HEAD</code>，生成一个新的提交来抵消之前的错误提交，保留版本历史的完整性。</li>
</ul>
<h3 data-id="heading-12">四、进阶场景与避坑指南：适配多人协作与复杂需求</h3>
<p>除基础操作外，掌握以下进阶技巧与避坑要点，能更好应对多人协作、大型项目管理中的复杂场景。</p>
<h4 data-id="heading-13">1. 远程仓库协作基础</h4>
<p>多人协作需依赖远程仓库（如GitHub、GitLab）同步代码，核心命令包括：</p>
<ul>
<li>添加远程仓库：<code>git remote add origin 远程仓库URL</code>，其中 <code>origin</code> 是远程仓库的默认简写。</li>
<li>拉取远程代码：<code>git pull origin 分支名</code>，同步远程仓库最新改动到本地，避免推送时冲突。</li>
<li>推送本地代码：<code>git push origin 分支名</code>，将本地已提交的改动推送到远程仓库。</li>
</ul>
<h4 data-id="heading-14">2. 常见错误与解决方案</h4>
<ul>
<li><strong>fatal: not a git repository</strong>：提示“不是Git仓库”，原因是当前目录未初始化仓库或路径错误。解决方案：切换到项目根目录，执行 <code>git init</code> 初始化，或通过 <code>git rev-parse --git-dir</code> 核查仓库路径。</li>
<li><strong>推送被拒绝（non-fast-forward）</strong> ：远程仓库有本地未同步的改动，需先执行 <code>git pull</code> 同步并解决冲突，再执行推送命令。</li>
<li><strong>误提交敏感信息</strong>：若已推送包含密码、密钥的提交，不可直接删除历史（会影响团队协作），需使用 <code>git filter-repo</code> 工具彻底清除历史中的敏感文件，再强制推送（需与团队沟通确认）。</li>
</ul>
<h4 data-id="heading-15">3. 最佳实践总结</h4>
<ol>
<li>提交频率适度：每个功能模块或bug修复完成后及时提交，提交说明清晰规范，便于版本追溯。</li>
<li>提交前核查：养成“<code>git status</code> 查状态 + <code>git diff</code> 查差异”的习惯，避免误提交。</li>
<li>慎用强制命令：<code>git reset --hard</code>、<code>git push --force</code> 等命令可能覆盖或删除数据，使用前务必确认风险。</li>
<li>多人协作先同步：推送代码前先拉取远程最新改动，主动解决冲突，避免影响团队进度。</li>
</ol>
<p>Git的功能远不止于此，分支管理、合并策略、标签管理等进阶内容，可在掌握基础操作后逐步深入。作为版本控制工具，Git的核心价值在于规范代码管理、提升协作效率，熟练运用核心命令，结合实际场景积累经验，才能真正发挥其在开发中的作用，为项目质量保驾护航。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【 算法-7 /Lesson72(2025-12-17)】有序数组合并：从双指针到三指针的深度解析🧠]]></title>    <link>https://juejin.cn/post/7597946284679888915</link>    <guid>https://juejin.cn/post/7597946284679888915</guid>    <pubDate>2026-01-22T14:25:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597946284679888915" data-draft-id="7598021313870462982" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【 算法-7 /Lesson72(2025-12-17)】有序数组合并：从双指针到三指针的深度解析🧠 "/> <meta itemprop="keywords" content="算法,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-22T14:25:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jing_Rainbow"/> <meta itemprop="url" content="https://juejin.cn/user/1285809519198256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【 算法-7 /Lesson72(2025-12-17)】有序数组合并：从双指针到三指针的深度解析🧠 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1285809519198256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jing_Rainbow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T14:25:37.000Z" title="Thu Jan 22 2026 14:25:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在算法与数据结构的世界中，<strong>有序数组的合并</strong>是一个基础却极具教学意义的问题。它不仅考察了对数组操作的理解，还引导我们思考如何在时间和空间复杂度之间取得平衡。本文将围绕 LeetCode 第88题《合并两个有序数组》（<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fmerge-sorted-array%2Fdescription%2F" target="_blank" title="https://leetcode.cn/problems/merge-sorted-array/description/" ref="nofollow noopener noreferrer">题目链接</a>），从问题描述出发，逐步深入讲解<strong>双指针法</strong>和<strong>空间优化的三指针法</strong>，并结合代码实现、原理剖析与边界处理，全面掌握这一经典问题。</p>
<hr/>
<h2 data-id="heading-0">📌 问题背景</h2>
<p>给定两个<strong>非递减顺序排列</strong>的整数数组 <code>nums1</code> 和 <code>nums2</code>，以及两个整数 <code>m</code> 和 <code>n</code>，分别表示 <code>nums1</code> 和 <code>nums2</code> 中的有效元素个数。</p>
<ul>
<li><code>nums1</code> 的长度为 <code>m + n</code>，其中前 <code>m</code> 个元素是有效数据，后 <code>n</code> 个位置为预留空间（初始值通常为0或任意值）。</li>
<li>要求将 <code>nums2</code> 合并到 <code>nums1</code> 中，使得 <code>nums1</code> 成为一个包含 <code>m + n</code> 个元素的<strong>非递减有序数组</strong>。</li>
<li><strong>关键限制</strong>：必须在 <code>nums1</code> 上原地修改，<strong>不能返回新数组</strong>。</li>
</ul>
<blockquote>
<p>💡 注意：由于 <code>nums1</code> 已经预留了足够空间，因此无需额外分配内存来存储结果。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">🔍 初步思路：双指针从前向后（需额外空间）</h2>
<p>最直观的想法是使用<strong>双指针</strong>，分别指向两个数组的开头：</p>
<ul>
<li>指针 <code>i</code> 指向 <code>nums1[0]</code></li>
<li>指针 <code>j</code> 指向 <code>nums2[0]</code></li>
<li>创建一个临时数组 <code>temp</code>，长度为 <code>m + n</code></li>
<li>比较 <code>nums1[i]</code> 和 <code>nums2[j]</code>，将较小者放入 <code>temp</code>，并移动对应指针</li>
<li>最后将 <code>temp</code> 复制回 <code>nums1</code></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 双指针 + 额外空间（不满足原地要求）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">mergeWithExtraSpace</span>(<span class="hljs-params">nums1, m, nums2, n</span>) {
    <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> temp = [];
    <span class="hljs-keyword">while</span> (i &lt; m &amp;&amp; j &lt; n) {
        <span class="hljs-keyword">if</span> (nums1[i] &lt;= nums2[j]) {
            temp.<span class="hljs-title function_">push</span>(nums1[i++]);
        } <span class="hljs-keyword">else</span> {
            temp.<span class="hljs-title function_">push</span>(nums2[j++]);
        }
    }
    <span class="hljs-comment">// 处理剩余元素</span>
    <span class="hljs-keyword">while</span> (i &lt; m) temp.<span class="hljs-title function_">push</span>(nums1[i++]);
    <span class="hljs-keyword">while</span> (j &lt; n) temp.<span class="hljs-title function_">push</span>(nums2[j++]);
    <span class="hljs-comment">// 复制回 nums1</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; m + n; k++) {
        nums1[k] = temp[k];
    }
}
</code></pre>
<p>✅ <strong>优点</strong>：逻辑清晰，易于理解<br/>
❌ <strong>缺点</strong>：需要 O(m + n) 的额外空间，<strong>不符合题目“原地修改”的要求</strong></p>
<hr/>
<h2 data-id="heading-2">🚀 优化方案：三指针从后向前（原地合并）</h2>
<p>为了<strong>避免覆盖尚未处理的元素</strong>，我们可以<strong>逆向思维</strong>：从两个数组的<strong>末尾</strong>开始比较，并将较大值填入 <code>nums1</code> 的<strong>末尾预留空间</strong>。</p>
<h3 data-id="heading-3">🧩 为什么可以从后往前？</h3>
<ul>
<li><code>nums1</code> 的后 <code>n</code> 个位置是空的（或可被覆盖的）</li>
<li>两个数组都是<strong>非递减</strong>的 → 它们的<strong>最大值一定在末尾</strong></li>
<li>因此，<strong>全局最大值</strong>一定是 <code>nums1[m-1]</code> 或 <code>nums2[n-1]</code> 中的较大者</li>
<li>将其放入 <code>nums1[m+n-1]</code> 后，问题规模缩小 1，可递归/迭代处理</li>
</ul>
<h3 data-id="heading-4">🧮 三指针定义</h3>
<ul>
<li><code>i = m - 1</code>：指向 <code>nums1</code> 有效部分的最后一个元素</li>
<li><code>j = n - 1</code>：指向 <code>nums2</code> 的最后一个元素</li>
<li><code>k = m + n - 1</code>：指向 <code>nums1</code> 的最后一个位置（待填充）</li>
</ul>
<h3 data-id="heading-5">🔁 合并过程</h3>
<ol>
<li>
<p>当 <code>i &gt;= 0</code> 且 <code>j &gt;= 0</code> 时：</p>
<ul>
<li>若 <code>nums1[i] &gt; nums2[j]</code>，则 <code>nums1[k] = nums1[i]</code>，<code>i--</code></li>
<li>否则 <code>nums1[k] = nums2[j]</code>，<code>j--</code></li>
<li><code>k--</code></li>
</ul>
</li>
<li>
<p>若 <code>nums2</code> 还有剩余（即 <code>j &gt;= 0</code>），说明 <code>nums1</code> 的所有元素已处理完，直接将 <code>nums2</code> 剩余部分复制到 <code>nums1</code> 前部</p>
</li>
<li>
<p>若 <code>nums1</code> 有剩余（<code>i &gt;= 0</code>），<strong>无需操作</strong>，因为它们已经在正确位置</p>
</li>
</ol>
<blockquote>
<p>✅ 关键洞察：<strong>不需要处理 <code>nums1</code> 剩余的情况</strong>，因为它们本就在 <code>nums1</code> 中，且位置正确！</p>
</blockquote>
<hr/>
<h2 data-id="heading-6">💻 完整代码实现（JavaScript）</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">merge</span>(<span class="hljs-params">nums1, m, nums2, n</span>) {
    <span class="hljs-comment">// 数组是连续的存储空间，所以可以从后往前合并</span>
    <span class="hljs-keyword">let</span> i = m - <span class="hljs-number">1</span>;      <span class="hljs-comment">// nums1 有效部分的末尾</span>
    <span class="hljs-keyword">let</span> j = n - <span class="hljs-number">1</span>;      <span class="hljs-comment">// nums2 的末尾</span>
    <span class="hljs-keyword">let</span> k = m + n - <span class="hljs-number">1</span>;  <span class="hljs-comment">// nums1 整体的末尾（待填充位置）</span>

    <span class="hljs-comment">// 两个数组都还有元素时，比较并填充</span>
    <span class="hljs-keyword">while</span> (i &gt;= <span class="hljs-number">0</span> &amp;&amp; j &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">if</span> (nums1[i] &gt; nums2[j]) {
            nums1[k] = nums1[i];
            i--;
        } <span class="hljs-keyword">else</span> {
            nums1[k] = nums2[j];
            j--;
        }
        k--;
    }

    <span class="hljs-comment">// 如果 nums2 还有剩余元素（nums1 已耗尽）</span>
    <span class="hljs-keyword">while</span> (j &gt;= <span class="hljs-number">0</span>) {
        nums1[k] = nums2[j];
        j--;
        k--;
    }

    <span class="hljs-comment">// 注意：如果 nums1 有剩余，无需处理，已在正确位置</span>
}
</code></pre>
<blockquote>
<p>📌 <strong>重要说明</strong>：该函数<strong>不返回任何值</strong>，因为 JavaScript 中数组是引用类型，直接修改 <code>nums1</code> 即可影响调用者。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">🧪 示例演示</h2>
<p>假设：</p>
<pre><code class="hljs language-js" lang="js">nums1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>], m = <span class="hljs-number">3</span>
nums2 = [<span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>],           n = <span class="hljs-number">3</span>
</code></pre>
<p>执行过程：</p>





























































<table><thead><tr><th>步骤</th><th>i</th><th>j</th><th>k</th><th>比较</th><th>nums1 状态（k位置更新）</th></tr></thead><tbody><tr><td>初始</td><td>2</td><td>2</td><td>5</td><td>3 vs 6 → 6</td><td>[..., 6]</td></tr><tr><td>1</td><td>2</td><td>1</td><td>4</td><td>3 vs 5 → 5</td><td>[..., 5, 6]</td></tr><tr><td>2</td><td>2</td><td>0</td><td>3</td><td>3 vs 2 → 3</td><td>[..., 3, 5, 6]</td></tr><tr><td>3</td><td>1</td><td>0</td><td>2</td><td>2 vs 2 → 2</td><td>[..., 2, 3, 5, 6]</td></tr><tr><td>4</td><td>0</td><td>0</td><td>1</td><td>1 vs 2 → 2</td><td>[..., 2, 2, 3, 5, 6]</td></tr><tr><td>5</td><td>0</td><td>-1</td><td>0</td><td>j &lt; 0，结束</td><td>[1, 2, 2, 3, 5, 6] ✅</td></tr></tbody></table>
<p>最终 <code>nums1 = [1, 2, 2, 3, 5, 6]</code>，完全有序。</p>
<hr/>
<h2 data-id="heading-8">⏱️ 复杂度分析</h2>
<ul>
<li><strong>时间复杂度</strong>：O(m + n)<br/>
每个元素最多被访问一次，总共 <code>m + n</code> 次操作。</li>
<li><strong>空间复杂度</strong>：O(1)<br/>
仅使用三个指针变量，<strong>原地修改</strong>，无额外数组。</li>
</ul>
<blockquote>
<p>✅ 完美满足题目对“原地”和“高效”的双重要求！</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">❗ 边界情况处理</h2>
<ol>
<li>
<p><strong><code>m = 0</code></strong>：<code>nums1</code> 无有效元素，直接将 <code>nums2</code> 全部复制到 <code>nums1</code></p>
<ul>
<li>此时 <code>i = -1</code>，第一个 <code>while</code> 不执行，进入第二个 <code>while</code>，正确处理</li>
</ul>
</li>
<li>
<p><strong><code>n = 0</code></strong>：<code>nums2</code> 为空，无需操作</p>
<ul>
<li><code>j = -1</code>，两个 <code>while</code> 都不执行，<code>nums1</code> 保持不变</li>
</ul>
</li>
<li>
<p><strong>全相等元素</strong>：如 <code>nums1 = [1,1,0,0]</code>, <code>nums2 = [1,1]</code></p>
<ul>
<li>算法仍能正确合并，保持稳定性（虽然题目不要求稳定）</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-10">🧠 为什么这个方法巧妙？</h2>
<ul>
<li><strong>利用了数组的有序性</strong>：最大值在末尾，天然适合从后往前填</li>
<li><strong>避免了元素覆盖</strong>：传统从前向后会覆盖 <code>nums1</code> 中未处理的元素，而从后向前写入的是“空位”</li>
<li><strong>极致的空间优化</strong>：将“预留空间”转化为“操作缓冲区”</li>
</ul>
<hr/>
<h2 data-id="heading-11">📚 延伸思考</h2>
<ul>
<li>如果两个数组都<strong>没有预留空间</strong>，该如何合并？→ 必须使用额外 O(m+n) 空间</li>
<li>如果要求<strong>稳定合并</strong>（相等元素保持原相对顺序）？→ 本算法在 <code>nums1[i] &lt;= nums2[j]</code> 时优先取 <code>nums2</code>，<strong>不稳定</strong>；若改为 <code>&lt;</code> 时取 <code>nums1</code>，<code>&gt;=</code> 时取 <code>nums2</code>，则可稳定（但本题不要求）</li>
<li>此技巧可推广到<strong>多个有序数组合并</strong>、<strong>归并排序的原地优化</strong>等场景</li>
</ul>
<hr/>
<h2 data-id="heading-12">✅ 总结</h2>
<blockquote>
<p>🌟 <strong>有序数组合并</strong>看似简单，实则蕴含深刻的算法思想。</p>
</blockquote>
<p>通过从<strong>双指针+额外空间</strong>的朴素解法，到<strong>三指针+从后向前</strong>的原地优化，我们不仅解决了具体问题，更掌握了<strong>逆向思维</strong>、<strong>空间复用</strong>和<strong>边界控制</strong>等核心编程技巧。</p>
<p>记住这个模式：<strong>当需要原地合并有序数组，且目标数组尾部有空闲空间时，优先考虑从后往前的三指针法！</strong></p>
<p>这不仅是 LeetCode 的一道题，更是通向高效算法设计的一把钥匙 🔑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>